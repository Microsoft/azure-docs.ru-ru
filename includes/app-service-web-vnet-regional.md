---
author: ccompy
ms.service: app-service-web
ms.topic: include
ms.date: 10/21/2020
ms.author: ccompy
ms.openlocfilehash: 7796b94609a9be05fdb72900d0725747440f8042
ms.sourcegitcommit: f0a3ee8ff77ee89f83b69bc30cb87caa80f1e724
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/26/2021
ms.locfileid: "105582755"
---
Использование региональной интеграции виртуальной сети позволяет приложению получить доступ к следующим данным:

* Ресурсы в виртуальной сети в том же регионе, что и ваше приложение.
* Ресурсы в виртуальных сетей, подключенные к виртуальной сети, с которой интегрировано приложение.
* Службы, защищенные конечной точкой службы.
* Ресурсы для подключений Azure ExpressRoute.
* Ресурсы в виртуальной сети, с которыми вы интегрируетесь.
* Ресурсы через одноранговые соединения, включая подключения Azure ExpressRoute.
* Частные конечные точки 

При использовании интеграции с виртуальной сетью с виртуальных сетей в том же регионе можно использовать следующие сетевые функции Azure:

* **Группы безопасности сети (группы безопасности сети)**. исходящий трафик можно блокировать с помощью NSG, размещенного в подсети интеграции. Правила для входящих подключений не применяются, так как вы не можете использовать интеграцию с виртуальной сетью для предоставления входящего доступа к приложению.
* **Таблицы маршрутов (определяемые пользователем маршруты)**. таблицу маршрутов можно поместить в подсеть интеграции для отправки исходящего трафика.

По умолчанию приложение перенаправляет только АДРЕСНЫЕ пространства RFC1918 трафик в виртуальную сеть. Если вы хотите направить весь исходящий трафик в виртуальную сеть, выполните следующие действия, чтобы добавить `WEBSITE_VNET_ROUTE_ALL` параметр в приложение: 

1. Перейдите в пользовательский интерфейс **настройки** на портале приложения. Выберите **Новый параметр приложения**.
1. Введите `WEBSITE_VNET_ROUTE_ALL` в поле **имя** и введите `1` в поле **значение** .

   ![Укажите параметр приложения][4]

1. Щелкните **ОК**.
1. Щелкните **Сохранить**.

> [!NOTE]
> При маршрутизации всего исходящего трафика в виртуальную сеть он подпадает под группы безопасности сети и определяемые пользователем маршруты, которые применяются к подсети интеграции. Если параметр `WEBSITE_VNET_ROUTE_ALL` имеет значение `1` , исходящий трафик по-прежнему отправляется из адресов, перечисленных в свойствах приложения, если только не указаны маршруты, которые направляют трафик в другое место.
> 
> При интеграции с региональной виртуальной сетью не удается использовать порт 25.

Существуют некоторые ограничения при использовании интеграции с виртуальной сетью с виртуальных сетей в одном регионе:

* Не удается получить доступ к ресурсам по глобальным одноранговым соединениям.
* Эта функция доступна во всех единицах масштабирования службы приложений в Premium v2 и Premium v3. Он также доступен в стандарте, но только из новых единиц масштабирования службы приложений. Если вы используете более раннюю единицу масштабирования, эту функцию можно использовать только из плана службы приложений Premium v2. Если вы хотите убедиться, что вы можете использовать эту функцию в стандартном плане службы приложений, создайте приложение в плане службы приложений уровня "Премиум V3". Эти планы поддерживаются только в самых новых единицах масштабирования. Вы можете уменьшить масштаб, если хотите.  
* Подсеть интеграции может использоваться только одним планом службы приложений.
* Эта функция не может использоваться приложениями изолированного плана, которые находятся в Среда службы приложений.
* Для этой функции требуется неиспользуемая подсеть, которая имеет значение/28 или больше в Azure Resource Manager виртуальной сети.
* Приложение и виртуальная сеть должны находиться в одном регионе.
* Невозможно удалить виртуальную сеть с интегрированным приложением. Удалите интеграцию перед удалением виртуальной сети.
* Можно использовать только одну региональную интеграцию с виртуальной сетью на один план службы приложений. Несколько приложений в одном плане службы приложений могут использовать одну и ту же виртуальную сеть.
* Вы не можете изменить подписку приложения или плана, пока есть приложение, использующее интеграцию с региональной виртуальной сетью.
* Приложение не может разрешать адреса в Частные зоны Azure DNS без изменений конфигурации.

Интеграция виртуальной сети зависит от выделенной подсети. При подготовке подсети подсеть Azure теряет пять IP-адресов с самого начала. Один адрес используется из подсети интеграции для каждого экземпляра плана. При масштабировании приложения до четырех экземпляров используются четыре адреса. 

При увеличении или уменьшении размера необходимого адресного пространства удваивается в течение короткого периода времени. Это влияет на реальные, доступные поддерживаемые экземпляры для заданного размера подсети. В следующей таблице показаны максимальные доступные адреса на блок CIDR, а также их влияние на горизонтальное масштабирование:

| Размер блока CIDR | Максимальное число доступных адресов | Максимальный масштаб по горизонтали (экземпляры)<sup>*</sup> |
|-----------------|-------------------------|---------------------------------|
| /28             | 11                      | 5                               |
| /27             | 27                      | 13                              |
| /26             | 59                      | 29                              |

<sup>*</sup>Предполагается, что в некоторый момент вам придется увеличивать или уменьшать масштаб в какой либо размер, либо SKU. 

Так как размер подсети нельзя изменить после назначения, используйте подсеть, которая достаточно велика для размещения любого масштаба, к которому может получить доступ приложение. Чтобы избежать проблем с емкостью подсети, следует использовать адрес a/26 с 64.  

Если вы хотите, чтобы приложения в другом плане достигли виртуальной сети, к которой уже подключены приложения в другом плане, выберите подсеть, отличную от используемой уже существующей интеграцией виртуальной сети.

Эта функция полностью поддерживается для приложений Windows и Linux, включая [Пользовательские контейнеры](../articles/app-service/quickstart-custom-container.md). Все эти поведения действуют одинаково в приложениях Windows и приложениях Linux.

### <a name="service-endpoints"></a>Конечные точки служб

Интеграция региональной виртуальной сети позволяет использовать конечные точки службы. Ниже приведены основные шаги для доступа к службе из приложения через конечные точки службы.

1. Настройте интеграцию региональной виртуальной сети с веб-приложением для подключения к определенной подсети для интеграции.
1. Перейдите в целевую службу и настройте конечные точки службы для подсети интеграции.

### <a name="network-security-groups"></a>Группы безопасности сети

Группы безопасности сети можно использовать для блокировки входящего и исходящего трафика для ресурсов в виртуальной сети. Приложение, использующее интеграцию региональной виртуальной сети, может использовать [группу безопасности сети][VNETnsg] для блокировки исходящего трафика к ресурсам в виртуальной сети или Интернете. Для блокировки трафика на общедоступные адреса необходимо, чтобы параметр приложения был `WEBSITE_VNET_ROUTE_ALL` установлен в значение `1` . Правила для входящих подключений в NSG не применяются к вашему приложению, так как интеграция с виртуальной сетью влияет только на исходящий трафик из приложения.

Чтобы управлять входящим трафиком к приложению, используйте функцию ограничения доступа. NSG, применяемый к подсети интеграции, действует независимо от всех маршрутов, примененных к подсети интеграции. Если параметр `WEBSITE_VNET_ROUTE_ALL` имеет значение `1` , а у вас нет маршрутов, влияющих на трафик общедоступного адреса в подсети интеграции, весь исходящий трафик по-прежнему подчиняется группы безопасности сети, назначенному вашей подсети интеграции. Если `WEBSITE_VNET_ROUTE_ALL` параметр не задан, группы безопасности сети применяется только к трафику адресные пространства RFC1918.

### <a name="routes"></a>Маршруты

Таблицы маршрутов можно использовать для маршрутизации исходящего трафика из приложения в нужное место. По умолчанию таблицы маршрутов влияют только на трафик назначения АДРЕСНЫЕ пространства RFC1918. Если задано `WEBSITE_VNET_ROUTE_ALL` значение `1` , все исходящие вызовы будут затронуты. Маршруты, настроенные в подсети интеграции, не влияют на ответы на входящие запросы приложений. Общие назначения могут включать устройства брандмауэра или шлюзы.

Если требуется маршрутизировать весь исходящий трафик локально, можно использовать таблицу маршрутов для отправки всего исходящего трафика на шлюз ExpressRoute. Если вы направите трафик в шлюз, не забудьте установить маршруты во внешней сети для отправки ответов обратно.

Маршруты протокол BGP (BGP) также влияют на трафик приложения. Если у вас есть маршруты BGP, например шлюз ExpressRoute, это повлияет на исходящий трафик приложения. По умолчанию маршруты BGP влияют только на трафик назначения АДРЕСНЫЕ пространства RFC1918. Если параметр `WEBSITE_VNET_ROUTE_ALL` имеет значение `1` , маршруты BGP могут повлиять на весь исходящий трафик.

### <a name="azure-dns-private-zones"></a>Azure DNS частные зоны 

После интеграции приложения с виртуальной сетью используется тот же DNS-сервер, с которым настроена виртуальная сеть. По умолчанию приложение не будет работать с Azure DNS частными зонами. Для работы с частными зонами Azure DNS необходимо добавить следующие параметры приложения:

1. `WEBSITE_DNS_SERVER` со значением `168.63.129.16`
1. `WEBSITE_VNET_ROUTE_ALL` со значением `1`

Эти параметры отправляют все исходящие вызовы из приложения в виртуальную сеть и предоставляют приложению доступ к частной зоне Azure DNS. С помощью этих параметров приложение может использовать Azure DNS, запрашивая закрытую зону DNS на уровне рабочей роли.  

> [!NOTE]
> Попытка добавить личный домен в веб-приложение с помощью частной зоны DNS невозможно с интеграция с виртуальной сетью. Проверка пользовательских доменов выполняется на уровне контроллера, а не на уровне рабочей роли, что предотвращает отображение записей DNS. Чтобы использовать личный домен из частной зоны DNS, необходимо обойти проверку с помощью [шлюза приложений](../articles/app-service/networking/app-gateway-with-service-endpoints.md) или [ilB среда службы приложений](../articles/app-service/environment/create-ilb-ase.md).

### <a name="private-endpoints"></a>Частные конечные точки

Если вы хотите выполнять вызовы к [частным конечным точкам][privateendpoints], необходимо убедиться, что поиск DNS разрешается в частную конечную точку. Это поведение можно применить одним из следующих способов. 

* Интеграция с Azure DNS частными зонами. Если в виртуальной сети нет настраиваемого DNS-сервера, это выполняется автоматически.
* Управление частной конечной точкой на DNS-сервере, используемом приложением. Для этого необходимо узнать адрес частной конечной точки, а затем указать конечную точку, к которой вы пытаетесь связаться по этому адресу, используя запись A.
* Настройте собственный DNS-сервер для пересылки в Azure DNS частные зоны.

<!--Image references-->
[4]: ../includes/media/web-sites-integrate-with-vnet/vnetint-appsetting.png

<!--Links-->
[VNETnsg]: /azure/virtual-network/security-overview/
[privateendpoints]: ../articles/app-service/networking/private-endpoint.md
