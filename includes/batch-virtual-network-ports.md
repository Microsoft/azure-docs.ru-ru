---
title: включить файл
description: включить файл
services: batch
documentationcenter: ''
author: JnHs
manager: evansma
editor: ''
ms.service: batch
ms.devlang: na
ms.topic: include
ms.tgt_pltfrm: na
ms.date: 01/13/2021
ms.author: jenhayes
ms.custom: include file
ms.openlocfilehash: c625253585cc99c035852b8b9042f939284bad19
ms.sourcegitcommit: c27a20b278f2ac758447418ea4c8c61e27927d6a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/03/2021
ms.locfileid: "101750094"
---
### <a name="general-requirements"></a>Общие требования

* Виртуальная сеть должна находиться в тех же подписке и регионе, что и учетная запись пакетной службы, которую вы используете для создания пула.

* Указанная для пула подсеть должна иметь достаточное количество свободных IP-адресов для всех виртуальных машин, предназначенных для пула, то есть сумму свойств `targetDedicatedNodes` и `targetLowPriorityNodes` этого пула. Если в подсети недостаточно свободных IP-адресов, пакетная служба ограничивает выделение вычислительных узлов для пула и генерирует ошибку изменения размера.

* Необходимо, чтобы конечная точка службы хранилища Azure могла быть разрешена на всех пользовательских DNS-серверах, используемых в виртуальной сети. В частности, должны разрешаться URL-адреса в формате `<account>.table.core.windows.net`, `<account>.queue.core.windows.net` и `<account>.blob.core.windows.net`.

* Вы можете создать несколько пулов в одной виртуальной сети или одной подсети (при наличии достаточного адресного пространства). Один пул нельзя расположить в нескольких виртуальных сетях или подсетях.

Дополнительные требования к виртуальной сети различаются в зависимости от того, где указан пул пакетной службы: в конфигурации виртуальной машины или конфигурации облачных служб. Для новых развертываний пула в виртуальной сети рекомендуется конфигурация виртуальной машины.

### <a name="pools-in-the-virtual-machine-configuration"></a>Пулы в конфигурации виртуальной машины

**Поддерживаемые виртуальные сети** — только виртуальные сети на основе Azure Resource Manager.

**Идентификатор подсети** — при указании подсети с помощью API пакетной службы используйте *идентификатор ресурса* подсети. Идентификатор подсети имеет вид:

`/subscriptions/{subscription}/resourceGroups/{group}/providers/Microsoft.Network/virtualNetworks/{network}/subnets/{subnet}`

**Разрешения** — проверьте, ограничивают ли ваши политики безопасности или блокировки в подписке или группе ресурсов виртуальной сети разрешения пользователя на управление виртуальной сетью.

**Дополнительные сетевые ресурсы** — пакетная служба автоматически выделяет дополнительные сетевые ресурсы в группе ресурсов, содержащей виртуальную сеть.

> [!IMPORTANT]
> Для каждого из 100 выделенных или низкоприоритетных узлов пакетная служба выделяет по одной группе безопасности сети (NSG), одному общедоступному IP-адресу и одной подсистеме балансировки нагрузки. Эти ресурсы ограничены [квотами ресурсов](../articles/azure-resource-manager/management/azure-subscription-service-limits.md) в подписке. Для больших пулов, возможно, вам потребуется запросить увеличение квоты на один или несколько ресурсов.

#### <a name="network-security-groups-batch-default"></a>Группы безопасности сети Пакетная служба по умолчанию

Подсеть должна разрешать входящее подключение из пакетной службы для планирования задач на вычислительных узлах, и исходящее подключение для обмена данными со службой хранилища Azure или другими ресурсами в соответствии с требованиями рабочей нагрузки. Для пулов в конфигурации виртуальной машины пакетная служба добавляет группы безопасности сети на уровне сетевых интерфейсов, подключенных к вычислительным узлам. Эти группы безопасности сети настраиваются с применением следующих дополнительных правил:

* Входящий TCP-трафик через порты 29876 и 29877 с IP-адресов пакетной службы, которые соответствуют тегу `BatchNodeManagement` службы.
* Входящий трафик TCP через порт 22 (узлы Linux) или 3389 (узлы Windows), чтобы разрешить удаленный доступ. Для некоторых типов задач с несколькими экземплярами в Linux (например, MPI) необходимо также разрешить трафик SSH через порт 22 для IP-адресов в подсети, содержащей вычислительные узлы пакетной службы. Эта возможность может быть заблокирована для каждого правила группы безопасности сети на уровне подсети (см. ниже).
* Исходящий трафик в виртуальную сеть на любом порту. Это можно изменить в правилах группы безопасности сети на уровне подсети (см. ниже).
* Исходящий трафик, передаваемый в Интернет через любой порт. Это можно изменить в правилах группы безопасности сети на уровне подсети (см. ниже).

> [!IMPORTANT]
> Соблюдайте осторожность, если вы изменяете или добавляете правила для входящего и исходящего трафика в группах безопасности сети, настроенных для пакетной службы. Если группа безопасности сети (NSG), связанная с назначенной подсетью, запрещает взаимодействие с вычислительными узлами, пакетная служба установит для вычислительных узлов состояние **Непригоден**. Кроме того, не следует применять блокировки к ресурсам, созданным пакетной службой. Это может препятствовать очистке ресурсов в результате действий, инициированных пользователем, таких как удаление пула.

#### <a name="network-security-groups-specifying-subnet-level-rules"></a>Группы безопасности сети. Определение правил уровня подсети

Вам не нужно указывать группы безопасности сети на уровне подсети виртуальной сети, так как пакетная служба настраивает собственные группы безопасности сети (см. выше). Если у вас есть группа NSG, связанная с подсетью, где развернуты вычислительные узлы пакетной службы, или вы хотите применить настраиваемые правила NSG для переопределения правил по умолчанию, необходимо настроить для этой группы NSG по крайней мере правила безопасности для входящего и исходящего трафика, указанные в таблицах ниже.

Настройте входящий трафик через порт 3389 (Windows) или 22 (Linux), только если необходимо разрешить удаленный доступ к вычислительным узлам из внешних ресурсов. Чтобы включить поддержку многоэкземплярных задач с определенными средами MPI, включите правила порта 22 в Linux. Разрешение передачи трафика через эти порты не является обязательным для использования вычислительных узлов пула.

> [!WARNING]
> IP-адреса пакетной службы могут меняться со временем. Поэтому для правил NSG, приведенных в следующих таблицах, настоятельно рекомендуется использовать тег службы `BatchNodeManagement` (или региональный вариант). Не указывайте для правил NSG конкретные IP-адреса пакетной службы.

**Правила безопасности для входящего трафика**

| Исходные IP-адреса | Тег службы источника | Исходные порты | Назначение | Конечные порты | Протокол | Действие |
| --- | --- | --- | --- | --- | --- | --- |
| Недоступно | [Тег службы](../articles/virtual-network/network-security-groups-overview.md#service-tags) `BatchNodeManagement` (если используется региональный вариант, в том же регионе, что и учетная запись пакетной службы). | * | Любой | 29876–29877 | TCP | Allow |
| Исходные IP-адреса пользователя для удаленного доступа к вычислительным узлам и (или) подсети вычислительных узлов для задач с несколькими экземплярами Linux, если это необходимо. | Недоступно | * | Любой | 3389 (Windows), 22 (Linux) | TCP | Allow |

**Правила безопасности для исходящего трафика**

| Источник | Исходные порты | Назначение | Тег целевой службы | Конечные порты | Протокол | Действие |
| --- | --- | --- | --- | --- | --- | --- |
| Любой | * | [Тег службы](../articles/virtual-network/network-security-groups-overview.md#service-tags) | `Storage` (если используется региональный вариант, в том же регионе, что и учетная запись пакетной службы). | 443 | TCP | Allow |
| Любой | * | [Тег службы](../articles/virtual-network/network-security-groups-overview.md#service-tags) | `BatchNodeManagement` (если используется региональный вариант, в том же регионе, что и учетная запись пакетной службы). | 443 | TCP | Allow |

Исходящий трафик в `BatchNodeManagement` требуется для обращения к пакетной службе из вычислительных узлов, например узлов для задач диспетчера заданий.

### <a name="pools-in-the-cloud-services-configuration"></a>Пулы в конфигурации облачных служб

> [!WARNING]
> Не рекомендуется использовать пулы с конфигурацией облачных служб. Вместо них используйте пулы с конфигурацией виртуальных машин.

**Поддерживаемые виртуальные сети** — только классические виртуальные сети.

**Идентификатор подсети** — при указании подсети с помощью API пакетной службы используйте *идентификатор ресурса* подсети. Идентификатор подсети имеет вид:

`/subscriptions/{subscription}/resourceGroups/{group}/providers/Microsoft.ClassicNetwork /virtualNetworks/{network}/subnets/{subnet}`

**Разрешения`Microsoft Azure Batch` — субъекту-службе**  должна быть назначена роль Azure `Classic Virtual Machine Contributor` для указанной виртуальной сети.

#### <a name="network-security-groups"></a>Группы безопасности сети

Подсеть должна разрешать входящую связь из пакетной службы, чтобы иметь возможность планировать задачи на вычислительных узлах, и исходящую связь для связи со службой хранилища Azure или другими ресурсами.

Вам не нужно указывать группу безопасности сети, так как пакетная служба настраивает входящий трафик только с IP-адресов пакетной службы на узлах пула. Если указанной подсети уже назначены группы безопасности сети и (или) брандмауэр, настройте правила безопасности для входящего и исходящего трафика, как показано в следующих таблицах. Если группа безопасности сети (NSG), связанная с назначенной подсетью, запрещает взаимодействие с вычислительными узлами, пакетная служба устанавливает для вычислительных узлов состояние **Непригоден**.

Настройте входящий трафик через порт 3389 (в Windows), только если необходимо разрешить RDP-доступ к узлам пула. Узлы пула можно использовать и без этой настройки.

**Правила безопасности для входящего трафика**

| Исходные IP-адреса | Исходные порты | Назначение | Конечные порты | Протокол | Действие |
| --- | --- | --- | --- | --- | --- |
Любой <br /><br />Хотя фактически это разрешает доступ со всех адресов, пакетная служба применяет правило списка управления доступом на уровне каждого узла, которое отфильтровывает все IP-адреса, не относящиеся к пакетной службе. | * | Любой | 10100, 20100, 30100 | TCP | Allow |
| (Необязательно) Для разрешения RDP-доступа к вычислительным узлам. | * | Любой | 3389 | TCP | Allow |

**Правила безопасности для исходящего трафика**

| Источник | Исходные порты | Назначение | Конечные порты | Протокол | Действие |
| --- | --- | --- | --- | --- | --- |
| Любой | * | Любой | 443  | Любой | Allow |
