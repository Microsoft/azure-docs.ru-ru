---
author: ggailey777
ms.service: azure-functions
ms.topic: include
ms.date: 10/01/2020
ms.author: glenga
ms.openlocfilehash: 2ccff72be66a88b9bf0a5e9eb9c29ade8397804b
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "96356199"
---
Ошибки, возникающие в функциях Azure, могут поступать из любого из следующих источников:

- Использование встроенных [триггеров и привязок](..\articles\azure-functions\functions-triggers-bindings.md) функций Azure
- Вызовы API базовых служб Azure
- Вызовы конечных точек RESTFUL
- Вызовы клиентских библиотек, пакетов или сторонних API

Следующие рекомендации по обработке ошибок важны, чтобы избежать потери данных или пропущенных сообщений. Рекомендуемые методы обработки ошибок включают следующие действия.

- [Включить Application Insights](../articles/azure-functions/functions-monitoring.md)
- [Использование структурированной обработки ошибок](#use-structured-error-handling)
- [Проектирование для идемпотентности](../articles/azure-functions/functions-idempotent.md)
- [Реализация политик повтора](#retry-policies-preview) (при необходимости)

### <a name="use-structured-error-handling"></a>Использование структурированной обработки ошибок

Запись и запись ошибок в журнал крайне важны для мониторинга работоспособности приложения. Самый верхний уровень кода функции должен включать блок try/catch. В блоке catch можно записывать и записывать ошибки.

## <a name="retry-policies-preview"></a>Политики повтора (Предварительная версия)

Политику повтора можно определить для любой функции любого типа триггера в приложении-функции.  Политика повтора повторно выполняет функцию до успешного выполнения или до тех пор, пока не будет выполнено максимальное число повторных попыток.  Политики повтора можно определить для всех функций в приложении или для отдельных функций.  По умолчанию приложение-функция не будет повторять сообщения (помимо [конкретных триггеров, которые имеют политику повтора в источнике триггера](#using-retry-support-on-top-of-trigger-resilience)).  Политика повтора вычисляется каждый раз, когда выполнение приводит к неперехваченному исключению.  Рекомендуется перехватить все исключения в коде и повторно создать все ошибки, которые должны привести к появлению повторных попыток.  Концентраторы событий и контрольные точки Azure Cosmos DB не будут записаны до тех пор, пока не завершится политика повторных попыток выполнения. Это означает, что выполнение этой секции приостанавливается до завершения текущего пакета.

### <a name="retry-policy-options"></a>Параметры политики повтора

Для определения политики повтора доступны следующие параметры.

Максимальное число **повторных попыток** — это максимальное количество повторений выполнения до последующего сбоя. Значение параметра `-1` указывает на неограниченное время повтора. Текущее число повторных попыток хранится в памяти экземпляра. Возможно, произошел сбой экземпляра между повторными попытками.  При сбое экземпляра во время применения политики повтора число повторных попыток будет утеряно.  При возникновении ошибок экземпляра триггеры, такие как концентраторы событий, Azure Cosmos DB и хранилище очередей, могут возобновить обработку и повторить пакет на новом экземпляре, при этом счетчик повторных попыток сбрасывается в ноль.  Другие триггеры, такие как HTTP и Timer, не возобновляются на новом экземпляре.  Это означает, что максимальное количество повторных попыток является наилучшим вариантом, и в некоторых редких случаях выполнение может быть повторено более, чем максимальное, или для триггеров, таких как HTTP и таймер, которые будут повторяться меньше максимального значения.

**Стратегия повторных попыток** управляет поведением повторных попыток.  Ниже приведены два варианта поддержки повторных попыток.

| Параметр | Описание|
|---|---|
|**`fixedDelay`**| Указанное количество времени может пройти между повторными попытками,|
| **`exponentialBackoff`**| Первая повторная попытка ожидает минимальную задержку. При последующих повторах время добавляется экспоненциально к начальной длительности каждой попытки, пока не будет достигнута максимальная задержка.  Экспоненциальное обратное отключение добавляет некоторый небольшой случай, чтобы задерживать повторные попытки в сценариях с высокой пропускной способностью.|

#### <a name="app-level-configuration"></a>Настройка уровня приложения

Политику повтора можно определить для всех функций в приложении [, использующих `host.json` файл](../articles/azure-functions/functions-host-json.md#retry). 

#### <a name="function-level-configuration"></a>Настройка уровня функции

Политику повтора можно определить для определенной функции.  Конфигурация, зависящая от функции, имеет приоритет над конфигурацией на уровне приложения.

#### <a name="fixed-delay-retry"></a>Фиксированная задержка повтора

# <a name="c"></a>[C#](#tab/csharp)

Для повторных попыток требуется пакет NuGet [Microsoft. Azure. веб-задания](https://www.nuget.org/packages/Microsoft.Azure.WebJobs) >= 3.0.23

```csharp
[FunctionName("EventHubTrigger")]
[FixedDelayRetry(5, "00:00:10")]
public static async Task Run([EventHubTrigger("myHub", Connection = "EventHubConnection")] EventData[] events, ILogger log)
{
// ...
}
```

# <a name="c-script"></a>[Скрипт C#](#tab/csharp-script)

Ниже приведена Политика повтора в *function.jsдля* файла:

```json
{
    "disabled": false,
    "bindings": [
        {
            ....
        }
    ],
    "retry": {
        "strategy": "fixedDelay",
        "maxRetryCount": 4,
        "delayInterval": "00:00:10"
    }
}
```
# <a name="javascript"></a>[JavaScript](#tab/javascript)

Ниже приведена Политика повтора в *function.jsдля* файла:


```json
{
    "disabled": false,
    "bindings": [
        {
            ....
        }
    ],
    "retry": {
        "strategy": "fixedDelay",
        "maxRetryCount": 4,
        "delayInterval": "00:00:10"
    }
}
```

# <a name="python"></a>[Python](#tab/python)

Ниже приведена Политика повтора в *function.jsдля* файла:

```json
{
    "disabled": false,
    "bindings": [
        {
            ....
        }
    ],
    "retry": {
        "strategy": "fixedDelay",
        "maxRetryCount": 4,
        "delayInterval": "00:00:10"
    }
}
```

# <a name="java"></a>[Java](#tab/java)

Ниже приведена Политика повтора в *function.jsдля* файла:


```json
{
    "disabled": false,
    "bindings": [
        {
            ....
        }
    ],
    "retry": {
        "strategy": "fixedDelay",
        "maxRetryCount": 4,
        "delayInterval": "00:00:10"
    }
}
```

# <a name="powershell"></a>[PowerShell](#tab/powershell)

Ниже приведена Политика повтора в *function.jsдля* файла:


```json
{
    "disabled": false,
    "bindings": [
        {
            ....
        }
    ],
    "retry": {
        "strategy": "fixedDelay",
        "maxRetryCount": 4,
        "delayInterval": "00:00:10"
    }
}
```
---

#### <a name="exponential-backoff-retry"></a>Экспоненциальная повторная попытка

# <a name="c"></a>[C#](#tab/csharp)

Для повторных попыток требуется пакет NuGet [Microsoft. Azure. веб-задания](https://www.nuget.org/packages/Microsoft.Azure.WebJobs) >= 3.0.23

```csharp
[FunctionName("EventHubTrigger")]
[ExponentialBackoffRetry(5, "00:00:04", "00:15:00")]
public static async Task Run([EventHubTrigger("myHub", Connection = "EventHubConnection")] EventData[] events, ILogger log)
{
// ...
}
```

# <a name="c-script"></a>[Скрипт C#](#tab/csharp-script)

Ниже приведена Политика повтора в *function.jsдля* файла:

```json
{
    "disabled": false,
    "bindings": [
        {
            ....
        }
    ],
    "retry": {
        "strategy": "exponentialBackoff",
        "maxRetryCount": 5,
        "minimumInterval": "00:00:10",
        "maximumInterval": "00:15:00"
    }
}
```

# <a name="javascript"></a>[JavaScript](#tab/javascript)

Ниже приведена Политика повтора в *function.jsдля* файла:

```json
{
    "disabled": false,
    "bindings": [
        {
            ....
        }
    ],
    "retry": {
        "strategy": "exponentialBackoff",
        "maxRetryCount": 5,
        "minimumInterval": "00:00:10",
        "maximumInterval": "00:15:00"
    }
}
```

# <a name="python"></a>[Python](#tab/python)

Ниже приведена Политика повтора в *function.jsдля* файла:

```json
{
    "disabled": false,
    "bindings": [
        {
            ....
        }
    ],
    "retry": {
        "strategy": "exponentialBackoff",
        "maxRetryCount": 5,
        "minimumInterval": "00:00:10",
        "maximumInterval": "00:15:00"
    }
}
```

# <a name="java"></a>[Java](#tab/java)

Ниже приведена Политика повтора в *function.jsдля* файла:

```json
{
    "disabled": false,
    "bindings": [
        {
            ....
        }
    ],
    "retry": {
        "strategy": "exponentialBackoff",
        "maxRetryCount": 5,
        "minimumInterval": "00:00:10",
        "maximumInterval": "00:15:00"
    }
}
```

# <a name="powershell"></a>[PowerShell](#tab/powershell)

Ниже приведена Политика повтора в *function.jsдля* файла:

```json
{
    "disabled": false,
    "bindings": [
        {
            ....
        }
    ],
    "retry": {
        "strategy": "exponentialBackoff",
        "maxRetryCount": 5,
        "minimumInterval": "00:00:10",
        "maximumInterval": "00:15:00"
    }
}
```
---

|свойство function.json  |Свойство атрибута | Описание |
|---------|---------|---------| 
|модель|Н/Д|Обязательный. Используемая стратегия повторных попыток. Допустимые значения: `fixedDelay` или `exponentialBackoff`.|
|maxRetryCount|Н/Д|Обязательный. Максимальное количество попыток выполнения каждой функции. `-1` Указывает на неограниченное время повтора.|
|делайинтервал|Н/Д|Задержка, которая будет использоваться между повторными попытками при использовании `fixedDelay` стратегии.|
|minimumInterval|Н/Д|Минимальная задержка повторных попыток при использовании `exponentialBackoff` стратегии.|
|maximumInterval|Н/Д|Максимальная задержка повтора при использовании `exponentialBackoff` стратегии.| 

### <a name="retry-limitations-during-preview"></a>Ограничения повторных попыток во время предварительной версии

- Для проектов .NET может потребоваться вручную извлечь версию [Microsoft. Azure. веб-задания](https://www.nuget.org/packages/Microsoft.Azure.WebJobs) >= 3.0.23.
- В плане потребления приложение может быть уменьшено до нуля при повторном выполнении последних сообщений в очереди.
- В плане потребления приложение может масштабироваться при выполнении повторных попыток.  Для получения наилучших результатов выберите интервал повтора <= 00:01:00 и <= 5 повторных попыток.

## <a name="using-retry-support-on-top-of-trigger-resilience"></a>Использование поддержки повторных попыток на основе устойчивости триггеров

Политика повтора для приложения-функции не зависит от повторных попыток или устойчивости, предоставляемых триггером.  Политика повтора функции будет разслойовать только поверх восстанавливаемой повторной попытки триггера.  Например, при использовании служебной шины Azure очереди по умолчанию имеют число доставленных сообщений, равное 10.  Значение счетчика доставки по умолчанию означает, что после 10 попыток доставки сообщения очереди служебная шина отправит сообщение недоставленным письмом.  Можно определить политику повтора для функции, которая имеет триггер служебной шины, но повторные попытки будут поверх всех попыток доставки служебной шины.  

Например, если вы использовали значение счетчика доставки служебной шины по умолчанию (10) и определили политику повтора для функции, равную 5.  Сообщение сначала выдаст очередь, увеличивая учетную запись доставки служебной шины до 1.  При сбое каждого выполнения после пяти попыток активировать одно и то же сообщение оно помечается как брошенное.  Служебная шина немедленно выдаст сообщение в очередь, оно запустит функцию и увеличит число доставок до 2.  Наконец, после 50 попыток (10 поставок служебной шины * пять повторных попыток передачи функций на доставку) сообщение будет отброшено и активировать недоставленную букву в служебной шине.

> [!WARNING]
> Не рекомендуется устанавливать счетчики доставки для триггера, например для очередей служебной шины, в значение 1, что означает, что сообщение будет недоставлено сразу после одного цикла повтора функции.  Это обусловлено тем, что триггеры обеспечивают устойчивость с повторными попытками, в то время как политика повтора функций является наилучшим вариантом и может привести к меньшему количеству попыток.

### <a name="triggers-with-additional-resiliency-or-retries"></a>Триггеры с дополнительной устойчивостью или повторными попытками

Следующие триггеры поддерживают повторные попытки в источнике триггера:

* [Хранилище BLOB-объектов Azure](../articles/azure-functions/functions-bindings-storage-blob.md)
* [хранилище очередей Azure](../articles/azure-functions/functions-bindings-storage-queue.md);
* [служебная шина Azure (очередь/тема)](../articles/azure-functions/functions-bindings-service-bus.md).

По умолчанию большинство триггеров попыток повтора не более пяти раз. После пятой повторной попытки хранилище очередей Azure будет записывать сообщение в [очередь подозрительных](../articles/azure-functions/functions-bindings-storage-queue-trigger.md#poison-messages)сообщений.  Политика по умолчанию очереди и раздела служебной шины будет записывать сообщение в [очередь недоставленных](../articles/service-bus-messaging/service-bus-dead-letter-queues.md) сообщений после 10 попыток.
