---
title: включить файл
description: включить файл
services: virtual-machines
author: roygara
ms.service: virtual-machines
ms.topic: include
ms.date: 07/14/2020
ms.author: rogarana
ms.custom: include file
ms.openlocfilehash: 74c77356df4f35461a8b9f1459712cdcf7f77cbf
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "95555758"
---
Общие диски Azure — это новая функция для управляемых дисков Azure, которая позволяет подключать управляемые диски одновременно к нескольким виртуальным машинам. Подключение управляемого диска к нескольким виртуальным машинам позволяет разворачивать новые или переносить существующие кластеризованные приложения в Azure.

## <a name="how-it-works"></a>Принцип работы

Виртуальные машины в кластере могут выполнять чтение или запись на подключенный диск в соответствии с резервированием, выбранным кластеризованным приложением, с использованием [постоянных резервирований SCSI](https://www.t10.org/members/w_spc3.htm) (по протоколу SCSI). SCSI PR — это промышленный стандарт, используемый приложениями, работающими в локальных сетях хранения данных (SAN). Включение SCSI PR на управляемом диске позволяет перенести эти приложения в Azure "как есть".

Общие управляемые диски предлагают общее хранилище блоков, доступ к которому можно получить из нескольких виртуальных машин, которые предоставляются в виде логических номеров устройств (LUN). Затем LUN представляются инициатору (виртуальной машине) из целевого объекта (диска). Эти LUN представляются виртуальной машине дисками с прямым подключением (DAS) или локальными дисками.

Общие управляемые диски изначально не предлагают полностью управляемую файловую систему, доступ к которой можно получить с помощью SMB/NFS. Необходимо использовать диспетчер кластеров, например отказоустойчивый кластер Windows Server (WSFC) или Pacemaker, который управляет обменом данными между узлом кластера и блокировкой записи.

## <a name="limitations"></a>Ограничения

[!INCLUDE [virtual-machines-disks-shared-limitations](virtual-machines-disks-shared-limitations.md)]

### <a name="operating-system-requirements"></a>Требования к операционной системе

Общие диски поддерживают несколько операционных систем. Поддерживаемые операционные системы см. в разделах [Windows](#windows) или [Linux](#linux) .

## <a name="disk-sizes"></a>Размеры диска

[!INCLUDE [virtual-machines-disks-shared-sizes](virtual-machines-disks-shared-sizes.md)]

## <a name="sample-workloads"></a>Примеры рабочих нагрузок

### <a name="windows"></a>Windows

Общие диски Azure поддерживаются в Windows Server 2008 и более поздних версиях. Большинство кластеров на основе Windows, основанных на WSFC, которые обрабатывают всю основную инфраструктуру для обмена данными с узлом кластера, позволяя приложениям использовать шаблоны параллельного доступа. WSFC поддерживает решения на основе CSV и других форматов в зависимости от используемой версии Windows Server. Дополнительные сведения см. в разделе [Создание отказоустойчивого кластера](/windows-server/failover-clustering/create-failover-cluster).

Ниже перечислены некоторые популярные приложения, работающие в WSFC:

- [Создание FCI с общими дисками Azure (SQL Server на виртуальных машинах Azure)](../articles/azure-sql/virtual-machines/windows/failover-cluster-instance-azure-shared-disks-manually-configure.md)
- Масштабируемый файловый сервер (SoFS) [шаблон] (https://aka.ms/azure-shared-disk-sofs-template)
- SAP ASCS/SCS [шаблон] (https://aka.ms/azure-shared-disk-sapacs-template)
- файловый сервер для общего использования (рабочая нагрузка IW);
- диск профиля пользователя сервера удаленных рабочих столов (RDS UPD);

### <a name="linux"></a>Linux

Общие диски Azure поддерживаются в:
- [SUSE SLE для SAP и SUSE SLE HA 15 с пакетом обновления 1 (SP1) и выше](https://www.suse.com/c/azure-shared-disks-excercise-w-sles-for-sap-or-sle-ha/)
- [Ubuntu 18,04 и более поздние версии](https://discourse.ubuntu.com/t/ubuntu-high-availability-corosync-pacemaker-shared-disk-environments/14874)
- [Предварительная версия RHEL Developer в любой версии RHEL 8](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html-single/deploying_red_hat_enterprise_linux_8_on_public_cloud_platforms/index?lb_target=production#azure-configuring-shared-block-storage_configuring-rhel-high-availability-on-azure)
- [Oracle Enterprise Linux](https://docs.oracle.com/en/operating-systems/oracle-linux/8/availability/hacluster-1.html)

Кластеры Linux могут использовать диспетчеры кластеров, например [Pacemaker](https://wiki.clusterlabs.org/wiki/Pacemaker). Pacemaker построен на основе [Corosync](http://corosync.github.io/corosync/) и обеспечивает связь с кластером для приложений, развернутых в средах с высокой доступностью. Некоторые распространенные кластерные файловые системы включают [ocfs2](https://oss.oracle.com/projects/ocfs2/) и [gfs2](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/global_file_system_2/ch-overview-gfs2). Для арбитратинг доступа к диску можно использовать модели кластеризации постоянного резервирования SCSI (SCSI PR) и/или STONITH Block Device (SBD). При использовании интерфейса SCSI можно управлять резервированием и регистрацией с помощью таких служебных программ, как [fence_scsi](http://manpages.ubuntu.com/manpages/eoan/man8/fence_scsi.8.html) и [sg_persist](https://linux.die.net/man/8/sg_persist).

## <a name="persistent-reservation-flow"></a>Поток постоянного резервирования

На следующей схеме показан пример приложения кластеризованной базы данных с двумя узлами, которое использует SCSI PR для включения отработки отказа с одного узла на другой.

![Кластер с двумя узлами. Приложение, работающее в кластере, обеспечивает доступ к диску.](media/virtual-machines-disks-shared-disks/shared-disk-updated-two-node-cluster-diagram.png)

Процесс выглядит следующим образом:

1. Кластеризованное приложение, работающее и на Azure VM1, и на VM2, регистрирует свое намерение выполнить чтение или запись на диск.
1. Затем экземпляр приложения в VM1 выполняет монопольное резервирование для записи на диск.
1. Это резервирование применяется на диске Azure, и база данных теперь имеет эксклюзивное право записи на диск. Любые операции записи из экземпляра приложения в VM2 не будут выполнены.
1. Если экземпляр приложения в VM1 выходит из строя, экземпляр в VM2 может инициировать отработку отказа базы данных и перехватить контроль над диском.
1. Теперь он резервирует диске Azure, и этот диск больше не будет принимать операции записи от VM1. Он будет принимать только операции записи от VM2.
1. Кластеризованное приложение может завершить отработку отказа базы данных и обслуживать запросы от VM2.

На следующей схеме показана еще одна общая кластеризованная рабочая нагрузка, состоящая из нескольких узлов, считывающих данные с диска для выполнения параллельных процессов, таких как обучение моделей машинного обучения.

![Кластер виртуальных машин с четырьмя узлами. Каждый узел регистрирует намерение выполнить запись, приложение принимает монопольное резервирование для правильной обработки запросов на запись.](media/virtual-machines-disks-shared-disks/shared-disk-updated-machine-learning-trainer-model.png)

Процесс выглядит следующим образом:

1. Кластеризованное приложение, работающее на всех виртуальных машинах, регистрирует свое намерение выполнить чтение или запись на диск.
1. Экземпляр приложения в VM1 выполняет монопольное резервирование для записи на диск, а операции чтения с диска делаются доступными для других виртуальных машин.
1. Это резервирование принудительно применяется на диске Azure.
1. Теперь все узлы в кластере могут выполнять чтение с диска. Только один узел может записывать результаты обратно на диск от имени всех узлов в кластере.

### <a name="ultra-disks-reservation-flow"></a>Поток резервирования дисков (цен. категория "Ультра")

Диски в ценовой категории "Ультра" предлагают дополнительный регулятор рабочей нагрузки, то есть всего два регулятора. Из-за этого поток резервирования дисков в ценовой категории "Ультра" может работать, как описано в предыдущем разделе, или он может выполнять более детальное регулирование и распределение производительности.

:::image type="content" source="media/virtual-machines-disks-shared-disks/ultra-reservation-table.png" alt-text="Изображение таблицы, описывающее доступ &quot;только для чтения&quot; или &quot;чтение/запись&quot; для владельца резервирования, зарегистрированного и других.":::

## <a name="performance-throttles"></a>Регулировки производительности

### <a name="premium-ssd-performance-throttles"></a>SSD (цен. категория "Премиум") регулирования производительности

При использовании SSD уровня "Премиум" дисковые операции ввода-вывода и пропускная способность фиксированы, например, число операций ввода-вывода в секунду P30 — 5000 Это значение остается, если диск является общим для двух виртуальных машин или 5 виртуальных машин. Ограничения на доступ к диску можно получить с одной виртуальной машины или разделить на две или несколько виртуальных машин. 

### <a name="ultra-disk-performance-throttles"></a>Регулятор рабочей нагрузки дисков (цен. категория "Ультра")

Диски в ценовой категории "Ультра" дают уникальные возможности настройки производительности, предоставляя изменяемые атрибуты и позволяя изменять их. По умолчанию существует только два изменяемых атрибута, но общие диски этой категории имеют два дополнительных атрибута.


|attribute  |Описание  |
|---------|---------|
|DiskIOPSReadWrite     |Общее разрешенное количество операций ввода-вывода в секунду на всех виртуальных машинах, подключенных к общему диску с доступом на запись.         |
|DiskMBpsReadWrite     |Общая разрешенная пропускная способность (МБ/с) на всех виртуальных машинах, подключенных к общему диску с доступом на запись.         |
|DiskIOPSReadOnly*     |Общее количество операций ввода-вывода в секунду на всех виртуальных машинах, подключенных к общему диску как `ReadOnly` .         |
|DiskMBpsReadOnly*     |Общая пропускная способность (МБ/с), разрешенная на всех виртуальных машинах, подключенных к общему диску как `ReadOnly` .         |

\* Применяется только к общим дискам в ценовой категории "Ультра"

В следующих формулах объясняется, как можно задать атрибуты производительности, так как пользователи могут их изменять.

- DiskIOPSReadWrite/DiskIOPSReadOnly: 
    - до 300 операций ввода-вывода в секунду/ГиБ, но не более 160 000 операций ввода-вывода на диск.
    - Минимальное значение — 100 операций ввода-вывода в секунду.
    - DiskIOPSReadWrite  + DiskIOPSReadOnly — не менее 2 операций ввода-вывода в секунду/ГиБ.
- DiskMBpsRead    Write/DiskMBpsReadOnly:
    - Предельная пропускная способность одного диска — 256 КиБ/с для каждой подготовленной операции ввода-вывода в секунду, но не более 2000 Мбит/с на диск.
    - Минимальная гарантированная пропускная способность на диск — 4 КиБ/с для каждой подготовленной операции ввода-вывода, с общим базовым минимумом не менее 1 Мбит/с.

#### <a name="examples"></a>Примеры

В следующих примерах показано несколько сценариев, демонстрирующих, как регулирование может работать конкретно с общими дисками ценовой категории "Ультра".

##### <a name="two-nodes-cluster-using-cluster-shared-volumes"></a>Использование общих томов кластера двухузловым кластером

Ниже приведен пример кластера WSFC с двумя узлами, использующего кластеризованные общие тома. В такой конфигурации обе виртуальные машины имеют одновременный доступ на запись к диску, что приводит к `ReadWrite` разбиению регулирования между двумя виртуальными машинами и `ReadOnly` неиспользуемым регулированием.

:::image type="content" source="media/virtual-machines-disks-shared-disks/ultra-two-node-example.png" alt-text="Пример CSV с двумя узлами (цен. категория Ультра)":::

##### <a name="two-node-cluster-without-cluster-share-volumes"></a>Кластер с двумя узлами без общих томов кластера

Ниже приведен пример кластера WSFC с двумя узлами, не использующего кластеризованные общие тома. В такой конфигурации только одна виртуальная машина имеет доступ на запись к диску. В результате регулирование будет `ReadWrite` использоваться исключительно для основной виртуальной машины и `ReadOnly` регулирование используется только вторичной репликой.

:::image type="content" source="media/virtual-machines-disks-shared-disks/ultra-two-node-no-csv.png" alt-text="Пример CSV с двумя узлами без диска CSV в цен. категории Ультра":::

##### <a name="four-node-linux-cluster"></a>Кластер с четырьмя узлами Linux

Ниже приведен пример кластера Linux с 4 узлами с одним модулем записи и тремя модулями чтения с горизонтальным масштабированием. В такой конфигурации только одна виртуальная машина имеет доступ на запись к диску. В результате регулирование будет `ReadWrite` использоваться исключительно для основной виртуальной машины, а `ReadOnly` регулирование будет разбито на вторичные виртуальные машины.

:::image type="content" source="media/virtual-machines-disks-shared-disks/ultra-four-node-example.png" alt-text="Пример регулирования Ультра на четырех узлах":::

#### <a name="ultra-pricing"></a>Ultra ценах

Стоимость использования Ultra Shared дисков зависит от подготовленной емкости, общего числа подготовленных операций ввода-вывода в секунду (Дискиопсреадврите + Дискиопсреадонли) и общей пропускной способности Мбит/с (Дискмбпсреадврите + Дискмбпсреадонли). Дополнительная плата за каждую дополнительную виртуальную машину не взимается. Например, Ultra Shared Disk со следующей конфигурацией (Дисксизегб: 1024, Дискиопсреадврите: 10000, Дискмбпсреадврите: 600, Дискиопсреадонли: 100, Дискмбпсреадонли: 1) выставляются с 1024 гиб, 10100 операций ввода-вывода и 601 Мбит/с независимо от того, подключена ли она к двум виртуальным машинам или пяти виртуальным машинам.