---
author: dominicbetts
ms.author: dobett
ms.service: iot-pnp
ms.topic: include
ms.date: 11/20/2020
ms.openlocfilehash: 94451cfefefe30bbae1748844f9303b2cfdd7be1
ms.sourcegitcommit: f28ebb95ae9aaaff3f87d8388a09b41e0b3445b5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/30/2021
ms.locfileid: "104612255"
---
В этом руководстве показано, как создать пример приложения устройства IoT Plug and Play с компонентами, подключить его к центру Интернета вещей и с помощью обозревателя Интернета вещей Azure просмотреть сведения, отправляемые в центр. Пример приложения написан на языке Python и включен в пакет SDK для устройств центра Интернета вещей Azure для Python. Разработчик решения может использовать обозреватель Интернета вещей Azure, чтобы ознакомиться с возможностями устройства IoT Plug and Play, не просматривая код устройства.

Изучив это руководство, вы:

> [!div class="checklist"]
> * Скачайте пример кода.
> * Запустите пример приложения устройства и проверьте, подключается ли оно к вашему центру Интернета вещей.
> * Просмотрите исходный код.

## <a name="prerequisites"></a>Предварительные требования

[!INCLUDE [iot-pnp-prerequisites](iot-pnp-prerequisites.md)]

Для выполнения инструкций, приведенных в этом учебнике, на компьютере для разработки необходимо установить Python 3.7. Вы можете скачать последнюю рекомендуемую версию для нескольких платформ на сайте [python.org](https://www.python.org/). Проверить версию Python можно с помощью следующей команды:  

```cmd/sh
python --version
```

Вы можете скачать последнюю рекомендуемую версию для нескольких платформ на сайте [python.org](https://www.python.org/).

## <a name="download-the-code"></a>Загрузка кода

Пакет **azure-iot-device** опубликован как PIP.

В локальной среде Python установите пакет следующим образом:

```cmd/sh
pip install azure-iot-device
```

Если вы ознакомились с [Кратким руководством по подключению примера приложения устройства IoT Plug and Play в Windows к Центру Интернета вещей (Python)](../articles/iot-pnp/quickstart-connect-device.md), значит, вы уже клонировали репозиторий.

Клонируйте репозиторий пакета SDK Интернета вещей для Python:

```cmd/sh
git clone https://github.com/Azure/azure-iot-sdk-python
```

## <a name="review-the-code"></a>Просмотр кода

В этом примере реализуется устройство контроллера температуры IoT Plug and Play. Модель, которую реализует этот пример, использует [несколько компонентов](../articles/iot-pnp/concepts-modeling-guide.md). [Файл модели языка определения Digital Twins (DTDL) для устройства определения температуры](https://github.com/Azure/opendigitaltwins-dtdl/blob/master/DTDL/v2/samples/TemperatureController.json) определяет телеметрию, свойства и команды, реализуемые устройством.

В папке *azure-iot-sdk-python\azure-iot-device\samples\pnp* содержится пример кода для устройства IoT Plug and Play. Ниже приведены файлы для устройства контроля температуры:

- temp_controller_with_thermostats.py
- pnp_helper.py

Устройство для контроля температуры имеет несколько компонентов и компонент по умолчанию на основе модели DTDL.

Откройте файл *temp_controller_with_thermostats.py* в любом редакторе. Код в этом файле:

1. Импортирует `pnp_helper.py`, чтобы получить доступ к вспомогательным методам.

1. Определяет два идентификатора модели цифрового двойника (DTMIs), которые уникальным образом представляют два разных интерфейса, определенные в модели DTDL. Компоненты в реальном контроллере температуры должны реализовывать эти два интерфейса. Эти два интерфейса уже опубликованы в центральном репозитории. Эти DTMIs должны быть известны пользователю и изменяться в зависимости от сценария реализации устройства. Для текущего примера эти два интерфейса представляют собой:

    - Терморегулятор.
    - Сведения об устройстве, разработанном Azure.

1. Определяет DTMI `model_id` для реализуемого устройства. DTMI определяется пользователем и должен соответствовать DTMI в файле модели DTDL.

1. Определяет имена, присвоенные компонентам в файле DTDL. В DTDL есть два терморегулятора и один информационный компонент устройства. Константа `serial_number` также определяется в компоненте по умолчанию. Невозможно изменить `serial_number` устройства.

1. Определяет реализации обработчика команд. Они определяют действия устройства при получении запросов команд.

1. Определяет функции для создания ответа команды. Они определяют реакцию устройства на запросы команд. Функции ответа команды создаются, если команде необходимо отправить пользовательский ответ обратно в Центр Интернета вещей. Если функция ответа для команды не указана, отправляется универсальный ответ. В этом примере пользовательский ответ есть только у команды **getMaxMinReport**.

1. Определяет функцию для отправки данных телеметрии с этого устройства. Данные телеметрии отправляются с помощью терморегуляторов и компонента по умолчанию. Эта функция принимает дополнительный параметр имени компонента, чтобы определить, какой компонент отправил данные телеметрии.

1. Определяет прослушиватель для запросов команд.

1. Определяет прослушиватель для требуемых обновлений свойств.

1. Имеет функцию `main`, которая:

    - Использует пакет SDK для устройств для создания клиента устройства и подключения к Центру Интернета вещей. Устройство отправляет `model_id`, чтобы Центр Интернета вещей мог определить устройство IoT Plug and Play.

    - Использует функцию `create_reported_properties` во вспомогательном файле для создания свойств. Передайте имя компонента и свойства в виде пар "ключ — значение" для этой функции.

    - Обновляет доступные для чтения свойства своих компонентов путем вызова `patch_twin_reported_properties`.

    - Начинает прослушивание запросов команд с помощью функции `execute_command_listener`. Функция настраивает прослушиватель для запросов команд от службы. При настройке прослушивателя вы предоставляете параметры `method_name`, `user_command_handler` и дополнительный параметр `create_user_response_handler`.
        - `method_name` определяет запрос команды. В этом примере модель определяет команды **перезагрузки** и **getMaxMinReport**.
        - Функция `user_command_handler` определяет действия устройства при получении команды.
        - Функция `create_user_response_handler` создает ответ, который будет отправлен в Центр Интернета вещей при успешном выполнении команды. Этот ответ можно просмотреть на портале. Если эта функция не указана, в службу отправляется общий ответ.

    - Использует `execute_property_listener` для прослушивания обновлений свойств.

    - Начинает отправку телеметрии с помощью `send_telemetry`. В примере кода используется цикл для вызова трех функций отправки телеметрии. Все они вызываются каждые восемь секунд

    - Отключает все прослушиватели и задачи и выходит из цикла при нажатии кнопки **Q** или **q**.

[!INCLUDE [iot-pnp-environment](iot-pnp-environment.md)]

Дополнительные сведения о примере конфигурации см. в [образце файла сведений](https://github.com/Azure/azure-iot-sdk-python/blob/master/azure-iot-device/samples/pnp/README.md).

Для запуска примера используйте следующую команду:

```cmd/sh
python temp_controller_with_thermostats.py
```

Пример устройства отправляет сообщения телеметрии каждые несколько секунд в Центр Интернета вещей.

Вы увидите приведенный ниже результат, который указывает на то, что устройство начало отправлять данные телеметрии в центр и готово к получению команд и обновлений свойств.

![Сообщения о подтверждении устройства](media/iot-pnp-multiple-components-python/multiple-component.png)

Продолжите работу примера, после того как выполните следующие действия.

## <a name="use-azure-iot-explorer-to-validate-the-code"></a>Проверка кода с помощью обозревателя Интернета вещей Azure

После запуска примера клиента устройства используйте обозреватель Интернета вещей Azure, чтобы убедиться, что он работает.

[!INCLUDE [iot-pnp-iot-explorer.md](iot-pnp-iot-explorer.md)]
