---
title: Что делать при прерывании работы службы Azure, которое влияет на управляемое устройство HSM — Azure Key Vault | Документация Майкрософт
description: Сведения о том, что делать в случае прерывания работы службы Azure, которое влияет на управляемое устройство HSM.
services: key-vault
author: amitbapat
ms.service: key-vault
ms.subservice: general
ms.topic: tutorial
ms.date: 09/15/2020
ms.author: ambapat
ms.openlocfilehash: 8c284e9993002f6e05e41ca00d00b388feef8f82
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "100376009"
---
# <a name="managed-hsm-disaster-recovery"></a>Аварийное восстановление управляемого устройства HSM

Создание точной реплики HSM может потребоваться, если оригинал утрачен или стал недоступен по одной из следующих причин:

- Устройство было удалено, а затем очищено.
- Разрушительный сбой в регионе привел к уничтожению всех разделов в нем.

Вы можете повторно создать экземпляр HSM в том же или другом регионе, если у вас есть следующее:
- [домен безопасности](security-domain.md) исходного устройства HSM;
- закрытые ключи (не меньше кворума), которые шифруют этот домен безопасности;
- самая свежая [полная резервная копия](backup-restore.md) исходного устройства HSM.

Ниже перечислены шаги процедуры аварийного восстановления.

1. Создайте новый экземпляр HSM.
1. Запустите процесс "Восстановление домена безопасности". Будет создана новая пара ключей RSA (ключи обмена доменами безопасности) для переноса домена безопасности, и в ответе службы вы получите открытый ключ SecurityDomainExchangeKey из этой пары.
1. Создайте "файл переноса домена безопасности" и отправьте его в службу. Для этого потребуются закрытые ключи, которые шифруют домен безопасности. Закрытые ключи при этом используются только локально и никогда никуда не передаются.
1. Создайте резервную копию нового устройства HSM. Эта резервная копия является обязательной для любого восстановления, даже если устройство HSM пустое. Резервные копии позволяют легко выполнять откат.
1. Восстановите последнюю резервную копию исходного устройства HSM.

С помощью этих инструкций вы сможете вручную выполнить репликацию содержимого HSM в другой регион. Имя HSM (и URI конечной точки службы) будет отличаться. Поэтому, возможно, потребуется изменить конфигурацию приложения, чтобы использовать эти ключи из другого расположения.

## <a name="create-a-new-managed-hsm"></a>Создание управляемого устройства HSM

С помощью команды `az keyvault create` создайте управляемое устройство HSM. Этот скрипт принимает три обязательных параметра: имя группы ресурсов, имя HSM и географическое расположение.

Для создания ресурса управляемого устройства HSM необходимо указать следующие входные данные:

- имя устройства HSM;
- группа ресурсов в вашей подписке, в которой этот ресурс будет размещен;
- расположение Azure;
- список первых администраторов.

В приведенном ниже примере создается устройство HSM с именем **ContosoMHSM** в группе ресурсов **ContosoResourceGroup**, размещенной в регионе **Восточная часть США 2**, и для него в качестве единственного администратора задается **текущий пользователь, выполнивший вход**.

```azurecli-interactive
oid=$(az ad signed-in-user show --query objectId -o tsv)
az keyvault create --hsm-name "ContosoMHSM" --resource-group "ContosoResourceGroup" --location "East US 2" --administrators $oid
```

> [!NOTE]
> Выполнение команды создания может занять несколько минут. После ее успешного завершения вы можете активировать новое устройство HSM.

В выходных данных команды вы увидите свойства созданного управляемого устройства HSM. Среди всех свойств есть два самых важных:

* **name**. В этом примере используется имя ContosoMHSM. Вы будете использовать это имя для выполнения других команд хранилища ключей.
* **hsmUri.** В этом примере универсальный код ресурса (URI) — https://contosohsm.managedhsm.azure.net. Приложения, использующие HSM через REST API, должны использовать именно этот универсальный код ресурса (URI).

Теперь ваша учетная запись Azure авторизована, и вы можете выполнять любые операции на этом управляемом устройстве HSM. Но пока никто другой не авторизован.

## <a name="activate-the-security-domain-recovery-mode"></a>Перейдите в режим "Восстановление домена безопасности".

При обычном процессе создания на этом этапе инициализируется и скачивается новый домен безопасности. Но сейчас мы выполняем процедуру аварийного восстановления, поэтому следует перевести HSM в режим восстановления домена безопасности и скачать ключ обмена доменами безопасности. Ключ обмена доменами безопасности представляет собой открытый ключ RSA, который будет применен для шифрования домена безопасности перед отправкой на устройство HSM. Соответствующий закрытый ключ безопасно хранится внутри HSM, гарантируя сохранность содержимого домена безопасности во время перемещения.

```azurecli-interactive
az keyvault security-domain init-recovery --hsm-name ContosoMHSM2 --sd-exchange-key ContosoMHSM2-SDE.cer
```

## <a name="upload-security-domain-to-destination-hsm"></a>Отправка домена безопасности на целевое устройство HSM

Для этого шага вам потребуется следующее:
- ключ обмена доменами безопасности, скачанный на предыдущем шаге;
- домен безопасности исходного устройства HSM;
- один или несколько закрытых ключей (не меньше кворума), которые использовались для шифрования домена безопасности.

Команда `az keyvault security-domain upload` выполняет следующие операции.

- Расшифровывает домен безопасности исходного устройства HSM, используя предоставленные вами закрытые ключи. 
- Создает большой двоичный объект для передачи домена безопасности, шифруя его с помощью ключа обмена доменами безопасности, который мы скачали на предыдущем шаге.
- Отправляет большой двоичный объект для передачи домена безопасности в HSM, где будет завершен процесс восстановления домена безопасности.

В примере ниже используется домен безопасности устройства **ContosoMHSM** и два его закрытых ключа, а результат отправляется на устройство **ContosoMHSM2**, которое ожидает получения домена безопасности. 

```azurecli-interactive
az keyvault security-domain upload --hsm-name ContosoMHSM2 --sd-exchange-key ContosoMHSM-SDE.cer --sd-file ContosoMHSM-SD.json --sd-wrapping-keys cert_0.key cert_1.key
```

Теперь исходное (ContosoMHSM) и целевое устройство HSM (ContosoMHSM2) содержат один и тот же домен безопасности. Это означает, что вы можете восстановить полную резервную копию исходного устройства HSM в целевое устройство HSM.

## <a name="create-a-backup-as-a-restore-point-of-your-new-hsm"></a>Создание резервной копии (точки восстановления) нового устройства HSM

Перед выполнением полного восстановления HSM мы рекомендуем всегда создавать полную резервную копию, чтобы сохранить точку восстановления на тот случай, если с восстановлением что-то пойдет не так.

Чтобы создать резервную копию HSM, вам потребуется следующее:
- учетная запись хранения, где будет храниться резервная копия;
- контейнер хранилища BLOB-объектов в этой учетной записи хранения, где процесс резервного копирования создаст новую папку для хранения зашифрованной резервной копии.

Мы используем команду `az keyvault backup`, чтобы создать резервную копию HSM в контейнере хранилища **mhsmbackupcontainer**, размещенном в учетной записи хранения **ContosoBackup**, для приведенного ниже примера. Мы создаем маркер SAS со сроком действия 30 минут и передаем его на управляемое устройство HSM для записи резервной копии.

```azurecli-interactive
end=$(date -u -d "500 minutes" '+%Y-%m-%dT%H:%MZ')
skey=$(az storage account keys list --query '[0].value' -o tsv --account-name ContosoBackup)
az storage container create --account-name  mhsmdemobackup --name mhsmbackupcontainer  --account-key $skey
sas=$(az storage container generate-sas -n mhsmbackupcontainer --account-name ContosoBackup --permissions crdw --expiry $end --account-key $skey -o tsv)
az keyvault backup start --hsm-name ContosoMHSM2 --storage-account-name ContosoBackup --blob-container-name mhsmdemobackupcontainer --storage-container-SAS-token $sas

```

## <a name="restore-backup-from-source-hsm"></a>Восстановление резервной копии исходного устройства HSM

Для этого шага вам потребуется следующее:

- учетная запись хранения и контейнер больших двоичных объектов, где хранятся резервные копии исходного устройства HSM;
- имя папки, из которой нужно восстановить резервную копию (если вы регулярно создавали резервные копии, в этом контейнере будет много папок).


```azurecli-interactive
end=$(date -u -d "500 minutes" '+%Y-%m-%dT%H:%MZ')
skey=$(az storage account keys list --query '[0].value' -o tsv --account-name ContosoBackup)
sas=$(az storage container generate-sas -n mhsmdemobackupcontainer --account-name ContosoBackup --permissions rl --expiry $end --account-key $skey -o tsv)
az keyvault restore start --hsm-name ContosoMHSM2 --storage-account-name ContosoBackup --blob-container-name mhsmdemobackupcontainer --storage-container-SAS-token $sas --backup-folder mhsm-ContosoMHSM-2020083120161860
```

Итак, вы завершили процесс полного аварийного восстановления. Теперь на целевом устройстве HSM восстановлено содержимое исходного устройства HSM на момент создания резервной копии, включая все ключи, версии, атрибуты, теги и назначения ролей.

## <a name="next-steps"></a>Дальнейшие действия

- Дополнительные сведения о домене безопасности см. в статье [о домене безопасности управляемого устройства HSM](security-domain.md).
- Изучите также [рекомендации по использованию управляемого устройства HSM](best-practices.md).
