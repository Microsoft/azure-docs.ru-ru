---
title: Краткое руководство. Подготовка и активация управляемого устройства HSM Azure
description: Краткое руководство по подготовке и активации Управляемого устройства HSM с помощью Azure CLI
services: key-vault
author: amitbapat
tags: azure-resource-manager
ms.service: key-vault
ms.subservice: managed-hsm
ms.topic: quickstart
ms.date: 09/15/2020
ms.author: ambapat
ms.openlocfilehash: 86d0a336a7d3f5d12ed8e53de802616f839f9eba
ms.sourcegitcommit: f28ebb95ae9aaaff3f87d8388a09b41e0b3445b5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/29/2021
ms.locfileid: "91756827"
---
# <a name="quickstart-provision-and-activate-a-managed-hsm-using-azure-cli"></a>Краткое руководство. Подготовка и активация управляемого устройства HSM с помощью Azure CLI

Управляемое устройство HSM в Azure Key Vault — это полностью управляемая высокодоступная однотенантная соответствующая стандартам облачная служба, которая позволяет защищать криптографические ключи для облачных приложений, используя устройства HSM, отвечающие стандартам **FIPS 140-2 уровня 3**. Дополнительные сведения об управляемых устройствах HSM см. в этом [обзоре](overview.md). 

Используя сведения из этого краткого руководства, вы создадите и активируете управляемое устройство HSM с помощью Azure CLI. После этого вы сохраните в нем секрет.

## <a name="prerequisites"></a>Предварительные требования

Чтобы выполнить действия, описанные в этой статье, вам потребуется следующее:

* подписка на Microsoft Azure. Если у вас ее нет, зарегистрируйтесь, чтобы воспользоваться [бесплатной пробной версией](https://azure.microsoft.com/pricing/free-trial).
* Azure CLI 2.12.0 или более поздней версии. Чтобы узнать версию, выполните команду `az --version`. Если вам необходимо выполнить установку или обновление, см. статью [Установка Azure CLI]( /cli/azure/install-azure-cli).
* Управляемое устройство HSM в подписке. См. [Краткое руководство. Подготовка и активация управляемого устройства HSM с помощью Azure CLI](quick-create-cli.md) для выполнения соответствующих действий.

[!INCLUDE [cloud-shell-try-it.md](../../../includes/cloud-shell-try-it.md)]

## <a name="sign-in-to-azure"></a>Вход в Azure

Чтобы войти в Azure с помощью CLI, введите следующее:

```azurecli
az login
```

## <a name="create-a-resource-group"></a>Создание группы ресурсов

Группа ресурсов — это логический контейнер, в котором происходит развертывание ресурсов Azure и управление ими. В следующем примере создается группа ресурсов с именем *ContosoResourceGroup* в расположении *eastus2*.

```azurecli-interactive
az group create --name "ContosoResourceGroup" --location eastus2
```

## <a name="create-a-managed-hsm"></a>Создание управляемого устройства HSM

Создание управляемого устройства HSM выполняется в два этапа:
1. Подготовка ресурса управляемого устройства HSM.
1. Активация управляемого устройства HSM с помощью загрузки домена безопасности.

### <a name="provision-a-managed-hsm"></a>Подготовка управляемого устройства HSM

С помощью команды `az keyvault create` создайте управляемое устройство HSM. Этот скрипт принимает три обязательных параметра: имя группы ресурсов, имя HSM и географическое расположение.

Для создания ресурса управляемого устройства HSM необходимо указать приведенные ниже входные данные.
- Группа ресурсов в вашей подписке, в которой он будет размещен.
- Расположение Azure.
- Список первых администраторов.

В приведенном ниже примере создается устройство HSM с именем **ContosoMHSM** в группе ресурсов **ContosoResourceGroup**, размещенной в регионе **Восточная часть США 2**, и для него в качестве единственного администратора задается **текущий пользователь, выполнивший вход**.

```azurecli-interactive
oid=$(az ad signed-in-user show --query objectId -o tsv)
az keyvault create --hsm-name "ContosoMHSM" --resource-group "ContosoResourceGroup" --location "East US 2" --administrators $oid
```

> [!NOTE]
> Команда создания может выполняться несколько минут. После успешного ее завершения вы можете активировать HSM.

В выходных данных команды вы увидите свойства созданного управляемого устройства HSM. Среди всех свойств есть два самых важных:

* **name**. В этом примере используется имя ContosoMHSM. Вы будете использовать это имя для выполнения других команд хранилища ключей.
* **hsmUri.** В этом примере универсальный код ресурса (URI) — https://contosohsm.managedhsm.azure.net. Приложения, использующие HSM через REST API, должны использовать именно этот универсальный код ресурса (URI).

Теперь ваша учетная запись Azure авторизована, и вы можете выполнять любые операции на этом управляемом устройстве HSM. Но пока никто другой не авторизован.

### <a name="activate-your-managed-hsm"></a>Активация управляемого устройства HSM

Все команды плоскости данных отключены до тех пор, пока не будет активировано устройство HSM. Вы не сможете создавать ключи или назначать роли. Только администраторы, назначенные во время выполнения команды создания, могут активировать HSM. Чтобы активировать HSM, необходимо загрузить [домен безопасности](security-domain.md).

Чтобы активировать необходимый модуль HSM, выполните следующие действия:
- получите минимум 3 пары ключей RSA (максимум 10);
- укажите минимальное число ключей, необходимых для расшифровки домена безопасности (кворум).

Чтобы активировать устройство HSM, отправьте в него по крайней мере 3 (максимум 10) открытых ключей RSA. HSM шифрует домен безопасности с помощью этих ключей и отправляет их обратно. После успешного завершения загрузки домена безопасности устройство HSM готово к использованию. Также необходимо указать кворум, который является минимальным числом закрытых ключей, необходимых для расшифровки домена безопасности.

В приведенном ниже примере показано использование `openssl` для создания 3 самозаверяющих сертификатов.

```azurecli-interactive
openssl req -newkey rsa:2048 -nodes -keyout cert_0.key -x509 -days 365 -out cert_0.cer
openssl req -newkey rsa:2048 -nodes -keyout cert_1.key -x509 -days 365 -out cert_1.cer
openssl req -newkey rsa:2048 -nodes -keyout cert_2.key -x509 -days 365 -out cert_2.cer
```

> [!IMPORTANT]
> Безопасно создайте и сохраните пары ключей RSA и файл домена безопасности.

Выполните команду `az keyvault security-domain download`, чтобы скачать домен безопасности и активировать управляемое устройство HSM. В приведенном ниже примере используются 3 пары ключей RSA (для этой команды требуются только открытые ключи) и кворум со значением 2.

```azurecli-interactive
az keyvault security-domain download --hsm-name ContosoMHSM --sd-wrapping-keys ./certs/cert_0.cer ./certs/cert_1.cer ./certs/cert_2.cer --sd-quorum 2 --security-domain-file ContosoMHSM-SD.json
```

Надежно сохраните файл домена безопасности и пары ключей RSA. Они понадобятся вам для аварийного восстановления или создания другого управляемого устройства HSM, которое использует тот же домен безопасности (поэтому они могут совместно использовать ключи).

После успешной загрузки домена безопасности устройство HSM будет находиться в активном состоянии и готово к использованию.

## <a name="clean-up-resources"></a>Очистка ресурсов

Другие руководства в этой серии созданы на основе этого документа. Если вы планируете продолжить работу с последующими краткими руководствами и статьями, эти ресурсы можно не удалять.

Вы можете удалить ставшие ненужными группу ресурсов и все связанные с ней ресурсы, выполнив команду [az group delete](/cli/azure/group). Удалите ресурсы следующим образом:

```azurecli-interactive
az group delete --name ContosoResourceGroup
```

## <a name="next-steps"></a>Дальнейшие действия

С помощью этого краткого руководства вы создали Key Vault и сохранили в нем секрет. Дополнительные сведения о Key Vault и его интеграции в приложения см. в следующих статьях.

- Ознакомьтесь с [обзором управляемого устройства HSM](overview.md).
- Просмотрите дополнительные сведения об [управлении ключами в управляемом устройстве HSM](key-management.md).
- Изучите [рекомендации по использованию управляемого устройства HSM](best-practices.md).
