---
title: Руководство по регулированию хранилища ключей Azure
description: Регулирование Key Vault позволяет ограничить число одновременных вызовов для предотвращения чрезмерного использования ресурсов.
services: key-vault
author: msmbaldwin
manager: rkarlin
ms.service: key-vault
ms.subservice: general
ms.topic: conceptual
ms.date: 12/02/2019
ms.author: mbaldwin
ms.openlocfilehash: 7bdc3ac517df6b73fba7231cfe0fdc9855803782
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "102175759"
---
# <a name="azure-key-vault-throttling-guidance"></a>Руководство по регулированию хранилища ключей Azure

Регулирование — это процесс, позволяющий ограничить число одновременных вызовов к службе Azure для предотвращения чрезмерного использования ресурсов. Хранилище ключей Azure (AKV) может обрабатывать большое число запросов. Если это число превышает приемлемое, для обеспечения оптимальной производительности и надежности службы AKV используется регулирование клиентских запросов.

Ограничения регулирования зависят от сценария. Например, при выполнении большого объема операций записи возможность регулирования будет более высокой по сравнению с ситуацией, когда выполняются только операции чтения.

## <a name="how-does-key-vault-handle-its-limits"></a>Как хранилище ключей обрабатывает свои ограничения?

Ограничения службы в Key Vault предотвращают неправильное использование ресурсов и гарантируют качество обслуживания для всех клиентов Key Vault. При превышении порогового значения службы Key Vault ограничивает все последующие запросы от этого клиента на период времени, возвращает код состояния HTTP 429 (слишком много запросов), и запрос завершается ошибкой. Неудачные запросы, возвращающие 429, не учитываются в ограничениях регулирования, отслеживаниющих Key Vault. 

Key Vault изначально была разработана для хранения и извлечения секретов во время развертывания.  Мир изменился, а Key Vault используется во время выполнения для хранения и получения секретов, и часто приложения и службы хотят использовать Key Vault, например базу данных.  Текущие ограничения не поддерживают высокие показатели пропускной способности.

Изначально Key Vault были созданы с учетом ограничений, заданных в [ограничениях службы Azure Key Vault](service-limits.md).  Ниже приведены некоторые рекомендуемые рекомендации и рекомендации по максимальному повышению пропускной способности для Key Vault с помощью ставок.
1. Убедитесь, что вы выполнили регулирование.  Клиент должен учитывать экспоненциальные политики для 429 и выполнять повторные попытки согласно приведенным ниже рекомендациям.
1. Разделите Key Vault трафик между несколькими хранилищами и различными регионами.   Используйте отдельное хранилище для каждого домена безопасности и доступности.   Если у вас пять приложений, каждый из которых находится в двух регионах, мы рекомендуем 10 хранилищ, каждый из которых содержит секреты, уникальные для приложения и региона.  Ограничение на уровне подписки для всех типов транзакций составляет пять раз в пределах отдельного хранилища ключей. Например, для других транзакций HSM на каждую подписку предусмотрено максимум 5000 транзакций в течение 10 секунд. Рассмотрите возможность кэширования секрета в службе или приложении, чтобы также сократить число RP непосредственно в хранилище ключей и (или) обработки трафика на основе пакетов.  Вы также можете разделить трафик между разными регионами, чтобы максимально сокращать задержку и использовать другую подписку или хранилище.  Не отправляйте больше предельного числа подписок в службу Key Vault в одном регионе Azure.
1. Кэшировать секреты, получаемые из Azure Key Vault в памяти, и по возможности повторно использовать память из памяти.  Повторное чтение из Azure Key Vault только в том случае, если кэшированная копия перестанет работать (например, повернута в источнике). 
1. Key Vault предназначен для собственных секретов служб.   Если вы храните секреты клиентов (особенно для сценариев хранения ключей с высокой пропускной способностью), рассмотрите возможность размещения ключей в базе данных или учетной записи хранения с шифрованием и сохранением только главного ключа в Azure Key Vault.
1. Шифрование, перенос и проверка операций с открытым ключом можно выполнять без доступа к Key Vault, что не только снижает риск регулирования, но также повышает надежность (при условии, что вы правильно кэшируете материал открытого ключа).
1. Если для хранения учетных данных для службы используется Key Vault, проверьте, поддерживает ли служба аутентификация Azure AD проверку подлинности напрямую. Это сокращает нагрузку на Key Vault, повышает надежность и упрощает код, так как Key Vault теперь может использовать маркер Azure AD.  Многие службы перешли на использование проверки подлинности Azure AD.  См. текущий список [служб, поддерживающих управляемые удостоверения для ресурсов Azure](../../active-directory/managed-identities-azure-resources/services-support-managed-identities.md#azure-services-that-support-managed-identities-for-azure-resources).
1. Рассмотрите возможность разнесения нагрузки или развертывания в течение более длительного периода времени, чтобы остаться в пределах текущих ограничений RPS.
1. Если приложение состоит из нескольких узлов, которым необходимо считать одни и те же секреты, рассмотрите возможность использования шаблона out, где одна сущность считывает секрет из Key Vault и вентиляторы выходят на все узлы.   Кэширование извлеченных секретов только в памяти.
Если вы обнаружите, что описанные выше действия не соответствуют вашим потребностям, заполните приведенную ниже таблицу и свяжитесь с нами, чтобы определить дополнительную емкость, которую можно добавить (пример приведен ниже для наглядности).

| Имя хранилища | Регион хранилища | Тип объекта (секрет, ключ или сертификат) | Операции * | Тип ключа | Длина ключа или кривая | Ключ HSM?| Требуется устойчивый RPS для состояния | Требуется пиковое число RPS |
|--|--|--|--|--|--|--|--|--|
| https://mykeyvault.vault.azure.net/ | | Ключ | Sign | EC | P-256 | нет | 200 | 1000 |

\* Полный список возможных значений см. в разделе [операции Azure Key Vault](/rest/api/keyvault/key-operations).

Если вы утвердите дополнительную емкость, обратите внимание на следующее:
1. Изменения модели согласованности данных. После того как хранилище разрешается в соответствии с дополнительными возможностями пропускной способности, согласованность данных службы Key Vault гарантируется (это необходимо для удовлетворения большего количества RPS, так как служба хранилища Azure не может поддерживаться).  Если говорить кратко,
  1. **Без разрешения списка**: служба Key Vault будет отражать результаты операции записи (например, Secret, CreateKey) сразу же в последующих вызовах (например, Секретжет, Кэйсигн).
  1. **С разрешающим списком**: Key Vault служба будет отражать результаты операции записи (например, Secret, CreateKey) в течение 60 секунд в последующих вызовах (например, Секретжет, Кэйсигн).
1. Клиентский код должен учитывать политику обратного отключения для 429 повторных попыток. Клиентский код, вызывающий службу Key Vault, не должен немедленно повторять запросы Key Vault при получении кода ответа 429.  Руководство по регулированию Azure Key Vault, опубликованное здесь, рекомендует применить экспоненциальную задержку при получении кода ответа HTTP 429.

Если у вас есть реальный пример использования с более высокими ограничениями регулирования, пожалуйста, расскажите нам о нем.

## <a name="how-to-throttle-your-app-in-response-to-service-limits"></a>Регулирование приложения в ответ на ограничения служб

Ниже **приведены рекомендации, которые** следует реализовать при регулировании службы.
- Сократите число операций на один запрос.
- Уменьшите частоту запросов.
- Избегайте немедленных повторных попыток. 
    - Все запросы учитываются, и их количество сравнивается с ограничениями использования.

При реализации обработки ошибок для приложения используйте код ошибки HTTP 429, чтобы определить необходимость регулирования на стороне клиента. Если запрос снова завершается сбоем с кодом ошибки HTTP 429, это означает, что вы по-прежнему не соблюдаете ограничения службы Azure. Продолжайте использовать рекомендуемый метод регулирования на стороне клиента и повторяйте выполнять запрос, пока он не будет успешно выполнен.

Ниже показан код, который реализует экспоненциальную задержку. 
```
SecretClientOptions options = new SecretClientOptions()
    {
        Retry =
        {
            Delay= TimeSpan.FromSeconds(2),
            MaxDelay = TimeSpan.FromSeconds(16),
            MaxRetries = 5,
            Mode = RetryMode.Exponential
         }
    };
    var client = new SecretClient(new Uri("https://keyVaultName.vault.azure.net"), new DefaultAzureCredential(),options);
                                 
    //Retrieve Secret
    secret = client.GetSecret(secretName);
```


Использовать этот код в клиентском приложении C# очень просто. 

### <a name="recommended-client-side-throttling-method"></a>Рекомендуемый метод регулирования на стороне клиента

При возврате кода ошибки HTTP 429 начните регулирование клиента с помощью метода экспоненциального откладывания:

1. Подождите 1 с и повторите запрос
2. Если запрос по-прежнему не выполнен, подождите 2 с и повторите запрос
3. Если запрос по-прежнему не выполнен, подождите 4 с и повторите запрос
4. Если запрос по-прежнему не выполнен, подождите 8 с и повторите запрос
5. Если запрос по-прежнему не выполнен, подождите 16 с и повторите запрос

На этом этапе вы не должны получать коды ответа HTTP 429.

## <a name="see-also"></a>См. также раздел

Более подробные сведения о регулировании для Microsoft Cloud см. в разделе [Шаблон регулирования](/azure/architecture/patterns/throttling).
