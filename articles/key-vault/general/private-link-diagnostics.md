---
title: Диагностика проблем с конфигурацией Приватных каналов в Azure Key Vault
description: Устранение распространенных проблем с частными ссылками с Key Vault и углубленным углублением в конфигурацию
author: msfcolombo
ms.author: fcolombo
ms.date: 09/30/2020
ms.service: key-vault
ms.subservice: general
ms.topic: how-to
ms.openlocfilehash: 03abe4e4e098d46060e33ba114872905e54a443f
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "96317068"
---
# <a name="diagnose-private-links-configuration-issues-on-azure-key-vault"></a>Диагностика проблем с конфигурацией Приватных каналов в Azure Key Vault

## <a name="introduction"></a>Введение

Эта статья поможет пользователям диагностировать и устранять проблемы, связанные с Key Vault и функцией закрытых ссылок. Это руководство поможет в аспектах настройки, таких как получение частных ссылок в первый раз, или исправление ситуации, когда частные связи перестали работать из-за некоторых изменений.

Если вы не знакомы с этой функцией, см. статью [интеграция Key Vault с помощью частного канала Azure](private-link-service.md).

### <a name="problems-covered-by-this-article"></a>Проблемы, описываемые в этой статье

- Запросы DNS по-прежнему возвращают общедоступный IP-адрес для хранилища ключей, а не частный IP-адрес, с помощью которого вы ожидаете использовать функции закрытых ссылок.
- Все запросы, выполняемые данным клиентом, которые используют закрытую связь, завершаются сбоем с истечением времени ожидания или ошибками сети, и проблема не является временной.
- Хранилище ключей имеет частный IP-адрес, но запросы по-прежнему получают `403` ответ с `ForbiddenByFirewall` кодом внутренней ошибки.
- Вы используете частные ссылки, но хранилище ключей по-прежнему принимает запросы из общедоступного Интернета.
- В вашем хранилище ключей есть две частные конечные точки. Запросы, использующие один, работают нормально, но запросы, использующие другой, завершаются сбоем.
- У вас есть другая подписка, хранилище ключей или виртуальная сеть, использующие частные ссылки. Вы хотите создать новое аналогичное развертывание, но не можете приступить к работе с частными ссылками.

### <a name="problems-not-covered-by-this-article"></a>Проблемы, не описываемые в этой статье

- Существует временная проблема с подключением. В данном клиенте вы увидите, что некоторые запросы работают и некоторые не работают. *Временные проблемы обычно не вызваны проблемой в конфигурации частных ссылок. они являются подписыванием перегрузки сети или клиента.*
- Вы используете продукт Azure, который поддерживает BYOK (создание собственных ключей), CMK (управляемые пользователем ключи) или доступ к секретам, хранящимся в хранилище ключей. При включении брандмауэра в параметрах хранилища ключей этот продукт не сможет получить доступ к хранилищу ключей. *Ознакомьтесь с документацией по продукту. Убедитесь, что он явно указывает на поддержку хранилищ ключей с включенным брандмауэром. При необходимости обратитесь в службу поддержки для конкретного продукта.*

### <a name="how-to-read-this-article"></a>Как читать эту статью

Если вы не знакомы с частными ссылками или оцениваете сложное развертывание, рекомендуется прочитать всю статью. В противном случае вы можете выбрать раздел, который лучше всего подходит для проблем, с которыми вы сталкиваетесь.

Приступим к работе!

## <a name="1-confirm-that-you-own-the-client-connection"></a>1. Подтвердите, что вы владеете клиентским подключением.

### <a name="confirm-that-your-client-runs-at-the-virtual-network"></a>Убедитесь, что ваш клиент работает в виртуальной сети.

Это краткое справочное по предназначено для решения проблем с подключением к хранилищу ключей, происходящим из кода приложения. Примеры — это приложения и скрипты, которые выполняются на виртуальных машинах Azure, кластерах Service Fabric Azure, службе приложений Azure, службе Azure Kubernetes (AKS) и других аналогичных. Это также относится к доступу, выполняемому в портал Azure пользовательском интерфейсе веб-базы, где браузер обращается к хранилищу ключей напрямую.

По определению частных ссылок приложение, сценарий или портал должны быть запущены на компьютере, кластере или в среде, подключенной к виртуальной сети, в которой был развернут [ресурс частной конечной точки](../../private-link/private-endpoint-overview.md) .

Если приложение, сценарий или портал выполняются в произвольной сети, подключенной к Интернету, это правило неприменимо, и скорее всего нельзя использовать закрытые ссылки. Это ограничение также применимо к командам, выполняемым в Azure Cloud Shell, так как они выполняются на удаленном компьютере Azure по требованию, а не в браузере пользователя.

### <a name="if-you-use-a-managed-solution-refer-to-specific-documentation"></a>Если вы используете управляемое решение, обратитесь к конкретной документации.

Это неприменимо к решениям, которые управляются корпорацией Майкрософт, где доступ к хранилищу ключей осуществляется с помощью продукта Azure, который существует независимо от виртуальной сети клиента. Примерами таких сценариев могут быть службы хранилища Azure или SQL Azure, настроенные для шифрования неактивных данных, данные шифрования концентратора событий Azure с помощью предоставленных клиентом ключей, фабрика данных Azure, которые обращаются к учетным данным службы, хранятся в хранилище ключей, Azure Pipelines получения секретов из хранилища ключей и других подобных сценариев. В таких случаях *необходимо проверить, поддерживает ли продукт хранилища ключей с включенным брандмауэром*. Эта поддержка обычно выполняется с помощью функции [доверенных служб](overview-vnet-service-endpoints.md#trusted-services) Key Vault брандмауэре. Однако многие продукты не включаются в список доверенных служб по различным причинам. В этом случае обратитесь в службу поддержки конкретного продукта.

Небольшое количество продуктов Azure поддерживает концепцию *внедрения виртуальной сети*. Говоря простым образом, продукт добавляет сетевое устройство в виртуальную сеть клиента, что позволяет ему отсылать запросы, как если бы оно было развернуто в виртуальной сети. Важным примером является [Azure Databricks](/azure/databricks/administration-guide/cloud-configurations/azure/vnet-inject). Подобные продукты могут выполнять запросы к хранилищу ключей с помощью частных ссылок, и это руководство по устранению неполадок может помочь.

## <a name="2-confirm-that-the-connection-is-approved-and-succeeded"></a>2. Убедитесь, что подключение утверждено и выполнено.

Следующие шаги проверяют, что подключение к частной конечной точке утверждено и выполнено.

1. Откройте портал Azure и откройте ресурс хранилища ключей.
2. В меню слева выберите **сеть**.
3. Перейдите на вкладку **подключения к частной конечной точке** . Будут показаны все подключения к частным конечным точкам и соответствующие состояния. Если подключения отсутствуют или отсутствует подключение к виртуальной сети, необходимо создать новую закрытую конечную точку. Это будет рассмотрено позже.
4. Находясь в **закрытых конечных точках**, найдите подходящие для диагностики и убедитесь, что "состояние подключения" **утверждено** , а "состояние подготовки" — **выполнено**.
    - Если подключение находится в состоянии "ожидание", вы можете просто утвердить его.
    - Если подключение "Отклонено", "сбой", "ошибка", "отключено" или другое состояние, это не эффективно, необходимо создать новый ресурс частной конечной точки.

Рекомендуется удалить недействующие подключения, чтобы не усложнять их.

## <a name="3-confirm-that-the-key-vault-firewall-is-properly-configured"></a>3. Убедитесь, что брандмауэр хранилища ключей настроен правильно.

>[!IMPORTANT]
> Изменение параметров брандмауэра может привести к удалению доступа с легальных клиентов, которые по-прежнему не используют частные ссылки. Убедитесь, что вы знаете о влиянии каждого изменения в конфигурации брандмауэра.

Важное понятие заключается в том, что функция частных ссылок *предоставляет* доступ к вашему хранилищу ключей только в виртуальной сети, которая закрыта для предотвращения утечка данных. Он не *удаляет* существующий доступ. Для эффективного блокирования доступа из общедоступного Интернета необходимо явно включить брандмауэр хранилища ключей:

1. Откройте портал Azure и откройте ресурс хранилища ключей.
2. В меню слева выберите **сеть**.
3. Убедитесь, что на вкладке **брандмауэры и виртуальные сети** выбран параметр поверх остальных.
4. Убедитесь, что выбран параметр **Частная конечная точка и выбранные сети** . Если вы нашли **все сети** , то узнаете, почему внешние клиенты по-прежнему могут получить доступ к хранилищу ключей.

Следующие инструкции также применяются к параметрам брандмауэра.

- Для компонента "частные ссылки" не требуется указывать виртуальную сеть в параметрах брандмауэра хранилища ключей. Все запросы, использующие частный IP-адрес хранилища ключей (см. следующий раздел), должны работать, даже если в параметрах брандмауэра хранилища ключей не указана виртуальная сеть.
- Функция "частные ссылки" не требует указания IP-адреса в параметрах брандмауэра хранилища ключей. Опять же, все запросы, использующие частный IP-адрес хранилища ключей, должны работать, даже если в параметрах брандмауэра не указан IP-адрес.

При использовании частных ссылок единственными причинами для указания виртуальной сети или IP-адреса в брандмауэре хранилища ключей являются:

- У вас есть Гибридная система, в которой некоторые клиенты используют частные связи, некоторые используют конечные точки службы, некоторые общедоступные IP-адреса.
- Выполняется переход на частные ссылки. В этом случае после подтверждения того, что все клиенты используют частные ссылки, следует удалить виртуальные сети и IP-адреса из параметров брандмауэра хранилища ключей.

## <a name="4-make-sure-the-key-vault-has-a-private-ip-address"></a>4. Убедитесь, что хранилище ключей имеет частный IP-адрес.

### <a name="difference-between-private-and-public-ip-addresses"></a>Различие между частными и общедоступными IP-адресами

Частный IP-адрес всегда имеет один из следующих форматов:

- 10. x. x. x: примеры: `10.1.2.3` , `10.56.34.12` .
- 172.16. x. x в 172.32. x. x: примеры: `172.20.1.1` , `172.31.67.89` .
- 192.168. x. x: примеры: `192.168.0.1` , `192.168.100.7`

Некоторые IP-адреса и диапазоны зарезервированы:

- 224. x. x. x: многоадресная рассылка
- 255.255.255.255: трансляция
- 127. x. x. x: замыкание на себя
- 169.254. x. x: локальная связь
- 168.63.129.16: внутренний DNS-сервер

Все остальные IP-адреса являются общедоступными.

При просмотре портала или выполнении команды, которая отображает IP-адрес, убедитесь, что этот IP-адрес является частным, общедоступным или зарезервированным. Чтобы частные ссылки работали, имя узла хранилища ключей должно разрешаться в частный IP-адрес, принадлежащий к адресному пространству виртуальной сети.

### <a name="find-the-key-vault-private-ip-address-in-the-virtual-network"></a>Поиск частного IP-адреса хранилища ключей в виртуальной сети

Необходимо будет диагностировать разрешение имен узлов и для этого необходимо знать точный частный IP-адрес хранилища ключей с включенными частными ссылками. Чтобы найти этот адрес, выполните следующую процедуру:

1. Откройте портал Azure и откройте ресурс хранилища ключей.
2. В меню слева выберите **сеть**.
3. Перейдите на вкладку **подключения к частной конечной точке** . Будут показаны все подключения к частным конечным точкам и соответствующие состояния.
4. Найдите подходящие для диагностики и убедитесь, что "состояние подключения" **утверждено** и состояние подготовки — " **выполнено**". Если вы не видите это, вернитесь к предыдущим разделам этого документа.
5. Когда вы найдете нужный элемент, щелкните ссылку в столбце **Частная конечная точка** . При этом будет открыт ресурс частной конечной точки.
6. На странице "Обзор" может отображаться раздел " **Настраиваемые параметры DNS**". Убедитесь, что существует только одна запись, соответствующая имени узла хранилища ключей. Эта запись отображает частный IP-адрес хранилища ключей.
7. Вы также можете щелкнуть ссылку в **сетевом интерфейсе** и убедиться, что частный IP-адрес совпадает с отображением на предыдущем шаге. Сетевой интерфейс — это виртуальное устройство, представляющее хранилище ключей.

IP-адрес — это тот, который виртуальные машины и другие устройства *, работающие в той же виртуальной сети* , будут использовать для подключения к хранилищу ключей. Запишите IP-адрес или откройте вкладку браузер и не нажимайте ее, пока вы проследите за дальнейшими исследованиями.

>[!NOTE]
> Если в вашем хранилище ключей есть несколько частных конечных точек, оно имеет несколько частных IP-адресов. Это полезно, только если у вас есть несколько виртуальных сетей, обращающихся к одному хранилищу ключей, каждое через собственную закрытую конечную точку (частная конечная точка принадлежит одной виртуальной сети). Убедитесь в диагностике проблемы для правильной виртуальной сети и выберите правильное подключение к частной конечной точке в процедуре выше. Кроме того, **не создавайте** несколько частных конечных точек для одного и того же Key Vault в одной виртуальной сети. Это не является необходимым и является источником путаницы.

## <a name="5-validate-the-dns-resolution"></a>5. Проверка разрешения DNS

Разрешение DNS — это процесс перевода имени узла хранилища ключей (например: `fabrikam.vault.azure.net` ) в IP-адрес (например `10.1.2.3` ,). В следующих подразделах показаны ожидаемые результаты разрешения DNS в каждом сценарии.

### <a name="key-vaults-without-private-link"></a>Хранилища ключей без закрытой ссылки

Этот раздел предназначен для обучения. Если в хранилище ключей нет подключения к частной конечной точке в утвержденном состоянии, разрешение имени узла приводит к результату, аналогичному следующему:

Windows:

```console
C:\> nslookup fabrikam.vault.azure.net
```

```output
Non-authoritative answer:
Address:  52.168.109.101
Aliases:  fabrikam.vault.azure.net
          data-prod-eus.vaultcore.azure.net
          data-prod-eus-region.vaultcore.azure.net
```

Linux:

```console
joe@MyUbuntu:~$ host fabrikam.vault.azure.net
```

```output
fabrikam.vault.azure.net is an alias for data-prod-eus.vaultcore.azure.net.
data-prod-eus.vaultcore.azure.net is an alias for data-prod-eus-region.vaultcore.azure.net.
data-prod-eus-region.vaultcore.azure.net has address 52.168.109.101
```

Вы видите, что имя разрешается в общедоступный IP-адрес, а псевдоним отсутствует `privatelink` . Псевдоним объясняется позже, не беспокойтесь о нем сейчас.

Приведенный выше результат является ожидаемым, независимо от того, подключен ли компьютер к виртуальной сети или является произвольным компьютером с подключением к Интернету. Это происходит потому, что в хранилище ключей нет подключения к частной конечной точке в утвержденном состоянии, поэтому хранилище ключей не должно поддерживать частные ссылки.

### <a name="key-vault-with-private-link-resolving-from-arbitrary-internet-machine"></a>Хранилище ключей с разрешениями частной связи с произвольного компьютера в Интернете

Если хранилище ключей имеет одну или несколько подключений к частной конечной точке в утвержденном состоянии и вы разрешаете имя узла с произвольного компьютера, подключенного к Интернету (компьютер, *не* подключенный к виртуальной сети, в которой находится частная конечная точка), вы должны найти следующее:

Windows:

```console
C:\> nslookup fabrikam.vault.azure.net
```

```output
Non-authoritative answer:
Address:  52.168.109.101
Aliases:  fabrikam.vault.azure.net
          fabrikam.privatelink.vaultcore.azure.net
          data-prod-eus.vaultcore.azure.net
          data-prod-eus-region.vaultcore.azure.net
```

Linux:

```console
joe@MyUbuntu:~$ host fabrikam.vault.azure.net
```

```output
fabrikam.vault.azure.net is an alias for fabrikam.privatelink.vaultcore.azure.net.
fabrikam.privatelink.vaultcore.azure.net is an alias for data-prod-eus.vaultcore.azure.net.
data-prod-eus.vaultcore.azure.net is an alias for data-prod-eus-region.vaultcore.azure.net.
data-prod-eus-region.vaultcore.azure.net has address 52.168.109.101
```

Важным отличием от предыдущего сценария является наличие нового псевдонима со значением `{vaultname}.privatelink.vaultcore.azure.net` . Это означает, что плоскость данных хранилища ключей готова принимать запросы от частных ссылок.

Это не означает, что запросы, выполненные на компьютерах *за пределами* виртуальной сети (например, только что использованной), будут использовать частные ссылки. Это видно из того факта, что имя узла по-прежнему разрешается в общедоступный IP-адрес. Только компьютеры *, подключенные к виртуальной сети,* могут использовать частные связи. Дополнительные сведения об этом будут ниже.

Если псевдоним не отображается `privatelink` , это означает, что в хранилище ключей нет подключений к частным конечным точкам в `Approved` состоянии. Вернитесь к [этому разделу](#2-confirm-that-the-connection-is-approved-and-succeeded) перед повторной попыткой.

### <a name="key-vault-with-private-link-resolving-from-virtual-network"></a>Хранилище ключей с разрешением частной связи из виртуальной сети

Если хранилище ключей имеет одно или несколько подключений к частной конечной точке в утвержденном состоянии и вы разрешаете имя узла с компьютера, подключенного к виртуальной сети, в которой была создана частная конечная точка, это ожидаемый ответ:

Windows:

```console
C:\> nslookup fabrikam.vault.azure.net
```

```output
Non-authoritative answer:
Address:  10.1.2.3
Aliases:  fabrikam.vault.azure.net
          fabrikam.privatelink.vaultcore.azure.net
```

Linux:

```console
joe@MyUbuntu:~$ host fabrikam.vault.azure.net
```

```output
fabrikam.vault.azure.net is an alias for fabrikam.privatelink.vaultcore.azure.net.
fabrikam.privatelink.vaultcore.azure.net has address 10.1.2.3
```

Существует два существенных отличия. Во-первых, имя разрешается в частный IP-адрес. Это должен быть IP-адрес, который мы нашли в [соответствующем разделе](#find-the-key-vault-private-ip-address-in-the-virtual-network) этой статьи. Во вторых, другие псевдонимы после него отсутствуют `privatelink` . Это происходит потому, что DNS-серверы виртуальной сети *перехватывают* цепочку псевдонимов и возвращают частный IP-адрес непосредственно из имени `fabrikam.privatelink.vaultcore.azure.net` . Эта запись фактически является `A` записью в частная зона DNSной зоне. Дополнительные сведения об этом будут ниже.

>[!NOTE]
> Приведенный выше результат происходит только на виртуальной машине, подключенной к виртуальной сети, в которой была создана частная конечная точка. Если у вас нет виртуальной машины, развернутой в виртуальной сети, содержащей закрытую конечную точку, разверните ее и подключитесь к ней удаленно, затем выполните `nslookup` команду (Windows) или `host` команду (Linux) выше.

При выполнении этих команд на виртуальной машине, подключенной к виртуальной сети, в которой была создана частная конечная точка, и **не** отображает частный IP-адрес хранилища ключей, следующий раздел может помочь устранить эту неполадку.

## <a name="6-validate-the-private-dns-zone"></a>6. Проверка зоны Частная зона DNS

Если разрешение DNS не работает, как описано в предыдущем разделе, возможно, возникла проблема с Частная зона DNS зоной, и этот раздел может помочь. Если разрешение DNS показывает правильный частный IP-адрес хранилища ключей, возможно, Частная зона DNS зона правильная. Вы можете пропустить весь раздел.

### <a name="confirm-that-the-required-private-dns-zone-resource-exists"></a>Убедитесь, что необходимый ресурс Частная зона DNS зоны существует

Подписка Azure должна иметь Частная зона DNS ресурс [зоны](../../dns/private-dns-privatednszone.md) с таким же именем:

`privatelink.vaultcore.azure.net`

Чтобы проверить наличие этого ресурса, перейдите на страницу подписки на портале и выберите в меню слева пункт "ресурсы". Имя ресурса должно быть `privatelink.vaultcore.azure.net` , а тип ресурса — в **Частная зона DNS Zone**.

Обычно этот ресурс создается автоматически при создании частной конечной точки с помощью общей процедуры. Но бывают случаи, когда этот ресурс не создается автоматически, и его необходимо выполнить вручную. Этот ресурс также мог быть случайно удален.

Если у вас нет этого ресурса, создайте новый ресурс Частная зона DNS зоны в подписке. Помните, что имя должно быть в точности `privatelink.vaultcore.azure.net` без пробелов или дополнительных точек. Если указано неправильное имя, разрешение имен, описанное в этой статье, не будет работать. Дополнительные сведения о создании этого ресурса см. [в статье Создание частной зоны DNS Azure с помощью портал Azure](../../dns/private-dns-getstarted-portal.md). Если вы подписаны на эту страницу, вы можете пропустить создание виртуальной сети, так как на этом этапе она уже должна быть. Также можно пропустить процедуры проверки с помощью виртуальных машин.

### <a name="confirm-that-the-private-dns-zone-is-linked-to-the-virtual-network"></a>Убедитесь, что зона Частная зона DNS связана с виртуальной сетью.

Недостаточно Частная зона DNSной зоны. Он также должен быть связан с виртуальной сетью, содержащей частную конечную точку. Если зона Частная зона DNS не связана с правильной виртуальной сетью, любое разрешение DNS из этой виртуальной сети будет пропускать зону Частная зона DNS.

Откройте ресурс зоны Частная зона DNS и в меню слева выберите пункт **связи виртуальных сетей** . Отобразится список ссылок с именем виртуальной Входящий сетевой трафик вашей подписки. Виртуальная сеть, содержащая ресурс частной конечной точки, должна быть указана здесь. Если она отсутствует, добавьте ее. Подробные инструкции см. [в разделе Связывание виртуальной сети](../../dns/private-dns-getstarted-portal.md#link-the-virtual-network). Вы можете оставить флажок "включить автоматическую регистрацию" снятым — эта функция не связана с частными ссылками.

После того как зона Частная зона DNS связана с виртуальной сетью, запросы DNS, исходящие из виртуальной сети, будут искать имена в зоне Частная зона DNS. Это необходимо для правильного разрешения адресов, выполняемых на виртуальных машинах, подключенных к виртуальной сети, в которой была создана частная конечная точка.

>[!NOTE]
> Если вы только что сохранили ссылку, это может занять некоторое время, даже после того, как на портале будет указано, что операция завершена. Также может потребоваться перезагрузить виртуальную машину, которая используется для проверки разрешения DNS.

### <a name="confirm-that-the-private-dns-zone-contains-the-right-a-record"></a>Убедитесь, что зона Частная зона DNS содержит правильную запись

На портале откройте зону Частная зона DNS с именем `privatelink.vaultcore.azure.net` . На странице Обзор отображаются все записи. По умолчанию будет существовать одна запись с именем `@` и типом `SOA` , что означает начало полномочий. Не трогайте это.

Для работы разрешения имен хранилища ключей должна существовать `A` запись с простым именем хранилища без суффикса или точек. Например, если имя узла — `fabrikam.vault.azure.net` , то должно быть `A` запись с именем `fabrikam` без суффикса или точек.

Кроме того, значение `A` записи (IP-адрес) должно быть [частным IP-адресом хранилища ключей](#find-the-key-vault-private-ip-address-in-the-virtual-network). Если вы нашли `A` запись, но она содержит неправильный IP-адрес, необходимо удалить неправильный IP-адрес и добавить новый. Рекомендуется удалить всю `A` запись и добавить новую.

>[!NOTE]
> При каждом удалении или изменении `A` записи компьютер по-прежнему может разрешить доступ к старому IP-адресу, так как срок жизни значения TTL (срок жизни) еще не истек. Рекомендуется всегда указывать значение TTL не менее 60 секунд (одна минута) и не больше 600 секунд (10 минут). Если указано слишком большое значение, восстановление после простоя может занять слишком много времени.

### <a name="dns-resolution-for-more-than-one-virtual-network"></a>Разрешение DNS для более чем одной виртуальной сети

Если существует несколько виртуальных сетей и у каждой из них есть собственная частная конечная точка, ссылающаяся на одно и то же хранилище ключей, имя узла хранилища ключей должно разрешаться в другой частный IP-адрес в зависимости от сети. Это означает, что также требуется несколько зон Частная зона DNS, каждый из которых связан с другой виртуальной сетью и использует другой IP-адрес в `A` записи.

В более сложных сценариях для виртуальных сетей может быть включен пиринг. В этом случае только одной виртуальной сети требуется ресурс частной конечной точки, хотя они должны быть связаны с ресурсом Частная зона DNS зоны. Этот сценарий не распространяется непосредственно на этот документ.

### <a name="understand-that-you-have-control-over-dns-resolution"></a>Общие сведения об управлении разрешением DNS

Как описано в [предыдущем разделе](#key-vault-with-private-link-resolving-from-arbitrary-internet-machine), хранилище ключей с частными ссылками имеет псевдоним `{vaultname}.privatelink.vaultcore.azure.net` в *общедоступной* регистрации. DNS-сервер, используемый виртуальной сетью, использует общедоступную регистрацию, но проверяет каждый псевдоним для *закрытой* регистрации, и, если он найден, он останавливает следующие псевдонимы, определенные при открытой регистрации.

Эта логика означает, что если виртуальная сеть связана с Частная зона DNS зоной с именем `privatelink.vaultcore.azure.net` , а общедоступная регистрация DNS для хранилища ключей имеет псевдоним `fabrikam.privatelink.vaultcore.azure.net` (Обратите внимание, что суффикс имени узла хранилища ключей точно соответствует имени зоны частная зона DNS), то запрос DNS будет искать `A` запись с именем `fabrikam` *в зоне частная зона DNS*. Если `A` запись найдена, ее IP-адрес возвращается в запросе DNS и дальнейший поиск не выполняется при общедоступной регистрации DNS.

Как видите, разрешение имен находится под вашим контролем. Для этого проекта используются следующие основания.

- У вас может быть сложный сценарий, включающий пользовательские DNS-серверы и интеграцию с локальными сетями. В этом случае необходимо управлять преобразованием имен в IP-адреса.
- Может потребоваться доступ к хранилищу ключей без ссылок на частные каналы. В этом случае разрешение имени узла из виртуальной сети должно возвращать общедоступный IP-адрес. это происходит потому, что хранилища ключей без закрытых ссылок не имеют `privatelink` псевдонима в регистрации имени.

## <a name="7-validate-that-requests-to-key-vault-use-private-link"></a>7. Проверка того, что запросы к хранилищу ключей используют закрытую ссылку

### <a name="query-the-healthstatus-endpoint-of-the-key-vault"></a>Запрос `/healthstatus` конечной точки хранилища ключей

Хранилище ключей предоставляет `/healthstatus` конечную точку, которую можно использовать для диагностики. Заголовки ответов включают исходный IP-адрес, как показано в службе хранилища ключей. Эту конечную точку можно вызвать с помощью следующей команды (не **забывайте использовать имя узла хранилища ключей**):

Windows (PowerShell):

```powershell
PS C:\> $(Invoke-WebRequest -UseBasicParsing -Uri https://fabrikam.vault.azure.net/healthstatus).Headers
```

```output
Key                           Value
---                           -----
Pragma                        no-cache
x-ms-request-id               3729ddde-eb6d-4060-af2b-aac08661d2ec
x-ms-keyvault-service-version 1.2.27.0
x-ms-keyvault-network-info    addr=10.4.5.6;act_addr_fam=InterNetworkV6;
Strict-Transport-Security     max-age=31536000;includeSubDomains
Content-Length                4
Cache-Control                 no-cache
Content-Type                  application/json; charset=utf-8
```

Linux или последняя версия Windows 10, которая включает в себя `curl` :

```console
joe@MyUbuntu:~$ curl -i https://fabrikam.vault.azure.net/healthstatus
```

```output
HTTP/1.1 200 OK
Cache-Control: no-cache
Pragma: no-cache
Content-Type: application/json; charset=utf-8
x-ms-request-id: 6c090c46-0a1c-48ab-b740-3442ce17e75e
x-ms-keyvault-service-version: 1.2.27.0
x-ms-keyvault-network-info: addr=10.4.5.6;act_addr_fam=InterNetworkV6;
Strict-Transport-Security: max-age=31536000;includeSubDomains
Content-Length: 4
```

Если вы не получаете подобный результат или если вы получаете сетевую ошибку, это означает, что хранилище ключей недоступно через указанное имя узла ( `fabrikam.vault.azure.net` в примере). Либо имя узла не разрешается в правильный IP-адрес, либо у вас возникла ошибка подключения на транспортном уровне. Это может быть вызвано проблемами маршрутизации, удалением пакетов и другими причинами. Необходимо изучить дополнительные сведения.

Ответ должен включать заголовок `x-ms-keyvault-network-info` :

```console
x-ms-keyvault-network-info: addr=10.4.5.6;act_addr_fam=InterNetworkV6;
```

`addr`Поле в `x-ms-keyvault-network-info` заголовке показывает IP-адрес источника запроса. Этот IP-адрес может быть одним из следующих:

- Частный IP-адрес компьютера, выполняющего запрос. Это означает, что запрос использует частные ссылки или конечные точки службы. Это ожидаемый результат для частных ссылок.
- Другой частный IP-адрес, а *не* компьютер, на котором выполняется запрос. Это означает, что какая-либо настраиваемая маршрутизация эффективна. Он по-прежнему указывает, что запрос использует частные ссылки или конечные точки службы.
- Некоторые общедоступные IP-адреса. Это означает, что запрос направляется в Интернет через устройство шлюза (NAT). Это означает, что запрос не использует закрытые ссылки, и некоторые проблемы необходимо исправить. Распространенные причины: 1) частная конечная точка не находится в состоянии "утверждено" и "выполнено"; и 2) имя узла не разрешается в частный IP-адрес хранилища ключей. В этой статье содержатся действия по устранению неполадок в обоих случаях.

>[!NOTE]
> Если запрос `/healthstatus` работает, но `x-ms-keyvault-network-info` заголовок отсутствует, то, скорее всего, хранилище ключей не будет обслуживать конечную точку. Так как приведенные выше команды также проверяют HTTPS-сертификат, отсутствующий заголовок может быть подписыванием подделки.

### <a name="query-the-key-vault-ip-address-directly"></a>Запрос IP-адреса хранилища ключей напрямую

>[!IMPORTANT]
> Доступ к хранилищу ключей без проверки сертификата HTTPS является опасным, и его можно использовать только в целях обучения. Рабочий код никогда не должен получать доступ к хранилищу ключей без проверки на стороне клиента. Даже если вы просто выполняете диагностику проблем, возможно, вы подпадаетесь на попытки несанкционированного изменения, которые не будут выявляться при частом отключении проверки сертификата HTTPS в запросах к хранилищу ключей.

Если вы установили последнюю версию PowerShell, вы можете использовать `-SkipCertificateCheck` для пропуска проверок HTTPS-сертификатов, после чего вы можете напрямую ориентироваться на [IP адрес хранилища ключей](#find-the-key-vault-private-ip-address-in-the-virtual-network) :

```powershell
PS C:\> $(Invoke-WebRequest -SkipCertificateCheck -Uri https://10.1.2.3/healthstatus).Headers
```

Если вы используете `curl` , то можете сделать то же самое с `-k` аргументом:

```console
joe@MyUbuntu:~$ curl -i -k https://10.1.2.3/healthstatus
```

Ответ должен быть аналогичен предыдущему разделу, что означает, что он должен включать `x-ms-keyvault-network-info` заголовок с тем же значением. `/healthstatus`Конечная точка не имеет значения, если вы используете имя узла или IP-адрес хранилища ключей.

Если вы видите, что `x-ms-keyvault-network-info` возвращает одно значение для запроса, используя имя узла хранилища ключей, и другое значение для запроса с использованием IP-адреса, каждый запрос предназначен для другой конечной точки. Ознакомьтесь с описанием `addr` поля из `x-ms-keyvault-network-info` в предыдущем разделе, чтобы решить, какой случай является неправильным и нужно ли его исправить.

## <a name="8-other-changes-and-customizations-that-cause-impact"></a>8. другие изменения и настройки, которые приводят к влиянию

Следующие элементы являются неисчерпывающими действиями расследования. Они будут сообщать вам, где искать дополнительные проблемы, но для устранения проблем в этих сценариях необходимо иметь расширенные знания о сети.

### <a name="diagnose-custom-dns-servers-at-virtual-network"></a>Диагностика пользовательских DNS-серверов в виртуальной сети

На портале Откройте ресурс виртуальной сети. В меню слева откройте **DNS-серверы**. Если вы используете "Custom", то разрешение DNS может быть не так, как описано в этом документе. Необходимо определить, как DNS-серверы разрешают имя узла хранилища ключей.

При использовании DNS-серверов, предоставляемых Azure по умолчанию, весь документ применим.

### <a name="diagnose-hosts-overriding-or-custom-dns-servers-at-virtual-machine"></a>Диагностика узлов, переопределяющих или настраиваемых DNS-серверов на виртуальной машине

Многие операционные системы позволяют задавать явный фиксированный IP-адрес для каждого имени узла, обычно изменяя `hosts` файл. Они также могут разрешить переопределение DNS-серверов. Если вы используете один из этих сценариев, перейдите к параметрам диагностики, относящимся к системе.

### <a name="promiscuous-proxies-fiddler-etc"></a>Неизбирательные прокси-серверы (Fiddler и т. д.)

Кроме случаев, когда явно указано иное, параметры диагностики в этой статье работают только в том случае, если в среде нет непрямого прокси-сервера. Хотя эти прокси-серверы часто устанавливаются исключительно на проверяемом компьютере (Fiddler является наиболее распространенным примером), опытные администраторы могут перезаписывать корневые центры сертификации (CAs) и устанавливать неизбирательный прокси-сервер на устройствах шлюзов, обслуживающих несколько компьютеров в сети. Эти прокси-серверы могут существенно повлиять на безопасность и надежность. Корпорация Майкрософт не поддерживает конфигурации, использующие такие продукты.

### <a name="other-things-that-may-affect-connectivity"></a>Другие вещи, которые могут повлиять на подключение

Это неисчерпывающий список элементов, которые можно найти в расширенных или сложных сценариях.

- Параметры брандмауэра: брандмауэр Azure, подключенный к виртуальной сети, или пользовательское решение брандмауэра, развернутое в виртуальной сети или на компьютере.
- Пиринг сети, который может влиять на используемые DNS-серверы и способ маршрутизации трафика.
- Решения настраиваемого шлюза (NAT), которые могут повлиять на маршрутизацию трафика, включая трафик из запросов DNS.