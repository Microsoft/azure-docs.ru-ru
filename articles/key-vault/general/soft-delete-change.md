---
title: Включение обратимого удаления для всех объектов хранилищ ключей в Azure Key Vault | Документация Майкрософт
description: Этот документ поможет при внедрении обратимого удаления для всех хранилищ ключей, а также при внесении изменений в приложения и систему администрирования для предотвращения ошибок конфликтов.
services: key-vault
author: ShaneBala-keyvault
manager: ravijan
tags: azure-resource-manager
ms.service: key-vault
ms.topic: conceptual
ms.date: 12/15/2020
ms.author: sudbalas
ms.openlocfilehash: b96f2ca4f925846bd252e5cfd35088d832f5c216
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "98572873"
---
# <a name="soft-delete-will-be-enabled-on-all-key-vaults"></a>Включение обратимого удаления во всех хранилищах ключей

> [!WARNING]
> Критическое изменение: возможность отказаться от обратимого удаления скоро перестанет поддерживаться. Пользователи и администраторы Azure Key Vault должны немедленно включить обратимое удаление для хранилищ ключей.
>
> Для управляемого устройства HSM Azure Key Vault обратимое удаление включено по умолчанию и его нельзя отключить.

Если секрет удаляется из хранилища ключей без защиты с помощью обратимого удаления, он удаляется окончательно. Сейчас пользователи могут отказаться от обратимого удаления во время создания хранилища ключей. Но в ближайшее время корпорация Майкрософт будет включать защиту обратимого удаления для всех хранилищ ключей, чтобы защитить секреты от случайного или злонамеренного удаления пользователем. Пользователи больше не смогут отказаться от обратимого удаления или отключить его.

:::image type="content" source="../media/softdeletediagram.png" alt-text="Схема: сравнение удаления хранилища ключей с защитой обратимого удаления и без такой защиты.":::

Дополнительные сведения о функции обратимого удаления см. в [этой статье](soft-delete-overview.md).

## <a name="can-my-application-work-with-soft-delete-enabled"></a>Можно ли в моем приложении использовать обратимое удаление?

> [!Important] 
> Прежде чем включать обратимое удаление для хранилищ ключей, внимательно ознакомьтесь с приведенной ниже информацией.

Имена хранилищ ключей должны быть глобально уникальными, то есть Имена секретов в хранилище ключей также должны быть уникальными. Вы не сможете повторно использовать имя хранилища ключей или объекта хранилища ключей, если хранилище или объект находятся в состоянии обратимого удаления. 

Например, если приложение программными средствами создает хранилище ключей с именем "Хранилище A" и позже удаляет его, хранилище будет переведено в состояние обратимого удаления. Ваше приложение не сможет еще раз создать хранилище ключей с именем "Хранилище А", пока такое хранилище не будет выведено из состояния обратимого удаления (очищено). 

Кроме того, если приложение создает ключ с именем `test key` в Хранилище А и позже удаляет этот ключ, приложение не сможет создать новый ключ с именем `test key` в Хранилище А, пока объект `test key` не будет выведен из состояния обратимого удаления (очищен). 

Если вы попытаетесь удалить объект хранилища ключей и воссоздать его с тем же именем, не выводя его из состояния обратимого удаления, могут произойти ошибки конфликтов. Эти ошибки могут вызвать сбой приложений или автоматизации. Прежде чем вносить указанные ниже необходимые изменения в приложение и систему администрирования, обратитесь к своей команде разработчиков. 

### <a name="application-changes"></a>Изменения приложений

Если в приложении предполагается, что обратимое удаление не включено, и ожидается, что удаленные секреты или имена хранилищ ключей будут доступны для немедленного повторного использования, вам потребуется внести указанные ниже изменения в логику приложения.

1. Удалите исходное хранилище ключей или секрет.
1. Очистить хранилище ключей или секрет в состоянии обратимого удаления.
1. Дождитесь завершения очистки. При немедленном повторном создании может произойти конфликт.
1. Повторно создать хранилище ключей с тем же именем.
1. Если операция создания по-прежнему приводит к ошибке конфликта имен, попробуйте еще раз создать хранилище ключей. Для обновления записей Azure DNS может потребоваться максимум 10 минут.

### <a name="administration-changes"></a>Изменения администрирования

Субъектам безопасности, которым необходим доступ для окончательного удаления секретов, нужно предоставить расширенные разрешения политики доступа для очистки этих секретов и хранилища ключей.

Отключите в своих хранилищах ключей политику Azure, которая требует отключить обратимое удаление. Возможно, вам потребуется передать эту проблему администратору, который контролирует политики Azure, применяемые к среде. Если эта политика не отключена, вы можете утратить возможность создавать хранилища ключей в области применяемой политики.

Если организация регулируется требованиями нормативно-правового соответствия и не может позволить удаленным хранилищам ключей и секретам в течение длительного периода оставаться в состоянии, допускающем восстановление, вам потребуется настроить период хранения обратимого удаления, чтобы обеспечить соответствие стандартам организации. Для срока хранения можно настроить длительность 7–90 дней.

## <a name="procedures"></a>Процедуры

### <a name="audit-your-key-vaults-to-check-if-soft-delete-is-enabled"></a>Выполнение аудита хранилищ ключей для проверки включения обратимого удаления

1. Войдите на портал Azure.
1. Выполните поиск по запросу **Политика Azure**.
1. Выберите элемент **Определения**.
1. В разделе **Категория** в фильтре выберите элемент **Key Vault**.
1. Выберите политику, требующую, чтобы **в хранилище ключей было включено обратимое удаление**.
1. Выберите **Назначить**.
1. Настройте область подписки.
1. Убедитесь, что для действия политики задано значение **Аудит**.
1. Выберите **Review + Create** (Просмотреть и создать). Полное сканирование среды может занять до 24 часов.
1. В области **Политика Azure** щелкните элемент **Соответствие**.
1. Выберите примененную политику.

Теперь вы можете применять фильтрацию и видеть, в каких хранилищах ключей включено обратимое удаление (соответствующие ресурсы), а в каких хранилищах ключей не включена эта функция (несоответствующие ресурсы).

### <a name="turn-on-soft-delete-for-an-existing-key-vault"></a>Включение обратимого удаления для существующего хранилища ключей

1. Войдите на портал Azure.
1. Найдите свое хранилище ключей.
1. В разделе **Параметры** выберите элемент **Свойства**.
1. В разделе **Обратимое удаление** выберите параметр **Enable recovery of this vault and its objects** (Включить восстановление этого хранилища и его объектов).
1. Настройте срок хранения для обратимого удаления.
1. Щелкните **Сохранить**.

### <a name="grant-purge-access-policy-permissions-to-a-security-principal"></a>Предоставление субъекту безопасности разрешения политики доступа на очистку

1. Войдите на портал Azure.
1. Найдите свое хранилище ключей.
1. В разделе **Параметры** выберите элемент **Политики доступа**.
1. Выберите субъект-службу, которому хотите предоставить доступ.
1. Просмотрите каждое раскрывающееся меню в разделах **Ключ**, **Секрет** и **Разрешения сертификатов**, пока не отобразится элемент **Privileged Operations** (Привилегированные операции). Выберите разрешение **Очистка**.

## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы

### <a name="does-this-change-affect-me"></a>Повлияет ли это изменение на работу?

Если у вас уже включено обратимое удаление или вы не удаляете и не воссоздаете объекты хранилища ключей с тем же именем, то, скорее всего, вы не заметите никаких изменений в работе хранилища ключей.

Если у вас есть приложение, которое часто удаляет и воссоздает объекты хранилища ключей с одинаковыми соглашениями об именовании, вам нужно будет внести изменения в логику приложения, чтобы поддерживать ожидаемое поведение. См. раздел [Изменения приложений](#application-changes) в этой статье.

### <a name="how-do-i-benefit-from-this-change"></a>Каковы преимущества этого изменения?

Функция обратимого удаления предоставляет организации еще один уровень защиты от случайного или злонамеренного удаления. Как администратор хранилища ключей вы можете ограничить доступ как к разрешениям на восстановление, так и к разрешениям на очистку.

Если пользователь случайно удалит хранилище ключей или секрет, вы сможете предоставить ему права доступа для самостоятельного восстановления секрета без риска того, что он навсегда удалит секрет или хранилище ключей. Этот процесс самообслуживания минимизирует время простоя в среде и гарантирует доступность секретов.

### <a name="how-do-i-find-out-if-i-need-to-take-action"></a>Как узнать, нужно ли предпринимать какие-то действия?

Выполните действия, описанные в разделе [Выполнение аудита хранилищ ключей для проверки включения обратимого удаления](#audit-your-key-vaults-to-check-if-soft-delete-is-enabled) этой статьи. Это изменение затронет все хранилища ключей, для которых не включено обратимое удаление.

### <a name="what-action-do-i-need-to-take"></a>Какие действия необходимо предпринять?

Убедившись, что вам не нужно вносить изменения в логику приложения, включите обратимое удаление для всех хранилищ ключей.

### <a name="when-do-i-need-to-take-action"></a>Когда нужно предпринимать действия?

Чтобы ваши приложения не были затронуты, включите обратимое удаление для хранилищ ключей как можно скорее.

## <a name="next-steps"></a>Следующие шаги

- С любыми вопросами об этом изменении обращайтесь по адресу [akvsoftdelete@microsoft.com](mailto:akvsoftdelete@microsoft.com).
- Ознакомьтесь с [общими сведениями об обратимом удалении](soft-delete-overview.md).
