---
title: Проверка подлинности в Azure Key Vault
description: Узнайте, как выполнять проверку подлинности в Azure Key Vault
author: ShaneBala-keyvault
ms.author: sudbalas
ms.date: 08/27/2020
ms.service: key-vault
ms.subservice: general
ms.topic: how-to
ms.openlocfilehash: 8a8fe4ed0c24d2ccda5fb844005a33a93e85a169
ms.sourcegitcommit: dddd1596fa368f68861856849fbbbb9ea55cb4c7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/13/2021
ms.locfileid: "107365524"
---
# <a name="authenticate-to-azure-key-vault"></a>Проверка подлинности в Azure Key Vault

Azure Key Vault позволяет хранить секреты и управлять их распределением в централизованном и защищенном облачном репозитории. При этом нет необходимости хранить учетные данные в приложениях. Для доступа к этим секретам во время выполнения приложению достаточно пройти проверку подлинности в Key Vault.

## <a name="app-identity-and-security-principals"></a>Удостоверение приложения и субъекты безопасности

Проверка подлинности в Key Vault работает в сочетании со службой [Azure Active Directory (Azure AD)](../../active-directory/fundamentals/active-directory-whatis.md), которая отвечает за проверку подлинности удостоверений любого предоставленного **субъекта безопасности**.

Субъект безопасности — это объект, представляющий пользователя, группу, службу или приложение, которые запрашивают доступ к ресурсам Azure. Azure назначает каждому субъекту безопасности уникальный **идентификатор объекта**.

* Субъект безопасности **Пользователь** определяет конкретного человека, у которого есть профиль в Azure Active Directory.

* Субъект безопасности **Группа** определяет набор пользователей, созданных в Azure Active Directory. Все роли или разрешения, назначенные группе, предоставляются всем пользователям в этой группе.

* Особый тип субъекта безопасности **Субъект-служба** служит идентификатором для приложения или службы, то есть сопоставляется с определенным фрагментом кода, а не с пользователем или группой. Идентификатор объекта для субъекта-службы называется **идентификатором клиента** и применяется аналогично имени пользователя. **Секрет клиента** выполняет для субъекта-службы функции пароля.

У приложений есть два способа получить субъект-службу:

* Создайте для приложения **управляемое удостоверение**, назначаемое системой (рекомендуется).

    При использовании управляемого удостоверения Azure самостоятельно управляет субъектом-службой приложения и автоматически выполняет для него проверку подлинности в других службах Azure. Управляемое удостоверение доступно для приложений, развернутых в разных службах.

    Дополнительные сведения см. в статье [Что такое управляемые удостоверения для ресурсов Azure?](../../active-directory/managed-identities-azure-resources/overview.md) Также просмотрите статью [Службы с поддержкой управляемых удостоверений для ресурсов Azure](../../active-directory/managed-identities-azure-resources/services-support-managed-identities.md), где собраны ссылки на статьи с инструкциями по включению управляемых удостоверений для конкретных служб (Служба приложений, Функции Azure, Виртуальные машины и т. д.).

* Если вы не можете использовать управляемое удостоверение, **зарегистрируйте** приложение в клиенте Azure AD, как описано в статье [Краткое руководство. Регистрация приложения с помощью платформы удостоверений Майкрософт](../../active-directory/develop/quickstart-register-app.md). Кроме того, при регистрации создается второй объект приложения, который представляет это приложение для всех клиентов.

## <a name="authorize-a-security-principal-to-access-key-vault"></a>Авторизация доступа к Key Vault для субъекта безопасности

Key Vault поддерживает два отдельных уровня авторизации.

- **Политики доступа** определяют, разрешено ли пользователю, группе или субъекту-службе обращаться к секретам, ключам и сертификатам, размещенным *внутри* существующего ресурса Key Vault (так называемые "операции плоскости данных"). Политики доступа обычно сопоставляются с пользователями, группами и приложениями.

    Чтобы назначить политики доступа, воспользуйтесь следующими руководствами:

    - [Портал Azure](assign-access-policy-portal.md)
    - [Azure CLI](assign-access-policy-cli.md)
    - [Azure PowerShell](assign-access-policy-portal.md)

- **Разрешения роли** определяют, разрешено ли пользователю, группе или субъекту-службе создавать или удалять ресурсы Key Vault и иным образом управлять ими (так называемые "операции плоскости управления"). Такие роли обычно предоставляются только администраторам.
 
    Сведения о назначении ролей и управлении ими вы найдете в следующих статьях:

    - [Портал Azure](../../role-based-access-control/role-assignments-portal.md)
    - [Azure CLI](../../role-based-access-control/role-assignments-cli.md)
    - [Azure PowerShell](../../role-based-access-control/role-assignments-powershell.md)

    Общие сведения о ролях см. в статье [Что такое управление доступом на основе ролей в Azure (Azure RBAC)?](../../role-based-access-control/overview.md)


> [!IMPORTANT]
> Для повышения уровня безопасности всегда соблюдайте принцип минимальных привилегий, предоставляя только те конкретные политики и роли доступа, которые необходимы для работы. 
    
## <a name="configure-the-key-vault-firewall"></a>Настройка брандмауэра Key Vault

По умолчанию Key Vault разрешает доступ к ресурсам с общедоступных IP-адресов. Чтобы повысить уровень безопасности, вы можете ограничить доступ, разрешая его только для конкретных диапазонов IP-адресов, конечных точек служб, виртуальных сетей или частных конечных точек.

Дополнительные сведения см. в статье [Доступ к Azure Key Vault из-за брандмауэра](./access-behind-firewall.md).


## <a name="the-key-vault-authentication-flow"></a>Поток проверки подлинности Key Vault

1. Субъект-служба запрашивает проверку подлинности в Azure AD, например:
    * пользователь входит на портал Azure, вводя имя пользователя и пароль;
    * приложение вызывает REST API Azure, предоставляя идентификатор и секрет или сертификат клиента;
    * ресурс Azure, например виртуальная машина с управляемым удостоверением, обращается к конечной точке REST [Службы метаданных экземпляров (IMDS) Azure](../../virtual-machines/windows/instance-metadata-service.md) для получения маркера доступа.

1. Если проверка подлинности в Azure AD проходит успешно, субъекту-службе предоставляется маркер OAuth.

1. Субъект-служба вызывает REST API Key Vault через конечную точку (URI) Key Vault.

1. Брандмауэр Key Vault проверяет указанные ниже условия. Если любое из них соблюдается, вызов разрешается. Иначе вызов блокируется и возвращается соответствующий ответ:

    * брандмауэр отключен, то есть общедоступная конечная точка Key Vault считается доступной из общедоступного Интернета;
    * вызывающий объект является [доверенной службой Key Vault](./overview-vnet-service-endpoints.md#trusted-services), то есть к нему не применяются правила брандмауэра;
    * вызывающий объект указан в брандмауэре в списке разрешенных IP-адресов, виртуальных сетей или конечных точек служб;
    * вызывающий объект может обращаться к Key Vault через настроенное подключение к приватному каналу.    

1. Если брандмауэр разрешает вызов, Key Vault обращается к Azure AD для проверки маркера доступа субъекта-службы.

1. Key Vault проверяет, есть ли для субъекта-службы необходимая политика доступа для запрошенной операции. Если политики нет, Key Vault возвращает ответ с запретом доступа.

1. Key Vault выполняет запрошенную операцию и возвращает результат.

На следующей схеме показан пример обращения приложения к интерфейсу API "Получение секрета" в Key Vault:

![Поток проверки подлинности в Key Vault](../media/authentication/authentication-flow.png)

> [!NOTE]
> Чтобы получить секреты, сертификаты и ключи, клиенты пакета SDK для Key Vault делают дополнительный вызов хранилища ключей без маркера доступа, что приводит к ответу 401 при попытке получить сведения о клиенте. Дополнительные сведения см. в [этой статье](authentication-requests-and-responses.md).

## <a name="code-examples"></a>Примеры кода

В следующей таблице собраны ссылки на статьи, которые демонстрируют работу с Key Vault в коде приложения на разных языках с использованием соответствующей библиотеки пакета средств разработки для Azure. Там же для удобства представлены и другие интерфейсы, такие как Azure CLI и портал Azure.

| Секреты Key Vault | Ключи Key Vault | Сертификаты Key Vault |
|  --- | --- | --- |
| [Python](../secrets/quick-create-python.md) | [Python](../keys/quick-create-python.md) | [Python](../certificates/quick-create-python.md) | 
| [.NET](../secrets/quick-create-net.md) | [.NET](../keys/quick-create-net.md) | [.NET](../certificates/quick-create-net.md) |
| [Java](../secrets/quick-create-java.md) | [Java](../keys/quick-create-java.md) | [Java](../certificates/quick-create-java.md) |
| [JavaScript](../secrets/quick-create-node.md) | [JavaScript](../keys/quick-create-node.md) | [JavaScript](../certificates/quick-create-node.md) | 
| [Портал Azure](../secrets/quick-create-portal.md) | [Портал Azure](../keys/quick-create-portal.md) | [Портал Azure](../certificates/quick-create-portal.md) |
| [Azure CLI](../secrets/quick-create-cli.md) | [Azure CLI](../keys/quick-create-cli.md) | [Azure CLI](../certificates/quick-create-cli.md) |
| [Azure PowerShell](../secrets/quick-create-powershell.md) | [Azure PowerShell](../keys/quick-create-powershell.md) | [Azure PowerShell](../certificates/quick-create-powershell.md) |
| [Шаблон ARM](../secrets/quick-create-net.md) | -- | -- |

## <a name="next-steps"></a>Next Steps

- [Устранение неполадок с политиками доступа Key Vault](troubleshooting-access-issues.md)
- [Коды ошибок REST API в Key Vault](rest-error-codes.md)
- [Руководство разработчика для Key Vault](developers-guide.md)
- [Что такое управление доступом на основе ролей в Azure (RBAC)?](../../role-based-access-control/overview.md)
