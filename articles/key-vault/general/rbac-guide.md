---
title: Предоставление приложениям разрешения на доступ к хранилищу ключей Azure с помощью Azure RBAC | Документация Майкрософт
description: Узнайте, как предоставить доступ к ключам, секретам и сертификатам с помощью управления доступом на основе ролей Azure.
services: key-vault
author: msmbaldwin
manager: rkarlin
ms.service: key-vault
ms.subservice: general
ms.topic: how-to
ms.date: 8/30/2020
ms.author: mbaldwin
ms.openlocfilehash: 886b87adeabdc0aadde04c189b78739435aabede
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "100527070"
---
# <a name="provide-access-to-key-vault-keys-certificates-and-secrets-with-an-azure-role-based-access-control"></a>Предоставление доступа к ключам, сертификатам и секретам Key Vault с помощью управления доступом на основе ролей Azure

> [!NOTE]
> Поставщик ресурсов Key Vault поддерживает два типа ресурсов: **хранилища** и **управляемый HSM**. Управление доступом, описанное в этой статье, применимо только к **хранилищам**. Дополнительные сведения об управлении доступом для управляемого модуля HSM см. в разделе [управляемый контроль доступа HSM](../managed-hsm/access-control.md).

Управление доступом на основе ролей в Azure (Azure RBAC) — это система авторизации, основанная на [Azure Resource Manager](../../azure-resource-manager/management/overview.md) , которая обеспечивает детальное управление доступом к ресурсам Azure.

Azure RBAC позволяет пользователям управлять разрешениями ключей, секретов и сертификатов. Он предоставляет одно место для управления всеми разрешениями во всех хранилищах ключей. 

Модель RBAC Azure предоставляет возможность устанавливать разрешения для различных уровней области: группы управления, подписки, группы ресурсов или отдельных ресурсов.  Azure RBAC для хранилища ключей также предоставляет возможность иметь отдельные разрешения на отдельные ключи, секреты и сертификаты.

Дополнительные сведения см. в статье [Управление доступом на основе ролей в Azure (Azure RBAC)](../../role-based-access-control/overview.md).

## <a name="best-practices-for-individual-keys-secrets-and-certificates"></a>Рекомендации по отдельным ключам, секретам и сертификатам

Мы рекомендуем использовать хранилище для каждого приложения в каждой среде (разработки, подготовительные и рабочие).

Индивидуальные разрешения на доступ к ключам, секретам и сертификатам следует использовать только в определенных сценариях.

-   Многоуровневые приложения, которым необходимо разделить управление доступом между слоями

-   Совместное использование индивидуального секрета несколькими приложениями

Дополнительные сведения о рекомендациях по управлению Azure Key Vault см. в следующих статьях:

- [Обзор системы безопасности Azure Key Vault](security-overview.md)
- [Ограничения службы Azure Key Vault](service-limits.md)

## <a name="azure-built-in-roles-for-key-vault-data-plane-operations"></a>Встроенные роли Azure для Key Vault операций с плоскостью данных
> [!NOTE]
> `Key Vault Contributor` роль предназначена для операций плоскости управления, позволяющих управлять хранилищами ключей. Он не разрешает доступ к ключам, секретам и сертификатам.

| Встроенные роли | Описание | ID |
| --- | --- | --- |
| Администратор Key Vault| Выполните все операции с плоскостью данных в хранилище ключей и всех его объектах, включая сертификаты, ключи и секреты. Не может управлять ресурсами хранилища ключей или управлять назначениями ролей. Работает только для хранилищ ключей, использующих модель разрешений управления доступом на основе ролей Azure. | 00482a5a-887f-4fb3-b363-3b7fe8e74483 |
| Директор сертификатов Key Vault | Выполните любое действие с сертификатами хранилища ключей, за исключением разрешений на управление. Работает только для хранилищ ключей, использующих модель разрешений управления доступом на основе ролей Azure. | a4417e6f-fecd-4de8-b567-7b0420556985 |
| Key Vault директор по шифрованию | Выполните любое действие с ключами хранилища ключей, за исключением разрешений на управление. Работает только для хранилищ ключей, использующих модель разрешений управления доступом на основе ролей Azure. | 14b46e9e-c2b7-41b4-b07b-48a6ebf60603 |
| Key Vault шифрование службы шифрования | Чтение метаданных ключей и выполнение операций упаковки и распаковки. Работает только для хранилищ ключей, использующих модель разрешений управления доступом на основе ролей Azure. | e147488a-f6f5-4113-8e2d-b22465e65bf6 |
| Пользователь Key Vault шифрования  | Выполнение криптографических операций с помощью ключей. Работает только для хранилищ ключей, использующих модель разрешений управления доступом на основе ролей Azure. | 12338af0-0e69-4776-bea7-57ae8d297424 |
| Модуль чтения Key Vault | Чтение метаданных хранилищ ключей и их сертификатов, ключей и секретов. Не удается считать конфиденциальные значения, такие как содержимое секрета или материал ключа. Работает только для хранилищ ключей, использующих модель разрешений управления доступом на основе ролей Azure. | 21090545-7ca7-4776-b22c-e363652d74d2 |
| Директор Key Vault секретов| Выполните любое действие с секретами хранилища ключей, за исключением разрешений на управление. Работает только для хранилищ ключей, использующих модель разрешений управления доступом на основе ролей Azure. | b86a8fe4-44ce-4948-aee5-eccb2c155cd7 |
| Key Vault секреты пользователя | Чтение содержимого секрета. Работает только для хранилищ ключей, использующих модель разрешений управления доступом на основе ролей Azure. | 4633458b-17de-408a-b874-0445c86b69e6 |

Дополнительные сведения о встроенных определениях ролей Azure см. [в статье встроенные роли Azure](../../role-based-access-control/built-in-roles.md).

## <a name="using-azure-rbac-secret-key-and-certificate-permissions-with-key-vault"></a>Использование разрешений секрета, ключа и сертификата Azure RBAC с Key Vault

Новая модель разрешений RBAC в Azure для хранилища ключей предоставляет альтернативу модели разрешений политики доступа к хранилищу. 

### <a name="prerequisites"></a>Предварительные требования

Для добавления назначений ролей требуются следующие разрешения:

- Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.
- `Microsoft.Authorization/roleAssignments/write` и `Microsoft.Authorization/roleAssignments/delete`, такие как [Администратор доступа пользователей](../../role-based-access-control/built-in-roles.md#user-access-administrator) или [Владелец](../../role-based-access-control/built-in-roles.md#owner).

### <a name="enable-azure-rbac-permissions-on-key-vault"></a>Включение разрешений RBAC в Azure на Key Vault

> [!NOTE]
> Для изменения модели разрешений требуется разрешение Microsoft. Authorization/roleAssignments/Write, которое является частью ролей [владельца](../../role-based-access-control/built-in-roles.md#owner) и [администратора доступа пользователей](../../role-based-access-control/built-in-roles.md#user-access-administrator) . Роли администратора классической подписки, такие как "Администратор службы" и "Соадминистратор", не поддерживаются.

1.  Включите разрешения RBAC Azure в новом хранилище ключей:

    ![Включение разрешений RBAC в Azure — новое хранилище](../media/rbac/image-1.png)

2.  Включение разрешений RBAC Azure в существующем хранилище ключей:

    ![Включение разрешений RBAC в Azure — существующее хранилище](../media/rbac/image-2.png)

> [!IMPORTANT]
> Настройка модели разрешений Azure RBAC делает недействительными все разрешения политик доступа. Это может привести к простоям, если эквивалентные роли Azure не назначены.

### <a name="assign-role"></a>Назначение роли

> [!Note]
> Вместо имени роли в скриптах рекомендуется использовать уникальный идентификатор роли. Таким образом, если роль переименовывается, скрипты будут продолжать работать. В этом имени роли документа используется только для удобочитаемости.

Azure CLI команду для создания назначения роли:

```azurecli
az role assignment create --role <role_name_or_id> --assignee <assignee> --scope <scope>
```

В портал Azure экран назначения ролей Azure доступен для всех ресурсов на вкладке Управление доступом (IAM).

![Назначение ролей — Вкладка (IAM)](../media/rbac/image-3.png)

### <a name="resource-group-scope-role-assignment"></a>Назначение роли области группы ресурсов

1.  Перейдите к группе ресурсов хранилища ключей.
    ![Назначение ролей — группа ресурсов](../media/rbac/image-4.png)

2.  Щелкните Добавление назначения роли "Управление доступом (IAM)" \> \> Добавить.

3.  Создание роли читателя Key Vault "читатель Key Vault" для текущего пользователя

    ![Добавление роли — группа ресурсов](../media/rbac/image-5.png)

Azure CLI:
```azurecli
az role assignment create --role "Key Vault Reader" --assignee {i.e user@microsoft.com} --scope /subscriptions/{subscriptionid}/resourcegroups/{resource-group-name}
```

Приведенное выше назначение ролей предоставляет возможность перечисления объектов хранилища ключей в хранилище ключей.

### <a name="key-vault-scope-role-assignment"></a>Назначение роли области Key Vault

1. Перейти на \> вкладку управления доступом Key Vault (IAM)

2. Щелкните Добавить назначение роли \> Добавить.

3. Создайте роль директора ключевых секретов "Key Vault секреты для текущего пользователя.

    ![Назначение ролей — хранилище ключей](../media/rbac/image-6.png)

 Azure CLI:

```azurecli
az role assignment create --role "Key Vault Secrets Officer" --assignee {i.e jalichwa@microsoft.com} --scope /subscriptions/{subscriptionid}/resourcegroups/{resource-group-name}/providers/Microsoft.KeyVault/vaults/{key-vault-name}
```

После создания назначения ролей можно создать, обновить или удалить секреты.

4. Создайте новый секрет (секреты \> , создание и импорт) для проверки назначения ролей уровня секрета.

    ![Добавление хранилища ключей ролей](../media/rbac/image-7.png)

### <a name="secret-scope-role-assignment"></a>Назначение роли области секрета

1. Открытие одного из ранее созданных секретов, обзор уведомлений и управление доступом (IAM) 

2. Щелкните вкладку Управление доступом (IAM).

    ![Назначение роли — секрет](../media/rbac/image-8.png)

3. Создайте роль директора ключевых секретов "Key Vault секреты для текущего пользователя, как это было сделано выше для Key Vault.

Azure CLI:

```azurecli
az role assignment create --role "Key Vault Secrets Officer" --assignee {i.e user@microsoft.com} --scope /subscriptions/{subscriptionid}/resourcegroups/{resource-group-name}/providers/Microsoft.KeyVault/vaults/{key-vault-name}/secrets/RBACSecret
```

### <a name="test-and-verify"></a>Тестирование и проверка

> [!NOTE]
> Браузеры используют кэширование, а обновление страницы требуется после удаления назначений ролей.<br>
> Разрешить обновление назначений ролей в течение нескольких минут

1. Проверьте Добавление нового секрета без роли "Key Vault секреты" директор "на уровне хранилища ключей".

Перейдите на вкладку Управление доступом к хранилищу ключей (IAM) и удалите назначение роли "Key Vault секреты" для этого ресурса.

![Удалить назначение — хранилище ключей](../media/rbac/image-9.png)

Перейдите к ранее созданному секрету. Вы можете просмотреть все свойства секрета.

![Представление секрета с доступом](../media/rbac/image-10.png)

Создание нового секрета (секреты, \> Создание и импорт) должно показываться ниже ошибки:

   ![Создать новый секрет](../media/rbac/image-11.png)

2.  Проверка секретного изменения без роли "Key Vault секретного директора" на уровне секрета.

-   Перейдите к созданной ранее вкладке контроль доступа на секретные данные (IAM) и удалите назначение роли "Key Vault секреты" для этого ресурса.

-   Перейдите к ранее созданному секрету. Вы видите свойства секрета.

   ![Представление секрета без доступа](../media/rbac/image-12.png)

3. Проверка секретов чтения без роли читателя на уровне хранилища ключей.

-   Перейдите в раздел управления доступом к группе ресурсов хранилища ключей (IAM) и удалите назначение роли "модуль чтения Key Vault".

-   При переходе на вкладку секреты хранилища ключей должно отобразиться следующее сообщение об ошибке:

   ![Вкладка "секретный код" — ошибка](../media/rbac/image-13.png)

### <a name="creating-custom-roles"></a>Создание пользовательских ролей 

[AZ Role Definition Create, команда](/cli/azure/role/definition#az-role-definition-create)

**(Bash-скрипт CLI)</br>**
```azurecli
az role definition create --role-definition '{ \
   "Name": "Backup Keys Operator", \
   "Description": "Perform key backup/restore operations", \
    "Actions": [ 
    ], \
    "DataActions": [ \
        "Microsoft.KeyVault/vaults/keys/read ", \
        "Microsoft.KeyVault/vaults/keys/backup/action", \
         "Microsoft.KeyVault/vaults/keys/restore/action" \
    ], \
    "NotDataActions": [ 
   ], \
    "AssignableScopes": ["/subscriptions/{subscriptionId}"] \
}'
```

Дополнительные сведения о создании пользовательских ролей см. в следующих статьях:

[Настраиваемые роли Azure](../../role-based-access-control/custom-roles.md)

## <a name="known-limits-and-performance"></a>Известные ограничения и производительность

-   2000. назначения ролей Azure на подписку

-   Задержка назначений ролей: в текущей ожидаемой производительности это займет до 10 минут (600 с) после изменения назначения ролей для применения роли.

## <a name="learn-more"></a>Дополнительные сведения

- [Обзор Azure RBAC](../../role-based-access-control/overview.md)
- [Учебник по настраиваемым ролям](../../role-based-access-control/tutorial-custom-role-cli.md)