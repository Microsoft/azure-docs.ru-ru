---
title: Создание и слияние CSR в Azure Key Vault
description: Создание и слияние CSR в Azure Key Vault
services: key-vault
author: msmbaldwin
manager: rkarlin
tags: azure-resource-manager
ms.service: key-vault
ms.subservice: certificates
ms.topic: tutorial
ms.date: 06/17/2020
ms.author: sebansal
ms.openlocfilehash: 42f649f9dd206b34f0fac8513ba742febed2dbcb
ms.sourcegitcommit: a4533b9d3d4cd6bb6faf92dd91c2c3e1f98ab86a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/22/2020
ms.locfileid: "97724635"
---
# <a name="creating-and-merging-csr-in-key-vault"></a>Создание и слияние CSR в Key Vault

Azure Key Vault поддерживает хранение в хранилище ключей цифрового сертификата, выданного любым центром сертификации. Он поддерживает создание запроса на подписывание сертификата с парой из закрытого и открытого ключа, а также организацию подписывания выбранным вами центром сертификации (ЦС). Это может быть внутренний ЦС предприятия или внешний общедоступный ЦС. Запрос на подписывание сертификата (CSR) — это сообщение от пользователя в центр сертификации (ЦС) с просьбой о выдаче цифрового сертификата.

Более общие сведения о сертификатах см. в статье [Сведения о сертификатах Azure Key Vault](./about-certificates.md).

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

## <a name="adding-certificate-in-key-vault-issued-by-partnered-ca"></a>Добавление в KeyVault сертификата, выданного центром сертификации со статусом партнера
Key Vault пользуется услугами следующих двух центров сертификации для упрощения процесса по созданию сертификатов. 

|Поставщик|Тип сертификата|Настройка конфигурации  
|--------------|----------------------|------------------|  
|DigiCert;|Key Vault предоставляет OV или EV SSL-сертификаты в DigiCert| [Руководство по интеграции](./how-to-integrate-certificate-authority.md)
|GlobalSign;|Key Vault предоставляет OV или EV SSL-сертификаты в GlobalSign| [Руководство по интеграции](https://support.globalsign.com/digital-certificates/digital-certificate-installation/generating-and-importing-certificate-microsoft-azure-key-vault)

## <a name="adding-certificate-in-key-vault-issued-by-non-partnered-ca"></a>Добавление в KeyVault сертификата, выданного центром сертификации, который не имеет статус партнера

Приведенные ниже инструкции помогут вам создать сертификат в центре сертификации, не имеющем партнерских отношений с Key Vault (например, GoDaddy не является доверенным ЦС хранилища ключей). 



# <a name="portal"></a>[Портал](#tab/azure-portal)

1.  Чтобы создать CSR для выбранного ЦС, перейдите к хранилищу ключей, в которое решили добавить этот сертификат.
2.  На странице свойств Key Vault выберите **Сертификаты**.
3.  Выберите вкладку **Generate/Import** (Создать или импортировать).
4.  На экране **Создание сертификата** выберите следующие значения:
    - **Метод создания сертификата:** Сформировать.
    - **Имя сертификата:** ContosoManualCSRCertificate.
    - **Тип центра сертификации (ЦС):** Сертификат, выданный неинтегрированным ЦС
    - **Тема:** `"CN=www.contosoHRApp.com"`
    - При желании выберите другие значения. Нажмите кнопку **Создать**.

    ![Свойства сертификатов](../media/certificates/create-csr-merge-csr/create-certificate.png)  


6.  Вы увидите, что этот сертификат появился в списке сертификатов. Выберите этот только что созданный сертификат. Текущее состояние сертификата — "отключено", так как он еще не выдан центром сертификации.
7. Щелкните вкладку **Операции с сертификатом** и выберите **Загрузить CSR**.

   ![Снимок экрана: выделенная кнопка "Скачать CSR".](../media/certificates/create-csr-merge-csr/download-csr.png)
 
8.  Передайте CSR-файл в центр сертификации с запросом на получение подписи.
9.  После того как запрос будет подписан ЦС, вернитесь к файлу сертификата, чтобы **выполнить слияние для подписанного запроса** на том же экране "Операция с сертификатом".

Теперь для запроса на сертификат успешно выполнено слияние.


# <a name="powershell"></a>[PowerShell](#tab/azure-powershell)



1. Сначала **создайте политику сертификата**. В этом сценарии Key Vault не будет обращаться к издателю для регистрации или обновления сертификата от имени пользователя, так как этот сценарий не поддерживает выбранный ЦС. Это подтверждается значением Unknown (Неизвестно) для параметра IssuerName (Имя издателя).

   ```azurepowershell
   $policy = New-AzKeyVaultCertificatePolicy -SubjectName "CN=www.contosoHRApp.com" -ValidityInMonths 1  -IssuerName Unknown
   ```
    
   > [!NOTE]
   > Если вы используете относительное различающееся имя (RDN), содержащее запятую (,) в значении, используйте одинарные кавычки. Кроме того, заключите значение, содержащее специальный символ, в двойные кавычки. Например, `$policy = New-AzKeyVaultCertificatePolicy -SubjectName 'OU="Docs,Contoso",DC=Contoso,CN=www.contosoHRApp.com' -ValidityInMonths 1  -IssuerName Unknown`. В этом примере значение `OU` можно растолковать как **Docs, Contoso**. Этот формат используется для всех значений, содержащих запятую.

2. Создание **запроса на подписывание сертификата**

   ```azurepowershell
   $csr = Add-AzKeyVaultCertificate -VaultName ContosoKV -Name ContosoManualCSRCertificate -CertificatePolicy $policy
   $csr.CertificateSigningRequest
   ```

3. Получение **подписанного ЦС запроса** CSR. Объект `$csr.CertificateSigningRequest` содержит запрос на подписывание сертификата, закодированный в формате base4. Вы можете взять этот готовый большой двоичный объект и передать его на веб-сайт издателя, принимающий запросы на сертификаты. Конкретная процедура будет зависеть от определенного центра сертификации. Поэтому рекомендации по ее выполнению лучше всего получить в самом центре сертификации. Кроме того, вы можете использовать такие средства, как certreq или openssl, чтобы подписать запрос сертификата и завершить его создание.


4. Выполните **слияние подписанного запроса** в Key Vault. Когда запрос сертификата будет подписан издателем, вы можете получить подписанный сертификат и объединить его с исходной парой закрытого и открытого ключей, созданной в Azure Key Vault.

    ```azurepowershell-interactive
    Import-AzKeyVaultCertificate -VaultName ContosoKV -Name ContosoManualCSRCertificate -FilePath C:\test\OutputCertificateFile.cer
    ```

    Теперь для запроса на сертификат успешно выполнено слияние.
---

> [!NOTE]
> Если значения RDN содержат запятые, их также можно добавить в поле **Тема**, заключив значение в двойные кавычки, как показано на шаге 4.
> Пример записи в поле "Тема": `DC=Contoso,OU="Docs,Contoso",CN=www.contosoHRApp.com` В этом примере RDN `OU` содержит значение с запятой в имени. Выходными данными для `OU` является **Docs, Contoso**.

## <a name="adding-more-information-to-csr"></a>Добавление дополнительных сведений в CSR-файл

Возможно, требуется добавить дополнительные сведения при создании CSR-файла, например следующие: 
    - страна;
    - город или местоположение;
    - область, республика, край, округ;
    - Организация:
    - подразделение. Вы можете добавить все эти сведения при создании CSR-файла, определив их в subjectName.

Пример
    ```SubjectName="CN = docs.microsoft.com, OU = Microsoft Corporation, O = Microsoft Corporation, L = Redmond, S = WA, C = US"
    ```

> [!NOTE]
> Если вы запрашиваете сертификат проверки домена (DV-сертификат) со всеми этими сведениями в CSR-файле, то центр сертификации может отклонить запрос, так как не сможет проверить всю информацию в запросе. Если вы запрашиваете OV-сертификат, то добавление всех этих сведений в CSR-файл будет более уместным.


## <a name="troubleshoot"></a>Диагностика

- Дополнительные сведения об отслеживании ответа на запрос сертификат или управлении им см. [здесь](https://docs.microsoft.com/azure/key-vault/certificates/create-certificate-scenarios).

- **Тип ошибки The public key of the end-entity certificate in the specified X.509 certificate content does not match the public part of the specified private key. Please check if certificate is valid. (Открытый ключ сертификата конечного субъекта в указанном содержимом сертификата X.509 не соответствует открытой части указанного закрытого ключа. Проверьте, действителен ли сертификат.)** Эта ошибка может возникать, если не выполняется слияние CSR с тем же инициированным запросом CSR. При каждом создании CSR создается закрытый ключ, который должен быть сопоставлен при слиянии подписанного запроса.
    
- При объединении CSR объединяется ли вся цепочка?
    Да, вся цепочка будет объединена, если пользователь предоставит файл p7b для объединения.

- Если выданный сертификат имеет состояние "отключено" на портале Azure, изучите инструкции по **работе с сертификатами**, чтобы просмотреть сообщение об ошибке, связанной с этим сертификатом.

Дополнительные сведения о работе с сертификатами см. в [справочнике по работе с Azure Key Vault с помощью REST API](/rest/api/keyvault). Сведения об установке разрешений см. в статьях [Vaults — Create Or Update](/rest/api/keyvault/vaults/createorupdate) (Хранилища. Создание или обновление) и [Vaults — Update Access Policy](/rest/api/keyvault/vaults/updateaccesspolicy) (Хранилища. Обновление политики доступа).

- **Тип ошибки: The subject name provided is not a valid X500 name** (Указанное имя субъекта не является допустимым именем X500). Эта ошибка может происходить, если в значениях SubjectName были добавлены специальные знаки. Дополнительные сведения см. в примечаниях на портале Azure и инструкциях PowerShell соответственно. 

---
## <a name="next-steps"></a>Дальнейшие действия

- [Аутентификация, запросы и ответы](../general/authentication-requests-and-responses.md)
- [Руководство разработчика Azure Key Vault](../general/developers-guide.md)
