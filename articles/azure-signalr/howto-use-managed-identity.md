---
title: Управляемые удостоверения в службе Azure SignalR
description: Узнайте, как управляемые удостоверения работают в службе Azure SignalR и как использовать управляемое удостоверение в бессерверных сценариях.
author: chenyl
ms.service: signalr
ms.topic: article
ms.date: 06/8/2020
ms.author: chenyl
ms.openlocfilehash: dee15977318eda7bcd0b1950286bb33f621221dd
ms.sourcegitcommit: 78ecfbc831405e8d0f932c9aafcdf59589f81978
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/23/2021
ms.locfileid: "98731590"
---
# <a name="managed-identities-for-azure-signalr-service"></a>Управляемые удостоверения для службы Azure SignalR

В этой статье показано, как создать управляемое удостоверение для службы Azure SignalR и как использовать его в бессерверных сценариях.

> [!Important] 
> Служба Azure SignalR может поддерживать только одно управляемое удостоверение. Это означает, что можно добавить либо назначенное системой удостоверение, либо пользовательское удостоверение. 

## <a name="add-a-system-assigned-identity"></a>Добавление назначаемого системой удостоверения

Чтобы настроить управляемое удостоверение в портал Azure, сначала создайте экземпляр службы Azure SignalR, а затем включите эту функцию.

1. Создайте экземпляр службы Azure SignalR на портале, как обычно. Перейдите к нему на портале.

2. Выберите **Удостоверение**.

4. На вкладке **назначенная система** переключите **состояние** **на вкл**. Щелкните **Сохранить**.

    :::image type="content" source="media/signalr-howto-use-managed-identity/system-identity-portal.png" alt-text="Добавление назначенного системой удостоверения на портале":::

## <a name="add-a-user-assigned-identity"></a>Добавление назначаемого пользователем удостоверения

Для создания экземпляра службы Azure SignalR с назначенным пользователем удостоверением необходимо создать удостоверение, а затем добавить его идентификатор ресурса в службу.

1. Создайте ресурс назначаемого пользователем управляемого удостоверения в соответствии с [этими инструкциями](../active-directory/managed-identities-azure-resources/how-to-manage-ua-identity-portal.md#create-a-user-assigned-managed-identity).

2. Создайте экземпляр службы Azure SignalR на портале, как обычно. Перейдите к нему на портале.

3. Выберите **Удостоверение**.

4. На вкладке **Назначенные пользователи** выберите **Добавить**.

5. Найдите созданное ранее удостоверение и выберете его. Выберите **Добавить**.

    :::image type="content" source="media/signalr-howto-use-managed-identity/user-identity-portal.png" alt-text="Добавление назначенного пользователем удостоверения на портале":::

## <a name="use-a-managed-identity-in-serverless-scenarios"></a>Использование управляемого удостоверения в бессерверных сценариях

Служба Azure SignalR — это полностью управляемая служба, поэтому вы не можете использовать управляемое удостоверение для получения маркеров вручную. Вместо этого служба Azure SignalR использует управляемое удостоверение, заданное для получения маркера доступа. Затем служба устанавливает маркер доступа в `Authorization` заголовок вышестоящего запроса в бессерверных сценариях.

### <a name="enable-managed-identity-authentication-in-upstream-settings"></a>Включение проверки подлинности управляемого удостоверения в параметрах вышестоящего

1. Добавьте удостоверение, назначенное системой, или пользовательское удостоверение.

2. Добавьте один вышестоящий параметр и щелкните любую звездочку, чтобы перейти на страницу с подробными сведениями, как показано ниже.
    :::image type="content" source="media/signalr-howto-use-managed-identity/pre-msi-settings.png" alt-text="параметр pre-MSI":::
    
    :::image type="content" source="media/signalr-howto-use-managed-identity/msi-settings.png" alt-text="параметр MSI":::

3. В параметрах аутентификации управляемого удостоверения для **ресурса** можно указать целевой ресурс. Ресурс станет `aud` утверждением в полученном маркере доступа, который можно использовать в качестве части проверки в вышестоящей конечной точки. Ресурс может быть одним из следующих:
    - Empty
    - Идентификатор приложения (клиента) субъекта-службы
    - URI идентификатора приложения субъекта-службы
    - [Идентификатор ресурса службы Azure](../active-directory/managed-identities-azure-resources/services-support-managed-identities.md#azure-services-that-support-azure-ad-authentication)

    > [!NOTE]
    > При проверке маркера доступа в службе вы можете выбрать любой из форматов ресурсов. Просто убедитесь, что значение **ресурса** в параметрах **проверки подлинности** и проверка являются одинаковыми. При использовании управления доступом на основе ролей Azure (Azure RBAC) для плоскости данных необходимо использовать ресурс, запрашиваемый поставщиком услуг.

### <a name="validate-access-tokens"></a>Проверка маркеров доступа

Маркер в `Authorization` заголовке — это [маркер доступа платформы удостоверений (Майкрософт](../active-directory/develop/access-tokens.md#validating-tokens)).

Чтобы проверить маркеры доступа, приложение должно также проверить аудиторию и маркеры подписывания. Они должны проверяться на соответствие значениям в документе обнаружения OpenID. Например, см. [версию документа, не зависящую от клиента](https://login.microsoftonline.com/common/.well-known/openid-configuration).

По промежуточного слоя Azure Active Directory (Azure AD) имеет встроенные возможности проверки маркеров доступа. Вы можете просмотреть наши [примеры](../active-directory/develop/sample-v2-code.md) , чтобы найти их на выбранном языке.

Мы предоставляем библиотеки и примеры кода, демонстрирующие способы проверки маркеров. Кроме того, для проверки JSON Web Token (JWT) доступны несколько библиотек партнеров с открытым кодом. Существует по крайней мере один вариант почти для каждой платформы и языка. Дополнительные сведения о библиотеках проверки подлинности Azure AD и примеры кода см. в [статье библиотеки проверки подлинности платформы Microsoft Identity](../active-directory/develop/reference-v2-libraries.md).

#### <a name="authentication-in-function-app"></a>Проверка подлинности в приложение-функция

Настройка проверки маркера доступа в приложение-функция проста и эффективна без работы с кодом.

1. На странице **Проверка подлинности и авторизация** переключайте **проверку подлинности службы приложений** **на вкл**.

2. Выберите **Вход с Azure Active Directory** в **действии, чтобы выполнить, когда запрос не прошел проверку подлинности**.

3. В поставщике проверки подлинности щелкните INTO **Azure Active Directory**

4. На новой странице. Выберите **Экспресс** и **создать новое приложение AD** , а затем щелкните **ОК** :::image type="content" source="media/signalr-howto-use-managed-identity/function-aad.png" alt-text="функция AAD"::: .

5. Перейдите в службу SignalR и выполните [шаги](howto-use-managed-identity.md#add-a-system-assigned-identity) , чтобы добавить назначенное системой удостоверение или удостоверение, назначенное пользователем.

6. Перейдите в **Параметры вышестоящей** службы в службе SignalR и выберите **использовать управляемое удостоверение** и **выберите существующие приложения**. Выберите ранее созданное приложение.

После этих параметров приложение-функция будет отклонять запросы без маркера доступа в заголовке.

## <a name="use-a-managed-identity-for-key-vault-reference"></a>Использование управляемого удостоверения для Key Vault ссылки

Служба SignalR может получить доступ к Key Vault для получения секрета с помощью управляемого удостоверения.

1. Добавьте удостоверение, назначенное системой, или назначенное пользователем удостоверение для службы Azure SignalR.

2. Предоставьте секретное разрешение на чтение для управляемого удостоверения в политиках доступа в Key Vault. См. раздел [Назначение политики доступа Key Vault с помощью портал Azure](../key-vault/general/assign-access-policy-portal.md)

В настоящее время эту функцию можно использовать в следующих сценариях:

- [Справочный секрет в шаблоне вышестоящего URL-адреса](./concept-upstream.md#key-vault-secret-reference-in-url-template-settings)


## <a name="next-steps"></a>Следующие шаги

- [Azure Functions development and configuration with Azure SignalR Service](signalr-concept-serverless-development-config.md) (Разработка и настройка функций Azure с помощью Службы Azure SignalR)