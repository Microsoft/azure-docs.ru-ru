---
title: Режим службы в службе SignalR Azure
description: Общие сведения о различных режимах обслуживания в службе SignalR Azure, объяснение их различий и применимых пользовательских сценариев
author: chenkennt
ms.service: signalr
ms.topic: conceptual
ms.date: 08/19/2020
ms.author: kenchen
ms.openlocfilehash: 60f1ab0440120cb9a96e6c05a4fc1987ead29188
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "92143263"
---
# <a name="service-mode-in-azure-signalr-service"></a>Режим службы в службе SignalR Azure

Режим службы является важным понятием в службе Azure SignalR. При создании нового ресурса SignalR вам будет предложено указать режим службы:

:::image type="content" source="media/concept-service-mode/create.png" alt-text="Выбор режима обслуживания при создании":::

Его также можно изменить позже в меню "Параметры":

:::image type="content" source="media/concept-service-mode/update.png" alt-text="Обновление режима службы":::

Сейчас служба SignalR Azure поддерживает три режима обслуживания: **по умолчанию**, **бессерверные** и **классические**. Ваш ресурс SignalR будет вести себя по-разному в разных режимах. В этой статье вы узнаете о различиях, а также о том, как выбрать подходящий режим службы на основе вашего сценария.

## <a name="default-mode"></a>Режим по умолчанию

Режим по умолчанию — значение по умолчанию для режима обслуживания при создании нового ресурса SignalR. В этом режиме приложение работает как типичное ASP.NET Coreное приложение SignalR (или ASP.NET), где имеется веб-сервер, на котором размещен центр (именуемый Hub Server здесь и далее), и клиенты могут обмениваться данными в режиме реального времени с центральным сервером. Единственное отличие заключается в том, что вместо прямого подключения клиента и сервера клиент и сервер подключаются к службе SignalR и используют службу в качестве прокси-сервера. Ниже приведена схема, иллюстрирующая типичную структуру приложения в режиме по умолчанию.

:::image type="content" source="media/concept-service-mode/default.png" alt-text="Структура приложения в режиме по умолчанию":::

Поэтому при наличии приложения SignalR и необходимости интеграции со службой SignalR в большинстве случаев следует выбрать режим по умолчанию.

### <a name="connection-routing-in-default-mode"></a>Маршрутизация подключений в режиме по умолчанию

В режиме по умолчанию будут использоваться соединения WebSocket между сервером концентратора и службой SignalR («соединения сервера»). Эти соединения используются для обмена сообщениями между сервером и клиентом. При подключении нового клиента служба SignalR перенаправит клиента на один сервер концентратора (предположим, что имеется несколько серверов) через существующие соединения с сервером. Затем клиентское подключение будет работать на одном сервере-концентраторе в течение своего времени существования. Когда клиент отправляет сообщения, они всегда переходят на один и тот же сервер концентратора. Это поведение позволяет безопасно поддерживать некоторые состояния для отдельных подключений на сервере-концентраторе. Например, если нужно выполнить потоковую передачу данных между сервером и клиентом, не нужно учитывать случай, когда пакеты с данными попадают на разные серверы.

> [!IMPORTANT]
> Это также означает, что в режиме по умолчанию клиент не может подключиться, не выполняя подключение к серверу. Если все серверы концентратора отключены из-за прерывания работы сети или перезагрузки сервера, то при подключении клиента появится сообщение об ошибке, сообщающее о том, что сервер не подключен. Поэтому вы обязаны убедиться в том, что в любое время есть хотя бы один сервер концентратора, подключенный к службе SignalR (например, иметь несколько серверов-концентраторов и должен ли они не переходить в автономный режим одновременно для таких вещей, как обслуживание).

Эта модель маршрутизации также означает, что если сервер-концентратор переходит в режим «вне сети», то подключения, направляемые этим сервером, будут удалены. Поэтому следует рассчитывать на подключение, если сервер-концентратор находится в автономном режиме для обслуживания и нормального подключения, чтобы он не влиял на приложение.

## <a name="serverless-mode"></a>Бессерверный режим

Режим без сервера, как и предполагает его имя, является режимом, в котором не может быть сервера центра. Сравнение с режимом по умолчанию. в этом режиме клиент не требует, чтобы сервер концентратора был подключен. Все подключения подключены к службе в режиме "без сервера", и служба отвечает за поддержание клиентских подключений, таких как обработка проверки связи с клиентами (в режиме по умолчанию это обрабатывается серверами-концентраторами).

Кроме того, в этом режиме нет подключения к серверу (если вы попытаетесь использовать пакет SDK для установки подключения к серверу, возникнет ошибка). Поэтому отсутствует маршрутизация соединений и серверное закрепление (как описано в разделе режим по умолчанию). Но вы по-прежнему можете использовать приложение на стороне сервера для отправки сообщений клиентам. Это можно сделать двумя способами: использовать API- [интерфейсы RESTful](https://github.com/Azure/azure-signalr/blob/dev/docs/rest-api.md) для одноразовой отправки или через соединение WebSocket, чтобы можно было более эффективно отправить несколько сообщений (Обратите внимание, что это соединение WebSocket отличается от подключения к серверу).

> [!NOTE]
> Как REST API, так и WebSocket поддерживаются в [пакете SDK управления](https://github.com/Azure/azure-signalr/blob/dev/docs/management-sdk-guide.md)службой SignalR. Если вы используете язык, отличный от .NET, можно также вручную вызвать интерфейсы API-интерфейсов RESTFUL, следуя этой [спецификации](https://github.com/Azure/azure-signalr/blob/dev/docs/rest-api.md).
>
> Если вы используете функции Azure, вы можете использовать [привязки службы SignalR для функций Azure](../azure-functions/functions-bindings-signalr-service.md) (здесь и далее с именем "Привязка функции") для отправки сообщений в качестве выходной привязки.

Серверное приложение также может принимать сообщения и события подключения от клиентов. Служба будет доставлять сообщения и события подключения в предварительно настроенные конечные точки (которые называются вышестоящим) с помощью веб-перехватчиков. По сравнению с режимом по умолчанию не гарантируется, что закрепление и HTTP-запросы могут оказаться менее эффективными, чем соединения WebSocket.

Дополнительные сведения о настройке вышестоящей конфигурации см. в этом [документе](./concept-upstream.md).

Ниже приведена схема, на которой показано, как работает бессерверный режим.

:::image type="content" source="media/concept-service-mode/serverless.png" alt-text="Структура приложения в бессерверном режиме":::

> [!NOTE]
> Обратите внимание, что в режиме по умолчанию можно также использовать функцию REST API/Management SDK/Function для отправки сообщений клиенту напрямую, если вы не хотите проходить через сервер концентратора. Но в режиме по умолчанию клиентские подключения по-прежнему обрабатываются серверами концентратора, а вышестоящее подключение не работает в этом режиме.

## <a name="classic-mode"></a>Классический режим

Классическая модель является смешанным режимом работы по умолчанию и бессерверного режима. В этом режиме режим соединения определяется тем, подключен ли сервер концентратора при установлении клиентского соединения. При наличии сервера-концентратора клиентское подключение будет направляться на сервер концентратора. В противном случае будет введен безсерверный режим, в котором сообщение "клиент-сервер" не может быть доставлено на сервер концентратора. Это приведет к несоответствию, например, если все серверы-концентраторы недоступны в течение короткого промежутка времени, все подключения клиентов, созданные в это время, будут находиться в бессерверном режиме и не смогут передавать сообщения на сервер концентратора.

> [!NOTE]
> Классический режим в основном используется для обеспечения обратной совместимости для приложений, созданных до появлении режима по умолчанию и бессерверного. Настоятельно рекомендуется больше не использовать этот режим. Для новых приложений выберите вариант по умолчанию или бессерверный в зависимости от вашего сценария. Для существующих приложений также рекомендуется проверить варианты использования и выбрать подходящий режим обслуживания.

Классический режим также не поддерживает некоторые новые функции, такие как вышестоящий режим без сервера.

## <a name="choose-the-right-service-mode"></a>Выбор правильного режима службы

Теперь следует понимать различия между режимами обслуживания и уметь выбирать между ними. Как вы уже узнали из предыдущего раздела, классический режим не рекомендуется, и следует выбирать только между сервером по умолчанию и без сервера. Ниже приведены некоторые дополнительные советы, которые помогут вам сделать правильный вариант для новых приложений и снять классический режим для существующих приложений.

* Если вы уже знакомы с работой библиотеки SignalR и хотите переместиться из самостоятельно размещенного SignalR для использования службы Azure SignalR, выберите режим по умолчанию. Режим по умолчанию работает точно так же, как и самостоятельно размещенный SignalR (и вы можете использовать ту же модель программирования в библиотеке SignalR), служба SignalR выступает в качестве прокси между клиентами и серверами-концентраторами.

* Если вы создаете новое приложение и не хотите поддерживать сервер концентратора и соединения с сервером, выберите режим без сервера. Этот режим обычно работает вместе с функциями Azure, поэтому вам не нужно поддерживать какой бы то ни было сервер. Можно по-прежнему использовать дуплексную связь (с помощью пакета SDK REST API/Management или привязки функции + вышестоящего), но модель программирования будет отличаться от модели SignalR.

* Если у вас есть оба концентратора для обслуживания клиентских подключений и серверного приложения для прямой отправки сообщений клиентам (например, через REST API), следует выбрать режим по умолчанию. Помните, что основное различие между режимами по умолчанию и бессерверностью заключается в том, имеются ли серверы-концентраторы и как направляются подключения клиентов. В обоих режимах можно использовать пакет SDK для REST API/управления и привязку функций.

* Если у вас есть смешанный сценарий, то, например, у вас есть два разных концентратора в одном и том же ресурсе SignalR, один из которых используется в качестве стандартного концентратора SignalR, а другой используется с функциями Azure и не имеет сервера-концентратора, следует считать, что они разделяются на два ресурса SignalR, один в режиме по умолчанию и один в режиме без сервера.

## <a name="next-steps"></a>Дальнейшие действия

Чтобы узнать больше о том, как использовать режим по умолчанию и бессерверные, ознакомьтесь со следующими статьями:

* [Внутренние компоненты службы Azure SignalR](signalr-concept-internals.md)

* [Azure Functions development and configuration with Azure SignalR Service](signalr-concept-serverless-development-config.md) (Разработка и настройка функций Azure с помощью Службы Azure SignalR)