---
title: Защита содержимого с помощью служб мультимедиа Azure | Документация Майкрософт
description: В этой статье приводятся общие сведения о защите содержимого с помощью служб мультимедиа Azure версии 2.
services: media-services
documentationcenter: ''
author: IngridAtMicrosoft
manager: femila
editor: ''
ms.assetid: 81bc00e1-dcda-4d69-b9ab-8768b793422b
ms.service: media-services
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 03/10/2021
ms.author: inhenkel
ms.openlocfilehash: edffa2dddd0ec877a4b825a69a76fb158928c89f
ms.sourcegitcommit: 225e4b45844e845bc41d5c043587a61e6b6ce5ae
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/11/2021
ms.locfileid: "103016769"
---
# <a name="content-protection-overview"></a>Обзор системы защиты содержимого

[!INCLUDE [media services api v2 logo](./includes/v2-hr.md)] 

> [!NOTE]
> В Cлужбы мультимедиа версии 2 больше не добавляются новые компоненты или функциональные возможности. <br/>Ознакомьтесь с новейшей версией Служб мультимедиа — [версией 3](../latest/index.yml). Также изучите руководство по [миграции из версии 2 в версию 3](../latest/migrate-v-2-v-3-migration-introduction.md).

Службы мультимедиа Azure позволяют защитить данные мультимедиа, покидающие ваш компьютер, на этапах их хранения, обработки и доставки, а также доставлять в режиме реального времени и по требованию содержимое, зашифрованное динамически с помощью Advanced Encryption Standard (AES-128) или трех основных систем управления цифровыми правами (DRM): Microsoft PlayReady, Google Widevine и Apple FairPlay. Они также обеспечивают службу доставки ключей AES и лицензий DRM (PlayReady, Widevine и FairPlay) авторизованным клиентам. 

На следующем рисунке показан рабочий процесс защиты содержимого Служб мультимедиа: 

![Защита с помощью PlayReady](./media/media-services-content-protection-overview/media-services-content-protection-with-multi-drm.png)

В этой статье объясняются основные понятия и термины, необходимые для понимания процесса защиты содержимого с помощью AMS. В статье также содержатся ссылки на статьи, в которых обсуждается защита содержимого. 

## <a name="dynamic-encryption"></a>Динамическое шифрование

Службы мультимедиа Azure доставляют содержимое, динамически зашифрованное с помощью незащищенного ключа AES или шифрования DRM путем использования PlayReady, Widevine или FairPlay. Если содержимое шифруется с помощью открытого ключа AES и отправляется по протоколу HTTPS, оно не очищается до тех пор, пока не достигнет клиента. 

Каждый метод шифрования поддерживает следующие протоколы потоковой передачи:
 
- AES: MPEG-DASH, Smooth Streaming и HLS.
- PlayReady: MPEG-DASH, Smooth Streaming и HLS.
- Widevine: MPEG-DASH.
- FairPlay: HLS.

Шифрование при поэтапной загрузке не поддерживается. 

Чтобы выполнить шифрование ресурса, необходимо связать ключ шифрования содержимого с ресурсом, а также настроить политику авторизации для ключа. Ключи содержимого можно указать или они автоматически создаются службами мультимедиа.

Потребуется также настроить политику доставки ресурсов. Если вы хотите выполнять потоковую передачу ресурса из зашифрованного хранилища, задайте способ его доставки, настроив политику доставки ресурсов.

Когда поток запрашивается проигрывателем, Службы мультимедиа используют указанный ключ для динамического шифрования содержимого с помощью незащищенного ключа AES или DRM. Чтобы расшифровать поток, проигрыватель запросит ключ у службы доставки ключей Служб мультимедиа. Чтобы определить, есть ли у пользователя право на получение ключа, служба оценивает политики авторизации, заданные для ключа.

## <a name="aes-128-clear-key-vs-drm"></a>AES-128 очистка ключа и DRM
Клиенты часто интересуются, следует ли им использовать шифрование AES или систему DRM. Основное различие между двумя системами заключается в том, что при шифровании AES ключ содержимого передается клиенту в незашифрованном формате ("в чистом виде"). В результате ключ, используемый для шифрования содержимого, можно просмотреть в сетевой трассировке на стороне клиента в виде открытого текста. Шифрование незащищенного ключа AES-128 подходит для использования в случаях, когда зритель является доверенным лицом (например, шифрование корпоративного видео, распространяемого внутри компании, для просмотра сотрудниками).

PlayReady, Widevine и FairPlay обеспечивают более высокий уровень шифрования по сравнению с незащищенным ключом AES-128. Ключ содержимого передается в зашифрованном виде. Кроме того, расшифровка выполняется в защищенной среде на уровне операционной системы, где злоумышленнику труднее атаковать. Мы рекомендуем использовать DRM в случаях, когда зритель не может быть доверенным лицом, и вам нужен самый высокий уровень безопасности.

## <a name="storage-encryption"></a>Шифрование хранилища
Шифрование хранилища используется для локального шифрования незащищенного содержимого с помощью AES 256 и его добавления в службу хранилища Azure, где оно хранится в зашифрованном виде. Ресурсы, защищенные с помощью шифрования хранилища, автоматически расшифровываются и помещаются в зашифрованную файловую систему до кодирования. При необходимости ресурсы повторно кодируются до отправки в виде нового выходного ресурса. Основная причина использования шифрования хранилища — для защиты входных файлов мультимедиа высокого качества с помощью стойкого шифрования при хранении на диске.

Для доставки ресурса из зашифрованного хранилища необходимо настроить политику доставки ресурсов, чтобы Службы мультимедиа могли определить, как вы хотите доставлять содержимое. Перед выполнением потоковой передачи ресурса сервер потоковой передачи расшифровывает и осуществляет потоковую передачу содержимого с помощью указанной политики доставки (например, AES, общее шифрование или без шифрования).

## <a name="types-of-encryption"></a>Типы шифрования
PlayReady и Widevine используют общее шифрование (режим AES CTR). FairPlay использует режим шифрования AES CBC. Шифрование с применением незащищенного ключа AES-128 использует шифрование конвертов.

## <a name="licenses-and-keys-delivery-service"></a>Служба доставки лицензий и ключей
Службы мультимедиа предоставляют службу доставки ключей для доставки лицензий DRM (PlayReady, Widevine и FairPlay) и ключей AES авторизованным клиентам. Чтобы настроить политики авторизации и аутентификации для лицензий и ключей, можно использовать [портал Azure](media-services-portal-protect-content.md), REST API или пакет SDK служб мультимедиа для .NET.

## <a name="control-content-access"></a>Доступ к содержимому элемента управления
Вы можете контролировать пользователей, имеющих доступ к содержимому, настроив политику авторизации ключа содержимого. Политика авторизации ключа содержимого поддерживает открытую авторизацию или авторизацию с использованием маркера.

### <a name="open-authorization"></a>Открытая авторизация
При использовании политики открытой авторизации ключ содержимого отправляется любому клиенту (без ограничений).

### <a name="token-authorization"></a>Авторизация с помощью маркера
При использовании политики авторизации с ограничением по маркеру ключ содержимого будет отправлен только тому клиенту, который представит действующий токен JSON Web Token (JWT) или простой веб-токен (SWT) в запросе ключа или лицензии. Этот токен должен быть выдан службой токенов безопасности (STS). Вы можете использовать Azure Active Directory в качестве STS или развернуть пользовательскую службу токенов безопасности. Чтобы создать маркер, подписанный указанным ключом, и получить утверждения, указанные в конфигурации ограничения по маркерам, должна быть настроена служба маркеров безопасности. Служба доставки ключей Служб мультимедиа возвращает клиенту запрошенный ключ (или лицензию), если маркер является допустимым, а его утверждения соответствуют утверждениям, настроенным для ключа (или лицензии).

При настройке политики ограничения по маркеру необходимо задать такие параметры, как основной ключ проверки, издатель и аудитория. Основной ключ проверки содержит ключ, которым был подписан маркер. Издателем является служба токенов безопасности, которая выдает токен. Аудитория, иногда называемая областью, описывает назначение маркера или ресурс, доступ к которому обеспечивает маркер. Служба доставки ключей служб мультимедиа проверяет, соответствуют ли эти значения в маркере значениям в шаблоне.

### <a name="token-replay-prevention"></a>Предотвращение воспроизведения токенов

Функция *Предотвращение воспроизведения маркеров* позволяет клиентам Служб мультимедиа устанавливать ограничения на то, сколько раз один и тот же маркер можно использовать для запроса ключа или лицензии. Клиент может добавить утверждение типа `urn:microsoft:azure:mediaservices:maxuses` в маркер, где значение — это количество раз, когда маркер может быть использован для получения лицензии или ключа. Все последующие запросы с одинаковым токеном к доставке ключей будут возвращать несанкционированный ответ. См. статью как добавить утверждение в [Пример DRM](https://github.com/Azure-Samples/media-services-v3-dotnet-tutorials/blob/master/AMSV3Tutorials/EncryptWithDRM/Program.cs#L601).
 
#### <a name="considerations"></a>Рекомендации

* Клиенты должны иметь контроль над созданием маркеров. Утверждение необходимо поместить в сам маркер.
* При использовании этой функции запросы с маркерами, срок действия которых превышает один час с момента получения запроса, отклоняются с несанкционированным ответом.
* Маркеры уникально идентифицируются их сигнатурой. Любое изменение полезных данных (например, обновление до срока действия или утверждения) приводит к изменению подписи маркера и будет считаться новым маркером, который доставка ключа не поступает до этого момента.
* Воспроизведение завершается ошибкой, если маркер превысил `maxuses` значение, установленное клиентом.
* Эта функция может использоваться для всего существующего защищенного содержимого (необходимо изменить только выданный маркер).
* Эта функция работает как с JWT, так и с SWT.

## <a name="streaming-urls"></a>URL-адреса потоковой передачи
Если ресурс был зашифрован с помощью нескольких систем DRM, то в URL-адресе для потоковой передачи следует использовать тег шифрования: (format='m3u8-aapl', encryption='xxx').

Действительны следующие условия.

* Вы можете указать не более одного типа шифрования.
* Если к ресурсу был применен только один тип шифрования, то в URL-адресе тип шифрования можно не указывать.
* Тип шифрования вводится без учета регистра.
* Можно указать следующие типы шифрования:

  * **cenc**: PlayReady или Widevine (общее шифрование).
  * **cbcs aapl**: для FairPlay (шифрование AES CBC).
  * **cbc**: шифрование конверта AES.

## <a name="additional-notes"></a>Дополнительные замечания

* Widevine — это служба, которая предоставляется компанией Google Inc. и подпадает под условия предоставления услуг и политику конфиденциальности Google Inc.

## <a name="next-steps"></a>Дальнейшие действия
В следующих статьях описываются дальнейшие действия, которые помогут вам приступить к работе по защите содержимого:

* [Шифрование содержимого с помощью шифрования хранилища](media-services-rest-storage-encryption.md)
* [Использование динамического шифрования AES-128 и службы доставки ключей](media-services-protect-with-aes128.md)
* [Защита с помощью PlayReady и Widevine](media-services-protect-with-playready-widevine.md)
* [Защита с помощью FairPlay](media-services-protect-hls-with-FairPlay.md)

## <a name="related-links"></a>Связанные ссылки

* [JWT token Authentication in Azure Media Services and Dynamic Encryption](http://www.gtrifonov.com/2015/01/03/jwt-token-authentication-in-azure-media-services-and-dynamic-encryption/) (Аутентификация токена JWT в службах мультимедиа Azure и динамическое шифрование)
* [Integrate Azure Media Services OWIN MVC based app with Azure Active Directory and restrict content key delivery based on JWT claims](http://www.gtrifonov.com/2015/01/24/mvc-owin-azure-media-services-ad-integration/) (Интеграция приложения на основе OWIN MVC Служб мультимедиа Azure с Azure Active Directory и ограничение доставки ключей содержимого на основе утверждений JWT)

[content-protection]: ./media/media-services-content-protection-overview/media-services-content-protection.png
