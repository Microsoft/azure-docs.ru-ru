---
title: Доставка содержимого клиентам
description: В этой статье представлен обзор доставки содержимого с помощью служб мультимедиа Azure.
services: media-services
author: IngridAtMicrosoft
manager: femila
ms.assetid: 89ede54a-6a9c-4814-9858-dcfbb5f4fed5
ms.service: media-services
ms.workload: media
ms.topic: article
ms.date: 03/10/2021
ms.author: inhenkel
ms.openlocfilehash: 1ad89345a2779766fde4559758e61dff92023741
ms.sourcegitcommit: 225e4b45844e845bc41d5c043587a61e6b6ce5ae
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/11/2021
ms.locfileid: "103016617"
---
# <a name="deliver-content-to-customers"></a>Доставка содержимого клиентам

[!INCLUDE [media services api v2 logo](./includes/v2-hr.md)]

При доставке содержимого клиентам в виде потоковой трансляции или видео по запросу ваша задача — доставлять видео высокого качества для различных устройств в разных сетевых условиях.

Для достижения этой цели можно сделать следующее.

* Можно кодировать поток в видеопоток с разными скоростями (с переменной скоростью). Это позволит соблюдать различные уровни качества и условия сети.
* Можно также использовать [динамическую упаковку](media-services-dynamic-packaging-overview.md) служб мультимедиа Microsoft Azure для динамической перепаковки потока в разные протоколы. Это позволит транслировать поток на разных устройствах. Службы мультимедиа поддерживают доставку следующих технологий потоковой передачи с переменной скоростью: <br/>
    * **HTTP Live Streaming** (HLS). Добавьте путь (format=m3u8-aapl) в часть /Manifest URL-адреса, чтобы настроить для сервера-источника потоковой передачи возврат содержимого HLS для использования на собственных устройствах **Apple iOS**. Дополнительные сведения см. в разделах об [указателях](#locators) и [URL-адресах](#URLs).
    * **MPEG-DASH**. Добавьте путь (format=mpd-time-csf) в часть /Manifest URL-адреса, чтобы настроить для сервера-источника потоковой передачи возврат MPEG-DASH. Дополнительные сведения см. в разделах об [указателях](#locators) и [URL-адресах](#URLs).
    * **Smooth Streaming**.

>[!NOTE]
>При создании учетной записи AMS в нее добавляется конечная точка потоковой передачи **по умолчанию** в состоянии **Остановлена**. Чтобы начать потоковую передачу содержимого и воспользоваться динамической упаковкой и динамическим шифрованием, конечная точка потоковой передачи, из которой необходимо выполнять потоковую передачу содержимого, должна находиться в состоянии **Выполняется**. 

В этой статье приводится обзор важных понятий, связанных с доставкой содержимого.

Сведения об известных проблемах см. в разделе [Известные проблемы](media-services-deliver-content-overview.md#known-issues).

## <a name="dynamic-packaging"></a>Динамическая упаковка
Применение динамической упаковки служб мультимедиа позволяет доставлять закодированное содержимое MP4-файлов с переменной скоростью или содержимое Smooth Streaming в форматах потоковой передачи с поддержкой служб мультимедиа (MPEG-DASH, HLS, Smooth Streaming) без необходимости перепаковки в эти форматы. Мы рекомендуем доставлять содержимое с помощью динамической упаковки.

Чтобы воспользоваться динамической упаковкой, закодируйте мезонинный (исходный) файл в набор файлов формата MP4 или потоковой передачи Smooth Streaming с переменной скоростью.

Используя динамическую упаковку, можно хранить и оплачивать файлы в одном формате хранения. Службы мультимедиа будут создавать и обрабатывать соответствующий ответ с учетом ваших запросов.

Динамическая упаковка доступна для конечных точек потоковой передачи уровня "Стандартный" и "Премиум". 

Дополнительные сведения см. в разделе [Динамическая упаковка](media-services-dynamic-packaging-overview.md).

## <a name="filters-and-dynamic-manifests"></a>Фильтры и динамические манифесты
Службы мультимедиа позволяют определять фильтры для ресурсов-контейнеров. Эти фильтры представляют собой правила на стороне сервера, помогающие пользователям выполнять такие действия, как воспроизведение определенной части видео или указание подмножества представлений аудио и видео, которые может обрабатывать устройство клиента (вместо всех представлений, связанных с ресурсом-контейнером). Такая фильтрация осуществляется с помощью *динамических манифестов* , которые создаются, когда клиент запрашивает потоковую передачу видео на основе одного или нескольких указанных фильтров.

Чтобы узнать больше, ознакомьтесь со [Фильтры и динамические манифесты](media-services-dynamic-manifest-overview.md).

## <a name="locators"></a><a name="locators"></a>Указатели
Чтобы предоставить пользователю URL-адрес, который можно использовать для потоковой передачи или скачивания содержимого, сначала необходимо опубликовать ресурс-контейнер, создав указатель. Указатель предоставляет точку входа для доступа к файлам в ресурсе-контейнере. Службы мультимедиа поддерживают два типа указателей:

* Указатели OnDemandOrigin. Они используются для потоковой передачи мультимедиа (например, в формате MPEG DASH, HLS или Smooth Streaming) или поэтапной загрузки файлов.
* Указатели подписанного URL-адреса (SAS). Они используются для скачивания файлов мультимедиа на локальный компьютер.

*Политика доступа* используется для определения разрешений (например, для чтения, записи и перечисления) и длительности доступа клиента к определенному ресурсу-контейнеру. Обратите внимание, что разрешение на перечисление (AccessPermissions.List) не следует использовать при создании указателя OnDemandOrigin.

Указатели имеют срок действия. Портал Azure задает для указателей срок действия в 100 лет.

> [!NOTE]
> Если вы создавали указатели на портале Azure до марта 2015 года, то их срок действия составлял два года.
> 
> 

Чтобы обновить срок действия указателя, используйте [REST API](/rest/api/media/operations/locator#update_a_locator) или [.NET API](/dotnet/api/microsoft.windowsazure.mediaservices.client.ilocator). Обратите внимание, что при обновлении срока действия указателя SAS изменяется URL-адрес.

Указатели не предназначены для управления доступом на уровне пользователей. Вы можете предоставлять различные права доступа отдельным пользователям, используя решения для управления цифровыми правами. Дополнительные сведения см. в разделе [Службы мультимедиа — потоковая передача по запросу](/previous-versions/azure/dn282272(v=azure.100)).

При создании указателя может возникать 30-секундная задержка из-за необходимых процессов сохранения и распространения в службе хранилища Azure.

## <a name="adaptive-streaming"></a>Адаптивная потоковая передача
Технологии передачи с переменной скоростью позволяют видеопроигрывателю определить условия работы сети и выбрать одну из нескольких скоростей. Если условия передачи в сети ухудшаются, клиент может выбрать более низкую скорость, позволяя видеопроигрывателю продолжать воспроизводить видео в более низком качестве. Если состояние сети улучшается, то клиент может переключиться на более высокую скорость с более высоким качеством видео. Службы мультимедиа Azure поддерживают следующие технологии передачи с переменной скоростью: HTTP Live Streaming (HLS), Smooth Streaming и MPEG-DASH.

Чтобы предоставить пользователям URL-адреса потоковой передачи, сначала необходимо создать указатель OnDemandOrigin. При создании указателя вы получите базовый путь к ресурсу-контейнеру, в котором находится содержимое для потоковой передачи. Тем не менее, чтобы получить возможность потоковой передачи содержимого, необходимо изменить этот путь. Чтобы сформировать полный URL-адрес к файлу манифеста потоковой передачи, необходимо сцепить значение пути указателя и имя файла манифеста (filename.ism). Затем добавьте **/Manifest** и соответствующий формат (если нужно) в путь указателя.

> [!NOTE]
> Вы также можете выполнять потоковую передачу содержимого через TLS-подключение. Для этого убедитесь, что URL-адреса потоковой передачи начинаются с HTTPS. Обратите внимание, что в настоящее время AMS не поддерживает TLS с пользовательскими доменами.  
> 

Потоковую передачу можно выполнять только по протоколу TLS, если конечная точка потоковой передачи, из которой доставляется содержимое, была создана после 10 сентября 2014 г. Если URL-адреса потоковой передачи основаны на конечных точках потоковой передачи, созданных после 10 сентября 2014 года, то они содержат "streaming.mediaservices.windows.net". URL-адреса потоковой передачи, содержащие "origin.mediaservices.windows.net" (старый формат), не поддерживают TLS. Если URL-адрес имеет старый формат и вы хотите иметь возможность выполнять потоковую передачу по протоколу TLS, создайте новую конечную точку потоковой передачи. Используйте URL-адреса на основе новой конечной точки потоковой передачи, чтобы передать содержимое по протоколу TLS.

## <a name="streaming-url-formats"></a><a name="URLs"></a>Форматы URL-адресов потоковой передачи

### <a name="mpeg-dash-format"></a>Формат MPEG-DASH
{имя конечной точки потоковой передачи - имя учетной записи служб мультимедиа}.streaming.mediaservices.windows.net/{идентификатор указателя}/{имя файла}.ism/Manifest(format=mpd-time-csf)

http: \/ /testendpoint-testaccount.Streaming.mediaservices.Windows.NET/fecebb23-46f6-490d-8b70-203e86b0df58/BigBuckBunny.ISM/MANIFEST (формат = MPD-Time-CSF)

### <a name="apple-http-live-streaming-hls-v4-format"></a>Формат Apple HTTP Live Streaming (HLS) V4
{имя конечной точки потоковой передачи - имя учетной записи служб мультимедиа}.streaming.mediaservices.windows.net/{идентификатор указателя}/{имя файла}.ism/Manifest(format=m3u8-aapl)

http: \/ /testendpoint-testaccount.Streaming.mediaservices.Windows.NET/fecebb23-46f6-490d-8b70-203e86b0df58/BigBuckBunny.ISM/MANIFEST (Format = m3u8-AAPL)

### <a name="apple-http-live-streaming-hls-v3-format"></a>Формат Apple HTTP Live Streaming (HLS) V3
{имя конечной точки потоковой передачи - имя учетной записи служб мультимедиа}.streaming.mediaservices.windows.net/{идентификатор указателя}/{имя файла}.ism/Manifest(format=m3u8-aapl-v3)

http: \/ /testendpoint-testaccount.Streaming.mediaservices.Windows.NET/fecebb23-46f6-490d-8b70-203e86b0df58/BigBuckBunny.ISM/MANIFEST (Format = m3u8-AAPL-v3)

### <a name="apple-http-live-streaming-hls-format-with-audio-only-filter"></a>Формат Apple HTTP Live Streaming (HLS) с фильтром "только аудио"
По умолчанию дорожки, содержащие только аудио, включены в манифест HLS. Это требуется для сертификации магазина Apple для сетей мобильной связи. В этом случае, если клиент не имеет достаточную пропускную способность или подключен через сеть 2G, то он переключается на воспроизведение только аудио дорожки. Это позволяет осуществлять потоковую передачу содержимого без необходимости буферизации, но и видео при этом не отображается. В некоторых сценариях буферизация проигрывателя может быть предпочтительнее воспроизведения лишь аудио дорожки. Для удаления дорожки, содержащей только аудио, добавьте к URL-адресу **audio-only=false** .

http: \/ /testendpoint-testaccount.Streaming.mediaservices.Windows.NET/fecebb23-46f6-490d-8b70-203e86b0df58/BigBuckBunny.ISM/MANIFEST (Format = m3u8-AAPL-v3, Audio-Only = false)

Дополнительные сведения см. в записи блога [Azure Media Services – Dynamic Manifest Composition support and HLS output additional features](https://azure.microsoft.com/blog/azure-media-services-release-dynamic-manifest-composition-remove-hls-audio-only-track-and-hls-i-frame-track-support/) (Службы мультимедиа Azure — поддержка динамического создания манифестов и дополнительные функции вывода HLS).

### <a name="smooth-streaming-format"></a>Формат Smooth Streaming
{имя конечной точки потоковой передачи - имя учетной записи служб мультимедиа}.streaming.mediaservices.windows.net/{идентификатор указателя}/{имя файла}.ism/Manifest

Пример

http: \/ /testendpoint-testaccount.Streaming.mediaservices.Windows.NET/fecebb23-46f6-490d-8b70-203e86b0df58/BigBuckBunny.ISM/manifest

### <a name="smooth-streaming-20-manifest-legacy-manifest"></a><a id="fmp4_v20"></a>Манифест Smooth Streaming 2.0 (манифест прежних версий)
По умолчанию формат манифеста Smooth Streaming содержит тег повтора (r-tag). Однако некоторые проигрыватели не поддерживают r-tag. Клиенты с этими проигрывателями могут использовать формат, который отключает r-tag.

{имя конечной точки потоковой передачи - имя учетной записи служб мультимедиа}.streaming.mediaservices.windows.net/{идентификатор указателя}/{имя файла}.ism/Manifest(format=fmp4-v20)

`http://testendpoint-testaccount.streaming.mediaservices.windows.net/fecebb23-46f6-490d-8b70-203e86b0df58/BigBuckBunny.ism/Manifest(format=fmp4-v20)`

## <a name="progressive-download"></a>Прогрессивное скачивание
Поэтапная загрузка позволяет начать воспроизведение мультимедиа до окончания скачивания всего файла. ISM\* (ISMV-, ISMA-, ISMT- и ISMC)-файлы не могут быть загружены поэтапно.

Для последовательной загрузки содержимого используйте тип указателя OnDemandOrigin. В следующем примере показан URL-адрес, основанный на типе указателя OnDemandOrigin.

`http://amstest1.streaming.mediaservices.windows.net/3c5fe676-199c-4620-9b03-ba014900f214/BigBuckBunny_H264_650kbps_AAC_und_ch2_96kbps.mp4`

Необходимо расшифровать все зашифрованные в хранилище ресурсы-контейнеры, которые требуется передать из исходной службы для поэтапной загрузки.

## <a name="download"></a>Скачивание
Для скачивания содержимого на клиентское устройство необходимо создать указатель SAS. Он предоставляет доступ к контейнеру службы хранилища Azure, в котором расположен ваш файл. Чтобы создать URL-адрес загрузки, необходимо вставить имя файла между узлом и подписью SAS.

В следующем примере показан URL-адрес, основанный на типе указателя SAS.

`https://test001.blob.core.windows.net/asset-ca7a4c3f-9eb5-4fd8-a898-459cb17761bd/BigBuckBunny.mp4?sv=2012-02-12&se=2014-05-03T01%3A23%3A50Z&sr=c&si=7c093e7c-7dab-45b4-beb4-2bfdff764bb5&sig=msEHP90c6JHXEOtTyIWqD7xio91GtVg0UIzjdpFscHk%3D`

Действительны следующие условия.

* Необходимо расшифровать все зашифрованные в хранилище ресурсы-контейнеры, которые требуется передать из исходной службы для поэтапной загрузки.
* Процесс скачивания, не завершенный в течение 12 часов, завершается ошибкой.

## <a name="streaming-endpoints"></a>Конечные точки потоковой передачи

Конечная точка потоковой передачи — это служба потоковой передачи, которая может доставить содержимое непосредственно в клиентское приложение проигрывателя или в сеть доставки содержимого (CDN) для дальнейшего распространения. Исходящим потоком службы конечной точки потоковой передачи может быть динамический поток или ресурс-контейнер видео по запросу в учетной записи служб мультимедиа. Существует два типа конечных точек потоковой передачи: **стандартные** и **Премиум**. Дополнительные сведения см. в статье [Общие сведения о конечных точках потоковой передачи](media-services-streaming-endpoints-overview.md).

>[!NOTE]
>При создании учетной записи AMS в нее добавляется конечная точка потоковой передачи **по умолчанию** в состоянии **Остановлена**. Чтобы начать потоковую передачу содержимого и воспользоваться динамической упаковкой и динамическим шифрованием, конечная точка потоковой передачи, из которой необходимо выполнять потоковую передачу содержимого, должна находиться в состоянии **Выполняется**. 

## <a name="known-issues"></a>Известные проблемы
### <a name="changes-to-smooth-streaming-manifest-version"></a>Изменения в версии манифеста Smooth Streaming
До выпуска набора исправлений в июле 2016 года дело обстояло так. Когда ресурсы-контейнеры, генерируемые стандартным кодировщиком мультимедиа, расширенным рабочим процессом кодировщика мультимедиа или устаревшим кодировщиком мультимедиа Azure, передавались в потоке с помощью динамической упаковки, выдавался манифест Smooth Streaming версии 2.0. В нем для длительностей фрагментов не использовались так называемые теги повтора (r-tag). Пример.

```xml
<?xml version="1.0" encoding="UTF-8"?>
<SmoothStreamingMedia MajorVersion="2" MinorVersion="0" Duration="8000" TimeScale="1000">
    <StreamIndex Chunks="4" Type="video" Url="QualityLevels({bitrate})/Fragments(video={start time})" QualityLevels="3" Subtype="" Name="video" TimeScale="1000">
        <QualityLevel Index="0" Bitrate="1000000" FourCC="AVC1" MaxWidth="640" MaxHeight="360" CodecPrivateData="00000001674D4029965201405FF2E02A100000030010000003032E0A000F42400040167F18E3050007A12000200B3F8C70ED0B16890000000168EB7352" />
        <c t="0" d="2000" n="0" />
        <c d="2000" />
        <c d="2000" />
        <c d="2000" />
    </StreamIndex>
</SmoothStreamingMedia>
```

После выпуска набора исправлений в июле 2016 года создаваемый манифест Smooth Streaming соответствует версии 2.2, в которой для длительностей фрагментов используются теги повтора. Пример.

```xml
<?xml version="1.0" encoding="UTF-8"?>
<SmoothStreamingMedia MajorVersion="2" MinorVersion="2" Duration="8000" TimeScale="1000">
    <StreamIndex Chunks="4" Type="video" Url="QualityLevels({bitrate})/Fragments(video={start time})" QualityLevels="3" Subtype="" Name="video" TimeScale="1000">
        <QualityLevel Index="0" Bitrate="1000000" FourCC="AVC1" MaxWidth="640" MaxHeight="360" CodecPrivateData="00000001674D4029965201405FF2E02A100000030010000003032E0A000F42400040167F18E3050007A12000200B3F8C70ED0B16890000000168EB7352" />
        <c t="0" d="2000" r="4" />
    </StreamIndex>
</SmoothStreamingMedia>
```

Некоторые устаревшие клиенты Smooth Streaming могут не поддерживать теги повтора и поэтому не загружать манифест. Чтобы устранить эту проблему, воспользуйтесь параметром формата манифеста прежних версий **(format=fmp4-v20)** или обновите свой клиент до последней версии, поддерживающей теги повтора. Чтобы узнать больше, ознакомьтесь со [Smooth Streaming 2.0](media-services-deliver-content-overview.md#fmp4_v20).

## <a name="media-services-learning-paths"></a>Схемы обучения работе со службами мультимедиа
[!INCLUDE [media-services-learning-paths-include](../../../includes/media-services-learning-paths-include.md)]

## <a name="provide-feedback"></a>Отзывы
[!INCLUDE [media-services-user-voice-include](../../../includes/media-services-user-voice-include.md)]

## <a name="related-topics"></a>Связанные темы
[Обновление указателей служб мультимедиа после отката ключей хранилища](media-services-roll-storage-access-keys.md)