---
title: Использование аутентификации Azure AD для доступа к API служб мультимедиа Azure с помощью REST | Документация Майкрософт
description: Узнайте, как обращаться к API служб мультимедиа Azure с помощью аутентификации Azure Active Directory, используя REST.
services: media-services
documentationcenter: ''
author: IngridAtMicrosoft
manager: femila
editor: ''
ms.service: media-services
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 03/10/2021
ms.author: inhenkel
ms.reviewer: willzhan; johndeu
ms.openlocfilehash: a2b4e7bf03ebb1fbc197b78287cb50b3f421d713
ms.sourcegitcommit: 225e4b45844e845bc41d5c043587a61e6b6ce5ae
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/11/2021
ms.locfileid: "103017313"
---
# <a name="use-azure-ad-authentication-to-access-the-media-services-api-with-rest"></a>Использование аутентификации Azure AD для доступа к API Служб мультимедиа с помощью REST

[!INCLUDE [media services api v2 logo](./includes/v2-hr.md)]

> [!NOTE]
> В Cлужбы мультимедиа версии 2 больше не добавляются новые компоненты или функциональные возможности. <br/>Ознакомьтесь с новейшей версией Служб мультимедиа — [версией 3](../latest/index.yml). Также изучите руководство по [миграции из версии 2 в версию 3](../latest/migrate-v-2-v-3-migration-introduction.md).

Процесс аутентификации Azure AD в службах мультимедиа Azure можно выполнить двумя способами.

- **Аутентификация пользователя** позволяет проверить подлинность пользователя, который использует приложение для взаимодействия с ресурсами служб мультимедиа Azure. Интерактивное приложение должно сначала запросить у пользователя учетные данные. Примером может послужить приложение консоли управления, которое используется авторизованными пользователями для мониторинга заданий кодирования или потоковой трансляции. 
- **Аутентификация субъекта-службы** позволяет проверить подлинность службы. Этот метод аутентификации обычно используют приложения, которые выполняют службы управляющей программы, службы среднего уровня или запланированные задания, например веб-приложения, приложения-функции, приложения логики, интерфейсы API или микрослужбы.

    В этом руководстве показано, как использовать аутентификацию **субъекта-службы** Azure AD для доступа к API AMS с помощью REST. 

    > [!NOTE]
    > **Субъект-служба** — это лучшая методика для большинства приложений, подключающихся к службам мультимедиа Azure. 

В этом руководстве описано следующее:

> [!div class="checklist"]
> * Получение сведений об аутентификации с портала Azure
> * Получение токена доступа с помощью Postman
> * Проверка API **ресурсов** с помощью токена доступа


> [!IMPORTANT]
> Службы мультимедиа в настоящее время поддерживают модель аутентификации с помощью службы контроля доступа Azure. Тем не менее авторизация посредством службы контроля доступа будет объявлена устаревшей 1 июня 2018 года. Мы рекомендуем как можно быстрее перейти на использование модели аутентификации Azure AD.

## <a name="prerequisites"></a>Предварительные требования

- Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись](https://azure.microsoft.com/free/?ref=microsoft.com&utm_source=microsoft.com&utm_medium=docs&utm_campaign=visualstudio), прежде чем начинать работу.
- [Создайте учетную запись служб мультимедиа Azure с помощью портал Azure](media-services-portal-create-account.md).
- Изучите статьею [Доступ к API служб мультимедиа Azure с помощью аутентификации Azure AD](media-services-use-aad-auth-to-access-ams-api.md).
- Установите клиент REST [Postman](https://www.getpostman.com/) для выполнения REST API, как показано в этой статье. 

    В этом руководстве мы используем **Postman**, но подойдет любой инструмент REST. Другие варианты включают: **Visual Studio Code** с подключаемым модулем REST или **Telerik Fiddler**. 

## <a name="get-the-authentication-information-from-the-azure-portal"></a>Получение сведений об аутентификации с портала Azure

### <a name="overview"></a>Обзор

Чтобы получить доступ к API служб мультимедиа, необходимо собрать следующие данные.

|Параметр|Пример|Описание|
|---|-------|-----|
|Домен клиента Azure Active Directory|microsoft.onmicrosoft.com|Azure AD в качестве конечной точки службы токенов безопасности (STS) создается в следующем формате: <https://login.microsoftonline.com/{your-ad-tenant-name.onmicrosoft.com}/oauth2/token>. Azure AD выдает маркер JWT для доступа к ресурсам (маркер доступа).|
|Конечная точка REST API|<https://amshelloworld.restv2.westus.media.azure.net/api/>|Это конечная точка, к которой отправляются все вызовы REST API служб мультимедиа в вашем приложении.|
|Идентификатор клиента (идентификатор приложения)|f7fbbb29-a02d-4d91-bbc6-59a2579259d2|Идентификатор приложения (клиента) Azure AD. Идентификатор клиента необходим для получения токена доступа. |
|Секрет клиента|+mUERiNzVMoJGggD6aV1etzFGa1n6KeSlLjIq+Dbim0=|Ключи приложений Azure AD (секрет клиента). Секрет клиента необходим для получения токена доступа.|

### <a name="get-azure-active-directory-auth-info-from-the-azure-portal"></a>Получение сведений о проверке подлинности Azure Active Directory из портал Azure

Чтобы получить сведения, сделайте следующее:

1. Войдите на [портал Azure](https://portal.azure.com).
2. Перейдите к экземпляру службы мультимедиа Azure.
3. Выберите **доступ через API**.
4. Щелкните **Подключение к API служб мультимедиа Azure с помощью субъекта-службы**.

    ![Снимок экрана, в котором в меню "службы мультимедиа" выбран пункт "доступ к P I", а в правой области — "подключение к службам мультимедиа Azure A P I с субъектом-службой".](./media/connect-with-rest/connect-with-rest01.png)

5. Выберите имеющееся **приложение Azure AD** или создайте новое (как показано ниже).

    > [!NOTE]
    > Чтобы запрос REST служб мультимедиа Azure был успешно выполнен, у вызывающего пользователя должна быть роль **участника** или **владельца** для учетной записи служб мультимедиа, к которой он пытается получить доступ. Если вы получите сообщение The remote server returned an error: (401) Unauthorized (Удаленный сервер вернул ошибку: не авторизовано (401)), см. раздел [Управление доступом](media-services-use-aad-auth-to-access-ams-api.md#access-control).

    Если необходимо создать новое приложение Azure AD, выполните следующее.
    
   1. Нажмите кнопку **Создать**.
   2. Введите имя.
   3. Нажмите кнопку **Создать** еще раз.
   4. Нажмите кнопку **Save**(Сохранить).

      ![Снимок экрана, на котором показано диалоговое окно "Создание нового" с выделенным текстовым полем "создать приложение" и выбранная кнопка "Сохранить".](./media/connect-with-rest/new-app.png)

      Новое приложение отображается на странице.

6. Получите **идентификатор клиента** (приложения).
    
   1. Выберите приложение.
   2. В окне справа находится **идентификатор клиента**. 

      ![Снимок экрана, показывающий, что выбран пункт "приложение Azure A D" и "Управление приложением", и "клиент I D", выделенный в правой области.](./media/connect-with-rest/existing-client-id.png)

7. Получите **ключ** приложения (секрет клиента). 

   1. Нажмите кнопку **Управление приложением** (обратите внимание, что сведения об идентификаторе клиента находятся над **идентификатором приложения**). 
   2. Щелкните **Ключи**.
    
       ![Снимок экрана, на котором отображается выбранная кнопка "Управление приложением", "приложение I D" в центральной области, выделенное, и "ключи" на правой панели.](./media/connect-with-rest/manage-app.png)
   3. Создайте ключ приложения (секрет клиента), заполнив поля **описания** и **срока действия** и нажав кнопку **Сохранить**.
    
       После **этого** отобразится значение ключа. Скопируйте его, прежде чем выйти из колонки.

   ![Доступ через API](./media/connect-with-rest/connect-with-rest03.png)

Вы можете добавить значения параметров подключения AD в файл web.config или app.config для дальнейшего использования в коде.

> [!IMPORTANT]
> **Ключ клиента** является важным секретом и должен быть защищен надлежащим образом в хранилище ключей или зашифрован в рабочей среде.

## <a name="get-the-access-token-using-postman"></a>Получение токена доступа с помощью Postman

В этом разделе показано, как использовать **Postman** для выполнения REST API, который возвращает токен носителя JWT (токен доступа). Чтобы вызвать любой REST API служб мультимедиа, необходимо добавить заголовок Authorization к вызовам, а к каждому вызову — значение Bearer *токен_доступа* (как показано в следующем разделе этого руководства). 

1. Откройте **POST**.
2. Выберите **POST**.
3. Введите URL-адрес, содержащий имя клиента, в следующем формате: имя клиента должно заканчиваться на **.onmicrosoft.com**, а URL-адрес — на **oauth2/token**. 

    `https://login.microsoftonline.com/{your-aad-tenant-name.onmicrosoft.com}/oauth2/token`

4. Выберите вкладку **Headers** (Заголовки).
5. Введите данные **заголовков**, используя сетку данных "ключ — значение". 

    ![Снимок экрана, на котором показана вкладка "заголовки" и выбрано действие "Групповое изменение".](./media/connect-with-rest/headers-data-grid.png)

    Кроме того, можно щелкнуть ссылку **Массовое изменение** в окне Postman справа и вставить следующий код.

    ```javascript
    Content-Type:application/x-www-form-urlencoded
    Keep-Alive:true
    ```

6. Перейдите на вкладку **Body** (Текст).
7. Введите сведения с помощью сетки данных "ключ— значение" (замените значения идентификатора и секрета клиента). 

    ![Сетка данных](./media/connect-with-rest/data-grid.png)

    Кроме того, можно нажать **Bulk Edit** (Массовое изменение) в окне Postman справа и вставить следующий текст (замените значения идентификатора и секрета клиента):

    ```javascript
    grant_type:client_credentials
    client_id:{Your Client ID that you got from your Azure AD Application}
    client_secret:{Your client secret that you got from your Azure AD Application's Keys}
    resource:https://rest.media.azure.net
    ```

8. Нажмите кнопку **Отправить**.

    ![Снимок экрана, на котором показаны текстовые поля "Post", "Headers" и "Body", а также выделен "access_token" и обнаружена кнопка "Отправить".](./media/connect-with-rest/connect-with-rest04.png)

Возвращенный ответ содержит **токен доступа**, который необходим для доступа к любым API AMS.

## <a name="test-the-assets-api-using-the-access-token"></a>Проверка API **ресурсов** с помощью токена доступа

В этом разделе показано, как получить доступ к API **ресурсов** с помощью **Postman**.

1. Откройте **POST**.
2. Выберите **получить**.
3. Вставьте конечную точку REST API (например, https://amshelloworld.restv2.westus.media.azure.net/api/Assets)
4. Перейдите на вкладку **Authorization** (Авторизация). 
5. Выберите **Bearer Token** (Токен носителя).
6. Вставьте токен, который был создан в предыдущем разделе.

    ![получение токена](./media/connect-with-rest/connect-with-rest05.png)

    > [!NOTE]
    > Версия пользовательского интерфейса Postman для Mac и ПК может быть разной. Если в версии Mac в раскрывающемся списке раздела **Authentication** (Аутентификация) отсутствует параметр Bearer Token (Токен носителя), необходимо вручную добавить заголовок **Authorization** на клиенте Mac.

   ![Заголовок аутентификации](./media/connect-with-rest/auth-header.png)

7. Выберите **Headers** (Заголовки).
5. В окне Postman справа щелкните ссылку **Bulk Edit** (Массовое изменение).
6. Вставьте следующие заголовки.

    ```javascript
    x-ms-version:2.19
    Accept:application/json
    Content-Type:application/json
    DataServiceVersion:3.0
    MaxDataServiceVersion:3.0
    ```

7. Нажмите кнопку **Отправить**.

Возвращенный ответ содержит ресурсы, которые находятся в вашей учетной записи.

## <a name="next-steps"></a>Дальнейшие действия

* Пример кода доступен в разделе [Azure AD Authentication for Azure Media Services Access: Both via REST API](https://github.com/willzhan/WAMSRESTSoln) (Аутентификация Azure AD для доступа к службам мультимедиа Azure с помощью REST API)
* [Передача файлов в учетную запись служб мультимедиа с помощью .NET](media-services-dotnet-upload-files.md)
