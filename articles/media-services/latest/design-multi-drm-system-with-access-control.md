---
title: Система защиты содержимого с несколькими DRM
description: В этой статье приводится подробное описание того, как спроектировать систему защиты содержимого с несколькими цифровыми правами с помощью служб мультимедиа Azure.
services: media-services
documentationcenter: ''
author: willzhan
manager: steveng
editor: ''
ms.service: media-services
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: conceptual
ms.date: 08/31/2020
ms.author: willzhan
ms.custom: seodec18
ms.openlocfilehash: e0104dd2761f74fbd84486aebbf8c3c4e128eb08
ms.sourcegitcommit: 4e70fd4028ff44a676f698229cb6a3d555439014
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/28/2021
ms.locfileid: "98954907"
---
# <a name="design-of-a-multi-drm-content-protection-system-with-access-control"></a>Проектирование системы для защиты содержимого с несколькими подсистемами DRM и управлением доступом

[!INCLUDE [media services api v3 logo](./includes/v3-hr.md)]

Проектирование и создание подсистемы управления цифровыми правами (DRM) для OTT или веб-решений для потоковой передачи — непростая задача. Общепринятой практикой операторов и поставщиков веб-видео является передача этой задачи на реализацию специализированным поставщикам служб DRM. Цель данного документа — предоставить справочную структуру и реализацию готовой подсистемы DRM в OTT или веб-решении для потоковой передачи.

Этот документ предназначен для инженеров, работающих в подсистеме DRM OTT или с веб-решениями для потоковой передачи или с несколькими экранами, а также для всех читателей, заинтересованных в подсистеме DRM. Предполагается, что читатели знакомы по крайней мере с одной из технологий DRM на рынке, например PlayReady, Widevine, FairPlay или Adobe Access.

В этой статье под несколькими подсистемами DRM мы подразумеваем 3 DRM, поддерживаемые Службами мультимедиа Azure: Common Encryption (CENC) для PlayReady и Widevine, FairPlay, а также шифрование с помощью незащищенного ключа AES-128. Основной тенденцией в отрасли интерактивной потоковой передачи и OTT является использование собственных DRM на различных клиентских платформах. Это переход от предыдущей тенденции использования единого DRM и клиентского пакета SDK для различных клиентских платформ. При использовании CENC с несколькими собственными DRM и PlayReady, и Widevine шифруются посредством спецификации [стандартного шифрования (ISO/IEC 23001-7 CENC)](https://www.iso.org/iso/home/store/catalogue_ics/catalogue_detail_ics.htm?csnumber=65271/).

Преимущества использования нескольких собственных подсистем DRM для защиты содержимого заключаются в следующем:

* Снижается стоимость шифрования, так как используется единая обработка шифрования для разных платформ с собственными DRM.
* Снижаются расходы на управление ресурсами, так как в хранилище требуется только одна копия ресурса.
* Исключаются расходы на лицензирование клиента DRM, так как собственный клиент DRM обычно предоставляется бесплатно на собственной платформе.

### <a name="goals-of-the-article"></a>Цели статьи

Цели этой статьи:

* предоставить справочную структуру подсистемы DRM, которая использует все 3 DRM (CENC для DASH, FairPlay для HLS и PlayReady для потоковой передачи Smooth Streaming);
* предоставить справочную реализацию на платформе Azure или Служб мультимедиа Azure;
* Рассмотреть некоторые вопросы проектирования и реализации.

В следующей таблице представлена поддержка собственной подсистемы DRM на различных платформах и поддержка EME в различных браузерах.

| **Платформа клиента** | **Собственная подсистема DRM** | **EME** |
| --- | --- | --- |
| **Смарт-ТВ, STB** | PlayReady, Widevine и др. | Встроенный браузер и EME для PlayReady и/или Widevine|
| **Windows 10** | PlayReady | Microsoft Edge и IE 11 для PlayReady|
| **Устройства Android (телефоны, планшеты, телевизоры)** |Widevine |Chrome для Widevine |
| **iOS** | FairPlay | Safari для FairPlay (начиная с iOS версии 11.2) |
| **macOS** | FairPlay | Safari для FairPlay (начиная с Safari 9+ на Mac OS X 10.11+ El Capitan)|
| **tvOS** | FairPlay | |

С учетом текущего состояния развертывания для каждого DRM службе обычно требуется реализовать 2 или 3 DRM, чтобы вы могли максимально эффективно использовать все типы конечных точек.

Существует компромиссное решение, позволяющее справиться со сложностями логики службы и сложностями на стороне клиента по достижению определенного уровня работы пользователей на различных клиентах.

Делая выбор, необходимо иметь в виду следующее:

* Технология PlayReady изначально реализована на всех устройствах Windows, на некоторых устройствах Android и доступна в пакетах SDK программ практически на любой платформе.
* Widevine изначально реализована на каждом устройстве Android, Chrome и некоторых других устройствах. Widevine также поддерживается в браузерах Firefox и Opera через DASH.
* Технология FairPlay доступна на iOS, macOS и tvOS.


## <a name="a-reference-design"></a>Справочное проектирование
В этом разделе мы представим справочную структуру, не зависящую от технологий, используемых для ее реализации.

Подсистема DRM может содержать следующие компоненты:

* Управление ключами
* упаковка с шифрованием DRM;
* Доставка лицензий DRM
* проверка прав и управление доступом;
* проверка подлинности и авторизация пользователей;
* приложение Player;
* Исходная сеть доставки содержимого (CDN).

На следующей схеме представлено взаимодействие высокого уровня между компонентами в подсистеме DRM:

![Подсистема DRM с CENC](./media/design-multi-drm-system-with-access-control/media-services-generic-drm-subsystem-with-cenc.png)

Структура состоит из трех основных уровней:

* Уровень операционного отдела организации (черный), который не предоставляется внешним объектам.
* Уровень сети периметра (темно-синий) содержит все общедоступные конечные точки.
* Уровень общедоступного Интернета (светло-синий), содержащий CDN и проигрыватели с трафиком через общедоступный Интернет.

Кроме того, должно быть внедрено средство управления содержимым для контроля защиты DRM независимо от используемого шифрования (статического или динамического). Входные данные для шифрования DRM должны включать:

* видеосодержимое MBR;
* Ключ содержимого
* URL-адреса для приобретения лицензии;

Во время воспроизведения поток верхнего уровня включает:

* Проверку подлинности пользователя.
* Создание маркера авторизации пользователя.
* Загрузку защищенного DRM содержимого (манифест) в проигрыватель.
* Отправку проигрывателем запроса на приобретение лицензий на серверы лицензий вместе с идентификатором ключа и маркером авторизации.

В следующем разделе описываются структуры управления ключами.

| **Отношение ContentKey к ресурсу** | **Сценарий** |
| --- | --- |
| "Один к одному" |Простейший случай. Он предоставляет самый лучший контроль. Однако обычно этот договор приводит к наибольшей стоимости доставки лицензий. Для каждого защищенного ресурса требуется минимум один запрос лицензии. |
| "Один ко многим" |Можно использовать тот же ключ содержимого для нескольких ресурсов. Например, для всех ресурсов в логической группе, такой как жанр или подмножество жанров (или жанр фильма), можно использовать один ключ содержимого. |
| "Многие к одному" |Несколько ключей содержимого необходимы для каждого ресурса. <br/><br/>Например, если необходимо применить динамическую защиту CENC с несколькими DRM для MPEG-DASH и динамическое шифрование AES-128 для HLS, требуется два отдельных ключа содержимого. Каждый из ключей имеет свой собственный ContentKeyType. (Для ключа содержимого, используемого для динамической защиты CENC, следует применять ContentKeyType.CommonEncryption. Для ключа содержимого, применяемого для динамического шифрования AES-128, используйте ContentKeyType.EnvelopeEncryption).<br/><br/>Другой пример: в защите CENC содержимого DASH теоретически можно использовать один ключ содержимого для защиты видеопотока и другой ключ содержимого для защиты аудиопотока. |
| "Много ко многим" |Сочетание описанных выше сценариев. Один набор ключей содержимого используется для каждого из нескольких ресурсов в одной группе ресурсов. |

Другим важным вопросом является использование постоянных и временных лицензий.

Почему эти вопросы важны?

Они имеют непосредственное влияние на стоимость доставки лицензий при использовании общедоступного облака для доставки постоянных и временных лицензий. Рассмотрим следующие два случая разных структур для иллюстрации:

* Ежемесячная подписка: используйте постоянную лицензию и 1 ключ содержимого для нескольких ресурсов. Например, для всех детских фильмов мы используем один ключ содержимого для шифрования. В данном случае:

    Общее число лицензий, запрашиваемых для всех детских фильмов или устройств, = 1

* Ежемесячная подписка: используйте временную лицензию и 1 ключ содержимого для 1 ресурса. В данном случае:

    Общее число лицензий, запрашиваемых для всех детских фильмов или устройств, = [число просмотренных фильмов] x [число сеансов]

Два различных варианта дают очень разные шаблоны запросов лицензий. Следовательно, и затраты на доставку лицензий, осуществляемую через общедоступное облако, например через Службы мультимедиа.

## <a name="map-design-to-technology-for-implementation"></a>Сопоставление структуры и технологии для реализации
Далее мы сопоставим универсальную структуру и технологии на платформе Azure и Служб мультимедиа Azure, указав, какую технологию использовать для каждого стандартного блока.

Сопоставление показано в следующей таблице.

| **Стандартный блок** | **Технология** |
| --- | --- |
| **Игрок** |[Проигрыватель мультимедиа Azure](https://azure.microsoft.com/services/media-services/media-player/) |
| **Поставщик удостоверений (IDP)** |Azure Active Directory (Azure AD) |
| **Служба маркеров безопасности (STS)** |Azure AD |
| **Рабочий процесс защиты DRM** |Динамическая защита служб мультимедиа Azure |
| **Доставка лицензий DRM** |* Доставка лицензий Служб мультимедиа (PlayReady, Widevine, FairPlay) <br/>* Сервер лицензирования Axinom <br/>* Пользовательский сервер лицензирования PlayReady |
| **Исходный домен** |Конечная точка потоковой передачи Служб мультимедиа Azure |
| **Управление ключами** |Не требуется для справочной реализации |
| **Управление содержимым** |Консольное приложение C# |

Другими словами, в Azure AD предоставлены поставщик удостоверений и служба маркеров безопасности. Для проигрывателя используется [API Проигрывателя мультимедиа Azure](https://amp.azure.net/libs/amp/latest/docs/). Как Службы мультимедиа Azure, так и Проигрыватель мультимедиа Azure поддерживают CENC через DASH, FairPlay через HLS, PlayReady через потоковую передачу Smooth Streaming, а также шифрование AES-128 для DASH, HLS и потоковой передачи.

Следующая схема показывает общую структуру и поток с описанным выше сопоставлением технологии:

![CENC в Службах мультимедиа](./media/design-multi-drm-system-with-access-control/media-services-cenc-subsystem-on-AMS-platform.png)

Чтобы настроить защиту содержимого с DRM, средство управления содержимым будет использовать следующие входные данные:

* открытое содержимое;
* ключ содержимого из раздела управления ключом;
* URL-адреса для приобретения лицензии;
* список сведений от Azure AD, таких как аудитория, издатель и утверждения токена.

Выходные данные средства управления содержимым будут выглядеть так:

* ContentKeyPolicy описывает шаблон лицензии DRM для каждого используемого типа DRM;
* ContentKeyPolicyRestriction описывает управление доступом до выдачи лицензии DRM;
* Streamingpolicy описывает различные комбинации DRM, режима шифрования, протокола потоковой передачи, формата контейнера для потоковой передачи;
* StreamingLocator описывает ключ содержимого/IV, используемый для шифрования, и URL-адреса потоковой передачи. 

Ниже приведен процесс выполнения:

* После проверки подлинности пользователя создается маркер JWT.
* Одно из утверждений, содержащихся в маркере JWT, является утверждением группы и содержит идентификатор объекта группы EntitledUserGroup. Это утверждение используется для проверки прав.
* Проигрыватель загружает клиентский манифест содержимого, защищенного с помощью CENC, и определяет следующее:
   * идентификатор ключа;
   * содержимое защищено DRM;
   * URL-адреса для приобретения лицензии.
* Проигрыватель делает запрос на приобретение лицензий на основании поддерживаемого браузера и DRM. Идентификатор ключа и маркер JWT также отправляются в запросе на приобретение лицензии. Перед выдачей необходимых лицензий служба доставки лицензий проверяет маркер JWT и содержащиеся утверждения.

## <a name="implementation"></a>Реализация
### <a name="implementation-procedures"></a>Процедуры реализации
Реализация включает в себя следующие шаги:

1. Подготовка тестовых ресурсов. Кодирование или упаковка тестового видео в формат MP4 с разными скоростями в службах мультимедиа. Этот ресурс *не* защищен DRM. Защита DRM будет реализована позже с помощью динамической защиты.

2. Создание идентификатора ключа и ключа содержимого (при необходимости из начального значения). В этом случае система управления ключами не требуется, так как мы имеем дело только с одним набором идентификатора ключа и ключа содержимого для нескольких тестовых ресурсов.

3. Использование API Служб мультимедиа для настройки службы доставки лицензий с несколькими DRM для тестовых ресурсов. Если ваша компания или поставщик компании использует пользовательские серверы лицензий вместо служб лицензирования в Службах мультимедиа, можно пропустить этот шаг. URL-адреса приобретения лицензий можно указать на этапе настройки доставки лицензий. API Служб мультимедиа необходим, чтобы указать подробные конфигурации, например ограничения политики авторизации, шаблоны ответов лицензий для различных лицензионных служб DRM. В настоящее время портал Azure пока не предоставляет необходимый пользовательский интерфейс для этой конфигурации. Дополнительные сведения об уровне API и пример кода см. в статье [Использование общего динамического шифрования PlayReady и (или) Widevine DRM](protect-with-drm.md).

4. Использование API Служб мультимедиа для настройки политики доставки ресурсов для тестовых ресурсов. Дополнительные сведения об уровне API и пример кода см. в статье [Использование общего динамического шифрования PlayReady и (или) Widevine DRM](protect-with-drm.md).

5. Создание и настройка клиента Azure AD в Azure.

6. Создание нескольких учетных записей пользователей и групп в клиенте Azure AD. Создайте по крайней мере группу "Пользователи с правами" и добавьте в нее пользователя. Пользователи этой группы проходят проверку прав на получение лицензии. Пользователи, не входящие в эту группу, не могут пройти проверку подлинности и получить лицензию. Членство в группе "Пользователи с правами" является обязательным утверждением группы в маркере JWT, выданном Azure AD. Это требование утверждения должно быть указано при настройке служб доставки лицензий с несколькими DRM.

7. Создание приложения ASP.NET MVC для размещения вашего видеопроигрывателя. Это приложение ASP.NET будет защищено с помощью проверки подлинности пользователей в клиенте Azure Active Directory. Соответствующие утверждения будут включены в маркеры доступа, получаемые после проверки подлинности пользователя. На этом шаге рекомендуется использовать API OpenID Connect. Установите следующие пакеты NuGet:

   * Install-Package Microsoft.Azure.ActiveDirectory.GraphClient
   * Install-Package Microsoft.Owin.Security.OpenIdConnect
   * Install-Package Microsoft.Owin.Security.Cookies
   * Install-Package Microsoft.Owin.Host.SystemWeb
   * Install-Package Microsoft.IdentityModel.Clients.ActiveDirectory

8. Создание проигрывателя с помощью [API Проигрывателя мультимедиа Azure](https://amp.azure.net/libs/amp/latest/docs/). [API ProtectionInfo Проигрывателя мультимедиа Azure](https://amp.azure.net/libs/amp/latest/docs/) позволяет указать, какие технологии DRM следует использовать на разных платформах DRM.

9. Сопоставление показано в тестовой матрице.

    | **DRM** | **Браузер** | **Результат для соответствующего пользователя** | **Результат для не соответствующего пользователя** |
    | --- | --- | --- | --- |
    | **PlayReady** |Microsoft Edge или Internet Explorer 11 в Windows 10 |Успешно |Ошибка |
    | **Widevine** |Chrome, Firefox, Opera |Успешно |Ошибка |
    | **FairPlay** |Safari в macOS      |Успешно |Ошибка |
    | **AES-128** |Большинство современных браузеров  |Успешно |Ошибка |

Дополнительные сведения о настройке Azure AD для приложения проигрывателя ASP.NET MVC см. в статье [Integrate Azure Media Services OWIN MVC based app with Azure Active Directory and restrict content key delivery based on JWT claims](http://gtrifonov.com/2015/01/24/mvc-owin-azure-media-services-ad-integration/) (Интеграция приложения на основе OWIN MVC Служб мультимедиа Azure с Azure Active Directory и ограничение доставки ключей содержимого на основе утверждений JWT).

Дополнительные сведения см. в статьях [Проверка подлинности маркеров JWT в службах мультимедиа Azure и динамическое шифрование](http://gtrifonov.com/2015/01/03/jwt-token-authentication-in-azure-media-services-and-dynamic-encryption/).  

Сведения об Azure AD:

* Сведения для разработчиков см. в [руководстве разработчика по Azure Active Directory](../../active-directory/develop/v2-overview.md).
* Сведения для администраторов см. в статье [Управление каталогом Azure AD](../../active-directory/fundamentals/active-directory-whatis.md).

### <a name="some-issues-in-implementation"></a>Некоторые проблемы в реализации

Используйте следующие сведения по устранению неполадок при реализации.

* URL-адрес издателя должен заканчиваться символом "/". Значением параметра audience должен быть идентификатор клиента приложения проигрывателя. Кроме того, добавьте символ "/" в конце URL-адреса издателя.

    ```xml
    <add key="ida:audience" value="[Application Client ID GUID]" />
    <add key="ida:issuer" value="https://sts.windows.net/[AAD Tenant ID]/" />
    ```

    В [декодере JWT](http://jwt.calebb.net/) должны быть **aud** и **iss**, как показано ниже в маркере JWT:

    ![JWT](./media/design-multi-drm-system-with-access-control/media-services-1st-gotcha.png)

* Добавьте разрешения для приложения в AAD (на вкладке **Настройка** приложения). Разрешения необходимы для каждого приложения (локальной и развернутой версий).

    ![Разрешения](./media/design-multi-drm-system-with-access-control/media-services-perms-to-other-apps.png)

* Используйте правильного издателя при настройке динамической защиты CENC.

    ```xml
    <add key="ida:issuer" value="https://sts.windows.net/[AAD Tenant ID]/"/>
    ```

    Следующий пример не сработает:

    ```xml
    <add key="ida:issuer" value="https://willzhanad.onmicrosoft.com/" />
    ```

    Идентификатор GUID — идентификатор клиента AAD. Идентификатор GUID можно найти во всплывающем меню **Конечные точки** на портале Azure.

* Предоставление привилегий утверждения членства в группе. Убедитесь, что в файле манифеста приложения AAD содержится следующее: 

    "groupMembershipClaims": "All", (значение по умолчанию: null)

* Установите правильный TokenType при создании требований к ограничениям.

    `objTokenRestrictionTemplate.TokenType = TokenType.JWT;`

    После добавления поддержки для JWT (AAD) в дополнение к SWT (ACS) значение по умолчанию TokenType — TokenType.JWT. Если вы используете SWT и ACS, необходимо задать значение маркера TokenType.SWT.

## <a name="the-completed-system-and-test"></a>Завершенная система и тестирование

В этом разделе мы рассмотрим несколько сценариев в завершенной комплексной системе, чтобы читатели получили базовое представление о поведении до получения учетной записи для входа:

* Если необходим неинтегрированный сценарий:

    * Видеоматериалы, размещенные в Службах мультимедиа либо не защищены, либо защищены DRM, но без проверки подлинности маркера (лицензия выдается тому, кто ее запрашивает). Вы можете проверить его без входа в систему. Переключитесь на использование HTTP, если ваше потоковое видео передается по протоколу HTTP.

* Если необходим полностью интегрированный сценарий:

    * При использовании видеоматериалов, на которые распространяется динамическая защита DRM в Службах мультимедиа с проверкой подлинности маркера и маркером JWT, создаваемым в Azure AD, необходимо войти в систему.

Дополнительные сведения о веб-приложении проигрывателя и его входе в систему см. на [этом веб-сайте](https://openidconnectweb.azurewebsites.net/).

### <a name="user-sign-in"></a>Вход пользователя
Чтобы протестировать полностью интегрированную систему DRM, необходимо создать или добавить учетную запись.

Какую учетную запись?

Хотя изначально система Azure разрешала доступ только пользователям учетных записей Майкрософт, теперь она позволяет получать доступ пользователям обеих систем. Теперь все свойства Azure стали доверять процессу проверки подлинности Azure AD, чтобы Azure AD выполняла проверку подлинности пользователей организации. Кроме того, были созданы федеративные отношения, при которых Azure AD доверяет системе идентификации Майкрософт выполнять проверку подлинности пользователей-клиентов. В результате Azure AD может проверять подлинность "гостевых" учетных записей Майкрософт, а также собственных учетных записей Azure AD.

Так как Azure AD доверяет домену учетных записей Майкрософт, можно добавить любые учетные записи из любого из следующих доменов в пользовательский клиент Azure AD и использовать учетную запись для входа:

| **Доменное имя** | **Доменная** |
| --- | --- |
| **Домен пользовательского клиента Azure AD** |somename.onmicrosoft.com |
| **Домен организации** |microsoft.com |
| **Домен учетных записей Майкрософт** |outlook.com, live.com, hotmail.com |

Вы можете связаться с любым автором, чтобы получить созданную или добавленную учетную запись.

Ниже приведены снимки экранов различных страниц входа, используемых разными учетными записями домена:

**Учетная запись домена пользовательского клиента Azure AD**: в этом случае вы видите настраиваемую страницу входа домена пользовательского клиента Azure AD.

![Учетная запись домена пользовательского клиента Azure AD (один)](./media/design-multi-drm-system-with-access-control/media-services-ad-tenant-domain1.png)

**Учетная запись домена Майкрософт со смарт-картой**: в этом случае вы видите страницу входа, настроенную ИТ-специалистами корпорации Майкрософт, с двухфакторной проверкой подлинности.

![Учетная запись домена пользовательского клиента Azure AD (два)](./media/design-multi-drm-system-with-access-control/media-services-ad-tenant-domain2.png)

**Учетная запись Майкрософт**: в этом случае вы видите страницу входа учетной записи Майкрософт для потребителей.

![Учетная запись домена пользовательского клиента Azure AD (три)](./media/design-multi-drm-system-with-access-control/media-services-ad-tenant-domain3.png)

### <a name="use-encrypted-media-extensions-for-playready"></a>Использование расширений зашифрованных носителей для PlayReady

В современных браузерах с поддержкой расширений зашифрованных носителей (EME) или PlayReady, таких как Internet Explorer 11 в Windows 8.1 и выше и Microsoft Edge в Windows 10, PlayReady является базовым решением DRM для EME.

![Использование EME для PlayReady](./media/design-multi-drm-system-with-access-control/media-services-eme-for-playready1.png)

Темная область проигрывателя возникает из-за того, что защита PlayReady не позволяет сделать снимок экрана защищенного видео.

На следующем снимке экрана показаны подключаемые модули проигрывателя, а также поддержка Microsoft Security Essentials и EME:

![Подключаемые модули проигрывателя для PlayReady](./media/design-multi-drm-system-with-access-control/media-services-eme-for-playready2.png)

EME в Microsoft Edge и Internet Explorer 11 в Windows 10 позволяет вызывать [PlayReady SL3000](https://www.microsoft.com/playready/features/EnhancedContentProtection.aspx/) на поддерживающих устройствах Windows 10. PlayReady SL3000 разблокирует поток улучшенного содержимого премиум-класса (4K, HDR) и новые модели доставки содержимого (для улучшенного содержимого).

Если брать во внимание устройства Windows, PlayReady является единственной технологией DRM в оборудовании, доступной на устройствах Windows (PlayReady SL3000). Служба потоковой передачи может использовать PlayReady через EME или приложение универсальной платформы Windows. Благодаря PlayReady SL3000 она предлагает более высокое качество видеоизображения, чем другие DRM. Как правило, содержимое 2K будет передаваться через Chrome или Firefox, а содержимое 4K — через Microsoft Edge и Internet Explorer 11 или приложение универсальной платформы Windows на том же устройстве. Объем зависит от реализации и параметров службы.

#### <a name="use-eme-for-widevine"></a>Использование EME для Widevine

В современных браузерах с поддержкой EME и Widevine, таких как Chrome 41+ в Windows 10, Windows 8.1, Mac OSX Yosemite и Chrome в Android 4.4.4, Google Widevine является DRM в основе EME.

![Использование EME для Widevine](./media/design-multi-drm-system-with-access-control/media-services-eme-for-widevine1.png)

Widevine не запрещает делать снимок экрана защищенного видео.

![Подключаемые модули проигрывателя для Widevine](./media/design-multi-drm-system-with-access-control/media-services-eme-for-widevine2.png)

#### <a name="use-eme-for-fairplay"></a>Использование EME для FairPlay

Аналогичным образом, вы можете проверить защищенное содержимое FairPlay в этом тестовом проигрывателе в Safari на macOS или iOS 11.2 и более поздних версиях.

Убедитесь, что вы указали FairPlay в качестве параметра protectionInfo.type и ввели правильный URL-адрес для своего сертификата приложения в пути FPS AC (путь к сертификату потокового приложения FairPlay).

### <a name="unentitled-users"></a>Пользователи, не имеющие прав

Если пользователь не является участником группы "Пользователи с правами", то он не сможет пройти проверку прав. Служба лицензий с несколькими DRM откажется выдать запрашиваемую лицензию, как показано ниже. Подробное описание звучит "Не удалось получить лицензию", как это и было задумано.

![Пользователи, не имеющие прав](./media/design-multi-drm-system-with-access-control/media-services-unentitledusers.png)

### <a name="run-a-custom-security-token-service"></a>Запуск пользовательской службы маркеров безопасности

При запуске пользовательской STS маркер JWT выдается пользовательской службой маркеров безопасности с помощью симметричного или асимметричного ключа.

На следующем снимке экрана показан сценарий использования симметричного ключа (в Chrome):

![Пользовательская STS с симметричным ключом](./media/design-multi-drm-system-with-access-control/media-services-running-sts1.png)

На следующем снимке экрана показан сценарий использования асимметричного ключа через сертификат X509 (в современных браузерах Майкрософт):

![Пользовательская STS с асимметричным ключом](./media/design-multi-drm-system-with-access-control/media-services-running-sts2.png)

В обоих указанных случаях проверка подлинности пользователя остается неизменной. Она происходит через Azure AD. Единственное различие состоит в том, что маркеры JWT выдаются пользовательской STS вместо Azure AD. При настройке динамической защиты CENC ограничение службы доставки лицензий указывает тип маркера JWT — симметричный или асимметричный ключи.

## <a name="next-steps"></a>Дальнейшие шаги

* [Часто задаваемые вопросы по Аналитике компьютеров](frequently-asked-questions.md)
* [Обзор системы защиты содержимого](content-protection-overview.md)
* [Использование динамического шифрования DRM и службы доставки лицензий](protect-with-drm.md)
