---
заголовок: Потоковая трансляция в реальном времени с помощью Служб мультимедиа версии 3 : Службы мультимедиа Azure description: Сведения о потоковой трансляции в режиме реального времени с помощью Служб мультимедиа Azure версии 3.
services: media-services documentationcenter: '' author: IngridAtMicrosoft manager: femila editor: ''

ms.service: media-services ms.workload: media ms.tgt_pltfrm: na ms.devlang: na ms.topic: tutorial ms.custom: "mvc, devx-track-csharp" ms.date: 06/13/2019 ms.author: inhenkel

---

# <a name="tutorial-stream-live-with-media-services"></a>Руководство по Потоковая трансляция в реальном времени с помощью Служб мультимедиа

> [!NOTE]
> Несмотря на то, что в этом учебнике используются примеры для [пакета SDK для .NET](/dotnet/api/microsoft.azure.management.media.models.liveevent), общие шаги одинаковы для [REST API](/rest/api/media/liveevents), [CLI](/cli/azure/ams/live-event), или других поддерживаемых [пакетов SDK](media-services-apis-overview.md#sdks). 

В Службах мультимедиа Azure за обработку содержимого потоковой трансляции отвечают компоненты [событий потоковой трансляции](/rest/api/media/liveevents). Событие потоковой трансляции предоставляет входную конечную точку (URL-адрес входа), которую вы можете передать динамическому кодировщику. Событие потоковой трансляции получает от динамического кодировщика входные потоки трансляции и предоставляет их для потоковой передачи через одну или несколько [конечных точек потоковой передачи](/rest/api/media/streamingendpoints). Кроме того, события потоковой трансляции предоставляют конечную точку предварительного просмотра (URL-адрес предварительного просмотра), которая позволяет просмотреть и проверить поток перед его обработкой и доставкой. В этом руководстве описано, как с помощью .NET Core создавать события прямой трансляции **сквозного** типа.

В этом руководстве описаны следующие процедуры.

> [!div class="checklist"]
> * Скачивание примера приложения, описанного в этой статье.
> * Проверка кода, который выполняет потоковую трансляцию.
> * Просмотр событий с помощью [Проигрывателя мультимедиа Azure](https://amp.azure.net/libs/amp/latest/docs/index.html), доступного по ссылке [https://ampdemo.azureedge.net](https://ampdemo.azureedge.net).
> * Очистка ресурсов.

[!INCLUDE [quickstarts-free-trial-note](../../../includes/quickstarts-free-trial-note.md)]

## <a name="prerequisites"></a>Предварительные требования

Ниже перечислены необходимые условия для выполнения действий, описанных в этом руководстве:

- Установите Visual Studio Code или Visual Studio.
- [Создание учетной записи Служб мультимедиа](./create-account-howto.md).<br/>Обязательно скопируйте сведения о доступе к API в формате JSON или сохраните значения, необходимые для подключения к учетной записи Служб мультимедиа, в формате ENV, используемом в этом примере.
- Выполните действия, описанные в статье [Доступ к API Служб мультимедиа Azure с помощью Azure CLI](./access-api-howto.md), и сохраните учетные данные. Их необходимо будет использовать для доступа к API в этом примере. Кроме того, эти учетные данные можно добавить в ENV-файл. 
- Веб-камера или другое устройство (например, ноутбук) для трансляции события.
- Локальный программный кодировщик, который кодирует ваш поток камеры и отправляет его в службу потоковой передачи Служб мультимедиа с помощью протокола RTMP, описывается в статье [Рекомендуемые локальные динамические кодировщики](recommended-on-premises-live-encoders.md). Поток должен иметь формат **RTMP** или **Smooth Streaming**.  
- В этом примере для простоты рекомендуется начать работу с программным кодировщиком, например с бесплатным ПО [Open Broadcast Software OBS Studio](https://obsproject.com/download). 

> [!TIP]
> Прежде чем продолжить работу, ознакомьтесь со статьей [Live streaming with Azure Media Services v3](live-streaming-overview.md) (Потоковая трансляция в Службах мультимедиа Azure v3). 

## <a name="download-and-configure-the-sample"></a>Скачивание и настройка примера

Клонируйте на свой компьютер приведенный ниже репозиторий GitHub, содержащий пример для потоковой передачи данных .NET, с помощью следующей команды:  

 ```bash
 git clone https://github.com/Azure-Samples/media-services-v3-dotnet.git
 ```

Пример потоковой трансляции размещен в папке [Live](https://github.com/Azure-Samples/media-services-v3-dotnet/tree/main/Live).

Откройте файл [appsettings.json](https://github.com/Azure-Samples/media-services-v3-dotnet/blob/main/Live/LiveEventWithDVR/appsettings.json) в скачанном проекте. Замените значения учетными данными, которые вы получили, выполнив действия из руководства по [получению доступа к API](./access-api-howto.md).

Обратите внимание на то, что можно также использовать ENV-файл в корне проекта, чтобы единоразово задать переменные среды для всех проектов в репозитории примеров .NET. Просто скопируйте файл sample.env и добавьте в него сведения, полученные на странице доступа к API Служб мультимедиа на портале Azure или посредством Azure CLI.  Переименуйте файл sample.env в ".env", чтобы использовать его во всех проектах.
GITIGNORE-файл уже настроен, чтобы не публиковать содержимое этого файла в разветвленном репозитории. 

> [!IMPORTANT]
> Этот пример использует уникальный суффикс для каждого ресурса. Если вы отмените отладку или завершите приложение раньше, чем оно закончит свою работу, в вашей учетной записи сохранятся несколько трансляций. <br/>Не забудьте остановить все запущенные события потоковой трансляции. В противном случае за них будет **начислена плата**!

## <a name="examine-the-code-that-performs-live-streaming"></a>Проверка кода, который выполняет потоковую трансляцию

В этом разделе рассматриваются функции, определенные в файле [Program.cs](https://github.com/Azure-Samples/media-services-v3-dotnet/blob/main/Live/LiveEventWithDVR/Program.cs) проекта *LiveEventWithDVR*.

Этот пример создает уникальный суффикс для каждого ресурса, чтобы избежать конфликтов имен при многократном запуске примера без очистки.


### <a name="start-using-media-services-apis-with-net-sdk"></a>Начало использования API Служб мультимедиа с пакетом SDK для .NET

Чтобы начать использование API Служб мультимедиа с .NET, создайте объект **AzureMediaServicesClient**. Чтобы создать объект, введите учетные данные, необходимые клиенту для подключения к Azure с помощью Azure AD. В коде, клонированном в начале этой статьи, функция **GetCredentialsAsync** создает объект ServiceClientCredentials на основе учетных данных, предоставленных в локальном файле конфигурации (appsettings.js) или ENV-файле переменных среды, расположенном в корне репозитория.

[!code-csharp[Main](../../../media-services-v3-dotnet/Live/LiveEventWithDVR/Program.cs#CreateMediaServicesClient)]

### <a name="create-a-live-event"></a>Создание события прямой трансляции

В этом разделе показано, как создать событие потоковой трансляции **сквозного** типа (для которого параметр LiveEventEncodingType имеет значение None). Дополнительные сведения о других доступных типах трансляций см. в разделе [Типы событий потоковой трансляции](live-events-outputs-concept.md#live-event-types). В дополнение к сквозному перекодированию можно использовать трансляцию с динамическим перекодированием для облачного кодирования в формате 720P или 1080P с адаптивной скоростью. 
 
При создании событий прямой трансляции вы также можете настроить следующее:

* Протокол приема данных для трансляции (сейчас поддерживаются протоколы RTMP и Smooth Streaming).<br/>Изменить протокол во время работы события потоковой трансляции или связанных с ним выходных данных потоковой трансляции нельзя. Если вам нужны другие протоколы потоковой трансляции, создайте отдельное событие потоковой трансляции для каждого из них.  
* Ограничения по IP-адресам для приема и предварительного просмотра. Вы можете определить IP-адреса, с которых событие потоковой трансляции будет принимать видео. Можно указать отдельный допустимый IP-адрес (например, 10.0.0.1), или диапазон IP-адресов, используя IP-адрес и маску подсети CIDR (например, 10.0.0.1/22), или IP-адрес и маску подсети с точками (например, 10.0.0.1(255.255.252.0)).<br/>Если IP-адреса не указаны и правила не заданы, ни один IP-адрес не разрешен. Чтобы разрешить все IP-адреса, создайте правило и задайте адрес 0.0.0.0/0.<br/>IP-адреса должны быть представлены в одном из следующих форматов: IpV4-адрес с четырьмя цифрами или диапазон адресов CIDR.
* Для создаваемого события можно настроить автоматический запуск. <br/>Если для автозапуска задано значение true, событие прямой трансляции будет запущено после создания. Это означает, что плата начисляется сразу же после запуска события потоковой трансляции. Чтобы остановить начисление оплаты, нужно явно вызвать функцию Stop (Остановить) для ресурса события потоковой трансляции. Дополнительные сведения см. в статье [Состояния компонента LiveEvent и выставление счетов за его использование](live-event-states-billing.md).
Существуют также режимы ожидания для запуска трансляции в менее затратном состоянии "Выделено", что ускоряет переход в состояние "Работает". Это удобно в таких средах, как горячие пулы, которым необходимо быстро предоставлять каналы стримерам.
* Чтобы принимающий URL-адрес был предсказуемым и удобным в обслуживании в аппаратном динамическом кодировщике, задайте для свойства "useStaticHostname" значение true. Подробные сведения см. в разделе [URL-адреса приема событий трансляции](live-events-outputs-concept.md#live-event-ingest-urls).

[!code-csharp[Main](../../../media-services-v3-dotnet/Live/LiveEventWithDVR/Program.cs#CreateLiveEvent)]

### <a name="get-ingest-urls"></a>Получение URL-адресов приема

После создания события потоковой трансляции можно получить URL-адреса приема, которые необходимо передать динамическому кодировщику. Он использует эти адреса для передачи динамического потока на вход.

[!code-csharp[Main](../../../media-services-v3-dotnet/Live/LiveEventWithDVR/Program.cs#GetIngestURL)]

### <a name="get-the-preview-url"></a>Получение URL-адреса предварительного просмотра

Используйте конечную точку предварительного просмотра, чтобы проверить получение входных данных от кодировщика.

> [!IMPORTANT]
> Прежде чем продолжить, убедитесь, что видео правильно передается на URL-адрес предварительного просмотра.

[!code-csharp[Main](../../../media-services-v3-dotnet/Live/LiveEventWithDVR/Program.cs#GetPreviewURLs)]

### <a name="create-and-manage-live-events-and-live-outputs"></a>Создание событий и выходных данных потоковой трансляции и управление ими

Настроив передачу потока данных в событие потоковой трансляции, можно запустить событие потоковой передачи, создав ресурс, выходные данные потоковой трансляции и указатель потоковой передачи. В результате вы сможете запустить архивирование потока и предложить его зрителям через конечную точку потоковой передачи.

При изучении этих понятий удобно рассматривать объект "ресурс" как кассету, которую раньше вставляли в видеомагнитофон. Выходные данные потоковой трансляции — это сам видеомагнитофон. Трансляция — это просто видеосигнал, поступающий на заднюю панель этого прибора.

Сначала вы создаете сигнал, создав трансляцию.  Сигнал не передастся, пока вы не запустите эту трансляцию и не подключите кодировщик к входным данным.

Кассету можно создать в любой момент. Это просто пустой ресурс, который можно передать в объект выходных данных потоковой трансляции — магнитофон в нашей аналогии.

Магнитофон можно создать в любое время. Это означает, что выходные данные потоковой трансляции можно создать перед запуском потока сигналов или после него. Если необходимо ускорить процесс, иногда бывает удобно создать его перед запуском потока сигналов.

Чтобы остановить магнитофон, вызовите метод Delete для LiveOutput. Это не приведет к удалению содержимого кассеты (ресурса).  Ресурс всегда хранится с архивным видеосодержимым до тех пор, пока не будет явно вызвано удаление самого ресурса.

В следующем разделе будет рассмотрено создание ресурса (кассеты) и выходных данных потоковой трансляции (магнитофона).

#### <a name="create-an-asset"></a>Создание ресурса

Создайте ресурс, который будет использоваться в выходных данных прямой трансляции. В приведенной выше аналогии это будет кассета, на которую записывается потоковый видеосигнал. Зрители смогут просматривать содержимое этой виртуальной кассеты в реальном времени или по запросу.

[!code-csharp[Main](../../../media-services-v3-dotnet/Live/LiveEventWithDVR/Program.cs#CreateAsset)]

#### <a name="create-a-live-output"></a>Создание выходных данных прямой трансляции

Выходные данные потоковой трансляции запускаются при создании и останавливаются при удалении. Они будут "магнитофоном" для нашего события. При удалении выходных данных потоковой трансляции базовый ресурс и его содержимое не удаляются. Представьте, будто вы извлекли кассету из магнитофона. Ресурс с записью будет храниться столько, сколько вам нужно, и когда он будет извлечен (при удалении выходных данных потоковой трансляции), то он будет немедленно доступен для просмотра по запросу. 

[!code-csharp[Main](../../../media-services-v3-dotnet/Live/LiveEventWithDVR/Program.cs#CreateLiveOutput)]

#### <a name="create-a-streaming-locator"></a>Создание указателя потоковой передачи

> [!NOTE]
> При создании учетной записи Служб мультимедиа в нее добавляется конечная точка потоковой передачи **по умолчанию** в состоянии **Остановлена**. Чтобы начать потоковую передачу содержимого и воспользоваться функциями [динамической упаковки](dynamic-packaging-overview.md) и динамического шифрования, конечная точка потоковой передачи, из которой необходимо выполнять потоковую передачу содержимого, должна находиться в состоянии **Выполняется**.

В случае публикации ресурса с указателем потоковой передачи трансляция (до продолжительности окна DVR) будет доступна для просмотра, пока не истечет срок действия указателя потоковой передачи или он не будет удален, в зависимости от того, что произойдет первым. Так вы сделаете запись на виртуальной кассете доступной для зрителей в реальном времени и по запросу. По завершении записи (при удалении выходных данных потоковой трансляции) один и тот же URL-адрес можно будет использовать для просмотра трансляции, окна DVR или ресурса по запросу.

[!code-csharp[Main](../../../media-services-v3-dotnet/Live/LiveEventWithDVR/Program.cs#CreateStreamingLocator)]

```csharp

// Get the url to stream the output
ListPathsResponse paths = await client.StreamingLocators.ListPathsAsync(resourceGroupName, accountName, locatorName);

foreach (StreamingPath path in paths.StreamingPaths)
{
    UriBuilder uriBuilder = new UriBuilder();
    uriBuilder.Scheme = "https";
    uriBuilder.Host = streamingEndpoint.HostName;

    uriBuilder.Path = path.Paths[0];
    // Get the URL from the uriBuilder: uriBuilder.ToString()
}
```

### <a name="cleaning-up-resources-in-your-media-services-account"></a>Очистка ресурсов в учетной записи Служб мультимедиа

После завершения потоковой передачи события вы можете удалить выделенные ранее ресурсы с помощью описанной ниже процедуры.

* Остановите трансляцию потока из кодировщика.
* Остановите событие потоковой трансляции. Плата за остановленное событие потоковой трансляции не взимается. Если вам понадобится снова запустить его, вы можете воспользоваться тем же URL-адресом приема (перенастраивать кодировщик не потребуется).
* Вы можете остановить конечную точку потоковой передачи, если больше не собираетесь предоставлять доступ к архиву мероприятия в качестве потоковой передачи по требованию. Если событие потоковой трансляции находится в остановленном состоянии, плата не взимается.

[!code-csharp[Main](../../../media-services-v3-dotnet/Live/LiveEventWithDVR/Program.cs#CleanupLiveEventAndOutput)]

[!code-csharp[Main](../../../media-services-v3-dotnet/Live/LiveEventWithDVR/Program.cs#CleanupLocatorAssetAndStreamingEndpoint)]

## <a name="watch-the-event"></a>Просмотр события

Чтобы просмотреть событие, скопируйте URL-адрес потоковой передачи, полученный при выполнении кода в разделе "Создание указателя потоковой трансляции". Вы можете использовать проигрыватель мультимедиа по своему усмотрению. [Проигрыватель мультимедиа Azure](https://amp.azure.net/libs/amp/latest/docs/index.html) доступен для проверки потока на https://ampdemo.azureedge.net.

После остановки событие потоковой трансляции автоматически преобразуется в содержимое по требованию. Даже после остановки и удаления события пользователи смогут запрашивать потоковую трансляцию архивированного видеосодержимого, пока не удален соответствующий ресурс. Ресурс невозможно удалить, пока он используется каким-либо событием: сначала нужно удалить это событие.

## <a name="clean-up-resources"></a>Очистка ресурсов

Если вам больше не нужны какие-либо ресурсы в группе ресурсов, включая Службы мультимедиа и учетные записи хранения, созданные для этого руководства, удалите группу ресурсов, созданную ранее.

Выполните следующую команду CLI:

```azurecli-interactive
az group delete --name amsResourceGroup
```

> [!IMPORTANT]
> За запущенное событие потоковой трансляции взимается плата. Учтите также, что при сбое или остановке проекта или программы по любой причине событие потоковой трансляции может остаться в работающем состоянии, за что будет взиматься плата.

## <a name="ask-questions-give-feedback-get-updates"></a>Получение справки, отправка отзывов, получение обновлений

Прочитайте статью [сообщества Служб мультимедиа Azure](media-services-community.md), чтобы узнать, как задавать вопросы, оставлять отзывы и получать новости о Службах мультимедиа.

## <a name="next-steps"></a>Дальнейшие действия

[Потоковая передача файлов](stream-files-tutorial-with-api.md)
 
