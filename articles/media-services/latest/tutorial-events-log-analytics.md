---
заголовок: Хранение событий Служб мультимедиа Azure в Azure Log Analytics Службы мультимедиа Azure description: Узнайте, как хранить события Служб мультимедиа Azure в Azure Log Analytics.
services: media-services documentationcenter: '' author: IngridAtMicrosoft manager: femila editor: '' ms.service: media-services ms.workload: ms.topic: tutorial ms.date: 08/24/2020 ms.author: inhenkel
---

# <a name="tutorial-store-azure-media-services-events-in-azure-log-analytics"></a>Руководство по хранению событий Служб мультимедиа Azure в Azure Log Analytics

## <a name="azure-media-services-events"></a>События Служб мультимедиа Azure

Службы мультимедиа Azure версии 3 создают события в [Сетке событий Azure](media-services-event-schemas.md). Подписываться на события и хранить их в хранилищах данных можно различными способами. В рамках этого учебника вы подпишетесь на события Служб мультимедиа с помощью [потока приложения логики](https://azure.microsoft.com/services/logic-apps/). Приложение логики будет срабатывать при каждом событии и хранить текст события в Azure Log Analytics. Когда события попадают в Log Analytics Azure, вы можете использовать другие службы Azure, чтобы создать панель мониторинга, отслеживать и оповещать об этих событиях, хотя мы не будем рассматривать это в этом учебнике.

> [!NOTE]
> Это полезно, если вы уже знакомы с использованием FFmpeg в качестве локального кодировщика.  В противном случае ничего страшного. Ниже приведены командная строка и инструкции для потоковой передачи видео.

Вы научитесь:

> [!div class="checklist"]
> * создавать поток приложения логики без кода;
> * подписываться на разделы событий Служб мультимедиа Azure;
> * анализировать события и сохранять их в Azure Log Analytics;
> * запрашивать события из Azure Log Analytics.

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

## <a name="prerequisites"></a>Предварительные требования

> * [Подписка Azure](how-to-set-azure-subscription.md)
> * Учетная запись [Служб мультимедиа](create-account-howto.md) и группа ресурсов.
> * Установка [FFmpeg](https://ffmpeg.org/download.html) для вашей ОС.
> * Рабочая область [Log Analytics](../../azure-monitor/learn/quick-create-workspace.md) .

## <a name="subscribe-to-a-media-services-event-with-logic-app"></a>Подписка на событие Служб мультимедиа с помощью приложения логики

1. На портале Azure создайте рабочую область [Log Analytics](../../azure-monitor/learn/quick-create-workspace.md), если это еще не сделано. Вам потребуется идентификатор рабочей области и один из ключей, поэтому не закрывайте окно браузера. Затем откройте портал на другой вкладке или в новом окне.

1. Перейдите к учетной записи Служб мультимедиа Azure и щелкните раздел **События**. Будут показаны все методы подписки на события Служб мультимедиа Azure.
    > [!div class="mx-imgBorder"]
    > ![Портал Служб мультимедиа Azure](media/tutorial-events-log-analytics/select-events-01a.png)

1. Щелкните значок **Приложения логики**, чтобы создать приложение логики. Откроется конструктор приложений логики, в котором можно создать поток для записи событий и отправки их в Log Analytics. 
    > [!div class="mx-imgBorder"]
    > ![Создание приложения логики](media/tutorial-events-log-analytics/select-logic-app-02.png)

1. Щелкните значок **+** , выберите нужный клиент, а затем выберите элемент "Вход". Вы увидите запрос на вход в учетную запись Майкрософт.
    > [!div class="mx-imgBorder"]
    > ![Подключение к службе "Сетка событий Azure"](media/tutorial-events-log-analytics/select-event-add-grid-03.png)
![Выбор клиента](media/tutorial-events-log-analytics/select-tenant-03a.png)

1. Нажмите кнопку **Продолжить**, чтобы подписаться на события Служб мультимедиа.
    > [!div class="mx-imgBorder"]
    > ![Подключение к службе "Сетка событий Azure"](media/tutorial-events-log-analytics/select-continue-04.png)

1. В списке **Тип ресурса** выберите Microsoft.Media.MediaServices.
    > [!div class="mx-imgBorder"]
    >![События ресурсов Служб мультимедиа Azure](media/tutorial-events-log-analytics/locate-azure-media-services-events-05.png)

1. Щелкните **Event Type item** (Элемент типа события). Появится список всех событий, создаваемых Службами мультимедиа Azure. Вы можете выбрать события, которые нужно отслеживать. Вы также можете добавить несколько типов событий. (Позже вы внесете небольшое изменение в поток приложения логики для хранения каждого типа события в отдельном журнале Log Analytics и динамического распространения имени типа события на имя журнала Log Analytics.)
    > [!div class="mx-imgBorder"]
    > ![Тип события Служб мультимедиа Azure](media/tutorial-events-log-analytics/select-azure-media-services-event-type-06.png)

1. Выберите **Сохранить как**.

1. Присвойте приложению логики имя.  Группа ресурсов выбирается по умолчанию. Оставьте другие параметры в том виде, в котором они есть, а затем нажмите кнопку **Создать**.  Вы вернетесь на начальный экран Azure.
    > [!div class="mx-imgBorder"]
    > ![Интерфейс именования приложений логики](media/tutorial-events-log-analytics/give-logic-app-name-06a.png)

## <a name="create-an-action"></a>Создание действия

Теперь, когда вы подписаны на события, создайте действие.

1. Если на портале откроется начальный экран, вернитесь к созданному приложению логики, выполнив поиск по имени приложения в списке "Все ресурсы".

1. Выберите приложение, а затем щелкните элемент **Конструктор приложений логики**. Откроется панель конструктора.

1. Выберите **+ Новый шаг**.

1. Так как вы хотите отправить события в службу Azure Log Analytics, выполните поиск по запросу Azure Log Analytics и выберите действие Azure Log Analytics Data Collector (Сборщик данных Azure Log Analytics).
    > [!div class="mx-imgBorder"]
    > ![Сборщик данных Azure Log Analytics](media/tutorial-events-log-analytics/select-azure-log-analytics-data-collector-07.png)

1. Чтобы подключиться к рабочей области Log Analytics, вам потребуется идентификатор рабочей области и ключ агента. Откройте портал Azure в новой вкладке или окне, перейдите к рабочей области Log Analytics, созданной до начала работы с этим учебником.
    > [!div class="mx-imgBorder"]
    > ![Идентификатор рабочей области Azure Log Analytics](media/tutorial-events-log-analytics/log-analytics-workspace-id-08.png)

1. В меню слева найдите пункт **Agents Management** (Управление агентами) и выберите его. Будут показаны созданные ключи агента.
    > [!div class="mx-imgBorder"]
    > ![Управление агентами Azure Log Analytics](media/tutorial-events-log-analytics/select-agents-management-09.png)

1. Скопируйте значение поля *Идентификатор рабочей области*.
    > [!div class="mx-imgBorder"]
    > ![Копирование идентификатора рабочей области](media/tutorial-events-log-analytics/copy-workspace-id.png)

1. На другой вкладке или в другом окне браузера в разделе Log Analytics Data Collector (Сборщик данных Azure Log Analytics) щелкните вкладку **Отправить данные**, присвойте имя подключению, а затем вставьте *идентификатор рабочей области* в **соответствующее** поле.

1. Вернитесь на вкладку или окно обозревателя рабочей области и скопируйте значение поля *Ключ рабочей области*.
    > [!div class="mx-imgBorder"]
    > ![Первичный ключ управления агентами](media/tutorial-events-log-analytics/agents-management-primary-key-10.png)

1. На другой вкладке или в другом окне браузера вставьте *ключ рабочей области* в **соответствующее** поле.

1. Нажмите кнопку **создания**. Теперь создадим текст запроса JSON и имя пользовательского журнала.

1. Выберите поле **JSON Request body** (Текста запроса JSON).  Откроется ссылка **Добавить динамическое содержимое**.

1. Щелкните ссылку **Добавить динамическое содержимое**, а затем выберите пункт **Раздел**.

1. Сделайте то же самое для пункта **Custom Log Name** (Имя пользовательского журнала).
    > [!div class="mx-imgBorder"]
    > ![Выбранный раздел](media/tutorial-events-log-analytics/topic-selected.png)

1. Выберите раздел **Представление кода** приложения логики. Найдите строки входных данных и типа журнала.
    > [!div class="mx-imgBorder"]
    > ![Представление кода с двумя строками](media/tutorial-events-log-analytics/code-view-two-lines.png)

1. Измените значение параметра `body` с `"@triggerBody()?['topic']"` на `"@{triggerBody()}"`. Это предназначено для синтаксического анализа всего сообщения в Log Analytics.

1. Измените значение параметра `Log-Type` с `"@triggerBody()?['topic']"` на `"@replace(triggerBody()?['eventType'],'.','')"`. (Это заменит символ ".", так как он не разрешен в именах журналов Log Analytics.)
    > [!div class="mx-imgBorder"]
    > ![Приложение логики JSON после изменения](media/tutorial-events-log-analytics/changed-lines.png)

1. Щелкните **Сохранить**.

1. Чтобы проверить, выберите **Конструктор приложений логики**.
    > [!div class="mx-imgBorder"]
    > ![Проверка текста и шагов функций](media/tutorial-events-log-analytics/verify-changes-to-json.png)

1. При просмотре всех ресурсов в группе ресурсов будет указано приложение логики и два соединителя API приложений логики: один для событий и один для Log Analytics. Дополнительные сведения о системных разделах Сетки событий см. в статье [Системные разделы в службе "Сетка событий Azure"](../../event-grid/system-topics.md).
    > [!div class="mx-imgBorder"]
    > ![Все ресурсы в группе ресурсов](media/tutorial-events-log-analytics/contoso-rg-listing.png)

## <a name="test"></a>Тест

Чтобы проверить, как это работает, создайте событие прямой трансляции в Службах мультимедиа Azure. Создайте событие прямой трансляции RTMP и используйте FFmpeg для отправки потока в реальном времени на основе образца файла MP4. После создания события получите URL-адрес приема RTMP.

1. В учетной записи Служб мультимедиа щелкните **Потоковая трансляция**.
    > [!div class="mx-imgBorder"]
    > ![Создание события прямой трансляции Служб мультимедиа Azure](media/tutorial-events-log-analytics/live-event.png)

1. Щелкните элемент **Add live event** (Добавить трансляцию).

1. Введите имя в поле **Имя трансляции**. Поле **Description** (Описание) заполнять необязательно.

1. Для параметра "Кодирование в облаке" выберите значение **Стандартный**.

1. Для параметра "Предустановка кодирования" выберите значение **По умолчанию 720p**.

1. Для параметра "Входной протокол" выберите значение **RTMP**.

1. Для параметра "Постоянный URL-адрес входных данных" выберите значение **Да**.

1. Выберите **Да**, чтобы событие запускалось при его создании.

    > [!WARNING]
    > Выставление счетов начнется, если нажать кнопку "Да".  Если вы хотите подождать начало трансляции *непосредственно перед тем*, как начать трансляцию с помощью FFmpeg, щелкните **Нет** и не забудьте запустить событие прямой трансляции.

    > [!div class="mx-imgBorder"]
    > ![Параметры события прямой трансляции](media/tutorial-events-log-analytics/live-event-settings.png)

1. Установите флажок **I have all the rights to use the content/file...** (У меня есть все права на использование содержимого или файла…).

1. Выберите **Проверить и создать**.

1. Просмотрите параметры, а затем нажмите кнопку **Создать**.  Отобразится список событий прямой трансляции, и будет показан URL-адрес приема потоковой трансляции.

1. Скопируйте **URL-адрес приема** в буфер обмена.

1. Выберите **событие прямой трансляции** в списке, чтобы открыть "Представление создателя".

### <a name="stream-with-ffmpeg-cli"></a>Потоковая передача с помощью интерфейса командной строки FFmpeg

1. Используйте следующую командную строку.

    ```AzureCLI
    ffmpeg -i <localpathtovideo> -map 0 -c:v libx264 -c:a copy -f flv <ingestURL>/mystream
    ```

1. Измените `<ingestURL>` на URL-адрес приема, скопированный в буфер обмена.
1. Измените `<localpathtovideo>` на локальный путь к файлу, который требуется передать из FFmpeg.
1. Добавьте уникальное имя в конце, например `mystream`.
1. Измените командную строку в соответствии с исходным файлом теста и другими системными переменными.
1. Выполните команду. Через пару секунд проигрыватель "Представление создателя" должен начать потоковую передачу. (Обновите проигрыватель, если видео не отображается автоматически.)

    > [!div class="mx-imgBorder"]
    > ![Проверка правильного приема видео в проигрывателе предварительного просмотра](media/tutorial-events-log-analytics/live-event-producer-view.png)

## <a name="verify-the-events"></a>Проверка событий

В потоке прямой трансляции Службы мультимедиа Azure создают различные события, которые активируют поток приложения логики. Чтобы проверить события, перейдите в приложение логики и определите, какие триггеры инициируются событиями из Служб мультимедиа.

1. Перейдите на страницу обзора приложения логики, где вы увидите вкладку "Журнал запусков" со списком успешно завершенных заданий.
    > [!div class="mx-imgBorder"]
    > ![Проверка успешного выполнения задания в приложении логики](media/tutorial-events-log-analytics/run-history.png)

1. Выберите успешное завершенное задание. Отобразятся подробные сведения о задании во время выполнения.
1. Щелкните вкладку **Отправить данные**, чтобы развернуть ее. В этом случае было записано событие `MicrosoftMediaLiveEventEncoderConnected`, а также проанализирован текст. Это действие отправляется в рабочую область Azure Log Analytics.
    > [!div class="mx-imgBorder"]
    > ![Просмотр отправки данных](media/tutorial-events-log-analytics/verify-send-data.png)

## <a name="verify-the-logs"></a>Проверка журналов

1. Перейдите в рабочую область Log Analytics, созданную ранее.

1. Выберите **Журналы**.
1. Закройте всплывающее окно Example queries (Примеры запросов).
1. Будет создан список пользовательских журналов. Щелкните стрелку вниз, чтобы развернуть его. Здесь вы увидите имя события `MicrosoftMediaLiveEventEncoderConnected`.
1. Выберите имя события, чтобы развернуть его.
1. При выборе значка глаза отобразится предварительный просмотр результата запроса.
1. Щелкните пункт **Просмотр в редакторе запросов**, а затем выберите элемент в списке **TimeGenerated UTC**, чтобы развернуть его и просмотреть необработанные данные.

![Просмотр подробных выходных данных событий в Log Analytics](media/tutorial-events-log-analytics/raw-data.png)

## <a name="delete-resources"></a>Удаление ресурсов

Если вам не нужны ресурсы, созданные во время работы с этим учебником, обязательно удалите их в группе ресурсов, иначе плата будет взиматься по-прежнему.

## <a name="next-steps"></a>Дальнейшие действия

Вы можете создать различные запросы и сохранить их. Их можно добавить на [Панель мониторинга Azure](../../azure-monitor/learn/tutorial-logs-dashboards.md).