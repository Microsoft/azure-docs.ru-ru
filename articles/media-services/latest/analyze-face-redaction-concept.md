---
title: Редактирование лиц в API-интерфейсе служб мультимедиа Azure v3 | Документация Майкрософт
description: В службах мультимедиа Azure v3 предусмотрена предустановка для обнаружения и исправления лиц, которая позволяет отправлять видеофайлы, обнаруживать грани и применять к ним размытие за один объединенный проход, а также выполнять две операции, позволяющие изменять их. В этой статье показано, как исправить грани с помощью предустановки детектора распознавания лиц в API V3.
services: media-services
documentationcenter: ''
author: IngridAtMicrosoft
manager: femila
editor: ''
ms.service: media-services
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: dotnet
ms.topic: article
ms.date: 03/25/2021
ms.author: johndeu
ms.custom: devx-track-csharp
ms.openlocfilehash: 6db93aa369366936c90446c41406eafe9ee6e414
ms.sourcegitcommit: a9ce1da049c019c86063acf442bb13f5a0dde213
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2021
ms.locfileid: "105630488"
---
# <a name="redact-faces-with-the-face-detector-preset"></a>Редактирование граней с помощью предустановки детектора распознавания лиц

[!INCLUDE [media services api v3 logo](./includes/v3-hr.md)]

API-интерфейс служб мультимедиа Azure v3 включает предустановку детектора лиц, которая предлагает масштабируемые средства обнаружения и исправления лиц (размытия) в облаке. Функция скрытия лиц позволяет изменять видео, размывая изображения лиц выбранных пользователей. Вы можете использовать функцию скрытия лиц в ситуациях, требующих соблюдения общественной безопасности, а также при работе с новостями. Несколько минут, в которых содержится несколько лиц, могут потребовать много часов для ручного исправления, но в этом случае для обработки исправлений лиц потребуется всего несколько простых шагов.

В этой статье приводятся сведения о **предустановленной детекторе распознавания лиц** и демонстрируется ее использование с пакетом SDK служб мультимедиа Azure для .NET.

## <a name="compliance-privacy-and-security"></a>Соответствие требованиям, конфиденциальность и безопасность
 
В качестве важного напоминания вы должны соблюдать все применимые законы в использовании аналитики в службах мультимедиа Azure. Не следует использовать службы мультимедиа Azure или другие службы Azure способом, нарушающим права других пользователей. Перед отправкой любых видеороликов, включая любые биометрические данные, в службу служб мультимедиа Azure для обработки и хранения данных необходимо иметь все необходимые права, включая все возможные разрешения, от пользователей видео. Чтобы узнать о соответствии требованиям, конфиденциальности и безопасности в службах мультимедиа Azure, [Cognitive Services условия](https://azure.microsoft.com/support/legal/cognitive-services-compliance-and-privacy/)Azure. Для соблюдения конфиденциальности и обработки данных корпорацией Майкрософт ознакомьтесь с заявлением [о конфиденциальности](https://privacy.microsoft.com/PrivacyStatement)корпорации Майкрософт, [условиями использования веб-служб](https://www.microsoft.com/licensing/product-licensing/products) (OST) и [дополнением к обработке данных](https://www.microsoftvolumelicensing.com/DocumentSearch.aspx?Mode=3&DocumentTypeId=67) ("DPA"). Дополнительные сведения о конфиденциальности, включая хранение, удаление и уничтожение данных, доступны в OST-файлах и [здесь](../video-indexer/faq.md). С помощью служб мультимедиа Azure вы соглашаетесь соблюдать условия Cognitive Services, OST, DPA и заявления о конфиденциальности.


## <a name="face-redaction-modes"></a>Режимы скрытия лиц

Во время работы этой функции в каждом видеокадре лица определяются и отслеживаются на протяжении всей записи. Таким образом, лицо одного и того же человека можно размыть, даже если оно снято с другого ракурса. Процесс автоматического исправления является сложным и не всегда имеет размытие для каждого лица 100%. По этой причине для повышения качества и точности размытия с помощью этапа редактирования перед отправкой файла для окончательного этапа размытия можно использовать режим с двумя проходами. 

В дополнение к полностью автоматическому **объединению** , двухэтапный рабочий процесс позволяет выбирать лиц, которым вы хотите размытие (или не размытие), с помощью списка идентификаторов лиц. Чтобы внести произвольные изменения для каждого кадра, Предустановка использует файл метаданных в формате JSON в качестве входных данных для второго прохода. Этот рабочий процесс разделен на два режима: **анализ** и **скрытие**.

Можно также просто объединить два режима в один, который выполняет обе задачи в одном задании. Этот режим называется **Объединенным**.  В этой статье в примере кода показано, как использовать упрощенный **Объединенный** режим Single-Pass в образце исходного файла.

### <a name="combined-mode"></a>Объединенный режим

При этом создается видеофайл показана исправленная версия MP4 за один проход без необходимости редактирования файла JSON вручную. Выходные данные в папке Asset для задания будут представлять собой один MP4-файл, содержащий размытые лица с использованием выбранного эффект размытия. Используйте свойство Resolution со значением **саурцересолутион** , чтобы добиться наилучших результатов для исправления.

| Этап | Имя файла | Примечания |
| --- | --- | --- |
| Входной ресурс-контейнер |"ignite-sample.mp4" |Видео в формате WMV, MOV или MP4 |
| Предустановленная конфигурация |Конфигурация детектора лиц | **режим**: Фацередактормоде. скомбинирован,  **блуртипе**: блуртипе. MED, **Resolution**: аналисисресолутион. саурцересолутион |
| Выходной ресурс-контейнер |"ignite-redacted.mp4 |Видео с эффекты размытия, примененные к сторонам |

### <a name="analyze-mode"></a>Режим анализа

Этап **анализа** двухфазной обработки, выполняемый в двух проходах, принимает входные данные видео и создает JSON-файл со списком расположений лиц, изображений идентификаторов лиц и JPG для каждого обнаруженного лица. 

| Этап | Имя файла | Примечания |
| --- | --- | --- |
| Входной ресурс-контейнер |"ignite-sample.mp4" |Видео в формате WMV, MPV или MP4 |
| Предустановленная конфигурация |Конфигурация детектора лиц |**режим**: Фацередактормоде. Analyze, **решение**: аналисисресолутион. саурцересолутион|
| Выходной ресурс-контейнер |ignite-sample_annotations.jsна |Аннотация с данными о расположении лиц в формате JSON. Вы можете отредактировать эти данные, чтобы изменить границы размытия. См. пример ниже. |
| Выходной ресурс-контейнер |foo_thumb%06d.jpg [foo_thumb000001.jpg, foo_thumb000002.jpg] |Обрезанный JPG-файл с изображением каждого обнаруженного лица, где номер соответствует идентификатору метки лица. |

#### <a name="output-example"></a>Пример выходных данных

```json
{
  "version": 1,
  "timescale": 24000,
  "offset": 0,
  "framerate": 23.976,
  "width": 1280,
  "height": 720,
  "fragments": [
    {
      "start": 0,
      "duration": 48048,
      "interval": 1001,
      "events": [
        [],
        [],
        [],
        [],
        [],
        [],
        [],
        [],
        [],
        [],
        [],
        [],
        [],
        [
          {
            "index": 13,
            "id": 1138,
            "x": 0.29537,
            "y": -0.18987,
            "width": 0.36239,
            "height": 0.80335
          },
          {
            "index": 13,
            "id": 2028,
            "x": 0.60427,
            "y": 0.16098,
            "width": 0.26958,
            "height": 0.57943
          }
        ],

    ... truncated
```

### <a name="redact-blur-mode"></a>Режим «исправить (размытие)»

Во время второго этапа рабочий процесс принимает большее количество входных данных для объединения в один ресурс-контейнер.

Сюда входит список идентификаторов размываемых лиц, исходное видео и аннотации в формате JSON. Этот режим использует аннотации для применения размытия ко входному видео.

Выходные данные этапа анализа не включают исходное видео. Видео необходимо передать во входной ресурс-контейнер, чтобы задача режима скрытия обработала его, а затем выбрать в качестве первичного файла.

| Этап | Имя файла | Примечания |
| --- | --- | --- |
| Входной ресурс-контейнер |"ignite-sample.mp4" |Видео в формате WMV, MPV или MP4. То же видео, что и на этапе 1. |
| Входной ресурс-контейнер |"ignite-sample_annotations.jsна" |файл метаданных заметок, начиная с первого этапа, с дополнительными изменениями, если вы хотите изменить грани с размытием. Это необходимо изменить во внешнем приложении, коде или текстовом редакторе. |
| Входной ресурс-контейнер | "ignite-sample_IDList.txt" (необязательно) | (Необязательно.) Новый список идентификаторов скрываемых лиц со строками-разделителями. Если оставить это поле пустым, то все грани в источнике будут иметь размытие. Можно использовать список, чтобы выборочно отказаться от размытия отдельных лиц. |
| Предустановка детектора лиц  |Предустановленная конфигурация  | **режим**: Фацередактормоде. исправить, **блуртипе**: блуртипе. MED |
| Выходной ресурс-контейнер |"ignite-sample-redacted.mp4" |Видео с размытием, примененным на основе аннотаций |

#### <a name="example-output"></a>Пример выходных данных

Выходные данные из списка идентификаторов с одним выбранным идентификатором.

Пример foo_IDList.txt

```
1
2
3
```

## <a name="blur-types"></a>Типы размытия

В режиме **комбинирования** или исправления существует пять различных режимов размытия, которые можно выбрать с помощью входной конфигурации JSON: **низкая**, **MED**,  **Высокая**, **Box** и **черная**. По умолчанию используется режим **Med** (Средний).

Примеры типов размытия можно просмотреть ниже.

### <a name="example-settings-for-face-detector-preset"></a>Примеры параметров для предустановки детектора лиц
[!code-csharp[Main](../../../media-services-v3-dotnet/VideoAnalytics/FaceRedactor/Program.cs#FaceDetectorPreset)]


#### <a name="low"></a>Низкий

![Пример настройки размытия с низким разрешением.](./media/media-services-face-redaction/blur-1.png)

#### <a name="med"></a>Средний

![Пример параметра размытия среднего разрешения.](./media/media-services-face-redaction/blur-2.png)

#### <a name="high"></a>Высокий

![Пример настройки размытия высокого разрешения.](./media/media-services-face-redaction/blur-3.png)

#### <a name="box"></a>Box

![Режим Box для использования при отладке выходных данных.](./media/media-services-face-redaction/blur-4.png)

#### <a name="black"></a>Черный

![Режим черного ящика охватывает все грани с черными квадратиками.](./media/media-services-face-redaction/blur-5.png)

## <a name="elements-of-the-output-json-file"></a>Элементы выходного JSON-файла

Обработчик мультимедиа с функцией скрытия лиц обеспечивает высокую точность обнаружения и отслеживания лиц с возможностью определения до 64 человеческих лиц в одном видеокадре. Скрытие лиц в анфас выполняется с лучшим результатом по сравнению с лицами в профиль или небольшим лицами (не более 24x24 пикселей), которые сложнее обработать.

[!INCLUDE [media-services-analytics-output-json](../../../includes/media-services-analytics-output-json.md)]

## <a name="net-sample-code"></a>Пример кода .NET

В следующей программе показано, как использовать **комбинированный** режим однопроходного исправления:

- Создать ресурс-контейнера и отправить в него файл мультимедиа.
- Настройте предустановку детектора лиц, которая использует параметры mode и Блуртипе.
- Создание нового преобразования с помощью предустановки детектора лиц
- Скачайте выходной файл показана исправленная версия Video.

## <a name="download-and-configure-the-sample"></a>Скачивание и настройка примера

Клонируйте репозиторий GitHub, содержащий пример .NET, на компьютер с помощью следующей команды:  

 ```bash
 git clone https://github.com/Azure-Samples/media-services-v3-dotnet.git
 ```

Пример находится в папке [фацередактор](https://github.com/Azure-Samples/media-services-v3-dotnet/tree/main/VideoAnalytics/FaceRedactor) Откройте файл [appsettings.json](https://github.com/Azure-Samples/media-services-v3-dotnet/blob/main/VideoAnalytics/FaceRedactor/appsettings.json) в скачанном проекте. Замените значения учетными данными, которые вы получили, выполнив действия из руководства по [получению доступа к API](./access-api-howto.md).

**При необходимости** можно скопировать файл **[Sample. env](https://github.com/Azure-Samples/media-services-v3-dotnet/blob/main/sample.env)** в корень репозитория и заполнить его в нем, а затем переименовать его в **. env** (Обратите внимание на точку на передней панели), чтобы ее можно было использовать во всех примерах проектов в репозитории.  Это избавляет от необходимости заполнять appsettings.jsфайла в каждом примере, а также обеспечивает защиту от проверки каких-либо параметров в собственных клонированных репозиториях в центре Git.

#### <a name="examples"></a>Примеры

В этом коде показано, как настроить **фацедетекторпресет** для **комбинированного** режима размытия.

[!code-csharp[Main](../../../media-services-v3-dotnet/VideoAnalytics/FaceRedactor/Program.cs#FaceDetectorPreset)]

В этом примере кода показано, как заданная Предустановка передается в объект преобразования во время создания. После создания преобразования задания могут быть отправлены в него напрямую.

[!code-csharp[Main](../../../media-services-v3-dotnet/VideoAnalytics/FaceRedactor/Program.cs#FaceDetectorPresetTransform)]

## <a name="next-steps"></a>Дальнейшие шаги

[!INCLUDE [media-services-learning-paths-include](../../../includes/media-services-learning-paths-include.md)]

## <a name="provide-feedback"></a>Отзывы

[!INCLUDE [media-services-user-voice-include](../../../includes/media-services-user-voice-include.md)]

