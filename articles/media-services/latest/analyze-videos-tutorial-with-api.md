---
title: Анализ видео с помощью Служб мультимедиа версии 3
description: Узнайте, как анализировать видео с помощью Служб мультимедиа Azure.
services: media-services
documentationcenter: ''
author: IngridAtMicrosoft
manager: femila
editor: ''
ms.service: media-services
ms.workload: ''
ms.topic: tutorial
ms.date: 08/31/2020
ms.author: inhenkel
ms.custom: seodec18
ms.openlocfilehash: 4a050d838bae9b394f5f292698781a9a824af0bf
ms.sourcegitcommit: 6386854467e74d0745c281cc53621af3bb201920
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/08/2021
ms.locfileid: "102454130"
---
# <a name="tutorial-analyze-videos-with-media-services-v3"></a>Руководство по Анализ видео с помощью Служб мультимедиа версии 3

[!INCLUDE [media services api v3 logo](./includes/v3-hr.md)]

> [!NOTE]
> Несмотря на то что в этом учебнике используются примеры для [пакета SDK для .NET](/dotnet/api/microsoft.azure.management.media.models.liveevent), общие шаги одинаковы для [REST API](/rest/api/media/liveevents), [CLI](/cli/azure/ams/live-event) или других поддерживаемых [пакетов SDK](media-services-apis-overview.md#sdks).

Это руководство содержит сведения об анализе видео с помощью Служб мультимедиа Azure. Имеется множество сценариев, в которых может потребоваться получить подробные сведения о видео- и аудиозаписях. Например, чтобы повысить удовлетворенность клиентов, организации могут выполнить преобразование речи в текст. Таким образом можно сделать записи клиентов доступным для поиска каталогом с индексами и панелями мониторинга. Затем они могут получить ценные сведения о своем бизнесе, такие как список распространенных жалоб, источников этих жалоб и другая полезная информация.

В этом учебнике описаны следующие процедуры.

> [!div class="checklist"]
> * Скачивание примера приложения, описанного в этой статье.
> * Проверка кода, анализирующего указанное видео.
> * Запустите приложение.
> * Изучение выходных данных.
> * Очистка ресурсов.

[!INCLUDE [quickstarts-free-trial-note](../../../includes/quickstarts-free-trial-note.md)]

## <a name="compliance-privacy-and-security"></a>Соответствие требованиям, конфиденциальность и безопасность
 
Хотим напомнить, что при использовании Индексатора видео вы должны соблюдать все применимые законы, и не имеете права использовать Индексатор видео или любые другие службы Azure каким либо способом, который нарушает права других лиц или может нанести им вред. Перед отправкой любого видеосодержимого, включая любые биометрические данные, в службу "Индексатор видео" для обработки и хранения данных необходимо иметь все необходимые права, включая все возможные разрешения, от отдельных пользователей, содержащихся в видеосодержимом. Чтобы узнать о соответствии требованиям, конфиденциальности и безопасности в Индексаторе видео, см. [Условия Microsoft Cognitive Services](https://azure.microsoft.com/support/legal/cognitive-services-compliance-and-privacy/). Обязательства Майкрософт по обеспечению конфиденциальности и обработке ваших данных см. в [Заявлении о конфиденциальности](https://privacy.microsoft.com/PrivacyStatement), [Условиях использования веб-служб](https://www.microsoft.com/licensing/product-licensing/products) ("OST") и [Приложение к обработке данных](https://www.microsoftvolumelicensing.com/DocumentSearch.aspx?Mode=3&DocumentTypeId=67) ("DPA"). Дополнительные сведения о конфиденциальности, включая хранение данных, их удаление или уничтожение, доступны в OST и [здесь](../video-indexer/faq.md). Используя Индексатор видео, обязуетесь соблюдать Условия Cognitive Services, OST, DPA и Заявление о конфиденциальности.

## <a name="prerequisites"></a>Предварительные требования

- Если у вас нет Visual Studio, скачайте и установите [Visual Studio Community 2019](https://www.visualstudio.com/thank-you-downloading-visual-studio/?sku=Community&rel=15).
- [Создание учетной записи Служб мультимедиа](./create-account-howto.md).<br/>Запишите значения, которые вы использовали в качестве имени группы ресурсов и имени учетной записи Служб мультимедиа.
- Выполните действия, описанные в статье [Доступ к API Служб мультимедиа Azure с помощью Azure CLI](./access-api-howto.md), и сохраните учетные данные. Эти данные понадобятся для доступа к API.

## <a name="download-and-configure-the-sample"></a>Скачивание и настройка примера

Клонируйте репозиторий GitHub, содержащий пример .NET, на компьютер с помощью следующей команды:  

 ```bash
 git clone https://github.com/Azure-Samples/media-services-v3-dotnet-tutorials.git
 ```

Этот образец находится в папке [AnalyzeVideos](https://github.com/Azure-Samples/media-services-v3-dotnet-tutorials/tree/master/AMSV3Tutorials/AnalyzeVideos).

Откройте файл [appsettings.json](https://github.com/Azure-Samples/media-services-v3-dotnet-tutorials/blob/master/AMSV3Tutorials/AnalyzeVideos/appsettings.json) в скачанном проекте. Замените значения учетными данными, которые вы получили, выполнив действия из руководства по [получению доступа к API](./access-api-howto.md).

## <a name="examine-the-code-that-analyzes-the-specified-video"></a>Проверка кода, анализирующего указанное видео

В этом разделе рассматриваются функции, определенные в файле [Program.cs](https://github.com/Azure-Samples/media-services-v3-dotnet-tutorials/blob/master/AMSV3Tutorials/AnalyzeVideos/Program.cs) проекта *AnalyzeVideos*.

Этот пример выполняет следующие действия:

1. Создает **преобразование** и **задание**, которое анализирует видео.
2. Создает входной **ресурс** и отправляет в него видео. Ресурс используется в качестве входных данных задания.
3. Создает выходной ресурс, который сохраняет выходные данные задания.
4. Подтверждает задание.
5. Проверяет состояние задания.
6. Загружает файлы, полученные в результате выполнения задания.

> [!NOTE]
> Используя наборы настроек анализаторов, установите 10 зарезервированных единиц мультимедиа S3 для своей учетной записи на портале Azure. Дополнительные сведения см. в [этой статье](media-reserved-units-cli-how-to.md).

### <a name="start-using-media-services-apis-with-net-sdk"></a>Начало использования API Служб мультимедиа с пакетом SDK для .NET

Чтобы начать использование API Служб мультимедиа с .NET, создайте объект **AzureMediaServicesClient**. Чтобы создать объект, введите учетные данные, необходимые клиенту для подключения к Azure с помощью Azure AD. В коде, который вы клонировали в начале статьи, функция **GetCredentialsAsync** создает объект ServiceClientCredentials с использованием учетных данных, предоставленных в локальном файле конфигурации. 

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/AnalyzeVideos/Program.cs#CreateMediaServicesClient)]

### <a name="create-an-input-asset-and-upload-a-local-file-into-it"></a>Создание входного ресурса и отправка в него локального файла 

Функция **CreateInputAsset** создает входной [ресурс](/rest/api/media/assets) и отправляет в него определенный локальный видеофайл. Этот ресурс используется в качестве входных данных для задания кодирования. В Службах мультимедиа версии 3 входные данные для задания могут быть либо ресурсом, либо содержимым, доступным в учетной записи Служб мультимедиа через URL-адрес HTTPS. Сведения о кодировании URL-адреса HTTPS см. в [этой статье](job-input-from-http-how-to.md).  

В Службах мультимедиа версии 3 для отправки файлов используются API службы хранилища. В следующих фрагментах кода .NET показано, как это сделать.

Следующая функция выполняет такие действия:

* создает ресурс;
* получает записываемый [URL-адрес SAS](../../storage/common/storage-sas-overview.md) в [контейнере в хранилище](../../storage/blobs/storage-quickstart-blobs-dotnet.md#upload-blobs-to-a-container) ресурса;

    При использовании функции [ListContainerSas](/rest/api/media/assets/listcontainersas) ресурса для получения URL-адресов SAS обратите внимание, что функция возвращает несколько URL-адресов SAS, так как для каждой учетной записи хранения существует два ключа. Учетная запись хранения имеет два ключа, чтобы обеспечить легкую смену ключей (например, можно использовать первый ключ и в это время заменить второй ключ, а затем начать использовать новый ключ, а в это время заменить первый ключ). Первый URL-адресом SAS представляет собой ключ к хранилищу данных 1, а второй — ключ к хранилищу данных 2.
* отправляет файл в контейнер в хранилище через URL-адрес SAS.

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/AnalyzeVideos/Program.cs#CreateInputAsset)]

### <a name="create-an-output-asset-to-store-the-result-of-the-job"></a>Создание выходного ресурса для хранения результатов задания

Выходной [ресурс](/rest/api/media/assets) сохраняет результаты задания. Проект определяет функцию **DownloadResults**, которая скачивает результаты из выходного ресурса в папку output, чтобы вы могли просмотреть их.

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/AnalyzeVideos/Program.cs#CreateOutputAsset)]

### <a name="create-a-transform-and-a-job-that-analyzes-videos"></a>Создание преобразования и задания, которое анализирует видео

При кодировании или обработке содержимого в Службах мультимедиа параметры кодировки часто задают в качестве набора инструкций. Затем необходимо отправить **задание**, чтобы применить этот набор к видео. Отправляя новые задания для каждого нового видео, вы применяете этот набор ко всем видео в своей библиотеке. Набор инструкций в Службах мультимедиа называется **Преобразование**. Дополнительные сведения см. в статье о [преобразованиях и заданиях](./transforms-jobs-concept.md). Пример кода, описанный в этом руководстве, определяет набор инструкций, которые анализируют указанное видео.

#### <a name="transform"></a>Преобразование

При создании нового экземпляра [преобразования](/rest/api/media/transforms) необходимо указать, что требуется создать в качестве выходных данных. **TransformOutput** — обязательный параметр. Каждый объект **TransformOutput** содержит **предустановку** (Preset). **Предустановка** описывает пошаговые инструкции для операций обработки видео и звука, которые будут использоваться для создания нужного объекта **TransformOutput**. В этом примере используется предустановка **VideoAnalyzerPreset** и язык (ru_RU) передается в конструктор (`new VideoAnalyzerPreset("en-US")`). Эта предустановка позволяет извлечь из видео множество аналитических сведений об аудио и видео. Если необходимо извлечь из видео множество аналитических сведений об аудио, используйте предустановку **AudioAnalyzerPreset**.

При создании **преобразования** сначала проверьте, существует ли оно, с помощью метода **Get**, как показано в следующем коде. В Службах мультимедиа версии 3 методы **Get**, отправленные к сущностям, возвращают значение **NULL**, если сущность не существует (проверка по имени без учета регистра).

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/AnalyzeVideos/Program.cs#EnsureTransformExists)]

#### <a name="job"></a>Задание

Как было указано выше, объект [преобразования](/rest/api/media/transforms) является набором инструкций, а [задание](/rest/api/media/jobs) — фактическим запросом к Службам мультимедиа для применения этого **преобразования** к данному видео и аудио. **Задание** указывает такую информацию, как расположение входного и выходного видео. Расположение видео можно указать с помощью URL-адресов HTTPS, URL-адресов SAS или ресурсов, которые находятся в вашей учетной записи Служб мультимедиа.

В этом примере задания входными данными задания является локальный видеофайл.  

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/AnalyzeVideos/Program.cs#SubmitJob)]

### <a name="wait-for-the-job-to-complete"></a>Ожидание завершения задания

Запуск задания занимает некоторое время. Поэтому вам пригодится уведомление. Получить уведомление о завершении [задания](/rest/api/media/jobs) можно несколькими способами. Самый простой (который показан тут) — использовать опрос.

Опрос не рекомендуется для приложений рабочей среды из-за потенциальной задержки. Его можно регулировать при чрезмерном использовании в учетной записи. Вместо этого разработчики должны использовать службу "Сетка событий".

Служба "Сетка событий" предназначена для обеспечения высокого уровня доступности, стабильной производительности и динамического масштабирования. С помощью службы "Сетка событий Azure" приложения могут ожидать передачи данных и реагировать на события, поступающие буквально из всех служб Azure и пользовательских источников. Простая реактивная обработка событий на основе HTTP позволяет создавать эффективные решения с использованием интеллектуальной фильтрации и маршрутизации событий. Дополнительные сведения см. в статье [Create and monitor Media Services events with Event Grid using the Azure CLI](job-state-events-cli-how-to.md) (Создание и мониторинг событий Служб мультимедиа с помощью Сетки событий и Azure CLI).

Для **задания** обычно последовательно устанавливаются следующие состояния: **Запланировано**, **В очереди**, **Идет обработка**, **Завершено** (конечное состояние). Если в задании обнаружена ошибка, вы получите состояние **Ошибка**. Если задание находится в процессе отмены, вы получите состояние **Выполнение отмены** и **Отменено** по завершении.

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/AnalyzeVideos/Program.cs#WaitForJobToFinish)]

### <a name="job-error-codes"></a>Коды ошибок задания

См. статью о [кодах ошибок](/rest/api/media/jobs/get#joberrorcode).

### <a name="download-the-result-of-the-job"></a>Скачивание результатов задания

С помощью следующей функции можно скачать результаты задания из выходного [ресурса](/rest/api/media/assets) контейнера в папку output, чтобы проанализировать их.

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/AnalyzeVideos/Program.cs#DownloadResults)]

### <a name="clean-up-resource-in-your-media-services-account"></a>Очистка ресурсов в учетной записи служб мультимедиа

Как правило, необходимо очистить все, кроме объектов, которые планируется использовать повторно. Обычно повторно используются Transforms и сохраненные StreamingLocators. Если учетную запись требуется очистить после эксперимента, удалите ресурсы, которые не планируется использовать повторно. Удалить задание и выходной ресурс можно с помощью следующего кода:

[!code-csharp[Main](../../../media-services-v3-dotnet-tutorials/AMSV3Tutorials/AnalyzeVideos/Program.cs#CleanUp)]

## <a name="run-the-sample-app"></a>Запуск примера приложения

Для запуска приложения *AnalyzeVideos* нажмите клавиши CTRL+F5.

При запуске программы задание создает эскизы каждого лица, обнаруженного в видео. Оно также создает файл insights.json.

## <a name="examine-the-output"></a>Изучение выходных данных

Выходной файл анализированных видео называется insights.json. Этот файл содержит аналитические сведения о видео. Описание элементов находятся в JSON-файле статьи об [аналитике мультимедиа](./analyzing-video-audio-files-concept.md).

## <a name="clean-up-resources"></a>Очистка ресурсов

Если вам больше не нужны какие-либо ресурсы в группе ресурсов, включая Службы мультимедиа и учетные записи хранения, созданные для этого руководства, удалите группу ресурсов, созданную ранее.

Выполните следующую команду CLI:

```azurecli
az group delete --name amsResourceGroup
```

## <a name="multithreading"></a>Многопоточность

Пакеты SDK для Служб мультимедиа Azure версии 3 не являются потокобезопасными. При работе с многопоточным приложением необходимо создать объект AzureMediaServicesClient для каждого потока.

## <a name="ask-questions-give-feedback-get-updates"></a>Получение справки, отправка отзывов, получение обновлений

Прочитайте статью [сообщества Служб мультимедиа Azure](media-services-community.md), чтобы узнать, как задавать вопросы, оставлять отзывы и получать новости о Службах мультимедиа.

## <a name="next-steps"></a>Дальнейшие действия

> [!div class="nextstepaction"]
> [Руководство. Отправка, кодирование и потоковая передача видео с помощью API](stream-files-tutorial-with-api.md)
