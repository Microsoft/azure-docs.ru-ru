---
title: Готовность к производству и рекомендации по работе с Azure
description: В этой статье содержатся инструкции по настройке и развертыванию функции Live Video Analytics в модуле IoT Edge в рабочих средах.
ms.topic: conceptual
ms.date: 04/27/2020
ms.openlocfilehash: 56982d84b7ffac718072683076657d56a2691d6c
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "97400562"
---
# <a name="production-readiness-and-best-practices"></a>Подготовка рабочей среды и рекомендации

В этой статье содержатся инструкции по настройке и развертыванию функции Live Video Analytics в модуле IoT Edge в рабочих средах. Кроме того, ознакомьтесь [со статьей подготовка к развертыванию решения IOT EDGE в рабочей](../../iot-edge/production-checklist.md) статье по подготовке IOT Edgeного решения. 

> [!NOTE]
> Вы должны обратиться в ИТ-отдел Организации к аспектам, связанным с безопасностью.

## <a name="running-the-module-as-a-local-user"></a>Запуск модуля от имени локального пользователя

При развертывании функции Live Video Analytics в модуле IoT Edge на пограничном устройстве по умолчанию оно запускается с повышенными привилегиями. Если вы проверите журналы в модуле ( `sudo iotedge logs {name-of-module}` ), вы увидите следующее:

```
!! production readiness: user accounts – Warning
       LOCAL_USER_ID and LOCAL_GROUP_ID environment variables are not set. The program will run as root!
       For optimum security, make sure to set LOCAL_USER_ID and LOCAL_GROUP_ID environment variables to a non-root user and group.
       See https://aka.ms/lva-iot-edge-prod-checklists-user-accounts for more information.
```

В следующих разделах описывается, как можно устранить вышеописанное предупреждение.

### <a name="creating-and-using-a-local-user-account"></a>Создание и использование учетной записи локального пользователя

Вы можете запустить Live Video Analytics в модуле IoT Edge в рабочей среде, используя учетную запись с минимальными привилегиями. Следующие команды, например, покажут, как можно создать локальную учетную запись пользователя на виртуальной машине Linux:

```
sudo groupadd -g 1010 localuser
sudo adduser --home /home/edgeuser --uid 1010 -gid 1010 edgeuser
```

Затем в манифесте развертывания можно задать переменные среды LOCAL_USER_ID и LOCAL_GROUP_ID для некорневого пользователя и группы:

```
"lvaEdge": {
"version": "1.0",
…
"env": {
    "LOCAL_USER_ID": 
    {
        "value": "1010"
    },
    "LOCAL_GROUP_ID": {
        "value": "1010"
    }
}
},
…
```

### <a name="granting-permissions-to-device-storage"></a>Предоставление разрешений для хранилища устройств

В реальном времени для анализа видео в модуле IoT Edge требуется возможность записи файлов в локальную файловую систему в следующих случаях:

* С помощью свойства Module двойника [`applicationDataDirectory`](module-twin-configuration-schema.md#module-twin-properties) , где необходимо указать каталог в локальной файловой системе для хранения данных конфигурации.
* Используя граф мультимедиа для записи видео в облако, модуль требует использования каталога на пограничном устройстве в качестве кэша (Дополнительные сведения см. в статье [Непрерывная запись видео](continuous-video-recording-concept.md) ).
* [Запись в локальный файл](event-based-video-recording-concept.md#video-recording-based-on-events-from-other-sources), где необходимо указать путь к записанному видео.

Если вы планируете использовать любой из перечисленных выше служб, следует убедиться, что указанная выше учетная запись пользователя имеет доступ к соответствующему каталогу. Рассмотрим пример Аппликатиондатадиректори. Вы можете создать каталог на пограничном устройстве и связать его с хранилищем модулей. 

```
sudo mkdir /var/local/mediaservices
sudo chown -R edgeuser /var/local/mediaservices
```

Затем в параметрах создания для модуля ребра в манифесте развертывания можно добавить параметр привязки, сопоставленный каталог ("var/local/mediaservices/") выше с каталогом в модуле (например, "/Вар/либ/азуремедиасервицес/"). И вы бы использовали последний каталог в качестве значения для Аппликатиондатадиректори.

```
"lvaEdge": {
    "version": "1.0",
    "type": "docker",
    "status": "running",
    "restartPolicy": "always",
    "settings": {
        "image": "mcr.microsoft.com/media/live-video-analytics:1.0",
        "createOptions": "{\"HostConfig\":{\"LogConfig\":{\"Type\":\"\",\"Config\":{\"max-size\":\"10m\",\"max-file\":\"10\"}},\"Binds\":[\"/var/local/mediaservices/:/var/lib/azuremediaservices/\"]}}"
    },
    "env": {
        "LOCAL_USER_ID": 
        {
            "value": "1010"
        },
        "LOCAL_GROUP_ID": {
            "value": "1010"
        }
    }
    },
    …
    
    "lvaEdge": {
    "properties.desired": {
    "applicationDataDirectory": "/var/lib/azuremediaservices",
    …
    }
}
```

Если взглянуть на образцы графов мультимедиа для краткого руководства и руководств, таких как [Непрерывная запись видео](continuous-video-recording-tutorial.md), то обратите внимание, что каталог кэша мультимедиа (локалмедиакачепас) использует подкаталог в аппликатиондатадиректори. Это рекомендуемый подход, так как кэш содержит временные данные.

### <a name="naming-video-assets-or-files"></a>Именование ресурсов или файлов видео

Графы мультимедиа позволяют создавать ресурсы в облачных и mp4ных файлах на границе. Ресурсы мультимедиа можно создавать с помощью [непрерывной записи видео](continuous-video-recording-tutorial.md) или с помощью [записи видео на основе событий](event-based-video-recording-tutorial.md). Хотя этим ресурсам и файлам можно присвоить имена нужным образом, рекомендуемой структурой именования для непрерывного видеоматериала на основе записи является " &lt; анитекст &gt; -$ {System. графтопологинаме}-$ {System. графинстанценаме}".   

Шаблон подстановки определяется символом $, за которым следует фигурные скобки: **$ {variablename}**.  

Например, можно задать Ассетнамепаттерн в приемнике актива следующим образом:

```
"assetNamePattern": "sampleAsset-${System.GraphTopologyName}-${System.GraphInstanceName}
```

Для ресурсов, создаваемых для записи видео на основе событий, рекомендуемым шаблоном именования является " &lt; анитекст &gt; -$ {System. DateTime}". Системная переменная гарантирует, что ресурсы не перезаписываются при возникновении событий в то же время. Например, можно задать Ассетнамепаттерн в приемнике актива следующим образом:

```
"assetNamePattern": "sampleAssetFromEVR-LVAEdge-${System.DateTime}"
```

Если вы используете несколько экземпляров одного и того же графа, для различения можно использовать имя топологии графа и имя экземпляра. Например, можно задать Ассетнамепаттерн в приемнике актива следующим образом:

```
"assetNamePattern": "sampleAssetFromEVR-${System.GraphTopologyName}-${System.GraphInstanceName}-${System.DateTime}"
```

Для записи видео на основе событий, созданной с помощью видеороликов MP4 на границе, рекомендуемый шаблон именования должен включать дату и время, а для нескольких экземпляров того же графа рекомендуется использовать системные переменные Графтопологинаме и Графинстанценаме. Например, можно задать Филепаспаттерн в приемнике файлов следующим образом: 

```
"fileNamePattern": "/var/media/sampleFilesFromEVR-${fileSinkOutputName}-${System.DateTime}"
```

либо 

```
"fileNamePattern": "/var/media/sampleFilesFromEVR-${fileSinkOutputName}--${System.GraphTopologyName}-${System.GraphInstanceName} ${System.DateTime}"
```
>[!NOTE]
> В приведенном выше примере переменная **филесинкаутпутнаме** является примером имени переменной, которое вы определяете в топологии графа. Это **не** системная переменная. 

#### <a name="system-variables"></a>Системные переменные
Ниже перечислены некоторые системные переменные, которые можно использовать.

|Системная переменная|Описание|Пример|
|-----------|-----------|-----------|
|System.DateTime|Дата и время в формате UTC (базовое представление ГГГГММДДTччммсс недоступен).|20200222T173200Z|
|System. ПреЦиседатетиме|Дата и время в формате UTC для формата, совместимого с файлом ISO8601, с миллисекундами (базовое представление ГГГГММДДTччммсс недоступен. SSS).|20200222T 173200.123 Z|
|System. Графтопологинаме|Указанное пользователем имя топологии выполнения графа.|инжестандрекорд|
|System. Графинстанценаме|Указанное пользователем имя исполняемого экземпляра Graph.|camera001|

>[!TIP]
> System. ПреЦиседатетиме нельзя использовать при именовании ресурсов из-за "." в имени
### <a name="keeping-your-vm-clean"></a>Обеспечение очистки виртуальной машины

Виртуальная машина Linux, используемая в качестве пограничного устройства, может перестать отвечать, если она не управляется на периодической основе. Важно очищать кэши, устранять ненужные пакеты и удалять неиспользуемые контейнеры из виртуальной машины. Вот набор рекомендуемых команд, которые можно использовать на виртуальной машине пограничной платформы.

1. `sudo apt-get clean`

    Команда apt-get Clean очищает локальный репозиторий полученных файлов пакета, которые остались в/Вар/каче. Каталоги, которые он очищает, — это/Вар/каче/Апт/арчивес/и/Вар/каче/Апт/арчивес/партиал/. Только файлы, которые он оставляет в/Вар/каче/Апт/арчивес, — это файл блокировки и частичный подкаталог. Команда apt-get clean обычно используется для очистки дискового пространства при необходимости, как правило, в рамках регулярного запланированного обслуживания. Дополнительные сведения см. в разделе [Очистка с помощью apt-get](https://www.networkworld.com/article/3453032/cleaning-up-with-apt-get.html).
1. `sudo apt-get autoclean`

    Параметр APT-GET reclean, например apt-get clean, очищает локальный репозиторий полученных файлов пакета, но удаляет только те файлы, которые больше не могут быть загружены и не являются полезными. Это помогает избежать слишком большого размера кэша.
1. `sudo apt-get autoremove1`

    Параметр Автоматическое удаление удаляет пакеты, которые были установлены автоматически, поскольку некоторые другие пакеты требуют их, но при удалении этих пакетов они больше не нужны.
1. `sudo docker image ls` — Предоставляет список образов DOCKER в пограничной системе.
1. `sudo docker system prune`

    DOCKER принимает консервативный подход к очистке неиспользуемых объектов (часто называемых "сборкой мусора"), таких как образы, контейнеры, тома и сети. Эти объекты обычно не удаляются, если только вы явно не запрашиваете DOCKER. Это может привести к тому, что DOCKER будет использовать дополнительное место на диске. Для каждого типа объекта DOCKER предоставляет команду очистки. Кроме того, можно использовать очистку системы DOCKER для очистки нескольких типов объектов одновременно. Дополнительные сведения см. в статье об [очистке неиспользуемых объектов DOCKER](https://docs.docker.com/config/pruning/).
1. `sudo docker rmi REPOSITORY:TAG`

    По мере обновления в модуле ребра в DOCKER могут присутствовать старые версии модуля ребра. В этом случае рекомендуется использовать команду DOCKER RMI для удаления определенных образов, определенных тегом версии образа.

## <a name="next-steps"></a>Дальнейшие действия

[Краткое руководство. Начало работы. Общие сведения об Аналитике видеотрансляции в IoT Edge](get-started-detect-motion-emit-events-quickstart.md)
