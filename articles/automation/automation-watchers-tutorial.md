---
title: Отслеживание обновленных файлов с помощью задачи наблюдателя службы автоматизации Azure
description: В этой статье объясняется, как создать задачу наблюдателя в учетной записи службы автоматизации Azure, чтобы отслеживать создание файлов в папке.
services: automation
ms.subservice: process-automation
ms.topic: conceptual
ms.date: 12/17/2020
ms.openlocfilehash: ca4c4013e0044811a5bac8786996761b8a5c45f1
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "97682745"
---
# <a name="track-updated-files-with-a-watcher-task"></a>Отслеживание обновленных файлов с помощью задачи наблюдателя

Служба автоматизации Azure использует задачи наблюдателя для слежения за событиями и активации действий с помощью модулей runbook PowerShell. Задача наблюдателя состоит из двух частей: наблюдателя и действия. Модуль runbook наблюдателя запускается с интервалом, определенным в задаче наблюдателя, и выводит данные в модуль runbook действия.

> [!NOTE]
> Задачи наблюдателя не поддерживаются в Azure для Китая (21Vianet).

> [!IMPORTANT]
> Начиная с мая 2020, рекомендуется использовать Azure Logic Apps — рекомендуемый и поддерживаемый способ наблюдения за событиями, планирования повторяющихся задач и запуска действий. См. статью [Планирование и выполнение повторяющихся автоматизированных задач, процессов и рабочих процессов с помощью Azure Logic Apps](../logic-apps/concepts-schedule-automated-recurring-tasks-workflows.md).

В этой статье описывается создание задачи наблюдателя для отслеживания добавления нового файла в каталог. Вы узнаете, как выполнять следующие задачи:

* Импорт runbook службы "Наблюдатель"
* Создание переменной службы автоматизации
* Создание runbook действия
* Создание задачи службы "Наблюдатель"
* Активация службы "Наблюдатель"
* Изучение выходных данных

## <a name="prerequisites"></a>Предварительные требования

Для выполнения этой статьи требуются следующие условия.

* Подписка Azure. Если у вас ее нет, [активируйте преимущества для подписчиков MSDN](https://azure.microsoft.com/pricing/member-offers/msdn-benefits-details/) или [зарегистрируйте бесплатную учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F).
* [Учетная запись службы автоматизации](./index.yml) для хранения runbook наблюдателя, runbook действия и задачи наблюдателя.
* [Гибридная рабочая роль runbook](automation-hybrid-runbook-worker.md), в которой выполняется задача наблюдателя.
* Модули runbook PowerShell. Модули runbook рабочего процесса PowerShell не поддерживаются задачами наблюдателя.

## <a name="import-a-watcher-runbook"></a>Импорт runbook службы "Наблюдатель"

В этой статье используется модуль Runbook наблюдателя с именем **Watch-NewFile** для поиска новых файлов в каталоге. Runbook службы "Наблюдатель" получает время последней записи в файлы в папке и ищет файлы, для которых это значение не превышает заданный предел.

Вы можете скачать модуль Runbook из [Организации GitHub службы автоматизации Azure](https://github.com/azureautomation).

1. Перейдите на страницу Организации Azure Automation GitHub для [Watch-NewFile.ps1](https://github.com/azureautomation/watcher-action-that-processes-events-triggerd-by-a-watcher-runbook).
2. Чтобы скачать модуль Runbook с сайта GitHub, выберите **код** в правой части страницы, а затем щелкните **скачать ZIP** -файл, чтобы скачать весь код в ZIP-файле.
3. Извлеките содержимое и [Импортируйте модуль Runbook](manage-runbooks.md#import-a-runbook-from-the-azure-portal).

Вы также можете импортировать этот модуль Runbook в учетную запись службы автоматизации на портале, выполнив следующие действия.

1. Откройте учетную запись службы автоматизации и щелкните на странице "Модули Runbook".
2. Щелкните **Обзор коллекции** и в раскрывающемся списке **источник** выберите **GitHub**.
3. Найдите пункт **Watcher runbook** (Модуль runbook наблюдателя), выберите **Watcher runbook that looks for new files in a directory** (Модуль runbook наблюдателя, ищущий новые файлы в каталоге) и щелкните **Импорт**.
4. Укажите имя и описание модуля runbook, затем щелкните **ОК**, чтобы импортировать модуль runbook в учетную запись службы автоматизации.
5. Щелкните **Изменить**, затем щелкните **Опубликовать**. При появлении соответствующего запроса щелкните **Да**, чтобы опубликовать модуль runbook.

## <a name="create-an-automation-variable"></a>Создание переменной службы автоматизации

[Переменная службы автоматизации](./shared-resources/variables.md) используется для хранения меток времени, которые предыдущий модуль считывает и сохраняет из каждого файла.

1. Выберите **Переменные** в разделе **Общие ресурсы**, затем щелкните **+ Добавить переменную**.
1. Введите **Watch-NewFileTimestamp** в поле имя.
1. Выберите тип DateTime (Дата и время).
1. Щелкните **Создать**, чтобы создать переменную службы автоматизации.

## <a name="create-an-action-runbook"></a>Создание runbook действия

Runbook действия используется в задаче службы "Наблюдатель" для работы с данными, передаваемыми в нее из runbook службы "Наблюдатель". Необходимо импортировать предопределенный Runbook действия **Process-NewFile** из [Организации GitHub службы автоматизации Azure](https://github.com/azureautomation).

Чтобы создать runbook действия, сделайте следующее:

1. Перейдите на страницу Организации Azure Automation GitHub для [Process-NewFile.ps1](https://github.com/azureautomation/watcher-action-that-processes-events-triggerd-by-a-watcher-runbook).
2. Чтобы скачать модуль Runbook с сайта GitHub, выберите **код** в правой части страницы, а затем щелкните **скачать ZIP** -файл, чтобы скачать весь код в ZIP-файле.
3. Извлеките содержимое и [Импортируйте модуль Runbook](manage-runbooks.md#import-a-runbook-from-the-azure-portal).

Вы также можете импортировать этот модуль runbook в учетную запись службы автоматизации на портале Azure:

1. Перейдите к своей учетной записи службы автоматизации и в категории **Автоматизация процессов** выберите **Модули Runbook**.
1. Щелкните **Обзор коллекции** и в раскрывающемся списке **источник** выберите **GitHub**.
1. Найдите пункт **Watcher action** (Действие наблюдателя), выберите **Watcher action that processes events triggered by a watcher runbook** (Действие наблюдателя, обрабатывающее события, активированные с помощью runbook наблюдателя) и щелкните **Импорт**.
1. Укажите имя и описание модуля runbook, затем щелкните **ОК**, чтобы импортировать модуль runbook в учетную запись службы автоматизации.
1. Щелкните **Изменить**, затем щелкните **Опубликовать**. При появлении соответствующего запроса щелкните **Да**, чтобы опубликовать модуль runbook.

## <a name="create-a-watcher-task"></a>Создание задачи службы "Наблюдатель"

На этом этапе настраивается задача наблюдателя, указывающая на модуль runbook наблюдателя и модуль runbook действия, определенные в предыдущих разделах.

1. Перейдите к своей учетной записи службы автоматизации и в категории **Автоматизация процессов** выберите **Задачи наблюдателя**.
1. Откройте страницу "Задачи наблюдателя" и щелкните **+ Добавить задачу наблюдателя**.
1. Введите имя **WatchMyFolder**.

1. Щелкните **Настройка наблюдателя** и выберите runbook **Watch-NewFile**.

1. Введите следующие значения параметров.

   * **FOLDERPATH** (Путь к папке). Папка в гибридной рабочей роли Runbook, где создаются файлы, например **d:\examplefiles**.
   * **EXTENSION** (Расширение). Расширение для конфигурации. Оставьте поле пустым, чтобы обрабатывались все расширения файлов.
   * **RECURSE** (Рекурсия). Рекурсивная операция. Оставьте это значение в качестве значения по умолчанию.
   * **RUN SETTINGS** (Параметры запуска). Настройка для запуска модуля runbook. Выберите гибридную рабочую роль.

1. Щелкните **ОК**, а затем **Выбрать**, чтобы вернуться на страницу "Наблюдатель".
1. Щелкните **Настройка действия** и выберите runbook с именем **Process-NewFile**.
1. Введите следующие значения параметров.

   * **EVENTDATA** (Данные событий). Не указывайте. Данные передаются из runbook наблюдателя.
   * **RUN SETTINGS** (Параметры запуска). Настройка для запуска модуля runbook. Оставьте значение "Azure", так как этот модуль runbook выполняется в службе автоматизации Azure.

1. Щелкните **ОК**, а затем **Выбрать**, чтобы вернуться на страницу "Наблюдатель".
1. Нажмите кнопку **ОК**, чтобы создать задачу службы "Наблюдатель".

    ![Настройка действия службы "Наблюдатель" с помощью пользовательского интерфейса](media/automation-watchers-tutorial/watchertaskcreation.png)

## <a name="trigger-a-watcher"></a>Активация службы "Наблюдатель"

Выполните описанный ниже тест, чтобы убедиться, что задача наблюдателя работает должным образом. 

1. Установите удаленное подключение к гибридной рабочей роли Runbook.
2. Откройте **PowerShell** и создайте тестовый файл в папке.

```azurepowerShell-interactive
New-Item -Name ExampleFile1.txt
```

В следующем примере показаны ожидаемые выходные данные.

```output
    Directory: D:\examplefiles


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----       12/11/2017   9:05 PM              0 ExampleFile1.txt
```

## <a name="inspect-the-output"></a>Изучение выходных данных

1. Перейдите к своей учетной записи службы автоматизации и в категории **Автоматизация процессов** выберите **Задачи наблюдателя**.
1. Щелкните задачу наблюдателя с именем **WatchMyFolder**.
1. Щелкните **Просмотреть потоки наблюдателей** в разделе **Потоки**, чтобы убедиться, что наблюдатель обнаружил новый файл и запустил модуль runbook действия.
1. Щелкните **Просмотреть задания действий наблюдателя**, чтобы просмотреть задания модуля runbook действия. Вы можете выбрать любое задание, чтобы просмотреть сведения о нем.

   ![Задания действия службы "Наблюдатель" в пользовательском интерфейсе](media/automation-watchers-tutorial/WatcherActionJobs.png)

Ожидаемые выходные данные при обнаружении нового файла можно увидеть в следующем примере.

```output
Message is Process new file...

Passed in data is @{FileName=D:\examplefiles\ExampleFile1.txt; Length=0}
```

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о создании собственного модуля Runbook см. в статье [Создание модуля Runbook PowerShell](learn/automation-tutorial-runbook-textual-powershell.md).
