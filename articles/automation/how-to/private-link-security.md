---
title: Безопасное подключение сетей к службе автоматизации Azure с помощью частной ссылки Azure
description: Безопасное подключение сетей к службе автоматизации Azure с помощью частной ссылки Azure
author: mgoedtel
ms.author: magoedte
ms.topic: conceptual
ms.date: 12/11/2020
ms.subservice: ''
ms.openlocfilehash: f3c9197faaae89e0ffb238f987ee66dafea8abdd
ms.sourcegitcommit: e559daa1f7115d703bfa1b87da1cf267bf6ae9e8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/17/2021
ms.locfileid: "100579804"
---
# <a name="use-azure-private-link-to-securely-connect-networks-to-azure-automation"></a>Безопасное подключение сетей к службе автоматизации Azure с помощью частной ссылки Azure

Частная конечная точка Azure — это сетевой интерфейс, который защищенно и надежно подключается к службе через Приватный канал Azure. Частная конечная точка использует частный IP-адрес из виртуальной сети, фактически передавая службу автоматизации в виртуальную сеть. Сетевой трафик между компьютерами в виртуальной сети и учетной записью службы автоматизации проходит по виртуальной сети и частной ссылке на магистральную сеть Майкрософт, что устраняет уязвимость в общедоступном Интернете.

Например, имеется виртуальная сеть, в которой отключен исходящий доступ к Интернету. Тем не менее вы хотите получить доступ к учетной записи службы автоматизации в частном порядке и использовать такие функции автоматизации, как веб-перехватчики, конфигурация состояния и задания Runbook в гибридных рабочих ролях Runbook. Кроме того, требуется, чтобы пользователи имели доступ к учетной записи службы автоматизации только через виртуальную сеть.  Развертывание частной конечной точки достигает этих целей.

В этой статье описывается, когда использовать и как настроить частную конечную точку с учетной записью службы автоматизации.

![Общие сведения о закрытой ссылке для службы автоматизации Azure](./media/private-link-security/private-endpoints-automation.png)

>[!NOTE]
> Поддержка закрытых ссылок в службе автоматизации Azure доступна только в коммерческих облаках Azure и в облаке государственных организаций США.

## <a name="advantages"></a>Преимущества

Приватный канал предоставляет следующие возможности:

- Подключайтесь к службе автоматизации Azure в частном порядке, не открывая доступ к общедоступной сети.
- Подключайтесь в частном порядке для Azure Monitor Log Analytics рабочей области, не открывая доступ к общедоступной сети.

    >[!NOTE]
    >Отдельная частная конечная точка для Log Analytics рабочей области требуется, если учетная запись службы автоматизации связана с Log Analytics рабочей областью для пересылки данных задания, а также при включении таких функций, как Управление обновлениями, Отслеживание изменений и Инвентаризация, конфигурация состояния или Запуск и остановка виртуальных машин в нерабочее время. Дополнительные сведения о закрытой ссылке для Azure Monitor см. [в статье Использование частной связи Azure для безопасного подключения сетей к Azure Monitor](../../azure-monitor/logs/private-link-security.md).

- Обеспечьте доступ к данным службы автоматизации только через разрешенные частные сети.
- Запретите утечка данных из частных сетей, определив ресурс службы автоматизации Azure, который подключается через вашу закрытую конечную точку.
- Безопасное подключение частной локальной сети к службе автоматизации Azure с помощью ExpressRoute и частной связи.
- Хранить весь трафик в Microsoft Azure магистральной сети.

Дополнительные сведения см. в разделе [Основные преимущества Приватного канала](../../private-link/private-link-overview.md#key-benefits).

## <a name="limitations"></a>Ограничения

- В текущей реализации частной связи облачные задания учетной записи службы автоматизации не могут получить доступ к ресурсам Azure, защищенным с помощью частной конечной точки. Например, Azure Key Vault, Azure SQL, учетная запись хранения Azure и т. д. Чтобы решить эту проблему, используйте [гибридную рабочую роль Runbook](../automation-hybrid-runbook-worker.md) .
- Необходимо использовать последнюю версию [агента log Analytics](../../azure-monitor/agents/log-analytics-agent.md) для Windows или Linux.
- [Шлюз log Analytics](../../azure-monitor/agents/gateway.md) не поддерживает закрытую связь.

## <a name="how-it-works"></a>Принцип работы

Частная ссылка службы автоматизации Azure подключает одну или несколько частных конечных точек (и, следовательно, виртуальных сетей, которые они содержат) к ресурсу учетной записи службы автоматизации. Эти конечные точки являются машинами, которые используют веб-перехватчики для запуска модуля Runbook, компьютеров, на которых размещаются Гибридная Рабочая роль Runbook и узлы с конфигурацией требуемого состояния (DSC).

После создания частных конечных точек для службы автоматизации каждый из общедоступных URL-адресов автоматизации сопоставляется с одной частной конечной точкой в виртуальной сети. Вы или компьютер можете напрямую обратиться к URL-адресам автоматизации.

### <a name="webhook-scenario"></a>Сценарий веб-перехватчика

Вы можете запускать модули Runbook, выполняя POST по URL-адресу перехватчика. Например, URL-адрес выглядит следующим образом: `https://<automationAccountId>.webhooks.<region>.azure-automation.net/webhooks?token=gzGMz4SMpqNo8gidqPxAJ3E%3d`

### <a name="hybrid-runbook-worker-scenario"></a>Сценарий гибридной рабочей роли Runbook

Функция гибридной рабочей роли Runbook пользователя в службе автоматизации Azure позволяет запускать модули Runbook непосредственно на компьютере с Azure или без Azure, включая серверы, зарегистрированные на серверах с поддержкой дуги Azure. С компьютера или сервера, на котором размещается роль, можно запускать модули Runbook непосредственно на ней и для ресурсов в среде, чтобы управлять этими локальными ресурсами.

Конечная точка ЖРДС используется гибридной рабочей ролью для запуска и завершения модулей Runbook, загрузки модулей Runbook в рабочую роль и отправки потока журнала заданий в службу автоматизации.После включения конечной точки ЖРДС URL-адрес будет выглядеть следующим образом: `https://<automationaccountID>.jobruntimedata.<region>.azure-automation.net` . Это обеспечит возможность выполнения Runbook в гибридной рабочей роли, подключенной к виртуальной сети Azure, для выполнения заданий без необходимости открывать исходящее подключение к Интернету.  

> [!NOTE]
>Текущая реализация частных ссылок для службы автоматизации Azure поддерживает только выполнение заданий в гибридной рабочей роли Runbook, подключенной к виртуальной сети Azure и не поддерживающей облачные задания.

## <a name="hybrid-worker-scenario-for-update-management"></a>Сценарий гибридной рабочей роли для Управление обновлениями  

Гибридная система Runbook Worker поддерживает набор скрытых модулей Runbook, используемых компонентом Управление обновлениями, предназначенным для установки указанных пользователем обновлений на компьютерах под управлением Windows и Linux. Если включена служба автоматизации Azure Управление обновлениями, любой компьютер, подключенный к рабочей области Log Analytics, автоматически настраивается в качестве системы Гибридная Рабочая роль Runbook.

Чтобы понять, & настроить Управление обновлениями обзор [Управление обновлениями](../update-management/overview.md). Управление обновлениями функция зависит от Log Analytics рабочей области и поэтому требует связывания рабочей области с учетной записью службы автоматизации. В Log Analytics рабочей области хранятся данные, собранные решением, и размещаются его поиск и представления журналов.

Если вы хотите, чтобы компьютеры, настроенные для управления обновлениями, могли подключаться к службе автоматизации & Log Analytics рабочей области по безопасному каналу, необходимо включить закрытую ссылку для рабочей области Log Analytics, связанной с учетной записью службы автоматизации, настроенной с помощью частного канала.

С помощью действий, описанных в разделе [настройка log Analytics](../../azure-monitor/logs/private-link-security.md#configure-log-analytics), можно управлять доступом к log Analytics рабочей области за пределами области действия закрытой связи. Если задать значение **Нет** для параметра **Allow public network access for ingestion** (Разрешить доступ из общедоступных сетей для приема), то компьютеры за пределами подключенных областей не смогут отправлять данные в эту рабочую область. Если задать значение **Нет** для параметра **Allow public network access for queries** (Разрешить доступ из общедоступных сетей для запросов), то компьютеры за пределами областей не смогут обращаться к данным в этой рабочей области.

Используйте целевой вспомогательный ресурс **дскандхибридворкер** , чтобы включить закрытую ссылку для пользовательских & системных гибридных рабочих ролей.

> [!NOTE]
> Компьютеры, размещенные за пределами Azure, которые управляются Управление обновлениями и подключены к виртуальной сети Azure через частный пиринг ExpressRoute, VPN-туннели и одноранговые виртуальные сети, использующие частные конечные точки, поддерживают закрытую ссылку.

### <a name="state-configuration-agentsvc-scenario"></a>Сценарий настройки состояния (agentsvc)

Конфигурация состояния предоставляет службу управления конфигурацией Azure, которая позволяет создавать, управлять и компилировать конфигурации Desired State Configuration (DSC) для узлов в любом облачном или локальном центре обработки данных.

Агент на компьютере регистрируется в службе DSC, а затем использует конечную точку службы для извлечения конфигурации DSC. Конечная точка службы агента выглядит следующим образом: `https://<automationAccountId>.agentsvc.<region>.azure-automation.net` .

URL-адрес общедоступной конечной точки открытого & будет таким же, но он будет сопоставлен с частным IP-адресом, если включена частная ссылка.

## <a name="planning-based-on-your-network"></a>Планирование с учетом сети

Перед настройкой ресурса учетной записи службы автоматизации учитывайте требования к изоляции сети. Оцените доступ виртуальных сетей к общедоступному Интернету и ограничения доступа к учетной записи службы автоматизации (включая настройку области частной группы ссылок для Azure Monitor журналов, если они интегрированы с учетной записью службы автоматизации). Также включите проверку [записей DNS](./automation-region-dns-records.md) службы автоматизации в рамках плана, чтобы обеспечить работу поддерживаемых функций без проблем.

### <a name="connect-to-a-private-endpoint"></a>Подключение к частной конечной точке

Создайте частную конечную точку для подключения к нашей сети. Его можно создать в [портал Azure частном центре ссылок](https://portal.azure.com/#blade/Microsoft_Azure_Network/PrivateLinkCenterBlade/privateendpoints). После применения изменений в Публикнетворкакцесс и закрытой ссылке может пройти до 35 минут, чтобы они вступили в силу.

В этом разделе вы создадите закрытую конечную точку для учетной записи службы автоматизации.

1. В верхней левой части экрана выберите **создать ресурс > сети > закрытый центр ссылок**.

2. В окне **Private Link Center — Overview** (Центр приватных каналов — общие сведения) для варианта **Build a private connection to a service** (Создание частного подключения к службе) выберите **Начать**.

3. В статье **Создание виртуальной машины — основы** введите или выберите следующие сведения.

    | Параметр | Значение |
    | ------- | ----- |
    | **Сведения о проекте** | |
    | Подписка | Выберите свою подписку. |
    | Группа ресурсов | Выберите **myResourceGroup**. Вы создали ее в предыдущем разделе.  |
    | **Подробности об экземпляре** |  |
    | Имя | Введите свой *приватиндпоинт*. |
    | Регион | Выберите **йоуррегион**. |
    |||

4. По завершении выберите **Next: Ресурс**.

5. В окне **Создание частной конечной точки — ресурс** введите или выберите следующие сведения:

    | Параметр | Значение |
    | ------- | ----- |
    |Метод подключения  | Выберите "подключиться к ресурсу Azure в моем каталоге".|
    | Подписка| Выберите свою подписку. |
    | Тип ресурса | Выберите **Microsoft. Automation/automationAccounts**. |
    | Ресурс |Выбор *мяутоматионаккаунт*|
    |Целевой подресурс |Выберите веб- *перехватчик* или *дскандхибридворкер* в зависимости от вашего сценария.|
    |||

6. По завершении выберите **Next: Конфигурация**.

7. В окне **Создание частной конечной точки — конфигурация** введите или выберите следующие сведения.

    | Параметр | Значение |
    | ------- | ----- |
    |**СЕТИ**| |
    | Виртуальная сеть| Выберите *MyVirtualNetwork*. |
    | Подсеть | Выберите *mySubnet*. |
    |**ЧАСТНАЯ ИНТЕГРАЦИЯ DNS**||
    |Интеграция с частной зоной DNS |Выберите **Да**. |
    |Частная зона DNS |Выберите *(создать) привателинк. Azure-Automation.NET* |
    |||

8. Выберите **Review + create** (Просмотреть и создать). Вы будете перенаправлены на страницу **Просмотр и создание**, где Azure проверит вашу конфигурацию.

9. При появлении сообщения **Проверка пройдена** нажмите кнопку **Создать**.

В **частном центре ссылок** выберите **частные конечные точки** , чтобы просмотреть ресурс закрытой ссылки.

![Частная ссылка на ресурс службы автоматизации](./media/private-link-security/private-link-automation-resource.png)

Выберите ресурс, чтобы просмотреть все сведения. При этом создается частная конечная точка для учетной записи службы автоматизации и назначается частный IP-адрес из виртуальной сети. **Состояние подключения** отображается как **утверждено**.

Аналогичным образом создается уникальное полное доменное имя (FQDN) для конфигурации состояния (agentsvc) и для среды выполнения задания гибридной рабочей роли Runbook (жрдс). Каждому из них назначается отдельный IP-адрес из виртуальной сети, а **состояние подключения** отображается как **утвержденное**.

Если потребитель службы имеет разрешения RBAC Azure для ресурса автоматизации, он может выбрать метод автоматического утверждения. В этом случае, когда запрос достигает ресурса поставщика автоматизации, никаких действий от поставщика услуг не требуется, и подключение автоматически утверждается.

## <a name="set-public-network-access-flags"></a>Установка флагов доступа к общедоступной сети

Можно настроить учетную запись службы автоматизации для запрета всех общедоступных конфигураций и разрешить подключения только через частные конечные точки для дальнейшего повышения безопасности сети. Если вы хотите ограничить доступ к учетной записи службы автоматизации только в пределах виртуальной сети и запретить доступ из Интернета, можно задать `publicNetworkAccess` для свойства значение `$false` .

Если параметр **доступа к общедоступной сети** имеет значение `$false` , разрешены только соединения через частные конечные точки, а все подключения через общедоступные конечные точки отклоняются с несанкционированным сообщением об ошибке и состоянием HTTP 401.

В следующем сценарии PowerShell показано, как `Get` и `Set` свойство **доступа к общедоступной сети** на уровне учетной записи службы автоматизации.

```powershell
$account = Get-AzResource -ResourceType Microsoft.Automation/automationAccounts -ResourceGroupName "<resourceGroupName>" -Name "<automationAccountName>" -ApiVersion "2020-01-13-preview"
$account.Properties | Add-Member -Name 'publicNetworkAccess' -Type NoteProperty -Value $false
$account | Set-AzResource -Force -ApiVersion "2020-01-13-preview"
```

Можно также управлять свойством доступа к общедоступной сети из портал Azure. В учетной записи службы автоматизации выберите **Сетевая изоляция** в левой области в разделе **Параметры учетной записи** . Если для параметра доступ к общедоступной сети задано значение **нет**, разрешены только соединения через частные конечные точки, а все соединения через общедоступные конечные точки отклоняются.

![Настройка доступа к общедоступной сети](./media/private-link-security/allow-public-network-access.png)

## <a name="dns-configuration"></a>Настройка DNS

При подключении к ресурсу Приватного канала с использованием полного доменного имени (FQDN) в строке подключения важно правильно настроить параметры DNS, чтобы разрешить доступ к выделенному частному IP-адресу. Возможно, существующие службы Azure уже используют конфигурацию DNS для подключения через общедоступную конечную точку. Конфигурацию DNS следует проверить и обновить для подключения с помощью частной конечной точки.

Сетевой интерфейс, связанный с частной конечной точкой, содержит полный набор сведений, необходимых для настройки DNS, включая полное доменное имя и частные IP-адреса, выделенные для конкретного ресурса Приватного канала.

Чтобы настраивать параметры DNS для частных конечных точек, можно использовать следующие варианты.

* Использовать файл узла (рекомендуется только для тестирования). С помощью файла узла на виртуальной машине можно сначала переопределить использование DNS для разрешения имен. Запись DNS должна выглядеть, как в следующем примере: `privatelinkFQDN.jrds.sea.azure-automation.net` .

* Используйте [частную зону DNS](../../dns/private-dns-privatednszone.md). Чтобы переопределить разрешение DNS для определенной частной конечной точки, можно использовать частные зоны DNS. Частная зона DNS может быть связана с вашей виртуальной сетью для разрешения конкретных доменов. Чтобы агент на виртуальной машине мог взаимодействовать через частную конечную точку, создайте запись Частная зона DNS как `privatelink.azure-automation.net` . Добавьте новое сопоставление записи *a* DNS с IP-адресом частной конечной точки.

* Использовать DNS-сервер пересылки (необязательно). Чтобы переопределить разрешение DNS для определенного ресурса Приватного канала, можно использовать DNS-сервер пересылки. Если [DNS-сервер](../../virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances.md#name-resolution-that-uses-your-own-dns-server) размещен в виртуальной сети, можно создать правило переадресации DNS, чтобы использовать частную зону DNS для упрощения настройки для всех ресурсов частной связи.

Дополнительные сведения см. в разделе [Конфигурация DNS для частной конечной точки Azure](../../private-link/private-endpoint-dns.md).

## <a name="next-steps"></a>Дальнейшие шаги

Дополнительные сведения о частных конечных точках см. в статье [что такое частная конечная точка Azure?](../../private-link/private-endpoint-overview.md).