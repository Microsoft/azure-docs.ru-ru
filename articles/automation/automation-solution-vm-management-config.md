---
title: Настройка запуска и остановки виртуальных машин в нерабочее время в службе автоматизации Azure
description: В этой статье рассказывается, как настроить функцию запуска и остановки виртуальных машин в нерабочее время для поддержки различных вариантов использования или сценариев.
services: automation
ms.subservice: process-automation
ms.date: 06/01/2020
ms.topic: conceptual
ms.openlocfilehash: b52b51133f059f028baf470515e886d17077af6a
ms.sourcegitcommit: e559daa1f7115d703bfa1b87da1cf267bf6ae9e8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/17/2021
ms.locfileid: "100593936"
---
# <a name="configure-startstop-vms-during-off-hours"></a>Настройка запуска и остановки виртуальных машин в нерабочее время

В этой статье рассказывается, как настроить функцию [Запуск и остановка виртуальных машин в нерабочее время](automation-solution-vm-management.md) для поддержки описываемых сценариев. Вы также можете узнать о следующем:

* [Настройка уведомлений по электронной почте](#configure-email-notifications)
* [Добавление виртуальной машины](#add-a-vm)
* [Исключение виртуальной машины](#exclude-a-vm)
* [Изменение расписаний запуска и завершения работы](#modify-the-startup-and-shutdown-schedules)

## <a name="scenario-1-startstop-vms-on-a-schedule"></a><a name="schedule"></a>Сценарий 1. Запуск и остановка виртуальных машин по расписанию

Это конфигурация по умолчанию, используемая после первого развертывания функции запуска и остановки виртуальных машин в нерабочее время. Например, эту функцию можно настроить, чтобы останавливать все виртуальные машины в подписке вечером, когда вы уходите с работы, и запускать их утром, когда вы возвращаетесь в офис. Если настроить расписания **Scheduled-StartVM** и **Scheduled-StopVM** во время развертывания, они будут запускать и останавливать целевые виртуальные машины. 

Можно настроить эту функцию только для остановки виртуальных машин. Ознакомьтесь с разделом [Изменение расписаний запуска и остановки](#modify-the-startup-and-shutdown-schedules), чтобы узнать, как настроить пользовательское расписание.

> [!NOTE]
> Эта функция использует часовой пояс, указанный при настройке параметра времени расписания. Однако служба автоматизации Azure хранит его у себя в формате UTC. Нет необходимости преобразовывать часовой пояс, так как это делается во время развертывания виртуальной машины.

Чтобы управлять виртуальными машинами в области, настройте переменные: `External_Start_ResourceGroupNames`, `External_Stop_ResourceGroupNames`и `External_ExcludeVMNames`.

Действие можно нацелить или на подписку и группу ресурсов, или на определенный список виртуальных машин.

### <a name="target-the-start-and-stop-actions-against-a-subscription-and-resource-group"></a>Нацеливание действий Start и Stop на подписку и группу ресурсов

1. Настройте переменные `External_Stop_ResourceGroupNames` и `External_ExcludeVMNames`, чтобы указывать целевые виртуальные машины.

2. Включите и обновите расписания **Scheduled-StartVM** и **Scheduled-StopVM**.

3. Запустите runbook **ScheduledStartStop_Parent**, указав для параметра **ACTION** значение **start**, а для параметра **WHATIF** — значение True, чтобы воспользоваться предварительным просмотром изменений.

### <a name="target-the-start-and-stop-action-by-vm-list"></a>Нацеливание действий Start и Stop на список виртуальных машин

1. Запустите модуль Runbook **ScheduledStartStop_Parent** с параметром **действие** **Запуск**.

2. Добавьте разделенный запятыми список виртуальных машин (без пробелов) в поле параметра **VMList** . Пример списка — `vm1,vm2,vm3` .

3. Задайте для поля параметра **WHATIF** значение true, чтобы просмотреть изменения.

4. Настройте `External_ExcludeVMNames` переменную с помощью разделенного запятыми списка виртуальных машин (VM1, VM2, VM3) без пробелов между значениями, разделенными запятыми.

5. Этот сценарий не учитывает переменные `External_Start_ResourceGroupNames` и `External_Stop_ResourceGroupnames`. Для этого сценария требуется создать собственное расписание службы автоматизации. Дополнительные сведения см. в разделе [Создание расписания для runbook в службе автоматизации Azure](shared-resources/schedules.md).

    > [!NOTE]
    > Значение для **Целевых имен ResourceGroup** хранится в виде значений как для `External_Start_ResourceGroupNames`, так и для `External_Stop_ResourceGroupNames`. Чтобы увеличить степень детализации, можно изменить эти переменные для различных групп ресурсов. Для действия запуска используйте `External_Start_ResourceGroupNames`и используйте `External_Stop_ResourceGroupNames` для действия остановки. Виртуальные машины автоматически добавляются в расписания запуска и остановки.

## <a name="scenario-2-startstop-vms-in-sequence-by-using-tags"></a><a name="tags"></a>Сценарий 2. Последовательный запуск и остановка виртуальных машин с использованием тегов

В среде, которая включает в себя два или более компонентов, работающих на нескольких виртуальных машинах, которые поддерживают распределенную рабочую нагрузку, важно наличие поддержки последовательного запуска и остановки компонентов в нужном порядке. 

### <a name="target-the-start-and-stop-actions-against-a-subscription-and-resource-group"></a>Нацеливание действий Start и Stop на подписку и группу ресурсов

1. Добавьте `sequencestart` и тег `sequencestop` с положительными целочисленными значениями в виртуальные машины, на которые нацелены переменные `External_Start_ResourceGroupNames` и `External_Stop_ResourceGroupNames`. Действия запуска и остановки будут выполняться в порядке возрастания. Чтобы узнать, как добавить тег к виртуальной машине, ознакомьтесь с разделами [Пометка виртуальной машины Windows в Azure](../virtual-machines/tag-portal.md) и [Пометка виртуальной машины Linux в Azure](../virtual-machines/tag-cli.md).

2. Измените расписания **Sequenced-StartVM** и **Sequenced-StopVM**, указав даты и время в соответствии со своими требованиями, после чего включите эти расписания.

3. Запустите runbook **SequencedStartStop_Parent**, указав для параметра **ACTION** значение **start**, а для параметра **WHATIF** — значение True, чтобы воспользоваться предварительным просмотром изменений.

4. Просмотрите действие и внесите необходимые изменения перед его реализацией для рабочих виртуальных машин. Когда все будет готово, можно будет вручную запустить runbook с параметром, имеющим значение **False**. Можно также позволить автоматический запуск расписаний службы автоматизации **Sequenced-StartVM** и **Sequenced-StopVM**, которые вы задали.

### <a name="target-the-start-and-stop-actions-by-vm-list"></a>Нацеливание действий запуска и остановки на список виртуальных машин

1. Добавьте `sequencestart` и тег `sequencestop` с положительными целочисленными значениями в виртуальные машины, которые планируете добавить к параметру `VMList`.

2. Запустите модуль Runbook **SequencedStartStop_Parent** с параметром **действие** **Запуск**.

3. Добавьте разделенный запятыми список виртуальных машин (без пробелов) в поле параметра **VMList** . Пример списка — `vm1,vm2,vm3` .

4. Задайте для параметра **WHATIF** значение true, чтобы просмотреть изменения. 

5. Настройте `External_ExcludeVMNames` переменную с разделенным запятыми списком виртуальных машин без пробелов между значениями, разделенными запятыми.

6. Этот сценарий не учитывает переменные `External_Start_ResourceGroupNames` и `External_Stop_ResourceGroupnames`. Для этого сценария требуется создать собственное расписание службы автоматизации. Дополнительные сведения см. в разделе [Создание расписания для runbook в службе автоматизации Azure](shared-resources/schedules.md).

7. Просмотрите действие и внесите необходимые изменения перед его реализацией для рабочих виртуальных машин. Когда все будет готово, вручную выполните **monitoring-and-diagnostics/monitoring-action-groupsrunbook** с параметром, для которого установлено значение **False**. Кроме того, можно позволить расписаниям службы автоматизации **Sequenced-StartVM** и **Sequenced-StopVM** запускаться автоматически после определенного вами расписания.

## <a name="scenario-3-start-or-stop-automatically-based-on-cpu-utilization"></a><a name="cpuutil"></a>Сценарий 3. Автоматический запуск и остановка на основе загрузки ЦП

Запуск и остановка виртуальных машин в нерабочее время поможет снизить затраты на использование Azure Resource Manager и классических виртуальных машин в подписке, путем выявления виртуальных машин Azure, которые не используются в периоды небольшой нагрузки, например в нерабочее время, и автоматически завершая их работу в случае, если процент использования процессора меньше указанного.

По умолчанию эта функция предварительно настроена для оценки метрики "Загрузка ЦП", и оно проверяет, составляет ли средняя загрузка 5 % или меньше. Для управления сценарием используются следующие переменные, которые можно изменить, если их значения по умолчанию не удовлетворяют вашим требованиям:

* `External_AutoStop_MetricName`
* `External_AutoStop_Threshold`
* `External_AutoStop_TimeAggregationOperator`
* `External_AutoStop_TimeWindow`
* `External_AutoStop_Frequency`
* `External_AutoStop_Severity`

Действие можно включить и нацелить на подписку и группу ресурсов или на определенный список виртуальных машин.

При запуске модуля Runbook **AutoStop_CreateAlert_Parent** он проверяет, существуют ли целевая подписка, группы ресурсов и виртуальные машины. Если виртуальные машины существуют, модуль runbook вызывает runbook **AutoStop_CreateAlert_Child** для каждой виртуальной машины, проверенной родительским модулем runbook. Дочерний runbook:

* создает правило генерации оповещений метрик для каждой проверенной виртуальной машины.
* Запускает runbook **AutoStop_VM_Child** для конкретной виртуальной машины, если ЦП падает ниже заданного порогового значения для указанного интервала времени. 
* Пытается прерывать работу виртуальной машины.

### <a name="target-the-autostop-action-against-all-vms-in-a-subscription"></a>Нацеливает действие автозавершения на все виртуальные машины в подписке

1. Убедитесь, что переменная `External_Stop_ResourceGroupNames` пуста или имеет значение * (подстановочный знак).

2. (Необязательно.) Если требуется исключить некоторые виртуальные машины из действия автозавершения, можно добавить разделенный запятыми список имен виртуальных машин в переменную `External_ExcludeVMNames`.

3. Включите выполнение расписания **Schedule_AutoStop_CreateAlert_Parent**, чтобы создать необходимые правила генерации оповещений метрик остановки виртуальной машины для всех виртуальных машин в подписке. Выполнение этого типа расписания позволяет создавать новые правила генерации оповещений метрик по мере добавления новых виртуальных машин в подписку.

### <a name="target-the-autostop-action-against-all-vms-in-a-resource-group-or-multiple-resource-groups"></a>Назначение действия автозавершения для всех виртуальных машин в группе ресурсов или нескольких группах ресурсов

1. Добавьте разделенный запятыми список имен групп ресурсов в переменную `External_Stop_ResourceGroupNames`.

2. Если требуется исключить некоторые виртуальные машины из автозавершения, можно добавить разделенный запятыми список имен виртуальных машин в переменную `External_ExcludeVMNames`.

3. Включите выполнение расписания **Schedule_AutoStop_CreateAlert_Parent**, чтобы создать необходимые правила генерации оповещений метрик остановки виртуальной машины для всех виртуальных машин в группах ресурсов. Выполнение этой операции по расписанию позволяет создавать новые правила генерации оповещений метрик по мере добавления новых виртуальных машин в группы ресурсов.

### <a name="target-the-autostop-action-to-a-list-of-vms"></a>Назначение действия автозавершения для списка виртуальных машин

1. Создайте новое [расписание](shared-resources/schedules.md#create-a-schedule) и свяжите его с runbook **модулем AutoStop_CreateAlert_Parent**, добавив разделенный запятыми список имен виртуальных машин в параметр `VMList`.

2. Кроме того, если вы хотите исключить некоторые виртуальные машины из действия автозавершения, можно добавить в переменную разделенный запятыми список имен виртуальных машин (без пробелов) `External_ExcludeVMNames` .

## <a name="configure-email-notifications"></a>Настройка уведомлений по электронной почте

Чтобы изменить уведомления по электронной почте после развертывания запуска и остановки виртуальных машин в нерабочее время, можно изменить группу действий, созданную во время развертывания.  

> [!NOTE]
> Подписки в облаке Azure для государственных организаций не поддерживают функцию электронной почты этого компонента.

1. На портале Azure выберите **Монитор** > **Группы действий**. Выберите группу действий под названием **StartStop_VM_Notication**.

    :::image type="content" source="media/automation-solution-vm-management/azure-monitor.png" alt-text="Снимок экрана со страницей &quot;монитор — группы действий&quot;.":::

2. На странице StartStop_VM_Notification в разделе **Сведения** щелкните **Изменить сведения**. Откроется страница "Электронная почта, SMS, push-уведомление, голосовой вызов". Измените адрес электронной почты и нажмите кнопку **ОК**, чтобы сохранить изменения.

    :::image type="content" source="media/automation-solution-vm-management/change-email.png" alt-text="Снимок экрана: страница электронной почты, SMS/Push/Voice с примером обновленного адреса электронной почты.":::

    Кроме того, можно добавить дополнительные действия в группу действий. Дополнительные сведения о группах действий см. в статье [Группы действий](../azure-monitor/alerts/action-groups.md)

Ниже приведен пример сообщения электронной почты, которое отправляется, когда функция завершает работу виртуальных машин.

:::image type="content" source="media/automation-solution-vm-management/email.png" alt-text="Снимок экрана примера сообщения электронной почты, отправленного при завершении работы компонента виртуальными машинами.":::

## <a name="add-or-exclude-vms"></a><a name="add-exclude-vms"></a>Добавление и исключение виртуальных машин

Эта функция позволяет добавлять целевые или исключенные виртуальные машины. 

### <a name="add-a-vm"></a>Добавление виртуальной машины

Существует два способа обеспечения включения виртуальной машины в одну из этих категорий при запуске функции:

* Каждый из родительских [модулей runbook](automation-solution-vm-management.md#runbooks) функции имеет параметр `VMList`. Можно передать разделенный запятыми список имен виртуальных машин (без пробелов) в этот параметр при планировании соответствующего родительского модуля Runbook для вашей ситуации, и эти виртуальные машины будут включаться при запуске компонента.

* Чтобы выбрать несколько виртуальных машин, задайте `External_Start_ResourceGroupNames` и `External_Stop_ResourceGroupNames` с именами групп ресурсов, которые содержат виртуальные машины, которые требуется запустить или остановить. Вы также можете указать для этих параметров значение `*`, чтобы запустить решение для всех групп ресурсов в подписке.

### <a name="exclude-a-vm"></a>Исключение виртуальной машины

Чтобы исключить виртуальную машину из числа подлежащих остановке или запуску в нерабочее время, можно добавить ее имя в переменную `External_ExcludeVMNames`. Эта переменная представляет собой разделенный запятыми список конкретных виртуальных машин (без пробелов), которые следует исключить из компонента. В этом списке можно использовать до 140 виртуальных машин. Если в список, разделенный запятыми, будет добавлено более 140 виртуальных машин, то те, которые необходимо исключить, могут начать запускаться или останавливаться в случайном порядке.

## <a name="modify-the-startup-and-shutdown-schedules"></a>Изменение расписаний запуска и завершения работы

Действия по управлению расписанием запуска и завершения работы в этой функции аналогичны описанным в статье [Создание расписания для runbook в службе автоматизации Azure](shared-resources/schedules.md). Для запуска и остановки виртуальных машин требуются отдельные расписания.

Поддерживается настройка функции только для остановки виртуальных машин в определенное время. В этом сценарии вы просто создаете расписание остановки без расписания запуска. 

1. Убедитесь, что вы добавили группы ресурсов для виртуальных машин, работу которых нужно завершить, в переменной `External_Stop_ResourceGroupNames`.

2. Создайте собственное расписание для времени завершения работы виртуальных машин.

3. Перейдите к runbook **ScheduledStartStop_Parent** и щелкните **Расписание**. Это позволит выбрать расписание, созданное на предыдущем шаге.

4. Выберите **Параметры и настройки запуска** и задайте в поле **ACTION** значение **Stop**.

5. Нажмите кнопку **ОК** , чтобы сохранить изменения.

## <a name="next-steps"></a>Дальнейшие действия

* Сведения о мониторинге функции во время работы см. в разделе [Журналы запросов функции "Запуск и остановка виртуальных машин в нерабочее время"](automation-solution-vm-management-logs.md).
* Сведения о решении проблем при управлении виртуальными машинами см. в разделе [Устранение неполадок функции "Запуск и остановка виртуальных машин в нерабочее время"](troubleshoot/start-stop-vm.md).
