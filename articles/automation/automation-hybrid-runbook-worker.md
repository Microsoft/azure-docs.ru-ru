---
title: Обзор гибридной рабочей роли Runbook в службе автоматизации Azure
description: Эта статья содержит общие сведения о гибридной рабочей роли Runbook, которую можно использовать для выполнения модулей runbook на компьютерах в локальном центре обработки данных или центре обработки данных поставщика облачных служб.
services: automation
ms.subservice: process-automation
ms.date: 01/11/2021
ms.topic: conceptual
ms.openlocfilehash: a23d30047a13b1d176b086a9923e140e7f8d3e45
ms.sourcegitcommit: 3af12dc5b0b3833acb5d591d0d5a398c926919c8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/11/2021
ms.locfileid: "98072145"
---
# <a name="hybrid-runbook-worker-overview"></a>Обзор гибридной рабочей роли Runbook

Модули Runbook в службе автоматизации Azure не будут иметь доступ к ресурсам в других облаках или локальной среде, так как они выполняются на платформе облака Azure. Вы можете использовать функцию гибридной рабочей роли Runbook в службе автоматизации Azure для запуска модулей Runbook непосредственно на компьютере, на котором размещается роль, и для ресурсов в среде, чтобы управлять этими локальными ресурсами. Модули Runbook хранятся и управляются в службе автоматизации Azure, а затем доставляются на один или несколько назначенных машин.

## <a name="runbook-worker-types"></a>Типы рабочих ролей Runbook

Существует два типа рабочих ролей Runbook: система и пользователь. В следующей таблице описаны различия между ними.

|Type | Описание: |
|-----|-------------|
|**Система** |Поддерживает набор скрытых модулей Runbook, используемых компонентом Управление обновлениями, предназначенным для установки указанных пользователем обновлений на компьютерах под управлением Windows и Linux.<br> Этот тип гибридной рабочей роли Runbook не является членом гибридной группы Runbook Worker, поэтому не выполняет модули Runbook, предназначенные для группы рабочей роли Runbook. |
|**Пользователь** |Поддерживает пользовательские модули Runbook, предназначенные для непосредственного запуска на компьютере Windows и Linux, которые являются членами одной или нескольких групп Runbook Worker. |

Гибридная Рабочая роль Runbook может запускаться в операционной системе Windows или Linux, и она полагается на [log Analytics агент](../azure-monitor/platform/log-analytics-agent.md) отчетов в [рабочую область Azure Monitor log Analytics](../azure-monitor/platform/design-logs-deployment.md). Рабочая область предназначена не только для наблюдения за машиной поддерживаемой операционной системы, но также для загрузки компонентов, необходимых для установки гибридной рабочей роли Runbook.

Если включена служба автоматизации Azure [Управление обновлениями](./update-management/overview.md) , любой компьютер, подключенный к рабочей области log Analytics, автоматически настраивается в качестве системы Гибридная Рабочая роль Runbook. Сведения о настройке в качестве пользователя гибридной рабочей роли Runbook для [Windows см.](automation-windows-hrw-install.md) в статье Развертывание гибридной [рабочей роли Runbook для Linux.](automation-linux-hrw-install.md)

## <a name="how-does-it-work"></a>Как это работает?

![Обзор гибридной рабочей роли Runbook](media/automation-hybrid-runbook-worker/automation.png)

Гибридная Рабочая роль Runbook каждого пользователя входит в состав группы гибридной рабочей роли Runbook, указанной при установке рабочей роли. Группа может включать в себя одного работника, но в группу можно включить несколько сотрудников, чтобы обеспечить высокий уровень доступности. На каждом компьютере можно разместить один гибридный модуль Runbook Worker в одной учетной записи службы автоматизации. нельзя зарегистрировать гибридную рабочую роль в нескольких учетных записях службы автоматизации. Гибридная Рабочая роль может прослушивать задания только из одной учетной записи службы автоматизации. Для компьютеров, на которых размещена система гибридной рабочей роли Runbook, управляемая Управление обновлениями, их можно добавить в группу гибридных рабочих ролей Runbook. Но вы должны использовать одну и ту же учетную запись службы автоматизации как для Управление обновлениями, так и для членства в группе гибридной рабочей роли Runbook.

При запуске модуля Runbook в гибридной рабочей роли Runbook пользователя указывается группа, в которой она выполняется. Каждый компонент Worker в группе опрашивает службу автоматизации, чтобы узнать, доступны ли какие-либо задания. Если задание доступно, его получает первая рабочая роль. Время обработки очереди заданий зависит от профиля оборудования и загрузки гибридной рабочей роли. Указание конкретной рабочей роли невозможно. Гибридная Рабочая роль работает с механизмом опроса (каждые 30 секунд) и соответствует порядку первых поступающих. В зависимости от того, когда было отправлено задание, из-за того, что Гибридная Рабочая роль проверяет связь со службой автоматизации, вы берете задание. Для одной гибридной рабочей роли обычно можно выбрать четыре задания для каждой проверки связи (то есть каждые 30 секунд). Если скорость отправки заданий превышает четыре в течение 30 секунд, то существует высокая вероятность того, что в группе гибридной рабочей роли Runbook забирается еще одна Гибридная Рабочая роль.

В гибридной рабочей роли Runbook не предусмотрено много [ограничений](../azure-resource-manager/management/azure-subscription-service-limits.md#automation-limits) ресурсов ["песочницы Azure"](automation-runbook-execution.md#runbook-execution-environment) для дискового пространства, памяти или сетевых сокетов. Ограничения гибридной рабочей роли связаны только с собственными ресурсами работника, и они не ограничиваются временным ограничением [общего](automation-runbook-execution.md#fair-share) времени, которое есть в песочницах Azure.

Чтобы управлять распределением модулей Runbook в гибридных рабочих ролях Runbook, а также при активации заданий или их запуске, можно зарегистрировать гибридную рабочую роль для разных групп гибридных рабочих ролей Runbook в учетной записи службы автоматизации. Нацеливание на задания в соответствии с определенной группой или группами для поддержки размещения выполнения.

## <a name="hybrid-runbook-worker-installation"></a>Установка гибридной рабочей роли Runbook

Процесс установки гибридной рабочей роли Runbook пользователя зависит от операционной системы. В таблице ниже указаны типы развертывания.

|Операционная система  |Типы развертывания  |
|---------|---------|
|Windows     | [Автоматическое](automation-windows-hrw-install.md#automated-deployment)<br>[Вручную](automation-windows-hrw-install.md#manual-deployment)        |
|Linux     | [Вручную](automation-linux-hrw-install.md#install-a-linux-hybrid-runbook-worker)        |

Рекомендуемый метод установки для компьютера Windows — использование модуля Runbook службы автоматизации Azure для полной автоматизации процесса настройки. Если это нецелесообразно, можно выполнить пошаговую процедуру, чтобы вручную установить и настроить роль. Для компьютеров с Linux для установки агента запустите скрипт Python.

## <a name="network-planning"></a><a name="network-planning"></a>Планирование сети

Для того, чтобы система и пользовательская Гибридная Рабочая роль Runbook могли подключаться к службе автоматизации Azure и зарегистрироваться в ней, у нее должен быть доступ к номеру порта и URL-адресам, описанным в этом разделе. Кроме того, у рабочей роли должен быть доступ к [портам и URL-адресам, необходимым для того, чтобы агент Log Analytics](../azure-monitor/platform/agent-windows.md) мог подключиться к рабочей области Log Analytics в Azure Monitor.

Для гибридной рабочей роли Runbook необходимы следующие порт и URL-адрес:

* Порт: только исходящий интернет-трафик через TCP-порт 443.
* Глобальный URL-адрес: `*.azure-automation.net`
* Глобальный URL-адрес US Gov (Вирджиния): `*.azure-automation.us`
* Служба агента: `https://<workspaceId>.agentsvc.azure-automation.net`

При наличии учетной записи службы автоматизации, определенной для конкретного региона, можно ограничить обмен данными гибридной рабочей роли Runbook соответствующим региональным центром обработки данных. Проверьте [записи DNS, используемые службой автоматизации Azure](how-to/automation-region-dns-records.md) для необходимых записей DNS.

### <a name="proxy-server-use"></a>Использование прокси-сервера

Если вы используете прокси-сервер для обмена данными между службой автоматизации Azure и компьютерами, на которых выполняется агент Log Analytics, убедитесь, что соответствующие ресурсы доступны. Время ожидания запросов от гибридной рабочей роли Runbook и служб автоматизации составляет 30 секунд. После трех попыток запрос завершится ошибкой.

### <a name="firewall-use"></a>Использование брандмауэра

Если вы используете брандмауэр для ограничения доступа к Интернету, необходимо настроить брандмауэр для разрешения доступа. Если в качестве прокси-сервера используется шлюз Log Analytics, он должен быть настроен для гибридных рабочих ролей Runbook. См. статью [Настройка шлюза log Analytics для гибридных рабочих ролей Runbook службы автоматизации](../azure-monitor/platform/gateway.md).

### <a name="service-tags"></a>Теги служб

Служба автоматизации Azure поддерживает теги службы виртуальной сети Azure, начиная с тега службы [гуестандхибридманажемент](../virtual-network/service-tags-overview.md). Теги службы можно использовать для определения элементов управления доступом к сети для [групп безопасности сети](../virtual-network/network-security-groups-overview.md#security-rules) или [брандмауэра Azure](../firewall/service-tags.md). Теги службы можно использовать вместо конкретных IP-адресов при создании правил безопасности. Указав имя тега службы **гуестандхибридманажемент**  в соответствующем поле источника или назначения правила, можно разрешить или запретить трафик для службы автоматизации. Этот тег службы не поддерживает более детализированный контроль за счет ограниченного диапазона IP-адресов в определенном регионе.

Тег службы службы автоматизации Azure предоставляет только IP-адреса, используемые в следующих сценариях:

* Активация веб-перехватчиков в виртуальной сети
* Разрешить гибридным рабочим процессам Runbook или агентам конфигурации состояния в виртуальной сети взаимодействовать со службой автоматизации

>[!NOTE]
>Тег службы **гуестандхибридманажемент** сейчас не поддерживает выполнение задания Runbook в песочнице Azure, только непосредственно в гибридной рабочей роли Runbook.

## <a name="support-for-impact-level-5-il5"></a>Поддержка уровня влияния 5 (IL5)

Гибридную рабочую роль Runbook службы автоматизации Azure можно использовать в Azure для государственных организаций, чтобы обеспечить поддержку рабочих нагрузок уровня 5 в любой из следующих двух конфигураций:

* [Изолированная виртуальная машина](../azure-government/documentation-government-impact-level-5.md#isolated-virtual-machines). При развертывании они используют весь физический узел для компьютера, предоставляющий необходимый уровень изоляции, необходимый для поддержки рабочих нагрузок IL5.

* [Выделенные узлы Azure](../azure-government/documentation-government-impact-level-5.md#azure-dedicated-host), которые предоставляют физические серверы, на которых можно разместить одну или несколько виртуальных машин, выделенных для одной подписки Azure.

>[!NOTE]
>Изоляция вычислений через гибридную рабочую роль Runbook доступна для коммерческих облаков Azure и государственных организаций США. 

### <a name="update-management-addresses-for-hybrid-runbook-worker"></a>Адреса для решения по управлению обновлениями в гибридной рабочей роли Runbook

В дополнение к стандартным адресам и портам, необходимым для гибридной рабочей роли Runbook, Управление обновлениями имеет другие требования к конфигурации сети, описанные в разделе « [планирование сети](./update-management/overview.md#ports) ».

## <a name="azure-automation-state-configuration-on-a-hybrid-runbook-worker"></a>Использование State Configuration службы автоматизации Azure в гибридной рабочей роли Runbook

Вы можете использовать [State Configuration службы автоматизации Azure](automation-dsc-overview.md) в гибридной рабочей роли Runbook. Для управления конфигурацией серверов, поддерживающих гибридную рабочую роль Runbook, необходимо добавить эти серверы в качестве узлов DSC. Дополнительные сведения см. в статье [Подключение компьютеров для управления с помощью State Configuration службы автоматизации Azure](automation-dsc-onboarding.md).

## <a name="runbook-worker-limits"></a>Ограничения рабочей роли Runbook

Максимальное число групп гибридных рабочих ролей на учетную запись службы автоматизации — 4000. оно применимо как для системных & пользователей, так и для гибридных рабочих ролей. При наличии более 4 000 компьютеров для управления рекомендуется создать другую учетную запись службы автоматизации.

## <a name="runbooks-on-a-hybrid-runbook-worker"></a>Модули runbook в гибридной рабочей роли Runbook

Возможно, у вас есть модули Runbook, которые управляют ресурсами на локальном компьютере или работают с ресурсами в локальной среде, где развернута пользовательская Гибридная Рабочая роль Runbook. В этом случае можно выбрать запуск модулей runbook в гибридной рабочей роли, а не в учетной записи службы автоматизации. Модули runbook, выполняемые в гибридной рабочей роли Runbook, по структуре идентичны тем, что выполняются в учетной записи службы автоматизации. См. статью [Запуск модулей Runbook в гибридной рабочей роли Runbook](automation-hrw-run-runbooks.md).

### <a name="hybrid-runbook-worker-jobs"></a>Задания гибридной рабочей роли Runbook

Задания гибридной рабочей роли Runbook выполняются в локальной учетной записи **System** в Windows или в учетной записи [nxautomation](automation-runbook-execution.md#log-analytics-agent-for-linux) в Linux. Служба автоматизации Azure обрабатывает задания в гибридных рабочих ролях Runbook по-разному из заданий, выполняемых в изолированных средах Azure. См. раздел [Среда выполнения runbook](automation-runbook-execution.md#runbook-execution-environment).

При перезагрузке компьютера, выполняющего гибридную рабочую роль Runbook, все выполняемые задания runbook запускаются заново, с самого начала или с последней контрольной точки, если это runbook рабочих процессов PowerShell. Если задание runbook перезапускается более трех раз, его выполнение приостанавливается.

### <a name="runbook-permissions-for-a-hybrid-runbook-worker"></a>Разрешения runbook для гибридной рабочей роли Runbook

Поскольку они обращаются к ресурсам, не относящимся к Azure, модули Runbook, работающие в гибридной рабочей роли Runbook пользователя, не могут использовать механизм проверки подлинности, обычно используемый модулями Runbook для проверки подлинности ресурсов Azure Модуль runbook предоставляет собственную аутентификацию для локальных ресурсов или настраивает ее с помощью [управляемых удостоверений для ресурсов Azure](../active-directory/managed-identities-azure-resources/tutorial-windows-vm-access-arm.md#grant-your-vm-access-to-a-resource-group-in-resource-manager). Также вы можете указать учетную запись запуска от имени, чтобы предоставить контекст пользователя для всех модулей runbook.

## <a name="view-system-hybrid-runbook-workers"></a>Просмотр системных гибридных рабочих ролей Runbook

После включения функции Управление обновлениями на компьютерах под управлением Windows или Linux можно выполнить инвентаризацию списка группы гибридных рабочих ролей Runbook в портал Azure. Вы можете просмотреть до 2 000 рабочих ролей на портале, выбрав **группу гибридные рабочие роли** на вкладке в **группе гибридные рабочие роли** в левой области для выбранной учетной записи службы автоматизации.

:::image type="content" source="./media/automation-hybrid-runbook-worker/system-hybrid-workers-page.png" alt-text="Страница групп гибридных рабочих ролей системы учетных записей службы автоматизации" border="false" lightbox="./media/automation-hybrid-runbook-worker/system-hybrid-workers-page.png":::

Если у вас более 2 000 гибридных рабочих ролей, чтобы получить их список, можно выполнить следующий сценарий PowerShell:

```powershell
"Get-AzSubscription -SubscriptionName "<subscriptionName>" | Set-AzContext
$workersList = (Get-AzAutomationHybridWorkerGroup -ResourceGroupName "<resourceGroupName>" -AutomationAccountName "<automationAccountName>").Runbookworker
$workersList | export-csv -Path "<Path>\output.csv" -NoClobber -NoTypeInformation"
```

## <a name="next-steps"></a>Дальнейшие действия

* Чтобы узнать, как настроить модули runbook для автоматизации процессов в локальном центре обработки данных или другой облачной среде, см. статью [Запуск модулей runbook в гибридной рабочей роли Runbook](automation-hrw-run-runbooks.md).

* Дополнительные сведения см. в статье [Устранение неполадок с гибридными рабочими ролями Runbook](troubleshoot/hybrid-runbook-worker.md#general).