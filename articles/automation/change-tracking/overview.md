---
title: Общие сведения об отслеживании изменений и инвентаризации в службе автоматизации Azure
description: В этой статье описывается функция Отслеживание изменений и инвентаризации, которая помогает обнаруживать изменения программного обеспечения и служб Майкрософт в вашей среде.
services: automation
ms.subservice: change-inventory-management
ms.date: 01/22/2021
ms.topic: conceptual
ms.openlocfilehash: e2371f3de8ed73250bca6639e6c749811c5559ad
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "100572606"
---
# <a name="change-tracking-and-inventory-overview"></a>Общие сведения об отслеживании изменений и инвентаризации

В этой статье приводятся основные сведения об отслеживании изменений и инвентаризации в службе автоматизации Azure. Эта функция отслеживает изменения в виртуальных машинах, размещенных в Azure, в локальной среде и в других облачных средах, которые помогают выявить проблемы в работе и окружающей среде с программным обеспечением, управляемым диспетчером пакетов распространения. Элементы, которые отслеживаются функцией отслеживания изменений и инвентаризации:

- Программное обеспечение Windows
- программное обеспечение Linux (пакеты);
- файлы Windows и Linux;
- разделы реестра Windows;
- службы Майкрософт;
- Управляющие программы Linux

> [!NOTE]
> Чтобы отслеживать изменения свойств Azure Resource Manager, обратитесь к [журналу изменений](../../governance/resource-graph/how-to/get-resource-changes.md) в Azure Resource Graph.

Отслеживание изменений и Инвентаризация используют [средство мониторинга целостности файлов (FIM) центра безопасности Azure](../../security-center/security-center-file-integrity-monitoring.md) для проверки файлов операционной системы и приложений, а реестр Windows. В то время как FIM отслеживает эти сущности, Отслеживание изменений и инвентаризации в собственном виде:

- изменения программного обеспечения;
- Службы Майкрософт
- Управляющие программы Linux

Включение всех функций, включенных в Отслеживание изменений и инвентаризации, может привести к дополнительным расходам. Прежде чем продолжать, ознакомьтесь со сведениями о [ценах на автоматизацию](https://azure.microsoft.com/pricing/details/automation/) и [ценах на Azure Monitor](https://azure.microsoft.com/pricing/details/monitor/).

Отслеживание изменений и Инвентаризация пересылают данные в журналы Azure Monitor, а собранные данные хранятся в Log Analytics рабочей области. Функция мониторинга целостности файлов (FIM) доступна, только если включен **защитник Azure для серверов** . Дополнительные сведения см. на странице [цен](../../security-center/security-center-pricing.md) на центр безопасности Azure. FIM передает данные в ту же рабочую область Log Analytics, которая была создана для хранения данных из Отслеживание изменений и инвентаризации. Мы рекомендуем отслеживать данные в связанной рабочей области Log Analytics, чтобы отслеживать точное использование. Дополнительные сведения об анализе Azure Monitor использовании данных журнала см. в разделе [Управление использованием и стоимостью](../../azure-monitor/logs/manage-cost-storage.md).

Компьютеры, подключенные к рабочей области Log Analytics, используют [агент log Analytics](../../azure-monitor/agents/log-analytics-agent.md) для получения данных об изменениях в установленном программном обеспечении, службах Майкрософт, реестре и файлах Windows и управляющих программах Linux на наблюдаемых серверах. Когда данные доступны, агент отправляет их в журналы Azure Monitor для обработки. Azure Monitor журналы применяют логику к полученным данным, записывают их и делают доступными для анализа.

> [!NOTE]
> Для Отслеживание изменений и инвентаризации необходимо связать Log Analytics рабочую область с учетной записью службы автоматизации. Полный список поддерживаемых регионов см. в статье о [сопоставлении рабочих областей Azure](../how-to/region-mappings.md). Сопоставления регионов не влияют на возможность управления виртуальными машинами в отдельном регионе из учетной записи службы автоматизации.

## <a name="current-limitations"></a>Текущие ограничения

Отслеживание изменений и инвентаризации не поддерживаются или имеют следующие ограничения.

- Рекурсия для отслеживания реестра Windows
- Сетевые файловые системы
- другие методы установки;
- ***exe файлы,** хранящиеся в Windows
- в текущей версии столбец и значения **Максимальный размер файла** не используются;
- При попытке сбора более 2500 файлов в течение 30-минутного цикла сбора может снизиться производительность Отслеживание изменений и инвентаризации.
- Если сетевой трафик высок, для показа записей изменений может потребоваться до шести часов.
- При изменении конфигурации во время завершения работы компьютера или сервера возможна публикация изменений, относящихся к предыдущей конфигурации.
- Сбор обновлений исправлений на компьютерах с Windows Server 2016 Core RS3.
- Управляющие программы Linux могут показывать измененное состояние, даже если изменений не было. Эта проблема возникает из-за способа `SvcRunLevels` написания данных в таблице Azure Monitor [ConfigurationChange](/azure/azure-monitor/reference/tables/configurationchange) .

## <a name="supported-operating-systems"></a>Поддерживаемые операционные системы

Функция отслеживания изменений и инвентаризации поддерживается во всех операционных системах, отвечающих требованиям для агента Log Analytics. Список версий операционных систем Windows и Linux, которые в настоящее время поддерживаются агентом Log Analytics, см. в разделе [Поддерживаемые операционные системы](../../azure-monitor/agents/agents-overview.md#supported-operating-systems) .

Сведения о требованиях клиента к TLS 1,2 см. в разделе [Принудительная поддержка tls 1,2 для службы автоматизации Azure](../automation-managing-data.md#tls-12-enforcement-for-azure-automation).

### <a name="python-requirement"></a>Требование к Python

Отслеживание изменений и Inventory поддерживают только python2. Если на вашем компьютере используется дистрибутив, который по умолчанию не включает Python 2, его необходимо установить. Приведенные ниже примеры команд будут устанавливать Python 2 на разных дистрибутивов.

- Red Hat, CentOS, Oracle: `yum install -y python2`
- Ubuntu, Debian: `apt-get install -y python2`
- SUSE: `zypper install -y python2`

Исполняемый файл python2 должен иметь псевдоним для *Python*.

## <a name="network-requirements"></a>Требования к сети

Дополнительные сведения о портах, URL-адресах и других данных о сети, необходимых для Отслеживание изменений и инвентаризации, см. в этой [конфигурации сети службы автоматизации Azure](../automation-network-configuration.md#update-management-and-change-tracking-and-inventory) .

## <a name="enable-change-tracking-and-inventory"></a>Включение решения для отслеживания изменений и инвентаризации

Включить Отслеживание изменений и инвентаризацию можно следующими способами.

- Из [учетной записи службы автоматизации](enable-from-automation-account.md) для одного или нескольких машин Azure и других компьютеров, не использующих Azure.

- Вручную для компьютеров, не относящихся к Azure, включая компьютеры или серверы, зарегистрированные на [серверах с поддержкой дуги Azure](../../azure-arc/servers/overview.md). Для гибридных компьютеров рекомендуется установить агент Log Analytics для Windows, сначала подключив компьютер к [серверам с поддержкой дуги Azure](../../azure-arc/servers/overview.md), а затем с помощью политики Azure назначить встроенную политику [развертывания log Analytics Agent для *Linux* или *Windows* Azure Arc](../../governance/policy/samples/built-in-policies.md#monitoring) . Если вы планируете также отслеживать компьютеры с Azure Monitor для виртуальных машин, используйте инициативу [Enable Azure Monitor для виртуальных машин](../../governance/policy/samples/built-in-initiatives.md#monitoring) .

- Для одной виртуальной машины Azure со [страницы виртуальной машины](enable-from-vm.md) в портал Azure. Этот сценарий доступен для виртуальных машин Linux и Windows.

- Для [нескольких виртуальных машин Azure](enable-from-portal.md), выбрав их на странице "Виртуальные машины" на портале Azure.

## <a name="tracking-file-changes"></a>Отслеживание изменений в файле

Для отслеживания изменений в файлах в Windows и Linux функция отслеживания изменений и инвентаризации использует MD5-хэши файлов. Затем эти хэши применяются для определения того, вносились ли изменения с момента последней инвентаризации.

## <a name="tracking-file-content-changes"></a>Отслеживание изменений содержимого файлов

Отслеживание изменений и инвентаризация позволяет просматривать содержимое файла Windows или Linux. Для каждого изменения в файле функция отслеживания изменений и инвентаризации сохраняет содержимое файла в [учетной записи хранения Azure](../../storage/common/storage-account-create.md). При отслеживании файла его содержимое можно просмотреть до или после изменения. Содержимое файла можно просмотреть как в строке, так и параллельно.

![Просмотр изменений в файле](./media/overview/view-file-changes.png)

## <a name="tracking-of-registry-keys"></a>Отслеживание разделов реестра

Отслеживание изменений и инвентаризация позволяет отслеживать изменения в разделах реестра Windows. Целью такого отслеживания является точное определение точек расширяемости, в которых может быть активирован сторонний код или вредоносная программа. В приведенной ниже таблице перечислены предварительно настроенные (но не включенные) разделы реестра. Чтобы отслеживать эти разделы, необходимо включить каждый из них.

> [!div class="mx-tdBreakAll"]
> |Ключ реестра | Назначение |
> | --- | --- |
> |`HKEY\LOCAL\MACHINE\Software\Microsoft\Windows\CurrentVersion\Group Policy\Scripts\Startup` | Отслеживаются сценарии, выполняемые при запуске.
> |`HKEY\LOCAL\MACHINE\Software\Microsoft\Windows\CurrentVersion\Group Policy\Scripts\Shutdown` | Отслеживаются сценарии, выполняемые при завершении работы.
> |`HKEY\LOCAL\MACHINE\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Run` | Отслеживаются разделы, загружаемые перед входом пользователя в учетную запись Windows. Этот раздел используется для 32-разрядных приложений, выполняющихся на 64-разрядных компьютерах.
> |`HKEY\LOCAL\MACHINE\SOFTWARE\Microsoft\Active Setup\Installed Components` | Отслеживаются изменения параметров приложения.
> |`HKEY\LOCAL\MACHINE\Software\Classes\Directory\ShellEx\ContextMenuHandlers` | Отслеживает обработчики контекстного меню, которые напрямую присоединяются к проводнику Windows и обычно выполняются в процессе с **explorer.exe**.
> |`HKEY\LOCAL\MACHINE\Software\Classes\Directory\Shellex\CopyHookHandlers` | Отслеживает обработчики копирования, которые напрямую присоединяются к проводнику Windows и обычно выполняются в процессе с **explorer.exe**.
> |`HKEY\LOCAL\MACHINE\Software\Microsoft\Windows\CurrentVersion\Explorer\ShellIconOverlayIdentifiers` | Отслеживается регистрация обработчика дополнительных значков.
> |`HKEY\LOCAL\MACHINE\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\Explorer\ShellIconOverlayIdentifiers` | Отслеживается регистрация обработчика дополнительных значков для 32-битных приложений, работающих на 64-разрядных компьютерах.
> |`HKEY\LOCAL\MACHINE\Software\Microsoft\Windows\CurrentVersion\Explorer\Browser Helper Objects` | Отслеживаются новые подключаемые модули вспомогательных объектов браузера для Internet Explorer. Используется для доступа к модели DOM текущей страницы и управления навигацией.
> |`HKEY\LOCAL\MACHINE\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\Explorer\Browser Helper Objects` | Отслеживаются новые подключаемые модули вспомогательных объектов браузера для Internet Explorer. Используется для получения доступа к модели DOM текущей страницы и управления навигацией для 32-разрядных приложений, работающих на 64-разрядных компьютерах.
> |`HKEY\LOCAL\MACHINE\Software\Microsoft\Internet Explorer\Extensions` | Отслеживаются новые расширения Internet Explorer, например пользовательские меню инструментов и пользовательские кнопки панели инструментов.
> |`HKEY\LOCAL\MACHINE\Software\Wow6432Node\Microsoft\Internet Explorer\Extensions` | Отслеживаются новые расширения Internet Explorer, например пользовательские меню инструментов и пользовательские кнопки панели инструментов для 32-битных приложений, работающих на 64-разрядных компьютерах.
> |`HKEY\LOCAL\MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Drivers32` | Отслеживаются 32-разрядные драйверы, связанные с устройствами wavemapper: wave1 и wave2, msacm.imaadpcm, .msadpcm, .msgsm610 и vidc. Ознакомьтесь с разделом о [драйверах] в файле **system.ini**.
> |`HKEY\LOCAL\MACHINE\Software\Wow6432Node\Microsoft\Windows NT\CurrentVersion\Drivers32` | Отслеживаются 32-разрядные драйверы, связанные с устройствами wavemapper, — wave1 и wave2, msacm.imaadpcm, .msadpcm, .msgsm610 и vidc — для 32-разрядных приложений, работающих на 64-разрядных компьютерах. Ознакомьтесь с разделом о [драйверах] в файле **system.ini**.
> |`HKEY\LOCAL\MACHINE\System\CurrentControlSet\Control\Session Manager\KnownDlls` | Отслеживается список известных или часто используемых системных библиотек DLL. Наблюдение предотвращает использование слабых разрешений каталога приложений с помощью удаления в системных библиотеках DLL-Троянных версий.
> |`HKEY\LOCAL\MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Notify` | Отслеживается список пакетов, получающих уведомления о событиях из **winlogon.exe** — интерактивной модели поддержки входа в систему для Windows.

## <a name="recursion-support"></a>Поддержка рекурсии

Функция отслеживания изменений и инвентаризации поддерживает рекурсию, что позволяет использовать подстановочные знаки для упрощения отслеживания в каталогах. Рекурсия также предоставляет переменные среды, которые позволяют отслеживать файлы в разных средах с несколькими или динамическими именами дисков. В следующем списке приведены общие сведения, которые следует учитывать при настройке рекурсии.

- Для отслеживания нескольких файлов необходимы подстановочные знаки.

- Подстановочные знаки можно использовать только в последнем сегменте пути к файлу, например **c:\u1087? АПКА \\ File** _ или _ */etc/*. conf * *.

- Если у переменной среды недопустимый путь, проверка будет успешной, но выполнение завершится сбоем.

- При задании пути не следует использовать общие имена путей, так как этот тип параметра может вызвать слишком много папок для обхода.

## <a name="change-tracking-and-inventory-data-collection"></a>Сбор данных для функции отслеживания изменений и инвентаризации

В таблице ниже указана частота сбора данных для типов изменений, поддерживаемых функцией отслеживания изменений и инвентаризации. Моментальный снимок данных текущего состояния для каждого типа обновляется по крайней мере каждые 24 часа.

| **Тип изменения** | **Частота** |
| --- | --- |
| Реестр Windows | 50 минут |
| Файловый ресурс Windows | 30 минут |
| Файловый ресурс Linux | 15 минут |
| Службы Майкрософт | от 10 секунд до 30 минут</br> Значение по умолчанию: 30 минут |
| Управляющие программы Linux | 5 мин |
| Программное обеспечение Windows | 30 минут |
| Программное обеспечение Linux | 5 мин |

В таблице ниже приведены ограничения по отслеживаемым элементам для одного компьютера при использовании функции отслеживания изменений и инвентаризации.

| **Ресурс** | **Ограничение** |
|---|---|---|
|Файл|500|
|Реестр|250|
|Программное обеспечение Windows (не включая исправления) |250|
|Пакеты Linux|1250|
|Службы|250|
|Управляющие программы|250|

Средний показатель использования данных Log Analytics для компьютера, использующего функцию отслеживания изменений и инвентаризации, — примерно 40 МБ в месяц в зависимости от среды. С помощью функции использования и оценки затрат рабочей области Log Analytics можно просмотреть данные, принимаемые Отслеживание изменений и инвентаризации на диаграмме использования. Используйте это представление данных, чтобы оценить использование данных и определить, как оно влияет на ваш счет. См. раздел [Просмотр сведений об использовании и оценка затрат](../../azure-monitor/logs/manage-cost-storage.md#understand-your-usage-and-estimate-costs).

### <a name="microsoft-service-data"></a>Данные по службам Майкрософт

Периодичность сбора по умолчанию для служб Майкрософт — 30 минут. Периодичность можно настроить с помощью ползунка на вкладке **Службы Майкрософт** в разделе **Изменить параметры**.

![Ползунок на вкладке "Службы Майкрософт"](./media/overview/windowservices.png)

Для оптимизации производительности агент Log Analytics отслеживает только изменения. Установка высокого порогового значения может пропускать изменения, если служба возвращается в исходное состояние. Если вы установите меньший период, то запишете изменения, которые в противном случае будут упущены.

> [!NOTE]
> Хотя агент может отслеживать изменения с 10-секундным интервалом, потребуется несколько минут, чтобы данные отобразились на портале Azure. В эти несколько минут изменения по-прежнему отслеживаются и записываются.

## <a name="support-for-alerts-on-configuration-state"></a>Поддержка оповещений о состоянии конфигурации

Ключевой возможностью отслеживания изменений и инвентаризации является возможность оповещения об изменениях состояния конфигурации в гибридной среде. Для активации в ответ на предупреждения доступны многие полезные действия. Например, действия с функциями Azure, модули Runbook службы автоматизации, веб-перехватчики и т. д. Предупреждение об изменениях в файле **c:\windows\system32\drivers\etc\hosts** для компьютера — это одно хорошее применение оповещений для отслеживание изменений и данных инвентаризации. Существует множество других сценариев использования оповещений, включая сценарии запросов, определенные в следующей таблице.

|Запрос  |Описание  |
|---------|---------|
|ConfigurationChange <br>&#124; где ConfigChangeType == "Files" и FileSystemPath содержит " c:\\windows\\system32\\drivers\\"|Полезно для отслеживания изменений в системных критических файлах.|
|ConfigurationChange <br>&#124; где FieldsChanged содержит "FileContentChecksum" и FileSystemPath == "c:\\windows\\system32\\drivers\\etc\\hosts"|Полезно для отслеживания изменений в файлах конфигурации ключа.|
|ConfigurationChange <br>&#124; где ConfigChangeType == "WindowsServices" и SvcName содержит "w3svc" и SvcState == "Stopped"|Полезно для отслеживания изменений в системных критически важных службах.|
|ConfigurationChange <br>&#124; где ConfigChangeType == "Управляющие программы", SvcName содержит "ssh", в SvcState == "Выполняется"|Полезно для отслеживания изменений в системных критически важных службах.|
|ConfigurationChange <br>&#124; где ConfigChangeType == "Software" и ChangeCategory == "Added"|Полезно для сред, которые требуют заблокированных конфигураций программного обеспечения.|
|ConfigurationData <br>&#124; где SoftwareName содержит "Monitoring Agent", а CurrentVersion != "8.0.11081.0"|Полезно для просмотра компьютеров, на которых установлена устаревшая или несовместимая версия программного обеспечения. Этот запрос сообщает о последнем сообщенном состоянии конфигурации, но не об изменениях.|
|ConfigurationChange <br>&#124; где RegistryKey == @"HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\QualityCompat"| Полезно для отслеживания изменений в важных антивирусных ключах.|
|ConfigurationChange <br>&#124; где RegistryKey содержит @"HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\SharedAccess\\Parameters\\FirewallPolicy"| Полезно для отслеживания изменений в параметрах брандмауэра.|

## <a name="next-steps"></a>Дальнейшие действия

- Сведения о включении из учетной записи службы автоматизации см. в статье [включение отслеживание изменений и инвентаризации из учетной записи службы автоматизации](enable-from-automation-account.md).

- Сведения о включении из портал Azure см. в разделе [включение отслеживание изменений и инвентаризации из портал Azure](enable-from-portal.md).

- Сведения о включении из модуля Runbook см. в статье [включение отслеживание изменений и инвентаризации из модуля Runbook](enable-from-runbook.md).

- Сведения о включении с виртуальной машины Azure см. в статье [включение отслеживание изменений и инвентаризации из виртуальной машины Azure](enable-from-vm.md).
