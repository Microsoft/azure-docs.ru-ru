---
title: Устранение неполадок с запуском и остановкой виртуальных машин в нерабочее время в службе автоматизации Azure
description: В этой статье рассказывается, как устранять проблемы, возникающие при использовании компонента "Запуск и остановка виртуальных машин в нерабочее время".
services: automation
ms.subservice: process-automation
ms.date: 04/04/2019
ms.topic: troubleshooting
ms.openlocfilehash: ff2ef8970afa21c0218da20a5b79ea2fb782dd5c
ms.sourcegitcommit: d1e56036f3ecb79bfbdb2d6a84e6932ee6a0830e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/29/2021
ms.locfileid: "99053590"
---
# <a name="troubleshoot-startstop-vms-during-off-hours-issues"></a>Устранение неполадок с запуском и остановкой виртуальных машин в нерабочее время

В этой статье содержатся сведения об устранении неполадок и проблем, возникающих при развертывании компонента "Запуск и остановка виртуальных машин в нерабочее время" службы автоматизации Azure на виртуальных машинах. 

## <a name="scenario-startstop-vms-during-off-hours-fails-to-properly-deploy"></a><a name="deployment-failure"></a>Сценарий. Не удается должным образом развернуть компонент "Запуск и остановка виртуальных машин в нерабочее время"

### <a name="issue"></a>Проблема

Развертывание компонента [Запуск и остановка виртуальных машин в нерабочее время](../automation-solution-vm-management.md) приводит к одной из перечисленных ниже ошибок.

```error
Account already exists in another resourcegroup in a subscription. ResourceGroupName: [MyResourceGroup].
```

```error
Resource 'StartStop_VM_Notification' was disallowed by policy. Policy identifiers: '[{\\\"policyAssignment\\\":{\\\"name\\\":\\\"[MyPolicyName]".
```

```error
The subscription is not registered to use namespace 'Microsoft.OperationsManagement'.
```

```error
The subscription is not registered to use namespace 'Microsoft.Insights'.
```

```error
The scope '/subscriptions/000000000000-0000-0000-0000-00000000/resourcegroups/<ResourceGroupName>/providers/Microsoft.OperationalInsights/workspaces/<WorkspaceName>/views/StartStopVMView' cannot perform write operation because following scope(s) are locked: '/subscriptions/000000000000-0000-0000-0000-00000000/resourceGroups/<ResourceGroupName>/providers/Microsoft.OperationalInsights/workspaces/<WorkspaceName>/views/StartStopVMView'. Please remove the lock and try again
```

```error
A parameter cannot be found that matches parameter name 'TagName'
```

```error
Start-AzureRmVm : Run Login-AzureRmAccount to login
```

### <a name="cause"></a>Причина

Сбои при выполнении развертывания могут возникать вследствие любой из указанных ниже причин.

- В выбранном регионе уже существует учетная запись службы автоматизации с тем же именем.
- Политика запрещает развертывание компонента "Запуск и остановка виртуальных машин в нерабочее время".
- Типы ресурсов `Microsoft.OperationsManagement`, `Microsoft.Insights` или `Microsoft.Automation` не зарегистрированы.
- Рабочая область Log Analytics заблокирована.
- Установлена устаревшая версия модулей AzureRM или компонента "Запуск и остановка виртуальных машин в нерабочее время".

### <a name="resolution"></a>Решение

Ниже приведены возможные решения проблемы.

* Учетные записи службы автоматизации должны быть уникальными в пределах региона Azure, даже если они находятся в разных группах ресурсов. Проверьте существующие учетные записи службы автоматизации в целевом регионе.
* Существующая политика запрещает использование ресурса, необходимого для развертывания компонента "Запуск и остановка виртуальных машин в нерабочее время". Перейдите к своим назначениям политики на портале Azure и проверьте, есть ли у вас назначение политики, запрещающее развертывание этого ресурса. Дополнительные сведения см. в статье [Ошибка RequestDisallowedByPolicy](../../azure-resource-manager/templates/error-policy-requestdisallowedbypolicy.md).
* Чтобы развернуть компонент "Запуск и остановка виртуальных машин в нерабочее время", ваша подписка должна быть зарегистрирована в указанных ниже пространствах имен ресурсов Azure.

    * `Microsoft.OperationsManagement`
    * `Microsoft.Insights`
    * `Microsoft.Automation`

   Дополнительные сведения об ошибках при регистрации поставщиков см. в статье [Устранение ошибок регистрации поставщика ресурсов](../../azure-resource-manager/templates/error-register-resource-provider.md).
* Если у вас есть блокировка в рабочей области Log Analytics, перейдите в свою рабочую область на портале Azure и удалите все блокировки в ресурсе.
* Если эти решения не помогли решить проблему, следуйте инструкциям в разделе [Обновление компонентов](../automation-solution-vm-management.md#update-the-feature) для повторного развертывания компонента "Запуск и остановка виртуальных машин в нерабочее время".

## <a name="scenario-all-vms-fail-to-start-or-stop"></a><a name="all-vms-fail-to-startstop"></a>Сценарий. Не удается запустить или остановить все виртуальные машины

### <a name="issue"></a>Проблема

Вы настроили компонент "Запуск и остановка виртуальных машин в нерабочее время", но он не запускает или не останавливает работу всех виртуальных машин.

### <a name="cause"></a>Причина

Ошибка может быть вызвана одной из следующих причин:

- Расписание настроено неправильно.
- Учетная запись запуска от имени настроена неправильно.
- При работе модуля Runbook возникли ошибки.
- Виртуальные машины были исключены.

### <a name="resolution"></a>Решение

Ниже приведены возможные решения проблемы.

* Проверьте правильность настройки расписания для компонента "Запуск и остановка виртуальных машин в нерабочее время". Сведения о настройке расписания см. в статье [Расписания](../shared-resources/schedules.md).

* Проверьте [потоки заданий](../automation-runbook-execution.md#job-statuses) на наличие ошибок. Найдите задания одного из следующих модулей Runbook:

  * **AutoStop_CreateAlert_Child**
  * **AutoStop_CreateAlert_Parent**
  * **AutoStop_Disable**
  * **AutoStop_VM_Child**
  * **ScheduledStartStop_Base_Classic**
  * **ScheduledStartStop_Child_Classic**
  * **ScheduledStartStop_Child**
  * **ScheduledStartStop_Parent**
  * **SequencedStartStop_Parent**

* Убедитесь, что у [учетной записи запуска от имени](../automation-security-overview.md#run-as-accounts) имеются соответствующие разрешения на работу с виртуальными машинами, которые вы пытаетесь запустить или остановить. Сведения о том, как проверить разрешения на ресурс, см. в статье [Краткое руководство. Использование портала Azure для просмотра ролей, назначенных пользователю](../../role-based-access-control/check-access.md). Вам потребуется указать идентификатор приложения для субъекта-службы, используемого учетной записью запуска от имени. Это значение можно получить, перейдя к учетной записи службы автоматизации на портале Azure. Выберите **Учетные записи запуска от имени** в разделе **Параметры учетной записи** и выберите соответствующую учетную запись запуска от имени.

* Виртуальные машины невозможно запустить или остановить, если они были явно исключены. Исключенные виртуальные машины задаются в переменной `External_ExcludeVMNames` в учетной записи службы автоматизации, в которой развернут этот компонент. В следующем примере показано, как запросить это значение с помощью PowerShell.

  ```powershell-interactive
  Get-AzAutomationVariable -Name External_ExcludeVMNames -AutomationAccountName <automationAccountName> -ResourceGroupName <resourceGroupName> | Select-Object Value
  ```

## <a name="scenario-some-of-my-vms-fail-to-start-or-stop"></a><a name="some-vms-fail-to-startstop"></a>Сценарий. Не удается запустить или остановить некоторые из виртуальных машин

### <a name="issue"></a>Проблема

Вы настроили компонент "Запуск и остановка виртуальных машин в нерабочее время", но он не запускает или не останавливает работу некоторых настроенных виртуальных машин.

### <a name="cause"></a>Причина

Ошибка может быть вызвана одной из следующих причин:

- В случае использования сценария с поочередной обработкой тег может отсутствовать или быть неправильным.
- Виртуальная машина была исключена.
- У учетной записи запуска от имени недостаточно разрешений на работу с виртуальной машиной.
- На виртуальной машине присутствует проблема, которая препятствует ее запуску или остановке.

### <a name="resolution"></a>Решение

Ниже приведены возможные решения проблемы.

* При использовании [сценария с поочередной обработкой](../automation-solution-vm-management.md) компонента "Запуск и остановка виртуальных машин в нерабочее время" необходимо убедиться, что каждой виртуальной машине, которую нужно запустить или остановить, присвоен правильный тег. Виртуальным машинам, которые нужно запустить, должен быть присвоен тег `sequencestart`, а виртуальным машинам, которые нужно остановить, — тег `sequencestop`. Для обоих тегов требуется положительное целое значение. Для поиска всех виртуальных машин с тегами и значений тегов можно использовать запрос, аналогичный приведенному ниже.

  ```powershell-interactive
  Get-AzResource | ? {$_.Tags.Keys -contains "SequenceStart" -or $_.Tags.Keys -contains "SequenceStop"} | ft Name,Tags
  ```

* Виртуальные машины невозможно запустить или остановить, если они были явно исключены. Исключенные виртуальные машины задаются в переменной `External_ExcludeVMNames` в учетной записи службы автоматизации, в которой развернут этот компонент. В следующем примере показано, как запросить это значение с помощью PowerShell.

  ```powershell-interactive
  Get-AzAutomationVariable -Name External_ExcludeVMNames -AutomationAccountName <automationAccountName> -ResourceGroupName <resourceGroupName> | Select-Object Value
  ```

* Для запуска и остановки виртуальных машин требуется, чтобы у учетной записи запуска от имени для учетной записи автоматизации были соответствующие разрешения на виртуальную машину. Сведения о том, как проверить разрешения на ресурс, см. в статье [Краткое руководство. Использование портала Azure для просмотра ролей, назначенных пользователю](../../role-based-access-control/check-access.md). Вам потребуется указать идентификатор приложения для субъекта-службы, используемого учетной записью запуска от имени. Это значение можно получить, перейдя к учетной записи службы автоматизации на портале Azure. Выберите **Учетные записи запуска от имени** в разделе **Параметры учетной записи** и выберите соответствующую учетную запись запуска от имени.
* Если на виртуальной машине возникла проблема при запуске или отмене распределения, это может быть вызвано проблемой в самой виртуальной машине. Примером может служить обновление, которое применяется при попытке завершить работу виртуальной машины, зависания службы и т. д. Перейдите к ресурсу виртуальной машины и проверьте, нет ли в **журналах действий** записей об ошибках. Вы также можете попытаться войти в систему виртуальной машины, чтобы просмотреть, нет ли ошибок в журналах событий. Дополнительные сведения об устранении неполадок виртуальной машины см. в статье [Устранение неполадок с виртуальными машинами Azure](../../virtual-machines/troubleshooting/index.yml).
* Проверьте [потоки заданий](../automation-runbook-execution.md#job-statuses) на наличие ошибок. На портале перейдите к учетной записи службы автоматизации и в разделе **Автоматизация процессов** выберите **Задания**.

## <a name="scenario-my-custom-runbook-fails-to-start-or-stop-my-vms"></a><a name="custom-runbook"></a>Сценарий. Пользовательскому модулю runbook не удается запустить или остановить виртуальные машины

### <a name="issue"></a>Проблема

Вы создали пользовательский модуль Runbook или скачали его из коллекции PowerShell, но он не работает должным образом.

### <a name="cause"></a>Причина

Может существовать несколько причин сбоя. Перейдите к учетной записи службы автоматизации на портале Azure и в разделе **Автоматизация процессов** выберите **Задания**. На странице **Задания** просмотрите, нет ли сведений о сбоях заданий runbook.

### <a name="resolution"></a>Решение

Примите во внимание следующие рекомендации.

* Используйте компонент [Запуск и остановка виртуальных машин в нерабочее время](../automation-solution-vm-management.md) для запуска и остановки виртуальных машин в службе автоматизации Azure. 
* Имейте в виду, что корпорация Майкрософт не поддерживает пользовательские модули Runbook. Вы можете найти решение для пользовательского модуля Runbook в статье [Устранение неполадок, связанных с модулем Runbook](runbooks.md). Проверьте [потоки заданий](../automation-runbook-execution.md#job-statuses) на наличие ошибок. 

## <a name="scenario-vms-dont-start-or-stop-in-the-correct-sequence"></a><a name="dont-start-stop-in-sequence"></a>Сценарий. Виртуальные машины не запускаются или не останавливаются в правильной очередности

### <a name="issue"></a>Проблема

Виртуальные машины, для которых включен компонент, не запускаются или не останавливаются в правильной очередности.

### <a name="cause"></a>Причина

Эта проблема связана с неправильным присвоением тегов для виртуальных машин.

### <a name="resolution"></a>Решение

Выполните следующие действия, чтобы убедиться, что функция включена правильно:

1. Убедитесь, что всем виртуальным машинам, которые нужно запустить, присвоен тег `sequencestart`, а тем, которые нужно остановить, — тег `sequencestop`. Этим тегам в качестве значения требуется положительное целое число. Виртуальные машины обрабатываются по возрастанию на основе этого значения.
1. Убедитесь, что группы ресурсов для виртуальных машин, которые нужно запустить, указаны в переменной `External_Start_ResourceGroupNames`, а для тех виртуальных машин, которые нужно остановить, — в переменной `External_Stop_ResourceGroupNames`.
1. Протестируйте изменения, запустив модуль Runbook **SequencedStartStop_Parent** с параметром `WHATIF`, которому присвоено значение True. Так вы сможете предварительно просмотреть изменения.

## <a name="scenario-startstop-vms-during-off-hours-job-fails-with-403-forbidden-error"></a><a name="403"></a>Сценарий. Сбой задания запуска и остановки виртуальных машин в нерабочее время с ошибкой "403 Запрещено"

### <a name="issue"></a>Проблема

Найдите задания, которые завершились с ошибкой `403 forbidden` для модулей Runbook с компонентом "Запуск и остановка виртуальных машин в нерабочее время".

### <a name="cause"></a>Причина

Эта проблема может быть вызвана неправильной настройкой или истекшим сроком действия учетной записи запуска от имени. Она также может быть связана с тем, что у учетной записи запуска от имени недостаточно разрешений на работу с ресурсами виртуальной машины.

### <a name="resolution"></a>Решение

Чтобы проверить правильность настройки учетной записи запуска от имени, перейдите в службу автоматизации на портале Azure и в разделе **Параметры учетной записи** выберите **Учетные записи запуска от имени**. Если учетная запись запуска от имени настроена неправильно или срок ее действия истек, ее статус указывает на состояние.

Если учетная запись запуска от имени настроена неправильно, следует удалить и повторно создать такую учетную запись. Дополнительные сведения см. в статье [учетные записи запуска от имени службы автоматизации Azure](../automation-security-overview.md#run-as-accounts).

Если срок действия сертификата для учетной записи запуска от имени истек, выполните действия, описанные в разделе [Обновление самозаверяющего сертификата](../manage-runas-account.md#cert-renewal), чтобы продлить сертификат.

Если отсутствуют разрешения, см. раздел [Краткое руководство. Использование портала Azure для просмотра ролей, назначенных пользователю](../../role-based-access-control/check-access.md). Необходимо указать идентификатор приложения для субъекта-службы, используемого учетной записью запуска от имени. Это значение можно получить, перейдя к учетной записи службы автоматизации на портале Azure. Выберите **Учетные записи запуска от имени** в разделе **Параметры учетной записи** и выберите соответствующую учетную запись запуска от имени.

## <a name="scenario-my-problem-isnt-listed-here"></a><a name="other"></a>Сценарий. Моя проблема отсутствует в списке

### <a name="issue"></a>Проблема

Во время использования компонента "Запуск и остановка виртуальных машин в нерабочее время" у вас возникла проблема или непредвиденный результат, которые не упомянуты на этой странице.

### <a name="cause"></a>Причина

Зачастую ошибки могут возникать из-за использования старых и устаревших версий компонента.

> [!NOTE]
> Компонент "Запуск и остановка виртуальных машин в нерабочее время" был протестирован с модулями Azure, импортированными в учетную запись службы автоматизации при развертывании этой функции на виртуальных машинах. Сейчас этот компонент не работает с более новыми версиями модуля Azure. Это ограничение влияет только на учетную запись службы автоматизации, которая используется для запуска компонента "Запуск и остановка виртуальных машин в нерабочее время". Вы по-прежнему можете использовать новые версии модуля Azure в других учетных записях службы автоматизации, как описано в разделе [Обновление модулей Azure PowerShell](../automation-update-azure-modules.md).

### <a name="resolution"></a>Решение

Чтобы устранить многие ошибки, удалите и [обновите компонент "Запуск и остановка виртуальных машин в нерабочее время"](../automation-solution-vm-management.md#update-the-feature). Также проверьте [потоки заданий](../automation-runbook-execution.md#job-statuses) на наличие ошибок. 

## <a name="next-steps"></a>Дальнейшие действия

Если вы не нашли здесь свою проблему или рекомендации не позволили ее решить, попробуйте использовать один из следующих каналов для получения дополнительной поддержки.

* Получите ответы специалистов Azure на [форумах Azure](https://azure.microsoft.com/support/forums/).
* Подпишитесь на [@AzureSupport](https://twitter.com/azuresupport) — официальный канал Microsoft Azure для работы с клиентами. Служба поддержки Azure взаимодействует с сообществом Azure, предоставляя ответы, поддержку и советы экспертов.
* Отправьте запрос в службу поддержки Azure Перейдите на [сайт поддержки Azure](https://azure.microsoft.com/support/options/) и выберите **Получить поддержку**.
