---
title: Управление учетной записью запуска от имени службы автоматизации Azure
description: В этой статье объясняется, как управлять учетной записью запуска от имени с помощью PowerShell или портала Azure.
services: automation
ms.subservice: ''
ms.date: 01/19/2021
ms.topic: conceptual
ms.openlocfilehash: f170fc948f136f4f46634e7ae2645ed2eb357afa
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "101096462"
---
# <a name="manage-an-azure-automation-run-as-account"></a>Управление учетной записью запуска от имени службы автоматизации Azure

Учетные записи запуска от имени в службе автоматизации Azure обеспечивают проверку подлинности для управления ресурсами в Azure Resource Manager или классической модели развертывания Azure с помощью модулей Runbook автоматизации и других функций автоматизации. В этой статье содержатся рекомендации по управлению учетной записью запуска от имени или классической.

Дополнительные сведения о проверке подлинности учетной записи службы автоматизации Azure и рекомендации, связанные с сценариями автоматизации процессов, [см. в](automation-security-overview.md)этой статье.

## <a name="renew-a-self-signed-certificate"></a><a name="cert-renewal"></a>Продление самозаверяющего сертификата

Срок действия самозаверяющего сертификата, созданного для учетной записи запуска от имени, составляет один год с даты создания. В определенный момент перед истечением срока действия учетной записи запуска от имени вам потребуется продлить сертификат. Его можно продлить в любое время до истечения его срока действия.

При продлении самозаверяющего сертификата текущий действительный сертификат сохраняется, чтобы гарантировать, что все модули runbook, которые поставлены в очередь или активно выполняются и для аутентификации которых используется учетная запись запуска от имени, не пострадают. Сертификат будет существовать до окончания срока действия.

>[!NOTE]
>Если вы считаете, что учетная запись запуска от имени была скомпрометирована, то можете удалить самозаверяющий сертификат и создать его заново.

>[!NOTE]
>Если вы настроили учетную запись запуска от имени службы автоматизации для использования сертификата, выданного корпоративным центром сертификации, и используете параметр продления самозаверяющего сертификата, то этот корпоративный сертификат будет заменен самозаверяющим сертификатом.

Чтобы продлить самозаверяющий сертификат, выполните следующие действия.

1. Войдите на [портал Azure](https://portal.azure.com).

1. Перейдите к учетной записи службы автоматизации и выберите **Учетные записи запуска от имени** в разделе параметров учетной записи.

    :::image type="content" source="media/manage-runas-account/automation-account-properties-pane.png" alt-text="Панель свойств учетной записи службы автоматизации.":::

1. На странице свойства **учетные записи запуска от имени** выберите учетную запись **запуска от имени** или **классическую учетную запись запуска от имени** в зависимости от учетной записи, для которой необходимо обновить сертификат.

1. На странице **Свойства** выбранной учетной записи выберите **Обновить сертификат**.

    :::image type="content" source="media/manage-runas-account/automation-account-renew-runas-certificate.png" alt-text="Продлите сертификат для учетной записи запуска от имени.":::

1. Ход обновления сертификата можно отслеживать в разделе **Уведомления** в меню.

## <a name="grant-run-as-account-permissions-in-other-subscriptions"></a>Предоставление разрешений учетной записи запуска от имени в других подписках

Служба автоматизации Azure поддерживает использование одной учетной записи службы автоматизации из одной подписки и запуск модулей Runbook для Azure Resource Managerных ресурсов в нескольких подписках. Эта конфигурация не поддерживает классическую модель развертывания Azure.

Вы назначаете субъекту-службе учетной записи запуска от имени роль [участника](../role-based-access-control/built-in-roles.md#contributor) в другой подписке или более широкие разрешения. Дополнительные сведения см. в статье [Управление доступом на основе ролей](automation-role-based-access-control.md) в службе автоматизации Azure. Чтобы назначить учетную запись запуска от имени роли в другой подписке, учетная запись пользователя, выполняющего эту задачу, должна быть членом роли **владельца** в этой подписке.

> [!NOTE]
> Эта конфигурация поддерживает только несколько подписок организации, использующих общий клиент Azure AD.

Перед предоставлением разрешений учетной записи запуска от имени необходимо сначала заметку отображаемого имени субъекта-службы для назначения.

1. Войдите на [портал Azure](https://portal.azure.com).
1. В учетной записи службы автоматизации в разделе **Параметры учетной записи** выберите **Учетные записи запуска от имени**.
1. Выберите **Azure Run As Account** (Учетная запись запуска от имени Azure).
1. Скопируйте или запишите значение для **отображаемого имени** на странице **учетной записи запуска от имени Azure** .

Чтобы получить подробные инструкции по добавлению назначений ролей, ознакомьтесь со следующими статьями в зависимости от того, какой метод вы хотите использовать.

* [Назначение ролей Azure с помощью портала Azure](../role-based-access-control/role-assignments-portal.md)
* [Назначение ролей Azure с помощью Azure PowerShell](../role-based-access-control/role-assignments-powershell.md)
* [Назначение ролей Azure с помощью Azure CLI](../role-based-access-control/role-assignments-cli.md)
* [Назначение ролей Azure с помощью REST API](..//role-based-access-control/role-assignments-rest.md)

После назначения роли учетной записи запуска от имени в модуле Runbook укажите, `Set-AzContext -SubscriptionId "xxxx-xxxx-xxxx-xxxx"` чтобы задать используемый контекст подписки. Дополнительные сведения см. в разделе [Set-азконтекст](/powershell/module/az.accounts/set-azcontext).

## <a name="limit-run-as-account-permissions"></a>Ограничение разрешений учетной записи запуска от имени

Чтобы управлять доступом службы автоматизации к ресурсам в Azure, можно запустить сценарий [Update-AutomationRunAsAccountRoleAssignments.ps1](https://aka.ms/AA5hug8). Этот сценарий изменяет существующий субъект-службу учетной записи запуска от имени, чтобы создать и использовать пользовательское определение роли. Это роль с разрешениями для всех ресурсов, кроме [Key Vault](../key-vault/index.yml).

>[!IMPORTANT]
>После запуска сценария **Update-AutomationRunAsAccountRoleAssignments.ps1** модули runbook, которые обращаются к Key Vault с помощью учетных записей запуска от имени, больше не будут работать. Перед выполнением сценария необходимо проверить модули runbook в вашей учетной записи на наличие вызовов к Azure Key Vault. Чтобы разрешить доступ к Key Vault из модулей runbook службы автоматизации Azure, необходимо [добавить учетную запись запуска от имени в разрешения Key Vault](#add-permissions-to-key-vault).

Если необходимо дополнительно ограничить действия, которые может выполнять субъект-служба, можно добавить другие типы ресурсов в `NotActions` элемент определения пользовательской роли. В следующем примере ограничивается доступ к `Microsoft.Compute/*`. Если вы добавите этот тип ресурса в `NotActions` в определении роли, данная роль не сможет предоставить доступ к вычислительному ресурсу. Чтобы узнать больше об определениях ролей, ознакомьтесь с разделом [Общие сведения об определениях ролей для ресурсов Azure](../role-based-access-control/role-definitions.md).

```powershell
$roleDefinition = Get-AzRoleDefinition -Name 'Automation RunAs Contributor'
$roleDefinition.NotActions.Add("Microsoft.Compute/*")
$roleDefinition | Set-AzRoleDefinition
```

Вы можете определить, назначена ли субъект-служба, используемая вашей учетной записью запуска от имени, роли **участника** или пользователя.

1. Войдите на [портал Azure](https://portal.azure.com).
1. Перейдите к учетной записи службы автоматизации и выберите **Учетные записи запуска от имени** в разделе параметров учетной записи.
1. Выберите **Azure Run As Account** (Учетная запись запуска от имени Azure).
1. Выберите **Роль**, чтобы указать используемое определение роли.

:::image type="content" source="media/manage-runas-account/verify-role.png" alt-text="Проверьте роль учетной записи запуска от имени." lightbox="media/manage-runas-account/verify-role-expanded.png":::

Можно также задать определение роли, используемое учетными записями запуска от имени, для нескольких подписок или учетных записей автоматизации. Для этого используйте сценарий [Check-AutomationRunAsAccountRoleAssignments.ps1](https://aka.ms/AA5hug5) из коллекции PowerShell.

### <a name="add-permissions-to-key-vault"></a>Добавление разрешений в Key Vault

Вы можете разрешить службе автоматизации Azure проверять, используют ли Key Vault и субъект-служба учетной записи запуска от имени пользовательское определение роли. Необходимо сделать следующее:

* Предоставьте разрешения для Key Vault.
* Настройте политику доступа.

Вы можете использовать скрипт [Extend-AutomationRunAsAccountRoleAssignmentToKeyVault.ps1](https://aka.ms/AA5hugb) в коллекция PowerShell, чтобы предоставить учетной записи запуска от имени разрешения на Key Vault. Дополнительные сведения о настройке разрешений для Key Vault см. в разделе [Назначение политики доступа Key Vault](../key-vault/general/assign-access-policy-powershell.md) .

## <a name="resolve-misconfiguration-issues-for-run-as-accounts"></a>Устранение проблем из-за неправильной конфигурации учетных записей запуска от имени

Во время начальной настройки некоторые из элементов конфигурации, необходимых для работы обычной или классической учетной записи запуска от имени, могут быть удалены или неправильно созданы. Возможные случаи неправильной конфигурации включают в себя:

* ресурс сертификата;
* ресурс подключения;
* удаление учетной записи запуска от имени из роли участника;
* субъект-службу или приложение в Azure AD.

В случае такой неправильной конфигурации учетная запись службы автоматизации обнаружит эти изменения и отобразит в области свойств учетных записей запуска от имени состояние *Не выполнено*.

:::image type="content" source="media/manage-runas-account/automation-account-runas-config-incomplete.png" alt-text="Неполная конфигурация учетной записи запуска от имени.":::

При выборе учетной записи запуска от имени в области свойств учетной записи отобразится приведенное ниже сообщение об ошибке.

```text
The Run As account is incomplete. Either one of these was deleted or not created - Azure Active Directory Application, Service Principal, Role, Automation Certificate asset, Automation Connect asset - or the Thumbprint is not identical between Certificate and Connection. Please delete and then re-create the Run As Account.
```

Вы можете быстро устранить проблемы с учетной записью запуска от имени, [удалив](delete-run-as-account.md) и [повторно создав](create-run-as-account.md) учетную запись запуска от имени.

## <a name="next-steps"></a>Дальнейшие действия

* [Объекты приложения и субъекта-службы](../active-directory/develop/app-objects-and-service-principals.md)
* [Общие сведения о сертификатах для Облачных служб Azure](../cloud-services/cloud-services-certs-create.md)
* Сведения о создании или повторном создании учетной записи запуска от имени см. в разделе [Создание учетной записи запуска от имени](create-run-as-account.md).
* Если вам больше не нужно использовать учетную запись запуска от имени, см. статью [Удаление учетной записи запуска от имени](delete-run-as-account.md).