---
title: Создание графических модулей Runbook в службе автоматизации Azure
description: В этой статье содержатся сведения о создании графических модулей Runbook без работы с кодом.
services: automation
ms.subservice: process-automation
ms.date: 03/16/2018
ms.topic: conceptual
ms.openlocfilehash: bbac794263fec176e03c7148d860c479a2ed9d39
ms.sourcegitcommit: 15d27661c1c03bf84d3974a675c7bd11a0e086e6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/09/2021
ms.locfileid: "102501234"
---
# <a name="author-graphical-runbooks-in-azure-automation"></a>Создание графических модулей Runbook в службе автоматизации Azure

Все модули Runbook в службе автоматизации Azure представляют собой рабочие процессы Windows PowerShell. Графические модули Runbook и графические модули Runbook рабочего процесса PowerShell создают код PowerShell, который запускается рабочими ролями службы автоматизации. Вы не можете просмотреть или изменить этот код. Графический модуль Runbook можно преобразовать в графический модуль Runbook рабочего процесса PowerShell и наоборот. Однако эти модули Runbook нельзя преобразовать в текстовый модуль Runbook. Кроме того, графический редактор службы автоматизации не может импортировать текстовый модуль Runbook.

Графическая разработка позволяет создавать модули Runbook для службы автоматизации Azure без необходимости написания кода в рамках рабочего процесса PowerShell или использования Windows PowerShell. Вы добавляете на холст действия из библиотеки командлетов и модулей Runbook, а затем связываете и настраиваете их, создавая рабочий процесс. Если вам приходилось работать с System Center Orchestrator или Service Management Automation (SMA), графическая разработка не вызовет сложностей. Эта статья содержит вводные сведения об основных понятиях, необходимые, чтобы приступить к созданию графического модуля Runbook.

## <a name="overview-of-graphical-editor"></a>Обзор графического редактора

Графический редактор можно открыть на портале Azure, создав или открыв для редактирования графический Runbook.

![Графическая рабочая область](media/automation-graphical-authoring-intro/runbook-graphical-editor.png)

В следующих разделах описываются элементы управления в графическом редакторе.

### <a name="canvas-control"></a>Элемент управления "Холст"

Элемент управления "Холст" позволяет проектировать модуль Runbook. Вы можете добавлять в Runbook действия из узлов в элементе управления "Библиотека" и соединять их с помощью связей, чтобы определить логику Runbook. Для увеличения и уменьшения масштаба можно использовать элементы управления в нижней части холста.

### <a name="library-control"></a>Элемент управления "Библиотека"

Элемент управления "Библиотека" позволяет выбирать [действия](#use-activities) для добавления в модуль Runbook. Вы добавляете их на холст, где можете соединить их с другими действиями. Элемент управления "Библиотека" содержит разделы, определенные в следующей таблице.

| Section | Описание |
|:--- |:--- |
| Командлеты |Все командлеты, которые могут использоваться в модуле Runbook. Командлеты группируются по модулям. Доступны все модули, которые установлены в учетной записи службы автоматизации. |
| Модули runbook |Модули Runbook в учетной записи службы автоматизации. Эти модули Runbook можно добавлять на холст, чтобы использовать их как дочерние модули. Отображаются только модули Runbook, тип которых совпадает с типом редактируемого модуля Runbook. Для графических модулей Runbook отображаются только модули Runbook на основе PowerShell. Для графических модулей Runbook рабочего процесса PowerShell отображаются только модули Runbook на основе рабочих процессов PowerShell. |
| Активы |Содержит [ресурсы службы автоматизации](/previous-versions/azure/dn939988(v=azure.100)) в учетной записи службы автоматизации, которые можно использовать в модуле Runbook. При добавлении ресурса в модуль Runbook добавляется действие рабочего процесса, которое получает выбранный ресурс. В случае ресурсов переменных можно либо добавить действие для получения переменной, либо задать переменную. |
| Элемент управления "Runbook" |Действия элемента управления "Модуль Runbook", которые могут использоваться в текущем модуле Runbook. Действие "Соединение" принимает несколько наборов входных данных и ожидает завершения их обработки, прежде чем продолжать рабочий процесс. Действие "Код" выполняет одну или несколько строк кода PowerShell или рабочего процесса PowerShell в зависимости от типа графического модуля Runbook. Это действие можно использовать в пользовательском коде или функции, которую не удается реализовать иными способами. |

### <a name="configuration-control"></a>Элемент управления "Конфигурация"

Элемент управления "Конфигурация" позволяет указывать сведения для объекта, выбранного на холсте. Свойства, доступные в этом элементе управления, зависят от типа выбранного объекта. При выборе параметра в элементе управления "Конфигурация" открываются дополнительные колонки с дополнительной информацией.

### <a name="test-control"></a>Элемент управления "Тест"

Элемент управления "Тест" не отображается при первом запуске графического редактора. Он открывается, когда вы интерактивно тестируете графический модуль Runbook.

## <a name="use-activities"></a>Использование действий

Действия являются стандартными блоками модуля Runbook. Действием может быть командлет PowerShell, дочерний Runbook или рабочий процесс. Вы можете добавить действие в модуль Runbook, щелкнув его правой кнопкой мыши в элементе управления "Библиотека" и выбрав пункт **Добавить на холст**. Затем можно щелкнуть и перетащить действие, чтобы поместить его на холсте туда, куда необходимо. Расположение действия на холсте никак не влияет на работу модуля Runbook. Модуль Runbook можно располагать любым способом, который сочтете наиболее подходящим для визуализации его работы.

![Добавить на холст](media/automation-graphical-authoring-intro/add-to-canvas-cmdlet.png)

Выберите действие на холсте, чтобы настроить его свойства и параметры в колонке "Конфигурация". Вы можете заменить метку действия именем, которое будет его описывать. Модуль Runbook по-прежнему выполняет исходный командлет. Вы просто изменяете отображаемое имя, используемое в графическом редакторе. Учтите, что метки должны быть уникальными в пределах модуля Runbook.

### <a name="parameter-sets"></a>Наборы параметров

Набор параметров определяет обязательные и необязательные параметры, которые принимают значения для определенного командлета. У каждого командлета имеется по крайней мере один набор параметров, а у некоторых их несколько. Если у командлета несколько наборов параметров, перед настройкой параметров необходимо выбрать, какой из них использовать. Можно изменить набор параметров, используемый действием, щелкнув **Набор параметров** и выбрав другой набор. В этом случае все уже настроенные значения параметров будут потеряны.

В следующем примере у командлета [Get-AzVM](/powershell/module/az.compute/get-azvm) три набора параметров. В этом примере используется один набор **ListVirtualMachineInResourceGroupParamSet** для возврата всех виртуальных машин в группе ресурсов. В набор входит один необязательный параметр. В примере также используется набор параметров **GetVirtualMachineInResourceGroupParamSet** для указания возвращаемой виртуальной машины. Этот набор содержит два обязательных параметра и один необязательный параметр.

![Набор параметров](media/automation-graphical-authoring-intro/get-azvm-parameter-sets.png)

#### <a name="parameter-values"></a>Значения параметра

При указании значения для параметра вы выбираете источник данных, чтобы определить, как будет указано значение. Источники данных, доступные для определенного параметра, зависят от допустимых значений для этого параметра. Например, значение NULL недоступно для параметра, который не допускает значений NULL.

| Источник данных | Описание |
|:--- |:--- |
| Постоянное значение |Введите значение для параметра. Этот источник данных доступен только для следующих типов данных: Int32, Int64, String, Boolean, DateTime, Switch. |
| Выходные данные действия |Используйте выходные данные действия, предшествующего текущему действию в рабочем процессе. Будут перечислены все допустимые действия. Для значения параметра используйте только действие, которое создает выходные данные. Если действие выводит объект с несколькими свойствами, после выбора действия можно ввести имя конкретного свойства. |
| Входные данные Runbook |Выберите входные данные модуля Runbook в качестве входных данных для параметра действия. |
| Ресурс переменной |Выберите переменную службы автоматизации в качестве входных данных. |
| Ресурс учетных данных |Выберите учетные данные службы автоматизации в качестве входных данных. |
| Ресурс сертификата |Выберите сертификат службы автоматизации в качестве входных данных. |
| Ресурс подключения |Выберите подключение службы автоматизации в качестве входных данных. |
| Выражение PowerShell |Укажите простое [выражение PowerShell](#work-with-powershell-expressions). Выражение оценивается перед выполнением действия, и его результат используется в качестве значения параметра. Вы можете использовать переменные, чтобы ссылаться на выходные данные действия или входной параметр Runbook. |
| Не настроено |Очищает все значения, которые были настроены ранее. |

#### <a name="optional-additional-parameters"></a>Необязательные дополнительные параметры

Для всех командлетов можно предоставить дополнительные параметры. Это могут быть общие параметры PowerShell или другие пользовательские параметры. В графическом редакторе появится текстовое поле, где можно будет указать параметры с помощью синтаксиса PowerShell. Например, чтобы использовать общий параметр `Verbose`, необходимо указать `-Verbose:$True`.

### <a name="retry-activity"></a>Повтор действий

Возможность повтора обеспечивает многократное выполнение действий — пока не будет выполнено определенное условие, как в цикле. Эта функция используется для действий, которые необходимо выполнить несколько раз (включая те, которые могут выполняться с ошибками), а также для проверки допустимости выходных данных действия.

Включая для действия режим повтора, можно задать условие и значение задержки. Задержка — это время (в секундах или минутах) ожидания модуля runbook перед повторным выполнением действия. Если задержка не указана, действие выполняется снова сразу же после завершения.

:::image type="content" source="media/automation-graphical-authoring-intro/retry-delay.png" alt-text="Снимок экрана: включение параметров функции &quot;включить повторы&quot;.":::

Условие повтора — это выражение PowerShell, которое вычисляется после каждого выполнения действия. Если выражение возвращает значение True, действие выполняется повторно. Если выражение возвращает значение False, действие не выполняется повторно, а модуль Runbook переходит к следующему действию.

:::image type="content" source="media/automation-graphical-authoring-intro/retry-condition.png" alt-text="Снимок экрана, показывающий повторную попытку до наступления этого условия, и примеры выражений PowerShell, которые могут использоваться в условии повтора.":::

В качестве условия повтора может использоваться переменная с именем `RetryData`, которая предоставляет доступ к сведениям о попытках выполнить действие. У этой переменной есть свойства, приведенные в таблице ниже.

| Свойство | Описание |
|:--- |:--- |
| `NumberOfAttempts` |Количество запусков действия. |
| `Output` |Результат последнего выполнения действия. |
| `TotalDuration` |Время с момента первого запуска действия. |
| `StartedAt` |Время первого запуска действия в формате UTC. |

Ниже приведены примеры условий, при которых действие выполняется повторно.

```powershell-interactive
# Run the activity exactly 10 times.
$RetryData.NumberOfAttempts -ge 10
```

```powershell-interactive
# Run the activity repeatedly until it produces any output.
$RetryData.Output.Count -ge 1
```

```powershell-interactive
# Run the activity repeatedly until 2 minutes has elapsed.
$RetryData.TotalDuration.TotalMinutes -ge 2
```

Когда вы настроите для действия условия запуска повторных попыток, действие будет отображать два напоминания. Одно включено в само действие, а второе отображается при проверке конфигурации действия.

![Визуальные индикаторы повторения действия](media/automation-graphical-authoring-intro/runbook-activity-retry-visual-cue.png)

### <a name="workflow-script-control"></a>Элемент управления сценария рабочего процесса

Элемент управления "Сценарий" рабочего процесса — это специальное действие, которое принимает сценарий PowerShell или рабочего процесса PowerShell (в зависимости от типа создаваемого графического модуля Runbook), обеспечивая возможности, которые иначе могут быть недоступными. Этот элемент управления предоставляет функциональные возможности, которые могут быть недоступны в других средствах. Он не может принимать параметры, но может использовать переменные для выходных данных действия и входных параметров Runbook. Все выходные данные действия добавляются в шину данных. Исключением являются выходные данные без исходящей связи. В этом случае выходные данные добавляются в выходные данные модуля Runbook.

Например, следующий код выполняет вычисление дат с помощью входной переменной модуля Runbook — `NumberOfDays`. Затем он отправляет вычисленную дату и время как выходные данные для использования последующими действиями в модуле Runbook.

```powershell-interactive
$DateTimeNow = (Get-Date).ToUniversalTime()
$DateTimeStart = ($DateTimeNow).AddDays(-$NumberOfDays)}
$DateTimeStart
```

## <a name="use-links-for-workflow"></a>Использование связей для рабочего процесса

Связь в графическом модуле Runbook соединяет два действия. Она отображается на холсте как стрелка от исходного действия к действию назначения. Действия выполняются в направлении стрелки: действие назначения запускается после завершения исходного действия.

### <a name="create-a-link"></a>Создание связи

Можно создать связь между двумя действиями, выбрав исходное действие и щелкнув круг в нижней части фигуры. Перетащите стрелку к действию назначения и отпустите ее.

![Создание связи](media/automation-graphical-authoring-intro/create-link-options.png)

Выберите связь, чтобы настроить ее свойства в колонке "Конфигурация". Свойства включают тип связи, который описан в следующей таблице.

| Тип связи | Описание |
|:--- |:--- |
| Pipeline |Действие назначения выполняется один раз для каждого вывода объекта из исходного действия. Действие назначения не выполняется, если исходное действие не создает выходные данные. Выходные данные из исходного действия доступны в виде объекта. |
| Последовательность |Действие назначения выполняется только один раз при получении выходных данных из исходного действия. Выходные данные из исходного действия доступны в виде массива объектов. |

### <a name="start-runbook-activity"></a>Действие запуска модуля Runbook

Графический модуль runbook начнется с любых действий, у которых нет входящей связи. Часто существует только одно действие, которое выступает в качестве начального действия модуля Runbook. Если у нескольких действий нет входящих связей, модуль Runbook запустится при их одновременном выполнении. Затем, по завершении каждого из них, он будет переходить по связям, выполняя другие действия.

### <a name="specify-link-conditions"></a>Указание условий связи

Если для связи указано условие, действие назначения выполняется, только если условие возвращает значение True. Для извлечения результата из исходного действия обычно используется переменная `ActivityOutput` в условии.

Для связи конвейера необходимо указать условие для одного объекта. Модуль Runbook вычисляет условие для выходных данных каждого выходного объекта с помощью исходного действия. Затем он выполняет действие с каждым объектом, который удовлетворяет условию. Например, если исходное действие — `Get-AzVM`, следующий синтаксис можно использовать в условной последовательной связи для получения только виртуальных машин, входящих в группу ресурсов Group1.

```powershell-interactive
$ActivityOutput['Get Azure VMs'].Name -match "Group1"
```

Для последовательной связи модуль Runbook вычисляет условие только один раз, так как возвращается один массив, содержащий все объекты из исходного действия. В связи с этим модуль Runbook не может использовать последовательную связь для фильтрации, как это можно сделать с помощью связи конвейера. Последовательная связь может просто определить, выполняется ли следующее действие.

Рассмотрим в качестве примера следующий набор действий в модуле Runbook для **запуска виртуальной машины**.

![Условная связь с последовательностями](media/automation-graphical-authoring-intro/runbook-conditional-links-sequence.png)

Модуль Runbook использует три различные связи с последовательностями, которые проверяют значения входных параметров `VMName` и `ResourceGroupName` для определения необходимого действия. Возможные действия: запуск одной виртуальной машины, запуск всех виртуальных машин в группе ресурсов или запуск всех виртуальных машин в подписке. Ниже приведена логика условия для связи с последовательностью между `Connect to Azure` и `Get single VM`.

```powershell-interactive
<#
Both VMName and ResourceGroupName runbook input parameters have values
#>
(
(($VMName -ne $null) -and ($VMName.Length -gt 0))
) -and (
(($ResourceGroupName -ne $null) -and ($ResourceGroupName.Length -gt 0))
)
```

При использовании условной связи данные из исходного действия, доступные для других действий в этой ветви, фильтруются по условию. Если действие является источником нескольких связей, данные, доступные для действий в каждой ветви, зависят от условия в связи, присоединенной к этой ветви.

Например, действие `Start-AzVM` в модуле Runbook ниже запускает все виртуальные машины. Действие включает две условные связи. Первая условная ссылка использует выражение `$ActivityOutput['Start-AzVM'].IsSuccessStatusCode -eq $true` для фильтрации успешного завершения действия `Start-AzVM`. Вторая условная ссылка использует выражение `$ActivityOutput['Start-AzVM'].IsSuccessStatusCode -ne $true` для фильтрации, если действию `Start-AzVm` не удается запустить виртуальную машину.

![Пример условной связи](media/automation-graphical-authoring-intro/runbook-conditional-links.png)

Любое действие, следующее по первой связи и использующее выходные данные действия `Get-AzureVM`, получит только виртуальные машины, которые были запущены на момент выполнения действия`Get-AzureVM`. Любое действие, которое следует по второй связи, получит только виртуальные машины, которые были остановлены на момент выполнения действия `Get-AzureVM`. Действие, следующее по третьей связи, получит все виртуальные машины вне зависимости от того, запущены они или нет.

### <a name="use-junctions"></a>Использование соединений

Соединение — это специальное действие, которое ожидает завершения всех входящих ветвей. Это дает возможность модулю Runbook параллельно выполнять несколько действий и гарантировать, что все они будут завершены перед выполнением следующего шага.

Хотя у соединения может быть неограниченное число входящих связей, конвейерной может быть только одна из них. Число входящих последовательных связей не ограничено. Вы сможете создать соединение с несколькими входящими конвейерными связями и сохранить модуль Runbook, но его запуск завершится ошибкой.

В приведенном ниже примере показана часть Runbook, которая запускает набор виртуальных машин, одновременно скачивая исправления для них. Она использует соединение, чтобы гарантировать, что оба процесса будут выполнены, прежде чем выполнение модуля Runbook будет продолжено.

![Соединение](media/automation-graphical-authoring-intro/runbook-junction.png)

### <a name="work-with-cycles"></a>Работа с циклами

Циклический процесс формируется, когда действие назначения обратно связывается с исходным действием или другим действием, которое в конечном итоге обратно связывается с его исходным действием. В настоящее время графическая разработка не поддерживает циклы. Если runbook содержит циклический процесс, он будет сохранен правильно, но при его выполнении произойдет ошибка.

![Циклический процесс](media/automation-graphical-authoring-intro/runbook-cycle.png)

### <a name="share-data-between-activities"></a>Обмен данными между действиями

Любые данные, которые выводятся действием с исходящей связью, записываются в шину данных для модуля Runbook. Любое действие в Runbook может использовать данные в шине данных, чтобы заполнить значения параметров или добавить эти данные в код сценария. Действие может обращаться к выходным данным любого предыдущего действия в рабочем процессе.

То, как данные записываются в шину данных, зависит от типа связи действия. Для конвейерной связи данные выводятся в виде нескольких объектов. Для последовательной связи данные выводятся в виде массива. Если имеется только одно значение, оно выводится в виде одноэлементного массива.

Модуль Runbook может получать доступ к данным в шине данных двумя способами: 
* с использованием источника выходных данных действия;
* с использованием источника данных выражения PowerShell.

Первый механизм использует источник данных выходных данных действия для заполнения параметра другого действия. Если выходными данными является объект, модуль Runbook может указать одно свойство.

![выходные данные действия](media/automation-graphical-authoring-intro/activity-output-datasource-revised20165.png)

Второй механизм доступа к данным получает выходные данные действия в источнике данных выражения PowerShell или действие сценария рабочего процесса с переменной `ActivityOutput`, используя приведенный ниже синтаксис. Если выходными данными является объект, модуль Runbook может указать одно свойство.

```powershell-interactive
$ActivityOutput['Activity Label']
$ActivityOutput['Activity Label'].PropertyName
```

### <a name="use-checkpoints"></a>Использование контрольных точек

В графическом модуле Runbook рабочего процесса PowerShell можно указать [контрольные точки](automation-powershell-workflow.md#use-checkpoints-in-a-workflow), выбрав параметр **Создать контрольную точку модуля Runbook** для любого действия. Это настраивает создание контрольной точки после выполнения действия.

![Контрольная точка](media/automation-graphical-authoring-intro/set-checkpoint.png)

Контрольные точки доступны только в графических модулях Runbook рабочего процесса PowerShell (соответственно, в графических модулях Runbook они недоступны). Если модуль Runbook использует командлеты Azure, он должен выполнять все действия с контрольными точками с помощью действия `Connect-AzAccount`. Операция подключения используется в случае, если модуль Runbook приостановлен и должен быть перезапущен из этой контрольной точки в другом рабочем процессе.

## <a name="handle-runbook-input"></a>Обработка выходных данных модуля Runbook

Может потребоваться ввод от пользователя, запускающего модуль Runbook на портале Azure, или из другого модуля Runbook, если текущий используется в качестве дочернего. Например, для модуля Runbook, который создает виртуальную машину, при каждом запуске Runbook пользователю может потребоваться предоставлять такие данные, как имя виртуальной машины и другие свойства.

Модуль Runbook принимает входные данные, определяя один или несколько входных параметров. Пользователь указывает значения для этих параметров при каждом запуске Runbook. Когда пользователь запускает модуль Runbook с помощью портал Azure, ему предлагается указать значения для каждого входного параметра, поддерживаемого модулем Runbook.

При создании модуля Runbook его параметры можно открыть, нажав кнопку **Вход и выход** на панели инструментов Runbook. Откроется элемент управления "Вход и выход", в котором можно изменить существующий входной параметр или создать новый, нажав кнопку **Добавить входные данные**.

![Добавить входные данные](media/automation-graphical-authoring-intro/runbook-edit-add-input.png)

Каждый входной параметр определяется с помощью свойств, указанных в следующей таблице:

| Свойство | Описание |
|:--- |:--- |
| Имя | Обязательный элемент. Имя параметра. Имя должно быть уникальным в пределах модуля Runbook. Имя должно начинаться с буквы, оно может содержать только буквы, цифры и символы подчеркивания. Имя не может содержать пробел. |
| Описание |Необязательный параметр. Описание предназначения входного параметра. |
| Тип | Необязательный параметр. Предполагаемый тип данных значения параметра. Портал Azure предоставит соответствующий элемент управления для типа данных каждого параметра при запросе ввода его значения. Поддерживаемые типы параметров: String, Int32, Int64, Decimal, Boolean, DateTime и Object. Если тип данных не выбран, то по умолчанию используется String.|
| Обязательный | Необязательный параметр. Параметр, который указывает, должно ли быть задано значение для параметра. Если выбрано `yes`, при запуске модуля будет необходимо указывать значение. Если выбрано `no`, ввод значения при запуске модуля не будет обязательным и можно установить значение по умолчанию. Запустить Runbook не удастся, если не указать значение для каждого обязательного параметра, у которого нет определенного значения по умолчанию. |
| Значение по умолчанию | Необязательный параметр. Значение, используемое для параметра, если перемер не передается при запуске модуля Runbook. Чтобы установить значение по умолчанию, выберите `Custom`. Выберите `None`, если не нужно использовать значения по умолчанию. |

## <a name="handle-runbook-output"></a>Обработка выходных данных Runbook

Графическая разработка сохраняет в [выходных данных модуля Runbook](./automation-runbook-output-and-messages.md) данные, созданные каким-либо действием,которые не имеют исходящей связи. Выходные данные сохраняются заданием Runbook и доступны родительскому модулю Runbook, если Runbook используется как дочерний.

## <a name="work-with-powershell-expressions"></a>Работа с выражениями PowerShell

Одним из преимуществ графической разработки является возможность создавать модули Runbook, располагая минимальными знаниями о PowerShell. В настоящее время необходимо знать лишь некоторые общие принципы работы с PowerShell для заполнения определенных [значений параметров](#use-activities) и настройки [условий связи](#use-links-for-workflow). В этом разделе содержатся краткие сведения о выражениях PowerShell. Полные сведения о PowerShell можно найти в статье [Создание сценариев с помощью Windows PowerShell](/powershell/scripting/overview).

### <a name="use-a-powershell-expression-as-a-data-source"></a>Использование выражения PowerShell в качестве источника данных

Выражение PowerShell можно использовать в качестве источника данных для заполнения значения [параметра действия](#use-activities) результатами кода PowerShell. Выражением может быть одна строка кода, которая выполняет простые функции, или несколько строк, выполняющие определенную сложную логику. Любые выходные данные команды, не присвоенные переменной, выводятся в значении параметра.

Например, следующая команда выводит текущую дату.

```powershell-interactive
Get-Date
```

Следующий фрагмент кода создает строку из текущей даты и присваивают ее переменной. Затем код передает содержимое переменной в выходные данные.

```powershell-interactive
$string = "The current date is " + (Get-Date)
$string
```

Следующие команды вычисляют текущую дату и возвращают строку, указывающую, является ли текущий день выходным или рабочим.

```powershell-interactive
$date = Get-Date
if (($date.DayOfWeek = "Saturday") -or ($date.DayOfWeek = "Sunday")) { "Weekend" }
else { "Weekday" }
```

### <a name="use-activity-output"></a>Использование выходных данных действия

Чтобы использовать выходные данные предыдущего действия в модуле Runbook, используйте переменную `ActivityOutput` со следующим синтаксисом.

```powershell-interactive
$ActivityOutput['Activity Label'].PropertyName
```

Например, можно использовать действие со свойством, которое требует указать имя виртуальной машины. В этом случае модуль Runbook может применять следующее выражение.

```powershell-interactive
$ActivityOutput['Get-AzureVM'].Name
```

При наличии свойства, требующего объект виртуальной машины только имени, модуль Runbook возвращает весь объект, используя следующий синтаксис.

```powershell-interactive
$ActivityOutput['Get-AzureVM']
```

Модуль Runbook может использовать выходные данные действия в более сложном выражении, как показано ниже. Это выражение объединяет текст с именем виртуальной машины.

```powershell-interactive
"The computer name is " + $ActivityOutput['Get-AzureVM'].Name
```

### <a name="compare-values"></a>Сравнение значений

Используйте [операторы сравнения](/powershell/module/microsoft.powershell.core/about/about_comparison_operators) для сравнения значений или определения того, соответствует ли значение указанному шаблону. Оператор сравнения возвращает значение True или False.

Например, следующее условие определяет, остановлена ли виртуальная машина из действия `Get-AzureVM` в данный момент.

```powershell-interactive
$ActivityOutput["Get-AzureVM"].PowerState –eq "Stopped"
```

Следующее условие проверяет, находится ли та же виртуальная машина в любом состоянии, кроме остановленного.

```powershell-interactive
$ActivityOutput["Get-AzureVM"].PowerState –ne "Stopped"
```

В модуле Runbook можно объединить несколько условий с помощью [логического оператора](/powershell/module/microsoft.powershell.core/about/about_logical_operators), например `-and` или `-or`. Например, следующее условие проверяет, находится ли виртуальная машина из предыдущего примера в состоянии "Остановлена" или "Останавливается".

```powershell-interactive
($ActivityOutput["Get-AzureVM"].PowerState –eq "Stopped") -or ($ActivityOutput["Get-AzureVM"].PowerState –eq "Stopping")
```

### <a name="use-hashtables"></a>Использование хэш-таблиц

[Хэш-таблицы](/powershell/module/microsoft.powershell.core/about/about_hash_tables) представляют собой пары "имя-значение", которые удобны для получения набора значений. Иногда хэш-таблицу называют словарем. Свойства для определенных действий ожидают хэш-таблицу вместо простого значения.

Хэш-таблицу можно создать, используя следующий синтаксис. Она содержит любое количество записей, каждая из которых определяется именем и значением.

```powershell-interactive
@{ <name> = <value>; [<name> = <value> ] ...}
```

Например, следующее выражение создает хэш-таблицу для использования в качестве источника данных для параметра действия, который ожидает хэш-таблицу со значениями для поиска в Интернете.

```powershell-interactive
$query = "Azure Automation"
$count = 10
$h = @{'q'=$query; 'lr'='lang_ja';  'count'=$Count}
$h
```

В следующем примере выходные данные действия `Get Twitter Connection` используются для заполнения хэш-таблицы.

```powershell-interactive
@{'ApiKey'=$ActivityOutput['Get Twitter Connection'].ConsumerAPIKey;
    'ApiSecret'=$ActivityOutput['Get Twitter Connection'].ConsumerAPISecret;
    'AccessToken'=$ActivityOutput['Get Twitter Connection'].AccessToken;
    'AccessTokenSecret'=$ActivityOutput['Get Twitter Connection'].AccessTokenSecret}
```

## <a name="authenticate-to-azure-resources"></a>Проверка подлинности в ресурсах Azure

В службе автоматизации Azure для модулей runbook, которые управляют ресурсами Azure, требуется проверка подлинности. Для доступа к ресурсам Azure Resource Manager в подписке с помощью модулей Runbook службы автоматизации по умолчанию используется [учетная запись запуска от имени](./automation-security-overview.md) (также называемая субъектом-службой). Эту функцию можно включить в графический модуль Runbook, добавив ресурс-контейнер подключения `AzureRunAsConnection`, который использует для работы с холстом командлет PowerShell [Get-AutomationConnection](/system-center/sma/manage-global-assets). Можно также добавить командлет [Connect-AzAccount](/powershell/module/az.accounts/connect-azaccount). Этот сценарий показан в примере ниже.

![Действия аутентификации запуска от имени](media/automation-graphical-authoring-intro/authenticate-run-as-account.png)

Действие `Get Run As Connection` или `Get-AutomationConnection` настроено с использованием источника данных постоянного значения с именем `AzureRunAsConnection`.

![Конфигурация подключения запуска от имени](media/automation-graphical-authoring-intro/authenticate-runas-parameterset.png)

Следующее действие `Connect-AzAccount` добавляет учетную запись запуска от имени с выполненной аутентификацией для использования в модуле Runbook.

![Набор параметров Connect-AzAccount](media/automation-graphical-authoring-intro/authenticate-conn-to-azure-parameter-set.png)

>[!NOTE]
>Для модулей runbook PowerShell `Add-AzAccount` и `Add-AzureRMAccount` являются псевдонимами для `Connect-AzAccount`. Обратите внимание, что эти псевдонимы недоступны для графических модулей runbook. Графический модуль Runbook может использовать только `Connect-AzAccount`.

Для полей параметров **APPLICATIONID**, **CERTIFICATETHUMBPRINT** и **TENANTID** укажите имя свойства для пути к полю, так как действие выводит объект с несколькими свойствами. Иначе при выполнении модуля Runbook попытка выполнения проверки подлинности завершится ошибкой. Это минимальные требования для проверки подлинности модуля Runbook с использованием учетной записи запуска от имени.

Некоторые подписчики создают учетную запись службы автоматизации с помощью [учетной записи пользователя Azure AD](./shared-resources/credentials.md) для управления классическим развертыванием Azure или для ресурсов Azure Resource Manager. В целях обеспечения обратной совместимости для этих подписчиков в модуле Runbook применяется следующий механизм проверки подлинности: командлет `Add-AzureAccount` с [ ресурсом-контейнером учетных данных](./shared-resources/credentials.md). Ресурс представляет пользователя Active Directory с доступом к учетной записи Azure.

Чтобы включить эту возможность для графического модуля Runbook, добавьте на холст ресурс-контейнер учетных данных, а затем — действие `Add-AzureAccount`, которое использует этот ресурс в качестве своих входных данных. См. указанный ниже пример.

![Действия аутентификации](media/automation-graphical-authoring-intro/authentication-activities.png)

Модуль Runbook должен проходить проверку подлинности в начале и после каждой контрольной точки. Поэтому после любого действия `Checkpoint-Workflow`следует использовать действие `Add-AzureAccount`. Дополнительное действие учетных данных не требуется

![Выходные данные действия](media/automation-graphical-authoring-intro/authentication-activity-output.png)

## <a name="export-a-graphical-runbook"></a>Экспорт графического модуля Runbook

Можно экспортировать только опубликованную версию графического модуля Runbook. Если модуль Runbook еще не опубликован, кнопка **Экспорт** недоступна. При нажатии кнопки **Экспорт** модуль Runbook скачивается на локальный компьютер. Имя файла соответствует имени модуля Runbook. Расширение файла — **GRAPHRUNBOOK**.

## <a name="import-a-graphical-runbook"></a>Импорт графического модуля Runbook

Файл графического модуля Runbook или графического модуля Runbook рабочего процесса PowerShell можно импортировать, выбрав параметр **Импорт** при добавлении модуля. При выборе файла для импорта можно сохранить то же имя или ввести новое. В поле **Тип модуля Runbook** отображается тип модуля Runbook после того, как он оценит выбранный файл. При попытке выбрать другой недопустимый тип в графическом редакторе выводится сообщение о существовании потенциальных конфликтов и возможном наличии синтаксических ошибок в процессе преобразования.

![Импортировать Runbook](media/automation-graphical-authoring-intro/runbook-import.png)

## <a name="test-a-graphical-runbook"></a>Тестирование графического модуля Runbook

У каждого графического модуля Runbook в службе автоматизации Azure есть черновая и опубликованная версии. Запускать можно только опубликованную версию, а изменять — только черновую. Изменения, внесенные в черновик, не влияют на опубликованную версию. Когда черновая версия готова к использованию, ее можно опубликовать, заменив текущую опубликованную версию содержимым черновой.

Черновик модуля Runbook можно протестировать на портале Azure, не изменяя при этом опубликованную версию. Или можно проверить новый модуль Runbook перед публикацией, чтобы убедиться в его правильной работе перед заменой версий. При тестировании модуля Runbook запускается его черновая версия и завершаются все действия, которые он выполняет. Журнал заданий не создается, но в области вывода теста отображаются выходные данные.

Откройте элемента управления "Тест" для графического модуля Runbook, открыв Runbook для редактирования и нажав кнопку **области тестирования**. Будет предложено ввести входные параметры, после чего вы сможете запустить модуль Runbook, нажав кнопку **Запуск**.

## <a name="publish-a-graphical-runbook"></a>Публикация графического модуля Runbook

Графический модуль Runbook можно опубликовать, открыв его для редактирования и нажав кнопку **Опубликовать**. Возможные состояния модуля Runbook:

* Новый — модуль Runbook еще не опубликован. 
* Опубликован — модуль Runbook опубликован.
* На изменении — модуль Runbook изменен после публикации, и черновая и опубликованная версии отличаются.

![Состояния Runbook](media/automation-graphical-authoring-intro/runbook-statuses-revised20165.png)

Имеется возможность восстановить опубликованную версию модуля Runbook. Эта операция отменяет все изменения, внесенные с момента последней публикации модуля Runbook. Он заменяет черновую версию модуля Runbook опубликованной версией.

## <a name="next-steps"></a>Дальнейшие действия

* Чтобы начать работу с графическими модулями Runbook, см. инструкции в статье [Учебник. Создание графического модуля Runbook](learn/automation-tutorial-runbook-graphical.md).
* См. сведения о типах runbook, их преимуществах и ограничениях в описании [типов последовательностей runbook в службе автоматизации Azure](automation-runbook-types.md)
* Сведения о том, как выполнять аутентификацию с помощью учетной записи запуска от имени службы автоматизации см. в [этой статье](automation-security-overview.md#run-as-account).
* Справочник по командлетам PowerShell см. в документации по [Az.Automation](/powershell/module/az.automation/#automation).
