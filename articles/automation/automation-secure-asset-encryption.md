---
title: Шифрование защищенных ресурсов в Службе автоматизации Azure
description: В этой статье приводятся основные сведения о настройке учетной записи службы автоматизации для использования шифрования.
services: automation
ms.service: automation
ms.subservice: process-automation
author: snehithm
ms.author: snmuvva
ms.date: 01/11/2020
ms.topic: conceptual
manager: kmadnani
ms.openlocfilehash: b46cf3a742158a3347b43a1e9bc6d62d0b2160d4
ms.sourcegitcommit: f28ebb95ae9aaaff3f87d8388a09b41e0b3445b5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/30/2021
ms.locfileid: "104773697"
---
# <a name="encryption-of-secure-assets-in-azure-automation"></a>Шифрование защищенных ресурсов в Службе автоматизации Azure

Безопасные средства в службе автоматизации Azure включают учетные данные, сертификаты, подключения и зашифрованные переменные. Для защиты этих ресурсов в службе автоматизации Azure используется несколько уровней шифрования. Существуют две модели шифрования в зависимости от ключа верхнего уровня, используемого для шифрования.

- С помощью ключей, управляемых Майкрософт
- С помощью ключей, управляемых вами

## <a name="microsoft-managed-keys"></a>Ключи, управляемые Майкрософт

По умолчанию учетная запись службы автоматизации Azure использует ключи, управляемые Майкрософт.

Каждый защищенный ресурс шифруется и хранится в службе автоматизации Azure с помощью уникального ключа (ключа шифрования данных), который создается для каждой учетной записи службы автоматизации. Сами эти ключи шифруются и хранятся в службе автоматизации Azure с помощью еще одного уникального ключа, создаваемого для каждой учетной записи, который называется ключом шифрования учетной записи (АЕК). Эти ключи шифрования учетной записи шифруются и хранятся в службе автоматизации Azure с помощью ключей, управляемых Майкрософт. 

## <a name="keys-that-you-manage-with-key-vault-preview"></a>Ключи, которыми управляете вы с помощью Key Vault (предварительная версия)

Для управления шифрованием защищенных ресурсов для учетной записи службы автоматизации можно использовать собственные ключи. При указании ключа, управляемого клиентом, на уровне учетной записи службы автоматизации этот ключ используется для защиты и контроля доступа к ключу шифрования учетной записи службы автоматизации. Последний, в свою очередь, используется для шифрования и расшифровки всех защищенных ресурсов. Ключи, управляемые клиентом, обеспечивают большую гибкость при создании, смене, отключении и отзыве контроля доступа, а также дают возможность выполнять аудит ключей шифрования, используемых для защиты ресурсов.

Для хранения управляемых клиентом ключей используйте Azure Key Vault. Можно либо создать собственные ключи и хранить их в хранилище ключей, либо использовать для их генерации API-интерфейсы Azure Key Vault.  Дополнительные сведения о хранилище ключей Azure см. в статье [Что такое хранилище ключей Azure?](../key-vault/general/overview.md)

## <a name="use-of-customer-managed-keys-for-an-automation-account"></a>Использование управляемых клиентом ключей для учетной записи службы автоматизации Azure

При использовании шифрования с помощью управляемых клиентом ключей для учетной записи автоматизации служба автоматизации Azure помещает ключ шифрования учетной записи в управляемый клиентом ключ в связанном хранилище ключей. Включение управляемых клиентом ключей не влияет на производительность, и учетная запись шифруется с новым ключом немедленно, без какой-либо задержки.

Новая учетная запись службы автоматизации Azure всегда шифруется с помощью ключей, управляемых Майкрософт. Во время создания учетной записи невозможно включить управляемые клиентом ключи. Управляемые клиентом ключи хранятся в Azure Key Vault, а хранилище ключей должно быть подготовлено с использованием политик доступа, которые предоставляют разрешения на работу с ключами для управляемого удостоверения, связанного с учетной записью службы автоматизации. Управляемое удостоверение доступно только после создания учетной записи хранения.

При изменении ключа, используемого для шифрования защищенного актива в службе автоматизации Azure путем включения или отключения управляемых клиентом ключей, обновления ключа шифрования учетной записи, а также указания другого ключа, шифрование этого ключа шифрования учетной записи изменяется, однако защищенные ресурсы в учетной записи службы автоматизации Azure не нужно шифровать повторно.

> [!NOTE] 
> Чтобы включить управляемые клиентом ключи, необходимо выполнить вызовы REST API службы автоматизации Azure с помощью API версии 2020-01-13-preview.

### <a name="prerequisites-for-using-customer-managed-keys-in-azure-automation"></a>Необходимые условия для использования управляемых клиентом ключей в службе автоматизации Azure

Перед включением управляемых клиентом ключей для учетной записи службы автоматизации Azure необходимо убедиться, что соблюдаются следующие необходимые условия.

 - Управляемый клиентом ключ хранится в Azure Key Vault. 
 - В хранилище ключей включите оба свойства: **Обратимое удаление** и **Не очищать**. Эти функции необходимы для восстановления ключей в результате случайного удаления.
 - Для шифрования служба автоматизации Azure поддерживает только ключи RSA. Дополнительные сведения о ключах см. в статье [Сведения о ключах Azure Key Vault, секретах и сертификатах](../key-vault/general/about-keys-secrets-certificates.md).
- Учетная запись службы автоматизации и хранилище ключей могут находиться в разных подписках, но должны находиться в одном клиенте Azure Active Directory.

### <a name="assignment-of-an-identity-to-the-automation-account"></a>Назначение удостоверения учетной записи службы автоматизации Azure

Чтобы использовать управляемые клиентом ключи с учетной записью службы автоматизации Azure, последней необходимо пройти проверку подлинности в хранилище ключей, в котором хранятся управляемые клиентом ключи. Служба автоматизации Azure использует управляемые удостоверения, назначенные системой, для проверки подлинности учетной записи в Azure Key Vault. Дополнительные сведения об управляемых удостоверениях см. в статье [Что такое управляемые удостоверения для ресурсов Azure?](../active-directory/managed-identities-azure-resources/overview.md)

Настройте управляемое удостоверение, назначенное системой для учетной записи службы автоматизации Azure, используя следующий вызов REST API.

```http
PATCH https://management.azure.com/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/resource-group-name/providers/Microsoft.Automation/automationAccounts/automation-account-name?api-version=2020-01-13-preview
```

Тело запроса:

```json
{ 
 "identity": 
 { 
  "type": "SystemAssigned" 
  } 
}
```

Назначенное системой удостоверение для учетной записи службы автоматизации возвращается в ответе, аналогичном следующему.

```json
{
 "name": "automation-account-name",
 "id": "/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/resource-group-name/providers/Microsoft.Automation/automationAccounts/automation-account-name",
 ..
 "identity": {
    "type": "SystemAssigned",
    "principalId": "aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa",
    "tenantId": "bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb"
 },
..
}
```

### <a name="configuration-of-the-key-vault-access-policy"></a>Настройка политики доступа к Key Vault

После назначения управляемого удостоверения учетной записи службы автоматизации Azure необходимо настроить доступ к хранилищу ключей, в котором хранятся управляемые клиентом ключи. В управляемых клиентом ключах службе автоматизации Azure требуются **get**, **recover**, **wrapKey**, **UnwrapKey**.

Такую политику доступа можно задать с помощью следующего вызова REST API.

```http
PUT https://management.azure.com/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/sample-group/providers/Microsoft.KeyVault/vaults/sample-vault/accessPolicies/add?api-version=2018-02-14
```

Тело запроса:

```json
{
  "properties": {
    "accessPolicies": [
      {
        "tenantId": "bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb",
        "objectId": "aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa",
        "permissions": {
          "keys": [
            "get",
            "recover",
            "wrapKey",
            "unwrapKey"
          ],
          "secrets": [],
          "certificates": []
        }
      }
    ]
  }
}
```

> [!NOTE]
> В полях **tenantId** и **objectId** должны быть указаны значения **identity.tenantId** и **identity.principalId** соответственно, из ответа управляемого удостоверения для учетной записи службы автоматизации.

### <a name="change-the-configuration-of-automation-account-to-use-customer-managed-key"></a>Изменение конфигурации учетной записи службы автоматизации для использования управляемого клиентом ключа

Наконец, можно переключить учетную запись службы автоматизации с использования ключей, управляемых Майкрософт, на использование управляемые клиентом ключей, используя следующий вызов REST API.

```http
PATCH https://management.azure.com/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/resource-group-name/providers/Microsoft.Automation/automationAccounts/automation-account-name?api-version=2020-01-13-preview
```

Тело запроса:

```json
{
    "identity": {
    "type": "SystemAssigned"
    },
    "properties": {
        "encryption": {
            "keySource": "Microsoft.Keyvault",
            "keyvaultProperties": {
                "keyName": "sample-vault-key",
                "keyvaultUri": "https://sample-vault-key12.vault.azure.net",
                "keyVersion": "7c73556c521340209371eaf623cc099d"
            }
        }
    }
}
```

Пример ответа

```json
{
  "name": "automation-account-name",
  "id": "/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/resource-group-name/providers/Microsoft.Automation/automationAccounts/automation-account-name",
  ..
  "properties": {
    ..
    "encryption": {
      "keyvaultProperties": {
         "keyName": "sample-vault-key",
          "keyvaultUri": "https://sample-vault-key12.vault.azure.net",
          "keyVersion": "7c73556c521340209371eaf623cc099d"
      },
      "keySource": "Microsoft.Keyvault"
    },
    ..
  }
}
```

## <a name="rotation-of-a-customer-managed-key"></a>Смена управляемого клиентом ключа

Вы можете периодически сменять управляемый клиентом ключ в Azure Key Vault в соответствии с применяемыми политиками соответствия требованиям. При смене ключа необходимо обновить учетную запись службы автоматизации Azure, чтобы она использовала URI нового ключа.

Смена ключа не приводит к повторному шифрованию защищенных ресурсов в учетной записи службы автоматизации Azure. Дальнейшие действия не требуются.

## <a name="revocation-of-access-to-a-customer-managed-key"></a>Отзыв доступа к управляемому клиентом ключу

Чтобы отозвать доступ к управляемым клиентом ключам, используйте PowerShell или Azure CLI. Дополнительные сведения см. в разделе [Azure Key Vault PowerShell](/powershell/module/az.keyvault/) или [Azure Key Vault CLI](/cli/azure/keyvault). Отзыв доступа фактически блокирует доступ ко всем данным в учетной записи хранения, поскольку ключ шифрования становится недоступен для службы хранилища Azure.

## <a name="next-steps"></a>Дальнейшие действия

- Общие сведения об Azure Key Vault см. в статье [Что такое хранилище ключей Azure?](../key-vault/general/overview.md).
- Сведения о работе с сертификатами см. в разделе [Управление сертификатами в службе автоматизации Azure](shared-resources/certificates.md).
- Сведения об обработке учетных данных см. в разделе [Управление учетными данными в службе автоматизации Azure](shared-resources/credentials.md).
- Сведения об использовании переменных службы автоматизации см. в разделе [Управление переменными в службе автоматизации Azure](shared-resources/variables.md).
- Справочные сведения о работе с подключениями см. в статье [Управление подключениями в службе автоматизации Azure](automation-connections.md).
