---
title: Устранение неполадок c изменениями на виртуальной машине Azure в службе автоматизации Azure | Документация Майкрософт
description: Эта статья содержит сведения об устранении неполадок с изменениями на виртуальной машине Azure.
services: automation
ms.subservice: change-inventory-management
keywords: изменение, отслеживание, отслеживание изменений, инвентаризация, автоматизация
ms.date: 03/21/2021
ms.topic: tutorial
ms.custom: mvc
ms.openlocfilehash: 980740d387f9e953d1ea764327c8aa13f8650948
ms.sourcegitcommit: 2c1b93301174fccea00798df08e08872f53f669c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/22/2021
ms.locfileid: "104775818"
---
# <a name="troubleshoot-changes-on-an-azure-vm"></a>Устранение неполадок с изменениями на виртуальной машине Azure

Из этого руководства вы узнаете, как устранять неполадки, возникающие при изменениях на виртуальной машине Azure. Включив функцию отслеживания изменений и инвентаризации, вы сможете контролировать изменения в программном обеспечении, файлах, управляющих программах Linux, службах и разделах реестра Windows на компьютере.
Контроль таких изменений поможет вам точно определять причину проблем с работоспособностью в сетевой среде.

Из этого руководства вы узнаете, как выполнить следующие задачи:

> [!div class="checklist"]
> * Включение отслеживания изменений и инвентаризации
> * Поиск остановленных служб в журналах изменений
> * Настройка функции отслеживания изменений
> * Настройка подключения к журналу действий
> * Активация события
> * Просмотр изменений
> * Настройка оповещений

## <a name="prerequisites"></a>Предварительные требования

Для работы с этим учебником необходимы указанные ниже компоненты.

* Подписка Azure. Если у вас ее нет, [активируйте преимущества для подписчиков MSDN](https://azure.microsoft.com/pricing/member-offers/msdn-benefits-details/) или [зарегистрируйте бесплатную учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F).
* [Учетная запись службы автоматизации](./index.yml) для хранения runbook наблюдателя и действия, а также задачи Наблюдателя.
* [Виртуальная машина](../virtual-machines/windows/quick-create-portal.md), для которой необходимо включить функцию.

## <a name="sign-in-to-azure"></a>Вход в Azure

Войдите на портал Azure по адресу https://portal.azure.com.

## <a name="enable-change-tracking-and-inventory"></a>Включение решения для отслеживания изменений и инвентаризации

Чтобы выполнить задачи из этого учебника, сначала нужно настроить Отслеживание изменений и инвентаризации. Если функция была включена ранее, этот шаг не является обязательным.

>[!NOTE]
>Если эти поля выделены серым цветом, для этой виртуальной машины включена другая функция автоматизации. Вам необходимо использовать ту же рабочую область и учетную запись службы автоматизации.

1. Выберите **Виртуальные машины**, а затем виртуальную машину в списке.
2. В меню слева в разделе **Операции** выберите **Учет**. Откроется страница "Учет".

    ![Изменение значений для включения функции](./media/automation-tutorial-troubleshoot-changes/enableinventory.png)

3. Выберите рабочую область [Log Analytics](../azure-monitor/logs/log-query-overview.md). Эта рабочая область собирает данные, создаваемые такими компонентами, как Отслеживание изменений и инвентаризация. Рабочая область предоставляет единое расположение для проверки и анализа данных из нескольких источников.

    [!INCLUDE [azure-monitor-log-analytics-rebrand](../../includes/azure-monitor-log-analytics-rebrand.md)]

4. Выберите учетную запись службы автоматизации, которую вы хотите использовать.

5. Настройте расположение для развертывания.

5. Нажмите кнопку **Включить**, чтобы развернуть функцию для виртуальной машины. 

Во время установки виртуальная машина подготавливается к работе с помощью агента Log Analytics для Windows и [гибридной рабочей роли Runbook](automation-hybrid-runbook-worker.md). Включение функции отслеживания изменений и инвентаризации может занять до 15 минут. В это время не закрывайте окно браузера.

Когда функция будет включена, сведения об установленном программном обеспечении и изменениях на виртуальной машине начнут передаваться в журналы Azure Monitor.
На получение данных для анализа может уйти от 30 минут до 6 часов.

## <a name="use-change-tracking-and-inventory-in-azure-monitor-logs"></a>Использование функции отслеживания изменений и инвентаризации в журналах Azure Monitor

Функция отслеживания изменений и инвентаризации создает данные журнала, которые отправляются в журналы Azure Monitor. Чтобы найти журналы с помощью запросов, выберите **Log Analytics** в верхней части страницы "Отслеживание изменений". Данные об отслеживании изменений хранятся в типе `ConfigurationChange`.

Следующий пример запроса Log Analytics возвращает все остановленные службы Windows.

```loganalytics
ConfigurationChange
| where ConfigChangeType == "WindowsServices" and SvcState == "Stopped"
```

Дополнительные сведения о поиске по файлам журналов в журналах Azure Monitor см. в статье [Анализ данных журнала в Azure Monitor](../azure-monitor/logs/log-query-overview.md).

## <a name="configure-change-tracking"></a>Настройка функции отслеживания изменений

С помощью функции отслеживания изменений вы можете выбрать, какие файлы и разделы реестра нужно собирать и отслеживать. Для этого выберите **Изменить параметры** в верхней части страницы отслеживания изменений. Вы можете добавить разделы реестра Windows, файлы Windows или Linux, которые нужно отслеживать на странице конфигурации рабочей области.

> [!NOTE]
> Функции отслеживания изменений и инвентаризации используют одни и те же параметры сбора настроек, которые настраиваются на уровне рабочей области.

### <a name="add-a-windows-registry-key"></a>Добавление раздела реестра Windows

1. На вкладке **Реестр Windows** выберите **Добавить**. 

1. На странице "Добавление реестра Windows для отслеживания изменений" введите сведения о ключе, для которого необходимо выполнить отслеживание, и щелкните **Сохранить**.

    |Свойство  |Описание  |
    |---------|---------|
    |Активировано     | Определяет, применяется ли параметр        |
    |Имя элемента     | Понятное имя файла для отслеживания        |
    |Группа     | Имя группы для логического группирования файлов        |
    |Раздел реестра Windows   | Путь для проверки наличия файла. Например: HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders\Common Startup      |

### <a name="add-a-windows-file"></a>Добавление файлов Windows

1. На вкладке **Файлы Windows** выберите **Добавить**. 

1. На странице "Добавление файла Windows для отслеживания изменений" введите сведения о файле или каталоге, для которых необходимо выполнить отслеживание, и щелкните **Сохранить**.

    |Свойство  |Описание  |
    |---------|---------|
    |Активировано     | Определяет, применяется ли параметр        |
    |Имя элемента     | Понятное имя файла для отслеживания        |
    |Группа     | Имя группы для логического группирования файлов        |
    |Укажите путь     | Путь для проверки наличия файла. Например, c:\temp\\\\*.txt.<br>Вы также можете использовать переменные среды, такие как %winDir%\System32\\\*.*         |
    |Рекурсия     | Определяет, используется ли рекурсия при поиске отслеживаемого элемента.        |
    |Отправка содержимого файла для всех параметров| Включение или отключение отправки содержимого файла для отслеженных изменений. Доступные параметры: **true** или **false**.|

### <a name="add-a-linux-file"></a>Добавление файла Linux

1. На вкладке **Файлы Linux** выберите **Добавить**. 

1. В окне "Добавление файла Linux для отслеживания изменений" введите сведения о файле или папке, для которых необходимо выполнить отслеживание, и щелкните **Сохранить**.

    |Свойство  |Описание  |
    |---------|---------|
    |Активировано     | Определяет, применяется ли параметр        |
    |Имя элемента     | Понятное имя файла для отслеживания        |
    |Группа     | Имя группы для логического группирования файлов        |
    |Укажите путь     | Путь для проверки наличия файла. Например, /etc/*.conf.       |
    |Тип пути     | Тип элемента для отслеживания (возможными значениями могут быть "Файл" и "Каталог")        |
    |Рекурсия     | Определяет, используется ли рекурсия при поиске отслеживаемого элемента.        |
    |Использовать sudo     | Этот параметр определяет, используется ли sudo для проверки наличия элемента.         |
    |Ссылки     | Этот параметр определяет работу символических ссылок при обзоре каталогов.<br> **Ignore** (Игнорировать) — игнорирование символических ссылок без включения ссылочных файлов и каталогов.<br>**Follow** (Переходить) — переход по символическим ссылкам во время рекурсий и включение ссылочных файлов и каталогов.<br>**Manage** (Управлять) — переход по символическим ссылкам и изменение способа обработки полученного содержимого.      |
    |Отправка содержимого файла для всех параметров| Включение или отключение отправки содержимого файла для отслеженных изменений. Доступные параметры: Значение True или False.|

   > [!NOTE]
   > Не рекомендуется использовать значение **Управление** для свойства **Ссылки**. Получение содержимого файлов не поддерживается.

## <a name="enable-activity-log-connection"></a>Настройка подключения к журналу действий

1. На странице "Отслеживание изменений" на виртуальной машине выберите **Управление подключением журнала действий**. 

2. На странице "Журнал действий Azure" щелкните **Подключить**, чтобы подключить службу отслеживания изменений и инвентаризации к журналу действий Azure для виртуальной машины.

3. Перейдите к странице "Обзор" для виртуальной машины и выберите действие **Остановить**, чтобы остановить виртуальную машину. 

4. Подтвердите остановку, выбрав **Да** при появлении соответствующего запроса. 

5. После освобождения виртуальной машины выберите **Запустить**, чтобы перезапустить ее. Остановка и запуск виртуальной машины регистрируются как события в журнале действий. 

## <a name="view-changes"></a>Просмотр изменений

1. Вернитесь к странице "Отслеживание изменений" и выберите вкладку **События** в нижней части страницы. 

2. Через некоторое время события отслеживания изменений отобразятся на диаграмме и в таблице. Здесь отображаются изменения, произошедшие за определенное время. На линейной диаграмме в верхней части отображаются события журнала действий Azure. Каждая строка гистограммы соответствует определенному типу отслеживаемых изменений. К этим типам относятся управляющие программы Linux, файлы, разделы реестра Windows, программное обеспечение и службы Windows. На вкладке "Изменения" отображаются подробные сведения об изменениях. Самые последние изменения отображаются первыми.

    ![Просмотр событий на портале](./media/automation-tutorial-troubleshoot-changes/viewevents.png)

3. Обратите внимание, что в систему внесено несколько изменений, в том числе относящихся к службам и программному обеспечению. Фильтры в верхней части страницы позволяют выбрать результаты по **типу изменений** или диапазону времени.

    ![Список изменений, внесенных в виртуальную машину](./media/automation-tutorial-troubleshoot-changes/change-tracking-list.png)

4. Выберите изменение **WindowsServices**. При этом откроется окно "Сведения об изменении" с информацией о конкретном изменении, а также соответствующими значениями до и после изменения. Этот пример сообщает об остановке службы защиты программного обеспечения.

    ![Просмотр сведений об изменениях на портале](./media/automation-tutorial-troubleshoot-changes/change-details.png)

## <a name="configure-alerts"></a>Настройка оповещений

Просмотр изменений на портале Azure может быть полезным, но удобнее просто получать оповещения при внесении изменений, таких как остановка службы. Добавьте оповещение для остановленной службы. 

1. На портале Azure перейдите к разделу **Монитор**. 

2. Выберите **Оповещения** в разделе **Общие службы** и нажмите кнопку **+ Новое правило генерации оповещений**.

3. Нажмите кнопку **Выбрать**, чтобы выбрать ресурс. 

4. На странице "Выбор ресурса" в раскрывающемся меню **Фильтр по типу ресурсов** выберите **Log Analytics**. 

5. Выберите рабочую область Log Analytics, а затем нажмите кнопку **Готово**.

    ![Выбор ресурса](./media/automation-tutorial-troubleshoot-changes/select-a-resource.png)

6. Нажмите кнопку **Добавить условие**.

7. В таблице на странице "Настройка логики сигнала" выберите **Custom log search** (Пользовательский поиск по журналам). 

8. В текстовое поле "Поисковый запрос" введите следующий запрос:

    ```loganalytics
    ConfigurationChange | where ConfigChangeType == "WindowsServices" and SvcName == "W3SVC" and SvcState == "Stopped" | summarize by Computer
    ```

    Этот запрос возвращает сведения о компьютерах с остановленной службой W3SVC в рамках указанного интервала времени.

9. В поле **Порог** в разделе **Логика оповещений** введите **0**. Закончив, нажмите кнопку **Готово**.

    ![Настройка логики сигналов](./media/automation-tutorial-troubleshoot-changes/configure-signal-logic.png)

10. Выберите **Создать** в разделе **Группы действий**. Группа действий содержит действия, которые можно использовать для нескольких оповещений. Эти действия могут включать в себя уведомления электронной почты, модули Runbook, веб-перехватчики и многое другое, но не ограничиваются ими. Дополнительные сведения о группах действий см. в разделе [Создание групп действий и управление ими на портале Azure](../azure-monitor/alerts/action-groups.md).

11. В разделе **Подробности об оповещении** введите имя и описание для оповещения. 

12. Задайте для параметра **Серьезность** значения **Информация (уровень серьезности 2)** , **Предупреждение (уровень серьезности 1)** или **Критический (уровень серьезности 0)** .

13. В поле **Имя группы действий** введите имя для оповещения и короткое имя. Короткое имя используется вместо полного имени группы действий при отправке уведомлений с помощью этой группы.

14. В разделе **Действия** введите имя действия, например **Администраторы электронной почты**. 

15. В разделе **Тип действия** выберите **Email/SMS/Push/Voice** (Электронная почта, SMS, push-уведомление, голосовое сообщение). 

16. В разделе **СВЕДЕНИЯ** выберите **Изменить сведения**.

    :::image type="content" source="./media/automation-tutorial-troubleshoot-changes/add-action-group.png" alt-text="Потребление и ожидаемые затраты" lightbox="./media/automation-tutorial-troubleshoot-changes/add-action-group.png":::

17. На панели **Email/SMS/Push/Voice** (Электронная почта, SMS, push-уведомление, голосовое сообщение) введите имя, установите флажок **Электронная почта**, а затем введите допустимый адрес электронной почты. По завершении нажмите кнопку **ОК** в области, а затем нажмите кнопку **ОК** на странице **Добавить группу действий**.

18. Чтобы настроить тему оповещения по электронной почте, выберите **Настройка действий**.

19. В разделе **Создать правило** выберите **Тема электронного письма**, а затем — **Создать правило генерации оповещений**. Это оповещение уведомляет об успешном завершении развертывания обновления и предоставляет сведения о том, на каких компьютерах выполнялось развертывание. На следующем рисунке представлен пример сообщения, полученный при остановке службы W3SVC.

    ![Снимок экрана: уведомление по электронной почте, полученное при остановке служб W3SVC.](./media/automation-tutorial-troubleshoot-changes/email.png)

## <a name="next-steps"></a>Дальнейшие действия

Из этого руководства вы узнали, как выполнять такие задачи:

> [!div class="checklist"]
> * Включение отслеживания изменений и инвентаризации
> * Поиск остановленных служб в журналах изменений
> * Настройка функции отслеживания изменений
> * Настройка подключения к журналу действий
> * Активация события
> * Просмотр изменений
> * Настройка оповещений

См. дополнительные сведения о функции отслеживания изменений и инвентаризации, чтобы узнать о ней подробнее.

> [!div class="nextstepaction"]
> [Общие сведения об отслеживании изменений и инвентаризации](change-tracking/overview.md)
