---
title: Создание динамических схем с использованием параметров
description: Сведения о статических и динамических параметрах и их использовании для создания безопасных и динамических схем.
ms.date: 01/27/2021
ms.topic: conceptual
ms.openlocfilehash: 5dbf7ec02e89eac791ec3e17202a5ab13a04b81d
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "98918540"
---
# <a name="creating-dynamic-blueprints-through-parameters"></a>Создание динамических схем с использованием параметров

Полностью определенная схема с различными артефактами, такими как группы ресурсов, шаблоны Azure Resource Manager (шаблоны ARM), политики или назначения ролей, обеспечивает быстрое создание и единообразное создание объектов в Azure. Azure Blueprint поддерживает параметры для обеспечения гибкого использования этих конструктивных шаблонов и контейнеров многократного использования. Параметры обеспечивают гибкий способ изменения свойств артефактов, развернутых с помощью схемы, как при определении, так и при назначении.

Простым примером является артефакт группы ресурсов. При создании группы ресурсов для нее нужно указать два обязательных значения: имя и расположение. При добавлении группы ресурсов в проект, если параметры не существуют, необходимо определить это имя и расположение для каждого использования схемы. В результате этих повторяющихся действий при каждом использовании схемы будут создаваться артефакты в одной группе ресурсов. Ресурсы в пределах этой группы ресурсов будут дублироваться и вызывать конфликт.

> [!NOTE]
> Если в разных схемах содержится группа ресурсов с одним именем, это не является сложностью.
> Если группа ресурсов, включенная в схему, уже существует, схема продолжит создавать связанные артефакты в этой группе ресурсов. Это может привести к конфликту, так как в подписке не могут быть два ресурса с одинаковым именем и типом.

Решить эту проблему позволяют параметры. Схемы Azure позволяют определить значение для каждого свойства артефакта во время назначения подписки. Параметры позволяют повторно использовать схему, которая создает группу ресурсов и другие ресурсы в рамках одной подписки без конфликта.

## <a name="blueprint-parameters"></a>Параметры схемы

С помощью REST API параметры могут быть созданы в самой схеме. Эти параметры отличаются от параметров всех поддерживаемых артефактов. Когда параметр создается в схеме, он может использоваться ее артефактами. Примером может быть префикс для именования группы ресурсов. Артефакт может использовать параметр схемы для создания "в основном динамического" параметра. Так как параметр может быть определен во время назначения, этот шаблон обеспечивает согласованность в соответствии с правилами именования. Сведения о рекомендуемых шагах см. в разделе о [задании статических параметров (параметров уровня схемы)](#blueprint-level-parameter).

### <a name="using-securestring-and-secureobject-parameters"></a>Использование параметров secureString и secureObject

Хотя _артефакт_ шаблона ARM поддерживает параметры типов **secureString** и **secureObject** , для схем Azure требуется подключение к Azure Key Vault. Эта мера безопасности предотвращает рискованную практику хранения секретов вместе со схемами и способствует использованию безопасных шаблонов. Схемы Azure поддерживают эту меру безопасности, обнаруживая Включение безопасного параметра в _артефакт_ шаблона ARM. Затем во время назначения служба предлагает задать такие свойства Key Vault для каждого обнаруженного параметра безопасности:

- идентификатора ресурса Key Vault;
- имени секрета Key Vault;
- версии секрета Key Vault.

Если в назначении схемы используется **управляемое системой удостоверение**, то ссылка Key Vault _должна_ существовать в той же подписке, которой назначено определение схемы.

Если в назначении схемы используется **управляемое пользователем удостоверение**, ссылка на Key Vault _может_ существовать в централизованной подписке. Управляемому удостоверению необходимо предоставить соответствующие права на Key Vault до назначения схемы.

> [!IMPORTANT]
> В обоих случаях Key Vault должен иметь **разрешение на доступ к Azure Resource Manager для развертывания шаблона** , настроенного на странице **политики доступа** . Инструкции о том, как включить эту функцию, см. в разделе [Включение развертывания шаблона](../../../azure-resource-manager/managed-applications/key-vault-access.md#enable-template-deployment).

Дополнительные сведения об Azure Key Vault см. в [этой статье](../../../key-vault/general/overview.md).

## <a name="parameter-types"></a>Типы параметров

### <a name="static-parameters"></a>Статические параметры

Значение параметра, заданное в определении схемы называется **статический параметр**, так как при каждом использовании схемы развертывается артефакт с использованием этого статического значения. В примере группы ресурсов это может не иметь смысла для имени группы ресурсов, но может быть полезным для расположения. Затем при каждом назначении схемы в том же расположении создавалась бы группа ресурсов (с определенным именем во время назначения). Такая гибкость позволяет выбирать, какие свойства являются обязательными и что можно изменить во время назначения.

#### <a name="setting-static-parameters-in-the-portal"></a>Установка статических параметров на портале

1. Выберите **Все службы** в левой области. Найдите и выберите пункт **Схемы**.

1. Выберите **Определения схем** на странице слева.

1. Выберите существующую схему, а затем щелкните **изменить проект** или выберите **+ создать** схему и заполните сведения на вкладке " **основы** ".

1. Нажмите кнопку **Далее: артефакты** или перейдите на вкладку **артефакты** .

1. Для добавленных в схему артефактов с заданными параметрами отображается строка наподобие **Заполнено X из Y параметров** в столбце **Параметры**. Выберите строку артефакта, чтобы изменить параметры артефакта.

   :::image type="content" source="../media/parameters/parameter-column.png" alt-text="Снимок экрана определения схемы и выделенного &quot;X&quot; параметров Y &quot;заполнено&quot;." border="false":::

1. На странице **изменение артефакта** отображаются параметры значений, соответствующие выбранному артефакту. Каждый параметр артефакта включает заголовок, поле значения и поле для установки флажка. Снимите флажок для преобразования в **статический параметр**. В приведенном ниже примере только _расположение_ является **статическим параметром**, так как для него не установлен флажок, а флажок для _имени группы ресурсов_ установлен.

   :::image type="content" source="../media/parameters/static-parameter.png" alt-text="Снимок экрана статических параметров в артефакте схемы." border="false":::

#### <a name="setting-static-parameters-from-rest-api"></a>Установка статических параметров из REST API

В каждом универсальном коде ресурса (URI) REST API есть переменные, которые необходимо заменить собственными значениями:

- `{YourMG}` — замените это значение именем своей группы управления.
- `{subscriptionId}` — замените это значение идентификатором своей подписки.

##### <a name="blueprint-level-parameter"></a>Параметр уровня схемы

При создании схемы через REST API можно создать ее [параметры](#blueprint-parameters). Для этого используйте следующий универсальный код ресурса (URI) REST API и формат текста:

- Универсальный код ресурса (URI) REST API

  ```http
  PUT https://management.azure.com/providers/Microsoft.Management/managementGroups/{YourMG}/providers/Microsoft.Blueprint/blueprints/MyBlueprint?api-version=2018-11-01-preview
  ```

- Текст запроса

  ```json
  {
      "properties": {
          "description": "This blueprint has blueprint level parameters.",
          "targetScope": "subscription",
          "parameters": {
              "owners": {
                  "type": "array",
                  "metadata": {
                      "description": "List of AAD object IDs that is assigned Owner role at the resource group"
                  }
              }
          },
          "resourceGroups": {
              "storageRG": {
                  "description": "Contains the resource template deployment and a role assignment."
              }
          }
      }
  }
  ```

После создания параметра уровня схемы его можно использовать в артефактах, добавленных в эту схему.
В следующем примере REST API создается артефакт назначения ролей в схеме и используется параметр уровня схемы.

- Универсальный код ресурса (URI) REST API

  ```http
  PUT https://management.azure.com/providers/Microsoft.Management/managementGroups/{YourMG}/providers/Microsoft.Blueprint/blueprints/MyBlueprint/artifacts/roleOwner?api-version=2018-11-01-preview
  ```

- Текст запроса

  ```json
  {
      "kind": "roleAssignment",
      "properties": {
          "resourceGroup": "storageRG",
          "roleDefinitionId": "/providers/Microsoft.Authorization/roleDefinitions/8e3af657-a8ff-443c-a75c-2fe8c4bcb635",
          "principalIds": "[parameters('owners')]"
      }
  }
  ```

В этом примере в свойстве **principalIds** использовался параметр уровня схемы **владельцев**: было указано значение `[parameters('owners')]`. Настройка параметра артефакта с помощью параметра уровня схемы — это так же пример **статического параметра**. Параметр уровня схемы нельзя задать во время ее назначения и он будет иметь одинаковое значение при каждом назначении.

##### <a name="artifact-level-parameter"></a>Параметр уровня артефакта

Создание **статических параметров** в артефакте аналогично, но вместо функции `parameters()` используется прямое значение. В следующем примере создаются два статических параметра: **tagName** и **tagValue**. Значение каждого из них предоставляется напрямую, и вызов функции не используется.

- Универсальный код ресурса (URI) REST API

  ```http
  PUT https://management.azure.com/providers/Microsoft.Management/managementGroups/{YourMG}/providers/Microsoft.Blueprint/blueprints/MyBlueprint/artifacts/policyStorageTags?api-version=2018-11-01-preview
  ```

- Текст запроса

  ```json
  {
      "kind": "policyAssignment",
      "properties": {
          "description": "Apply storage tag and the parameter also used by the template to resource groups",
          "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/49c88fc8-6fd1-46fd-a676-f12d1d3a4c71",
          "parameters": {
              "tagName": {
                  "value": "StorageType"
              },
              "tagValue": {
                  "value": "Premium_LRS"
              }
          }
      }
  }
  ```

### <a name="dynamic-parameters"></a>Динамические параметры

Противоположностью статического параметра является **динамический параметр**. Это параметр не определен в схеме, но определяется при каждом ее назначении. В примере группы ресурсов **динамический параметр** имеет смысл использовать для имени группы ресурсов. Он предоставляет разные имена при каждом назначении схемы. Список функций схемы см. в справочнике по [функциям схем](../reference/blueprint-functions.md) .

#### <a name="setting-dynamic-parameters-in-the-portal"></a>Установка динамических параметров на портале

1. Выберите **Все службы** в левой области. Найдите и выберите пункт **Схемы**.

1. Выберите **Определения схем** на странице слева.

1. Щелкните правой кнопкой мыши схему, которую нужно назначить. Выберите **назначить** схему или выберите схему, которую нужно назначить, а затем нажмите кнопку **назначить чертеж** .

1. На странице **назначить чертеж** найдите раздел **Параметры артефакта** . Каждый артефакт с хотя бы одним **динамическим параметром** отображается вместе с параметрами конфигурации. Перед назначением схемы укажите требуемые значения параметров. В приведенном ниже примере _имя_ является **динамическим параметром**, который нужно определить для завершения назначения схемы.

   :::image type="content" source="../media/parameters/dynamic-parameter.png" alt-text="Снимок экрана: Установка динамических параметров во время назначения схемы." border="false":::

#### <a name="setting-dynamic-parameters-from-rest-api"></a>Установка динамических параметров из REST API

Установка **динамических параметров** во время назначения выполняется путем непосредственного ввода нужного значения. Вместо использования функции, такой как [Параметры ()](../reference/blueprint-functions.md#parameters), предоставленное значение является подходящей строкой. Артефакты для группы ресурсов определяются с помощью имени шаблона и свойств **имени** и **расположения**. Все остальные параметры для включаемого артефакта определяются в **параметрах** с **\<name\>** парой ключей и **значением** . Если схема сконфигурирована для динамического параметра, который не указан во время назначения, это назначение завершится сбоем.

- Универсальный код ресурса (URI) REST API

  ```http
  PUT https://management.azure.com/subscriptions/{subscriptionId}/providers/Microsoft.Blueprint/blueprintAssignments/assignMyBlueprint?api-version=2018-11-01-preview
  ```

- Текст запроса

  ```json
  {
      "properties": {
          "blueprintId": "/providers/Microsoft.Management/managementGroups/{YourMG}  /providers/Microsoft.Blueprint/blueprints/MyBlueprint",
          "resourceGroups": {
              "storageRG": {
                  "name": "StorageAccount",
                  "location": "eastus2"
              }
          },
          "parameters": {
              "storageAccountType": {
                  "value": "Standard_GRS"
              },
              "tagName": {
                  "value": "CostCenter"
              },
              "tagValue": {
                  "value": "ContosoIT"
              },
              "contributors": {
                  "value": [
                      "7be2f100-3af5-4c15-bcb7-27ee43784a1f",
                      "38833b56-194d-420b-90ce-cff578296714"
                  ]
                },
              "owners": {
                  "value": [
                      "44254d2b-a0c7-405f-959c-f829ee31c2e7",
                      "316deb5f-7187-4512-9dd4-21e7798b0ef9"
                  ]
              }
          }
      },
      "identity": {
          "type": "systemAssigned"
      },
      "location": "westus"
  }
  ```

## <a name="next-steps"></a>Дальнейшие действия

- См. список [функций](../reference/blueprint-functions.md)схемы.
- Ознакомьтесь со сведениями о [жизненном цикле схем](./lifecycle.md).
- Научитесь настраивать [последовательность схемы](./sequencing-order.md).
- Узнайте, как применять [блокировку ресурсов схемы](./resource-locking.md).
- Узнайте, как [обновлять существующие назначения](../how-to/update-existing-assignments.md).
- Устраняйте проблемы, возникающие во время назначения схемы, с помощью [общих инструкций по устранению неполадок](../troubleshoot/general.md).