---
title: Руководство по Защита новых ресурсов с помощью блокировок
description: В рамках этого учебника вы используете параметры блокировок ресурсов Azure Blueprints "Только для чтения" и "Не удалять" для защиты только что развернутых ресурсов.
ms.date: 03/08/2021
ms.topic: tutorial
ms.openlocfilehash: 87da0f5a1fff2feb103b32533c8d314fb7690f80
ms.sourcegitcommit: e6de1702d3958a3bea275645eb46e4f2e0f011af
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "102485747"
---
# <a name="tutorial-protect-new-resources-with-azure-blueprints-resource-locks"></a>Руководство по Защита новых ресурсов с помощью блокировок ресурсов Azure Blueprints

[Блокировки ресурсов](../concepts/resource-locking.md) Azure Blueprints позволяют защитить новые развернутые ресурсы от незаконного изменения даже из учетной записи с ролью _Владелец_. Такую защиту можно добавить в определения схем ресурсов, созданных с помощью артефакта шаблона Azure Resource Manager (шаблона ARM). Блокировка ресурсов схемы задается при назначении схемы.

При работе с этим руководством вы выполните следующие шаги:

> [!div class="checklist"]
> - Создание определения схемы
> - установка определению схемы метки **Опубликовано**;
> - назначение определения схемы в существующую подписку (**настройка блокировки ресурсов**);
> - проверка новой группы ресурсов;
> - отмена назначения схемы для удаления блокировок.

## <a name="prerequisites"></a>Предварительные требования

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись](https://azure.microsoft.com/free), прежде чем начинать работу.

## <a name="create-a-blueprint-definition"></a>Создание определения схемы

Сначала создайте определение схемы.

1. Выберите **Все службы** в левой области. Найдите и выберите пункт **Схемы**.

1. На странице **Начало работы** с левой стороны в разделе **Создание схемы** нажмите кнопку **Создать**.

1. В верхней части страницы найдите пример схемы **Пустая схема**. Выберите **Начать с пустой схемы**.

1. На вкладке **Основные сведения** введите следующие данные:

   - **Имя схемы**. Укажите имя для копии образца схемы. В этом руководстве мы будем использовать имя **locked-storageaccount**.
   - **Описание схемы**. Добавьте описание для определения схемы. Например: **Для проверки блокировки ресурсов схемы на развернутых ресурсах**.
   - **Расположение определения**. Нажмите кнопку с многоточием (...) и выберите группу управления или подписку, в которую будет сохранено определение схемы.

1. В верхней части страницы выберите вкладку **Артефакты** или внизу страницы щелкните **Далее: Артефакты**.

1. Добавьте группу ресурсов на уровне подписки.
   1. В разделе **Подписка** выберите строку **Добавить артефакт**.
   1. В поле **Тип артефакта** выберите **Группа ресурсов**.
   1. Для **отображаемого имени артефакта** задайте значение **RGtoLock**.
   1. Оставьте поля **Имя группы ресурсов** и **Расположение** пустыми, но убедитесь, что установлен флажок для каждого свойства, чтобы сделать их **динамическими параметрами**.
   1. Нажмите кнопку **Добавить**, чтобы добавить артефакт в схему.

1. Добавьте шаблон в группу ресурсов:
   1. Под записью **RGtoLock** щелкните строку **Добавить артефакт**.
   1. В поле **Тип артефакта** выберите **Шаблон Azure Resource Manager**, для параметра **Отображаемое имя артефакта** укажите значение **StorageAccount**, а поле **Описание** оставьте пустым.
   1. На вкладке **Шаблон** в окне редактора вставьте следующий шаблон ARM. Вставив шаблон, щелкните **Добавить**, чтобы добавить этот артефакт к схеме.

      > [!NOTE]
      > Этот шаг определяет развертываемые ресурсы, которые блокируются с помощью блокировки ресурсов схемы, но не включает саму блокировку ресурсов схемы. Блокировки ресурсов схемы задаются в качестве параметра назначения схемы.

   ```json
   {
       "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
       "contentVersion": "1.0.0.0",
       "parameters": {
           "storageAccountType": {
               "type": "string",
               "defaultValue": "Standard_LRS",
               "allowedValues": [
                   "Standard_LRS",
                   "Standard_GRS",
                   "Standard_ZRS",
                   "Premium_LRS"
               ],
               "metadata": {
                   "description": "Storage Account type"
               }
           }
       },
       "variables": {
           "storageAccountName": "[concat('store', uniquestring(resourceGroup().id))]"
       },
       "resources": [{
           "type": "Microsoft.Storage/storageAccounts",
           "name": "[variables('storageAccountName')]",
           "location": "[resourceGroup().location]",
           "apiVersion": "2018-07-01",
           "sku": {
               "name": "[parameters('storageAccountType')]"
           },
           "kind": "StorageV2",
           "properties": {}
       }],
       "outputs": {
           "storageAccountName": {
               "type": "string",
               "value": "[variables('storageAccountName')]"
           }
       }
   }
   ```

1. В нижней части страницы нажмите **Сохранить черновик**.

На этом шаге в выбранной группе управления или подписке создается определение схемы.

Когда на портале появится уведомление **Определение схемы успешно сохранено**, перейдите к следующему шагу.

## <a name="publish-the-blueprint-definition"></a>Публикация определения схемы

Теперь в вашей среде создано определение схемы. Оно создано в режиме **Черновик**, и прежде чем назначить и развернуть эту копию, ее необходимо опубликовать.

1. Выберите **Все службы** в левой области. Найдите и выберите пункт **Схемы**.

1. В меню слева выберите страницу **Определения схем**. С помощью фильтров найдите определение схемы **locked-storageaccount** и выберите его.

1. В верхней части страницы выберите **Опубликовать схему**. На новой панели справа задайте для параметра **Версия** значение **1.0**. Это свойство можно использовать, если вы собираетесь внести изменения позже. Введите описание в поле **Сведения об изменениях**, например **Опубликована первая версия для блокировки ресурсов, развернутых в схеме**. Затем щелкните **Опубликовать** в нижней части страницы.

На этом шаге можно назначить схему подписке. После публикации определения схемы вы все равно сможете вносить изменения. Если вы вносите изменения, опубликуйте определение с новым значением версии, чтобы отслеживать различия между версиями одного определения схемы.

Когда на портале появится уведомление **Определение схемы опубликовано**, перейдите к следующему шагу.

## <a name="assign-the-blueprint-definition"></a>Назначение определения схемы

Опубликовав определение схемы, можете назначить его подписке в пределах группы управления, в которой вы сохранили определение. На этом шаге вы укажете параметры, которые позволяют сделать каждое развертывание определения схемы уникальным.

1. Выберите **Все службы** в левой области. Найдите и выберите пункт **Схемы**.

1. В меню слева выберите страницу **Определения схем**. С помощью фильтров найдите определение схемы **locked-storageaccount** и выберите его.

1. В верхней части страницы определения схемы выберите **Назначить схему**.

1. Укажите значения параметра для назначения схемы.

   - **Основы**

     - **Подписки**. Выберите одну или несколько подписок, которые находятся в группе управления, где вы сохранили определение схемы. Если вы выберете несколько подписок, для каждой из них будет создано назначение с использованием введенных вами параметров.
     - **Имя назначения.** Имя предварительно заполняется на основе имени определения схемы. Так как мы хотим, чтобы это назначение представляло блокировку новой группы ресурсов, измените его имя на **assignment-locked-storageaccount-TestingBPLocks**.
     - **Расположение.** Выберите регион, в котором будет создано управляемое удостоверение. Azure Blueprint использует это управляемое удостоверение для развертывания всех артефактов в назначенную схему. Дополнительные сведения см. в статье [Управляемые удостоверения для ресурсов Azure](../../../active-directory/managed-identities-azure-resources/overview.md).
       Для этого руководства выберите регион **Восточная часть США 2**.
     - **Версия определения схемы**. Выберите опубликованную версию **1.0** определения схемы.

   - **Блокировка назначения**

     Выберите режим блокировки схемы **Только для чтения**. Дополнительные сведения см. в разделе [Блокировка ресурсов схем](../concepts/resource-locking.md).

     > [!NOTE]
     > На этом шаге выполняется настройка блокировки ресурсов схемы для только что развернутых ресурсов.

   - **Управляемое удостоверение**

     Используйте параметр по умолчанию: **Назначено системой**. Дополнительные сведения см. в статье [Что такое управляемые удостоверения для ресурсов Azure?](../../../active-directory/managed-identities-azure-resources/overview.md)

   - **Параметры артефакта**

     Параметры, определенные в этом разделе, применяются к артефакту, под которым они определены. Так как эти параметры определяются во время назначения схемы, они являются [динамическими](../concepts/parameters.md#dynamic-parameters). Для каждого артефакта задайте значение параметра, отображаемое в столбце **Значение**.

     |Имя артефакта|Тип артефакта|Имя параметра|Значение|Описание|
     |-|-|-|-|-|
     |Группа ресурсов RGtoLock|Группа ресурсов|Имя|TestingBPLocks|Определяет имя новой группы ресурсов, к которой необходимо применить блокировки схемы.|
     |Группа ресурсов RGtoLock|Группа ресурсов|Расположение|западная часть США 2|Определяет расположение новой группы ресурсов, к которой необходимо применить блокировки схемы.|
     |StorageAccount|Шаблон Resource Manager|storageAccountType (StorageAccount)|Standard_GRS|Номер SKU хранилища. Значение по умолчанию — _Standard_LRS_.|

1. Когда укажете все параметры, в нижней части страницы выберите **Назначить**.

На этом шаге происходит развертывание определенных ресурсов и настройка выбранного **назначения блокировки**. Для применения блокировок схемы понадобится до 30 минут.

Когда на портале появится уведомление **Определение схемы назначено**, перейдите к следующему шагу.

## <a name="inspect-resources-deployed-by-the-assignment"></a>Просмотр ресурсов, развернутых назначением

При назначении создается группа ресурсов _TestingBPLocks_ и учетная запись хранения, развернутая артефактом шаблона ARM. Новая группа ресурсов и выбранное состояние блокировки отображаются на странице сведений о назначении.

1. Выберите **Все службы** в левой области. Найдите и выберите пункт **Схемы**.

1. Слева выберите страницу **Назначенные схемы**. С помощью фильтров найдите назначение схемы **assignment-locked-storageaccount-TestingBPLocks** и выберите его.

   На этой странице можно убедиться, что назначение прошло успешно, а ресурсы развернуты с новым состоянием блокировки схемы. При обновлении назначения в раскрывающемся списке **Операция назначения** отображаются сведения о развертывании каждой версии определения. Чтобы открыть страницу свойств, выберите группу ресурсов.

1. Выберите группу ресурсов **TestingBPLocks**.

1. В области слева откройте страницу **Управление доступом (IAM)** . Затем выберите вкладку **Назначения ролей**.

   На этой вкладке назначение схемы _assignment-locked-storageaccount-TestingBPLocks_ имеет роль _Владелец_. Это обусловлено тем, что эта роль использовалась для развертывания и блокировки группы ресурсов.

1. Выберите вкладку **Запрет назначений**.

   В развернутой группе ресурсов назначение схемы создало [запрет назначения](../../../role-based-access-control/deny-assignments.md), чтобы принудительно применить режим блокировки схемы **Только для чтения**. Запрет назначения не дает пользователю с соответствующими правами выполнять определенные действия на вкладке **Назначения ролей**. Запрет назначения влияет на _все субъекты_.

   Сведения об исключении субъекта из запрета назначения см. в статье о [блокировке ресурсов схемы](../concepts/resource-locking.md#exclude-a-principal-from-a-deny-assignment).

1. Выберите запрет назначения, а затем откройте страницу **Отклоненные разрешения** в области слева.

   Назначение запрета блокирует все операции с конфигурацией **\* *_ и _* Действие**, но разрешает доступ на чтение, исключая **\*/read** через **NotActions**.

1. В элементе навигации портала Azure выберите **TestingBPLocks — Управление доступом (IAM)** . Затем в левом меню перейдите на страницу **Обзор** и щелкните кнопку **Удалить группу ресурсов**. Чтобы подтвердить удаление, введите имя **TestingBPLocks** и в нижней части панели выберите **Удалить**.

   На портале появится уведомление **Удаление группы ресурсов TestingBPLocks завершилось сбоем**. Ошибка указывает на то, что хотя в вашей учетной записи и есть разрешение на удаление группы ресурсов, назначение схемы запрещает доступ к ней. Помните, что при назначении схемы мы выбрали режим блокировки схемы **Только для чтения**. Блокировка схемы предотвращает удаление ресурсов учетной записью с разрешением (даже с ролью _Владелец_). Дополнительные сведения см. в разделе [Блокировка ресурсов схем](../concepts/resource-locking.md).

Согласно этим действиям, теперь развернутые ресурсы защищены с помощью блокировок схемы, которые не допускают нежелательное удаление, даже из учетной записи с разрешением на это удаление.

## <a name="unassign-the-blueprint"></a>Отмена назначения схемы

Последнее, что нужно сделать, — это удалить назначение определения схемы. При удалении назначения связанные артефакты не удаляются.

1. Выберите **Все службы** в левой области. Найдите и выберите пункт **Схемы**.

1. Слева выберите страницу **Назначенные схемы**. С помощью фильтров найдите назначение схемы **assignment-locked-storageaccount-TestingBPLocks** и выберите его.

1. В верхней части страницы выберите **Отменить назначение схемы**. Прочтите предупреждение в диалоговом окне подтверждения, а затем щелкните **ОК**.

   Блокировки схемы удаляются вместе с назначением схемы. Удаление ресурсов из учетных записей с соответствующими разрешениями снова возможно.

1. В меню Azure выберите **Группы ресурсов**, а затем щелкните **TestingBPLocks**.

1. В меню слева выберите страницу **Управление доступом (IAM)** и перейдите на вкладку **Назначения ролей**.

Безопасность группы ресурсов указывает, что в назначении схемы больше нет доступа уровня _Владелец_.

Когда на портале появится уведомление **Назначение схемы удалено**, перейдите к следующему шагу.

## <a name="clean-up-resources"></a>Очистка ресурсов

После работы с этим руководством удалите такие ресурсы:

- группу ресурсов _TestingBPLocks_;
- определение схемы _locked-storageaccount_.

## <a name="next-steps"></a>Дальнейшие действия

В этом учебнике вы узнали, как защитить новые ресурсы, развернутые с помощью службы Azure Blueprints. Чтобы узнать больше о схемах Azure, перейдите к статье о жизненном цикле схемы.

> [!div class="nextstepaction"]
> [Ознакомьтесь со сведениями о жизненном цикле схем](../concepts/lifecycle.md)