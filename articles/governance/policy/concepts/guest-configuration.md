---
title: Узнайте больше про аудит содержимого виртуальных машин
description: Узнайте, как политика Azure использует клиент гостевой конфигурации для аудита параметров в виртуальных машинах.
ms.date: 01/14/2021
ms.topic: conceptual
ms.openlocfilehash: 5d1503680ea2ca7d0ff7c8adae19c05abfe441c0
ms.sourcegitcommit: 126ee1e8e8f2cb5dc35465b23d23a4e3f747949c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/10/2021
ms.locfileid: "100104813"
---
# <a name="understand-azure-policys-guest-configuration"></a>Общие сведения о гостевой конфигурации службы "Политика Azure"

Политика Azure может выполнять аудит параметров на компьютере как для компьютеров, работающих в Azure, так и для компьютеров, [подключенных к Arc](../../../azure-arc/servers/overview.md). Проверка выполняется с помощью расширения гостевой конфигурации и клиента. Расширение с помощью клиента проверяет такие параметры, как:

- Конфигурация операционной системы
- конфигурация или наличие приложения;
- Параметры среды

В настоящее время большинство определений политики гостевой конфигурации в политике Azure заменяют только параметры аудита на компьютере. Конфигурации не применяются. Исключением является только встроенная политика, [описанная ниже](#applying-configurations-using-guest-configuration).

## <a name="enable-guest-configuration"></a>Включить конфигурацию гостя

Чтобы выполнить аудит состояния компьютеров в среде, включая компьютеры в Azure и подключенных к ней Arc компьютерах, ознакомьтесь со следующими сведениями.

## <a name="resource-provider"></a>Поставщик ресурсов

Перед использованием гостевой конфигурации необходимо зарегистрировать поставщик ресурсов. Поставщик ресурсов регистрируется автоматически, если назначение политики гостевой конфигурации на виртуальной машине выполняется через портал. Вы можете вручную зарегистрироваться через [портал](../../../azure-resource-manager/management/resource-providers-and-types.md#azure-portal), [Azure PowerShell](../../../azure-resource-manager/management/resource-providers-and-types.md#azure-powershell) или [Azure CLI](../../../azure-resource-manager/management/resource-providers-and-types.md#azure-cli).

## <a name="deploy-requirements-for-azure-virtual-machines"></a>Требования к развертыванию виртуальных машин Azure

Для аудита параметров на компьютере включено [расширение виртуальной машины](../../../virtual-machines/extensions/overview.md) , и компьютер должен иметь управляемое системой удостоверение. Расширение скачивает подходящее назначение политики и соответствующее определение конфигурации. Удостоверение используется для проверки подлинности компьютера при чтении и записи в гостевой службе настройки. Расширение не требуется для подключенных к Arc компьютеров, так как оно входит в агент подключенного компьютера ARC.

> [!IMPORTANT]
> Для аудита виртуальных машин Azure требуется расширение конфигурации виртуальной машины и управляемое удостоверение. Чтобы развернуть расширение в масштабе, назначьте следующую инициативу политики:
> 
> `Deploy prerequisites to enable Guest Configuration policies on virtual machines`

### <a name="limits-set-on-the-extension"></a>Ограничения, установленные для расширения

Чтобы ограничить расширение от излишнего влияния на приложения, выполняемые внутри компьютера, конфигурация гостевой системы не может превышать 5 % ресурсов ЦП. Это ограничение существует как для встроенных, так и для пользовательских определений. Это справедливо и для гостевой службы настройки в агенте на подключенном компьютере ARC.

### <a name="validation-tools"></a>Инструменты проверки

Для выполнения аудита на виртуальной машине клиент гостевой конфигурации использует локальные средства.

В следующей таблице приведен список локальных средств, используемых в каждой поддерживаемой операционной системе. Для встроенного содержимого Гостевая конфигурация выполняет автоматическую загрузку этих средств.

|Операционная система|Инструмент проверки|Примечания|
|-|-|-|
|Windows|[Настройка требуемого состояния PowerShell](/powershell/scripting/dsc/overview/overview) v2| Загружено в папку, используемую политикой Azure. Не будет конфликтовать с Windows PowerShell DSC. PowerShell Core не добавляется в системный путь.|
|Linux|[Chef InSpec](https://www.chef.io/inspec/)| Устанавливает Chef Spec Version 2.2.61 в расположение по умолчанию и добавляется в системный путь. Также устанавливаются зависимости для пакета спецификации, включая Ruby и Python. |

### <a name="validation-frequency"></a>Частота проверки

Клиент гостевой конфигурации проверяет наличие нового содержимого каждые 5 минут. После получения назначения гостя параметры конфигурации проверяются повторно с 15-минутным интервалом. Результаты отправляются поставщику ресурсов гостевой конфигурации после завершения аудита. Когда происходит [триггер оценки](../how-to/get-compliance-data.md#evaluation-triggers) политики, состояние компьютера записывается в поставщик ресурсов гостевой конфигурации. Эти новые данные позволяют Политике Azure повторно оценить свойства Azure Resource Manager. Оценка Политики по запросу получает последнее значение от поставщика ресурсов гостевой конфигурации. Однако она не запускает новый аудит конфигурации в виртуальной машине.

## <a name="supported-client-types"></a>Поддерживаемые типы клиентов

Определения политик гостевой конфигурации являются включительно для новых версий. Более старые версии операционных систем, доступные в Azure Marketplace, исключаются, если гостевой клиент конфигурации не совместим. В следующей таблице перечислены операционные системы, поддерживаемые в образах Azure:

|Издатель|Имя|Версии|
|-|-|-|
|Canonical|Сервер Ubuntu|14,04-18,04|
|Credativ|Debian|8 и более поздних версий|
|Microsoft|Windows Server|2012 и более поздних версии|
|Microsoft|Клиент Windows|Windows 10|
|OpenLogic|CentOS|Версия 7.3 и позднее|
|Red Hat|Red Hat Enterprise Linux|7,4-7,8|
|Suse|SLES|12 SP3-SP5|

Пользовательские образы виртуальных машин поддерживаются определениями политик гостевой конфигурации, если они являются одной из операционных систем в приведенной выше таблице.

## <a name="network-requirements"></a>Требования к сети

Виртуальные машины в Azure могут использовать либо их локальные сетевые адаптеры, либо закрытые ссылки для связи с гостевой службой настройки.

Машины на основе дуги Azure подключаются с помощью локальной сетевой инфраструктуры для доступа к службам Azure и отчета о состоянии соответствия.

### <a name="communicate-over-virtual-networks-in-azure"></a>Обмен данными между виртуальными сетями в Azure

Виртуальным машинам, использующим виртуальные сети для обмена данными, потребуется исходящий доступ к центрам обработки данных Azure через порт `443` . Если вы используете в Azure частную виртуальную сеть, которая не разрешает исходящий трафик, настройте исключения с помощью правил группы безопасности сети. Тег службы "GuestAndHybridManagement" можно использовать для ссылки на службу конфигурации гостя.

### <a name="communicate-over-private-link-in-azure"></a>Связь по частной ссылке в Azure

Виртуальные машины могут использовать [закрытую ссылку](../../../private-link/private-link-overview.md) для подключения к гостевой службе настройки. Примените тег с именем `EnablePrivateNeworkGC` (без "t" в сети) и установите значение `TRUE` , чтобы включить эту функцию. Тег можно применить до или после применения определений политик гостевой конфигурации к компьютеру.

Трафик направляется с помощью [виртуального общедоступного IP-адреса](../../../virtual-network/what-is-ip-address-168-63-129-16.md) Azure, чтобы установить защищенный канал с проверкой подлинности с помощью ресурсов платформы Azure.

### <a name="azure-arc-connected-machines"></a>Подключенные к службе Arc Azure компьютеры

Для узлов, расположенных за пределами Azure, которые подключены с помощью дуги Azure, требуется подключение к гостевой службе настройки. Сведения о требованиях к сети и прокси-серверам, приведенным в [документации по службе Arc Azure](../../../azure-arc/servers/overview.md).

Для взаимодействия с поставщиком ресурсов гостевой конфигурации в Azure компьютерам требуется исходящий доступ к центрам обработки данных Azure через порт **443**. Если сеть в Azure не разрешает исходящий трафик, настройте исключения с помощью [правил группы безопасности сети](../../../virtual-network/manage-network-security-group.md#create-a-security-rule). [Тег службы](../../../virtual-network/service-tags-overview.md) "GuestAndHybridManagement" можно использовать для ссылки на службу конфигурации гостя.

Для подключенных к Arc серверов в частных центрах обработки данных разрешите трафик, используя следующие шаблоны:

- Порт: только исходящий интернет-трафик через TCP-порт 443.
- Глобальный URL-адрес: `*.guestconfiguration.azure.com`

## <a name="managed-identity-requirements"></a>Требования к удостоверениям

Определения политик в инициативе _развертывание предварительных требований для включения политик конфигурации гостя на виртуальных машинах_ позволяют назначить системе управляемое удостоверение, если оно не существует. В инициативе, управляющей созданием удостоверений, существует два определения политик. Условия IF в определениях политик обеспечивают правильное поведение на основе текущего состояния ресурса компьютера в Azure.

Если у компьютера в настоящее время нет управляемых удостоверений, действующая политика будет: [Добавить управляемое системой удостоверение, чтобы включить назначения гостевой конфигурации на виртуальных машинах без удостоверений](https://portal.azure.com/#blade/Microsoft_Azure_Policy/PolicyDetailBlade/definitionId/%2Fproviders%2FMicrosoft.Authorization%2FpolicyDefinitions%2F3cf2ab00-13f1-4d0c-8971-2ac904541a7e) .

Если компьютер в настоящее время имеет назначенное пользователем удостоверение системы, действующая политика будет: [Добавить управляемое системой удостоверение, чтобы включить назначения гостевой конфигурации на виртуальных машинах с назначенным пользователем удостоверением](https://portal.azure.com/#blade/Microsoft_Azure_Policy/PolicyDetailBlade/definitionId/%2Fproviders%2FMicrosoft.Authorization%2FpolicyDefinitions%2F497dff13-db2a-4c0f-8603-28fa3b331ab6) .

## <a name="guest-configuration-definition-requirements"></a>Требования к определению гостевой конфигурации

Определения политик гостевой конфигурации используют **помощью параметров auditifnotexistsный** результат. Когда определение назначается, серверная служба автоматически обрабатывает жизненный цикл всех требований в `Microsoft.GuestConfiguration` поставщике ресурсов Azure.

Определения политик **помощью параметров auditifnotexists** не будут возвращать результаты проверки соответствия, пока на компьютере не будут выполнены все требования. Требования описаны в разделе [требования к развертыванию для виртуальных машин Azure](#deploy-requirements-for-azure-virtual-machines) .

> [!IMPORTANT]
> В предыдущем выпуске гостевой конфигурации для объединения определений **деплойифнотиксистс** и **помощью параметров auditifnotexists** требуется инициатива. Определения **DeployIfNotExists** больше не требуются. Определения и интиаитивес помечены, `[Deprecated]` но существующие назначения будут продолжать работать. Дополнительные сведения см. в записи блога: [важное изменение, выпущенное для политик аудита настройки гостя](https://techcommunity.microsoft.com/t5/azure-governance-and-management/important-change-released-for-guest-configuration-audit-policies/ba-p/1655316) .

Политика Azure использует свойство **комплианцестатус** поставщика ресурсов гостевой конфигурации, чтобы сообщить о соответствии требованиям в узле **соответствие** . Дополнительные сведения см. в руководстве по [получению данных соответствия](../how-to/get-compliance-data.md).

#### <a name="auditing-operating-system-settings-following-industry-baselines"></a>Настройки аудита параметров операционной системы следуют стандартам индустрии.

Одна инициатива в политике Azure выполняет аудит параметров операционной системы после "базового плана". Определение, _\[ Предварительная версия \] : компьютеры Windows должны соответствовать требованиям к базовому плану безопасности Azure_ . Он включает набор правил на основе групповая политика Active Directory.

Большинство настроек доступны в качестве параметров. Параметры позволяют выбрать элементы, которые будут оцениваться в ходе аудита.
Выберите политику в соответствии с вашими требованиями или со сторонними правилами, например отраслевыми стандартами.

Некоторые параметры поддерживают диапазон целочисленных значений. Например, параметр максимального срока действия пароля может проверять действующий параметр групповой политики. Диапазон "1, 70" обозначит, что пользователи должны будут менять свои пароли по крайней мере каждые 70 дней, но не менее одного дня.

Если вы назначаете политику с помощью шаблона Azure Resource Manager (шаблон ARM), используйте файл параметров для управления исключениями. Синхронизируйте файлы в системе управления версиями, например Git. Комментарии об изменениях файлов доказывают, что присваивание является исключением ожидаемого значения.

#### <a name="applying-configurations-using-guest-configuration"></a>Применение конфигураций с помощью гостевой конфигурации

Только определение Настройка часового _пояса на компьютерах Windows_ вносит изменения на компьютере, настраивая часовой пояс. Определения настраиваемых политик для настройки параметров на компьютерах не поддерживаются.

При назначении определений, называющихся _"Настройка…"_ , необходимо также назначить определение _развертывания необходимых компонентов для включения политики гостевой конфигурации на виртуальных машинах Windows_. По желанию можно объединить эти определения в инициативу.

> [!NOTE]
> Встроенная политика часового пояса — это единственное определение, которое поддерживает настройку параметров внутри компьютеров и определений настраиваемых политик, которые настраивают параметры на виртуальных машинах, не поддерживаются.

#### <a name="assigning-policies-to-machines-outside-of-azure"></a>Назначение политик компьютерам вне Azure

Определения политик аудита, доступные для гостевой конфигурации, включают тип ресурса **Microsoft. хибридкомпуте/Machines** . Все компьютеры, подключенные к [Azure Arc для серверов](../../../azure-arc/servers/overview.md) и находящиеся в области назначения политики, добавляются автоматически.

## <a name="troubleshooting-guest-configuration"></a>Устранение неполадок настройки гостевой системы

Дополнительные сведения об устранении неполадок с гостевой конфигурацией см. в [статье Устранение неполадок политики Azure](../troubleshoot/general.md).

### <a name="multiple-assignments"></a>Несколько назначений

Определения политик гостевой конфигурации в настоящее время поддерживают только назначение одного и того же назначения гостей один раз на компьютер, даже если в назначении политики используются другие параметры.

### <a name="client-log-files"></a>Файлы журналов клиента

Модуль настройки гостевой конфигурации записывает файлы журналов в следующие разделы:

Windows: `C:\ProgramData\GuestConfig\gc_agent_logs\gc_agent.log`

Linux: `/var/lib/GuestConfig/gc_agent_logs/gc_agent.log`

### <a name="collecting-logs-remotely"></a>Удаленный сбор журналов

Первым шагом в устранении неполадок в конфигурациях или модулях гостевой конфигурации является использование `Test-GuestConfigurationPackage`cmdlet с помощью пошаговой инструкции[ по созданию пользовательской политики аудита настройки гостевой конфигурации для Windows](../how-to/guest-configuration-create.md#step-by-step-creating-a-custom-guest-configuration-audit-policy-for-windows).
Если этот шаг не помог, помочь в диагностике проблем может сбор журналов клиентов.

#### <a name="windows"></a>Windows

Полезно будет попробовать использовать следующий пример сценария PowerShell, чтобы получить данные из файлов журналов с помощью [команды выполнения](../../../virtual-machines/windows/run-command.md) виртуальной машины Azure.

```powershell
$linesToIncludeBeforeMatch = 0
$linesToIncludeAfterMatch = 10
$logPath = 'C:\ProgramData\GuestConfig\gc_agent_logs\gc_agent.log'
Select-String -Path $logPath -pattern 'DSCEngine','DSCManagedEngine' -CaseSensitive -Context $linesToIncludeBeforeMatch,$linesToIncludeAfterMatch | Select-Object -Last 10
```

#### <a name="linux"></a>Linux

Чтобы получить данные из файлов журналов с помощью [команды выполнения](../../../virtual-machines/linux/run-command.md) виртуальной машины Azure, пригодится данный скрипт на Bash.

```Bash
linesToIncludeBeforeMatch=0
linesToIncludeAfterMatch=10
logPath=/var/lib/GuestConfig/gc_agent_logs/gc_agent.log
egrep -B $linesToIncludeBeforeMatch -A $linesToIncludeAfterMatch 'DSCEngine|DSCManagedEngine' $logPath | tail
```

### <a name="client-files"></a>Файлы клиента

Клиент конфигурации гостя загружает пакеты содержимого на компьютер и извлекает содержимое.
Чтобы проверить, какое содержимое было загружено и сохранено, просмотрите расположение папок, указанное ниже.

Windows: `c:\programdata\guestconfig\configurations`

Linux: `/var/lib/guestconfig/configurations`

## <a name="guest-configuration-samples"></a>Примеры гостевой конфигурации

Встроенные примеры политики настройки гостевой конфигурации доступны здесь:

- [Встроенные определения политик — гостевая конфигурация](../samples/built-in-policies.md#guest-configuration)
- [Встроенные инициативы — гостевая конфигурация](../samples/built-in-initiatives.md#guest-configuration)
- [Репозиторий Политики Azure на сайте GitHub](https://github.com/Azure/azure-policy/tree/master/built-in-policies/policySetDefinitions/Guest%20Configuration)

## <a name="next-steps"></a>Дальнейшие действия

- Ознакомьтесь с тем, как просмотреть данные настроек [соответствия гостевой конфигурации](../how-to/determine-non-compliance.md#compliance-details-for-guest-configuration)
- Изучите примеры на странице [примеров Политики Azure](../samples/index.md).
- Изучите статью о [структуре определения Политики Azure](./definition-structure.md).
- Изучите [сведения о действии политик](./effects.md).
- Узнайте о [программном создании политик](../how-to/programmatically-create.md).
- Узнайте, как [получать сведения о соответствии](../how-to/get-compliance-data.md).
- Узнайте, как [исправлять несоответствующие ресурсы](../how-to/remediate-resources.md).
- Дополнительные сведения о группе управления см. в статье [Упорядочивание ресурсов с помощью групп управления Azure](../../management-groups/overview.md).
