---
title: Принцип работы эффектов
description: Определения политик Azure содержат различные действия, влияющие на управление соответствием требованиям и отчеты о нем.
ms.date: 10/05/2020
ms.topic: conceptual
ms.openlocfilehash: e72e94766dce2660409e729bc43eb107fb9ab39a
ms.sourcegitcommit: 6d6030de2d776f3d5fb89f68aaead148c05837e2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/05/2021
ms.locfileid: "97883084"
---
# <a name="understand-azure-policy-effects"></a>Сведения о действии политик Azure

Каждое определение политики в Azure имеет один эффект. Этот эффект определяет, что происходит при вычислении правила политики при сопоставлении. Действия по-разному влияют на новые, обновленные и имеющиеся ресурсы.

В настоящее время в определении политики поддерживается следующие действия.

- [Append](#append)
- [Аудит](#audit)
- [AuditIfNotExists](#auditifnotexists)
- [Запретить](#deny)
- [DeployIfNotExists](#deployifnotexists)
- [Отключено](#disabled)
- [Изменение](#modify)

Следующие эффекты являются _устаревшими_:

- [EnforceOPAConstraint](#enforceopaconstraint)
- [EnforceRegoPolicy](#enforceregopolicy)

> [!IMPORTANT]
> Вместо **енфорцеопаконстраинт** или **енфорцерегополици** используйте режим " _Аудит_ " и " _запретить_ " в режиме поставщика ресурсов `Microsoft.Kubernetes.Data` . Определения встроенных политик обновлены. При изменении существующих назначений политик для этих встроенных определений политик параметр _Effect_ необходимо изменить на значение в обновленном списке _allowedValues_ .

## <a name="order-of-evaluation"></a>Порядок оценки

Запросы на создание или обновление ресурса сначала оцениваются политикой Azure. Политика Azure создает список всех назначений, которые применяются к ресурсу, а затем оценивает ресурс по каждому определению. В [Диспетчер ресурсов режиме](./definition-structure.md#resource-manager-modes)политика Azure обрабатывает несколько эффектов перед передачей запроса соответствующему поставщику ресурсов. Этот порядок предотвращает ненужную обработку поставщиком ресурсов, если ресурс не соответствует специально разработанным элементам управления политики Azure. В [режиме поставщика ресурсов](./definition-structure.md#resource-provider-modes)поставщик ресурсов управляет вычислением и выходом и передает результаты в политику Azure.

- Действие **Disabled** проверяется первым. Таким образом определяется, нужно ли оценить правило политики.
- Затем оцениваются **Append** и **Modify**. Поскольку оба могут изменить запрос, а внесенное изменение может отменить вызов действия аудита или запрета. Эти эффекты доступны только в режиме диспетчер ресурсов.
- Затем оценивается действие **Deny** (запрет). Запрет оценивается перед аудитом, чтобы нежелательный ресурс не заносился в журнал дважды.
- **Аудит** вычисляется последним.

После того как поставщик ресурсов возвращает код успешного выполнения в запросе в режиме диспетчер ресурсов, **помощью параметров auditifnotexists** и **DeployIfNotExists** оценивают, требуется ли дополнительное ведение журнала соответствия или действие.

Кроме того, `PATCH` запросы, которые только изменяют `tags` связанные поля, ограничивают вычисление политики политиками, содержащими условия, проверяющие `tags` связанные поля.

## <a name="append"></a>Append

Это действие используется для добавления полей к запрашиваемому ресурсу во время создания или обновления. Типичный пример — указание разрешенных IP-адресов для ресурса хранилища.

> [!IMPORTANT]
> Append предназначено для использования со свойствами, не являющимися тегами. Несмотря на то что Append может добавлять теги к ресурсу во время запроса на создание или обновление, рекомендуется использовать [Modify](#modify) для тегов.

### <a name="append-evaluation"></a>Оценка добавления

Добавление оценивается до обработки запроса поставщиком ресурсов во время создания или обновления ресурса. Это действие добавляет поля к ресурсу, если выполняется условие **if** правила политики. Если добавление приведет к замене значения в исходном запросе на другое значение, то оно работает как действие запрета и отклоняет запрос. Чтобы добавить новое значение к имеющемуся массиву, используйте версию псевдонима **\[\*\]** .

При запуске определения политики с использованием действия добавления в рамках цикла оценивания оно не меняет уже существующие ресурсы. Вместо этого ресурсы, отвечающие условию **if**, отмечаются как несоответствующие.

### <a name="append-properties"></a>Свойства добавления

Действие добавления содержит только обязательный массив **details**. Так как свойство **details** представляет собой массив, оно может принимать как одну, так и несколько пар **поле/значение**. Список допустимых полей представлен в статье, посвященной [структуре определения](definition-structure.md#fields).

### <a name="append-examples"></a>Примеры добавления

Пример 1: Одна пара **поле/значение**, использующая псевдоним не являющийся **\[\*\]** — [псевдонимом](definition-structure.md#aliases) со **значением** массива для установки правил IP-адресов учетной записи хранения. Когда псевдоним без **\[\*\]** находится в массиве, действие добавляет **значение** ко всему массиву. Если массив уже существует, из конфликта возникает событие отказа.

```json
"then": {
    "effect": "append",
    "details": [{
        "field": "Microsoft.Storage/storageAccounts/networkAcls.ipRules",
        "value": [{
            "action": "Allow",
            "value": "134.5.0.0/21"
        }]
    }]
}
```

Пример 2. Одна пара **поле/значение**, использующая **\[\*\]** — [псевдоним](definition-structure.md#aliases) со **значением** массива для установки правил IP-адресов учетной записи хранения. Путем использования **\[\*\]** — псевдонима действие добавляет **значение** к потенциально имеющемуся массиву. Если массив еще не существует, он создается.

```json
"then": {
    "effect": "append",
    "details": [{
        "field": "Microsoft.Storage/storageAccounts/networkAcls.ipRules[*]",
        "value": {
            "value": "40.40.40.40",
            "action": "Allow"
        }
    }]
}
```

## <a name="audit"></a>Аудит

Аудит используется, чтобы создать предупреждение в журнале действий при оценке несоответствующего ресурса, но такое действие не останавливает запрос.

### <a name="audit-evaluation"></a>Оценка аудита

Аудит — это последнее действие проверки политики при создании или обновлении ресурса. В диспетчер ресурсов режиме политика Azure отправляет ресурс поставщику ресурсов. Аудит работает одинаково для запроса ресурса и для цикла оценки. Для новых и обновленных ресурсов политика Azure добавляет `Microsoft.Authorization/policies/audit/action` операцию в журнал действий и помечает ресурс как несовместимый.

### <a name="audit-properties"></a>Свойства аудита

В режиме диспетчер ресурсов в результате аудита не предусмотрены дополнительные свойства, которые можно использовать в условии **then** определения политики.

Для режима поставщика ресурсов `Microsoft.Kubernetes.Data` в этот результат аудита имеет следующие дополнительные подсвойства. 

- **констраинттемплате** (обязательно)
  - Шаблон ограничения CustomResourceDefinition (CRD), который определяет новые ограничения. Этот шаблон определяет логику Rego, схему ограничения и параметры ограничения, которые передаются через **значения** из политики Azure.
- **ограничение** (обязательно)
  - Реализация CRD шаблона ограничения. Использует параметры, передаваемые через **значения** как `{{ .Values.<valuename> }}`. В примере 2 ниже приведены значения `{{ .Values.excludedNamespaces }}` и `{{ .Values.allowedContainerImagesRegex }}` .
- **значения** (необязательно)
  - Определяет все параметры и значения, передаваемые ограничению. Каждое значение должно существовать в шаблоне ограничения CRD.

### <a name="audit-example"></a>Пример аудита

Пример 1. Использование действия аудита для режимов диспетчер ресурсов.

```json
"then": {
    "effect": "audit"
}
```

Пример 2. Использование действия аудита для режима поставщика ресурсов `Microsoft.Kubernetes.Data` . Дополнительные сведения в **подробностях** определяют шаблон ограничения и CRD для использования в Kubernetes для ограничения разрешенных образов контейнеров.

```json
"then": {
    "effect": "audit",
    "details": {
        "constraintTemplate": "https://raw.githubusercontent.com/Azure/azure-policy/master/built-in-references/Kubernetes/container-allowed-images/template.yaml",
        "constraint": "https://raw.githubusercontent.com/Azure/azure-policy/master/built-in-references/Kubernetes/container-allowed-images/constraint.yaml",
        "values": {
            "allowedContainerImagesRegex": "[parameters('allowedContainerImagesRegex')]",
            "excludedNamespaces": "[parameters('excludedNamespaces')]"
        }
    }
}
```

## <a name="auditifnotexists"></a>AuditIfNotExists

Помощью параметров auditifnotexists включает аудит ресурсов, _связанных_ с ресурсом, который соответствует условию **If** , но не имеет свойств, указанных в **сведениях о** условии **then** .

### <a name="auditifnotexists-evaluation"></a>Оценка AuditIfNotExists

Действие AuditIfNotExists выполняется после того, как поставщик ресурсов обрабатывает запрос на создание или обновление запрос ресурса и возвращает код состояния, указывающий на успешное выполнение. Этот аудит происходит только при отсутствии связанных ресурсов или в том случае, если для ресурсов, определенных в условии **ExistenceCondition**, не возвращается значение true. Для новых и обновленных ресурсов политика Azure добавляет `Microsoft.Authorization/policies/audit/action` операцию в журнал действий и помечает ресурс как несовместимый. При вызове этого действия ресурс, соответствующий условию **if**, отмечается как несоответствующий.

### <a name="auditifnotexists-properties"></a>Свойства AuditIfNotExists

Свойство **details** действия AuditIfNotExists содержит все дочерние свойства, определяющие связанные ресурсы для сопоставления.

- **Тип** (обязательно)
  - Указывает тип связанного ресурса для сопоставления.
  - Если **details.type** является типом ресурса в основе ресурса условия **if**, политика запрашивает ресурсы этого **type** в области вычисляемого ресурса. В противном случае политики выполняет запрос в той же группе ресурсов, что и оцененный ресурс.
- **Name** (необязательный)
  - Указывает точное имя сопоставляемого ресурса. При этом политика получает определенный ресурс, а не все ресурсы указанного типа.
  - Если значения условия для **. Field. Type** и then. **Details. Type** совпадают, то **имя** является _обязательным_ и должно быть `[field('name')]` или `[field('fullName')]` для дочернего ресурса.
    Однако вместо этого следует учитывать действие [audit](#audit).
- **ResourceGroupName** (необязательный)
  - Позволяет сопоставить связанный ресурс из другой группы ресурсов.
  - Не применяется, если в свойстве **type** указан тип, относящийся к дочернему ресурсу для ресурса из условия **if**.
  - По умолчанию указывается группа ресурсов, в которую входит ресурс из условия **if**.
- **ExistenceScope** (необязательный)
  - Допустимые значения: _Subscription_ и _ResourceGroup_.
  - Задает область, из которой требуется получить связанный ресурс для сопоставления.
  - Не применяется, если в свойстве **type** указан тип, относящийся к дочернему ресурсу для ресурса из условия **if**.
  - Если задано значение _ResourceGroup_, область ограничивается группой ресурсов, в которую входит ресурс из условия **if**, или группой ресурсов, указанной в свойстве **ResourceGroupName**.
  - Если задано значение _Subscription_, запрос применяется ко всей подписке для связанного ресурса.
  - По умолчанию задано значение _ResourceGroup_.
- **ExistenceCondition** (необязательный)
  - Если это свойство не задано, действие применяется ко всем связанным ресурсам, тип которых соответствует свойству **type**, а аудит не выполняется.
  - Используется тот же язык, что и в правиле политики для условия **if**, но оно оценивается отдельно для каждого связанного ресурса.
  - Если при оценке какого-либо связанного ресурса возвращается значение true, то действие не вызывает аудит.
  - С помощью функции [field()] можно проверять эквивалентность значениям из условия **if**.
  - Например, можно убедиться, что родительский ресурс (из условия **if**) находится там же, где и соответствующий связанный ресурс.

### <a name="auditifnotexists-example"></a>Пример AuditIfNotExists

Пример Оценка виртуальных машин для поиска антивредоносного расширения с последующим аудитом при его отсутствии.

```json
{
    "if": {
        "field": "type",
        "equals": "Microsoft.Compute/virtualMachines"
    },
    "then": {
        "effect": "auditIfNotExists",
        "details": {
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "existenceCondition": {
                "allOf": [{
                        "field": "Microsoft.Compute/virtualMachines/extensions/publisher",
                        "equals": "Microsoft.Azure.Security"
                    },
                    {
                        "field": "Microsoft.Compute/virtualMachines/extensions/type",
                        "equals": "IaaSAntimalware"
                    }
                ]
            }
        }
    }
}
```

## <a name="deny"></a>Запрет

Запрет используется, чтобы не пропускать запросы ресурсов, не соответствующие определенным стандартам, через определение политики. При этом запрос завершается с ошибкой.

### <a name="deny-evaluation"></a>Оценка запрета

При создании или обновлении сопоставленного ресурса в режиме диспетчер ресурсов deny запрещает запрос перед отправкой поставщику ресурсов. Запрос возвращает `403 (Forbidden)`. На портале для развертывания, запрещенного в связи с назначением политики, отображается состояние "Запрещено". Для режима поставщика ресурсов поставщик ресурсов управляет оценкой ресурса.

Во время оценки существующие ресурсы, которые соответствуют определению политики запрета, помечаются как несовместимые.

### <a name="deny-properties"></a>Свойства запрета

В случае диспетчер ресурсовного режима, результат Deny не имеет дополнительных свойств для использования в условии **then** определения политики.

Для режима поставщика ресурсов `Microsoft.Kubernetes.Data` , результат DENY имеет следующие дополнительные вложенные свойства **сведений**.

- **констраинттемплате** (обязательно)
  - Шаблон ограничения CustomResourceDefinition (CRD), который определяет новые ограничения. Этот шаблон определяет логику Rego, схему ограничения и параметры ограничения, которые передаются через **значения** из политики Azure.
- **ограничение** (обязательно)
  - Реализация CRD шаблона ограничения. Использует параметры, передаваемые через **значения** как `{{ .Values.<valuename> }}`. В примере 2 ниже приведены значения `{{ .Values.excludedNamespaces }}` и `{{ .Values.allowedContainerImagesRegex }}` .
- **значения** (необязательно)
  - Определяет все параметры и значения, передаваемые ограничению. Каждое значение должно существовать в шаблоне ограничения CRD.

### <a name="deny-example"></a>Пример запрета

Пример 1. применение действия Deny к режимам диспетчер ресурсов.

```json
"then": {
    "effect": "deny"
}
```

Пример 2. Использование действия Deny в режиме поставщика ресурсов `Microsoft.Kubernetes.Data` . Дополнительные сведения в **подробностях** определяют шаблон ограничения и CRD для использования в Kubernetes для ограничения разрешенных образов контейнеров.

```json
"then": {
    "effect": "deny",
    "details": {
        "constraintTemplate": "https://raw.githubusercontent.com/Azure/azure-policy/master/built-in-references/Kubernetes/container-allowed-images/template.yaml",
        "constraint": "https://raw.githubusercontent.com/Azure/azure-policy/master/built-in-references/Kubernetes/container-allowed-images/constraint.yaml",
        "values": {
            "allowedContainerImagesRegex": "[parameters('allowedContainerImagesRegex')]",
            "excludedNamespaces": "[parameters('excludedNamespaces')]"
        }
    }
}
```

## <a name="deployifnotexists"></a>DeployIfNotExists

Как и AuditIfNotExists, определение политики DeployIfNotExists выполняет шаблон развертывания при соблюдении условия.

> [!NOTE]
> [Вложенные шаблоны](../../../azure-resource-manager/templates/linked-templates.md#nested-template) поддерживаются с **deployIfNotExists**, но [связанные шаблоны](../../../azure-resource-manager/templates/linked-templates.md#linked-template) сейчас не поддерживаются.

### <a name="deployifnotexists-evaluation"></a>Оценка DeployIfNotExists

Действие DeployIfNotExists выполняется в течении примерно 15 минут после того, как поставщик ресурсов обрабатывает запрос на создание или обновление запрос ресурса и возвращает код состояния, указывающий на успешное выполнение. Шаблон развертывания появляется только при отсутствии связанных ресурсов или в том случае, если для ресурсов, определенных в условии **ExistenceCondition**, не возвращается значение true.
Длительность развертывания зависит от сложности ресурсов, включенных в шаблон.

В рамках цикла оценки ресурсы, соответствующие определениям политики с действием DeployIfNotExists, отмечаются как несоответствующие, но с ними не выполняется никаких действий. Существующие несоответствующие ресурсы можно исправить, активировав [задачу исправления](../how-to/remediate-resources.md).

### <a name="deployifnotexists-properties"></a>Свойства DeployIfNotExists

Свойство **details** действия DeployIfNotExists содержит все дочерние свойства, определяющие связанные ресурсы для сопоставления и шаблон развертывания.

- **Тип** (обязательно)
  - Указывает тип связанного ресурса для сопоставления.
  - Для начала совершается попытка получить дочерний ресурс для ресурса из условия **if**, а затем отправляются запросы в рамках той группы ресурсов, в которую входит ресурс из условия **if**.
- **Name** (необязательный)
  - Указывает точное имя сопоставляемого ресурса. При этом политика получает определенный ресурс, а не все ресурсы указанного типа.
  - Если значения условия для **. Field. Type** и then. **Details. Type** совпадают, то **имя** является _обязательным_ и должно быть `[field('name')]` или `[field('fullName')]` для дочернего ресурса.
- **ResourceGroupName** (необязательный)
  - Позволяет сопоставить связанный ресурс из другой группы ресурсов.
  - Не применяется, если в свойстве **type** указан тип, относящийся к дочернему ресурсу для ресурса из условия **if**.
  - По умолчанию указывается группа ресурсов, в которую входит ресурс из условия **if**.
  - Шаблон развертывания выполняется в группе ресурсов, соответствующей этому значению.
- **ExistenceScope** (необязательный)
  - Допустимые значения: _Subscription_ и _ResourceGroup_.
  - Задает область, из которой требуется получить связанный ресурс для сопоставления.
  - Не применяется, если в свойстве **type** указан тип, относящийся к дочернему ресурсу для ресурса из условия **if**.
  - Если задано значение _ResourceGroup_, область ограничивается группой ресурсов, в которую входит ресурс из условия **if**, или группой ресурсов, указанной в свойстве **ResourceGroupName**.
  - Если задано значение _Subscription_, запрос применяется ко всей подписке для связанного ресурса.
  - По умолчанию задано значение _ResourceGroup_.
- **ExistenceCondition** (необязательный)
  - Если это свойство не задано, действие применяется ко всем связанным ресурсам, тип которых соответствует свойству **type**, а развертывание не активируется.
  - Используется тот же язык, что и в правиле политики для условия **if**, но оно оценивается отдельно для каждого связанного ресурса.
  - Если при оценке какого-либо связанного ресурса возвращается значение true, то действие не активирует развертывание.
  - С помощью функции [field()] можно проверять эквивалентность значениям из условия **if**.
  - Например, можно убедиться, что родительский ресурс (из условия **if**) находится там же, где и соответствующий связанный ресурс.
- **роледефинитионидс** (обязательно)
  - Это свойство должно содержать массив строк, которые соответствуют идентификатору роли управления доступом на основе ролей, доступному для определенной подписки. Дополнительные сведения см. в статье [Исправление несоответствующих ресурсов с помощью службы "Политика Azure"](../how-to/remediate-resources.md#configure-policy-definition).
- **DeploymentScope** (необязательно)
  - Допустимые значения: _Subscription_ и _ResourceGroup_.
  - Задает тип инициируемого развертывания. _Subscription_ указывает на [развертывание на уровне подписки](../../../azure-resource-manager/templates/deploy-to-subscription.md), а _ResourceGroup_ — на развертывание в группе ресурсов.
  - Свойство _location_ должно быть указано для объекта _Deployment_ при использовании развертываний на уровне подписки.
  - По умолчанию задано значение _ResourceGroup_.
- **Развертывание** (обязательно)
  - Это свойство должно содержать полный шаблон развертывания, так как оно будет передано в API PUT `Microsoft.Resources/deployments`. Дополнительные сведения см. в [документации по REST API развертываний](/rest/api/resources/deployments).

  > [!NOTE]
  > Все функции в свойстве **Deployment** оцениваются как компоненты шаблона, а не политики. Исключение составляет свойство **parameters**, передающее значения из политики в шаблон. Свойство **value** из этого раздела под именем параметра шаблона используется для передачи значения (см. _fullDbName_ в примере DeployIfNotExists).

### <a name="deployifnotexists-example"></a>Пример DeployIfNotExists

Пример Оценка баз данных SQL Server, позволяющая определить, включен ли параметр transparentDataEncryption. Если это не так, выполняется развертывание для включения.

```json
"if": {
    "field": "type",
    "equals": "Microsoft.Sql/servers/databases"
},
"then": {
    "effect": "DeployIfNotExists",
    "details": {
        "type": "Microsoft.Sql/servers/databases/transparentDataEncryption",
        "name": "current",
        "roleDefinitionIds": [
            "/subscriptions/{subscriptionId}/providers/Microsoft.Authorization/roleDefinitions/{roleGUID}",
            "/providers/Microsoft.Authorization/roleDefinitions/{builtinroleGUID}"
        ],
        "existenceCondition": {
            "field": "Microsoft.Sql/transparentDataEncryption.status",
            "equals": "Enabled"
        },
        "deployment": {
            "properties": {
                "mode": "incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "fullDbName": {
                            "type": "string"
                        }
                    },
                    "resources": [{
                        "name": "[concat(parameters('fullDbName'), '/current')]",
                        "type": "Microsoft.Sql/servers/databases/transparentDataEncryption",
                        "apiVersion": "2014-04-01",
                        "properties": {
                            "status": "Enabled"
                        }
                    }]
                },
                "parameters": {
                    "fullDbName": {
                        "value": "[field('fullName')]"
                    }
                }
            }
        }
    }
}
```

## <a name="disabled"></a>Выключено

Это действие применяется при тестировании или для определения, имеет ли политика параметризованное действие. Такая гибкость позволяет отключить одно назначение этой политики вместо всех назначений.

Альтернативой отключенному результату является **енфорцементмоде**, который задается в назначении политики.
Когда **enforcementMode** является _Disabled_, ресурсы все равно оцениваются. Ведение журнала, например журналов действий, и последствий применения политик не выполняются. Дополнительные сведения см. в [назначение политик — режим применения](./assignment-structure.md#enforcement-mode).

## <a name="enforceopaconstraint"></a>EnforceOPAConstraint

Это действие используется с определением политики _mode_ из `Microsoft.Kubernetes.Data`. Оно используется для передачи правил управления допуском Gatekeeper v3, определенных с помощью [OPA Constraint Framework](https://github.com/open-policy-agent/frameworks/tree/master/constraint#opa-constraint-framework), [Open Policy Agent](https://www.openpolicyagent.org/) (OPA) в кластерах Kubernetes в Azure.

> [!IMPORTANT]
> Определения политик ограниченного просмотра с **енфорцеопаконстраинт** и связанными категориями **служб Kubernetes** являются _устаревшими_. Вместо этого используйте режим "эффекты _аудита_ " и " _запретить_ " с помощью поставщика ресурсов `Microsoft.Kubernetes.Data` .

### <a name="enforceopaconstraint-evaluation"></a>Оценка EnforceOPAConstraint

Контроллер допуска Open Policy Agent оценивает все новые запросы в кластере в режиме реального времени.
Каждые 15 минут завершается полное сканирование кластера и результаты отправляются политике Azure.

### <a name="enforceopaconstraint-properties"></a>Свойства EnforceOPAConstraint

Свойство **details** для действия EnforceOPAConstraint имеет вложенные свойства, описывающие правило управления допуском Gatekeeper v3.

- **констраинттемплате** (обязательно)
  - Шаблон ограничения CustomResourceDefinition (CRD), который определяет новые ограничения. Этот шаблон определяет логику Rego, схему ограничения и параметры ограничения, которые передаются через **значения** из политики Azure.
- **ограничение** (обязательно)
  - Реализация CRD шаблона ограничения. Использует параметры, передаваемые через **значения** как `{{ .Values.<valuename> }}`. В приведенном ниже примере это значения `{{ .Values.cpuLimit }}` и `{{ .Values.memoryLimit }}`.
- **значения** (необязательно)
  - Определяет все параметры и значения, передаваемые ограничению. Каждое значение должно существовать в шаблоне ограничения CRD.

### <a name="enforceopaconstraint-example"></a>Пример EnforceOPAConstraint

Пример Правило управления допуском Gatekeeper v3 для задания ограничений контейнера ЦП и ресурсов памяти в Kubernetes.

```json
"if": {
    "allOf": [
        {
            "field": "type",
            "in": [
                "Microsoft.ContainerService/managedClusters",
                "AKS Engine"
            ]
        },
        {
            "field": "location",
            "equals": "westus2"
        }
    ]
},
"then": {
    "effect": "enforceOPAConstraint",
    "details": {
        "constraintTemplate": "https://raw.githubusercontent.com/Azure/azure-policy/master/built-in-references/Kubernetes/container-resource-limits/template.yaml",
        "constraint": "https://raw.githubusercontent.com/Azure/azure-policy/master/built-in-references/Kubernetes/container-resource-limits/constraint.yaml",
        "values": {
            "cpuLimit": "[parameters('cpuLimit')]",
            "memoryLimit": "[parameters('memoryLimit')]"
        }
    }
}
```

## <a name="enforceregopolicy"></a>EnforceRegoPolicy

Это действие используется с определением политики _mode_ из `Microsoft.ContainerService.Data`. Оно используется для передачи правил управления допуском Gatekeeper v2, определенных с помощью [Rego](https://www.openpolicyagent.org/docs/latest/policy-language/#what-is-rego), [Open Policy Agent](https://www.openpolicyagent.org/) (OPA) в [службе AzureKubernetes](../../../aks/intro-kubernetes.md).

> [!IMPORTANT]
> Определения политик ограниченного просмотра с помощью действия **EnforceRegoPolicy**, а также связанная категория **Kubernetes Service** являются _устаревшими_. Вместо этого используйте режим "эффекты _аудита_ " и " _запретить_ " с помощью поставщика ресурсов `Microsoft.Kubernetes.Data` .

### <a name="enforceregopolicy-evaluation"></a>Оценка EnforceRegoPolicy

Контроллер допуска Open Policy Agent оценивает все новые запросы в кластере в режиме реального времени.
Каждые 15 минут завершается полное сканирование кластера и результаты отправляются политике Azure.

### <a name="enforceregopolicy-properties"></a>Свойства EnforceRegoPolicy

Свойство **details** для действия EnforceRegoPolicy имеет вложенные свойства, описывающие правило управления допуском Gatekeeper v2.

- **policyId** (обязательно)
  - Уникальное имя, передаваемое в качестве параметра в правило управления допуском Rego.
- **Политика** (обязательная)
  - Указывает универсальный код ресурса (URI) правила управления допуском Rego.
- **полиципараметерс** (необязательно)
  - Определяет все параметры и значения, передаваемые политике Rego.

### <a name="enforceregopolicy-example"></a>Пример EnforceRegoPolicy

Пример Правило управления допуском Gatekeeper v2, разрешающее только указанные образы контейнеров в AKS.

```json
"if": {
    "allOf": [
        {
            "field": "type",
            "equals": "Microsoft.ContainerService/managedClusters"
        },
        {
            "field": "location",
            "equals": "westus2"
        }
    ]
},
"then": {
    "effect": "EnforceRegoPolicy",
    "details": {
        "policyId": "ContainerAllowedImages",
        "policy": "https://raw.githubusercontent.com/Azure/azure-policy/master/built-in-references/KubernetesService/container-allowed-images/limited-preview/gatekeeperpolicy.rego",
        "policyParameters": {
            "allowedContainerImagesRegex": "[parameters('allowedContainerImagesRegex')]"
        }
    }
}
```

## <a name="modify"></a>Изменить

Параметр modify используется для добавления, обновления или удаления свойств или тегов для ресурса во время создания или обновления.
Распространенный пример — обновление тегов для таких ресурсов, как costCenter. Существующие несоответствующие ресурсы можно исправить, активировав [задачу исправления](../how-to/remediate-resources.md). Одно правило Modify может иметь любое количество операций.

Следующие операции поддерживаются в параметре Modify:

- Добавление, замена или удаление тегов ресурсов. Для тегов изменение политики должно быть `mode` настроено для _индексирования_ , если целевой ресурс не является группой ресурсов.
- Добавьте или замените значение типа управляемого удостоверения ( `identity.type` ) для виртуальных машин и масштабируемых наборов виртуальных машин.
- Добавьте или замените значения определенных псевдонимов (Предварительная версия).
  - Используйте `Get-AzPolicyAlias | Select-Object -ExpandProperty 'Aliases' | Where-Object { $_.DefaultMetadata.Attributes -eq 'Modifiable' }`.
    в Azure PowerShell **4.6.0** или более поздней версии, чтобы получить список псевдонимов, которые можно использовать с параметром MODIFY.

> [!IMPORTANT]
> Если вы управляете тегами, рекомендуется использовать параметр изменить вместо Append в качестве изменения предоставляет дополнительные типы операций и возможность исправлять существующие ресурсы. Однако рекомендуется использовать Append, если вы не можете создать управляемое удостоверение или изменить, пока не поддерживает псевдоним для свойства ресурса.

### <a name="modify-evaluation"></a>Оценка Modify

Modify выполняет оценку до обработки запроса поставщиком ресурсов во время создания или обновления ресурса. Операции изменения применяются к содержимому запроса при соблюдении условия **If** правила политики. Каждая операция изменения может указывать условие, определяющее, когда оно применяется. Операции с условиями, которые вычисляются как _false_ , пропускаются.

Если указан псевдоним, выполняются следующие дополнительные проверки, чтобы гарантировать, что операция изменения не изменит содержимое запроса таким образом, чтобы поставщик ресурсов отклонил его:

- Свойство, которому сопоставлен псевдоним, помечено как изменяемое в версии API запроса.
- Тип токена в операции изменения соответствует ожидаемому типу токена для свойства в версии API запроса.

Если какая – либо из этих проверок не пройдена, вычисление политики будет возвращаться к указанному **конфликтеффект**.

> [!IMPORTANT]
> Рекомменедед, что изменения определений, включающих псевдонимы, используют **конфликт** _аудита_ , чтобы избежать неудачных запросов с помощью версий API, в которых сопоставленное свойство не является изменяемым. Если один и тот же псевдоним ведет себя по-разному между версиями API, для определения операции изменения, используемой для каждой версии API, можно использовать условные операции изменения.

При запуске определения политики с использованием действия Modify в рамках цикла оценки оно не меняет уже существующие ресурсы. Вместо этого ресурсы, отвечающие условию **if**, отмечаются как несоответствующие.

### <a name="modify-properties"></a>Свойства Modify

Свойство **details** действия Modify имеет все вложенные свойства, определяющие разрешения, необходимые для исправления, а также **operations**, используемые для добавления, обновления или удаления значений тегов.

- **роледефинитионидс** (обязательно)
  - Это свойство должно содержать массив строк, которые соответствуют идентификатору роли управления доступом на основе ролей, доступному для определенной подписки. Дополнительные сведения см. в статье [Исправление несоответствующих ресурсов с помощью службы "Политика Azure"](../how-to/remediate-resources.md#configure-policy-definition).
  - Определенная роль должна включать все операции, предоставленные участнику роли [Contributor](../../../role-based-access-control/built-in-roles.md#contributor).
- **конфликтеффект** (необязательно)
  - Определяет, какое определение политики "WINS" в случае, если несколько определений политики изменяет одно и то же свойство или если операция изменения не работает с указанным псевдонимом.
    - Для новых или обновленных ресурсов определение политики с параметром _Deny_ имеет приоритет. Определения политик с _аудитом_ пропустить все **операции**. Если _запрещено_ более одного определения политики, запрос отклоняется как конфликт. Если все определения политик имеют _Аудит_, то ни одна из **операций** определений конфликтующих политик не обрабатывается.
    - Для существующих ресурсов, если более чем одно определение политики имеет значение _Deny_, состояние соответствия является _конфликтом_. Если одно или меньшее количество определений политики _отклоняется_, каждое назначение возвращает состояние соответствия _не соответствует_.
  - Доступные значения: _Audit_, _Deny_, _disabled_.
  - Значение по умолчанию — _Deny_.
- **операции** (обязательные)
  - Массив всех операций тегов, которые должны быть выполнены при сопоставлении ресурсов.
  - Свойства:
    - **Операция** (обязательная)
      - Определяет, какое действие следует предпринять с совпавшим ресурсом. Возможные варианты: _addOrReplace_, _Add_, _Remove_. _Add_ ведет себя так же, как и [Append](#append).
    - **поле** (обязательно)
      - Добавляемый, заменяемый или удаляемый тег Имена тегов должны соответствовать тому же соглашению об именовании, что и другие [поля](./definition-structure.md#fields).
    - **value** [необязательное]
      - Задаваемое значение тега.
      - Это свойство является обязательным, если **operation** (операцией) является _addOrReplace_ или _Add_.
    - **условие** (необязательно)
      - Строка, содержащая выражение языка политики Azure с [функциями политики](./definition-structure.md#policy-functions) , результатом вычисления которых является _true_ или _false_.
      - Не поддерживает следующие функции политики: `field()` , `resourceGroup()` , `subscription()` .

### <a name="modify-operations"></a>Операции Modify

Массив свойств **operation** позволяет изменять несколько тегов различными способами из одного определения политики. Каждая операция состоит из свойств **operation** (операция), **field** (поле) и **value** (значение). Операция определяет, что делает задача исправления в тегах, поле определяет, какой тег изменяется, а значение определяет новый параметр для этого тега. Приведенный ниже пример вносит следующие изменения в теги.

- Задает для тега `environment` значение Test, даже если он уже существует с другим значением.
- Удаляет тег `TempResource`.
- Задает тег `Dept` для параметра политики _DeptName_, настроенного для назначения политики.

```json
"details": {
    ...
    "operations": [
        {
            "operation": "addOrReplace",
            "field": "tags['environment']",
            "value": "Test"
        },
        {
            "operation": "Remove",
            "field": "tags['TempResource']",
        },
        {
            "operation": "addOrReplace",
            "field": "tags['Dept']",
            "value": "[parameters('DeptName')]"
        }
    ]
}
```

Свойство **operation** имеет следующие параметры.

|Операция |Описание |
|-|-|
|addOrReplace |Добавляет определенное свойство или тег и значение к ресурсу, даже если свойство или тег уже существуют с другим значением. |
|Добавить |Добавляет определенное свойство или тег и значение к ресурсу. |
|Удалить |Удаляет заданное свойство или тег из ресурса. |

### <a name="modify-examples"></a>Примеры Modify

Пример 1: Добавьте тег `environment` и замените существующие теги `environment` на Test.

```json
"then": {
    "effect": "modify",
    "details": {
        "roleDefinitionIds": [
            "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
        ],
        "operations": [
            {
                "operation": "addOrReplace",
                "field": "tags['environment']",
                "value": "Test"
            }
        ]
    }
}
```

Пример 2. Удалите тег `env` и добавьте тег `environment` или замените существующие теги `environment` параметризованным значением.

```json
"then": {
    "effect": "modify",
    "details": {
        "roleDefinitionIds": [
            "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
        ],
        "conflictEffect": "deny",
        "operations": [
            {
                "operation": "Remove",
                "field": "tags['env']"
            },
            {
                "operation": "addOrReplace",
                "field": "tags['environment']",
                "value": "[parameters('tagValue')]"
            }
        ]
    }
}
```

Пример 3. Убедитесь, что учетная запись хранения не разрешает доступ к большому двоичному объекту, операция изменения применяется только при вычислении запросов с API версии выше или равным "2019-04-01":

```json
"then": {
    "effect": "modify",
    "details": {
        "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/17d1049b-9a84-46fb-8f53-869881c3d3ab"
        ],
        "conflictEffect": "audit",
        "operations": [
            {
                "condition": "[greaterOrEquals(requestContext().apiVersion, '2019-04-01')]",
                "operation": "addOrReplace",
                "field": "Microsoft.Storage/storageAccounts/allowBlobPublicAccess",
                "value": false
            }
        ]
    }
}
```

## <a name="layering-policy-definitions"></a>Наложение определений политик

На ресурс могут влиять несколько назначений. Эти назначения могут быть в одной или в разных областях. Для этих назначений наверняка будут назначены разные действия. Условие и действие для каждой политики вычисляется независимо друг от друга. Пример:

- Политика 1
  - Ограничивает расположение ресурсов для региона "westus"
  - Назначенная подписка А
  - Результат запрета
- Политика 2
  - Ограничивает расположение ресурсов для региона "eastus"
  - Назначенные группе ресурсов B в подписке A
  - Действие аудита
  
Эта настройка приведет к следующему результату.

- Любой ресурс, уже входящий в группу ресурсов В и находящийся в регионе "eastus", соответствует политике 2, но не соответствует политике 1.
- Любой ресурс, уже входящий в группу ресурсов В и не находящийся в регионе "eastus", не соответствует политике 2 и политике 1, если не находится в регионе "westus".
- Любой новый ресурс в подписке А, не расположенный в регионе "westus", отклоняется политикой 1.
- Любой новый ресурс, который создается в подписке A и группе ресурсов В, расположенный в регионе "westus" и не соответствует политике 2.

Если задать для политик 1 и 2 действие запрета, ситуация изменится следующим образом.

- Любой ресурс, уже входящий в группу ресурсов В, но не расположенный в регионе "eastus", не соответствует политике 2.
- Любой ресурс, уже входящий в группу ресурсов В, но не расположенный в регионе "westus", не соответствует политике 1.
- Любой новый ресурс в подписке А, не расположенный в регионе "westus", отклоняется политикой 1.
- Любой новый ресурс в группе ресурсов B в подписке A запрещается.

Каждое назначение оценивается по отдельности. Таким образом, у ресурса нет возможности ускользнуть из-за различий в объеме. Общий результат наложения определений политик считается **накопительным по принципу максимальной строгости**. Например, если бы политики 1 и 2 имели эффект запрета, ресурс был бы заблокирован перекрывающимися и конфликтующими определениями политик. Если вам все равно нужно создать ресурс в целевой области, пересмотрите исключения в каждом назначении, чтобы гарантировать, что определения политик влияют на правильные области.

## <a name="next-steps"></a>Дальнейшие действия

- Рассмотрите [примеры для службы "Политика Azure"](../samples/index.md).
- Изучите статью о [структуре определения Политики Azure](definition-structure.md).
- Узнайте о [программном создании политик](../how-to/programmatically-create.md).
- Узнайте, как [получать сведения о соответствии](../how-to/get-compliance-data.md).
- Узнайте, как [исправлять несоответствующие ресурсы](../how-to/remediate-resources.md).
- Дополнительные сведения о группе управления см. в статье [Упорядочивание ресурсов с помощью групп управления Azure](../../management-groups/overview.md).
