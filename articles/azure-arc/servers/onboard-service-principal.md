---
title: Подключение гибридных компьютеров к Azure в большом масштабе
description: Из этой статьи вы узнаете, как подключить компьютеры к Azure с помощью серверов с поддержкой ARC в Azure с помощью субъекта-службы.
ms.date: 03/04/2021
ms.topic: conceptual
ms.openlocfilehash: c1ad3d4619896ff46db266789a17bfca80712e70
ms.sourcegitcommit: 24a12d4692c4a4c97f6e31a5fbda971695c4cd68
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/05/2021
ms.locfileid: "102175946"
---
# <a name="connect-hybrid-machines-to-azure-at-scale"></a>Подключение гибридных компьютеров к Azure в большом масштабе

Вы можете включить серверы с поддержкой ARC в Azure для нескольких компьютеров Windows или Linux в среде с несколькими гибкими возможностями в зависимости от требований. Используя предоставленный сценарий шаблона, можно автоматизировать каждый шаг установки, включая установку подключения к Azure Arc. Тем не менее, вам потребуется интерактивно выполнить этот сценарий с учетной записью, обладающей повышенным уровнем разрешений на целевом компьютере и в Azure.

Чтобы подключить компьютеры к серверам с поддержкой Arc Azure, можно использовать субъект- [службу](../../active-directory/develop/app-objects-and-service-principals.md) Azure Active Directory вместо использования привилегированного удостоверения для [интерактивного подключения компьютера](onboard-portal.md). Субъект-служба — это специальное ограниченное удостоверение управления, которому предоставляются только минимальные разрешения, необходимые для подключения компьютеров к Azure с помощью команды `azcmagent`. Это более безопасно, чем использование учетной записи с более высоким уровнем привилегий, такой как администратор клиента, и соответствует рекомендациям по обеспечению безопасности управления доступом. Субъект-служба используется только во время подключения и не используется для других целей.  

Методы установки и настройки агента Connected Machine требуют, чтобы для автоматизированного метода на компьютерах вам были предоставлены разрешения администратора. В Linux для этого используется корневая учетная запись, а в Windows следует быть членом группы локальных администраторов.

Прежде чем приступить к работе, ознакомьтесь с данными о [необходимых компонентах](agent-overview.md#prerequisites) и убедитесь, что подписка и ресурсы соответствуют требованиям. Сведения о поддерживаемых регионах и других связанных вопросах см. в разделе [Поддерживаемые регионы Azure](overview.md#supported-regions). Кроме того, ознакомьтесь с нашим [руководством по планированию](plan-at-scale-deployment.md) , чтобы понять критерии проектирования и развертывания, а также рекомендации по управлению и мониторингу.  

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

## <a name="create-a-service-principal-for-onboarding-at-scale"></a>Создание субъекта-службы для подключения в большом масштабе

Вы можете создать субъект-службу с помощью [Azure PowerShell](/powershell/azure/install-az-ps), выполнив командлет [New-AzADServicePrincipal](/powershell/module/Az.Resources/New-AzADServicePrincipal). Для этого можно также выполнить действия, описанные в статье [Создание субъекта-службы с помощью портала Azure](../../active-directory/develop/howto-create-service-principal-portal.md).

> [!NOTE]
> Перед созданием субъекта-службы ваша учетная запись должна быть членом роли " **владелец** " или " **администратор доступа пользователей** " в подписке, которую вы хотите использовать для адаптации. Если у вас нет достаточных разрешений для настройки назначений ролей, субъект-служба может быть создан, но не сможет подключить компьютеры.
>

Чтобы создать субъект-службу с помощью PowerShell, выполните следующие действия.

1. Выполните следующую команду. Необходимо сохранить выходные данные командлета [`New-AzADServicePrincipal`](/powershell/module/az.resources/new-azadserviceprincipal) в переменной, иначе вы не сможете получить пароль, который потребуется позже.

    ```azurepowershell-interactive
    $sp = New-AzADServicePrincipal -DisplayName "Arc-for-servers" -Role "Azure Connected Machine Onboarding"
    $sp
    ```

    ```output
    Secret                : System.Security.SecureString
    ServicePrincipalNames : {ad9bcd79-be9c-45ab-abd8-80ca1654a7d1, https://Arc-for-servers}
    ApplicationId         : ad9bcd79-be9c-45ab-abd8-80ca1654a7d1
    ObjectType            : ServicePrincipal
    DisplayName           : Hybrid-RP
    Id                    : 5be92c87-01c4-42f5-bade-c1c10af87758
    Type                  :
    ```

2. Чтобы получить пароль, хранящийся в переменной `$sp`, выполните следующую команду.

    ```azurepowershell-interactive
    $credential = New-Object pscredential -ArgumentList "temp", $sp.Secret
    $credential.GetNetworkCredential().password
    ```

3. В выходных данных найдите значение пароля в поле **password** и скопируйте его. Кроме того, найдите значение в поле **ApplicationId** и скопируйте его. Сохраните их в безопасном месте для последующего использования. Если вы забудете или потеряете пароль имени субъекта-службы, его можно сбросить с помощью командлета [`New-AzADSpCredential`](/powershell/module/azurerm.resources/new-azurermadspcredential).

Значения из следующих свойств используются для параметров, передаваемыми в `azcmagent`.

* Свойство **ApplicationId** используется в качестве значения параметра `--service-principal-id`.
* Свойство **password** используется в качестве значения `--service-principal-secret` при подключении агента.

> [!NOTE]
> Убедитесь, что для субъекта-службы используется свойство **ApplicationId**, а не **Id**.
>

Роль **Подключение Azure Connected Machine** содержит только разрешения, необходимые для подключения компьютера. Вы можете назначить субъекту-службе разрешение, чтобы добавить в его область группу ресурсов или подписку. Чтобы добавить назначение ролей, см. статью [назначение ролей Azure с помощью портал Azure](../../role-based-access-control/role-assignments-portal.md) или [назначение ролей azure с помощью Azure CLI](../../role-based-access-control/role-assignments-cli.md).

## <a name="generate-the-installation-script-from-the-azure-portal"></a>Создание скрипта установки на портале Azure

Скрипт для автоматизации скачивания и установки, а также для установки подключения к Azure Arc, доступен на портале Azure. Чтобы завершить процесс, выполните следующие действия.

1. В браузере перейдите на [портал Azure](https://portal.azure.com).

1. На странице **Серверы —Azure Arc** щелкните **Добавить** в левом верхнем углу.

1. На странице **Выбор метода** выберите плитку **Добавить несколько серверов** , а затем выберите **создать скрипт**.

1. На странице **Создать скрипт** выберите подписку и группу ресурсов, которые следует использовать для управления компьютером в Azure. Выберите расположение Azure, в котором будут храниться метаданные компьютера. Это расположение может совпадать или не совпадать с расположением группы ресурсов.

1. На странице **Необходимые условия** просмотрите сведения и нажмите кнопку **Далее: Сведения о ресурсе**.

1. На странице **Сведения о ресурсе** укажите следующее:

    1. В раскрывающемся списке **Группа ресурсов** выберите группу ресурсов, из которой будет осуществляться управление компьютером.
    1. В раскрывающемся списке **Регион** выберите регион Azure для хранения метаданных серверов.
    1. В раскрывающемся списке **Операционная система** выберите операционную систему, на которой настроен сценарий.
    1. Если компьютер обменивается данными через прокси-сервер для подключения к Интернету, укажите IP-адрес прокси-сервера или имя и номер порта, которые будут использоваться компьютером для взаимодействия с прокси-сервером. Введите значение в формате `http://<proxyURL>:<proxyport>`.
    1. Выберите **Далее: проверка подлинности**.

1. На странице **Проверка подлинности** в раскрывающемся списке **субъект-служба** выберите **Arc — for-Servers**.  Затем нажмите кнопку **Далее: Теги**.

1. На странице **Теги** проверьте **теги физического расположения**, заданные по умолчанию, а затем введите нужное значение или укажите один или несколько **настраиваемых тегов** в соответствии со своими стандартами.

1. По завершении выберите **Next: Download and run script** (Далее: скачивание и выполнение скрипта).

1. На вкладке **Download and run script** (Скачивание и выполнение скрипта) просмотрите сводные данные и щелкните **Скачать**. Если вам все еще нужно внести изменения, щелкните **Назад**.

Для Windows вам будет предложено сохранить `OnboardingScript.ps1` и для Linux `OnboardingScript.sh` на компьютере.

## <a name="install-the-agent-and-connect-to-azure"></a>Установка агента и подключение к Azure

После создания шаблона скрипта, созданного ранее, можно установить и настроить агент подключенного компьютера на нескольких гибридных компьютерах Linux и Windows с помощью предпочтительного средства автоматизации для организаций. Сценарий выполняет аналогичные действия, описанные в статье [подключение гибридных компьютеров к Azure из портал Azure](onboard-portal.md) . Разница заключается в последнем шаге, где устанавливается подключение к службе "Дуга Azure" с помощью `azcmagent` команды с помощью субъекта-службы.

Ниже приведены параметры команды `azcmagent` для использования субъекта-службы.

* `service-principal-id` — Уникальный идентификатор (GUID), представляющий идентификатор приложения субъекта-службы.
* `service-principal-secret` | Пароль субъекта-службы.
* `tenant-id` : Уникальный идентификатор (GUID), представляющий выделенный экземпляр Azure AD.
* `subscription-id` : Идентификатор (GUID) подписки Azure, в которой должны размещаться компьютеры.
* `resource-group` : Имя группы ресурсов, к которой должны принадлежать подключенные компьютеры.
* `location` : Ознакомьтесь с [поддерживаемыми регионами Azure](overview.md#supported-regions). Это расположение может совпадать или не совпадать с расположением группы ресурсов.
* `resource-name` : (*Необязательно*.) Используется для представления ресурсов Azure на локальном компьютере. Если это значение не указано, будет использовано имя узла компьютера.

Вы можете узнать больше о программе командной строки `azcmagent`, изучив [справочные материалы по Azcmagent](./manage-agent.md).

>[!NOTE]
>Сценарий Windows PowerShell поддерживает только запуск из 64-разрядной версии Windows PowerShell.
>

После установки агента и настройки его подключения к серверам с поддержкой Azure Arc перейдите на портал Azure, чтобы убедиться, что сервер подключен. Просмотрите свои компьютеры на [портале Azure](https://aka.ms/hybridmachineportal).

![Успешное соединение с сервером](./media/onboard-portal/arc-for-servers-successful-onboard.png)

## <a name="next-steps"></a>Дальнейшие действия

- Сведения об устранении неполадок можно найти в разделе [руководство по устранению неполадок подключенного компьютера](troubleshoot-agent-onboard.md).

- Узнайте, как управлять компьютером с помощью [политики Azure](../../governance/policy/overview.md), например [гостевой конфигурации](../../governance/policy/concepts/guest-configuration.md)виртуальной машины, проверить, что компьютер сообщает о предполагаемой log Analytics рабочей области, включить мониторинг с помощью [Azure Monitor с виртуальными машинами](../../azure-monitor/vm/vminsights-enable-policy.md)и многое другое.

- Узнайте больше об [агенте Log Analytics](../../azure-monitor/agents/log-analytics-agent.md). Агент Log Analytics для Windows и Linux является обязательным, если вы хотите получить данные мониторинга операционной системы и рабочей нагрузки с помощью Azure Monitor для виртуальных машин, управлять им с помощью модулей Runbook или функций автоматизации, таких как Управление обновлениями, или использовать другие службы Azure, такие как [Центр безопасности Azure](../../security-center/security-center-introduction.md).
