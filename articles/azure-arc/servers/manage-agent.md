---
title: Управление агентом серверов с поддержкой ARC в Azure
description: В этой статье описываются различные задачи управления, которые обычно выполняются в течение жизненного цикла агента подключенного компьютера с поддержкой ARC в Azure.
ms.date: 02/10/2021
ms.topic: conceptual
ms.openlocfilehash: cc42830fc73612e744942bdd8b353832e0ccbf2a
ms.sourcegitcommit: d4734bc680ea221ea80fdea67859d6d32241aefc
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/14/2021
ms.locfileid: "100368461"
---
# <a name="managing-and-maintaining-the-connected-machine-agent"></a>Обслуживание агента Connected Machine и управление им

После первоначального развертывания на серверах с поддержкой ARC в Azure, подключенных к Windows или Linux, может потребоваться перенастроить агент, обновить его или удалить с компьютера. Вы можете легко управлять этими задачами обслуживания вручную или автоматизировать этот процесс, сократив при этом эксплуатационные расходы и количество ошибок.

## <a name="before-uninstalling-agent"></a>Перед удалением агента

Прежде чем удалить агент подключенного компьютера с сервера с поддержкой Arc, примите во внимание следующие моменты, чтобы избежать непредвиденных проблем или затрат, добавленных в счет Azure.

* Если вы развернули расширения виртуальной машины Azure на включенном сервере и удалите агент подключенного компьютера или удалите ресурс, представляющий сервер с поддержкой ARC в группе ресурсов, эти расширения продолжают работать и выполнять их нормальную работу.

* Если удалить ресурс, представляющий сервер с поддержкой ARC в группе ресурсов, но вы не удалите расширения виртуальной машины, при повторной регистрации компьютера вы не сможете управлять установленными расширениями виртуальной машины.

Для серверов или компьютеров, которыми больше не требуется управлять с помощью серверов с поддержкой Arc, необходимо выполнить следующие действия, чтобы успешно завершить управление ИТ-службой.

1. Удалите расширения виртуальной машины с компьютера или с сервера. Действия приведены ниже.

2. Отключите компьютер от дуги Azure с помощью одного из следующих методов:

    * Выполнение `azcmagent disconnect` команды на компьютере или сервере.

    * С выбранного зарегистрированного сервера Arc, включенного в портал Azure, выберите **Удалить** на верхней панели.

    * Использование [Azure CLI](../../azure-resource-manager/management/delete-resource-group.md?tabs=azure-cli#delete-resource) или [Azure PowerShell](../../azure-resource-manager/management/delete-resource-group.md?tabs=azure-powershell#delete-resource). Для `ResourceType` параметра используйте `Microsoft.HybridCompute/machines` .

3. [Удалите агент](#remove-the-agent) с компьютера или с сервера, выполнив следующие действия.

## <a name="renaming-a-machine"></a>Переименование компьютера

При изменении имени компьютера Linux или Windows, подключенного к серверам с поддержкой дуги Azure, новое имя не распознается автоматически, так как имя ресурса в Azure является неизменяемым. Как и в случае с другими ресурсами Azure, необходимо удалить ресурс и создать его повторно, чтобы использовать новое имя.

Для серверов с поддержкой Arc перед переименованием компьютера необходимо удалить расширения виртуальной машины, прежде чем продолжать работу.

> [!NOTE]
> Хотя установленные расширения продолжают работать и выполняют нормальную работу после завершения этой процедуры, вы не сможете управлять ими. При попытке повторного развертывания расширений на компьютере может возникать непредсказуемое поведение.

> [!WARNING]
> Рекомендуется избегать переименования имени компьютера компьютера и выполнять эту процедуру только в случае крайней необходимости.

1. Произведите аудит установленных на компьютере расширений виртуальной машины и запишите их конфигурацию, используя [Azure CLI](manage-vm-extensions-cli.md#list-extensions-installed) или [Azure PowerShell](manage-vm-extensions-powershell.md#list-extensions-installed).

2. Удалите расширения виртуальной машины, установленные из [портал Azure](manage-vm-extensions-portal.md#uninstall-extension), с помощью [Azure CLI](manage-vm-extensions-cli.md#remove-an-installed-extension)или с помощью [Azure PowerShell](manage-vm-extensions-powershell.md#remove-an-installed-extension).

3. Используйте средство **азкмажент** с параметром [Disconnect](manage-agent.md#disconnect) для отключения компьютера от дуги Azure и удаления ресурса компьютера из Azure. Отключение компьютера от серверов с поддержкой Arc не приводит к удалению агента подключенного компьютера, и вам не нужно удалять агент в рамках этого процесса. Вы можете запустить его вручную, войдя в систему в интерактивном режиме, или автоматизировать с помощью того же субъекта-службы, который использовался для подключения нескольких агентов, или с помощью [маркера доступа](../../active-directory/develop/access-tokens.md)платформы удостоверений Майкрософт. Если вы не использовали субъект-службу для регистрации компьютера с серверами с поддержкой дуги Azure, ознакомьтесь со следующей [статьей](onboard-service-principal.md#create-a-service-principal-for-onboarding-at-scale) , чтобы создать субъект-службу.

4. Переименуйте имя компьютера компьютеров.

5. Повторно зарегистрируйте агент подключенного компьютера с серверами с поддержкой ARC. Запустите `azcmagent` средство с параметром [Connect](manage-agent.md#connect) выполнить этот шаг.

6. Повторно разверните расширения виртуальной машины, которые изначально были развернуты на компьютере с серверов с поддержкой ARC. Если вы развернули агент Azure Monitor для виртуальных машин (Insights) или агент Log Analytics с помощью политики Azure, агенты будут развернуты повторно после следующего [цикла оценки](../../governance/policy/how-to/get-compliance-data.md#evaluation-triggers).

## <a name="upgrading-agent"></a>Обновление агента

Агент подключенного компьютера Azure регулярно обновляется для устранения ошибок, улучшения стабильности и новой функциональности. [Помощник Azure](../../advisor/advisor-overview.md) определяет ресурсы, которые не используют последнюю версию агента компьютера, и рекомендует выполнить обновление до последней версии. При выборе сервера с поддержкой Arc отображается баннер на странице **обзора** или при доступе к помощнику через портал Azure.

Агент Azure Connected Machine для Windows и Linux можно обновить до последней версии вручную или автоматически в зависимости от требований.

Следующая таблица описывает методы, поддерживаемые при обновлении агента.

| Операционная система | Метод перехода |
|------------------|----------------|
| Windows | Вручную<br> Центр обновления Windows |
| Ubuntu | [Apt](https://help.ubuntu.com/lts/serverguide/apt.html) |
| SUSE Linux Enterprise Server | [zypper](https://en.opensuse.org/SDB:Zypper_usage_11.3) |
| RedHat Enterprise, Amazon, CentOS Linux | [yum](https://wiki.centos.org/PackageManagement/Yum) |

### <a name="windows-agent"></a>Агент Windows

Пакет обновления для агента Connected Machine для Windows доступен здесь:

* Центр обновления Майкрософт

* [Каталог Центра обновления Майкрософт](https://www.catalog.update.microsoft.com/Home.aspx)

* [Пакет установщика Windows для агента Windows](https://aka.ms/AzureConnectedMachineAgent) из Центра загрузки Майкрософт.

Агент можно обновить следующими способами для поддержки процесса управления обновлениями программного обеспечения. Помимо получения из Центра обновления Майкрософт, агент можно скачать и запустить вручную из командной строки, из скрипта или другого решения по автоматизации, или из мастера пользовательского интерфейса, выполнив команду `AzureConnectedMachine.msi`.

> [!NOTE]
> * Чтобы обновить агент, необходимы разрешения *Администратора*.
> * Чтобы обновить вручную, сначала необходимо скачать и скопировать пакет установщика в папку на целевом сервере или сделать это из общей сетевой папки. 

Если вы не работали с параметрами командной строки для пакетов установщика Windows, ознакомьтесь со [стандартными параметрами командной строки Msiexec](/windows/win32/msi/standard-installer-command-line-options) и [параметрами командной строки Msiexec](/windows/win32/msi/command-line-options).

#### <a name="to-upgrade-using-the-setup-wizard"></a>Обновление с помощью мастера установки

1. Войдите в систему компьютера, используя учетную запись с правами администратора.

2. Выполните команду **AzureConnectedMachineAgent.msi**, чтобы запустить мастер установки.

Мастер установки определяет наличие предыдущей версии, а затем автоматически обновляет агента. После завершения обновления мастер установки автоматически закроется.

#### <a name="to-upgrade-from-the-command-line"></a>Обновление с помощью командной строки

1. Войдите в систему компьютера, используя учетную запись с правами администратора.

2. Чтобы автоматически обновить агент и создать файл журнала установки в папке `C:\Support\Logs`, выполните следующую команду.

    ```dos
    msiexec.exe /i AzureConnectedMachineAgent.msi /qn /l*v "C:\Support\Logs\Azcmagentupgradesetup.log"
    ```

### <a name="linux-agent"></a>Агент Linux

Чтобы обновить агент на компьютере Linux до последней версии, требуется две команды. Одна команда для обновления индекса локального пакета со списком последних доступных пакетов из репозиториев и вторая команда для обновления локального пакета.

Вы можете скачать последнюю версию пакета агента из [репозитория пакетов](https://packages.microsoft.com/) корпорации Майкрософт.

> [!NOTE]
> Чтобы обновить агент, необходимо иметь разрешения *корневого* доступа или учетную запись, которой повысили права с помощью команды Sudo.

#### <a name="upgrade-ubuntu"></a>Обновление Ubuntu

1. Чтобы обновить индекс локального пакета с помощью последних изменений, внесенных в репозитории, выполните следующую команду:

    ```bash
    apt update
    ```

2. Чтобы обновить систему, выполните следующую команду:

    ```bash
    apt upgrade
    ```

Действия команды [apt](https://help.ubuntu.com/lts/serverguide/apt.html), такие как установка и удаление пакетов, записываются в файл журнала `/var/log/dpkg.log`.

#### <a name="upgrade-red-hatcentosamazon-linux"></a>Обновление Red Hat/CentOS/Amazon Linux

1. Чтобы обновить индекс локального пакета с помощью последних изменений, внесенных в репозитории, выполните следующую команду:

    ```bash
    yum check-update
    ```

2. Чтобы обновить систему, выполните следующую команду:

    ```bash
    yum update
    ```

Действия команды [yum](https://access.redhat.com/articles/yum-cheat-sheet), такие как установка и удаление пакетов, записываются в файл журнала `/var/log/yum.log`. 

#### <a name="upgrade-suse-linux-enterprise"></a>Обновление SUSE Linux Enterprise

1. Чтобы обновить индекс локального пакета с помощью последних изменений, внесенных в репозитории, выполните следующую команду:

    ```bash
    zypper refresh
    ```

2. Чтобы обновить систему, выполните следующую команду:

    ```bash
    zypper update
    ```

Действия команды [zypper](https://en.opensuse.org/Portal:Zypper), такие как установка и удаление пакетов, записываются в файл журнала `/var/log/zypper.log`.

## <a name="about-the-azcmagent-tool"></a>Сведения о средстве Azcmagent

Средство Азкмажент (Azcmagent.exe) используется для настройки агента подключенного компьютера с поддержкой ARC в Azure во время установки или изменения начальной конфигурации агента после установки. Azcmagent.exe предоставляет параметры командной строки для настройки агента и просмотра его состояния:

* **Connect** (Подключить). Чтобы подключить компьютер к Azure Arc.

* **Disconnect** (Отключить). Чтобы отключить компьютер от Azure Arc.

* **Show** (Показать). Просмотр состояния агента и его свойств конфигурации (имя группы ресурсов, идентификатора подписки, версии и т. д.), которые могут помочь при устранении неполадок с агентом. Включите `-j` параметр для вывода результатов в формате JSON.

* **Журналы** — создает ZIP-файл в текущем каталоге, содержащий журналы, которые помогут вам при устранении неполадок.

* **Версия** — показывает версию агента подключенного компьютера.

* **-h или --help**. Отображает возможные параметры командной строки.

    Например, чтобы просмотреть подробную справку по параметру **Connect** , введите `azcmagent connect -h` . 

* **-v или --verbose**. Включение подробного ведения журнала.

Вы можете выполнить **Подключение** и **отключиться** вручную, войдя в систему в интерактивном режиме, или автоматизировать с помощью того же субъекта-службы, который использовался для подключения нескольких агентов или с помощью [маркера доступа](../../active-directory/develop/access-tokens.md)платформы удостоверений Майкрософт. Если вы не использовали субъект-службу для регистрации компьютера с серверами с поддержкой дуги Azure, ознакомьтесь со следующей [статьей](onboard-service-principal.md#create-a-service-principal-for-onboarding-at-scale) , чтобы создать субъект-службу.

>[!NOTE]
>Для запуска **азкмажент** требуются права доступа *root* на компьютерах Linux.

### <a name="connect"></a>Подключение

Этот параметр указывает ресурс в Azure Resource Manager, представляющий компьютер, который создается в Azure. Ресурс находится в указанной подписке и группе ресурсов, а данные о компьютере хранятся в регионе Azure, указанном параметром `--location`. Имя ресурса по умолчанию является именем узла компьютера, если оно не указано.

Затем сертификат, соответствующий назначенному системой идентификатору компьютера, скачивается и сохраняется локально. После завершения этого шага служба метаданных компьютера, подключенного к Azure, и агент гостевой конфигурации начинают синхронизацию с серверами с поддержкой Arc Azure.

Чтобы подключиться с помощью субъекта-службы, выполните следующую команду:

`azcmagent connect --service-principal-id <serviceprincipalAppID> --service-principal-secret <serviceprincipalPassword> --tenant-id <tenantID> --subscription-id <subscriptionID> --resource-group <ResourceGroupName> --location <resourceLocation>`

Чтобы подключиться с помощью маркера доступа, выполните следующую команду:

`azcmagent connect --access-token <> --subscription-id <subscriptionID> --resource-group <ResourceGroupName> --location <resourceLocation>`

Чтобы подключиться с помощью учетных данных (интерактивно) с повышенными правами, выполните следующую команду:

`azcmagent connect --tenant-id <TenantID> --subscription-id <subscriptionID> --resource-group <ResourceGroupName> --location <resourceLocation>`

### <a name="disconnect"></a>Отключить

Этот параметр указывает ресурс в Azure Resource Manager, представляющий компьютер, который удаляется в Azure. Агент не удаляется с компьютера, агент удаляется отдельно. Если после отключения компьютера вы хотите повторно зарегистрировать его с помощью серверов с поддержкой дуги Azure, используйте `azcmagent connect` для этого новый ресурс в Azure.

> [!NOTE]
> Если вы развернули одно или несколько расширений виртуальной машины Azure на сервере с поддержкой Arc и удаляете его регистрацию в Azure, расширения по-прежнему устанавливаются. Важно понимать, что в зависимости от установленного расширения он активно выполняет свою функцию. Для компьютеров, которые должны быть отменены или больше не управляются серверами с поддержкой Arc, необходимо сначала удалить расширения, прежде чем удалять регистрацию из Azure.

Чтобы отключиться с помощью субъекта-службы, выполните следующую команду:

`azcmagent disconnect --service-principal-id <serviceprincipalAppID> --service-principal-secret <serviceprincipalPassword> --tenant-id <tenantID>`

Чтобы отключиться с помощью маркера доступа, выполните следующую команду:

`azcmagent disconnect --access-token <accessToken>`

Чтобы отключиться с помощью учетных данных (интерактивно) с повышенными правами, выполните следующую команду:

`azcmagent disconnect`

## <a name="remove-the-agent"></a>Удаление агента

Воспользуйтесь одним из следующих методов, чтобы удалить агент Connected Machine для Windows или Linux с компьютера. Удаление агента не приводит к отмене регистрации компьютера на серверах с поддержкой Arc или удалению установленных расширений виртуальной машины Azure. Отмените регистрацию компьютера и удалите установленные расширения виртуальных машин отдельно, когда больше не требуется управлять машиной в Azure, и эти действия необходимо выполнить до удаления агента.

### <a name="windows-agent"></a>Агент Windows

Оба следующих метода удаляют агент, но не удаляют папку *C:\Program Files\AzureConnectedMachineAgent* на компьютере.

#### <a name="uninstall-from-control-panel"></a>Удаление из панели управления

1. Чтобы удалить агент Windows с компьютера, выполните следующие действия:

    а. Войдите в систему компьютера, используя учетную запись с правами администратора.  
    b. Откройте **Панель управления**, выберите раздел **Программы и компоненты**.  
    c. В разделе **Программы и компоненты** выберите **Azure Connected Machine Agent** (Агент подключенного компьютера Azure), затем **Удалить**, а затем **Да**.  

    >[!NOTE]
    > Можно также запустить мастер установки агента, дважды щелкнув пакет установщика **AzureConnectedMachineAgent.msi**.

#### <a name="uninstall-from-the-command-line"></a>Удаление из командной строки

Чтобы вручную удалить агент из командной строки или использовать автоматизированный метод, например скрипт, можно использовать следующий пример. Сначала из операционной системы необходимо извлечь код продукта, который является уникальным идентификатором, представляющим собой идентификатор субъекта пакета приложения. Удаление выполняется с помощью командной строки Msiexec.exe — `msiexec /x {Product Code}`.

1. откройте редактор реестра;

2. в разделе реестра `HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Uninstall` найдите и скопируйте код GUID продукта;

3. после этого агент можно удалить с помощью Msiexec, используя следующие примеры:

   * из командной строки введите:

       ```dos
       msiexec.exe /x {product code GUID} /qn
       ```

   * эти же действия можно выполнить с помощью PowerShell:

       ```powershell
       Get-ChildItem -Path HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall | `
       Get-ItemProperty | `
       Where-Object {$_.DisplayName -eq "Azure Connected Machine Agent"} | `
       ForEach-Object {MsiExec.exe /x "$($_.PsChildName)" /qn}
       ```

### <a name="linux-agent"></a>Агент Linux

> [!NOTE]
> Чтобы удалить агент, необходимо иметь разрешения *корневого* доступа или учетную запись, которой повысили права с помощью команды Sudo.

Чтобы удалить агент Linux, используемая команда определяется операционной системой Linux.

- В ОС Ubuntu выполните следующую команду:

    ```bash
    sudo apt purge azcmagent
    ```

- В RHEL, CentOS и Amazon Linux выполните следующую команду:

    ```bash
    sudo yum remove azcmagent
    ```

- В ОС SLES выполните следующую команду:

    ```bash
    sudo zypper remove azcmagent
    ```

## <a name="unregister-machine"></a>Отмена регистрации компьютера

Если вы планируете запретить управление компьютером с помощью вспомогательных служб в Azure, выполните следующие действия, чтобы отменить регистрацию компьютера с серверами с поддержкой ARC. Эти действия можно выполнить либо до, либо после удаления агента Connected Machine с компьютера.

1. Откройте серверы с поддержкой ARC в Azure, перейдя к [портал Azure](https://aka.ms/hybridmachineportal).

2. Выберите компьютер в списке, щелкните значок с многоточием ( **...** ), а затем выберите пункт **Удалить**.

## <a name="update-or-remove-proxy-settings"></a>Обновление или удаление параметров прокси-сервера

Чтобы после развертывания настроить взаимодействие агента со службой через прокси-сервер или удалить эту конфигурацию, используйте один из приведенных ниже способов.

> [!NOTE]
> Серверы с поддержкой Arc не поддерживают использование [шлюза log Analytics](../../azure-monitor/platform/gateway.md) в качестве прокси-сервера для агента подключенного компьютера.
>

### <a name="windows"></a>Windows

Чтобы задать переменную среды прокси-сервера, выполните следующую команду:

```powershell
# If a proxy server is needed, execute these commands with the proxy URL and port.
[Environment]::SetEnvironmentVariable("https_proxy","http://{proxy-url}:{proxy-port}","Machine")
$env:https_proxy = [System.Environment]::GetEnvironmentVariable("https_proxy","Machine")
# For the changes to take effect, the agent service needs to be restarted after the proxy environment variable is set.
Restart-Service -Name himds
```

Чтобы настроить агент для прекращения связи через прокси-сервер, выполните следующую команду для удаления переменной среды прокси-сервера и перезапуска службы агента:

```powershell
[Environment]::SetEnvironmentVariable("https_proxy",$null,"Machine")
$env:https_proxy = [System.Environment]::GetEnvironmentVariable("https_proxy","Machine")
# For the changes to take effect, the agent service needs to be restarted after the proxy environment variable removed.
Restart-Service -Name himds
```

### <a name="linux"></a>Linux

Чтобы задать прокси-сервер, выполните следующую команду из каталога, в который вы скачали пакет установки агента:

```bash
# Reconfigure the connected machine agent and set the proxy server.
bash ~/Install_linux_azcmagent.sh --proxy "{proxy-url}:{proxy-port}"
```

Чтобы настроить агент для прекращения связи через прокси-сервер, выполните следующую команду для удаления конфигурации прокси-сервера:

```bash
sudo azcmagent_proxy remove
```

## <a name="next-steps"></a>Дальнейшие действия

* Сведения об устранении неполадок можно найти в разделе [руководство по устранению неполадок подключенного компьютера](troubleshoot-agent-onboard.md).

* Узнайте, как управлять компьютером с помощью [Политики Azure](../../governance/policy/overview.md), например для [гостевой конфигурации](../../governance/policy/concepts/guest-configuration.md) виртуальной машины, проверять отправку отчетов с компьютера в ожидаемую рабочую область Log Analytics, включать мониторинг с помощью [Azure Monitor с виртуальными машинами](../../azure-monitor/insights/vminsights-enable-policy.md) и т. д.

* Узнайте больше об [агенте Log Analytics](../../azure-monitor/platform/log-analytics-agent.md). Агент Log Analytics для Windows и Linux необходим, если требуется получить данные мониторинга операционной системы и рабочей нагрузки, управлять ими с помощью модулей Runbook или функций автоматизации, таких как Управление обновлениями, или использовать другие службы Azure, такие как [Центр безопасности Azure](../../security-center/security-center-introduction.md).