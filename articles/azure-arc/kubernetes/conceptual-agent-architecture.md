---
title: Архитектура агента Kubernetes с включенной службой Arc Azure
services: azure-arc
ms.service: azure-arc
ms.date: 02/15/2021
ms.topic: conceptual
author: shashankbarsin
ms.author: shasb
description: В этой статье представлен обзор архитектуры Kubernetes агентов Azure с поддержкой ARC.
keywords: Kubernetes, Arc, Azure, контейнеры
ms.openlocfilehash: e1f51f066598b59501b30704cb1475dd5332160e
ms.sourcegitcommit: de98cb7b98eaab1b92aa6a378436d9d513494404
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/17/2021
ms.locfileid: "100561677"
---
# <a name="azure-arc-enabled-kubernetes-agent-architecture"></a>Архитектура агента Kubernetes с включенной службой Arc Azure

[Kubernetes](https://kubernetes.io/) можно использовать для согласованного развертывания контейнерных рабочих нагрузок в гибридных и многооблачных средах. Kubernetes с поддержкой дуги Azure можно использовать в качестве централизованной плоскости управления для согласованного управления политикой, управлением и безопасностью в этих разнородных средах. В этой статье приводится следующее:

* Обзор архитектуры подключения кластера к службе "Дуга Azure".
* Шаблон подключения, за которым следуют агенты.
* Описание обмена данными между кластерной средой и Azure.

## <a name="deploy-agents-to-your-cluster"></a>Развертывание агентов в кластере

В большинстве локальных центров обработки данных применяются строгие правила сети, препятствующие входящему соединению через брандмауэр, используемый на границе сети. Kubernetes с включенной службой "Дуга Azure" работает с этими ограничениями, разрешая только те конечные точки исходящего трафика для исходящей связи и не запрашивающие входящие порты в брандмауэре. Агенты Kubernetes с включенной службой Arc Azure инициируют исходящие подключения.

![Общие сведения об архитектуре](./media/architectural-overview.png)

Подключите кластер к службе "Дуга Azure", выполнив следующие действия.

1. Создайте кластер Kubernetes на выбранной инфраструктуре (VMware vSphere, Amazon Web Services, Google Cloud Platform и т. д.). 

    > [!NOTE]
    > Клиенты должны создать и управлять жизненным циклом самого кластера Kubernetes, так как служба "Дуга Azure" включена Kubernetes в настоящее время поддерживает подключение существующих кластеров Kubernetes к службе "Дуга Azure".  

1. Инициируйте регистрацию Azure ARC для кластера с помощью Azure CLI.
    * Azure CLI использует Helm для развертывания диаграммы Helm агента в кластере.
    * Узлы кластера инициируют исходящие подключения к [реестру контейнеров Майкрософт](https://github.com/microsoft/containerregistry) и извлекают образы, необходимые для создания следующих агентов в `azure-arc` пространстве имен:

        | Агент | Описание |
        | ----- | ----------- |
        | `deployment.apps/clusteridentityoperator` | В настоящее время Kubernetes с включенной службой "Дуга Azure" поддерживает только [назначенные системой удостоверения](https://docs.microsoft.com/azure/active-directory/managed-identities-azure-resources/overview). клустеридентитйоператор делает первое исходящее взаимодействие, необходимое для выборки управляемого удостоверения службы (MSI), используемого другими агентами для взаимодействия с Azure. |
        | `deployment.apps/config-agent` | Наблюдает за подключенным кластером для ресурсов конфигурации системы управления версиями, применяемых в кластере, и обновляет состояние соответствия |
        | `deployment.apps/controller-manager` | Оператор операторов, координирующих взаимодействие между компонентами дуги Azure |    
        | `deployment.apps/metrics-agent` | Собирает метрики других агентов Arc, чтобы обеспечить оптимальную производительность этих агентов. |
        | `deployment.apps/cluster-metadata-operator` | Собирает метаданные кластера — версию кластера, число узлов и версию агента ARC для Azure. |
        | `deployment.apps/resource-sync-agent` | Синхронизирует упомянутые выше метаданные кластера с Azure |
        | `deployment.apps/flux-logs-agent` | Собирает журналы из операторов Flux, развернутых в составе конфигурации системы управления версиями |
    
1. После включения всех модулей Kubernetes агента Azure ARC в `Running` состояние убедитесь, что кластер подключен к службе "Дуга Azure". Вы должны увидеть следующее:
    * Ресурс Kubernetes с поддержкой дуги Azure в [Azure Resource Manager](../../azure-resource-manager/management/overview.md). Этот ресурс находится в Azure как проекция управляемого клиентом кластера Kubernetes, а не собственно самого кластера Kubernetes.
    * Метаданные кластера, такие как версия Kubernetes, версия агента и количество узлов, отображаются в ресурсе Arc Azure с поддержкой Kubernetes в качестве метаданных.

## <a name="data-exchange-between-cluster-environment-and-azure"></a>Обмен данными между кластерной средой и Azure

| Тип данных | Сценарий | Режим связи |
| --------- | -------- | ------------------ |
| Версия кластера Kubernetes | Метаданные кластера | Агент отправляет в Azure |
| Число узлов в кластере | Метаданные кластера | Агент отправляет в Azure |
| Версия агента | Метаданные кластера | Агент отправляет в Azure |
| Тип распределения Kubernetes | Метаданные кластера | Azure CLI push-уведомлений в Azure |
| Тип инфраструктуры (AWS/обеспечить/vSphere/...) | Метаданные кластера | Azure CLI push-уведомлений в Azure |
| Виртуальных ЦП число узлов в кластере | Выставление счетов | Azure CLI push-уведомлений в Azure |
| Пульс агента | Работоспособность ресурса | Агент отправляет в Azure |
| Потребление ресурсов (память/ЦП) агентами | Диагностика и поддержка | Агент отправляет в Azure |
| Журналы всех контейнеров агентов | Диагностика и поддержка | Агент отправляет в Azure |
| Доступность обновления агента | Обновление агента | Агент извлекает из Azure |
| Требуемое состояние конфигурации — URL-адрес репозитория Git, параметры оператора Flux, закрытый ключ, известные узлы, содержимое, имя пользователя HTTPS, токен и пароль | Конфигурация | Агент извлекает из Azure |
| Состояние установки оператора Flux | Конфигурация | Агент отправляет в Azure |
| Назначения политики Azure, которые требуют принудительного применения привратника в кластере | Политика Azure | Агент извлекает из Azure |
| Состояние аудита и соответствия требованиям политик в кластере | Политика Azure | Агент отправляет в Azure |
| Метрики и журналы рабочих нагрузок клиентов | Azure Monitor | Агент отправляет Log Analytics ресурс рабочей области в клиент и подписку клиента. |

## <a name="connectivity-status"></a>Состояние подключения

| Состояние | Описание |
| ------ | ----------- |
| Соединение | В службе "Дуга Azure" включен ресурс Kubernetes, созданный в Azure Resource Manager, но служба еще не получила пульс агента. |
| Подключен | Служба Kubernetes с поддержкой службы "Дуга Azure" получила период пульса агента в течение предыдущих 15 минут. |
| Автономная миграция | Ресурс Kubernetes с включенной службой Arc Azure был подключен ранее, но служба не получала пульс агента в течение 15 минут. |
| Срок действия истек | Срок действия сертификата управляемого удостоверения службы (MSI) истекает через 90 дней после его выдачи. После истечения срока действия этого сертификата считается, что ресурс рассматривается `Expired` и все функции, такие как конфигурация, мониторинг и политика, перестают работать в этом кластере. Дополнительные сведения о том, как устранить срок действия ресурсов Kubernetes с включенной службой "Дуга Azure", можно найти [здесь](./faq.md#how-to-address-expired-azure-arc-enabled-kubernetes-resources) . |

## <a name="understand-connectivity-modes"></a>Общие сведения о режимах подключения

| Режим подключения | Описание |
| ----------------- | ----------- |
| Полное подключение | Агенты всегда могут обращаться к Azure. В этом случае опыт идеально подходит, поскольку задержка в распространении конфигураций (для Гитопс), применение политик (в политике и привратнике Azure) и сбор метрик и журналов рабочих нагрузок (в Azure Monitor) |
| С частичным подключением | Сертификат MSI, извлеченный службой, `clusteridentityoperator` действителен в течение 90 дней до истечения срока действия сертификата. После истечения срока действия сертификата ресурс Kubernetes в службе "Дуга Azure" перестанет работать. Удалите и повторно создайте ресурс и агенты Kubernetes в службе "Дуга Azure", чтобы получить все функции ARC для работы в кластере. В течение 90 дней рекомендуется подключать кластер по крайней мере один раз в 30 дней. |
| Отключено | Кластеры Kubernetes в отключенных средах без доступа к Azure сейчас не поддерживаются в Kubernetes с поддержкой ARC. Если эта возможность вам интересна, отправьте или Проголосуйте идею на [форуме по UserVoice для дуги Azure](https://feedback.azure.com/forums/925690-azure-arc).

## <a name="next-steps"></a>Дальнейшие действия

* [Подключение кластера к службе "Дуга Azure"](./connect-cluster.md)
* [Общие сведения о конфигурациях](./conceptual-configurations.md)