---
title: Архитектура агента Kubernetes с включенной службой Arc Azure
services: azure-arc
ms.service: azure-arc
ms.date: 03/03/2021
ms.topic: conceptual
author: shashankbarsin
ms.author: shasb
description: В этой статье представлен обзор архитектуры Kubernetes агентов Azure с поддержкой ARC.
keywords: Kubernetes, Arc, Azure, контейнеры
ms.openlocfilehash: 5e53e99c492f08deab8dea89ec95190782661012
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "102121904"
---
# <a name="azure-arc-enabled-kubernetes-agent-architecture"></a>Архитектура агента Kubernetes с включенной службой Arc Azure

В своей основе [Kubernetes](https://kubernetes.io/) может постоянно развертывать контейнерные рабочие нагрузки в гибридных и многооблачных средах. Однако Kubernetes с поддержкой дуги Azure работает как централизованная, согласованная плоскость управления, которая управляет политикой, управлением и безопасностью в средах разнородных. В этой статье приводится следующее:

* Обзор архитектуры подключения кластера к службе "Дуга Azure".
* Шаблон подключения, за которым следуют агенты.
* Описание обмена данными между кластерной средой и Azure.

## <a name="deploy-agents-to-your-cluster"></a>Развертывание агентов в кластере

В большинстве локальных центров обработки данных применяются строгие правила сети, препятствующие входящему соединению через брандмауэр с границами сети. Kubernetes с включенной службой "Дуга Azure" работает с этими ограничениями, не запрашивая входящие порты в брандмауэре и разрешая только исходящие конечные точки исходящих подключений. Агенты Kubernetes с включенной службой Arc Azure инициируют это исходящее взаимодействие. 

![Общие сведения об архитектуре](./media/architectural-overview.png)

### <a name="connect-a-cluster-to-azure-arc"></a>Подключение кластера к Azure Arc

1. Создайте кластер Kubernetes на выбранной инфраструктуре (VMware vSphere, Amazon Web Services, Google Cloud Platform и т. д.). 

    > [!NOTE]
    > Так как служба ARC в Azure Kubernetes сейчас поддерживает подключение существующих кластеров Kubernetes к службе "Дуга Azure", клиентам необходимо создавать и администрировать жизненный цикл самих кластеров Kubernetes.  

1. Запустите регистрацию Azure ARC для кластера с помощью Azure CLI.
    * Azure CLI использует Helm для развертывания диаграммы Helm агента в кластере.
    * Узлы кластера инициируют исходящие подключения к [реестру контейнеров Майкрософт](https://github.com/microsoft/containerregistry) и извлекают образы, необходимые для создания следующих агентов в `azure-arc` пространстве имен:

        | Агент | Описание |
        | ----- | ----------- |
        | `deployment.apps/clusteridentityoperator` | В настоящее время Kubernetes с включенной службой "Дуга Azure" поддерживает только [назначенные системой удостоверения](../../active-directory/managed-identities-azure-resources/overview.md). `clusteridentityoperator` инициирует первое исходящее взаимодействие. Первое взаимодействие извлекает сертификат Управляемое удостоверение службы (MSI), используемый другими агентами для связи с Azure. |
        | `deployment.apps/config-agent` | Наблюдает за подключенным кластером для ресурсов конфигурации системы управления версиями, примененных к кластеру. Обновляет состояние соответствия. |
        | `deployment.apps/controller-manager` | Оператор операторов, который управляет взаимодействием между компонентами дуги Azure. |    
        | `deployment.apps/metrics-agent` | Собирает метрики других агентов ARC для проверки оптимальной производительности. |
        | `deployment.apps/cluster-metadata-operator` | Собирает метаданные кластера, включая версию кластера, число узлов и версию агента Azure Arc. |
        | `deployment.apps/resource-sync-agent` | Синхронизирует метаданные упомянутого выше кластера с Azure. |
        | `deployment.apps/flux-logs-agent` | Собирает журналы из операторов Flux, развернутых в составе конфигурации системы управления версиями. |
    
1. После того как все модули Kubernetes агента Azure Arc включены `Running` , убедитесь, что кластер подключен к службе "Дуга Azure". Вы должны увидеть следующее:
    * Ресурс Kubernetes с поддержкой дуги Azure в [Azure Resource Manager](../../azure-resource-manager/management/overview.md). Azure отслеживает этот ресурс как проекцию управляемого клиентом кластера Kubernetes, а не собственно самого кластера Kubernetes.
    * Метаданные кластера (такие как версия Kubernetes, версия агента и количество узлов) отображаются в ресурсе Arc Azure с поддержкой Kubernetes в качестве метаданных.

## <a name="data-exchange-between-cluster-environment-and-azure"></a>Обмен данными между кластерной средой и Azure

| Тип данных | Сценарий | Режим связи |
| --------- | -------- | ------------------ |
| Версия кластера Kubernetes | Метаданные кластера | Агент отправляет в Azure |
| Число узлов в кластере | Метаданные кластера | Агент отправляет в Azure |
| Версия агента | Метаданные кластера | Агент отправляет в Azure |
| Тип распределения Kubernetes | Метаданные кластера | Azure CLI push-уведомлений в Azure |
| Тип инфраструктуры (AWS/обеспечить/vSphere/...) | Метаданные кластера | Azure CLI push-уведомлений в Azure |
| Виртуальных ЦП число узлов в кластере | Выставление счетов | Azure CLI push-уведомлений в Azure |
| Пульс агента | Работоспособность ресурса | Агент отправляет в Azure |
| Потребление ресурсов (память/ЦП) агентами | Диагностика и поддержка | Агент отправляет в Azure |
| Журналы всех контейнеров агентов | Диагностика и поддержка | Агент отправляет в Azure |
| Доступность обновления агента | Обновление агента | Агент извлекает из Azure |
| Требуемое состояние конфигурации: URL-адрес репозитория Git, параметры оператора Flux, закрытый ключ, известное содержимое узла, имя пользователя HTTPS, токен или пароль | Конфигурация | Агент извлекает из Azure |
| Состояние установки оператора Flux | Конфигурация | Агент отправляет в Azure |
| Назначения политики Azure, которые требуют принудительного применения привратника в кластере | Политика Azure | Агент извлекает из Azure |
| Состояние аудита и соответствия требованиям политик в кластере | Политика Azure | Агент отправляет в Azure |
| Метрики и журналы рабочих нагрузок клиентов | Azure Monitor | Агент отправляет Log Analytics ресурс рабочей области в клиент и подписку клиента. |

## <a name="connectivity-status"></a>Состояние подключения

| Состояние | Описание |
| ------ | ----------- |
| Соединение | Ресурс Kubernetes с включенной службой "Дуга Azure" создается в Azure Resource Manager, но еще не получил период пульса агента. |
| Подключен | Служба Kubernetes с поддержкой службы "Дуга Azure" получила период пульса агента в течение предыдущих 15 минут. |
| Автономная миграция | Ресурс Kubernetes с включенной службой Arc Azure был подключен ранее, но служба не получала пульс агента в течение 15 минут. |
| Срок действия истек | Срок действия сертификата MSI истек через 90 дней после его выдачи. После истечения срока действия этого сертификата считается, что ресурс рассматривается `Expired` и все функции, такие как конфигурация, мониторинг и политика, перестают работать в этом кластере. Дополнительные сведения о том, как устранить срок действия ресурсов Kubernetes с включенной службой "Дуга Azure [", можно найти в статье часто задаваемых вопросов](./faq.md#how-to-address-expired-azure-arc-enabled-kubernetes-resources). |

## <a name="understand-connectivity-modes"></a>Общие сведения о режимах подключения

| Режим подключения | Описание |
| ----------------- | ----------- |
| Полное подключение | Агенты могут согласованно взаимодействовать с Azure с небольшой задержкой в распространении конфигураций Гитопс, применении политик Azure и привратника, а также сбора метрик рабочей нагрузки и журналов в Azure Monitor. |
| С частичным подключением | Сертификат MSI, извлеченный службой, `clusteridentityoperator` действителен до 90 дней до истечения срока действия сертификата. По истечении срока действия ресурс Kubernetes с включенной службой "Дуга Azure" перестает работать. Чтобы повторно активировать все функции службы "Дуга" Azure в кластере, удалите и повторно создайте ресурс и агенты Kubernetes с включенной службой Arc Azure. В течение 90 дней Подключите кластер по крайней мере один раз в 30 дней. |
| Отключено | Кластеры Kubernetes в отключенных средах не могут получить доступ к Azure в настоящее время не поддерживаются Kubernetes в службе "Дуга" Azure. Если эта возможность вам интересна, отправьте или Проголосуйте идею на [форуме по UserVoice для дуги Azure](https://feedback.azure.com/forums/925690-azure-arc).

## <a name="next-steps"></a>Дальнейшие действия

* Пошаговое руководство по [подключению кластера Kubernetes к службе "Дуга Azure](./connect-cluster.md)".
* Узнайте больше о создании подключений между кластером и репозиторием Git в качестве [ресурса конфигурации с помощью Kubernetes Azure с включенной службой Arc](./conceptual-configurations.md).
