---
title: Рабочий процесс CI/CD с использованием Гитопс — служба "Дуга Azure" включена Kubernetes
services: azure-arc
ms.service: azure-arc
ms.date: 02/26/2021
ms.topic: conceptual
author: tcare
ms.author: tcare
description: В этой статье приводятся общие сведения о рабочем процессе CI/CD с помощью Гитопс
keywords: Гитопс, Kubernetes, K8s, Azure, Helm, Arc, AKS, Azure Kubernetes Service, контейнеры, CI, CD, Azure DevOps
ms.openlocfilehash: 044275db0977a20474aa1451324486ad1750a7f9
ms.sourcegitcommit: c27a20b278f2ac758447418ea4c8c61e27927d6a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/03/2021
ms.locfileid: "101693274"
---
# <a name="overview"></a>Обзор

Современные развертывания Kubernetes размещаются в нескольких приложениях, кластерах и средах. С помощью Гитопс можно более легко управлять этими сложными настройками, отследяя при этом требуемое состояние сред Kubernetes, декларативно с помощью Git. Используя общие средства Git для отслеживания состояния кластера, можно повысить уровень отчетности, упростить анализ сбоев и включить автоматизацию для управления средами.

В этой статье приводятся общие сведения о том, как сделать Гитопс на весь жизненный цикл изменения приложения с помощью Arc, Azure Repos и Azure Pipelines. Пошаговый пример отдельного изменения в приложении от разработчика до Гитопс сред Kubernetes.

## <a name="architecture"></a>Architecture

Рассмотрим приложение, развернутое в одной или нескольких средах Kubernetes.

![Архитектура CI/CD Гитопс](./media/gitops-arch.png)
### <a name="application-repo"></a>Репозиторий приложений
Репозиторий приложений содержит код приложения, над которым разработчики работают во время внутреннего цикла. Шаблоны развертывания приложения находятся в этом репозитории в универсальной форме, например Helm или Кустомизе. Значения, зависящие от среды, не сохраняются. Изменения в этом репозитории вызывают конвейер PR или CI, который запускает процесс развертывания.
### <a name="container-registry"></a>Реестр контейнеров
Реестр контейнеров содержит все образы первого и сторонних производителей, используемые в средах Kubernetes. Помечать образы первого приложения с помощью понятных для человека тегов и фиксации Git, используемой для создания образа. Кэшировать сторонние образы для обеспечения безопасности, скорости и устойчивости. Установите план для своевременного тестирования и интеграции обновлений для системы безопасности. Дополнительные сведения см. в статье [Использование записи контроля доступа и обслуживание общедоступного содержимого](https://docs.microsoft.com/azure/container-registry/tasks-consume-public-content) в качестве примера.
### <a name="pr-pipeline"></a>Конвейер PR
Вытягивание в репозиторий приложений наследуется на успешном выполнении конвейера PR. Этот конвейер выполняет базовые шлюзы качества, такие как linting и модульные тесты в коде приложения. Конвейер проверяет шаблоны Application и линтс файлы dockerfile и Helm, используемые для развертывания в среде Kubernetes. Образы DOCKER должны быть созданы и протестированы, но не помещены в. Не отключайте длительность конвейера относительно короткого, чтобы обеспечить быструю итерацию.
### <a name="ci-pipeline"></a>Конвейер CI
Конвейер CI приложения выполняет все этапы конвейера запросов на вытягивание и развертывает проверки и тесты развертывания. Конвейер может быть выполнен для каждой фиксации или с постоянной ритмичностью с группой фиксаций. На этом этапе выполняется тестирование приложения, слишком длинное для конвейера PR. Отправка образов DOCKER в реестр контейнеров после создания в процессе подготовки к развертыванию. Замененный шаблон может быть линтед с набором проверочных значений. Образы, используемые во время выполнения службы, должны быть линтед, созданы и протестированы на этом этапе. В сборке CI в частности, артефакты публикуются на шаге CD для использования при подготовке к развертыванию.
### <a name="flux"></a>Flux
Flux — это служба, которая выполняется в каждом кластере и отвечает за поддержание требуемого состояния. Служба часто опрашивает репозиторий Гитопс на предмет изменений в кластере и применяет их.
### <a name="cd-pipeline"></a>Конвейер CD
Конвейер CD запускается автоматически при успешном выполнении сборок CI. В нем используются опубликованные ранее шаблоны, заменяются значения среды и открывается объект PR для репозитория Гитопс, чтобы запросить изменение требуемого состояния одного или нескольких кластеров Kubernetes. Администраторы кластера просматривают изменение состояния и утверждают слияние в репозиторий Гитопс. Затем конвейер ожидает завершения запроса на вытягивание, что позволяет Flux выбрать изменение состояния.
### <a name="gitops-repo"></a>Репозиторий Гитопс
Репозиторий Гитопс представляет текущее требуемое состояние всех сред в кластерах. Любое изменение в этом репозитории осуществляется службой Flux в каждом кластере и развернутым. Вытягивание создаются с изменениями требуемого состояния, просмотра и слияния. Эти вытягивание содержат изменения как в шаблонах развертывания, так и в итоговых отображаемых манифестах Kubernetes. Низкоуровневые готовые к просмотру манифесты позволяют избежать каких-либо непредвиденных сюрпризов при подстановке шаблона, разрешая тщательную проверку изменений, которые обычно не видны на уровне шаблона.
### <a name="kubernetes-clusters"></a>Кластеры Kubernetes
Один или несколько кластеров Kubernetes с поддержкой дуги Azure выполняют различные среды, необходимые для приложения. Например, один кластер может обслуживать среду разработки и контроля качества с помощью различных пространств имен. Второй кластер обеспечивает простое разделение сред и более детализированный контроль.
## <a name="example-workflow"></a>Пример рабочего процесса
Как разработчик приложения, Алиса:
* Записывает код приложения.
* Определяет, как запускать приложение в контейнере DOCKER.
* Определяет шаблоны, в которых выполняется контейнер и зависимые службы в кластере Kubernetes.

Хотя Алиса знает, что приложению требуется возможность запуска в нескольких средах, она не знает конкретные параметры для каждой среды.

Предположим, что Алиса хочет внести изменения в приложение, которое изменяет образ DOCKER, используемый в шаблоне развертывания приложения.

1. Алиса изменяет шаблон развертывания, отправляет его в удаленную ветвь в репозитории приложения и открывает запрос на проверку.
2. Алиса запрашивает у своей команды проверку изменений.
    * Конвейер PR выполняет проверку.
    * После успешного выполнения конвейера команда подключается и изменение объединяется.
3. Конвейер CI проверяет изменения Алисы и завершается успешно.
    * Это изменение является надежным для развертывания в кластере, и артефакты сохраняются в выполнении конвейера CI.
4. При этом Алиса выполняет слияние изменений и запускает конвейер CD.
    * Конвейер CD выбирает артефакты, сохраненные с помощью конвейера CI.
    * Конвейер CD подставляет шаблоны с конкретными значениями среды и изменяет состояние существующего кластера в репозитории Гитопс.
    * Конвейер CD создает в репозитории Гитопс запрос на вытягивание с требуемыми изменениями состояния кластера.
5. Группа Алисы изучает и утверждает его.
    * Изменение будет объединено в целевую ветвь, соответствующую среде.
6. В течение нескольких минут Flux замечает изменение в репозитории Гитопс и извлекает изменения Алисы.
    * Из-за изменения образа DOCKER модуль приложения требует обновления.
    * Flux применяет изменения к кластеру.
7. Алиса проверяет конечную точку приложения, чтобы убедиться, что развертывание успешно завершено.
   > [!NOTE]
   > Для дополнительных сред, предназначенных для развертывания, конвейер компакт-дисков проходит через создание запроса на вытягивание для следующей среды и повторяет шаги 4-7. Этот процесс требует дополнительного утверждения для развертываний или сред сложнейшую, таких как изменение, связанное с безопасностью, или рабочая среда.
8.  После того как все среды получили успешные развертывания, конвейер завершается.

## <a name="next-steps"></a>Дальнейшие действия
[Конфигурации и Гитопс с включенной службой Arc Azure Kubernetes](./conceptual-configurations.md)
