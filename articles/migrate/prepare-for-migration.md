---
title: Подготовка компьютеров к миграции с помощью Миграции Azure
description: Подготовка локальных компьютеров к миграции в Azure с помощью службы "Миграция Azure"
author: anvar-ms
ms.author: anvar
ms.manager: bsiva
ms.topic: how-to
ms.date: 06/08/2020
ms.openlocfilehash: 8083b9edd49f65f29fe9c9b2cfa30edfacf89507
ms.sourcegitcommit: e6de1702d3958a3bea275645eb46e4f2e0f011af
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "102614893"
---
# <a name="prepare-on-premises-machines-for-migration-to-azure"></a>Подготовка локальных компьютеров к миграции в Azure

В этой статье описывается подготовка локальных компьютеров перед миграцией в Azure с помощью средства [миграции сервера службы "Миграция Azure"](migrate-services-overview.md#azure-migrate-server-migration-tool).

Работая с этой статьей, вы выполните следующие задачи:
> [!div class="checklist"]
> * Проверка ограничений, накладываемых при выполнении миграции.
> * Выбор метода для миграции виртуальных машин VMware.
> * Проверка требования к гипервизору и операционной системе для компьютеров, которые требуется перенести.
> * Проверка доступа к URL-адресу и порту для компьютеров, которые необходимо перенести.
> * Проверка изменений, которые, возможно, придется внести перед началом миграции.
> * Проверка требований к виртуальным машинам Azure для перенесенных компьютеров.
> * Подготовка компьютеров, позволяющая подключаться к виртуальным машинам Azure после миграции.



## <a name="verify-migration-limitations"></a>Проверка ограничений, накладываемых при выполнении миграции

В таблице представлены сводные данные об ограничениях для обнаружения, оценки и миграции в службе "Миграция Azure". Рекомендуется оценить компьютеры перед миграцией, но это не обязательно.

**Сценарий** | **Проект** | **Обнаружение и оценка** | **Миграция**
--- | --- | --- | ---
**Виртуальные машины VMware** | Обнаружение и оценка до 35 000 виртуальных машин в одном проекте службы "Миграция Azure". | Обнаружение до 10 000 виртуальных машин VMware с помощью одного [устройства Миграции Azure](common-questions-appliance.md) для VMware. | **Миграция без агента.** Вы можете одновременно реплицировать не более 500 виртуальных машин из каждого экземпляра vCenter Server. **Миграция на основе агента**. Для репликации большого количества виртуальных машин можно [горизонтально масштабировать](./agent-based-migration-architecture.md#performance-and-scaling) [устройство репликации](migrate-replication-appliance.md).<br/><br/> На портале можно выбрать до 10 компьютеров для репликации одновременно. Чтобы реплицировать больше компьютеров, объедините их в пакеты по 10 штук.
**Виртуальные машины Hyper-V** | Обнаружение и оценка до 35 000 виртуальных машин в одном проекте службы "Миграция Azure". | Обнаружение до 5 000 виртуальных машин Hyper-V с помощью одного устройства Миграции Azure. | Устройство не используется для миграции Hyper-V. Вместо этого на каждом узле Hyper-V выполняется поставщик репликации Hyper-V.<br/><br/> На производительность репликации влияют такие факторы, как скорость изменения данных виртуальной машины и пропускная способность передачи данных репликации.<br/><br/> На портале можно выбрать до 10 компьютеров для репликации одновременно. Чтобы реплицировать больше компьютеров, объедините их в пакеты по 10 штук.
**Физические компьютеры** | Обнаружение и оценка до 35 000 компьютеров в одном проекте службы "Миграция Azure". | Обнаружение до 250 физических серверов с одним устройством Миграции Azure для физических серверов. | Для репликации большого количества серверов можно [горизонтально масштабировать](./agent-based-migration-architecture.md#performance-and-scaling) [устройство репликации](migrate-replication-appliance.md).<br/><br/> На портале можно выбрать до 10 компьютеров для репликации одновременно. Чтобы реплицировать больше компьютеров, объедините их в пакеты по 10 штук.

## <a name="select-a-vmware-migration-method"></a>Выбор метода миграции VMware

При миграции виртуальных машин VMware в Azure [сравните](server-migrate-overview.md#compare-migration-methods) методы миграции с агентом и без него, чтобы выбрать оптимальный вариант.

## <a name="verify-hypervisor-requirements"></a>Проверка требований гипервизора

- Проверьте требования для миграции виртуальных машин VMware [с агентом](migrate-support-matrix-vmware-migration.md#vmware-requirements-agentless) и [без него](migrate-support-matrix-vmware-migration.md#vmware-requirements-agent-based).
- Проверьте требования к [узлу Hyper-V](migrate-support-matrix-hyper-v-migration.md#hyper-v-host-requirements).


## <a name="verify-operating-system-requirements"></a>Проверка требований к операционной системе

Проверьте поддерживаемые операционные системы для миграции.

- При миграции виртуальных машин VMware или виртуальных машин Hyper-V проверьте требования к виртуальным машинам VMware для миграции [без агента](migrate-support-matrix-vmware-migration.md#vm-requirements-agentless) и [с ним](migrate-support-matrix-vmware-migration.md#vm-requirements-agent-based), а также требования для [виртуальных машин Hyper-V](migrate-support-matrix-hyper-v-migration.md#hyper-v-vms).
- Проверьте, поддерживаются ли [операционные системы Windows](https://support.microsoft.com/help/2721672/microsoft-server-software-support-for-microsoft-azure-virtual-machines) в Azure.
- Проверьте, поддерживаются ли [дистрибутивы Linux](../virtual-machines/linux/endorsed-distros.md) в Azure.

## <a name="review-url-and-port-access"></a>Проверка доступа к URL-адресу или порту

Проверьте, к каким URL-адресам и портам осуществляется доступ во время миграции.

**Сценарий** | **Сведения** |  **URL-адреса** | **Порты**
--- | --- | --- | ---
**Миграция VMware без агента** | Использует для миграции [устройство Миграции Azure](migrate-appliance-architecture.md). На виртуальных машинах VMware ничего не установлено. | Проверьте [URL-адреса](migrate-appliance.md#url-access) общедоступного облака и службы для государственных организаций, необходимые для обнаружения, оценки и миграции с помощью устройства. | [Просмотрите](migrate-support-matrix-vmware-migration.md#port-requirements-agentless) требования к порту для миграции без агента.
**Миграция VMware на основе агента** | Для миграции используется [устройство репликации](migrate-replication-appliance.md). На виртуальных машинах установлен агент службы "Мобильность". | Проверьте URL-адреса [общедоступного облака](migrate-replication-appliance.md#url-access) и [Azure для государственных организаций](migrate-replication-appliance.md#azure-government-url-access), к которым должно иметь доступ устройство репликации. | [Проверьте](migrate-replication-appliance.md#port-access) порты, используемые при миграции на основе агента.
**Миграция Hyper-V** | Использует для миграции поставщик, установленный на узлах Hyper-V. На виртуальных машинах Hyper-V ничего не установлено. | Проверьте URL-адреса [общедоступного облака](migrate-support-matrix-hyper-v-migration.md#url-access-public-cloud) и [Azure для государственных организаций](migrate-support-matrix-hyper-v-migration.md#url-access-azure-government), к которым должен иметь доступ поставщик репликации, запущенный на узлах. | Поставщик репликации на узле Hyper-V использует для отправки данных репликации виртуальной машины исходящие подключения через HTTPS-порт 443.
**Физические компьютеры** | Для миграции используется [устройство репликации](migrate-replication-appliance.md). Агент службы "Мобильность", установленный на каждом физическом компьютере. | Проверьте URL-адреса [общедоступного облака](migrate-replication-appliance.md#url-access) и [Azure для государственных организаций](migrate-replication-appliance.md#azure-government-url-access), к которым должно иметь доступ устройство репликации. | [Проверьте](migrate-replication-appliance.md#port-access) порты, используемые при физической миграции.

## <a name="verify-required-changes-before-migrating"></a>Проверка необходимых изменений перед миграцией

Прежде чем переносить виртуальные машины в Azure, необходимо внести в них некоторые изменения.

- Для некоторых операционных систем служба "Миграция Azure" вносит изменения автоматически в процессе репликации или миграции.
- Для других параметры необходимо настроить вручную.
- Важно настроить параметры вручную до начала миграции. Если вы перенесете виртуальную машину до внесения изменений, она может не загрузиться в Azure.

Изучите таблицы, чтобы узнать, какие изменения необходимо внести.

### <a name="windows-machines"></a>Компьютеры Windows

В таблице кратко описаны обязательные изменения.

**Действие** | **VMware (миграция без агента)** | **VMware (на основе агента) или физические компьютеры** | **Windows на Hyper-V** 
--- | --- | --- | ---
**Настройка для политики SAN значения "Перевод всего в состояние "в сети"**<br/><br/> Это гарантирует, что тома Windows в виртуальной машине Azure используют те же назначения букв дисков, что и на локальной виртуальной машине. | Этот параметр задается автоматически для компьютеров с ОС Windows Server 2008 R2 или более поздней версии.<br/><br/> Настройка вручную для операционных систем предыдущих версий. | В большинстве случаев задается автоматически. | Настройте вручную.
**Установка службы Hyper-V Guest Integration** | [Установите вручную](prepare-windows-server-2003-migration.md#install-on-vmware-vms) на компьютерах с ОС Windows Server 2003. | [Установите вручную](prepare-windows-server-2003-migration.md#install-on-vmware-vms) на компьютерах с ОС Windows Server 2003. | [Установите вручную](prepare-windows-server-2003-migration.md#install-on-hyper-v-vms) на компьютерах с ОС Windows Server 2003.
**Включение Серийной консоли Azure**.<br/><br/>[Включите консоль](../virtual-machines/troubleshooting/serial-console-windows.md) на виртуальных машинах Azure, чтобы устранить неполадки. Перезагружать виртуальную машину не нужно. Виртуальная машина Azure будет загружаться с помощью образа диска. Для новой виртуальной машины загрузка с образа диска эквивалентна перезагрузке. | Включите вручную. | Включите вручную. | Включите вручную.
**Подключение после миграции**<br/><br/> Для подключения после миграции перед ее выполнением необходимо выполнить ряд действий. | [Настройте вручную](#prepare-to-connect-to-azure-windows-vms). | [Настройте вручную](#prepare-to-connect-to-azure-windows-vms). | [Настройте вручную](#prepare-to-connect-to-azure-windows-vms).


#### <a name="configure-san-policy"></a>Настройка политики SAN

По умолчанию виртуальным машинам Azure в качестве временного хранилища назначен диск D.

- В результате для всех остальных назначений подключенного накопителя будет использоваться следующая по порядку буква.
- Например, если в локальной установке используется диск данных, который назначен диску D для установок приложений, назначение этого диска будет изменено на диск E после миграции виртуальной машины в Azure. 
- Чтобы предотвратить такое автоматическое назначение и убедиться, что Azure назначает следующую свободную букву диска временному тому, задайте для политики сети хранения данных (SAN) значение **OnlineAll**:

Настройте этот параметр вручную следующим образом.

1. На локальном компьютере (не на сервере узла) откройте командную строку с повышенными привилегиями.
2. Введите **diskpart**.
3. Введите **SAN**. Если буква диска гостевой ОС не поддерживается, возвращается значение **Offline All** (Перевод всего в состояние "вне сети") или **Offline Shared** (Перевод в состояние "вне сети" общих ресурсов).
4. В командной строке **DISKPART** введите **SAN Policy=OnlineAll**. Этот параметр гарантирует, что диски будут подключены к сети, и вы сможете выполнять чтение и запись на обоих дисках.
5. Во время тестовой миграции вы можете проверить, сохраняются ли буквы дисков.


### <a name="linux-machines"></a>Компьютеры Linux

Служба "Миграция Azure" автоматически выполняет эти действия для данных версий

- Red Hat Enterprise Linux 7.8, 7.7, 7.6, 7.5, 7.4, 7.0, 6.x (также в ходе миграции автоматически устанавливается агент виртуальной машины Linux в Azure)
- Cent OS 7.7, 7.6, 7.5, 7.4, 6.x (также в ходе миграции автоматически устанавливается агент виртуальной машины Linux в Azure)
- SUSE Linux Enterprise Server 12 SP1+;
- SUSE Linux Enterprise Server 15 SP1;
- Ubuntu 19.04, 19.10, 18.04LTS, 16.04LTS, 14.04LTS (также в ходе миграции автоматически устанавливается агент виртуальной машины Linux в Azure)
- Ubuntu 18.04LTS, 16.04LTS
- Debian 9, 8, 7
- Oracle Linux 7.7, Oracle Linux 7.7-CI.

Для других версий подготовьте компьютеры, как указано в таблице.  


**Действие** | **Сведения** | **Версия Linux**
--- | --- | ---
**Установка Hyper-V Linux Integration Services** | Выполните повторную сборку образа инициализации Linux, чтобы он содержал необходимые драйверы Hyper-V. Повторная сборка образа инициализации гарантирует, что виртуальная машина будет загружаться в Azure. | В большинстве новых версий дистрибутивов Linux это включено по умолчанию.<br/><br/> Если драйвер не включен, установите его вручную для всех версий, кроме указанных выше.
**Включение ведения журнала Серийной консоли Azure** | Включение ведения журнала консоли поможет устранить неполадки. Перезагружать виртуальную машину не нужно. Виртуальная машина Azure будет загружаться с помощью образа диска. Для новой виртуальной машины загрузка с образа диска эквивалентна перезагрузке.<br/><br/> Чтобы включить, следуйте [этим инструкциям](../virtual-machines/troubleshooting/serial-console-linux.md).
**Обновление файла сопоставления устройств** | Обновите файл сопоставления устройств с именем устройства для сопоставлений томов, чтобы использовать постоянные идентификаторы устройств. | Установите его вручную для всех версий, кроме указанных выше. Возможно только в сценарии миграции виртуальных машин VMware на основе агента.
**Обновление записи в FSTAB-файле** |  Обновите записи, чтобы использовать постоянные идентификаторы томов.    | Обновите вручную для всех версий, кроме указанных выше.
**Удаление правила udev** | Удалите все правила udev, которые резервируют имена интерфейсов на основе MAC-адресов и т. д. | Удалите вручную для всех версий, кроме указанных выше.
**Обновление сетевых интерфейсов** | Обновите сетевые интерфейсы для получения IP-адреса на основе DHCP.nst. | Обновите вручную для всех версий, кроме указанных выше.
**Включение SSH** | Убедитесь, что SSH включен и служба sshd настроена на автоматический запуск при перезагрузке.<br/><br/> Убедитесь, что входящие запросы на SSH-соединения не заблокированы брандмауэром ОС или правилами сценариев.| Включите вручную для всех версий, кроме указанных выше.

В следующей таблице приведены шаги, выполняемые автоматически для операционных систем, перечисленных выше.


| Действие                                      | Миграция VMware на основе агента | Миграция VMware без агента | Hyper\-V   |
|---------------------------------------------|-------------------------------|----------------------------|------------|
| Установка Hyper\-V Linux Integration Services | да                           | Да                        | Не требуется. |
| Включение ведения журнала последовательной консоли Azure         | да                           | Да                        | Нет         |
| Обновление файла карты устройств                      | Да                           | Нет                         | Нет         |
| Обновление записи в FSTAB-файле                        | да                           | Да                        | Нет         |
| Удаление правила udev                            | да                           | Да                        | Нет         |
| Обновление сетевых интерфейсов                   | да                           | Да                        | Нет         |
| Включение SSH                                  | Нет                            | Нет                         | Нет         |

Ознакомьтесь с дополнительными сведениями об [этапах запуска виртуальной машины Linux в Azure](../virtual-machines/linux/create-upload-generic.md) и инструкциями для некоторых популярных дистрибутивов Linux в этой статье.

Изучите список [обязательных пакетов](https://docs.microsoft.com/azure/virtual-machines/extensions/agent-linux#requirements) для установки агента виртуальной машины Linux. Служба "Миграция Azure" автоматически устанавливает агент виртуальной машины Linux для RHEL6, RHEL7, CentOS7 (6 должна поддерживаться аналогично RHEL), Ubuntu 14.04, Ubuntu 16.04, Ubuntu18.04, если используется метод миграции VMware без агента.

## <a name="check-azure-vm-requirements"></a>Проверка требований для виртуальных машин Azure

Локальные компьютеры, реплицируемые в Azure, должны соответствовать требованиям к операционной системе и архитектуре, дискам, сетевым настройкам и наименованию для виртуальных машин Azure.

Прежде чем выполнять миграцию, ознакомьтесь с требованиями к виртуальным машинам Azure для миграции [VMware](migrate-support-matrix-vmware-migration.md#azure-vm-requirements), [Hyper-V](migrate-support-matrix-hyper-v-migration.md#azure-vm-requirements), а также [физического сервера](migrate-support-matrix-physical-migration.md#azure-vm-requirements).



## <a name="prepare-to-connect-after-migration"></a>Подготовка к подключению после миграции

Виртуальные машины Azure создаются во время миграции в Azure. После миграции вам необходимо подключиться к новым виртуальным машинам Azure. Для успешного подключения требуется выполнить несколько шагов.

### <a name="prepare-to-connect-to-azure-windows-vms"></a>Подготовка к подключению к виртуальным машинам Windows в Azure

На локальных компьютерах с Windows:

1. Настройте параметры Windows. К ним относится удаление любых статических постоянных маршрутов или прокси-сервера WinHTTP.
2. Убедитесь, что [необходимые службы](../virtual-machines/windows/prepare-for-upload-vhd-image.md#check-the-windows-services) запущены.
3. Включите удаленный рабочий стол (RDP), чтобы разрешить установку удаленных подключений к локальному компьютеру. Узнайте, как [использовать PowerShell для включения RDP](../virtual-machines/windows/prepare-for-upload-vhd-image.md#update-remote-desktop-registry-settings).
4. Чтобы получить доступ к виртуальной машине Azure через Интернет после миграции, в брандмауэре Windows на локальном компьютере разрешите протоколы TCP и UDP в общедоступном профиле и установите RDP в качестве разрешенного приложения для всех профилей.
5. Если вы хотите получить доступ к виртуальной машине Azure через VPN типа "сеть — сеть" после миграции, в брандмауэре Windows на локальном компьютере разрешите RDP для частного профиля и профиля домена. Узнайте, как [разрешить RDP-трафик](../virtual-machines/windows/prepare-for-upload-vhd-image.md#configure-windows-firewall-rules). 
6. Прежде чем выполнять миграцию убедитесь, что на локальной виртуальной машине нет ожидающих установки обновлений Windows. В противном случае установка этих обновлений на виртуальной машине Azure может активироваться после миграции, и вы не сможете войти в нее до завершения установки.


### <a name="prepare-to-connect-with-linux-azure-vms"></a>Подготовка к подключению к виртуальным машинам Linux Azure

На локальных компьютерах с Linux:

1. Настройте автоматический запуск службы SSH при загрузке системы (если он еще не настроен).
2. Убедитесь, что правила брандмауэра разрешают SSH-подключение.

### <a name="configure-azure-vms-after-migration"></a>Настройка виртуальных машин Azure после миграции

После миграции выполните следующие действия на созданных виртуальных машинах Azure.

1. Чтобы подключиться к виртуальной машине через Интернет, назначьте ей общедоступный IP-адрес. Для виртуальной машины Azure следует указать общедоступный IP-адрес, отличный от ранее используемых для локального компьютера. [Подробнее](../virtual-network/virtual-network-public-ip-address.md).
2. Убедитесь, что правила группы безопасности сети (NSG) на виртуальной машине разрешают входящие подключения к порту RDP или SSH.
3. Перейдите в раздел [диагностики загрузки](../virtual-machines/troubleshooting/boot-diagnostics.md#enable-boot-diagnostics-on-existing-virtual-machine), чтобы просмотреть сведения о виртуальной машине.


## <a name="next-steps"></a>Дальнейшие действия

Выберите предпочтительный метод [миграции виртуальных машин VMware](server-migrate-overview.md) в Azure или начните миграцию [виртуальных машин Hyper-V](tutorial-migrate-hyper-v.md), [физических серверов либо виртуализованных или облачных виртуальных машин](tutorial-migrate-physical-virtual-machines.md).

## <a name="see-whats-supported"></a>Поддерживаемые функции

Для виртуальных машин VMware средство миграции сервера поддерживает [миграцию без агентов или на основе агентов](server-migrate-overview.md).

- **Виртуальные машины VMware**/ Проверьте [требования к миграции и поддерживаемые функции](migrate-support-matrix-vmware-migration.md) для виртуальных машин VMware.
- **Виртуальные машины Hyper-V**. Проверьте [требования к миграции и поддерживаемые функции](migrate-support-matrix-hyper-v-migration.md) для виртуальных машин Hyper-V.
- **Физические компьютеры**. Проверьте [требования к миграции и поддерживаемые функции](migrate-support-matrix-physical-migration.md) для локальных физических компьютеров или других виртуализированных серверов. 
