---
title: Автоматизация миграции VMware без агента в службе "миграция Azure"
description: Описание использования сценариев для переноса большого количества виртуальных машин VMware в службе "миграция Azure"
author: rahulg1190
ms.author: rahugup
ms.manager: bsiva
ms.topic: how-to
ms.date: 10/30/2020
ms.openlocfilehash: cdae1fe13f8e08cb6b817f8ec6431c77013020d7
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "96754272"
---
# <a name="scale-migration-of-vmware-vms"></a>Масштабирование миграции виртуальных машин VMware 

Эта статья поможет вам понять, как использовать сценарии для переноса большого количества виртуальных машин VMware (ВМ) с помощью метода без агента. Чтобы масштабировать миграцию, используйте модуль PowerShell для службы " [Миграция Azure](./tutorial-migrate-vmware-powershell.md)". 

Скрипты автоматизации миграции VMware для Azure можно скачать в репозитории [примеров Azure PowerShell](https://github.com/Azure/azure-docs-powershell-samples/tree/master/azure-migrate/migrate-at-scale-vmware-agentles) на сайте GitHub. Сценарии можно использовать для переноса виртуальных машин VMware в Azure с помощью метода миграции без агента. Команды PowerShell для службы "миграция Azure", используемые в этих сценариях, описаны [здесь](./tutorial-migrate-vmware-powershell.md).

## <a name="current-limitations"></a>Текущие ограничения
- Эти сценарии поддерживают перенос виртуальных машин VMware со всеми дисками. Вы можете обновить скрипты, если хотите выборочно реплицировать диски, подключенные к виртуальной машине VMware. 
- Скрипты поддерживают использование рекомендаций по оценке. Если рекомендации по оценке не используются, то все диски, подключенные к виртуальной машине VMware, переносятся на один и тот же тип управляемого диска ("Стандартный" или "Премиум"). Вы можете обновить скрипты, если вы хотите использовать несколько типов управляемых дисков с одной и той же виртуальной машиной.

## <a name="prerequisites"></a>Предварительные условия

- [Выполнить задачи из учебника по обнаружению](tutorial-discover-vmware.md), чтобы подготовить Azure и VMware к миграции.
- Мы рекомендуем изучить и второй учебник, чтобы [оценить виртуальные машины VMware](./tutorial-assess-vmware-azure-vm.md) перед переносом в Azure.
- Установить модуль `Az` Azure PowerShell. Если вам необходимо установить или обновить Azure PowerShell, ознакомьтесь с этим [руководством по установке и настройке Azure PowerShell](/powershell/azure/install-az-ps).

## <a name="install-azure-migrate-powershell-module"></a>Установка модуля PowerShell для Миграции Azure

Модуль PowerShell для Миграции Azure доступен в режиме предварительной версии. Необходимо установить модуль PowerShell с помощью следующей команды. 

```azurepowershell
Install-Module -Name Az.Migrate 
```

## <a name="csv-input-file"></a>Входной CSV-файл
После выполнения всех необходимых условий необходимо создать CSV-файл с данными для каждой исходной виртуальной машины, которую требуется перенести. Все сценарии предназначены для работы с одним и тем же CSV-файлом. Пример шаблона CSV-файла доступен в папке сценариев для справки. CSV-файл можно настроить таким образом, чтобы вы могли использовать рекомендации по оценке и даже указывать, не должны ли запускаться определенные операции для конкретной виртуальной машины. 

> [!NOTE]
> Один и тот же CSV-файл можно использовать для переноса виртуальных машин в нескольких проектах службы "миграция Azure".

### <a name="csv-file-schema"></a>Схема CSV-файла

**Заголовок столбца** | **Описание**
--- | ---
AZMIGRATEPROJECT_SUBSCRIPTION_ID | Укажите идентификатор подписки проекта "миграция Azure".
AZMIGRATEPROJECT_RESOURCE_GROUP_NAME | Укажите имя группы ресурсов для переноса Azure.
AZMIGRATEPROJECT_NAME | Укажите имя проекта службы "миграция Azure", в котором требуется перенести серверы. 
SOURCE_MACHINE_NAME | Укажите понятное имя (отображаемое имя) для обнаруженной виртуальной машины в проекте службы "миграция Azure".
AZMIGRATEASSESSMENT_NAME | Укажите имя оценки, которую необходимо использовать для миграции.
AZMIGRATEGROUP_NAME | Укажите имя группы, которая использовалась для оценки службы "миграция Azure".
TARGET_RESOURCE_GROUP_NAME | Укажите имя группы ресурсов Azure, в которую необходимо перенести виртуальную машину.
TARGET_VNET_NAME| Укажите имя виртуальной сети Azure, которую должна использовать перенесенная виртуальная машина.
TARGET_SUBNET_NAME | Укажите имя подсети в целевой виртуальной сети, которую должна использовать перенесенная виртуальная машина. Если оставить это поле пустым, будет использоваться подсеть по умолчанию.
TARGET_MACHINE_NAME | Укажите имя, которое должна использовать перенесенная виртуальная машина в Azure. Если оставить это поле пустым, будет использоваться имя исходного компьютера.  
TARGET_MACHINE_SIZE | Укажите номер SKU, который виртуальная машина должна использовать в Azure. Чтобы перенести виртуальную машину в D2_v2 виртуальную машину в Azure, укажите в этом поле значение "Standard_D2_v2". При использовании оценки это значение будет получено на основе рекомендации по оценке.
LICENSE_TYPE | Укажите, следует ли использовать Преимущество гибридного использования Azure для виртуальных машин Windows Server. Используйте значение "WindowsServer", чтобы воспользоваться преимуществами Преимущество гибридного использования Azure. В противном случае оставьте пустым или используйте "Нолиценсетипе".
OS_DISK_ID | Укажите идентификатор диска операционной системы для переносимой виртуальной машины. Используемый идентификатор диска — это свойство уникального идентификатора (UUID) для диска, полученного с помощью командлета Get-AzMigrateServer. Сценарий будет использовать первый диск виртуальной машины в качестве диска ОС в случае, если значение не указано.
TARGET_DISKTYPE | Укажите тип диска, который будет использоваться для всех дисков виртуальной машины в Azure. Используйте "Premium_LRS" для дисков с управляемыми уровнями "Премиум", "StandardSSD_LRS" для стандартных дисков SSD и "Standard_LRS" для использования дисков стандартного жесткого диска. Если вы решили использовать оценку, скрипт будет определять приоритеты с помощью рекомендуемых типов дисков для каждого диска виртуальной машины. Если вы не используете оценку или не укажете какое бы то ни значение, по умолчанию сценарий будет использовать диски стандартного жесткого диска.    
AVAILABILITYZONE_NUMBER | Укажите номер зоны доступности, который будет использоваться для перенесенной виртуальной машины. Вы можете оставить это поле пустым, если вы не хотите использовать зоны доступности. 
AVAILABILITYSET_NAME | Укажите имя группы доступности, которая будет использоваться для перенесенной виртуальной машины. Вы можете оставить это поле пустым, если вы не хотите использовать группу доступности.
TURNOFF_SOURCESERVER | Укажите "Y", если вы хотите отключить исходную виртуальную машину во время миграции. В противном случае используйте "N". Если оставить это поле пустым, то скрипт предполагает, что значение равно «N».
TESTMIGRATE_VNET_NAME | Укажите имя виртуальной сети, которая будет использоваться для тестовой миграции.
UPDATED_TARGET_RESOURCE_GROUP_NAME | Если вы хотите обновить группу ресурсов для использования перенесенной виртуальной машиной в Azure, укажите имя группы ресурсов Azure, в противном случае оставьте поле пустым. 
UPDATED_TARGET_VNET_NAME | Если вы хотите обновить виртуальную сеть, которая будет использоваться перенесенной виртуальной машиной в Azure, укажите имя виртуальной сети Azure, в противном случае оставьте поле пустым.
UPDATED_TARGET_MACHINE_NAME | Если вы хотите обновить имя, которое будет использоваться перенесенной виртуальной машиной в Azure, укажите новое имя, которое будет использоваться, в противном случае оставьте пустым.
UPDATED_TARGET_MACHINE_SIZE | Если вы хотите обновить номер SKU, который будет использоваться перенесенной виртуальной машиной в Azure, укажите новый номер SKU, который будет использоваться, в противном случае оставьте пустым.
UPDATED_AVAILABILITYZONE_NUMBER | Если вы хотите обновить зону доступности, которая будет использоваться перенесенной виртуальной машиной в Azure, укажите новую зону доступности, которая будет использоваться, в противном случае оставьте поле пустым.
UPDATED_AVAILABILITYSET_NAME | Если вы хотите обновить группу доступности, которая будет использоваться перенесенной виртуальной машиной в Azure, укажите новую группу доступности, которая будет использоваться, в противном случае оставьте поле пустым.
UPDATE_NIC1_ID | Укажите идентификатор сетевого адаптера для обновления. Если оставить это поле пустым, сценарий предполагает, что значение является первой сетевой картой обнаруженной виртуальной машины. Если вы не хотите обновлять сетевую карту виртуальной машины, оставьте все поля с именем сетевой карты пустыми. 
UPDATED_TARGET_NIC1_SELECTIONTYPE | Укажите значение, которое будет использоваться для этой сетевой карты. Используйте "основной", "вторичный" или "Доноткреате", чтобы указать, должна ли эта сетевая карта быть основной, вторичной или не должна быть создана на перенесенной виртуальной машине. Для виртуальной машины можно задать только одну основную сетевую карту. Оставьте пустым, если вы не хотите обновлять.
UPDATED_TARGET_NIC1_SUBNET_NAME | Укажите имя подсети, используемой для сетевой карты на перенесенной виртуальной машине. Оставьте пустым, если вы не хотите обновлять.
UPDATED_TARGET_NIC1_IP | Укажите IPv4-адрес, который будет использоваться сетевым адаптером на перенесенной виртуальной машине, если вы хотите использовать статический IP. Если вы хотите автоматически назначить IP-адрес, используйте "Авто". Оставьте пустым, если вы не хотите обновлять.
UPDATE_NIC2_ID | Укажите идентификатор сетевого адаптера для обновления. Если оставить это поле пустым, сценарий предполагает, что значение является вторым сетевым адаптером обнаруженной виртуальной машины. Если вы не хотите обновлять сетевую карту виртуальной машины, оставьте все поля с именем сетевой карты пустыми.
UPDATED_TARGET_NIC2_SELECTIONTYPE | Укажите значение, которое будет использоваться для этой сетевой карты. Используйте "основной", "вторичный" или "Доноткреате", чтобы указать, должна ли эта сетевая карта быть основной, вторичной или не должна быть создана на перенесенной виртуальной машине. Для виртуальной машины можно задать только одну основную сетевую карту. Оставьте пустым, если вы не хотите обновлять.
UPDATED_TARGET_NIC2_SUBNET_NAME | Укажите имя подсети, используемой для сетевой карты на перенесенной виртуальной машине. Оставьте пустым, если вы не хотите обновлять.
UPDATED_TARGET_NIC2_IP | Укажите IPv4-адрес, который будет использоваться сетевым адаптером на перенесенной виртуальной машине, если вы хотите использовать статический IP. Если вы хотите автоматически назначить IP-адрес, используйте "Авто". Оставьте пустым, если вы не хотите обновлять.
OK_TO_UPDATE | Используйте "Y", чтобы указать, нужно ли обновлять свойства виртуальной машины при запуске скрипта AzMigrate_UpdateMachineProperties. Используйте "N" или оставьте пустым в противном случае.
OK_TO_MIGRATE | Используйте "Y", чтобы указать, следует ли перенести виртуальную машину при запуске скрипта AzMigrate_StartMigration. Используйте "N" или оставьте пустым, если вы не хотите переносить виртуальную машину. 
OK_TO_USE_ASSESSMENT | Используйте "Y", чтобы указать, должна ли виртуальная машина запускать репликацию с использованием рекомендаций по оценке при запуске скрипта AzMigrate_StartReplication. Это переопределит значения TARGET_MACHINE_SIZE и TARGET_DISKTYPE в CSV-файле. Используйте "N" или оставьте пустым, если вы не хотите использовать рекомендации по оценке.
OK_TO_TESTMIGRATE | Используйте "Y", чтобы указать, следует ли выполнять тестовую миграцию виртуальной машины при запуске скрипта AzMigrate_StartTestMigration. Используйте "N" или оставьте пустым, если вы не хотите тестировать миграцию виртуальной машины. 
OK_TO_RETRIEVE_REPLICATIONSTATUS | Используйте "Y", чтобы указать, следует ли обновлять состояние репликации виртуальной машины при запуске скрипта AzMigrate_ReplicationStatus. Используйте "N" или оставьте пустым, если не хотите обновлять состояние репликации.
OK_TO_CLEANUP | Используйте "Y", чтобы указать, следует ли очищать репликацию виртуальной машины при запуске скрипта AzMigrate_StopReplication. Используйте "N" или оставьте пустым в противном случае.
OK_TO_TESTMIGRATE_CLEANUP | Используйте "Y", чтобы указать, следует ли очищать тестовую миграцию для виртуальной машины при запуске скрипта AzMigrate_CleanUpTestMigration. Используйте "N" или оставьте пустым в противном случае.


## <a name="script-execution"></a>Выполнение сценария

После подготовки CSV-файла можно выполнить следующие действия, чтобы перенести локальные виртуальные машины VMware.

**Номер шага** | **Имя сценария** | **Описание**
--- | --- | ---
1 | AzMigrate_StartReplication.ps1 | Включите репликацию для всех виртуальных машин, перечисленных в CSV-файле, скрипт создает выходные данные в формате CSV и файл журнала для устранения неполадок.
2 | AzMigrate_ReplicationStatus.ps1 | Проверьте состояние репликации. сценарий создает выходные данные в формате CSV с состоянием каждой виртуальной машины и файлом журнала для устранения неполадок.
3 | AzMigrate_UpdateMachineProperties.ps1 | После завершения начальной репликации на виртуальных машинах используйте этот скрипт, чтобы обновить целевые свойства виртуальной машины (Свойства вычислений и сети). Скрипт создает выходные данные CSV-файла со сведениями о задании для каждой виртуальной машины.
4 | AzMigrate_StartTestMigration.ps1 |  Запустите тестовую отработку отказа для всех виртуальных машин, перечисленных в CSV-файле, которые настроены для тестовой миграции. Скрипт создает выходные данные CSV-файла со сведениями о задании для каждой виртуальной машины.
5 | AzMigrate_CleanUpTestMigration.ps1 | После того как вы вручную проверите виртуальные машины, для которых произошел сбой теста, используйте этот скрипт для очистки виртуальных машин тестовой отработки отказа для всех виртуальных машин, перечисленных в CSV-файле, настроенных для очистки тестовой миграции. Скрипт создает выходные данные CSV-файла со сведениями о задании для каждой виртуальной машины.
6 | AzMigrate_StartMigration.ps1 | Запустите миграцию для всех виртуальных машин, перечисленных в CSV-файле, которые настроены для миграции. Скрипт создает выходные данные CSV-файла со сведениями о задании для каждой виртуальной машины.
7 | AzMigrate_StopReplication.ps1 | Останавливает репликацию для виртуальной машины после ее успешного переноса или отмены репликации по другим причинам. Скрипт создает выходные данные CSV-файла со сведениями о задании для каждой виртуальной машины.


Следующие скрипты вызываются другими скриптами для всех операций службы "миграция Azure", таких как включение репликации, запуск тестовой миграции, обновление свойств виртуальной машины и т. д. Убедитесь, что все сценарии находятся в одной папке или пути. 

**Номер шага** | **Имя сценария** | **Описание**
--- | --- | ---
1 | AzMigrate_Shared.ps1 | Общий скрипт, содержащий функции для получения свойств оценки (через API), обнаруженных виртуальных машин и репликации виртуальных машин. 
2 | AzMigrate_CSV_Processor.ps1 | Общий скрипт, содержащий функции, используемые для операций с файлами CSV, включая загрузку, чтение и печать для журналов. 
3 | AzMigrate_Logger.ps1 | Общий скрипт, вызванный для создания файла журнала для операций службы автоматизации миграции Azure. Файл журнала будет иметь формат log.Scriptname.Datetime.txt.

Кроме того, в папке также содержится AzMigrate_Template.ps1, содержащая каркасную платформу для создания пользовательских скриптов для различных операций миграции Azure. 

### <a name="script-execution-syntax"></a>Синтаксис выполнения сценария

После скачивания скриптов их можно выполнить следующим образом.

Если вы хотите выполнить сценарий для запуска репликации виртуальных машин с помощью файла Input.csv, используйте следующий синтаксис. 

```azurepowershell
".\AzMigrate_StartReplication.ps1" .\Input.csv 
```

Чтобы узнать больше об использовании Azure PowerShell для переноса виртуальных машин VMware с помощью службы "миграция Azure", следуйте указаниям в этом [руководстве](./tutorial-migrate-vmware-powershell.md).