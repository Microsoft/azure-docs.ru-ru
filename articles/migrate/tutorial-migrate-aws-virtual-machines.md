---
title: Обнаружение, оценка и перенос виртуальных машин EC2 Amazon Web Services (AWS) в Azure
description: В этой статье описывается, как перенести виртуальные машины AWS в Azure с помощью службы "Миграция Azure".
author: deseelam
ms.author: deseelam
ms.manager: bsiva
ms.topic: tutorial
ms.date: 08/19/2020
ms.custom: MVC
ms.openlocfilehash: 430ece58bd3dc1651ac391ba0e29515085ee507b
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "98878194"
---
# <a name="discover-assess-and-migrate-amazon-web-services-aws-vms-to-azure"></a>Обнаружение, оценка и перенос виртуальных машин Amazon Web Services (AWS) в Azure

Из этого учебника вы узнаете, как обнаруживать, оценивать и переносить виртуальные машины Amazon Web Services (AWS) в виртуальные машины Azure, используя средства "Миграция Azure: оценка сервера" и "Миграция Azure: миграция сервера".

> [!NOTE]
> Перенос виртуальных машин AWS в Azure выполняется так же, как и перенос физических серверов.

В этом учебнике рассматривается следующее.
> [!div class="checklist"]
>
> * Проверка предварительных требований для миграции.
> * Подготовка ресурсов Azure с помощью средства миграции сервера Миграции Azure. Настройка разрешений для своей учетной записи Azure и ресурсов для работы с Миграцией Azure.
> * Подготовка экземпляров EC2 AWS к переносу.
> * Добавление средства миграции сервера в центр службы "Миграция Azure".
> * Настройка устройства репликации и развертывание сервера конфигурации.
> * Установка службы "Мобильность" на виртуальных машинах AWS, которые нужно перенести.
> * Включите репликацию для виртуальных машин.
> * Отслеживание и мониторинг состояния репликации. 
> * Выполнение тестовой миграции, позволяющей убедиться в правильной работе всех компонентов.
> * Выполнение полной миграции в Azure.

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись](https://azure.microsoft.com/pricing/free-trial/), прежде чем начинать работу.

## <a name="discover-and-assess"></a>Обнаружение и оценка

Перед миграцией в Azure рекомендуется выполнить обнаружение виртуальных машин и оценку миграции. Эта оценка помогает выбрать соответствующий размер виртуальных машин AWS для миграции в Azure и рассчитать потенциальные расходы на выполнение в Azure.

Настройте оценку следующим образом:

1. Выполните инструкции из этого [учебника](./tutorial-discover-physical.md), чтобы настроить Azure и подготовить виртуальные машины AWS к оценке. Обратите внимание на следующее.

    - Миграция Azure использует аутентификацию с паролем при обнаружении экземпляров AWS. По умолчанию экземпляры AWS не поддерживают аутентификацию с паролем. Прежде чем выполнять обнаружение экземпляра, включите аутентификацию с паролем.
        - На компьютерах Windows разрешите порт WinRM 5985 (HTTPS). Это позволит выполнять удаленные вызовы инструментария WMI.
        - Для компьютеров Linux:
            1. Войдите на каждый компьютер Linux.
            2. Откройте файл sshd_config в каталоге vi /etc/ssh/sshd_config
            3. В файле найдите строку **PasswordAuthentication** и измените значение на **yes**.
            4. Сохраните файл и закройте его. Перезапустите службу ssh.
    - Если для обнаружения виртуальных машин Linux вы используете права привилегированного пользователя, убедитесь, что на виртуальных машинах разрешается вход с такими правами.
        1. Войдите на каждый компьютер Linux.
        2. Откройте файл sshd_config в каталоге vi /etc/ssh/sshd_config
        3. В файле найдите строку **PermitRootLogin** и измените значение на **yes**.
        4. Сохраните файл и закройте его. Перезапустите службу ssh.

2. Затем следуйте инструкциям в этом [учебнике](./tutorial-assess-physical.md), чтобы настроить проект и устройство Миграции Azure для обнаружения и оценки виртуальных машин AWS.

Хотя мы рекомендуем опробовать оценку, ее выполнение не является обязательным шагом для миграции виртуальных машин.



## <a name="prerequisites"></a>Предварительные требования 

- Убедитесь, что виртуальные машины AWS, которые нужно перенести, работают под управлением поддерживаемой версии ОС. Для выполнения миграции виртуальные машины AWS обрабатываются как физические компьютеры. Просмотрите [поддерживаемые операционные системы и версии ядра](../site-recovery/vmware-physical-azure-support-matrix.md#replicated-machines) для рабочего процесса миграции физического сервера. Для проверки версий ОС и ядра для виртуальных машин Linux можно использовать стандартные команды, такие как *hostnamectl* или *uname -a*.  Прежде чем приступить к реальной миграции, мы рекомендуем выполнить тестовую миграцию (тестовую отработку отказа), чтобы проверить, работает ли виртуальная машина должным образом.
- Убедитесь, что виртуальные машины AWS соответствуют [поддерживаемым конфигурациям](./migrate-support-matrix-physical-migration.md#physical-server-requirements) для переноса в Azure.
- Убедитесь, что виртуальные машины AWS, которые реплицируются в Azure, соответствуют [требованиям к виртуальным машинам Azure](./migrate-support-matrix-physical-migration.md#azure-vm-requirements).
- Прежде чем переносить виртуальные машины в Azure, необходимо внести в них некоторые изменения.
    - В некоторых операционных системах Миграция Azure вносит эти изменения автоматически.
    - Важно внести эти изменения до начала миграции. Если вы перенесете виртуальную машину до внесения изменений, она может не загрузиться в Azure.
Просмотрите сведения об изменениях для [Windows](prepare-for-migration.md#windows-machines) и [Linux](prepare-for-migration.md#linux-machines), которые необходимо внести.

### <a name="prepare-azure-resources-for-migration"></a>Подготовка ресурсов Azure для миграции

Подготовка Azure к миграции с помощью средства миграции сервера Миграции Azure.

**Задача** | **Сведения**
--- | ---
**Создание проекта службы "Миграция Azure"** | [Для создания проекта](./create-manage-projects.md) учетная запись Azure должна иметь разрешения участника или владельца.
**Проверка разрешений учетной записи Azure** | Учетная запись Azure должна иметь разрешения на создание виртуальной машины и на запись на управляемый диск Azure.

### <a name="assign-permissions-to-create-project"></a>Назначение разрешений для создания проекта

1. На портале Azure откройте подписку, а затем выберите **Управление доступом (IAM)** .
2. В разделе **Проверить доступ** найдите соответствующую учетную запись и щелкните ее, чтобы просмотреть разрешения.
3. Вы должны обладать разрешениями уровня **Участник** или **Владелец**.
    - Если вы создали бесплатную учетную запись Azure, вы являетесь владельцем подписки.
    - Если вы не являетесь владельцем подписки, назначьте эту роль совместно с владельцем.

### <a name="assign-azure-account-permissions"></a>Назначение разрешений учетной записи Azure

Назначьте учетной записи Azure роль участника виртуальных машин. Это предоставит следующие разрешения:

- разрешение на создание виртуальной машины в выбранной группе ресурсов;
- разрешение на создание виртуальной машины в выбранной виртуальной сети;
- разрешение на запись на управляемый диск Azure. 

### <a name="create-an-azure-network"></a>Создание сети Azure

[Настройте](../virtual-network/manage-virtual-network.md#create-a-virtual-network) виртуальную сеть Azure. При репликации в Azure создаются виртуальные машины Azure, которые присоединяются к виртуальной сети Azure, указанной при настройке миграции.

## <a name="prepare-aws-instances-for-migration"></a>Подготовка экземпляров AWS к переносу

Чтобы подготовиться к переносу AWS в Azure, необходимо подготовить и развернуть устройство репликации для миграции.

### <a name="prepare-a-machine-for-the-replication-appliance"></a>Подготовка компьютера для устройства репликации

Миграция Azure средство миграции сервера использует устройство репликации для репликации компьютеров в Azure. Устройство репликации запускает следующие компоненты.

- **Сервер конфигурации**: Сервер конфигурации используется для управления обменом данными между средой AWS и Azure, а также репликацией данных.
- **Сервер обработки** Сервер обработки выступает в качестве шлюза репликации. Он получает данные репликации, оптимизирует их путем кэширования, сжатия и шифрования и отправляет их в учетную запись хранения кэша Azure.

Выполните подготовку к развертыванию устройства следующим образом:

- Настройте отдельную виртуальную машину EC2 для размещения устройства репликации. Этот экземпляр должен работать в Windows Server 2012 R2 или Windows Server 2016. [Ознакомьтесь](./migrate-replication-appliance.md#appliance-requirements) с требованиями к оборудованию, программному обеспечению и сети для устройства.
- Модуль не следует устанавливать на исходной виртуальной машине, которую необходимо реплицировать, или в модуле обнаружения и оценки службы "Миграция Azure", которые вы могли установить ранее. Оно должно быть развернуто на другой виртуальной машине.
- Исходные виртуальные машины AWS, которые необходимо перенести, должны иметь сеть, по которой они смогут напрямую подключаться к устройству репликации. Настройте необходимые правила группы безопасности, чтобы включить эту сеть. Рекомендуется развернуть устройство репликации в той же сети VPC, что и исходные виртуальные машины, которые необходимо перенести. Если устройство репликации должно находиться в другой VPC, сети VPC должны быть подключены через пиринг VPC.
- Исходные виртуальные машины AWS обмениваются данными с устройством репликации через порты HTTPS 443 (оркестрация канала управления) и TCP 9443 (передача данных), которые являются входящими для управления репликацией и передачи данных репликации. Устройство репликации, в свою очередь, выполняет оркестрацию данных репликации и отправляет их в Azure через порт HTTPS 443 для исходящих подключений. Чтобы настроить эти правила, измените правила для входящего и исходящего трафика группы безопасности с соответствующими портами и сведениями об IP-адресе источника.

   ![Группы безопасности AWS ](./media/tutorial-migrate-aws-virtual-machines/aws-security-groups.png)
     
 
   ![Изменение параметров безопасности ](./media/tutorial-migrate-aws-virtual-machines/edit-security-settings.png)

- Модуль репликации использует MySQL. Проверьте [параметры](migrate-replication-appliance.md#mysql-installation) для установки MySQL в модуле.
- Проверьте URL-адреса Azure, к которым модуль репликации будет обращаться в [общедоступных](migrate-replication-appliance.md#url-access) облаках и облаках [для государственных организаций](migrate-replication-appliance.md#azure-government-url-access).

## <a name="set-up-the-replication-appliance"></a>Настройка устройства репликации

Первым шагом миграции является настройка устройства репликации. Чтобы настроить устройство для миграции виртуальных машин AWS, необходимо скачать файл установщика для устройства, а затем запустить его на [подготовленной вами виртуальной машине](#prepare-a-machine-for-the-replication-appliance).

### <a name="download-the-replication-appliance-installer"></a>Скачивание установщика устройства репликации

1. В проекте "Миграция Azure" > **Серверы**, в разделе **Azure Migrate: Server Migration** (Миграция Azure: Миграция сервера), выберите **Обнаружить**.

    ![Обнаружение виртуальных машин](./media/tutorial-migrate-physical-virtual-machines/migrate-discover.png)

2. В разделе **Обнаружение компьютеров** > **Ваши компьютеры виртуализированы?** выберите **Not virtualized/Other** (Не виртуализированы/Другое).
3. В поле **Целевой регион** выберите регион Azure, в который необходимо перенести компьютеры.
4. Выберите параметр **Confirm that the target region for migration is <region-name>** (Подтвердите, что целевым регионом для миграции является "имя-региона").
5. Щелкните **Создать ресурсы**. После этого в фоновом режиме создается хранилище Azure Site Recovery.
    - Если вы уже настроили миграцию с помощью средства "Миграция сервера" службы "Миграция Azure", целевой параметр нельзя настроить, так как ресурсы были настроены ранее.
    - После нажатия этой кнопки вы не сможете изменить целевой регион для этого проекта.
    - Чтобы перенести виртуальные машины в другой регион, нужно создать новый или другой проект Миграции Azure.

6. В разделе **Do you want to install a new replication appliance?** (Вы хотите установить новое устройство репликации?) щелкните **Установить устройство репликации**.
7. В разделе **Download and install the replication appliance software** (Скачайте и установите ПО устройства репликации) скачайте установщик устройства и регистрационный ключ. Для регистрации устройства необходим ключ. Ключ действителен в течение пяти дней после скачивания.

    ![Скачивание поставщика](media/tutorial-migrate-physical-virtual-machines/download-provider.png)

8. Скопируйте файл установки устройства и файл ключа на виртуальную машину AWS под управлением Windows Server 2016 или Windows Server 2012, которую вы создали для устройства репликации.
9. Запустите файл установки устройства репликации, как описано в следующей процедуре.  
    9.1. На вкладке **Перед началом работы** выберите **Установить сервер конфигурации и сервер обработки** и щелкните **Далее**.   
    9.2 В разделе **Third-Party Software License** (Лицензия на программное обеспечение стороннего поставщика) выберите **Я принимаю лицензионное соглашение стороннего производителя**, а затем щелкните **Далее**.   
    9.3 В разделе **Регистрация** выберите **Обзор** и перейдите к расположению, в котором находится файл ключа регистрации хранилища. Выберите **Далее**.  
    9.4 В разделе **Параметры браузера** выберите **Connect to Azure Site Recovery without a proxy server** (Подключаться к Azure Site Recovery без прокси-сервера), а затем щелкните **Далее**.  
    9.5 На странице **Проверка предварительных требований** будет выполнена проверка нескольких элементов. По завершении проверки нажмите кнопку **Далее**.  
    9.6 В разделе **MySQL Configuration** (Конфигурация MySQL) предоставьте пароль для базы данных MySQL и щелкните **Далее**.  
    9.7 На странице **Сведения о среде** выберите **Нет**. Защита для виртуальных машин не требуется. Затем нажмите кнопку **Далее**.  
    9.8 В разделе **Расположение установки** щелкните **Далее**, чтобы принять значения по умолчанию.  
    9.9 В разделе **Выбор сети** щелкните **Далее**, чтобы принять значения по умолчанию.  
    9.10 На странице **Сводка** щелкните **Установить**.   
    9.11 На странице **Ход выполнения установки** отображается информация о процессе установки. Когда этот процесс завершится, выберите **Далее**. Появится окно с предупреждением о перезагрузке. Щелкните **ОК**.   
    9.12 Следующее окно выводит сообщение о парольной фразе для подключения к серверу конфигурации. Скопируйте парольную фразу в буфер обмена и сохраните ее во временном текстовом файле на исходных виртуальных машинах. Эта фраза понадобится вам позже, во время процесса установки службы "Мобильность".
10. После установки будет автоматически запущен мастер настройки устройства (мастер можно также запустить вручную с помощью ярлыка cspsconfigtool, который создается на рабочем столе устройства). Используйте вкладку "Управление учетными записями" мастера, чтобы добавить сведения об учетной записи для принудительной установки службы "Мобильность". В рамках этого учебника мы будем устанавливать службу "Мобильность" вручную на исходных виртуальных машинах, которые нужно реплицировать. Поэтому создайте на этом этапе фиктивную учетную запись и продолжайте работу. Вы можете указать следующие сведения для создания фиктивной учетной записи: guest в качестве имени, username в качестве имени пользователя и password в качестве пароля учетной записи. Такая фиктивная учетная запись потребуется вам на шаге "Включение репликации". 
11. После настройки и перезапуска устройства на вкладке **Обнаружение компьютеров** выберите новое устройство в разделе **Выберите сервер конфигурации** и нажмите кнопку **Finalize registration** (Завершить регистрацию). Завершение регистрации выполняет пару заключительных задач по подготовке устройства репликации.

    ![Завершение регистрации](./media/tutorial-migrate-physical-virtual-machines/finalize-registration.png)

## <a name="install-the-mobility-service"></a>Установка службы Mobility

Агент службы "Мобильность" должен быть установлен на исходных виртуальных машинах AWS, подлежащих миграции. Установщики агента доступны на устройстве репликации. Найдите правильный установщик и установите агент на каждой машине, которую хотите перенести. Сделайте следующее:

1. Войдите на устройство репликации.
2. Перейдите по ссылке **%ProgramData%\ASR\home\svsystems\pushinstallsvc\repository**.
3. Найдите версию установщика, которая соответствует ОС исходной виртуальной машины AWS. Проверьте [поддерживаемые операционные системы](../site-recovery/vmware-physical-azure-support-matrix.md#replicated-machines).
4. Скопируйте файл установщика на исходную виртуальную машину AWS, которую вы хотите перенести.
5. Убедитесь, что вы сохранили текстовый файл с парольной фразой, который был создан при установке устройства репликации.
    - Если вы забыли его сохранить, вы можете просмотреть парольную фразу на устройстве репликации с помощью этого шага. В командной строке выполните **C:\ProgramData\ASR\home\svsystems\bin\genpassphrase.exe -v**, чтобы просмотреть текущую парольную фразу.
    - Теперь скопируйте эту парольную фразу в буфер обмена и сохраните ее во временном текстовом файле на исходных виртуальных машинах.

### <a name="installation-guide-for-windows-aws-vms"></a>Руководство по установке виртуальных машин Windows AWS

1. Извлеките содержимое файла установщика в локальную папку (например, C:\Temp) на виртуальной машине AWS следующим образом:

    ```
    ren Microsoft-ASR_UA*Windows*release.exe MobilityServiceInstaller.exe
    MobilityServiceInstaller.exe /q /x:C:\Temp\Extracted
    cd C:\Temp\Extracted
    ```  

2. Запустите установщик Службы мобильности:
    ```
   UnifiedAgent.exe /Role "MS" /Silent
    ```  

3. Зарегистрируйте агент на устройстве репликации:
    ```
    cd C:\Program Files (x86)\Microsoft Azure Site Recovery\agent
    UnifiedAgentConfigurator.exe  /CSEndPoint <replication appliance IP address> /PassphraseFilePath <Passphrase File Path>
    ```

### <a name="installation-guide-for-linux-aws-vms"></a>Руководство по установке виртуальных машин Linux AWS

1. Извлеките содержимое файла tarball установщика в локальную папку (например, /tmp/MobSvcInstaller) на виртуальной машине AWS следующим образом:
    ```
    mkdir /tmp/MobSvcInstaller
    tar -C /tmp/MobSvcInstaller -xvf <Installer tarball>
    cd /tmp/MobSvcInstaller
    ```  

2. Запустите скрипт установщика.
    ```
    sudo ./install -r MS -q
    ```  

3. Зарегистрируйте агент на устройстве репликации:
    ```
    /usr/local/ASR/Vx/bin/UnifiedAgentConfigurator.sh -i <replication appliance IP address> -P <Passphrase File Path>
    ```

## <a name="enable-replication-for-aws-vms"></a>Включение репликации для виртуальных машин AWS

> [!NOTE]
> На портале можно добавить до 10 виртуальных машин для выполнения репликации одновременно. Чтобы реплицировать больше виртуальных машин одновременно, вы можете добавить их пакетами по 10 штук.

1. В проекте службы "Миграция Azure" щелкните **Серверы** и в разделе **Azure Migrate: Server Migration** (Миграция Azure: миграция сервера) выберите **Репликация**.

    ![Репликация виртуальных машин](./media/tutorial-migrate-physical-virtual-machines/select-replicate.png)

2. В разделе **Репликация** выберите **Параметры исходного кода** > **Ваши компьютеры виртуализированы?**  > **Not virtualized/Other** (Без виртуализации или иное).
3. В разделе **Локальное устройство** выберите имя устройства Миграции Azure, которое вы настроили.
4. В разделе **Сервер обработки** выберите имя устройства репликации. 
5. В разделе **Учетные данные гостя** выберите созданную на этапе [настройки установщика репликации](#download-the-replication-appliance-installer) фиктивную учетную запись, чтобы вручную установить службу "Мобильность" (автоматическая установка не поддерживается). Выберите **Next: Виртуальные машины**.   
 
    ![Репликация параметров](./media/tutorial-migrate-physical-virtual-machines/source-settings.png)
6. В разделе **Виртуальные машины** на вкладке **Импортировать параметры миграции из оценки?** оставьте параметр по умолчанию **No, I'll specify the migration settings manually** (Нет, я укажу параметры миграции вручную).
7. Проверьте каждую виртуальную машину, которую требуется перенести. Выберите **Next: Целевые параметры**.

    ![Выбор виртуальных машин](./media/tutorial-migrate-physical-virtual-machines/select-vms.png)

8. В разделе **Целевые параметры** выберите подписку и целевой регион, в который вы хотите выполнить миграцию, а также укажите группу ресурсов, в которой будут находиться виртуальные машины Azure после миграции.
9. В разделе **Виртуальная сеть** выберите виртуальную сеть или подсеть Azure, к которой будут подключены виртуальные машины Azure после миграции.
10. В области **Параметры доступности** выберите следующие параметры.
    -  "Зона доступности", чтобы закрепить перенесенный компьютер в определенной зоне доступности в регионе. Используйте этот параметр для распределения серверов, образующих уровень приложения с несколькими узлами, по зонам доступности. Если вы выберете этот параметр, нужно будет указать зону доступности, чтобы использовать ее для каждого из выбранных компьютеров на вкладке "Вычисление". Этот параметр доступен только в том случае, если в целевом регионе, выбранном для миграции, поддерживаются зоны доступности.
    -  "Группа доступности", чтобы поместить перенесенную виртуальную машину в группу доступности. Чтобы использовать этот параметр, выбранная целевая группа ресурсов должна содержать одну или несколько групп доступности.
    - Параметр "Избыточность инфраструктуры не требуется", если вам не нужна ни одна из этих конфигураций доступности для перенесенных виртуальных машин.
    
11. В разделе **Disk encryption type** (Тип шифрования диска) выберите один из следующих вариантов:
    - шифрование неактивных данных с помощью ключа, управляемого платформой;
    - шифрование неактивных данных с помощью ключа, управляемого клиентом.
    - Double encryption with platform-managed and customer-managed keys (Двойное шифрование с помощью ключей, управляемых платформой и управляемых клиентом).

   > [!NOTE]
   > Чтобы реплицировать виртуальные машины с помощью CMK, вам потребуется [создать набор шифрования дисков](../virtual-machines/disks-enable-customer-managed-keys-portal.md#set-up-your-disk-encryption-set) в целевой группе ресурсов. Объект набора шифрования дисков сопоставляет управляемые диски с Key Vault, где содержится CMK для использования в SSE.
  
12. Для параметра **Преимущество гибридного использования Azure**

    - выберите вариант **Нет**, если вы не хотите применять Преимущество гибридного использования Azure. Затем нажмите кнопку **Далее**.
    - Выберите вариант **Да**, если у вас есть компьютеры с Windows Server, на которые распространяются активные подписки Software Assurance или Windows Server, и вы хотите применить это преимущество к компьютерам, которые вы переносите. Затем нажмите кнопку **Далее**.

    ![Целевые параметры](./media/tutorial-migrate-vmware/target-settings.png)

13. В разделе **Вычисление** проверьте имя виртуальной машины, ее размер, тип диска ОС и конфигурацию доступности (если она выбрана на предыдущем шаге). Виртуальные машины должны соответствовать [требованиям Azure](migrate-support-matrix-physical-migration.md#azure-vm-requirements).

    - **Размер виртуальной машины**. Если вы используете рекомендации по оценке, в раскрывающемся списке размеров виртуальных машин отобразится рекомендуемый размер. В противном случае Миграция Azure выбирает размер в зависимости от ближайшего совпадения в подписке Azure. В качестве альтернативы выберите размер вручную в разделе **Размер виртуальной машины Azure**.
    - **Диск ОС**: Укажите загрузочный диск ОС для виртуальной машины. Диск ОС — это диск с загрузчиком операционной системы и установщиком.
    - **Зона доступности.** Укажите зону доступности, которую необходимо использовать.
    - **Группа доступности**. Укажите группу доступности, которую необходимо использовать.

![Параметры вычислений](./media/tutorial-migrate-physical-virtual-machines/compute-settings.png)

14. В разделе **Диски** укажите, следует ли реплицировать диски виртуальных машин в Azure, и выберите тип диска (SSD или HDD (цен. категория "Стандартный") или управляемые диски (цен. категория "Премиум")) в Azure. Затем нажмите кнопку **Далее**.
    - Диски можно исключить из репликации.
    - Если вы исключите диски, они не будут присутствовать на виртуальной машине Azure после миграции. 

    ![Параметры дисков](./media/tutorial-migrate-physical-virtual-machines/disks.png)

15. В разделе **Review and start replication** (Просмотр и запуск репликации) просмотрите параметры и нажмите кнопку **Реплицировать**, чтобы начать первоначальную репликацию серверов.

> [!NOTE]
> Вы можете обновить параметры репликации в любое время до начала репликации в разделе **Управление** > **Репликация компьютеров**. Настройки невозможно изменить после начала репликации.

## <a name="track-and-monitor-replication-status"></a>Отслеживание и мониторинг состояния репликации

- Когда вы нажимаете кнопку **Реплицировать**, выполняется задание "Запуск репликации".
- После успешного завершения задания "Запуск репликации" виртуальные машины начинают первоначальную репликацию в Azure.
- После завершения начальной репликации начинается разностная репликация. Добавочные изменения дисков виртуальной машины AWS периодически реплицируются на диски реплики в Azure.

Отслеживать состояние задания можно в уведомлениях портала.

Вы можете отслеживать состояние репликации, щелкнув **Репликация серверов** в разделе **Azure Migrate: Server Migration** (Миграция Azure: миграция сервера).  

![Мониторинг репликации](./media/tutorial-migrate-physical-virtual-machines/replicating-servers.png)

## <a name="run-a-test-migration"></a>Выполнение тестовой миграции

Когда начинается разностная репликация, вы можете запустить тестовую миграцию для виртуальных машин перед выполнением полной миграции в Azure. Мы настоятельно рекомендуем выполнять тестовую миграцию. Она предоставляет возможность обнаружить любые потенциальные проблемы и исправить их, прежде чем приступить к фактической миграции. Рекомендуется выполнить ее хотя бы один раз для каждой виртуальной машины перед ее миграцией.

- Запуск тестовой миграции позволяет проверить, что миграция будет работать должным образом, не затрагивая виртуальные машины AWS, которые остаются работоспособными и продолжают репликацию.
- Тестовая миграция моделирует миграцию путем создания виртуальной машины Azure с использованием реплицированных данных (обычно выполняется миграция в нерабочую виртуальную сеть в вашей подписке Azure).
- Вы можете использовать реплицированную тестовую виртуальную машину Azure для проверки миграции, выполнения тестирования приложений и решения любых проблем перед полной миграцией.

Выполните тестовую миграцию следующим образом:

1. Последовательно выберите разделы **Цели миграции** > **Серверы** > **Azure Migrate: Server Migration** (Миграция Azure: миграция сервера) щелкните **Тестовая миграция серверов выполнена**.

     ![Тестовая миграция серверов](./media/tutorial-migrate-physical-virtual-machines/test-migrated-servers.png)

2. Щелкните правой кнопкой мыши виртуальную машину, чтобы выполнить тест, и выберите **Тестовая миграция**.

    ![Тестовая миграция](./media/tutorial-migrate-physical-virtual-machines/test-migrate.png)

3. В разделе **Тестовая миграция** выберите виртуальную сеть Azure, в которой будет находиться виртуальная машина Azure после миграции. Мы рекомендуем использовать нерабочую виртуальную сеть.
4. Запустится задание **Тестовая миграция**. Отслеживайте задание и уведомления на портале.
5. После завершения миграции просмотрите перенастроенную виртуальную машину Azure в разделе **Виртуальные машины** на портале Azure. Имя машины содержит суффикс **-Test**.
6. После завершения теста щелкните правой кнопкой мыши виртуальную машину Azure в разделе **Репликация компьютеров** и выберите **Очистка тестовой миграции**.

    ![Очистка миграции](./media/tutorial-migrate-physical-virtual-machines/clean-up.png)


## <a name="migrate-aws-vms"></a>Миграция виртуальных машин AWS

Убедившись, что тестовая миграция работает должным образом, вы можете выполнить миграцию виртуальных машин AWS.

1. В проекте "Миграция Azure" щелкните **Серверы** > **Azure Migrate: Server Migration** (Миграция Azure: миграция сервера) и выберите **Репликация серверов**.

    ![Репликация серверов](./media/tutorial-migrate-physical-virtual-machines/replicate-servers.png)

2. В области **Репликация компьютеров** щелкните правой кнопкой мыши виртуальную машину и выберите **Миграция**.
3. В разделе **Миграция** > **Shut down virtual machines and perform a planned migration with no data loss** (Завершить работу виртуальных машин и выполнить запланированную миграцию без потери данных?) выберите вариант **Да** > **ОК**.
    - Если вы не хотите выключать виртуальную машину, выберите вариант **Нет**.
4. Запустится задание миграции виртуальной машины. Чтобы просмотреть состояние задания, щелкните значок уведомления (колокольчик) в правом верхнем углу страницы портала или перейдите на страницу заданий средства миграции сервера (щелкните "Обзор" на плитке средства и выберите "Задания" в левом меню).
5. После завершения работы вы можете просматривать виртуальную машину и управлять ею на странице "Виртуальные машины".

### <a name="complete-the-migration"></a>Выполнение миграции

1. После завершения миграции щелкните правой кнопкой мыши виртуальную машину и выберите **Stop migration** (Остановка миграции). Таким образом вы сделаете следующее:
    - Прекратите выполнение репликации для виртуальной машины AWS.
    - Удалите виртуальную машину AWS из числа **реплицируемых серверов** в средстве для миграции серверов Миграции Azure.
    - Очистите информацию о состоянии репликации виртуальной машины.
2. Установите агент [Linux](../virtual-machines/extensions/agent-linux.md) на перенесенных компьютерах. Агент Windows виртуальной машины Azure предварительно устанавливается в процессе миграции.
3. Выполните любые действия по настройке после миграции приложения, такие как обновление строк подключения к базе данных и конфигурация веб-сервера.
4. Выполните приемочное тестирование конечного приложения и миграции на перенесенном приложении, работающем в Azure.
5. Остановите трафик для перенесенного экземпляра виртуальной машины Azure.
6. Обновите внутренние документы и отразите в них новое расположение и IP-адреса виртуальных машин Azure. 




## <a name="post-migration-best-practices"></a>Рекомендации, выполняемые после миграции

- Для повышения устойчивости:
    - Обеспечьте безопасность данных путем резервного копирования виртуальных машин Azure с помощью службы Azure Backup. [Подробнее](../backup/quick-backup-vm-portal.md).
    - Обеспечьте непрерывную работу и постоянную доступность рабочих нагрузок за счет репликации виртуальных машин Azure в дополнительный регион с помощью Site Recovery. [Подробнее](../site-recovery/azure-to-azure-tutorial-enable-replication.md).
- Для повышения уровня безопасности:
    - Заблокируйте и ограничьте доступ входящего трафика с помощью [JIT-администрирования](../security-center/security-center-just-in-time.md) центра безопасности Azure.
    - Ограничьте сетевой трафик конечными точками с помощью [групп безопасности сети](../virtual-network/network-security-groups-overview.md).
    - Разверните [шифрование дисков Azure](../security/fundamentals/azure-disk-encryption-vms-vmss.md), чтобы обеспечить безопасность дисков и защитить данные от кражи и несанкционированного доступа.
    - Ознакомьтесь с дополнительными сведениями о [защите ресурсов IaaS](https://azure.microsoft.com/services/virtual-machines/secure-well-managed-iaas/) и посетите [центр безопасности Azure](https://azure.microsoft.com/services/security-center/).
- Для мониторинга и управления:
    - Рассмотрите возможность развертывания [службы "Управление затратами Azure"](../cost-management-billing/cloudyn/overview.md) для мониторинга использования ресурсов и затрат.



## <a name="troubleshooting--tips"></a>Советы по устранению неполадок

**Вопрос**. В списке обнаруженных серверов для миграции не отображается виртуальная машина AWS.   
**Ответ.** Проверьте, соответствует ли ваше устройство репликации требованиям. Убедитесь, что агент мобильности установлен на исходной виртуальной машине, предназначенной для миграции, и зарегистрирован на сервере конфигурации. Проверьте параметры сети и правила брандмауэра, чтобы включить сетевой путь между устройством репликации и исходными виртуальными машинами AWS.  

**Вопрос**. Как узнать, была ли моя виртуальная машина успешно перенесена?   
**Ответ.** После завершения миграции вы можете просматривать виртуальную машину и управлять ею на странице "Виртуальные машины". Подключитесь к перенесенной виртуальной машине для выполнения проверки.  

**Вопрос**. Мне не удалось импортировать виртуальные машины для миграции из моих ранее созданных результатов оценки сервера.   
**Ответ.** В настоящее время мы не поддерживаем импорт оценки для этого рабочего процесса. В качестве обходного решения вы можете экспортировать оценку, а затем вручную выбрать рекомендацию виртуальной машины в процессе включения репликации.
  
**Вопрос**. При попытке обнаружить мои виртуальные машины AWS я получаю ошибку Failed to fetch BIOS GUID (Не удалось получить глобальный уникальный идентификатор BIOS).   
**Ответ.** При аутентификации выполняйте вход в корневой каталог и не используйте псевдо-имя пользователя. Также проверьте поддерживаемые операционные системы для виртуальных машин AWS.  

**Вопрос**. Состояние репликации не выполняется.   
**Ответ.** Проверьте, соответствует ли ваше устройство репликации требованиям. Убедитесь, что вы включили необходимые порты на своем устройстве репликации: TCP-порт 9443 и HTTPS 443 для передачи данных. Убедитесь в отсутствии устаревших дублирующих версий устройства репликации, подключенных к тому же проекту.   

**Вопрос**. Мне не удается обнаружить экземпляры AWS с помощью Миграции Azure из-за кода состояния HTTP 504 из удаленной службы управления Windows.    
**Ответ.** Обязательно ознакомьтесь с требованиями к устройству миграции Azure и требованиями к доступу по URL-адресу. Убедитесь, что никакие параметры прокси-сервера не блокируют регистрацию устройства.

**Вопрос**. Нужно ли вносить изменения перед переносом моих виртуальных машин AWS в Azure   
**Ответ.** Возможно, перед переносом виртуальных машин EC2 в Azure вам потребуется внести приведенные ниже изменения.

- Если вы используете cloud-init для подготовки виртуальной машины, вам может потребоваться отключить cloud-init на виртуальной машине перед его репликацией в Azure. Шаги подготовки, выполняемые cloud-init на виртуальной машине, могут быть доступны только для AWS и станут недействительными после миграции в Azure. 
- Если виртуальная машина представляет собой виртуальную машину PV (паравиртуализированная ВМ), а не виртуальную машину HVM, вы не сможете запустить ее "как есть" в Azure, так как паравиртуализированные виртуальные машины используют пользовательскую последовательность загрузки в AWS. Вы можете решить эту проблему, удалив драйверы PV перед выполнением миграции в Azure.  
- Всегда рекомендуется выполнять тестовую миграцию перед окончательной миграцией.  


**Вопрос**. Можно ли перенести виртуальные машины AWS с операционной системой Amazon Linux  
**Ответ.** Невозможно выполнить миграцию виртуальных машин Amazon Linux "как есть", так как ОС Amazon Linux поддерживается только в AWS.
Чтобы перенести рабочие нагрузки, выполняемые в Amazon Linux, можно запустить виртуальную машину CentOS или RHEL в Azure и перенести рабочую нагрузку, запущенную на компьютере AWS Linux, с помощью соответствующего подхода к миграции рабочей нагрузки. Например, в зависимости от рабочей нагрузки могут применяться специальные средства для упрощения миграции, например для баз данных или средств развертывания в случае веб-серверов.

## <a name="next-steps"></a>Дальнейшие действия

Проанализируйте процесс [миграции в облако](/azure/architecture/cloud-adoption/getting-started/migrate) в Azure Cloud Adoption Framework.