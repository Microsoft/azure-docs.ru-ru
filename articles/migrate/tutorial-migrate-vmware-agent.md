---
title: Перенос виртуальных машин VMware на основе агента миграции сервера службы "Миграция Azure"
description: Узнайте, как выполнить миграцию виртуальных машин VMware на основе агентов с помощью службы "Миграция Azure".
author: rahulg1190
ms.author: rahugup
ms.manager: bsiva
ms.topic: tutorial
ms.date: 06/09/2020
ms.custom: MVC
ms.openlocfilehash: 15bf8f4fde2128181664fa7b94f2479bac7ad5b9
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "98881523"
---
# <a name="migrate-vmware-vms-to-azure-agent-based"></a>Миграция виртуальных машин VMware в Azure (на основе агента)

В этой статье показано, как выполнить миграцию на основе агента для локальных виртуальных машин VMware в Azure с помощью [средства "Миграция сервера" службы "Миграция Azure"](migrate-services-overview.md#azure-migrate-server-migration-tool).  Кроме того, вы можете использовать для виртуальных машин VMware миграцию без агента. [Сравните](server-migrate-overview.md#compare-migration-methods) эти методы.


 В этом руководстве описано следующее:
> [!div class="checklist"]
> * подготовка Azure для работы со службой "Миграция Azure";
> * подготовка к миграции на основе агента; настройка учетной записи VMware, чтобы служба "Миграция Azure" могла обнаруживать компьютеры для миграции; настройка учетной записи, чтобы агент службы "Мобильность" устанавливался на компьютерах, которые требуется перенести, и подготовить эти компьютеры к работе в качестве устройства репликации;
> * Добавление средства "Миграция сервера" службы "Миграция Azure"
> * Настройка устройства репликации.
> * репликация виртуальных машин;
> * Выполнение тестовой миграции, позволяющей убедиться в правильной работе всех компонентов.
> * Выполнение полной миграции в Azure.

> [!NOTE]
> В руководствах показан простейший путь развертывания сценария, использование которого позволяет быстро настроить проверку концепции. В руководствах по возможности используются параметры по умолчанию и показаны не все возможные параметры и пути. 

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись](https://azure.microsoft.com/pricing/free-trial/), прежде чем начинать работу.


## <a name="prerequisites"></a>Предварительные требования

Перед началом работы с этим руководством [изучите](./agent-based-migration-architecture.md) архитектуру миграции VMware на основе агента.

## <a name="prepare-azure"></a>Подготовка Azure

Выполните задачи в этой таблице, чтобы подготовить Azure к миграции на основе агента.

**Задача** | **Сведения**
--- | ---
**Создание проекта службы "Миграция Azure"** | Чтобы создать проект, учетная запись Azure должна иметь привилегии участника или владельца.
**Проверка разрешений учетной записи Azure** | Учетная запись Azure должна иметь разрешения на создание виртуальной машины и на запись на управляемый диск Azure.
**Настройка сети Azure** | Настройте сеть, к которой будут присоединяться виртуальные машины Azure после миграции.

### <a name="assign-permissions-to-create-project"></a>Назначение разрешений для создания проекта
Если у вас нет проекта службы "Миграция Azure", проверьте наличие разрешений для его создания.


1. На портале Azure откройте подписку, а затем выберите **Управление доступом (IAM)** .
2. В разделе **Проверить доступ** найдите соответствующую учетную запись и щелкните ее, чтобы просмотреть разрешения.
3. Убедитесь, что у вас есть разрешения уровня **Участник** или **Владелец**.

    - Если вы создали бесплатную учетную запись Azure, вы являетесь владельцем подписки.
    - Если вы не являетесь владельцем подписки, назначьте эту роль совместно с владельцем.
    
### <a name="assign-azure-account-permissions"></a>Назначение разрешений учетной записи Azure

Присвойте учетной записи роль участника виртуальной машины, чтобы получить разрешения на следующие действия:

- разрешение на создание виртуальной машины в выбранной группе ресурсов;
- разрешение на создание виртуальной машины в выбранной виртуальной сети;
- разрешение на запись на управляемый диск Azure. 


### <a name="set-up-an-azure-network"></a>Настроить сеть

[Настройте сеть Azure](../virtual-network/manage-virtual-network.md#create-a-virtual-network). Локальные компьютеры реплицируются на управляемые диски Azure. При отработке отказа в Azure для миграции виртуальные машины Azure создаются на этих управляемых дисках и присоединяются к сети Azure, которую вы настроили.

## <a name="prepare-for-migration"></a>Подготовка к переносу

Проверьте требования по поддержке и разрешения, затем подготовьтесь к развертыванию устройства репликации. 

### <a name="prepare-an-account-to-discover-vms"></a>Подготовка учетной записи для обнаружения виртуальных машин

Средству "Миграция сервера" службы "Миграция Azure" требуется доступ к серверам VMware, чтобы обнаруживать переносимые виртуальные машины. Создайте учетную запись следующим образом:

1. Чтобы использовать выделенную учетную запись, создайте роль на уровне vCenter. Присвойте роли имя, например **Azure_Migrate**.
2. Назначьте роли разрешения, представленные в следующей таблице.
3. Создайте пользователя на сервере vCenter или узле vSphere. Назначьте роль для пользователя.

#### <a name="vmware-account-permissions"></a>Разрешения учетной записи VMware

**Задача** | **Роль/Разрешения** | **Сведения**
--- | --- | ---
**Обнаружение виртуальных машин** | Пользователь только для чтения (минимум).<br/><br/> Объект центра обработки данных –> Распространение на дочерний объект, роль Read-only | Пользователь назначается на уровне центра обработки данных и поэтому имеет доступ ко всем объектам в центре обработки данных.<br/><br/> Если нужно ограничить доступ, назначьте дочерним объектам (узлы vSphere, хранилища данных, виртуальные машины и сети) роль **Без доступа** с параметром **Распространить на дочерний объект**.
**Репликация** |  Создайте роль VMware (Azure_Site_Recovery) с необходимыми разрешениями и назначьте эту роль пользователю или группе VMware.<br/><br/> Объект центра обработки данных –> распространение на дочерний объект, роль Azure_Site_Recovery<br/><br/> Хранилище данных -> выделение места, обзор хранилища данных, низкоуровневые операции с файлами, удаление файлов, обновление файлов виртуальной машины<br/><br/> Сеть -> Назначение сети<br/><br/> Ресурс -> назначение виртуальной машины в пул ресурсов, миграция отключенной виртуальной машины, миграция включенной виртуальной машины<br/><br/> Задачи -> Создание задач, Обновление задач<br/><br/> Виртуальная машина -> конфигурация<br/><br/> Виртуальная машина -> взаимодействие -> ответ на вопрос, подключение устройства, настройка компакт-диска носителя, настройка дискеты носителя, отключение, включение, установка средств VMware<br/><br/> Виртуальная машина -> инвентаризация -> создание, регистрация, отмена регистрации<br/><br/> Виртуальная машина -> подготовка -> разрешение загрузки виртуальной машины, разрешение отправки файлов виртуальной машины<br/><br/> виртуальная машина -> моментальные снимки -> удаление моментальных снимков. | Пользователь назначается на уровне центра обработки данных и поэтому имеет доступ ко всем объектам в центре обработки данных.<br/><br/> Если нужно ограничить доступ, назначьте дочерним объектам (узлы vSphere, хранилища данных, виртуальные машины и сети) роль **Без доступа** с параметром **Распространить на дочерний объект**.

### <a name="prepare-an-account-for-mobility-service-installation"></a>Подготовка учетной записи к установке службы Mobility Service

На компьютерах, которые нужно реплицировать, должна быть установлена служба Mobility Service.

- Устройство репликации Миграции Azure может выполнить принудительную установку этой службы, если будет включена репликация для этого компьютера, или ее можно установить вручную или с помощью инструментов установки.
- В этом руководстве рассматривается принудительная установка службы Mobility Service.
- Для принудительной установки необходимо подготовить учетную запись, которую средство "Миграция сервера" службы "Миграция Azure" может использовать для доступа к виртуальной машине. Эта учетная запись используется только для принудительной установки, если вы не устанавливаете службу "Мобильность" вручную.

Подготовьте учетную запись описанным ниже способом.

1. Подготовьте домен или локальную учетную запись с этими разрешениями для установки на виртуальной машине.
2. Если вы работаете с виртуальными машинами Windows и не используете учетную запись домена, отключите управление доступом удаленного пользователя на локальном компьютере. Для этого в разделе реестра **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System** добавьте запись DWORD **LocalAccountTokenFilterPolicy** и задайте для нее значение 1.
3. Для установки на виртуальные машины Linux необходимо подготовить корневую учетную запись на исходном сервере Linux.


### <a name="prepare-a-machine-for-the-replication-appliance"></a>Подготовка компьютера для устройства репликации

Устройство используется для репликации компьютеров в Azure. Это устройство представляет собой отдельную, локальную виртуальную машину VMware с высоким уровнем доступности, на которой размещены следующие компоненты:

- **Сервер конфигурации**: Сервер конфигурации используется для управления обменом данными между локальным источником и Azure, а также репликацией данных.
- **Сервер обработки** Сервер обработки выступает в качестве шлюза репликации. Он получает данные репликации, оптимизирует их путем кэширования, сжатия и шифрования и отправляет их в учетную запись хранения кэша Azure. Сервер обработки также устанавливает агенты службы Mobility Service на виртуальную машину, которую требуется реплицировать, и выполняет автоматическое обнаружение локальных виртуальных машин VMware.

Подготовьте устройство следующим образом:

- [Проверьте требования к устройству](migrate-replication-appliance.md#appliance-requirements). Обычно устройство репликации настраивается как виртуальная машина VMware с помощью скачанного OVA-файла. Этот шаблон создает устройство, которое соответствует всем требованиям.
- На устройстве должна быть установлена MySQL. [Изучите](migrate-replication-appliance.md#mysql-installation) методы установки.
- Проверьте [URL-адреса общедоступного облака](migrate-replication-appliance.md#url-access) и [URL-адреса Azure для государственных организаций](migrate-replication-appliance.md#azure-government-url-access), к которым должен иметь доступ компьютер устройства.
- [Проверьте порты](migrate-replication-appliance.md#port-access), к которым должен иметь доступ компьютер устройства репликации.



### <a name="check-vmware-requirements"></a>Проверка соответствия требованиям к VMware

Убедитесь, что серверы и виртуальные машины VMware соответствуют требованиям для миграции Azure. 

1. [Проверьте](migrate-support-matrix-vmware-migration.md#vmware-requirements-agent-based) соответствие требованиям сервера VMware.
2. [Проверьте](migrate-support-matrix-vmware-migration.md#vm-requirements-agent-based) требования к виртуальным машинам для миграции.
3. Проверьте параметры Azure. Локальные виртуальные машины, которые реплицируются в Azure, должны соответствовать [требованиям к виртуальным машинам Azure](migrate-support-matrix-vmware-migration.md#azure-vm-requirements).
4. Прежде чем переносить виртуальные машины в Azure, необходимо внести в них некоторые изменения.
    - Важно внести эти изменения до начала миграции. Если вы перенесете виртуальную машину до внесения изменений, она может не загрузиться в Azure.
    - Просмотрите сведения об изменениях для [Windows](prepare-for-migration.md#windows-machines) и [Linux](prepare-for-migration.md#linux-machines), которые необходимо внести.

> [!NOTE]
> Миграция на основе агентов с помощью средства "Миграция сервера" службы "Миграция Azure" основана на функциях службы Azure Site Recovery. Некоторые требования могут ссылаться на документацию Site Recovery.

## <a name="set-up-the-replication-appliance"></a>Настройка устройства репликации

В этой процедуре описывается, как настроить устройство с помощью скачанного шаблона Open Virtualization Application (OVA). Если вы не можете использовать этот метод, устройство можно настроить [с помощью скрипта](tutorial-migrate-physical-virtual-machines.md#set-up-the-replication-appliance). 

### <a name="download-the-replication-appliance-template"></a>Скачивание шаблона устройства репликации

Скачайте шаблон следующим образом:

1. В проекте Миграции Azure щелкните **Серверы** в разделе **Цели миграции**.
2. На странице **Azure Migrate — Servers** > **Azure Migrate: Server Migration** (Миграция Azure — серверы > Миграция Azure: миграция сервера) щелкните **Обнаружить**.

    ![Обнаружение виртуальных машин](./media/tutorial-migrate-vmware-agent/migrate-discover.png)

3. В разделе **Обнаружение компьютеров** > **Ваши компьютеры виртуализированы?** щелкните **Да, с VMware vSphere Hypervisor**.
4. В разделе **Как вы хотите выполнить миграцию?** щелкните **Использование репликации на основе агентов**.
5. В поле **Целевой регион** выберите регион Azure, в который необходимо перенести компьютеры.
6. Выберите параметр **Подтвердите, что целевым регионом для миграции является "имя-региона"** .
7. Щелкните **Создать ресурсы**. После этого в фоновом режиме создается хранилище Azure Site Recovery. Вы не сможете изменить целевой регион для этого проекта после нажатия этой кнопки, и все последующие миграции будут выполняться в тот же регион.

    ![Создание хранилища Служб восстановления](./media/tutorial-migrate-vmware-agent/create-resources.png)

8. В разделе **Do you want to install a new replication appliance?** (Вы хотите установить новое устройство репликации?) щелкните **Установить устройство репликации**.
9. Щелкните элемент **Загрузить**. Будет скачан шаблон OVF.
    ![Скачивание OVA-файла](./media/tutorial-migrate-vmware-agent/download-ova.png)
10. Запишите имя группы ресурсов и хранилище служб восстановления. Это необходимо во время развертывания устройства.


### <a name="import-the-template-in-vmware"></a>Импорт шаблона в VMware

После скачивания шаблона OVF импортируйте его в VMware, чтобы создать приложение репликации на виртуальной машине VMware под управлением Windows Server 2016.

1. Войдите на сервер VMware vCenter или узел vSphere ESXi с помощью клиента VMware vSphere.
2. В меню **File** (Файл) выберите **Deploy OVF Template** (Развернуть шаблон OVF), чтобы запустить **мастер развертывания шаблона OVF**. 
3. Укажите расположение скачанного шаблона OVF в разделе **Select source** (Выбор источника).
4. В разделе **Review details** (Просмотр сведений) выберите **Next** (Далее).
5. Примите значения параметров по умолчанию в разделах **Select name and folder** (Выбор имени и папки) и **Select configuration** (Выбор конфигурации).
6. В разделе **Select storage** > **Select virtual disk format** (Выбор хранилища > Выбор формата виртуального диска), чтобы улучшить производительность, выберите **Thick Provision Eager Zeroed** (Быстрое обнуление плотной подготовки).
7. На остальных страницах мастера примите значение параметров по умолчанию.
8. Чтобы настроить виртуальную машину с параметрами по умолчанию, на странице **Ready to complete** (Готово к завершению) выберите **Power on after deployment** > **Finish** (Включить после развертывания > Готово).

   > [!TIP]
   > Если вам нужен дополнительный сетевой интерфейс, снимите флажок **Power on after deployment** > **Finish** (Включение после развертывания > Готово). По умолчанию шаблон содержит один сетевой интерфейс. Вы можете добавить дополнительные сетевые адаптеры после развертывания.

### <a name="start-appliance-setup"></a>Запуск установки устройства

1. В консоли клиента VMware vSphere включите виртуальную машину. Виртуальная машина загружается в среду установки Windows Server 2016.
2. Примите лицензионное соглашение и введите пароль администратора.
3. После установки войдите в виртуальную машину от имени администратора с помощью пароля. При первом входе в систему через несколько секунд будет запущено средство настройки устройства репликации (средство конфигурации Azure Site Recovery).
5. Введите имя, которое будет использоваться для регистрации устройства в средстве "Миграция сервера". Затем нажмите кнопку **Далее**.
6. Средство проверяет, может ли виртуальная машина подключиться к Azure. После установки подключения выберите **Sign in** (Вход), чтобы войти в подписку Azure.
7. Подождите, пока средство завершит регистрацию приложения Azure AD, чтобы идентифицировать устройство. Устройство перезагрузится.
1. Снова войдите в систему. Через несколько секунд мастер управления сервером конфигурации запустится автоматически.

### <a name="register-the-replication-appliance"></a>Регистрация устройства репликации

Завершите настройку и регистрацию устройства репликации.

1. В окне настройки устройства выберите **Настройка подключения**.
2. Выберите сетевую карту (по умолчанию есть только одна сетевая карта), которую устройство репликации использует для обнаружения виртуальных машин, а также для принудительной установки Службы мобильности на исходных компьютерах.
3. Выберите сетевую карту, которую устройство репликации использует для подключения к Azure. Затем нажмите кнопку **Save** (Сохранить). После настройки этот параметр уже нельзя изменить.
4. Если устройство находится вне прокси-сервера, необходимо указать параметры прокси-сервера.
    - Укажите имя прокси-сервера как **http://ip-address** или. **http://FQDN** . Прокси-серверы HTTPS не поддерживаются.
5. Когда появится запрос на подписку, группы ресурсов и сведения о хранилище, добавьте сведения, которые вы отметили при скачивании шаблона устройства.
6. В разделе **Install third-party software** (Установка стороннего программного обеспечения) примите лицензионное соглашение. Выберите **Download and Install** (Скачать и установить), чтобы установить сервер MySQL.
7. Выберите **Install VMware PowerLCI** (Установить VMware PowerCLI). Прежде чем это сделать, закройте все окна браузера. Затем выберите **Continue** (Продолжить).
8. Прежде чем вы продолжите, будут проверены предварительные требования в разделе **Validate appliance configuration** (Проверка конфигурации модуля).
9. В разделе **Configure vCenter Server/vSphere ESXi server** (Настройка сервера vCenter Server или vSphere ESXi) введите полное доменное имя или IP-адрес сервера vCenter или узла vSphere, на которых расположены виртуальные машины для репликации. Введите порт, от которого ожидается передача данных на сервер. Введите понятное имя для сервера VMware в хранилище.
10. Введите учетные данные для учетной записи, которую вы [создали](#prepare-an-account-to-discover-vms) для обнаружения VMware. Выберите **Добавить** > **Продолжить**.
11. В разделе **Настройка учетных данных виртуальной машины** введите учетные данные, которые вы [создали](#prepare-an-account-for-mobility-service-installation) для принудительной установки Службы мобильности при включении репликации для виртуальных машин.  
    - Для компьютеров Windows учетной записи должны быть предоставлены права локального администратора на компьютерах, которые требуется реплицировать.
    - Для Linux предоставьте сведения для учетной записи root.
12. Выберите **Finalize configuration** (Завершение конфигурации) для завершения регистрации.


После регистрации устройства репликации средство "Оценка сервера" службы "Миграция Azure" подключается к серверам VMware с использованием указанных параметров и обнаруживает виртуальные машины. Вы можете просмотреть обнаруженные виртуальные машины на вкладке **Прочие**, щелкнув **Управление** > **Обнаруженные элементы**.



## <a name="replicate-vms"></a>Репликация виртуальных машин

Теперь выберите виртуальные машины для миграции.

> [!NOTE]
> На портале можно выбрать до 10 компьютеров для репликации одновременно. Если вам нужно реплицировать больше, сгруппируйте их пакетами по 10.

1. В проекте службы "Миграция Azure" щелкните **Серверы** и в разделе **Azure Migrate: Server Migration** (Миграция Azure: миграция сервера) выберите **Репликация**.

    ![Снимок экрана: страница "Серверы" в Миграции Azure. Кнопка "Реплицировать" выбрана в средстве "Миграция сервера" службы Миграции Azure в разделе "Средства миграции".](./media/tutorial-migrate-vmware-agent/select-replicate.png)

2. В разделе **Реплицировать** выберите **Параметры исходного кода** > **Ваши компьютеры виртуализированы?** и **Yes, with VMware vSphere Hypervisor** (Да, с помощью гипервизора VMware vSphere).
3. В разделе **Локальное устройство** выберите имя устройства Миграции Azure, которое вы настроили.
4. В разделе **vCenter Server** укажите имя сервера vCenter, управляющего виртуальными машинами, или сервера vSphere, на котором размещены виртуальные машины.
5. В разделе **Сервер обработки** выберите имя устройства репликации.
6. В разделе **Учетные данные гостя** укажите учетную запись администратора виртуальной машины, которая будет использоваться для принудительной установки Службы мобильности. Выберите **Next: Виртуальные машины**.

    ![Снимок экрана: вкладка "Параметры источника" на странице "Репликация". Поле "Учетные данные гостя" выделено со значением VM-admin-account.](./media/tutorial-migrate-vmware-agent/source-settings.png)

7. В разделе **Виртуальные машины** выберите виртуальные машины, которые необходимо реплицировать.

    - Если вы выполнили оценку для виртуальных машин, вы можете применить рекомендации по выбору размера виртуальной машины и типу диска ("Премиум" или "Стандарт") из результатов оценки. Для этого в поле **Импортировать параметры миграции из средства оценки Миграции Azure?** выберите вариант **Да**.
    - Если вы не проводили оценку или не хотите использовать параметры оценки, выберите вариант **Нет**.
    - Если вы решили использовать оценку, выберите группу виртуальных машин и имя оценки.
8. В области **Параметры доступности** выберите следующие параметры.
    -  "Зона доступности", чтобы закрепить перенесенный компьютер в определенной зоне доступности в регионе. Используйте этот параметр для распределения серверов, образующих уровень приложения с несколькими узлами, по зонам доступности. Если вы выберете этот параметр, нужно будет указать зону доступности, чтобы использовать ее для каждого из выбранных компьютеров на вкладке "Вычисление". Этот параметр доступен только в том случае, если в целевом регионе, выбранном для миграции, поддерживаются зоны доступности.
    -  "Группа доступности", чтобы поместить перенесенную виртуальную машину в группу доступности. Чтобы использовать этот параметр, выбранная целевая группа ресурсов должна содержать одну или несколько групп доступности.
    - Параметр "Избыточность инфраструктуры не требуется", если вам не нужна ни одна из этих конфигураций доступности для перенесенных виртуальных машин.
9. Проверьте каждую виртуальную машину, которую требуется перенести. Выберите **Next: Целевые параметры**.
10. В разделе **Целевые параметры** выберите подписку и целевой регион, в который вы хотите выполнить миграцию, а также укажите группу ресурсов, в которой будут находиться виртуальные машины Azure после миграции.
11. В разделе **Виртуальная сеть** выберите виртуальную сеть или подсеть Azure, к которой будут подключены виртуальные машины Azure после миграции.
12. В области **Параметры доступности** выберите следующие параметры.
    -  "Зона доступности", чтобы закрепить перенесенный компьютер в определенной зоне доступности в регионе. Используйте этот параметр для распределения серверов, образующих уровень приложения с несколькими узлами, по зонам доступности. Если вы выберете этот параметр, нужно будет указать зону доступности, чтобы использовать ее для каждого из выбранных компьютеров на вкладке "Вычисление". Этот параметр доступен только в том случае, если в целевом регионе, выбранном для миграции, поддерживаются зоны доступности.
    -  "Группа доступности", чтобы поместить перенесенную виртуальную машину в группу доступности. Чтобы использовать этот параметр, выбранная целевая группа ресурсов должна содержать одну или несколько групп доступности.
    - Параметр "Избыточность инфраструктуры не требуется", если вам не нужна ни одна из этих конфигураций доступности для перенесенных виртуальных машин.
13. В разделе **Disk encryption type** (Тип шифрования диска) выберите один из следующих вариантов:
    - шифрование неактивных данных с помощью ключа, управляемого платформой;
    - шифрование неактивных данных с помощью ключа, управляемого клиентом.
    - Double encryption with platform-managed and customer-managed keys (Двойное шифрование с помощью ключей, управляемых платформой и управляемых клиентом).

   > [!NOTE]
   > Чтобы реплицировать виртуальные машины с помощью CMK, вам потребуется [создать набор шифрования дисков](../virtual-machines/disks-enable-customer-managed-keys-portal.md#set-up-your-disk-encryption-set) в целевой группе ресурсов. Объект набора шифрования дисков сопоставляет управляемые диски с Key Vault, где содержится CMK для использования в SSE.
  
14. Для параметра **Преимущество гибридного использования Azure**

    - выберите вариант **Нет**, если вы не хотите применять Преимущество гибридного использования Azure. Затем нажмите кнопку **Далее**.
    - Выберите вариант **Да**, если у вас есть компьютеры с Windows Server, на которые распространяются активные подписки Software Assurance или Windows Server, и вы хотите применить это преимущество к компьютерам, которые вы переносите. Затем нажмите кнопку **Далее**.

    ![Целевые параметры](./media/tutorial-migrate-vmware/target-settings.png)

15. В разделе **Вычисление** проверьте имя виртуальной машины, ее размер, тип диска ОС и конфигурацию доступности (если она выбрана на предыдущем шаге). Виртуальные машины должны соответствовать [требованиям Azure](migrate-support-matrix-vmware-migration.md#azure-vm-requirements).

   - **Размер виртуальной машины**. Если вы используете рекомендации по оценке, в раскрывающемся списке размеров виртуальных машин отобразится рекомендуемый размер. В противном случае Миграция Azure выбирает размер в зависимости от ближайшего совпадения в подписке Azure. В качестве альтернативы выберите размер вручную в разделе **Размер виртуальной машины Azure**. 
    - **Диск ОС**: Укажите загрузочный диск ОС для виртуальной машины. Диск ОС — это диск с загрузчиком операционной системы и установщиком. 
    - **Зона доступности.** Укажите зону доступности, которую необходимо использовать.
    - **Группа доступности**. Укажите группу доступности, которую необходимо использовать.

16. В разделе **Диски** укажите, следует ли реплицировать диски виртуальных машин в Azure, и выберите тип диска (SSD или HDD (цен. категория "Стандартный") или управляемые диски (цен. категория "Премиум")) в Azure. Затем нажмите кнопку **Далее**.
    - Диски можно исключить из репликации.
    - Если вы исключите диски, они не будут присутствовать на виртуальной машине Azure после миграции. 

17. В разделе **Review and start replication** (Просмотр и запуск репликации) просмотрите параметры и нажмите кнопку **Реплицировать**, чтобы начать первоначальную репликацию серверов.

> [!NOTE]
> Вы можете обновить параметры репликации в любое время до начала репликации в разделе **Управление** > **Репликация компьютеров**. Настройки невозможно изменить после начала репликации.


## <a name="track-and-monitor"></a>Отслеживание и мониторинг

1. Состояние задания можно отслеживать в уведомлениях портала. 

    ![Отслеживание задания](./media/tutorial-migrate-vmware-agent/jobs.png)
    
2. Вы можете отслеживать состояние репликации, щелкнув **Репликация серверов** в разделе **Azure Migrate: Server Migration** (Миграция Azure: миграция сервера).

    ![Мониторинг репликации](./media/tutorial-migrate-vmware-agent/replicate-servers.png)

Репликация выполняется следующим образом:
- После успешного завершения задания "Запуск репликации" компьютеры начинают первоначальную репликацию в Azure.
- После завершения начальной репликации начинается разностная репликация. Добавочные изменения локальных дисков периодически реплицируются на диски реплики в Azure.


## <a name="run-a-test-migration"></a>Выполнение тестовой миграции


Когда начинается разностная репликация, вы можете запустить тестовую миграцию для виртуальных машин перед выполнением полной миграции в Azure. Мы настоятельно рекомендуем сделать это хотя бы один раз для каждой машины перед ее миграцией.

- Запуск тестовой миграции позволяет проверить, что миграция будет работать должным образом, не затрагивая локальные машины, которые остаются работоспособными и продолжают репликацию. 
- Тестовая миграция моделирует миграцию путем создания виртуальной машины Azure с использованием реплицированных данных (обычно выполняется миграция в нерабочую виртуальную сеть в вашей подписке Azure).
- Вы можете использовать реплицированную тестовую виртуальную машину Azure для проверки миграции, выполнения тестирования приложений и решения любых проблем перед полной миграцией.

Выполните тестовую миграцию следующим образом:


1. Последовательно выберите разделы **Цели миграции** > **Серверы** > **Azure Migrate: Server Migration** (Миграция Azure: миграция сервера) щелкните **Тестовая миграция серверов выполнена**.

     ![Тестовая миграция серверов](./media/tutorial-migrate-vmware-agent/test-migrated-servers.png)

2. Щелкните правой кнопкой мыши виртуальную машину, чтобы выполнить тест, и выберите **Тестовая миграция**.

    ![Тестовая миграция](./media/tutorial-migrate-vmware-agent/test-migrate.png)

3. В разделе **Тестовая миграция** выберите виртуальную сеть Azure, в которой будет находиться виртуальная машина Azure после миграции. Мы рекомендуем использовать нерабочую виртуальную сеть.
4. Запустится задание **Тестовая миграция**. Отслеживайте задание и уведомления на портале.
5. После завершения миграции просмотрите перенастроенную виртуальную машину Azure в разделе **Виртуальные машины** на портале Azure. Имя машины содержит суффикс **-Test**.
6. После завершения теста щелкните правой кнопкой мыши виртуальную машину Azure в разделе **Репликация компьютеров** и выберите **Очистка тестовой миграции**.

    ![Очистка миграции](./media/tutorial-migrate-vmware-agent/clean-up.png)


## <a name="migrate-vms"></a>Перенос виртуальных машин

Убедившись, что тестовая миграция работает должным образом, вы можете выполнить миграцию локальных компьютеров.

1. В проекте "Миграция Azure" щелкните **Серверы** > **Azure Migrate: Server Migration** (Миграция Azure: миграция сервера) и выберите **Репликация серверов**.

    ![Репликация серверов](./media/tutorial-migrate-vmware-agent/replicate-servers.png)

2. В области **Репликация компьютеров** щелкните правой кнопкой мыши виртуальную машину и выберите **Миграция**.
3. В разделе **Миграция** > **Shut down virtual machines and perform a planned migration with no data loss** (Завершить работу виртуальных машин и выполнить запланированную миграцию без потери данных?) выберите вариант **Да** > **ОК**.
    - По умолчанию служба "Миграция Azure" завершает работу локальной виртуальной машины, чтобы обеспечить минимальную вероятность потери данных. 
    - Если вы не хотите выключать виртуальную машину, выберите вариант **Нет**.
4. Запустится задание миграции виртуальной машины. Отслеживайте задание в уведомлениях Azure.
5. После завершения работы вы можете просматривать виртуальную машину и управлять ею на странице **Виртуальные машины**.

## <a name="complete-the-migration"></a>Выполнение миграции

1. После завершения миграции щелкните правой кнопкой мыши виртуальную машину и выберите **Stop migration** (Остановка миграции). Таким образом вы сделаете следующее:
    - Остановите репликацию для локального компьютера.
    - Удалите компьютер из числа **реплицируемых серверов** в средстве для миграции серверов Миграции Azure.
    - Очистите информацию о состоянии репликации виртуальной машины.
2. Установите агент виртуальной машины Azure для [Windows](../virtual-machines/extensions/agent-windows.md) или [Linux](../virtual-machines/extensions/agent-linux.md) на перенесенных компьютерах.
3. Выполните любые действия по настройке после миграции приложения, такие как обновление строк подключения к базе данных и конфигурация веб-сервера.
4. Выполните приемочное тестирование конечного приложения и миграции на перенесенном приложении, работающем в Azure.
5. Остановите трафик для перенесенного экземпляра виртуальной машины Azure.
6. Удалите локальные виртуальные машины из списка локальных виртуальных машин.
7. Удалите локальные виртуальные машины из локальных заданий резервного копирования.
8. Обновите внутренние документы и отразите в них новое расположение и IP-адреса виртуальных машин Azure. 

## <a name="post-migration-best-practices"></a>Рекомендации, выполняемые после миграции

- В локальной среде
    - Переместите трафик приложения в приложение, работающее на экземпляре перенесенной виртуальной машины Azure.
    - Удалите локальные виртуальные машины из списка локальных виртуальных машин.
    - Удалите локальные виртуальные машины из локальных заданий резервного копирования.
    - Обновите внутренние документы и отразите в них новое расположение и IP-адреса виртуальных машин Azure.
- Настройка параметров виртуальных машин Azure после миграции.
    - [Агент виртуальной машины Azure](../virtual-machines/extensions/agent-windows.md) управляет взаимодействием виртуальной машины с контроллером Azure Fabric. Это обязательно для некоторых служб Azure, таких как Azure Backup, Site Recovery и служба безопасности Azure. При миграции виртуальных машин VMware с использованием агента, установщик Mobility Service устанавливает на компьютерах Windows агент виртуальной машины Azure. Для виртуальных машин Linux мы рекомендуем установить этот агент после отработки отказа.
    - После миграции вручную удалите службу мобильности из виртуальной машины Azure.
    - После миграции вручную удалите средства VMware.
- В Azure выполните следующее.
    - Выполните любые действия по настройке после миграции приложения, такие как обновление строк подключения к базе данных и конфигурация веб-сервера.
    - Выполните приемочное тестирование конечного приложения и миграции на перенесенном приложении, работающем в Azure.
- Непрерывность бизнес-процессов, аварийное восстановление
    - Обеспечьте безопасность данных путем резервного копирования виртуальных машин Azure с помощью службы Azure Backup. [Подробнее](../backup/quick-backup-vm-portal.md).
    - Обеспечьте непрерывную работу и постоянную доступность рабочих нагрузок за счет репликации виртуальных машин Azure в дополнительный регион с помощью Site Recovery. [Подробнее](../site-recovery/azure-to-azure-tutorial-enable-replication.md).
- Для повышения уровня безопасности:
    - Заблокируйте и ограничьте доступ входящего трафика с помощью [JIT-администрирования](../security-center/security-center-just-in-time.md) центра безопасности Azure.
    - Ограничьте сетевой трафик конечными точками с помощью [групп безопасности сети](../virtual-network/network-security-groups-overview.md).
    - Разверните [шифрование дисков Azure](../security/fundamentals/azure-disk-encryption-vms-vmss.md), чтобы обеспечить безопасность дисков и защитить данные от кражи и несанкционированного доступа.
    - Ознакомьтесь с дополнительными сведениями о [защите ресурсов IaaS](https://azure.microsoft.com/services/virtual-machines/secure-well-managed-iaas/) и посетите [центр безопасности Azure](https://azure.microsoft.com/services/security-center/).
- Для мониторинга и управления:
    - Рассмотрите возможность развертывания [службы "Управление затратами Azure"](../cost-management-billing/cloudyn/overview.md) для мониторинга использования ресурсов и затрат.




 ## <a name="next-steps"></a>Дальнейшие действия

Проанализируйте процесс [миграции в облако](/azure/architecture/cloud-adoption/getting-started/migrate) в Azure Cloud Adoption Framework.