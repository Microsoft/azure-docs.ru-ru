---
title: Настройка анализа зависимостей без агента в службе "миграция Azure — Оценка сервера"
description: Настройка анализа зависимостей без агента в службе "миграция Azure" для оценки серверов.
author: vikram1988
ms.author: vibansa
ms.manager: abhemraj
ms.topic: how-to
ms.date: 6/08/2020
ms.openlocfilehash: c3aa2aea764af8469152b007e60427724fea398a
ms.sourcegitcommit: f3ec73fb5f8de72fe483995bd4bbad9b74a9cc9f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/04/2021
ms.locfileid: "102045859"
---
# <a name="analyze-server-dependencies-agentless"></a>Анализ зависимостей сервера (без агента)

В этой статье описывается, как настроить анализ зависимостей без агента с помощью службы "миграция Azure": Оценка сервера. [Анализ зависимостей](concepts-dependency-visualization.md) помогает определить и понять зависимости между серверами для оценки и миграции в Azure.

> [!IMPORTANT]
> Анализ зависимостей без агента сейчас находится на этапе предварительной версии для серверов, работающих в среде VMware, обнаруженных с помощью средства Azure Migrate: Server Analysis Tool.
> Эта предварительная версия охватывается службой поддержки клиентов и может использоваться для рабочих нагрузок.
> Дополнительные сведения см. в статье [Дополнительные условия использования предварительных выпусков Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).

## <a name="current-limitations"></a>Текущие ограничения

- В представлении "анализ зависимостей" в настоящее время невозможно добавить или удалить сервер из группы.
- Схема зависимостей для группы серверов в настоящее время недоступна.
- В проекте службы "миграция Azure" сбор данных о зависимостях можно включить параллельно для серверов 1000. Можно проанализировать большее количество серверов путем виртуализации в пакетах серверов 1000.

## <a name="before-you-start"></a>Прежде чем начать

- Убедитесь, что вы [создали проект "миграция Azure](./create-manage-projects.md) " с помощью средства "миграция Azure", добавленного к нему.
- Ознакомьтесь с [требованиями к VMware](migrate-support-matrix-vmware.md#vmware-requirements) , чтобы выполнить анализ зависимостей.
- Проверьте [требования к устройству](migrate-support-matrix-vmware.md#azure-migrate-appliance-requirements) перед настройкой устройства.
- [Ознакомьтесь с требованиями к анализу зависимостей](migrate-support-matrix-vmware.md#dependency-analysis-requirements-agentless) перед включением анализа зависимостей на серверах.

## <a name="deploy-and-configure-the-azure-migrate-appliance"></a>Развертывание и Настройка устройства "миграция Azure"

1. [Ознакомьтесь](migrate-appliance.md#appliance---vmware) с требованиями к развертыванию устройства "миграция Azure".
2. Ознакомьтесь с URL-адресами Azure, которые требуются устройству для доступа в [общедоступных](migrate-appliance.md#public-cloud-urls) и [правительственных облаках](migrate-appliance.md#government-cloud-urls).
3. [Просмотрите данные](migrate-appliance.md#collected-data---vmware), собранные устройством во время обнаружения и оценки.
4. [Обратите внимание](migrate-support-matrix-vmware.md#port-access-requirements) на требования доступа к порту для устройства.
5. [Разверните устройство "миграция Azure"](how-to-set-up-appliance-vmware.md) , чтобы запустить обнаружение. Чтобы развернуть устройство, скачайте и импортируйте шаблон OVA в VMware, чтобы создать сервер, работающий на vCenter Server. После развертывания устройства необходимо зарегистрировать его в проекте службы "миграция Azure" и настроить его для инициации обнаружения.
6. При настройке устройства необходимо указать следующие параметры в диспетчере конфигурации устройства:
    - Сведения о vCenter Server, к которому необходимо подключиться.
    - vCenter Server учетные данные для обнаружения серверов в среде VMware.
    - Учетные данные сервера, которые могут быть учетными данными домена или Windows (не домена) или Linux (не домена). Дополнительные [сведения](add-server-credentials.md) о способах предоставления учетных данных и их обработке.

## <a name="verify-permissions"></a>Проверка разрешений

- Для обнаружения и оценки необходимо [создать vCenter Server учетную запись только для чтения](./tutorial-discover-vmware.md#prepare-vmware) . Учетной записи только для чтения требуются привилегии для  >  **гостевых операций** виртуальных машин, чтобы взаимодействовать с серверами для получения данных о зависимостях.
- Необходима учетная запись пользователя, чтобы оценка сервера могла получить доступ к серверу для получения данных о зависимостях. [Сведения](migrate-support-matrix-vmware.md#dependency-analysis-requirements-agentless) о требованиях к учетной записи для серверов Windows и Linux.

### <a name="add-credentials-and-initiate-discovery"></a>Добавление учетных данных и инициирование обнаружения

1. Откройте диспетчер конфигурации устройства, выполните проверки готовности и регистрацию устройства.
2. Перейдите на панель **Управление учетными данными и источниками обнаружения** .
1.  На **шаге 1. Укажите учетные данные vCenter Server**, щелкните **Добавить учетные** данные, чтобы указать учетные данные для учетной записи vCenter Server, которую устройство будет использовать для обнаружения серверов, работающих на vCenter Server.
1. На **шаге 2. укажите vCenter Server сведения**, щелкните **Добавить источник обнаружения** , чтобы выбрать понятное имя учетных данных из раскрывающегося списка. Укажите **IP-адрес или полное доменное** имя :::image type="content" source="./media/tutorial-discover-vmware/appliance-manage-sources.png" alt-text="панели экземпляра vCenter Server 3 в диспетчере конфигурации устройства для сведений о vCenter Server":::
1. На **шаге 3. Предоставьте учетные данные сервера для выполнения инвентаризации программного обеспечения, анализа зависимостей без агента и обнаружения экземпляров SQL Server и баз данных**. Щелкните **Добавить учетные данные** , чтобы указать несколько учетных данных сервера для запуска инвентаризации программного обеспечения.
1. Нажмите кнопку **начать обнаружение**, чтобы запустить обнаружение vCenter Server.

 После завершения обнаружения vCenter Server устройство инициирует Обнаружение установленных приложений, ролей и компонентов (инвентаризации программного обеспечения). Во время инвентаризации программного обеспечения добавленные учетные данные сервера будут передаваться по серверам и проверяться на предмет анализа зависимостей без агента. Вы можете включить анализ зависимостей без агента для серверов с портала. Для включения анализа зависимостей без агента можно выбрать только серверы, на которых прошла проверка.

## <a name="start-dependency-discovery"></a>Запустить обнаружение зависимостей

Выберите серверы, на которых необходимо включить обнаружение зависимостей.

1. В **службе "миграция Azure": Оценка сервера** щелкните **обнаруженные серверы**.
2. Выберите **имя устройства** , обнаружение которого нужно проверить.
1. Состояние проверки серверов можно увидеть в столбце **зависимости (без агента)** .
1. Щелкните раскрывающийся список **анализ зависимостей** .
1. Нажмите кнопку **Добавить серверы**.
1. На странице **Добавление серверов** выберите серверы, на которых нужно включить анализ зависимостей. Сопоставление зависимостей можно включить только на тех серверах, на которых проверка прошла удачно. Следующий цикл проверки будет выполняться через 24 часа после последней отметки времени проверки.
1. Выбрав серверы, нажмите кнопку **Добавить серверы**.

:::image type="content" source="./media/how-to-create-group-machine-dependencies-agentless/start-dependency-discovery.png" alt-text="Запуск анализа зависимостей":::

Можно визуализировать зависимости около шести часов после включения анализа зависимостей на серверах. Если вы хотите одновременно включить несколько серверов для анализа зависимостей, для этого можно использовать [PowerShell](#start-or-stop-dependency-analysis-using-powershell) .

## <a name="visualize-dependencies"></a>Визуализация зависимостей

1. В **службе "миграция Azure": Оценка сервера** щелкните **обнаруженные серверы**.
1. Выберите **имя устройства** , обнаружение которого нужно проверить.
1. Найдите сервер, зависимости которого необходимо просмотреть.
1. В столбце **зависимости (без агента)** щелкните **Просмотр зависимостей** .
1. Измените период времени, для которого необходимо просмотреть карту, с помощью раскрывающегося списка **Длительность времени** .
1. Разверните группу **клиентов** , чтобы получить список серверов с зависимостью от выбранного сервера.
1. Разверните группу **портов** , чтобы получить список серверов, имеющих зависимость от выбранного сервера.
1. Чтобы перейти к представлению карт зависимых серверов, щелкните имя сервера > **загрузить схему сервера** 
 :::image type="content" source="./media/how-to-create-group-machine-dependencies-agentless/load-server-map.png" alt-text="развернуть группу портов сервера и загрузить карту сервера"::: .
:::image type="content" source="./media/how-to-create-group-machine-dependencies-agentless/expand-client-group.png" alt-text="Развернуть группу клиентов":::

8. Разверните выбранный сервер, чтобы просмотреть сведения об уровне процесса для каждой зависимости.
:::image type="content" source="./media/how-to-create-group-machine-dependencies-agentless/expand-server-processes.png" alt-text="Развертывание сервера для отображения процессов":::

> [!NOTE]
> Сведения о процессе для зависимости не всегда доступны. Если он недоступен, зависимость отображается с процессом, помеченным как "Неизвестный процесс".

## <a name="export-dependency-data"></a>Экспорт данных зависимостей

1. В **службе "миграция Azure": Оценка сервера** щелкните **обнаруженные серверы**.
2. Щелкните раскрывающийся список **анализ зависимостей** .
3. Нажмите кнопку **Экспорт зависимостей приложений**.
4. На странице **Экспорт зависимостей приложения** выберите имя устройства, которое будет обнаруживать нужные серверы.
5. Выберите время начала и время окончания. Обратите внимание, что данные можно загрузить только за последние 30 дней.
6. Щелкните **Экспорт зависимостей**.

Данные зависимостей экспортируются и загружаются в формате CSV. Скачанный файл содержит данные зависимостей на всех серверах, включенных для анализа зависимостей. 
:::image type="content" source="./media/how-to-create-group-machine-dependencies-agentless/export.png" alt-text="Экспорт зависимостей":::

### <a name="dependency-information"></a>Сведения о зависимостях

Каждая строка в экспортированном CSV-файле соответствует зависимости, наблюдаемой в заданном интервале времени.

В следующей таблице перечислены поля в экспортированном CSV-файле. Обратите внимание, что поля имя сервера, приложение и процесс заполнены только для серверов, для которых включен анализ зависимостей без агента.

**Имя поля** | **Сведения**
--- | --- 
тимеслот | Тимеслот, в течение которого была наблюдаться зависимость. <br/> Данные зависимостей захватываются в течение 6-часового слота.
Имя исходного сервера | Имя исходного сервера 
Исходное приложение | Имя приложения на исходном сервере  
Процесс-источник | Имя процесса на исходном сервере  
Имя целевого сервера | Имя целевого сервера
Конечный IP-адрес | IP-адрес целевого сервера
Конечное приложение | Имя приложения на целевом сервере
Процесс назначения | Имя процесса на целевом сервере  
Конечный порт | Номер порта на целевом сервере

## <a name="stop-dependency-discovery"></a>Отключить обнаружение зависимостей

Выберите серверы, на которых требуется отключить обнаружение зависимостей.

1. В **службе "миграция Azure": Оценка сервера** щелкните **обнаруженные серверы**.
1. Выберите **имя устройства** , обнаружение которого нужно проверить.
1. Щелкните раскрывающийся список **анализ зависимостей** .
1. Нажмите кнопку **удалить серверы**.
1. На странице **Удаление серверов** выберите сервер, который необходимо отключить для анализа зависимостей.
1. Выбрав серверы, нажмите кнопку **удалить серверы**.

Если вы хотите, чтобы зависимость намерена одновременно на нескольких серверах, для этого можно использовать [PowerShell](#start-or-stop-dependency-analysis-using-powershell) .

## <a name="start-or-stop-dependency-analysis-using-powershell"></a>Запуск или завершение анализа зависимостей с помощью PowerShell

Скачайте модуль PowerShell из репозитория [примеров Azure PowerShell](https://github.com/Azure/azure-docs-powershell-samples/tree/master/azure-migrate/dependencies-at-scale) на сайте GitHub.

### <a name="log-in-to-azure"></a>Вход в Azure

1. Войдите в подписку Azure с помощью командлета Connect-AzAccount.

    ```PowerShell
    Connect-AzAccount
    ```
    При использовании Azure для государственных организаций используйте следующую команду.
    ```PowerShell
    Connect-AzAccount -EnvironmentName AzureUSGovernment
    ```

2. Выберите подписку, в которой был создан проект "миграция Azure" 

    ```PowerShell
    select-azsubscription -subscription "Fabrikam Demo Subscription"
    ```

3. Импорт скачанного модуля PowerShell AzMig_Dependencies

    ```PowerShell
    Import-Module .\AzMig_Dependencies.psm1
    ```

### <a name="enable-or-disable-dependency-data-collection"></a>Включение или отключение сбора данных о зависимостях

1. Получите список обнаруженных серверов в проекте службы "миграция Azure" с помощью следующих команд. В приведенном ниже примере имя проекта — Фабрикамдемопрожект, а группа ресурсов, к которой он принадлежит, — Фабрикамдеморг. Список серверов будет сохранен в FabrikamDemo_VMs.csv

    ```PowerShell
    Get-AzMigDiscoveredVMwareVMs -ResourceGroupName "FabrikamDemoRG" -ProjectName "FabrikamDemoProject" -OutputCsvFile "FabrikamDemo_VMs.csv"
    ```

    В файле можно увидеть отображаемое имя сервера, текущее состояние коллекции зависимостей и идентификатор ARM для всех обнаруженных серверов. 

2. Чтобы включить или отключить зависимости, создайте входной CSV-файл. Файл должен иметь столбец с заголовком "ARM ID". Все дополнительные заголовки в CSV-файле будут игнорироваться. Вы можете создать CSV-файл с помощью файла, созданного на предыдущем шаге. Создайте копию файла, в котором будут храниться серверы, для которых необходимо включить или отключить зависимости. 

    В следующем примере анализ зависимостей включается в списке серверов во входном файле FabrikamDemo_VMs_Enable.csv.

    ```PowerShell
    Set-AzMigDependencyMappingAgentless -InputCsvFile .\FabrikamDemo_VMs_Enable.csv -Enable
    ```

    В следующем примере анализ зависимостей отключается в списке серверов во входном файле FabrikamDemo_VMs_Disable.csv.

    ```PowerShell
    Set-AzMigDependencyMappingAgentless -InputCsvFile .\FabrikamDemo_VMs_Disable.csv -Disable
    ```

## <a name="visualize-network-connections-in-power-bi"></a>Визуализация сетевых подключений в Power BI

Служба "миграция Azure" предлагает шаблон Power BI, который можно использовать для визуализации сетевых подключений нескольких серверов одновременно, а также для фильтрации по процессам и серверам. Чтобы визуализировать, загрузите Power BI с данными зависимостей в соответствии с приведенными ниже инструкциями.

1. Скачайте модуль PowerShell и шаблон Power BI из репозитория [примеров Azure PowerShell](https://github.com/Azure/azure-docs-powershell-samples/tree/master/azure-migrate/dependencies-at-scale) на сайте GitHub.

2. Войдите в Azure, выполнив приведенные ниже инструкции. 
    - Войдите в подписку Azure с помощью командлета Connect-AzAccount.

        ```PowerShell
        Connect-AzAccount
        ```

    - При использовании Azure для государственных организаций используйте следующую команду.

        ```PowerShell
        Connect-AzAccount -EnvironmentName AzureUSGovernment
        ```

    - Выберите подписку, в которой был создан проект "миграция Azure"

        ```PowerShell
        select-azsubscription -subscription "Fabrikam Demo Subscription"
        ```

3. Импорт скачанного модуля PowerShell AzMig_Dependencies

    ```PowerShell
    Import-Module .\AzMig_Dependencies.psm1
    ```

4. Выполните следующую команду. Эта команда скачивает данные зависимостей в CSV-файл и обрабатывает их для создания списка уникальных зависимостей, которые можно использовать для визуализации в Power BI. В примере ниже имя проекта — Фабрикамдемопрожект, а группа ресурсов, к которой он принадлежит, — Фабрикамдеморг. Зависимости будут скачаны для серверов, обнаруженных Фабрикамапплианце. Уникальные зависимости будут сохранены в FabrikamDemo_Dependencies.csv

    ```PowerShell
    Get-AzMigDependenciesAgentless -ResourceGroup FabrikamDemoRG -Appliance FabrikamAppliance -ProjectName FabrikamDemoProject -OutputCsvFile "FabrikamDemo_Dependencies.csv"
    ```

5. Открытие скачанного шаблона Power BI

6. Загрузите Скачанные данные зависимостей в Power BI.
    - Откройте шаблон в Power BI.
    - Щелкните **получить данные** на панели инструментов. 
    - Выберите **Text/CSV** из общих источников данных.
    - Выберите скачанный файл зависимостей.
    - Нажмите кнопку **Загрузить**.
    - Вы увидите таблицу, которая импортируется с именем CSV-файла. Таблицу можно увидеть на панели полей справа. Переименуйте его в AzMig_Dependencies
    - Щелкните Обновить на панели инструментов.

    Диаграмма "Сетевые подключения" и имя исходного сервера, имя целевого сервера, имя исходного процесса, срезы имени процесса назначения должны быть освещены с импортированными данными.

7. Визуализировать карту сетевых подключений по серверам и процессам. Сохраните файл.

## <a name="next-steps"></a>Дальнейшие действия

[Групповые серверы](how-to-create-a-group.md) для оценки.