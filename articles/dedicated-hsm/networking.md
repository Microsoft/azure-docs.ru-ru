---
title: Рекомендации по работе с сетями. Варианты Выделенное устройство HSM Azure | Документация Майкрософт
description: Рекомендации по работе с сетями, применяющиеся к развертываниям выделенных устройств HSM Azure.
services: dedicated-hsm
author: msmbaldwin
manager: rkarlin
ms.custom: mvc, seodec18
ms.service: key-vault
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: conceptual
ms.date: 03/25/2021
ms.author: keithp
ms.openlocfilehash: 5365ba8c4fbc07c487dd40cfcdc9d566990c493c
ms.sourcegitcommit: 73d80a95e28618f5dfd719647ff37a8ab157a668
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/26/2021
ms.locfileid: "105607053"
---
# <a name="azure-dedicated-hsm-networking"></a>Сеть для выделенного устройства HSM Azure

Для выделенного устройства HSM Azure требуется высокий уровень безопасности сетевой инфраструктуры. Он требуется как в случае перехода из облака Azure в локальную ИТ-среду клиента, так и при использовании распределенных приложений или сценариев высокого уровня доступности. Сеть Azure предоставляет это, и есть четыре различные области, которые нужно рассмотреть.

- Создание устройств HSM внутри виртуальной сети (VNet) в Azure
- Подключение локальных ресурсов к облачным для настройки устройств HSM и управления ими
- Создание и подключение виртуальных сетей для подключения ресурсов приложений и устройств HSM
- Подключение виртуальных сетей в разных регионах для обмена данными, а также для реализации сценариев с высоким уровнем доступности

## <a name="virtual-network-for-your-dedicated-hsms"></a>Виртуальная сеть для выделенных HSM

Выделенные HSM интегрированы в виртуальную сеть и помещаются в собственную частную сеть клиентов в Azure. Это обеспечивает доступ к устройствам с виртуальных машин или вычислительных ресурсов в виртуальной сети.  
Дополнительные сведения об интеграции служб Azure в виртуальной сети и возможностях, которые она предоставляет, см. в статье [Виртуальная сеть для служб Azure](../virtual-network/virtual-network-for-azure-services.md).

### <a name="virtual-networks"></a>Виртуальные сети

Перед подготовкой выделенного устройства HSM клиенты сначала должны создать виртуальную сеть в Azure или использовать уже существующую в подписке клиентов. Виртуальная сеть определяет периметр безопасности для выделенного устройства HSM. Дополнительные сведения о создании виртуальных сетей см. в [документации по виртуальным сетям](../virtual-network/virtual-networks-overview.md).

### <a name="subnets"></a>подсети;

Подсети сегментируют виртуальную сеть на отдельные адресные пространства, которые применяются для размещения ресурсов Azure. Выделенные HSM развертываются в подсети в виртуальной сети. Каждое выделенное устройство HSM, которое развернуто в подсети клиента, будет получать частный IP-адрес из этой подсети. Подсеть, в которой развернуто устройство HSM, должна быть явно делегирована службе: Microsoft.HardwareSecurityModules/dedicatedHSMs. Это предоставляет определенные разрешения для службы HSM для развертывания в подсети. Делегирование выделенных HSM накладывает некоторые ограничения политики на подсеть. Группы безопасности сети (NSG) и определяемые пользователем маршруты (UDR) в настоящее время не поддерживаются в делегированных подсетях. После делегирования подсети для выделенных HSM она может использоваться только для развертывания ресурсов HSM. Развертывание любых других клиентских ресурсов в подсети не будет выполнено.


### <a name="expressroute-gateway"></a>Шлюз ExpressRoute

Требование для текущей архитектуры представляет собой конфигурацию ER-шлюза в подсети клиентов, где должно быть размещено устройство HSM для обеспечения интеграции устройства HSM в Azure. Этот ER-шлюз не может быть использован для подключения локальных расположений к клиентским устройствам HSM в Azure.

## <a name="connecting-your-on-premises-it-to-azure"></a>Подключение локальных ИТ к Azure

При создании облачных ресурсов типичным требованием является наличие частного подключения к локальным ИТ-ресурсам. В случае с выделенным устройством HSM это требование преимущественно распространяется на клиентское программное обеспечение HSM для настройки устройств HSM, а также на такие действия, как резервное копирование и извлечение журналов из HSM для анализа. В данном случае ключевым аспектом для принятия решения является характер подключения, так как возможны разные варианты.  Самый гибкий вариант — VPN между сайтами. В этом случае может быть несколько локальных ресурсов, для которых требуется безопасный обмен данными с ресурсами (включая HSM) в облаке Azure. Для этого нужно, чтобы в организации клиента было VPN-устройство для подключения. VPN-подключение типа "точка — сеть" можно использовать при наличии только одной локальной конечной точки (например, одной рабочей станции администрирования).
Дополнительные сведения о вариантах подключения см. в статье [Параметры планирования VPN-шлюза](../vpn-gateway/vpn-gateway-about-vpngateways.md?toc=%2fazure%2fvirtual-network%2ftoc.json#planningtable).

> [!NOTE]
> В настоящее время ExpressRoute не является вариантом подключения к локальным ресурсам. Следует также отметить, что шлюз ExpressRoute, используемый описанным выше способом, не предназначается для подключения к локальной инфраструктуре.

### <a name="point-to-site-vpn"></a>VPN-подключение типа "точка — сеть"

Виртуальная частная сеть типа "точка — сеть" — это самая простая форма безопасного подключения к одной локальной конечной точке. Это может быть важно в том случае, если вы планируете использовать только одну рабочую станцию администрирования для выделенных устройств HSM на базе Azure.

### <a name="site-to-site-vpn"></a>VPN-подключение "сеть-сеть"

Виртуальная частная сеть типа "сеть — сеть" обеспечивает безопасный обмен данными между выделенными устройствами HSM на платформе Azure и локальными ИТ-ресурсами. Причиной этого является наличие средства резервного копирования для локального модуля HSM и необходимость подключения между ними для запуска резервного копирования.

## <a name="connecting-virtual-networks"></a>Подключение виртуальных сетей

Типичная архитектура развертывания для выделенного HSM запускается с одной виртуальной сетью и соответствующей подсетью, в которой создаются и подготавливаются устройства HSM. В том же регионе также могут быть дополнительные виртуальные сети и подсети для компонентов приложения, которые используют выделенное устройство HSM. Чтобы обеспечить обмен данными между этими сетями, мы используем пиринг между виртуальными сетями.

### <a name="virtual-network-peering"></a>Пиринг между виртуальными сетями

При наличии нескольких виртуальных сетей в пределах региона, которым необходим доступ к ресурсам друг друга, пиринг между виртуальными сетями можно использовать для создания каналов безопасного обмена данными между ними.  Пиринг между виртуальными сетями обеспечивает не только безопасные подключения, но и низкую задержку с высокой пропускной способностью соединений между ресурсами в Azure.

![Пиринг сетей](media/networking/peering.png)

## <a name="connecting-across-azure-regions"></a>Подключение между регионами Azure

Устройства HSM могут с помощью библиотек программного обеспечения перенаправить трафик на альтернативное устройство HSM. Перенаправление трафика полезно в том случае, если устройства отказали или доступ к устройству потерян. Сценарии сбоя на региональном уровне можно смягчить, развертывая HSM в других регионах и включая обмен данными между виртуальными сетями в разных регионах.

### <a name="cross-region-ha-using-vpn-gateway"></a>Высокий уровень доступности с использованием VPN-шлюза для регионов

Для глобально распределенных приложений или сценариев региональной отработки отказа с обеспечением высокого уровня доступности необходимо подключить виртуальные сети, находящиеся в разных регионах. Благодаря выделенному устройству HSM Azure можно добиться высокого уровня доступности с помощью VPN-шлюза, обеспечивающего безопасный туннель между двумя виртуальными сетями. Дополнительные сведения о подключениях между виртуальными сетями с помощью VPN-шлюза см. в статье [Что такое VPN-шлюз](../vpn-gateway/design.md#V2V).

> [!NOTE]
> На данный момент глобальный пиринг между виртуальными сетями недоступен в сценариях с возможностью межрегионального подключения с помощью выделенных HSM, вместо него следует использовать VPN-шлюз. 

![На схеме показаны два региона, Соединенных двумя шлюзами V P N. Каждый регион содержит одноранговые виртуальные сети.](media/networking/global-vnet.png)

## <a name="networking-restrictions"></a>Ограничения сети
> [!NOTE]
> Ограничение выделенной службы HSM с помощью делегирования подсети является назначением ограничений, которые следует учитывать при проектировании целевой сетевой архитектуры для развертывания HSM. Использование делегирования подсети означает, что группы безопасности сети, определяемые пользователем маршруты и пиринг глобальной виртуальной сети не поддерживаются для выделенного HSM. В разделах ниже приводятся сведения о других методах, позволяющих добиться того же или аналогичного результата для этих возможностей. 

Сетевой адаптер HSM, который находится в выделенной виртуальной сети HSM, не может использовать группы безопасности сети или определяемые пользователем маршруты. Это означает, что невозможно установить политики запрета по умолчанию с точки зрения выделенной виртуальной сети HSM, и что другие сегменты сети должны быть алловлистед для получения доступа к выделенной службе HSM. 

Добавление решения прокси-сервера "Сетевые виртуальные устройства" (NVA) также позволяет логически размещать брандмауэр NVA в центре транзитного или DMZ перед сетевым адаптером HSM, тем самым предоставляя необходимую альтернативу для группы безопасности сети и определяемые пользователем маршруты.

### <a name="solution-architecture"></a>Архитектура решения
Для этой структуры сети требуются следующие элементы:
1.  Транзитная виртуальная сеть центра DMZ с уровнем прокси-сервера NVA. В идеале есть два или более NVA. 
2.  Канал ExpressRoute с включенным частным пирингом и подключением к виртуальной сети транзитного концентратора.
3.  Пиринг виртуальной сети между транзитной виртуальной сетью концентратора и выделенной виртуальной сетью HSM.
4.  В качестве варианта можно развернуть брандмауэр NVA или брандмауэр Azure, предлагающий службы DMZ в центре. 
5.  Дополнительные периферийные серверы рабочей нагрузки виртуальных сетей могут быть соединены с виртуальной сетью концентратора. Клиент Gemalto может получить доступ к выделенной службе HSM через виртуальную сеть концентратора.

![На схеме показана виртуальная сеть центра DMZ с уровнем прокси-сервера NVA для решения NSG и UDR.](media/networking/network-architecture.png)

Так как добавление NVA прокси-сервера также позволяет логически размещать брандмауэр NVA в центре транзитного/DMZ перед сетевым адаптером HSM, предоставляя необходимые политики запрета по умолчанию. В нашем примере мы будем использовать брандмауэр Azure для этой цели и потребуются следующие элементы:
1. Брандмауэр Azure, развернутый в подсети «Азурефиреваллсубнет» в виртуальной сети DMZ Hub.
2. Таблица маршрутизации с UDR, которая направляет трафик в частную конечную точку ILB Azure в брандмауэр Azure. Эта таблица маршрутизации будет применена к GatewaySubnet, где размещен виртуальный шлюз ExpressRoute клиента.
3. Правила сетевой безопасности в Азурефиревалл, чтобы разрешить перенаправление между доверенным исходным диапазоном и частной конечной точкой ИБЛ Azure, прослушиваемой через TCP-порт 1792. Эта логика безопасности добавит необходимую политику "запретить по умолчанию" для выделенной службы HSM. Это означает, что выделенной службе HSM будут разрешены только доверенные диапазоны IP-адресов источника. Все остальные диапазоны будут удалены.  
4. Таблица маршрутизации с UDR, которая направляет трафик в локальную систему в брандмауэре Azure. Эта таблица маршрутизации будет применена к подсети прокси-сервера NVA. 
5. NSG, применяемый к подсети NVA прокси-сервера, чтобы доверять только диапазону подсети брандмауэра Azure в качестве источника и разрешить перенаправление на IP-адрес сетевого адаптера HSM через порт TCP 1792. 

> [!NOTE]
> Поскольку уровень прокси-сервера NVA будет решать, что IP-адрес клиента при пересылке на сетевой адаптер HSM не требуется, определяемые пользователем маршруты между виртуальной сетью HSM и виртуальной сетью концентратора DMZ.  

### <a name="alternative-to-udrs"></a>Альтернатива определяемые пользователем маршруты
Решение уровня NVA, упомянутое выше, работает в качестве альтернативы определяемые пользователем маршруты. Обратите внимание на некоторые важные моменты.
1.  Преобразование сетевых адресов должно быть настроено в NVA, чтобы обеспечить правильную маршрутизацию трафика.
2. Клиентам следует отключить запись IP-адреса клиента в конфигурации HSM Luna, чтобы использовать ВНА для NAT. Ниже приведены команды, сервце в качестве примера.
```
Disable:
[hsm01] lunash:>ntls ipcheck disable
NTLS client source IP validation disabled
Command Result : 0 (Success)

Show:
[hsm01] lunash:>ntls ipcheck show
NTLS client source IP validation : Disable
Command Result : 0 (Success)
```
3.  Разверните определяемые пользователем маршруты для входящего трафика на уровне NVA. 
4. В зависимости от структуры подсети HSM не инициируют запрос на исходящий трафик к уровню платформы.

### <a name="alternative-to-using-global-vnet-peering"></a>Альтернатива использованию глобального Пиринг виртуальных сетей
Существует несколько архитектур, которые можно использовать в качестве альтернативы глобальным пиринга виртуальной сети.
1.  Использование [подключения VPN-шлюза из виртуальной сети в](https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-vnet-vnet-resource-manager-portal) виртуальную сеть 
2.  Подключите HSM VNET с другой ВИРТУАЛЬНОЙ сетью с каналом ER. Это лучше, если требуется прямой локальный путь или VPN-Виртуальная сеть. 

#### <a name="hsm-with-direct-express-route-connectivity"></a>HSM с прямым подключением Express Route
![На схеме показан HSM с прямым подключением Express Route](media/networking/expressroute-connectivity.png)

## <a name="next-steps"></a>Дальнейшие шаги

- [Часто задаваемые вопросы по Аналитике компьютеров](faq.md)
- [Возможности поддержки](supportability.md)
- [Высокая доступность](high-availability.md)
- [Физическая безопасность](physical-security.md)
- [Мониторинг](monitoring.md)
- [Архитектура развертывания](deployment-architecture.md)
