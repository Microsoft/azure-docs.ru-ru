---
title: Управление моментальными снимками с помощью Azure NetApp Files | Документы Майкрософт
description: Описывает создание, управление и использование моментальных снимков с помощью Azure NetApp Files.
services: azure-netapp-files
documentationcenter: ''
author: b-juche
manager: ''
editor: ''
ms.assetid: ''
ms.service: azure-netapp-files
ms.workload: storage
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: how-to
ms.date: 02/20/2021
ms.author: b-juche
ms.openlocfilehash: a18c53d972fbb38dc0b0e557d14b2fbffbff15fa
ms.sourcegitcommit: 24a12d4692c4a4c97f6e31a5fbda971695c4cd68
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/05/2021
ms.locfileid: "102174365"
---
# <a name="manage-snapshots-by-using-azure-netapp-files"></a>Управление моментальными снимками с помощью Azure NetApp Files

Azure NetApp Files поддерживает создание моментальных снимков по запросу и использование политик моментальных снимков для планирования автоматического создания моментальных снимков. Можно также восстановить моментальный снимок на новый том, восстановить отдельный файл с помощью клиента или отменить существующий том с помощью моментального снимка.

> [!NOTE] 
> Рекомендации по управлению моментальными снимками в репликации между регионами см. в разделе [требования и рекомендации по использованию репликации между регионами](cross-region-replication-requirements-considerations.md).

## <a name="create-an-on-demand-snapshot-for-a-volume"></a>Создание моментального снимка по запросу для тома

Моментальные снимки томов можно создавать по запросу. 

1.  Перейдите к тому, для которого нужно создать моментальный снимок. Щелкните **моментальные снимки**.

    ![Переход к моментальным снимкам](../media/azure-netapp-files/azure-netapp-files-navigate-to-snapshots.png)

2.  Чтобы создать моментальный снимок по запросу для тома, щелкните **+ Добавить моментальный снимок**.

    ![Добавление моментального снимка](../media/azure-netapp-files/azure-netapp-files-add-snapshot.png)

3.  В окне "Создание моментального снимка" введите имя создаваемого моментального снимка.   

    ![Создание моментального снимка.](../media/azure-netapp-files/azure-netapp-files-new-snapshot.png)

4. Нажмите кнопку **ОК**. 

## <a name="manage-snapshot-policies"></a>Управление политиками моментальных снимков

Вы можете запланировать автоматическое создание моментальных снимков томов с помощью политик моментальных снимков. Кроме того, можно изменить политику моментальных снимков или удалить политику моментальных снимков, которая больше не нужна.  

### <a name="register-the-feature"></a>регистрация компонента

Функция **политики моментальных снимков** сейчас доступна в предварительной версии. Если эта функция используется впервые, ее необходимо сначала зарегистрировать. 

1. Зарегистрируйте функцию: 

    ```azurepowershell-interactive
    Register-AzProviderFeature -ProviderNamespace Microsoft.NetApp -FeatureName ANFSnapshotPolicy
    ```

2. Проверьте состояние регистрации компонента: 

    > [!NOTE]
    > **RegistrationState** может находиться в состоянии до `Registering` 60 минут до перехода на `Registered` . Прежде чем продолжить, подождите, пока состояние не будет **зарегистрировано** .

    ```azurepowershell-interactive
    Get-AzProviderFeature -ProviderNamespace Microsoft.NetApp -FeatureName ANFSnapshotPolicy
    ```
Вы также можете использовать [Azure CLI команды](/cli/azure/feature) `az feature register` , `az feature show` чтобы зарегистрировать эту функцию и отобразить состояние регистрации. 

### <a name="create-a-snapshot-policy"></a>Создание политики моментальных снимков 

Политика моментальных снимков позволяет указать частоту создания моментального снимка в ежечасном, ежедневном, еженедельном или ежемесячном цикле. Также необходимо указать максимальное число моментальных снимков, которые будут храниться в томе.  

1.  В представлении учетной записи NetApp щелкните **Политика моментальных снимков**.

    ![Навигация по политике моментальных снимков](../media/azure-netapp-files/snapshot-policy-navigation.png)

2.  В окне Политика моментальных снимков задайте для параметра Состояние политики значение **включено**. 

3.  Щелкните вкладку **ежечасно**, **ежедневно**, **еженедельно** или **ежемесячно** , чтобы создать почасовую, ежедневную, еженедельную или ежемесячную политику моментальных снимков. Укажите **число хранимых моментальных снимков**.  

    См. раздел [ограничения ресурсов для Azure NetApp Files](azure-netapp-files-resource-limits.md) о максимальном количестве моментальных снимков, разрешенных для тома. 

    В следующем примере показана конфигурация политики ежечасных моментальных снимков. 

    ![Политика моментальных снимков — ежечасно](../media/azure-netapp-files/snapshot-policy-hourly.png)

    В следующем примере показана ежедневная Настройка политики моментальных снимков.

    ![Ежедневная политика моментальных снимков](../media/azure-netapp-files/snapshot-policy-daily.png)

    В следующем примере показана еженедельная Настройка политики моментальных снимков.

    ![Политика моментальных снимков еженедельно](../media/azure-netapp-files/snapshot-policy-weekly.png)

    В следующем примере показана ежемесячная Настройка политики моментальных снимков.

    ![Политика моментальных снимков ежемесячно](../media/azure-netapp-files/snapshot-policy-monthly.png) 

4.  Выберите команду **Сохранить**.  

Если необходимо создать дополнительные политики моментальных снимков, повторите шаг 3.
Созданные политики отображаются на странице Политика моментальных снимков.

Если требуется, чтобы том использовал политику моментальных снимков, необходимо [Применить политику к тому](azure-netapp-files-manage-snapshots.md#apply-a-snapshot-policy-to-a-volume). 

### <a name="apply-a-snapshot-policy-to-a-volume"></a>Применение политики моментальных снимков к тому

Если вы хотите, чтобы том использовал созданную политику моментальных снимков, необходимо применить политику к тому. 

Вы не можете применить политику моментальных снимков к целевому тому в репликации между регионами.  

1.  Перейдите на страницу **тома** , щелкните правой кнопкой мыши том, к которому требуется применить политику моментальных снимков, и выберите пункт **изменить**.

    ![Меню "тома" щелкните правой кнопкой мыши](../media/azure-netapp-files/volume-right-cick-menu.png) 

2.  В окне редактирования в разделе **Политика моментальных снимков** выберите политику, которая будет использоваться для тома.  Нажмите кнопку **ОК** , чтобы применить политику.  

    ![Изменение политики моментальных снимков](../media/azure-netapp-files/snapshot-policy-edit.png) 

### <a name="modify-a-snapshot-policy"></a>Изменение политики моментальных снимков 

Можно изменить существующую политику моментальных снимков, чтобы изменить состояние политики, периодичность моментальных снимков (ежечасно, ежедневно, еженедельно или ежемесячно) или число моментальных снимков.  
 
1.  В представлении учетной записи NetApp щелкните **Политика моментальных снимков**.

2.  Щелкните правой кнопкой мыши политику моментальных снимков, которую необходимо изменить, и выберите **изменить**.

    ![Меню "политика моментальных снимков" щелкните правой кнопкой мыши](../media/azure-netapp-files/snapshot-policy-right-click-menu.png) 

3.  Внесите изменения в появившемся окне Политика моментальных снимков, а затем нажмите кнопку **сохранить**. 

### <a name="delete-a-snapshot-policy"></a>Удаление политики моментальных снимков 

Вы можете удалить политику моментальных снимков, которую больше не нужно поддерживать.   

1.  В представлении учетной записи NetApp щелкните **Политика моментальных снимков**.

2.  Щелкните правой кнопкой мыши политику моментальных снимков, которую необходимо изменить, а затем выберите **Удалить**.

    ![Меню "политика моментальных снимков" щелкните правой кнопкой мыши](../media/azure-netapp-files/snapshot-policy-right-click-menu.png) 

3.  Нажмите кнопку **Да** , чтобы подтвердить удаление политики моментальных снимков.   

    ![Подтверждение удаления политики моментальных снимков](../media/azure-netapp-files/snapshot-policy-delete-confirm.png) 

## <a name="edit-the-hide-snapshot-path-option"></a>Изменение параметра "скрыть путь к снимку"
Параметр Скрыть путь к снимку определяет, виден ли путь к моментальному снимку тома. Во время создания тома [NFS](azure-netapp-files-create-volumes.md#create-an-nfs-volume) или [SMB](azure-netapp-files-create-volumes-smb.md#add-an-smb-volume) можно указать, следует ли скрывать путь моментального снимка. При необходимости можно изменить параметр Скрыть путь к снимку.  

> [!NOTE]
> Для [целевого тома](cross-region-replication-create-peering.md#create-the-data-replication-volume-the-destination-volume) в репликации между регионами параметр Скрыть путь к моментальному снимку включен по умолчанию, и этот параметр нельзя изменить. 

1. Чтобы просмотреть параметр параметра Скрыть путь к снимку тома, выберите том. Поле **Скрыть путь к снимку** показывает, включен ли параметр.   
    ![Снимок экрана, описывающий поле "скрыть путь к снимку".](../media/azure-netapp-files/hide-snapshot-path-field.png) 
2. Чтобы изменить параметр Скрыть путь к моментальному снимку, щелкните **изменить** на странице громкость и при необходимости измените параметр **Скрыть путь к снимку** .   
    ![Снимок экрана, описывающий параметр "изменить моментальный снимок тома".](../media/azure-netapp-files/volume-edit-snapshot-options.png) 

## <a name="restore-a-snapshot-to-a-new-volume"></a>Восстановление моментального снимка в новый том

Сейчас моментальный снимок можно восстановить только в новый том. 
1. В колонке "том" выберите " **моментальные снимки** ", чтобы отобразить список моментальных снимков. 
2. Щелкните правой кнопкой мыши моментальный снимок, который необходимо восстановить, и выберите пункт **восстановить в новый том** в меню.  

    ![Восстановление моментального снимка в новый том](../media/azure-netapp-files/azure-netapp-files-snapshot-restore-to-new-volume.png)

3. В окне Создание тома введите сведения для нового тома:  
    * **Name**   
        Укажите имя создаваемого тома.  
        
        Имя должно быть уникальным в пределах группы ресурсов. Длина имени должна быть не менее трех знаков.  Имя может состоять из любых алфавитно-цифровых символов.

    * **Квота**  
        Укажите объем логического хранилища, который необходимо выделить для тома.  

    ![Восстановить в новый том](../media/azure-netapp-files/snapshot-restore-new-volume.png) 

4. Щелкните **проверить и создать**.  Нажмите кнопку **Создать**.   
    Новый том использует тот же протокол, который используется моментальным снимком.   
    Новый том, на котором восстанавливается моментальный снимок, отображается в колонке "Тома".

## <a name="restore-a-file-from-a-snapshot-using-a-client"></a>Восстановление файла из моментального снимка с помощью клиента

Если вы не хотите [восстанавливать весь моментальный снимок на том](#restore-a-snapshot-to-a-new-volume), можно восстановить файл из моментального снимка с помощью клиента, подключенного к тому.  

Подключенный том содержит каталог моментальных снимков с именем  `.snapshot` (в NFS-клиентах) или `~snapshot` (в клиентах SMB), доступный клиенту. Каталог моментальных снимков содержит подкаталоги, соответствующие моментальным снимкам тома. Каждый подкаталог содержит файлы моментального снимка. Если вы случайно удалили или перезаписали файл, можно восстановить его в родительском каталоге, доступном для чтения и записи, скопировав файл из подкаталога моментальных снимков в каталог, доступный для чтения и записи. 

С помощью [параметра Скрыть путь к снимку](#edit-the-hide-snapshot-path-option)можно управлять доступом к каталогам моментальных снимков. Этот параметр определяет, должен ли каталог быть скрытым от клиентов. Таким образом, он также управляет доступом к файлам и папкам в моментальных снимках.  

Нфсв 4.1 не показывает `.snapshot` Каталог ( `ls -la` ). Однако если параметр Скрыть путь к снимку не установлен, доступ к каталогу по-прежнему можно получить `.snapshot` через нфсв 4.1 с помощью `cd <snapshot-path>` команды из командной строки клиента. 

### <a name="restore-a-file-by-using-a-linux-nfs-client"></a>Восстановление файла с помощью клиента NFS Linux 

1. Используйте `ls` команду Linux, чтобы получить список файлов, которые требуется восстановить из `.snapshot` каталога. 

    Пример:

    `$ ls my.txt`   
    `ls: my.txt: No such file or directory`   

    `$ ls .snapshot`   
    `daily.2020-05-14_0013/              hourly.2020-05-15_1106/`   
    `daily.2020-05-15_0012/              hourly.2020-05-15_1206/`   
    `hourly.2020-05-15_1006/             hourly.2020-05-15_1306/`   

    `$ ls .snapshot/hourly.2020-05-15_1306/my.txt`   
    `my.txt`

2. Используйте `cp` команду, чтобы скопировать файл в родительский каталог.  

    Пример: 

    `$ cp .snapshot/hourly.2020-05-15_1306/my.txt .`   

    `$ ls my.txt`   
    `my.txt`   

### <a name="restore-a-file-by-using-a-windows-client"></a>Восстановление файла с помощью клиента Windows 

1. Если `~snapshot` каталог тома скрыт, отобразите [скрытые элементы](https://support.microsoft.com/help/4028316/windows-view-hidden-files-and-folders-in-windows-10) в родительском каталоге `~snapshot` .

    ![Отображение скрытых элементов](../media/azure-netapp-files/snapshot-show-hidden.png) 

2. Перейдите к подкаталогу в, `~snapshot` чтобы найти файл, который нужно восстановить.  Щелкните файл правой кнопкой мыши. Нажмите **Копировать**.  

    ![Копировать файл для восстановления](../media/azure-netapp-files/snapshot-copy-file-restore.png) 

3. Вернитесь к родительскому каталогу. Щелкните правой кнопкой мыши родительский каталог и выберите команду `Paste` , чтобы вставить файл в каталог.

    ![Вставить файл для восстановления](../media/azure-netapp-files/snapshot-paste-file-restore.png) 

4. Можно также щелкнуть правой кнопкой мыши родительский каталог, выбрать пункт **Свойства**, щелкнуть вкладку **предыдущие версии** , чтобы просмотреть список моментальных снимков, и выбрать **восстановить** для восстановления файла.  

    ![Свойства предыдущих версий](../media/azure-netapp-files/snapshot-properties-previous-version.png) 

## <a name="revert-a-volume-using-snapshot-revert"></a>Отмена изменений тома с помощью отката моментального снимка

Функция отмены изменений моментальных снимков позволяет быстро вернуть том в состояние, в котором он находился при создании определенного моментального снимка. В большинстве случаев отмена изменений для тома выполняется гораздо быстрее, чем восстановление отдельных файлов из моментального снимка в активную файловую систему. Эта функция также позволяет сэкономить больше пространства по сравнению с восстановлением моментального снимка на новый том. 

Параметр восстановить том можно найти в меню моментальные снимки тома. После выбора моментального снимка для изменения версии Azure NetApp Files отменяет том до данных и отметок времени, которые он содержал при создании выбранного снимка. 

> [!IMPORTANT]
> Данные активной файловой системы и моментальные снимки, созданные после создания выбранного снимка, будут потеряны. Операция отката моментального снимка заменит *все* данные в целевом томе данными из выбранного моментального снимка. При выборе моментального снимка необходимо обратить внимание на содержимое моментального снимка и дату создания. Отменить операцию отмены изменений моментального снимка нельзя.

1. Перейдите в меню " **моментальные снимки** " тома.  Щелкните правой кнопкой мыши моментальный снимок, который вы хотите использовать для операции отката. Выберите **восстановить том**. 

    ![Снимок экрана, посвященный контекстному меню моментального снимка](../media/azure-netapp-files/snapshot-right-click-menu.png) 

2. В окне Восстановление тома в снимок введите имя тома и нажмите кнопку **отменить**.   

    Теперь том восстановлен до момента времени выбранного снимка.

    ![Снимок экрана: восстановление тома в снимок окна](../media/azure-netapp-files/snapshot-revert-volume.png) 

## <a name="delete-snapshots"></a>Удаление моментальных снимков  

Вы можете удалить моментальные снимки, которые больше не нужно поддерживать. 

> [!IMPORTANT]
> Невозможно отменить операцию удаления моментальных снимков. Невозможно восстановить удаленный моментальный снимок. 

1. Перейдите в меню " **моментальные снимки** " тома. Щелкните правой кнопкой мыши моментальный снимок, который нужно удалить. Выберите команду **Удалить**.

    ![Снимок экрана, посвященный контекстному меню моментального снимка](../media/azure-netapp-files/snapshot-right-click-menu.png) 

2. В окне Удаление моментального снимка подтвердите удаление моментального снимка, нажав кнопку **Да**. 

    ![Снимок экрана, подтверждающий удаление моментального снимка](../media/azure-netapp-files/snapshot-confirm-delete.png)  

## <a name="next-steps"></a>Дальнейшие действия

* [Устранение неполадок с политиками моментальных снимков](troubleshoot-snapshot-policies.md)
* [Ограничения ресурсов для службы Azure NetApp Files](azure-netapp-files-resource-limits.md)
* [Видео о Azure NetApp Filesных моментальных снимках 101](https://www.youtube.com/watch?v=uxbTXhtXCkw&feature=youtu.be)
* [Что такое средство создания моментальных снимков, согласованных с приложениями Azure](azacsnap-introduction.md)
