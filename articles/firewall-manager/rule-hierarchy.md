---
title: Использование политики брандмауэра Azure для определения иерархии правил
description: Узнайте, как использовать политику брандмауэра Azure для определения иерархии правил и обеспечения соответствия.
services: firewall-manager
author: vhorne
ms.service: firewall-manager
ms.topic: how-to
ms.date: 08/26/2020
ms.author: victorh
ms.openlocfilehash: 1ba683e3d616f52854f1055dab9b9fe2d389116a
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "92331742"
---
# <a name="use-azure-firewall-policy-to-define-a-rule-hierarchy"></a>Использование политики брандмауэра Azure для определения иерархии правил

Администраторам безопасности необходимо управлять брандмауэрами и обеспечить соответствие локальным и облачным развертываниям. Ключевой компонент — это возможность предоставлять группам приложений гибкие возможности для реализации конвейеров CI/CD для автоматического создания правил брандмауэра.

Политика брандмауэра Azure позволяет определить иерархию правил и обеспечить соответствие требованиям.

- Предоставляет иерархическую структуру для наложения Центральной основной политики поверх политики группы дочерних приложений. Базовая политика имеет более высокий приоритет и выполняется перед дочерней политикой.
- Используйте определение пользовательской роли Azure, чтобы предотвратить случайное удаление базовой политики и предоставить избирательный доступ к группам коллекций правил в подписке или группе ресурсов. 

## <a name="solution-overview"></a>Обзор решения

Ниже приведены общие действия для этого примера.

1. Создайте базовую политику брандмауэра в группе ресурсов группы безопасности. 
3. Определите правила безопасности в базовой политике. Это добавляет общий набор правил для разрешения или запрета трафика.
4. Создание политик группы приложений, которые наследуют базовую политику. 
5. Определение правил для конкретной группы приложений в политике. Можно также перенести правила из уже существующих брандмауэров.
6. Создайте Azure Active Directory пользовательские роли, чтобы обеспечить детальный доступ к группе сбора правил и добавить роли в области политики брандмауэра. В следующем примере участники группы продаж могут изменять группы коллекции правил для политики брандмауэра группы продаж. То же самое относится к базам данных и инженерам отдела.
7. Свяжите политику с соответствующим брандмауэром. Брандмауэр Azure может иметь только одну назначенную политику. Для этого каждая группа приложений должна иметь собственный брандмауэр.



:::image type="content" source="media/rule-hierarchy/contoso-teams.png" alt-text="Группы и требования" border="false":::

### <a name="create-the-firewall-policies"></a>Создание политик брандмауэра

- Базовая политика брандмауэра.

Создайте политики для каждой группы приложений:

- Политика брандмауэра продаж. Политика брандмауэра продаж наследует базовую политику брандмауэра.
- Политика брандмауэра базы данных. Политика брандмауэра базы данных наследует политику базового брандмауэра.
- Политика инженерного брандмауэра. Политика брандмауэра для инженеров также наследует базовую политику брандмауэра.

:::image type="content" source="media/rule-hierarchy/policy-hierarchy.png" alt-text="Иерархия политик" border="false":::

### <a name="create-custom-roles-to-access-the-rule-collection-groups"></a>Создание пользовательских ролей для доступа к группам коллекции правил 

Пользовательские роли определяются для каждой группы разработчиков приложений. Роль определяет операции и область. Группа разработчиков приложений может изменять группы коллекций правил для соответствующих приложений.

Для определения пользовательских ролей используйте следующую процедуру высокого уровня:

1. Получить подписку:

   `Select-AzSubscription -SubscriptionId xxxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxxxx`
2. Выполните следующую команду.

   `Get-AzProviderOperation "Microsoft.Support/*" | FT Operation, Description -AutoSize`
3. Используйте команду Get-AzRoleDefinition, чтобы вывести роль модуля чтения в формате JSON. 

   `Get-AzRoleDefinition -Name "Reader" | ConvertTo-Json | Out-File C:\CustomRoles\ReaderSupportRole.json`
4. Откройте файл ReaderSupportRole.jsв редакторе.

   Ниже приведены выходные данные JSON. Дополнительные сведения о различных свойствах см. в статье [пользовательские роли Azure](../role-based-access-control/custom-roles.md).

```json
   { 
     "Name": "Reader", 
     "Id": "acdd72a7-3385-48ef-bd42-f606fba81ae7", 
     "IsCustom": false, 
     "Description": "Lets you view everything, but not make any changes.", 
     "Actions": [ 
      "*/read" 
     ], 
     "NotActions": [], 
     "DataActions": [], 
     "NotDataActions": [], 
     "AssignableScopes": [ 
       "/" 
     ] 
   } 
```
5. Измените файл JSON, чтобы добавить 

   `*/read", "Microsoft.Network/*/read", "Microsoft.Network/firewallPolicies/ruleCollectionGroups/write` 

   Операция к свойству **Actions**   . Не забудьте включить запятую после операции чтения. Это действие позволяет пользователю создавать и обновлять группы коллекций правил.
6. В **AssignableScopes** добавьте идентификатор подписки в следующем формате: 

   `/subscriptions/xxxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxxxx`

   Вам нужно добавить явные идентификаторы подписки, иначе вы не сможете импортировать роль в подписку.
7. Удалите ****   строку свойства ID и измените значение свойства **Custom**   на true.
8. Измените свойства  **имя**   и  **Описание**   на *Азфм автор группы сбора правил* , и *Пользователи этой роли могут изменить группы коллекции правил политики брандмауэра* .

Файл JSON должен выглядеть, как в следующем примере:

```
{ 

    "Name":  "AZFM Rule Collection Group Author", 
    "IsCustom":  true, 
    "Description":  "Users in this role can edit Firewall Policy rule collection groups", 
    "Actions":  [ 
                    "*/read", 
                    "Microsoft.Network/*/read", 
                     "Microsoft.Network/firewallPolicies/ruleCollectionGroups/write" 
                ], 
    "NotActions":  [ 
                   ], 
    "DataActions":  [ 
                    ], 
    "NotDataActions":  [ 
                       ], 
    "AssignableScopes":  [ 
                             "/subscriptions/xxxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxxxx"] 
} 
```
9. Чтобы создать новую настраиваемую роль, используйте команду New-AzRoleDefinition и укажите файл определения роли JSON. 

   `New-AzRoleDefinition -InputFile "C:\CustomRoles\RuleCollectionGroupRole.json`

### <a name="list-custom-roles"></a>Вывод списка настраиваемых ролей

Чтобы получить список всех пользовательских ролей, можно использовать команду Get-AzRoleDefinition.

   `Get-AzRoleDefinition | ? {$_.IsCustom -eq $true} | FT Name, IsCustom`

Пользовательские роли также можно просмотреть в портал Azure. Перейдите к своей подписке, выберите **Управление доступом (IAM)**, **роли**.

:::image type="content" source="media/rule-hierarchy/sales-app-policy.png" alt-text="салесаппполици":::

:::image type="content" source="media/rule-hierarchy/sales-app-policy-read.png" alt-text="Разрешение на чтение Салесаппполици":::

Дополнительные сведения см. в разделе [учебник. Создание настраиваемой роли Azure с помощью Azure PowerShell](../role-based-access-control/tutorial-custom-role-powershell.md).

### <a name="add-users-to-the-custom-role"></a>Добавление пользователей в пользовательскую роль

На портале можно добавить пользователей в роль авторов группы коллекции правил АЗФМ и предоставить доступ к политикам брандмауэра.

1. На портале выберите политику брандмауэра группы приложений (например, Салесаппполици).
2. Выберите **Управление доступом**.
3. Выберите **Добавить назначение ролей**.
4. Добавление пользователей и групп пользователей (например, группы продаж) к роли.

Повторите эту процедуру для других политик брандмауэра.

### <a name="summary"></a>Итоги

Политика брандмауэра с пользовательскими ролями теперь предоставляет избирательный доступ к группам коллекции правил политики брандмауэра.

У пользователей нет разрешений на:
- Удалите брандмауэр Azure или политику брандмауэра.
- Обновите иерархию политики брандмауэра или параметры DNS или аналитику угроз.
- Обновите политику брандмауэра, если она не является членом группы "Автор" группы АЗФМ Rules.

Администраторы безопасности могут использовать базовую политику для принудительного применения снятие и блокировать определенные типы трафика (например, ICMP) в соответствии с требованиями Организации. 

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о [политике брандмауэра Azure](policy-overview.md).

