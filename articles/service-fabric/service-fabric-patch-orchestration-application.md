---
title: Установка исправлений операционной системы Windows в кластере Service Fabric
description: В этой статье описывается, как автоматизировать установку исправлений операционной системы в кластере Service Fabric с помощью приложения для управления исправлениями.
services: service-fabric
documentationcenter: .net
author: athinanthny
manager: chackdan
editor: ''
ms.assetid: de7dacf5-4038-434a-a265-5d0de80a9b1d
ms.service: service-fabric
ms.devlang: dotnet
ms.topic: conceptual
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 2/01/2019
ms.author: atsenthi
ms.openlocfilehash: 7d52d49ab5d3a47dd69fdc1708f9e52f4f796a92
ms.sourcegitcommit: d4734bc680ea221ea80fdea67859d6d32241aefc
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/14/2021
ms.locfileid: "100390646"
---
# <a name="patch-the-windows-operating-system-in-your-service-fabric-cluster"></a>Установка исправлений операционной системы Windows в кластере Service Fabric

> [!IMPORTANT]
> С 30 апреля 2019 г. приложение для управления исправлениями версии 1,2. * больше не поддерживается. Не забудьте выполнить обновление до последней версии. Обновления виртуальных машин, в которых "Центр обновления Windows" применяет исправления операционной системы без замены диска ОС, не поддерживаются. 

> [!NOTE]
> Получение [автоматических обновлений образов ОС в масштабируемом наборе виртуальных машин](../virtual-machine-scale-sets/virtual-machine-scale-sets-automatic-upgrade.md) — это рекомендуемый способ обновления операционной системы в Azure. Для автоматического обновления образов ОС на основе масштабируемого набора виртуальных машин потребуется Серебряная или более надежная устойчивость масштабируемого набора. Для типов узлов с бронзовым уровнем устойчивости это не поддерживается, в данном случае используйте приложение для управления исправлениями.

Приложение для управления исправлениями (ВЕХ) — это оболочка для службы Диспетчер восстановления Azure Service Fabric, которая позволяет планировать исправления ОС на основе конфигурации для кластеров, не относящихся к Azure. ВЕХ не требуется для кластеров, размещенных не в Azure, но для обновления Service Fabric узлов кластера без простоев требуется установка исправлений по домену обновления.

ВЕХ — это Service Fabric приложение, которое автоматизирует установку исправлений операционной системы в кластере Service Fabric без простоев.

ВЕХ предоставляет следующие возможности.

- **Автоматическая установка обновлений операционной системы**. Обновления операционной системы автоматически загружаются и устанавливаются. Узлы кластера перезапускаются по мере необходимости без простоя кластера.

- **Исправление с учетом состояния кластера и интеграция функций работоспособности**. Хотя ВЕХ применяется для обновления, он отслеживает работоспособность узлов кластера. Узлы кластера обновляются по одному узлу за раз или по одному домену обновления за раз. Если работоспособность кластера выходит из строя из-за процесса исправления, установка исправлений останавливается, чтобы предотвратить усугублялась проблемы.

## <a name="internal-details-of-poa"></a>Внутренние сведения о ВЕХ

ВЕХ состоит из следующих подкомпонентов:

- **Служба координатора** — эта служба с отслеживанием состояния отвечает за следующие задачи:
    - координация задания обновления Windows во всем кластере;
    - хранение результатов завершенных операций обновления Windows.

- **Служба агента узла** — это служба без отслеживания состояния, которая выполняется на всех узлах кластера Service Fabric. Она отвечает за следующие задачи:
    - начальная загрузка NTService агента узла;
    - мониторинг службы NTService агента узла.

- **Служба NTService агента узла** — служба Windows NT, которая выполняется с разрешением высокого уровня (СИСТЕМА). Для сравнения служба агента узла и служба координатора выполняются с разрешением более низкого уровня (СЕТЕВАЯ СЛУЖБА). Служба отвечает за выполнение следующих заданий обновления Windows на всех узлах кластера:
    - Отключение автоматических обновлений Windows на узле.
    - Загрузка и установка обновлений Windows в соответствии с политикой, предоставленной пользователем.
    - Перезагрузка компьютера после установки обновлений Windows.
    - передача результатов обновления Windows в службу координатора;
    - Отчеты о работоспособности, если операция завершилась сбоем после исчерпания всех повторных попыток.

> [!NOTE]
> ВЕХ использует службу Service Fabric Диспетчер восстановления, чтобы отключить или включить узел и выполнить проверки работоспособности. Задача восстановления, созданная ВЕХ, отслеживает ход выполнения Центр обновления Windows для каждого узла.

## <a name="prerequisites"></a>Предварительные требования

> [!NOTE]
> Требуемая минимальная версия платформа .NET Framework — 4,6.

### <a name="enable-the-repair-manager-service-if-its-not-running-already"></a>Включение службы Диспетчер восстановления (если она еще не запущена)

Для ВЕХ требуется, чтобы служба Диспетчер восстановления была включена в кластере.

#### <a name="azure-clusters"></a>Кластеры Azure

Для кластеров Azure на уровне "Серебряная устойчивость" по умолчанию включена служба Диспетчер восстановления. В кластерах Azure на уровне устойчивости Gold может быть или не включена служба Диспетчер восстановления, в зависимости от того, когда эти кластеры были созданы. Для кластеров Azure на уровне бронзовой устойчивости по умолчанию служба Диспетчер восстановления не включена. Если служба уже включена, ее можно увидеть в разделе "системные службы" в Service Fabric Explorer.

##### <a name="the-azure-portal"></a>Портал Azure
Вы можете включить Диспетчер восстановления из портал Azure при настройке кластера. При настройке кластера выберите параметр **включить Диспетчер восстановления** в разделе **Дополнительные компоненты**.

![Изображение включения Диспетчер восстановления из портал Azure](media/service-fabric-patch-orchestration-application/EnableRepairManager.png)

##### <a name="the-azure-resource-manager-deployment-model"></a>Модель развертывания Azure Resource Manager
Кроме того, можно использовать [модель развертывания Azure Resource Manager](./service-fabric-cluster-creation-via-arm.md) для включения службы Диспетчер восстановления на новых и существующих кластерах Service Fabric. Получите шаблон для кластера, который требуется развернуть. Можно использовать примеры шаблонов или создать пользовательский шаблон модели развертывания Azure Resource Manager. 

Чтобы включить службу Диспетчер восстановления с помощью [шаблона модели развертывания Azure Resource Manager](./service-fabric-cluster-creation-via-arm.md), выполните следующие действия.

1. Убедитесь, что для `apiVersion` ресурса *Microsoft. ServiceFabric/Clusters* установлено значение *2017-07-01-Preview* . Если это не так, необходимо выполнить обновление `apiVersion` до *2017-07-01-Preview* или более поздней версии.

    ```json
    {
        "apiVersion": "2017-07-01-preview",
        "type": "Microsoft.ServiceFabric/clusters",
        "name": "[parameters('clusterName')]",
        "location": "[parameters('clusterLocation')]",
        ...
    }
    ```

1. Включите службу Диспетчер восстановления, добавив следующий `addonFeatures` раздел после `fabricSettings` раздела:

    ```json
    "fabricSettings": [
        ...      
    ],
    "addonFeatures": [
        "RepairManager"
    ],
    ```

3. После обновления шаблона кластера примените эти изменения и добавим обновление. Теперь вы можете увидеть службу Диспетчер восстановления, работающую в кластере. Он называется *Fabric:/System/репаирманажерсервице* в разделе системных служб Service Fabric Explorer. 

### <a name="standalone-on-premises-clusters"></a>Автономные локальные кластеры

Чтобы включить Диспетчер восстановленияную службу в новом или существующем кластере Service Fabric, можно использовать [Параметры конфигурации для изолированного кластера Windows](./service-fabric-cluster-manifest.md).

Чтобы включить службу Диспетчер восстановления, выполните следующие действия.

1. Убедитесь, что `apiVersion` в разделе [Общие конфигурации кластера](./service-fabric-cluster-manifest.md#general-cluster-configurations) установлено значение *04-2017* или более поздняя версия, как показано ниже:

    ```json
    {
        "name": "SampleCluster",
        "clusterConfigurationVersion": "1.0.0",
        "apiVersion": "04-2017",
        ...
    }
    ```

1. Включите службу Диспетчер восстановления, добавив следующий `addonFeatures` раздел после `fabricSettings` раздела, как показано ниже:

    ```json
    "fabricSettings": [
        ...      
    ],
    "addonFeatures": [
        "RepairManager"
    ],
    ```

1. Обновите манифест кластера с помощью этих изменений, используя обновленный манифест кластера. [Создайте новый кластер](./service-fabric-cluster-creation-for-windows-server.md) или [Обновите конфигурацию кластера](./service-fabric-cluster-upgrade-windows-server.md). 

   После того как кластер будет работать с обновленным манифестом кластера, вы увидите службу Диспетчер восстановления, работающую в кластере. Он называется *Fabric:/System/репаирманажерсервице* и находится в разделе Системные службы в Service Fabric Explorer.

### <a name="configure-windows-updates-for-all-nodes"></a>Настройка обновлений Windows для всех узлов

Автоматическое обновление Windows может привести к утрате доступности, так как несколько узлов кластера могут перезапускаться одновременно. По умолчанию ВЕХ пытается отключить автоматические обновления Windows на каждом узле кластера. Однако если параметры управляются администратором или групповая политика, рекомендуется явно задать для политики Центр обновления Windows значение "уведомлять перед загрузкой".

## <a name="download-the-application-package"></a>Скачивание пакета приложения

Чтобы скачать пакет приложения, перейдите на [страницу выпуска приложения для управления исправлениями](https://github.com/microsoft/Service-Fabric-POA/releases/latest/) на сайте GitHub.

## <a name="configure-poa-behavior"></a>Настройка поведения ВЕХ

Вы можете настроить поведение ВЕХ в соответствии с вашими потребностями. Переопределите значения по умолчанию, передав параметр приложения во время создания или обновления приложения. Вы можете указать параметры приложения, указав `ApplicationParameter` `Start-ServiceFabricApplicationUpgrade` `New-ServiceFabricApplication` командлеты или.

| Параметр        | Тип                          | Сведения |
|:-|-|-|
|MaxResultsToCache    |Long                              | Максимальное количество Центр обновления Windows результатов, которые должны быть кэшированы. <br><br>Значение по умолчанию — 3000, предполагая, что: <br> &nbsp;&nbsp;— Количество узлов равно 20. <br> &nbsp;&nbsp;— Количество обновлений узла в месяц — 5. <br> &nbsp;&nbsp;— Количество результатов на операцию может быть равно 10. <br> &nbsp;&nbsp;— Должны храниться результаты за последние три месяца. |
|TaskApprovalPolicy   |Перечисление. <br> { NodeWise, UpgradeDomainWise }                          |TaskApprovalPolicy указывает политику, которая будет использоваться службой координатора для установки обновлений Windows на узлы кластера Service Fabric.<br><br>Допустимые значения: <br>*Нодевисе*: обновления Windows устанавливаются по одному узлу за раз. <br> *Упградедомаинвисе*: обновления Windows устанавливаются по одному домену обновления за раз. (Как правило, все узлы, принадлежащие домену обновления, могут попасть на обновление Windows.)<br><br> Чтобы решить, какая политика лучше всего подходит для кластера, см. раздел [часто задаваемые вопросы](#frequently-asked-questions) .
|LogsDiskQuotaInMB   |Long  <br> (По умолчанию: *1024*)               | Максимальный размер журналов приложений для управления исправлениями в МБ, которые можно сохранить локально на узлах.
| WUQuery               | строка<br>(По умолчанию: *устанавливаются = 0*)                | Запрос на получение обновлений Windows. Дополнительные сведения см. в разделе [WuQuery](/windows/win32/api/wuapi/nf-wuapi-iupdatesearcher-search).
| InstallWindowsOSOnlyUpdates | *Логический* <br> (значение по умолчанию — false)                 | Используйте этот флаг, чтобы контролировать, какие обновления следует скачать и установить. Допустимы следующие значения: <br>true — устанавливает только обновления операционной системы Windows;<br>false — устанавливает все доступные обновления на компьютере.          |
| WUOperationTimeOutInMinutes | Int <br>(По умолчанию: *90*)                   | Указывает время ожидания для любой операции обновления Windows (поиск, скачивание или установка). Если операция не завершена по истечении заданного времени ожидания, она будет прервана.       |
| WURescheduleCount     | Int <br> (По умолчанию: *5*)                  | Максимальное количество случаев, когда служба может изменить расписание обновления Windows, если операция постоянно завершается сбоем.          |
| WURescheduleTimeInMinutes | Int <br>(По умолчанию: *30*) | Интервал времени, по истечении которого служба изменяет расписание обновления Windows в случае повторения ошибки. |
| WUFrequency           | Строка с разделителями-запятыми (по умолчанию: *еженедельно, среда, 7:00:00*)     | Частота установки обновлений Windows. Формат и возможные значения: <br>-Monthly, дд, чч: мм: СС (например: *ежемесячно, 5, 12:22:32*). Допустимые значения для поля _дд_ (день) — числа от 1 до 28 и _Last_. <br>-Еженедельно, день, чч: мм: СС (например: *еженедельно, вторник, 12:22:32*)  <br>Ежедневно, чч: мм: СС (например: *ежедневно, 12:22:32*)  <br>-Week, Day, чч: мм: СС (например: *2, пятница, 21:00:00* — 9:00, UTC — Пятница 2 недели по Гринвичу каждого месяца) <br>- *Нет* — не следует выполнять обновления Windows.  <br><br> Время задаются в формате UTC.|
| AcceptWindowsUpdateEula | Логическое <br>(Значение по умолчанию: *true*) | Если этот флажок установлен, приложение принимает условия лицензионного соглашения Центра обновления Windows от имени владельца компьютера.              |

> [!TIP]
> Если требуется, чтобы обновления Windows происходили немедленно, задайте значение `WUFrequency` относительно времени развертывания приложения. Например, у вас тестовый кластер с пятью узлами и вы планируете развернуть приложение около 17:00 UTC. Если предполагается, что обновление или развертывание приложения занимает 30 минут, установите Вуфрекуенци *ежедневно, 17:30:00*.

## <a name="deploy-poa"></a>Развертывание ВЕХ

1. Завершите все предварительные шаги, чтобы подготовить кластер.
1. Разверните ВЕХ, как и любое другое приложение Service Fabric. Сведения о развертывании с помощью PowerShell см. в статье [развертывание и удаление приложений с помощью PowerShell](./service-fabric-deploy-remove-applications.md).
1. Чтобы настроить приложение во время развертывания, передайте `ApplicationParameter` для командлета `New-ServiceFabricApplication`. Для вашего удобства мы сопроводили приложение сценарием Deploy.ps1. Использование сценария

    - Подключитесь к кластеру Service Fabric при помощи `Connect-ServiceFabricCluster`.
    - Выполните сценарий PowerShell Deploy.ps1 с соответствующим значением `ApplicationParameter`.

> [!NOTE]
> Не заключайте сценарий и папку приложения *PatchOrchestrationApplication* в один каталог.

## <a name="upgrade-poa"></a>Обновление ВЕХ

Чтобы обновить версию ВЕХ с помощью PowerShell, следуйте инструкциям в разделе [Service Fabric обновлении приложения с помощью PowerShell](./service-fabric-application-upgrade-tutorial-powershell.md).

## <a name="remove-poa"></a>Удалить ВЕХ

Чтобы удалить приложение, следуйте инструкциям в разделе [развертывание и удаление приложений с помощью PowerShell](./service-fabric-deploy-remove-applications.md).

Для удобства мы предоставили сценарий Undeploy.ps1 вместе с приложением. Использование сценария

  - Подключитесь к кластеру Service Fabric при помощи ```Connect-ServiceFabricCluster```.
  - Выполните сценарий PowerShell Undeploy.ps1.

> [!NOTE]
> Не заключайте сценарий и папку приложения *PatchOrchestrationApplication* в один каталог.

## <a name="view-the-windows-update-results"></a>Просмотр результатов обновления Windows

ВЕХ предоставляет API-интерфейсы RESTFUL для вывода результатов для пользователей. Ниже приведен пример результата JSON:

```json
[
  {
    "NodeName": "_stg1vm_1",
    "WindowsUpdateOperationResults": [
      {
        "OperationResult": 0,
        "NodeName": "_stg1vm_1",
        "OperationTime": "2019-05-13T08:44:56.4836889Z",
        "OperationStartTime": "2019-05-13T08:44:33.5285601Z",
        "UpdateDetails": [
          {
            "UpdateId": "7392acaf-6a85-427c-8a8d-058c25beb0d6",
            "Title": "Cumulative Security Update for Internet Explorer 11 for Windows Server 2012 R2 (KB3185319)",
            "Description": "A security issue has been identified in a Microsoft software product that could affect your system. You can help protect your system by installing this update from Microsoft. For a complete listing of the issues that are included in this update, see the associated Microsoft Knowledge Base article. After you install this update, you may have to restart your system.",
            "ResultCode": 0,
            "HResult": 0
          }
        ],
        "OperationType": 1,
        "WindowsUpdateQuery": "IsInstalled=0",
        "WindowsUpdateFrequency": "Daily,10:00:00",
        "RebootRequired": false
      }
    ]
  },
  ...
]
```

Поля JSON описаны в следующей таблице.

Поле | Значения | Сведения
-- | -- | --
OperationResult | 0 — успешно<br> 1 — выполнено с ошибками<br> 2 — сбой<br> 3 — прервано<br> 4 — прервано с временем ожидания | Указывает результат общей операции, которая обычно включает в себя установку одного или нескольких обновлений.
ResultCode | Как и для OperationResult | Это поле указывает результат операции установки для отдельного обновления.
OperationType | 1 — установка<br> 0 — Поиск и загрузка| По умолчанию установка — это единственная OperationType, которая отображается в результатах.
WindowsUpdateQuery | Значение по умолчанию: IsInstalled=0 | Центр обновления Windows запрос, который использовался для поиска обновлений. Дополнительные сведения см. в разделе [вукуери](/windows/win32/api/wuapi/nf-wuapi-iupdatesearcher-search).
RebootRequired | true — требовалась перезагрузка<br> false — перезагрузка не требовалась | Указывает, требуется ли перезагрузка для завершения установки обновлений.
оператионстарттиме | Дата и время | Указывает время запуска операции (загрузки или установки).
оператионтиме | Дата и время | Указывает время завершения операции (загрузки или установки).
HResult | 0 — успешное завершение<br> другие — сбой| Указывает причину сбоя обновления Windows с помощью updateID "7392acaf-6a85-427c-8a8d-058c25beb0d6".

Если обновление еще не запланировано, поле результата JSON будет пустым.

Войдите в кластер, чтобы запросить Центр обновления Windows результаты. Найдите IP-адрес реплики для основного адреса службы координатора и откройте следующий URL-адрес в браузере: http:// &lt; Replica-IP &gt; : &lt; ApplicationPort &gt; /PatchOrchestrationApplication/v1/GetWindowsUpdateResults.

Конечная точка REST для службы координатора имеет динамический порт. Чтобы проверить точный URL-адрес, см. Service Fabric Explorer. Например, результаты доступны по адресу *http://10.0.0.7:20000/PatchOrchestrationApplication/v1/GetWindowsUpdateResults* .

![Изображение конечной точки RESTFUL](media/service-fabric-patch-orchestration-application/Rest_Endpoint.png)

Если в кластере включен обратный прокси-сервер, вы также можете получить доступ к URL-адресу за пределами кластера.

Необходимо нажать конечную точку *http:// &lt; SERVERURL &gt; : &lt; реверсепроксипорт &gt; /PatchOrchestrationApplication/CoordinatorService/v1/GetWindowsUpdateResults*.

Чтобы включить обратный прокси-сервер в кластере, следуйте инструкциям в разделе [обратный прокси-сервер в Azure Service Fabric](./service-fabric-reverseproxy.md). 

> 
> [!WARNING]
> После настройки обратного прокси-сервера все микрослужбы в кластере, предоставляющие конечную точку HTTP, будут доступны за пределами кластера.

## <a name="diagnostics-and-health-events"></a>События диагностики и работоспособности

В этом разделе описывается отладка и диагностика проблем с обновлениями исправлений через ВЕХ на кластерах Service Fabric.

> [!NOTE]
> Для получения многих из следующих вызываемых усовершенствований с самодиагностикой необходимо установить ВЕХ версии 1.4.0 или более поздней.

Агент узла служба NTService создает [задачи восстановления](/dotnet/api/system.fabric.repair.repairtask) для установки обновлений на узлах. Затем каждая задача подготавливается службой координатора в соответствии с политикой утверждения задач. Наконец, подготовленные задачи утверждаются Диспетчер восстановления, что не утверждает задачу, если кластер находится в неработоспособном состоянии. 

Чтобы понять, как обновления продолжают работать на узле, давайте пошаговым шагом.

1. Нодеажентнтсервице, выполняющиеся на каждом узле, ищет доступные обновления Windows в запланированное время. Если обновления доступны, они загружают их на узле.

1. После загрузки обновлений агент узла служба NTService создает соответствующую задачу восстановления для узла с именем *POS___ \<unique_id>*. Эти задачи восстановления можно просмотреть с помощью командлета [Get-сервицефабрикрепаиртаск](/powershell/module/servicefabric/get-servicefabricrepairtask) или с помощью SFX в разделе сведения об узле. После создания задачи восстановления она быстро переходит в [ *затребованное* состояние](/dotnet/api/system.fabric.repair.repairtaskstate).

1. Служба координатора периодически ищет задачи восстановления в *запрошенном* состоянии, а затем обновляет их для *подготовки* состояния на основе TaskApprovalPolicy. Если TaskApprovalPolicy настроен на Нодевисе, то задача восстановления, соответствующая узлу, подготавливается только в том случае, если в настоящее время не выполняется *Подготовка*, *утверждение*, *исполнение* или *Восстановление* состояния. 

   Аналогично, в случае с Упградевисе TaskApprovalPolicy существуют задачи в предыдущих состояниях только для узлов, принадлежащих к одному домену обновления. После перемещения задачи восстановления в состояние *подготовки* соответствующий узел Service Fabric [отключается](/powershell/module/servicefabric/disable-servicefabricnode) с намерением, установленным для *перезапуска*.

   ВЕХ версии 1.4.0 и более поздних версий передают события с помощью свойства Клустерпатчингстатус в службы координатора для просмотра обновляемых узлов. Обновления устанавливаются на _poanode_0, как показано на следующем рисунке:

    [![Изображение состояния исправления кластера](media/service-fabric-patch-orchestration-application/clusterpatchingstatus.png)](media/service-fabric-patch-orchestration-application/clusterpatchingstatus.png#lightbox)

1. После отключения узла задача восстановления перемещается в состояние *выполнения* . 
   
   > [!NOTE]
   > Узел, который находится в *отключенном* состоянии, может блокировать новую задачу восстановления, которая останавливает операцию исправления в кластере.

1. Когда задача восстановления находится в состоянии *выполняется* , начинается установка исправления на этом узле. После установки исправления узел может быть или не перезапущен, в зависимости от исправления. Затем задача восстановления перемещается в состояние *восстановления* , что позволяет повторно включить узел. Затем задача восстановления помечается как завершенная.

   В ВЕХ Versions 1.4.0 и более поздних версий можно узнать состояние обновления, просмотрев события работоспособности в службы агента узла с помощью Вуоператионстатус- \<NodeName> Property. В выделенных разделах на следующих изображениях показано состояние обновлений Windows на узлах *poanode_0* и *poanode_2*.

   [![На снимке экрана отображается окно консоли Центр обновления Windows состояние операции с выделенным poanode_0.](media/service-fabric-patch-orchestration-application/wuoperationstatusa.png)](media/service-fabric-patch-orchestration-application/wuoperationstatusa.png#lightbox)

   [![На снимке экрана отображается окно консоли Центр обновления Windows состояние операции с выделенным poanode_1.](media/service-fabric-patch-orchestration-application/wuoperationstatusb.png)](media/service-fabric-patch-orchestration-application/wuoperationstatusb.png#lightbox)

   Вы также можете получить подробные сведения с помощью PowerShell. Для этого подключитесь к кластеру и извлеките состояние задачи восстановления с помощью команды [Get-сервицефабрикрепаиртаск](/powershell/module/servicefabric/get-servicefabricrepairtask). 
   
   В следующем примере задача "POS__poanode_2_125f2969-933c-4774-85d1-ebdf85e79f15" находится в состоянии *DownloadComplete* . Это означает, что обновления были скачаны на *poanode_2* узле, и при переходе задачи в состояние *выполнения* будет предпринята попытка установки.

   ``` powershell
    D:\service-fabric-poa-bin\service-fabric-poa-bin\Release> $k = Get-ServiceFabricRepairTask -TaskId "POS__poanode_2_125f2969-933c-4774-85d1-ebdf85e79f15"

    D:\service-fabric-poa-bin\service-fabric-poa-bin\Release> $k.ExecutorData
    {"ExecutorSubState":2,"ExecutorTimeoutInMinutes":90,"RestartRequestedTime":"0001-01-01T00:00:00"}
    ```

   Если осталось больше проблем, войдите в виртуальную машину или виртуальные машины и изучите их с помощью журналов событий Windows. Ранее упомянутая задача восстановления может существовать только в следующих подсостояниях исполнителя:

      ексекуторсубстате | Описание
    -- | -- 
      Нет = 1 |  Подразумевает, что на узле не выполнялась текущая операция. Состояние может быть в переходе.
      Довнлоадкомплетед = 2 | Подразумевает, что операция загрузки была выполнена успешно, частично или неудачно.
      Инсталлатионаппровед = 3 | Подразумевает, что операция загрузки была выполнена ранее и Диспетчер восстановления утвердила установку.
      Инсталлатионинпрогресс = 4 | Соответствует состоянию выполнения задачи восстановления.
      Инсталлатионкомплетед = 5 | Подразумевает, что установка была выполнена успешно, частично или неудачно.
      Рестартрекуестед = 6 | Подразумевает, что установка исправления завершена, а на узле есть ожидающее действие перезагрузки.
      Рестартнотнидед = 7 |  Подразумевает, что после завершения установки исправления перезагрузка не требовалась.
      Рестарткомплетед = 8 | Подразумевает, что перезагрузка выполнена успешно.
      Оператионкомплетед = 9 | Операция Центр обновления Windows выполнена успешно.
      Оператионабортед = 10 | Подразумевает, что операция Центр обновления Windows была прервана.

1. В ВЕХ Versions 1.4.0 и более поздних версиях при попытке обновления узла в службы агента узла будет отправлено событие со свойством Вуоператионстатус-[NodeName], уведомляющее о том, что начнется следующая попытка загрузки и установки обновлений Windows. Это показано на следующем рисунке:

     [![На снимке экрана показано окно консоли Центр обновления Windows состояние операции с параметром службы агента узла.](media/service-fabric-patch-orchestration-application/wuoperationstatusc.png)](media/service-fabric-patch-orchestration-application/wuoperationstatusc.png#lightbox)

### <a name="diagnostics-logs"></a>Раздел "Журналы диагностики"

Журналы приложений для оркестрации исправлений собираются как часть журналов среды выполнения Service Fabric.

Журналы можно записывать с помощью средства диагностики или конвейера по своему усмотрению. ВЕХ использует следующие фиксированные идентификаторы поставщиков для регистрации событий с помощью [источника событий](/dotnet/api/system.diagnostics.tracing.eventsource):

- e39b723c-590c-4090-abb0-11e3e6616346
- fc0028ff-bfdc-499f-80dc-ed922c52c5e9
- 24afa313-0d3b-4c7c-b485-1047fd964b60
- 05dc046c-60e9-4ef7-965e-91660adffa68

### <a name="health-reports"></a>Отчеты о работоспособности

ВЕХ также публикует отчеты о работоспособности в службе агента узла или службе координатора в следующих сценариях:

* Служба NTService агента узла не работает

   Если на узле не работает служба NTService агента узла, генерируется отчет о работоспособности уровня предупреждения для службы агента узла.

* Служба Диспетчер восстановления не включена

   Если служба Диспетчер восстановления не найдена в кластере, для службы координатора создается отчет о работоспособности уровня предупреждения.

## <a name="frequently-asked-questions"></a>Вопросы и ответы

**Вопрос. Почему кластер находится в состоянии ошибки, когда ВЕХ работает?**

Ответ. в процессе установки ВЕХ отключает или перезапускает узлы, которые могут временно привести к неработоспособному кластеру.

В зависимости от политики приложения один из узлов может быть остановлен во время операции исправления *или* весь домен обновления может быть переустановлен одновременно.

После завершения установки обновлений Windows узлы снова включаются после перезагрузки.

В примере ниже кластер временно перешел в состояние ошибки, так как два узла вышли из строя и политика MaxPercentageUnhealthNodes была нарушена. Эта ошибка временная, пока не начнется операция исправления.

![Представление неработоспособного кластера](media/service-fabric-patch-orchestration-application/MaxPercentage_causing_unhealthy_cluster.png)

Если проблема не будет устранена, см. сведения в разделе об устранении неполадок.

**Вопрос. что можно сделать, если ВЕХ находится в состоянии предупреждения?**

Ответ. Проверьте, является ли отчет о работоспособности, опубликованный для приложения, указанием основной причины. Обычно в описании предупреждения содержатся сведения о проблеме. Если проблема временная, предполагается, что приложение будет восстановлено автоматически.

**Вопрос. что можно сделать, если кластер неработоспособен и мне нужно срочное обновление операционной системы?**

Ответ. ВЕХ не устанавливает обновления, пока кластер находится в неработоспособном состоянии. Попробуйте перевести кластер в работоспособное состояние, чтобы разблокировать рабочий процесс ВЕХ.

**Вопрос. следует ли задать для кластера TaskApprovalPolicy как "Нодевисе" или "Упградедомаинвисе"?**

Ответ. параметр "Упградедомаинвисе" ускоряет общее восстановление кластера путем установки исправлений параллельно на всех узлах, принадлежащих домену обновления. Во время процесса узлы, принадлежащие к целому домену обновления, недоступны (в [ *отключенном* состоянии](/dotnet/api/system.fabric.query.nodestatus#System_Fabric_Query_NodeStatus_Disabled)).

В отличие от этого, параметр «Нодевисе» выполняет исправление только одного узла за раз, что означает, что установка всего исправления кластера может занять больше времени. Однако в процессе установки исправлений только один узел в большинстве случаев будет недоступен (в *отключенном* состоянии).

Если кластер допускает выполнение на N-1 нескольких доменах обновления во время цикла обновления (где N — общее число доменов обновления в кластере), можно задать для политики значение "Упградедомаинвисе". В противном случае задайте для него значение "Нодевисе".

**Вопрос. Сколько времени занимает обновление узла?**

Ответ. Исправление узла может занять от нескольких минут (например, [обновлений определений Защитника Windows](https://www.microsoft.com/en-us/wdsi/definitions)) до часов (например, [накопительных обновлений Windows](https://www.catalog.update.microsoft.com/Search.aspx?q=windows%20server%20cumulative%20update)). Время, необходимое для исправления узла, зависит главным образом: 
 - Размер обновлений.
 - Число обновлений, которые должны быть применены в окне исправлений.
 - Время, необходимое для установки обновлений, перезагрузки узла (если это необходимо) и завершения установки после перезагрузки.
 - Производительность виртуальной машины или компьютера, а также состояния сети.

**Вопрос. Сколько времени займет обновление всего кластера?**

Ответ. время, необходимое для исправления всего кластера, зависит от следующих факторов:

- Время, необходимое для исправления узла.

- Политика службы координатора. Политика по умолчанию «Нодевисе» приводит к исправлению только одного узла за раз, подход, который медленнее, чем использование «Упградедомаинвисе». 

   Например, если для исправления узла требуется ~ 1 час, установка исправления для кластера из 20 узлов (узлов того же типа) с 5 доменами обновления, каждый из которых содержит 4 узла, требует:
    - Для "Нодевисе": ~ 20 часов.
    - Для "Упградедомаинвисе": ~ 5 часов.

- Загрузка кластера. Для каждой операции исправления требуется перемещение рабочей нагрузки клиента на другие доступные узлы в кластере. В течение этого времени обновляемый узел будет находиться в [состоянии *отключения*](/dotnet/api/system.fabric.query.nodestatus#System_Fabric_Query_NodeStatus_Disabling) . Если кластер работает почти в пиковой нагрузке, процесс отключения займет больше времени. Таким образом, общий процесс установки исправлений может оказаться слишком длительным в таких условиях напряженности.

- Сбои работоспособности кластера во время установки исправлений. Любое [снижение](/dotnet/api/system.fabric.health.healthstate#System_Fabric_Health_HealthState_Error) [работоспособности кластера](./service-fabric-health-introduction.md) приведет к прерыванию процесса исправления. Эта проблема может сложить общее время, необходимое для исправления всего кластера.

**Вопрос. Почему некоторые обновления отображаются в Центр обновления Windows результаты, полученные с помощью REST API, но не в журнале Центр обновления Windows на компьютере?**

Ответ. Некоторые обновления продукта отображаются только в журнале обновлений или исправлений. Например, обновления защитника Windows могут или не отображаться в журнале Центр обновления Windows в Windows Server 2016.

**Вопрос. можно ли ВЕХ использовать для исправления моего кластера разработки (кластер с одним узлом)?**

Ответ. нет, ВЕХ нельзя использовать для исправления кластера с одним узлом. Это ограничение обусловлено проектированием, поскольку [Service Fabric системные службы](./service-fabric-technical-overview.md#system-services) или другие клиентские приложения будут вызывать простои. Поэтому задания по исправлению исправлений никогда не будут утверждены Диспетчер восстановления.

**Вопрос. Разделы справки обновления узлов кластера в Linux?**

Ответ. сведения об оркестрации обновлений в Linux см. в статье [Автоматическое обновление образа ОС в масштабируемом наборе виртуальных машин Azure](../virtual-machine-scale-sets/virtual-machine-scale-sets-automatic-upgrade.md).

**Вопрос. Почему цикл обновления занимает настолько много времени?**

Ответ. выполните запрос к результирующему JSON-запросу, введите цикл обновления для всех узлов, а затем попробуйте узнать время, затрачиваемое на установку обновлений на каждом узле, с помощью Оператионстарттиме и Оператионтиме (Оператионкомплетионтиме). 

Если имеется большое временное окно, в котором не происходит обновления, кластер может находиться в состоянии ошибки и, следовательно, Диспетчер восстановления не может утверждать какие-либо задачи восстановления ВЕХ. Если установка обновления на любом узле занимает длительное время, этот узел может быть не обновлен в течение определенного времени. Возможно, ожидается установка большого количества обновлений, что может привести к задержкам. 

Возможно также, что исправление узла заблокировано, так как оно зависает в состоянии *отключения* . Обычно это происходит потому, что отключение узла может привести к возникновению проблем с кворумом или потерей данных.

**Вопрос. Зачем следует отключать узел при установке исправления ВЕХ?**

Ответ. ВЕХ отключает узел с намерением *перезапуска* , который останавливает или перераспределяет все службы Service Fabric, запущенные на узле. ВЕХ делает это для того, чтобы приложения не применялись сочетанием новых и старых библиотек DLL, поэтому мы рекомендуем не отключать обновление узла, не отключая его.

**Вопрос. Каково максимальное число узлов, которые можно обновить с помощью ВЕХ?**

Ответ. ВЕХ использует Диспетчер восстановления Service Fabric для создания задач восстановления узлов для обновлений. Однако в одно и то же время могут присутствовать не более 250 задач восстановления. В настоящее время ВЕХ создает задачи восстановления для каждого узла одновременно, поэтому ВЕХ может обновлять не более 250 узлов в кластере. 

## <a name="disclaimers"></a>Заявления об отказе от ответственности

- ВЕХ принимает лицензионное соглашение End-User для Центр обновления Windows от имени пользователя. При необходимости этот параметр можно отключить в конфигурации приложения.

- ВЕХ собирает данные телеметрии для отслеживания использования и производительности. Телеметрия приложения выполняется в соответствии с настройкой телеметрии в среде выполнения Service Fabric (которая включена по умолчанию).

## <a name="troubleshooting"></a>Устранение неполадок

В этом разделе приводятся возможные решения по устранению неполадок с узлами исправлений.

### <a name="a-node-is-not-coming-back-to-up-state"></a>Узел не возвращается в рабочее состояние

* Узел может зависнуть в состоянии *отключения* , так как:

  - Проверка безопасности находится в состоянии ожидания. В этом случае необходимо убедиться, что достаточное количество узлов находятся в работоспособном состоянии.

* Узел может быть остановлен в *отключенном* состоянии по следующим причинам:

  - Она была отключена вручную.
  - Она была отключена из-за текущего задания инфраструктуры Azure.
  - Это временно отключено ВЕХ для исправления узла.

* Возможная причина, по которой узел остался в отключенном состоянии

  - Оно было переведено в состояние "отключено" вручную.
  - Он перезапускается (что может быть активировано ВЕХ).
  - У него есть неисправный компьютер или ВИРТУАЛЬная машина, или возникли проблемы с сетевым подключением.

### <a name="updates-were-skipped-on-some-nodes"></a>Обновления на некоторых узлах пропущены

ВЕХ пытается установить обновление Windows в соответствии с политикой перепланирования. Служба пытается восстановить узел и пропустить обновление в соответствии с политикой приложения.

В этом случае для службы агента узла будет создан отчет о работоспособности уровня предупреждения. Результат Центр обновления Windows также содержит возможные причины сбоя.

### <a name="the-health-of-the-cluster-goes-to-error-while-the-update-is-being-installed"></a>При установке обновления работоспособность кластера переходит в ошибку

Сбой обновления Windows может привести к работоспособности приложения или кластера в определенном узле или домене обновления. ВЕХ прекращает дальнейшую операцию Центр обновления Windows, пока кластер не станет работоспособным.

Администратор должен определить, почему приложение или кластер стали неработоспособными из-за Центр обновления Windows.

## <a name="poa-release-notes"></a>Заметки о выпуске ВЕХ

>[!NOTE]
> В ВЕХ Versions 1.4.0 и более поздних версий заметки о выпуске и выпуски можно найти на [странице выпуска приложения для управления исправлениями](https://github.com/microsoft/Service-Fabric-POA/releases/) на сайте GitHub.

### <a name="version-110"></a>Версия 1.1.0
- Общедоступный выпуск

### <a name="version-111"></a>Версии 1.1.1
- Исправлена ошибка в SetupEntryPoint службы агента узла, которая препятствовала установке службы NTService агента узла.

### <a name="version-120"></a>Версии 1.2.0

- Исправлены ошибки, связанные с рабочим процессом перезапуска системы.
- Исправлена ошибка при создании задач службы управления правами, из-за которой проверка работоспособности не выполнялась должным образом во время подготовки задач восстановления.
- Изменен режим запуска службы Windows Поанодесвк с Auto на отложенный-Auto.

### <a name="version-121"></a>Версия 1.2.1

- Исправлены ошибки в рабочем процессе уменьшения масштаба кластера. Добавлена логика сборки мусора для задач восстановления POA, относящихся к несуществующим узлам.

### <a name="version-122"></a>Версия 1.2.2

- Прочие исправления ошибок.
- Теперь двоичные файлы подписаны.
- Добавлена ссылка на sfpkg для приложения.

### <a name="version-130"></a>Версия 1.3.0

- Заданное параметру InstallWindowsOSOnlyUpdates значение false теперь устанавливает все доступные обновления.
- Изменена логика отключения автоматических обновлений. Благодаря этому ошибка, когда автоматические обновления не были отключены на Server 2016 и более поздних версий, была исправлена.
- Параметризованное ограничение размещения как для микрослужб ВЕХ, так и для расширенных вариантов использования.

### <a name="version-131"></a>Версия 1.3.1
- Устранение регрессии, когда ВЕХ 1.3.0 не будет работать в Windows Server 2012 R2 или более ранней версии из-за сбоя при отключении автоматических обновлений. 
- Исправлена ошибка, при которой для конфигурации InstallWindowsOSOnlyUpdates всегда выбирается значение True.
- Значения по умолчанию InstallWindowsOSOnlyUpdates изменилось на False.

### <a name="version-132"></a>Версия 1.3.2
- Устранение проблемы, влияющей на жизненный цикл исправления на узле, если имеются узлы с именем, которое является подмножеством имени текущего узла. Для таких узлов возможно, что исправление пропущено или ожидается перезагрузка.
