---
title: Планирование развертывания кластера Azure Service Fabric
description: Узнайте, как планировать и подготавливать рабочую Service Fabric развертывание кластера в Azure.
ms.topic: conceptual
ms.date: 03/20/2019
ms.openlocfilehash: 82521487b9a3e9438784e010a32cf6df8e7be2ef
ms.sourcegitcommit: ed7376d919a66edcba3566efdee4bc3351c57eda
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/24/2021
ms.locfileid: "105046323"
---
# <a name="plan-and-prepare-for-a-cluster-deployment"></a>Планирование и подготовка к развертыванию кластера

Планирование и подготовка к развертыванию производственного кластера очень важно.  Есть много факторов, которые следует учитывать.  В этой статье описано, как подготовить развертывание кластера.

## <a name="read-the-best-practices-information"></a>Прочтите сведения о рекомендациях
Для успешного управления приложениями Azure Service Fabric и кластерами существуют операции, которые мы настоятельно рекомендуем выполнить для оптимизации надежности рабочей среды.  Дополнительные сведения см. в статье [Service Fabric рекомендации по приложениям и кластерам](./service-fabric-best-practices-security.md).

## <a name="select-the-os-for-the-cluster"></a>Выберите ОС для кластера
Service Fabric позволяет создавать кластеры Service Fabric на любых виртуальных машинах или компьютерах под управлением Windows Server или Linux.  Перед развертыванием кластера необходимо выбрать ОС Windows или Linux.  Каждый узел (виртуальная машина) в кластере выполняет одну и ту же ОС. Вы не можете смешивать виртуальные машины Windows и Linux в одном кластере.

## <a name="capacity-planning"></a>Планирование ресурсов
Для любой рабочей развернутой службы важным шагом является планирование загрузки. Вот несколько моментов, которые необходимо учесть:

* Начальное число типов узлов для кластера 
* Свойства каждого типа узла (размер, число экземпляров, первичный, с выходом в Интернет, количество виртуальных машин и т. д.)
* Надежность и устойчивость характеристик кластера.

### <a name="select-the-initial-number-of-node-types"></a>Выберите начальное число типов узлов
Во-первых, необходимо выяснить, для чего будет использоваться создаваемый кластер и какие виды приложений планируется в нем развернуть. Есть ли у вашего приложения несколько служб, среди которых есть службы, которые должны быть общедоступными или доступными из Интернета? У служб (составляющих приложение) различные требования к инфраструктуре, например больше ОЗУ или тактов центрального процессора? Кластер Service Fabric может состоять более чем из одного типа узла: типа первичного узла и одного или нескольких типов непервичных узлов. Каждый тип узла соответствует набору масштабирования виртуальных машин. Каждый тип узла поддерживает возможность независимого масштабирования, имеет разные наборы открытых портов и собственные метрики емкости. [Свойства узла и ограничения на размещение][placementconstraints] можно настроить для ограничения конкретных служб конкретными типами узлов.  Дополнительные сведения см. в статье [Service Fabric планирование емкости кластера](service-fabric-cluster-capacity.md).

### <a name="select-node-properties-for-each-node-type"></a>Выберите свойства узла для каждого типа узла.
Типы узлов определяют номера SKU, Номера и свойства ВИРТУАЛЬНЫХ машин в связанном масштабируемом наборе.

Минимальный размер виртуальных машин для каждого типа узла определяется [уровнем устойчивости][durability] , выбранным для типа узла.

Минимальное количество виртуальных машин для типа первичного узла зависит от выбранного [уровня надежности][reliability].

Ознакомьтесь с минимальными рекомендациями для типов [первичных узлов](service-fabric-cluster-capacity.md#primary-node-type), [рабочих нагрузок с отслеживанием состояния на типах узлов, не являющихся первичными](service-fabric-cluster-capacity.md#stateful-workloads), и [рабочих нагрузок без отслеживания состояния на типах узлов, не являющихся первичными](service-fabric-cluster-capacity.md#stateless-workloads).

Количество узлов, превышающее минимальное, должно быть основано на количестве реплик приложения или служб, которые необходимо выполнить в этом типе узла.  [Планирование ресурсов для Service Fabric приложений](service-fabric-capacity-planning.md) помогает оценить ресурсы, необходимые для выполнения приложений. Вы всегда можете увеличить или уменьшить масштаб кластера позже, чтобы изменить рабочую нагрузку приложения. 

#### <a name="use-ephemeral-os-disks-for-virtual-machine-scale-sets"></a>Использование временных дисков ОС для масштабируемых наборов виртуальных машин

*Временные диски ОС* — это хранилище, созданное на локальной виртуальной машине и не сохраненное в удаленном хранилище Azure. Они рекомендуются для всех типов узлов Service Fabric (основной и дополнительный), так как по сравнению с традиционными дисками с постоянными ОС, временными дисками ОС:

* Уменьшение задержки чтения и записи на диск ОС
* Включить более быстрые операции по управлению узлами для сброса и повторного создания образа
* Сократите общие затраты (диски бесплатно и не требуют дополнительных затрат на хранение).

Временные диски ОС не являются определенной Service Fabricой функцией, а представляют собой функцию *масштабируемых наборов виртуальных машин* Azure, сопоставленных с типами узлов Service Fabric. Для их использования с Service Fabric требуется следующее в шаблоне Azure Resource Manager кластера:

1. Убедитесь, что типы узлов задают [Поддерживаемые размеры виртуальных машин Azure](../virtual-machines/ephemeral-os-disks.md) для временных дисков ОС, и что размер кэша виртуальной машины достаточен для поддержки размера диска ОС (см. *Примечание* ниже). Например:

    ```xml
    "vmNodeType1Size": {
        "type": "string",
        "defaultValue": "Standard_DS3_v2"
    ```

    > [!NOTE]
    > Не забудьте выбрать размер виртуальной машины с размером кэша, равным или превышающим размер диска ОС самой виртуальной машины. в противном случае развертывание Azure может привести к ошибке (даже если изначально оно принято).

2. Укажите версию масштабируемого набора виртуальных машин ( `vmssApiVersion` ) `2018-06-01` или более позднюю:

    ```xml
    "variables": {
        "vmssApiVersion": "2018-06-01",
    ```

3. В разделе масштабируемый набор виртуальных машин шаблона развертывания укажите `Local` параметр для `diffDiskSettings` :

    ```xml
    "apiVersion": "[variables('vmssApiVersion')]",
    "type": "Microsoft.Compute/virtualMachineScaleSets",
        "virtualMachineProfile": {
            "storageProfile": {
                "osDisk": {
                        "caching": "ReadOnly",
                        "createOption": "FromImage",
                        "diffDiskSettings": {
                            "option": "Local"
                        },
                }
            }
        }
    ```

> [!NOTE]
> Пользовательские приложения не должны иметь никаких зависимостей, файлов или артефактов на диске операционной системы, так как при обновлении ОС диск операционной системы будет потерян.

> [!NOTE]
> Существующие неэфемерные VMSS нельзя обновить на месте, чтобы использовать временные диски.
> Чтобы выполнить миграцию, пользователям потребуется [Добавить](./virtual-machine-scale-set-scale-node-type-scale-out.md) новый NodeType с временными дисками, переместить рабочие нагрузки в новый NodeType & [Удалить](./service-fabric-how-to-remove-node-type.md) существующий NodeType.
>

Дополнительные сведения и дополнительные параметры конфигурации см. в статье [диски с временными ОС для виртуальных машин Azure](../virtual-machines/ephemeral-os-disks.md) . 


### <a name="select-the-durability-and-reliability-levels-for-the-cluster"></a>Выбор уровней устойчивости и надежности для кластера
Уровень устойчивости используется, чтобы указать системе привилегии, имеющиеся у виртуальных машин в базовой инфраструктуре Azure. Для типа первичного узла эта привилегия позволяет Service Fabric приостановить любой запрос инфраструктуры на уровне виртуальной машины (например, перезагрузку, переустановку из образа или перенос виртуальной машины), который влияет на требования к кворуму, установленные для системных служб и ваших служб с отслеживанием состояния. Для типов вторичных узлов эта привилегия позволяет Service Fabric приостановить любой запрос инфраструктуры на уровне виртуальной машины (например, перезагрузку, переустановку из образа и перенос виртуальной машины), который влияет на требования к кворуму, установленные для ваших служб с отслеживанием состояния.  Преимущества различных уровней и рекомендаций по уровню [надежности кластера][durability]и рекомендации по их использованию.

Уровень надежности используется для задания числа реплик системных служб, которые будут выполняться в этом кластере на первичных узлах. Чем больше реплик, тем надежнее системные службы в кластере.  Для получения преимуществ различных уровней и рекомендаций по уровню использования и, когда, см. статью [характеристики надежности кластера][reliability]. 

## <a name="enable-reverse-proxy-andor-dns"></a>Включение обратных прокси-серверов и (или) DNS
Службы, которые подключаются друг к другу в рамках кластера, обычно могут напрямую обратиться к конечным точкам другой службы, так как узлы в кластере расположены в пределах одной локальной сети. Чтобы упростить подключение между службами, Service Fabric предоставляет дополнительные службы: [службу DNS](service-fabric-dnsservice.md) и [службу обратных прокси-серверов](service-fabric-reverseproxy.md).  Обе службы можно включить при развертывании кластера.

Так как многие службы, особенно контейнерные службы, могут иметь существующее URL-имя, возможность их устранения с помощью стандартного протокола DNS (а не протокола Служба именования) удобна, особенно в сценариях "поднятие и смена приложений". Именно это и делает служба DNS. Она позволяет сопоставить DNS-имена с именем службы и, следовательно, разрешить IP-адреса конечных точек.

Обратный прокси-сервер обращается к службам в кластере, которые предоставляют конечные точки HTTP (включая HTTPS). Обратный прокси-сервер значительно упрощает вызов других служб, предоставляя конкретный формат URI.  Обратный прокси-сервер также обрабатывает шаги разрешения, подключения и повтора, необходимые для взаимодействия одной службы с другой.

## <a name="prepare-for-disaster-recovery"></a>Подготовка к аварийному восстановлению
Для обеспечения высокого уровня доступности крайне важно гарантировать продолжение работы всех типов служб при любых сбоях. Это особенно важно в ситуациях незапланированных сбоев, которые находятся вне вашего контроля. [Подготовка к аварийному восстановлению](service-fabric-disaster-recovery.md) описывает некоторые распространенные режимы сбоев, которые могут быть аварийными, если они не моделируются и не управляются надлежащим образом. В нем также обсуждаются меры по устранению рисков и действия, выполняемые в случае возникновения аварии.

## <a name="production-readiness-checklist"></a>Контрольный список готовности рабочей среды
Готовы ли ваше приложение и кластер к приему рабочего трафика? Перед развертыванием кластера в рабочей среде выполните [Контрольный список готовности к производству](service-fabric-production-readiness-checklist.md). Используйте элементы этого контрольного списка, чтобы обеспечить бесперебойную работу приложения и кластера. Мы настоятельно рекомендуем отключать все эти элементы перед переходом в рабочую среду.

## <a name="next-steps"></a>Дальнейшие действия
* [Создание кластера Service Fabric под Windows](./service-fabric-best-practices-security.md)
* [Создание кластера Service Fabric под управлением Linux](service-fabric-tutorial-create-vnet-and-linux-cluster.md)

[placementconstraints]: service-fabric-cluster-resource-manager-cluster-description.md#node-properties-and-placement-constraints
[durability]: service-fabric-cluster-capacity.md#durability-characteristics-of-the-cluster
[reliability]: service-fabric-cluster-capacity.md#reliability-characteristics-of-the-cluster