---
title: Транзакции и режимы блокировки в надежных коллекциях
description: Транзакции и блокировка диспетчера надежных состояний и надежных коллекций Azure Service Fabric.
ms.topic: conceptual
ms.date: 5/1/2017
ms.openlocfilehash: 5d2cbb517ea5ca45697cd9124b82e9ef13dd32db
ms.sourcegitcommit: a055089dd6195fde2555b27a84ae052b668a18c7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/26/2021
ms.locfileid: "98784348"
---
# <a name="transactions-and-lock-modes-in-azure-service-fabric-reliable-collections"></a>Транзакции и режимы блокировки в надежных коллекциях Azure Service Fabric

## <a name="transaction"></a>Транзакция

Транзакция является последовательностью операций, выполненных как одна логическая единица работы. Он обеспечивает стандартные свойства [ACID](https://en.wikipedia.org/wiki/ACID) (*атомарность*, *согласованность*, *изоляция*, *устойчивость*) транзакций базы данных:

* **Атомарность**. Транзакция должна быть атомарной единицей работы. Другими словами, должны выполняться либо все ее изменения данных, либо ни одно из них.
* **Согласованность**. По завершении транзакция должна оставить все данные в согласованном состоянии. Все внутренние структуры данных должны быть правильными на момент завершения транзакции.
* **Изоляция**. Изменения, выполняемые одной параллельной транзакцией, должны быть изолированы от изменений, выполняемых прочими параллельными транзакциями. Уровень изоляции, используемый для операции в [ITransaction](/dotnet/api/microsoft.servicefabric.data.itransaction) , определяется [ирелиаблестате](/dotnet/api/microsoft.servicefabric.data.ireliablestate) , выполняющим операцию.
* **Устойчивость**. После завершения транзакции ее результаты постоянно сохраняются в системе. Изменения сохраняются даже в случае системного сбоя.

### <a name="isolation-levels"></a>Уровни изоляции

Уровень изоляции определяет степень, до которой транзакция должна быть изолирована от изменений, вносимых другими транзакциями.
Надежные коллекции поддерживают два уровня изоляции:

* **Повторяющееся чтение**. Указывает, какие операторы не могут считывать данные, которые были изменены, но еще не зафиксированы другими транзакциями, и что другие транзакции не могут изменять данные, считанные текущей транзакцией, до ее завершения.
* **Моментальный снимок**: указывает, что данные, считанные любой инструкцией транзакции, являются транзакционно согласованной версией данных, существовавших в начале транзакции.
  Транзакция может распознать только те изменения данных, которые были зафиксированы до ее начала.
  Инструкции, выполняемые текущей транзакцией, не видят изменений данных, произведенных другими транзакциями после запуска текущей транзакции.
  Это похоже на то, как если бы инструкции в транзакции получили снимок данных, зафиксированных на момент начала транзакции.
  Моментальные снимки согласованы между надежными коллекциями.

Для операций чтения надежные коллекции автоматически выбирают уровень изоляции в зависимости от самой операции и роли реплики в момент создания транзакции.
Ниже приведена таблица уровней изоляции по умолчанию для операций надежного словаря и очереди.

| Операция \ Роль | Первичная | Вторичная |
| --- |:--- |:--- |
| Операция чтения одной сущности |Повторяющаяся операция чтения |Моментальный снимок |
| Перечисление, подсчет |Моментальный снимок |Моментальный снимок |

> [!NOTE]
> Распространенные примеры операций с одной сущностью: `IReliableDictionary.TryGetValueAsync`, `IReliableQueue.TryPeekAsync`.
> 

И надежный словарь, и поддержка надежной очереди *считывают записи*.
Другими словами, каждая операция записи в рамках одной транзакции будет видна для последующей операции чтения, которая выполняется в рамках той же транзакции.

## <a name="locks"></a>Блокировки

В надежных коллекциях все транзакции реализуют строгую двухэтапную блокировку: транзакция не снимает свои установленные блокировки, пока она не завершится прерыванием или фиксацией.

Надежный словарь использует блокировку на уровне строк для всех операций с одной сущностью.
Надежная очередь поступается параллелизмом ради строгого соблюдения транзакционного свойства FIFO.
Надежная очередь использует блокировки на уровне операций, разрешающие одну транзакцию с `TryPeekAsync` и (или) `TryDequeueAsync` и одну транзакцию `EnqueueAsync` за раз.
Обратите внимание, что если `TryPeekAsync` или `TryDequeueAsync` когда-либо обнаружит, что надежная очередь пуста, то для сохранения логики FIFO также заблокирует `EnqueueAsync`.

Операции записи всегда используют монопольные блокировки.
Для операций чтения блокировка зависит от нескольких факторов:

- Любая операция чтения, использующая изоляцию моментального снимка, не блокируется.
- В повторяющихся операциях чтения используются совмещаемые блокировки (по умолчанию).
- Тем не менее, для любой операции чтения, поддерживающей повторяющееся чтение, вместо совмещаемой блокировки пользователь может запросить блокировку изменений.
Блокировка изменений является асимметричной блокировкой, которая используется для предотвращения распространенной формы взаимоблокировки. Взаимоблокировка возникает, когда несколько транзакций блокируют ресурсы для возможного обновления в будущем.

Ниже приведена таблица совместимости блокировок.

| Запрос \ Предоставлено | Нет | Совмещаемая блокировка | Update | Монопольная блокировка |
| --- |:--- |:--- |:--- |:--- |
| Совмещаемая блокировка |Нет конфликтов |Нет конфликтов |Conflict |Conflict |
| Update |Нет конфликтов |Нет конфликтов |Conflict |Conflict |
| Монопольная блокировка |Нет конфликтов |Conflict |Conflict |Conflict |

Аргумент timeout в API-интерфейсах надежных коллекций используется для обнаружения взаимоблокировок.
Например, две транзакции (Т1 и Т2) пытаются считать и изменить К1.
Существует вероятность возникновения взаимоблокировки, поскольку в обеих транзакциях используется совмещаемая блокировка.
В этом случае истекает время ожидания одной или обеих операций. В этом сценарии блокировка обновления может препятствовать такой взаимоблокировке.

## <a name="next-steps"></a>Дальнейшие действия

* [Работа с Reliable Collections](service-fabric-work-with-reliable-collections.md)
* [Уведомления Reliable Services](service-fabric-reliable-services-notifications.md)
* [Архивация и восстановление (аварийное восстановление) надежных служб](service-fabric-reliable-services-backup-restore.md)
* [Конфигурация диспетчера надежных состояний](service-fabric-reliable-services-configuration.md)
* [Справочник разработчика по надежным коллекциям](/dotnet/api/microsoft.servicefabric.data.collections#microsoft_servicefabric_data_collections)
