---
title: Проверка подлинности на основе сертификата X. 509 в кластере Service Fabric
description: Узнайте о проверке подлинности на основе сертификатов в Service Fabric кластерах и о том, как обнаруживать, устранять и устранять проблемы, связанные с сертификатами.
ms.topic: conceptual
ms.date: 03/16/2020
ms.openlocfilehash: 2d94e5cc78afbabde38eb38e0c4f89381bd67167
ms.sourcegitcommit: c27a20b278f2ac758447418ea4c8c61e27927d6a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/03/2021
ms.locfileid: "101729697"
---
# <a name="x509-certificate-based-authentication-in-service-fabric-clusters"></a>Проверка подлинности на основе сертификата X. 509 в кластерах Service Fabric

В этой статье приводятся общие сведения о [Service Fabric безопасности кластера](service-fabric-cluster-security.md)и рассматривается проверка подлинности на основе сертификатов в кластерах Service Fabric. Предполагается, что читатель знаком с основными концепциями безопасности, а также с элементами управления, которые Service Fabric предоставляет для управления безопасностью кластера.  

Темы, описываемые в этом заголовке:

* Основы проверки подлинности на основе сертификатов
* Удостоверения и соответствующие им роли
* Правила конфигурации сертификатов
* Устранение неполадок и часто задаваемые вопросы

## <a name="certificate-based-authentication-basics"></a>Основы проверки подлинности на основе сертификатов
В качестве краткого обновления в системе безопасности сертификат — это инструмент, предназначенный для привязки информации о сущности (субъекте) к их владению с парой асимметричных криптографических ключей. Таким образом образуется основная конструкция шифрования с открытым ключом. Ключи, представленные в сертификате, можно использовать для защиты данных или для подтверждения подлинности владельцев ключей. При использовании в сочетании с системой инфраструктуры открытых ключей сертификат может представлять дополнительные признаки субъекта, например владение доменом Интернета или определенные привилегии, предоставленные ему издателем сертификата (известного как центр сертификации или ЦС). Типичное применение сертификатов — это поддержка протокола TLS, обеспечивающая безопасную связь через компьютерную сеть. В частности, клиент и сервер используют сертификаты для обеспечения конфиденциальности и целостности связи, а также для проведения взаимной проверки подлинности.

В Service Fabric фундаментальный уровень кластера (Федерации) также строится на TLS (помимо других протоколов) для обеспечения надежной и безопасной сети участвующих узлов. Подключения к кластеру через API-интерфейсы Service Fabric клиента используют TLS, а также для защиты трафика и для установки удостоверений сторон. В частности, при использовании для проверки подлинности в Service Fabric сертификат можно использовать для подтверждения следующих утверждений: a) выступающий учетные данные сертификата имеют закрытый ключ сертификата b) сертификат SHA-1 сертификата (' Thumbprint ') соответствует объявлению, входящему в определение кластера, или c) общее имя субъекта сертификата соответствует объявлению, входящему в определение кластера. , а издатель сертификата известен или является доверенным.

В приведенном выше списке "b" — разговорной речи, известный как "закрепление отпечатков"; в этом случае объявление относится к определенному сертификату, а сила схемы проверки подлинности остается в том, что она нецелесообразна для подделки сертификата, который создает то же значение хэша, что и другой, и в то же время является допустимым, правильно сформированным объектом во всех остальных отношениях. Элемент "c" представляет альтернативную форму для объявления сертификата, в котором сила схемы наследуется по сочетанию субъекта сертификата и центра выдачи. В этом случае объявление относится к классу сертификатов — все два сертификата с одинаковыми характеристиками считаются полностью эквивалентными. 

В следующих разделах подробно объясняется, как среда выполнения Service Fabric использует и проверяет сертификаты для обеспечения безопасности кластера.

## <a name="identities-and-their-respective-roles"></a>Удостоверения и соответствующие им роли
Прежде чем углубляться в подробные сведения о проверке подлинности или защите каналов связи, важно перечислить участвующие субъекты и соответствующие роли, которые они играют в кластере:
- среда выполнения Service Fabric, называемая "System": набор служб, предоставляющий абстракции и функциональные возможности, представляющие кластер. При обращении между экземплярами системы в кластере используется термин "удостоверение кластера"; При ссылке на кластер в качестве получателя или целевого объекта трафика, находящегося за пределами кластера, мы будем использовать термин "удостоверение сервера".
- размещенные приложения, называемые "приложения": код, предоставленный владельцем кластера, который управляется и выполняется в кластере.
- Клиенты: сущности, которым разрешено подключаться к и выполнять функции в кластере в соответствии с конфигурацией кластера. Мы различим два уровня привилегий — "User" и "admin" соответственно. Клиент "пользователь" ограничен главным образом операциями только для чтения (но не всеми функциями только для чтения), тогда как "клиент" admin "имеет неограниченный доступ к функциональности кластера. (Дополнительные сведения см. в разделе [роли безопасности в кластере Service Fabric](service-fabric-cluster-security-roles.md).)
- (Только для Azure) службы Service Fabric, которые координирующи и предоставляют элементы управления для операций и управления Service Fabric кластерами, называемые просто "службой". В зависимости от среды служба может ссылаться на поставщик ресурсов Service Fabric Azure или на других поставщиков ресурсов, принадлежащих и обслуживаемых Группой Service Fabric.

В защищенном кластере каждая из этих ролей может быть настроена с помощью собственного, уникального удостоверения, объявленного как связывание предопределенного имени роли и соответствующих учетных данных. Service Fabric поддерживает объявление учетных данных в качестве сертификатов или субъекта-службы на основе домена. (Удостоверения Windows-/Керберос-басед также поддерживаются, но выходят за рамки этой статьи. см. раздел [безопасность на основе Windows в Service Fabric кластерах](service-fabric-windows-cluster-windows-security.md).) В кластерах Azure роли клиентов также могут быть объявлены как [удостоверения на основе Azure Active Directory](service-fabric-cluster-creation-setup-aad.md).

Как упомянуто, среда выполнения Service Fabric определяет два уровня привилегий в кластере: "admin" и "User". Клиент с правами администратора и компонент System будут использовать права "admin", поэтому они не различаются друг от друга. При установлении соединения в или в кластере в качестве базы для последующей авторизации будет Service Fabric предоставляться вызывающий объект, прошедший проверку подлинности, с помощью одной из двух ролей. Подробнее рассмотрим проверку подлинности в следующих разделах.

## <a name="certificate-configuration-rules"></a>Правила конфигурации сертификатов
### <a name="validation-rules"></a>Правила проверки
Параметры безопасности кластера Service Fabric описывают, в принципе, следующие аспекты:
- тип проверки подлинности; это неизменяемая характеристика кластера. Примеры таких параметров: "параметра clustercredentialtype значение", "Servercredentialtype значение" и допустимые значения: "None", "x509" или "Windows". Эта статья посвящена проверке подлинности типа x509.
- правила проверки подлинности; Эти параметры задаются владельцем кластера и описывают, какие учетные данные должны приниматься для данной роли. Примеры будут подробно рассмотрены ниже.
- параметры, используемые для корректировки или изменения результата проверки подлинности. Примеры включают в себя флаги (de-) принудительное применение списков отзыва сертификатов и т. д.

> [!NOTE]
> Примеры конфигурации кластера, приведенные ниже, являются выдержками из манифеста кластера в формате XML в качестве наиболее дайджестного формата, который поддерживает непосредственно Service Fabric функциональности, описанной в этой статье. Те же параметры можно выразить непосредственно в представлениях JSON определения кластера, независимо от того, является ли он автономным манифестом кластера JSON или шаблоном для управляемого ресурса Azure.

Правило проверки сертификата состоит из следующих элементов:
- соответствующая роль: Клиент, клиент администрирования (привилегированная роль)
- учетные данные, принятые для роли, объявленные либо по отпечатку, либо в общем имени субъекта

#### <a name="thumbprint-based-certificate-validation-declarations"></a>Объявления проверки сертификата на основе отпечатков
В случае правил проверки на основе отпечатка учетные данные, представленные вызывающим объектом, запрашивающим соединение в кластере, будут проверяться следующим образом:
  - учетные данные являются допустимым, правильно сформированным сертификатом: его цепочка может быть построена, совпадают сигнатуры
  - сертификат действителен по времени (NotBefore <= теперь < NotAfter)
  - хэш SHA-1 сертификата соответствует объявлению, так как сравнение строк без учета регистра за исключением всех пробелов

Все ошибки доверия, обнаруженные во время построения цепочки или проверки, будут подавлены для объявлений на основе отпечатка, за исключением просроченных сертификатов, но для этого случая также существуют подготавливается. В частности, ошибки, связанные с: состояние отзыва неизвестно или находится в автономном режиме, недоверенный корень, недопустимое использование ключа, частичная цепочка считается неустранимыми ошибками. в данном случае, в этом случае сертификат является просто оболочкой для пары ключей. безопасность заключается в том, что владелец кластера установил меры для защиты закрытого ключа.

Следующий фрагмент из манифеста кластера обладает такой набор правил проверки на основе отпечатков:

```xml
<Section Name="Security">
  <Parameter Name="ClusterCredentialType" Value="X509" />
  <Parameter Name="ServerAuthCredentialType" Value="X509" />
  <Parameter Name="AdminClientCertThumbprints" Value="d5ec...4264" />
  <Parameter Name="ClientCertThumbprints" Value="7c8f...01b0" />
  <Parameter Name="ClusterCertThumbprints" Value="abcd...1234,ef01...5678" />
  <Parameter Name="ServerCertThumbprints" Value="ef01...5678" />
</Section>
```

Каждая из приведенных выше записей ссылается на определенное удостоверение, как описано выше. Каждая запись также позволяет указать несколько значений в виде списка строк с разделителями-запятыми. В этом примере после успешной проверки входящих учетных данных выступающий сертификат с отпечатком SHA-1 5ec... 4264 "будет предоставлена роль" admin "; и наоборот, вызывающий код проходит проверку подлинности с помощью сертификата ' 7c8f... 01b0 "будет предоставлена роль" пользователь ", которая ограничена главными операциями только для чтения. Входящий вызывающий объект, представляющий сертификат, отпечаток которого имеет значение ABCD... 1234 ' или ' ef01... 5678 "будет принят как одноранговый узел в кластере. Наконец, клиент, подключающийся к конечной точке управления кластера, будет ждать, что отпечаток сертификата сервера будет иметь значение "ef01... 5678. 

Как упоминалось ранее, Service Fabric выполняет подготовку к приему сертификатов с истекшим сроком действия; Причина в том, что сертификаты имеют ограниченное время существования, и, если они объявлены по отпечатку (который ссылается на конкретный экземпляр сертификата), что позволяет истечению срока действия сертификата привести к сбою подключения к кластеру или по правому свертыванию кластера. Очень просто забыть или не пропустить поворот сертификата, прикрепленного к отпечатку, и, увы, восстановление из такой ситуации усложняется.

Для этого владелец кластера может явно указать, что самозаверяющие сертификаты, объявленные с помощью отпечатка, будут считаться действительными, как показано ниже.

```xml
  <Section Name="Security">
    <Parameter Name="AcceptExpiredPinnedClusterCertificate" Value="true" />
  </Section>
```
Это поведение не распространяется на сертификаты, выданные ЦС; Если это так, отозванный сертификат с истекшим сроком действия может стать действительным, как только он больше не будет отображаться в списке отзыва сертификатов ЦС и, таким образом, станет представлять угрозу безопасности. При использовании самозаверяющих сертификатов владелец кластера считается единственной стороной, ответственной за защиту закрытого ключа сертификата, что не так с сертификатами, выданными ЦС. владелец кластера может не знать, как или когда сертификат был объявлен скомпрометированным.

#### <a name="common-name-based-certificate-validation-declarations"></a>Общие объявления проверки сертификатов на основе имен
Общие объявления на основе имен принимают одну из следующих форм:
- Общее имя субъекта (только)
- Общее имя субъекта с закреплением издателя

Мы сначала рассмотрим выдержку из манифеста кластера, ексемплифинг оба стиля объявления:
```xml
    <Section Name="Security/ServerX509Names">
      <Parameter Name="server.demo.system.servicefabric.azure-int" Value="" />
    </Section>
    <Section Name="Security/ClusterX509Names">
      <Parameter Name="cluster.demo.system.servicefabric.azure-int" Value="1b45...844d,d7fe...26c8,3ac7...6960,96ea...fb5e" />
    </Section>
```
Объявления ссылаются на удостоверения сервера и кластера соответственно; Обратите внимание, что объявления на основе CN имеют собственные разделы в манифесте кластера, отделены от стандартного уровня безопасности. В обоих объявлениях "имя" представляет различающееся имя общего субъекта сертификата, а поле "значение" представляет ожидаемого издателя, как показано ниже:

- в первом случае объявление указывает, что элемент общего имени отличительного субъекта сертификата сервера должен соответствовать строке "server.demo.sysTEM. servicefabric. Azure-int"; пустое поле "значение" указывает на то, что корень цепочки сертификатов является доверенным для узла или компьютера, на котором проверяется сертификат сервера. в Windows это означает, что сертификат может быть связан с любыми сертификатами, установленными в хранилище "доверенный корневой ЦС".
- во втором случае в объявлении указывается, что выступающий сертификат принимается в качестве однорангового узла в кластере, если общее имя сертификата совпадает со строкой "cluster.demo.sysTEM. servicefabric. Azure-int", *а* отпечаток прямого издателя сертификата соответствует одной из записей с разделителями-запятыми в поле "значение". (Этот тип правила — разговорной речи, известный как "Общее имя с закреплением издателя".)

В любом случае Цепочка сертификата создается, и предполагается, что оно будет свободно без ошибок. то есть ошибки отзыва, частичная цепочка или недопустимые ошибки доверия считаются неустранимыми, и проверка сертификата завершится ошибкой. Закрепление издателей приведет к тому, что состояние "недоверенный корень" не является неустранимой ошибкой; Несмотря на внешний вид, это является более строгой формой проверки, так как позволяет владельцу кластера ограничивать набор разрешенных и обслуживаемых издателей собственной PKI.

После сборки цепочки сертификатов она проверяется по стандартной политике TLS/SSL с объявленной темой в качестве удаленного имени. сертификат будет считаться соответствующим, если его общее имя субъекта или любое из его альтернативных имен совпадает с объявлением CN из манифеста кластера. В этом случае поддерживаются подстановочные знаки, а при сопоставлении строк регистр не учитывается.

(Необходимо уточнить, что приведенная выше последовательность может быть выполнена для каждого типа использования ключа, объявленного сертификатом. Если сертификат указывает на использование ключа проверки подлинности клиента, цепочка создается и оценивается первой для клиентской роли. В случае успеха вычисление завершается успешно и проверка прошла удачно. Если сертификат не использует проверку подлинности клиента или проверка не пройдена, то среда выполнения Service Fabric создаст и вычислит подлинность сервера в цепочке.)

Чтобы выполнить пример, приведенный ниже фрагмент иллюстрирует объявление сертификатов клиента по общему имени:
```xml
    <Section Name="Security/AdminClientX509Names">
      <Parameter Name="admin.demo.client.servicefabric.azure-int" Value="1b45...844d,d7fe...26c8,3ac7...6960,96ea...fb5e" />
    </Section>
    <Section Name="Security/ClientX509Names">
      <Parameter Name="user.demo.client.servicefabric.azure-int" Value="1b45...844d,d7fe...26c8,3ac7...6960,96ea...fb5e" />
    </Section>
```

Приведенные выше объявления соответствуют идентификаторам администратора и пользователя соответственно. Проверка сертификатов, объявленных таким способом, точно описана в предыдущих примерах сертификатов кластера и сервера.

> [!NOTE]
> Общие объявления на основе имен предназначены для упрощения вращения, а обычно для управления сертификатами кластера. Однако рекомендуется соблюдать следующие рекомендации, чтобы обеспечить непрерывную доступность и безопасность кластера.
  * предпочитать подкрепление издателя для полагаться на доверенные корни
  * Старайтесь не смешивать издателей из разных PKI
  * Убедитесь, что в объявлении сертификата указаны все ожидаемые издатели. несоответствие издателя приведет к неудачной проверке
  * Убедитесь, что конечные точки политики сертификатов PKI доступны для обнаружения, доступности и доступности. Это означает, что конечные точки AIA, CRL или OCSP объявляются в конечном сертификате и доступны для завершения построения цепочки сертификатов.

Объедините все вместе. После получения запроса на подключение в кластере, защищенном с помощью сертификатов X. 509, среда выполнения Service Fabric будет использовать параметры безопасности кластера для проверки учетных данных удаленной стороны, как описано выше. в случае успешного выполнения считается, что вызывающая сторона или удаленная сторона проходила проверку подлинности. Если учетные данные соответствуют нескольким правилам проверки, среда выполнения предоставит вызывающей роли наивысшего уровня для любого из сопоставленных правил. 

### <a name="presentation-rules"></a>Правила представления
В предыдущем разделе описано, как проверка подлинности работает в кластере, защищенном с помощью сертификатов. в этом разделе объясняется, как сама среда выполнения Service Fabric обнаруживает и загружает сертификаты, используемые для обмена данными в кластере. Мы вызываем эти правила «презентации».

Как и в случае с правилами проверки, правила представления указывают роль и связанное объявление учетных данных, выраженное либо отпечатком, либо общим именем. В отличие от правил проверки, общие объявления на основе имен не имеют подположений для закрепления издателя. Это обеспечивает большую гибкость, а также повышает производительность. Правила представления объявляются в разделе "NodeType" манифеста кластера для каждого отдельного типа узла. Параметры разбиваются из разделов безопасности кластера, чтобы обеспечить полную конфигурацию каждого типа узла в одном разделе. В кластерах Service Fabric Azure объявления сертификата типа узла по умолчанию соответствуют соответствующим параметрам в разделе Безопасность определения кластера.

#### <a name="thumbprint-based-certificate-presentation-declarations"></a>Объявления представления сертификатов на основе отпечатков
Как было описано выше, среда выполнения Service Fabric различает ее роль в качестве однорангового узла других узлов в кластере, а также как сервер для операций управления кластерами. В принципе, эти параметры можно настроить по отдельности, но на практике они обычно выводятся. В оставшейся части этой статьи предполагается, что параметры соответствуют простоте.

Рассмотрим следующий фрагмент манифеста кластера:
```xml
  <NodeTypes>
    <NodeType Name="nt1vm">
      <Certificates>
        <ClusterCertificate X509FindType="FindByThumbprint" X509FindValue="cc71...1984" X509FindValueSecondary="49e2...19d6" X509StoreName="my" Name="ClusterCertificate" />
        <ServerCertificate X509FindValue="cc71...1984" Name="ServerCertificate" />
        <ClientCertificate X509FindValue="cc71...1984" Name="ClientCertificate" />
      </Certificates>
    </NodeType>
  </NodeTypes>
```
Элемент "параметров clustercertificate" демонстрирует полную схему, включая необязательные параметры ("X509FindValueSecondary"), или те, которые имеют соответствующие значения по умолчанию (' заданного параметром x509storename '). в других объявлениях отображается сокращенная форма. В описании сертификата кластера указано, что параметры безопасности узлов типа "nt1vm" инициализируются с помощью сертификата "cc71. 1984 "в качестве первичного и" 49e2.. 19d6 "сертификат как вторичный; Предполагается, что оба сертификата находятся в \' хранилище сертификатов LocalMachine My (или в аналогичном пути Linux, *var/lib/сфцертс*).

#### <a name="common-name-based-certificate-presentation-declarations"></a>Объявления представления общих сертификатов на основе имен
Сертификаты типа узла также можно объявить по общему имени субъекта, как показано ниже содержащиеся:

```xml
  <NodeTypes>
    <NodeType Name="nt1vm">
      <Certificates>
        <ClusterCertificate X509FindType="FindBySubjectName" X509FindValue="demo.cluster.azuredocpr.system.servicefabric.azure-int" Name="ClusterCertificate" />
      </Certificates>
    </NodeType>
  </NodeTypes>
```

Для объявления любого типа Service Fabric узел будет считывать конфигурацию при запуске, искать и загружать указанные сертификаты и сортировать их в порядке убывания их атрибутов NotBefore. сертификаты с истекшим сроком действия игнорируются, а первый элемент списка выбирается в качестве учетных данных клиента для любого Service Fabric подключения, попыток которого попытался этот узел. (Фактически, Service Fabric подходит к последнему выданному сертификату.)

> [!NOTE]
> До версии 7.2.445 (7,2 CU4) Service Fabric выбрали самый крайний срок действия сертификата (сертификат с самым крайним свойством "NotAfter").

Обратите внимание, что для объявлений представления на основе общих имен сертификат считается соответствующим, если его общее имя субъекта равно полю X509FindValue (или X509FindValueSecondary) в объявлении в виде точного сравнения строк с учетом регистра. Это отличается от правил проверки, которые поддерживают сопоставление с подстановочными знаками, а также сравнение строк без учета регистра.  

### <a name="miscellaneous-certificate-configuration-settings"></a>Прочие параметры конфигурации сертификатов
Ранее упоминалось, что параметры безопасности кластера Service Fabric позволяют незначительно изменять поведение кода проверки подлинности. Хотя в статье [Service Fabric параметры кластера](service-fabric-cluster-fabric-settings.md) представлены исчерпывающий и наиболее актуальный список параметров, мы расскажем о выборе некоторых параметров безопасности здесь, чтобы завершить полное предоставление проверки подлинности на основе сертификатов. Для каждого параметра будет объяснено назначение, значение по умолчанию и поведение, как это влияет на проверку подлинности и какие значения приемлемы.

Как уже упоминалось, проверка сертификата всегда подразумевает создание и оценку цепочки сертификатов. Для сертификатов, выданных ЦС, этот простой вызов API ОС обычно включает несколько исходящих вызовов к различным конечным точкам выдающего PKI, кэширования ответов и т. д. Учитывая распространенность вызовов проверки сертификатов в кластере Service Fabric, любые проблемы в конечных точках PKI могут привести к снижению доступности кластера или к неправильной декомпозиции. Хотя исходящие вызовы не могут быть подавлены (Дополнительные сведения об этом см. ниже в разделе часто задаваемых вопросов), можно использовать следующие параметры для маскирования ошибок проверки, вызванных неудачными вызовами CRL.

  * Крлчеккингфлаг — в разделе "безопасность" строка, преобразованная в UINT. Значение этого параметра используется Service Fabric для маскирования ошибок состояния цепочки сертификатов путем изменения поведения построения цепочки; Он передается в вызов Win32 CryptoAPI [CertGetCertificateChain](/windows/win32/api/wincrypt/nf-wincrypt-certgetcertificatechain) в качестве параметра "dwFlags" и может быть установлен в любое допустимое сочетание флагов, принимаемых функцией. Значение 0 заставляет среду выполнения Service Fabric игнорировать любые ошибки состояния доверия — это не рекомендуется, поскольку его использование может привести к значительному раскрытию безопасности. Значение по умолчанию — 0x40000000 (CERT_CHAIN_REVOCATION_CHECK_CHAIN_EXCLUDE_ROOT).

  Когда следует использовать: для локального тестирования с самозаверяющими сертификатами или сертификатами разработчика, которые не полностью сформированы или не имеют надлежащей инфраструктуры открытых ключей для поддержки сертификатов. Также может использоваться в качестве решения проблем в средах Air-гаппед во время перехода между PKI.

  Как использовать. мы рассмотрим пример, который вызывает проверку отзыва для доступа только к кэшированным URL-адресам. Предположим
  ```C++
  #define CERT_CHAIN_REVOCATION_CHECK_CACHE_ONLY         0x80000000
  ```
  затем объявление в манифесте кластера выглядит следующим образом:
  ```xml
    <Section Name="Security">
      <Parameter Name="CrlCheckingFlag" Value="0x80000000" />
    </Section>
  ```

  * Игнорекрлоффлиниррор — в разделе "безопасность" — логическое значение со значением по умолчанию "false". Представляет ярлык для подавления состояния ошибки построения цепочки "в сети отзыва" (или последующего состояния ошибки проверки политики цепочки).

  Когда следует использовать: Локальное тестирование или с сертификатами разработчика, которые не поддерживаются соответствующей PKI. Используйте как устранение рисков в средах Air-гаппед или когда известно, что инфраструктура PKI недоступна.

  Как использовать:
  ```xml
    <Section Name="Security">
      <Parameter Name="IgnoreCrlOfflineError" Value="true" />
    </Section>
  ```

  Другие важные параметры (все в разделе "безопасность"):
  * Акцептекспиредпиннедклустерцертификате — рассматривается в разделе, посвященном проверке сертификата на основе отпечатка. разрешает принимать просроченные самозаверяющие сертификаты кластера. 
  * Цертификатикспирисафетимаргин — интервал, выраженный в минутах до отметка времени NotAfter сертификата, в течение которого сертификат считается риском для истечения срока действия. Service Fabric отслеживает сертификаты кластера и периодически выдает отчеты о работоспособности по их оставшейся доступности. В пределах интервала "безопасность" эти отчеты о работоспособности имеют состояние "предупреждение". По умолчанию используется значение 30 дней.
  * Цертификатехеалсрепортингинтервал — управляет частотой отчетов о работоспособности, касающихся оставшегося времени действия сертификатов кластера. Отчеты будут выдаваться только один раз за этот интервал. Значение выражается в секундах со значением по умолчанию 8 часов.
  * Енфорцепревалидатиононсекуритичанжес — логическое значение. управляет поведением обновления кластера при обнаружении изменений параметров безопасности. Если задано значение true, то при обновлении кластера будет предпринята попытка убедиться, что по крайней мере один из сертификатов, соответствующих любому из правил представления, может передать соответствующее правило проверки. Предварительная проверка выполняется до применения новых параметров к любому узлу, но только на узле, где размещается первичная реплика службы диспетчера кластеров на момент запуска обновления. На момент написания этой статьи параметр имеет значение по умолчанию "false" и будет иметь значение "true" для новых кластеров Azure Service Fabric с версией среды выполнения, начинающейся с 7,1.
 
### <a name="end-to-end-scenario-examples"></a>Сквозной сценарий (примеры)
Мы рассмотрели правила представления, правила проверки и настройки флагов, но как это работает вместе? В этом разделе мы рассмотрим два комплексных примера, демонстрирующих использование параметров безопасности для безопасного обновления кластера. Обратите внимание, что это не является исчерпывающим electionsм по надлежащему управлению сертификатами в Service Fabric. Ознакомьтесь с сопутствующей статьей по этому вопросу.

Разделение правил представления и проверки представляет очевидный вопрос (или проблему) того, могут ли они расследоваться, и каковы последствия. Это действительно возможно, что выбор узла сертификата проверки подлинности не передаст правила проверки другого узла. На самом деле, это несоответствие является основной причиной инцидентов, связанных с проверкой подлинности. В то же время разделение этих правил позволяет кластеру продолжать работу во время обновления, что изменяет параметры безопасности кластера. Рассмотрите, что, добавив первыми правила проверки в качестве первого шага, все узлы кластера будут объединять новые параметры, не используя текущие учетные данные. 

Помните, что в Service Fabricном кластере обновление выполняется через (до 5) "домены обновления" или доменов обновления. Только узлы в текущем обновления обновляются или изменяются в определенный момент времени, а обновление переходит к следующему обновления только в том случае, если доступ к кластеру разрешен. (Дополнительные сведения см. в разделе [Service Fabric обновления кластера](service-fabric-cluster-upgrade.md) и другие статьи по этой теме.) Изменения сертификата и безопасности особенно опасны, так как они могут изолировать узлы от кластера или оставить кластер на границе потери кворума.

Для описания параметров безопасности узла мы будем использовать следующую нотацию:

NK: {П:{ТП = A}, В:{ТП = A}}, где:
  - "NK" представляет узел в домене обновления *k*
  - "P" представляет правила текущей презентации узла (предполагается, что мы будем ссылаться только на сертификаты кластера); 
  - "V" представляет текущие правила проверки узла (только для сертификата кластера)
  - "TP = A" представляет объявление на основе отпечатка (TP), а "A" — отпечаток сертификата
  - "CN = B" представляет общее объявление на основе имени (CN), где "B" является общим именем субъекта сертификата 

#### <a name="rotating-a-cluster-certificate-declared-by-thumbprint"></a>Вращение сертификата кластера, объявленного отпечатком
В следующей последовательности описывается, как можно использовать 2-этапное обновление, чтобы безопасно ввести сертификат вторичного кластера, объявленный отпечатком. Первый этап представляет новое объявление сертификата в правилах проверки, а второй этап представляет его в правилах представления.
  - начальное состояние: N0 = {П:{ТП = A}, В:{ТП = A}},... NK = {П:{ТП = A}, В:{ТП = A}} — кластер находится в неактивных настройках, все узлы используют общую конфигурацию.
  - После завершения обновления домена 0: N0 = {П:{ТП = A}, В:{ТП = A, TP = B}},... NK = {П:{ТП = A}, В:{ТП = A}} — узлы в ДО0 будут представлять сертификат а и принимают сертификаты A или B; все остальные узлы представлены и принимают только сертификат A
  - После завершения последнего домена обновления: N0 = {П:{ТП = A}, В:{ТП = A, TP = B}},... NK = {П:{ТП = A}, В:{ТП = A, TP = B}} — все узлы представляют сертификат A, все узлы принимают сертификат A или B.
      
На этом этапе кластер снова находится в равновесия, а второй этап обновления и изменения параметров безопасности может начаться:
  - После завершения обновления домена 0: N0 = {П:{ТП = A, TP = B}, В:{ТП = A, TP = B}},... NK = {П:{ТП = A}, В:{ТП = A, TP = B}}. узлы в ДО0 будут начинать представление B, которое принимается любым другим узлом в кластере.
  - После завершения последнего домена обновления: N0 = {П:{ТП = A, TP = B}, В:{ТП = A, TP = B}},... NK = {П:{ТП = A, TP = B}, В:{ТП = A, TP = B}}-все узлы переключены на представление сертификата B. сертификат A теперь можно снять с учета или удалить из определения кластера с помощью последующего набора обновлений.

#### <a name="converting-a-cluster-from-thumbprint--to-common-name-based-certificate-declarations"></a>Преобразование кластера из отпечатка в объявления сертификатов на основе общих имен
Аналогичным образом, изменение типа объявления сертификата (с отпечатка на общее имя) будет соответствовать тому же шаблону, что и выше. Обратите внимание, что правила проверки позволяют объявлять сертификаты данной роли по отпечатку и общему имени в одном и том же определении кластера. Однако, напротив, правила представления позволяют использовать только одну форму объявления. Кстати, надежный подход к преобразованию сертификата кластера с отпечатка на общее имя состоит в том, чтобы ввести предполагаемый целевой сертификат сначала по отпечатку, а затем изменить это объявление на общую единицу на основе имени. В следующем примере предполагается, что отпечаток и общее имя субъекта "B" ссылаются на один и тот же сертификат. 

  - начальное состояние: N0 = {П:{ТП = A}, В:{ТП = A}},... NK = {П:{ТП = A}, В:{ТП = A}} — кластер находится в неактивных настройках, все узлы используют общую конфигурацию с отпечаткой основного сертификата.
  - После завершения обновления домена 0: N0 = {П:{ТП = A}, В:{ТП = A, CN = B}},... NK = {П:{ТП = A}, В:{ТП = A}} — узлы в ДО0 будут представлять сертификат а и принимать сертификаты с отпечатком A или общим именем B; все остальные узлы представлены и принимают только сертификат A
  - После завершения последнего домена обновления: N0 = {П:{ТП = A}, В:{ТП = A, CN = B}},... NK = {П:{ТП = A}, В:{ТП = A, CN = B}} — все узлы представляют сертификат A, все узлы принимают сертификат A (TP) или B (CN).

На этом этапе можно продолжить изменение правил представления при последующем обновлении:
  - После завершения обновления домена 0: N0 = {П:{кН = B}, В:{ТП = A, CN = B}},... NK = {П:{ТП = A}, В:{ТП = A, CN = B}}. узлы в ДО0 будут представлять сертификат б, обнаруженный CN, и принимают сертификаты с отпечатком A или общим именем B; все остальные узлы представлены и принимают только сертификаты A, выбранные по отпечатку
  - После завершения последнего домена обновления: N0 = {П:{кН = B}, В:{ТП = A, CN = B}},... NK = {П:{кН = B}, В:{ТП = A, CN = B}} — все узлы представляют сертификат B, обнаруженный CN, все узлы принимают либо сертификат A (TP), либо B (CN).
    
Завершение фазы 2 также помечает преобразование кластера в Общие сертификаты на основе имени; объявления проверки на основе отпечатков можно удалить в последующем обновлении кластера.

> [!NOTE]
> В кластерах Service Fabric Azure рабочие процессы, описанные выше, управляются поставщиком ресурсов Service Fabric. Владелец кластера по-прежнему отвечает за подготовку сертификатов в кластере в соответствии с указанными правилами (представлением или проверкой), и рекомендуется выполнять изменения в нескольких шагах.

В отдельной статье мы будем обращаться к разделу об управлении и подготовке сертификатов в кластере Service Fabric.

## <a name="troubleshooting-and-frequently-asked-questions"></a>Устранение неполадок и часто задаваемые вопросы
При отладке проблем, связанных с проверкой подлинности, в Service Fabric кластерах непросто, мы хопефул следующие указания и советы. Самый простой способ начать исследование — изучить журналы событий Service Fabric на узлах кластера — не обязательно только те, которые показывают симптомы, но и узлы, которые не могут подключиться к одному из их соседей. В Windows события значимости обычно регистрируются в каналах "приложения и службы Логс\микрософт-сервицефабрик\админ" или "рабочие" соответственно. Иногда может быть полезно [включить ведение журнала CAPI2](/archive/blogs/benjaminperkins/enable-capi2-event-logging-to-troubleshoot-pki-and-ssl-certificate-issues), чтобы получить дополнительные сведения о проверке сертификата, получении списка CRL/CTL и т. д. (не забудьте отключить его после завершения воспроизведения, он может быть довольно подробным.)

Типичные симптомы, возникающие в кластере при возникновении проблем с проверкой подлинности: 
  - узлы отключены или циклически 
  - попытки подключения отклоняются
  - время ожидания попыток подключения истекло

Каждая из симптомов может быть вызвана разными проблемами, и одна и та же основная причина может показывать разные манифесты. Таким образом, мы просто перечислим небольшой пример типичных проблем с рекомендациями по их устранению. 

* Узлы могут обмениваться сообщениями, но не могут подключаться. Возможной причиной прекращения попытки подключения является ошибка "сертификат не соответствует" — одна из сторон в подключениях типа "Service Fabric-Service Fabric" представляет сертификат, который не выполняет правила проверки получателя. Может сопровождаться одной из следующих ошибок: 
  ```C++
  0x80071c44    -2147017660 FABRIC_E_SERVER_AUTHENTICATION_FAILED
  ```
  Для дальнейшей диагностики и дальнейшего изучения: на каждом из узлов, пытающихся подключиться, определите, какой сертификат будет представлен. Проверьте сертификат и попробуйте смоделировать правила проверки (проверьте наличие отпечатка или общего имени, проверьте отпечатки издателя, если они указаны).

  Другим распространенным сопутствующим кодом ошибки может быть:
  ```C++
  0x800b0109    -2146762487 CERT_E_UNTRUSTEDROOT
  ```
  В этом случае сертификат объявляется по общему имени и применяется одно из следующих условий.
    - издатели не закреплены, а корневой сертификат не является доверенным или
    - Издатели закреплены, но объявление не включает отпечаток прямого издателя этого сертификата.

* Узел работает, но не может подключиться к другим узлам; другие узлы не получают входящий трафик от узла, на котором происходит сбой. В этом случае возможна ошибка загрузки сертификата на локальном узле. Найдите следующие ошибки:
  - сертификат не найден — убедитесь, что сертификаты, объявляемые в правилах представления, могут быть разрешены по содержимому хранилища сертификатов LocalMachine\My (или в указанном). 
    Возможные причины сбоя могут включать: 
      - недопустимые символы в объявлении отпечатка
      - сертификат не установлен
      - срок действия сертификата истек
      - объявление общего имени включает префикс "CN ="
      - в объявлении указан подстановочный знак, и в хранилище сертификатов не содержится точного соответствия (Объявление: CN = *. mydomain. com, фактический сертификат: CN = Server. mydomain. com)

  - неизвестные учетные данные — указывает отсутствующий закрытый ключ, соответствующий сертификату, обычно сопровождаемый кодом ошибки: 
    ```C++ 
    0x8009030d  -2146893043 SEC_E_UNKNOWN_CREDENTIALS
    0x8009030e  -2146893042 SEC_E_NO_CREDENTIALS
    ```
    Чтобы устранить проблему, проверьте наличие закрытого ключа. Убедитесь, что Сфадминс предоставлено разрешение "чтение | выполнение" для закрытого ключа.

  - Неверный тип поставщика — указывает сертификат CNG ("поставщик хранилища ключей программного обеспечения Майкрософт"); в настоящее время Service Fabric поддерживает только сертификаты CAPI1. Обычно сопровождается кодом ошибки:
    ```C++
    0x80090014  -2146893804 NTE_BAD_PROV_TYPE
    ```
    Чтобы устранить проблему, повторно создайте сертификат кластера с помощью CAPI1 (например, поставщика криптографических поставщиков Microsoft Enhanced RSA and AES). Дополнительные сведения о поставщиках шифрования см. в статье [Общие сведения о поставщиках служб шифрования](/windows/win32/seccertenroll/understanding-cryptographic-providers) .
