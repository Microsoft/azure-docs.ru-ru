---
title: Создание инфраструктуры для кластера в AWS
description: В этом руководстве содержатся сведения о настройке инфраструктуры AWS для запуска кластера Service Fabric.
ms.topic: tutorial
ms.date: 05/11/2018
ms.custom: mvc
ms.openlocfilehash: c7a18b0dcdc04bdf66ac4b36ce7376ee018eb238
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "91842909"
---
# <a name="tutorial-create-aws-infrastructure-to-host-a-service-fabric-cluster"></a>Руководство по созданию инфраструктуры AWS для размещения кластера Service Fabric

Изолированные кластеры Service Fabric предоставляют возможность выбрать собственную среду и создать кластер в рамках подхода "любая ОС, любое облако", который применяется на платформе Service Fabric. Из этой серии руководств вы узнаете, как создать изолированный кластер, размещенный в AWS, и установить в нем приложение.

Это руководство представляет первую часть цикла. В рамках этой статьи вы создадите ресурсы AWS, необходимые для размещения автономного кластера Service Fabric. В следующих статьях вам нужно будет установить автономный пакет Service Fabric, а также пример приложения в кластере, и наконец, очистить кластер.

В первой части цикла вы узнаете, как выполнять такие задачи:

> [!div class="checklist"]
> * Создание набора экземпляров EC2.
> * Изменение группы безопасности.
> * Вход на один из экземпляров.
> * Подготовка экземпляра для Service Fabric.

## <a name="prerequisites"></a>Предварительные требования

Для работы с этим руководством необходима учетная запись AWS.  Если у вас еще нет учетной записи, создайте ее, перейдя в [консоль AWS](https://aws.amazon.com/).

## <a name="create-ec2-instances"></a>Создание экземпляров EC2

Войдите в консоль AWS. В поле поиска введите **EC2** и выберите **EC2 Virtual Servers in the Cloud** (Виртуальные серверы EC2 в облаке).

![Поиск в консоли AWS][aws-console]

Выберите **Launch Instance** (Запустить экземпляр), на следующем экране рядом с Microsoft Windows Server 2016 Base нажмите кнопку **Select** (Выбрать).

![Выбор экземпляра EC2][aws-ec2instance]

Выберите **t2.medium**, затем щелкните **Next: Configure Instance Details** (Далее. Настройка сведений об экземпляре). На следующем экране измените количество экземпляров на `3`, а затем выберите **Advanced Details** (Дополнительные сведения), чтобы развернуть этот раздел.

Чтобы подключить между собой виртуальные машины в Service Fabric, виртуальные машины, содержащие вашу инфраструктуру, должны иметь одинаковые учетные данные.  Существует два распространенных способа получения согласованных учетных данных: присоедините все виртуальные машины к одному домену или установите один и тот же пароль администратора на каждой виртуальной машине.  В этом руководстве вы зададите одинаковый пароль для всех экземпляров EC2, используя скрипт пользовательских данных.  В рабочей среде присоединение узлов к домену Windows более безопасно.

Введите следующий скрипт в поле пользовательских данных в консоли:

```powershell
<powershell>
$user = [adsi]"WinNT://localhost/Administrator,user"
$user.SetPassword("serv1ceF@bricP@ssword")
$user.SetInfo()
netsh advfirewall firewall set rule group="File and Printer Sharing" new enable=Yes
New-NetFirewallRule -DisplayName "Service Fabric Ports" -Direction Inbound -Action Allow -RemoteAddress LocalSubnet -Protocol TCP -LocalPort 135, 137-139, 445
</powershell>
```

После того, как вы ввели скрипт PowerShell, выберите **Review and Launch** (Просмотреть и запустить).

![Просмотр и запуск EC2][aws-ec2configure2]

На экране просмотра выберите **Launch** (Запустить).  Затем измените раскрывающийся список на **Proceed without a key pair** (Продолжить без пары ключей) и установите флажок, указывающий, что вы знаете пароль.

![Выбор пары ключей AWS][aws-keypair]

Наконец, выберите **Launch Instances** (Запустить экземпляры), а затем — **View Instances** (Просмотреть экземпляры).  У вас есть основа для созданного кластера Service Fabric, и теперь вам нужно добавить несколько окончательных конфигураций для самих экземпляров, чтобы подготовить их для настройки Service Fabric.

## <a name="modify-the-security-group"></a>Изменение группы безопасности.

Для службы Service Fabric между узлами кластера необходимо открыть несколько портов. Чтобы открыть эти порты в инфраструктуре AWS, выберите один из созданных вами экземпляров. Затем выберите имя группы безопасности, например **launch-wizard-1**. Теперь щелкните вкладку **Inbound** (Входящие).

Чтобы не сделать эти порты общедоступными, откройте их только для узлов в той же группе безопасности. Запишите идентификатор группы безопасности. В примере он имеет значение **sg c4fb1eba**.  Затем выберите **Изменить**.

Добавьте четыре правила в группу безопасности для зависимостей службы, а затем еще три для самой службы Service Fabric. Первое правило — разрешить трафик ICMP для базовой проверки подключений. Другие правила открывают необходимые порты для включения SMB и удаленного реестра.

Для первого правила выберите **Add Rule** (Добавить правило), затем в раскрывающемся меню выберите **All ICMP - IPv4** (Все ICMP — IPv4). Выберите поле ввода рядом с полем Custom (Настраиваемый) и введите записанный ранее идентификатор группы безопасности.

Выполните эту же процедуру для последних трех зависимостей.  Выберите **Add Rule** (Добавить правило), в раскрывающемся списке выберите **Custom TCP Rule** (Настраиваемое правило TCP), для каждого правила в поле диапазона портов введите одно из следующих значений: `135`, `137-139` или `445`. Наконец, в поле источника введите идентификатор группы безопасности.

![Порты группы безопасности][aws-ec2securityports]

Теперь, когда порты для зависимостей открыты, вам нужно выполнить тот же процесс для портов, которые служба Service Fabric использует для подключения. Выберите **Add Rule** (Добавить правило), в раскрывающемся списке выберите **Custom TCP Rule** (Настраиваемое правило TCP), в поле диапазона портов введите `20001-20031`, а в поле источника — группу безопасности.

Затем добавьте правило для диапазона временных портов.  Выберите **Add Rule** (Добавить правило), в раскрывающемся списке выберите **Custom TCP Rule** (Настраиваемое правило TCP), а в поле диапазона портов введите `20606-20861`. Наконец, в поле источника введите идентификатор группы безопасности.

Порты последних двух правил для Service Fabric сделайте общедоступными, чтобы вы могли управлять кластером Service Fabric с вашего персонального компьютера. Выберите **Add Rule** (Добавить правило), в раскрывающемся списке выберите **Custom TCP Rule** (Настраиваемое правило TCP), в поле диапазона портов введите `19000-19003` и `19080-19081`, а затем в раскрывающемся списке Source (Источник) выберите Anywhere (Везде).

Наконец, нужно просто открыть порт 8080, чтобы вы могли видеть развернутое приложение. Выберите **Add Rule** (Добавить правило), в раскрывающемся списке выберите **Custom TCP Rule** (Настраиваемое правило TCP), в поле диапазона портов введите `8080`, затем в раскрывающемся списке Source (Источник) выберите Anywhere (Везде).

Теперь все правила указаны. Щелкните **Сохранить**.

## <a name="connect-to-an-instance-and-validate-connectivity"></a>Подключение к экземпляру и проверка подключения

На вкладке группы безопасности в меню слева выберите **Instances** (Экземпляры).  Выберите каждый из созданных экземпляров и запишите их частные IP-адреса. Для приведенных ниже примеров будут использоваться адреса `172.31.21.141` и `172.31.20.163`.

После выбора одного из экземпляров для подключения всех IP-адресов щелкните правой кнопкой мыши экземпляр и выберите **Connect** (Подключить).  Здесь вы можете скачать RDP-файл для этого конкретного экземпляра.  Выберите **Download Remote Desktop File** (Скачать файл удаленного рабочего стола), а затем откройте загруженный файл, чтобы установить подключение к удаленному рабочему столу (RDP) для данного экземпляра.  При появлении запроса введите пароль `serv1ceF@bricP@ssword`.

![Загрузка файла удаленного рабочего стола][aws-rdp]

Как только вы успешно подключитесь к своему экземпляру, проверьте, возможно ли подключение между ними, а также обмен файлами.  Из записанных IP-адресов для всех экземпляров выберите тот, к которому вы в настоящее время не подключены. Нажмите кнопку **Пуск**, введите `cmd` и выберите **Командная строка**.

В этих примерах подключение RDP было установлено для IP-адреса 172.31.21.141. Затем выполняется проверка подключения к IP-адресу 172.31.20.163.

Чтобы проверить работу основного подключения, используйте команду ping.

```
ping 172.31.20.163
```

Если ваш результат выглядит следующим образом `Reply from 172.31.20.163: bytes=32 time<1ms TTL=128` и повторяется четыре раза, это означает, что ваше соединение между экземплярами работает.  Теперь с помощью следующей команды проверьте, работает ли SMB:

```
net use * \\172.31.20.163\c$
```

Она должна возвратить следующие выходные данные: `Drive Z: is now connected to \\172.31.20.163\c$.`.

## <a name="prep-instances-for-service-fabric"></a>Подготовка экземпляров для Service Fabric

Если вы создаете экземпляр с нуля, вам нужно выполнить несколько дополнительных шагов.  А именно: вам нужно будет проверить, запущен ли удаленный реестр, включен ли SMB и открыты ли необходимые порты для SMB и удаленного реестра.

С целью упрощения этого процесса вся эта работа была выполнена во время начальной загрузки экземпляров с помощью скрипта пользовательских данных.

Включить SMB можно с помощью команды PowerShell, которую вы уже использовали:

```powershell
netsh advfirewall firewall set rule group="File and Printer Sharing" new enable=Yes
```

Чтобы открыть порты в брандмауэре, выполните команду PowerShell:

```powershell
New-NetFirewallRule -DisplayName "Service Fabric Ports" -Direction Inbound -Action Allow -RemoteAddress LocalSubnet -Protocol TCP -LocalPort 135, 137-139, 445
```

## <a name="next-steps"></a>Дальнейшие действия

В первой части цикла вы узнали, как запустить три экземпляра EC2 и настроить их для установки Service Fabric:

> [!div class="checklist"]
> * Создание набора экземпляров EC2.
> * Изменение группы безопасности.
> * Вход на один из экземпляров.
> * Подготовка экземпляра для Service Fabric.

Перейдите ко второй части цикла, чтобы настроить Service Fabric на кластере.

> [!div class="nextstepaction"]
> [Руководство по установке и созданию кластера Service Fabric](service-fabric-tutorial-standalone-create-service-fabric-cluster.md)

<!-- IMAGES -->
[aws-console]: ./media/service-fabric-tutorial-standalone-cluster/aws-console.png
[aws-ec2instance]: ./media/service-fabric-tutorial-standalone-cluster/aws-ec2instance.png
[aws-ec2configure2]: ./media/service-fabric-tutorial-standalone-cluster/aws-ec2configure2.png
[aws-rdp]: ./media/service-fabric-tutorial-standalone-cluster/aws-rdp.png
[aws-ec2securityports]: ./media/service-fabric-tutorial-standalone-cluster/aws-ec2securityports.png
[aws-keypair]: ./media/service-fabric-tutorial-standalone-cluster/aws-keypair.png