---
title: Рекомендации по планированию загрузки кластера Service Fabric
description: Типы узлов, устойчивость, надежность и другие факторы, которые следует учитывать при планировании Service Fabric кластера.
ms.topic: conceptual
ms.date: 05/21/2020
ms.author: pepogors
ms.openlocfilehash: b3361337bb0cf60e47efe198aad7aa8cc20ae7b3
ms.sourcegitcommit: c27a20b278f2ac758447418ea4c8c61e27927d6a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/03/2021
ms.locfileid: "101714941"
---
# <a name="service-fabric-cluster-capacity-planning-considerations"></a>Рекомендации по планированию загрузки кластера Service Fabric

Планирование емкости кластера важно для каждой Service Fabric рабочей среды. Ключевые моменты:

* **Начальное число и свойства *типов узлов* кластера**

* **Уровень *устойчивости* каждого типа узла**, который определяет Service Fabric привилегий виртуальной машины в инфраструктуре Azure.

* **Уровень *надежности* кластера**, который определяет стабильность Service Fabric системных служб и общей функции кластера.

В этой статье подробно рассматриваются важные моменты для каждого из этих областей.

## <a name="initial-number-and-properties-of-cluster-node-types"></a>Начальное число и свойства типов узлов кластера

*Тип узла* определяет размер, число и свойства для набора узлов (виртуальных машин) в кластере. Каждый тип узла, определенный в кластере Service Fabric, сопоставляется c [масштабируемым набором виртуальных машин](../virtual-machine-scale-sets/overview.md).

Так как каждый тип узла представляет собой отдельный масштабируемый набор, его можно масштабировать по отдельности, иметь разные наборы портов и иметь разные метрики емкости. Дополнительные сведения о связи между типами узлов и масштабируемыми наборами виртуальных машин см. в разделе [типы узлов кластера Service Fabric](service-fabric-cluster-nodetypes.md).

Для каждого кластера требуется один **Тип первичного узла**, который запускает важные системные службы, предоставляющие Service Fabric возможности платформы. Хотя для запуска приложений можно также использовать типы первичных узлов, рекомендуется выделить их только для запуска системных служб.

**Типы узлов, не являющихся первичными** , можно использовать для определения ролей приложения (например, *интерфейсных* и *внутренних* служб), а также для физической изоляции служб в кластере. Кластеры Service Fabric могут иметь не более одного типа узлов.

Тип первичного узла настраивается с помощью `isPrimary` атрибута в определении типа узла в шаблоне развертывания Azure Resource Manager. Полный список свойств типа узла см. в [объекте нодетипедескриптион](/azure/templates/microsoft.servicefabric/clusters#nodetypedescription-object) . Например, откройте любое *AzureDeploy.jsв* файле в [примерах Service Fabric кластера](https://github.com/Azure-Samples/service-fabric-cluster-templates/tree/master/) и найдите для объекта поиск *по странице* `nodeTypes` .

### <a name="node-type-planning-considerations"></a>Вопросы планирования типов узлов

Количество исходных типов узлов зависит от назначения кластера и запущенных на нем приложений и служб. Оцените следующие вопросы.

* ***Есть ли у вашего приложения несколько служб, среди которых есть службы, которые должны быть общедоступными или доступными из Интернета?***

    Обычные приложения содержат службу внешнего шлюза, которая получает входные данные от клиента и одну или несколько серверных служб, взаимодействующих с интерфейсными службами, с отдельной сетью между интерфейсной и внутренней службами. В таких случаях обычно требуется три типа узлов: один тип первичного узла и два типа непервичных узлов (по одному для интерфейсной и серверной служб).

* ***Имеют ли службы, составляющие приложение, различные требования к инфраструктуре, такие как больший объем ОЗУ или больше циклов ЦП?***

    Часто служба внешнего интерфейса может работать на небольших виртуальных машинах (размер виртуальной машины, например D2), которые имеют открытые порты для Интернета.  Для ресурсоемких серверных служб может потребоваться работать на больших виртуальных машинах (с размерами виртуальных машин, например D4, D6, D15), которые не подключены к Интернету. Определение различных типов узлов для этих служб позволяет повысить эффективность и безопасное использование базовых Service Fabric виртуальных машин и позволяет им масштабировать их независимо друг от друга. Дополнительные сведения об оценке необходимого объема ресурсов см. в разделе [планирование емкости для Service Fabric приложений](service-fabric-capacity-planning.md) .

* ***Будет ли любая из ваших служб приложений масштабироваться за пределами 100 узлов?***

    Один тип узла не может надежно масштабироваться свыше 100 узлов на каждый масштабируемый набор виртуальных машин для Service Fabric приложений. Для выполнения более 100 узлов требуются дополнительные масштабируемые наборы виртуальных машин (и, следовательно, дополнительные типы узлов).

* ***Будет ли кластер распределяться по Зоны доступности?***

    Service Fabric поддерживает кластеры, охватывающие несколько [зоны доступности](../availability-zones/az-overview.md) , развертывая типы узлов, которые закреплены в конкретных зонах, обеспечивая высокую доступность приложений. Зоны доступности требуется планирование дополнительного типа узла и минимальные требования. Дополнительные сведения см. в статье [Рекомендуемая топология для типа первичного узла Service Fabric кластеров, охватывающих зоны доступности](service-fabric-cross-availability-zones.md#recommended-topology-for-primary-node-type-of-azure-service-fabric-clusters-spanning-across-availability-zones). 

При определении числа и свойств типов узлов для первоначального создания кластера следует помнить, что при развертывании кластера всегда можно добавлять, изменять и удалять (не являющиеся первичными) типы узлов. [Типы первичных узлов можно также изменять](service-fabric-scale-up-primary-node-type.md) в работающих кластерах (хотя такие операции требует значительных средств планирования и предостережения в рабочих средах).

Более подробное замечание для свойств типа узла — уровень устойчивости, который определяет привилегии виртуальных машин типа узла в инфраструктуре Azure. Используйте размер виртуальных машин, выбранных для кластера, и число экземпляров, назначаемое для отдельных типов узлов, чтобы определить соответствующий уровень устойчивости для каждого типа узла, как описано далее.

## <a name="durability-characteristics-of-the-cluster"></a>Характеристики устойчивости кластера

*Уровень устойчивости* определяет привилегии Service Fabric виртуальных машин с базовой инфраструктурой Azure. Эта привилегия позволяет Service Fabric приостанавливать любой запрос инфраструктуры на уровне виртуальной машины (например, перезагрузку, повторное создание образа или миграцию), который влияет на требования кворума для Service Fabric системных служб и служб с отслеживанием состояния.

> [!IMPORTANT]
> Уровень устойчивости задается для каждого типа узла. Если ничего не указано, будет использоваться *бронзовый* уровень, однако автоматическое обновление ОС не предоставляется. Для рабочих нагрузок рекомендуется использовать уровень устойчивости « *серебро* » или « *Gold* ».

В следующей таблице перечислены Service Fabric уровни устойчивости, их требования и аффорданцес.

| Уровень устойчивости  | Необходимое минимальное количество виртуальных машин | Поддерживаемые размеры виртуальных машин                                                                  | Изменения, вносимые в масштабируемый набор виртуальных машин                               | Обновления и обслуживание, инициированные Azure                                                              | 
| ---------------- |  ----------------------------  | ---------------------------------------------------------------------------------- | ----------------------------------------------------------- | ------------------------------------------------------------------------------------------------------- |
| Золотая             | 5                              | Размеры полных узлов, выделенные одному клиенту (например, L32s, GS5, G5, DS15_v2, D15_v2). | Можно отложить до утверждения кластером Service Fabric | Можно приостановить в течение 2 часов на домен обновления, чтобы разрешить дополнительное время для восстановления реплик после предыдущих сбоев. |
| Серебряная           | 5                              | Виртуальные машины с одним ядром или более, по крайней мере 50 ГБ локального SSD                      | Можно отложить до утверждения кластером Service Fabric | Задержка на любой значительный период времени невозможна                                                    |
| Бронзовая          | 1                              | Виртуальные машины с размером не менее 50 ГБ локального SSD                                              | Не будет задержано кластером Service Fabric           | Задержка на любой значительный период времени невозможна                                                    |

> [!NOTE]
> Упомянутое выше минимальное количество виртуальных машин является обязательным требованием для каждого уровня устойчивости. У нас есть проверки на месте, что предотвратит создание или изменение существующих скалесетс виртуальных машин, которые не соответствуют этим требованиям.

> [!WARNING]
> При использовании бронзовой устойчивости автоматическое обновление образа ОС недоступно. В то время как приложение для управления [исправлениями](service-fabric-patch-orchestration-application.md) (предназначенное только для кластеров, не размещенных в Azure) *не рекомендуется* для уровней устойчивости, а также для автоматизации обновлений Windows в отношении доменов обновления Service Fabric.

> [!IMPORTANT]
> Независимо от уровня устойчивости выполнение операции [освобождения](/rest/api/compute/virtualmachinescalesets/deallocate) в масштабируемом наборе виртуальных машин приведет к уничтожению кластера.

### <a name="bronze"></a>Бронзовая

Типы узлов, выполняющиеся с устойчивостью Bronze, не получают привилегий. Это означает, что задания инфраструктуры, влияющие на рабочие нагрузки с отслеживанием состояния, не будут остановлены или отложены. Используйте бронзовую устойчивость для типов узлов, которые запускают рабочие нагрузки без отслеживания состояния. Для рабочих нагрузок рекомендуется использовать Silver или более высокий уровень.

### <a name="silver-and-gold"></a>Серебро и золото

Используйте уровень устойчивости "серебро" или "Gold" для всех типов узлов, которые размещают службы с отслеживанием состояния, которые будут часто масштабироваться, а также для того, чтобы сократить операции развертывания и уменьшить емкость, чтобы упростить процесс. Сценарии горизонтального масштабирования не должны влиять на выбор уровня устойчивости.

#### <a name="advantages"></a>Преимущества

* Сокращает количество необходимых шагов для операций масштабирования (деактивация узла и Remove-ServiceFabricNodeState вызывается автоматически).
* Снижается риск потери данных из-за операций изменения размера виртуальной машины на месте и операций инфраструктуры Azure.

#### <a name="disadvantages"></a>Недостатки

* Развертывание в масштабируемых наборах виртуальных машин и других связанных ресурсах Azure может исдерживаться, быть задержано или полностью заблокировано проблемами в кластере или на уровне инфраструктуры.
* Увеличивается число [событий жизненного цикла реплики](service-fabric-reliable-services-lifecycle.md) (например, переключений первичного узла) из-за автоматизированной деактивации узлов во время операций инфраструктуры Azure.
* Узлы становятся недоступны в периоды обновления программного обеспечения платформы Azure или обслуживания оборудования. Во время этих операций вы можете видеть узлы в состоянии "Идет отключение" или "Отключено". При этом временно уменьшается размер кластера, но это не должно влиять на доступность кластера или приложений.

#### <a name="best-practices-for-silver-and-gold-durability-node-types"></a>Рекомендации по типам узлов категории "серебро" и "Gold"

Следуйте приведенным ниже рекомендациям по управлению типами узлов со статусом "серебро" или "Gold".

* Поддерживайте постоянную работоспособность кластера и приложений и проверяйте, своевременно ли реагируют приложения на все [события жизненного цикла реплики службы](service-fabric-reliable-services-lifecycle.md) (например, задержку сборки реплики).
* Принимайте более безопасные способы изменения размера виртуальной машины (увеличить или уменьшить). Изменение размера виртуальной машины для масштабируемого набора виртуальных машин требует тщательного планирования и предостережения. Дополнительные сведения см. [в разделе увеличение масштаба Service Fabric типа узла](service-fabric-scale-up-primary-node-type.md) .
* Обеспечьте как минимум пять узлов для любого масштабируемого набора виртуальных машин с уровнем устойчивости Gold или Silver. Кластер будет переходить в состояние ошибки, если масштаб превышает это пороговое значение, и необходимо вручную очистить состояние ( `Remove-ServiceFabricNodeState` ) для удаленных узлов.
* Каждый масштабируемый набор виртуальных машин с уровнем устойчивости Silver или Gold должен быть сопоставлен с собственным типом узла в кластере Service Fabric. Сопоставление нескольких масштабируемых наборов виртуальных машин в одном типе узла сделает невозможным координацию между кластером Service Fabric и инфраструктурой Azure.
* Не удаляйте случайные экземпляры виртуальных машин. всегда используйте функцию масштабирования масштабируемого набора виртуальных машин. Удаление случайных экземпляров виртуальной машины может создать дисбаланс в экземпляре виртуальной машины, распределенном между [доменами обновления](service-fabric-cluster-resource-manager-cluster-description.md#upgrade-domains) и [доменами сбоя](service-fabric-cluster-resource-manager-cluster-description.md#fault-domains). Такое дисбаланс может негативно повлиять на способность систем правильно распределять нагрузку между экземплярами службы и репликами службы.
* При использовании автомасштабирования задайте правила, в которых операции масштабирования (удаления экземпляров виртуальных машин) выполняются только по одному узлу за раз. Одновременно уменьшать масштаб более одного экземпляра небезопасно.
* При удалении или отмене выделения виртуальных машин в типе первичного узла никогда не уменьшайте число выделенных виртуальных машин, которые требуются для уровня надежности. Эти операции будут заблокированы на неограниченное время в масштабируемом наборе с уровнем устойчивости Silver или Gold.

### <a name="changing-durability-levels"></a>Изменение уровней надежности

В некоторых ограничениях можно настроить уровень устойчивости типа узла:

* Типы узлов с уровнями устойчивости серебро или Gold нельзя понизить до бронзовых.
* Обновление с Bronze до Silver или Gold может занять несколько часов.
* При изменении уровня устойчивости обязательно обновите его как в конфигурации расширения Service Fabric в ресурсе масштабируемого набора виртуальных машин, так и в определении типа узла в ресурсе кластера Service Fabric. Эти значения должны совпадать.

Другое обстоятельство, когда планирование емкости — это уровень надежности кластера, который определяет стабильность системных служб и всего кластера, как описано в следующем разделе.

## <a name="reliability-characteristics-of-the-cluster"></a>Характеристики надежности кластера

*Уровень надежности* кластера определяет количество реплик системных служб, выполняемых на основном типе узла кластера. Чем больше реплик, тем надежнее системные службы (и, следовательно, кластер в целом).

> [!IMPORTANT]
> Уровень надежности задается на уровне кластера и определяет минимальное количество узлов типа первичного узла. Для рабочих нагрузок требуется уровень надежности серебро (больше или равно пяти узлов) или выше.  

Уровень надежности может принимать следующие значения:

* **Platinum** — системные службы выполняются с целевым набором реплик, равным девяти
* **Категории Gold** -System выполняются с целевым набором реплик, равным семи
* **Серебро** — системные службы выполняются с целевым набором реплик, равным пяти
* **Бронзовые** службы запускаются с целевым набором целевых реплик, равным трем

Ниже приведены рекомендации по выбору уровня надежности. Число начальных узлов также задается равным минимальному количеству узлов для уровня надежности.


| **Количество узлов** | **Уровень надежности** |
| --- | --- |
| 1 | *Не указывайте `reliabilityLevel` параметр: система вычисляет его.* |
| 3 | Бронзовая |
| 5 или 6| Серебряная |
| 7 или 8 | Золотая |
| 9 и более | Platinum |

При увеличении или уменьшении размера кластера (сумма экземпляров виртуальных машин во всех типах узлов) рекомендуется обновить надежность кластера с одного уровня на другой. Это активирует обновления кластера, необходимые для изменения числа реплик системных служб. Подождите, пока обновление не будет завершено, прежде чем вносить другие изменения в кластер, например добавлять узлы.  Ход выполнения обновления можно отслеживать в Service Fabric Explorer или с помощью командлета [Get-ServiceFabricClusterUpgrade](/powershell/module/servicefabric/get-servicefabricclusterupgrade).

### <a name="capacity-planning-for-reliability"></a>Планирование емкости для обеспечения надежности

Требования к емкости кластера определяются конкретной рабочей нагрузкой и требованиями к надежности. В этом разделе приводятся общие рекомендации по началу работы с планированием ресурсов.

#### <a name="virtual-machine-sizing"></a>Размеры виртуальных машин

**Для производственных рабочих нагрузок рекомендуемый размер виртуальной машины (SKU) — [стандартный D2_V2](../virtual-machines/dv2-dsv2-series.md) (или эквивалентный) с минимум 50 ГБ локального SSD, 2 ядра и 4 гиб памяти.** Рекомендуется использовать не менее 50 ГБ локального SSD, однако для некоторых рабочих нагрузок (таких как работающие контейнеры Windows) потребуется больше дисков. При выборе других [размеров виртуальных машин](../virtual-machines/sizes-general.md) для рабочих нагрузок учитывайте следующие ограничения.

- Размеры виртуальных машин с частичным ядром, например "Стандартный a0", не поддерживаются.
- *Серия A* Размеры виртуальных машин не поддерживаются по соображениям производительности.
- Низкоприоритетные виртуальные машины не поддерживаются.

#### <a name="primary-node-type"></a>Тип первичного узла

Для рабочих **нагрузок** в Azure требуется как минимум пять основных узлов (экземпляров виртуальных машин) и уровень надежности серебряных. Рекомендуется выделить тип первичного узла кластера для системных служб и использовать ограничения на размещение для развертывания приложения на вторичных типах узлов.

**Тестовые рабочие нагрузки** в Azure могут выполнять как минимум один или три основных узла. Чтобы настроить кластер с одним узлом, убедитесь, что этот `reliabilityLevel` параметр полностью пропущен в шаблоне диспетчер ресурсов (Указание пустого строкового значения для недостаточно `reliabilityLevel` ). Если настроить кластер с одним узлом с портал Azure, эта конфигурация будет выполнена автоматически.

> [!WARNING]
> Кластеры с одним узлом работают с специальной конфигурацией без надежности, а масштабное развертывание не поддерживается.

#### <a name="non-primary-node-types"></a>Типы узлов, не являющихся первичными

Минимальное число узлов для типа узла, не являющегося первичным, зависит от конкретного [уровня устойчивости](#durability-characteristics-of-the-cluster) типа узла. Необходимо спланировать количество узлов (и уровень устойчивости) в зависимости от числа реплик приложений или служб, которые необходимо выполнить для типа узла, и в зависимости от того, является ли Рабочая нагрузка отслеживанием состояния или без отслеживания состояния. Помните, что количество виртуальных машин в типе узла можно увеличить или уменьшить в любое время после развертывания кластера.

##### <a name="stateful-workloads"></a>Рабочие нагрузки с отслеживанием состояния

Для рабочих нагрузок с отслеживанием состояния, использующих Service Fabric [надежных коллекций или надежных субъектов](service-fabric-choose-framework.md), рекомендуется использовать минимальное и целевое число реплик, равное пяти. В результате в стабильном состоянии вы подаете реплику (из набора реплик) в каждом домене сбоя и домене обновления. Как правило, используйте уровень надежности, заданный для системных служб, в качестве инструкции по количеству реплик, используемых для служб с отслеживанием состояния.

##### <a name="stateless-workloads"></a>Рабочие нагрузки без отслеживания состояния

Для рабочих нагрузок без отслеживания состояния минимальный поддерживаемый размер типа непервичного узла составляет три для поддержки кворума, однако рекомендуется использовать тип узла 5.

## <a name="next-steps"></a>Дальнейшие действия

Перед настройкой кластера проверьте `Not Allowed` [политики обновления кластера](service-fabric-cluster-fabric-settings.md) , чтобы устранить необходимость повторного создания кластера позже из-за неизменяемых параметров конфигурации системы.

Дополнительные сведения о планировании кластеров см. в следующих статьях:

* [Планирование вычислений и масштабирования](service-fabric-best-practices-capacity-scaling.md)
* [Планирование емкости для приложений Service Fabric](service-fabric-capacity-planning.md)
* [План аварийного восстановления](service-fabric-disaster-recovery.md)

<!--Image references-->
[SystemServices]: ./media/service-fabric-cluster-capacity/SystemServices.png
