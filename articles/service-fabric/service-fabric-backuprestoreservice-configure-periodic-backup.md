---
title: Основные сведения о настройке периодического резервного копирования
description: Используйте функцию периодического резервного копирования и восстановления Service Fabric, чтобы настроить периодическую архивацию надежных служб с отслеживанием состояния или Reliable Actors.
ms.topic: article
ms.date: 2/01/2019
ms.openlocfilehash: 2607502af44b178131820d78f23bcdf4e32454a0
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "96018891"
---
# <a name="understanding-periodic-backup-configuration-in-azure-service-fabric"></a>Основные сведения о настройке периодического резервного копирования в Azure Service Fabric

Настройка периодического резервного копирования надежных служб с отслеживанием состояния и Reliable Actors предусматривает следующие шаги:

1. **Создание политик резервного копирования.** На этом шаге создаются одна или несколько политик резервного копирования в зависимости от требований.

2. **Включение резервного копирования.** На этом шаге политики резервного копирования, созданные на **шаге 1**, нужно связать с необходимыми сущностями: _приложением_, _службой_ или _разделом_.

## <a name="create-backup-policy"></a>Создать политику архивации

Политика резервного копирования состоит из следующих конфигураций:

* **Автоматическое восстановление в случае потери данных.** Указывает, следует ли активировать автоматическое восстановление с использованием последней доступной резервной копии в случае потери данных в разделе.
> [!NOTE]
> НЕ рекомендуется устанавливать автоматическое восстановление в рабочих кластерах.
>

* **Максимальное число добавочных резервных копий.** Определяет максимальное число добавочных резервных копий, которые должны создаваться в интервале между созданием двух полных резервных копий. Максимальное число добавочных резервных копий указывает верхний предел. Полное резервное копирование можно выполнить до создания указанного числа добавочных резервных копий при одном из следующих условий:

    1. Для реплики никогда не создавалась полная резервная копия, так как она стала первичной.

    2. С момента последнего ее создания были усечены некоторые записи журнала.

    3. Размер реплики превысил ограничение MaxAccumulatedBackupLogSizeInMB.

* **Расписание резервного копирования.** Время или частота, с которой следует выполнять периодическое резервное копирование. Выполнение резервного копирования можно запланировать через указанный интервал или в указанное время ежедневно или еженедельно.

    1. **Расписание резервного копирования на основе частоты.** Этот тип расписания следует использовать, если резервное копирование данных необходимо выполнять через фиксированные промежутки времени. Необходимый период времени между двумя последовательными резервными копированиями определяется с помощью формата ISO8601. Расписание резервного копирования на основе частоты поддерживает разрешение интервала до минуты.
        ```json
        {
            "ScheduleKind": "FrequencyBased",
            "Interval": "PT10M"
        }
        ```

    2. **Расписание резервного копирования на основе времени.** Этот тип расписания следует использовать, если резервное копирование данных необходимо выполнять в указанное время дня или недели. Тип частоты расписания может быть ежедневным или еженедельным.
        1. **Расписание _ежедневного_ резервного копирования на основе времени**. Этот тип расписания следует использовать, если необходимо выполнять резервное копирование данных в определенное время суток. Чтобы сделать это, задайте для параметра `ScheduleFrequencyType` значение _Ежедневно_, а для параметра `RunTimes` задайте список значений нужного времени в течение дня в формате ISO8601. Дата, указанная с временем, будет игнорироваться. Например, `0001-01-01T18:00:00` означает _18:00_ каждый день, а часть даты _0001-01-01_ игнорируется. В приведенном ниже примере показана конфигурация активации ежедневного резервного копирования в _9:00_ и _18:00_ ежедневно.

            ```json
            {
                "ScheduleKind": "TimeBased",
                "ScheduleFrequencyType": "Daily",
                "RunTimes": [
                  "0001-01-01T09:00:00Z",
                  "0001-01-01T18:00:00Z"
                ]
            }
            ```

        2. **_Еженедельное_ расписание резервного копирования на основе времени**. Этот тип расписания следует использовать, если необходимо выполнять резервное копирование данных в определенное время суток. Чтобы сделать это, задайте для параметра `ScheduleFrequencyType` значение _Еженедельно_, а для параметра `RunDays` задайте список дней недели, когда необходимо активировать резервное копирование, а для параметра `RunTimes` задайте список необходимых значений нужного времени в течение дня в формате ISO8601. Дата, указанная с временем, будет игнорироваться. Выведите список дней недели, когда необходимо активировать периодическое резервное копирование. В приведенном ниже примере показана конфигурация активации ежедневного резервного копирования в _9:00_ и _18:00_ с понедельника по пятницу.

            ```json
            {
                "ScheduleKind": "TimeBased",
                "ScheduleFrequencyType": "Weekly",
                "RunDays": [
                   "Monday",
                   "Tuesday",
                   "Wednesday",
                   "Thursday",
                   "Friday"
                ],
                "RunTimes": [
                  "0001-01-01T09:00:00Z",
                  "0001-01-01T18:00:00Z"
                ]
            }
            ```

* **Хранилище резервных копий.** Указывает расположение, в которое нужно передать резервные копии. Роль хранилища может выполнять хранилище больших двоичных объектов или файловый ресурс Azure.
    1. **Хранилище больших двоичных объектов Azure.** Этот тип хранилища следует выбрать, если созданные резервные копии необходимо хранить в Azure. Этот тип хранилища может использовать как _автономный_ кластер, так и кластер _на базе Azure_. Для описания этого типа хранилища требуется строка подключения и имя контейнера, в который необходимо передать резервные копии. Если контейнер с указанным именем недоступен, он будет создан во время передачи резервной копии.

        ```json
        {
            "StorageKind": "AzureBlobStore",
            "FriendlyName": "Azure_storagesample",
            "ConnectionString": "<Put your Azure blob store connection string here>",
            "ContainerName": "BackupContainer"
        }
        ```

        > [!NOTE]
        > Служба восстановления резервных копий не работает с хранилищем Azure v1
        >

    2. **Файловый ресурс**. Этот тип хранилища следует выбирать для _автономных_ кластеров, когда требуется хранить резервную копию данных в локальной среде. Для описания этого типа хранилища требуется путь к файловому ресурсу, в который необходимо передать резервные копии. Доступ к файловому ресурсу можно настроить с использованием одного из следующих вариантов:
        1. _Встроенная проверка подлинности Windows_, где доступ к файловому ресурсу предоставляется на всех компьютерах, принадлежащих к кластеру Service Fabric. В этом случае задайте следующие поля, чтобы настроить хранилище резервных копий на основе _файлового ресурса_.

            ```json
            {
                "StorageKind": "FileShare",
                "FriendlyName": "Sample_FileShare",
                "Path": "\\\\StorageServer\\BackupStore"
            }
            ```

        2. _Защита файлового ресурса с использованием имени пользователя и пароля_, где доступ к файловому ресурсу предоставляется определенным пользователям. Спецификация хранилища на основе файлового ресурса также предоставляет возможность указать дополнительное имя пользователя и дополнительный пароль для предоставления резервных учетных данных в случае сбоя проверки подлинности с помощью основного имени пользователя и основного пароля. В этом случае задайте следующие поля, чтобы настроить хранилище резервных копий на основе _файлового ресурса_.

            ```json
            {
                "StorageKind": "FileShare",
                "FriendlyName": "Sample_FileShare",
                "Path": "\\\\StorageServer\\BackupStore",
                "PrimaryUserName": "backupaccount",
                "PrimaryPassword": "<Password for backupaccount>",
                "SecondaryUserName": "backupaccount2",
                "SecondaryPassword": "<Password for backupaccount2>"
            }
            ```

> [!NOTE]
> Убедитесь, что надежность хранилища удовлетворяет или превосходит требования к надежности данных резервного копирования.
>

* **Политика хранения**: определяет политику хранения резервных копий в настроенном хранилище. Поддерживается только политика хранения уровня "Базовый".
    1. **Базовая политика хранения**. Эта политика хранения позволяет обеспечить оптимальное использование хранилища, удаляя файлы резервных копий, которые больше не требуются. `RetentionDuration` можно указать, чтобы задать период времени, в течение которого резервные копии должны храниться в хранилище. `MinimumNumberOfBackups` — необязательный параметр, который можно указать, чтобы указанное количество резервных копий всегда хранилось независимо от настроенного параметра `RetentionDuration`. В приведенном ниже примере показана конфигурация для хранения резервных копий в течение _10_ дней и в количестве не менее _20_ экземпляров.

        ```json
        {
            "RetentionPolicyType": "Basic",
            "RetentionDuration" : "P10D",
            "MinimumNumberOfBackups": 20
        }
        ```

## <a name="enable-periodic-backup"></a>Включение периодического резервного копирования
После определения политики резервного копирования, которая соответствует требованиям данных резервного копирования, ее необходимо соответствующим образом связать с _приложением_, _службой_ или _разделом_.

> [!NOTE]
> Перед включением резервного копирования убедитесь, что не выполняется обновление приложения
>

### <a name="hierarchical-propagation-of-backup-policy"></a>Иерархические распространение политики резервного копирования
В Service Fabric отношение между приложением, службой и разделами иерархические, как описано в статье [Моделирование приложения в структуре службы](./service-fabric-application-model.md). В иерархии политику резервного копирования можно связать с _приложением_, _службой_ или _разделом_. Политика резервного копирования иерархически распространяется до следующего уровня. Если предположить, что только одна политика резервного копирования создана и связана с _приложением_, для всех разделов с отслеживанием состояния, относящимся ко всем _надежным службам с отслеживанием состояния_ и _Reliable Actors__приложения_, будут созданы резервные копии с помощью политики резервного копирования. Или если политика резервного копирования связана с _надежной службой с отслеживанием состояния_, для всех ее разделов будут созданы резервные копии с помощью этой политики.

### <a name="overriding-backup-policy"></a>Переопределение политики резервного копирования
Возможны сценарии, в которых резервное копирование данных с одним и тем же расписанием необходимо для всех служб приложения за исключением определенных служб, для которых резервное копирование данных необходимо выполнять с большей частотой или создавать резервные копии в другую учетную запись хранения или файловый ресурс. Для таких сценариев служба резервного восстановления предоставляет возможность переопределить распространенную политику на уровне службы и раздела. Когда политика резервного копирования связана на уровне _службы_ или _раздела_, служба переопределяет распространенную политику резервного копирования, если таковая имеется.

### <a name="example"></a>Пример

В этом примере используется установка с двумя приложениями, _MyApp_A_ и _MyApp_B_. Приложение _MyApp_A_ содержит две надежные службы с отслеживанием, _SvcA1_ & _SvcA3_, и одну службу Reliable Actors, _ActorA2_. _SvcA1_ содержит три раздела, а _ActorA2_ и _SvcA3_ — по два раздела.  Приложение _MyApp_B_ содержит три надежные службы с отслеживанием, _SvcB1_, _SvcB2_ и _SvcB3_. _SvcB1_ и _SvcB2_ содержат по два раздела, а _SvcB3_ — три раздела.

Предположим, что требования резервного копирования данных этих приложений следующие.

1. MyApp_A
    1. Ежедневно создавайте резервную копию данных для всех разделов всех _надежных служб с отслеживанием_ и _Reliable Actors_, относящихся к приложению. Передайте данные резервного копирования в расположение _BackupStore1_.

    2. Для одной из служб, _SvcA3_, требуется резервное копирование данных каждый час.

    3. Размер данных в разделе _SvcA1_P2_ превышает ожидаемый и его данные резервного копирования следует сохранить в другое место хранения _BackupStore2_.

2. MyApp_B
    1. Создавайте резервную копию данных каждое воскресенье в 8:00 для всех разделов службы _SvcB1_. Передайте данные резервного копирования в расположение _BackupStore1_.

    2. Создавайте резервную копию данных каждый день в 8:00 для раздела _SvcB2_P1_. Передайте данные резервного копирования в расположение _BackupStore1_.

Для удовлетворения этих требований резервного копирования данных создаются политики резервного копирования от BP_1 до BP_5, а резервное копирование включается следующим образом.
1. MyApp_A
    1. Создайте политику резервного копирования, _BP_1_, с расписанием резервного копирования на основе частоты, где для частоты задается значение 24 часа. и хранилищем резервных копий, настроенным для использования места хранения _BackupStore1_. Включите эту политику для приложения _MyApp_A_ с помощью API [Enable Application Backup](/rest/api/servicefabric/sfclient-api-enableapplicationbackup) (Включение резервного копирования приложения). Это действие позволяет выполнять резервное копирование данных с помощью политики резервного копирования _BP_1_ для всех разделов _надежных служб с отслеживанием состояния_ и _Reliable Actors_, относящихся к приложению _MyApp_A_.

    2. Создайте политику резервного копирования, _BP_2_, с расписанием резервного копирования на основе частоты, где для частоты задается значение 1 час, и хранилищем резервных копий, настроенным для использования места хранения _BackupStore1_. Включите эту политику для службы _SvcA3_ с помощью API [Enable Service Backup](/rest/api/servicefabric/sfclient-api-enableservicebackup) (Включение резервного копирования службы). Это действие переопределяет распространенную политику _BP_1_ с помощью включенной политики резервного копирования _BP_2_ для всех разделов службы _SvcA3_, в результате чего для этих разделов резервное копирование данных выполняется с помощью политики резервного копирования _BP_2_.

    3. Создайте политику резервного копирования, _BP_3_, с расписанием резервного копирования на основе частоты, где для частоты задается значение 24 часа. и хранилищем резервных копий, настроенным для использования места хранения _BackupStore2_. Включите эту политику для раздела _SvcA1_P2_ с помощью API [Enable Partition Backup](/rest/api/servicefabric/sfclient-api-enablepartitionbackup) (Включение резервного копирования раздела). Это действие переопределяет распространенную политику _BP_1_ с помощью включенной политики резервного копирования _BP_3_ для раздела _SvcA1_P2_.

2. MyApp_B
    1. Создайте политику резервного копирования, _BP_4_, с расписанием резервного копирования на основе времени, в котором для типа частоты расписания задано значение "еженедельно", для дней выполнения — воскресенье, а времени выполнения — 8:00. Хранилище резервных копий, настроенное для использования места хранения _BackupStore1_. Включите эту политику для службы _SvcB1_ с помощью API [Enable Service Backup](/rest/api/servicefabric/sfclient-api-enableservicebackup) (Включение резервного копирования службы). Это действие позволяет выполнять резервное копирование данных с помощью политики резервного копирования _BP_4_ для всех разделов службы _SvcB1_.

    2. Создайте политику резервного копирования, _BP_5_, с расписанием резервного копирования на основе времени, в котором для типа частоты расписания задано значение "ежедневно", а времени выполнения — 8:00. Хранилище резервных копий, настроенное для использования места хранения _BackupStore1_. Включите эту политику для раздела _SvcB2_P1_ с помощью API [Enable Partition Backup](/rest/api/servicefabric/sfclient-api-enablepartitionbackup) (Включение резервного копирования раздела). Это действие позволяет выполнять резервное копирование данных с помощью политики резервного копирования _BP_5_ для раздела _SvcB2_P1_.

На следующей схеме показаны включенные политики резервного копирования и распространенные политики резервного копирования.

![Иерархия приложения Service Fabric][0]

## <a name="disable-backup"></a>Отключение резервного копирования
Политики резервного копирования можно отключить, если выполнять резервное копирование данных не нужно. Политику резервного копирования, включенную на уровне _приложения_, можно отключить только в том же самом _приложении_ с помощью API [Disable Application Backup](/rest/api/servicefabric/sfclient-api-disableapplicationbackup) (Отключение резервного копирования приложения). Политику резервного копирования, включенную на уровне _службы_, можно отключить в той же самой _службе_ с помощью API [Disable Service Backup](/rest/api/servicefabric/sfclient-api-disableservicebackup) (Отключение резервного копирования службы). Политику резервного копирования, включенную на уровне _раздела_, можно отключить в том же самом _разделе_ с помощью API [Disable Partition Backup](/rest/api/servicefabric/sfclient-api-disablepartitionbackup) (Отключение резервного копирования раздела).

* Отключение политики резервного копирования для _приложения_ останавливает все периодические резервные копирования данных, выполняемые в результате распространения политики резервного копирования в разделы служб с отслеживанием состояния или разделов Reliable Actors.

* Отключение политики резервного копирования для _службы_ останавливает все периодические резервные копирования данных, выполняемые в результате распространения этой политики резервного копирования в разделы _службы_.

* Отключение политики резервного копирования для _раздела_ останавливает все периодические резервные копирования данных, выполняемые политикой резервного копирования в разделе.

* При отключении резервного копирования для сущности (приложения/службы/раздела) для параметра `CleanBackup` можно установить значение _true_, чтобы удалить все резервные копии в настроенном хранилище.
    ```json
    {
        "CleanBackup": true 
    }
    ```
> [!NOTE]
> Перед отключением резервного копирования убедитесь, что не выполняется обновление приложения
>

## <a name="suspend--resume-backup"></a>Приостановка и возобновление резервного копирования
В некоторых ситуациях может понадобится временная приостановка периодического резервного копирования данных. В такой ситуации в зависимости от требований API приостановки резервного копирования может использоваться в _приложении_, _службе_ или _разделе_. Приостановка периодического резервного копирования переходит на поддерево иерархии приложения с точки, к которой она применяется. 

* Если применить приостановку в _приложении_ с помощью API [Suspend Application Backup](/rest/api/servicefabric/sfclient-api-suspendapplicationbackup) (Приостановка резервного копирования приложения), то во всех службах и разделах этого приложения периодическое резервное копирование данных будет приостановлено.

* Если применить приостановку в _службе_ с помощью API [Suspend Service Backup](/rest/api/servicefabric/sfclient-api-suspendservicebackup) (Приостановка резервного копирования службы), то во всех разделах этой службы периодическое резервное копирование данных будет приостановлено.

* Если применить приостановку в _разделе_ с помощью API [Suspend Partition Backup](/rest/api/servicefabric/sfclient-api-suspendpartitionbackup) (Приостановка резервного копирования раздела), то во всех разделах этой службы периодическое резервное копирование данных будет приостановлено.

После того как необходимость в приостановке отпадет, периодическое резервное копирование данных можно восстановить с помощью соответствующего API возобновления резервного копирования. Периодическое резервное копирование должно быть возобновлено в том же самом _приложении_, _службе_ или _разделе_, в котором оно было приостановлено.

* Если приостановка применена в _приложении_, резервное копирование следует возобновить с помощью API [Resume Application Backup](/rest/api/servicefabric/sfclient-api-resumeapplicationbackup) (Возобновление резервного копирования приложения). 

* Если приостановка применена в _службе_, резервное копирование следует возобновить с помощью API [Resume Service Backup](/rest/api/servicefabric/sfclient-api-resumeservicebackup) (Возобновление резервного копирования службы).

* Если приостановка применена в _разделе_, резервное копирование следует возобновить с помощью API [Resume Partition Backup](/rest/api/servicefabric/sfclient-api-resumepartitionbackup) (Возобновление резервного копирования раздела).

### <a name="difference-between-suspend-and-disable-backups"></a>Различие между приостановкой и отключением резервного копирования
Отключение резервного копирования должно использоваться, когда резервные копии для конкретного приложения, службы или раздела больше не требуются. Запрос на отключение резервного копирования можно отправить вместе с параметром очистки резервных копий, при этом наряду с отключением резервного копирования также будут удалены все существующие резервные копии. Приостановка резервного копирования используется в тех случаях, когда нужно временно отключить резервное копирование, например при заполнении локального диска, когда не удалось отправить резервную копию из-за известной ошибки сети и т. д. 

Отключение может быть вызвано только на том уровне, который ранее был использован для резервного копирования явным образом. Однако приостановку можно выполнить на любом уровне, для которого сейчас включено резервное копирование, напрямую или через наследование или иерархию. Например, если резервное копирование включено на уровне приложения, то отключить его можно только на уровне приложения, однако приостановить его можно на уровне приложения и на уровне любой службы или любого раздела этого приложения. 

## <a name="auto-restore-on-data-loss"></a>Автоматическое восстановление в случае потери данных
В разделе службы может произойти потеря данных из-за непредвиденных сбоев. Например, диск для двух из трех реплик для раздела (включая первичную реплику) поврежден или очищен.

Когда Service Fabric обнаруживает, что в разделе произошла потеря данных, она вызывает метод интерфейса `OnDataLossAsync` в раздел и ожидает, пока в разделе не будут предприняты необходимые действия по устранению потери данных. В этом случае, если в действующей политике резервного копирования в разделе для флага `AutoRestoreOnDataLoss` задано значение `true`, то восстановление автоматически активируется с использованием последней доступной резервной копии для этого раздела.

> [!NOTE]
> НЕ рекомендуется устанавливать автоматическое восстановление в рабочих кластерах.
>

## <a name="get-backup-configuration"></a>Получение конфигурации резервного копирования
Для получения сведений о конфигурации резервного копирования на уровне _приложения_, _службы_ и _раздела_ теперь доступны отдельные API. [Get Application Backup Configuration Info](/rest/api/servicefabric/sfclient-api-getapplicationbackupconfigurationinfo) (Получение сведений о конфигурации резервного копирования приложения), [Get Service Backup Configuration Info](/rest/api/servicefabric/sfclient-api-getservicebackupconfigurationinfo) (Получение сведений о конфигурации резервного копирования службы) и [Get Partition Backup Configuration Info](/rest/api/servicefabric/sfclient-api-getpartitionbackupconfigurationinfo) (Получение сведений о конфигурации резервного копирования раздела) — эти API соответственно. Главным образом эти API возвращают сведения о применимой политике резервного копирования, уровне, на котором применена политика резервного копирования, и приостановке резервного копирования. Ниже приводится краткое описание возвращаемых результатов этих API.

- Сведения о конфигурации резервного копирования приложения: предоставляет сведения о политике резервного копирования, примененной в приложении, и всех переопределенных политиках в службах и разделах, относящихся к приложению. Сюда также входят сведения о приостановке приложения и его служб и разделов.

- Сведения о конфигурации резервного копирования службы: предоставляет сведения о действующей политике резервного копирования в службе и уровне, на котором эта политика была применена, а также о всех переопределенных политиках в ее разделах. Сюда также входят сведения о приостановке службы и ее разделов.

- Сведения о конфигурации резервного копирования раздела: предоставляет сведения о действующей политике резервного копирования в разделе и уровне, на котором эта политика была применена. Сюда также входят сведения о приостановке для разделов.

## <a name="list-available-backups"></a>Вывод списка доступных резервных копий

Вывести список доступных резервных копий можно с помощью API получения списка резервных копий. Результат вызова API включает в себя элементы сведений о резервных копиях, доступных в хранилище резервных копий, настроенному в применимой политике резервного копирования. Для вывода списка доступных резервных копий, относящихся к приложению, службе или разделу, предоставлены различные варианты этого API. Эти API поддерживают получение _последней_ доступной резервной копии всех применимых разделов или фильтрацию резервных копий на основе _даты начала_ и _даты окончания_.

Эти API также поддерживают разбиение на страницы результатов, если для параметров _MaxResults_ задано ненулевое положительное целое число, API возвращает максимальное количество элементов сведений о резервных копиях _MaxResults_. Если число доступных элементов сведений о резервных копиях превышает значение _MaxResults_, возвращается маркер продолжения. Для получения следующего набора результатов можно воспользоваться допустимым параметром маркера продолжения. Когда допустимое значение токена продолжения передается в следующий вызов API, он возвращает следующий набор результатов. Маркер продолжения не предоставляется в ответе, если возвращаются все доступные результаты.

Ниже приведены краткие сведения о поддерживаемых вариантах.

- [Get Application Backup List](/rest/api/servicefabric/sfclient-api-getapplicationbackuplist) (Получение списка резервного копирования приложения). Возвращает список резервных копий, доступных для каждого раздела, относящегося к данному приложению Service Fabric.

- [Get Service Backup List](/rest/api/servicefabric/sfclient-api-getservicebackuplist) (Получение списка резервного копирования службы). Возвращает список резервных копий, доступных для каждого раздела, относящегося к данной службе Service Fabric.
 
- [Get Partition Backup List](/rest/api/servicefabric/sfclient-api-getpartitionbackuplist) (Получение списка резервного копирования раздела). Возвращает список резервных копий, доступных для данного раздела.

## <a name="next-steps"></a>Дальнейшие действия
- [Backup restore REST API reference](/rest/api/servicefabric/sfclient-index-backuprestore) (Справочник по REST API службы резервного копирования и восстановления)

[0]: ./media/service-fabric-backuprestoreservice/backup-policy-association-example.png
