---
title: развертыванию Azure Spring Cloud в виртуальной сети
description: Развертывание Azure Spring Cloud в виртуальной сети (внедрение виртуальной сети).
author: MikeDodaro
ms.author: brendm
ms.service: spring-cloud
ms.topic: how-to
ms.date: 07/21/2020
ms.custom: devx-track-java
ms.openlocfilehash: 82dcd8c59c55a2866b51fd6dee896ea1298b6cf6
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "102031809"
---
# <a name="deploy-azure-spring-cloud-in-a-virtual-network"></a>развертыванию Azure Spring Cloud в виртуальной сети

**Эта статья применима к:** ✔️ Java ✔️ C#

В этом учебнике объясняется, как развернуть экземпляр службы Azure Spring Cloud в виртуальной сети. Иногда это развертывание называют внедрением виртуальной сети.

Развертывание включает:

* изоляцию приложений и среды выполнения служб Azure Spring Cloud от Интернета в корпоративной сети;
* взаимодействие Azure Spring Cloud с системами в локальных центрах обработки данных и (или) службах Azure в других виртуальных сетях;
* предоставление клиентам возможности контролировать входящие и исходящие сетевые подключения для Azure Spring Cloud.

> [!Note]
> Вы можете выбрать виртуальную сеть Azure только при создании нового экземпляра облачной службы Azure Spring Cloud. Вы не сможете выбрать другую виртуальную сеть после создания экземпляра Azure Spring Cloud.

## <a name="prerequisites"></a>Предварительные требования

Регистрация поставщиков ресурсов Azure Spring Cloud **Microsoft.AppPlatform** и **Microsoft.ContainerService** в соответствии с инструкциями по [регистрации поставщика ресурсов на портале Azure](../azure-resource-manager/management/resource-providers-and-types.md#azure-portal) или с помощью следующей команды Azure CLI:

```azurecli
az provider register --namespace Microsoft.AppPlatform
az provider register --namespace Microsoft.ContainerService
```

## <a name="virtual-network-requirements"></a>Требования к виртуальной сети

Виртуальная сеть, в которой развертывается экземпляр Azure Spring Cloud, должна соответствовать приведенным ниже требованиям.

* **Расположение.** Виртуальная сеть должна находиться в том же расположении, что и экземпляр Azure Spring Cloud.
* **Подписка**: Виртуальная сеть должна находиться в той же подписке, что и экземпляр Azure Spring Cloud.
* **Подсети**. Виртуальная сеть должна содержать две подсети, выделенные для экземпляра Azure Spring Cloud:

    * Одна для среды выполнения службы.
    * Одна для приложений для микрослужб Spring Boot.
    * Между этими подсетями и экземпляром службы Azure Spring Cloud существует связь "один к одному". Используйте новую подсеть для каждого развертываемого экземпляра службы. Каждая подсеть может содержать только один экземпляр службы.
* **Диапазон адресов**: Блоки CIDR до */28* для подсети среды выполнения службы и для подсети приложений для микрослужбы Spring Boot.
* **Таблица маршрутизации**. По умолчанию для подсетей не требуются существующие связанные таблицы маршрутизации. Вы можете [использовать собственную таблицу маршрутизации](#bring-your-own-route-table).

В следующих процедурах описывается настройка виртуальной сети для хранения экземпляра Azure Spring Cloud.

## <a name="create-a-virtual-network"></a>Создание виртуальной сети

Если у вас уже есть виртуальная сеть для размещения экземпляра службы Azure Spring Cloud, пропустите шаги 1, 2 и 3. Вы можете начать с шага 4, чтобы подготовить подсети для виртуальной сети.

1. В меню портала Microsoft Azure выберите **Создать ресурс**. В Azure Marketplace выберите **Сети** > **Виртуальная сеть**.

1. В диалоговом окне **Создать виртуальную сеть** введите или выберите приведенную ниже информацию.

    |Параметр          |Значение                                             |
    |-----------------|--------------------------------------------------|
    |Подписка     |Выберите свою подписку.                         |
    |Группа ресурсов   |Создайте группу ресурсов или выберите имеющуюся.  |
    |Название             |Введите **azure-spring-cloud-vnet**.                 |
    |Расположение         |Выберите **Восточная часть США**.                               |

1. По завершении выберите **Next: IP-адреса**.

1. В поле диапазона IPv4-адресов введите **10.1.0.0/16**.

1. Нажмите **Добавить подсеть**. Затем введите **service-runtime-subnet** для параметра **Имя подсети** и **10.1.0.0/28** для параметра **Диапазон адресов подсети**. Нажмите кнопку **Добавить**.

1. Снова выберите **Добавление подсети**, а затем введите имя в поле **Имя подсети** и диапазон адресов в поле **Диапазон адресов подсети**. Например, введите **apps-subnet** и **10.1.1.0/28**. Нажмите кнопку **Добавить**.

1. Выберите **Review + create** (Просмотреть и создать). Сохраните остальные значения по умолчанию и нажмите **Создать**.

## <a name="grant-service-permission-to-the-virtual-network"></a>Предоставление службе разрешения на доступ к виртуальной сети
Azure Spring Cloud требуются разрешения **владельца** для виртуальной сети. Это позволит предоставлять выделенный и динамический субъект-службу в виртуальной сети для дальнейшего развертывания и обслуживания.

Выберите виртуальную сеть **azure-spring-cloud-vnet**, созданную ранее.

1. Выберите **Управление доступом (IAM)** , а затем **Добавить** > **Добавить назначение ролей**.

    ![Снимок экрана, на котором показан экран "Управление доступом".](./media/spring-cloud-v-net-injection/access-control.png)

1. В диалоговом окне **Добавить назначение ролей** введите или выберите следующую информацию:

    |Параметр  |Значение                                             |
    |---------|--------------------------------------------------|
    |Роль     |Выберите роль **Владелец**.                                 |
    |Выберите пункт   |Введите **Azure Spring Cloud Resource Provider** (Поставщик ресурсов Azure Spring Cloud).   |

    Затем выберите **Azure Spring Cloud Resource Provider** (Поставщик ресурсов Azure Spring Cloud) и выберите **Сохранить**.

    ![Снимок экрана, показывающий выбор поставщика ресурсов Azure Spring Cloud.](./media/spring-cloud-v-net-injection/grant-azure-spring-cloud-resource-provider-to-vnet.png)

Этого можно также достичь, выполнив следующую команду Azure CLI:

```azurecli
VIRTUAL_NETWORK_RESOURCE_ID=`az network vnet show \
    --name ${NAME_OF_VIRTUAL_NETWORK} \
    --resource-group ${RESOURCE_GROUP_OF_VIRTUAL_NETWORK} \
    --query "id" \
    --output tsv`

az role assignment create \
    --role "Owner" \
    --scope ${VIRTUAL_NETWORK_RESOURCE_ID} \
    --assignee e8de9221-a19c-4c81-b814-fd37c6caf9d2
```

## <a name="deploy-an-azure-spring-cloud-instance"></a>Развертывание экземпляра Azure Spring Cloud

Развертывание экземпляра Azure Spring Cloud в виртуальной сети:

1. Откройте [портал Azure](https://portal.azure.com).

1. В поле поиска сверху введите **Azure Spring Cloud**. Выберите **Azure Spring Cloud** в списке результатов.

1. На странице **Azure Spring Cloud** выберите элемент **+ Добавить**.

1. Заполните форму на странице **создания** Azure Spring Cloud.

1. Выберите ту же группу ресурсов и регион, в которых находится виртуальная сеть.

1. В разделе **Сведения о службе** в поле **Имя** выберите **azure-spring-cloud-vnet**.

1. Перейдите на вкладку **Сеть** и выберите следующие значения:

    |Параметр                                |Значение                                             |
    |---------------------------------------|--------------------------------------------------|
    |Deploy in your own virtual network (Развертывание в собственной виртуальной сети)     |Выберите **Да**.                                   |
    |Виртуальная сеть                        |Выберите **azure-spring-cloud-vnet**.               |
    |Service runtime subnet (Подсеть среды выполнения службы)                 |Выберите **service-runtime-subnet**.                |
    |Spring Boot microservice apps subnet (Подсеть приложений для микрослужб Spring Boot)   |Выберите **apps-subnet**.                           |

    ![Снимок экрана: вкладка "Сеть" на странице создания Azure Spring Cloud.](./media/spring-cloud-v-net-injection/creation-blade-networking-tab.png)

1. Выберите **Просмотреть и создать**.

1. Проверьте спецификации и щелкните **Создать**.

    ![Снимок экрана, на котором показана проверка спецификаций.](./media/spring-cloud-v-net-injection/verify-specifications.png)

После развертывания в подписке будут созданы две дополнительные группы ресурсов для размещения сетевых ресурсов для экземпляра Azure Spring Cloud. Перейдите на **главную** страницу, затем выберите вверху пункт меню **Группы ресурсов**, чтобы найти указанные ниже новые группы ресурсов.

Группа ресурсов с именем **ap-svc-rt_{имя экземпляра службы}_{регион экземпляра службы}** содержит сетевые ресурсы для среды выполнения экземпляра службы.

  ![Снимок экрана, на котором показана среда выполнения службы.](./media/spring-cloud-v-net-injection/service-runtime-resource-group.png)

Группа ресурсов с именем **ap-app_{имя экземпляра службы}_{регион экземпляра службы}** содержит сетевые ресурсы для приложений на основе микрослужб Spring Boot экземпляра службы.

  ![Снимок экрана, показывающий группу ресурсов приложений.](./media/spring-cloud-v-net-injection/apps-resource-group.png)

Эти сетевые ресурсы подключены к виртуальной сети, создание которой показано на предыдущем изображении.

  ![Снимок экрана, на котором показана виртуальная сеть с подключенными устройствами.](./media/spring-cloud-v-net-injection/vnet-with-connected-device.png)

   > [!Important]
   > Группы ресурсов полностью управляются службой Azure Spring Cloud. *Не* следует вручную удалять или изменять ресурсы внутри.

## <a name="using-smaller-subnet-ranges"></a>Использование небольших диапазонов подсети

В этой таблице приведено максимальное число экземпляров приложений, которые поддерживает Azure Spring Cloud при использовании небольших диапазонов подсетей.

| CIDR подсети приложения | Всего IP-адресов | Доступные IP-адреса | Максимальное число экземпляров приложения                                        |
| --------------- | --------- | ------------- | ------------------------------------------------------------ |
| /28             | 16        | 8             | <p> Приложение с 1 ядром:  96 <br/> Приложение с 2 ядрами: 48<br/>  Приложение с 3 ядрами: 32 <br/> Приложение с 4 ядрами: 24 </p> |
| /27             | 32        | 24            | <p> Приложение с 1 ядром:  228<br/> Приложение с 2 ядрами: 144<br/>  Приложение с 3 ядрами: 96 <br/>  Приложение с 4 ядрами: 72</p> |
| /26             | 64        | 56            | <p> Приложение с 1 ядром:  500<br/> Приложение с 2 ядрами: 336<br/>  Приложение с 3 ядрами: 224<br/>  Приложение с 4 ядрами: 168</p> |
| /25             | 128       | 120           | <p> Приложение с 1 ядром:  500<br> Приложение с 2 ядрами:  500<br>  Приложение с 3 ядрами:  480<br>  Приложение с 4 ядрами: 360</p> |
| /24             | 256       | 248           | <p> Приложение с 1 ядром:  500<br/> Приложение с 2 ядрами:  500<br/>  Приложение с 3 ядрами: 500<br/>  Приложение с 4 ядрами: 500</p> |

Для подсетей пять IP-адресов зарезервированы с помощью Azure, а для Azure Spring Cloud требуется по крайней мере четыре адреса. Требуется по меньшей мере девять IP-адресов, поэтому /29 и /30 являются нерабочими.

Для подсети среды выполнения службы минимальный размер равен /28. Этот размер не влияет на количество экземпляров приложения.

## <a name="bring-your-own-route-table"></a>Использование собственной таблицы маршрутизации

Azure Spring Cloud поддерживает использование существующих подсетей и таблиц маршрутизации.

Если настраиваемые подсети не содержат таблиц маршрутизации, Azure Spring Cloud создает их для каждой подсети и добавляет к ним правила на протяжении всего жизненного цикла экземпляра. Если настраиваемые подсети содержат таблицы маршрутизации, Azure Spring Cloud подтверждает существующие таблицы маршрутизации во время операций экземпляра, а также добавляет или обновляет и применяет правила для операций соответствующим образом.

> [!Warning] 
> Настраиваемые правила можно добавить в пользовательские таблицы маршрутизации и обновить. Но правила добавляются с помощью Azure Spring Cloud. Их не следует обновлять или удалять. Правила, такие как 0.0.0.0/0, должны всегда существовать в данной таблице маршрутизации и сопоставляться с целевым объектом шлюза Интернета, например NVA или другим шлюзом исходящего трафика. Будьте внимательны при обновлении правил, если изменяются только настраиваемые правила.


### <a name="route-table-requirements"></a>Требования к таблице маршрутизации

Таблицы маршрутизации, с которыми связана настраиваемая виртуальная сеть, должны соответствовать следующим требованиям:

* Вы можете связать таблицы маршрутизации Azure с вашей виртуальной сетью только при создании экземпляра облачной службы Azure Spring Cloud. Вы не сможете выбрать другую таблицу маршрутизации после создания экземпляра Azure Spring Cloud.
* Подсеть приложения для микрослужбы и подсеть среды выполнения службы должны быть связаны с разными таблицами маршрутизации или ни с одной из них.
* Разрешения необходимо назначить до создания экземпляра. Не забудьте предоставить права *владельца Azure Spring Cloud* для таблиц маршрутизации.
* Нельзя обновить связанный ресурс таблицы маршрутизации после создания кластера. Хотя ресурс таблицы маршрутизации нельзя обновить, можно изменить настраиваемые правила в таблице маршрутизации.
* Нельзя повторно использовать таблицу маршрутизации с несколькими экземплярами из-за потенциально конфликтующих правил маршрутизации.

## <a name="next-steps"></a>Дальнейшие действия

[Развертывание приложения в Azure Spring Cloud в вашей виртуальной сети](https://github.com/microsoft/vnet-in-azure-spring-cloud/blob/master/02-deploy-application-to-azure-spring-cloud-in-your-vnet.md)

## <a name="see-also"></a>См. также раздел

- [Устранение неполадок Azure Spring Cloud в виртуальной сети](https://github.com/microsoft/vnet-in-azure-spring-cloud/blob/master/05-troubleshooting-azure-spring-cloud-in-vnet.md)
- [Обязательства клиентов в отношении запуска Azure Spring Cloud в виртуальной сети](https://github.com/microsoft/vnet-in-azure-spring-cloud/blob/master/06-customer-responsibilities-for-running-azure-spring-cloud-in-vnet.md)
