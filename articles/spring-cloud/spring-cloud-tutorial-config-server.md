---
title: Настройка экземпляра сервера конфигурации в Azure Spring Cloud
description: Сведения о том, как настроить экземпляр сервера конфигурации Spring Cloud для службы Azure Spring Cloud на портале Azure.
ms.service: spring-cloud
ms.topic: how-to
ms.author: brendm
author: bmitchell287
ms.date: 10/18/2019
ms.custom: devx-track-java
ms.openlocfilehash: 3033be3a793c318135f8150b86114b6fee55fac7
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "94655226"
---
# <a name="set-up-a-spring-cloud-config-server-instance-for-your-service"></a>настройке экземпляра сервера конфигурации Spring Cloud для службы

**Эта статья применима к:** ✔️ Java ✔️ C#

В этой статье описано подключение экземпляра сервера конфигурации Spring Cloud к службе Azure Spring Cloud.

Конфигурация Spring Cloud предоставляет поддержку на стороне сервера и клиента для внешней конфигурации в распределенной системе. Экземпляр сервера конфигурации обеспечивает централизованное управление внешними свойствами приложений во всех средах. Дополнительные сведения см. в статье [Spring Cloud Config](https://spring.io/projects/spring-cloud-config) (Конфигурация Spring Cloud).

## <a name="prerequisites"></a>Предварительные требования
* Подписка Azure. Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу. 
* Подготовленная и запущенная служба Azure Spring Cloud. Чтобы настроить и запустить службу Azure Spring Cloud, ознакомьтесь со статьей [Краткое руководство. Запуск приложения Java Spring с помощью Azure CLI](spring-cloud-quickstart.md).

## <a name="restriction"></a>Ограничение

При использовании сервера конфигурации с серверной частью Git существуют некоторые ограничения. Для доступа к серверу конфигурации и обнаружению служб в среду вашего приложения автоматически добавляются некоторые свойства. Настроив эти свойства из файлов сервера конфигурации, вы можете столкнуться с конфликтами и непредвиденным поведением. Эти свойства включают в себя следующие: 

```yaml
eureka.client.service-url.defaultZone
eureka.client.tls.keystore
server.port
spring.cloud.config.tls.keystore
spring.application.name
spring.jmx.enabled
```

> [!CAUTION]
> Настоятельно рекомендуем вам _не_ помещать вышеуказанные свойства в файлы приложения сервера конфигурации.

## <a name="create-your-config-server-files"></a>Создание файлов сервера конфигурации

Для хранения файлов сервера конфигурации Azure Spring Cloud поддерживает Azure DevOps, GitHub, GitLab и Bitbucket. После подготовки репозитория создайте и сохраните файлы конфигурации, выполнив следующие инструкции.

Кроме того, некоторые настраиваемые свойства доступны только для определенных типов. В следующих подразделах перечислены свойства для каждого типа.

### <a name="public-repository"></a>Общедоступный репозиторий

При использовании общедоступного репозитория настраиваемые свойства являются более ограниченными.

Все настраиваемые свойства, используемые для настройки общедоступного репозитория Git, перечислены в следующей таблице.

> [!NOTE]
> Использование дефиса (-) для разделения слов является единственным поддерживаемым в настоящее время соглашением об именовании. Например, вы можете использовать *default-label*, но не *defaultLabel*.

| Свойство        | Обязательно | Компонент                                                      |
| :-------------- | -------- | ------------------------------------------------------------ |
| `uri`           | Да    | URI репозитория Git, используемого в качестве серверной части сервера конфигурации, начинается с *http://* , *https://* , *git@* или *ssh://* . |
| `default-label` | Нет     | Меткой по умолчанию для репозитория Git должно быть *имя ветви*, *имя тега* или *commit-id* репозитория. |
| `search-paths`  | Нет     | Массив строк, используемых для поиска в подкаталогах репозитория Git. |

------

### <a name="private-repository-with-ssh-authentication"></a>Частный репозиторий с проверкой подлинности SSH

Все настраиваемые свойства, используемые для настройки частного репозитория Git с проверкой подлинности SSH, перечислены в следующей таблице.

> [!NOTE]
> Использование дефиса (-) для разделения слов является единственным поддерживаемым в настоящее время соглашением об именовании. Например, вы можете использовать *default-label*, но не *defaultLabel*.

| Свойство                   | Обязательно | Компонент                                                      |
| :------------------------- | -------- | ------------------------------------------------------------ |
| `uri`                      | Да    | URI репозитория Git, используемый в качестве серверной части сервера конфигурации, должен начинаться следующим образом: *http://* , *https://* , *git@* или *ssh://* . |
| `default-label`            | Нет     | Меткой по умолчанию для репозитория Git должно быть *имя ветви*, *имя тега* или *commit-id* репозитория. |
| `search-paths`             | Нет     | Массив строк, используемых для поиска в подкаталогах репозитория Git. |
| `private-key`              | Нет     | Закрытый ключ SSH для доступа к репозиторию Git, _необходимый_, когда URI начинается с *git@* или *ssh://* . |
| `host-key`                 | Нет     | Ключ узла сервера репозитория Git не должен содержать префикс алгоритма, как указано в `host-key-algorithm`. |
| `host-key-algorithm`       | Нет     | Алгоритмом ключа узла должен быть *ssh-dss*, *ssh-rsa*, *ecdsa-sha2-nistp256*, *ecdsa-sha2-nistp384* или *ecdsa-sha2-nistp521*. *Требуется*, только если существует `host-key`. |
| `strict-host-key-checking` | Нет     | Указывает, будет ли запуск экземпляра сервера конфигурации невозможен при использовании частного `host-key`. Должно быть *true* (значение по умолчанию) или *false*. |

> [!NOTE]
> Сервер конфигурации принимает `master` (OM Git) в качестве метки по умолчанию, если не указан. Но GitHub изменил ветвь по умолчанию с `master` на `main` недавно. Чтобы избежать сбоя сервера настройки Azure весны в облаке, обратите особое внимание на метку по умолчанию при настройке сервера конфигурации с помощью GitHub, особенно для новых созданных репозиториев.

-----

### <a name="private-repository-with-basic-authentication"></a>Частный репозиторий с обычной проверкой подлинности

Все настраиваемые свойства, используемые для настройки частного репозитория Git с обычной проверкой подлинности, перечислены ниже.

> [!NOTE]
> Использование дефиса (-) для разделения слов является единственным поддерживаемым в настоящее время соглашением об именовании. Например, используйте *default-label*, а не *defaultLabel*.

| Свойство        | Обязательно | Компонент                                                      |
| :-------------- | -------- | ------------------------------------------------------------ |
| `uri`           | Да    | URI репозитория Git, используемый в качестве серверной части сервера конфигурации, должен начинаться следующим образом: *http://* , *https://* , *git@* или *ssh://* . |
| `default-label` | Нет     | Меткой по умолчанию для репозитория Git должно быть *имя ветви*, *имя тега* или *commit-id* репозитория. |
| `search-paths`  | Нет     | Массив строк, используемых для поиска в подкаталогах репозитория Git. |
| `username`      | Нет     | Имя пользователя, используемое для доступа к серверу репозитория Git; _требуется_, когда сервер репозитория Git поддерживает `Http Basic Authentication`. |
| `password`      | Нет     | Пароль, используемый для доступа к серверу репозитория Git; _требуется_, когда сервер репозитория Git поддерживает `Http Basic Authentication`. |

> [!NOTE]
> Многие серверы репозитория `Git` поддерживают для обычной проверки подлинности HTTP использование токенов, а не паролей. Некоторые репозитории, например GitHub, позволяют сохранять токены в течение неограниченного времени. Однако на некоторых серверах репозитория Git, включая Azure DevOps, срок действия токенов может заканчиваться через несколько часов. Репозитории, на которые истекает срока действия токенов, не должны использовать проверку подлинности на основе токенов в Azure Spring Cloud.

### <a name="git-repositories-with-pattern"></a>Репозитории Git с шаблоном

Все настраиваемые свойства, используемые для настройки репозиториев Git с шаблоном, перечислены ниже.

> [!NOTE]
> Использование дефиса (-) для разделения слов является единственным поддерживаемым в настоящее время соглашением об именовании. Например, используйте *default-label*, а не *defaultLabel*.

| Свойство                           | Обязательно         | Компонент                                                      |
| :--------------------------------- | ---------------- | ------------------------------------------------------------ |
| `repos`                            | Нет             | Схема, состоящая из параметров репозитория Git с заданным именем. |
| `repos."uri"`                      | Да для `repos` | URI репозитория Git, используемый в качестве серверной части сервера конфигурации, должен начинаться следующим образом: *http://* , *https://* , *git@* или *ssh://* . |
| `repos."name"`                     | Да для `repos` | Имя для идентификации репозитория Git; _требуется_ только при наличии `repos`. Например, *team-A*, *team-B*. |
| `repos."pattern"`                  | Нет             | Массив строк, используемый для сопоставления имени приложения. Для каждого шаблона используйте формат `{application}/{profile}` с подстановочными знаками. |
| `repos."default-label"`            | Нет             | Меткой по умолчанию для репозитория Git должно быть *имя ветви*, *имя тега* или *commit-id* репозитория. |
| `repos."search-paths`"             | Нет             | Массив строк, используемых для поиска в подкаталогах репозитория Git. |
| `repos."username"`                 | Нет             | Имя пользователя, используемое для доступа к серверу репозитория Git; _требуется_, когда сервер репозитория Git поддерживает `Http Basic Authentication`. |
| `repos."password"`                 | Нет             | Пароль, используемый для доступа к серверу репозитория Git; _требуется_, когда сервер репозитория Git поддерживает `Http Basic Authentication`. |
| `repos."private-key"`              | Нет             | Закрытый ключ SSH для доступа к репозиторию Git, _необходимый_, когда URI начинается с *git@* или *ssh://* . |
| `repos."host-key"`                 | Нет             | Ключ узла сервера репозитория Git не должен содержать префикс алгоритма, как указано в `host-key-algorithm`. |
| `repos."host-key-algorithm"`       | Нет             | Алгоритмом ключа узла должен быть *ssh-dss*, *ssh-rsa*, *ecdsa-sha2-nistp256*, *ecdsa-sha2-nistp384* или *ecdsa-sha2-nistp521*. *Требуется*, только если существует `host-key`. |
| `repos."strict-host-key-checking"` | Нет             | Указывает, будет ли запуск экземпляра сервера конфигурации невозможен при использовании частного `host-key`. Должно быть *true* (значение по умолчанию) или *false*. |

## <a name="attach-your-config-server-repository-to-azure-spring-cloud"></a>Подключение репозитория сервера конфигурации к Azure Spring Cloud

После сохранения файлов конфигурации в репозитории необходимо подключить к нему Azure Spring Cloud.

1. Войдите на [портал Azure](https://portal.azure.com).

2. Перейдите на страницу **Обзор** Azure Spring Cloud.

3. В левой области навигации выберите **сервер конфигурации** .

4. В разделе **Репозиторий по умолчанию** задайте для **URI** значение "https://github.com/Azure-Samples/piggymetrics-config".

5. Нажмите кнопку **Проверить**.

    ![Переход к серверу конфигурации](media/spring-cloud-quickstart-launch-app-portal/portal-config.png)

6. После завершения проверки щелкните **Применить**, чтобы сохранить изменения.

    ![Проверка сервера конфигурации](media/spring-cloud-quickstart-launch-app-portal/validate-complete.png)

7. На обновление конфигурации может потребоваться несколько минут.
 
    ![Обновление сервера конфигурации](media/spring-cloud-quickstart-launch-app-portal/updating-config.png) 

8. После завершения настройки вы получите уведомление.

### <a name="enter-repository-information-directly-to-the-azure-portal"></a>Введение данных репозитория непосредственно на портал Azure

#### <a name="default-repository"></a>Репозиторий по умолчанию

* **Общедоступный репозиторий**. В разделе **Репозиторий по умолчанию** вставьте URI репозитория в поле **URI**.  Задайте для параметра **Метка** значение **config**. Убедитесь, что параметр **Проверка подлинности** имеет значение **Общедоступный**, а затем выберите **Применить** для завершения. 

* **Частный репозиторий**. Azure Spring Cloud поддерживает обычную проверку подлинности на основе пароля или маркера и SSH.

    * **Обычная проверка подлинности**. В разделе **Репозиторий по умолчанию** в поле **URI** вставьте URI репозитория и нажмите кнопку **Проверка подлинности** (значок "Карандаш"). В области **Изменение параметров проверки подлинности** в раскрывающемся списке **Тип проверки подлинности** выберите **HTTP Basic** и введите свое имя пользователя и пароль или токен, чтобы предоставить доступ к Azure Spring Cloud. Щелкните **ОК** и **Применить**, чтобы завершить настройку экземпляра сервера конфигурации.

    ![Панель "изменение проверки подлинности" — Обычная аутентификация](media/spring-cloud-tutorial-config-server/basic-auth.png)
    
    > [!CAUTION]
    > Некоторые серверы репозитория Git, такие как GitHub, для **обычной проверки подлинности** используют маркер *personal-token* или *access-token*, такой как пароль. Вы можете использовать этот тип маркера в качестве пароля в Azure Spring Cloud, так как срок его действия никогда не истечет. Но для других серверов репозитория Git, таких как BitBucket и Azure DevOps, срок действия *access-token* истекает через один или два часа. Это означает, что при использовании этих серверов репозитория с Azure Spring Cloud эта опция бесполезная.

    * **SSH**: В разделе **Репозиторий по умолчанию** в поле **URI** вставьте URI репозитория и нажмите кнопку **Проверка подлинности** (значок "Карандаш"). В области **Изменение параметров проверки подлинности** в раскрывающемся списке **Тип проверки подлинности** выберите **SSH** и введите **закрытый ключ**. При необходимости можно указать **ключ узла** и **алгоритм ключа узла**. Не забудьте включить открытый ключ в репозиторий сервера конфигурации. Щелкните **ОК** и **Применить**, чтобы завершить настройку экземпляра сервера конфигурации.

    ![Проверка подлинности SSH в панели "изменение аутентификации"](media/spring-cloud-tutorial-config-server/ssh-auth.png)

#### <a name="pattern-repository"></a>Репозиторий шаблонов

Если вы хотите использовать необязательный **репозиторий шаблона** для настройки службы, укажите **URI** и **проверку подлинности** аналогично **репозиторию по умолчанию**. Не забудьте включить в шаблон **имя**, а затем нажмите кнопку **Применить**, чтобы присоединить его к экземпляру. 

### <a name="enter-repository-information-into-a-yaml-file"></a>Ввод сведений о репозитории в файл YAML

Если вы создали файл YAML с параметрами репозитория, файл можно импортировать непосредственно с локального компьютера в Azure Spring Cloud. Простой файл YAML для частного репозитория с обычной проверкой подлинности будет выглядеть следующим образом:

```yaml
spring:
    cloud:
        config:
            server:
                git:
                    uri: https://github.com/azure-spring-cloud-samples/config-server-repository.git
                    username: <username>
                    password: <password/token>

```

Нажмите кнопку **Импорт параметров**, а затем выберите файл YAML из каталога проекта. Выберите **Импорт**, после чего появится операция `async` из окна **Уведомления**. Через 1-2 минуты она должна сообщить об успешном выполнении.

![Область "Уведомления" сервера конфигурации](media/spring-cloud-tutorial-config-server/local-yml-success.png)


Сведения из файла YAML должны отобразиться на портале Azure. Нажмите кнопку **Применить** для завершения. 

## <a name="using-azure-repos-for-azure-spring-cloud-configuration"></a>Использование Azure Repos для настройки облачного облака Azure

Azure Spring Cloud может получить доступ к общедоступным репозиториям Git, защищенным с помощью SSH или обычной проверки подлинности HTTP. Мы будем использовать последний вариант, так как проще создавать Azure Repos и управлять ими.

### <a name="get-repo-url-and-credentials"></a>Получение URL-адреса и учетных данных репозитория
1. На портале Azure Repos проекта нажмите кнопку "клонировать":

    ![Кнопка клонирования](media/spring-cloud-tutorial-config-server/clone-button.png)

1. Скопируйте URL-адрес клона из текстового поля. Этот URL-адрес обычно будет иметь следующий вид:

    ```Text
    https://<organization name>@dev.azure.com/<organization name>/<project name>/_git/<repository name>
    ```

    Удалите все после `https://` и более `dev.azure.com` , включая `@` . Итоговый URL-адрес должен иметь вид:

    ```Text
    https://dev.azure.com/<organization name>/<project name>/_git/<repository name>
    ```

    Сохраните этот URL-адрес для использования в следующем разделе.

1. Щелкните "создать учетные данные Git". Отобразятся имя пользователя и пароль. Сохраните их для использования в следующем разделе.


### <a name="configure-azure-spring-cloud-to-access-the-git-repository"></a>Настройка доступа Azure Spring Cloud к репозиторию Git

1. Войдите на [портал Azure](https://portal.azure.com).

1. Перейдите на страницу **Обзор** Azure Spring Cloud.

1. Выберите службу для настройки.

1. В левой области страницы службы в разделе **Параметры** выберите вкладку **сервер конфигурации** . Настройте созданный ранее репозиторий.
   - Добавьте URL-адрес репозитория, сохраненный из предыдущего раздела.
   - Щелкните `Authentication` и выберите `HTTP Basic`
   - __Имя пользователя__ — это имя пользователя, сохраненное в предыдущем разделе.
   - __Пароль__ — это пароль, сохраненный из предыдущего раздела.
   - Щелкните "Применить" и дождитесь завершения операции.

   ![Сервер конфигурации Spring Cloud](media/spring-cloud-tutorial-config-server/config-server-azure-repos.png)

## <a name="delete-your-app-configuration"></a>Удаление конфигурации приложения

После сохранения файла конфигурации на вкладке **Конфигурация** отобразится кнопка **Delete app configuration** (Удалить конфигурацию приложения). При нажатии этой кнопки имеющиеся параметры будут полностью удалены. Нажмите ее, если вам нужно подключить экземпляр сервера конфигурации к другому источнику, например, для перехода с GitHub на Azure DevOps.



## <a name="next-steps"></a>Дальнейшие действия

В рамках этой статьи вы узнали, как включить и настроить экземпляр сервера конфигурации Spring Cloud. Дополнительные сведения об управлении приложением см. в статье [Масштабирование приложения в Azure Spring Cloud](spring-cloud-tutorial-scale-manual.md).
