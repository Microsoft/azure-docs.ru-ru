---
title: 'VPN-шлюз Azure: создание & установка файлов конфигурации VPN-клиента — P2S RADIUS Connections'
description: Создайте файлы конфигурации VPN-клиента Windows, OS X и Linux для подключений, использующих проверку подлинности RADIUS.
services: vpn-gateway
author: cherylmc
ms.service: vpn-gateway
ms.topic: how-to
ms.date: 09/02/2020
ms.author: cherylmc
ms.openlocfilehash: e6d811e19bb19c8c8bf96764cfcca2b1294f4a85
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "91440070"
---
# <a name="create-and-install-vpn-client-configuration-files-for-p2s-radius-authentication"></a>Создание и установка файлов конфигурации VPN-клиента для аутентификации при подключениях типа "точка — сеть" с использованием RADIUS

Для установления подключения "точка— сеть" к виртуальной сети необходимо настроить клиентское устройство, из которого будет выполняться подключение. Вы можете создавать VPN-подключения P2S из клиентских устройств Windows, OS X и Linux. 

При использовании проверки подлинности RADIUS доступно несколько способов проверки подлинности: по имени пользователя и паролю, на основе сертификата, а также другие типы проверки подлинности. Настройка VPN-клиента отличается для каждого типа аутентификации. Для настройки VPN-клиента используются файлы конфигурации клиента, содержащие необходимые параметры. Эта статья поможет создать и установить конфигурацию VPN-клиента для используемого типа аутентификации RADIUS.

>[!IMPORTANT]
>[!INCLUDE [TLS](../../includes/vpn-gateway-tls-change.md)]
>

Ниже приведен рабочий процесс настройки аутентификации RADIUS для подключений типа "точка — сеть".

1. [Настройте VPN-шлюз Azure для подключения P2S](point-to-site-how-to-radius-ps.md).
2. [Настройте сервер RADIUS для проверки подлинности](point-to-site-how-to-radius-ps.md#radius). 
3. **Получите конфигурацию VPN-клиента для выбранного варианта проверки подлинности и используйте ее для настройки VPN-клиента** (эта статья).
4. [Настройте и установите подключение "точка — сеть"](point-to-site-how-to-radius-ps.md).

>[!IMPORTANT]
>Если вы создали профиль конфигурации VPN-клиента, а затем внесли изменения в конфигурацию VPN-подключения "точка — сеть" (например, изменили тип VPN-протокола или проверки подлинности), создайте и установите новую конфигурацию VPN-клиента на устройствах пользователей.
>
>

Чтобы использовать разделы этой статьи, сначала решите, какой тип аутентификации вы хотите использовать: по имени пользователя и паролю, на основе сертификата или другие типы аутентификации. В каждом разделе есть шаги для Windows, OS X и Linux (в настоящее время доступны ограниченные действия).


## <a name="usernamepassword-authentication"></a><a name="adeap"></a>Проверка имени пользователя и пароля

Вы можете настроить проверку подлинности по имени пользователя и паролю с или без Active Directory. При любом сценарии убедитесь, что у всех пользователей есть учетные данные (имя пользователя и пароль), которые могут использоваться при аутентификации RADIUS.

При настройке аутентификации по имени пользователя и паролю можно создать только конфигурацию для протокола аутентификации по имени пользователя и паролю EAP-MSCHAPv2. В командах для параметра `-AuthenticationMethod` укажите значение `EapMSChapv2`.

### <a name="1-generate-vpn-client-configuration-files"></a><a name="usernamefiles"></a> 1. Создание файлов конфигурации VPN-клиента

Файлы конфигурации VPN-клиента можно создать с помощью портал Azure или с помощью Azure PowerShell.

#### <a name="azure-portal"></a>Портал Azure

1. Перейдите к шлюзу виртуальной сети.
2. Щелкните **Конфигурация "точка — сеть**".
3. Щелкните **скачать VPN-клиент**.
4. Выберите клиент и заполните все запрошенные сведения.
5. Нажмите кнопку **скачать** , чтобы создать ZIP-файл.
6. ZIP-файл будет скачан, как правило, в папку загрузки.

#### <a name="azure-powershell"></a>Azure PowerShell

Создайте файлы конфигурации VPN-клиента для аутентификации имени пользователя и пароля. Вы можете создать файлы конфигурации VPN-клиента с помощью следующей команды:

```azurepowershell-interactive
New-AzVpnClientConfiguration -ResourceGroupName "TestRG" -Name "VNet1GW" -AuthenticationMethod "EapMSChapv2"
```
 
Выполненная команда возвращает ссылку. Скопируйте и вставьте ссылку на веб-браузер, чтобы скачать **VpnClientConfiguration.zip**. Распакуйте файл. Отобразятся следующие папки: 
 
* **WindowsAmd64** и **WindowsX86**. Эти папки содержат пакеты установщика 64- и 32-разрядной версий Windows соответственно. 
* **Generic**. Эта папка содержит общие сведения для создания конфигурации VPN-клиента. Эта папка не требуется, чтобы настроить проверку подлинности по имени пользователя и пароля.
* **Mac**. Если при создании шлюза виртуальной сети настроен протокол IKEv2, отобразится папка с именем **Mac**, которая содержит файл **mobileconfig**. Этот файл используется для настройки клиентов Mac.

Если вы уже создали файлы конфигурации клиента, получить их можно с помощью командлета `Get-AzVpnClientConfiguration`. Но если изменить конфигурацию VPN-подключения "точка — сеть", например изменить тип VPN-протокола или проверки подлинности, конфигурация не обновится автоматически. Необходимо выполнить командлет `New-AzVpnClientConfiguration` для создания скачиваемого файла конфигурации.

Чтобы получить созданные файлы конфигурации, используйте следующую команду:

```azurepowershell-interactive
Get-AzVpnClientConfiguration -ResourceGroupName "TestRG" -Name "VNet1GW"
```

### <a name="2-configure-vpn-clients"></a><a name="setupusername"></a> 2. Настройка VPN-клиентов

Можно настроить следующие VPN-клиенты:

* [Windows](#adwincli)
* [Mac (OS X)](#admaccli)
* [Linux с использованием strongSwan](#adlinuxcli).
 
#### <a name="windows-vpn-client-setup"></a><a name="adwincli"></a>Настройка VPN-клиента Windows

На каждом клиентском компьютере Windows можно использовать один и тот же пакет конфигурации VPN-клиента, если его версия соответствует архитектуре клиента. Список поддерживаемых клиентских операционных систем см. в разделе с [вопросами и ответами](vpn-gateway-vpn-faq.md#P2S).

Чтобы настроить в Windows собственный VPN-клиент для аутентификации на основе сертификата, сделайте следующее:

1. Выберите файлы конфигурации VPN-клиента, которые соответствуют архитектуре компьютера Windows. Для архитектуры с 64-разрядным процессором выберите пакет установщика **VpnClientSetupAmd64** . Для архитектуры с 32-разрядным процессором выберите пакет установщика **VpnClientSetupX86** . 
2. Дважды щелкните пакет, чтобы установить его. Если отображается всплывающее окно SmartScreen, выберите пункт **больше сведений**  >  **запустить все равно**.
3. На клиентском компьютере перейдите в раздел **Параметры сети** и выберите **VPN**. Для VPN-подключения отображается имя виртуальной сети, к которой оно устанавливается. 

#### <a name="mac-os-x-vpn-client-setup"></a><a name="admaccli"></a>Настройка VPN-клиента Mac (OS X)

1. Выберите файл **VpnClientSetup mobileconfig** и отправьте его всем пользователям. Можно использовать электронную почту или другой способ.

2. Найдите файл **mobileconfig** на компьютере Mac.

   ![Расположение файла mobileconfig](./media/point-to-site-vpn-client-configuration-radius/admobileconfigfile.png)

3. (Необязательно.) Если вы хотите указать пользовательскую службу DNS, добавьте следующие строки в файл **mobileconfig**:

   ```xml
    <key>DNS</key>
    <dict>
      <key>ServerAddresses</key>
        <array>
            <string>10.0.0.132</string>
        </array>
      <key>SupplementalMatchDomains</key>
        <array>
            <string>TestDomain.com</string>
        </array>
    </dict> 
   ```
4. Дважды щелкните профиль, чтобы установить его, и нажмите кнопку **Continue** (Продолжить). Имя профиля совпадает с именем виртуальной сети.

   ![Сообщение об установке](./media/point-to-site-vpn-client-configuration-radius/adinstall.png)
5. Нажмите кнопку **Continue** (Продолжить), чтобы определить отправителя как надежного и продолжить установку.

   ![Сообщение с подтверждением](./media/point-to-site-vpn-client-configuration-radius/adcontinue.png)
6. При установке профиля вы можете указать имя пользователя и пароль, которые используются для проверки подлинности VPN. Эти сведения вводить не обязательно, но если вы их укажете, они сохранятся и будут автоматически подставляться при установке подключения. Нажмите кнопку **Install (Установить)**, чтобы продолжить.

   ![Поля Username (Имя пользователя) и Password (Пароль) для VPN](./media/point-to-site-vpn-client-configuration-radius/adsettings.png)
7. Введите имя пользователя и пароль, чтобы получить разрешения, необходимые для установки профиля на компьютере. Щелкните **ОК**.

   ![Поля Username (Имя пользователя) и Password (Пароль) для установки профиля](./media/point-to-site-vpn-client-configuration-radius/adusername.png)
8. Установленный профиль отображается в диалоговом окне **Profiles** (Профили). Это диалоговое окно также можно открыть позже в разделе **System Preferences** (Системные настройки).

   ![Диалоговое окно Profiles (Профили)](./media/point-to-site-vpn-client-configuration-radius/adsystempref.png)
9. Чтобы получить доступ к VPN-подключению, откройте в разделе **System Preferences** (Системные настройки) диалоговое окно **Network** (Сеть).

   ![Значки в системных настройках](./media/point-to-site-vpn-client-configuration-radius/adnetwork.png)
10. VPN-подключение отображается как **IkeV2-VPN**. Имя можно изменить, обновив файл **MOBILECONFIG**.

    ![Подробные сведения о VPN-подключении](./media/point-to-site-vpn-client-configuration-radius/adconnection.png)
11. Выберите **Параметры проверки подлинности**. В списке выберите **Username** (Имя пользователя) и введите свои учетные данные. Если учетные данные были введены ранее, в списке автоматически выбирается **имя пользователя** , а имя пользователя и пароль заполняются заранее. Нажмите кнопку **ОК**, чтобы сохранить настройки.

    ![Снимок экрана, показывающий раскрывающийся список "Параметры проверки подлинности" с выбранным параметром "имя пользователя".](./media/point-to-site-vpn-client-configuration-radius/adauthentication.png)
12. Вернитесь в диалоговое окно **Network** (Сеть) и выберите **Apply** (Применить), чтобы сохранить изменения. Чтобы инициировать подключение, выберите **Connect** (Подключиться).

#### <a name="linux-vpn-client-setup-through-strongswan"></a><a name="adlinuxcli"></a>Установка VPN-клиента Linux с помощью strongSwan

Приведенные ниже инструкции были созданы с помощью strongSwan 5.5.1 в Ubuntu 17.0.4. Фактические экраны могут отличаться в зависимости от вашей версии Linux и strongSwan.

1. Откройте приложение **Terminal**, чтобы установить **strongSwan** и его Network Manager, выполнив команду из примера. Если появляется сообщение об ошибке, связанной с `libcharon-extra-plugins`, замените этот параметр на `strongswan-plugin-eap-mschapv2`.

   ```Terminal
   sudo apt-get install strongswan libcharon-extra-plugins moreutils iptables-persistent network-manager-strongswan
   ```
2. Щелкните значок **Network Manager** (Диспетчер сети) (стрелка вверх или стрелка вниз), а затем выберите **Edit Connections** (Изменить подключения).

   ![Выбор параметра Edit Connections (Изменить подключения) в диспетчере сети](./media/point-to-site-vpn-client-configuration-radius/EditConnection.png)
3. Нажмите кнопку **Add** (Добавить), чтобы создать подключение.

   ![Кнопка Add (Добавить) для подключения](./media/point-to-site-vpn-client-configuration-radius/AddConnection.png)
4. Выберите **IPsec/IKEv2 (strongswan)** (IPsec или IKEv2 (strongswan)) из раскрывающегося меню, а затем — **Create** (Создать). На этом шаге можно переименовать подключение.

   ![Выбор типа подключения](./media/point-to-site-vpn-client-configuration-radius/AddIKEv2.png)
5. Откройте файл **VpnSettings.xml** из папки **Generic** скачанных файлов конфигурации клиента. Найдите тег `VpnServer` и скопируйте имя, начиная с `azuregateway` и заканчивая `.cloudapp.net`.

   ![Содержимое файла VpnSettings.xml](./media/point-to-site-vpn-client-configuration-radius/VpnSettings.png)
6. Вставьте это имя в поле **Address** (Адрес) нового VPN-подключения в разделе **Gateway** (Шлюз). Затем щелкните значок папки в конце поля **Certificate** (Сертификат), перейдите в папку **Generic** и выберите файл **VpnServerRoot**.
7. В разделе **Client** (Клиент) подключения выберите значение **EAP** для параметра **Authentication** (Проверка подлинности) и введите имя пользователя и пароль. Необходимо выбрать значок замка справа, чтобы сохранить эти сведения. Затем нажмите кнопку **Сохранить**.

   ![Изменение параметров подключения](./media/point-to-site-vpn-client-configuration-radius/editconnectionsettings.png)
8. Щелкните значок **Network Manager** (Диспетчер сети) (стрелка вверх или стрелка вниз), а затем выберите **VPN Connections** (VPN-подключения). Вы увидите созданное VPN-подключение. Чтобы инициировать подключение, выберите его.

   ![Подключение VPN Radius в диспетчере сети](./media/point-to-site-vpn-client-configuration-radius/ConnectRADIUS.png)

## <a name="certificate-authentication"></a><a name="certeap"></a>Аутентификация на основе сертификата
 
Вы можете создать файлы конфигурации VPN-клиента для аутентификации RADIUS на основе сертификата с использованием протокола EAP-TLS. Как правило, для проверки подлинности пользователя при VPN-подключениях используется сертификат, который выпущен предприятием. Убедитесь, что на устройствах всех пользователей, для которых инициируется подключение, установлен сертификат, и что сервер RADIUS может его проверить.

>[!NOTE]
>[!INCLUDE [TLS](../../includes/vpn-gateway-tls-change.md)]
>

В командах для параметра `-AuthenticationMethod` укажите значение `EapTls`. При аутентификации на основе сертификата клиент проверяет сервер RADIUS, оценивая его сертификат. Параметр `-RadiusRootCert` определяет CER-файл с корневым сертификатом, который используется для проверки сервера RADIUS.

Для каждого клиентского VPN-устройства требуется установленный сертификат клиента. Иногда у устройства Windows может быть несколько сертификатов клиента. В таком случае при проверке подлинности может отобразиться всплывающее диалоговое окно со списком всех сертификатов. Пользователь должен выбрать в списке нужный сертификат. Сертификат можно найти с помощью фильтра, указав корневой сертификат, к которому должен привязываться сертификат клиента. 

Параметр `-ClientRootCert` определяет CER-файл с корневым сертификатом. Это необязательный параметр. Если у устройства, для которого вам нужно установить подключение, есть один сертификат клиента, этот параметр указывать не требуется.

### <a name="1-generate-vpn-client-configuration-files"></a><a name="certfiles"></a>1. Создание файлов конфигурации VPN-клиента

Вы можете создать файлы конфигурации VPN-клиента для аутентификации на основе сертификата. Вы можете создать файлы конфигурации VPN-клиента с помощью следующей команды:
 
```azurepowershell-interactive
New-AzVpnClientConfiguration -ResourceGroupName "TestRG" -Name "VNet1GW" -AuthenticationMethod "EapTls" -RadiusRootCert <full path name of .cer file containing the RADIUS root> -ClientRootCert <full path name of .cer file containing the client root> | fl
```

Выполненная команда возвращает ссылку. Скопируйте и вставьте ссылку в веб-браузер, чтобы скачать файл VpnClientConfiguration.zip. Распакуйте файл. Отобразятся следующие папки:

* **WindowsAmd64** и **WindowsX86**. Эти папки содержат пакеты установщика 64- и 32-разрядной версий Windows соответственно. 
* **GenericDevice**. Эта папка содержит общие сведения для создания конфигурации VPN-клиента.

Если вы уже создали файлы конфигурации клиента, получить их можно с помощью командлета `Get-AzVpnClientConfiguration`. Но если изменить конфигурацию VPN-подключения "точка — сеть", например изменить тип VPN-протокола или проверки подлинности, конфигурация не обновится автоматически. Необходимо выполнить командлет `New-AzVpnClientConfiguration` для создания скачиваемого файла конфигурации.

Чтобы получить созданные файлы конфигурации, используйте следующую команду:

```azurepowershell-interactive
Get-AzVpnClientConfiguration -ResourceGroupName "TestRG" -Name "VNet1GW" | fl
```
 
### <a name="2-configure-vpn-clients"></a><a name="setupusername"></a> 2. Настройка VPN-клиентов

Можно настроить следующие VPN-клиенты:

* [Windows](#certwincli)
* [Mac (OS X)](#certmaccli)
* Linux (поддерживается, но инструкции в статье пока не представлены).

#### <a name="windows-vpn-client-setup"></a><a name="certwincli"></a>Настройка VPN-клиента Windows

1. Выберите пакет конфигурации и установите его на клиентском устройстве. Для архитектуры с 64-разрядным процессором выберите пакет установщика **VpnClientSetupAmd64** . Для архитектуры с 32-разрядным процессором выберите пакет установщика **VpnClientSetupX86** . Если отображается всплывающее окно SmartScreen, выберите пункт **больше сведений**  >  **запустить все равно**. Вы также можете сохранить пакет для установки на других клиентских компьютерах.
2. Для выполнения проверки подлинности каждому клиенту требуется сертификат клиента. Установите сертификат клиента. Дополнительные сведения о сертификатах клиентов см. [в статье клиентские сертификаты для "точка — сеть](vpn-gateway-certificates-point-to-site.md)". Установка созданного сертификата описывается в разделе [Установка сертификата клиента для аутентификации Azure на основе сертификата при подключениях типа "точка — сеть"](point-to-site-how-to-vpn-client-install-azure-cert.md).
3. На клиентском компьютере перейдите в раздел **Параметры сети** и выберите **VPN**. Для VPN-подключения отображается имя виртуальной сети, к которой оно устанавливается.

#### <a name="mac-os-x-vpn-client-setup"></a><a name="certmaccli"></a>Настройка VPN-клиента Mac (OS X)

Для каждого устройства Mac, которое подключается к виртуальной сети Azure, нужно создать отдельный профиль, так как для аутентификации таких устройств в профиле необходимо указать сертификат пользователя. В папке **Generic** содержатся все сведения, требуемые для создания профиля.

* Файл **VpnSettings.xml** содержит такие важные параметры, как адрес сервера и тип туннеля.
* Файл **VpnServerRoot.cer** содержит корневой сертификат, который требуется для проверки VPN-шлюза при установке подключения "точка — сеть".
* Файл **RadiusServerRoot.cer** содержит корневой сертификат, который требуется для проверки сервера RADIUS при аутентификации.

Чтобы настроить на устройстве Mac собственный VPN-клиент для проверки подлинности на основе сертификата, сделайте следующее:

1. Импортируйте корневые сертификаты **VpnServerRoot** и **RadiusServerRoot** на устройство Mac. Скопируйте каждый файл на устройство Mac, дважды щелкните его и выберите **Add** (Добавить).

   ![Добавление сертификата VpnServerRoot](./media/point-to-site-vpn-client-configuration-radius/addcert.png)

   ![Добавление сертификата RadiusServerRoot](./media/point-to-site-vpn-client-configuration-radius/radiusrootcert.png)
2. Для выполнения проверки подлинности каждому клиенту требуется сертификат клиента. Установите сертификат клиента на клиентском устройстве.
3. Откройте диалоговое окно **Network** (Сеть) в разделе **Network Preferences** (Параметры сети). Выберите этот параметр **+** , чтобы создать новый профиль подключения VPN-клиента для подключения P2S к виртуальной сети Azure.

   Установите следующие значения: для параметра **Interface** (Интерфейс) — **VPN**, для **VPN Type** (Тип VPN) — **IKEv2**. Укажите имя профиля в поле **Service Name** (Имя службы), а затем нажмите кнопку **Create** (Создать), чтобы создать профиль подключения VPN-клиента.

   ![Сведения об интерфейсе и имени службы](./media/point-to-site-vpn-client-configuration-radius/network.png)
4. В папке **Generic** из файла **VpnSettings.xml** скопируйте значение тега **VpnServer**. Вставьте это значение в поля профиля **Server Address** (Адрес сервера) и **Remote ID** (Удаленный ИД). Не заполняйте поле **Local ID** (Локальный ИД).

   ![Информация о сервере](./media/point-to-site-vpn-client-configuration-radius/servertag.png)
5. Выберите **Authentication Settings** (Параметры проверки подлинности), а затем — **Certificate** (Сертификат). 

   ![Параметры проверки подлинности](./media/point-to-site-vpn-client-configuration-radius/certoption.png)
6. Щелкните **Select** (Выбрать), чтобы выбрать сертификат, который будет использоваться для проверки подлинности.

   ![Выбор сертификата для проверки подлинности](./media/point-to-site-vpn-client-configuration-radius/certificate.png)
7. В окне **Choose An Identity** (Выбор удостоверения) отобразится список доступных сертификатов. Выберите нужный сертификат, а затем нажмите кнопку **Continue** (Продолжить).

   ![Список Choose An Identity (Выбор удостоверения)](./media/point-to-site-vpn-client-configuration-radius/identity.png)
8. В поле **Local ID** (Локальный ИД) укажите имя сертификата (из шага 6). В нашем примере это **ikev2Client.com**. Нажмите кнопку **Apply** (Применить), чтобы сохранить изменения.

   ![Поле Local ID (Локальный ИД)](./media/point-to-site-vpn-client-configuration-radius/applyconnect.png)
9. В диалоговом окне **Network** (Сеть) выберите **Apply** (Применить), чтобы сохранить все изменения. Затем выберите **Connect** (Подключиться), чтобы установить подключение "точка — сеть" к виртуальной сети Azure.

## <a name="working-with-other-authentication-types-or-protocols"></a><a name="otherauth"></a>Работа с другими протоколами или типами аутентификации

Чтобы использовать другой тип проверки подлинности (например, OTP) либо же другой протокол проверки подлинности (например, протокол PEAP-MSCHAPv2, а не EAP-MSCHAPv2), создайте собственный профиль конфигурации VPN-клиента. Чтобы создать профиль, требуются следующие данные: IP-адрес шлюза виртуальной сети, тип туннеля и сведения о маршрутах с разделенный туннелем. Эти данные можно получить, сделав следующее:

1. Выполните командлет `Get-AzVpnClientConfiguration`, чтобы создать конфигурацию VPN-клиента для EapMSChapv2.

2. Распакуйте файл VpnClientConfiguration.zip и найдите папку **GenericDevice**. Не используйте папки с установщиками Windows для 64- и 32-разрядной архитектур.
 
3. Папка **GenericDevice** содержит XML-файл с именем **VpnSettings**. В этом файле находится вся необходимая информация.

   * **VpnServer** — полное доменное имя VPN-шлюза Azure. Это адрес, по которому подключается клиент.
   * **VpnType** — тип туннеля, который вы используете для подключения.
   * **Routes** — маршруты, которые нужно настроить в профиле, чтобы через P2S-туннель отправлялся только трафик виртуальной сети Azure.
   
   Кроме того, папка **GenericDevice** содержит CER-файл с именем **VpnServerRoot**. В этом файле содержится корневой сертификат, который требуется для проверки VPN-шлюза Azure при установке подключения "точка — сеть". Установите сертификат на всех устройствах, которые будут подключаться к виртуальной сети Azure.

## <a name="next-steps"></a>Дальнейшие действия

Вернитесь к статье, чтобы [завершить настройку подключения типа "точка — сеть"](point-to-site-how-to-radius-ps.md).

Дополнительные сведения см. в руководстве по [устранению неполадок подключения типа "точка — сеть" в Azure](vpn-gateway-troubleshoot-vpn-point-to-site-connection-problems.md).
