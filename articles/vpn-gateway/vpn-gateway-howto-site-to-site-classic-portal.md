---
title: Соединение локальной сети с виртуальною сетью Azure с помощью подключения VPN типа "сеть — сеть" (классического) и портала | Документация Майкрософт
description: Создание подключения IPsec между локальной сетью и классической виртуальной сетью Azure при помощи общего доступа через Интернет.
services: vpn-gateway
author: cherylmc
ms.service: vpn-gateway
ms.topic: how-to
ms.date: 10/08/2020
ms.author: cherylmc
ms.openlocfilehash: 4ad05281f13885327c855a261a3101388f38af83
ms.sourcegitcommit: aaa65bd769eb2e234e42cfb07d7d459a2cc273ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/27/2021
ms.locfileid: "98878059"
---
# <a name="create-a-site-to-site-connection-using-the-azure-portal-classic"></a>Создание подключения типа "сеть — сеть" с помощью классического портала Azure

В этой статье показано, как с помощью портала Azure создать подключение типа "сеть — сеть" с использованием VPN-шлюза между вашей локальной сетью к виртуальной. Действия, описанные в этой статье, применимы к классической модели развертывания и не применяются к текущей модели развертывания диспетчер ресурсов. Эту конфигурацию также можно создать с помощью разных средств или моделей развертывания, выбрав вариант из следующего списка:

> [!div class="op_single_selector"]
> * [Портал Azure](./tutorial-site-to-site-portal.md)
> * [PowerShell](vpn-gateway-create-site-to-site-rm-powershell.md)
> * [CLI](vpn-gateway-howto-site-to-site-resource-manager-cli.md)
> * [Портал Azure (классический)](vpn-gateway-howto-site-to-site-classic-portal.md)
> 

Подключение VPN-шлюза типа "сеть — сеть" используется для подключения между локальной сетью и виртуальной сетью Azure через туннель VPN по протоколу IPsec/IKE (IKEv1 или IKEv2). Для этого типа подключения требуется локальное VPN-устройство, которому назначен внешний общедоступный IP-адрес. Дополнительные сведения о VPN-шлюзах см. в [этой статье](vpn-gateway-about-vpngateways.md).

![Схема подключения типа "сеть — сеть" через VPN-шлюз](./media/vpn-gateway-howto-site-to-site-classic-portal/site-to-site-diagram.png)

## <a name="before-you-begin"></a><a name="before"></a>Перед началом

Перед началом настройки убедитесь, что удовлетворены следующие требования:

* Убедитесь, что выбрана классическая модель развертывания. Если вы хотите работать в модели развертывания Resource Manager, см. статью [Создание подключения типа "сеть — сеть" на портале Azure](./tutorial-site-to-site-portal.md). Рекомендуется использовать модель развертывания диспетчер ресурсов, так как классическая модель является устаревшей.
* Убедитесь, что у вас есть совместимое VPN–устройство и пользователь, который может настроить его. Дополнительные сведения о совместимых устройствах VPN и их настройке см. в [этой статье](vpn-gateway-about-vpn-devices.md).
* Убедитесь, что у вас есть общедоступный IPv4–адрес для вашего VPN–устройства.
* Если вы не знаете диапазоны IP-адресов в своей конфигурации локальной сети, найдите того, кто сможет предоставить вам нужную информацию. При создании этой конфигурации необходимо указать префиксы диапазона IP-адресов, которые Azure будет направлять к локальному расположению. Ни одна из подсетей локальной сети не может перекрывать виртуальные подсети, к которым вы хотите подключиться.
* Для указания общего ключа и создания подключения к VPN-шлюзу требуется PowerShell. [!INCLUDE [vpn-gateway-classic-powershell](../../includes/vpn-gateway-powershell-classic-locally.md)]

### <a name="sample-configuration-values-for-this-exercise"></a><a name="values"></a>Примеры значений конфигурации для этого упражнения

В примерах этой статьи мы используем следующие значения. Эти значения можно использовать для создания тестовой среды или для лучшего понимания примеров в этой статье. Как правило, при работе со значениями IP-адресов для адресного пространства необходимо координировать работу администратора сети, чтобы избежать перекрытия адресных пространств, что может повлиять на маршрутизацию. В этом случае замените значения IP-адреса собственными, если вы хотите создать работающее подключение.

* **Группа ресурсов**. TestRG1
* **Имя виртуальной сети:** TestVNet1
* **Адресное пространство:** 10.11.0.0/16
* **Имя подсети**: FrontEnd
* **Диапазон адресов подсети:** 10.11.0.0/24.
* **GatewaySubnet:** 10.11.255.0/27
* **Регион**: Восточная часть США (США)
* **Имя локального сайта:** Site2.
* **Адресное пространство клиента:** Это адресное пространство, которое находится на локальном сайте.

## <a name="create-a-virtual-network"></a><a name="CreatVNet"></a>Создание виртуальной сети

При создании виртуальной сети для подключения типа "сеть — сеть" убедитесь, что указанные адресные пространства не перекрывают адресные пространства клиента для локальных сайтов, к которым необходимо подключиться. В таком случае подключение не будет работать правильно.

* Если у вас уже есть виртуальная сеть, проверьте совместимость параметров со структурой VPN-шлюза. Обратите особое внимание на подсети, которые могут пересекаться с другими сетями.

* Если у вас нет виртуальной сети, создайте ее. Снимки экрана приведены в качестве примеров. Обязательно подставьте собственные значения.

### <a name="to-create-a-virtual-network"></a>Создание виртуальной сети

[!INCLUDE [basic classic vnet](../../includes/vpn-gateway-vnet-classic.md)]

[!INCLUDE [basic classic DNS](../../includes/vpn-gateway-dns-classic.md)]

## <a name="configure-the-site-and-gateway"></a><a name="localsite"></a>Настройка сайта и шлюза

### <a name="to-configure-the-site"></a>Настройка сайта

Термин "локальный сайт" обычно означает локальное расположение. Он содержит IP-адрес VPN-устройства, для которого будет создано подключение, и диапазоны IP-адресов, которые будут использоваться для передачи трафика через VPN-шлюз к VPN-устройству.

1. На странице виртуальной сети в разделе **Параметры** выберите **подключения "сеть — сеть**".
1. На странице подключения "сеть — сеть" выберите **+ Добавить**.
1. На странице **Настройка VPN-подключения и шлюза** для **типа подключения** оставьте выбранным " **сеть — сеть** ". В этом упражнении необходимо использовать сочетание [значений примеров](#values) и собственных значений.

   * **IP-адрес VPN-шлюза.** Это общедоступный IP-адрес VPN-устройства для локальной сети. Для VPN-устройства требуется общедоступный IP-адрес IPv4. Укажите допустимый общедоступный IP-адрес VPN-устройства, к которому необходимо подключиться. Она должна быть доступна в Azure. Если вы не знаете IP-адрес VPN-устройства, можно всегда указать значение заполнителя (при условии, что он имеет формат допустимого общедоступного IP-адреса) и изменить его в будущем.

   * **Адресное пространство клиента.** Укажите диапазон IP-адресов, которые нужно перенаправлять в локальную сеть через этот шлюз. Можно добавить несколько диапазонов пространства адресов. Убедитесь, что указанные диапазоны не перекрывают диапазоны других сетей, к которым подключена ваша виртуальная сеть, или диапазоны адресов самой виртуальной сети.
1. В нижней части страницы не выбирайте Просмотр и создание. Вместо этого нажмите кнопку **Далее: шлюз>**.

### <a name="to-configure-the-virtual-network-gateway"></a><a name="sku"></a>Настройка шлюза виртуальной сети

1. На странице **шлюз** выберите следующие значения:

   * **Размер:** Это SKU шлюза, который используется для создания шлюза виртуальной сети. Классические VPN-шлюзы используют старые (устаревшие версии) SKU. Дополнительные сведения об устаревших версиях SKU шлюза см. в статье [Работа со SKU шлюза виртуальной сети (старые версии SKU)](vpn-gateway-about-skus-legacy.md). Для этого упражнения можно выбрать " **стандартный** ".

   * **Тип маршрутизации:** Выберите тип маршрутизации для шлюза. Его также называют типом VPN. Важно выбрать правильный тип, так как вы не можете преобразовать шлюз из одного типа в другой. VPN-устройство должно быть совместимым с выбранным типом маршрутизации. Дополнительные сведения о типе маршрутизации см. в разделе [сведения о параметрах VPN-шлюза](vpn-gateway-about-vpn-gateway-settings.md#vpntype). В статье могут упоминаться такие типы VPN, как RouteBased и PolicyBased. RouteBased соответствует динамическому VPN-подключению, а PolicyBased — статическому. Как правило, требуется динамическая маршрутизация.

   * **Подсеть шлюза:** Размер указанной подсети шлюза зависит от конфигурации VPN-шлюза, которую необходимо создать. Несмотря на то, что можно создавать подсеть шлюза размером /29, мы рекомендуем использовать /27 или /28. При этом создается большая подсеть, которая включает в себя больше адресов. Использование более крупной подсети для шлюза позволяет создавать достаточное число IP-адресов с учетом возможных конфигураций в будущем.

1. В нижней части страницы щелкните **Просмотр и создание** , чтобы проверить параметры. Выберите **создать** для развертывания. Создание шлюза виртуальной сети может занять до 45 минут в зависимости от выбранного номера SKU шлюза.

## <a name="configure-your-vpn-device"></a><a name="vpndevice"></a>Настройка устройства VPN

Для подключения типа "сеть — сеть" к локальной сети требуется VPN-устройство. На этом этапе мы настроим VPN-устройство. Чтобы настроить локальное VPN-устройство, потребуются следующие значения:

* Общий ключ. Это тот же общий ключ, который указывается при создании VPN-подключения "сеть — сеть". В наших примерах мы используем простые общие ключи. Для практического использования рекомендуется создавать более сложные ключи.
* Общедоступный IP-адрес шлюза виртуальной сети. Общедоступный IP-адрес можно просмотреть с помощью портала Azure, PowerShell или CLI.

[!INCLUDE [vpn-gateway-configure-vpn-device-rm](../../includes/vpn-gateway-configure-vpn-device-rm-include.md)]

## <a name="retrieve-values"></a><a name="getvalues"></a>Получение значений

[!INCLUDE [retrieve values](../../includes/vpn-gateway-values-classic.md)]

## <a name="create-the-connection"></a><a name="CreateConnection"></a>Создание подключения

> [!NOTE]
> Для классической модели развертывания этот шаг недоступен в портал Azure или с помощью Azure Cloud Shell. На рабочем столе необходимо локально использовать версию управления службами (SM) командлетов Azure PowerShell.
>

На этом шаге, используя значения из предыдущих шагов, вы настроили общий ключ и создаете соединение. Установите ключ, использованный в конфигурации VPN-устройства.

1. Установите общий ключ и создайте подключение.

   * Измените значение параметра-VNetName и значение-LocalNetworkSiteName. Если указывается имя с пробелами, заключите его в одиночные кавычки.
   * "-SharedKey" — это значение, которое вы создаете, а затем укажите. В этом примере мы использовали "abc123", но вы можете (и должны) создать нечто более сложное. Важно, чтобы заданное здесь значение совпадало со значением, указанным при настройке вашего VPN-устройства.

   ```powershell
   Set-AzureVNetGatewayKey -VNetName 'Group TestRG1 TestVNet1' `
   -LocalNetworkSiteName '6C74F6E6_Site2' -SharedKey abc123
   ```

1. После создания подключения отобразится состояние **Успешно**.

## <a name="verify-your-connection"></a><a name="verify"></a>Проверка подключения

[!INCLUDE [vpn-gateway-verify-connection-azureportal-classic](../../includes/vpn-gateway-verify-connection-azureportal-classic-include.md)]

Если возникают проблемы с подключением, просмотрите раздел **Устранение неполадок**, выбрав его в оглавлении в левой области.

## <a name="how-to-reset-a-vpn-gateway"></a><a name="reset"></a>Как сбросить VPN-шлюз

Сброс настроек VPN-шлюза Azure полезен при потере распределенного VPN-подключения в одном или нескольких VPN-туннелях типа "сеть-сеть". В этой ситуации все локальные VPN-устройства работают правильно, но не могут взаимодействовать с VPN-шлюзами Azure через туннели IPsec. Пошаговые инструкции см. в статье [Сброс VPN-шлюза](./reset-gateway.md#resetclassic).

## <a name="how-to-change-a-gateway-sku"></a><a name="changesku"></a>Как изменить SKU шлюза

Инструкции по изменению номера SKU шлюза см. в статье изменение [размера SKU шлюза](vpn-gateway-about-SKUS-legacy.md#classicresize).

## <a name="next-steps"></a>Дальнейшие действия

* Установив подключение, можно добавить виртуальные машины в виртуальные сети. Дополнительные сведения о виртуальных машинах см. [здесь](../index.yml).
* Дополнительные сведения о принудительном туннелировании см. в статье [о принудительном туннелировании](vpn-gateway-about-forced-tunneling.md).