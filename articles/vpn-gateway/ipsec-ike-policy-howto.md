---
title: 'Политика IPsec/IKE для подключений типа "Виртуальная сеть — VPN" & "сеть — сеть": портал Azure'
titleSuffix: Azure VPN Gateway
description: Настройте политику IPsec/IKE для подключений типа S2S или VNet к виртуальной сети с помощью VPN-шлюзов Azure, используя Azure Resource Manager и портал Azure.
services: vpn-gateway
author: yushwang
ms.service: vpn-gateway
ms.topic: how-to
ms.date: 09/18/2020
ms.author: yushwang
ms.openlocfilehash: 2b298185866d16da02fe8d3b3fdb41f0b0b1f726
ms.sourcegitcommit: aaa65bd769eb2e234e42cfb07d7d459a2cc273ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/27/2021
ms.locfileid: "98878550"
---
# <a name="configure-ipsecike-policy-for-s2s-vpn-or-vnet-to-vnet-connections-azure-portal"></a>Настройка политики IPsec/IKE для подключений S2S VPN или VNet-to-VNet: портал Azure

В этой статье описано, как настроить политику IPsec/IKE для VPN-подключений типа "сеть — сеть" или "Виртуальная сеть — виртуальные сети" с помощью портал Azure. Следующие разделы содержат сведения о создании и настройке политики IPsec/IKE и применении политики к новому или существующему соединению.

## <a name="about-ipsec-and-ike-policy-parameters"></a><a name="about"></a>Параметры политики IPsec и IKE

Стандарт протоколов IPsec и IKE поддерживает широкий набор алгоритмов шифрования в различных сочетаниях. [Сведения о требованиях к шифрованию и VPN-шлюзах Azure](vpn-gateway-about-compliance-crypto.md) позволяют убедиться в том, что это может помочь обеспечить подключение между локальными и виртуальными сетями в соответствии с требованиями к соответствию или безопасности.

В этой статье приводятся инструкции по созданию и настройке политики IPsec/IKE и применению ее к новому или существующему подключению VPN-шлюза.

### <a name="considerations"></a>Рекомендации

* Политика IPsec/IKE работает только со следующими номерами SKU шлюза:
  * ***VpnGw1 ~ 5 и VpnGw1AZ ~ 5AZ** _ _ ***Standard** _ and _*_HighPerformance_*_ _. Вы можете указать только **одно** сочетание политики * 1 для данного соединения.
  _ Необходимо указать все алгоритмы и параметры для IKE (основной режим) и IPsec (быстрый режим). Указать частичную политику нельзя.
* Ознакомьтесь со спецификациями поставщиков VPN-устройств, чтобы убедиться, что политика поддерживается на локальных VPN-устройствах. Если политики несовместимы, невозможно будет установить VPN-подключения типа "сеть — сеть" или "виртуальная сеть — виртуальная сеть".

## <a name="workflow"></a><a name ="workflow"></a>Рабочий процесс

В этом разделе описывается рабочий процесс, необходимый для создания и обновления политики IPsec/IKE для VPN-подключений типа "сеть — сеть" или "виртуальная сеть — виртуальная сеть":

1. Создание виртуальной сети и VPN-шлюза.
2. Создайте локальный сетевой шлюз для подключения между локальными сетями или другую виртуальную сеть и шлюз для подключения между виртуальными сетями.
3. Создайте соединение (IPsec или VNet2VNet).
4. Настройте или обновите или удалите политику IPsec/IKE для ресурсов подключения.

Инструкции в этой статье помогут настроить и настроить политики IPsec/IKE, как показано на схеме.

:::image type="content" source="./media/ipsec-ike-policy-howto/policy-diagram.png" alt-text="Диаграмма политики IPsec/IKE" border="false":::

## <a name="supported-cryptographic-algorithms--key-strengths"></a><a name ="params"></a>Поддерживаемые алгоритмы шифрования & сильные стороны ключей

### <a name="algorithms-and-keys"></a><a name ="table1"></a>Алгоритмы и ключи

В таблице ниже перечислены поддерживаемые алгоритмы шифрования и уровни стойкости ключей, которые могут настроить клиенты.

| **IPsec/IKE**    | **Параметры**    |
| ---              | ---            |
| Шифрование IKE   | AES256, AES192, AES128, DES3, DES                  |
| Целостность IKE    | SHA384, SHA256, SHA1, MD5                          |
| Группа DH         | DHGroup24, ECP384, ECP256, DHGroup14, DHGroup2048, DHGroup2, DHGroup1, нет |
| Шифрование IPsec | GCMAES256, GCMAES192, GCMAES128, AES256, AES192, AES128, DES3, DES, нет    |
| Целостность IPsec  | GCMASE256, GCMAES192, GCMAES128, SHA256, SHA1, MD5 |
| Группа PFS        | PFS24, ECP384, ECP256, PFS2048, PFS2, PFS1, нет   |
| Время существования QM SA   | (**Необязательно**. Если не указано, используются значения по умолчанию)<br>Секунды (целое число, **минимум 300**, по умолчанию — 27 000 с)<br>Килобайты (целое число, **минимум 1024**, по умолчанию — 102 400 000 КБ)    |
| Селектор трафика | UsePolicyBasedTrafficSelectors** ($True/$False; **необязательно** — по умолчанию используется значение $False, если не задано другое значение.)    |
| Время ожидания DPD      | Секунды (целое число: min. 9/Max. 3600; по умолчанию 45 секунд) |
|  |  |

#### <a name="important-requirements"></a>Важные требования

* Ваша конфигурация локальных VPN-устройств должна совпадать со следующими алгоритмами и параметрами, указанными в политике Azure IPsec/IKE, или содержать их.
  * алгоритм шифрования IKE (основной режим или фаза 1);
  * алгоритм обеспечения целостности IKE (основной режим или фаза 1);
  * группа DH (основной режим или фаза 1);
  * алгоритм шифрования IKE (основной режим или фаза 2);
  * алгоритм обеспечения целостности IPsec (быстрый режим или фаза 2);
  * Группа PFS (быстрый режим/этап 2) > * выбор трафика (если используется UsePolicyBasedTrafficSelectors)
  * Время существования SA указывается исключительно в локальных спецификациях, эти значения не обязательно должны совпадать.

* Если GCMAES одинаковую используется для алгоритма шифрования IPsec, необходимо выбрать тот же алгоритм GCMAES одинаковую и длину ключа для целостности IPsec. Например, для обоих типов используется GCMAES128.

* В [таблице алгоритмы и ключи](#table1) выше:
  * IKE соответствует основному режиму или этапу 1
  * IPsec соответствует быстрому режиму или фазе 2;
  * группа DH определяет группу Диффи — Хеллмана, которая используется в основном режиме или фазе 1;
  * группа PFS определяет группу Диффи — Хеллмана, которая используется в быстром режиме или фазе 2.

* Время существования SA основного режима IKE в 28 800 секунд на VPN-шлюзах Azure.

* Если для **UsePolicyBasedTrafficSelectors** задано значение $true для подключения, он НАСТРОИТ VPN-шлюз Azure для подключения к БРАНДМАУЭРу VPN на основе политики в локальной среде. Если вы включили параметр PolicyBasedTrafficSelectors, необходимо обеспечить соответствующие селекторы трафика для VPN-устройства, которые определены с помощью всех комбинаций префиксов локальной сети (шлюза локальной сети) с префиксами виртуальной сети Azure, а не разрешать совпадение любого префикса с любым. Например, если префиксы локальной сети — 10.1.0.0/16 и 10.2.0.0/16, а префиксы виртуальной сети — 192.168.0.0/16 и 172.16.0.0/16, необходимо указать следующие селекторы трафика:
  * 10.1.0.0/16 <====> 192.168.0.0/16;
  * 10.1.0.0/16 <====> 172.16.0.0/16;
  * 10.2.0.0/16 <====> 192.168.0.0/16;
  * 10.2.0.0/16 <====> 172.16.0.0/16.

   Дополнительные сведения о селекторах трафика на основе политик см. в статье [Подключение VPN-шлюзов Azure к нескольким локальным VPN-устройствам на основе политики с помощью PowerShell](vpn-gateway-connect-multiple-policybased-rm-ps.md).

* DPD timeout — значение по умолчанию — 45 секунд на VPN-шлюзах Azure. Установка более короткого времени ожидания приведет к более агрессивному выполнению ключей IKE, что приведет к разрыву соединения в некоторых экземплярах. Это может оказаться нежелательным, если ваши локальные расположения находятся далеко от региона Azure, где находится шлюз VPN, или если условие физической связи может вызвать потери пакетов. Общая рекомендация заключается в установке времени ожидания в диапазоне от **30 до 45** секунд.

### <a name="diffie-hellman-groups"></a>Группы Диффи-Хеллмана

В следующей таблице перечислены соответствующие группы Диффи — Хеллмана, поддерживаемые пользовательскими политиками.

| **Группа Диффи-Хелмана**  | **DHGroup**              | **PFSGroup** | **Длина ключа** |
| --- | --- | --- | --- |
| 1                         | DHGroup1                 | PFS1         | MODP (768 бит)   |
| 2                         | DHGroup2                 | PFS2         | MODP (1024 бит)  |
| 14                        | DHGroup14<br>DHGroup2048 | PFS2048      | MODP (2048 бит)  |
| 19                        | ECP256                   | ECP256       | ECP (256 бит)    |
| 20                        | ECP384                   | ECP384       | ECP (384 бит)    |
| 24                        | DHGroup24                | PFS24        | MODP (2048 бит)  |

Дополнительные сведения см. в статье о группе [RFC3526](https://tools.ietf.org/html/rfc3526) и [RFC5114](https://tools.ietf.org/html/rfc5114).

## <a name="s2s-vpn-with-ipsecike-policy"></a><a name ="S2S"></a>Сеть S2S VPN с политикой IPsec/IKE

В этом разделе описано, как создать VPN-подключение типа "сеть — сеть" с помощью политики IPsec/IKE. Следующие шаги создают подключение, как показано на следующей схеме.

:::image type="content" source="./media/ipsec-ike-policy-howto/site-to-site-diagram.png" alt-text="Политика &quot;сеть — сеть&quot;" border="false":::

### <a name="step-1---create-the-virtual-network-vpn-gateway-and-local-network-gateway"></a><a name="createvnet1"></a>Шаг 1. Создание виртуальной сети, VPN-шлюза и шлюза локальной сети

Создайте следующие ресурсы, как показано на снимках экрана ниже. Инструкции см. [в разделе Создание VPN-подключения типа "сеть — сеть](./tutorial-site-to-site-portal.md)".

* **Виртуальная сеть:**  TestVNet1

   :::image type="content" source="./media/ipsec-ike-policy-howto/testvnet-1.png" alt-text="Региональной":::

* **VPN-шлюз:** VNet1GW

   :::image type="content" source="./media/ipsec-ike-policy-howto/vnet-1-gateway.png" alt-text="Шлюз":::

* **Шлюз локальной сети:** Site6

   :::image type="content" source="./media/ipsec-ike-policy-howto/lng-site-6.png" alt-text="Сайт":::

* **Подключение:** VNet1 Site6

    :::image type="content" source="./media/ipsec-ike-policy-howto/connection-site-6.png" alt-text="Соединение":::

### <a name="step-2---configure-ipsecike-policy-on-the-s2s-vpn-connection"></a><a name="s2sconnection"></a>Шаг 2. Настройка политики IPsec/IKE для VPN-подключения S2S

В этом разделе вы настроите политику IPsec/IKE со следующими алгоритмами и параметрами:

* IKE: AES256, SHA384, DHGroup24, DPD timeout 45 с
* IPsec: AES256, SHA256, PFS нет, жизненный цикл SA 30000 сек и 102400000KB

1. Перейдите к ресурсу подключения **VNet1toSite6** в портал Azure. Выберите страницу **Конфигурация** и выберите **Настраиваемая** политика IPSec/IKE, чтобы отобразить все параметры конфигурации. На следующем снимке экрана показана конфигурация в соответствии со списком:

    :::image type="content" source="./media/ipsec-ike-policy-howto/policy-site-6.png" alt-text="Сайт 6":::

1. Если для IPsec используется алгоритм GCMAES, необходимо указать одинаковую длину ключа и алгоритма для шифрования и целостности данных IPsec. Например, на следующем снимке экрана указывается GCMAES128 для шифрования IPsec и IPsec.

   :::image type="content" source="./media/ipsec-ike-policy-howto/gcmaes.png" alt-text="GCMAES одинаковую для IPsec":::

1. При необходимости можно выбрать **включить** для параметра **использовать селекторы трафика на основе политики** , чтобы разрешить VPN-шлюзу Azure ПОДключаться к VPN-устройствам на основе политик локально, как описано выше.

   :::image type="content" source="./media/ipsec-ike-policy-howto/policy-based-selector.png" alt-text="Селектор трафика на основе политики":::

1. После выбора всех параметров нажмите кнопку **сохранить** , чтобы зафиксировать изменения в ресурсе подключения. Политика будет применена примерно через минуту.

> [!IMPORTANT]
>
> * После указания для подключения политики IPsec/IKE VPN-шлюз Azure будет только отправлять и принимать предложения IPsec/IKE с определенными алгоритмами шифрования и уровнями стойкости ключей для этого подключения. Локальное VPN-устройство для подключения должно использовать или принимать точную комбинацию политик. Иначе VPN-туннель типа "сеть — сеть" не будет установлен.
>
> * Параметры **выбора трафика на основе политики** и **время ожидания DPD** можно указать с помощью политики **по умолчанию** без настраиваемой политики IPSec/IKE, как показано на снимке экрана выше.
>

## <a name="vnet-to-vnet-with-ipsecike-policy"></a><a name ="vnet2vnet"></a>Репликация между виртуальными сетями с помощью политики IPsec/IKE

Шаги по созданию подключения между виртуальными сетями с политикой IPsec/IKE аналогичны действиям VPN-подключения S2S.

:::image type="content" source="./media/ipsec-ike-policy-howto/vnet-policy.png" alt-text="Схема политики &quot;Виртуальная сеть — виртуальная сети&quot;" border="false":::

1. Чтобы создать подключение между виртуальными сетями, выполните действия, описанные в статье Создание подключения " [Виртуальная](vpn-gateway-vnet-vnet-rm-ps.md) сеть — виртуальная сеть".

2. После выполнения этих действий вы увидите два подключения между виртуальными сетями, как показано на снимке экрана ниже ресурса VNet2GW:

   :::image type="content" source="./media/ipsec-ike-policy-howto/vnet-vnet-connections.png" alt-text="Подключения &quot;виртуальная сеть — виртуальная сеть&quot;":::

3. Перейдите к ресурсу подключения и перейдите на страницу **конфигурации** на портале. Выберите **Пользовательская** в **политике IPSec/IKE** , чтобы отобразить параметры настраиваемой политики. Выберите алгоритмы шифрования с соответствующей длиной ключей.

   На снимке экрана показана другая политика IPsec/IKE со следующими алгоритмами и параметрами:
   * IKE: AES128, SHA1, DHGroup14, DPD timeout 45 с
   * IPsec: GCMAES128, GCMAES128, PFS14, срок действия SA (14 400 секунд и 102 400 000 КБ).

   :::image type="content" source="./media/ipsec-ike-policy-howto/vnet-vnet-policy.png" alt-text="Политика подключения":::

4. Нажмите кнопку **сохранить** , чтобы применить изменения политики к ресурсу подключения.

5. Примените ту же политику к другому ресурсу подключения VNet2toVNet1. В противном случае VPN-туннель IPsec/IKE не будет подключаться из-за несоответствия политики.

   > [!IMPORTANT]
   > После указания для подключения политики IPsec/IKE VPN-шлюз Azure будет только отправлять и принимать предложения IPsec/IKE с определенными алгоритмами шифрования и уровнями стойкости ключей для этого подключения. Политики IPsec для обоих подключений должны быть одинаковыми, иначе подключение типа "виртуальная сеть — виртуальная сеть" не будет установлено.

6. После выполнения этих действий подключение будет установлено через несколько минут, и вы получите следующую топологию сети:

    :::image type="content" source="./media/ipsec-ike-policy-howto/policy-diagram.png" alt-text="Диаграмма политики IPsec/IKE" border="false":::

## <a name="to-remove-custom-ipsecike-policy-from-a-connection"></a><a name ="deletepolicy"></a>Удаление настраиваемой политики IPsec/IKE из подключения

1. Чтобы удалить настраиваемую политику из подключения, перейдите к ресурсу подключения и перейдите на страницу **Конфигурация** , чтобы просмотреть текущую политику.

2. Выберите **значение по умолчанию** в параметре **политика IPSec/IKE** . Это приведет к удалению всех пользовательских политик, ранее указанных в подключении, и восстановлению параметров IPsec/IKE по умолчанию для этого подключения:

   :::image type="content" source="./media/ipsec-ike-policy-howto/delete-policy.png" alt-text="Удаление политики":::

3. Нажмите кнопку **сохранить** , чтобы удалить настраиваемую политику и восстановить параметры IPsec/IKE по умолчанию для подключения.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о селекторах трафика на основе политик см. в статье [Подключение VPN-шлюзов Azure к нескольким локальным VPN-устройствам на основе политики с помощью PowerShell](vpn-gateway-connect-multiple-policybased-rm-ps.md).