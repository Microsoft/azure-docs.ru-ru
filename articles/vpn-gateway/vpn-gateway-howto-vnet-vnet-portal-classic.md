---
title: 'Создайте подключение между виртуальных сетей: классическая: портал Azure'
description: Подключение виртуальных сетей Azure между собой с помощью PowerShell и портала Azure.
services: vpn-gateway
titleSuffix: Azure VPN Gateway
author: cherylmc
ms.service: vpn-gateway
ms.topic: how-to
ms.date: 10/15/2020
ms.author: cherylmc
ms.openlocfilehash: 0d81e0474d898ffee7f128c0bcea61f077c3d758
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "92103226"
---
# <a name="configure-a-vnet-to-vnet-connection-classic"></a>Настройка подключения между виртуальными сетями (классическая модель)

В этой статье описывается, как создать подключение VPN-шлюза между виртуальными сетями. Виртуальные сети могут относиться к одному или разным регионам и к одной или разным подпискам.

:::image type="content" source="./media/vpn-gateway-howto-vnet-vnet-portal-classic/v2vclassic.png" alt-text="Схема, показывающая классическую архитектуру виртуальной сети в виртуальную сеть":::

[!INCLUDE [deployment models](../../includes/vpn-gateway-classic-deployment-model-include.md)]

Приведенные в этой статье инструкции относятся к классической модели развертывания и порталу Azure. Эту конфигурацию также можно создать с помощью разных средств или моделей развертывания, выбрав вариант из следующего списка:

> [!div class="op_single_selector"]
> * [Классический](vpn-gateway-howto-vnet-vnet-portal-classic.md)
> * [Resource Manager](vpn-gateway-howto-vnet-vnet-resource-manager-portal.md)
> * [Подключение виртуальных сетей в разных моделях развертывания](vpn-gateway-connect-different-deployment-models-portal.md)
>
>

## <a name="about-vnet-to-vnet-connections"></a>О подключениях "виртуальная сеть — виртуальная сеть"

Подключение типа "виртуальная сеть — виртуальная сеть" в классической модели развертывания через VPN-шлюз похоже на подключение виртуальной сети к локальному сайту. В обоих типах подключений используется VPN-шлюз для создания защищенного туннеля, использующего IPsec/IKE.

Подключаемые виртуальные сети могут иметь разные подписки в разных регионах. Можно комбинировать подключение "виртуальная сеть — виртуальная сеть" с многосайтовыми конфигурациями. Это позволяет настраивать топологии сети, совмещающие распределенные подключения с подключениями между виртуальными сетями.

:::image type="content" source="./media/vpn-gateway-howto-vnet-vnet-portal-classic/aboutconnections.png" alt-text="Схема, показывающая подключения":::

### <a name="why-connect-virtual-networks"></a><a name="why"></a>Что может дать связь между виртуальными сетями

Вам может потребоваться подключить виртуальные сети по следующим причинам.

* **Межрегиональная географическая избыточность и географическое присутствие**

  * Вы можете настроить собственную георепликацию или синхронизацию с безопасной связью без прохождения трафика через конечные точки с выходом в Интернет.
  * С помощью Azure Load Balancer и технологий кластеризации корпорации Майкрософт или сторонних производителей можно настроить высокодоступную рабочую нагрузку с геоизбыточностью в нескольких регионах Azure. Одним из важных примеров является настройка SQL Always On с группами доступности, распределенными между несколькими регионами Azure.
* **Региональные многоуровневые приложения с четкой границей изоляции**

  * В одном регионе можно настроить многоуровневые приложения с использованием нескольких связанных друг с другом виртуальных сетей с сильной изоляцией и защищенной связью между уровнями.
* **Обмен данными между подписками и организациями в Azure**

  * Если у вас есть несколько подписок Azure, то вы можете безопасно связывать рабочие нагрузки из разных подписок между виртуальными сетями.
  * Благодаря технологии защищенных сетей VPN в Azure для предприятий или поставщиков услуг возможен обмен данными между организациями.

См. дополнительные сведения в разделе с [часто задаваемыми вопросами о подключениях типа "виртуальная сеть — виртуальная сеть"](#faq) в конце этой статьи.

## <a name="prerequisites"></a>Предварительные условия

Мы используем портал для большинства операций, но для создания подключений между виртуальными сетями нужно использовать PowerShell. Вы не можете создать подключения с помощью портал Azure, так как не существует способа указать общий ключ на портале. [!INCLUDE [vpn-gateway-classic-powershell](../../includes/vpn-gateway-powershell-classic-locally.md)]

## <a name="planning"></a><a name="planning"></a>Планирование

Важно определить диапазоны адресов, которые будут использоваться при настройке виртуальных сетей. При настройке необходимо убедиться в том, что никакие из диапазонов виртуальных сетей или диапазонов локальных сетей, к которым они подключены, никак не перекрываются между собой.

### <a name="vnets"></a><a name="vnet"></a>Виртуальных сетей

В этом упражнении мы используем следующие примеры значений:

**Значения для TestVNet1**

Имя: TestVNet1<br>
Адресное пространство: 10.11.0.0/16, 10.12.0.0/16 (необязательно)<br>
Имя подсети: по умолчанию<br>
Диапазон адресов подсети: 10.11.0.0/24.<br>
Группа ресурсов: ClassicRG<br>
Расположение: восточная часть США<br>
Подсеть шлюза: 10.11.1.0/27

**Значения для TestVNet4**

Имя: TestVNet4<br>
Адресное пространство: 10.41.0.0/16, 10.42.0.0/16 (необязательно)<br>
Имя подсети: по умолчанию<br>
Диапазон адресов подсети: 10.41.0.0/24.<br>
Группа ресурсов: ClassicRG<br>
Расположение: западная часть США<br>
Подсеть шлюза: 10.41.1.0/27

### <a name="connections"></a><a name="plan"></a>Соединение

В следующей таблице приведен пример того, как можно подключить виртуальных сетей. Используйте указанные диапазоны только в качестве примера. Запишите диапазоны для своих виртуальных сетей. Эти сведения будут необходимы для выполнения последующих действий.

В этом примере TestVNet1 подключается к сайту локальной сети, созданному с именем "VNet4Local". Параметры VNet4Local содержат префиксы адресов TestVNet4.
Локальным сайтом каждой виртуальной сети является другая виртуальная сеть. Для этой конфигурации используются следующие примеры значений:

**Пример**

| Виртуальная сеть | Адресное пространство | Расположение | Подключается к сайту локальной сети |
|:--- |:--- |:--- |:--- |
| TestVNet1 |TestVNet1<br>(10.11.0.0/16)<br>(10.12.0.0/16) |Восточная часть США |SiteVNet4<br>(10.41.0.0/16)<br>(10.42.0.0/16) |
| TestVNet4 |TestVNet4<br>(10.41.0.0/16)<br>(10.42.0.0/16) |Западная часть США |SiteVNet1<br>(10.11.0.0/16)<br>(10.12.0.0/16) |

## <a name="create-virtual-networks"></a><a name="vnetvalues"></a>Создание виртуальных сетей

На этом шаге вы создадите две классические виртуальные сети, TestVNet1 и TestVNet4. Если вы используете эту статью в качестве упражнения, используйте [примеры значений](#vnet).

**При создании виртуальных сетей необходимо учитывать следующие параметры:**

* **Адресное пространство виртуальной сети.** На странице "Адресное пространство виртуальной сети" укажите диапазон адресов, который вы хотите использовать для виртуальной сети. Это динамические IP-адреса, которые будут назначаться виртуальным машинам и другим экземплярам ролей, развертываемым в этой виртуальной сети.<br>Выбранные адресные пространства не должны пересекаться с адресными пространствами других виртуальных сетей или локальных расположений, к которым будет подключена виртуальная сеть.

* **Расположение** — при создании виртуальной сети эта сеть связывается с регионом (расположением) Azure. Например, если вы хотите, чтобы ваши виртуальные машины разворачивались в виртуальной сети, которая физически расположена в западной части США, выберите это расположение. Нельзя изменить расположение, связанное с виртуальной сетью, после ее создания.

**После создания виртуальных сетей можно добавить следующие параметры:**

* **Адресное пространство.** Дополнительное адресное пространство не является обязательным для этой конфигурации, но его можно добавить после создания виртуальной сети.

* **Подсети.** Дополнительные подсети не требуются для этой конфигурации, но вам может понадобиться разместить виртуальные машины в подсети отдельно от других экземпляров ролей.

* **DNS-серверы.** Введите имя и IP-адрес DNS-сервера. Этот параметр не приводит к созданию DNS-сервера. Он позволяет указать DNS-сервер, который вы хотите использовать для разрешения имен в этой виртуальной сети.

### <a name="to-create-a-classic-virtual-network"></a>Создание классической виртуальной сети

[!INCLUDE [basic classic vnet](../../includes/vpn-gateway-vnet-classic.md)]

[!INCLUDE [basic classic DNS](../../includes/vpn-gateway-dns-classic.md)]

## <a name="configure-sites-and-gateways"></a><a name="localsite"></a>Настройка сайтов и шлюзов

С помощью параметров, заданных в каждом сайте локальной сети, Azure определяет способ маршрутизации трафика между виртуальными сетями. Каждая виртуальная сеть должна указывать на соответствующую локальную сеть, в которую будет выполняться маршрутизация трафика. Укажите имена, которые будут использоваться для ссылки на каждый из сайтов локальной сети. Лучше всего использовать описательные имена.

Например, сеть TestVNet1 подключается к созданному вами сайту локальной сети с именем VNet4Local. Параметры VNet4Local содержат префиксы адресов TestVNet4.

Помните, что локальный сайт для каждой виртуальной сети — это другая виртуальная сеть.

| Виртуальная сеть | Адресное пространство | Расположение | Подключается к сайту локальной сети |
|:--- |:--- |:--- |:--- |
| TestVNet1 |TestVNet1<br>(10.11.0.0/16)<br>(10.12.0.0/16) |Восточная часть США |SiteVNet4<br>(10.41.0.0/16)<br>(10.42.0.0/16) |
| TestVNet4 |TestVNet4<br>(10.41.0.0/16)<br>(10.42.0.0/16) |Западная часть США |SiteVNet1<br>(10.11.0.0/16)<br>(10.12.0.0/16) |

### <a name="to-configure-a-site"></a><a name="site"></a>Настройка сайта

Термин "локальный сайт" обычно означает локальное расположение. Он содержит IP-адрес VPN-устройства, для которого будет создано подключение, и диапазоны IP-адресов, которые будут использоваться для передачи трафика через VPN-шлюз к VPN-устройству.

1. На странице виртуальной сети в разделе **Параметры** выберите **подключения "сеть — сеть**".
1. На странице подключения "сеть — сеть" выберите **+ Добавить**.
1. На странице **Настройка VPN-подключения и шлюза** для **типа подключения** оставьте выбранным " **сеть — сеть** ".

   * **IP-адрес VPN-шлюза.** Это общедоступный IP-адрес VPN-устройства для локальной сети. В этом упражнении можно добавить фиктивный адрес, так как у вас еще нет IP-адреса VPN-шлюза для другого сайта. Например, 5.4.3.2. Позже, после настройки шлюза для другой виртуальной сети, можно изменить это значение.

   * **Адресное пространство клиента:** Перечислите диапазоны IP-адресов, которые вы хотите перенаправить в другую виртуальную сеть через этот шлюз. Можно добавить несколько диапазонов пространства адресов. Убедитесь, что указанные диапазоны не перекрывают диапазоны других сетей, к которым подключена ваша виртуальная сеть, или диапазоны адресов самой виртуальной сети.
1. В нижней части страницы не выбирайте Просмотр и создание. Вместо этого нажмите кнопку **Далее: шлюз>**.

### <a name="to-configure-a-virtual-network-gateway"></a><a name="sku"></a>Настройка шлюза виртуальной сети

1. На странице **шлюз** выберите следующие значения:

   * **Размер:** Это SKU шлюза, который используется для создания шлюза виртуальной сети. Классические VPN-шлюзы используют старые (устаревшие версии) SKU. Дополнительные сведения об устаревших версиях SKU шлюза см. в статье [Работа со SKU шлюза виртуальной сети (старые версии SKU)](vpn-gateway-about-skus-legacy.md). Для этого упражнения можно выбрать " **стандартный** ".

   * **Тип маршрутизации:** Выберите тип маршрутизации для шлюза. Его также называют типом VPN. Важно выбрать правильный тип, так как вы не можете преобразовать шлюз из одного типа в другой. VPN-устройство должно быть совместимым с выбранным типом маршрутизации. Дополнительные сведения о типе маршрутизации см. в разделе [сведения о параметрах VPN-шлюза](vpn-gateway-about-vpn-gateway-settings.md#vpntype). В статье могут упоминаться такие типы VPN, как RouteBased и PolicyBased. RouteBased соответствует динамическому VPN-подключению, а PolicyBased — статическому. Для этой конфигурации выберите **динамический**.

   * **Подсеть шлюза:** Размер указанной подсети шлюза зависит от конфигурации VPN-шлюза, которую необходимо создать. Несмотря на то, что можно создавать подсеть шлюза размером /29, мы рекомендуем использовать /27 или /28. При этом создается большая подсеть, которая включает в себя больше адресов. Использование более крупной подсети для шлюза позволяет создавать достаточное число IP-адресов с учетом возможных конфигураций в будущем.

1. В нижней части страницы щелкните **Просмотр и создание** , чтобы проверить параметры. Выберите **создать** для развертывания. Создание шлюза виртуальной сети может занять до 45 минут в зависимости от выбранного номера SKU шлюза.
1. Во время создания этого шлюза можно перейти к следующему шагу.

### <a name="configure-testvnet4-settings"></a>Настройка параметров TestVNet4

Повторите шаги по [созданию сайта и шлюза](#localsite) для настройки TestVNet4, заменив значения при необходимости. Если вы делаете это как упражнение, используйте [примеры значений](#planning).

## <a name="update-local-sites"></a><a name="updatelocal"></a>Обновление локальных сайтов

После создания шлюзов виртуальной сети для обоих виртуальных сетей необходимо настроить свойства локального сайта для **IP-адреса шлюза VPN**.

|Имя виртуальной сети|Подключенный сайт|IP-адрес шлюза|
|:--- |:--- |:--- |
|TestVNet1|VNet4Local|IP-адрес VPN-шлюза для TestVNet4|
|TestVNet4|VNet1Local|IP-адрес VPN-шлюза для TestVNet1|

### <a name="part-1---get-the-virtual-network-gateway-public-ip-address"></a>Часть 1. Получение общедоступного IP-адреса шлюза виртуальной сети

1. Перейдите к виртуальной сети, перейдя в **группу ресурсов** и выбрав виртуальную сеть.
1. На странице виртуальной сети на панели " **основные компоненты** " справа выберите **IP-адрес шлюза** и скопируйте его в буфер обмена.

### <a name="part-2---modify-the-local-site-properties"></a>Часть 2. изменение свойств локального сайта

1. В разделе подключения "сеть — сеть" выберите подключение. Например, SiteVNet4.
1. На странице **Свойства** подключения "сеть — сеть" выберите **изменить локальный сайт**.
1. В поле **IP-адрес шлюза VPN** вставьте IP-адрес VPN-шлюза, скопированный в предыдущем разделе.
1. Щелкните **ОК**.
1. Поле обновляется в системе. Этот метод также можно использовать для добавления дополнительного IP-адреса, который нужно направить на этот сайт.

### <a name="part-3---repeat-steps-for-the-other-vnet"></a>Часть 3. Повторение шагов для другой виртуальной сети

Повторите шаги для TestVNet4.

## <a name="retrieve-configuration-values"></a><a name="getvalues"></a>Получение значений конфигурации

[!INCLUDE [retrieve values](../../includes/vpn-gateway-values-classic.md)]

## <a name="create-connections"></a><a name="createconnections"></a>Создание подключений

После завершения всех предыдущих шагов можно задать общие ключи IPsec/IKE и создать подключение. Для этого набора действий используется только PowerShell. Невозможно настроить подключения между виртуальными сетями для классической модели развертывания в портал Azure, так как общий ключ не может быть указан на портале.

Обратите внимание, что в приведенных ниже примерах общий ключ совпадает. Общий ключ всегда должен совпадать. Обязательно замените значения в этих примерах на точные имена для виртуальных сетей и сайтов локальной сети.

1. Создайте подключение между TestVNet1 и TestVNet4. Не забудьте изменить значения.

   ```powershell
   Set-AzureVNetGatewayKey -VNetName 'Group ClassicRG TestVNet1' `
   -LocalNetworkSiteName 'value for _VNet4Local' -SharedKey A1b2C3D4
   ```
2. Создайте подключение между TestVNet4 и TestVNet1.

   ```powershell
   Set-AzureVNetGatewayKey -VNetName 'Group ClassicRG TestVNet4' `
   -LocalNetworkSiteName 'value for _VNet1Local' -SharedKey A1b2C3D4
   ```
3. Ожидание подключений для инициализации. После инициализации шлюза для состояния будет установлено значение "Успешно".

   ```
   Error          :
   HttpStatusCode : OK
   Id             :
   Status         : Successful
   RequestId      :
   StatusCode     : OK
   ```

## <a name="faq-and-considerations"></a><a name="faq"></a>Вопросы и ответы по

Эти рекомендации относятся к классическим виртуальным сетям и классическим шлюзам виртуальной сети.

* Виртуальные сети могут быть в одной или разных подписках.
* Виртуальные сети могут быть в одном или разных регионах (расположениях) Azure.
* Облачная служба или конечная точка балансировки нагрузки не может охватывать виртуальные сети, даже если они соединены друг с другом.
* Для подключения нескольких виртуальных сетей друг к другу не требуются VPN-устройства.
* Подключения между виртуальными сетями поддерживает подключение виртуальных сетей Azure. Не поддерживается подключение виртуальных машин или облачных служб, не развернутых в виртуальной сети.
* Для подключения "виртуальная сеть — виртуальная сеть" требуются шлюзы с динамической маршрутизацией. Шлюзы Azure со статической маршрутизацией не поддерживаются.
* Подключение к виртуальной сети можно использовать одновременно с многосайтовыми VPN-подключениями. Можно использовать до 10 туннелей VPN для подключения VPN-шлюза виртуальной сети к другим виртуальным сетям или локальным сайтам.
* Адресные пространства виртуальных сетей и местных сайтов локальных сетей не должны перекрываться. Перекрытие адресных пространств приведет к сбою при создании виртуальных сетей или отправке файлов конфигурации netcfg.
* Избыточные туннели между парой виртуальных сетей не поддерживаются.
* Все туннели VPN виртуальной сети, включая VPN-подключения типа "точка — сеть", совместно используют доступную пропускную способность VPN-шлюза Azure и регулируются одним соглашением об уровне обслуживания, определяющим время работы VPN-шлюзов в Azure.
* Трафик между виртуальными сетями проходит через магистральную сеть Azure.

## <a name="next-steps"></a>Дальнейшие действия

Проверьте подключения. Дополнительные сведения см. в статье [Проверка подключения VPN-шлюза](vpn-gateway-verify-connection-resource-manager.md).
