---
title: Подключение классических виртуальных сетей к виртуальным сетям Resource Manager с помощью портала | Документация Майкрософт
description: Инструкции по созданию подключения между классическими виртуальными сетями и виртуальными сетями Resource Manager с помощью VPN-шлюза и портала
services: vpn-gateway
author: cherylmc
ms.service: vpn-gateway
ms.topic: how-to
ms.date: 02/10/2021
ms.author: cherylmc
ms.openlocfilehash: 9d31bcaad01b9b762e57bd619d45c1f53ffb201e
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "100376808"
---
# <a name="connect-virtual-networks-from-different-deployment-models-using-the-portal"></a>Подключение виртуальных сетей из разных моделей развертывания с помощью портала

Эта статья описывает, как подключить классические виртуальные сети к виртуальным сетям Resource Manager, чтобы ресурсы, находящиеся в разных моделях развертывания, могли взаимодействовать между собой. В описанных здесь действиях в основном используется портал Azure, однако эту конфигурацию можно создать и с помощью PowerShell, выбрав соответствующую статью в списке.

> [!div class="op_single_selector"]
> * [Портал](vpn-gateway-connect-different-deployment-models-portal.md)
> * [PowerShell](vpn-gateway-connect-different-deployment-models-powershell.md)
> 
> 

Подключение к классической виртуальной сети к виртуальной сети Resource Manager похоже на подключение виртуальной сети к локальному сайту. В обоих типах подключений используется VPN-шлюз для создания защищенного туннеля, использующего IPsec/IKE. Подключение можно создать между виртуальными сетями, которые находятся в разных подписках и разных регионах. Вы также можете создать подключение между виртуальными сетями, которые уже подключены к локальным сетям. В этом случае для них должен быть настроен динамический шлюз или шлюз на основе маршрутов. Дополнительные сведения о подключениях типа "виртуальная сеть — виртуальная сеть" см. в разделе [Часто задаваемые вопросы о подключениях типа "виртуальная сеть — виртуальная сеть"](#faq) в конце этой статьи. 

Если у вас нет шлюза виртуальной сети и вы не хотите его создавать, то вместо этого можно подключить виртуальные сети с помощью пиринга виртуальных сетей. При пиринговой связи между виртуальными сетями VPN-шлюз не используется. Дополнительную информацию см. в статье [Пиринговая связь между виртуальными сетями](../virtual-network/virtual-network-peering-overview.md).

### <a name="before-you-begin"></a><a name="before"></a>Подготовка к работе



* Предполагается, что обе виртуальные сети уже созданы. Если вы используете эту статью в качестве упражнения и у вас нет виртуальных сетей, в шагах есть ссылки, которые помогут вам их создать.
* Убедитесь, что диапазоны адресов для виртуальных сетей не перекрываются между собой или с другими диапазонами подключений, к которым могут быть подключены шлюзы.
* Установите последнюю версию командлетов PowerShell для Resource Manager и управления службами (классическая модель). В этой статье мы используем как портал Azure, так и PowerShell. Для создания подключения от классической виртуальной сети к виртуальной сети Resource Manager требуется PowerShell. Подробнее: [Установка и настройка Azure PowerShell](/powershell/azure/). 

### <a name="example-settings"></a><a name="values"></a>Примеры параметров

Эти значения можно использовать для создания тестовой среды или для лучшего понимания примеров в этой статье.

**Классическая виртуальная сеть**

Имя виртуальной сети = ClassicVNet <br>
Адресное пространство: 10.0.0.0/24. <br>
Имя подсети: Subnet-1. <br>
Диапазон адресов подсети: 10.0.0.0/27. <br>
Подписка: подписка, которая будет использоваться. <br>
Группа ресурсов: RG1. <br>
Расположение: Западная часть США <br>
Подсеть шлюза: 10.0.0.32/28. <br>
Локальный сайт: RMVNetLocal. <br>

**Виртуальная сеть Resource Manager**

Имя виртуальной сети = RMVNet <br>
Адресное пространство: 192.168.0.0/16. <br>
Группа ресурсов = RG1 <br>
Расположение = восточная часть США <br>
Имя подсети: Subnet-1. <br>
Диапазон адресов: 192.168.1.0/24. <br>
Шлюз подсети = 192.168.0.0/26 <br>
Имя шлюза виртуальной сети = RMGateway <br>
Тип шлюза: VPN <br>
Тип VPN: на основе маршрутов <br>
Номер SKU: VpnGw1. <br>
Расположение = восточная часть США <br>
Тип виртуальной сети: RMVNet. <br> (Связывает VPN-шлюз с этой виртуальной сетью.) Первая IP-конфигурация: rmgwpip. <br> (Общедоступный IP-адрес шлюза.) Шлюз локальной сети: ClassicVNetLocal. <br>
Имя подключения = RMtoClassic

### <a name="connection-overview"></a><a name="connectoverview"></a>Общие сведения о подключении

Для этой конфигурации вы создадите подключение к VPN-шлюзу через VPN-туннель IPsec/IKE между виртуальными сетями. При настройке необходимо убедиться в том, что никакие из диапазонов виртуальных сетей или диапазонов локальных сетей, к которым они подключены, никак не перекрываются между собой.

В таблице ниже показан пример, как определяются виртуальные сети и локальные веб-сайты.

| Виртуальная сеть | Адресное пространство | Регион | Подключается к сайту локальной сети |
|:--- |:--- |:--- |:--- |
| ClassicVNet |(10.0.0.0/24) |Западная часть США | RMVNetLocal (192.168.0.0/16) |
| RMVNet | (192.168.0.0/16) |Восточная часть США |ClassicVNetLocal (10.0.0.0/24) |

## <a name="section-1---configure-the-classic-vnet-settings"></a><a name="classicvnet"></a>Раздел 1. Настройка классической виртуальной сети

В этом разделе вы создадите классическую виртуальную сеть, локальную сеть (локальный сайт) и шлюз виртуальной сети. Снимки экрана приведены в качестве примеров. Обязательно подставьте собственные значения или воспользуйтесь значениями из [примера](#values).

### <a name="1-create-a-classic-vnet"></a>1. <a name="classicvnet"></a> Создание классической виртуальной сети

Если у вас нет классической виртуальной сети и вы выполняете действия из этой статьи в качестве упражнения, вы можете создать виртуальную сеть с помощью [этой статьи](/previous-versions/azure/virtual-network/virtual-networks-create-vnet-classic-pportal), используя [примеры](#values) значений параметров выше.

Если у вас уже есть виртуальная сеть с VPN-шлюзом, убедитесь, что шлюз динамический. Если он является статическим, необходимо сначала удалить VPN-шлюз, прежде чем перейти к [настройке локального сайта](#local).

1. Откройте [портал Azure](https://ms.portal.azure.com) и войдите в систему, используя свою учетную запись Azure.
2. Щелкните **+Создать ресурс**, чтобы открыть страницу "Создание".
3. В поле "Поиск по Marketplace" введите запрос "Виртуальная сеть". Если вместо этого вы выберете "Сети" -> "Виртуальная сеть", команда создания классической виртуальной сети не отобразится.
4. Найдите в результатах поиска запись "Виртуальная сеть" и щелкните ее. Откроется страница "Виртуальная сеть". 
5. На странице виртуальной сети выберите "Классическая", чтобы создать классическую виртуальную сеть. Если использовать значения по умолчанию, то вы получите виртуальную сеть Resource Manager.

### <a name="2-configure-the-local-site"></a>2. <a name="local"></a> Настройка локального сайта

1. Перейдите к колонке **Все ресурсы** и найдите **ClassicVNet** в списке.
2. Щелкните **шлюз** в разделе **Параметры** меню, а затем щелкните баннер, чтобы создать шлюз.
  ![Настройка VPN-шлюза](./media/vpn-gateway-connect-different-deployment-models-portal/gatewaygraphic.png "Настройка VPN-шлюза")
3. На странице **Новое VPN-подключение** для параметра **Тип подключения** выберите значение **Сеть-сеть**.
4. Для параметра **Локальный сайт** щелкните **Настроить обязательные параметры**. Откроется страница **Локальный сайт**.
5. На странице **Локальный сайт** введите имя, которое будет использоваться для виртуальной сети Resource Manager. Например, RMVNetLocal.
6. Если у VPN-шлюза для виртуальной сети Resource Manager уже есть общедоступный IP-адрес, укажите его в поле **IP-адрес VPN-шлюза**. Если вы выполняете эти шаги в качестве упражнения или у вас еще нет шлюза для виртуальной сети Resource Manager, можно использовать заполнитель IP-адреса. Убедитесь, что для заполнителя IP-адреса используется допустимый формат. Позднее необходимо будет заменить его общедоступным IP-адресом шлюза виртуальной сети Resource Manager.
7. В поле **Адресное пространство клиента** укажите [значения](#connectoverview) пространств IP-адресов виртуальной сети Resource Manager. Этот параметр используется, чтобы определить адресные пространства для маршрутизации в виртуальную сеть Resource Manager. В этом примере мы используем диапазон адресов 192.168.0.0/16 для RMVNet.
8. Нажмите кнопку **ОК**, чтобы сохранить значения и вернуться к странице **Новое VPN-подключение**.

### <a name="3-create-the-virtual-network-gateway"></a><a name="classicgw"></a>3. Создание шлюза виртуальной сети

1. На странице **Новое VPN-подключение** установите флажок **Немедленно создать шлюз**.
2. Щелкните **Дополнительная настройка шлюза**, чтобы открыть страницу **Настройка шлюза**.

   ![Открыть страницу настройки шлюза](./media/vpn-gateway-connect-different-deployment-models-portal/optionalgatewayconfiguration.png "Открыть страницу настройки шлюза")
3. Щелкните **Подсеть — Настройка обязательных параметров**, чтобы открыть страницу **Добавление подсети**. Вы увидите, что в поле **Имя** уже задано обязательное значение **GatewaySubnet**.
4. **Диапазон адресов** определяет диапазон подсети шлюза. Несмотря на то что можно создать подсеть шлюза с диапазоном адресов /29 (3 адреса), мы советуем создать подсеть шлюза с большим числом доступных IP-адресов. Это поможет учесть будущие конфигурации, которые могут потребовать больше доступных IP-адресов. Если это возможно, используйте диапазон /27 или /28. Если вы выполняете эти шаги в качестве упражнения, вы можете использовать [примеры значений](#values). В этом примере мы используем диапазон 10.0.0.32/28. Нажмите кнопку **ОК**, чтобы создать подсеть шлюза.
5. На странице **Настройка шлюза** отображается значение **Размер**, которое относится к номеру SKU шлюза. Выберите номер SKU для своего VPN-шлюза.
6. Убедитесь, что параметр **Тип маршрутизации** имеет значение **Динамическая**, и нажмите кнопку **ОК** для возврата к странице **VPN-подключения**.
7. На странице **VPN-подключения** нажмите кнопку **ОК**, чтобы создать VPN-шлюз. Создание VPN-шлюза может занять до 45 минут.

### <a name="4-copy-the-virtual-network-gateway-public-ip-address"></a><a name="ip"></a>4. Скопируйте общедоступный IP-адрес шлюза виртуальной сети.

После создания шлюза виртуальной сети можно просмотреть его IP-адрес. 

1. Перейдите к классической виртуальной сети и щелкните **Обзор**.
2. Щелкните **VPN-подключения**, чтобы открыть страницу "VPN-подключения". На странице "VPN-подключения" можно увидеть общедоступный IP-адрес. Это общедоступный IP-адрес, назначенный вашему шлюзу виртуальной сети. Запишите этот IP-адрес. Он понадобится позже, при работе с параметрами конфигурации локального сетевого шлюза Resource Manager. 
3. Можно просмотреть состояние подключений шлюза. Обратите внимание, что созданный вами сайт локальной сети отображен в состоянии "Подключение". Это состояние изменится после создания подключений. Завершив просмотр состояния, можно закрыть эту страницу.

## <a name="section-2---configure-the-resource-manager-vnet-settings"></a><a name="rmvnet"></a>Раздел 2. Настройка параметров виртуальной сети Resource Manager

В этом разделе вы создадите шлюз виртуальной сети и шлюз локальной сети для виртуальной сети Resource Manager. Снимки экрана приведены в качестве примеров. Обязательно подставьте собственные значения или воспользуйтесь значениями из [примера](#values).

### <a name="1-create-a-virtual-network"></a>1. Создание виртуальной сети

**Примеры значений:**

* Имя виртуальной сети = RMVNet <br>
* Адресное пространство: 192.168.0.0/16. <br>
* Группа ресурсов = RG1 <br>
* Расположение = восточная часть США <br>
* Имя подсети: Subnet-1. <br>
* Диапазон адресов: 192.168.1.0/24. <br>

Если у вас нет виртуальной сети Resource Manager и вы выполняете действия из этой статьи в качестве упражнения, вы можете [создать виртуальную сеть](../virtual-network/quick-create-portal.md), используя примеры значений.

### <a name="2-create-a-virtual-network-gateway"></a><a name="creategw"></a>2. Создание шлюза виртуальной сети

На этом шаге вы создадите шлюз для своей виртуальной сети. Создание шлюза часто занимает 45 минут и более, в зависимости от выбранного SKU шлюза.

[!INCLUDE [About gateway subnets](../../includes/vpn-gateway-about-gwsubnet-portal-include.md)]

**Примеры значений:**

* Имя шлюза виртуальной сети = RMGateway <br>
* Тип шлюза: VPN <br>
* Тип VPN: на основе маршрутов <br>
* Номер SKU: VpnGw1. <br>
* Расположение = восточная часть США <br>
* Тип виртуальной сети: RMVNet. <br>
* Шлюз подсети = 192.168.0.0/26 <br>
* Первая IP-конфигурация: rmgwpip. <br>

[!INCLUDE [Add gateway](../../includes/vpn-gateway-add-gw-rm-portal-empty.md)]

[!INCLUDE [vpn-gateway-no-nsg-include](../../includes/vpn-gateway-no-nsg-include.md)]

### <a name="3-create-a-local-network-gateway"></a><a name="createlng"></a>3. Создание шлюза локальной сети

**Примеры значений**: Шлюз локальной сети = ClassicVNetLocal.

| Виртуальная сеть | Адресное пространство | Регион | Подключается к сайту локальной сети |Общедоступный IP-адрес|
|:--- |:--- |:--- |:--- |:--- |
| ClassicVNet |(10.0.0.0/24) |Западная часть США | RMVNetLocal (192.168.0.0/16) |Общедоступный IP-адрес, назначенный шлюзу ClassicVNet|
| RMVNet | (192.168.0.0/16) |Восточная часть США |ClassicVNetLocal (10.0.0.0/24) |Общедоступный IP-адрес, назначенный шлюзу RMVNet|

Шлюз локальной сети задает диапазон адресов и общедоступный IP-адрес, связанный с классической виртуальной сетью и ее шлюзом. При выполнении этих действий в качестве упражнения используйте примеры значений.

[!INCLUDE [Add local network gateway](../../includes/vpn-gateway-add-local-network-gateway-portal-ip-empty.md)]

## <a name="section-3---modify-the-classic-vnet-local-site-settings"></a><a name="modifylng"></a>Раздел 3. Изменение параметров локального сайта виртуальной сети

В этом разделе вы замените заполнитель IP-адреса, указанный при настройке параметров локального сайта, на IP-адрес VPN-шлюза Resource Manager. В этом разделе используются классические командлеты PowerShell (управление службами).

1. На портале Azure перейдите к классической виртуальной сети.
2. На странице своей виртуальной сети щелкните **Обзор**.
3. В разделе **VPN-подключения** щелкните имя своего локального сайта на схеме.

   ![VPN-подключения](./media/vpn-gateway-connect-different-deployment-models-portal/vpnconnections.png "VPN-подключения")
4. На странице **VPN-подключения типа «сеть-сеть»** щелкните имя сайта.

   ![Имя сайта](./media/vpn-gateway-connect-different-deployment-models-portal/sitetosite3.png "Имя локального сайта")
5. На странице подключения для локального сайта щелкните его имя, чтобы открыть страницу **Локальный сайт**.

   ![Открытие — локальный сайт](./media/vpn-gateway-connect-different-deployment-models-portal/openlocal.png "Открытие локального сайта")
6. На странице **Локальный сайт** замените **IP-адрес VPN-шлюза** IP-адресом шлюза Resource Manager.

   ![IP-адрес шлюза](./media/vpn-gateway-connect-different-deployment-models-portal/gwipaddress.png "IP-адрес шлюза")
7. Нажмите кнопку **ОК**, чтобы обновить IP-адрес.

## <a name="section-4---create-resource-manager-to-classic-connection"></a><a name="RMtoclassic"></a>Раздел 4. Создание подключения между виртуальной сетью Resource Managиr к классической виртуальной сетью

На этих шагах вы с помощью портала Azure настроите подключение от виртуальной сети Resource Manager к классической виртуальной сети.

1. В колонке **Все ресурсы** найдите шлюз локальной сети. В нашем примере это **ClassicVNetLocal**.
2. Щелкните **Конфигурация** и убедитесь, что значение IP-адреса соответствует VPN-шлюзу для классической виртуальной сети. Обновите его при необходимости, а затем щелкните **Сохранить**. Закройте страницу.
3. В колонке **Все ресурсы** щелкните шлюз локальной сети.
4. Щелкните **Подключения**, чтобы открыть страницу "Подключения".
5. На странице **Подключения** щелкните **+**, чтобы добавить подключение.
6. На странице **Добавление подключения** укажите имя для своего подключения. Например, RMtoClassic.
7. На этой странице уже выбрано подключение **Сеть-сеть**.
8. Выберите шлюз виртуальной сети, который необходимо связать с этим сайтом.
9. Создайте **общий ключ**. Этот ключ также используется в подключении, которое вы создали от классической виртуальной сети к виртуальной сети Resource Manager. Вы можете создать ключ или ввести свой. В нашем примере мы использовали abc123, но вы можете (это рекомендуется) создать и использовать что-нибудь посложнее.
10. Нажмите кнопку **ОК**, чтобы создать подключение.

## <a name="section-5---create-classic-to-resource-manager-connection"></a><a name="classictoRM"></a>Раздел 5. Создание подключения между классической виртуальной сетью и виртуальной сетью Resource Manager

На этих шагах вы настроите подключение от классической виртуальной сети к виртуальной сети Resource Manager. Для этого понадобится PowerShell. Это подключение невозможно создать на портале. Убедитесь, что командлеты PowerShell Resource Manager и классические командлеты PowerShell установлены.

### <a name="1-connect-to-your-azure-account"></a>1. подключение к учетной записи Azure

Запустите консоль PowerShell с повышенными правами и войдите в свою учетную запись Azure. После выполнения входа он скачивает параметры учетной записи, чтобы они были доступны в Azure PowerShell. Следующий командлет запрашивает учетные данные входа для вашей учетной записи Azure для модели развертывания с помощью Resource Manager.

```powershell
Connect-AzAccount
```

Получите список подписок Azure.

```powershell
Get-AzSubscription
```

При наличии нескольких подписок укажите подписку, которую вы хотите использовать.

```powershell
Select-AzSubscription -SubscriptionName "Name of subscription"
```

Затем войдите, чтобы использовать классические командлеты PowerShell (управление службами). Используйте следующую команду, чтобы добавить учетную запись Azure для классической модели развертывания.

```powershell
Add-AzureAccount
```

Получите список своих подписок. Этот шаг может потребоваться при добавлении командлетов для управления службами в зависимости от установленного модуля Azure.

```powershell
Get-AzureSubscription
```

При наличии нескольких подписок укажите подписку, которую вы хотите использовать.

```powershell
Select-AzureSubscription -SubscriptionName "Name of subscription"
```

### <a name="2-view-the-network-configuration-file-values"></a>2. Просмотр значений файла конфигурации сети

При создании виртуальной сети на портале Azure полное имя, которое используется Azure, не отображается на портале. Например, если виртуальная сеть отображается на портале Azure с именем ClassicVNet, то в файле конфигурации сети она может иметь гораздо более длинное имя. Это имя может выглядеть примерно как Group ClassicRG ClassicVNet. На этих шагах вы скачаете файл конфигурации сети и просмотрите значения в нем.

Создайте каталог на компьютере, а затем экспортируйте в него файл конфигурации сети. В этом примере файл конфигурации сети экспортируется в каталог C:\AzureNet.

```powershell
Get-AzureVNetConfig -ExportToFile C:\AzureNet\NetworkConfig.xml
```

Откройте файл в текстовом редакторе и просмотрите имя для классической виртуальной сети. При выполнении командлетов PowerShell используйте имена из файла конфигурации сети.

- Имена виртуальных сетей перечислены как **VirtualNetworkSite name =**.
- Имена веб-сайтов перечислены как **VirtualNetworkSite name =**.

### <a name="3-create-the-connection"></a>3. Создание подключения

Установите общий ключ и создайте подключение от классической виртуальной сети к виртуальной сети Resource Manager. Общий ключ невозможно задать с помощью портала. Эти шаги следует выполнять при входе с помощью классической версии командлетов PowerShell. Чтобы сделать это, используйте командлет **Add-AzureAccount**. В противном случае вы не сможете задать "-AzureVNetGatewayKey".

- В этом примере **-VNetName** — это имя классической виртуальной сети, указанное в файле конфигурации сети. 
- **- LocalNetworkSiteName** — это имя для локального сайта, указанное в файле конфигурации сети.
- Параметр **-SharedKey** — это значение, которое вы создаете и указываете. В этом примере мы использовали *abc123*, но можно создать что-нибудь посложнее. Важно, чтобы заданное здесь значение совпадало со значением, которое вы указали при создании подключения от виртуальной сети Resource Manager к классической виртуальной сети.

```powershell
Set-AzureVNetGatewayKey -VNetName "Group ClassicRG ClassicVNet" `
-LocalNetworkSiteName "172B9E16_RMVNetLocal" -SharedKey abc123
```

## <a name="section-6---verify-your-connections"></a><a name="verify"></a>Раздел 6. Проверка подключений

Подключения можно проверить на портале Azure или с помощью PowerShell. При проверке может потребоваться подождать пару минут, пока подключение не будет создано. В случае успешного подключения его состояние изменится с "Подключение" на "Подключено".

### <a name="to-verify-the-connection-from-your-classic-vnet-to-your-resource-manager-vnet"></a>Проверка подключения классической виртуальной сети к виртуальной сети Resource Manager

[!INCLUDE [vpn-gateway-verify-connection-azureportal-classic](../../includes/vpn-gateway-verify-connection-azureportal-classic-include.md)]

### <a name="to-verify-the-connection-from-your-resource-manager-vnet-to-your-classic-vnet"></a>Проверка подключения виртуальной сети Resource Manager к классической виртуальной сети

[!INCLUDE [vpn-gateway-verify-connection-portal-rm](../../includes/vpn-gateway-verify-connection-portal-rm-include.md)]

## <a name="vnet-to-vnet-faq"></a><a name="faq"></a>Часто задаваемые вопросы о подключениях типа "виртуальная сеть — виртуальная сеть"

[!INCLUDE [vpn-gateway-vnet-vnet-faq](../../includes/vpn-gateway-faq-vnet-vnet-include.md)]
