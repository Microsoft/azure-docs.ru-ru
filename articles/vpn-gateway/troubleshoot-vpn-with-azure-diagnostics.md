---
title: Устранение неполадок VPN-шлюза Azure с помощью журналов диагностики
description: Устранение неполадок VPN-шлюза Azure с помощью журналов диагностики
services: vpn-gateway
author: stegag
ms.service: vpn-gateway
ms.topic: how-to
ms.date: 03/15/2021
ms.author: stegag
ms.openlocfilehash: 232e084e44696c6aa88a9dd33092c48a96e35f85
ms.sourcegitcommit: 2c1b93301174fccea00798df08e08872f53f669c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/22/2021
ms.locfileid: "104772011"
---
# <a name="troubleshoot-azure-vpn-gateway-using-diagnostic-logs"></a>Устранение неполадок VPN-шлюза Azure с помощью журналов диагностики

В этой статье содержатся сведения о различных журналах, доступных для диагностики VPN-шлюза, а также об их использовании для эффективного устранения проблем с VPN-шлюзом.

[!INCLUDE [support-disclaimer](../../includes/support-disclaimer.md)]

В Azure доступны следующие журналы:

|***Имя** _ | _ *_Описание_** |
|---        | ---               |
|**GatewayDiagnosticLog** | Содержит журналы диагностики для событий конфигурации шлюза, основных изменений и событий обслуживания. |
|**TunnelDiagnosticLog** | Содержит события изменения состояния туннеля. События подключения и отключения туннеля имеют обобщенную причину изменения состояния, если это применимо. |
|**RouteDiagnosticLog** | Записывает изменения статических маршрутов и событий BGP, происходящих на шлюзе. |
|**IKEDiagnosticLog** | Записывает в шлюз сообщения управления IKE и события. |
|**P2SDiagnosticLog** | Регистрирует сообщения управления точка-сеть и события на шлюзе. |

Обратите внимание, что в этих таблицах имеется несколько столбцов. В этой статье мы представляем наиболее важные для удобства использования журнала.

## <a name="set-up-logging"></a><a name="setup"></a>Настройка ведения журнала

Сведения о настройке событий журнала диагностики из VPN-шлюза Azure с помощью Log Analytics Azure см. в разделе [Настройка оповещений для событий журнала диагностики из VPN-шлюза](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-setup-alerts-virtual-network-gateway-log).

## <a name="gatewaydiagnosticlog"></a><a name="GatewayDiagnosticLog"></a>GatewayDiagnosticLog

Аудит изменений конфигурации осуществляется в таблице **гатевайдиагностиклог** . Изменения, выполняемые в журналах, могут занять несколько минут.

Здесь у вас есть образец запроса в виде ссылки.

```
AzureDiagnostics  
| where Category == "GatewayDiagnosticLog"  
| project TimeGenerated, OperationName, Message, Resource, ResourceGroup  
| sort by TimeGenerated asc
```

В этом запросе к **гатевайдиагностиклог** будет показано несколько столбцов.

|***Имя** _ | _ *_Описание_** |
|---        | ---               |
|**TimeGenerated** | Метка времени каждого события в часовом поясе UTC.|
|**OperationName** |произошедшее событие. Это может быть либо *сетгатевайконфигуратион, сетконнектионконфигуратион, хостмаинтенанцеевент, гатевайтенантпримаричанжед, MigrateCustomerSubscription, GatewayResourceMove, ValidateGatewayConfiguration*.|
|**Сообщение** | подробные сведения о выполняемой операции и список успешных и неудачных порезультатов.|

В приведенном ниже примере показано действие, регистрируемое при применении новой конфигурации.

:::image type="content" source="./media/troubleshoot-vpn-with-azure-diagnostics/image-26-set-gateway.png" alt-text="Пример операции задания шлюза, наблюдаемой в Гатевайдиагностиклог.":::


Обратите внимание, что при каждом изменении конфигурации на VPN-шлюзе или шлюзе локальной сети будет регистрироваться Сетгатевайконфигуратион.
Перекрестная ссылка на результаты из таблицы **гатевайдиагностиклог** с помощью таблиц **туннелдиагностиклог** может помочь определить, начался ли сбой подключения туннеля в то же время, когда была изменена конфигурация, или было выполнено обслуживание. Если да, то у нас есть отличный указатель на возможную основную причину.

## <a name="tunneldiagnosticlog"></a><a name="TunnelDiagnosticLog"></a>TunnelDiagnosticLog

Таблица **туннелдиагностиклог** очень полезна для проверки состояния подключения туннеля в журнале.

Здесь у вас есть образец запроса в виде ссылки.

```
AzureDiagnostics
| where Category == "TunnelDiagnosticLog"
| project TimeGenerated, OperationName, instance_s, Resource, ResourceGroup
| sort by TimeGenerated asc
```

В этом запросе к **туннелдиагностиклог** будет показано несколько столбцов.


|***Имя** _ | _ *_Описание_** |
|---        | ---               |
|**TimeGenerated** | Метка времени каждого события в часовом поясе UTC.|
|**OperationName** | произошедшее событие. Это может быть либо *туннелконнектед* , либо *туннелдисконнектед*.|
| **Экземпляр \_ s** | экземпляр роли шлюза, который активировал событие. Он может быть либо Гатевайтенантворкер \_ в \_ 0, либо гатевайтенантворкер \_ в \_ 1, который является именами двух экземпляров шлюза.|
| **Ресурс** | Указывает имя VPN-шлюза. |
| **ResourceGroup** | Указывает группу ресурсов, в которой находится шлюз.|


Выходные данные примера:

:::image type="content" source="./media/troubleshoot-vpn-with-azure-diagnostics/image-16-tunnel-connected.png" alt-text="Пример события подключения, подключенного к туннелю, в Туннелдиагностиклог.":::


**Туннелдиагностиклог** очень полезна для устранения неполадок с прошлыми событиями о непредвиденных отключениях VPN. Его упрощенная природа дает возможность анализировать большие временные диапазоны в течение нескольких дней с минимальными усилиями.
Только после того, как вы укажете отметку времени отключения, можно переключиться на более подробный анализ таблицы **икедиагностиклог** , чтобы более подробно изучить причины отключения, которые должны быть связаны с IPSec.


Некоторые советы по устранению проблем
- Если вы видите событие отключения в одном экземпляре шлюза, а затем событие подключения на **другом** экземпляре шлюза через несколько секунд, вы просматриваете отработку отказа шлюза. Как правило, это ожидаемое поведение из-за обслуживания экземпляра шлюза. Дополнительные сведения об этом поведении см. в статье [о избыточности VPN-шлюза Azure](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-highlyavailable#about-azure-vpn-gateway-redundancy).
- Такое же поведение будет наблюдаться, если вы преднамеренно запустили сброс шлюза на стороне Azure, что приводит к перезагрузке активного экземпляра шлюза. Дополнительные сведения об этом поведении см. в статье [Сброс VPN-шлюза](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-resetgw-classic).
- Если вы видите событие отключения в одном экземпляре шлюза, за которым следует событие подключения для одного **и того же** экземпляра шлюза через несколько секунд, возможно, вы просматриваете сбой сети, вызывающий тайм-аут DPD, или отсоединение, ошибочно отправленное локальным устройством.

## <a name="routediagnosticlog"></a><a name="RouteDiagnosticLog"></a>RouteDiagnosticLog

Таблица **раутедиагностиклог** отслеживает действие для статически измененных маршрутов или маршрутов, полученных по протоколу BGP.

Здесь у вас есть образец запроса в виде ссылки.

```
AzureDiagnostics
| where Category == "RouteDiagnosticLog"
| project TimeGenerated, OperationName, Message, Resource, ResourceGroup
```

В этом запросе к **раутедиагностиклог** будет показано несколько столбцов.

|***Имя** _ | _ *_Описание_** |
|---        | ---               |
|**TimeGenerated** | Метка времени каждого события в часовом поясе UTC.|
|**OperationName** | произошедшее событие. Может быть либо *статикраутеупдате, бгпраутеупдате, бгпконнектедевент, бгпдисконнектедевент*.|
| **Сообщение** | сведения о том, что происходит при выполнении операции.|

В выходных данных отобразятся полезные сведения о подключенных и отключенных узлах BGP, а также об обмене маршрутами.

Пример


:::image type="content" source="./media/troubleshoot-vpn-with-azure-diagnostics/image-31-bgp-route.png" alt-text="Пример действия обмена маршрутами BGP, отображаемый в Раутедиагностиклог.":::


## <a name="ikediagnosticlog"></a><a name="IKEDiagnosticLog"></a>IKEDiagnosticLog

В таблице **икедиагностиклог** имеется подробное ведение журнала отладки для IKE/IPSec. Это очень полезно для просмотра при устранении неполадок, связанных с подключением, или при сбое подключения к сценариям VPN.

Здесь у вас есть образец запроса в виде ссылки.

```
AzureDiagnostics  
| where Category == "IKEDiagnosticLog" 
| extend Message1=Message
| parse Message with * "Remote " RemoteIP ":" * "500: Local " LocalIP ":" * "500: " Message2
| extend Event = iif(Message has "SESSION_ID",Message2,Message1)
| project TimeGenerated, RemoteIP, LocalIP, Event, Level 
| sort by TimeGenerated asc
```

В этом запросе к **икедиагностиклог** будет показано несколько столбцов.


|***Имя** _ | _ *_Описание_** |
|---        | ---               |
|**TimeGenerated** | Метка времени каждого события в часовом поясе UTC.|
| **RemoteIP** | IP-адрес локального VPN-устройства. В реальных сценариях полезно выполнять фильтрацию по IP-адресу соответствующего локального устройства, если оно имеет более одного. |
|**LocalIP** | IP-адрес VPN-шлюза, для которого выполняется устранение неполадок. В реальных сценариях полезно фильтровать по IP-адресу соответствующего VPN-шлюза, если в подписке есть больше одного. |
|**Событие** | содержит диагностическое сообщение, полезное для устранения неполадок. Обычно они начинаются с ключевого слова и обращаются к действиям, выполняемым шлюзом Azure: **\[ Send \]** указывает на событие, вызванное пакетом IPSec, отправленным шлюзом Azure.  **\[ Полученное \]** значение указывает на событие, как следствие пакета, полученного от локального устройства.  **\[ Локальный \]** указывает действие, выполняемое локально шлюзом Azure. |


Обратите внимание, что столбцы RemoteIP, Локалип и Event отсутствуют в исходном списке столбцов в базе данных AzureDiagnostics, но добавляются в запрос путем анализа выходных данных столбца "Message" для упрощения анализа.

Советы по устранению неполадок

- Чтобы определить начало согласования IPSec, необходимо найти исходное \_ сообщение SA init. Такое сообщение может быть отправлено одной из сторон туннеля. Каждый, кто отправляет первый пакет, называется «инициатор» в терминологии IPsec, а другая сторона становится «ответчиком». Первое сообщение SA \_ init всегда равно одному, где ркукие = 0.

- Если не удается установить туннель IPsec, Azure повторит попытку через несколько секунд. По этой причине устранение неполадок с VPN-отключением очень удобно в Икедиагностиклог, так как нет необходимости ждать определенного времени для воспроизведения проблемы. Кроме того, эта ошибка будет всегда одинаковой при каждом походе, поэтому можно просто увеличить одно «примерное» согласование в любое время.

- \_Инициализация SA содержит параметры IPsec, которые узел хочет использовать для этого согласования IPSec. Официальный документ   
[Параметры IPsec/IKE по умолчанию](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-about-vpn-devices#ipsec) Перечисляет параметры IPsec, поддерживаемые шлюзом Azure, с параметрами по умолчанию.


## <a name="p2sdiagnosticlog"></a><a name="P2SDiagnosticLog"></a>P2SDiagnosticLog

Последняя доступная таблица для диагностики VPN — **P2SDiagnosticLog**. Эта таблица отслеживает действие для "точка — сеть".

Здесь у вас есть образец запроса в виде ссылки.

```
AzureDiagnostics  
| where Category == "P2SDiagnosticLog"  
| project TimeGenerated, OperationName, Message, Resource, ResourceGroup
```

В этом запросе к **P2SDiagnosticLog** будет показано несколько столбцов.

|***Имя** _ | _ *_Описание_** |
|---        | ---               |
|**TimeGenerated** | Метка времени каждого события в часовом поясе UTC.|
|**OperationName** | произошедшее событие. Будет *P2SLogEvent*.|
| **Сообщение** | сведения о том, что происходит при выполнении операции.|

В выходных данных будут показаны все параметры типа "точка — сеть", к которым применен шлюз, а также политики IPsec.

:::image type="content" source="./media/troubleshoot-vpn-with-azure-diagnostics/image-28-p2s-log-event.png" alt-text="Пример подключения типа &quot;точка — сеть&quot; в P2SDiagnosticLog.":::

Кроме того, всякий раз, когда клиент будет подключаться через IKEv2 или Опенвпн Point to site, таблица будет записывать в журнал активность пакетов, взаимодействия EAP/RADIUS, а также успешных и неудачных результатов по пользователям.

:::image type="content" source="./media/troubleshoot-vpn-with-azure-diagnostics/image-29-eap.png" alt-text="Пример проверки подлинности EAP, отображаемой в P2SDiagnosticLog.":::

## <a name="next-steps"></a>Next Steps

Сведения о настройке оповещений в журналах ресурсов туннеля см. в разделе [Настройка оповещений в журналах ресурсов VPN-шлюза](vpn-gateway-howto-setup-alerts-virtual-network-gateway-log.md).

