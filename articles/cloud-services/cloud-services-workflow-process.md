---
title: Рабочий процесс архитектуры виртуальных машин Windows Azure | Документация Майкрософт
description: В этой статье приводятся общие сведения о рабочих процессах при развертывании службы.
ms.topic: article
ms.service: cloud-services
ms.date: 10/14/2020
ms.author: tagore
author: tanmaygore
ms.reviewer: mimckitt
ms.custom: ''
ms.openlocfilehash: 606510940460db963a2aa63deb57b6dba77de3ac
ms.sourcegitcommit: c27a20b278f2ac758447418ea4c8c61e27927d6a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/03/2021
ms.locfileid: "101700139"
---
# <a name="workflow-of-windows-azure-classic-vm-architecture"></a>Рабочий процесс классической архитектуры виртуальной машины Windows Azure 

> [!IMPORTANT]
> [Облачные службы Azure (Расширенная поддержка)](../cloud-services-extended-support/overview.md) — это новая модель развертывания на основе Azure Resource Manager для продукта облачных служб Azure.После этого изменения облачные службы Azure, работающие в модели развертывания на основе Service Manager Azure, были переименованы как облачные службы (классические), и все новые развертывания должны использовать [облачные службы (Расширенная поддержка)](../cloud-services-extended-support/overview.md).

В этой статье приведены общие сведения о рабочих процессах, выполняемых при развертывании или обновлении ресурсов Azure, таких как виртуальная машина. 

> [!NOTE]
>В Azure предусмотрены две модели развертывания для создания ресурсов и работы с ними: модель Resource Manager и классическая модель. В этой статье рассматривается использование классической модели развертывания.

На следующей схеме представлена архитектура ресурсов Azure.

:::image type="content" source="./media/cloud-services-workflow-process/workflow.jpg" alt-text="<Познакомьтесь с изображением рабочего процесса Azure>":::

## <a name="workflow-basics"></a>Основы рабочих процессов
   
**A**. RDFE/ФФЕ — это путь взаимодействия от пользователя к структуре. RDFE (RedDog Front End) — это общедоступный API, который является внешним интерфейсом для портал управления и API управления службами, например Visual Studio, Azure MMC и т. д.  Все запросы пользователя проходят через RDFE. ФФЕ (внешний интерфейс структуры) — это слой, который преобразует запросы из RDFE в команды структуры. Все запросы из RDFE проходят через ФФЕ, чтобы связаться с контроллерами структуры.

**Б**. Контроллер структуры отвечает за обслуживание и мониторинг всех ресурсов в центре обработки данных. Он взаимодействует с агентами узлов структуры в ОС структуры, отправляя сведения, такие как версия гостевой ОС, пакет службы, конфигурация службы и состояние службы.

**В**. Агент узла находится в ОС узла и отвечает за настройку гостевой ОС и связь с гостевым агентом (Виндовсазурегуестажент) для обновления роли до предполагаемого состояния цели и проверки пульса с помощью гостевого агента. Если агент узла не получает ответ пульса в течение 10 минут, агент узла перезапускает гостевую ОС.

**C2**. Вааппажент отвечает за установку, настройку и обновление WindowsAzureGuestAgent.exe.

**Г**.  Виндовсазурегуестажент отвечает за следующее:

1. Настройка гостевой ОС, включая брандмауэр, списки ACL, ресурсы LocalStorage, пакет службы, конфигурацию и сертификаты.
2. Настройка идентификатора безопасности для учетной записи пользователя, под которой будет выполняться роль.
3. Связь состояния роли с структурой.
4. Запустите Вахостбутстраппер и отслеживайте его, чтобы убедиться в том, что роль находится в состоянии цели.

**Д**. Вахостбутстраппер отвечает за следующее:

1. Чтение конфигурации роли и запуск всех соответствующих задач и процессов для настройки и запуска роли.
2. Наблюдение за всеми дочерними процессами.
3. Вызов события StatusCheck в процессе узла роли.

**F**. Иисконфигуратор выполняется, если роль настроена как полная веб-роль IIS. Он отвечает за следующее:

1. Запуск стандартных служб IIS
2. Настройка модуля перезаписи в веб-конфигурации
3. Настройка AppPool для настроенной роли в модели службы
4. Настройка ведения журнала IIS для указания на папку Диагностиксторе LocalStorage
5. Настройка разрешений и ACL
6. Веб-сайт находится в каталоге% RoleRoot%: \sitesroot\0, а AppPool указывает на это расположение для запуска IIS. 

**Ж**. Задачи запуска определяются моделью роли и запускаются Вахостбутстраппер. Задачи запуска можно настроить для асинхронного запуска в фоновом режиме, а начальный загрузчик узла запускает задачу запуска, а затем переходит к другим задачам запуска. Задачи запуска также можно настроить для работы в режиме Simple (по умолчанию), в котором начальный загрузчик узла будет ожидать завершения выполнения задачи запуска и вернуть код выхода Success (0), прежде чем переходить к следующей задаче запуска.

**З**. Эти задачи являются частью пакета SDK и определяются как подключаемые модули в определении службы роли (CSDEF-файле). При развертывании в задачи запуска **диагностиксажент** и **ремотеакцессажент** уникальны в том, что каждый из них определяет две задачи запуска: один обычный и один с параметром **/блоккстартуп** . Обычная задача запуска определяется как фоновая задача запуска, чтобы ее можно было выполнять в фоновом режиме во время выполнения самой роли. Задача запуска **/блоккстартуп** определяется как простая задача запуска, поэтому вахостбутстраппер ожидает завершения работы, прежде чем продолжить. Задача **/блоккстартуп** ожидает завершения инициализации обычной задачи, а затем завершает работу и разрешает продолжение работы загрузчика узла. Это делается для того, чтобы можно было настроить диагностику и доступ по протоколу RDP перед запуском ролей (это делается с помощью задачи/Блоккстартуп). Это также позволяет выполнять диагностику и RDP-доступ для продолжения работы после того, как начальный загрузчик узла завершит задачи запуска (это выполняется с помощью обычной задачи).

**Я**. WaWorkerHost — это стандартный ведущий процесс для обычных рабочих ролей. В этом хост-процессе размещаются все библиотеки DLL и код точки входа роли, такие как OnStart и Run.

**J**. WaIISHost — это ведущий процесс для кода точки входа роли для веб-ролей, использующих полные службы IIS. Этот процесс загружает первую найденную библиотеку DLL, которая использует класс **RoleEntryPoint** , и выполняет код из этого класса (OnStart, Run, OnStart). В этом процессе вызываются все события **RoleEnvironment** (например, StatusCheck и Changed), созданные в классе RoleEntryPoint.

**Л**. W3WP — это стандартный рабочий процесс IIS, который используется, если роль настроена для использования полных служб IIS. При этом выполняется запуск AppPool, настроенного из Иисконфигуратор. Все события RoleEnvironment (такие как StatusCheck и Changed), созданные здесь, вызываются в этом процессе. Обратите внимание, что события RoleEnvironment будут срабатывать в обоих расположениях (WaIISHost и w3wp.exe), если вы подписываетесь на события в обоих процессах.

## <a name="workflow-processes"></a>Процессы рабочего процесса

1. Пользователь выполняет запрос, например отправку файлов ". cspkg" и ". cscfg", представляя ресурс для отмены или изменения конфигурации и т. д. Это можно сделать с помощью портал Azure или средства, использующего API управления службами, например функции публикации Visual Studio. Этот запрос переходит к RDFE для выполнения всех операций, связанных с подпиской, а затем передает запрос в ФФЕ. Остальные этапы рабочего процесса — это развертывание нового пакета и его запуск.
2. ФФЕ находит правильный пул компьютеров (на основе введенных данных, например территориальную группу или географическое расположение, а также входные данные из структуры, например доступность компьютера) и обменивается данными с контроллером Master Fabric в этом пуле машин.
3. Контроллер структуры находит узел, который имеет доступные ядра ЦП (или начинает новый узел). Пакет и конфигурация службы копируются на узел, и контроллер структуры взаимодействует с агентом узла в ОС узла для развертывания пакета (Настройка DIP, портов, гостевой ОС и т. д.).
4. Агент узла запускает гостевую ОС и взаимодействует с гостевым агентом (Виндовсазурегуестажент). Узел отправляет пакеты пульса на гостевую систему, чтобы убедиться, что роль работает с ее состоянием цели.
5. Виндовсазурегуестажент настраивает гостевую ОС (брандмауэр, списки ACL, LocalStorage и т. д.), копирует новый XML-файл конфигурации в К:\конфиг, а затем запускает процесс Вахостбутстраппер.
6. Для полных веб-ролей IIS Вахостбутстраппер запускает Иисконфигуратор и сообщает ему об удалении всех существующих пулов приложений для веб-роли из служб IIS.
7. Вахостбутстраппер считывает задачи **запуска** из E:\RoleModel.xml и начинает выполнять задачи запуска. Вахостбутстраппер ожидает завершения всех простых задач запуска и возвращает сообщение об успешном выполнении.
8. Для полных веб-ролей IIS Вахостбутстраппер указывает Иисконфигуратор настроить IIS AppPool и указывает сайту на `E:\Sitesroot\<index>` , где `<index>` — Отсчитываемый от нуля индекс в количестве `<Sites>` элементов, определенных для службы.
9. Вахостбутстраппер запустит ведущий процесс в зависимости от типа роли:
    1. **Рабочая роль**: WaWorkerHost.exe запущена. Вахостбутстраппер выполняет метод OnStart (). После возврата Вахостбутстраппер начинает выполнение метода Run (), а затем одновременно помечает роль как готовую и помещает ее в поворот балансировщика нагрузки (если Инпутендпоинтс определен). Затем Вахостбутсраппер переходит в цикл проверки состояния роли.
    2. **Полная веб-роль IIS**: аиишост запущена. Вахостбутстраппер выполняет метод OnStart (). После возврата он начинает выполнять метод Run (), а затем одновременно помечает роль как готовую и помещает ее в поворот балансировщика нагрузки. Затем Вахостбутсраппер переходит в цикл проверки состояния роли.
10. Входящие веб-запросы к полной веб-роли IIS инициируют IIS для запуска процесса W3WP и выполняют запрос так же, как и в локальной среде IIS.

## <a name="log-file-locations"></a>Расположение файлов журнала

**WindowsAzureGuestAgent**

- к:\логс\аппажентрунтиме.лог.  
Этот журнал содержит изменения в службе, включая запуск, остановку и новые конфигурации. Если служба не изменится, в этом файле журнала можно увидеть большие промежутки времени.
- к:\логс\вааппажент.лог.  
Этот журнал содержит обновления состояния и уведомления о пульсе и обновляется каждые 2-3 секунд.  Этот журнал содержит исторические представления о состоянии экземпляра и сообщает, когда экземпляр не находится в состоянии готовности.
 
**вахостбутстраппер**

`C:\Resources\Directory\<deploymentID>.<role>.DiagnosticStore\WaHostBootstrapper.log`
 
**WaIISHost**

`C:\Resources\Directory\<deploymentID>.<role>\WaIISHost.log`
 
**иисконфигуратор**

`C:\Resources\Directory\<deploymentID>.<role>\IISConfigurator.log`
 
**Журналы IIS**

`C:\Resources\Directory\<guid>.<role>.DiagnosticStore\LogFiles\W3SVC1`
 
**Журналы событий Windows**

`D:\Windows\System32\Winevt\Logs`
