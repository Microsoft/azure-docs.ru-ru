---
title: Проблемы с подключениями и сетями
description: В этой статье приведены часто задаваемые вопросы по подключениям и сетям для облачных служб Microsoft Azure.
ms.topic: article
ms.service: cloud-services
ms.date: 10/14/2020
ms.author: tagore
author: tanmaygore
ms.reviewer: mimckitt
ms.custom: ''
ms.openlocfilehash: c7b83c615e4ac19e10b5c4f6cc1a102206b1a39a
ms.sourcegitcommit: 6272bc01d8bdb833d43c56375bab1841a9c380a5
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/23/2021
ms.locfileid: "98742426"
---
# <a name="connectivity-and-networking-issues-for-azure-cloud-services-classic-frequently-asked-questions-faqs"></a>Проблемы подключения и сети для облачных служб Azure (классическая модель): часто задаваемые вопросы

> [!IMPORTANT]
> [Облачные службы Azure (Расширенная поддержка)](../cloud-services-extended-support/overview.md) — это новая модель развертывания на основе Azure Resource Manager для продукта облачных служб Azure.После этого изменения облачные службы Azure, работающие в модели развертывания на основе Service Manager Azure, были переименованы как облачные службы (классические), и все новые развертывания должны использовать [облачные службы (Расширенная поддержка)](../cloud-services-extended-support/overview.md).

В этой статье приведены часто задаваемые вопросы по подключениям и сетям для [облачных служб Azure](https://azure.microsoft.com/services/cloud-services). Дополнительные сведения о размерах см. в статье [Размеры для облачных служб](cloud-services-sizes-specs.md).

[!INCLUDE [support-disclaimer](../../includes/support-disclaimer.md)]

## <a name="i-cant-reserve-an-ip-in-a-multi-vip-cloud-service"></a>Не удается зарезервировать IP-адрес в облачной службе с несколькими виртуальными IP-адресами
Сначала убедитесь, что экземпляр виртуальной машины, для который вы пытаетесь зарезервировать IP-адрес, включен. Далее убедитесь, что вы используете зарезервированные IP-адреса как для промежуточного, так и для рабочего развертывания. *Не изменяйте* параметры во время обновления развертывания.

## <a name="how-do-i-use-remote-desktop-when-i-have-an-nsg"></a>Как использовать удаленный рабочий стол при наличии NSG?
Добавьте в NSG правила, разрешающие передачу трафика через порты **3389** и **20000**. Удаленный рабочий стол использует порт **3389**. В экземплярах облачной службы реализована балансировка нагрузки, поэтому вы не можете напрямую управлять подключением к экземпляру. Агенты *RemoteForwarder* и *RemoteAccess* управляют трафиком по протоколу удаленного рабочего стола (RDP) и позволяют клиенту отправлять файлы cookie по RDP и указывать отдельный экземпляр для подключения. Агентам *RemoteForwarder* и *RemoteAccess* требуется открытий порт **20000** При использовании группы безопасности сети он может быть заблокирован.

## <a name="can-i-ping-a-cloud-service"></a>Можно ли проверить связь с облачной службой?

Нет, только не с помощью обычного протокола проверки связи или ICMP. Протокол ICMP не разрешен в подсистеме балансировки нагрузки Azure.

Чтобы проверить подключение, рекомендуется выполнить проверку связи с портом. Хотя Ping.exe использует протокол ICMP, вы можете использовать другие инструменты, такие как PSPing, Nmap и telnet, которые позволяют проверить возможность подключения к конкретному порту TCP.

Дополнительные сведения см. в статье [Использование проверки связи с портом вместо ICMP для проверки подключения к виртуальной машине Azure](/archive/blogs/mast/use-port-pings-instead-of-icmp-to-test-azure-vm-connectivity).

## <a name="how-do-i-prevent-receiving-thousands-of-hits-from-unknown-ip-addresses-that-might-indicate-a-malicious-attack-to-the-cloud-service"></a>Как избежать получения тысяч вхождений с неизвестных IP-адресов, указывающих, что на облачную службу производится вредоносная атака?
Azure реализует многоуровневую сетевую безопасность для защиты служб платформы от распределенных атак типа "отказ в обслуживании" (DDoS). Система защиты Azure от DDoS-атак — часть непрерывного процесса мониторинга Azure, которая постоянно улучшается благодаря тестам на проникновение. Эта система защиты от DDoS-атак предназначена для защиты не только от атак извне, но и от других клиентов Azure. Дополнительные сведения см. в статье [безопасность сети Azure](https://download.microsoft.com/download/C/A/3/CA3FC5C0-ECE0-4F87-BF4B-D74064A00846/AzureNetworkSecurity_v3_Feb2015.pdf).

Вы также можете создать задачу при запуске для выборочного блокирования некоторых конкретных IP-адресов. Дополнительные сведения см. в разделе [Блокирование определенного IP-адреса](cloud-services-startup-tasks-common.md#block-a-specific-ip-address).

## <a name="when-i-try-to-rdp-to-my-cloud-service-instance-i-get-the-message-the-user-account-has-expired"></a>При попытке выполнить удаленное подключение к моему экземпляру облачной службы появляется сообщение "Срок действия этой учетной записи пользователя истек".
Вы можете получить сообщение "Срок действия этой учетной записи пользователя истек" при обходе даты истечения срока действия, которая настраивается в параметрах протокола удаленного рабочего стола. Можно изменить дату истечения срока действия на портале, выполнив следующие действия.

1. Войдите на [портал Azure](https://portal.azure.com), перейдите к облачной службе и выберите вкладку **Удаленный рабочий стол**.

2. Выберите **рабочий** или **промежуточный** слот развертывания.

3. Измените **срок действия на** дату, а затем сохраните конфигурацию.

Теперь вы сможете подключиться к своему компьютеру по протоколу удаленного рабочего стола.

## <a name="why-is-azure-load-balancer-not-balancing-traffic-equally"></a>Почему Azure Load Balancer не балансирует трафик одинаково?
Сведения о том, как работает внутренняя подсистема балансировки нагрузки, см. в записи блога о [новом режиме распределения Azure Load Balancer](https://azure.microsoft.com/blog/azure-load-balancer-new-distribution-mode/).

В основе алгоритма распределения лежит использование хэша 5 кортежей (исходный IP-адрес, порт источника, IP-адрес назначения, порт назначения и тип протокола) для сопоставления трафика с доступными серверами. Он позволяет закреплять IP-адреса только в рамках сеанса транспорта. Пакеты в одном сеансе TCP или UDP направляются на один экземпляр IP-адреса центра обработки данных (DIP) в конечной точке с балансировкой нагрузки. Когда клиент закрывает и снова открывает подключение или начинает новый сеанс с того же исходного IP-адреса, порт источника изменяется и перенаправляет трафик к другой конечной точке DIP.

## <a name="how-can-i-redirect-incoming-traffic-to-the-default-url-of-my-cloud-service-to-a-custom-url"></a>Как я могу перенаправить входящий трафик со стандартного URL-адреса облачной службы на пользовательский URL-адрес?

Модуль переопределения URL-адресов IIS можно использовать, чтобы перенаправлять трафик, поступающий на URL-адрес облачной службы по умолчанию (например, \*.cloudapp.net), к любому пользовательскому имени или URL-адресу. Так как модуль переопределения URL-адресов включен для веб-ролей по умолчанию, а его правила настроены в web.config приложения, они всегда доступны на виртуальной машине независимо от перезагрузки и повторного создания образов. Дополнительные сведения см. в следующих статьях:

- [Create rewrite rules for the URL Rewrite module](/iis/extensions/url-rewrite-module/creating-rewrite-rules-for-the-url-rewrite-module) (Создание правил переопределения для модуля переопределения URL-адресов).
- [Раздел об удалении связи по умолчанию](https://stackoverflow.com/questions/32286487/azure-website-how-to-remove-default-link?answertab=votes#tab-top)

## <a name="how-can-i-blockdisable-incoming-traffic-to-the-default-url-of-my-cloud-service"></a>Как заблокировать или отключить поступление входящего трафика на URL-адрес облачной службы, используемый по умолчанию?

Вы можете запретить поступление входящего трафика на стандартный URL-адрес или адрес с именем облачной службы (например, \*.cloudapp.net). В качестве заголовка узла задайте настраиваемое DNS-имя (например, www \. MyCloudService.com) в разделе Конфигурация привязки сайта в файле определения облачной службы (*. CSDEF), как указано ниже.

```xml
<?xml version="1.0" encoding="utf-8"?>
<ServiceDefinition name="AzureCloudServicesDemo" xmlns="http://schemas.microsoft.com/ServiceHosting/2008/10/ServiceDefinition" schemaVersion="2015-04.2.6">
    <WebRole name="MyWebRole" vmsize="Small">
        <Sites>
            <Site name="Web">
            <Bindings>
                <Binding name="Endpoint1" endpointName="Endpoint1" hostHeader="www.MyCloudService.com" />
            </Bindings>
            </Site>
        </Sites>
        <Endpoints>
            <InputEndpoint name="Endpoint1" protocol="http" port="80" />
        </Endpoints>
        <ConfigurationSettings>
            <Setting name="Microsoft.WindowsAzure.Plugins.Diagnostics.ConnectionString" />
        </ConfigurationSettings>
    </WebRole>
</ServiceDefinition>
```

Поскольку эта привязка к заголовку узла применяется при помощи CSDEF-файла, служба будет доступна только по адресу с указанием пользовательского имени www.MyCloudService.com. При этом все входящие запросы по адресу *.cloudapp.net будут завершаться ошибкой. Если вы используете пользовательский зонд SLB или внутреннюю подсистему балансировки нагрузки, блокировка стандартного URL-адреса или имени службы может повлиять на поведение этих систем.

## <a name="how-can-i-make-sure-the-public-facing-ip-address-of-a-cloud-service-never-changes"></a>Как можно гарантировать, что общедоступный IP-адрес облачной службы никогда не будет изменяться?

Чтобы гарантировать, что общедоступный IP-адрес облачной службы (также называемый виртуальным VIP) не изменится, чтобы его можно было утверждать с помощью нескольких конкретных клиентов, рекомендуется связать с ним зарезервированные IP-адреса. Иначе предоставляемый Azure виртуальный IP-адрес удаляется из подписки, когда вы удаляете развертывание. Для успешного переключения виртуального IP-адреса вам потребуется присвоить зарезервированные IP-адреса и рабочей, и промежуточной средам. В противном случае произойдет сбой операции замены. Чтобы зарезервировать IP-адрес и связать его с облачными службами, выполните инструкции в следующих статьях:

- [Резервирование IP-адреса существующей облачной службы](/previous-versions/azure/virtual-network/virtual-networks-reserved-public-ip#reserve-the-ip-address-of-an-existing-cloud-service)
- [Связывание зарезервированного IP-адреса с облачной службой с помощью файла конфигурации службы](/previous-versions/azure/virtual-network/virtual-networks-reserved-public-ip#associate-a-reserved-ip-to-a-cloud-service-by-using-a-service-configuration-file)

Если у вас несколько экземпляров каждой роли, связывание зарезервированного IP-адреса с облачной службой не будет вызывать простоев. Кроме того, можно добавить диапазон IP-адресов центра обработки данных Azure в список разрешений. Все диапазоны IP-адресов Azure можно найти в [Центре загрузки Майкрософт](https://www.microsoft.com/en-us/download/details.aspx?id=41653).

Этот файл содержит диапазоны IP-адресов (включая диапазоны вычисления, хранения и SQL), используемые в центрах обработки данных Azure. Обновленный файл публикуется еженедельно, что отражает развернутые в настоящее время диапазоны и все предстоящие изменения IP-адресов. Новые диапазоны, появившиеся в файле, не будут использоваться в центрах обработки данных по крайней мере одну неделю. Скачивайте новый XML-файл каждую неделю и вносите соответствующие изменения на своем сайте, чтобы правильно определять службы, выполняемые в Azure. Пользователи Azure ExpressRoute могут заметить, что этот файл используется для того, чтобы обновлять объявление BGP пространства Azure в первую неделю каждого месяца.

## <a name="how-can-i-use-azure-resource-manager-virtual-networks-with-cloud-services"></a>Как использовать виртуальные сети Azure Resource Manager совместно с облачными службами?

Облачные службы нельзя разместить в виртуальных сетях Azure Resource Manager. Виртуальные сети с развертыванием Resource Manager и классическим развертыванием можно соединить через пиринг. Дополнительные сведения см. в статье [Пиринг между виртуальными сетями](../virtual-network/virtual-network-peering-overview.md).


## <a name="how-can-i-get-the-list-of-public-ips-used-by-my-cloud-services"></a>Как получить список общедоступных IP-адресов, используемых моими облачными службами?

Можно использовать следующий сценарий PS, чтобы получить список общедоступных IP-адресов, используемых облачными службами в вашей подписке.

```powershell
$services = Get-AzureService  | Group-Object -Property ServiceName

foreach ($service in $services)
{
    "Cloud Service '$($service.Name)'"

    $deployment = Get-AzureDeployment -ServiceName $service.Name
    "VIP - " +  $deployment.VirtualIPs[0].Address
    "================================="
}
```