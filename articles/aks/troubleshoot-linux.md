---
title: Средства оценки производительности Linux
titleSuffix: Azure Kubernetes Service
description: Узнайте, как использовать средства производительности Linux для устранения распространенных проблем при использовании службы Kubernetes Azure (AKS).
services: container-service
author: alexeldeib
ms.service: container-service
ms.topic: troubleshooting
ms.date: 02/10/2020
ms.author: aleldeib
ms.openlocfilehash: 74f65780594c7bc938ed6d59437473c4363e5848
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "90982034"
---
# <a name="linux-performance-troubleshooting"></a>Устранение неполадок производительности в Linux

Нехватка ресурсов на компьютерах Linux является распространенной проблемой и может проявляться с помощью самых разнообразных симптомов. В этом документе представлен общий обзор средств, предназначенных для диагностики таких проблем.

Многие из этих средств принимают интервал, по истечении которого создаются последовательные выходные данные. Этот формат вывода, как правило, делает шаблоны более простыми. При принятии примера вызов будет включать в себя `[interval]` .

Многие из этих средств имеют обширный журнал и широкий набор параметров конфигурации. На этой странице предоставляется только простое подмножество вызовов для выделения распространенных проблем. Канонический источник информации всегда является справочной документацией для каждого конкретного инструмента. Эта документация будет намного более тщательнее, чем предоставлено здесь.

## <a name="guidance"></a>Руководство

Будьте систематически в своем подходе для изучения проблем с производительностью. Используются два распространенных подхода (использование, насыщенность, ошибки) и красный (Rate, Errors, Duration). Красный цвет обычно используется в контексте служб для мониторинга на основе запросов. Обычно используется для наблюдения за ресурсами: для каждого ресурса на компьютере, отслеживания использования, насыщенности и ошибок. Четыре основных типа ресурсов на любом компьютере — ЦП, память, диск и сеть. Высокий уровень использования, насыщенность или частота ошибок для любого из этих ресурсов указывает на возможную проблему в системе. При возникновении проблемы проверьте основную причину: почему задержка ввода-вывода диска высока? Регулируется ли диск или номер SKU виртуальной машины? Какие процессы записываются на устройства и какие файлы?

Некоторые примеры распространенных проблем и индикаторов для их диагностики:
- Регулирование числа операций ввода-вывода в секунду. Используйте iostat для измерения операций ввода-вывода на устройстве. Убедитесь, что ни один диск не превышает предел, а сумма для всех дисков меньше, чем ограничение для виртуальной машины.
- Регулирование полосы пропускания. Используйте iostat как для операций ввода-вывода, но измеряйте пропускную способность чтения/записи. Убедитесь, что для каждого устройства и общей пропускной способности ниже ограничения пропускной способности.
- Нехватка SNAT: Эта возможность может служить в качестве высокоактивных (исходящих) подключений в САР. 
- Потеря пакетов. это может измеряться прокси-сервером с помощью счетчика повторной передачи TCP по отношению к количеству отправленных и полученных данных. `sar` `netstat` Эти сведения могут быть показаны и в, и в.

## <a name="general"></a>Общие сведения

Эти средства предназначены для общего назначения и охватывают основные сведения о системе. Они являются хорошей отправной точкой для дальнейшего изучения.

### <a name="uptime"></a>просто

```
$ uptime
 19:32:33 up 17 days, 12:36,  0 users,  load average: 0.21, 0.77, 0.69
```

время бесперебойной работы обеспечивается временем непрерывной работы системы и 1, 5 и 15-минутными средними нагрузками. Эти средние нагрузки приблизительно соответствуют потокам, выполняющим работу, или ожидают завершения неработающей работы. В абсолютных значениях может быть трудно интерпретировать, но с течением времени они могут сообщить нам полезную информацию:

- 1-минутное среднее > 5-минутное среднее означает увеличение нагрузки.
- 1-минутное среднее < 5-минутное среднее означает, что нагрузка уменьшается.

время бесперебойной работы может также засветить причину недоступности информации: проблема может быть решена самостоятельно или с помощью перезапуска, прежде чем пользователь сможет получить доступ к компьютеру.

Среднее время загрузки, превышающее количество доступных потоков ЦП, может указывать на проблемы с производительностью при данной рабочей нагрузке.

### <a name="dmesg"></a>дмесг

```
$ dmesg | tail 
$ dmesg --level=err | tail
```

дмесг создает дамп буфера ядра. Такие события, как Умкилл, добавляют запись в буфер ядра. Поиск Умкилл или других сообщений о нехватке ресурсов в журналах дмесг является строгим индикатором проблемы.

### <a name="top"></a>top

```
$ top
Tasks: 249 total,   1 running, 158 sleeping,   0 stopped,   0 zombie
%Cpu(s):  2.2 us,  1.3 sy,  0.0 ni, 95.4 id,  1.0 wa,  0.0 hi,  0.2 si,  0.0 st
KiB Mem : 65949064 total, 43415136 free,  2349328 used, 20184600 buff/cache
KiB Swap:        0 total,        0 free,        0 used. 62739060 avail Mem

   PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND
116004 root      20   0  144400  41124  27028 S  11.8  0.1 248:45.45 coredns
  4503 root      20   0 1677980 167964  89464 S   5.9  0.3   1326:25 kubelet
     1 root      20   0  120212   6404   4044 S   0.0  0.0  48:20.38 systemd
     ...
```

`top` предоставляет общий обзор текущего состояния системы. Заголовки предоставляют некоторые полезные статистические сведения:

- состояние задач: работает, находится в спящем режиме, остановлено.
- Использование ЦП, в этом случае в основном показывает время простоя.
- Общая, свободная и используемая системная память.

`top` могут пропускать кратковременные процессы; альтернативные варианты `htop` , такие как и, `atop` предоставляют аналогичные интерфейсы при устранении некоторых из этих недостатков.

## <a name="cpu"></a>ЦП

Эти средства предоставляют сведения об использовании ЦП. Это особенно удобно при использовании пошагового вывода, где шаблоны легко распознать.

### <a name="mpstat"></a>мпстат

```
$ mpstat -P ALL [interval]
Linux 4.15.0-1064-azure (aks-main-10212767-vmss000001)  02/10/20        _x86_64_        (8 CPU)

19:49:03     CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
19:49:04     all    1.01    0.00    0.63    2.14    0.00    0.13    0.00    0.00    0.00   96.11
19:49:04       0    1.01    0.00    1.01   17.17    0.00    0.00    0.00    0.00    0.00   80.81
19:49:04       1    1.98    0.00    0.99    0.00    0.00    0.00    0.00    0.00    0.00   97.03
19:49:04       2    1.01    0.00    0.00    0.00    0.00    1.01    0.00    0.00    0.00   97.98
19:49:04       3    0.00    0.00    0.99    0.00    0.00    0.99    0.00    0.00    0.00   98.02
19:49:04       4    1.98    0.00    1.98    0.00    0.00    0.00    0.00    0.00    0.00   96.04
19:49:04       5    1.00    0.00    1.00    0.00    0.00    0.00    0.00    0.00    0.00   98.00
19:49:04       6    1.00    0.00    1.00    0.00    0.00    0.00    0.00    0.00    0.00   98.00
19:49:04       7    1.98    0.00    0.99    0.00    0.00    0.00    0.00    0.00    0.00   97.03
```

`mpstat` выводит похожие сведения о ЦП в начало, но с разбивкой по потокам ЦП. Просмотр всех ядер одновременно может быть полезен для обнаружения высокой несбалансированной загрузки ЦП, например, когда одно потоковое приложение использует одно ядро при использовании в 100%. Эта проблема может быть сложнее в случае агрегирования всех процессоров в системе.

### <a name="vmstat"></a>vmstat

```
$ vmstat [interval]
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 2  0      0 43300372 545716 19691456    0    0     3    50    3    3  2  1 95  1  0
```

`vmstat` предоставляет аналогичные сведения `mpstat` и `top` перечисление количества процессов, ожидающих ЦП (столбец r), статистику памяти и процент времени ЦП, затраченного на каждое рабочее состояние.

## <a name="memory"></a>Память

Память очень важна, и, к счастью, ресурс, который нужно отвести. Некоторые средства могут сообщать о ЦП и памяти, например `vmstat` . Но такие средства `free` , как, могут быть полезны для быстрой отладки.

### <a name="free"></a>free

```
$ free -m
              total        used        free      shared  buff/cache   available
Mem:          64403        2338       42485           1       19579       61223
Swap:             0           0           0
```

`free` представляет основные сведения о общем объеме памяти, а также об используемой и свободной памяти. `vmstat` может оказаться более полезным даже для базового анализа памяти, так как его способность предоставлять последовательные выходные данные.

## <a name="disk"></a>Диск

Эти средства измеряют дисковые операции ввода-вывода, ожидания очереди и общую пропускную способность. 

### <a name="iostat"></a>iostat

```
$ iostat -xy [interval] [count]
$ iostat -xy 1 1
Linux 4.15.0-1064-azure (aks-main-10212767-vmss000001)  02/10/20        _x86_64_        (8 CPU)

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           3.42    0.00    2.92    1.90    0.00   91.76

Device:         rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util
loop0             0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00    0.00    0.00   0.00   0.00
sdb               0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00    0.00    0.00   0.00   0.00
sda               0.00    56.00    0.00   65.00     0.00   504.00    15.51     0.01    3.02    0.00    3.02   0.12   0.80
scd0              0.00     0.00    0.00    0.00     0.00     0.00     0.00     0.00    0.00    0.00    0.00   0.00   0.00
```

`iostat` предоставляет подробную информацию об использовании диска. Этот вызов проходит `-x` расширенную статистику, `-y` пропуская начальные средние выходные данные системы печати с момента загрузки и `1 1` указывает, что требуется интервал в 1 секунду, завершающий после одного блока выходных данных. 

`iostat` предоставляет много полезной статистики:

- `r/s` и `w/s` — операций чтения в секунду и операций записи в секунду. Сумма этих значений — операции ввода-вывода.
- `rkB/s` и `wkB/s` находятся в килобайтах на чтение и запись в секунду. Сумма этих значений — пропускная способность.
- `await` Среднее время иоваит в миллисекундах для запросов в очереди.
- `avgqu-sz` Средний размер очереди за указанный интервал.

На виртуальной машине Azure:

- сумма `r/s` и `w/s` для отдельного блочного устройства не может превышать пределы SKU диска.
- сумма `rkB/s` и `wkB/s`  для отдельного блочного устройства не может превышать пределы SKU диска
- сумма `r/s` и `w/s` для всех блочных устройств не может превышать пределы номера SKU виртуальной машины.
- сумма  `rkB/s` и "wkB/с" для всех блочных устройств не может превышать пределы номера SKU виртуальной машины.

Обратите внимание, что диск ОС считается управляемым диском наименьшего номера SKU, соответствующего его емкости. Например, диск ОС 1024GB соответствует диску P30. На временных дисках ОС и временных дисках отсутствуют ограничения на отдельные диски. они ограничиваются только полными ограничениями виртуальной машины.

Ненулевые значения Await или авгку-SZ также являются хорошими показателями состязаний.

## <a name="network"></a>Сеть

Эти средства измеряют сетевую статистику, например пропускную способность, сбои передачи и использование. Более глубокий анализ может предоставить детализированную статистику TCP о перегрузке и отброшенных пакетах.

### <a name="sar"></a>САР

```
$ sar -n DEV [interval]
22:36:57        IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s   txcmp/s  rxmcst/s   %ifutil
22:36:58      docker0      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
22:36:58    azv604be75d832      1.00      9.00      0.06      1.04      0.00      0.00      0.00      0.00
22:36:58       azure0     68.00     79.00     27.79     52.79      0.00      0.00      0.00      0.00
22:36:58    azv4a8e7704a5b    202.00    207.00     37.51     21.86      0.00      0.00      0.00      0.00
22:36:58    azve83c28f6d1c     21.00     30.00     24.12      4.11      0.00      0.00      0.00      0.00
22:36:58         eth0    314.00    321.00     70.87    163.28      0.00      0.00      0.00      0.00
22:36:58    azva3128390bff     12.00     20.00      1.14      2.29      0.00      0.00      0.00      0.00
22:36:58    azvf46c95ddea3     10.00     18.00     31.47      1.36      0.00      0.00      0.00      0.00
22:36:58       enP1s1     74.00    374.00     29.36    166.94      0.00      0.00      0.00      0.00
22:36:58           lo      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
22:36:58    azvdbf16b0b2fc      9.00     19.00      3.36      1.18      0.00      0.00      0.00      0.00
```

`sar` — Это мощный инструмент для широкого спектра анализа. Хотя в этом примере используется возможность измерять статистику по сети, она обладает одинаковыми возможностями для измерения потребления ресурсов ЦП и памяти. В этом примере вызывается `sar` с `-n` флагом, чтобы указать `DEV` ключевое слово (сетевое устройство), которое показывает пропускную способность сети для устройства.

- Сумма `rxKb/s` и `txKb/s` Общая пропускная способность для данного устройства. Если это значение превышает ограничение для подготовленной сетевой карты Azure, рабочие нагрузки на компьютере будут испытывать повышенную задержку в сети.
- `%ifutil` измеряет использование указанного устройства. Так как это значение приближается к 100%, рабочие нагрузки будут испытывать повышенную задержку в сети.

```
$ sar -n TCP,ETCP [interval]
Linux 4.15.0-1064-azure (aks-main-10212767-vmss000001)  02/10/20        _x86_64_        (8 CPU)

22:50:08     active/s passive/s    iseg/s    oseg/s
22:50:09         2.00      0.00     19.00     24.00

22:50:08     atmptf/s  estres/s retrans/s isegerr/s   orsts/s
22:50:09         0.00      0.00      0.00      0.00      0.00

Average:     active/s passive/s    iseg/s    oseg/s
Average:         2.00      0.00     19.00     24.00

Average:     atmptf/s  estres/s retrans/s isegerr/s   orsts/s
Average:         0.00      0.00      0.00      0.00      0.00
```

Этот вызов `sar` использует `TCP,ETCP` Ключевые слова для проверки TCP-подключений. Третий столбец последней строки "перетранзакции" — это число повторных передач TCP в секунду. Высокие значения этого поля указывают на ненадежное сетевое подключение. В первой и третьей строках "Active" означает подключение, созданное на локальном устройстве, а "удаленный" — входящее подключение.  Распространенной проблемой в Azure является нехватка портов SNAT, что `sar` поможет обнаружить. Нехватка портов SNAT будет выглядеть как высокие значения "Active", так как проблема вызвана высокой частотой исходящих, локально инициированных подключений TCP.

Как `sar` принимает интервал, он выводит выходные данные, а затем выводит конечные строки выходных данных, содержащие средние результаты вызова.

### <a name="netstat"></a>netstat

```
$ netstat -s
Ip:
    71046295 total packets received
    78 forwarded
    0 incoming packets discarded
    71046066 incoming packets delivered
    83774622 requests sent out
    40 outgoing packets dropped
Icmp:
    103 ICMP messages received
    0 input ICMP message failed.
    ICMP input histogram:
        destination unreachable: 103
    412802 ICMP messages sent
    0 ICMP messages failed
    ICMP output histogram:
        destination unreachable: 412802
IcmpMsg:
        InType3: 103
        OutType3: 412802
Tcp:
    11487089 active connections openings
    592 passive connection openings
    1137 failed connection attempts
    404 connection resets received
    17 connections established
    70880911 segments received
    95242567 segments send out
    176658 segments retransmited
    3 bad segments received.
    163295 resets sent
Udp:
    164968 packets received
    84 packets to unknown port received.
    0 packet receive errors
    165082 packets sent
UdpLite:
TcpExt:
    5 resets received for embryonic SYN_RECV sockets
    1670559 TCP sockets finished time wait in fast timer
    95 packets rejects in established connections because of timestamp
    756870 delayed acks sent
    2236 delayed acks further delayed because of locked socket
    Quick ack mode was activated 479 times
    11983969 packet headers predicted
    25061447 acknowledgments not containing data payload received
    5596263 predicted acknowledgments
    19 times recovered from packet loss by selective acknowledgements
    Detected reordering 114 times using SACK
    Detected reordering 4 times using time stamp
    5 congestion windows fully recovered without slow start
    1 congestion windows partially recovered using Hoe heuristic
    5 congestion windows recovered without slow start by DSACK
    111 congestion windows recovered without slow start after partial ack
    73 fast retransmits
    26 retransmits in slow start
    311 other TCP timeouts
    TCPLossProbes: 198845
    TCPLossProbeRecovery: 147
    480 DSACKs sent for old packets
    175310 DSACKs received
    316 connections reset due to unexpected data
    272 connections reset due to early user close
    5 connections aborted due to timeout
    TCPDSACKIgnoredNoUndo: 8498
    TCPSpuriousRTOs: 1
    TCPSackShifted: 3
    TCPSackMerged: 9
    TCPSackShiftFallback: 177
    IPReversePathFilter: 4
    TCPRcvCoalesce: 1501457
    TCPOFOQueue: 9898
    TCPChallengeACK: 342
    TCPSYNChallenge: 3
    TCPSpuriousRtxHostQueues: 17
    TCPAutoCorking: 2315642
    TCPFromZeroWindowAdv: 483
    TCPToZeroWindowAdv: 483
    TCPWantZeroWindowAdv: 115
    TCPSynRetrans: 885
    TCPOrigDataSent: 51140171
    TCPHystartTrainDetect: 349
    TCPHystartTrainCwnd: 7045
    TCPHystartDelayDetect: 26
    TCPHystartDelayCwnd: 862
    TCPACKSkippedPAWS: 3
    TCPACKSkippedSeq: 4
    TCPKeepAlive: 62517
IpExt:
    InOctets: 36416951539
    OutOctets: 41520580596
    InNoECTPkts: 86631440
    InECT0Pkts: 14
```

`netstat` может интроспект широкий спектр сетевой статистики, вызываемую с выходом сводных данных. В зависимости от проблемы здесь есть много полезных полей. Одно полезное поле в разделе TCP — «неудачные попытки подключения». Это может быть указанием нехватки портов SNAT или других проблем, связанных с исходящими подключениями. Высокая частота передаваемых сегментов (также в разделе TCP) может указывать на проблемы с доставкой пакетов. 
