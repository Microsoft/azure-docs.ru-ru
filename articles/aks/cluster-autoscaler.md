---
title: Использование средства автомасштабирования кластера в Службе контейнеров Azure
description: Узнайте, как использовать средство автомасштабирования кластера для автомасштабирования кластера в Службе контейнеров Azure в соответствии с требованиями приложения.
services: container-service
ms.topic: article
ms.date: 07/18/2019
ms.openlocfilehash: 9caf56545efc6aefae525e28614d39705c00c21e
ms.sourcegitcommit: c27a20b278f2ac758447418ea4c8c61e27927d6a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/03/2021
ms.locfileid: "101742574"
---
# <a name="automatically-scale-a-cluster-to-meet-application-demands-on-azure-kubernetes-service-aks"></a>Автоматическое масштабирование кластера в соответствии с требованиями приложения в Службе контейнеров Azure

Чтобы удовлетворить растущие требования приложения к Службе контейнеров Azure (AKS), вы можете изменить число узлов, на которых выполняются рабочие нагрузки. Компоненты кластера автомасштабирования могут отслеживать нехватку назначенных pod в кластере, связанную с ограничениями на ресурсы. При обнаружении проблем число узлов в пуле увеличивается в соответствии с требованиями приложения. Также регулярно проверяется наличие узлов с малым числом запущенных pod, при их обнаружении число узлов соответствующим образом снижается. Такая возможность автоматически масштабировать количество узлов в кластере AKS обеспечивает эффективное и экономное использование кластера.

В этой статье показано, как включить и администрировать средство автомасштабирования для кластера AKS.

## <a name="before-you-begin"></a>Перед началом

В этой статье предполагается, что вы используете Azure CLI версии 2.0.76 или более поздней. Чтобы узнать версию, выполните команду `az --version`. Если вам необходимо выполнить установку или обновление, см. статью [Установка Azure CLI 2.0][azure-cli-install].

## <a name="about-the-cluster-autoscaler"></a>Сведения о средстве автомасштабирования кластера

Чтобы учитывать постоянно меняющиеся требования приложения, например регулярное изменение нагрузки в течение дня или недели, часто требуется механизм автомасштабирования кластера. Для кластеров AKS существуют два способа горизонтального уменьшения масштаба:

* **Средство автомасштабирования кластера** отслеживает невозможность назначить на узел новые pod, связанную с ограниченными ресурсами. При возникновении такой ситуации число узлов в кластере автоматически повышается.
* **Средство горизонтального автомасштабирования pod** использует сервер метрик в кластере Kubernetes для отслеживания потребностей pod в ресурсах. Если приложению нужно больше ресурсов, количество pod автоматически увеличивается в соответствии с требованиями.

![Средство автомасштабирования кластера и средство горизонтального автомасштабирования pod часто используются вместе, чтобы учитывать любые изменения требований приложения.](media/autoscaler/cluster-autoscaler.png)

Оба этих средства могут уменьшать количество pod и узлов, когда в них отпадает надобность. Средство автомасштабирования кластера уменьшает количество узлов, если в течение определенного периода времени существует неиспользуемая емкость. Pod на узле, который будет удаляться, безопасно перемещаются средством автомасштабирования в другое расположение в том же кластере. Средство автомасштабирования кластера не сможет уменьшить масштаб, если pod невозможно переместить, например в следующих ситуациях:

* если pod создан напрямую на узле, а не через объект контроллера, например в наборе развертывания или реплик;
* если бюджет неработоспособности pod имеет слишком строгие условия и не допускает снижение числа pod ниже определенного порогового значения;
* если pod использует селекторы узла или свойства удаления сходства, которые невозможно выполнить, так как они запланированы на другом узле.

Дополнительные сведения о причинах, которые препятствуют средству автомасштабирования вертикально уменьшать масштаб, описаны в разделе [Какие типы pod могут помешать средству автомасштабирования кластера удалить узел?][autoscaler-scaledown]

Средство автомасштабирования кластера использует параметры запуска для выбора интервалов времени между событиями масштабирования, пороговых значений для ресурсов и т. п. Дополнительные сведения о том, какие параметры использует Автомасштабирование кластера, см. в разделе [Использование профиля автомасштабирования](#using-the-autoscaler-profile).

Средство автомасштабирования кластера и средство горизонтального автомасштабирования могут работать вместе, и часто оба средства развертываются в кластере. При совместной работе средство горизонтального автомасштабирования pod берет на себя управление числом pod, необходимых для удовлетворения требований приложения. Средство автомасштабирования кластера контролирует, в свою очередь, количество узлов для работы запланированного числа pod.

> [!NOTE]
> При использовании средства автомасштабирования кластера отключается возможность масштабирования вручную. Позвольте этому средству самостоятельно определять необходимое количество узлов. Если вы предпочитаете выполнять масштабирование кластера вручную, [отключите средство автомасштабирования кластера](#disable-the-cluster-autoscaler).

## <a name="create-an-aks-cluster-and-enable-the-cluster-autoscaler"></a>Создание кластера AKS и включение средства автомасштабирования кластера

Если вам нужен новый кластер AKS, выполните команду [az aks create][az-aks-create]. Чтобы включить и настроить Автомасштабирование кластера в пуле узлов для кластера, используйте `--enable-cluster-autoscaler` параметр и укажите узел `--min-count` и `--max-count` .

> [!IMPORTANT]
> Компонент Kubernetes является средством автомасштабирования кластера. Хотя в кластере AKS используется масштабируемый набор виртуальных машин для узлов, не включайте и не изменяйте вручную параметры автомасштабирования масштабируемого набора на портале Azure или с помощью Azure CLI. Разрешите средству автомасштабирования кластера Kubernetes устанавливать необходимые параметры масштабирования. Дополнительные сведения см. в разделе часто задаваемых вопросов [Можно ли изменять теги и другие свойства ресурсов AKS в группе ресурсов узла?][aks-faq-node-resource-group].

В следующем примере создается кластер AKS с одним пулом узлов на базе масштабируемого набора виртуальных машин. Он также включает средство автомасштабирования кластера в пуле узлов для этого кластера и задает минимальное (*1*) и максимальное (*3*) число узлов.

```azurecli-interactive
# First create a resource group
az group create --name myResourceGroup --location eastus

# Now create the AKS cluster and enable the cluster autoscaler
az aks create \
  --resource-group myResourceGroup \
  --name myAKSCluster \
  --node-count 1 \
  --vm-set-type VirtualMachineScaleSets \
  --load-balancer-sku standard \
  --enable-cluster-autoscaler \
  --min-count 1 \
  --max-count 3
```

Создание кластера и настройка параметров автомасштабирования кластера занимает несколько минут.

## <a name="update-an-existing-aks-cluster-to-enable-the-cluster-autoscaler"></a>Обновление существующего кластера AKS для включения автомасштабирования кластера

Используйте команду [AZ AKS Update][az-aks-update] , чтобы включить и настроить Автомасштабирование кластера в пуле узлов для существующего кластера. Используйте `--enable-cluster-autoscaler` параметр и укажите узел `--min-count` и `--max-count` .

> [!IMPORTANT]
> Компонент Kubernetes является средством автомасштабирования кластера. Хотя в кластере AKS используется масштабируемый набор виртуальных машин для узлов, не включайте и не изменяйте вручную параметры автомасштабирования масштабируемого набора на портале Azure или с помощью Azure CLI. Разрешите средству автомасштабирования кластера Kubernetes устанавливать необходимые параметры масштабирования. Дополнительные сведения см. в разделе часто задаваемых вопросов [Можно ли изменять теги и другие свойства ресурсов AKS в группе ресурсов узла?][aks-faq-node-resource-group].

В следующем примере обновляется существующий кластер AKS, чтобы включить Автомасштабирование кластера в пуле узлов для кластера и задать минимум *1* и максимум *3* узла:

```azurecli-interactive
az aks update \
  --resource-group myResourceGroup \
  --name myAKSCluster \
  --enable-cluster-autoscaler \
  --min-count 1 \
  --max-count 3
```

Обновление кластера и Настройка параметров автомасштабирования кластера займет несколько минут.

## <a name="change-the-cluster-autoscaler-settings"></a>Изменение параметров средства автомасштабирования кластера

> [!IMPORTANT]
> Если в кластере AKS имеется несколько пулов узлов, перейдите в [раздел об автомасштабировании с несколькими пулами агентов](#use-the-cluster-autoscaler-with-multiple-node-pools-enabled). Для изменения свойств конкретного пула узлов в кластерах с несколькими пулами агентов вместо `az aks` необходимо использовать набор команд `az aks nodepool`.

На предыдущем шаге при создании кластера AKS или обновлении имеющегося пула узлов мы указывали для средства автомасштабирования кластера минимальное число узлов *1* и максимальное число узлов *3*. По мере изменения требований приложения вы можете скорректировать настроенное количество узлов для средства автомасштабирования кластера.

Чтобы изменить число узлов, используйте команду [az aks update][az-aks-update].

```azurecli-interactive
az aks update \
  --resource-group myResourceGroup \
  --name myAKSCluster \
  --update-cluster-autoscaler \
  --min-count 1 \
  --max-count 5
```

В приведенном выше примере число узлов в средстве автомасштабирования кластера обновляется в пуле с одним узлом в *myAKSCluster* до минимального (*1*) и максимального (*5*) значений.

> [!NOTE]
> Автомасштабирование кластера позволяет принимать решения о масштабировании на основе минимального и максимального значений счетчиков для каждого пула узлов, но не применяет их после обновления минимального или максимального значения счетчиков. Например, если для текущего числа узлов задано значение 5, то при значении параметра число минут до уровня "3" не будет немедленно масштабироваться пул до 5. Если минимальное количество в пуле узлов имеет значение, превышающее текущее число узлов, то новые параметры min или Max будут учитываться при наличии достаточного количества непланируемых модулей, требующих 2 новых дополнительных узла и активации события автомасштабирования. После события Scale учитываются новые ограничения счетчика.

Отслеживайте производительность приложений и служб, а затем корректируйте диапазон числа узлов для средства автомасштабирования кластера в соответствии с требуемой производительностью.

## <a name="using-the-autoscaler-profile"></a>Использование профиля средства автомасштабирования

Вы также можете точнее настроить средство автомасштабирования кластера, изменив значения по умолчанию в профиле средства автомасштабирования для всего кластера. Например, событие вертикального уменьшения масштаба происходит после 10-минутного снижения уровня использования узлов. Если у вас есть рабочие нагрузки, которые выполняются каждые 15 минут, может потребоваться изменить профиль средства автомасштабирования, чтобы масштаб уменьшался вертикально, если низкий уровень использования наблюдается дольше 15 или 20 минут. Если не заданы другие параметры, при включении средства автомасштабирования кластера используется профиль по умолчанию. Следующие параметры профиля автомасштабирования кластера можно обновить.

| Параметр                          | Описание                                                                              | Значение по умолчанию |
|----------------------------------|------------------------------------------------------------------------------------------|---------------|
| scan-interval                    | Частота повторной оценки использования кластера для вертикального увеличения или уменьшения масштаба                                    | 10 с    |
| scale-down-delay-after-add       | Интервал между моментом вертикального увеличения масштаба и возобновлением оценки для его вертикального уменьшения                               | 10 минут.    |
| scale-down-delay-after-delete    | Интервал между моментом удаления узла и возобновлением оценки для вертикального уменьшения масштаба                          | scan-interval |
| scale-down-delay-after-failure   | Интервал между сбоем вертикального уменьшения масштаба и возобновлением оценки для его вертикального уменьшения                     | 3 минуты     |
| scale-down-unneeded-time         | Время простоя узла, по истечении которого допустимо вертикальное уменьшение масштаба                  | 10 минут.    |
| scale-down-unready-time          | Время простоя неготового узла, по истечении которого допустимо вертикальное уменьшение масштаба         | 20 минут    |
| scale-down-utilization-threshold | Уровень использования узла (сумма затребованных ресурсов, деленная на емкость), ниже которого допустимо вертикальное уменьшение масштаба | 0,5 |
| max-graceful-termination-sec     | Максимальное количество секунд, в течение которых модуль автомасштабирования кластера ожидает завершения работы Pod при попытке масштабирования узла | 600 секунд   |
| balance-similar-node-groups      | Обнаруживает похожие пулы узлов и распределяет количество узлов между ними                 | false         |
| Expander                         | Тип [расширения](https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md#what-are-expanders) пула узлов, который будет использоваться при увеличении масштаба. Возможные значения: `most-pods` , `random` , `least-waste` , `priority` | random | 
| пропуск — узлы с локальным хранилищем    | Если значение true, автоматическое масштабирование кластера никогда не удалит узлы с модулями Pod с локальным хранилищем, например EmptyDir или Хостпас | true |
| пропуск-Nodes-с-System-Pod      | Если значение true, автоматическое масштабирование кластера никогда не удалит узлы с модулями Pod из KUBE-System (за исключением управляющего набора или зеркального набора данных) | true | 
| Max-Empty-групповое удаление            | Максимальное количество пустых узлов, которые могут быть удалены одновременно                       | 10 узлов      |
| New-Pod — масштабирование — задержка           | В таких сценариях, как масштабируемость или Пакетная шкала, которая не должна действовать ЦС, прежде чем планировщик kubernetes может запланировать все модули Pod, вы можете сообщить центру сертификации, что они будут игнорировать незапланированные модули, прежде чем они будут иметь определенный возраст.                                                                                                                | 0 секунд    |
| Max-Total-непрочтенные-проценты     | Максимальный процент непрочитанных узлов в кластере. После превышения этого процента ЦС останавливает операции | 45 % |
| Max-node-подготавливать время          | Максимальное время, в течение которого Автомасштабирование ожидает подготовку узла                           | 15 минут    |   
| ОК — всего — не прочитано-Count           | Число разрешенных непрочтенных узлов, независимо от значения MAX-Total-unread-Percentage            | 3 узла       |

> [!IMPORTANT]
> Профиль средства автомасштабирования кластера влияет на все пулы узлов, которые используют это средство. Такой профиль нельзя задать отдельно для каждого пула узлов.
>
> Для профиля автомасштабирования кластера требуется версия *2.11.1* или более поздняя Azure CLI. Если вам необходимо выполнить установку или обновление, см. статью [Установка Azure CLI 2.0][azure-cli-install].

### <a name="set-the-cluster-autoscaler-profile-on-an-existing-aks-cluster"></a>Назначение профиля средства автомасштабирования кластера имеющемуся кластеру AKS

Чтобы назначить профиль средства автомасштабирования кластера своему кластеру, используйте команду [az aks update][az-aks-update-preview] с параметром *cluster-autoscaler-profile*. В следующем примере для интервала сканирования в профиле задается значение 30 с.

```azurecli-interactive
az aks update \
  --resource-group myResourceGroup \
  --name myAKSCluster \
  --cluster-autoscaler-profile scan-interval=30s
```

При включении средства автомасштабирования кластера в пулах узлов в кластере для таких кластеров также будет использоваться профиль этого средства. Пример:

```azurecli-interactive
az aks nodepool update \
  --resource-group myResourceGroup \
  --cluster-name myAKSCluster \
  --name mynodepool \
  --enable-cluster-autoscaler \
  --min-count 1 \
  --max-count 3
```

> [!IMPORTANT]
> При настройке профиля средства автомасштабирования кластера для всех имеющихся пулов узлов с включенным средством автомасштабирования кластера будет незамедлительно применен такой профиль.

### <a name="set-the-cluster-autoscaler-profile-when-creating-an-aks-cluster"></a>Настройка профиля средства автомасштабирования кластера при создании кластера AKS

При создании кластера можно также использовать параметр *cluster-autoscaler-profile*. Пример:

```azurecli-interactive
az aks create \
  --resource-group myResourceGroup \
  --name myAKSCluster \
  --node-count 1 \
  --enable-cluster-autoscaler \
  --min-count 1 \
  --max-count 3 \
  --cluster-autoscaler-profile scan-interval=30s
```

Приведенная выше команда создает кластер AKS и определяет интервал сканирования в 30 секунд для профиля автомасштабирования в масштабе кластера. Команда также включает средство автомасштабирования кластера в начальном пуле узлов, устанавливает минимальное число узлов, равное 1, а максимальное — 3.

### <a name="reset-cluster-autoscaler-profile-to-default-values"></a>Восстановление значений по умолчанию для профиля средства автомасштабирования кластера

Чтобы сбросить профиль средства автомасштабирования кластера в кластере, используйте команду [az aks update][az-aks-update-preview].

```azurecli-interactive
az aks update \
  --resource-group myResourceGroup \
  --name myAKSCluster \
  --cluster-autoscaler-profile ""
```

## <a name="disable-the-cluster-autoscaler"></a>Отключение средства автомасштабирования кластера

Если вы больше не хотите использовать Автомасштабирование кластера, его можно отключить с помощью команды [AZ AKS Update][az-aks-update-preview] , указав `--disable-cluster-autoscaler` параметр. При отключении средства автомасштабирования кластера узлы не удаляются.

```azurecli-interactive
az aks update \
  --resource-group myResourceGroup \
  --name myAKSCluster \
  --disable-cluster-autoscaler
```

Вы можете вручную масштабировать кластер после отключения средства автомасштабирования кластера с помощью команды [az aks scale][az-aks-scale]. Если вы используете средство горизонтального автомасштабирования pod, оно будет и далее работать после отключения средства автомасштабирования кластера, но при исчерпании ресурсов существующих узлов оно не сможет назначить новые pod.

## <a name="re-enable-a-disabled-cluster-autoscaler"></a>Повторное включение отключенного средства автомасштабирования кластера

Если вы хотите повторно включить Автомасштабирование кластера в существующем кластере, его можно включить повторно с помощью команды [AZ AKS Update][az-aks-update-preview] , указав `--enable-cluster-autoscaler` `--min-count` Параметры, и `--max-count` .

## <a name="retrieve-cluster-autoscaler-logs-and-status"></a>Получение журналов и состояния средства автомасштабирования кластера

Для диагностики и отладки событий средства автомасштабирования можно получить журналы и данные о состоянии из надстройки автомасштабирования.

AKS управляет средством автомасштабирования кластера от вашего имени и запускает его на управляемом уровне управления. Вы можете включить узел плоскости управления, чтобы просмотреть журналы и операции из центра сертификации.

Чтобы настроить принудительную отправку журналов из средства автомасштабирования кластера в Log Analytics, выполните следующие действия.

1. Настройте правило для журналов ресурсов, чтобы журналы средства автоматического масштабирования кластера принудительно отправлялись в Log Analytics. Подробные инструкции приведены [в этой статье][aks-view-master-logs]. Не забудьте при выборе параметров в разделе "Журналы" установить флажок для `cluster-autoscaler`.
1. Выберите раздел "журналы" в кластере с помощью портал Azure.
1. Введите следующий пример запроса в Log Analytics:

```
AzureDiagnostics
| where Category == "cluster-autoscaler"
```

При наличии журналов для извлечения вы должны увидеть журналы, аналогичные приведенным в следующем примере.

![Журналы Log Analytics](media/autoscaler/autoscaler-logs.png)

Автоматическое масштабирование кластера также записывает состояние работоспособности в `configmap` именованное `cluster-autoscaler-status` . Чтобы получить эти журналы, воспользуйтесь следующей командой `kubectl`. Для каждого пула узлов, настроенного в средстве автомасштабирования кластера, будет указано состояние работоспособности.

```
kubectl get configmap -n kube-system cluster-autoscaler-status -o yaml
```

Дополнительные сведения о том, какие данные записываются в журнал из средства автомасштабирования, см. в разделе часто задаваемых вопросов в рамках проекта для [Kubernetes и средства автомасштабирования на сайте GitHub][kubernetes-faq].

## <a name="use-the-cluster-autoscaler-with-multiple-node-pools-enabled"></a>Использование средства автомасштабирования кластера при включенной поддержке нескольких пулов узлов

Средство автомасштабирования кластера можно использовать при включенной поддержке [нескольких пулов узлов][aks-multiple-node-pools]. Изучите этот документ, чтобы узнать, как включить несколько пулов узлов и добавить дополнительные пулы узлов в имеющийся кластер. При одновременном использовании обеих функций средство автомасштабирования кластера включается для каждого отдельного пула узлов в кластере и может передавать каждому из них уникальные правила автомасштабирования.

Приведенная ниже команда предполагает, что вы выполнили [начальные инструкции](#create-an-aks-cluster-and-enable-the-cluster-autoscaler), приведенные ранее в этом документе, и хотите обновить максимальное число имеющихся в пуле узлов с *3* до *5*. Чтобы обновить параметры пула узлов, используйте команду [az aks nodepool update][az-aks-nodepool-update].

```azurecli-interactive
az aks nodepool update \
  --resource-group myResourceGroup \
  --cluster-name myAKSCluster \
  --name nodepool1 \
  --update-cluster-autoscaler \
  --min-count 1 \
  --max-count 5
```

Средство автоматического масштабирования кластера можно отключить с помощью команды [az aks nodepool update][az-aks-nodepool-update] с параметром `--disable-cluster-autoscaler`.

```azurecli-interactive
az aks nodepool update \
  --resource-group myResourceGroup \
  --cluster-name myAKSCluster \
  --name nodepool1 \
  --disable-cluster-autoscaler
```

Если вы хотите повторно включить Автомасштабирование кластера в существующем кластере, его можно включить повторно с помощью команды [AZ AKS нодепул Update][az-aks-nodepool-update] , указав `--enable-cluster-autoscaler` `--min-count` Параметры, и `--max-count` .

> [!NOTE]
> Если вы планируете использовать Автомасштабирование кластера с нодепулс, охватывающем несколько зон, и используете функции планирования, связанные с зонами, такими как планирование Volume топологическом, то рекомендуется установить по одной нодепул на каждую зону и включить с `--balance-similar-node-groups` помощью профиля автомасштабирования. Это обеспечит успешное масштабирование автомасштабирования и попытайтесь и сохранит размеры сбалансированного нодепулс.

## <a name="next-steps"></a>Дальнейшие действия

В этой статье показано, как автоматически масштабировать количество узлов AKS. Также вы можете использовать средство горизонтального автомасштабирования pod для автоматической настройки числа pod, на которых выполняется приложение. Инструкции по использованию средства горизонтального автомасштабирования pod см. в статье [Руководство. Масштабирование приложений в Службе Azure Kubernetes (AKS)][aks-scale-apps].

<!-- LINKS - internal -->
[aks-faq]: faq.md
[aks-faq-node-resource-group]: faq.md#can-i-modify-tags-and-other-properties-of-the-aks-resources-in-the-node-resource-group
[aks-multiple-node-pools]: use-multiple-node-pools.md
[aks-scale-apps]: tutorial-kubernetes-scale.md
[aks-support-policies]: support-policies.md
[aks-upgrade]: upgrade-cluster.md
[aks-view-master-logs]: ./view-control-plane-logs.md#enable-resource-logs
[autoscaler-profile-properties]: #using-the-autoscaler-profile
[azure-cli-install]: /cli/azure/install-azure-cli
[az-aks-show]: /cli/azure/aks#az-aks-show
[az-extension-add]: /cli/azure/extension#az-extension-add
[az-extension-update]: /cli/azure/extension#az-extension-update
[az-aks-create]: /cli/azure/aks#az-aks-create
[az-aks-update]: /cli/azure/aks#az-aks-update
[az-aks-scale]: /cli/azure/aks#az-aks-scale
[az-feature-register]: /cli/azure/feature#az-feature-register
[az-feature-list]: /cli/azure/feature#az-feature-list
[az-provider-register]: /cli/azure/provider#az-provider-register

<!-- LINKS - external -->
[az-aks-update-preview]: https://github.com/Azure/azure-cli-extensions/tree/master/src/aks-preview
[az-aks-nodepool-update]: https://github.com/Azure/azure-cli-extensions/tree/master/src/aks-preview#enable-cluster-auto-scaler-for-a-node-pool
[autoscaler-scaledown]: https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md#what-types-of-pods-can-prevent-ca-from-removing-a-node
[autoscaler-parameters]: https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md#what-are-the-parameters-to-ca
[kubernetes-faq]: https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md#ca-doesnt-work-but-it-used-to-work-yesterday-why