---
title: Обновление кластера службы Azure Kubernetes (AKS)
description: Узнайте, как обновить кластер Azure Kubernetes Service (AKS), чтобы получить новейшие функции и обновления для системы безопасности.
services: container-service
ms.topic: article
ms.date: 12/17/2020
ms.openlocfilehash: 1d3c275758a1e241a531b65d1897903153efab94
ms.sourcegitcommit: ca215fa220b924f19f56513fc810c8c728dff420
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/19/2021
ms.locfileid: "98567463"
---
# <a name="upgrade-an-azure-kubernetes-service-aks-cluster"></a>Обновление кластера службы Azure Kubernetes (AKS)

В рамках жизненного цикла кластера AKS выполняется периодическое обновление до последней версии Kubernetes. Важно установить последние версии системы безопасности или обновить, чтобы получить новейшие функции. В этой статье показано, как обновить главные компоненты или один пул узлов по умолчанию в кластере AKS.

Для кластеров AKS, использующих несколько пулов узлов или узлов Windows Server, см. статью [Обновление пула узлов в AKS][nodepool-upgrade].

## <a name="before-you-begin"></a>Перед началом

Для работы с этой статьей требуется Azure CLI версии 2.0.65 или более поздней. Чтобы узнать версию, выполните команду `az --version`. Если вам необходимо выполнить установку или обновление, см. статью [Установка Azure CLI 2.0][azure-cli-install].

> [!WARNING]
> Обновление кластера AKS активирует Cordon и сток узлов. При наличии свободной квоты вычислений обновление может завершиться ошибкой. Дополнительные сведения см. в разделе [увеличение квот](../azure-portal/supportability/resource-manager-core-quotas-request.md) .

## <a name="check-for-available-aks-cluster-upgrades"></a>Проверка доступных обновлений кластера AKS

С помощью команды [az aks get-upgrades][az-aks-get-upgrades] проверьте выпуски Kubernetes, доступные для кластера. В следующем примере проверяется наличие доступных обновлений в *myAKSCluster* в *myResourceGroup*:

```azurecli-interactive
az aks get-upgrades --resource-group myResourceGroup --name myAKSCluster --output table
```

> [!NOTE]
> При обновлении поддерживаемого кластера AKS невозможно пропустить дополнительные версии Kubernetes. Все обновления должны выполняться последовательно по основному номеру версии. Например, Допускается обновление между *1.14. x*  ->  *1,15 доллара. x* или *1,15 доллара. x*  ->  *1.16. x* , однако *1.14. x*  ->  *1.16. x* не допускается. 
> > Пропуск нескольких версий может выполняться только при обновлении с _неподдерживаемой версии_ до _поддерживаемой версии_. Например, обновление с неподдерживаемой версии *1.10. x* --> поддерживаемый *1,15 доллара. x* может быть завершен.

В следующем примере выходных данных показано, что кластер можно обновить до версии *1.19.1* и *1.19.3*:

```console
Name     ResourceGroup    MasterVersion    Upgrades
-------  ---------------  ---------------  --------------
default  myResourceGroup  1.18.10          1.19.1, 1.19.3
```

Если обновление недоступно, вы получите следующее сообщение:

```console
ERROR: Table output unavailable. Use the --query option to specify an appropriate query. Use --debug for more info.
```

## <a name="customize-node-surge-upgrade"></a>Настройка обновления нехватка узлов

> [!Important]
> Исчерпание узлов требует квоты подписки на запрошенное максимальное число скачков для каждой операции обновления. Например, кластер с 5 пулами узлов, каждый из которых имеет количество 4 узлов, всего 20 узлов. Если для каждого пула узлов задано максимальное значение всплеска напряжения 50%, для завершения обновления требуется дополнительная квота вычислений и IP-адреса, равная 10 узлам (2 узла * 5 пулов).
>
> Если вы используете Azure CNI, проверьте наличие доступных IP-адресов в подсети и [соответствие требованиям, предъявляемым службой Azure CNI](configure-azure-cni.md).

По умолчанию AKS настраивает обновление на всплеск с помощью одного дополнительного узла. Значение по умолчанию для параметра max всплеска напряжения позволит AKS минимизировать перерыв рабочей нагрузки, создав дополнительный узел перед тем, как Cordon/сток существующих приложений заменит узел более старой версии. Максимальное значение всплеска напряжения можно настроить для каждого пула узлов, чтобы обеспечить компромисс между скоростью обновления и перерывом в обновлении. Увеличивая максимальное значение всплеска напряжения, процесс обновления выполняется быстрее, но установка большого значения для параметра max всплеска напряжения может привести к сбоям во время процесса обновления. 

Например, максимальное значение всплеска напряжения 100% обеспечивает самый быстрый возможный процесс обновления (удвоение числа узлов), но также приводит к тому, что все узлы в пуле узлов будут одновременно остановлены. Вы можете использовать более высокое значение, например, для тестовых сред. Для пулов производственных узлов рекомендуется использовать параметр max_surge 33%.

AKS принимает целочисленные значения и процентное значение для максимального всплеска напряжения. Целое число, например "5", означает пять дополнительных узлов для всплеска. Значение "50%" указывает на значение всплеска в половину текущего числа узлов в пуле. Максимальное значение процента всплеска напряжения может быть не менее 1% и не более 100%. Значение процента округляется до ближайшего числа узлов. Если максимальное значение всплеска напряжения ниже текущего числа узлов во время обновления, то для максимального значения всплеска используется текущее число узлов.

Во время обновления максимальное значение всплеска напряжения может быть не менее 1, а максимальное значение равно количеству узлов в пуле узлов. Можно задать большие значения, но максимальное количество узлов, используемых для максимального всплеска напряжения, не будет превышать число узлов в пуле во время обновления.

> [!Important]
> Параметр максимального увеличения напряжения в пуле узлов является постоянным.  Этот параметр будет использоваться для последующих обновлений Kubernetes или обновлений версий узла. Максимальное значение всплеска для пулов узлов можно изменить в любое время. Для пулов производственных узлов рекомендуется использовать параметр max-всплеска на 33%.

Используйте следующие команды, чтобы задать максимальные значения всплесков для новых или существующих пулов узлов.

```azurecli-interactive
# Set max surge for a new node pool
az aks nodepool add -n mynodepool -g MyResourceGroup --cluster-name MyManagedCluster --max-surge 33%
```

```azurecli-interactive
# Update max surge for an existing node pool 
az aks nodepool update -n mynodepool -g MyResourceGroup --cluster-name MyManagedCluster --max-surge 5
```

## <a name="upgrade-an-aks-cluster"></a>Обновление кластера AKS

С помощью команды [az aks upgrade][az-aks-upgrade] обновите кластер AKS, используя список доступных версий. В процессе обновления AKS будет: 
- Добавьте новый узел буфера (или столько узлов, как указано в параметре [Max всплеска напряжения](#customize-node-surge-upgrade)) в кластер, на котором запущена указанная версия Kubernetes. 
- [Cordon и][kubernetes-drain] остановите один из старых узлов, чтобы минимизировать сбои в работе приложений (если вы используете параметр max всплеска, он будет [Cordon и стокировать][kubernetes-drain] столько узлов одновременно, сколько указано узлов буфера). 
- Если старый узел полностью остановлен, он будет создан повторно, чтобы получить новую версию, и он станет узлом буфера для обновления следующего узла. 
- Этот процесс повторяется до тех пор, пока не будут обновлены все узлы в кластере. 
- В конце процесса последний узел буфера будет удален, сохраняя текущее количество узлов агента и баланс зоны.

```azurecli-interactive
az aks upgrade \
    --resource-group myResourceGroup \
    --name myAKSCluster \
    --kubernetes-version KUBERNETES_VERSION
```

Время, требуемое для выполнения обновления кластера, зависит от количества узлов.

> [!IMPORTANT]
> Убедитесь, что все `PodDisruptionBudgets` (PDB) позволяют перемещать по крайней мере 1 реплику Pod одновременно, в противном случае операция стока или вытеснения завершится ошибкой.
> В случае сбоя операции очистки операция обновления завершится неудачно, чтобы убедиться в том, что приложения не нарушат работу. Исправьте причину, по которой выполнение операции остановится (неверные PDB-файлы, нехватка квоты и т. д.), и повторите операцию.

Чтобы проверить, что обновление выполнено успешно, введите команду [az aks show][az-aks-show].

```azurecli-interactive
az aks show --resource-group myResourceGroup --name myAKSCluster --output table
```

В следующем примере выходных данных показано, что кластер теперь выполняет *1.18.10*:

```json
Name          Location    ResourceGroup    KubernetesVersion    ProvisioningState    Fqdn
------------  ----------  ---------------  -------------------  -------------------  ----------------------------------------------
myAKSCluster  eastus      myResourceGroup  1.18.10              Succeeded            myakscluster-dns-379cbbb9.hcp.eastus.azmk8s.io
```

## <a name="set-auto-upgrade-channel"></a>Задать канал автоматического обновления

В дополнение к ручному обновлению кластера можно задать канал автоматического обновления в кластере. Доступны следующие каналы обновления:

|Канал| Действие | Пример
|---|---|---|
| `none`| отключает автоматическое обновление и сохраняет кластер в текущей версии Kubernetes| Значение по умолчанию, если оставить без изменений|
| `patch`| автоматически обновите кластер до последней поддерживаемой версии исправления, когда она станет доступной, сохраняя при этом дополнительный номер версии.| Например, если кластер работает под управлением версии *1.17.7* , а версии *1.17.9*, *1.18.4*, *1.18.6* и *1.19.1* доступны, кластер обновляется до версии *1.17.9* .|
| `stable`| автоматически обновите кластер до последнего поддерживаемого выпуска исправлений для дополнительной версии *n-1*, где *n* — последняя поддерживаемая дополнительная версия.| Например, если кластер работает под управлением версии *1.17.7* , а версии *1.17.9*, *1.18.4*, *1.18.6* и *1.19.1* доступны, то кластер обновляется до *1.18.6*.
| `rapid`| автоматически обновите кластер до последней поддерживаемой версии исправления с последней поддерживаемой дополнительной версией.| В случаях, когда кластер находится в версии Kubernetes, которая находится на *n-2* дополнительной версии, где *n* — последняя поддерживаемая дополнительная версия, кластер сначала обновляет последнюю поддерживаемую версию исправления на *N-1* дополнительный номер версии. Например, если кластер работает под управлением версии *1.17.7* , а версии *1.17.9*, *1.18.4*, *1.18.6* и *1.19.1* доступны, то кластер сначала обновляется до *1.18.6*, а затем обновляется до *1.19.1*.

> [!NOTE]
> Кластер с автообновлением обновляет только общедоступные версии Kubernetes и не будет обновлен до предварительной версии.

Автоматическое обновление кластера выполняется так же, как и обновление кластера вручную. Дополнительные сведения см. в статье [Обновление кластера AKS][upgrade-cluster].

Автоматическое обновление кластера для кластеров AKS является функцией предварительной версии.

[!INCLUDE [preview features callout](./includes/preview/preview-callout.md)]

Зарегистрируйте `AutoUpgradePreview` флаг компонента с помощью команды [AZ Feature Register][az-feature-register] , как показано в следующем примере:

```azurecli-interactive
az feature register --namespace Microsoft.ContainerService -n AutoUpgradePreview
```

Через несколько минут отобразится состояние *Registered* (Зарегистрировано). Проверьте состояние регистрации с помощью команды [AZ Feature List][az-feature-list] .

```azurecli-interactive
az feature list -o table --query "[?contains(name, 'Microsoft.ContainerService/AutoUpgradePreview')].{Name:name,State:properties.state}"
```

Когда все будет готово, обновите регистрацию поставщика ресурсов *Microsoft. ContainerService* с помощью команды [AZ Provider Register][az-provider-register] :

```azurecli-interactive
az provider register --namespace Microsoft.ContainerService
```

Чтобы задать канал автоматического обновления при создании кластера, используйте параметр *автоматического обновления канала* , как показано в следующем примере.

```azurecli-interactive
az aks create --resource-group myResourceGroup --name myAKSCluster --auto-upgrade-channel stable --generate-ssh-keys
```

Чтобы задать канал автоматического обновления в существующем кластере, обновите параметр *автоматического обновления канала* , как показано в следующем примере.

```azurecli-interactive
az aks update --resource-group myResourceGroup --name myAKSCluster --auto-upgrade-channel stable
```

## <a name="next-steps"></a>Дальнейшие действия

В этой статье было показано, как выполнить обновление существующего кластера AKS. Дополнительные сведения о развертывании AKS и управлении ею см. в следующей статье.

> [!div class="nextstepaction"]
> [Руководство. Подготовка приложения для Службы Azure Kubernetes (AKS)][aks-tutorial-prepare-app].

<!-- LINKS - external -->
[kubernetes-drain]: https://kubernetes.io/docs/tasks/administer-cluster/safely-drain-node/

<!-- LINKS - internal -->
[aks-tutorial-prepare-app]: ./tutorial-kubernetes-prepare-app.md
[azure-cli-install]: /cli/azure/install-azure-cli
[az-aks-get-upgrades]: /cli/azure/aks#az-aks-get-upgrades
[az-aks-upgrade]: /cli/azure/aks#az-aks-upgrade
[az-aks-show]: /cli/azure/aks#az-aks-show
[az-extension-add]: /cli/azure/extension#az-extension-add
[az-extension-update]: /cli/azure/extension#az-extension-update
[az-feature-list]: /cli/azure/feature?view=azure-cli-latest#az-feature-list&preserve-view=true
[az-feature-register]: /cli/azure/feature#az-feature-register
[az-provider-register]: /cli/azure/provider?view=azure-cli-latest#az-provider-register&preserve-view=true
[nodepool-upgrade]: use-multiple-node-pools.md#upgrade-a-node-pool
[upgrade-cluster]:  #upgrade-an-aks-cluster
