---
title: Миграция в службу Kubernetes Azure (AKS)
description: Переход на службу Azure Kubernetes Service (AKS).
services: container-service
ms.topic: article
ms.date: 02/25/2020
ms.custom: mvc
ms.openlocfilehash: 5881d03603002cc8d5bef1680083f6b4145bc77f
ms.sourcegitcommit: ea822acf5b7141d26a3776d7ed59630bf7ac9532
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/03/2021
ms.locfileid: "99526693"
---
# <a name="migrate-to-azure-kubernetes-service-aks"></a>Миграция в службу Kubernetes Azure (AKS)

Эта статья поможет вам спланировать и выполнить успешную миграцию в службу Azure Kubernetes (AKS). Чтобы помочь вам принять основные решения, в этом разделе содержатся сведения о текущей рекомендуемой конфигурации для AKS. В этой статье не рассматриваются все сценарии, и там, где это необходимо, содержатся ссылки на более подробные сведения о планировании успешной миграции.

Этот документ можно использовать для поддержки следующих сценариев:

* Миграция кластера AKS, поддерживаемого группами [доступности](../virtual-machines/windows/tutorial-availability-sets.md) , в [масштабируемые наборы виртуальных машин](../virtual-machine-scale-sets/overview.md)
* Миграция кластера AKS для использования [балансировщика нагрузки SKU](./load-balancer-standard.md) уровня "Стандартный"
* Миграция из [службы контейнеров Azure (ACS) — прекращение 31 января 2020 г](https://azure.microsoft.com/updates/azure-container-service-will-retire-on-january-31-2020/) . до AKS
* Миграция с [AKS Engine](/azure-stack/user/azure-stack-kubernetes-aks-engine-overview) на AKS
* Миграция с кластеров Kubernetes, отличных от Azure, в AKS
* Перемещение существующих ресурсов в другой регион

При миграции убедитесь, что Целевая версия Kubernetes находится в поддерживаемом окне для AKS. Если используется более старая версия, она может не находиться в поддерживаемом диапазоне и требовать обновления версий, поддерживаемых AKS. Дополнительные сведения см. в разделе [Поддерживаемые версии Kubernetes AKS](./supported-kubernetes-versions.md) .

Если вы выполняете миграцию на более новую версию Kubernetes, ознакомьтесь с разработкой [политики поддержки отклонений версий и версий Kubernetes](https://kubernetes.io/docs/setup/release/version-skew-policy/#supported-versions).

Некоторые средства с открытым кодом могут помочь при миграции в зависимости от сценария.

* [Велеро](https://velero.io/) (требуется Kubernetes 1.7 +)
* [Расширение CLI Azure KUBE](https://github.com/yaron2/azure-kube-cli)
* [Сдвиг](https://github.com/mhausenblas/reshifter)

В этой статье приводятся сводные сведения о миграции:

> [!div class="checklist"]
> * AKS с Load Balancer (цен. категория "Стандартный") и масштабируемыми наборами виртуальных машин
> * Существующие подключенные службы Azure
> * Обеспечение допустимых квот
> * Высокий уровень доступности и непрерывность бизнес-процессов
> * Рекомендации для приложений без отслеживания состояния
> * Рекомендации для приложений с отслеживанием состояния
> * Развертывание конфигурации кластера

## <a name="aks-with-standard-load-balancer-and-virtual-machine-scale-sets"></a>AKS с Load Balancer (цен. категория "Стандартный") и масштабируемыми наборами виртуальных машин

AKS — это управляемая служба, предлагающая уникальные возможности с более низкими затратами на управление. В результате управляемой службы необходимо выбрать из набора [регионов](./quotas-skus-regions.md) , поддерживаемых AKS. Переход из существующего кластера в AKS может потребовать изменения существующих приложений, чтобы они оставались работоспособными в управляемой плоскости управления AKS.

Мы рекомендуем использовать кластеры AKS, которые поддерживаются [масштабируемыми наборами виртуальных машин](../virtual-machine-scale-sets/index.yml) и [Load Balancer (цен. Категория "Стандартный") Azure](./load-balancer-standard.md) , чтобы получить такие компоненты, как [несколько пулов узлов](./use-multiple-node-pools.md), [зоны доступности](../availability-zones/az-overview.md), [диапазоны разрешенных IP-адресов](./api-server-authorized-ip-ranges.md), [Автомасштабирование кластера](./cluster-autoscaler.md), [Политика Azure для AKS](../governance/policy/concepts/policy-for-kubernetes.md)и другие новые функции по мере их выпуска.

В кластерах AKS, поддерживающих [группы доступности виртуальных машин](../virtual-machines/availability.md#availability-sets) , отсутствует поддержка многих из этих функций.

В следующем примере создается кластер AKS с одним пулом узлов, поддерживаемым масштабируемым набором виртуальных машин. В нем используется стандартный балансировщик нагрузки. Он также включает средство автомасштабирования кластера в пуле узлов для этого кластера и задает минимальное (*1*) и максимальное (*3*) число узлов.

```azurecli-interactive
# First create a resource group
az group create --name myResourceGroup --location eastus

# Now create the AKS cluster and enable the cluster autoscaler
az aks create \
  --resource-group myResourceGroup \
  --name myAKSCluster \
  --node-count 1 \
  --vm-set-type VirtualMachineScaleSets \
  --load-balancer-sku standard \
  --enable-cluster-autoscaler \
  --min-count 1 \
  --max-count 3
```

## <a name="existing-attached-azure-services"></a>Существующие подключенные службы Azure

При миграции кластеров могут быть присоединены внешние службы Azure. Для этого не требуется отдых ресурсов, но для поддержания функциональности им потребуется обновить подключения с предыдущих на новые кластеры.

* Реестр контейнеров Azure
* Log Analytics
* Application Insights
* Диспетчер трафика
* Учетная запись хранения
* Внешние базы данных

## <a name="ensure-valid-quotas"></a>Обеспечение допустимых квот

Так как дополнительные виртуальные машины будут развернуты в рамках подписки во время миграции, следует убедиться, что квоты и ограничения достаточны для этих ресурсов. Может потребоваться запросить увеличение [квоты виртуальных ЦП](../azure-portal/supportability/per-vm-quota-requests.md).

Может потребоваться запросить увеличение [квоты сети](../azure-portal/supportability/networking-quota-requests.md) , чтобы не допустить исчерпания IP-адресов. Дополнительные сведения см. в разделе [сети и диапазоны IP-адресов для AKS](./configure-kubenet.md) .

Дополнительные сведения см. в статье [Подписка Azure и ограничения службы](../azure-resource-manager/management/azure-subscription-service-limits.md). Чтобы проверить текущие квоты, в портал Azure перейдите в [колонку подписки](https://portal.azure.com/#blade/Microsoft_Azure_Billing/SubscriptionsBlade), выберите свою подписку и щелкните **использование + квоты**.

## <a name="high-availability-and-business-continuity"></a>Высокий уровень доступности и непрерывность бизнес-процессов

Если приложение не может справиться со временем простоя, необходимо следовать рекомендациям для сценариев миграции высокого уровня доступности.  Рекомендации по комплексному планированию непрерывности бизнес-процессов, аварийному восстановлению и максимальному времени работы выходят за рамки этого документа.  Дополнительные сведения см. в статье рекомендации [по обеспечению непрерывности бизнес-процессов и аварийному восстановлению в службе Azure Kubernetes (AKS)](./operator-best-practices-multi-region.md) .

Миграция сложных приложений обычно выполняется в течение некоторого времени, а не одномоментно. Это означает, что старым и новым средам может потребоваться взаимодействие по сети. Приложения, для которых ранее использовались `ClusterIP` службы для взаимодействия, могут быть предоставлены как тип `LoadBalancer` и должны быть защищены соответствующим образом.

Чтобы завершить миграцию, необходимо указать клиентам новые службы, работающие на AKS. Мы рекомендуем перенаправить трафик, обновив DNS, чтобы указать Load Balancer, расположенную перед кластером AKS.

[Диспетчер трафика Azure](../traffic-manager/index.yml) может направлять клиентов в нужный кластер Kubernetes и экземпляр приложения.  Диспетчер трафика — это балансировщик нагрузки трафика на основе DNS, который может распределять сетевой трафик между регионами.  Чтобы обеспечить оптимальную производительность и избыточность, направьте весь трафик приложения через диспетчер трафика, прежде чем он перейдет в кластер AKS.  При развертывании в многокластерной среде клиенты должны подключаться к DNS-имени диспетчера трафика, которое указывает на службы в каждом кластере AKS. Определите эти службы с помощью конечных точек диспетчера трафика. Каждая конечная точка — это *IP-адрес балансировщика нагрузки службы*. Используйте эту конфигурацию, чтобы направить сетевой трафик из конечной точки диспетчера трафика в одном регионе в конечную точку в другом регионе.

![AKS с диспетчером трафика](media/operator-best-practices-bc-dr/aks-azure-traffic-manager.png)

[Служба "Передняя дверца Azure](../frontdoor/front-door-overview.md) " — это еще один вариант для маршрутизации трафика для кластеров AKS.  Azure Front Door Service позволяет определять, управлять и отслеживать глобальную маршрутизацию для вашего веб-трафика посредством оптимизации для обеспечения наилучшей производительности и мгновенной глобальной отработки отказа для обеспечения высокой доступности. 

### <a name="considerations-for-stateless-applications"></a>Рекомендации для приложений без отслеживания состояния

Перенос приложений без отслеживания состояния — это самый простой случай. Примените определения ресурсов (YAML или Helm) к новому кластеру, убедитесь, что все работает правильно, и перенаправление трафика для активации нового кластера.

### <a name="considerations-for-stateful-applications"></a>Рекомендации для приложений с отслеживанием состояния

Тщательно спланируйте миграцию приложений с отслеживанием состояния, чтобы избежать потери данных или непредвиденного простоя.

Если вы используете службу файлов Azure, вы можете подключить общую папку как том в новом кластере:
* [Подключение статических файлов Azure в качестве тома](./azure-files-volume.md#mount-the-file-share-as-a-volume)

Если вы используете управляемые диски Azure, вы можете подключить диск только в том случае, если он не подключен к какой бы то ни было виртуальной машине:
* [Подключение статического диска Azure в качестве тома](./azure-disk-volume.md#mount-disk-as-volume)

Если ни один из этих подходов не работает, можно использовать параметры резервного копирования и восстановления.
* [Велеро в Azure](https://github.com/vmware-tanzu/velero-plugin-for-microsoft-azure/blob/master/README.md)

#### <a name="azure-files"></a>Файлы Azure

В отличие от дисков, файлы Azure можно одновременно подключить к нескольким узлам. В кластере AKS Azure и Kubernetes не препятствуют созданию Pod, который по-прежнему используется кластером ACS. Чтобы избежать потери данных и непредвиденного поведения, убедитесь, что кластеры не записывают одни и те же файлы одновременно.

Если в приложении может размещаться несколько реплик, которые указывают на один и тот же общий файловый ресурс, следуйте шагам миграции без отслеживания состояния и разверните определения YAML в новом кластере. В противном случае для миграции возможен следующий порядок действий.

* Проверьте, правильно ли работает приложение.
* Наведите динамический трафик в новый кластер AKS.
* Отключите старый кластер.

Если вы хотите начать с пустой общей папки и создать копию исходных данных, можно использовать [`az storage file copy`](/cli/azure/storage/file/copy) команды для переноса данных.


#### <a name="migrating-persistent-volumes"></a>Перенос постоянных томов

При переносе существующих постоянных томов в AKS, как правило, необходимо выполнить следующие действия:

* Замораживание записи в приложение. (Этот шаг является необязательным и требует простоя.)
* Создание моментальных снимков дисков.
* Создание управляемых дисков из моментальных снимков.
* Создайте постоянные тома в AKS.
* Обновите спецификации Pod, чтобы [использовать существующие тома](./azure-disk-volume.md) , а не персистентволумеклаимс (статическая подготовка).
* Разверните приложение в AKS.
* Проверьте, правильно ли работает приложение.
* Наведите динамический трафик в новый кластер AKS.

> [!IMPORTANT]
> Если вы решили не заморозить операции записи, необходимо реплицировать данные в новое развертывание. В противном случае данные, записанные после создания моментальных снимков диска, будут пропущены.

Некоторые средства с открытым кодом могут помочь в создании управляемых дисков и переносе томов между кластерами Kubernetes:

* [Azure CLIное расширение копирования дисков](https://github.com/noelbundick/azure-cli-disk-copy-extension) копирует и преобразует диски в группах ресурсов и регионах Azure.
* [Расширение CLI Azure KUBE](https://github.com/yaron2/azure-kube-cli) перечисляет тома Kubernetes ACS и переносит их в кластер AKS.


### <a name="deployment-of-your-cluster-configuration"></a>Развертывание конфигурации кластера

Мы рекомендуем использовать существующий конвейер непрерывной интеграции (CI) и непрерывной поставки (CD) для развертывания известной работоспособной конфигурации в AKS. Azure Pipelines можно использовать для [создания и развертывания приложений в AKS](/azure/devops/pipelines/ecosystems/kubernetes/aks-template). Клонировать существующие задачи развертывания и убедиться, что они `kubeconfig` указывают на новый кластер AKS.

Если это невозможно, экспортируйте определения ресурсов из существующего кластера Kubernetes и примените их к AKS. Для экспорта объектов можно использовать `kubectl`.

```console
kubectl get deployment -o=yaml --export > deployments.yaml
```

### <a name="moving-existing-resources-to-another-region"></a>Перемещение существующих ресурсов в другой регион

Возможно, потребуется переместить кластер AKS в [другой регион, поддерживаемый AKS][region-availability]. Рекомендуется создать новый кластер в другом регионе, а затем развернуть ресурсы и приложения в новом кластере. Кроме того, при наличии любых служб, например [Azure dev Spaces][azure-dev-spaces] , выполняющихся в кластере AKS, необходимо также установить и настроить эти службы в новом регионе в кластере.


В этой статье мы обобщены сведения о миграции для:

> [!div class="checklist"]
> * AKS с Load Balancer (цен. категория "Стандартный") и масштабируемыми наборами виртуальных машин
> * Существующие подключенные службы Azure
> * Обеспечение допустимых квот
> * Высокий уровень доступности и непрерывность бизнес-процессов
> * Рекомендации для приложений без отслеживания состояния
> * Рекомендации для приложений с отслеживанием состояния
> * Развертывание конфигурации кластера


[region-availability]: https://azure.microsoft.com/global-infrastructure/services/?products=kubernetes-service
[azure-dev-spaces]: ../dev-spaces/index.yml
