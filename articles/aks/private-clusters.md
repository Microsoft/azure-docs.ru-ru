---
title: Создание частного кластера Службы Azure Kubernetes
description: Узнайте, как создать частный кластер Службы Azure Kubernetes
services: container-service
ms.topic: article
ms.date: 3/5/2021
ms.openlocfilehash: 190658e23ee02651e64c3718824315c0265c0f04
ms.sourcegitcommit: 7edadd4bf8f354abca0b253b3af98836212edd93
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/10/2021
ms.locfileid: "102556542"
---
# <a name="create-a-private-azure-kubernetes-service-cluster"></a>Создание частного кластера Службы Azure Kubernetes

В частном кластере плоскость управления или сервер API имеют внутренние IP-адреса, определенные в [адресные пространства RFC1918 адресе для частного Интернет](https://tools.ietf.org/html/rfc1918) -документа. С помощью частного кластера можно гарантировать, что сетевой трафик между сервером API и пулами узлов остается только в частной сети.

Уровень управления или сервер API находятся в подписке Azure, управляемой Azure Kubernetes Service (AKS). Кластер или пул узлов клиента находятся в подписке клиента. Сервер и кластер или пул узлов могут взаимодействовать друг с другом через службу [Приватный канал Azure][private-link-service] в виртуальной сети сервера API и частной конечной точки, находящейся в подсети кластера AKS клиента.

## <a name="region-availability"></a>Доступность по регионам

Частный кластер доступен в регионах общедоступного региона, Azure для государственных организаций и Azure для Китая, где [поддерживается AKS](https://azure.microsoft.com/global-infrastructure/services/?products=kubernetes-service).

> [!NOTE]
> Сайты Azure для государственных организаций поддерживаются, однако US Gov (Техас) в настоящее время не поддерживается из-за отсутствия поддержки закрытых ссылок.

## <a name="prerequisites"></a>Предварительные требования

* Azure CLI 2.2.0 или более поздней версии
* Служба Приватного канала поддерживается только для Azure Load Balancer цен. категории "Стандартный". Azure Load Balancer цен. категории "Базовый" не поддерживается.  
* Чтобы использовать пользовательский DNS-сервер, добавьте на настраиваемом DNS-сервере в качестве вышестоящего DNS-сервера IP-адрес Azure DNS 168.63.129.16.

## <a name="create-a-private-aks-cluster"></a>Создание частного кластера AKS

### <a name="create-a-resource-group"></a>Создание группы ресурсов

Создайте группу ресурсов или выберите существующую группу ресурсов для кластера AKS.

```azurecli-interactive
az group create -l westus -n MyResourceGroup
```

### <a name="default-basic-networking"></a>Базовое сетевое взаимодействие по умолчанию 

```azurecli-interactive
az aks create -n <private-cluster-name> -g <private-cluster-resource-group> --load-balancer-sku standard --enable-private-cluster  
```
Где `--enable-private-cluster` — обязательный флаг для частного кластера. 

### <a name="advanced-networking"></a>Сетевое взаимодействие уровня "Расширенный"  

```azurecli-interactive
az aks create \
    --resource-group <private-cluster-resource-group> \
    --name <private-cluster-name> \
    --load-balancer-sku standard \
    --enable-private-cluster \
    --network-plugin azure \
    --vnet-subnet-id <subnet-id> \
    --docker-bridge-address 172.17.0.1/16 \
    --dns-service-ip 10.2.0.10 \
    --service-cidr 10.2.0.0/24 
```
Где `--enable-private-cluster` — обязательный флаг для частного кластера. 

> [!NOTE]
> Если адрес CIDR моста Docker (172.17.0.1/16) конфликтует с подсетью CIDR, измените его соответствующим образом.

## <a name="configure-private-dns-zone"></a>Настройка зоны Частная зона DNS 

Для настройки зоны Частная зона DNS можно использовать следующие параметры.

- Значение System является значением по умолчанию. Если аргумент--частный-DNS-Zone не указан, AKS создаст зону Частная зона DNS в группе ресурсов Node.
- "Нет" означает, что AKS не создаст зону Частная зона DNS.  Для этого необходимо подключить собственный DNS-сервер и настроить разрешение DNS для частного полного доменного имени.  Если не настроить разрешение DNS, DNS разрешается только в пределах узлов агентов и после развертывания приведет к проблемам с кластером. 
- Для "CUSTOM_PRIVATE_DNS_ZONE_RESOURCE_ID" требуется создать зону Частная зона DNS в этом формате для глобального облака Azure: `privatelink.<region>.azmk8s.io` . Вам потребуется идентификатор ресурса, который будет Частная зона DNS зоны.  Кроме того, вам потребуется назначенное пользователем удостоверение или субъект-служба по крайней мере с `private dns zone contributor` ролью.
- "FQDN-поддомен" можно использовать с "CUSTOM_PRIVATE_DNS_ZONE_RESOURCE_ID" только для предоставления возможностей поддомену для `privatelink.<region>.azmk8s.io`

### <a name="prerequisites"></a>Предварительные условия

* Предварительная версия AKS версии 0.5.3 или более поздней
* API версии 2020-11-01 или более поздней

### <a name="create-a-private-aks-cluster-with-private-dns-zone-preview"></a>Создание частного кластера AKS с зоной Частная зона DNS (Предварительная версия)

```azurecli-interactive
az aks create -n <private-cluster-name> -g <private-cluster-resource-group> --load-balancer-sku standard --enable-private-cluster --enable-managed-identity --assign-identity <ResourceId> --private-dns-zone [system|none]
```

### <a name="create-a-private-aks-cluster-with-a-custom-private-dns-zone-preview"></a>Создание частного кластера AKS с настраиваемой зоной Частная зона DNS (Предварительная версия)

```azurecli-interactive
az aks create -n <private-cluster-name> -g <private-cluster-resource-group> --load-balancer-sku standard --enable-private-cluster --enable-managed-identity --assign-identity <ResourceId> --private-dns-zone <custom private dns zone ResourceId> --fqdn-subdomain <subdomain-name>
```
## <a name="options-for-connecting-to-the-private-cluster"></a>Варианты подключения к частному кластеру

Конечная точка сервера API не имеет общедоступного IP-адреса. Для управления сервером API необходимо использовать виртуальную машину, имеющую доступ к виртуальной сети Azure кластера AKS. Существует несколько вариантов установки сетевого подключения к частному кластеру.

* Создать виртуальную машину в той же виртуальной сети Azure, что и кластер AKS.
* Использовать виртуальную машину в отдельной сети и настроить [пиринг виртуальных сетей][virtual-network-peering].  Дополнительные сведения об этом варианте см. ниже.
* Использовать подключение [Express Route или VPN][express-route-or-VPN].

Самым простым вариантом является создание виртуальной машины в той же виртуальной сети, что и кластер AKS.  Использование Express Route и VPN увеличивает затраты и сложность сети.  Для пиринга виртуальных сетей необходимо спланировать диапазоны адресов сети CIDR, чтобы убедиться в отсутствии перекрывающихся диапазонов.

## <a name="virtual-network-peering"></a>Пиринг между виртуальными сетями

Как уже упоминалось, пиринг виртуальных сетей — это один из способов доступа к частному кластеру. Чтобы использовать пиринг виртуальных сетей, необходимо настроить связь между виртуальной сетью и частной зоной DNS.
    
1. Перейдите в группу ресурсов узла в портал Azure.  
2. Выберите частную зону DNS.   
3. На левой панели выберите ссылку **Виртуальная сеть**.  
4. Создайте новую ссылку, чтобы добавить виртуальную сеть виртуальной машины в частную зону DNS. Ссылка на зону DNS станет доступной через несколько минут.  
5. В портал Azure перейдите к группе ресурсов, содержащей виртуальную сеть кластера.  
6. В области справа выберите виртуальную сеть. Имя виртуальной сети указано в формате *aks-vnet-\** .  
7. В левой области выберите **Пиринг**.  
8. Нажмите **Добавить**, добавьте виртуальную сеть виртуальной машины, а затем создайте пиринг.  
9. Перейдите в виртуальную сеть с виртуальной машиной, выберите **Пиринг**, выберите виртуальную сеть AKS и затем создайте пиринг. Если диапазоны адресов виртуальной сети AKS конфликтуют с виртуальной сетью виртуальной машины, пиринг завершится сбоем. Дополнительные сведения см. в статье [Пиринг между виртуальными сетями][virtual-network-peering].

## <a name="hub-and-spoke-with-custom-dns"></a>Звездообразная архитектура с настраиваемым DNS

Для развертывания сетей в Azure часто используется [звездообразная архитектура](/azure/architecture/reference-architectures/hybrid-networking/hub-spoke). Во многих из этих развертываний параметры DNS в периферийных виртуальных сетях настроены для ссылки на центральный сервер пересылки DNS, чтобы обеспечить разрешение локальных DNS-имен и имен на основе Azure. При развертывании кластера AKS в такой сетевой среде необходимо учитывать некоторые особенности.

![Частный концентратор и звездообразная архитектура](media/private-clusters/aks-private-hub-spoke.png)

1. По умолчанию при подготовке частного кластера в группе ресурсов, управляемой кластером, создается частная конечная точка (1) и частная зона DNS (2). Кластер использует запись A в частной зоне для разрешения IP-адреса частной конечной точки для обмена данными с сервером API.

2. Частная зона DNS связана только с виртуальной сетью, к которой подключены узлы кластера (3). Это означает, что частная конечная точка может разрешаться только узлами в этой связанной виртуальной сети. В сценариях, где настраиваемая служба DNS не настроена в виртуальной сети (по умолчанию), она работает без проблем в качестве узлов в 168.63.129.16 для DNS, которые могут разрешать записи в частной зоне DNS из-за ссылки.

3. В сценариях, где виртуальная сеть, содержащая кластер, имеет пользовательские параметры DNS (4), развертывание кластера завершается сбоем, если только частная зона DNS не связана с виртуальной сетью, содержащей пользовательские сопоставители DNS (5). Эту ссылку можно создать вручную после создания частной зоны во время подготовки кластера или с помощью автоматизации при обнаружении создания зоны с помощью механизмов развертывания на основе событий (например, службы "Сетка событий Azure" и "функции Azure").

> [!NOTE]
> Если вы используете [собственную таблицу маршрутов с кубенет](./configure-kubenet.md#bring-your-own-subnet-and-route-table-with-kubenet) и перенесете собственный DNS с частным кластером, создание кластера завершится сбоем. После сбоя создания кластера необходимо связать [RouteTable](./configure-kubenet.md#bring-your-own-subnet-and-route-table-with-kubenet) в группе ресурсов узла с подсетью, чтобы успешно создать кластер.

## <a name="limitations"></a>Ограничения 
* Диапазоны IP-адресов не могут быть применены к конечной точке сервера частного API, они применяются только к общедоступному серверу API.
* [Ограничения службы Приватного канала Azure][private-link-service] применимы к частным кластерам.
* Отсутствует поддержка агентов, размещенных в Microsoft Azure DevOps, с частными кластерами. Рекомендуется использовать [локальные агенты](/azure/devops/pipelines/agents/agents?tabs=browser). 
* Для клиентов, которым необходимо включить реестр контейнеров Azure для работы с частными AKS, виртуальная сеть реестра контейнеров должна быть соединена с виртуальной сетью кластера агента.
* Отсутствует поддержка преобразования существующих кластеров AKS в частные кластеры.
* Удаление или изменение частной конечной точки в подсети клиента приведет к прекращению работы кластера. 
* После того как клиенты обновили запись A на своих собственных DNS-серверах, они по-прежнему будут разрешать аписервер FQDN до старого IP-адреса после миграции, пока они не будут перезапущены. Клиентам необходимо перезапустить Хостнетворк Pods и модули Днсполици по умолчанию после миграции плоскости управления.
* В случае обслуживания на плоскости управления [IP-адрес AKS](./limit-egress-traffic.md) может измениться. В этом случае необходимо обновить запись A, указывающую на частный IP-адрес сервера API, на пользовательском DNS-сервере и перезапустить все пользовательские модули Pod или развертывания с помощью Хостнетворк.

<!-- LINKS - internal -->
[az-provider-register]: /cli/azure/provider#az-provider-register
[az-feature-list]: /cli/azure/feature#az-feature-list
[az-extension-add]: /cli/azure/extension#az-extension-add
[az-extension-update]: /cli/azure/extension#az-extension-update
[private-link-service]: ../private-link/private-link-service-overview.md#limitations
[virtual-network-peering]: ../virtual-network/virtual-network-peering-overview.md
[azure-bastion]: ../bastion/tutorial-create-host-portal.md
[express-route-or-vpn]: ../expressroute/expressroute-about-virtual-network-gateways.md
[devops-agents]: /azure/devops/pipelines/agents/agents
[availability-zones]: availability-zones.md
