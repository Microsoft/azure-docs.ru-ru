---
title: Асинхронное обновление для моделей Azure Analysis Services | Документация Майкрософт
description: Описывает использование REST API Azure Analysis Services для кода асинхронного обновления данных модели.
author: minewiskan
ms.service: azure-analysis-services
ms.topic: conceptual
ms.date: 04/15/2020
ms.author: owend
ms.reviewer: minewiskan
ms.custom: references_regions
ms.openlocfilehash: e9fd20fd42e9fe1eb0e98766798e5c759c974c97
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "92013905"
---
# <a name="asynchronous-refresh-with-the-rest-api"></a>Асинхронное обновление с помощью REST API

Используя любой язык программирования, поддерживающий вызовы RESTFUL, можно выполнять асинхронные операции обновления данных в Azure Analysis Services табличных моделях. Обновление предусматривает также синхронизацию реплик только для чтения для развертывания запросов. 

Операции обновления данных могут занять некоторое время в зависимости от ряда факторов, включая объем данных, уровень оптимизации с использованием секций и т. д. Эти операции традиционно были вызваны с помощью существующих методов, таких как использование [Tom](/analysis-services/tom/introduction-to-the-tabular-object-model-tom-in-analysis-services-amo) (табличная модель объектов), командлеты [PowerShell](/analysis-services/powershell/analysis-services-powershell-reference) или [TMSL](/analysis-services/tmsl/tabular-model-scripting-language-tmsl-reference) (язык сценариев табличной модели). Но для использования этих методов может понадобиться применить ненадежные длительные HTTP-подключения.

REST API для Azure Analysis Services позволяет выполнять обновления данных асинхронно. REST API устраняет необходимость в длительных подключениях через клиентские приложения. Кроме того, здесь предусмотрены другие возможности, обеспечивающие надежность работы, такие как выполнение повторных попыток и пакетных фиксаций.

## <a name="base-url"></a>Базовый URL-адрес

У базового URL-адреса должен быть такой формат:

```
https://<rollout>.asazure.windows.net/servers/<serverName>/models/<resource>/
```

Например, рассмотрим модель с именем AdventureWorks на сервере с именем `myserver` , расположенную в регионе Azure "Западная часть США". Тогда у сервера будет такое имя:

```
asazure://westus.asazure.windows.net/myserver 
```

Базовый URL-адрес для сервера с этим именем будет таким:

```
https://westus.asazure.windows.net/servers/myserver/models/AdventureWorks/ 
```

Базовый URL-адрес можно использовать, чтобы добавлять ресурсы и операции на основе следующих параметров: 

![Асинхронное обновление](./media/analysis-services-async-refresh/aas-async-refresh-flow.png)

- Все, что заканчивается на **s** — коллекции.
- Все, что заканчивается на **()** — функции.
- Все остальное — это ресурсы или объекты.

Например, вы можете выполнить обновление, применив команду POST к коллекции refreshes:

```
https://westus.asazure.windows.net/servers/myserver/models/AdventureWorks/refreshes
```

## <a name="authentication"></a>Аутентификация

Все вызовы должны проходить проверку подлинности, для чего нужен допустимый токен Azure Active Directory (OAuth 2) в заголовке авторизации, и соответствовать следующим требованиям:

- Токен должен быть пользовательским маркером или субъектом-службой приложения.
- У токена должна быть правильная аудитория, а именно `https://*.asazure.windows.net`.
- У пользователя или приложения должно быть достаточно разрешений для сервера или модели, чтобы выполнять запрашиваемые вызовы. Уровень разрешений определяется по ролям в модели или группе администраторов на сервере.

    > [!IMPORTANT]
    > Сейчас требуются разрешения роли **администратора сервера**.

## <a name="post-refreshes"></a>POST для /refreshes

Выполните обновление, применив команду POST к коллекции /refreshes, чтобы добавить в нее новый элемент. Под заголовком Location в ответе будет указан идентификатор обновления. Клиентское приложение может отключиться и, если требуется, проверить состояние позже, так как обновление происходит асинхронно.

Для одной модели можно выполнить только одну операцию обновления. Если во время одной операции обновления запустить вторую, возвращается конфликт с кодом состояния HTTP 409.

Текст должен выглядеть примерно так:

```
{
    "Type": "Full",
    "CommitMode": "transactional",
    "MaxParallelism": 2,
    "RetryCount": 2,
    "Objects": [
        {
            "table": "DimCustomer",
            "partition": "DimCustomer"
        },
        {
            "table": "DimDate"
        }
    ]
}
```

### <a name="parameters"></a>Параметры

Указывать параметры не обязательно. Применяются значения по умолчанию.

| Имя             | Type  | Описание  |По умолчанию  |
|------------------|-------|--------------|---------|
| `Type`           | Перечисление  | Тип выполняемой обработки. Тип выполняемой обработки зависит от типа [команды refresh](/analysis-services/tmsl/refresh-command-tmsl) TMSL: full, clearValues, calculate, dataOnly, automatic или defragment. Тип add не поддерживается.      |   automatic      |
| `CommitMode`     | Перечисление  | Определяет, будут объекты зафиксированы в пакетах или только после завершения. Режимы: default, transactional, partialBatch.  |  transactional       |
| `MaxParallelism` | Int   | Это значение определяет максимальное количество потоков, над которыми можно параллельно выполнять команды обработки. Это значение согласуется со свойством MaxParallelism, которое можно задать, используя [команду sequence](/analysis-services/tmsl/sequence-command-tmsl) или другими способами.       | 10        |
| `RetryCount`     | Int   | Указывает число попыток повторить операцию, по исчерпании которого будет определен сбой.      |     0    |
| `Objects`        | Array | Массив объектов для обработки. Для каждого объекта указываются параметр table, если нужно обработать целую таблицу, или параметры table и partition для обработки секции. Если нет указанных объектов, обновляется вся модель. |   Обработка целой модели      |

Значение CommitMode — partialBatch. Оно используется при начальной загрузке для больших наборов данных, что может занять несколько часов. Если обновление завершится сбоем после успешной фиксации одного или нескольких пакетов, эти пакеты останутся зафиксированными (т. е. для них не будет выполнен откат).

> [!NOTE]
> На момент написания статьи требуется, чтобы размер пакета был равен значению MaxParallelism, но это могло измениться.

### <a name="status-values"></a>Значения состояния

|Значение состояния  |Описание  |
|---------|---------|
|`notStarted`    |   Операция еще не запущена.      |
|`inProgress`     |   Выполняется операция.      |
|`timedOut`     |    Время ожидания операции истекло на основе указанного пользователем времени ожидания.     |
|`cancelled`     |   Операция отменена пользователем или системой.      |
|`failed`     |   Ошибка при выполнении операции.      |
|`succeeded`      |   Операция успешно завершена.      |

## <a name="get-refreshesrefreshid"></a>ПОЛУЧИТЬ/рефрешес/\<refreshId>

Чтобы проверить состояние обновления, используйте команду GET с идентификатором обновления. Ниже приведен пример текста ответа. Если операция выполняется, `inProgress` возвращается в состояние.

```
{
    "startTime": "2017-12-07T02:06:57.1838734Z",
    "endTime": "2017-12-07T02:07:00.4929675Z",
    "type": "full",
    "status": "succeeded",
    "currentRefreshType": "full",
    "objects": [
        {
            "table": "DimCustomer",
            "partition": "DimCustomer",
            "status": "succeeded"
        },
        {
            "table": "DimDate",
            "partition": "DimDate",
            "status": "succeeded"
        }
    ]
}
```

## <a name="get-refreshes"></a>GET для /refreshes

Чтобы получить список последних операций обновления для модели, примените команду GET к коллекции /refreshes. Ниже приведен пример текста ответа. 

> [!NOTE]
> На момент написания этой статьи предусматривается, что сохраняются и возвращаются операции обновления за последние 30 дней, но это могло измениться.

```
[
    {
        "refreshId": "1344a272-7893-4afa-a4b3-3fb87222fdac",
        "startTime": "2017-12-07T02:06:57.1838734Z",
        "endTime": "2017-12-07T02:07:00.4929675Z",
        "status": "succeeded"
    },
    {
        "refreshId": "474fc5a0-3d69-4c5d-adb4-8a846fa5580b",
        "startTime": "2017-12-07T01:05:54.157324Z",
        "endTime": "2017-12-07T01:05:57.353371Z",
        "status": "succeeded"
    }
]
```

## <a name="delete-refreshesrefreshid"></a>УДАЛИТЬ/рефрешес/\<refreshId>

Чтобы отменить выполняющееся обновление, примените команду DELETE к идентификатору обновления.

## <a name="post-sync"></a>POST для /sync

После выполнения операций обновления может потребоваться синхронизация новых данных с репликами для масштабирования запроса. Чтобы выполнить операцию синхронизации для модели, используйте команду POST для функции/Sync. Под заголовком Location в ответе будет указан идентификатор операции.

## <a name="get-sync-status"></a>GET для состояния /sync

Чтобы проверить состояние синхронизации, используйте команду GET, передав в качестве параметра идентификатор операции. Вот пример текста ответа:

```
{
    "operationId": "cd5e16c6-6d4e-4347-86a0-762bdf5b4875",
    "database": "AdventureWorks2",
    "UpdatedAt": "2017-12-09T02:44:26.18",
    "StartedAt": "2017-12-09T02:44:20.743",
    "syncstate": 2,
    "details": null
}
```

Значения для `syncstate`:

- 0 — репликация. Файлы базы данных реплицируются в целевую папку.
- 1 — восстановление. База данных восстанавливается на серверных экземплярах только для чтения.
- 2 — завершено. Синхронизация успешно выполнена.
- 3 — сбой операции.
- 4 — финализация. Синхронизация завершена, но еще выполняется очистка.

## <a name="code-sample"></a>Пример кода

Здесь приведен пример кода C# для начала работы: [RestApiSample на GitHub](https://github.com/Microsoft/Analysis-Services/tree/master/RestApiSample).

### <a name="to-use-the-code-sample"></a>Как пользоваться примером кода

1.    Клонируйте или скачайте репозиторий. Откройте решение RestApiSample.
2.    Найдите строку **client.BaseAddress = …** и укажите [базовый URL-адрес](#base-url).

В примере кода используется проверка подлинности [субъекта-службы](#service-principal) .

### <a name="service-principal"></a>Субъект-служба

Дополнительные сведения о том, как настроить субъект-службу и назначить необходимые разрешения в Azure AS, см. в статьях [Создание приложения Azure Active Directory и субъекта-службы с доступом к ресурсам с помощью портала](../active-directory/develop/howto-create-service-principal-portal.md) и [Добавление субъекта-службы к роли администратора сервера](analysis-services-addservprinc-admins.md). Выполнив эти шаги, сделайте дополнительно следующее:

1.    В примере кода найдите **центр String =...**, замените **Общий** идентификатором клиента вашей организации.
2.    Закомментируйте или раскомментируйте код, так чтобы класс ClientCredential использовался для создания экземпляра объекта cred. Убедитесь, \<App ID> что \<App Key> доступ к значениям и осуществляется безопасным способом, или используйте проверку подлинности на основе сертификатов для субъектов-служб.
3.    Запустите образец.


## <a name="see-also"></a>См. также раздел

[Регистрируют](analysis-services-samples.md)   
[REST API](/rest/api/analysisservices/servers)