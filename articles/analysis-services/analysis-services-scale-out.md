---
title: Горизонтальное масштабирование служб Azure Analysis Services | Документация Майкрософт
description: Репликация Azure Analysis Services серверов с помощью горизонтального масштабирования. Затем клиентские запросы можно распределять между несколькими репликами запросов в пуле запросов с горизонтальным масштабированием.
author: minewiskan
ms.service: azure-analysis-services
ms.topic: conceptual
ms.date: 09/10/2020
ms.author: owend
ms.reviewer: minewiskan
ms.openlocfilehash: 24ee31b941d836d296c30927cfb9636f3023fa89
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "92019445"
---
# <a name="azure-analysis-services-scale-out"></a>Горизонтальное масштабирование служб Azure Analysis Services

При использовании горизонтального масштабирования клиентские запросы могут распределяться между несколькими *репликами запросов* в *пуле запросов*, что сокращает время отклика во время рабочих нагрузок с высоким запросом. Операции обработки могут выполняться отдельно от пула запросов, чтобы эти операции не оказывали отрицательного влияния на клиентские запросы. Горизонтальное масштабирование можно настроить на портале Azure или с помощью REST API служб Analysis Services.

Горизонтальное масштабирование доступно для серверов в ценовой категории "Стандартный". Каждая реплика запросов оплачивается по той же ставке, что и сервер. Все реплики запроса создаются в том же регионе, что и сервер. Число реплик запросов, которые вы можете настроить, ограничено регионом, в котором находится ваш сервер. Дополнительные сведения см. в разделе [Доступность по регионам](analysis-services-overview.md#availability-by-region). Горизонтальное масштабирование не увеличивает объем доступной памяти сервера. Чтобы увеличить объем памяти, необходимо изменить план. 

## <a name="why-scale-out"></a>Зачем масштабировать?

В обычном развертывании сервера один сервер выступает в роли сервера обработки и сервера запросов. Если количество клиентских запросов к моделям на сервере превышает число единиц обработки запросов (QPU) в плане сервера или обработка модели производится во время выполнения рабочей нагрузки с большим числом запросов, это может привести к снижению производительности. 

С помощью горизонтального масштабирования можно создать пул запросов, содержащий до семи дополнительных ресурсов реплики запроса (всего восемь, включая *основной* сервер). Можно масштабировать количество реплик в пуле запросов, чтобы удовлетворить требования QPU в критические моменты времени, и в любое время можно разделить сервер обработки из пула запросов. 

Независимо от числа реплик запросов, имеющихся в пуле запросов, обработка рабочих нагрузок не распределяется между репликами запросов. Сервер источника выступает в качестве сервера обработки. Реплики запросов обслуживают только запросы к базам данных модели, синхронизированным между сервером источника и каждой репликой в пуле запросов. 

При масштабировании для добавления новых реплик запросов в пул запросов может потребоваться до пяти минут. Когда все новые реплики запросов работают и выполняются, новые подключения клиентов распределяются между ресурсами в пуле запросов. Имеющиеся клиентские подключения останутся в пуле, к которому они в настоящее время подключены. При свертывании любые имеющиеся клиентские подключения к ресурсу пула запросов, которые удаляются из пула, завершаются. Клиенты могут повторно подключаться к оставшимся ресурсам пула запросов.

## <a name="how-it-works"></a>Принцип работы

При первой настройке горизонтального развертывания базы данных модели на сервере-источнике *автоматически* синхронизируются с новыми репликами в новом пуле запросов. Автоматическая синхронизация выполняется только один раз. Во время автоматической синхронизации файлы данных сервера-источника (зашифрованные при хранении в хранилище BLOB-объектов) копируются во второе расположение, а также шифруются при хранении в хранилище больших двоичных объектов. Реплики в пуле запросов *сохраняются с данными* из второго набора файлов. 

Хотя автоматическая синхронизация выполняется только при первом горизонтальном масштабировании сервера, можно также выполнить синхронизацию вручную. Синхронизация гарантирует, что данные на репликах в пуле запросов соответствуют основному серверу. При обработке (обновлении) моделей на сервере-источнике необходимо выполнить синхронизацию *после* завершения операций обработки. Эта синхронизация копирует обновленные данные из файлов сервера-источника в хранилище BLOB-объектов во второй набор файлов. Реплики в пуле запросов сохраняются обновленными данными из второго набора файлов в хранилище BLOB-объектов. 

При выполнении последующей операции масштабирования, например при увеличении количества реплик в пуле запросов от двух до пяти, новые реплики сохраняются с данными из второго набора файлов в хранилище BLOB-объектов. Синхронизация отсутствует. Если затем выполнить синхронизацию после масштабирования, новые реплики в пуле запросов будут восстановлены дважды — избыточный расконсервации. При выполнении последующей операции масштабирования важно помнить:

* Выполните синхронизацию *до операции горизонтального масштабирования* , чтобы избежать избыточного расконсервации для добавленных реплик. Параллельная синхронизация и операции горизонтального масштабирования, выполняемые одновременно, не допускаются.

* При автоматизации операций обработки *и* масштабирования важно сначала обработать данные на сервере-источнике, затем выполнить синхронизацию, а затем выполнить операцию масштабирования. Эта последовательность гарантирует минимальное воздействие на ресурсы QPU и памяти.

* Во время операций масштабирования все серверы в пуле запросов, включая сервер-источник, временно находятся в автономном режиме.

* Синхронизация разрешена даже при отсутствии реплик в пуле запросов. При масштабировании от нуля до одной или нескольких реплик с новыми данными из операции обработки на сервере-источнике сначала выполните синхронизацию без реплик в пуле запросов, а затем выполните горизонтальное масштабирование. Синхронизация перед масштабированием позволяет избежать избыточного расконсервации только что добавленных реплик.

* При удалении базы данных модели с сервера-источника она не удаляется автоматически из реплик в пуле запросов. Необходимо выполнить операцию синхронизации с помощью команды PowerShell [Sync-азаналисиссервицесинстанце](/powershell/module/az.analysisservices/sync-AzAnalysisServicesinstance) , которая удаляет файл/s для этой базы данных из общего расположения хранилища BLOB-объектов реплики, а затем удаляет базу данных model в репликах в пуле запросов. Чтобы определить, существует ли база данных модели в репликах в пуле запросов, но не на сервере-источнике, убедитесь, что на **отдельном сервере обработки запроса к пулу** выбрано значение **Да**. Затем используйте SSMS для подключения к основному серверу с помощью `:rw` квалификатора, чтобы определить, существует ли база данных. Затем подключитесь к репликам в пуле запросов, подключившись без `:rw` квалификатора, чтобы проверить, существует ли та же база данных. Если база данных существует в репликах в пуле запросов, но не на сервере-источнике, выполните операцию синхронизации.   

* При переименовании базы данных на сервере-источнике необходимо выполнить дополнительные действия, чтобы убедиться, что база данных правильно синхронизирована с какими-либо репликами. После переименования выполните синхронизацию с помощью команды [Sync-азаналисиссервицесинстанце](/powershell/module/az.analysisservices/sync-AzAnalysisServicesinstance) , указав `-Database` параметр со старым именем базы данных. Эта синхронизация удаляет базу данных и файлы со старым именем из всех реплик. Затем выполните еще одну синхронизацию, указав `-Database` параметр с новым именем базы данных. Вторая синхронизация копирует новую именованную базу данных во второй набор файлов и восстанавливает все реплики. Эти операции синхронизации невозможно выполнить с помощью команды Синхронизировать модель на портале.

### <a name="synchronization-mode"></a>Режим синхронизации

По умолчанию реплики запросов сохраняются полностью, а не постепенно. Восстановление происходит поэтапно. Они отсоединяются и соединяются по два раза за раз (при условии, что существует по крайней мере три реплики), чтобы гарантировать, что по крайней мере одна реплика будет находиться в оперативном режиме для запросов в любой момент времени. В некоторых случаях клиентам может потребоваться повторное подключение к одной из сетевых реплик во время выполнения этого процесса. С помощью параметра **репликасинкмоде** теперь можно указать синхронизацию реплик запросов в параллельном режиме. Параллельная синхронизация обеспечивает следующие преимущества. 

- Значительное сокращение времени синхронизации. 
- Данные между репликами, скорее всего, будут согласованы во время процесса синхронизации. 
- Так как базы данных остаются в сети во всех репликах в процессе синхронизации, клиентам не нужно повторно подключаться. 
- Кэш в памяти обновляется постепенно только с измененными данными, что может быть быстрее, чем полное повторное восстановление модели. 

#### <a name="setting-replicasyncmode"></a>Настройка Репликасинкмоде

Используйте SSMS, чтобы задать Репликасинкмоде в дополнительных свойствах. Допустимые значения: 

- `1` (по умолчанию): полное восстановление базы данных реплики по этапам (добавочное). 
- `2`: Оптимизированная синхронизация в параллельном режиме. 

![Параметр Реликасинкмоде](media/analysis-services-scale-out/aas-scale-out-sync-mode.png)

При установке **репликасинкмоде = 2** в зависимости от того, какая часть кэша нуждается в обновлении, реплики запросов могут использовать дополнительную память. Чтобы база данных оставалась в режиме в сети и была доступна для запросов, в зависимости от того, какая часть данных изменилась, операция может потребовать *удвоения памяти* в реплике, так как старый и новый сегменты хранятся одновременно в памяти. Узлы реплик имеют то же выделение памяти, что и первичный узел, и обычно на основном узле возникает дополнительный объем памяти для операций обновления, поэтому может быть маловероятно, что в репликах будет исчерпана память. Кроме того, распространенным сценарием является то, что база данных постепенно обновляется на основном узле, поэтому потребность в удвоении памяти должна быть редкой. Если операция синхронизации обнаружила ошибку нехватки памяти, она повторит попытку с помощью метода по умолчанию (присоединить или отсоединить два за раз). 

### <a name="separate-processing-from-query-pool"></a>Отделение обработки от пула запросов

Чтобы достичь максимальной производительности во время выполнения операций обработки и запросов, отделите сервер обработки от пула запросов. При разделении новые клиентские соединения назначаются репликам запросов только в пуле запросов. Если для операций обработки требуется лишь короткий промежуток времени, вы можете отделить сервер обработки от пула запросов только на время, затрачиваемое на выполнение операций обработки и синхронизации, а затем снова включить его в пул запросов. При разделении сервера обработки из пула запросов или добавлении его в пул запросов может потребоваться до пяти минут для завершения операции.

## <a name="monitor-qpu-usage"></a>Мониторинг использования QPU

Чтобы определить, требуется ли горизонтальное масштабирование для сервера, [Отслеживайте сервер](analysis-services-monitor.md) в портал Azure с помощью метрик. Регулярно используется максимальное число QPU, это означает, что количество запросов к моделям превышает квоту QPU для плана. Значение метрики длины очереди заданий для пула запросов также увеличивается, когда количество запросов в очереди пула потока запросов превышает доступную квоту QPU. 

Еще одной хорошей метрикой для отслеживания является средняя QPU по Серверресаурцетипе. Эта метрика сравнивает среднюю QPU для сервера источника с пулом запросов. 

![Масштабирование метрик запросов](media/analysis-services-scale-out/aas-scale-out-monitor.png)

**Настройка QPU by Серверресаурцетипе**

1. На графике метрик нажмите кнопку **Добавить метрику**. 
2. В списке **ресурс** выберите свой сервер, затем в **пространстве имен метрик** выберите **Analysis Services стандартные метрики**, затем в **списке метрика** выберите **QPU**, а затем в окне **агрегирование** выберите **AVG**. 
3. Щелкните **Применить разделение**. 
4. В списке **значения** выберите **серверресаурцетипе**.  

### <a name="detailed-diagnostic-logging"></a>Подробное ведение журнала диагностики

Используйте журналы Azure Monitor для более подробной диагностики масштабируемых ресурсов сервера. С помощью журналов можно использовать запросы Log Analytics, чтобы прервать QPU и память для сервера и реплики. Дополнительные сведения см. в разделе примеры запросов в [Analysis Services ведение журнала диагностики](analysis-services-logging.md#example-queries).


## <a name="configure-scale-out"></a>Настройка горизонтального масштабирования

### <a name="in-azure-portal"></a>На портале Azure

1. На портале щелкните **горизонтальное масштабирование**. С помощью ползунка выберите число серверов реплик запросов. Число выбранных реплик помимо существующего сервера.  

2. В разделе **Отделить сервер обработки от пула запросов** выберите "Да", чтобы отделить сервер обработки от серверов запросов. Клиентские [соединения](#connections) , использующие строку подключения по умолчанию (без `:rw` ), перенаправляются в реплики в пуле запросов. 

   ![Ползунок горизонтального масштабирования](media/analysis-services-scale-out/aas-scale-out-slider.png)

3. Нажмите кнопку **Сохранить**, чтобы подготовить новые серверы-реплики запросов. 

При первой настройке горизонтального масштабирования для сервера модели на сервере-источнике автоматически синхронизируются с репликами в пуле запросов. Автоматическая синхронизация происходит только один раз, если сначала настроить горизонтальное масштабирование для одной или нескольких реплик. Последующие изменения количества реплик на одном сервере *не будут запускать другую автоматическую синхронизацию*. Автоматическая синхронизация не будет возникать повторно, даже если для сервера задано нулевое количество реплик, а затем снова выполнено масштабирование до любого количества реплик. 

## <a name="synchronize"></a>Synchronize 

Операции синхронизации должны выполняться вручную или с помощью REST API.

### <a name="in-azure-portal"></a>На портале Azure

Выберите **Обзор** > модель > **Синхронизировать модель**.

![Значок синхронизации](media/analysis-services-scale-out/aas-scale-out-sync.png)

### <a name="rest-api"></a>REST API

Используйте операцию **sync**.

#### <a name="synchronize-a-model"></a>Синхронизация модели:   

`POST https://<region>.asazure.windows.net/servers/<servername>:rw/models/<modelname>/sync`

#### <a name="get-sync-status"></a>Получение состояния синхронизации  

`GET https://<region>.asazure.windows.net/servers/<servername>/models/<modelname>/sync`

Коды состояния возврата:


|Код  |Описание  |
|---------|---------|
|-1     |  Недопустимо       |
|0     | Replicating        |
|1     |  Восстанавливается       |
|2     |   Завершено       |
|3     |   Сбой      |
|4     |    Завершение     |
|||


### <a name="powershell"></a>PowerShell

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

Перед использованием PowerShell [установите или обновите новый модуль Azure PowerShell](/powershell/azure/install-az-ps). 

Чтобы запустить синхронизацию, используйте [Sync-азаналисиссервицесинстанце](/powershell/module/az.analysisservices/sync-AzAnalysisServicesinstance).

Чтобы задать число реплик запросов, используйте [Set-азаналисиссервицессервер](/powershell/module/az.analysisservices/set-azanalysisservicesserver). Укажите необязательный параметр `-ReadonlyReplicaCount`.

Чтобы отделить сервер обработки от пула запросов, используйте [Set-азаналисиссервицессервер](/powershell/module/az.analysisservices/set-azanalysisservicesserver). Укажите необязательный `-DefaultConnectionMode` параметр для использования `Readonly` .

Дополнительные сведения см. в разделе [Использование субъекта-службы с модулем AZ. AnalysisServices](analysis-services-service-principal.md#azmodule).

## <a name="connections"></a>Соединения

На странице "Обзор" вашего сервера указаны два имени сервера. Если вы еще не настроили горизонтальное масштабирование для сервера, оба его имени работают одинаково. После настройки горизонтального масштабирования для сервера нужно указать соответствующее имя сервера в зависимости от типа подключения. 

Для клиентских подключений конечных пользователей, таких как Power BI Desktop, Excel и пользовательские приложения, используйте **имя сервера**. 

Для SSMS, Visual Studio и строк подключения в PowerShell, в приложениях функций Azure и объектах AMO используйте **имя сервера управления**. Имя сервера управления содержит специальный квалификатор `:rw` (чтение и запись). Все операции обработки выполняются на сервере управления (основном).

![имена серверов;](media/analysis-services-scale-out/aas-scale-out-name.png)

## <a name="scale-up-scale-down-vs-scale-out"></a>Горизонтальное масштабирование, горизонтальное масштабирование и горизонтальное масштабирование

Ценовую категорию на сервере можно изменить с помощью нескольких реплик. Та же ценовая категория применяется ко всем репликам. Операция масштабирования сначала выводит все реплики, а затем все реплики в новой ценовой категории.

## <a name="troubleshoot"></a>Диагностика

**Вопрос.** Ошибка при получении пользователей **не удается найти \<Name of the server> экземпляр сервера "" в режиме соединения "ReadOnly".**

**Решение:** При выборе **отдельного сервера обработки из параметра "запрос пула** " клиентские соединения, использующие строку подключения по умолчанию (без `:rw` ), перенаправляются в реплики пула запросов. Если реплики в пуле запросов еще не подключены, так как синхронизация еще не завершена, возможен сбой перенаправления клиентских подключений. Чтобы предотвратить неудачные попытки соединения, должны существовать по крайней мере два сервера в пуле запросов при выполнении синхронизации. Каждый сервер синхронизируется по отдельности, а другие остаются в сети. Если вы решили отказаться от сервера обработки в пуле запросов во время обработки, вы можете удалить его из пула для обработки и затем повторно добавить его туда после завершение этого процесса, но перед синхронизацией. Вы можете использовать метрики памяти и единицы обработки запросов для проверки состояния синхронизации.



## <a name="related-information"></a>Дополнительные сведения

[Мониторинг метрик сервера](analysis-services-monitor.md)   
[Управление службами Azure Analysis Services](analysis-services-manage.md)