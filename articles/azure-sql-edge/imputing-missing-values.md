---
title: Заполнение временных зазоров и ввода отсутствующие значения — Azure SQL Server
description: Дополнительные сведения о заполнении временных зазоров и ввода отсутствующих значений в Azure SQL ребро
keywords: SQL ребро, TimeSeries
services: sql-edge
ms.service: sql-edge
ms.topic: conceptual
author: SQLSourabh
ms.author: sourabha
ms.reviewer: sstein
ms.date: 09/22/2020
ms.openlocfilehash: c444732a497d595235ac337d7f5c71fb84f17cca
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "96185595"
---
# <a name="filling-time-gaps-and-imputing-missing-values"></a>Заполнение временных зазоров и ввода отсутствующие значения 

При работе с данными временных рядов часто могут отсутствовать значения для этих атрибутов в данных временных рядов. Также возможно, что, из-за природы данных или из-за перерывов в сборе данных, существует *промежуток времени в* наборе данных.

Например, при сборе статистики потребления энергии для смарт-устройства, когда устройство не работает, в статистике использования будут пропуски. Аналогично, в сценарии сбора данных телеметрии компьютеров различные датчики могут быть настроены на выдачу данных с различной частотой, что приведет к отсутствующим значениям датчиков. Например, при наличии двух датчиков, напряжения и нажима, настроенных с частотой 100 Гц и 10 Гц, датчик напряжения будет выдавать данные каждые сотые секунды, а датчик давления будет отправлять данные только каждую десятую часть секунды.

В следующей таблице описывается набор данных телеметрии компьютера, который был собран с интервалом в одну секунду. 

```
timestamp               VoltageReading  PressureReading
----------------------- --------------- ----------------
2020-09-07 06:14:41.000 164.990400      97.223600
2020-09-07 06:14:42.000 162.241300      93.992800
2020-09-07 06:14:43.000 163.271200      NULL
2020-09-07 06:14:44.000 161.368100      93.403700
2020-09-07 06:14:45.000 NULL            NULL
2020-09-07 06:14:46.000 NULL            98.364800
2020-09-07 06:14:49.000 NULL            94.098300
2020-09-07 06:14:51.000 157.695700      103.359100
2020-09-07 06:14:52.000 157.019200      NULL
2020-09-07 06:14:54.000 NULL            95.352000
2020-09-07 06:14:56.000 159.183500      100.748200

```

Предыдущий набор данных имеет две важные характеристики. 

- Набор данных не содержит точек данных, связанных с несколькими метками времени `2020-09-07 06:14:47.000` , `2020-09-07 06:14:48.000` ,, `2020-09-07 06:14:50.000` `2020-09-07 06:14:53.000` и `2020-09-07 06:14:55.000` . Эти отметки времени — это *пробелы* в наборе данных.  
- Отсутствуют значения, представленные в виде `null` , для считывания напряжения и давления. 

## <a name="gap-filling"></a>Заполнение зазоров 

Заполнение зазоров — это метод, который помогает создать непрерывный упорядоченный набор меток времени для упрощения анализа данных временных рядов. В Azure SQL Server самым простым способом заполнения пропусков в наборе данных временных рядов является определение временной таблицы с требуемым распределением времени, а затем выполнение `LEFT OUTER JOIN` операции или с `RIGHT OUTER JOIN` таблицей набора данных. 

Используя приведенные `MachineTelemetry` выше данные в качестве примера, можно использовать следующий запрос для создания непрерывного упорядоченного набора меток времени для анализа. 

> [!NOTE]
> Приведенный ниже запрос формирует недостающие строки со значениями и значениями меток времени `null` для атрибутов. 

```sql
Create Table #SeriesGenerate(dt datetime Primary key Clustered)
GO

Declare @startdate datetime = '2020-09-07 06:14:41.000', @endtime datetime = '2020-09-07 06:14:56.000'
While (@startdate <= @endtime)
BEGIN
Insert into #SeriesGenerate values (@startdate)
set @startdate = DATEADD(SECOND, 1, @startdate)
END

Select a.dt as timestamp, b.VoltageReading, b.PressureReading 
From 
#SeriesGenerate a LEFT OUTER JOIN MachineTelemetry b 
    on a.dt = b.[timestamp]
```
Приведенный выше запрос возвращает следующий результат, содержащий все метки времени, состоящий из *одной секунды* в указанном диапазоне.

Результирующий набор

```

timestamp               VoltageReading    PressureReading
----------------------- ----------------- ----------------
2020-09-07 06:14:41.000 164.990400        97.223600
2020-09-07 06:14:42.000 162.241300        93.992800
2020-09-07 06:14:43.000 163.271200        NULL
2020-09-07 06:14:44.000 161.368100        93.403700
2020-09-07 06:14:45.000 NULL              NULL
2020-09-07 06:14:46.000 NULL              98.364800
2020-09-07 06:14:47.000 NULL              NULL
2020-09-07 06:14:48.000 NULL              NULL
2020-09-07 06:14:49.000 NULL              94.098300
2020-09-07 06:14:50.000 NULL              NULL
2020-09-07 06:14:51.000 157.695700        103.359100
2020-09-07 06:14:52.000 157.019200        NULL
2020-09-07 06:14:53.000 NULL              NULL
2020-09-07 06:14:54.000 NULL              95.352000
2020-09-07 06:14:55.000 NULL              NULL
2020-09-07 06:14:56.000 159.183500        100.748200
```

## <a name="imputing-missing-values"></a>Добавление пропущенных значений

Предыдущий запрос создал отсутствующие метки времени для анализа данных, но не заменил какие-либо отсутствующие значения (представленные как значения NULL) для `voltage` и `pressure` чтения. В Azure SQL ребро был добавлен новый синтаксис в T-SQL `LAST_VALUE()` и `FIRST_VALUE()` функции, которые предоставляют механизмы для аппроксимация отсутствующих значений на основе приведенных выше или следующих значений в наборе данных. 

Новый синтаксис добавляет `IGNORE NULLS` предложение and `RESPECT NULLS` в `LAST_VALUE()` `FIRST_VALUE()` функции и. Следующий запрос к `MachineTelemetry` набору данных вычислит отсутствующие значения с помощью функции LAST_VALUE, где отсутствующие значения заменяются последним наблюдаемым значением в наборе данных.

```sql
Select 
    timestamp,
    VoltageReading As OriginalVoltageValues,
    LAST_VALUE(VoltageReading) IGNORE NULLS OVER (ORDER BY timestamp) As ImputedUsingLastValue, 
    PressureReading As OriginalPressureValues,
    LAST_VALUE(PressureReading) IGNORE NULLS OVER (ORDER BY timestamp) As ImputedUsingLastValue
From 
MachineTelemetry 
order by timestamp 
```
Результирующий набор

```

timestamp               OrigVoltageVals  ImputedVoltage OrigPressureVals  ImputedPressure
----------------------- ---------------- -------------- ----------------- ----------------
2020-09-07 06:14:41.000 164.990400       164.990400     97.223600         97.223600
2020-09-07 06:14:42.000 162.241300       162.241300     93.992800         93.992800
2020-09-07 06:14:43.000 163.271200       163.271200     NULL              93.992800
2020-09-07 06:14:44.000 161.368100       161.368100     93.403700         93.403700
2020-09-07 06:14:45.000 NULL             161.368100     NULL              93.403700
2020-09-07 06:14:46.000 NULL             161.368100     98.364800         98.364800
2020-09-07 06:14:49.000 NULL             161.368100     94.098300         94.098300
2020-09-07 06:14:51.000 157.695700       157.695700     103.359100        103.359100
2020-09-07 06:14:52.000 157.019200       157.019200     NULL              103.359100
2020-09-07 06:14:54.000 NULL             157.019200     95.352000         95.352000
2020-09-07 06:14:56.000 159.183500       159.183500     100.748200        100.748200

```

Следующий запрос импутес недостающие значения с помощью `LAST_VALUE()` `FIRST_VALUE` функции и. Для выходного столбца `ImputedVoltage` отсутствующие значения заменяются последним наблюдаемым значением, а для выходного столбца `ImputedPressure` отсутствующие значения заменяются следующим наблюдаемым значением в наборе данных. 

```sql
Select 
    dt as timestamp, 
    VoltageReading As OrigVoltageVals,
    LAST_VALUE(VoltageReading) IGNORE NULLS OVER (ORDER BY dt) As ImputedVoltage, 
    PressureReading As OrigPressureVals,
    First_VALUE(PressureReading) IGNORE NULLS OVER (ORDER BY dt ROWS 
                    BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING) As ImputedPressure
From 
(Select a.dt, b.VoltageReading,b.PressureReading  from 
    #SeriesGenerate a 
        LEFT OUTER JOIN 
    MachineTelemetry b 
        on a.dt = b.[timestamp]) A
order by timestamp
```
Результирующий набор

```

timestamp               OrigVoltageVals  ImputedVoltage  OrigPressureVals  ImputedPressure
----------------------- ---------------- --------------- ----------------- ---------------
2020-09-07 06:14:41.000 164.990400       164.990400      97.223600         97.223600
2020-09-07 06:14:42.000 162.241300       162.241300      93.992800         93.992800
2020-09-07 06:14:43.000 163.271200       163.271200      NULL              93.403700
2020-09-07 06:14:44.000 161.368100       161.368100      93.403700         93.403700
2020-09-07 06:14:45.000 NULL             161.368100      NULL              98.364800
2020-09-07 06:14:46.000 NULL             161.368100      98.364800         98.364800
2020-09-07 06:14:47.000 NULL             161.368100      NULL              94.098300
2020-09-07 06:14:48.000 NULL             161.368100      NULL              94.098300
2020-09-07 06:14:49.000 NULL             161.368100      94.098300         94.098300
2020-09-07 06:14:50.000 NULL             161.368100      NULL              103.359100
2020-09-07 06:14:51.000 157.695700       157.695700      103.359100        103.359100
2020-09-07 06:14:52.000 157.019200       157.019200      NULL              95.352000
2020-09-07 06:14:53.000 NULL             157.019200      NULL              95.352000
2020-09-07 06:14:54.000 NULL             157.019200      95.352000         95.352000
2020-09-07 06:14:55.000 NULL             157.019200      NULL              100.748200
2020-09-07 06:14:56.000 159.183500       159.183500      100.748200        100.748200
```

> [!NOTE]
> В приведенном выше запросе используется `FIRST_VALUE()` функция для замены отсутствующих значений на следующее наблюдаемое значение. Тот же результат можно получить с помощью `LAST_VALUE()` функции с `ORDER BY <ordering_column> DESC` предложением.

## <a name="next-steps"></a>Дальнейшие действия 

- [FIRST_VALUE (Transact-SQL)](/sql/t-sql/functions/first-value-transact-sql?toc=%2fazure%2fazure-sql-edge%2ftoc.json)
- [LAST_VALUE (Transact-SQL)](/sql/t-sql/functions/last-value-transact-sql?toc=%2fazure%2fazure-sql-edge%2ftoc.json)
- [DATE_BUCKET (Transact-SQL)](date-bucket-tsql.md)
- [Агрегатные функции (Transact-SQL)](/sql/t-sql/functions/aggregate-functions-transact-sql)