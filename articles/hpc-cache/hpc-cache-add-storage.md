---
title: Добавление хранилища в кэш HPC Azure
description: Определение целевых объектов хранилища, чтобы кэш Azure HPC мог использовать локальную систему NFS или контейнеры больших двоичных объектов Azure для долгосрочного хранения файлов.
author: ekpgh
ms.service: hpc-cache
ms.topic: how-to
ms.date: 01/28/2021
ms.author: v-erkel
ms.openlocfilehash: b4df5863cc746490f13685a8d412232217af3bc8
ms.sourcegitcommit: d1e56036f3ecb79bfbdb2d6a84e6932ee6a0830e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/29/2021
ms.locfileid: "99054371"
---
# <a name="add-storage-targets"></a>Добавление целевых объектов хранилища

*Целевые объекты хранилища* — это серверное хранилище для файлов, доступ к которым осуществляется через кэш HPC Azure. Вы можете добавить хранилище NFS (например, локальную аппаратную систему) или сохранить данные в большом двоичном объекте Azure.

Можно определить до десяти различных целевых объектов хранилища для одного кэша. Кэш представляет все целевые объекты хранилища в одном объединенном пространстве имен.

Пути к пространству имен настраиваются отдельно после добавления целевых объектов хранилища. Как правило, целевой объект хранилища NFS может иметь до десяти путей к пространству имен или больше для некоторых крупных конфигураций. Дополнительные сведения см. в статье о [путях к пространству имен NFS](add-namespace-paths.md#nfs-namespace-paths) .

Помните, что экспорты хранилища должны быть доступны из виртуальной сети кэша. Для локального хранилища оборудования может потребоваться настроить DNS-сервер, который может разрешать имена узлов для доступа к хранилищу NFS. Дополнительные сведения см. в статье [доступ к DNS](hpc-cache-prerequisites.md#dns-access).

Добавьте целевые объекты хранилища после создания кэша. Выполните следующую процедуру.

1. [Создание кэша](hpc-cache-create.md)
1. Определение целевого объекта хранилища (сведения в этой статье)
1. [Создание путей взаимодействия с клиентом](add-namespace-paths.md) (для [агрегированного пространства имен](hpc-cache-namespace.md))

Процедура добавления целевого объекта хранилища немного отличается в зависимости от того, добавляется ли хранилище BLOB-объектов Azure или экспорт NFS. Сведения для каждого из них приведены ниже.

Щелкните изображение ниже, чтобы просмотреть [видео демонстрацию](https://azure.microsoft.com/resources/videos/set-up-hpc-cache/) создания кэша и добавления целевого объекта хранилища из портал Azure.

[![Эскиз видео: кэш Azure HPC: Настройка (щелкните, чтобы посетить страницу видео)](media/video-4-setup.png)](https://azure.microsoft.com/resources/videos/set-up-hpc-cache/)

## <a name="add-a-new-azure-blob-storage-target"></a>Добавление нового целевого объекта хранилища BLOB-объектов Azure

Для нового целевого объекта хранилища BLOB-объектов требуется пустой контейнер больших двоичных объектов или контейнер, заполненный данными в формате облачной файловой системы Azure HPC. Дополнительные сведения о предварительной загрузке контейнера больших двоичных объектов см. в статье [Перемещение данных в хранилище BLOB-объектов Azure](hpc-cache-ingest.md).

На странице портал Azure **Добавление целевого объекта хранилища** имеется возможность создать новый контейнер больших двоичных объектов непосредственно перед добавлением.

### <a name="portal"></a>[Портал](#tab/azure-portal)

В портал Azure откройте экземпляр кэша и щелкните **целевые объекты хранилища** на левой боковой панели.

![снимок экрана: страница параметров > целевого хранилища с двумя существующими целевыми объектами хранилища в таблице и выделением элемента "+ добавить целевой объект хранилища" над таблицей](media/add-storage-target-button.png)

На странице **целевые объекты хранилища** перечисляются все существующие целевые объекты и добавляется ссылка для добавления новой.

Нажмите кнопку **добавить целевой объект хранилища** .

![снимок экрана: страница "Добавление целевого объекта хранилища", заполненная данными для нового целевого объекта хранилища BLOB-объектов Azure](media/hpc-cache-add-blob.png)

Чтобы определить контейнер больших двоичных объектов Azure, введите эти сведения.

* **Имя целевого объекта хранилища** — задайте имя, идентифицирующее этот целевой объект хранилища в кэше HPC Azure.
* **Тип целевого объекта** — выберите **BLOB-объект**.
* **Учетная запись хранения** . Выберите учетную запись, которую вы хотите использовать.

  Необходимо авторизовать экземпляр кэша для доступа к учетной записи хранения, как описано в разделе [Добавление ролей доступа](#add-the-access-control-roles-to-your-account).

  Сведения о типе учетной записи хранения, которую можно использовать, см. в статье [требования к хранилищу BLOB-объектов](hpc-cache-prerequisites.md#blob-storage-requirements).

* **Контейнер хранилища** . Выберите контейнер больших двоичных объектов для этого целевого объекта или нажмите кнопку **создать**.

  ![снимок экрана диалогового окна для указания имени и уровня доступа (частный) для нового контейнера](media/add-blob-new-container.png)

По завершении нажмите кнопку **ОК** , чтобы добавить целевой объект хранилища.

> [!NOTE]
> Если брандмауэр учетной записи хранения настроен для ограничения доступа только к выбранным сетям, используйте временное решение, описанное в статье обход [параметров брандмауэра для учетной записи хранения BLOB-объектов](hpc-cache-blob-firewall-fix.md).

### <a name="add-the-access-control-roles-to-your-account"></a>Добавление ролей контроля доступа в учетную запись

Кэш Azure HPC использует [Управление доступом на основе ролей Azure (Azure RBAC)](../role-based-access-control/index.yml) для авторизации службы кэша на доступ к учетной записи хранения для целевых объектов хранилища BLOB-объектов Azure.

Владелец учетной записи хранения должен явно добавить роли [участника учетной записи хранения](../role-based-access-control/built-in-roles.md#storage-account-contributor) ролей и [участника данных большого двоичного объекта хранилища](../role-based-access-control/built-in-roles.md#storage-blob-data-contributor) для пользователя "поставщик ресурсов кэша HPC".

Это можно сделать заранее или щелкнув ссылку на странице, где вы добавите целевой объект хранилища BLOB-объектов. Помните, что для распространения параметров роли в среде Azure может потребоваться до пяти минут, поэтому необходимо подождать несколько минут после добавления ролей перед созданием целевого объекта хранилища.

Шаги для добавления ролей Azure:

1. Откройте страницу **управления доступом (IAM)** для учетной записи хранения. (Ссылка на странице **Добавление целевого объекта хранилища** автоматически открывает эту страницу для выбранной учетной записи.)

1. Щелкните в **+** верхней части страницы и выберите **добавить назначение роли**.

1. Выберите роль "участник учетной записи хранения" из списка.

1. В поле **назначить доступ к** оставьте значение по умолчанию ("пользователь Azure AD, группа или субъект-служба").  

1. В поле **выбора** выполните поиск по запросу "HPC".  Эта строка должна соответствовать одному субъекту-службе с именем "поставщик ресурсов кэша HPC". Щелкните этот субъект, чтобы выбрать его.

   > [!NOTE]
   > Если Поиск "HPC" не работает, попробуйте использовать строку "сторажекаче". Пользователям, получившим участие в предварительных версиях (до общедоступной версии), может потребоваться использовать старое имя субъекта-службы.

1. Нажмите кнопку **сохранить** внизу.

1. Повторите эту процедуру, чтобы назначить роль "участник данных BLOB-объекта хранилища".  

![снимок экрана: Добавление графического пользовательского интерфейса назначения ролей](media/hpc-cache-add-role.png)

### <a name="azure-cli"></a>[Azure CLI](#tab/azure-cli)

### <a name="prerequisite-storage-account-access"></a>Необходимое условие: доступ к учетной записи хранения

[Настройте Azure CLI для кэша HPC Azure](./az-cli-prerequisites.md).

Перед добавлением целевого объекта хранилища BLOB-объектов убедитесь, что кэш имеет нужные роли для доступа к учетной записи хранения, и что параметры брандмауэра допускают создание целевого объекта хранилища.

Кэш Azure HPC использует [Управление доступом на основе ролей Azure (Azure RBAC)](../role-based-access-control/index.yml) для авторизации службы кэша на доступ к учетной записи хранения для целевых объектов хранилища BLOB-объектов Azure.

Владелец учетной записи хранения должен явно добавить роли [участника учетной записи хранения](../role-based-access-control/built-in-roles.md#storage-account-contributor) ролей и [участника данных большого двоичного объекта хранилища](../role-based-access-control/built-in-roles.md#storage-blob-data-contributor) для пользователя "поставщик ресурсов кэша HPC".

Создание целевого объекта хранилища завершится ошибкой, если в кэше отсутствуют эти роли.

Для распространения параметров роли в среде Azure может потребоваться до пяти минут, поэтому необходимо подождать несколько минут после добавления ролей перед созданием целевого объекта хранилища.

Подробные инструкции [см. в статье Добавление и удаление назначений ролей Azure с помощью Azure CLI](../role-based-access-control/role-assignments-cli.md) .

Также проверьте параметры брандмауэра учетной записи хранения. Если брандмауэр настроен для ограничения доступа только к выбранным сетям, создание целевого объекта хранилища может завершиться ошибкой. Используйте обходное решение, описанное в статье [Работа с параметрами брандмауэра для учетной записи хранения BLOB-объектов](hpc-cache-blob-firewall-fix.md).

### <a name="add-a-blob-storage-target-with-azure-cli"></a>Добавление целевого объекта хранилища BLOB-объектов с Azure CLI

Чтобы определить целевой объект хранилища BLOB-объектов Azure, используйте интерфейс [Add HPC-Cache Blob — Storage-Target](/cli/azure/ext/hpc-cache/hpc-cache/blob-storage-target#ext-hpc-cache-az-hpc-cache-blob-storage-target-add) .

> [!NOTE]
> В настоящее время для команд Azure CLI требуется создать путь к пространству имен при добавлении целевого объекта хранилища. Это отличается от процесса, используемого с интерфейсом портал Azure.

Помимо стандартных параметров группы ресурсов и имени кэша, необходимо указать следующие параметры для целевого объекта хранилища:

* ``--name`` — Укажите имя, идентифицирующее этот целевой объект хранилища в кэше HPC Azure.

* ``--storage-account`` — Идентификатор учетной записи в следующем формате:/Subscriptions/*<subscription_id>*/resourceGroups/*<storage_resource_group>*/провидерс/Микрософт.стораже/сторажеаккаунтс/*<account_name>*

  Сведения о типе учетной записи хранения, которую можно использовать, см. в статье [требования к хранилищу BLOB-объектов](hpc-cache-prerequisites.md#blob-storage-requirements).

* ``--container-name`` — Укажите имя контейнера, который будет использоваться для этого целевого объекта хранилища.

* ``--virtual-namespace-path`` — Укажите путь к файлу для этого целевого объекта хранилища. Заключите пути в кавычки. Дополнительные сведения о функции виртуального пространства имен см. в статье [планирование обобщенного пространства имен](hpc-cache-namespace.md) .

Пример команды:

```azurecli
az hpc-cache blob-storage-target add --resource-group "hpc-cache-group" \
    --cache-name "cache1" --name "blob-target1" \
    --storage-account "/subscriptions/<subscriptionID>/resourceGroups/myrgname/providers/Microsoft.Storage/storageAccounts/myaccountname" \
    --container-name "container1" --virtual-namespace-path "/blob1"
```

---

## <a name="add-a-new-nfs-storage-target"></a>Добавление нового целевого объекта хранилища NFS

Цель хранилища NFS отличается от параметров целевого объекта хранилища BLOB-объектов. Параметр модель использования помогает кэшу эффективно кэшировать данные из этой системы хранения.

![Снимок экрана: страница добавления целевого объекта хранилища с определенным целевым объектом NFS](media/add-nfs-target.png)

> [!NOTE]
> Перед созданием целевого объекта хранилища NFS убедитесь, что ваша система хранения доступна из кэша HPC Azure и соответствует требованиям к разрешениям. Создание целевого объекта хранилища завершится ошибкой, если кэш не может получить доступ к системе хранения. Дополнительные сведения см. в статье [требования к хранилищу NFS](hpc-cache-prerequisites.md#nfs-storage-requirements) и [Устранение неполадок конфигурации NAS и целевого сервера хранилища NFS](troubleshoot-nas.md) .

### <a name="choose-a-usage-model"></a>Выбор модели использования
<!-- referenced from GUI - update aka.ms link if you change this heading -->

При создании целевого объекта хранилища, указывающего на систему хранения NFS, необходимо выбрать модель использования для этого целевого объекта. Эта модель определяет, как кэшируются данные.

Встроенные модели использования позволяют выбрать способ балансировки быстрого реагирования с риском получения устаревших данных. Если вы хотите оптимизировать скорость чтения файлов, вы можете не заботиться, проверяются ли файлы в кэше по внутренним файлам. С другой стороны, если вы хотите, чтобы файлы всегда были обновлены с помощью удаленного хранилища, выберите модель, которая проверяется часто.

Доступны три параметра:

* **Частое чтение, редкие операции записи** . Используйте этот параметр, если требуется ускорить доступ на чтение к файлам, которые являются статическими или редко изменяемыми.

  Этот параметр кэширует файлы, которые считываются клиентами, но немедленно передает записи в хранилище серверной части. Файлы, хранящиеся в кэше, не сравниваются автоматически с файлами на томе хранилища NFS. (Дополнительные сведения см. в примечании ниже о проверке серверной части.)

  Не используйте этот параметр, если существует риск, что файл может быть изменен непосредственно в системе хранения без предварительной записи в кэш. В таком случае кэшированная версия файла не будет синхронизирована с внутренним файлом.

* Более **15% операций записи** . Этот параметр ускоряет скорость чтения и записи. При использовании этого параметра все клиенты должны получить доступ к файлам через кэш HPC Azure, а не подключать серверное хранилище напрямую. В кэшированных файлах будут внесены последние изменения, которые не хранятся в серверной части.

  В этой модели использования файлы в кэше проверяются только по файлам в хранилище серверной части каждые 8 часов. Предполагается, что кэшированная версия файла является более актуальной. Измененный файл в кэше записывается в систему хранения серверной части после того, как она найдет в кэше в течение часа без дополнительных изменений.

* **Клиенты записываются в целевой объект NFS, минуя кэш** . Выберите этот параметр, если клиенты в рабочем процессе записывают данные непосредственно в систему хранения без предварительной записи в кэш или если требуется оптимизировать согласованность данных. Файлы, запрашиваемые клиентами, кэшируются, но любые изменения этих файлов, передаваемые из клиента, немедленно передаются обратно в систему хранения в серверной части.

  В этой модели использования файлы в кэше часто проверяются относительно серверных версий для обновлений. Эта проверка позволяет изменять файлы вне кэша, сохраняя согласованность данных.

В этой таблице перечислены различия в модели использования.

| Модель использования                   | Режим кэширования | Проверка серверной части | Максимальная задержка записи на сервер |
|-------------------------------|--------------|-----------------------|--------------------------|
| Частое чтение, редкие операции записи | Чтение         | Никогда                 | Нет                     |
| Более 15% операций записи       | Чтение/запись   | 8 ч               | 1 час                   |
| Клиенты обходят кэш      | Чтение         | 30 секунд            | Нет                     |

> [!NOTE]
> Значение **серверной проверки** показывает, когда кэш автоматически сравнивает свои файлы с исходными файлами в удаленном хранилище. Тем не менее можно принудительно использовать кэш HPC Azure для сравнения файлов путем выполнения операции с каталогом, включающей запрос реаддирплус. Реаддирплус — это стандартный API NFS (также называемый расширенным чтением), который возвращает метаданные каталога, что приводит к сравнению и обновлению файлов в кэше.

### <a name="create-an-nfs-storage-target"></a>Создание целевого объекта хранилища NFS

### <a name="portal"></a>[Портал](#tab/azure-portal)

В портал Azure откройте экземпляр кэша и щелкните **целевые объекты хранилища** на левой боковой панели.

![снимок экрана: страница параметров > целевого хранилища с двумя существующими целевыми объектами хранилища в таблице и выделением элемента "+ добавить целевой объект хранилища" над таблицей](media/add-storage-target-button.png)

На странице **целевые объекты хранилища** перечисляются все существующие целевые объекты и добавляется ссылка для добавления новой.

Нажмите кнопку **добавить целевой объект хранилища** .

![Снимок экрана: страница добавления целевого объекта хранилища с определенным целевым объектом NFS](media/add-nfs-target.png)

Укажите эти сведения для целевого объекта хранилища с поддержкой NFS:

* **Имя целевого объекта хранилища** — задайте имя, идентифицирующее этот целевой объект хранилища в кэше HPC Azure.

* **Тип целевого объекта** — выберите **NFS**.

* **Имя узла** — введите IP-адрес или полное доменное имя для системы хранения NFS. (Используйте доменное имя, только если ваш кэш имеет доступ к DNS-серверу, который может разрешить это имя.)

* **Модель использования** — выберите один из профилей кэширования данных на основе рабочего процесса, описанный в разделе [Выбор модели использования](#choose-a-usage-model) выше.

По завершении нажмите кнопку **ОК** , чтобы добавить целевой объект хранилища.

### <a name="azure-cli"></a>[Azure CLI](#tab/azure-cli)

[Настройте Azure CLI для кэша HPC Azure](./az-cli-prerequisites.md).

Чтобы создать целевой объект хранилища, используйте команду Azure CLI [AZ HPC-Cache NFS-Storage-Target Add](/cli/azure/ext/hpc-cache/hpc-cache/nfs-storage-target#ext-hpc-cache-az-hpc-cache-nfs-storage-target-add) .

> [!NOTE]
> В настоящее время для команд Azure CLI требуется создать путь к пространству имен при добавлении целевого объекта хранилища. Это отличается от процесса, используемого с интерфейсом портал Azure.

Укажите эти значения в дополнение к имени кэша и группе ресурсов кэша:

* ``--name`` — Укажите имя, идентифицирующее этот целевой объект хранилища в кэше HPC Azure.
* ``--nfs3-target`` — IP-адрес системы хранения NFS. (Полное доменное имя можно использовать здесь, если ваш кэш имеет доступ к DNS-серверу, который может разрешить это имя).
* ``--nfs3-usage-model`` — Один из профилей кэширования данных, описанный в разделе [Выбор модели использования](#choose-a-usage-model)выше.

  Проверьте имена моделей использования с помощью команды [AZ HPC-Cache Usage-Model List](/cli/azure/ext/hpc-cache/hpc-cache/usage-model#ext-hpc-cache-az-hpc-cache-usage-model-list).

* ``--junction`` — Параметр соединения связывает путь к виртуальному файлу клиента с путем экспорта в системе хранения.

  Целевой объект хранилища NFS может иметь несколько виртуальных путей, если каждый путь представляет отдельный экспорт или подкаталог в одной системе хранения. Создайте все пути для одной системы хранения на одном целевом объекте хранилища.

  Пути к [пространству имен](add-namespace-paths.md) в целевом хранилище можно добавлять и изменять в любое время.

  ``--junction``Параметр использует следующие значения:

  * ``namespace-path`` — Путь к виртуальному файлу клиента.
  * ``nfs-export`` — Экспорт системы хранения, связываемый с путем, ориентированным на клиента
  * ``target-path`` (необязательно) — подкаталог экспорта (при необходимости).

  Например, ``--junction namespace-path="/nas-1" nfs-export="/datadisk1" target-path="/test"``.

  Дополнительные сведения о функции виртуального пространства имен см. в статье [Настройка агрегированного пространства имен](hpc-cache-namespace.md) .

Пример команды:

```azurecli

az hpc-cache nfs-storage-target add --resource-group "hpc-cache-group" --cache-name "doc-cache0629" \
    --name nfsd1 --nfs3-target 10.0.0.4 --nfs3-usage-model WRITE_WORKLOAD_15 \
    --junction namespace-path="/nfs1/data1" nfs-export="/datadisk1" target-path=""
```

Выходные данные:
```azurecli

{- Finished ..
  "clfs": null,
  "id": "/subscriptions/<subscriptionID>/resourceGroups/hpc-cache-group/providers/Microsoft.StorageCache/caches/doc-cache0629/storageTargets/nfsd1",
  "junctions": [
    {
      "namespacePath": "/nfs1/data1",
      "nfsExport": "/datadisk1",
      "targetPath": ""
    }
  ],
  "location": "eastus",
  "name": "nfsd1",
  "nfs3": {
    "target": "10.0.0.4",
    "usageModel": "WRITE_WORKLOAD_15"
  },
  "provisioningState": "Succeeded",
  "resourceGroup": "hpc-cache-group",
  "targetType": "nfs3",
  "type": "Microsoft.StorageCache/caches/storageTargets",
  "unknown": null
}

```

---

## <a name="view-storage-targets"></a>Просмотр целевых объектов хранилища

Для отображения целевых объектов хранилища, уже определенных для кэша, можно использовать портал Azure или Azure CLI.

### <a name="portal"></a>[Портал](#tab/azure-portal)

В портал Azure откройте экземпляр кэша и щелкните **целевые объекты хранилища**, расположенные под заголовком Параметры на левой врезке. На странице целевые объекты хранилища перечислены все существующие целевые объекты и элементы управления для их добавления или удаления.

Щелкните имя целевого объекта хранилища, чтобы открыть его страницу сведений.

Дополнительные сведения см. в статье [Изменение целевых объектов хранилища](hpc-cache-edit-storage.md) .

### <a name="azure-cli"></a>[Azure CLI](#tab/azure-cli)

[Настройте Azure CLI для кэша HPC Azure](./az-cli-prerequisites.md).

Чтобы отобразить существующие целевые объекты хранилища для кэша, воспользуйтесь параметром [AZ HPC-Cache Storage-Target List](/cli/azure/ext/hpc-cache/hpc-cache/storage-target#ext-hpc-cache-az-hpc-cache-storage-target-list) . Укажите имя кэша и группу ресурсов (если вы не настроили ее глобально).

```azurecli
az hpc-cache storage-target list --resource-group "scgroup" --cache-name "sc1"
```

Чтобы просмотреть сведения о конкретном целевом объекте хранилища, используйте команду [AZ HPC — хранилище кэша — целевое отображение](/cli/azure/ext/hpc-cache/hpc-cache/storage-target#ext-hpc-cache-az-hpc-cache-storage-target-list) . (Укажите целевой объект хранилища по имени.)

Пример

```azurecli
$ az hpc-cache storage-target show --cache-name doc-cache0629 --name nfsd1

{
  "clfs": null,
  "id": "/subscriptions/<subscription_ID>/resourceGroups/scgroup/providers/Microsoft.StorageCache/caches/doc-cache0629/storageTargets/nfsd1",
  "junctions": [
    {
      "namespacePath": "/nfs1/data1",
      "nfsExport": "/datadisk1",
      "targetPath": ""
    }
  ],
  "location": "eastus",
  "name": "nfsd1",
  "nfs3": {
    "target": "10.0.0.4",
    "usageModel": "WRITE_WORKLOAD_15"
  },
  "provisioningState": "Succeeded",
  "resourceGroup": "scgroup",
  "targetType": "nfs3",
  "type": "Microsoft.StorageCache/caches/storageTargets",
  "unknown": null
}
$
```

---

## <a name="next-steps"></a>Дальнейшие действия

После создания целевых объектов хранилища продолжите выполнение этих задач, чтобы подготовить кэш к использованию:

* [Настройка агрегированного пространства имен](add-namespace-paths.md)
* [Mount the Azure HPC Cache](hpc-cache-mount.md) (Подключение Azure HPC Cache)
* [Перемещение данных в хранилище BLOB-объектов Azure](hpc-cache-ingest.md)

Если необходимо обновить какие-либо параметры, можно [изменить целевой объект хранилища](hpc-cache-edit-storage.md).