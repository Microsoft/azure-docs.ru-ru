---
title: Руководство по миграции из SQL Server в Управляемый экземпляр SQL по сети
titleSuffix: Azure Database Migration Service
description: Узнайте, как перенести базу данных из экземпляра SQL Server в Управляемый экземпляр SQL Azure по сети с помощью Azure Database Migration Service.
services: dms
author: pochiraju
ms.author: rajpo
manager: craigg
ms.reviewer: craigg
ms.service: dms
ms.workload: data-services
ms.custom: seo-lt-2019
ms.topic: tutorial
ms.date: 08/04/2020
ms.openlocfilehash: 4ee3e9e7d2aa0247011415b43517147fd421902a
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "101094934"
---
# <a name="tutorial-migrate-sql-server-to-an-azure-sql-managed-instance-online-using-dms"></a>Руководство по Миграция из SQL Server в Управляемый экземпляр SQL Azure по сети с помощью DMS

Azure Database Migration Service позволяет переносить базы данных из экземпляра SQL Server в [Управляемый экземпляр SQL Azure](../azure-sql/managed-instance/sql-managed-instance-paas-overview.md) с минимальным простоем. Сведения о других методах, которые могут потребовать некоторых действий вручную, см. в статье [Перенос экземпляра SQL Server в Управляемый экземпляр SQL Azure](../azure-sql/managed-instance/migrate-to-instance-from-sql-server.md).

В этом руководстве объясняется, как перенести базу данных **Adventureworks2012** из локального экземпляра SQL Server в Управляемый экземпляр SQL Azure с помощью Azure Database Migration Service с минимальным простоем.

В этом руководстве вы узнаете, как:
> [!div class="checklist"]
>
> * Создайте экземпляр Azure Database Migration Service.
> * создание проекта миграции и запуск миграции по сети с помощью Azure Database Migration Service;
> * Мониторинг миграции.
> * Когда будете готовы, выполните прямую миграцию.

> [!IMPORTANT]
> Чтобы выполнить миграцию из SQL Server в Управляемый экземпляр SQL Azure по сети с помощью Azure Database Migration Service, поместите полную резервную копию и последующие резервные копии журналов в сетевую папку SMB, которые служба может использовать для переноса баз данных. Azure Database Migration Service не инициирует создание резервных копий, вместо этого он использует для миграции существующие резервные копии, которые уже могли быть созданы в рамках плана аварийного восстановления.
> Выбирайте [резервные копии, используя параметр WITH CHECKSUM](/sql/relational-databases/backup-restore/enable-or-disable-backup-checksums-during-backup-or-restore-sql-server?preserve-view=true&view=sql-server-2017). Также убедитесь, что не добавили несколько резервных копий (например, полную копию и журнал транзакций) на один носитель резервных копий. Сохраняйте каждую резервную копию в отдельный файл. Наконец, чтобы снизить вероятность возникновения потенциальных проблем, связанных с миграцией больших объемов резервных копий, можно использовать сжатые резервные копии.

> [!NOTE]
> Чтобы выполнить сетевую миграцию с помощью Azure Database Migration Service, требуется создать экземпляр ценовой категории "Премиум".

> [!IMPORTANT]
> Чтобы процесс миграции был выполнен без проблем, корпорация Майкрософт рекомендует создать экземпляр Azure Database Migration Service в том же регионе Azure, в котором размещена целевая база данных. Перемещение данных между регионами и географическими областями может замедлить процесс миграции и привести к ошибкам.

> [!IMPORTANT]
> Максимально ускорьте миграцию по сети, чтобы свести к минимуму риск прерывания работы из-за перенастройки экземпляра или планового обслуживания. Иначе процесс миграции придется повторить с самого начала. В случае планового обслуживания повторная попытка миграции откладывается на 36 часов.

[!INCLUDE [online-offline](../../includes/database-migration-service-offline-online.md)]

В этой статье описан перенос данных из SQL Server в Управляемый экземпляр SQL по сети. Сведения о переносе в автономном режиме см. в статье [Руководство. Миграция из SQL Server в Управляемый экземпляр SQL Azure в автономном режиме с помощью DMS](tutorial-sql-server-to-managed-instance.md).

## <a name="prerequisites"></a>Предварительные требования

Для работы с этим руководством вам потребуется следующее:

* Создайте виртуальную сеть Microsoft Azure для Azure Database Migration Service с помощью модели развертывания Azure Resource Manager. Она обеспечивает подключение "сеть — сеть" к локальным исходным серверам через [ExpressRoute](../expressroute/expressroute-introduction.md) или [VPN](../vpn-gateway/vpn-gateway-about-vpngateways.md). [Изучите сетевые топологии для миграции в Управляемый экземпляр SQL с помощью Azure Database Migration Service](./resource-network-topologies.md). Дополнительные сведения см. в статье [Документация по виртуальной сети](../virtual-network/index.yml), где особое внимание стоит уделить кратким руководствам с пошаговыми инструкциями.

    > [!NOTE]
    > Если вы используете ExpressRoute с пиринговым подключением к сети, управляемой Майкрософт, во время настройки виртуальной сети добавьте в подсеть, в которой будет подготовлена служба, следующие [конечные точки](../virtual-network/virtual-network-service-endpoints-overview.md):
    >
    > * целевую конечную точку базы данных (например, конечная точка SQL, конечная точка Cosmos DB и т. д.);
    > * конечную точку службы хранилища;
    > * конечную точку служебной шины.
    >
    > Такая конфигурация вызвана тем, что у Azure Database Migration Service нет подключения к Интернету.
    >
    >Если у вас нет подключения типа "сеть — сеть" между локальной сетью и Azure, или если пропускная способность подключения "сеть — сеть" ограничена, рекомендуется использовать Azure Database Migration Service в гибридном режиме (Предварительная версия). Гибридный режим использует локальный рабочий процесс миграции вместе с экземпляром Azure Database Migration Service, который работает в облаке. Сведения о создании экземпляра Azure Database Migration Service в гибридном режиме см. в статье [Создание экземпляра Azure Database Migration Service в гибридном режиме с помощью портала Azure](./quickstart-create-data-migration-service-portal.md).

    > [!IMPORTANT]
    > В отношении учетной записи хранения, используемой в процессе миграции, необходимо:
    > * разрешить всем сетям доступ к учетной записи хранения;
    > * Включите [делегирование подсети](../virtual-network/manage-subnet-delegation.md) для подсети MI и обновите правила брандмауэра учетной записи хранения, чтобы разрешить эту подсеть.

* Убедитесь, что правила группы безопасности сети для виртуальной сети не блокируют исходящий порт 443 ServiceTag для Служебной шины, службы хранилища и Azure Monitor. См. дополнительные сведения о [фильтрации трафика, предназначенного для виртуальной сети, с помощью групп безопасности сети](../virtual-network/virtual-network-vnet-plan-design-arm.md).
* Настройте [брандмауэр Windows для доступа к ядру исходной СУБД](/sql/database-engine/configure-windows/configure-a-windows-firewall-for-database-engine-access).
* Откройте брандмауэр Windows, чтобы предоставить Azure Database Migration Service доступ к исходному серверу SQL Server. По умолчанию это TCP-порт 1433. Если ваш экземпляр по умолчанию прослушивает какой-либо другой порт, добавьте его в брандмауэр.
* Если вы запустили несколько именованных экземпляров SQL Server, использующих динамические порты, вы можете включить службу обозревателя SQL и разрешить доступ к UDP-порту 1434 через брандмауэры. Это позволит службе Azure Database Migration Service подключиться к именованному экземпляру на исходном сервере.
* Если перед исходными базами данных используется брандмауэр, его правила должны разрешать службе Azure Database Migration Service доступ к исходным базам данных для миграции и файлам SMB через порт 445.
* Создайте Управляемый экземпляр SQL по инструкциям из статьи [Краткое руководство. Создание управляемого экземпляра Управляемого экземпляра SQL](../azure-sql/managed-instance/instance-create-quickstart.md).
* Убедитесь, что для подключения к исходному серверу SQL Server и целевому Управляемому экземпляру SQL применяются имена входа пользователей с ролью администратора сервера.
* Укажите сетевую папку SMB, содержащую все файлы полных резервных копий базы данных и файлы резервных копий журнала транзакций, которые могут использоваться службой Azure Database Migration Service для миграции базы данных.
* Предоставьте учетной записи службы, от имени которой выполняется исходный экземпляр SQL Server, права на запись в эту созданную сетевую папку, а учетной записи компьютера для исходного сервера — права на чтение и запись для этой папки.
* Запишите имя пользователя и пароль учетной записи Windows, которой предоставлены полные права доступа к этой сетевой папке. Служба Azure Database Migration Service олицетворяет пользователя с этими учетными данными, чтобы отправить файлы резервных копий в контейнер службы хранилища Azure для операции восстановления.
* Создайте идентификатор приложения Azure Active Directory, генерирующего ключ идентификатора приложения, который может использоваться службой DMS для подключения к целевому Управляемому экземпляру Базы данных SQL Azure и контейнеру службы хранилища Azure. Дополнительные сведения см. в статье [Создание приложения Azure Active Directory и субъекта-службы с доступом к ресурсам с помощью портала](../active-directory/develop/howto-create-service-principal-portal.md).

  > [!NOTE]
  > DMS необходимо разрешение участника в подписке для указанного идентификатора приложения. Кроме того, вы можете создать пользовательские роли, предоставляющие определенные разрешения, которые требует Azure Database Migration Service. Пошаговые инструкции по использованию пользовательских ролей см. в статье [Пользовательские роли для миграции из SQL Server в Управляемый экземпляр SQL Azure по сети](./resource-custom-roles-sql-db-managed-instance.md).

* Создайте и запишите учетную запись хранения Azure с **уровнем производительности "Стандартный"**, которая позволяет службе DMS передавать файлы резервной копии базы данных и использовать их для переноса баз данных.  Убедитесь, что учетная запись хранения Azure создана в том же регионе, что и экземпляр службы DMS.

  > [!NOTE]
  > При переносе базы данных, защищенной с помощью [прозрачного шифрования данных](../azure-sql/database/transparent-data-encryption-tde-overview.md), в управляемый экземпляр по сети, перед восстановлением базы данных необходимо перенести соответствующий сертификат из локального экземпляра SQL Server или экземпляра SQL Server на виртуальной машине Azure. Пошаговая процедура приведена в статье о [переносе сертификата защищенной TDE базы данных в управляемый экземпляр](../azure-sql/database/transparent-data-encryption-tde-overview.md).

## <a name="register-the-microsoftdatamigration-resource-provider"></a>Регистрация поставщика ресурсов Microsoft.DataMigration

1. Войдите на портал Azure, щелкните **Все службы** и выберите **Подписки**.

    ![Отображение подписок на портале](media/tutorial-sql-server-to-managed-instance-online/portal-select-subscriptions.png)

2. Выберите подписку, в которой нужно создать экземпляр Azure Database Migration Service, а затем щелкните **Поставщики ресурсов**.

    ![Отображение поставщиков ресурсов](media/tutorial-sql-server-to-managed-instance-online/portal-select-resource-provider.png)

3. В поле поиска введите migration, а затем справа от **Microsoft.DataMigration** щелкните **Зарегистрировать**.

    ![Регистрация поставщика ресурсов](media/tutorial-sql-server-to-managed-instance-online/portal-register-resource-provider.png)

## <a name="create-an-azure-database-migration-service-instance"></a>Создание экземпляра Azure Database Migration Service

1. На портале Azure выберите + **Создать ресурс**, введите в поле поиска **Azure Database Migration Service**, а затем в раскрывающемся списке выберите **Azure Database Migration Service**.

     ![Azure Marketplace](media/tutorial-sql-server-to-managed-instance-online/portal-marketplace.png)

2. На экране **Azure Database Migration Service** выберите **Создать**.

    ![Создание экземпляра Azure Database Migration Service](media/tutorial-sql-server-to-managed-instance-online/dms-create1.png)

3. На экране **Создание службы миграции** укажите имя службы, подписку и новую или существующую группу ресурсов.

4. Выберите расположение, в котором хотите создать экземпляр DMS.

5. Выберите существующую виртуальную сеть или создайте новую.

    Виртуальная сеть предоставляет Azure Database Migration Service доступ к исходному экземпляру SQL Server и целевому Управляемому экземпляру SQL.

    См. дополнительные сведения о [создании виртуальной сети с помощью портала Azure](../virtual-network/quick-create-portal.md).

    Подробные сведения см. в статье [Сетевые топологии для миграции в Управляемый экземпляр SQL с помощью Azure Database Migration Service](./resource-network-topologies.md).

6. Выберите номер SKU ценовой категории "Премиум".

    > [!NOTE]
    > Миграция по сети поддерживается, только если используется уровень "Премиум".

    Дополнительные сведения о ценовых категориях и затратах см. на [странице с описанием цен](https://aka.ms/dms-pricing).

    ![Создание службы DMS](media/tutorial-sql-server-to-managed-instance-online/dms-create-service3.png)

7. Выберите **Создать**, чтобы создать службу.

## <a name="create-a-migration-project"></a>Создание проекта миграции

После создания экземпляра службы найдите его на портале Azure, откройте и создайте проект миграции.

1. На портале Azure щелкните **Все службы**, выполните поиск по запросу "Azure Database Migration Service" и выберите **Azure Database Migration Services** (Службы Azure Database Migration Service).

    ![Поиск всех экземпляров Azure Database Migration Service](media/tutorial-sql-server-to-managed-instance-online/dms-search.png)

2. На экране **Служба миграции баз данных Azure** найдите имя созданного экземпляра и выберите его.

3. Выберите **+ Новый проект миграции**.

4. На экране **Новый проект миграции** задайте имя для проекта, в текстовом поле **Тип исходного сервера** выберите элемент **SQL Server**, в текстовом поле **Тип целевого сервера** выберите элемент **Управляемый экземпляр SQL Azure**, а затем в разделе **Выберите тип действия** выберите элемент **Миграция данных по сети**.

   ![Создание проекта Azure Database Migration Service](media/tutorial-sql-server-to-managed-instance-online/dms-create-project3.png)

5. Выберите **Create and run activity** (Создать и выполнить действие), чтобы создать проект.

## <a name="specify-source-details"></a>Указание сведений об источнике

1. На экране **Migration source detail** (Сведения об источнике миграции) задайте сведения о подключении для исходного SQL Server.

2. Если на сервере не установлен доверенный сертификат, установите флажок **Доверять сертификату сервера**.

    Если доверенный сертификат не установлен, SQL Server создаст самозаверяющий сертификат при запуске экземпляра. Этот сертификат используется с целью шифрования учетных данных для клиентских подключений.

    > [!CAUTION]
    > TLS-соединения, шифруемые с помощью самозаверяющего сертификата, не обеспечивают надежной защиты. Они уязвимы для атак "злоумышленник в середине". Не следует надеяться на защиту TLS с самозаверяющими сертификатами в рабочей среде или на серверах, подключенных к Интернету.

   ![Сведения об источнике](media/tutorial-sql-server-to-managed-instance-online/dms-source-details2.png)

3. Щелкните **Сохранить**.

4. На экране **Выбор баз данных-источников** выберите базу данных **Adventureworks2012** для миграции.

   ![Выбор баз данных-источников](media/tutorial-sql-server-to-managed-instance-online/dms-source-database1.png)

    > [!IMPORTANT]
    > При использовании MSSQL Integration Services (SSIS), DMS не поддерживает перенос базы данных каталога для проектов или пакетов служб SSIS (SSISDB) из SQL Server в Управляемый экземпляр SQL. Но можно подготовить SSIS в Фабрике данных Azure (ADF) и повторно развернуть проекты или пакеты служб SQL Server Integration Services в целевой базе данных SQL Server Integration Services, размещенной в Управляемом экземпляре SQL. Дополнительные сведения о миграции пакетов SSIS см. в статье [Перенос пакетов SQL Server Integration Services в Azure](./how-to-migrate-ssis-packages.md).

5. Щелкните **Сохранить**.

## <a name="specify-target-details"></a>Указание сведений о цели

1. На экране **Сведения о целевом объекте миграции** укажите **идентификатор приложения** и **ключ**, которые экземпляр DMS будет использовать для подключения к целевому экземпляру Управляемого экземпляра SQL Azure и учетной записи хранения Azure.

    Дополнительные сведения см. в статье [Создание приложения Azure Active Directory и субъекта-службы с доступом к ресурсам с помощью портала](../active-directory/develop/howto-create-service-principal-portal.md).

2. Выберите **подписку**, содержащую целевой экземпляр Управляемого экземпляра SQL, а затем выберите целевой экземпляр.

    Если Управляемый экземпляр SQL еще не подготовлен, щелкните [эту ссылку](../azure-sql/managed-instance/instance-create-quickstart.md), чтобы подготовить его. Когда Управляемый экземпляр SQL будет готов, вернитесь к этому проекту, чтобы выполнить миграцию.

3. Укажите **пользователя SQL** и **пароль** для подключения к Управляемому экземпляру SQL.

    ![Выбор цели](media/tutorial-sql-server-to-managed-instance-online/dms-target-details3.png)

4. Щелкните **Сохранить**.

## <a name="select-source-databases"></a>Выбор баз данных-источников

1. На экране **Выбор баз данных-источников** выберите базу данных-источник для миграции.

    ![Выбор баз данных-источников](media/tutorial-sql-server-to-managed-instance-online/dms-select-source-databases2.png)

2. Щелкните **Сохранить**.

## <a name="configure-migration-settings"></a>Настройка параметров миграции

1. На экране **Configure migration settings** (Настройка параметров миграции) укажите следующие сведения:

    | | |
    |--------|---------|
    |**Общая сетевая папка SMB** | Локальная сетевая папка SMB или общая папка Azure, содержащая файлы резервных копий базы данных и файлы резервных копий журнала транзакций, которые могут использоваться службой Azure Database Migration Service для миграции. Учетная запись службы, в которой выполняется исходный экземпляр SQL Server, должна иметь права записи и чтения для этой сетевой папки. Укажите полное доменное имя или IP-адрес сервера и сетевую папку, например "\\\servername.domainname.com\backupfolder" или "\\\IP address\backupfolder". Для повышения производительности мы рекомендуем использовать отдельную папку для каждой переносимой базы данных. Путь к общей папке на уровне базы данных можно указать с помощью параметра **Дополнительные параметры**. Если возникают проблемы с подключением, см. раздел об [общей папке SMB](known-issues-azure-sql-db-managed-instance-online.md#smb-file-share-connectivity). |
    |**User name** | Убедитесь, что пользователь Windows имеет полное право доступа к указанной ранее сетевой папке. Служба Azure Database Migration Service будет олицетворять пользователя с этими учетными данными, чтобы отправить файлы резервных копий в контейнер службы хранилища Azure для операции восстановления. При использовании файлового ресурса Azure следует использовать имя учетной записи хранения, предварительно указав в качестве имени пользователя AZURE\. |
    |**Пароль** | Пароль для пользователя Если используется общая папка Azure, в качестве пароля следует указать ключ учетной записи хранения. |
    |**Подписка учетной записи хранения Azure** | Выберите подписку, которая содержит учетную запись хранения Azure. |
    |**Учетная запись хранения Azure** | Выберите учетную запись хранения Azure, в которую служба DMS может отправлять файлы резервной копии из общей сетевой папки SMB, а также использовать эту учетную запись для миграции базы данных.  Рекомендуется выбрать учетную запись хранения в том же регионе, что и служба DMS для получения оптимальной производительности при передаче файлов. |

    ![Настройка параметров миграции](media/tutorial-sql-server-to-managed-instance-online/dms-configure-migration-settings4.png)

    > [!NOTE]
    > Возможной причиной появления в Azure Database Migration Service ошибок "системная ошибка 53" или "системная ошибка 57" может быть отсутствие у Azure Database Migration Service доступа к общей папке Azure. При возникновении таких ошибок [предоставьте доступ к хранилищу учетной записи из виртуальной сети](../storage/common/storage-network-security.md?toc=%2fazure%2fvirtual-network%2ftoc.json#grant-access-from-a-virtual-network).

    > [!IMPORTANT]
    > Если функция проверки замыкания на себя включена, а исходный экземпляр SQL Server и общая папка находятся на одном компьютере, такой источник не сможет получить доступ к общей папке по полному доменному имени. Чтобы устранить эту проблему, отключите функцию проверки замыкания на себя, как описано [здесь](https://support.microsoft.com/help/926642/error-message-when-you-try-to-access-a-server-locally-by-using-its-fqd).

2. Щелкните **Сохранить**.

## <a name="review-the-migration-summary"></a>Просмотр сводки по миграции

1. На экране **Сводка по миграции** в текстовом поле **Имя активности** задайте имя действия миграции.

2. Проверьте и подтвердите сведения, связанные с проектом миграции.

    ![Сводка по проекту миграции](media/tutorial-sql-server-to-managed-instance-online/dms-project-summary3.png)

## <a name="run-and-monitor-the-migration"></a>Запуск и мониторинг миграции

1. Выберите **Запустить миграцию**.

2. На экране действия миграции, выберите **Обновить**, чтобы обновить отображающиеся данные.

   ![Выполняется действие миграции](media/tutorial-sql-server-to-managed-instance-online/dms-monitor-migration2.png)

    Далее можно развернуть категории баз данных и имен для входа, чтобы отслеживать состояние переноса соответствующих объектов сервера.

   ![Состояние действия миграции](media/tutorial-sql-server-to-managed-instance-online/dms-monitor-migration-extend2.png)

## <a name="performing-migration-cutover"></a>Выполнение прямой миграции

После восстановления полной резервной копии базы данных в целевом экземпляре Управляемого экземпляра SQL база данных будет доступна для переключения.

1. Когда вы будете готовы выполнить миграцию базы данных по сети, щелкните **Start Cutover** (Запустить прямую миграцию).

2. Остановите весь входящий трафик для баз данных-источников.

3. Создайте [резервную копию заключительного фрагмента журнала], сделайте файл резервной копии доступным в сетевой папке SMB и подождите, пока восстановится окончательная резервная копия журнала транзакций.

    На том этапе для параметра **Ожидающие изменения** будет присвоено значение 0.

4. Щелкните **Подтвердить**, а затем — **Apply** (Применить).

    ![Подготовка к выполнению прямой миграции](media/tutorial-sql-server-to-managed-instance-online/dms-complete-cutover.png)

    > [!IMPORTANT]
    > После переключения для Управляемого экземпляра SQL с уровнем служб "Критически важный для бизнеса" включение может занять значительно больше времени, чем для уровня служб "Общего назначения", так как для создания группы высокой доступности AlwaysOn необходимо заполнить три вторичные реплики. Длительность этой операции зависит от размера данных, как описано в разделе о [длительности операций управления](../azure-sql/managed-instance/management-operations-overview.md#duration).

5. Когда состояние миграции базы данных изменится на **Завершено**, подключите свои приложения к новому целевому экземпляру Управляемого экземпляра SQL.

    ![Завершенная прямая миграция](media/tutorial-sql-server-to-managed-instance-online/dms-cutover-complete.png)

## <a name="next-steps"></a>Дальнейшие действия

* Дополнительные сведения о переносе базы данных в Управляемый экземпляр SQL с помощью команды T-SQL RESTORE см. в статье [Краткое руководство. Восстановление резервной копии базы данных в Управляемый экземпляр SQL Azure с помощью SSMS](../azure-sql/managed-instance/restore-sample-database-quickstart.md).
* См. статью [Что такое Управляемый экземпляр Azure SQL?](../azure-sql/managed-instance/sql-managed-instance-paas-overview.md).
* См. сведения о [подключении приложений к Управляемому экземпляру SQL](../azure-sql/managed-instance/connect-application-instance.md).