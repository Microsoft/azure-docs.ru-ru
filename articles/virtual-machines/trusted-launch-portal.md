---
title: 'Предварительная версия: развертывание виртуальной машины с доверенным запуском'
description: Разверните виртуальную машину, использующую доверенный запуск.
author: khyewei
ms.author: khwei
ms.reviewer: cynthn
ms.service: virtual-machines
ms.subservice: security
ms.topic: how-to
ms.date: 03/03/2021
ms.custom: template-how-to
ms.openlocfilehash: fca11ce1cfa09fb680c2b288e40fa5f51337bdb8
ms.sourcegitcommit: dda0d51d3d0e34d07faf231033d744ca4f2bbf4a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/05/2021
ms.locfileid: "102200790"
---
# <a name="deploy-a-vm-with-trusted-launch-enabled-preview"></a>Развертывание виртуальной машины с включенным доверенным запуском (Предварительная версия)

[Доверенный запуск](trusted-launch.md) — это способ повысить безопасность виртуальных машин [поколения 2](generation-2.md) . Доверенный запуск защищает от сложных и устойчивых методов атак путем объединения технологий инфраструктуры, таких как vTPM и безопасная загрузка.

> [!IMPORTANT]
> Доверенный запуск в настоящее время находится в общедоступной предварительной версии.
> 
> Эта предварительная версия предоставляется без соглашения об уровне обслуживания и не рекомендована для использования рабочей среде. Некоторые функции могут не поддерживаться или их возможности могут быть ограничены.
>
> Дополнительные сведения см. в статье [Дополнительные условия использования предварительных выпусков Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).

## <a name="deploy-using-the-portal"></a>Развертывание с помощью портала

Создайте виртуальную машину с включенным доверенным запуском.

1. Войдите на [портал](https://aka.ms/TL_preview) Azure.
1. Выполните поиск **виртуальных машин**.
1. В разделе **Службы** выберите **Виртуальные машины**.
1. На странице **виртуальные машины** нажмите кнопку **Добавить**, а затем выберите **Виртуальная машина**.
1. В разделе **сведения о проекте** убедитесь, что выбрана правильная подписка.
1. В разделе **Группа ресурсов** выберите **создать** и введите имя группы ресурсов или выберите существующую группу ресурсов из раскрывающегося списка.
1. В разделе **сведения об экземпляре** введите имя виртуальной машины и выберите регион, который поддерживает [доверенный запуск](trusted-launch.md#public-preview-limitations).
1. В разделе **образ** выберите [образ, который поддерживает доверенный запуск](trusted-launch.md#public-preview-limitations). Возможно, вы видите только версию образа "Gen 1", что хорошо, и переходите к следующему шагу.
1. Переключитесь на вкладку **Дополнительно** , выбрав ее в верхней части страницы.
1. Прокрутите вниз до раздела **Создание виртуальной машины** , а затем выберите **Gen 2**.
1. Находясь на вкладке **Дополнительно** , прокрутите вниз до пункта **доверенный запуск** и установите флажок **доверенный запуск** . При этом будут отображены два дополнительных параметра — безопасная загрузка и vTPM. Выберите соответствующие параметры для развертывания.

    :::image type="content" source="media/trusted-launch/trusted-launch-portal.png" alt-text="Снимок экрана, показывающий варианты доверенного запуска.":::

1. Вернитесь на вкладку " **основы** " в разделе " **изображение**" и убедитесь, что отображается следующее сообщение: **этот образ поддерживает предварительную версию доверенного запуска. Настройте на вкладке Дополнительно**. Теперь следует выбрать образ Gen 2.

    :::image type="content" source="media/trusted-launch/gen-2-image.png" alt-text="Снимок экрана, показывающий, что это Gen2 образ, поддерживающий доверенный запуск.":::

1.  Выберите размер виртуальной машины, который поддерживает доверенный запуск. См. список [поддерживаемых размеров](trusted-launch.md#public-preview-limitations).
1.  Введите данные **учетной записи администратора** , а затем **правила для входящих портов**.
1.  В нижней части страницы выберите **Просмотр и создание** .
1.  На странице **Создание виртуальной машины** можно просмотреть сведения о виртуальной машине, которую вы собираетесь развернуть. Когда вы будете готовы, нажмите **Создать**.

    :::image type="content" source="media/trusted-launch/validation.png" alt-text="Сцееншот страницы проверки, в которую включены параметры доверенного запуска.":::


Развертывание виртуальной машины может занять несколько минут. 

## <a name="deploy-using-a-template"></a>Развертывание с помощью шаблона

Вы можете развернуть доверенные виртуальные машины с помощью шаблона быстрого запуска:

**Linux**:    
[![Развернуть в Azure](https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/1-CONTRIBUTION-GUIDE/images/deploytoazure.svg?sanitize=true)](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fprash200%2Fazure-quickstart-templates%2Fmaster%2F101-vm-trustedlaunch-linux%2Fazuredeploy.json/createUIDefinitionUri/https%3A%2F%2Fraw.githubusercontent.com%2Fprash200%2Fazure-quickstart-templates%2Fmaster%2F101-vm-trustedlaunch-linux%2FcreateUiDefinition.json)

**Windows**:    
[![Развернуть в Azure](https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/1-CONTRIBUTION-GUIDE/images/deploytoazure.svg?sanitize=true)](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fprash200%2Fazure-quickstart-templates%2Fmaster%2F101-vm-trustedlaunch-windows%2Fazuredeploy.json/createUIDefinitionUri/https%3A%2F%2Fraw.githubusercontent.com%2Fprash200%2Fazure-quickstart-templates%2Fmaster%2F101-vm-trustedlaunch-windows%2FcreateUiDefinition.json)

## <a name="view-and-update"></a>Просмотр и обновление

Чтобы просмотреть конфигурацию доверенного запуска для существующей виртуальной машины, перейдите на страницу **обзора** виртуальной машины на портале.

Чтобы изменить конфигурацию доверенного запуска, в меню слева выберите **Конфигурация** в разделе **Параметры** . Вы можете включить или отключить безопасную загрузку и vTPM из раздела **доверенного запуска** . По завершении нажмите кнопку **сохранить** в верхней части страницы. 

:::image type="content" source="media/trusted-launch/configuration.png" alt-text="Снимок экрана, посвященный изменению конфигурации доверенного запуска.":::

Если виртуальная машина запущена, вы получите сообщение о том, что виртуальная машина будет перезапущена для применения измененной конфигурации доверенного запуска. Чтобы изменения вступили в силу, выберите **Да** и дождитесь ПЕРЕЗАПУСКА виртуальной машины.


## <a name="verify-secure-boot-and-vtpm"></a>Проверка безопасной загрузки и vTPM

Вы можете проверить, включена безопасная загрузка и vTPM на виртуальной машине.
    
### <a name="linux-validate-if-secure-boot-is-running"></a>Linux: Проверка того, запущена ли безопасная загрузка

Подключитесь к виртуальной машине по протоколу SSH, а затем выполните следующую команду: 

```bash
mokutil --sb-state
```

Если включена безопасная загрузка, команда возвратит:
 
```bash
SecureBoot enabled 
```

### <a name="linux-validate-if-vtpm-is-enabled"></a>Linux: Проверка, включена ли vTPM

Подключитесь к виртуальной машине по протоколу SSH. Проверьте наличие устройства tpm0: 

```bash
ls /dev/tpm0
```

Если vTPM включен, команда возвратит:

```output
/dev/tpm0
```

Если vTPM отключен, команда возвратит:

```output
ls: cannot access '/dev/tpm0': No such file or directory
```

### <a name="windows-validate-that-secure-boot-is-running"></a>Windows: Проверка того, что запущена безопасная загрузка

Подключитесь к виртуальной машине с помощью удаленного рабочего стола, а затем запустите `msinfo32.exe` .

В области справа проверьте состояние безопасной **загрузки.**

## <a name="enable-the-azure-security-center-experience"></a>Включение интерфейса "Центр безопасности Azure"

Чтобы центр безопасности Azure отображал сведения о доверенных виртуальных машинах запуска, необходимо включить несколько политик. Самый простой способ включить политики — развернуть этот [шаблон диспетчер ресурсов](https://github.com/prash200/azure-quickstart-templates/tree/master/101-asc-trustedlaunch-policies) в подписке. 

Нажмите кнопку ниже, чтобы развернуть политики в подписке.

[![Развернуть в Azure](https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/1-CONTRIBUTION-GUIDE/images/deploytoazure.svg?sanitize=true)](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fprash200%2Fazure-quickstart-templates%2Fmaster%2F101-asc-trustedlaunch-policies%2Fazuredeploy.json)

Шаблон необходимо развернуть только один раз для каждой подписки. Он автоматически устанавливает `GuestAttestation` и выполняет `AzureSecurity` расширения на всех поддерживаемых виртуальных машинах. При возникновении ошибок попробуйте повторно развернуть шаблон.

Чтобы получить рекомендации по vTPM и безопасной загрузке для доверенных виртуальных машин, см. статью [Добавление пользовательской инициативы в подписку](https://docs.microsoft.com/azure/security-center/custom-security-policies#to-add-a-custom-initiative-to-your-subscription).
 
## <a name="sign-things-for-secure-boot-on-linux"></a>Знакомство с безопасной загрузкой в Linux

В некоторых случаях может потребоваться подписывать вещи для безопасной загрузки UEFI.  Например, может потребоваться выполнить [Подписывание элементов для безопасной загрузки](https://ubuntu.com/blog/how-to-sign-things-for-secure-boot) Ubuntu. В таких случаях необходимо ввести ключи регистрации служебной программы МОК для виртуальной машины. Для этого необходимо использовать последовательную консоль Azure для доступа к служебной программе МОК.

1. Включение последовательной консоли Azure для Linux. Дополнительные сведения см. в разделе [последовательная консоль для Linux](https://docs.microsoft.com/troubleshoot/azure/virtual-machines/serial-console-linux).
1. Войдите на [портал Azure](https://portal.azure.com).
1. Выполните поиск **виртуальных машин** и выберите свою виртуальную машину из списка.
1. В меню слева в разделе **Поддержка и устранение неполадок** выберите **серийная консоль**. Страница откроется справа с последовательной консолью.
1. Войдите в виртуальную машину с помощью последовательной консоли Azure. В поле **Login (имя входа**) введите имя пользователя, которое использовалось при создании виртуальной машины. Например, *azureuser*. При появлении запроса введите пароль, связанный с именем пользователя.
1. После входа используйте `mokutil` для импорта файла открытого ключа `.der` .

    ```bash
    sudo mokutil –import <path to public key.der> 
    ```
1. Перезагрузите компьютер из последовательной консоли Azure, введя `sudo reboot` . Начнется 10-секундный обратный отсчет.
1. Нажмите клавишу "вверх" или "вниз", чтобы прервать отсчет и подождать в режиме консоли UEFI. Если таймер не был прерван, процесс загрузки продолжится и все изменения МОК будут утеряны.
1. Выберите соответствующее действие в меню служебная программа МОК.

    :::image type="content" source="media/trusted-launch/mok-mangement.png" alt-text="Снимок экрана, показывающий доступные параметры в меню управления МОК в последовательной консоли.":::


## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о [доверенных](trusted-launch.md) виртуальных машинах запуска и [поколения 2](generation-2.md) .
