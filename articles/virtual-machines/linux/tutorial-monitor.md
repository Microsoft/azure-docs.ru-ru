---
title: Учебник. Мониторинг виртуальных машин Linux в Azure
description: В этом руководстве вы узнаете, как отслеживать производительность и обнаруживать компоненты приложений, работающих на ваших виртуальных машинах Linux.
services: virtual-machines-linux
documentationcenter: virtual-machines
author: mgoedtel
manager: gwallace
editor: ''
tags: azure-resource-manager
ms.assetid: ''
ms.service: virtual-machines-linux
ms.topic: tutorial
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure
ms.date: 09/30/2019
ms.author: magoedte
ms.custom: mvc, devx-track-azurecli
ms.openlocfilehash: f100df39ad92a3e8062c01a48a9f68730a3badb8
ms.sourcegitcommit: 78ecfbc831405e8d0f932c9aafcdf59589f81978
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/23/2021
ms.locfileid: "98736723"
---
# <a name="tutorial-monitor-a-linux-virtual-machine-in-azure"></a>Руководство по мониторингу виртуальных машин Linux в Azure

Служба мониторинга Azure использует агенты для сбора данных о производительности и загрузке с виртуальных машин Azure, сохраняет эти данные в хранилище Azure и предоставляет к ним доступ через портал, модуль Azure PowerShell и Azure CLI. Расширенный мониторинг осуществляется с помощью решения "Azure Monitor для виртуальных машин" путем сбора метрик производительности, обнаружения компонентов приложений, установленных на виртуальных машинах, и включает в себя таблицы производительности и карту зависимостей.

В этом руководстве описано следующее:

> [!div class="checklist"]
> * Включение диагностики загрузки на виртуальной машине
> * Просмотр диагностики загрузки
> * Просмотр метрик узла виртуальной машины
> * Включение Azure Monitor для виртуальных машин
> * Просмотр метрик производительности виртуальной машины
> * Создание оповещения

## <a name="launch-azure-cloud-shell"></a>Запуск Azure Cloud Shell

Azure Cloud Shell — это бесплатная интерактивная оболочка, с помощью которой можно выполнять действия, описанные в этой статье. Она включает предварительно установленные общие инструменты Azure и настроена для использования с вашей учетной записью. 

Чтобы открыть Cloud Shell, просто выберите **Попробовать** в правом верхнем углу блока кода. Cloud Shell можно также запустить в отдельной вкладке браузера, перейдя на страницу [https://shell.azure.com/powershell](https://shell.azure.com/powershell). Нажмите кнопку **Копировать**, чтобы скопировать блоки кода. Вставьте код в Cloud Shell и нажмите клавишу "ВВОД", чтобы выполнить его.

Если вы решили установить и использовать интерфейс командной строки локально, то для работы с этим руководством вам понадобится Azure CLI 2.0.30 или более поздней версии. Чтобы узнать версию, выполните команду `az --version`. Если вам необходимо выполнить установку или обновление, см. статью [Установка Azure CLI](/cli/azure/install-azure-cli).

## <a name="create-vm"></a>Создание виртуальной машины

Чтобы увидеть данные диагностики и метрики в действии, необходима виртуальная машина. Сначала создайте группу ресурсов с помощью команды [az group create](/cli/azure/group#az_group_create). В следующем примере создается группа ресурсов с именем *myResourceGroupMonitor* в расположении *eastus*.

```azurecli-interactive
az group create --name myResourceGroupMonitor --location eastus
```

Теперь создайте виртуальную машину командой [az vm create](/cli/azure/vm#az_vm_create). В следующем примере создаются виртуальная машина с именем *myVM* и ключи SSH, если они не существуют в каталоге *~/.ssh/* .

```azurecli-interactive
az vm create \
  --resource-group myResourceGroupMonitor \
  --name myVM \
  --image UbuntuLTS \
  --admin-username azureuser \
  --generate-ssh-keys
```

## <a name="enable-boot-diagnostics"></a>Включение диагностики загрузки

Во время загрузки виртуальных машин Linux расширение системы диагностики записывает выходные данные загрузки и сохраняет их в хранилище Azure. Эти данные можно использовать для устранения неполадок загрузки виртуальной машины. При создании виртуальной машины Linux с помощью Azure CLI диагностика загрузки не включается автоматически.

Перед включением диагностики загрузки необходимо создать учетную запись хранения для хранения журналов загрузки. Имена учетных записей хранения должны быть глобально уникальными, иметь длину от 3 до 24 символов и содержать только цифры и буквы в нижнем регистре. Создайте учетную запись хранения с помощью команды [az storage account create](/cli/azure/storage/account#az_storage_account_create). В этом примере для создания уникального имени учетной записи хранения используется случайная строка.

```azurecli-interactive
storageacct=mydiagdata$RANDOM

az storage account create \
  --resource-group myResourceGroupMonitor \
  --name $storageacct \
  --sku Standard_LRS \
  --location eastus
```

При включении диагностики загрузки необходим URI контейнера хранилища BLOB-объектов. Следующая команда запрашивает URI учетной записи хранения. Значение URI хранится в именах переменных *bloburi*, которые используются на следующем шаге.

```azurecli-interactive
bloburi=$(az storage account show --resource-group myResourceGroupMonitor --name $storageacct --query 'primaryEndpoints.blob' -o tsv)
```

Включите диагностику загрузки с помощью команды [az vm boot-diagnostics enable](/cli/azure/vm/boot-diagnostics#az-vm-boot-diagnostics-enable). Значение `--storage` — это URI BLOB-объекта, полученный на предыдущем шаге.

```azurecli-interactive
az vm boot-diagnostics enable \
  --resource-group myResourceGroupMonitor \
  --name myVM \
  --storage $bloburi
```

## <a name="view-boot-diagnostics"></a>Просмотр диагностики загрузки

Если включена диагностика загрузки, каждый раз при остановке и запуске виртуальной машины сведения о процессе загрузки записываются в файл журнала. В этом примере сначала освободите виртуальную машину с помощью команды [az vm deallocate](/cli/azure/vm#az_vm_deallocate) следующим образом:

```azurecli-interactive
az vm deallocate --resource-group myResourceGroupMonitor --name myVM
```

Теперь запустите виртуальную машину с помощью команды [az vm start](/cli/azure/vm#az_vm_start) следующим образом:

```azurecli-interactive
az vm start --resource-group myResourceGroupMonitor --name myVM
```

Данные диагностики загрузки для *myVM* можно получить с помощью команды [az vm boot-diagnostics get-boot-log](/cli/azure/vm/boot-diagnostics#az-vm-boot-diagnostics-get-boot-log) следующим образом:

```azurecli-interactive
az vm boot-diagnostics get-boot-log --resource-group myResourceGroupMonitor --name myVM
```

## <a name="view-host-metrics"></a>Просмотр метрик узла

Виртуальная машина Linux имеет выделенный узел в Azure, с которым она взаимодействует. Метрики узла собираются автоматически и их можно просмотреть на портале Azure следующим образом:

1. На портале Azure выберите **Группы ресурсов**, щелкните **myResourceGroupMonitor**, а затем в списке ресурсов выберите **myVM**.
1. Чтобы увидеть, как работает узел виртуальной машины, в окне виртуальной машины выберите **Метрики**, а затем щелкните любую метрику узла *[Host]* в группе **Доступные метрики**.

    ![Просмотр метрик узла](./media/tutorial-monitoring/monitor-host-metrics.png)

## <a name="enable-advanced-monitoring"></a>Включение расширенного мониторинга

Чтобы включить мониторинг виртуальной машины Azure с помощью решения "Azure Monitor для виртуальных машин", выполните следующие действия:

1. На портале Azure щелкните **Группы ресурсов**, выберите **myResourceGroupMonitor**, а затем в списке ресурсов выберите **myVM**.

2. На странице виртуальной машины в разделе **Мониторинг** выберите **Аналитические сведения (предварительная версия)** .

3. На странице **Аналитические сведения (предварительная версия)** выберите **Попробовать**.

    ![Включение Azure Monitor для виртуальной машины](../../azure-monitor/insights/media/vminsights-enable-single-vm/enable-vminsights-vm-portal.png)

4. Если имеющаяся рабочая область Log Analytics расположена в той же подписке, что и кластер, выберите ее из раскрывающегося списка на странице **Azure Monitor Insights Onboarding** (Подключение к службе аналитических сведений Azure Monitor).  

    В списке предварительно выбрана рабочая область по умолчанию и место развертывания виртуальной машины в подписке. 

    >[!NOTE]
    >Чтобы создать новую рабочую область Log Analytics для хранения данных мониторинга с виртуальной машины, см. руководство по [созданию рабочей области Log Analytics](../../azure-monitor/learn/quick-create-workspace.md). Эта рабочая область должна размещаться в одном из [поддерживаемых регионов](../../azure-monitor/insights/vminsights-configure-workspace.md#supported-regions).

После включения мониторинга может потребоваться подождать несколько минут, прежде чем можно будет просмотреть метрики производительности виртуальной машины.

![Включение Azure Monitor для обработки развертывания мониторинга виртуальных машин](../../azure-monitor/insights/media/vminsights-enable-single-vm/onboard-vminsights-vm-portal-status.png)

## <a name="view-vm-performance-metrics"></a>Просмотр метрик производительности виртуальной машины

Служба Azure Monitor для виртуальных машин включает в себя набор диаграмм производительности, ориентированных на несколько ключевых показателей эффективности (KPI), которые помогают определить, насколько эффективно работает виртуальная машина. Чтобы получить доступ со своей виртуальной машины, выполните указанные ниже действия.

1. На портале Azure щелкните **Группы ресурсов**, выберите **myResourceGroupMonitor**, а затем в списке ресурсов выберите **myVM**.

2. На странице виртуальной машины в разделе **Мониторинг** выберите **Аналитические сведения (предварительная версия)** .

3. Выберите вкладку **Производительность**.

Эта страница содержит не только диаграммы использования производительности, но и таблицу с отображением каждого обнаруженного логического диска, его емкости, использования и общего среднего значения по каждому показателю.

## <a name="create-alerts"></a>Создание оповещений

На основе метрик производительности можно создавать оповещения. Например, оповещения можно использовать для уведомления о том, что средняя загрузка ЦП превышает пороговое значение или свободное место на диске ниже определенного значения. Оповещения отображаются на портале Azure или могут быть отправлены по электронной почте. Вы также можете активировать модули Runbook службы автоматизации Azure или Azure Logic Apps в ответ на создаваемые оповещения.

В следующем примере создается предупреждение на основе среднего показателя использования ЦП.

1. На портале Azure щелкните **Группы ресурсов**, выберите **myResourceGroupMonitor**, а затем в списке ресурсов выберите **myVM**.

2. В колонке виртуальной машины щелкните **Правила оповещения**, а затем выберите **Добавить оповещение метрики**.

3. Укажите **имя** оповещения, например *myAlertRule*.

4. Для активации оповещения о превышении процента использования ЦП на 1.0 в течение пяти минут оставьте все настройки по умолчанию.

5. При необходимости установите флажок возле параметра *Участники, читатели и владельцы электронной почты* для отправки уведомлений по электронной почте. Действие по умолчанию — предоставлять уведомления на портале.

6. Нажмите кнопку **ОК** .

## <a name="next-steps"></a>Дальнейшие действия

В этом учебнике вы настроили и просмотрели метрики производительности виртуальной машины. Вы ознакомились с выполнением следующих задач:

> [!div class="checklist"]
> * Создание группы ресурсов и виртуальной машины
> * Включение диагностики загрузки на виртуальной машине.
> * Просмотр диагностики загрузки
> * Просмотр метрик узла
> * Включение Azure Monitor для виртуальных машин
> * Просмотр метрик виртуальной машины.
> * Создание оповещения

Перейдите к следующему руководству, чтобы узнать о центре безопасности Azure.

> [!div class="nextstepaction"]
> [Мониторинг защиты виртуальных машин с помощью центра безопасности Azure](../tutorial-azure-security.md)
