---
title: Использование xrdp с Linux
description: Узнайте, как установить и настроить удаленный рабочий стол (xrdp) для подключения к виртуальной машине Linux в Azure с помощью графических средств.
services: virtual-machines
author: cynthn
ms.service: virtual-machines
ms.collection: linux
ms.workload: infrastructure-services
ms.topic: how-to
ms.date: 03/03/2021
ms.author: cynthn
ms.openlocfilehash: 84960e6247edc708bedb899c96ebf7522397269a
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "104580374"
---
# <a name="install-and-configure-xrdp-to-use-remote-desktop-with-ubuntu"></a>Установка и настройка xrdp для использования удаленный рабочий стол с Ubuntu

Управление виртуальными машинами Linux в Azure обычно осуществляется из командной строки с помощью подключения Secure Shell (SSH). Если вы только начинаете работу с Linux или хотите быстро устранить неполадки, проще всего использовать удаленный рабочий стол. В этой статье подробно описано, как установить и настроить среду рабочего стола ([Xfce](https://www.xfce.org)) и удаленный рабочий стол ([xrdp](http://xrdp.org)) для виртуальной машины Linux под управлением Ubuntu.

Эта статья была записанныйа и протестирована с помощью виртуальной машины Ubuntu 18,04. 

## <a name="prerequisites"></a>Предварительные требования

Для работы с этой статьей требуется существующая виртуальная машина Ubuntu 18.04 LTS в Azure. Если требуется создать виртуальную машину, используйте один из следующих методов:

- [Интерфейс командной строки Azure](quick-create-cli.md)
- [портал Azure](quick-create-portal.md).


## <a name="install-a-desktop-environment-on-your-linux-vm"></a>Установка среды рабочего стола на виртуальной машине Linux

На большинстве виртуальных машин Linux в Azure по умолчанию не установлена среда рабочего стола. Управление виртуальными машинами Linux обычно осуществляется через SSH-подключения, а не с помощью рабочего стола. В Linux можно использовать различные среды рабочего стола. Выбранная среда рабочего стола может занимать 1–2 ГБ места на диске, а для установки и настройки всех необходимых пакетов может потребоваться 5–10 минут.

С помощью приведенного ниже примера кода можно установить упрощенную среду рабочего стола [xfce4](https://www.xfce.org/) на виртуальной машине Ubuntu 18.04 LTS. Команды для других дистрибутивов незначительно отличаются. Например, для установки на виртуальной машине Red Hat Enterprise Linux используйте `yum` и настройте соответствующие правила `selinux`, а для установки на виртуальной машине SUSE используйте `zypper`.

Сначала установите SSH-подключение к виртуальной машине. Следующий пример подключается к виртуальной машине *myvm.westus.cloudapp.azure.com* с использованием имени пользователя *azureuser*. Используйте собственные значения:

```bash
ssh azureuser@myvm.westus.cloudapp.azure.com
```

Если вы используете Windows и нуждаетесь в дополнительных сведениях об использовании SSH, см. статью [Использование SSH с Windows в Azure](ssh-from-windows.md).

Затем установите xfce с помощью `apt` следующим образом:

```bash
sudo apt-get update
sudo apt-get -y install xfce4
```

## <a name="install-and-configure-a-remote-desktop-server"></a>Установка и настройка сервера удаленных рабочих столов
После установки среды рабочего стола настройте службу удаленного рабочего стола для прослушивания входящих подключений. [xrdp](http://xrdp.org) — это сервер RDP с открытым исходным кодом, доступный в большинстве дистрибутивов Linux и совместимый с xfce. Установите xrdp на виртуальной машине Ubuntu следующим образом:

```bash
sudo apt-get -y install xrdp
sudo systemctl enable xrdp
```

Укажите, какую среду рабочего стола должен использовать сервер xrdp при запуске сеанса. Настройте xrdp для использования xfce в качестве среды рабочего стола с помощью следующего кода:

```bash
echo xfce4-session >~/.xsession
```

Перезапустите службу xrdp, чтобы изменения вступили в силу:

```bash
sudo service xrdp restart
```


## <a name="set-a-local-user-account-password"></a>Настройка пароля локальной учетной записи пользователя
Если вы создали пароль для учетной записи пользователя при создании виртуальной машины, пропустите этот шаг. Если вы используете только проверку подлинности с помощью ключа SSH и пароль локальной учетной записи не задан, укажите пароль, прежде чем использовать xrdp для входа на виртуальную машину. xrdp не принимает ключи SSH для проверки подлинности. В следующем примере задается пароль для учетной записи пользователя *azureuser*.

```bash
sudo passwd azureuser
```

> [!NOTE]
> После указания пароля конфигурация SSHD не обновится таким образом, чтобы разрешить вход с помощью пароля, если такая возможность в настоящее время не настроена. С точки зрения безопасности лучше подключиться к виртуальной машине через туннель SSH с помощью проверки подлинности на основе ключа, а затем подключиться к xrdp. В таком случае можно пропустить следующий шаг по созданию правила группы безопасности сети, разрешающего трафик с удаленного рабочего стола.


## <a name="create-a-network-security-group-rule-for-remote-desktop-traffic"></a>Создание правила группы безопасности сети, разрешающего трафик с удаленного рабочего стола
Чтобы трафик с удаленного рабочего стола мог поступать на виртуальную машину Linux, необходимо создать правило группы безопасности сети, разрешающее использовать протокол TCP на порту 3389 для доступа к виртуальной машине. Дополнительные сведения о правилах групп безопасности сети см. в статье [Безопасность сети](../../virtual-network/network-security-groups-overview.md). Вы также можете [создать правило группы безопасности сети с помощью портала Azure](../windows/nsg-quickstart-portal.md).

В следующем примере создается правило группы безопасности сети с именем [az vm open-port](/cli/azure/vm#az-vm-open-port) на порту *3389*. Из Azure CLI, а не сеанса SSH с виртуальной машиной, откройте следующее правило группы безопасности сети:

```azurecli
az vm open-port --resource-group myResourceGroup --name myVM --port 3389
```


## <a name="connect-your-linux-vm-with-a-remote-desktop-client"></a>Подключение к виртуальной машине Linux с помощью клиента удаленного рабочего стола

Откройте локальный клиент удаленного рабочего стола и подключитесь с помощью IP-адреса или DNS-имени виртуальной машины Linux. 

:::image type="content" source="media/use-remote-desktop/remote-desktop.png" alt-text="Снимок экрана клиента удаленного рабочего стола.":::

Введите имя пользователя и пароль для учетной записи пользователя на виртуальной машине:

:::image type="content" source="media/use-remote-desktop/xrdp-login.png" alt-text="Снимок экрана: экран входа в xrdp.":::

После проверки подлинности загрузится среда рабочего стола xfce. Она будет выглядеть примерно так:

![Среда рабочего стола xfce при подключении через xrdp](./media/use-remote-desktop/xfce-desktop-environment.png)

Если локальный RDP-клиент использует проверку подлинности на уровне сети (NLA), то может потребоваться отключить эту настройку подключения. В настоящее время XRDP не поддерживает NLA. Вы можете также воспользоваться альтернативными решениями для RDP, которые поддерживают NLA, такими как [FreeRDP](https://www.freerdp.com).


## <a name="troubleshoot"></a>Диагностика
Если не удается подключиться к виртуальной машине Linux с помощью клиента удаленного рабочего стола, используйте `netstat` на виртуальной машине Linux, чтобы убедиться, что она прослушивает RDP-подключения:

```bash
sudo netstat -plnt | grep rdp
```

В следующем примере показана виртуальная машина, прослушивающая TCP-порт 3389, как и ожидалось:

```bash
tcp     0     0      127.0.0.1:3350     0.0.0.0:*     LISTEN     53192/xrdp-sesman
tcp     0     0      0.0.0.0:3389       0.0.0.0:*     LISTEN     53188/xrdp
```

Если служба *xrdp-sesman* не выполняет прослушивание, перезапустите службу на виртуальной машине Ubuntu следующим образом:

```bash
sudo service xrdp restart
```

Просмотрите журналы в папке */var/log* на виртуальной машине Ubuntu, чтобы узнать, почему служба не отвечает. Вы также можете проверять системный журнал на предмет ошибок во время попыток подключения к удаленному рабочему столу:

```bash
tail -f /var/log/syslog
```

В других дистрибутивах Linux, например Red Hat Enterprise Linux и SUSE, способы перезапуска служб и расположение файла журнала могут отличаться.

Если ответ не поступает в клиент удаленного рабочего стола, а события не отображаются в системном журнале, это означает, что трафик с удаленного рабочего стола не достигает виртуальной машины. Проверьте правила групп безопасности сети и убедитесь, что в их числе есть правило, разрешающее трафик по протоколу TCP через порт 3389. Дополнительные сведения см. в статье [Устранение проблем с подключением к приложениям на виртуальных машинах Linux в Azure](/troubleshoot/azure/virtual-machines/troubleshoot-app-connection).


## <a name="next-steps"></a>Дальнейшие действия
Дополнительные сведения о создании и использовании ключей SSH на виртуальных машинах Linux см. в статье [Создание пары из открытого и закрытого ключей SSH для виртуальных машин Linux](mac-create-ssh-keys.md).

Сведения об использовании SSH в Windows см. в статье [Использование SSH с Windows в Azure](ssh-from-windows.md).