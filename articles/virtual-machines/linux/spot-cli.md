---
title: Развертывание виртуальных машин Azure на месте с помощью интерфейса командной строки
description: Узнайте, как использовать интерфейс командной строки для развертывания виртуальных машин Azure на месте, чтобы сэкономить затраты.
author: cynthn
ms.service: virtual-machines
ms.subservice: spot
ms.workload: infrastructure-services
ms.topic: how-to
ms.date: 03/22/2021
ms.author: cynthn
ms.reviewer: jagaveer
ms.openlocfilehash: 90ad35757834c14abdffb017ff31b3296074ca24
ms.sourcegitcommit: ba3a4d58a17021a922f763095ddc3cf768b11336
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/23/2021
ms.locfileid: "104802443"
---
# <a name="deploy-azure-spot-virtual-machines-using-the-azure-cli"></a>Развертывание виртуальных машин с использованием точки Azure с помощью Azure CLI

Используя [виртуальные машины Azure](../spot-vms.md) , вы можете использовать преимущества нашей неиспользуемой емкости с значительной экономией затрат. В любой момент, когда Azure нужна емкость, инфраструктура Azure будет выключать виртуальные машины Azure. Таким образом, виртуальные машины Azure для виртуальных машин отлично подходят для рабочих нагрузок, которые могут обрабатывать прерывания, такие как задания пакетной обработки, среды разработки и тестирования, большие вычислительные рабочие нагрузки и многое другое.

Цены на виртуальные машины Azure для машинного хранения являются переменными на основе региона и SKU. Дополнительные сведения см. на страницах с информацией о ценах на виртуальные машины [Linux](https://azure.microsoft.com/pricing/details/virtual-machines/linux/) и [Windows](https://azure.microsoft.com/pricing/details/virtual-machines/windows/). 

Вы можете задать максимальную цену, которую вы хотите платить, в час, для виртуальной машины. Максимальная цена для виртуальной машины точки Azure может быть задана в долларах США (USD), в которой используется до 5 десятичных разрядов. Например, значение `0.98765` определяет максимальную цену 0,98765 долларов США в час. Если вы укажете для максимальной цены значение `-1`, виртуальная машине не будет вытесняться по критерию цены. Цена для виртуальной машины будет соответствовать текущей цене на виртуальную машину Azure для машинного курса или стоимость для стандартной виртуальной машины, которая когда-либо будет меньше, если есть доступная емкость и квота. Дополнительные сведения о настройке максимальной цены см. в статье о [ценах на виртуальные машины Azure](../spot-vms.md#pricing).

Процесс создания виртуальной машины Azure с помощью Azure CLI аналогичен описанному в [статье Краткое руководство](./quick-create-cli.md). Просто добавьте параметр "--Priority плашка", установите для параметра значение " `--eviction-policy` освобождение" (по умолчанию) или `Delete` и укажите максимальную цену или `-1` . 


## <a name="install-azure-cli"></a>Установка Azure CLI

Чтобы создать виртуальные машины Azure для точки, необходимо запустить Azure CLI версии 2.0.74 или более поздней. Чтобы узнать версию, выполните команду **az --version**. Если вам необходимо выполнить установку или обновление, см. статью [Установка Azure CLI](/cli/azure/install-azure-cli). 

Затем войдите в Azure с помощью команды [az login](/cli/azure/reference-index#az-login).

```azurecli-interactive
az login
```

## <a name="create-an-azure-spot-virtual-machine"></a>Создание виртуальной машины с помощью точки Azure

В этом примере показано, как развернуть виртуальную машину Linux в Azure, которая не будет исключена на основе цены. Политика вытеснения устанавливается таким образом, чтобы освободить виртуальную машину, чтобы ее можно было перезапустить позднее. Если вы хотите удалить виртуальную машину и базовый диск при удалении виртуальной машины, задайте для параметра значение `--eviction-policy` `Delete` .

```azurecli-interactive
az group create -n mySpotGroup -l eastus
az vm create \
    --resource-group mySpotGroup \
    --name myVM \
    --image UbuntuLTS \
    --admin-username azureuser \
    --generate-ssh-keys \
    --priority Spot \
    --max-price -1 \
    --eviction-policy Deallocate
```



После создания виртуальной машины можно выполнить запрос, чтобы увидеть максимальную стоимость выставления счетов для всех виртуальных машин в группе ресурсов.

```azurecli-interactive
az vm list \
   -g mySpotGroup \
   --query '[].{Name:name, MaxPrice:billingProfile.maxPrice}' \
   --output table
```

## <a name="simulate-an-eviction"></a>Имитация вытеснения

Вы можете имитировать вытеснение виртуальной машины в машинном коде Azure с помощью функции RESTFUL, PowerShell или интерфейса командной строки, чтобы проверить, насколько хорошо ваше приложение будет реагировать на внезапное вытеснение.

В большинстве случаев необходимо использовать REST API [виртуальные машины — имитировать вытеснение](/rest/api/compute/virtualmachines/simulateeviction) , чтобы помочь в автоматическом тестировании приложений. Для остальных компонентов `Response Code: 204` означает, что имитация вытеснения прошла успешно. Имитацию вытеснений можно объединить с [запланированной службой событий](scheduled-events.md), чтобы автоматизировать реакцию приложения на то, что виртуальная машина будет удалена.

Чтобы просмотреть запланированные события в действии, просмотрите [пятницу Azure с помощью запланированные события Azure, чтобы подготовиться к обслуживанию виртуальных машин](https://channel9.msdn.com/Shows/Azure-Friday/Using-Azure-Scheduled-Events-to-Prepare-for-VM-Maintenance).


### <a name="quick-test"></a>Быстрый тест

Для быстрой проверки того, как будет работать имитация вытеснения, давайте рассмотрим запрос запланированной службы событий, чтобы увидеть, как она выглядит при имитации вытеснения с помощью Azure CLI.

Служба запланированных событий включена для службы при первом выполнении запроса событий. 

Выполните удаленную работу в виртуальной машине, а затем откройте командную строку. 

В командной строке на виртуальной машине введите:

```
curl -H Metadata:true http://169.254.169.254/metadata/scheduledevents?api-version=2019-08-01
```

Первый ответ может занять до 2 минут. Теперь они должны отображать выходные данные практически сразу же.

На компьютере с установленным Azure CLI (например, на локальном компьютере) имитируйте вытеснение с помощью команды [AZ VM имитиру-вытеснение](https://docs.microsoft.com/cli/azure/vm#az_vm_simulate_eviction). Замените имя группы ресурсов и имя виртуальной машины собственными. 

```azurecli-interactive
az vm simulate-eviction --resource-group mySpotRG --name mySpot
```

Выходные данные ответа будут иметься, `Status: Succeeded` Если запрос был успешно выполнен.

Быстро вернитесь к удаленному подключению к своей виртуальной машине и повторите запрос к конечной точке Запланированные события. Повторите следующую команду, пока не получите выходные данные, содержащие дополнительные сведения:

```
curl -H Metadata:true http://169.254.169.254/metadata/scheduledevents?api-version=2019-08-01
```

Когда служба запланированных событий получает уведомление о вытеснении, вы получите ответ, похожий на следующий:

```output
{"DocumentIncarnation":1,"Events":[{"EventId":"A123BC45-1234-5678-AB90-ABCDEF123456","EventStatus":"Scheduled","EventType":"Preempt","ResourceType":"VirtualMachine","Resources":["myspotvm"],"NotBefore":"Tue, 16 Mar 2021 00:58:46 GMT","Description":"","EventSource":"Platform"}]}
```

Видно, что `"EventType":"Preempt"` ресурс является ресурсом виртуальной машины `"Resources":["myspotvm"]` . 

Вы также можете увидеть, когда виртуальная машина будет удалена, установив флажок `"NotBefore"` — Виртуальная машина не будет удалена до истечения заданного времени, чтобы ваше окно приложения было корректно закрыто.


## <a name="next-steps"></a>Следующие шаги

Вы также можете создать виртуальную машину Azure с помощью [Azure PowerShell](../windows/spot-powershell.md), [портала](../spot-portal.md)или [шаблона](spot-template.md).

Запросите текущие сведения о ценах с помощью [API розничных цен Azure](/rest/api/cost-management/retail-prices/azure-retail-prices) , чтобы получить сведения о виртуальной машине Azure для точки. Объект `meterName` и `skuName` будет содержать `Spot` .

Если возникает ошибка, см. раздел [коды ошибок](../error-codes-spot.md).
