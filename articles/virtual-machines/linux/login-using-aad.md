---
title: Вход на виртуальную машину Linux с учетными данными Azure Active Directory
description: Узнайте, как создать и настроить виртуальную машину Linux для входа с помощью Azure Active Directory проверки подлинности.
author: SanDeo-MSFT
ms.service: virtual-machines-linux
ms.topic: how-to
ms.workload: infrastructure
ms.date: 11/17/2020
ms.author: sandeo
ms.openlocfilehash: 3e50b6209c7790853158a1d2be2f42d625b6753b
ms.sourcegitcommit: aaa65bd769eb2e234e42cfb07d7d459a2cc273ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/27/2021
ms.locfileid: "98882133"
---
# <a name="preview-log-in-to-a-linux-virtual-machine-in-azure-using-azure-active-directory-authentication"></a>Предварительный просмотр. Войдите на виртуальную машину Linux в Azure, используя проверку подлинности Azure Active Directory

Для повышения безопасности виртуальных машин Linux в Azure их можно интегрировать с аутентификацией Azure Active Directory (AD). При аутентификации Azure AD для виртуальных машин Linux осуществляется централизованное управление и применение политик, которые разрешают или запрещают доступ к виртуальным машинам. В этой статье показано, как создать и настроить виртуальную машину Linux для аутентификации Azure AD.


> [!IMPORTANT]
> Azure Active Directoryная проверка подлинности в настоящее время доступна в предварительной версии.
> Эта предварительная версия предоставляется без соглашения об уровне обслуживания и не рекомендована для использования рабочей среде. Некоторые функции могут не поддерживаться или их возможности могут быть ограничены. Дополнительные сведения см. в статье [Дополнительные условия использования предварительных выпусков Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).
> Функцию следует применять на виртуальной машине, которая будет использоваться только для тестирования.
>


Есть много преимуществ аутентификации Azure AD при входе на виртуальные машины Linux в Azure, в том числе следующие:

- **Улучшенная безопасность:**
  - Для входа на виртуальные машины Linux в Azure можно использовать корпоративные учетные данные AD. Нет необходимости создавать учетные записи локального администратора и управлять временем существования учетных данных.
  - Так как учетные записи локального администратора не требуются, вам не придется беспокоиться о потере или краже учетных данных, недостаточной надежности учетных данных пользователей и т. д.
  - Политики сложности паролей и времени их существования, настроенные для вашего каталога Azure AD, также помогают защитить виртуальные машины Linux.
  - Для дальнейшей защиты входа на виртуальные машины Azure можно настроить аутентификацию MFA.
  - Возможность войти на виртуальные машины Linux с помощью Azure Active Directory также доступна для клиентов, использующих [службы федерации](../../active-directory/hybrid/how-to-connect-fed-whatis.md).

- **Удобная совместная работа:** С помощью управления доступом на основе ролей Azure (Azure RBAC) можно указать, кто может входить в данную виртуальную машину как обычный пользователь или с правами администратора. Когда пользователи присоединяются к команде или отменяют ее, вы можете обновить политику RBAC Azure для виртуальной машины, чтобы предоставить доступ соответствующим образом. Это намного проще, чем очистка виртуальных машин вручную для удаления ненужных открытых ключей SSH. Когда сотрудники уходят из вашей организации, а их учетная запись пользователя отключается или удаляется из Azure AD, они теряют доступ к вашим ресурсам.

## <a name="supported-azure-regions-and-linux-distributions"></a>Поддерживаемые регионы Azure и дистрибутивы Linux

В режиме предварительной версии этой функции сейчас поддерживаются следующие дистрибутивы Linux:

| Distribution | Версия |
| --- | --- |
| CentOS | CentOS 6, CentOS 7 |
| Debian | Debian 9 |
| openSUSE | openSUSE Leap 42.3 |
| RedHat Enterprise Linux | RHEL 6, RHEL 7 | 
| SUSE Linux Enterprise Server | SLES 12 |
| Сервер Ubuntu | Ubuntu 14.04 LTS, Ubuntu Server 16.04 и Ubuntu Server 18.04 |


В режиме предварительной версии этой функции сейчас поддерживаются следующие регионы Azure:

- Все глобальные регионы Azure

>[!IMPORTANT]
> Чтобы использовать эту предварительную версию функции, развертывайте только поддерживаемые дистрибутивы Linux и в поддерживаемых регионах Azure. Функция не поддерживается в Azure для государственных организаций и в национальных облаках.
>
> Использование этого расширения в кластерах Azure Kubernetes Service (AKS) не поддерживается. Дополнительные сведения см. в разделе [политики поддержки для AKS](../../aks/support-policies.md).


Чтобы установить и использовать интерфейс командной строки локально, для работы с этим руководством вам понадобится Azure CLI 2.0.31 или более поздней версии. Чтобы узнать версию, выполните команду `az --version`. Если вам необходимо выполнить установку или обновление, см. статью [Установка Azure CLI 2.0]( /cli/azure/install-azure-cli).

## <a name="network-requirements"></a>Требования к сети

Чтобы включить аутентификацию Azure AD для виртуальных машин Linux в Azure, необходимо убедиться, что конфигурация сети виртуальных машин разрешает исходящий доступ к следующим конечным точкам через TCP-порт 443:

* https:\//login.microsoftonline.com
* https:\//login.windows.net
* HTTPS: \/ /Device.Login.microsoftonline.com
* HTTPS: \/ /PAS.Windows.NET
* https:\//management.azure.com
* HTTPS: \/ /Packages.Microsoft.com

> [!NOTE]
> Сейчас нельзя настроить группы безопасности сети Azure для виртуальных машин, включенных с помощью аутентификации Azure AD.

## <a name="create-a-linux-virtual-machine"></a>Создание виртуальной машины Linux

Создайте группу ресурсов с помощью команды [az group create](/cli/azure/group#az-group-create), а затем — виртуальную машину с помощью команды [az vm create](/cli/azure/vm#az-vm-create), используя поддерживаемый дистрибутив в поддерживаемом регионе. В приведенном ниже примере развертывается виртуальная машина с именем *myVM*, использующая *Ubuntu 16.04 LTS*, в группе ресурсов с именем *myResourceGroup* в регионе *southcentralus*. В следующих примерах можно при необходимости указать собственную группу ресурсов и имена виртуальных машин.

```azurecli-interactive
az group create --name myResourceGroup --location southcentralus

az vm create \
    --resource-group myResourceGroup \
    --name myVM \
    --image UbuntuLTS \
    --admin-username azureuser \
    --generate-ssh-keys
```

Создание виртуальной машины и вспомогательных ресурсов занимает несколько минут.

## <a name="install-the-azure-ad-login-vm-extension"></a>Установка расширения для входа на виртуальную машину с помощью Azure AD

> [!NOTE]
> При развертывании этого расширения на ранее созданную виртуальную машину убедитесь, что на компьютере установлено по меньшей мере 1 ГБ памяти, поэтому расширение не будет установлено.

Чтобы войти на виртуальную машину Linux с учетными данными Azure AD, установите Azure Active Directory расширение виртуальной машины для входа. Расширения виртуальных машин — это небольшие приложения, которые выполняют задачи настройки и автоматизации после развертывания виртуальных машин Azure. С помощью команды [az vm extension set](/cli/azure/vm/extension#az-vm-extension-set) установите расширение *AADLoginForLinux* на виртуальную машину с именем *myVM* в группе ресурсов *myResourceGroup*:

```azurecli-interactive
az vm extension set \
    --publisher Microsoft.Azure.ActiveDirectory.LinuxSSH \
    --name AADLoginForLinux \
    --resource-group myResourceGroup \
    --vm-name myVM
```

После успешной установки расширения на виртуальной машине отображается *ProvisioningState* *успешно* . Для установки расширения виртуальной машине требуется работающий агент виртуальной машины. Дополнительные сведения см. в статье [Общие сведения о агенте ВМ](../extensions/agent-windows.md).

## <a name="configure-role-assignments-for-the-vm"></a>Настройка назначений ролей для виртуальной машины

Политика управления доступом на основе ролей Azure (Azure RBAC) определяет, кто может входить в виртуальную машину. Для авторизации имени входа виртуальной машины используются две роли Azure:

- **Имя для входа администратора виртуальной машины.** Пользователи с этой ролью могут входить на виртуальную машину Azure с правами администратора Windows или привилегированного пользователя Linux.
- **Имя для входа пользователя виртуальной машины.** Пользователи с этой ролью могут входить на виртуальную машину Azure с правами обычного пользователя.

> [!NOTE]
> Чтобы разрешить пользователю входить в на виртуальную машину через SSH, необходимо назначить ему роль *Имя для входа администратора виртуальной машины* или *Имя для входа пользователя виртуальной машины*. Роли входа администратора виртуальной машины и пользователя виртуальной машины используют действия с данными и поэтому не могут быть назначены в области группы управления. В настоящее время эти роли можно назначать только в подписке, группе ресурсов или области ресурсов. Пользователю Azure с ролью *Владелец* или *Участник*, назначенной для виртуальной машины, права для входа на эту виртуальную машину через SSH не предоставляются автоматически. 

В следующем примере используется команда [az role assignment create](/cli/azure/role/assignment#az-role-assignment-create) для назначения роли *Имя для входа администратора виртуальной машины* виртуальной машине текущего пользователя Azure. Имя пользователя активной учетной записи Azure можно получить с помощью команды [az account show](/cli/azure/account#az-account-show). В качестве *области* задается виртуальная машина, созданная на предыдущем шаге с помощью команды [az vm show](/cli/azure/vm#az-vm-show). Область может также быть назначена на уровне группы ресурсов или подписки, и применяются обычные разрешения на наследование Azure RBAC. Дополнительные сведения см. в разделе [Azure RBAC](../../role-based-access-control/overview.md) .

```azurecli-interactive
username=$(az account show --query user.name --output tsv)
vm=$(az vm show --resource-group myResourceGroup --name myVM --query id -o tsv)

az role assignment create \
    --role "Virtual Machine Administrator Login" \
    --assignee $username \
    --scope $vm
```

> [!NOTE]
> Если домен AAD и домен имени пользователя для входа не совпадают, необходимо указать идентификатор объекта учетной записи пользователя, предоставив *идентификатор объекта уполномоченного*, а не только имя пользователя *уполномоченного*. Идентификатор объекта учетной записи пользователя можно получить с помощью команды [az ad user list](/cli/azure/ad/user#az-ad-user-list).

Дополнительные сведения об использовании Azure RBAC для управления доступом к ресурсам подписки Azure см. в разделе Использование [Azure CLI](../../role-based-access-control/role-assignments-cli.md), [портал Azure](../../role-based-access-control/role-assignments-portal.md)или [Azure PowerShell](../../role-based-access-control/role-assignments-powershell.md).

## <a name="using-conditional-access"></a>Использование условного доступа

Вы можете применить политики условного доступа, такие как многофакторная проверка подлинности или проверка риска входа пользователя, прежде чем авторизовать доступ к виртуальным машинам Linux в Azure, которые включены с входом в Azure AD. Чтобы применить политику условного доступа, необходимо выбрать приложение "вход в виртуальную машину Azure" в параметрах облачных приложений или назначения действий, а затем использовать риск входа в качестве условия и/или требовать многофакторную проверку подлинности в качестве предоставления контроля доступа. 

> [!WARNING]
> Многофакторная проверка подлинности Azure AD для каждого пользователя включена и не поддерживается для входа на виртуальную машину.

## <a name="log-in-to-the-linux-virtual-machine"></a>Вход на виртуальную машину Linux

Сначала просмотрите общедоступный IP-адрес виртуальной машины с помощью команды [az vm show](/cli/azure/vm#az-vm-show):

```azurecli-interactive
az vm show --resource-group myResourceGroup --name myVM -d --query publicIps -o tsv
```

Войдите на виртуальную машину Azure с Linux, используя учетные данные Azure AD. Параметр `-l` позволяет указать собственный адрес учетной записи Azure AD. Замените пример учетной записи своим собственным. Адреса учетных записей следует вводить в нижнем регистре. Замените IP-адрес в примере общедоступным IP-адресом виртуальной машины из предыдущей команды.

```console
ssh -l azureuser@contoso.onmicrosoft.com 10.11.123.456
```

Вам будет предложено войти в Azure AD с помощью однократного использования кода в [https://microsoft.com/devicelogin](https://microsoft.com/devicelogin) . Скопируйте и вставьте однократное использование кода на страницу входа в устройство.

При появлении запроса введите учетные данные для входа в Azure AD на странице входа. 

При успешной проверке подлинности в веб-браузере отображается следующее сообщение: `You have signed in to the Microsoft Azure Linux Virtual Machine Sign-In application on your device.`

Закройте окно браузера, вернитесь к запросу SSH и нажмите клавишу **ВВОД**. 

Теперь вы выполнили вход на виртуальную машину Azure под управлением Linux с разрешениями назначенных ролей, таких как *пользователь виртуальной машины* или *администратор виртуальной машины*. Если учетной записи пользователя назначена роль *входа администратора виртуальной машины* , можно использовать `sudo` для выполнения команд, требующих привилегий root.

## <a name="sudo-and-aad-login"></a>Вход с использованием sudo и Azure AD

При первом выполнении sudo вам нужно пройти проверку подлинности во второй раз. Чтобы не проходить повторную проверку подлинности при выполнении sudo, вы можете изменить в файле sudoers `/etc/sudoers.d/aad_admins` следующую строку:

```bash
%aad_admins ALL=(ALL) ALL
```

Вставьте вместо нее эту строку:

```bash
%aad_admins ALL=(ALL) NOPASSWD:ALL
```


## <a name="troubleshoot-sign-in-issues"></a>Устранение неполадок при входе

В некоторых распространенных ошибках при попытке SSH с учетными данными Azure AD не назначены роли Azure, а также повторяются запросы на вход. Используйте следующие разделы для устранения этих проблем.

### <a name="access-denied-azure-role-not-assigned"></a>Отказано в доступе: роль Azure не назначена

Если в командной строке SSH отображается следующая ошибка, убедитесь, что для ВИРТУАЛЬНОЙ машины настроены политики RBAC Azure, которые предоставляют пользователю *имя входа администратора виртуальной машины* или роль *входа пользователя виртуальной машины* .

```output
login as: azureuser@contoso.onmicrosoft.com
Using keyboard-interactive authentication.
To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code FJX327AXD to authenticate. Press ENTER when ready.
Using keyboard-interactive authentication.
Access denied:  to sign-in you be assigned a role with action 'Microsoft.Compute/virtualMachines/login/action', for example 'Virtual Machine User Login'
Access denied
```
> [!NOTE]
> Если вы используете проблемы с назначениями ролей Azure, см. статью [Устранение неполадок в Azure RBAC](../../role-based-access-control/troubleshooting.md#azure-role-assignments-limit).

### <a name="continued-ssh-sign-in-prompts"></a>Непрерывные запросы на вход SSH

Если вы успешно прошли аутентификацию в веб-браузере, может сразу же поступить повторный запрос на вход со свежим кодом. Эта ошибка обычно вызывается несоответствием между именем входа, указанным в командной строке SSH, и учетной записью, с которой вы вошли в Azure AD. Для решения этой проблемы сделайте следующее:

- Проверьте, правильно ли указано имя входа в командной строке SSH. Опечатка в имени входа может вызвать несоответствие между именем входа, указанным в командной строке SSH, и учетной записью, с которой вы вошли в Azure AD. Например, вы ввели *азуресуер \@ contoso.onmicrosoft.com* вместо *azureuser \@ contoso.onmicrosoft.com*.
- Если у вас есть несколько учетных записей пользователя, убедитесь, что при входе в Azure AD в окне браузера не была указана другая учетная запись.
- В операционной системе Linux учитывается регистр. Различие между "Azureuser@contoso.onmicrosoft.com" и "azureuser@contoso.onmicrosoft.com" может вызвать несоответствие. Убедитесь в том, что имя участника-пользователя указано в командной строке SSH в правильном регистре.

### <a name="other-limitations"></a>Другие ограничения

Пользователи, которые наследуют права доступа через вложенные группы или назначения ролей, в настоящее время не поддерживаются. Пользователю или группе должны быть непосредственно назначены [требуемые назначения ролей](#configure-role-assignments-for-the-vm). Например, при использовании групп управления или назначений ролей вложенных групп не предоставляются правильные разрешения, позволяющие пользователю входить в систему.

## <a name="preview-feedback"></a>Отзывы о предварительной версии

Поделиться своими отзывами об этой предварительной версии функции или сообщите о проблемах на [форуме отзывов и предложений по Azure AD](https://feedback.azure.com/forums/169401-azure-active-directory?category_id=166032).

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения об Azure Active Directory см. в статье [Что такое Azure Active Directory](../../active-directory/fundamentals/active-directory-whatis.md).