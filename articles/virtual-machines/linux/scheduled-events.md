---
title: Подслужба "Запланированные события" для виртуальных машин Linux в Azure
description: Запланируйте события с помощью службы метаданных Azure, для виртуальных машин Linux.
author: EricRadzikowskiMSFT
ms.service: virtual-machines
ms.subservice: scheduled-events
ms.collection: linux
ms.topic: how-to
ms.workload: infrastructure-services
ms.date: 06/01/2020
ms.author: ericrad
ms.reviewer: mimckitt
ms.openlocfilehash: 8b4f8b064ab19a578ce5854697a1ed9bb0195759
ms.sourcegitcommit: e6de1702d3958a3bea275645eb46e4f2e0f011af
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "102505398"
---
# <a name="azure-metadata-service-scheduled-events-for-linux-vms"></a>Служба метаданных Azure: подслужба "Запланированные события" для виртуальных машин Linux

Запланированные события — это служба метаданных Azure, которая дает время вашему приложению для подготовки к обслуживанию виртуальной машины. Эта служба предоставляет сведения о предстоящем событии обслуживания (например, о перезагрузке), чтобы приложение могло подготовиться к ним и ограничить перебои в работе. Она доступна для всех типов виртуальных машин Azure, включая PaaS и IaaS (как для Windows, так и для Linux). 

Сведения о запланированных событиях, назначенные в Windows, см. в статье [Служба метаданных Azure. Запланированные события (предварительная версия) для виртуальных машин Windows](../windows/scheduled-events.md).

> [!Note] 
> Служба "Запланированные события" общедоступна во всех регионах Azure. В разделе [Доступность версий в регионах](#version-and-region-availability) вы найдете сведения о последних выпусках.

## <a name="why-use-scheduled-events"></a>Почему необходимо использовать запланированные события?

Во многих приложениях время на подготовку к обслуживанию виртуальной машины может положительно повлиять на их работу. Его можно использовать для выполнения конкретных задач по повышению доступности, надежности и удобства обслуживания: 

- создание контрольных точек и восстановление;
- фильтрация подключений;
- отработка отказа первичной реплики;
- удаление из пула подсистемы балансировки нагрузки;
- ведение журнала событий;
- нормальное завершение работы.

Используя запланированные события, приложение может учесть время, когда будет выполняться техническое обслуживание, и запустить задачи для ограничения его влияния.  

Запланированные события предусматривают события в следующих случаях:

- [инициированное платформой обслуживание](../maintenance-and-updates.md?bc=/azure/virtual-machines/linux/breadcrumb/toc.json&toc=/azure/virtual-machines/linux/toc.json) (например, перезагрузка виртуальной машины, динамическая миграция или обновление с сохранением памяти для узла);
- виртуальная машина работает на [оборудовании со сниженной производительностью](https://azure.microsoft.com/blog/find-out-when-your-virtual-machine-hardware-is-degraded-with-scheduled-events), сбой которого прогнозируется в ближайшее время;
- обслуживание, инициированное пользователем (например, пользователь перезагружает или повторно развертывает виртуальную машину).
- Вытеснение экземпляров [точечных виртуальных машин](../spot-vms.md) и [точечных масштабируемых наборов](../../virtual-machine-scale-sets/use-spot.md).

## <a name="the-basics"></a>Основы  

  Служба метаданных предоставляет сведения о работающих виртуальных машинах с помощью конечной точки REST, которая доступна из виртуальной машины. Эта информация предоставляется через немаршрутизируемый IP-адрес, то есть она недоступна вне виртуальной машины.

### <a name="scope"></a>Область
Запланированные события доставляются:

- автономным виртуальным машинам;
- всем виртуальным машинам в облачной службе;
- всем виртуальным машинам в группе доступности;
- Все виртуальные машины в зоне доступности. 
- всем виртуальным машинам в группе размещения масштабируемого набора. 

> [!NOTE]
> Запланированные события, относящиеся к виртуальным машинам в зоне доступности, отправляются на отдельные виртуальные машины в зоне.
> Например, если в группе доступности есть 100 виртуальных машин и имеется обновление одного из них, запланированное событие будет передаваться всем 100, тогда как если в зоне есть 100 одиночных виртуальных машин, то событие будет отправлено только на виртуальную машину, на которую повлияло.

Поэтому проверьте поле `Resources` в событии, чтобы определить, какие виртуальные машины затронуты.

### <a name="endpoint-discovery"></a>Обнаружение конечной точки
Для виртуальных машин с поддержкой виртуальной сети служба метаданных доступна со статического немаршрутизируемого IP-адреса, `169.254.169.254`. Полная конечная точка для последней версии службы "Запланированные события" выглядит так: 

 > `http://169.254.169.254/metadata/scheduledevents?api-version=2019-08-01`

Если виртуальная машина не создается в виртуальной сети, что является стандартным сценарием для облачных служб и классических виртуальных машин, для обнаружения используемого IP-адреса требуется дополнительная логика. Чтобы узнать, как [выполнить обнаружение конечной точки узла](https://github.com/azure-samples/virtual-machines-python-scheduled-events-discover-endpoint-for-non-vnet-vm), просмотрите этот пример.

### <a name="version-and-region-availability"></a>Доступность версий в регионах
Служба запланированных событий имеет версии. Версии являются обязательными. Сейчас используется версия от `2019-08-01`.

| Версия | Тип выпуска | Регионы | Заметки о выпуске | 
| - | - | - | - | 
| 01.08.2019 | Общедоступная версия | All | <li> Добавлена поддержка EventSource |
| 2019-04-01 | Общедоступная версия | All | <li> Добавлена поддержка описания события. |
| 01.01.2019 | Общедоступная версия | All | <li> Добавлена поддержка типа события "Завершение" для масштабируемых наборов виртуальных машин |
| 2017-11-01 | Общедоступная версия | All | <li> Добавлена поддержка типа события "Выгрузка" для исключения точечных виртуальных машин<br> | 
| 2017-08-01 | Общедоступная версия | All | <li> Удалено подчеркивание перед именами ресурсов для виртуальных машин IaaS.<br><li>Требование заголовка метаданных принудительно применяется для всех запросов. | 
| 2017-03-01 | Preview (Предварительный просмотр) | All | <li>Начальный выпуск |


> [!NOTE] 
> В предыдущих выпусках предварительной версии в качестве версии API поддерживалось значение {latest}. Этот формат больше не поддерживается и в дальнейшем будет считаться устаревшим.

### <a name="enabling-and-disabling-scheduled-events"></a>Включение и выключение службы "Запланированные события"
Служба "Запланированные события" включается для вашей службы, когда вы впервые запрашиваете события. При первом вызове возможна задержка ответа до двух минут.

Служба "Запланированные события" выключается для вашей службы, если она не отправляет запросы в течение 24 часов.

### <a name="user-initiated-maintenance"></a>Обслуживание, инициированное пользователем
Обслуживание виртуальных машин, инициированное пользователем на портале Azure, в API, Azure CLI или PowerShell, приведет к созданию запланированных событий. Затем можно протестировать логику подготовки обслуживания в вашем приложении, а также его можно подготовить к обслуживанию, инициированному пользователем.

При перезагрузке виртуальной машины событие с типом `Reboot` добавляется в расписание. При повторном развертывании виртуальной машины событие с типом `Redeploy` добавляется в расписание.

## <a name="use-the-api"></a>Использование API

### <a name="headers"></a>Заголовки
При запросе службы метаданных необходимо указать заголовок `Metadata:true`, чтобы удостовериться, что он не был случайно перенаправлен. Заголовок `Metadata:true` является обязательным для всех запросов запланированных событий. Невозможность включить заголовок в запрос приведет к ответу службы метаданных "Ошибка запроса".

### <a name="query-for-events"></a>Запрос сведений о событиях
Чтобы получить сведения о запланированных событиях, выполните следующий вызов.

#### <a name="bash"></a>Bash
```
curl -H Metadata:true http://169.254.169.254/metadata/scheduledevents?api-version=2019-08-01
```

Ответ содержит массив запланированных событий. Пустой массив означает, что сейчас запланированных событий нет.
Если передаются запланированные события, массив событий в ответе выглядит так: 
```
{
    "DocumentIncarnation": {IncarnationID},
    "Events": [
        {
            "EventId": {eventID},
            "EventType": "Reboot" | "Redeploy" | "Freeze" | "Preempt" | "Terminate",
            "ResourceType": "VirtualMachine",
            "Resources": [{resourceName}],
            "EventStatus": "Scheduled" | "Started",
            "NotBefore": {timeInUTC},       
            "Description": {eventDescription},
            "EventSource" : "Platform" | "User",
        }
    ]
}
```

### <a name="event-properties"></a>Свойства события
|Свойство  |  Описание |
| - | - |
| EventId | Глобальный уникальный идентификатор этого события. <br><br> Пример <br><ul><li>602d9444-d2cd-49c7-8624-8643e7171297  |
| EventType | Влияние, которое оказывает это событие. <br><br> Значения: <br><ul><li> `Freeze`: виртуальная машина будет приостановлена на несколько секунд. Работа ЦП и сетевого подключения будет приостановлена, но это действие не повлияет на память и открытые файлы.<li>`Reboot`: планирование перезагрузки виртуальной машины (временная память будет потеряна). <li>`Redeploy`: виртуальная машина будет перемещена на другой узел с потерей данных на временных дисках. <li>`Preempt`: выполняется удаление точечной виртуальной машины (временные диски теряются). <li> `Terminate`: виртуальная машина запланирована к удалению. |
| ResourceType | Тип ресурса, который затрагивает это событие. <br><br> Значения: <ul><li>`VirtualMachine`|
| Ресурсы| Список ресурсов, на которые влияет это событие. Список обязательно будет содержать виртуальные машины максимум из одного [домена обновления](../availability.md), но в нем не могут содержаться все машины из такого домена. <br><br> Пример <br><ul><li> ["FrontEnd_IN_0", "BackEnd_IN_0"] |
| EventStatus | Состояние этого события. <br><br> Значения: <ul><li>`Scheduled`: это запланированное событие состоится по истечении времени, указанного в свойстве `NotBefore`.<li>`Started`: это событие запущено.</ul> Состояние `Completed` (или аналогичное) никогда не предоставляется. После завершения событие не повторяется.
| NotBefore| Время, после которого это событие может состояться. <br><br> Пример <br><ul><li> Пн, 19 сентября 2016 г., 18:29:47 (GMT)  |
| Описание | Описание этого события. <br><br> Пример <br><ul><li> Сервер узла находится в состоянии обслуживания. |
| EventSource | Инициатор события. <br><br> Пример <br><ul><li> `Platform`: Это событие инициируется платформой. <li>`User`: Это событие инициируется пользователем. |

### <a name="event-scheduling"></a>Планирование события
В зависимости от типа каждое будущее событие будет выполняться минимальное количество времени. Это время отражается в свойстве события `NotBefore`. 

|EventType  | Минимальное время уведомления |
| - | - |
| Freeze| 15 минут |
| Перезагрузка | 15 минут |
| Повторное развертывание | 10 минут. |
| Выгрузка | 30 секунд |
| Завершение | [Настраивается пользователем](../../virtual-machine-scale-sets/virtual-machine-scale-sets-terminate-notification.md#enable-terminate-notifications): 5–15 минут |

> [!NOTE] 
> В некоторых случаях Azure может предсказать сбой узла на основе снижения производительности оборудования и попытаться предотвратить перерыв в обслуживании, запланировав миграцию. Для затронутых виртуальный машин задается запланированное событие с `NotBefore`, которое обычно должно происходить через несколько дней. Фактическое время зависит от оценки риска прогнозируемого сбоя. По возможности Azure пытается уведомить о миграции за 7 дней до нее, но фактическое время может быть меньше, если прогнозируется высокая вероятность сбоя оборудования. Чтобы снизить риск для службы в случае сбоя оборудования до выполнения миграции системой, рекомендуется как можно скорее развернуть виртуальную машину самостоятельно.

### <a name="polling-frequency"></a>Частота опроса

Вы можете опрашивать конечную точку на наличие обновлений как часто или редко. Однако чем дольше время между запросами, тем больше времени вы сможете отреагировать на предстоящее событие. Большинство событий содержат от 5 до 15 минут предварительного уведомления, хотя в некоторых случаях предварительное уведомление может быть не меньше 30 секунд. Чтобы убедиться в том, что у вас есть столько времени, сколько можно уменьшить количество действий, рекомендуется опросить службу раз в секунду.

### <a name="start-an-event"></a>Запуск события 

После того, как вы узнали о предстоящем событии и завершили все действия для корректного завершения работы, вы можете утвердить ожидающее событие, выполнив вызов `POST` к службе метаданных Azure с помощью `EventId`. Этот вызов указывает службе Azure, что она может сократить минимальное время уведомления (если возможно). 

Следующий пример кода JSON ожидается в тексте запроса `POST`. Запрос должен содержать список `StartRequests`. Каждый `StartRequest` содержит `EventId` для события, которое нужно ускорить:
```
{
    "StartRequests" : [
        {
            "EventId": {EventId}
        }
    ]
}
```

#### <a name="bash-sample"></a>Пример Bash
```
curl -H Metadata:true -X POST -d '{"StartRequests": [{"EventId": "f020ba2e-3bc0-4c40-a10b-86575a9eabd5"}]}' http://169.254.169.254/metadata/scheduledevents?api-version=2019-01-01
```

> [!NOTE] 
> Подтверждение событий позволяет выполнить событие для всех ресурсов `Resources` в событии, а не только для виртуальной машины, которая подтверждает событие. Таким образом, можно выбрать "лидера" для координации подтверждения, например первую виртуальную машину в поле `Resources`.

## <a name="python-sample"></a>Пример на языке Python 

В следующем примере выполняется запрос запланированных событий в службе метаданных, а затем утверждение каждого ожидающего события.

```python
#!/usr/bin/python

import json
import socket
import urllib2

metadata_url = "http://169.254.169.254/metadata/scheduledevents?api-version=2019-08-01"
this_host = socket.gethostname()


def get_scheduled_events():
    req = urllib2.Request(metadata_url)
    req.add_header('Metadata', 'true')
    resp = urllib2.urlopen(req)
    data = json.loads(resp.read())
    return data


def handle_scheduled_events(data):
    for evt in data['Events']:
        eventid = evt['EventId']
        status = evt['EventStatus']
        resources = evt['Resources']
        eventtype = evt['EventType']
        resourcetype = evt['ResourceType']
        notbefore = evt['NotBefore'].replace(" ", "_")
    description = evt['Description']
    eventSource = evt['EventSource']
        if this_host in resources:
            print("+ Scheduled Event. This host " + this_host +
                " is scheduled for " + eventtype + 
        " by " + eventSource + 
        " with description " + description +
        " not before " + notbefore)
            # Add logic for handling events here


def main():
    data = get_scheduled_events()
    handle_scheduled_events(data)


if __name__ == '__main__':
    main()
```

## <a name="next-steps"></a>Дальнейшие действия 
- Смотрите демонстрационную версию службы "Запланированные события" в серии [Пятница с Azure](https://channel9.msdn.com/Shows/Azure-Friday/Using-Azure-Scheduled-Events-to-Prepare-for-VM-Maintenance). 
- Просмотрите примеры кода запланированных событий в статье [Azure Metadata Service: Scheduled Events Samples](https://github.com/Azure-Samples/virtual-machines-scheduled-events-discover-endpoint-for-non-vnet-vm) (Служба метаданных Azure: примеры запланированных событий).
- Дополнительные сведения об API, доступных в [службе метаданных экземпляра](instance-metadata-service.md).
- Подробнее о [плановом обслуживании виртуальных машин Linux в Azure](../maintenance-and-updates.md?bc=/azure/virtual-machines/linux/breadcrumb/toc.json&toc=/azure/virtual-machines/linux/toc.json).
