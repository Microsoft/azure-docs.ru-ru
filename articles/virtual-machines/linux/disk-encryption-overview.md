---
title: Включение шифрования дисков Azure для виртуальных машин под управлением Linux
description: В этой статье приведены инструкции по включению шифрования дисков Microsoft Azure для виртуальных машин под управлением Linux.
author: msmbaldwin
ms.service: virtual-machines
ms.subservice: disks
ms.collection: linux
ms.topic: conceptual
ms.author: mbaldwin
ms.date: 08/06/2019
ms.custom: seodec18
ms.openlocfilehash: 81c026893c3185c6c9f960cdb6acb2d0c2d49cc4
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "104580357"
---
# <a name="azure-disk-encryption-for-linux-vms"></a>Шифрование дисков Azure для виртуальных машин под управлением Linux 

Шифрование дисков Azure помогает защитить данные согласно корпоративным обязательствам по обеспечению безопасности и соответствия. Для шифрования томов на дисках с ОС и данными на виртуальных машинах Azure в Linux используется функция [DM-Crypt](https://en.wikipedia.org/wiki/Dm-crypt), а также хранилище [Azure Key Vault](../../key-vault/index.yml), которое помогает управлять ключами шифрования дисков и секретами.

Шифрование дисков Azure является отказоустойчивой зоной, так же как и виртуальными машинами. Дополнительные сведения см. в статье [службы Azure, поддерживающие зоны доступности](../../availability-zones/az-region.md).

Если вы используете [центр безопасности Azure](../../security-center/index.yml), он оповестит вас при наличии незашифрованных виртуальных машин. Вы получите оповещение высокого уровня серьезности вместе c рекомендацией о шифровании таких виртуальных машин.

![Оповещение о шифровании диска в центре безопасности Azure](media/disk-encryption/security-center-disk-encryption-fig1.png)

> [!WARNING]
> - Если вы уже использовали шифрование дисков Azure c Azure AD для шифрования виртуальной машины, применяйте этот способ шифрования виртуальной машины и далее. Подробнее см. в разделе [Шифрование дисков Azure с использованием приложения Azure AD (предыдущий выпуск)](disk-encryption-overview-aad.md). 
> - Выполнение некоторых приведенных рекомендаций может привести к более интенсивному использованию данных, сети или вычислительных ресурсов, а следовательно к дополнительным затратам на лицензии или подписки. Необходима действующая подписка Azure, которая позволяет создавать ресурсы Azure в поддерживаемых регионах.

Статьи [Создание и шифрование виртуальной машины под управлением Linux с помощью краткого руководства по Azure CLI ](disk-encryption-cli-quickstart.md) и [Создание и шифрование виртуальной машины под управлением Linux с помощью краткого руководства по Azure PowerShell](disk-encryption-powershell-quickstart.md) помогут вам изучить основы шифрования дисков Azure для Linux за несколько минут.

## <a name="supported-vms-and-operating-systems"></a>Поддерживаемые виртуальные машины и операционные системы

### <a name="supported-vms"></a>Поддерживаемые виртуальные машины

Виртуальные машины под управлением Linux имеют определенный [диапазон размеров](../sizes.md). Шифрование дисков Azure поддерживается на виртуальных машинах поколения 1 и 2. Шифрование дисков Azure также доступно для виртуальных машин с хранилищем класса Рremium.

См. раздел [размеры виртуальных машин Azure без локального временного диска](../azure-vms-no-temp-disk.md).

Шифрование дисков Azure также недоступно на виртуальных машинах [серии A (Basic)](https://azure.microsoft.com/pricing/details/virtual-machines/series/)или виртуальных машин, которые не соответствуют следующим минимальным требованиям к памяти:

| Виртуальная машина | Минимальные требования к памяти |
|--|--|
| Виртуальные машины под управлением Linux при выполнении шифрования только томов данных| 2 ГБ |
| Виртуальные машины под управлением Linux при шифровании как операционной системы, так и томов данных, если корневая файловая система (/) использует менее 4 ГБ | 8 ГБ |
| Виртуальные машины под управлением Linux при шифровании как операционной системы, так и томов данных, если корневая файловая система (/) использует больше 4 ГБ | Использование корневой файловой системы * 2. Например, если используется 16 ГБ корневой файловой системы, необходимо не менее 32 ГБ ОЗУ. |

Как только процесс шифрования диска ОС будет завершен, виртуальную машину под управлением Linux можно настроить для работы с меньшим объемом памяти.

Дополнительные сведения об исключениях см. в статье [Шифрование дисков Azure. Неподдерживаемые сценарии](disk-encryption-linux.md#unsupported-scenarios).

### <a name="supported-operating-systems"></a>Поддерживаемые операционные системы

Шифрование дисков Azure поддерживается в подмножестве [дистрибутивов Linux, рекомендованных для Azure](endorsed-distros.md), которое само по себе является подмножеством всех возможных дистрибутивов для серверов Linux.

![Диаграмма Венна, показывающие дистрибутивы для серверов Linux, поддерживающих шифрование дисков Azure](./media/disk-encryption/ade-supported-distros.png)

Дистрибутивы для серверов Linux, не рекомендованные для Azure, не поддерживают шифрование дисков Azure. Из рекомендованных поддерживаются только следующие дистрибутивы и версии:


| Издатель | ПРЕДЛОЖЕНИЕ | номер SKU | URN | Тип тома, для которого поддерживается шифрование |
| --- | --- |--- | --- |
| Canonical | Ubuntu | 18.04-LTS | Canonical:UbuntuServer:18.04-LTS:latest | Диск операционной системы и данных |
| Canonical | Ubuntu 18.04 | 18.04-DAILY-LTS | Canonical:UbuntuServer:18.04-DAILY-LTS:latest | Диск операционной системы и данных |
| Canonical | Ubuntu 16.04 | 16.04-DAILY-LTS | Canonical:UbuntuServer:16.04-DAILY-LTS:latest | Диск операционной системы и данных |
| Canonical | Ubuntu 14.04.5</br>[с ядром, оптимизированным для Azure, обновленным до версии 4.15 или более поздней версии](disk-encryption-troubleshooting.md) | 14.04.5-LTS | Canonical:UbuntuServer:14.04.5-LTS:latest | Диск операционной системы и данных |
| Canonical | Ubuntu 14.04.5</br>[с ядром, оптимизированным для Azure, обновленным до версии 4.15 или более поздней версии](disk-encryption-troubleshooting.md) | 14.04.5-DAILY-LTS | Canonical:UbuntuServer:14.04.5-DAILY-LTS:latest | Диск операционной системы и данных |
| RedHat | RHEL 8 — LVM | 8 — LVM | RedHat: RHEL: 8 — LVM: Последняя | ОС и диск данных (см. примечание ниже) |
| RedHat | RHEL 8,2 | 8.2 | RedHat: RHEL: 8.2: Последняя | ОС и диск данных (см. примечание ниже) |
| RedHat | RHEL 8.1 | 8.1 | RedHat: RHEL: 8.1: Последняя версия | ОС и диск данных (см. примечание ниже) |
| RedHat | RHEL 7 — LVM | 7-LVM | RedHat: RHEL: 7 — LVM: 7.8.2020111201 | ОС и диск данных (см. примечание ниже) |
| RedHat | RHEL 7,8 | 7.8 | RedHat: RHEL: 7,8: Последняя | ОС и диск данных (см. примечание ниже) |
| RedHat | RHEL 7.7 | 7.7 | RedHat:RHEL:7.7:latest | ОС и диск данных (см. примечание ниже) |
| RedHat | RHEL 7.6 | 7.6 | RedHat:RHEL:7.6:latest | ОС и диск данных (см. примечание ниже) |
| RedHat | RHEL 7.5 | 7.5 | RedHat:RHEL:7.5:latest | ОС и диск данных (см. примечание ниже) |
| RedHat | RHEL 7.4 | 7.4 | RedHat:RHEL:7.4:latest | ОС и диск данных (см. примечание ниже) |
| RedHat | RHEL 7.3 | 7.3 | RedHat:RHEL:7.3:latest | ОС и диск данных (см. примечание ниже) |
| RedHat | RHEL 7.2; | 7.2 | RedHat:RHEL:7.2:latest | ОС и диск данных (см. примечание ниже) |
| RedHat | RHEL 6.8 | 6,8 | RedHat:RHEL:6.8:latest | Диск данных (см. примечание ниже) |
| RedHat | RHEL 6.7 | 6.7 | RedHat:RHEL:6.7:latest | Диск данных (см. примечание ниже) |
| OpenLogic | CentOS 8 — LVM | 8 — LVM | OpenLogic: CentOS-LVM: 8 — LVM: Последняя | Диск операционной системы и данных |
| OpenLogic | CentOS 8,2 | 8_2 | OpenLogic: CentOS: 8_2: Последняя | Диск операционной системы и данных |
| OpenLogic | CentOS 8,1 | 8_1 | OpenLogic: CentOS: 8_1: Последняя | Диск операционной системы и данных |
| OpenLogic | CentOS 7 — LVM | 7-LVM | OpenLogic: CentOS-LVM: 7 — LVM: 7.8.2020111100 | Диск операционной системы и данных |
| OpenLogic | CentOS 7,8 | 7.8 | OpenLogic: CentOS: 7_8: Последняя | Диск операционной системы и данных |
| OpenLogic | CentOS 7.7 | 7.7 | OpenLogic:CentOS:7.7:latest | Диск операционной системы и данных |
| OpenLogic | CentOS 7.6 | 7.6 | OpenLogic:CentOS:7.6:latest | Диск операционной системы и данных |
| OpenLogic | CentOS 7.5 | 7.5 | OpenLogic:CentOS:7.5:latest | Диск операционной системы и данных |
| OpenLogic | CentOS 7.4 | 7.4 | OpenLogic:CentOS:7.4:latest | Диск операционной системы и данных |
| OpenLogic | CentOS 7.3 | 7.3 | OpenLogic:CentOS:7.3:latest | Диск операционной системы и данных |
| OpenLogic | CentOS 7.2n | 7.2n | OpenLogic:CentOS:7.2n:latest | Диск операционной системы и данных |
| OpenLogic | CentOS 7.1; | 7.1 | OpenLogic:CentOS:7.1:latest | Только диск данных |
| OpenLogic | CentOS 7.0 | 7.0 | OpenLogic:CentOS:7.0:latest | Только диск данных |
| OpenLogic | CentOS 6.8. | 6,8 | OpenLogic:CentOS:6.8:latest | Только диск данных |
| SUSE | openSUSE 42.3 | 42.3 | SUSE:openSUSE-Leap:42.3:latest | Только диск данных |
| SUSE | SLES 12-SP4 | 12-SP4 | SUSE:SLES:12-SP4:latest | Только диск данных |
| SUSE | SLES HPC 12-SP3 | 12-SP3 | SUSE:SLES-HPC:12-SP3:latest | Только диск данных |

> [!NOTE]
> Новая реализация шифрования дисков Azure поддерживается для операционной системы RHEL и диска данных для образов RHEL7 с оплатой по мере использования.  
>
> ADE также поддерживается для образов RHEL Gold с использованием собственной подписки, но только **после** регистрации подписки. Дополнительные сведения см. в статье [Образы Red Hat Enterprise Linux Gold с использованием собственной подписки в Azure](../workloads/redhat/byos.md#encrypt-red-hat-enterprise-linux-bring-your-own-subscription-gold-images)

## <a name="additional-vm-requirements"></a>Дополнительные требования к виртуальным машинам

Для шифрования дисков Azure в системе должны быть установлены модули dm-crypt и vfat. Если вы удалите или отключите vfat от образа по умолчанию, система не сможет считать том ключа и получать ключ, необходимый для разблокировки дисков при последующих перезагрузках. Действия по укреплению безопасности системы, которые удаляют модуль вфат из системы или принудительно расширяют точки подключения и папки ОС на дисках данных, несовместимы с шифрованием дисков Azure. 

Перед включением шифрования диски данных, которые нужно зашифровать, должны быть правильно указаны в /etc/fstab. При создании записей используйте параметр "nofail" и выберите имя устройства постоянного блока (так как имена устройств в формате "/dev/sdX" могут оказаться не связаны с тем же диском при перезагрузке, особенно после шифрования; дополнительные сведения об этом поведении см. в статье: [Устранение неполадок при изменении имени устройства виртуальной машины Linux](/troubleshoot/azure/virtual-machines/troubleshoot-device-names-problems).

Убедитесь, что параметры /etc/fstab для подключения настроены правильно. Чтобы настроить эти параметры, запустите команду mount -a или перезагрузите виртуальную машину и подключите ее заново таким образом. Как только это будет завершено, проверьте выходные данные команды lsblk, чтобы убедиться, что нужный диск все еще подключен. 

- Если файл /etc/fstab не подключает диск должным образом до включения шифрования, служба шифрования дисков Azure не сможет правильно подключить его.
- Служба шифрования дисков Azure переместит информацию о подключении из /etc/fstab в собственный файл конфигурации как часть процесса шифрования. Не волнуйтесь, если увидите, что запись отсутствует в /etc/fstab после завершения шифрования диска данных.
- Перед началом шифрования остановите все службы и процессы, которые могут записывать что-либо на подключенные диски данных, и отключите их, чтобы они не перезапускались автоматически после перезагрузки. Таким образом, файлы на этих разделах будут открыты и процедура шифрования не сможет повторно подключить их, что позволит избежать сбоев. 
- После перезагрузки процессу шифрования дисков Azure потребуется некоторое время для подключения только что зашифрованных дисков. После перезагрузки они не будут доступны сразу. Прежде чем зашифрованные диски станут доступными для других процессов, потребуется некоторое время для их запуска, разблокировки и подключения. Этот процесс может занять более минуты после перезагрузки в зависимости от характеристик системы.

Ниже приведен пример команд, используемых для подключения дисков данных и создания необходимых записей в /etc/fstab:

```bash
UUID0="$(blkid -s UUID -o value /dev/sda1)"
UUID1="$(blkid -s UUID -o value /dev/sda2)"
mkdir /data0
mkdir /data1
echo "UUID=$UUID0 /data0 ext4 defaults,nofail 0 0" >>/etc/fstab
echo "UUID=$UUID1 /data1 ext4 defaults,nofail 0 0" >>/etc/fstab
mount -a
```
## <a name="networking-requirements"></a>Требования к сети

Чтобы использовать функцию шифрования дисков Azure, конфигурация конечной точки сети виртуальной машины под управлением Linux должна соответствовать приведенным ниже требованиям:
  - Виртуальная машина под управлением Linux должна иметь возможность подключиться к конечной точке Azure Active Directory \[login.microsoftonline.com\], чтобы получить маркер для подключения к хранилищу ключей.
  - Для записи ключей шифрования в ваше хранилище ключей виртуальная машина под управлением Linux должна иметь возможность подключиться к конечной точке хранилища ключей.
  - Виртуальная машина под управлением Linux должна иметь возможность подключиться к конечной точке службы хранилища Azure, в которой размещен репозиторий расширений Azure, и к учетной записи хранения Azure, в которой размещены VHD-файлы.
  -  Если ваша политика безопасности ограничивает доступ к Интернету с виртуальных машин Azure, можно разрешить указанный выше универсальный код ресурса (URI) и настроить определенное правило, чтобы разрешить исходящие подключения к данным IP-адресам. Дополнительные сведения см. в статье [Доступ к Azure Key Vault из-за брандмауэра](../../key-vault/general/access-behind-firewall.md).  

## <a name="encryption-key-storage-requirements"></a>Требования к хранилищу ключей шифрования  

Службе шифрования дисков Azure необходимо Azure Key Vault, чтобы управлять секретами и ключами шифрования дисков и контролировать их. Хранилище ключей и виртуальные машины должны находиться в одном регионе и подписке Azure.

Дополнительные сведения см. в статье [Создание и настройка хранилища ключей для шифрования дисков Azure](disk-encryption-key-vault.md).

## <a name="terminology"></a>Терминология

В следующей таблице приводятся распространенные термины, используемые в документации по шифрованию дисков Azure.

| Терминология | Определение |
| --- | --- |
| Azure Key Vault | Key Vault представляет собой службу управления криптографическими ключами. Она основана на аппаратных модулях безопасности, соответствующих Федеральному стандарту обработки информации (FIPS). Эти стандарты позволяют надежно хранить криптографические ключи и конфиденциальные данные. Дополнительные сведения см. в документации по [Azure Key Vault](https://azure.microsoft.com/services/key-vault/) и в статье [Создание и настройка хранилища ключей для шифрования дисков Azure](disk-encryption-key-vault.md). |
| Azure CLI | [Azure CLI](/cli/azure/install-azure-cli) оптимизирован для администрирования ресурсов Azure и управления ими из командной строки.|
| DM-Crypt |[DM-Crypt](https://gitlab.com/cryptsetup/cryptsetup/wikis/DMCrypt) — прозрачная подсистема шифрования дисков на платформе Linux, используемая для шифрования дисков виртуальных машин под управлением Linux. |
| Ключ шифрования ключей (KEK) | Асимметричный ключ (RSA 2048), который применяется для защиты секрета или помещения его в оболочку. Вы можете использовать защищенный HSM ключ или ключ с программной защитой. Дополнительные сведения см. в документации по [Azure Key Vault](https://azure.microsoft.com/services/key-vault/) и в статье [Создание и настройка хранилища ключей для шифрования дисков Azure](disk-encryption-key-vault.md). |
| Командлеты PowerShell | Дополнительные сведения см. в статье [Общие сведения об Azure PowerShell](/powershell/azure/). |


## <a name="next-steps"></a>Дальнейшие действия

- [Краткое руководство. Создание и шифрование виртуальной машины Linux с помощью Azure CLI](disk-encryption-cli-quickstart.md)
- [Краткое руководство. Создание и шифрование виртуальной машины Linux с помощью Azure PowerShell](disk-encryption-powershell-quickstart.md) 
- [Azure Disk Encryption scenarios on Linux VMs](disk-encryption-linux.md) (Сценарии шифрования дисков Azure для виртуальных машин Linux)
- [Скрипт CLI для подготовки предварительных требований для шифрования дисков Azure](https://github.com/ejarvi/ade-cli-getting-started)
- [Скрипт PowerShell для подготовки предварительных требований для шифрования дисков Azure](https://github.com/Azure/azure-powershell/tree/master/src/Compute/Compute/Extension/AzureDiskEncryption/Scripts)
- [Создание и настройка хранилища ключей для шифрования дисков Azure](disk-encryption-key-vault.md)