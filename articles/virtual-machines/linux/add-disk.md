---
title: Добавление диска данных в виртуальную машину Linux с помощью Azure CLI
description: Узнайте, как добавить постоянный диск данных в виртуальную машину Linux с помощью Azure CLI.
author: cynthn
ms.service: virtual-machines
ms.subservice: disks
ms.collection: linux
ms.topic: how-to
ms.date: 08/20/2020
ms.author: cynthn
ms.openlocfilehash: adf6198cf12011c77fcf3f93d4b595ea433ddefd
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "104580391"
---
# <a name="add-a-disk-to-a-linux-vm"></a>Добавление диска к виртуальной машине Linux

Из этой статьи вы узнаете, как добавить в виртуальную машину постоянный диск, на котором можно хранить данные. Эти данные сохранятся даже после повторной подготовки виртуальной машины (например, в ходе обслуживания или изменения размера).


## <a name="attach-a-new-disk-to-a-vm"></a>Подключение нового диска к виртуальной машине

Если вам нужен новый пустой диск с данными в виртуальной машине, то используйте команду [az vm disk attach](/cli/azure/vm/disk) с параметром `--new`. Если виртуальная машина находится в зоне доступности, то диск автоматически создается в одной зоне с виртуальной машиной. Дополнительные сведения см. в статье [Общие сведения о зонах доступности в Azure (предварительная версия)](../../availability-zones/az-overview.md). В следующем примере создается диск с именем *myDataDisk* размером 50 ГБ:

```azurecli
az vm disk attach \
   -g myResourceGroup \
   --vm-name myVM \
   --name myDataDisk \
   --new \
   --size-gb 50
```

## <a name="attach-an-existing-disk"></a>Подключение существующего диска

Чтобы подключить существующий диск, найдите идентификатор диска и укажите его в команде [az vm disk attach](/cli/azure/vm/disk). В следующем примере выполняется запрос диска *myDataDisk* в группе ресурсов *myResourceGroup*, а затем этот диск подключается к виртуальной машине *myVM*:

```azurecli
diskId=$(az disk show -g myResourceGroup -n myDataDisk --query 'id' -o tsv)

az vm disk attach -g myResourceGroup --vm-name myVM --name $diskId
```

## <a name="format-and-mount-the-disk"></a>Форматирование и подключение диска

Чтобы разбить диск на разделы, отформатировать и подключить новый диск к виртуальной машине Linux, подключитесь к своей виртуальной машине по протоколу SSH. Дополнительные сведения см. в статье [Как использовать SSH с Linux в Azure](mac-create-ssh-keys.md). В следующем примере подключается к виртуальной машине с общедоступным IP-адресом *10.123.123.25* с именем пользователя *azureuser*:

```bash
ssh azureuser@10.123.123.25
```

### <a name="find-the-disk"></a>Поиск диска

После подключения к виртуальной машине необходимо найти диск. В этом примере мы используем `lsblk` для перечисления дисков. 

```bash
lsblk -o NAME,HCTL,SIZE,MOUNTPOINT | grep -i "sd"
```

Вы должны увидеть результат, аналогичный приведенному ниже.

```bash
sda     0:0:0:0      30G
├─sda1             29.9G /
├─sda14               4M
└─sda15             106M /boot/efi
sdb     1:0:1:0      14G
└─sdb1               14G /mnt
sdc     3:0:0:0      50G
```

Здесь `sdc` — это диск, который нам нужен, так как он 50G. Если вы не уверены, на каком диске основан только размер, перейдите на страницу виртуальной машины на портале, выберите **диски** и проверьте номер LUN для диска в разделе **диски данных**. 


### <a name="format-the-disk"></a>Форматирование диска

Отформатируйте диск с помощью `parted` , если размер диска равен 2 тебибитес (тиб) или больше, необходимо использовать секционирование GPT, если оно находится в 2TiB, то можно использовать секционирование MBR или GPT. 

> [!NOTE]
> Рекомендуется использовать последнюю версию `parted` , доступную для дистрибутив.
> Если размер диска равен 2 тебибитес (тиб) или больше, необходимо использовать секционирование GPT. Если размер диска составляет 2 Тиб, можно использовать секционирование MBR или GPT.  


В следующем примере используется `parted` On `/dev/sdc` , где первый диск данных обычно находится на большинстве виртуальных машин. Замените на `sdc` правильный параметр для диска. Мы также используем форматирование в файловой системе [XFS](https://xfs.wiki.kernel.org/) .

```bash
sudo parted /dev/sdc --script mklabel gpt mkpart xfspart xfs 0% 100%
sudo mkfs.xfs /dev/sdc1
sudo partprobe /dev/sdc1
```

Используйте [`partprobe`](https://linux.die.net/man/8/partprobe) программу, чтобы убедиться в том, что ядро осведомлено о новом разделе и файловой системе. Невозможность использования `partprobe` может привести к тому, что команды blkid или лслбк не возвращали UUID для новой файловой системы немедленно.


### <a name="mount-the-disk"></a>Подключение диска

Теперь создайте каталог для подключения файловой системы, используя `mkdir`. В следующем примере создается каталог в `/datadrive` :

```bash
sudo mkdir /datadrive
```

Используйте `mount`, чтобы затем подключить файловую систему. В следующем примере секция подключается `/dev/sdc1` к `/datadrive` точке подключения:

```bash
sudo mount /dev/sdc1 /datadrive
```

### <a name="persist-the-mount"></a>Сохранение подключения

Чтобы обеспечить автоматическое повторное подключение диска после перезагрузки, его необходимо добавить в файл */etc/fstab*. Также настоятельно рекомендуется использовать UUID (универсальный уникальный идентификатор) в */etc/fstab* для ссылки на диск, а не только на имя устройства (например, */dev/sdc1*). Если операционная система обнаруживает ошибку диска во время загрузки, использование UUID позволяет избежать подключения ошибочного диска в это расположение. Остальные диски с данными затем получают те же идентификаторы устройств. Чтобы найти UUID нового диска, используйте служебную программу `blkid`:

```bash
sudo blkid
```

Результат должен быть аналогичным приведенному ниже:

```bash
/dev/sda1: LABEL="cloudimg-rootfs" UUID="11111111-1b1b-1c1c-1d1d-1e1e1e1e1e1e" TYPE="ext4" PARTUUID="1a1b1c1d-11aa-1234-1a1a1a1a1a1a"
/dev/sda15: LABEL="UEFI" UUID="BCD7-96A6" TYPE="vfat" PARTUUID="1e1g1cg1h-11aa-1234-1u1u1a1a1u1u"
/dev/sdb1: UUID="22222222-2b2b-2c2c-2d2d-2e2e2e2e2e2e" TYPE="ext4" TYPE="ext4" PARTUUID="1a2b3c4d-01"
/dev/sda14: PARTUUID="2e2g2cg2h-11aa-1234-1u1u1a1a1u1u"
/dev/sdc1: UUID="33333333-3b3b-3c3c-3d3d-3e3e3e3e3e3e" TYPE="xfs" PARTLABEL="xfspart" PARTUUID="c1c2c3c4-1234-cdef-asdf3456ghjk"
```

> [!NOTE]
> Некорректное изменение файла **/etc/fstab** может привести к невозможности загрузить систему. Если у вас есть сомнения, см. инструкции по правильному изменению этого файла в документации дистрибутива. Также рекомендуется перед внесением изменений создать резервную копию файла /etc/fstab.

Затем откройте файл */etc/fstab* в текстовом редакторе, как показано ниже:

```bash
sudo nano /etc/fstab
```

В этом примере используйте значение UUID для `/dev/sdc1` устройства, созданного на предыдущих шагах, и точку подключения `/datadrive` . Добавьте следующую строку в конец `/etc/fstab` файла:

```bash
UUID=33333333-3b3b-3c3c-3d3d-3e3e3e3e3e3e   /datadrive   xfs   defaults,nofail   1   2
```

В этом примере мы используем редактор Nano, поэтому по завершении редактирования файла используйте `Ctrl+O` для записи файла и `Ctrl+X` выхода из редактора.

> [!NOTE]
> Если вы позднее удалите диск данных без редактирования файла fstab, виртуальная машина может не загрузиться. Большинство дистрибутивов поддерживает параметры fstab *nofail* и (или) *nobootwait*. Эти параметры позволяют системе загружаться, даже если диск не подключится во время загрузки. Дополнительные сведения об этих параметрах см. в документации дистрибутива.
>
> Параметр *nofail* обеспечивает запуск виртуальной машины даже в том случае, если файловая система повреждена или отсутствует диск во время загрузки. Без этого параметра может возникнуть ситуация, описанная в записи блога [Cannot SSH to Linux VM due to FSTAB errors](/archive/blogs/linuxonazure/cannot-ssh-to-linux-vm-after-adding-data-disk-to-etcfstab-and-rebooting) (Не удается подключиться к виртуальной машине Linux по протоколу SSH из-за ошибок FSTAB).
>
> Последовательная консоль виртуальной машины Azure может использоваться для доступа к виртуальной машине через консоль, если изменение fstab привело к сбою загрузки. Дополнительные сведения см. в [документации по последовательной консоли](/troubleshoot/azure/virtual-machines/serial-console-linux).

### <a name="trimunmap-support-for-linux-in-azure"></a>Поддержка операций TRIM и UNMAP для Linux в Azure
Некоторые ядра Linux поддерживают операции TRIM и UNMAP для отмены неиспользуемых блоков на диске. Эту функцию особенно удобно использовать в хранилище уровня "Стандартный", чтобы сообщать Azure о том, что удаленные страницы больше не действительны и могут быть удалены. Это позволяет сократить затраты, если вы создаете большие файлы, а затем удаляете их.

Существует два способа включить поддержку операций TRIM в виртуальной машине Linux. Как обычно, обратитесь к документации дистрибутива, чтобы выбрать рекомендуемый метод.

* Используйте параметр подключения `discard` в */etc/fstab*. Ниже приведен пример.

    ```bash
    UUID=33333333-3b3b-3c3c-3d3d-3e3e3e3e3e3e   /datadrive   xfs   defaults,discard   1   2
    ```
* В некоторых случаях параметр `discard` может негативно влиять на производительность. Кроме того, вы можете вручную выполнить команду `fstrim` из командной строки или добавить ее в crontab для регулярного выполнения.

    **Ubuntu**

    ```bash
    sudo apt-get install util-linux
    sudo fstrim /datadrive
    ```

    **RHEL или CentOS**

    ```bash
    sudo yum install util-linux
    sudo fstrim /datadrive
    ```

## <a name="troubleshooting"></a>Устранение неполадок

[!INCLUDE [virtual-machines-linux-lunzero](../../../includes/virtual-machines-linux-lunzero.md)]

## <a name="next-steps"></a>Дальнейшие действия

* Ознакомьтесь с рекомендациями по [оптимизации производительности виртуальной машины Linux](/previous-versions/azure/virtual-machines/linux/optimization) , чтобы правильно настроить виртуальную машину Linux.
* Увеличьте емкость хранилища, добавив дополнительные диски, и [настройте RAID](/previous-versions/azure/virtual-machines/linux/configure-raid) для повышения производительности.