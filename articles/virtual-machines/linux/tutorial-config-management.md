---
title: Учебник. Управление конфигурацией виртуальных машин Linux в Azure
description: В этом учебнике описано, как выявлять пакетные обновления и управлять ими на виртуальных машинах Linux.
services: virtual-machines
documentationcenter: virtual-machines
author: mgoedtel
manager: gwallace
editor: ''
tags: azure-resource-manager
ms.assetid: ''
ms.service: virtual-machines
ms.collection: linux
ms.topic: tutorial
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure
ms.date: 09/27/2019
ms.author: magoedte
ms.custom: mvc, devx-track-azurecli
ms.openlocfilehash: 979cac8fd3d2c09443d52c9142a5e7c44127713a
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "102552537"
---
# <a name="tutorial-monitor-changes-and-update-a-linux-virtual-machine-in-azure"></a>Руководство по Мониторинг изменений и обновление виртуальных машин Linux в Azure

Решение [Отслеживание изменений](../../automation/change-tracking/overview.md) в Azure позволяет легко выявлять изменения, а решение [Управление обновлениями](../../automation/update-management/overview.md) — управлять обновлениями операционной системы на виртуальных машинах Linux в Azure.

В этом руководстве описано следующее:

> [!div class="checklist"]
> * Управление обновления Linux
> * Мониторинг изменений и инвентаризация

[!INCLUDE [azure-cli-prepare-your-environment.md](../../../includes/azure-cli-prepare-your-environment.md)]

- Для работы с этим учебником требуется Azure CLI версии 2.0.30 или более поздней. Если вы используете Azure Cloud Shell, последняя версия уже установлена.

## <a name="create-vm"></a>Создание виртуальной машины

Чтобы увидеть данные диагностики и метрики в действии, необходима виртуальная машина. Сначала создайте группу ресурсов с помощью команды [az group create](/cli/azure/group#az-group-create). В следующем примере создается группа ресурсов с именем *myResourceGroupMonitor* в расположении *eastus*.

```azurecli-interactive
az group create --name myResourceGroupMonitor --location eastus
```

Теперь создайте виртуальную машину командой [az vm create](/cli/azure/vm#az-vm-create). В следующем примере создаются виртуальная машина с именем *myVM* и ключи SSH, если они не существуют в каталоге *~/.ssh/* .

```azurecli-interactive
az vm create \
  --resource-group myResourceGroupMonitor \
  --name myVM \
  --image UbuntuLTS \
  --admin-username azureuser \
  --generate-ssh-keys
```

## <a name="manage-software-updates"></a>Управление обновлениями программного обеспечения

Управление обновлениями позволяет управлять обновлениями и исправлениями виртуальных машин Azure на базе Linux.
Напрямую из виртуальной машины можно быстро оценить состояние доступных обновлений, назначить время установки необходимых обновлений и проверить результаты развертывания, чтобы убедиться, что обновления на виртуальной машине были успешно применены.

Сведения о ценах см. на странице [цены на службу автоматизации](https://azure.microsoft.com/pricing/details/automation/).

### <a name="enable-update-management"></a>Включение управления обновлениями

Включение управления обновлениями для виртуальной машины:

1. В левой части экрана выберите **Виртуальные машины**.
2. Выберите виртуальную машину из списка.
3. На экране виртуальной машины в разделе **Операции** выберите **Управление обновлениями**. Откроется экран **Enable Update management** (Включение управления обновлениями).

Проверка выполняется, чтобы определить, включено ли управление обновлениями для этой виртуальной машины.
При этом проверяется рабочая область Log Analytics и связанная учетная запись службы автоматизации, а также наличие решения в рабочей области.

Рабочая область [Log Analytics](../../azure-monitor/logs/log-query-overview.md) используется для сбора данных, созданных компонентами и службами, такими как "Управление обновлениями".
Рабочая область предоставляет единое расположение для проверки и анализа данных из нескольких источников.
Для выполнения дополнительных действий на виртуальных машинах, требующих обновления, служба автоматизации Azure позволяет выполнять runbook на виртуальных машинах, например для скачивания и применения обновлений.

В процессе проверки также определяется, была ли виртуальная машина подготовлена с помощью агента Log Analytics и гибридной рабочей роли службы автоматизации. Агент позволяет взаимодействовать с виртуальной машиной и получать сведения о состоянии обновления.

Чтобы включить решение, выберите рабочую область Log Analytics и учетную запись службы автоматизации, а затем щелкните **Включить**. Процесс включения решения может занять до 15 минут.

Если во время подключения обнаружится, что отсутствует один из следующих компонентов, он будет автоматически добавлен.

* [Рабочая область Log Analytics](../../azure-monitor/logs/log-query-overview.md).
* [Учетная запись службы автоматизации](../../automation/index.yml)
* [Гибридная рабочая роль runbook](../../automation/automation-hybrid-runbook-worker.md) включена на виртуальной машине.

Откроется экран **Управление обновлениями**. Настройте расположение, рабочую область Log Analytics и учетную запись службы автоматизации, затем щелкните **Включить**. Если эти поля неактивны и выделены серым цветом, то для этой виртуальной машины настроено другое решение автоматизации, а значит необходимо использовать ту же рабочую область и ту же учетную запись службы автоматизации.

![Включение решения по управлению обновлениями](./media/tutorial-monitoring/manage-updates-update-enable.png)

Включение решения может занять до 15 минут. В это время не закрывайте окно браузера. После того как решение включено, сведения об отсутствующих обновлениях на виртуальной машине передаются в журналы Azure Monitor. На получение данных для анализа может уйти от 30 минут до 6 часов.

### <a name="view-update-assessment"></a>Просмотр оценок обновления

После включения решения **Управление обновлениями** отобразится экран **Управление обновлениями**. После оценки обновлений вы увидите список отсутствующих обновлений на вкладке **Отсутствующие обновления**.

 ![Просмотр состояния обновления](./media/tutorial-monitoring/manage-updates-view-status-linux.png)

### <a name="schedule-an-update-deployment"></a>Планирование развертывания обновлений

Чтобы установить обновления, составьте план развертывания в рамках графика выпуска и периода обслуживания. Вы можете выбрать типы обновлений, которые будут включены в развертывание. Например, можно включить только критические обновления или обновления для системы безопасности и исключить накопительные пакеты обновления.

Новое развертывание обновления для виртуальной машины можно запланировать, щелкнув **Schedule update deployment** (Планирование развертывания обновления) в верхней части экрана **Update management** (Управление обновлениями). На экране **New update deployment** (Новое развертывание обновлений) укажите следующие сведения:

Чтобы создать развертывание обновления, выберите **Запланировать развертывание обновлений**. Откроется панель **Новое развертывание обновления**. Введите значения для свойств, описанных в следующей таблице и нажмите **Создать**:

| Свойство | Описание |
| --- | --- |
| Имя |Уникальное имя для идентификации развертывания обновлений. |
|Операционная система| Windows или Linux|
| Группы для обновления |Для виртуальных машин Azure определите запрос на основе сочетания подписки, группы ресурсов, расположения и тегов, чтобы создать динамическую группу виртуальных машин Azure и добавить их в развертывание. </br></br>Для других виртуальных машин выберите сохраненный поисковый запрос, чтобы выбрать такие виртуальные машины и добавить их в развертывание. </br></br>Дополнительные сведения см. в статье [о динамических группах](../../automation/update-management/configure-groups.md).|
| Компьютеры, на которые нужно установить обновления |Щелкните "Сохраненные условия поиска", "Импортировать группу" или выберите "Компьютер" в раскрывающемся списке и выберите нужные компьютеры. Если выберете **Компьютеры**, готовность к обновлению будет показана в столбце **Готовность к обновлению агента**.</br> Дополнительные сведения о различных способах создания групп компьютеров в журналах Azure Monitor см. в статье [Группы компьютеров в запросах к журналам Azure Monitor](../../azure-monitor/logs/computer-groups.md). |
|Классификации обновлений|Выберите все необходимые категории обновления.|
|Включение или исключение обновлений|Позволяет открыть страницу **Включить или исключить**. Обновления, которые можно включить или исключить, находятся на отдельных вкладках. Дополнительные сведения об обработке включений см. в разделе [Планирование развертывания обновлений](../../automation/update-management/deploy-updates.md#schedule-an-update-deployment). |
|Параметры расписания|Выберите время запуска, а затем — однократное применение или повторяющееся.|
| Сценарии предварительного и последующего выполнения|Выберите сценарии, которые будут выполняться до и после развертывания|
| Период обслуживания |Количество минут, установленное для обновлений. Значение должно составлять не менее 30 минут, но не более 6 часов |
| Перезагрузка элемента управления| Определяет, как следует выполнять перезагрузку. Доступные параметры:</br>Перезагрузка при необходимости (по умолчанию)</br>Всегда выполнять перезагрузку</br>Никогда не перезагружать</br>Только перезагрузка без установки обновлений.|

Развертывания обновлений также можно создать программно. Чтобы узнать, как создать развертывание обновлений с помощью REST API, ознакомьтесь со статьей [Software Update Configurations — Create](/rest/api/automation/softwareupdateconfigurations/create) (Конфигурации обновления программного обеспечения. Создание). Кроме того, имеется пример модуля runbook, который можно использовать для создания развертывания еженедельного обновления. Дополнительные сведения об этом модуле runbook см. в статье [Create a weekly update deployment for one or more VMs in a resource group](https://gallery.technet.microsoft.com/scriptcenter/Create-a-weekly-update-2ad359a1) (Создание развертывания еженедельного обновления для одной или нескольких виртуальных машин в группе ресурсов).

Завершив настройку расписания, нажмите кнопку **Создать** и вернитесь к панели мониторинга состояния.
Обратите внимание, что таблица **Запланирован** показывает созданное расписание развертываний.

### <a name="view-results-of-an-update-deployment"></a>Просмотр результатов развертывания обновлений

После запуска запланированного развертывания вы можете контролировать его состояние на вкладке **Развертывания обновлений** раздела **Управление обновлениями**.
Если оно выполняется в данный момент, отображается состояние **Выполнение**. При успешном завершении появится состояние **Выполнено**.
В случае сбоя одного или нескольких обновлений в развертывании для состояния будет установлено значение **Частичный сбой**.
Выберите завершенное развертывание обновлений, чтобы просмотреть панель мониторинга для него.

![Панель мониторинга состояния развертывания обновлений конкретного развертывания](./media/tutorial-monitoring/manage-updates-view-results.png)

Плитка **Update results** (Результаты обновления) является сводкой общего количества обновлений и результатов развертывания на виртуальной машине.
В таблице справа представлен подробный разбор каждого обновления и результатов установки, которые могут принимать одно из следующих значений:

* **Not attempted** (Попытка не предпринималась). Обновление не установлено из-за недостатка времени в связи с заданной длительностью окна обслуживания.
* **Выполнено.** Обновление было успешно выполнено.
* **Сбой.** Обновление не удалось выполнить.

Чтобы просмотреть все записи журнала, созданные при этом развертывании, щелкните **Все журналы**.

Щелкните плитку **Вывод**, чтобы просмотреть поток заданий для модуля runbook, который управляет развертыванием обновления на целевой виртуальной машине.

Чтобы просмотреть подробные сведения об ошибках развертывания, выберите **Ошибки**.

## <a name="monitor-changes-and-inventory"></a>Мониторинг изменений и инвентаризация

Вы можете собирать и просматривать сведения об установленных на компьютерах программном обеспечении, файлах, управляющих программах, службах и разделах реестра Windows. Отслеживание конфигураций поможет вам локализовать операционные проблемы в любом сегменте среды и получить сведения о текущем состоянии компьютеров.

### <a name="enable-change-and-inventory-management"></a>Включение управления изменениями и инвентаризацией

Включите управление изменениями и инвентаризацией для виртуальной машины следующим образом:

1. В левой части экрана выберите **Виртуальные машины**.
2. Выберите виртуальную машину из списка.
3. На экране виртуальной машины в разделе **Операции** выберите **Инвентаризация** или **Отслеживание изменений**. Откроется экран **Отслеживание изменений и инвентаризация**.

Настройте расположение, рабочую область Log Analytics и учетную запись службы автоматизации, затем щелкните **Включить**. Если эти поля неактивны и выделены серым цветом, то для этой виртуальной машины настроено другое решение автоматизации, а значит необходимо использовать ту же рабочую область и ту же учетную запись службы автоматизации. Эти решения представлены в меню отдельно, но по сути являются одним решением. Включение любого из них активирует для виртуальной машины оба решения.

![Включение отслеживания для изменений и инвентаризации](./media/tutorial-monitoring/manage-inventory-enable.png)

После включения потребуется некоторое время, пока будут собраны и отображены данные инвентаризации для виртуальной машины.

### <a name="track-changes"></a>Отслеживание изменений

На виртуальной машине в разделе **Операции** выберите **Отслеживание изменений**. Щелкните **Изменение параметров**, чтобы открыть страницу **Отслеживание изменений**. Выберите тип настроек, которые вы намерены отслеживать, и щелкните **+ Добавить** для настройки параметров. Для Linux доступен параметр **Файлы Linux**.

Подробные сведения об отслеживании изменений см. в статье [Устранение неполадок при изменениях в среде](../../automation/automation-tutorial-troubleshoot-changes.md).

### <a name="view-inventory"></a>Просмотр данных инвентаризации

На виртуальной машине в разделе **Операции** выберите **Учет**. На вкладке **Программное обеспечение** вы найдете таблицу со списком обнаруженного программного обеспечения. В таблице предоставляются обобщенные сведения о каждой строке с информацией о программном обеспечении. Здесь для программного обеспечения указываются: имя, версия, издатель, время последнего обновления.

![Просмотр данных инвентаризации](./media/tutorial-monitoring/inventory-view-results.png)

### <a name="monitor-activity-logs-and-changes"></a>Мониторинг журналов действий и изменений

На странице **Отслеживание изменений** на виртуальной машине выберите **Управление подключением журнала действий**. Эта операция открывает страницу **Журнал действий Azure**. Выберите **Подключить**, чтобы подключить журнал действий Azure для виртуальной машины к службе отслеживания изменений.

Включив этот параметр, перейдите к странице **Обзор** для виртуальной машины и выберите действие **Остановить**, чтобы остановить виртуальную машину. Подтвердите остановку, выбрав **Да** при появлении соответствующего запроса. Когда освобождение виртуальной машины завершится, выберите **Запустить**, чтобы снова запустить ее.

Остановка и запуск виртуальной машины регистрируются как события в журнале действий. Вернитесь к странице **Отслеживание изменений**. Выберите вкладку **События** в нижней части страницы. Через некоторое время события отобразятся на диаграмме и в таблице. Вы можете выбрать любое из этих событий, чтобы просмотреть подробные сведения о нем.

![Просмотр изменений в журнале действий](./media/tutorial-monitoring/manage-activitylog-view-results.png)

Здесь отображаются изменения, произошедшие за определенное время. Когда вы добавите соединение с журналом действий, график в верхней части отобразит события из журнала действий Azure. Каждая строка гистограммы соответствует определенному типу отслеживаемых изменений. К этим типам относятся управляющие программы Linux, файлы и программное обеспечение. Вкладка "Изменения" отображает сведения об изменениях, отсортированные по времени в обратном порядке (первыми показаны самые последние).

## <a name="next-steps"></a>Дальнейшие действия

В этом учебнике вы настроили решения "Отслеживание изменений" и "Управление обновлениями" на виртуальной машине и проверили их. Вы ознакомились с выполнением следующих задач:

> [!div class="checklist"]
> * Создание группы ресурсов и виртуальной машины
> * Управление обновления Linux
> * Мониторинг изменений и инвентаризация

Перейдите к следующему учебнику, чтобы узнать о мониторинге виртуальных машин.

> [!div class="nextstepaction"]
> [Мониторинг виртуальных машин](/previous-versions/azure/virtual-machines/linux/tutorial-monitor)