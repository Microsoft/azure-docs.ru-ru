---
title: Выполнение скриптов оболочки на виртуальной машине Linux в Azure
description: В этом разделе описывается выполнение скриптов на виртуальной машине Azure Linux с помощью функции "Выполнение команд".
services: automation
ms.service: virtual-machines
ms.collection: linux
author: bobbytreed
ms.author: robreed
ms.date: 04/26/2019
ms.topic: how-to
manager: carmonm
ms.openlocfilehash: 73dd15a5eed3e27d9b72bc0357e35901c04ba7a2
ms.sourcegitcommit: e6de1702d3958a3bea275645eb46e4f2e0f011af
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "102552938"
---
# <a name="run-shell-scripts-in-your-linux-vm-by-using-run-command"></a>Выполнение скриптов оболочки в виртуальной машине Linux с помощью функции выполнения команд

Функция выполнения команд использует агент виртуальной машины для выполнения скриптов PowerShell на виртуальной машине Azure Linux. Эти сценарии можно использовать для общего управления компьютерами или приложениями. Они могут помочь вам быстро диагностировать и исправлять проблемы доступа к виртуальной машине и сети, а также восстановить работоспособность виртуальной машины.

## <a name="benefits"></a>Преимущества

Доступ к виртуальным машинам можно получить несколькими способами. Выполнение команд может удаленно реализовывать скрипты на виртуальных машинах с помощью их агента. Выполнение команд можно использовать на портале Microsoft Azure, в [REST API](/rest/api/compute/virtual%20machines%20run%20commands/runcommand) или в [Azure CLI](/cli/azure/vm/run-command#az_vm_run_command_invoke) для виртуальных машин Linux.

Эта возможность полезна во всех сценариях, где требуется выполнить скрипт на виртуальной машине. Это один из способов устранения неполадок и исправления виртуальной машины, на которой не открыт порт RDP или SSH из-за неправильной настройки сети или пользователя с правами администратора.

## <a name="restrictions"></a>Ограничения

При использовании выполнения команд следует принимать во внимание перечисленные ниже ограничения.

* Выводятся только последние 4096 байт.
* Минимальное время выполнения скрипта составляет около 20 секунд.
* По умолчанию в Linux скрипты выполняются от имени привилегированного пользователя.
* Два скрипта не могут выполняться одновременно.
* Скрипты, которые запрашивают сведения (в интерактивном режиме), не поддерживаются.
* Вы не можете отменить выполнение скрипта.
* Максимальное время выполнения скрипта составляет 90 минут. После этого время ожидания скрипта истекает.
* Чтобы вернуть результаты скрипта, требуется разрешить исходящие подключения из виртуальной машины.

> [!NOTE]
> Чтобы выполнение команд работало правильно, требуется подключение (через порт 443) к общедоступным IP-адресам Azure. Если расширение не имеет доступа к этим конечным точкам, скрипты могут успешно выполняться, но результаты не будут возвращаться. Если вы блокируете трафик на виртуальной машине, вы можете использовать [теги служб](../../virtual-network/network-security-groups-overview.md#service-tags), чтобы разрешить трафик к общедоступным IP-адресам Azure с помощью тега `AzureCloud`.

## <a name="available-commands"></a>Доступные команды

В этой таблице представлен список команд, доступных для виртуальных машин Linux. Команду **RunShellScript** можно использовать для выполнения любых пользовательских скриптов. При использовании Azure CLI или PowerShell для выполнения команды значение, указанное для параметра `--command-id` или `-CommandId`, должно быть одним из приведенных ниже значений. При указании значения, которое не является доступной командой, появится следующее сообщение об ошибке.

```error
The entity was not found in this Azure location
```

|**имя**;|**Описание**|
|---|---|
|**RunShellScript**|Выполняет скрипт оболочки Linux.|
|**ifconfig**| Получает конфигурации всех сетевых интерфейсов.|

## <a name="azure-cli"></a>Azure CLI

Ниже приведен пример с использованием команды [az vm run-command](/cli/azure/vm/run-command#az_vm_run_command_invoke) для запуска скрипта оболочки на виртуальной машине Azure Linux.

```azurecli-interactive
az vm run-command invoke -g myResourceGroup -n myVm --command-id RunShellScript --scripts "apt-get update && apt-get install -y nginx"
```

> [!NOTE]
> Для выполнения команд от имени другого пользователя введите `sudo -u`, чтобы указать нужную учетную запись.

## <a name="azure-portal"></a>Портал Azure

Перейдите к виртуальной машине на [портале Azure](https://portal.azure.com) и выберите **Выполнить команду** под пунктом **ОПЕРАЦИИ**. Появится список доступных команд, выполняемых на виртуальной машине.

![Список команд](./media/run-command/run-command-list.png)

Выберите команду для запуска. Некоторые команды могут иметь необязательные или обязательные входные параметры. Параметры для этих команд представлены в виде текстовых полей для ввода входных значений. В каждой команде можно развернуть **Просмотреть скрипт**, чтобы просмотреть выполняемый скрипт. Команда **RunShellScript** отличается от других команд тем, что она позволяет запускать пользовательские скрипты.

> [!NOTE]
> Встроенные команды не редактируются.

Выбрав команду, выберите **Выполнить**, чтобы запустить скрипт. Скрипт выполняется и по завершении выдает результаты и возможные ошибки в окне вывода. На следующем снимке экрана показан пример вывода команды запуска **ifconfig**.

![Вывод сценария команды запуска](./media/run-command/run-command-script-output.png)

### <a name="powershell"></a>PowerShell

Ниже приведен пример с использованием командлета [Invoke-AzVMRunCommand](/powershell/module/az.compute/invoke-azvmruncommand) для выполнения скрипта PowerShell на виртуальной машине Azure. Этот командлет ожидает, что скрипт, указанный в параметре `-ScriptPath`, расположен в локальной среде, в которой выполняется командлет.

```powershell-interactive
Invoke-AzVMRunCommand -ResourceGroupName '<myResourceGroup>' -Name '<myVMName>' -CommandId 'RunShellScript' -ScriptPath '<pathToScript>' -Parameter @{"arg1" = "var1";"arg2" = "var2"}
```

## <a name="limiting-access-to-run-command"></a>Ограничение доступа к команде запуска

Для получения списка выполняемых команд или отображения сведений о команде требуется разрешение `Microsoft.Compute/locations/runCommands/read`. Это разрешение имеется у встроенной роли [Читатель](../../role-based-access-control/built-in-roles.md#reader) и более высоких уровней.

Для выполнения команды требуется разрешение `Microsoft.Compute/virtualMachines/runCommand/action`. Это разрешение имеется у роли [Участник виртуальной машины](../../role-based-access-control/built-in-roles.md#virtual-machine-contributor) и более высоких уровней.

Можно использовать одну из [встроенных ролей](../../role-based-access-control/built-in-roles.md) или создать [пользовательскую роль](../../role-based-access-control/custom-roles.md) для использования функции выполнения команд.

## <a name="next-steps"></a>Дальнейшие действия

Сведения о других способах для удаленного запуска скриптов и команд на виртуальной машине см. в разделе [Выполнение скриптов в виртуальных машинах Linux](run-scripts-in-vm.md).
