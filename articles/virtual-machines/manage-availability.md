---
title: Управление доступностью виртуальных машин Windows в Azure
description: Узнайте, как использовать несколько виртуальных машин для обеспечения высокой доступности приложений в Azure.
author: cynthn
ms.service: virtual-machines
ms.workload: infrastructure-services
ms.topic: conceptual
ms.date: 09/22/2020
ms.author: cynthn
ms.openlocfilehash: 0ae4a311bc4f5084ff930b97d68482d64671a782
ms.sourcegitcommit: b6267bc931ef1a4bd33d67ba76895e14b9d0c661
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/19/2020
ms.locfileid: "97695755"
---
# <a name="manage-the-availability-of-linux-virtual-machines"></a>Управление доступностью виртуальных машин Linux

Изучите способы настройки нескольких виртуальных машин и управления ими для обеспечения высокой доступности приложения Linux в Azure. 


## <a name="understand-vm-reboots---maintenance-vs-downtime"></a>Общие сведения о перезагрузках виртуальной машины. Обслуживание и простой
Есть три сценария, которые могут повлиять на работу виртуальной машины в Azure: незапланированное техническое обслуживание, незапланированный простой и запланированное техническое обслуживание.

* **Событие незапланированного технического обслуживания** возникает, когда платформа Azure прогнозирует, что в оборудовании или в любом компоненте платформы, связанными с физическим компьютером, может произойти ошибка. При выявлении такой ошибки платформа Azure вызывает событие незапланированного технического обслуживания, чтобы уменьшить воздействие на виртуальные машины, размещенные на этом оборудовании. Azure использует технологию [динамической миграции](./maintenance-and-updates.md?bc=%2fazure%2fvirtual-machines%2flinux%2fbreadcrumb%2ftoc.json%252c%2fazure%2fvirtual-machines%2flinux%2fbreadcrumb%2ftoc.json&toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json%253ftoc%253d%2fazure%2fvirtual-machines%2flinux%2ftoc.json), чтобы перенести Виртуальные машины с оборудования, которое работает со сбоями, на работоспособный физический компьютер. Динамическая миграция — это операция обслуживания виртуальной машины, которая всего лишь приостанавливает работу виртуальной машины на короткое время. Память, открытые файлы и сетевые подключения сохраняются, но производительность может уменьшиться до или после события. Если динамическую миграцию невозможно применить, возникает событие незапланированного простоя виртуальных машин, как описано ниже.


* **Непредвиденные простои** при неожиданных отказах оборудования или физической инфраструктуры виртуальной машины. Это могут быть сбои локальной сети или локальных жестких дисков, а также другие ошибки на уровне стойки. При выявлении таких сбоев платформа Azure автоматически переносит виртуальную машину на работоспособный физический компьютер в том же центре обработки данных. Во время восстановления работоспособности виртуальной машины возникает простой (перезагрузка), а в некоторых случаях отключается временный диск. Подключенные диски ОС и диски данных всегда сохраняются.

  Виртуальные машины могут также стать недоступными в случае сбоя или аварии, которые затрагивают весь центр обработки данных или даже весь регион, но это маловероятная ситуация. Для таких сценариев в Azure предусмотрены разные функции защиты, включая [зоны доступности](../availability-zones/az-overview.md) и [пары регионов](regions.md#region-pairs).

* **События запланированного обслуживания** — это периодические обновления, осуществляемые корпорацией Майкрософт на базовой платформе Azure для улучшения общей надежности, производительности и безопасности инфраструктуры платформы, на которой работают ваши виртуальные машины. Большинство этих обновлений выполняются без каких-либо последствий на виртуальных машинах или облачных службах (см. раздел [обслуживание, для которого не требуется перезагрузка](maintenance-and-updates.md#maintenance-that-doesnt-require-a-reboot)). Хотя в большинстве случаев платформа Azure выполняет обслуживание с сохранением виртуальной машины, в некоторых случаях требуется перезагрузить виртуальную машину, чтобы применить необходимые обновления к базовой инфраструктуре. В этом случае можно выполнить плановое техническое обслуживание Azure с операцией повторного развертывания обслуживания. Для этого обслуживание виртуальных машин инициируется в подходящем временном окне. Дополнительные сведения см. в статье [Плановое обслуживание виртуальных машин Windows](maintenance-and-updates.md).


Чтобы уменьшить воздействие простоя из-за одного или нескольких из описанных здесь событий, мы рекомендуем вам выполнить на своих виртуальных машинах следующие действия по обеспечению высокого уровня доступности.

* Использование Зоны доступности для защиты от сбоев центра обработки данных
* Настройка нескольких виртуальных машин в группе доступности для обеспечения избыточности
* Использование управляемых дисков для виртуальных машин в группе доступности
* Использование запланированных событий для упреждающего ответа, влияющие на события виртуальных машин
* Настройка каждого уровня приложений в отдельных группах доступности
* Объединение подсистемы балансировки нагрузки с зонами или группами доступности

## <a name="use-availability-zones-to-protect-from-datacenter-level-failures"></a>Используйте зоны доступности, чтобы обеспечить защиту от сбоев на уровне центра обработки данных

[Зоны доступности](../availability-zones/az-overview.md) — позволяют повысить уровень контроля, обеспечивая доступность приложений и данных на виртуальных машинах. Зоны доступности — уникальные физические расположения в пределах одного региона Azure. Каждая зона состоит из одного или нескольких центров обработки данных, оснащенных независимыми системами электроснабжения, охлаждения и сетевого взаимодействия. Чтобы обеспечить отказоустойчивость, во всех включенных регионах используются минимум три отдельные зоны. Физическое разделение зон доступности в пределах региона защищает приложения и данные от сбоев центров обработки данных. Избыточные между зонами службы реплицируют приложения и данные в зонах доступности, чтобы обеспечить защиту от возникновения единых точек отказа.

Зона доступности в регионе Azure — это сочетание **домена сбоя** и **домена обновления**. Например, если вы создаете три или боле виртуальных машин в трех зонах в регионе Azure, виртуальные машины эффективно распределяются между тремя доменами сбоя и тремя доменами обновления. Платформа Azure поддерживает такое распределение между доменами обновления, чтобы виртуальные машины в различных зонах не обновлялись одновременно.

Благодаря зонам доступности Azure предлагает наилучшее в отрасли соглашение об уровне обслуживания с гарантией времени непрерывной работы 99,99 % для виртуальных машин. Вы можете защитить приложения и данные от потери в центре обработки данных, настроив свои решения для использования реплицированных виртуальных машин в зонах доступности. В случае неполадок с одной зоной реплицированные приложения и данные сразу же станут доступными в другой зоне.

![Зоны доступности](./media/virtual-machines-common-manage-availability/three-zones-per-region.png)

См. дополнительные сведения о развертывании виртуальных машин [Windows](./windows/create-powershell-availability-zone.md) или [Linux](./linux/create-cli-availability-zone.md) в зонах доступности.

## <a name="configure-multiple-virtual-machines-in-an-availability-set-for-redundancy"></a>Настройка нескольких виртуальных машин в группе доступности для обеспечения избыточности
Группы доступности — это другая конфигурация центра обработки данных, обеспечивающая избыточность и доступность виртуальных машин. Эта конфигурация в пределах центра обработки данных обеспечит доступность не менее одной виртуальной машины и достижение показателя 99,95 % уровня обслуживания Azure при событиях запланированного и незапланированного обслуживания. Дополнительные сведения см. в статье о [соглашении об уровне обслуживания для виртуальных машин](https://azure.microsoft.com/support/legal/sla/virtual-machines/).

> [!IMPORTANT]
> Если виртуальная машина с одним экземпляром в группе доступности использует SSD (цен. категория "Премиум") или Диски (цен. категория "Ультра") для всех дисков операционной системы и дисков данных, в рамках Соглашения об уровне обслуживания ее доступность для подключения гарантированно составляет не менее 99,9 %. 
> 
> Для виртуальной машины с одним экземпляром и SSD ценовой категории "Стандартный" будет предоставляться соглашение об уровне обслуживания, гарантирующее минимальный показатель доступности 99,5 %. Для виртуальной машины с одним экземпляром и HDD ценовой категории "Стандартный" соглашение об уровне обслуживания будет гарантировать минимальный показатель доступности 95 %.  См. страницу [Соглашение об уровне обслуживания для Виртуальных машин](https://azure.microsoft.com/support/legal/sla/virtual-machines/).

Платформа Azure назначает каждой виртуальной машине в группе доступности **домен обновления** и **домен сбоя**. Для заданной группы доступности по умолчанию назначается пять доменов обновления без возможности изменения пользователем (в дальнейшем службы, развернутые с помощью Resource Manager, можно будет расширить до 20 доменов обновления). Это позволяет указывать группы виртуальных машин и базовое физическое оборудование, которые можно одновременно перезагружать. Если в одной группе доступности настраивается более пяти виртуальных машин, шестая виртуальная машина помещается в тот же домен обновления, что и первая виртуальная машина, седьмая — что и вторая, и т. д. Порядок перезагрузки доменов обновления при выполнении запланированного обслуживания может не быть последовательным, но за один раз будет перезагружаться только один домен обновления. Перезагруженному домену обновления предоставляется 30 минут для восстановления, прежде чем будет инициировано обслуживание на другом домене обновления.

Домены сбоя определяют группу виртуальных машин, которые совместно используют общий источник питания и сетевой коммутатор. По умолчанию виртуальные машины, настроенные в группе доступности, разделяются на три домена сбоя для служб, развернутых с помощью Resource Manager, и на два домена сбоя для классического развертывания. Включение виртуальных машин в группу доступности не защитит ваше приложение от сбоев, связанных с операционной системой или приложениями, но минимизирует последствия сбоев физического оборудования, сети и электропитания.

<!--Image reference-->
   ![Схема: конфигурация домена обновления и домена сбоя](./media/virtual-machines-common-manage-availability/ud-fd-configuration.png)

## <a name="use-managed-disks-for-vms-in-an-availability-set"></a>Использование управляемых дисков для виртуальных машин в группе доступности
Если в настоящее время вы используете виртуальные машины с неуправляемыми дисками, мы настоятельно рекомендуем преобразовать неуправляемые диски в управляемые, для [Linux](./linux/convert-unmanaged-to-managed-disks.md) и [Windows](./windows/convert-unmanaged-to-managed-disks.md).

Служба [Управляемые диски](./managed-disks-overview.md) обеспечивает более высокую надежность групп доступности. При ее использовании диски разных виртуальных машин в группе доступности достаточно изолированы друг от друга, что позволяет избежать одиночных точек сбоя. Это обеспечивается за счет автоматического помещения дисков в разные домены сбоя хранилища (кластеры хранилища) и их оптимизации с доменом сбоя виртуальной машины. При неполадках домена сбоя хранилища из-за сбоя оборудования или программного обеспечения происходит сбой только того экземпляра виртуальной машины, диски которого находятся на домене сбоя хранилища.
![Домены сбоя управляемых дисков](./media/virtual-machines-common-manage-availability/md-fd-updated.png)

> [!IMPORTANT]
> Количество доменов сбоя в управляемых группах доступности зависит от региона. На каждый регион выделяется два или три домена сбоя. Чтобы увидеть домен сбоя для каждого региона, запустите следующие скрипты.

```azurepowershell-interactive
Get-AzComputeResourceSku | where{$_.ResourceType -eq 'availabilitySets' -and $_.Name -eq 'Aligned'}
```

```azurecli-interactive 
az vm list-skus --resource-type availabilitySets --query '[?name==`Aligned`].{Location:locationInfo[0].location, MaximumFaultDomainCount:capabilities[0].value}' -o Table
```

> [!NOTE]
> При определенных обстоятельствах две виртуальные машины в одной группе доступности могут совместно использовать один домен сбоя. Это можно проверить, перейдя в группе доступности к столбцу **Домен сбоя**. Совместное использование домена сбоя может быть вызвано выполнением следующей последовательности при развертывании виртуальных машин:
> 1. развертывание первой виртуальной машины;
> 1. остановка и освобождение первой виртуальной машины;
> 1. развертывание второй виртуальной машины.
>
> В этих случаях диск операционной системы второй виртуальной машины может быть создан в том же домене сбоя, что и диск первой виртуальной машины, поэтому вторая виртуальная машина также будет использовать этот домен сбоя. Чтобы избежать этой проблемы, мы рекомендуем не останавливать и не освобождать виртуальные машины между развертываниями.

Если вы планируете использовать виртуальные машины с неуправляемыми дисками, выполните указанные ниже рекомендации для учетных записей хранения, в которых хранятся виртуальные жесткие диски (VHD) виртуальных машин в виде [страничных BLOB-объектов](/rest/api/storageservices/Understanding-Block-Blobs--Append-Blobs--and-Page-Blobs#about-page-blobs).

1. **Храните все диски (операционной системы и данных), связанные с одной виртуальной машиной, в одной учетной записи хранения**.
2. Прежде чем добавлять диски VHD в учетную запись хранения, **просмотрите [ограничения](../storage/blobs/scalability-targets-premium-page-blobs.md) на количество неуправляемых дисков в учетной записи хранения Azure**.
3. **Используйте отдельные учетные записи хранения для каждой виртуальной машины в группе доступности.** Несколько виртуальных машин в одной группе доступности не должны совместно использовать одну учетную запись хранения. Это допустимо для виртуальных машин из разных групп доступности, если соблюдаются все описанные выше рекомендации. ![Домены сбоя неуправляемых дисков](./media/virtual-machines-common-manage-availability/umd-updated.png)

## <a name="use-scheduled-events-to-proactively-respond-to-vm-impacting-events"></a>Использование запланированных событий для упреждающего ответа, влияющие на события виртуальных машин

При подписке на [запланированные события](./linux/scheduled-events.md) виртуальная машина получает уведомления о предстоящих событиях обслуживания, которые могут повлиять на вашу виртуальную машину. Активация запланированных событий предоставляет виртуальной машине минимальный интервал времени перед тем, как будет выполнено обслуживание. Например, если не предпринять какое-либо действие, выполнятся обновления ОС узла, которые могут поставить в очередь виртуальную машину как события, указывающие на влияние и время обслуживания. События расписания также помещаются в очередь, когда Azure обнаруживает неизбежный сбой оборудования, который может повлиять на вашу виртуальную машину, что позволяет вам решить, когда следует выполнить восстановление. Клиенты могут использовать события для выполнения задач перед обслуживанием, например, сохранение состояния, переключение на вторичное устройство и т. д. После того как вы завершите свою логику для корректной обработки события обслуживания, вы можете утвердить ожидающее запланированное событие, чтобы позволить платформе продолжить обслуживание.


## <a name="combine-a-load-balancer-with-availability-zones-or-sets"></a>Объединение подсистемы балансировки нагрузки с зонами или группами доступности
Чтобы обеспечить максимальную устойчивость приложения, объедините [Azure Load Balancer](../load-balancer/load-balancer-overview.md) с зоной или группой доступности. Подсистема балансировки нагрузки Azure распределяет трафик между несколькими виртуальными машинами. Наши виртуальные машины стандартного уровня включают в себя подсистему балансировки нагрузки Azure. Не все уровни виртуальных машин имеют балансировщик нагрузки Azure. Дополнительные сведения о балансировке нагрузки виртуальных машин см. в статье **Балансировка нагрузки виртуальных машин** для [Linux](linux/tutorial-load-balancer.md) или [Windows](windows/tutorial-load-balancer.md).

Если балансировщик нагрузки не настроен для балансировки трафика между несколькими виртуальными машинами, то любое запланированное событие обслуживания оказывает воздействие на единственную виртуальную машину, обслуживающую трафик, что приведет к сбою на уровне приложений. Если включить несколько виртуальных машин одного уровня в одну подсистему балансировки нагрузки и группу доступности, трафик непрерывно будет обслуживаться хотя бы одним экземпляром.

Руководство по балансировке нагрузки между зонами доступности см. в разделе [учебник. Балансировка нагрузки виртуальных машин в разных зонах доступности с помощью Load Balancer (цен. категория "Стандартный") портал Azure](../load-balancer/tutorial-load-balancer-standard-public-zone-redundant-portal.md).


## <a name="next-steps"></a>Дальнейшие действия
Чтобы больше узнать о балансировке нагрузки виртуальных машин, ознакомьтесь с разделом [Балансировка нагрузки виртуальных машин](../load-balancer/load-balancer-overview.md).
