---
title: Вопросы развертывания СУБД для рабочей нагрузки SAP на виртуальных машинах Azure | Документы Майкрософт
description: Вопросы развертывания СУБД для рабочей нагрузки SAP на виртуальных машинах Azure
author: msjuergent
ms.service: virtual-machines-sap
ms.topic: article
ms.date: 09/20/2020
ms.author: juergent
ms.reviewer: cynthn
ms.openlocfilehash: 470b6b0c871d91a2a8a584a6efd04605e0afcf88
ms.sourcegitcommit: b4647f06c0953435af3cb24baaf6d15a5a761a9c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/02/2021
ms.locfileid: "101666846"
---
# <a name="considerations-for-azure-virtual-machines-dbms-deployment-for-sap-workload"></a>Вопросы развертывания СУБД для рабочей нагрузки SAP на виртуальных машинах Azure
[1114181]:https://launchpad.support.sap.com/#/notes/1114181
[1409604]:https://launchpad.support.sap.com/#/notes/1409604
[1597355]:https://launchpad.support.sap.com/#/notes/1597355
[1928533]:https://launchpad.support.sap.com/#/notes/1928533
[1984787]:https://launchpad.support.sap.com/#/notes/1984787
[1999351]:https://launchpad.support.sap.com/#/notes/1999351
[2002167]:https://launchpad.support.sap.com/#/notes/2002167
[2015553]:https://launchpad.support.sap.com/#/notes/2015553
[2039619]:https://launchpad.support.sap.com/#/notes/2039619
[2069760]:https://launchpad.support.sap.com/#/notes/2069760
[2171857]:https://launchpad.support.sap.com/#/notes/2171857
[2178632]:https://launchpad.support.sap.com/#/notes/2178632
[2191498]:https://launchpad.support.sap.com/#/notes/2191498
[2233094]:https://launchpad.support.sap.com/#/notes/2233094
[2243692]:https://launchpad.support.sap.com/#/notes/2243692
[deployment-guide]:deployment-guide.md
[deployment-guide-3]:deployment-guide.md#b3253ee3-d63b-4d74-a49b-185e76c4088e
[planning-guide]:planning-guide.md

[Logo_Linux]:media/virtual-machines-shared-sap-shared/Linux.png
[Logo_Windows]:media/virtual-machines-shared-sap-shared/Windows.png



Это руководство — часть документации по внедрению и развертыванию программного обеспечения SAP в Microsoft Azure. Перед прочтением этого руководства ознакомьтесь с [руководством по планированию и внедрению][planning-guide] и статьями, на которые указывает руководства по планированию. В этом документе рассматриваются аспекты универсального развертывания СУБД, связанного с SAP, на виртуальных машинах Microsoft Azure с использованием возможностей Azure IaaS.

Это руководство дополняет документацию по установке SAP и комментарии по SAP, которые являются основными ресурсами по установке и развертыванию SAP на упомянутых платформах.

В этом документе рассматриваются вопросы запуска связанных с SAP систем СУБД на виртуальных машинах Azure. Также здесь приводятся ссылки на конкретные СУБД. Конкретные СУБД рассматриваются ниже, после этой главы.

## <a name="definitions"></a>Определения
В этом документе мы будем использовать следующие термины:

* **IaaS**: инфраструктура как услуга.
* **PaaS**: платформа как услуга.
* **SaaS**: программное обеспечение как услуга.
* **Компонент SAP**: отдельное приложение SAP, например ERP Central Component (ECC), Business Warehouse (BW), Solution Manager или Enterprise Portal (EP). Компоненты SAP могут основываться на традиционной технологии ABAP или Java или быть приложениями не на основе NetWeaver, например бизнес-объектами.
* **Среда SAP**: один или несколько компонентов SAP, логически сгруппированных для выполнения бизнес-функции (разработка, оценка качества, обучение, аварийное восстановление или производство).
* **Ландшафт SAP**: этот термин обозначает все ресурсы SAP, доступные в клиентском ИТ-ландшафте. Ландшафт SAP включает все рабочие и нерабочие среды.
* **Система SAP**: сочетание уровня СУБД и уровня приложений системы разработки SAP ERP, тестовой системы SAP Business Warehouse и рабочей системы SAP CRM. В развертываниях Azure не поддерживается разделение этих двух уровней между локальной средой и Azure. Таким образом, систему SAP необходимо развернуть полностью в локальной среде или полностью в Azure. Вы можете развертывать разные системы ландшафта SAP как в Azure, так и локально. Например, системы разработки и тестирования SAP CRM можно развернуть в Azure, а производственную систему SAP CRM — в локальной среде.
* **Распределенное развертывание**: описывает сценарии, при которых в подписке Azure развернуты виртуальные машины с подключениями "сеть — сеть" или Azure ExpressRoute между локальными центрами обработки данных и Azure. В документации Azure развертывания такого рода также называются распределенными развертываниями. 

    Такое подключение используется для расширения в Azure локальных доменов, локальной службы Active Directory и локальной службы DNS. Локальная среда распространяется на ресурсы Azure, входящие в подписку. При таком расширении виртуальные машины могут быть частью локального домена. Пользователи локального домена могут получать доступ к серверам и запускать службы на этих виртуальных машинах (например, службы СУБД). Возможно взаимодействие и разрешение имен между виртуальными машинами, развернутыми в локальной сети и Azure. Этот сценарий является наиболее распространенным сценарием развертывания ресурсов SAP в Azure. Дополнительные сведения см. в разделе [Планирование и проектирование VPN-шлюза](../../../vpn-gateway/vpn-gateway-about-vpngateways.md).

> [!NOTE]
> Для рабочих систем SAP поддерживаются распределенные развертывания систем SAP, в которых системы SAP выполняются на виртуальных машинах Azure, являющихся членами локального домена. Распределенная конфигурация предполагает развертывание в Azure полного ландшафта SAP или его частей. Даже если весь ландшафт SAP работает в Azure, эти виртуальные машины должны входить в локальный домен и каталог Active Directory/LDAP. 
>
> В предыдущих версиях документации упоминались гибридные сценарии. Понятие *гибридного* развертывания основано на том факте, что между локальной средой и Azure существует распределенное подключение. В этом случае "гибридное" также означает, что виртуальные машины в Azure являются частью локальной системы Active Directory.
>
>

В некоторых документах Майкрософт сценарии распределенного подключения описываются иначе. В частности, это касается высокодоступных конфигураций СУБД. В документации по SAP сценарий распределенного подключения сводится к двум моментам: к наличию подключения типа "сеть — сеть" или частного подключения [ExpressRoute](https://azure.microsoft.com/services/expressroute/), а также к распределению ландшафта SAP между локальной сетью и Azure.

## <a name="resources"></a>Ресурсы
Существуют и другие статьи по рабочей нагрузке SAP в Azure. Начните с изучения руководства о [начале работы с рабочей нагрузкой SAP в Azure](./get-started.md), а затем выберите интересующую вас область.

Следующие примечания SAP относятся к использованию SAP в Azure в области, описанной в настоящем документе.

| Номер примечания | Title |
| --- | --- |
| [1928533] |Приложения SAP в Azure: поддерживаемые продукты и типы виртуальных машин Azure |
| [2015553] |SAP в Microsoft Azure: необходимые компоненты для поддержки |
| [1999351] |Устранение неполадок, связанных с расширенным мониторингом Azure для SAP |
| [2178632] |Ключевые метрики мониторинга для SAP в Microsoft Azure |
| [1409604] |Виртуализация в Windows: расширенный мониторинг |
| [2191498] |SAP на платформе Linux в Azure: расширенный мониторинг |
| [2039619] |Приложения SAP в Microsoft Azure с использованием Oracle Database: поддерживаемые продукты и версии |
| [2233094] |DB6: приложения SAP в Azure с использованием IBM DB2 для Linux, UNIX и Windows Дополнительные сведения |
| [2243692] |Linux на виртуальной машине Microsoft Azure (IaaS): проблемы с лицензированием SAP |
| [1984787] |SUSE Linux Enterprise Server 12 Замечания по установке |
| [2002167] |Red Hat Enterprise Linux 7.x: Установка и обновление |
| [2069760] |Установка и обновление Oracle Linux 7.x SAP |
| [1597355] |Рекомендация по области буфера для Linux |
| [2171857] |Oracle Database 12c: поддержка файловой системы в Linux |
| [1114181] |Oracle Database 11g: поддержка файловой системы в Linux |


Сведения обо всех примечаниях по SAP для Linux см. на [вики-сайте сообщества SAP](https://wiki.scn.sap.com/wiki/display/HOME/SAPonLinuxNotes).

Вы узнаете об архитектуре Microsoft Azure и о том, как развертываются и эксплуатируются виртуальные машины Microsoft Azure. См. сведения в [документации по Azure](../../../index.yml).

Как правило, установка и настройка Windows, Linux и СУБД в целом выполняются так же, как и для любой локальной виртуальной машины или локального физического компьютера. Но некоторые решения, связанные с архитектурой и реализацией управления системой, в Azure IaaS все же отличаются. В этом документе объясняются конкретные различия в архитектуре и управлении системой, которые следует учитывать при использовании Azure IaaS.


## <a name="storage-structure-of-a-vm-for-rdbms-deployments"></a><a name="65fa79d6-a85f-47ee-890b-22e794f51a64"></a>Структура хранилища виртуальной машины для развертывания реляционной СУБД
Чтобы проследить эту главу, прочитайте и изучите информацию, представленную в:

- [SAP NetWeaver на виртуальных машинах Windows. Руководство по планированию и внедрению](./planning-guide.md)
- [Типы Службы хранилища Azure для рабочей нагрузки SAP](./planning-guide-storage.md)
- [Программное обеспечение SAP, поддерживаемое для развертываний Azure](./sap-supported-product-on-azure.md)
- [Поддерживаемые сценарии использования рабочей нагрузки SAP в виртуальных машинах Azure](./sap-planning-supported-configurations.md) 

Необходимо ознакомиться с различными сериями виртуальных машин и отличиями между хранилищами классов Standard и Premium. 

Для блочного хранилища Azure настоятельно рекомендуется использовать управляемые диски Azure. Дополнительные сведения об управляемых дисках Azure см. в статье [Введение в управляемые диски для виртуальных машин Azure](../../managed-disks-overview.md).

В базовой конфигурации мы обычно рекомендуем структуру развертывания, в которой операционная система, СУБД и двоичные файлы SAP отделены от файлов базы данных. При изменении предыдущих рекомендаций рекомендуется использовать отдельные диски Azure для:

- Операционная система (базовый виртуальный жесткий диск или VHD ОС)
- Исполняемые файлы системы управления базами данных
- Исполняемые файлы SAP, например/usr/SAP

Конфигурация, разделяющая эти компоненты на трех разных дисках Azure, может привести к более высокой устойчивости, так как чрезмерные записи журналов или исполняемых файлов SAP не мешают дисковой квоте диска операционной системы. 

Файлы данных СУБД и журналов транзакций и повторов хранятся в хранилище блоков, поддерживаемом Azure, или Azure NetApp Files. Они хранятся на разных дисках и присоединяются в качестве логических дисков к исходной виртуальной машине с образом ОС Azure. Для развертываний Linux разработаны различные рекомендации, особенно для SAP HANA. Ознакомьтесь со статьей [типы хранилища Azure для рабочей нагрузки SAP](./planning-guide-storage.md) для возможностей и поддержку различных типов хранилищ для вашего сценария. 

При планировании структуры диска следует установить оптимальный баланс между этими элементами:

* Количество файлов данных.
* Число дисков, содержащих файлы.
* Квоты операций ввода-вывода для одного диска или общего ресурса NFS.
* Пропускная способность данных на диск или общую папку NFS.
* Количество дополнительных доступных дисков в зависимости от размера виртуальной машины.
* Общий объем хранилища или пропускной способности сети, которую может предоставить виртуальная машина.
* Задержка для различных типов хранилища Azure.
* Соглашения об уровне обслуживания для виртуальной машины.

Azure применяет квоту операций ввода-вывода на диск данных или общую папку NFS. Эти квоты отличаются для дисков, размещенных в различных решениях и общих ресурсах хранилища Azure. Кроме того, задержка ввода-вывода также различается в разных типах хранилищ. 

Каждый из типов виртуальных машин поддерживает присоединение ограниченного количества дисков. Другое ограничение заключается в том, что можно использовать только определенные типы виртуальных машин, например хранилище класса Premium. Как правило, решение по использованию определенного типа виртуальной машины принимается с учетом требований к ЦП и памяти. Кроме того, можно принять во внимание требования к операциям ввода-вывода, задержкам и пропускной способности диска, которые обычно зависят от числа дисков или типа дисков хранилища класса Premium. Число операций ввода-вывода и пропускная способность, которые должны поддерживаться на каждом диске, могут определять размер диска, особенно для хранилища класса Premium.

> [!NOTE]
> Для развертываний СУБД мы рекомендуем использовать хранилище Azure класса Premium, Ultra Disk или Azure NetApp Files общие ресурсы NFS (исключительно для SAP HANA) для любых данных, журналов транзакций или файлов повторов. Неважно, развертываете ли вы систему, предназначенную или не предназначенную для рабочей среды.

> [!NOTE]
> Чтобы воспользоваться [соглашением об уровне обслуживания для единственной виртуальной машины](https://azure.microsoft.com/support/legal/sla/virtual-machines/v1_8/)Azure, все подключенные диски должны быть в хранилище Azure класса Premium или в формате Ultra Disk для Azure, который включает базовый виртуальный жесткий диск (хранилище Azure класса Premium).

> [!NOTE]
> Размещение основных файлов (файлов данных и журналов) баз данных SAP на оборудовании для хранения данных в расположении, где сторонние центры обработки данных размещаются вместе с центрами обработки данных Azure, не поддерживается. Хранилище, предоставляемое через программные устройства, размещенные на виртуальных машинах Azure, также не поддерживается для этого варианта использования. Для рабочих нагрузок SAP СУБД только хранилище, представленное как собственная служба Azure, поддерживается для файлов данных и журналов транзакций в базах данных SAP в целом. Разные СУБД могут поддерживать различные типы хранилищ Azure. Дополнительные сведения см. в статье [типы хранилища Azure для рабочей нагрузки SAP](./planning-guide-storage.md) .

Размещение файлов базы данных и файлов журнала и повтора, а также тип используемой службы хранилища Azure определяется в соответствии с требованиями к операциям ввода-вывода, задержкам и пропускной способности. В частности, для хранилища Azure класса Premium, чтобы добиться достаточного количества операций ввода-вывода в секунду, можно использовать несколько дисков или диск хранилища класса Premium. При использовании нескольких дисков нужно создать полосу программного чередования между дисками, содержащими файлы данных, файлы журнала и файлы повторных операций. В таких случаях соглашения об уровне обслуживания для операций ввода-вывода в секунду и пропускной способности диска или максимально возможное число операций ввода-вывода в секунду для дисков хранилища класса Standard являются накопительными для результирующего чередующегося набора.

Если потребность в операциях ввода-вывода превышает то, что может предоставить один виртуальный жесткий диск, следует сбалансировать необходимое количество операций ввода-вывода для файлов базы данных в ряде виртуальных жестких дисков. Самый простой способ распределить нагрузку по числу операций ввода-вывода в секунду между дисками — создать полосу программного чередования между несколькими дисками. Затем следует поместить ряд файлов данных СУБД SAP в LUN, полученные из полосы программного чередования. Количество дисков в чередующемся наборе данных зависит от требований операций ввода-вывода в секунду, требований к пропускной способности диска и требований тома.


---
> ![Чередование хранилищ Windows][Logo_Windows] Windows
>
> Мы рекомендуем использовать дисковые пространства Windows для создания чередующихся наборов между несколькими виртуальными жесткими дисками Azure. Используйте как минимум Windows Server 2012 R2 или Windows Server 2016.
>
> ![Чередование хранилищ Linux][Logo_Linux] Linux
>
> Для создания программного RAID-массива в Linux поддерживаются только MDADM и LVM (диспетчер логических томов). Дополнительные сведения см. в разделе:
>
> - [Настройка программного RAID-массива в Linux](/previous-versions/azure/virtual-machines/linux/configure-raid) с помощью MDADM
> - [Настройка диспетчера логических томов на виртуальной машине Linux в Azure](/previous-versions/azure/virtual-machines/linux/configure-lvm) с помощью диспетчера логических томов
>
>

---

Для Azure Ultra Disk чередование не требуется, так как можно определить операции ввода-вывода и пропускную способность диска независимо от размера диска.


> [!NOTE]
> Так как в службе хранилища Azure хранятся три образа виртуальных жестких дисков, настраивать избыточность при чередовании не нужно. Необходимо настроить чередование так, чтобы операции ввода-вывода распределялись между различными виртуальными жесткими дисками.
>

### <a name="managed-or-nonmanaged-disks"></a>Управляемые и неуправляемые диски
Учетная запись хранения Azure является и административной конструкцией, и предметом ограничений. Для учетных записей хранения Standard и Premium действуют разные ограничения. Дополнительные сведения о возможностях и ограничениях см. в статье [Целевые показатели масштабируемости и производительности службы хранилища Azure](../../../storage/common/scalability-targets-standard-account.md).

Помните, что для хранилища класса Standard существует ограничение на количество операций ввода-вывода в секунду на учетную запись хранения. См. строку **Общая частота запросов** в статье [Целевые показатели масштабируемости и производительности службы хранилища Azure](../../../storage/common/scalability-targets-standard-account.md). Кроме того, существует изначальное ограничение на количество учетных записей хранения в одной подписке Azure. Сбалансируйте виртуальные жесткие диски для более крупного ландшафта SAP между несколькими учетными записями хранения, чтобы избежать превышения ограничений этих учетных записей. Если у вас несколько сотен виртуальных машин, а количество виртуальных жестких дисков превышает тысячу, это утомительная работа.

Использование хранилища уровня "Стандартный" для развертываний СУБД в сочетании с рабочей нагрузкой SAP не рекомендуется. Поэтому ссылки и рекомендации для хранилища уровня "Стандартный" ограничиваются этой короткой [статьей](/archive/blogs/mast/configuring-azure-virtual-machines-for-optimal-storage-performance)

Чтобы избежать административной работы, связанной с планированием и развертыванием виртуальных жестких дисков в разных учетных записях хранения Azure, корпорация Майкрософт в 2017 году представила [Управляемые диски Azure](https://azure.microsoft.com/services/managed-disks/). Управляемые диски доступны для хранилища классов Standard и Premium. Ниже перечислены основные преимущества управляемых дисков по сравнению с неуправляемыми дисками.

- Для управляемых дисков Azure автоматически распределяет разные виртуальные жесткие диски в разных учетных записях хранения во время развертывания. Таким образом, ограничения учетной записи хранения для объема данных, пропускной способности ввода-вывода и операций чтения не превышаются.
- За счет использования управляемых дисков служба хранилища Azure соблюдает принципы групп доступности Azure. Если виртуальная машина входит в группу доступности Azure, базовый виртуальный жесткий диск и подключенный диск виртуальной машины развертываются в разных доменах сбоя и обновления.


> [!IMPORTANT]
> Учитывая преимущества управляемых дисков Azure, мы настоятельно рекомендуем использовать управляемые диски Azure для развертывания СУБД и развертываний SAP в целом.
>

Сведения о переключении с неуправляемых дисков на управляемые см. в следующих статьях:

- [Convert a Windows virtual machine from unmanaged disks to managed disks](../../windows/convert-unmanaged-to-managed-disks.md) (Переключение виртуальной машины Windows с неуправляемых на управляемые диски).
- [Convert a Linux virtual machine from unmanaged disks to managed disks](../../linux/convert-unmanaged-to-managed-disks.md) (Переключение виртуальной машины Linux с неуправляемых на управляемые диски).


### <a name="caching-for-vms-and-data-disks"></a><a name="c7abf1f0-c927-4a7c-9c1d-c7b5b3b7212f"></a>Кэширование для виртуальных машин и дисков данных
При подключении дисков к виртуальным машинам вы можете выбрать, будет ли кэшироваться трафик ввода-вывода между виртуальной машиной и этими дисками, размещенными в хранилище Azure.

Приведенные ниже рекомендации даны исходя из следующих характеристик ввода-вывода для СУБД уровня "Стандартный":

- Главным образом используются рабочие нагрузки чтения для файлов данных базы данных. Производительность этих операций чтения критически важна для СУБД.
- Запись в файлы данных происходит скачкообразно на основе контрольных точек или постоянного потока. В среднем за день выполняется меньше операций записи, чем операций чтения. В отличие от операций чтения из файлов данных эти операции записи являются асинхронными и не задерживают пользовательские транзакции.
- Вряд ли возникнут другие ситуации, когда понадобится чтение из журнала транзакций или файлов повторных операций. Исключениями являются крупные операции ввода-вывода при резервном копировании журналов транзакций.
- Основной нагрузкой для файлов журнала транзакций и файлов повторных операций являются операции записи. В зависимости от характера рабочей нагрузки можно иметь операции ввода-вывода размером 4 КБ, тогда как в других случаях размер может превышать 1 МБ.
- Все операции записи должны быть сохранены на диске надежным образом

Для службы хранилища класса Standard возможны следующие типы кэша.

* None
* Чтение
* Чтение/запись

Согласованную и предсказуемую производительность можно получить, задав значение **NONE** для параметра кэширования в службе хранилища класса Standard для всех дисков, содержащих файлы данных, связанные с СУБД, файлы журналов, файлы повторных операций и табличное пространство. Для параметров кэширования основного виртуального жесткого диска можно оставить значения по умолчанию.

Для хранилища Azure класса Premium существуют следующие варианты кэширования.

* None
* Чтение
* Чтение/запись
* Нет + ускоритель записи (только для виртуальных машин Azure серии M)
* Чтение + ускоритель записи (только для виртуальных машин Azure серии M)

Для хранилища класса Premium рекомендуется использовать параметр **Read caching for data files** (Кэширование чтения файлов данных) базы данных SAP и выбрать **No caching for the disks of log file(s)** (Без кэширования дисков файлов журнала).

Для виртуальных машин серии M рекомендуется использовать ускоритель записи Azure для развертывания СУБД. Дополнительные сведения об ускорителе записи Azure, его ограничениях и развертывании см. в статье [Включение ускорителя записи](../../how-to-enable-write-accelerator.md).

Для Ultra Disk и Azure NetApp Files не предлагаются варианты кэширования.


### <a name="azure-nonpersistent-disks"></a>Временные диски Azure
Виртуальные машины Azure предлагают временные диски после развертывания виртуальной машины. В случае перезагрузки виртуальной машины все содержимое временных дисков удаляется. На этих дисках ни в коем случае не следует замещать файлы данных, файлы журнала и файлы повторных операций баз данных. Для некоторых баз данных возможны исключения: для них разрешается размещать на временных дисках табличные пространства tempdb и temp. Не следует использовать эти диски для виртуальных машин серии A, так как пропускная способность временных дисков с этим семейством виртуальных машин ограничена. 

Дополнительные сведения см. в статье [Общие сведения о временном диске на виртуальных машинах Windows в Azure](/archive/blogs/mast/understanding-the-temporary-drive-on-windows-azure-virtual-machines).

---
> ![Несохраняемый диск Windows][Logo_Windows] Windows
>
> Диск D на виртуальной машине Azure — это временный диск, поддерживаемый некоторыми локальными дисками на вычислительном узле Azure. Временный обозначает, что любые изменения содержимого диска D теряются при перезагрузке виртуальной машины. Изменения касаются файлов, которые были сохранены, каталогов, которые были созданы, и приложений, которые были установлены.
>
> ![Линукснонперсистед диск][Logo_Linux] Linux
>
> Виртуальные машины Azure под управлением Linux автоматически подключают диск к каталогу /mnt/resource — временному диску, который поддерживается локальными дисками на вычислительном узле Azure. "Временный" обозначает, что любые изменения содержимого каталога /mnt/resource теряются при перезагрузке виртуальной машины. Изменения касаются файлов, которые были сохранены, каталогов, которые были созданы, и приложений, которые были установлены.
>
>

---



### <a name="microsoft-azure-storage-resiliency"></a><a name="10b041ef-c177-498a-93ed-44b3441ab152"></a>Устойчивость службы хранилища Microsoft Azure
Основной виртуальный жесткий диск (с ОС) и подключенные диски или BLOB-объекты размещаются в службе хранилища Microsoft Azure не менее чем на трех различных узлах хранилища. Этот тип хранилища называется локально избыточным хранилищем (LRS). LRS используется по умолчанию для всех типов хранилищ в Azure.

Существуют и другие методы избыточности. Дополнительные сведения см. в статье [Репликация службы хранилища Azure](../../../storage/common/storage-redundancy.md?toc=%2fazure%2fstorage%2fqueues%2ftoc.json).

> [!NOTE]
> Хранилище Azure уровня "Премиум", Ultra Disk and Azure NetApp Files (исключительно для SAP HANA) — это рекомендуемый тип хранилища для виртуальных машин и дисков СУБД, в которых хранятся файлы базы данных, журналы и повторы. Единственным доступным методом избыточности для этих типов хранения является LRS. Поэтому необходимо настроить методы базы данных для включения репликации данных базы данных в другой регион Azure или зону доступности. Можно использовать такие методы, как SQL Server Always On, Oracle Data Guard и репликация системы HANA.


> [!NOTE]
> В развертываниях СУБД не рекомендуется использовать геоизбыточное хранилище (GRS) для хранилища класса Standard. GRS серьезно влияет на производительность и не учитывает порядок записи на разных виртуальных жестких дисках, подключенных к виртуальной машине. Это может привести к несогласованности баз данных на целевой стороне репликации. Такая ситуация возникает, если файлы базы данных, файлы журнала и файлы повторных операций распределены по нескольким виртуальным жестким дискам, как это обычно бывает на стороне исходной виртуальной машины.



## <a name="vm-node-resiliency"></a>Устойчивость узлов виртуальной машины
Azure предоставляет несколько разных соглашений об уровне обслуживания для виртуальных машин. Дополнительные сведения см. в последнем выпуске [соглашения об уровне обслуживания для виртуальных машин](https://azure.microsoft.com/support/legal/sla/virtual-machines/v1_8/). Поскольку уровень СУБД является критически важным для обеспечения доступности в системе SAP, необходимо понимать, какие группы доступности, Зоны доступности и события обслуживания. Дополнительные сведения об этих понятиях см. в статьях [Управление доступностью виртуальных машин Windows в Azure](../../manage-availability.md) и [Управление доступностью виртуальных машин Linux в Azure](../../manage-availability.md).

Минимальная рекомендация для рабочих сценариев СУБД с рабочей нагрузкой SAP такова:

- Разверните две виртуальные машины в отдельных группах доступности в одном регионе Azure.
- Запустите эти две виртуальные машины в одной и той же виртуальной сети Azure, причем их сетевые адаптеры должны быть подключены к одной и той же подсети.
- Используйте методы базы данных для сервера горячей замены на второй виртуальной машине. Можно использовать такие методы, как SQL Server AlwaysOn, Oracle Data Guard и репликация системы HANA.

Кроме того, можно развернуть третью виртуальную машину в другом регионе Azure и использовать те же методы базы данных, чтобы предоставить асинхронную реплику в другом регионе Azure.

Сведения о настройке групп доступности Azure см. в [этом руководстве](../../windows/tutorial-availability-sets.md).



## <a name="azure-network-considerations"></a>Рекомендации по сети Azure
В крупномасштабных развертываниях SAP используйте схему [виртуального центра обработки данных Azure](/azure/architecture/vdc/networking-virtual-datacenter). Применяйте ее для настройки виртуальной сети, а также назначений разрешений и ролей в различных частях организации.

Приведенные ниже рекомендации были выработаны на основе анализа множества развертываний клиентов.

- Виртуальные сети, в которые развертывается приложение SAP, не должны иметь доступ к Интернету.
- Виртуальные машины базы данных работают в той же виртуальной сети, что и уровень приложения, разделенный в другой подсети на уровне приложений SAP.
- Для виртуальных машин в виртуальной сети должно использоваться статическое выделение частных IP-адресов. Дополнительные сведения см. в статье [Типы IP-адресов и методы их распределения в Azure](../../../virtual-network/public-ip-addresses.md).
- Ограничения маршрутизации к виртуальным машинам СУБД и от них задаются *не* с помощью брандмауэров, установленных на локальных виртуальных машинах СУБД. Вместо этого определяется маршрутизация трафика с использованием [групп безопасности сети](../../../virtual-network/network-security-groups-overview.md).
- Чтобы отделить и изолировать трафик к виртуальной машине СУБД, назначьте виртуальной машине разные сетевые адаптеры. Каждый сетевой адаптер получает свой IP-адрес и назначается другой подсети виртуальной сети. Для каждой подсети действуют собственные правила NSG. Изоляция или отделение сетевого трафика применяются для маршрутизации. Они не используются для задания квот для пропускной способности сети.

> [!NOTE]
> Назначение статических IP-адресов с помощью Azure означает их назначение отдельным виртуальным сетевым адаптерам. Не назначайте статические IP-адреса для виртуальных сетевых адаптеров в гостевой ОС. Некоторые службы Azure, такие как Azure Backup, полагаются на тот факт, что по крайней мере для основного виртуального сетевого адаптера используется DHCP, а не статические IP-адреса. Дополнительные сведения см. в статье [Устранение неполадок резервного копирования на виртуальных машинах Azure](../../../backup/backup-azure-vms-troubleshoot.md#networking). Чтобы назначить виртуальной машине несколько статических IP-адресов, назначьте ей несколько виртуальных сетевых адаптеров.
>


> [!WARNING]
> Настройка [виртуальных сетевых модулей Azure](https://azure.microsoft.com/solutions/network-appliances/) в пути взаимодействия между уровнем приложений SAP и уровнем СУБД SAP NetWeaver, Hybris или системами SAP на основе S/4 HANA не поддерживается. Это ограничение обусловлено вопросами функциональности и производительности. Путь взаимодействия между уровнем приложений SAP и уровнем СУБД должен быть прямым. Это ограничение не относится к [правилам групп безопасности приложений (ASG) и сети (NSG)](../../../virtual-network/network-security-groups-overview.md), если эти правила разрешают прямой путь взаимодействия. 
>
> Ниже приведены другие сценарии, в которых виртуальные сетевые модули не поддерживаются.
>
> * Пути взаимодействия между виртуальными машинами Azure, представляющими узлы кластера Pacemaker в Linux, и устройствами SBD, как описано в статье [Руководство по обеспечению высокого уровня доступности виртуальных машин Azure для SAP NetWeaver на SUSE Linux Enterprise Server для приложений SAP](./high-availability-guide-suse.md).
> * Пути взаимодействия между виртуальными машинами Azure и Windows Server SOFS, настроенными, как описано в статье [Кластеризация экземпляра SAP ASCS/SCS в отказоустойчивом кластере Windows с помощью общей папки в Azure](./sap-high-availability-guide-wsfc-file-share.md). 
>
> Сетевые виртуальные модули в путях взаимодействия данными могут легко удвоить задержку сети между двумя сторонами. Они могут также ограничить пропускную способность в критических путях между уровнем приложений SAP и уровнем СУБД. В некоторых сценариях клиентов сетевые виртуальные модули могут привести к сбою кластеров Pacemaker Linux. Это случаи, когда обмен данными между узлами кластера Linux Pacemaker с устройством SBD осуществляется через сетевой виртуальный модуль.
>

> [!IMPORTANT]
> Еще одно *неподдерживаемое* решение – разделение уровня приложений SAP и уровня СУБД на разные виртуальные сети Azure, не являющиеся [одноранговыми](../../../virtual-network/virtual-network-peering-overview.md). Чтобы отделить уровень приложений SAP от уровня СУБД, рекомендуется использовать подсети одной виртуальной сети Azure, а не разные виртуальные сети Azure. 
>
> Если вы решите не следовать этой рекомендации, а разделить два уровня на разные виртуальные сети, то эти виртуальные сети должны быть [одноранговыми](../../../virtual-network/virtual-network-peering-overview.md). 
>
> Учтите, что за передачу трафика между двумя [одноранговыми](../../../virtual-network/virtual-network-peering-overview.md) виртуальными сетями Azure взимается плата. Между уровнем приложений SAP и уровнем СУБД передается огромный объем трафика в несколько терабайт. Если уровень приложений SAP и уровень СУБД разделяются между двумя одноранговыми виртуальными сетями Azure, вы можете столкнуться со значительными расходами.

Используйте две виртуальные машины для развертывания производственных СУБД в группе доступности Azure или между двумя Зоны доступности Azure. Кроме того, используйте отдельную маршрутизацию для уровня приложений SAP и трафика управления и эксплуатации к двум виртуальным машинам СУБД. См. следующее изображение:

![Схема двух виртуальных машин в двух подсетях](./media/virtual-machines-shared-sap-deployment-guide/general_two_dbms_two_subnets.PNG)


### <a name="use-azure-load-balancer-to-redirect-traffic"></a>Использование Azure Load Balancer для перенаправления трафика
Для использования частных виртуальных IP-адресов, применяемых в таких методах, как SQL Server Always On или репликация системы HANA, необходимо настроить Azure Load Balancer. Подсистема балансировки нагрузки определяет активный узел с помощью проверки портов и направляет трафик только на этот активный узел базы данных. 

В случае отработки отказа для узла базы данных повторно настраивать приложение SAP не нужно. Вместо этого в большинстве распространенных архитектур SAP выполняется повторное подключение к частному виртуальному IP-адресу. В то же время подсистема балансировки нагрузки реагирует на отработку отказа узла, перенаправляя трафик на частный виртуальный IP-адрес второго узла.

Azure предлагает два разных номера SKU [подсистемы балансировки нагрузки](../../../load-balancer/load-balancer-overview.md): номер SKU категории "Базовый" и номер SKU категории "Стандартный". В зависимости от преимуществ установки и функциональности следует использовать стандартный SKU балансировщика нагрузки Azure. Одним из больших преимуществ стандартной версии балансировщика нагрузки является то, что трафик данных не направляется через подсистему балансировки нагрузки.

Пример настройки внутренней подсистемы балансировки нагрузки можно найти в статье [руководство по настройке SQL Server группы доступности на виртуальных машинах Azure вручную.](../../../azure-sql/virtual-machines/windows/availability-group-manually-configure-tutorial.md#create-an-azure-load-balancer)

> [!NOTE]
> Существуют различия в поведении базового и стандартного SKU, связанных с доступом к общедоступным IP-адресам. Способ обойти ограничения уровня "Стандартный" для доступа к общедоступным IP-адресам описывается в статье подключение к общедоступной [конечной точке для виртуальных машин с помощью Load Balancer (цен. Категория "Стандартный") Azure в сценариях высокого уровня доступности SAP](./high-availability-guide-standard-load-balancer-outbound-connections.md) .


### <a name="azure-accelerated-networking"></a>Ускорение работы в сети Azure
Чтобы еще больше сократить сетевую задержку между виртуальными машинами Azure, рекомендуется выбрать [Ускоренную сеть Azure](https://azure.microsoft.com/blog/maximize-your-vm-s-performance-with-accelerated-networking-now-generally-available-for-both-windows-and-linux/). Используйте ее при развертывании виртуальных машин Azure для рабочей нагрузки SAP, особенно для уровня приложений SAP и уровня СУБД SAP.

> [!NOTE]
> Не все типы виртуальных машин поддерживают ускоренную сеть. В предыдущей статье приведен список типов виртуальных машин, поддерживающих ускоренную сеть.
>

---
> ![Windows с ускорением работы в сети][Logo_Windows] Windows
>
> Сведения о развертывании виртуальных машин с ускоренной сетью для Windows см. в статье [Создание виртуальной машины Windows с ускоренной сетью](../../../virtual-network/create-vm-accelerated-networking-powershell.md).
>
> ![Linux с ускоренной сетью][Logo_Linux] Linux
>
> Дополнительные сведения о дистрибутиве Linux см. в статье [Создание виртуальной машины Linux с ускоренной сетью](../../../virtual-network/create-vm-accelerated-networking-cli.md).
>
>

---

> [!NOTE]
> Для SUSE, Red Hat и Oracle Linux функция ускорения сети поддерживается в новых версиях этих дистрибутивов. В более старых версиях, таких как SLES 12 с пакетом обновления 2 (SP2) или RHEL 7.2, ускоренная сеть Azure не поддерживается.
>


## <a name="deployment-of-host-monitoring"></a>Развертывание мониторинга узлов
Для использования приложений SAP на виртуальных машинах Azure в производственных целях системе SAP требуется возможность получения данных мониторинга узлов с физических узлов, на которых работают виртуальные машины Azure. Требуется определенный уровень исправлений SAP HostAgent, включающий эту возможность в SAPOSCOL и SAP HostAgent. Точное описание уровня исправлений указано в примечании к SAP [1409604].

Дополнительные сведения о развертывании компонентов, передающих данные узлов в SAPOSCOL и SAP Host Agent, и об управлении жизненным циклом этих компонентов см. в [руководстве по развертыванию][deployment-guide].


## <a name="next-steps"></a>Дальнейшие действия
Дополнительные сведения о конкретных СУБД см. в следующих статьях:

- [Рабочие нагрузки SAP на Виртуальных машинах Azure. Руководство по развертыванию СУБД SQL Server](dbms_guide_sqlserver.md)
- [Рабочие нагрузки SAP на Виртуальных машинах Azure. Руководство по развертыванию СУБД Oracle](dbms_guide_oracle.md)
- [Рабочие нагрузки SAP на Виртуальных машинах Azure. Руководство по развертыванию СУБД IBM DB2](dbms_guide_ibm.md)
- [Рабочие нагрузки SAP на Виртуальных машинах Azure. Руководство по развертыванию СУБД SAP ASE](dbms_guide_sapase.md)
- [Развертывание SAP MaxDB, liveCache и сервера содержимого на виртуальных машинах Azure](dbms_guide_maxdb.md)
- [Руководство по использованию SAP HANA в Azure](hana-vm-operations.md)
- [Обеспечение высокого уровня доступности для SAP HANA на виртуальных машинах Azure](sap-hana-availability-overview.md)
- [Руководство по резервному копированию SAP HANA на виртуальных машинах Azure](sap-hana-backup-guide.md)