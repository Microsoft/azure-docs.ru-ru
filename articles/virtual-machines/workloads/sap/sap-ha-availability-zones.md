---
title: Конфигурации рабочих нагрузок SAP с использованием Зон доступности Azure | Документация Майкрософт
description: Архитектура с высоким уровнем доступности и сценарии для SAP NetWeaver с использованием Зон доступности Azure
services: virtual-machines-windows,virtual-network,storage
documentationcenter: saponazure
author: msjuergent
manager: bburns
editor: ''
tags: azure-resource-manager
keywords: ''
ms.assetid: 887caaec-02ba-4711-bd4d-204a7d16b32b
ms.service: virtual-machines-windows
ms.subservice: workloads
ms.topic: article
ms.tgt_pltfrm: vm-windows
ms.workload: infrastructure-services
ms.date: 12/29/2020
ms.author: juergent
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: e098256a43add6df026ab136bcd6a6b549c147e7
ms.sourcegitcommit: aaa65bd769eb2e234e42cfb07d7d459a2cc273ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/27/2021
ms.locfileid: "98871321"
---
# <a name="sap-workload-configurations-with-azure-availability-zones"></a>Конфигурации рабочих нагрузок SAP с использованием Зон доступности Azure
Кроме того, для развертывания различных уровней архитектуры SAP в группах доступности Azure можно также использовать более новые [зоны доступности Azure](../../../availability-zones/az-overview.md) для развертываний рабочих нагрузок SAP. Зона доступности Azure определяется как "уникальные физические расположения в пределах региона". Каждая зона состоит из одного или нескольких центров обработки данных, оснащенных независимым питанием, охлаждением и сетью. Зоны доступности Azure недоступны во всех регионах. Для регионов Azure, которые предоставляют Зоны доступности, проверьте [карту региона Azure](https://azure.microsoft.com/global-infrastructure/geographies/). Эта схема показывает, какие регионы предоставляются или объявлены для предоставления Зоны доступности. 

Начиная с стандартной архитектуры SAP NetWeaver или S/4HANA, необходимо защитить три разных уровня:

- Уровень приложений SAP, который может быть одним на несколько десятков виртуальных машин. Необходимо максимально сокращать вероятность развертывания виртуальных машин на одном сервере узла. Вы также хотите, чтобы эти виртуальные машины в приемлемом близком к уровню СУБД оставались сетевой задержкой в приемлемом окне.
- Уровень SAP ASCS/SCS, представляющий единую точку отказа в архитектуре SAP NetWeaver и S/4HANA. Обычно вы просматриваете две виртуальные машины, которые планируется использовать с инфраструктурой отработки отказа. Поэтому эти виртуальные машины должны выделяться в разных доменах сбоя и обновления инфраструктуры.
- Уровень СУБД SAP, который также представляет единую точку отказа. В обычных случаях он состоит из двух виртуальных машин, охваченных инфраструктурой отработки отказа. Поэтому эти виртуальные машины должны выделяться в разных доменах сбоя и обновления инфраструктуры. Исключения SAP HANA масштабных развертываниях, где можно использовать более двух виртуальных машин.

Основные различия между развертыванием критически важных виртуальных машин с помощью групп доступности или Зоны доступности:

- Развертывание с помощью группы доступности — это структурирование виртуальных машин в наборе в одной зоне или центре обработки данных (что применимо для определенного региона). В результате развертывание с помощью группы доступности не защищено с помощью возможностей, связанных с электропитанием, охлаждением или сетью, которые влияют на датацетер зоны в целом. На стороне плюс виртуальные машины согласовываются с доменами обновления и сбоя в пределах этой зоны или центра обработки данных. В частности, для уровня SAP ASCS или СУБД, в котором мы защищают две виртуальные машины на группу доступности, выравнивание с доменами сбоя и обновления предотвращает завершение обеих виртуальных машин на одном и том же оборудовании. 
- Развертывание виртуальных машин с помощью Зоны доступности Azure и выбор различных зон (не более трех возможных) заключается в развертывании виртуальных машин в различных физических расположениях и с последующим добавлением дополнительной защиты из проблем питания, охлаждения или сети, влияющих на датацетер зоны в целом. Однако при развертывании нескольких виртуальных машин одного семейства виртуальных машин в одной зоне доступности не существует защиты от виртуальных машин, которые заканчиваются на одном узле. В результате развертывание с помощью Зоны доступности идеально подходит для уровня SAP ASCS и СУБД, где обычно рассматриваются две виртуальные машины. Для уровня приложений SAP, который может быть значительно больше двух виртуальных машин, может потребоваться вернуться к другой модели развертывания (см. Далее).

Ваша мотивация для развертывания в Зоны доступности Azure должна быть в том, что вы, в своюмся, закрываете сбой одной критической виртуальной машины или возможность сократить время простоя для исправления программного обеспечения в критической ситуации, которую необходимо защитить от более крупных проблем инфраструктуры, которые могут повлиять на доступность одного или нескольких центров обработки данных Azure. 

## <a name="considerations-for-deploying-across-availability-zones"></a>Рекомендации по развертыванию в зонах доступности


При использовании зон доступности необходимо учитывать следующее.

- Нет никаких гарантий относительно расстояний между различными зонами доступности в регионе Azure.
- Зоны доступности не следует считать идеальным решением для аварийного восстановления. Стихийное бедствие может причинить существенный ущерб мировым регионам, в том числе инфраструктуре электропитания. Расстояния между различными зонами могут быть недостаточно большими для реализации соответствующего решения аварийного восстановления.
- Задержка в сети между зонами доступности в регионах Azure различна. В некоторых случаях вы можете развернуть прикладной уровень SAP и выполнить его в разных зонах, так как задержка в сети при обращении из какой-либо из этих зон к активной виртуальной машине СУБД остается в допустимых пределах. Но в некоторых регионах Azure будет складываться такая ситуация, в которой задержка между активной виртуальной машиной СУБД и экземпляром приложением SAP, развернутыми в разных зонах, будет неприемлемой для бизнес-процессов SAP. В таких случаях архитектура развертывания должна быть различной, с архитектурой "активный/активный" для приложения или архитектурой "активный/пассивный", в которой задержка сети между зонами слишком высока.
- Выбор места применения зон доступности должен исходить из задержки в сети между зонами. Задержка в сети играет важную роль в двух областях.
    - Задержка между двумя экземплярами СУБД, между которыми нужно настроить синхронную репликацию. Чем выше задержка в сети, тем выше вероятность ухудшения масштабируемости вашей рабочей нагрузки.
    - Разница сетевой задержки между виртуальной машиной, выполняющей экземпляр диалога SAP в зоне, где расположен активный экземпляр СУБД, и аналогичной виртуальной машиной в другой зоне. Чем больше разница между ними, тем большее влияние они будут оказывать на время выполнения бизнес-процессов и пакетных заданий, в зависимости от того, находятся ли они в одной с СУБД зоне или в разных зонах.

При развертывании виртуальных машин Azure в зонах доступности или установке решений отработки отказа в одном регионе Azure накладываются некоторые ограничения.

- При развертывании в Зонах доступности Azure необходимо использовать [Управляемые диски Azure](https://azure.microsoft.com/services/managed-disks/). 
- Сопоставление перечислений зон с физическими зонами фиксируется на уровне подписки Azure. Если вы используете разные подписки для развертывания систем SAP, для каждой подписки следует определить оптимальные зоны.
- Вы не можете развертывать группы доступности Azure в пределах зоны доступности Azure, если не используете [группу размещения](../../co-location.md)с учетом расположения в Azure. Способ развертывания уровня СУБД SAP и центральных служб в разных зонах, а также развертывание уровня приложений SAP с помощью групп доступности и по-прежнему достигнуть близкого сходства виртуальных машин приводится в статье [группы размещения Azure для обеспечения оптимальной сетевой задержки с приложениями SAP](sap-proximity-placement-scenarios.md). Если вы не используете группы размещения близости к Azure, необходимо выбрать одну или другую как платформу развертывания для виртуальных машин.
- Невозможно использовать [Azure Load Balancer (цен. категория "Базовый")](../../../load-balancer/load-balancer-overview.md) для создания отказоустойчивых кластерных решений, основанных на службах отказоустойчивого кластера Windows Server или Linux Pacemaker. Вместо этого необходимо использовать [номер SKU Azure Load Balancer (цен. Категория "Стандартный")](../../../load-balancer/load-balancer-standard-availability-zones.md).



## <a name="the-ideal-availability-zones-combination"></a>Идеальное сочетание зон доступности
Если вы хотите развернуть систему SAP NetWeaver или S/4HANA в разных зонах, можно развернуть две следующие архитектуры.

- Активный/активный: пара виртуальных машин с ASCS/SCS и парой виртуальных машин, на которых выполняется уровень СУБД, распределена между двумя зонами. Количество виртуальных машин, на которых выполняется уровень приложений SAP, развертывается на четном числе в одной и той же двух зонах. В случае отработки отказа виртуальной машины СУБД или ASCS/SCS может быть выполнен откат некоторых открытых и активных транзакций. Но пользователи остаются в системе. Он не имеет значения в том, в какой зоне работают активные ВМ СУБД и экземпляры приложений. Эта архитектура является предпочтительной архитектурой для развертывания в разных зонах.
- Активный/пассивный: пара виртуальных машин с ASCS/SCS и парой виртуальных машин, на которых выполняется уровень СУБД, распределяется между двумя зонами. Число виртуальных машин, на которых выполняется уровень приложений SAP, развертывается на одном из Зоны доступности. Уровень приложения запускается в той же зоне, что и активный экземпляр ASCS/SCS и DBMS. Эта архитектура развертывания используется, если задержка сети в разных зонах слишком высока для запуска уровня приложения, распределенного по зонам. Вместо этого уровень приложений SAP должен выполняться в той же зоне, что и активный экземпляр ASCS/SCS и (или) СУБД. Если виртуальная машина ASCS/SCS или СУБД перейдет в дополнительную зону, может возникнуть большая задержка в сети и снижение пропускной способности. Чтобы вернуться к предыдущим уровням пропускной способности, необходимо как можно быстрее восстановить виртуальную машину, для которой была выполнена отработка отказа. Если происходит сбой зональные, необходимо выполнить отработку отказа уровня приложения в дополнительную зону. Действие, которое пользователи испытывают как полное завершение работы системы. В некоторых регионах Azure эта архитектура является единственной допустимой архитектурой, если вы хотите использовать Зоны доступности. Если не удается принять потенциальное воздействие на виртуальные машины ASCS/SCS или СУБД в дополнительную зону, возможно, будет удобнее работать с развертываниями группы доступности.


Поэтому перед принятием решения об использовании Зоны доступности необходимо определить:

- Задержка в сети между тремя зонами в регионе Azure. Знание сетевой задержки между зонами региона позволяет выбрать зоны с наименьшей задержкой в сети в сетевом трафике между зонами.
- Разница задержек между виртуальными машинами в пределах одной из выбранных зон и задержка в сети между двумя выбранными зонами.
- Доступность типов виртуальных машин, которые вы намерены развернуть в соответствующих двух зонах. При выборе некоторых виртуальных машин, особенно виртуальных машин серии M, могут возникать ситуации, когда некоторые номера SKU будут доступны в только двух зонах из трех.

## <a name="network-latency-between-and-within-zones"></a>Задержка в сети между зонами и в пределах зоны.
Чтобы определить задержку между несколькими зонами, сделайте следующее.

- Разверните в каждой из трех зон виртуальную машину с тем номером SKU, который вы намерены использовать для экземпляра СУБД. Перед выполнением измерений убедитесь, что включено [ускорение работы в сети Azure](https://azure.microsoft.com/blog/maximize-your-vm-s-performance-with-accelerated-networking-now-generally-available-for-both-windows-and-linux/).
- Когда вы найдете две зоны с наименьшей задержкой в сети, разверните во всех трех зонах доступности еще три виртуальные машины с тем номером SKU, который вы планируете использовать для виртуальных машин прикладного уровня. Измерьте задержку в сети для двух виртуальных машин СУБД в двух выбранных зонах для СУБД. 
- Используйте **`niping`** в качестве средства измерения. Это инструмент SAP, который описан в примечаниях по поддержке SAP [№ 500235](https://launchpad.support.sap.com/#/notes/500235) и [№ 1100926](https://launchpad.support.sap.com/#/notes/1100926/E). Уделите внимание описанным командам для измерения задержки. Так как **ping** не работает с путями кода для ускорения работы в сети Azure, мы не рекомендуем использовать этот инструмент.

Эти тесты не нужно выполнять вручную. Вы можете найти [проверку задержки для зоны доступности](https://github.com/Azure/SAP-on-Azure-Scripts-and-Utilities/tree/master/AvZone-Latency-Test) процедур PowerShell, которая автоматизирует тесты с заданной задержкой. 

По результатам этих измерений и с учетом доступности номеров SKU виртуальных машин в зонах доступности вам следует принять следующие решения.

- Определите оптимальные зоны для уровня СУБД.
- Исходя из различий задержки в сети в пределах зоны и между зонами определите, нужно ли распределить активный прикладной уровень SAP на одну, две или все три зоны.
- Определите, нужно ли развертывать конфигурацию "активный — пассивный" или "активный — активный" с точки зрения приложения. (Эти конфигурации описаны далее в статье.)

При принятии этих решений учитывайте также рекомендации компании SAP по задержкам в сети, которые описаны в примечании SAP [№ 1100926](https://launchpad.support.sap.com/#/notes/1100926/E).

> [!IMPORTANT]
> Все измерения и принятые решения применимы только для той подписки Azure, которую вы использовали для этих измерений. Если вы используете другую подписку Azure, необходимо будет повторить измерения. Соответствие перечисляемых зон для другой подписки Azure может отличаться.


> [!IMPORTANT]
> Считается нормальным, что описанные выше измерения дадут разные результаты в каждом из регионов Azure, который поддерживает [Зоны доступности](https://azure.microsoft.com/global-infrastructure/geographies/). Даже если требования к задержке в сети будут такими же, для разных регионов Azure могут подходить разные стратегии развертывания из-за различий в задержках между зонами. В одних регионах Azure задержка в сети между тремя разными зонами может значительно отличаться. В других регионах Azure задержка в сети между тремя разными зонами может быть более схожей. Утверждать, что задержка в сети всегда составляет 1–2 миллисекунды, неправильно. Не существует общих правил, характеризующих задержку в сети между зонами доступности в регионах Azure.

## <a name="activeactive-deployment"></a>Развертывание архитектуры "активный — активный"
Эта архитектура развертывания называется "активный" или "активный", так как вы развертываете активные серверы приложений SAP в двух или трех зонах. Экземпляр центральных служб SAP, использующий службу постановки в очередь для репликации, будет развертываться в двух зонах. Это справедливо и для уровня СУБД, который будет развертываться в тех же зонах, что и центральная служба SAP. При рассмотрении этой конфигурации необходимо найти в нужном регионе две зоны доступности, задержка в сети между которыми приемлема для используемой рабочей нагрузки и синхронной репликации СУБД. Кроме того, разница между задержками в сети в пределах выбранных зон и между ними не должна быть слишком большой. 

Природа архитектуры SAP состоит в том, что, если вы не настроили ее по-разному, пользователи и пакетные задания могут выполняться в разных экземплярах приложения. Побочным действием этого факта при развертывании «активный/активный» является то, что пакетные задания могут выполняться любыми экземплярами приложения SAP независимо от того, работают ли они в той же зоне с активной СУБД. Если разница в сетевой задержке между зонами различий меньше по сравнению с задержкой сети в пределах зоны, разница в времени выполнения пакетных заданий может быть незначительна. Тем не менее чем больше разница между задержкой сети в пределах зоны по сравнению с сетевым трафиком зоны, тем меньше времени выполнения пакетных заданий может повлиять на то, что задание было выполнено в зоне, в которой экземпляр СУБД не активен. Вы как клиент решаете, какие приемлемые отличия во время выполнения. И с тем, что приемлемой сетевая задержка для трафика между зонами.

Регионы Azure, в которых такое развертывание "активный/активный" должно быть возможным без больших различий во время выполнения и пропускной способности в пределах уровня приложения, развернутого в разных Зоны доступности, следующим образом:

- Западная США 2 (все три зоны)
- Восточная США 2 (все три зоны)
- Центральная американская (все три зоны)
- Северная Европа (все три зоны)
- Западная Европа (две из трех зон)
- Восточная часть США (две из трех зон)
- Юго-Центральная часть США (две из трех зон)
- Южная часть Соединенного Королевства (две из трех зон)

Регионы Azure, в которых не рекомендуется использовать эту архитектуру развертывания SAP в разных зонах:

- Центральная Франция 
- Северная часть ЮАР;
- Центральная Канада
- Japan East

В зависимости от того, что вы готовы к допуску различия во времени выполнения, другие регионы, отсутствующие в списке, также могут быть определены.


Упрощенная схема развертывания "активный — активный" в двух зонах может выглядеть примерно так:

![Зональное развертывание архитектуры "активный — активный"](./media/sap-ha-availability-zones/active_active_zones_deployment.png)

Для этой конфигурации следует принимать во внимание следующие соображения.

- Не используйте [группу размещения](../../co-location.md)с учетом расположения Azure, вы обрабатываете зоны доступности Azure как домены сбоя и обновления для всех виртуальных машин, так как группы доступности не могут быть развернуты в зоны доступности Azure.
- Если вы хотите объединить развертывания зональные для уровня СУБД и центральных служб, но вы хотите использовать группы доступности Azure для уровня приложения, вам нужно воспользоваться группами близости Azure, как описано в статье [группы размещения службы "близость" Azure для оптимальной сетевой задержки с приложениями SAP](sap-proximity-placement-scenarios.md).
- Подсистемы балансировки нагрузки, которые вы применяете для отказоустойчивых кластеров центральных служб SAP и для уровня СУБД, должны использовать [номер SKU ценовой категории "Стандартный"](../../../load-balancer/load-balancer-standard-availability-zones.md). Подсистема балансировки нагрузки (цен. категория "Базовый") не будет работать между зонами.
- Виртуальная сеть Azure и все подсети, развернутые для размещения системы SAP, распределяются по нескольким зонам. Нет необходимости выделять виртуальные сети для каждой зоны.
- Для всех развертываемых виртуальных машин необходимо использовать [управляемые диски Azure](https://azure.microsoft.com/services/managed-disks/). Неуправляемые диски не поддерживаются для зональных развертываний.
- Хранилище Azure класса Premium, [хранилище SSD (цен. Категория "ультра")](../../disks-types.md#ultra-disk)или использовании не поддерживают репликацию хранилища в разных зонах. Приложение (СУБД или центральные службы SAP) должно самостоятельно реплицировать важные данные.
- Это относится и к общей папке sapmnt, которая содержит общий диск (для Windows), общую папку CIFS (для Windows) или общую папку NFS (Linux). Вам нужна технология, которая позволяет реплицировать такие общие диски или общие папки между зонами. Поддерживаются следующие технологии:
  - Для Windows между зонами можно применить кластерное решение на основе SIOS Datakeeper, которое описано в статье [Кластеризация экземпляра SAP ASCS/SCS в отказоустойчивом кластере Windows с помощью общего диска кластера в Azure](./sap-high-availability-guide-wsfc-shared-disk.md).
  - Для SUSE Linux поддерживается общая папка NFS, созданная по инструкциям из статьи [Обеспечение высокого уровня доступности NFS на виртуальных машинах Azure в SUSE Linux Enterprise Server](./high-availability-guide-suse-nfs.md).
    
    В настоящее время решение на основе масштабируемых файловых служб (SOFS) Windows, которое описано в статье [Подготовка высокодоступной инфраструктуры Azure для SAP с помощью отказоустойчивого кластера Windows и файлового ресурса для экземпляров SAP ASCS/SCS](./sap-high-availability-infrastructure-wsfc-file-share.md), не поддерживается для работы между зонами.
- Третья зона используется для размещения устройства SBD, если вы создаете [кластер Pacemaker SUSE Linux](./high-availability-guide-suse-pacemaker.md#create-azure-fence-agent-stonith-device) и используете устройства SBD вместо агента разграничения Azure. Или для дополнительных экземпляров приложения.
- Чтобы обеспечить согласованность во время выполнения критических бизнес-процессов, можно попытаться направить определенные пакетные задания и пользователей в экземпляры приложений, которые находятся в зоне с активным экземпляром СУБД, с помощью групп серверов пакетной службы SAP, групп входа SAP или групп RFC. Но в случае зональной отработки отказа вам придется вручную перемещать эти группы в экземпляры, выполняемые на виртуальных машинах в одной зоне с виртуальной машиной базы данных.  
- Может потребоваться развернуть неактивные экземпляры диалога в каждой из зон. 

> [!IMPORTANT]
> В этом сценарии "активный/активный" дополнительная плата за пропускную способность объявлена корпорацией Майкрософт от 04/01/2020. Проверьте [сведения о ценах пропускной способности](https://azure.microsoft.com/pricing/details/bandwidth/)документа. Обмен данными между уровнем приложений SAP и уровнем СУБД SAP очень трудоемк. Поэтому сценарий "активный/активный" может значительно снизить затраты. Следите за этой статьей, чтобы получить точные затраты. 


## <a name="activepassive-deployment"></a>Развертывание архитектуры "активный — пассивный"
Если вы не сможете найти сочетание зон с приемлемой разницей задержек в сети внутри одной зоны и между зонами, то вы можете развернуть архитектуру типа "активный — пассивный" с точки зрения прикладного уровня SAP. В ней вы определяете *активную* зону, в которой будет развернут весь прикладной уровень и будут выполняться активный экземпляр СУБД и экземпляр центральных служб SAP. Такая конфигурация позволяет гарантировать, что различия во времени выполнения бизнес-транзакций и пакетных заданий не будут критически большими в зависимости от того, выполняется ли задание в зоне с активным экземпляром СУБД или в другой зоне.

Ниже перечислены регионы Azure, в которых может быть предпочтительнее такой тип архитектуры развертывания в разных зонах.

- Southeast Asia
- Восточная Австралия
- Brazil South
- Центрально-Западная Германия
- Северная часть ЮАР;
- Центральная Франция 
- Центральная Канада
- Japan East


Базовая схема такой архитектуры выглядит следующим образом.

![Зональное развертывание архитектуры "активный — пассивный"](./media/sap-ha-availability-zones/active_passive_zones_deployment.png)

Для этой конфигурации следует принимать во внимание следующие соображения.

- Группы доступности невозможно развернуть в Зонах доступности Azure. Чтобы компенсировать это, вы можете использовать группы размещения службы "близость" Azure, как описано в статье [группы размещения службы "близость" Azure для оптимальной сетевой задержки в приложениях SAP](sap-proximity-placement-scenarios.md).
- Применяя такую архитектуру, вам придется внимательно отслеживать состояние и стараться удерживать активные экземпляры СУБД и центральных служб SAP в той же зоне, где развернут прикладной уровень. При отработке отказа экземпляра центральной службы SAP или СУБД вам важно как можно раньше вручную выполнить восстановление размещения в ту зону, где развернут прикладной уровень SAP.
- Подсистемы балансировки нагрузки, которые вы применяете для отказоустойчивых кластеров центральных служб SAP и для уровня СУБД, должны использовать [номер SKU ценовой категории "Стандартный"](../../../load-balancer/load-balancer-standard-availability-zones.md). Подсистема балансировки нагрузки (цен. категория "Базовый") не будет работать между зонами.
- Виртуальная сеть Azure и все подсети, развернутые для размещения системы SAP, распределяются по нескольким зонам. Нет необходимости выделять виртуальные сети для каждой зоны.
- Для всех развертываемых виртуальных машин необходимо использовать [управляемые диски Azure](https://azure.microsoft.com/services/managed-disks/). Неуправляемые диски не поддерживаются для зональных развертываний.
- Хранилище Azure класса Premium, [хранилище SSD (цен. Категория "ультра")](../../disks-types.md#ultra-disk)или использовании не поддерживают репликацию хранилища в разных зонах. Приложение (СУБД или центральные службы SAP) должно самостоятельно реплицировать важные данные.
- Это относится и к общей папке sapmnt, которая содержит общий диск (для Windows), общую папку CIFS (для Windows) или общую папку NFS (Linux). Вам нужна технология, которая позволяет реплицировать такие общие диски или общие папки между зонами. Поддерживаются следующие технологии:
    - Для Windows между зонами можно применить кластерное решение на основе SIOS Datakeeper, которое описано в статье [Кластеризация экземпляра SAP ASCS/SCS в отказоустойчивом кластере Windows с помощью общего диска кластера в Azure](./sap-high-availability-guide-wsfc-shared-disk.md).
    - Для SUSE Linux поддерживается общая папка NFS, созданная по инструкциям из статьи [Обеспечение высокого уровня доступности NFS на виртуальных машинах Azure в SUSE Linux Enterprise Server](./high-availability-guide-suse-nfs.md).
    
  В настоящее время решение на основе масштабируемых файловых служб (SOFS) Windows, которое описано в статье [Подготовка высокодоступной инфраструктуры Azure для SAP с помощью отказоустойчивого кластера Windows и файлового ресурса для экземпляров SAP ASCS/SCS](./sap-high-availability-infrastructure-wsfc-file-share.md), не поддерживается для работы между зонами.
- Третья зона используется для размещения устройства SBD, если вы создаете [кластер Pacemaker SUSE Linux](./high-availability-guide-suse-pacemaker.md#create-azure-fence-agent-stonith-device) и используете устройства SBD вместо агента разграничения Azure. Или для дополнительных экземпляров приложения.
- Следует развернуть неактивные виртуальные машины в пассивной зоне (с точки зрения СУБД), чтобы можно было запускать ресурсы приложения в случае сбоя зоны.
    - В настоящее время невозможно использовать [Azure Site Recovery](https://azure.microsoft.com/services/site-recovery/) для репликации активных виртуальных машин в неактивные виртуальные машины в другой зоне. 
- Следует вкладывать в службу автоматизации, которая позволяет автоматически запускать уровень приложений SAP во второй зоне при возникновении сбоя зональные.

## <a name="combined-high-availability-and-disaster-recovery-configuration"></a>Сочетание конфигураций высокого уровня доступности и аварийного восстановления
Корпорация Майкрософт не предоставляет сведений о географическом расстоянии между элементами инфраструктуры, на которых размещаются разные зоны доступности Azure в определенном регионе Azure. Несмотря на этот факт, некоторые клиенты успешно применяют зоны для создания конфигураций, поддерживающих одновременно высокий уровень доступности и аварийное восстановление с нулевым значением целевой точки восстановления. Значение RPO, равное нулю, означает, что не следует потерять все зафиксированные транзакции базы данных даже в случае аварийного восстановления. 

> [!NOTE]
> Мы рекомендуем использовать подобную конфигурацию только в определенных обстоятельствах. Например, ее можно использовать, если данные не должны покидать регион Azure из соображений безопасности и соответствия требованиям. 

Ниже приведен пример такой конфигурации.

![Конфигурация, поддерживающая одновременно высокий уровень доступности и аварийное восстановление в зонах](./media/sap-ha-availability-zones/combined_ha_dr_in_zones.png)

Для этой конфигурации следует принимать во внимание следующие соображения.

- Вам следует предполагать, что элементы инфраструктуры, на которых размещается зона доступности, далеко расположены друг от друга, иначе вам придется остаться в пределах определенного региона Azure. Группы доступности невозможно развернуть в Зонах доступности Azure. Чтобы компенсировать это, вы можете использовать группы размещения службы "близость" Azure, как описано в статье [группы размещения службы "близость" Azure для оптимальной сетевой задержки в приложениях SAP](sap-proximity-placement-scenarios.md).
- Применяя такую архитектуру, вам придется внимательно отслеживать состояние и стараться удерживать активные экземпляры СУБД и центральных служб SAP в той же зоне, где развернут прикладной уровень. При отработке отказа экземпляра центральной службы SAP или СУБД вам важно как можно раньше вручную выполнить восстановление размещения в ту зону, где развернут прикладной уровень SAP.
- У вас должны быть рабочие экземпляры приложения, предварительно установленные на виртуальных машинах, на которых выполняются активные экземпляры приложения для контроля качества.
- В случае сбоя зональные завершите работу экземпляров приложения контроля качества и запустите рабочие экземпляры. Для выполнения этой работы необходимо использовать виртуальные имена для экземпляров приложения.
- Подсистемы балансировки нагрузки, которые вы применяете для отказоустойчивых кластеров центральных служб SAP и для уровня СУБД, должны использовать [номер SKU ценовой категории "Стандартный"](../../../load-balancer/load-balancer-standard-availability-zones.md). Подсистема балансировки нагрузки (цен. категория "Базовый") не будет работать между зонами.
- Виртуальная сеть Azure и все подсети, развернутые для размещения системы SAP, распределяются по нескольким зонам. Нет необходимости выделять виртуальные сети для каждой зоны.
- Для всех развертываемых виртуальных машин необходимо использовать [управляемые диски Azure](https://azure.microsoft.com/services/managed-disks/). Неуправляемые диски не поддерживаются для зональных развертываний.
- Хранилище Azure (цен. категория "Премиум") или [хранилище SSD (цен. категория "Ультра")](../../disks-types.md#ultra-disk) не поддерживают репликацию хранилища между зонами. Приложение (СУБД или центральные службы SAP) должно самостоятельно реплицировать важные данные.
- Это относится и к общей папке sapmnt, которая содержит общий диск (для Windows), общую папку CIFS (для Windows) или общую папку NFS (Linux). Вам нужна технология, которая позволяет реплицировать такие общие диски или общие папки между зонами. Поддерживаются следующие технологии:
    - Для Windows между зонами можно применить кластерное решение на основе SIOS Datakeeper, которое описано в статье [Кластеризация экземпляра SAP ASCS/SCS в отказоустойчивом кластере Windows с помощью общего диска кластера в Azure](./sap-high-availability-guide-wsfc-shared-disk.md).
    - Для SUSE Linux поддерживается общая папка NFS, созданная по инструкциям из статьи [Обеспечение высокого уровня доступности NFS на виртуальных машинах Azure в SUSE Linux Enterprise Server](./high-availability-guide-suse-nfs.md).

  В настоящее время решение на основе масштабируемых файловых служб (SOFS) Windows, которое описано в статье [Подготовка высокодоступной инфраструктуры Azure для SAP с помощью отказоустойчивого кластера Windows и файлового ресурса для экземпляров SAP ASCS/SCS](./sap-high-availability-infrastructure-wsfc-file-share.md), не поддерживается для работы между зонами.
- Третья зона используется для размещения устройства SBD, если вы создаете [кластер Pacemaker SUSE Linux](./high-availability-guide-suse-pacemaker.md#create-azure-fence-agent-stonith-device) и используете устройства SBD вместо агента разграничения Azure. 





## <a name="next-steps"></a>Дальнейшие действия
Ниже приведены дальнейшие действия по развертыванию в Зонах доступности Azure:

- [Кластеризация экземпляра SAP ASCS/SCS в отказоустойчивом кластере Windows с помощью общего диска кластера в Azure](./sap-high-availability-guide-wsfc-shared-disk.md).
- [Подготовка высокодоступной инфраструктуры Azure для SAP с помощью отказоустойчивого кластера Windows и файлового ресурса для экземпляров SAP ASCS/SCS](./sap-high-availability-infrastructure-wsfc-file-share.md).