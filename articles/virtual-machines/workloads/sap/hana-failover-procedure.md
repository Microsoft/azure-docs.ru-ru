---
title: Процедура отработки отказа HANA в расположение аварийного восстановления для SAP HANA в Azure (крупные экземпляры) | Документация Майкрософт
description: Сведения о том, как выполнить отработку отказа в расположение аварийного восстановления для SAP HANA в Azure (крупные экземпляры)
services: virtual-machines-linux
documentationcenter: ''
author: saghorpa
manager: juergent
editor: ''
ms.service: virtual-machines-sap
ms.topic: article
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure
ms.date: 04/22/2019
ms.author: saghorpa
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: 2a33340524556f5da1703cae3532f053fbe8ba13
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "101670987"
---
# <a name="disaster-recovery-failover-procedure"></a>Процедура отработки отказа при аварийном восстановлении


>[!IMPORTANT]
>Эта статья не заменяет документацию по администрированию SAP HANA или примечания SAP. Предполагается, что вы хорошо понимаете принципы администрирования и эксплуатации SAP HANA, особенно принципы резервного копирования, восстановления, обеспечения высокой доступности и аварийного восстановления. В этой статье показаны снимки экрана из SAP HANA Studio. Содержимое, структура и характер экранов инструментов администрирования SAP и сами инструменты могут изменяться в разных выпусках SAP HANA.

Существует два сценария при отработке отказа на сайт аварийного восстановления:

- Необходимо восстановить последнее состояние данных базы данных SAP HANA. В этом случае предлагается сценарий самообслуживания, который позволяет выполнять отработку отказа без необходимости обращения в корпорацию Майкрософт. Для восстановления размещения нужно обратиться в корпорацию Майкрософт.
- Требуется выполнить восстановление на основе моментального снимка хранилища, который не является последним реплицированным моментальным снимком. В этом случае следует обратиться в корпорацию Майкрософт. 

>[!NOTE]
>Шаги ниже необходимо выполнить в экземпляре HANA (крупные экземпляры), который представляет собой экземпляр аварийного восстановления. 
 
Чтобы выполнить восстановление в последние реплицированные моментальные снимки хранилища, выполните действия, описанные в разделе "Выполнение полной отработки отказа с аварийным восстановлением — azure_hana_dr_failover" статьи [Средства создания моментальных снимков Майкрософт для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.3/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.3.pdf). 

Если вы хотите выполнить отработку отказа нескольких экземпляров SAP HANA, выполните команду azure_hana_dr_failover несколько раз. По запросу введите идентификатор безопасности SAP HANA, для которого требуется выполнить отработку отказа и восстановление. 


Кроме того, можно протестировать отработку отказа с аварийным восстановлением без ущерба для фактической связи репликации. Чтобы выполнить тестовую отработку отказа, выполните действия, описанные в разделе "Выполнение тестовой отработки отказа с аварийным восстановлением — azure_hana_test_dr_failover" статьи [Средства создания моментальных снимков Майкрософт для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.3/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.3.pdf). 

>[!IMPORTANT]
>Не *запускайте* рабочие транзакции в экземпляре, созданном на сайте аварийного восстановления, в процессе **тестирования отработки отказа**. Команда azure_hana_test_dr_failover создает набор томов, не связанных с основным сайтом. В результате синхронизация с основным сайтом *невозможна*. 

Если вы хотите проверить несколько экземпляров SAP HANA, выполните скрипт несколько раз. По запросу введите идентификатор безопасности экземпляра SAP HANA, для которого требуется протестировать отработку отказа. 

>[!NOTE]
>Если нужно выполнить отработку отказа на сайт аварийного восстановления для восстановления данных, удаленных несколько часов назад, и задать для томов аварийного восстановления состояние более раннее, чем в последнем моментальном снимке, примените эту процедуру. 

1. Завершите работу нерабочего экземпляра HANA, запущенного в единице аварийного восстановления крупных экземпляров HANA. Неактивный рабочий экземпляр HANA установлен предварительно.
1. Остановите все процессы SAP HANA. Для этой проверки используйте следующую команду:

      `/usr/sap/hostctrl/exe/sapcontrol –nr <HANA instance number> - function GetProcessList`.

      В выходных данных должен быть указан остановленный процесс **hdbdaemon** и должны отсутствовать какие-либо другие работающие или запущенные процессы HANA.
1. Определите имя моментального снимка или идентификатор резервного копирования SAP HANA для восстановления на сайте аварийного восстановления. В реальных ситуациях аварийного восстановления, как правило, это последний моментальный снимок. Если необходимо восстановить потерянные данные, выберите более ранний снимок.
1. Обратитесь в службу поддержки Azure, отправив запрос на техническую поддержку с высоким приоритетом. Запросите восстановление с помощью этого моментального снимка, указав имя и дату создания снимка или идентификатор резервного копирования HANA на сайте аварийного восстановления. Если этого не сделать, отдел эксплуатации восстановит только том /hana/data. Если вы хотите также восстановить тома /hana/logbackups, вам необходимо обозначить это в запросе. *Не восстанавливайте том /hana/shared.* Вместо этого после повторного подключения тома /hana/shared для PRD выберите определенные файлы, такие как global.ini, из каталога **.snapshot** и его подкаталогов. 

   На стороне отдела эксплуатации произойдет следующее:

   а. Репликация моментальных снимков из рабочего тома на тома аварийного восстановления остановится. Такое прерывание уже могло произойти, если появилась необходимость выполнить аварийное восстановление из-за сбоя на рабочем сайте.
   
   b. На томах аварийного восстановления будет восстановлен выбранный моментальный снимок с идентификатором резервного копирования или моментальный снимок хранилища с указанным именем.
   
   c. После завершения восстановления данных тома аварийного восстановления становятся доступны для подключения к единицам крупных экземпляров HANA в регионе аварийного восстановления.
      
1. Подключите тома аварийного восстановления к единице крупного экземпляра HANA на сайте аварийного восстановления. 
1. Запустите неактивный рабочий экземпляр SAP HANA.
1. Если вы решили скопировать резервные копии журналов транзакций, чтобы уменьшить значение целевой точки восстановления, объедините эти резервные копии в только что подключенном каталоге аварийного восстановления /hana/logbackups. Не перезаписывайте имеющиеся резервные копии. Скопируйте новые резервные копии, которые еще не были реплицированы.
1. Кроме того, можно восстановить отдельные файлы из моментальных снимков, которые не были реплицированы в том /hana/shared/PRD в регионе аварийного восстановления Azure.

Приведенная ниже последовательность действий демонстрирует восстановление рабочего экземпляра SAP HANA на основе восстановленного моментального снимка хранилища и доступных резервных копий журналов транзакций.

1. С помощью SAP HANA Studio измените расположение резервной копии на расположение **/hana/logbackups**.

   ![Изменение расположения резервной копии для аварийного восстановления](./media/hana-overview-high-availability-disaster-recovery/change_backup_location_dr1.png)

1. SAP HANA проверит расположения файлов резервных копий и предложит для восстановления самую последнюю резервную копию журналов транзакций. Проверка может занять несколько минут, после чего отобразится следующий экран:

   ![Список резервных копий журналов транзакций для аварийного восстановления](./media/hana-overview-high-availability-disaster-recovery/backup_list_dr2.PNG)

1. Настройте некоторые параметры по умолчанию:

      - снимите флажок **Use Delta Backups** (Использовать разностные резервные копии);
      - установите флажок **Initialize Log Area** (Инициализировать область журнала).

   ![Выбор инициализации области журнала](./media/hana-overview-high-availability-disaster-recovery/initialize_log_dr3.PNG)

1. Нажмите кнопку **Готово**.

   ![Завершение аварийного восстановления](./media/hana-overview-high-availability-disaster-recovery/finish_dr4.PNG)

Должно появиться окно хода выполнения, как показано ниже. Помните, что в примере выполняется аварийное восстановление развернутой конфигурации SAP HANA с тремя узлами.

![Ход восстановления](./media/hana-overview-high-availability-disaster-recovery/restore_progress_dr5.PNG)

Если восстановление на **завершающем** экране остановилось и не отображается на экране хода выполнения, проверьте, все ли экземпляры SAP HANA выполняются в рабочих узлах. При необходимости запустите экземпляры SAP HANA вручную.


## <a name="failback-from-a-dr-to-a-production-site"></a>Восстановление размещения с сайта аварийного восстановления на рабочий сайт
Вы можете выполнить восстановление размещения с сайта аварийного восстановления на рабочий сайт. Рассмотрим сценарий, когда отработка отказа на сайт аварийного восстановления была вызвана проблемами в рабочем регионе Azure, а не вашей потребностью восстановить потерянные данные. 

Некоторое время на сайте аварийного восстановления выполнялась рабочая нагрузка SAP. После устранения проблем на рабочем сайте можно выполнить восстановление размещения. Так как потеря данных недопустима, возвращение на рабочий сайт включает в себя несколько действий и тесное взаимодействие с рабочей группой SAP HANA в Azure. Вы должны связаться с рабочей группой, чтобы она инициировала синхронизацию на рабочий сайт после устранения проблем.

Выполните следующие действия.

1. Рабочая группа SAP HANA в Azure получает сигнал для синхронизации томов рабочего хранилища из томов хранилища аварийного восстановления, которые теперь представляют состояние рабочего сайта. В этом состоянии работа единицы крупного экземпляра HANA на рабочем сайте завершена.
1. Рабочая группа SAP HANA в Azure отслеживает репликацию и обеспечивает актуальность данных, а затем информирует клиентов.
1. Вам необходимо завершить работу приложений, которые используют рабочий экземпляр HANA на сайте аварийного восстановления. Затем вы создадите резервную копию журналов транзакций HANA. Затем нужно остановить экземпляр HANA, запущенный в единицах крупного экземпляра HANA на сайте аварийного восстановления.
1. После завершения работы экземпляра HANA, выполнявшегося в единице крупного экземпляра HANA на сайте аварийного восстановления, рабочая группа вручную повторно синхронизирует тома дисков.
1. Она снова запускает единицу крупного экземпляра HANA на рабочем сайте, а затем передает ее вам. Убедитесь в том, что в момент запуска единицы крупного экземпляра HANA работа экземпляра SAP HANA завершена.
1. Вы выполните те же действия по восстановлению базы данных, которые вы выполняли ранее при отработке отказа на сайт аварийного восстановления.

## <a name="monitor-disaster-recovery-replication"></a>Мониторинг репликации для аварийного восстановления

Чтобы наблюдать за состоянием процесса репликации хранилища, выполните скрипт `azure_hana_replication_status`. Эту команду нужно выполнить в единице, работающей в расположении аварийного восстановления. В противном случае она не будет работать должным образом. Эта команда работает независимо от того, активна ли репликация. Команда может выполняться для каждой единицы крупного экземпляра HANA вашего клиента в расположении аварийного восстановления. С ее помощью невозможно получить сведения о загрузочном томе. 

Дополнительные сведения об этой команде и ее выходных данных см. в разделе "Получение состояния репликации с аварийным восстановлением — azure_hana_replication_status" статьи [Средства создания моментальных снимков Майкрософт для SAP HANA в Azure](https://github.com/Azure/hana-large-instances-self-service-scripts/blob/master/snapshot_tools_v4.3/Microsoft%20Snapshot%20Tools%20for%20SAP%20HANA%20on%20Azure%20v4.3.pdf).


## <a name="next-steps"></a>Дальнейшие действия
- См. статью [Мониторинг и устранение неполадок со стороны HANA](hana-monitor-troubleshoot.md).
