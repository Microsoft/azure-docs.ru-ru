---
title: Устранение неполадок SSH-подключения к виртуальной машине Azure | Документация Майкрософт
description: Диагностика ошибок, например "ошибка SSH-подключения" или "в SSH-подключении отказано", для виртуальной машины под управлением Linux.
keywords: отклонение SSH-подключения, ошибка SSH, Azure SSH, ошибка SSH-подключения
services: virtual-machines-linux
documentationcenter: ''
author: genlin
manager: dcscontentpm
tags: top-support-issue,azure-service-management,azure-resource-manager
ms.service: virtual-machines-linux
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm-linux
ms.topic: troubleshooting
ms.date: 05/30/2017
ms.author: genli
ms.openlocfilehash: 63c1e388ecd53d9b827e45a1fa78bdb6feeaab21
ms.sourcegitcommit: 2bd0a039be8126c969a795cea3b60ce8e4ce64fc
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/14/2021
ms.locfileid: "98201949"
---
# <a name="troubleshoot-ssh-connections-to-an-azure-linux-vm-that-fails-errors-out-or-is-refused"></a>Устранение неполадок с SSH-подключением к виртуальной машине Azure Linux: сбой, ошибка или отклонение
В этой статье вы узнаете, как найти и исправить проблемы, возникающие из-за ошибок Secure Shell (SSH), сбоев SSH-соединения или отказа SSH при попытке подключения к виртуальной машине Linux. Для устранения неполадок и решения проблем с подключением можно воспользоваться порталом Azure, Azure CLI или расширением для доступа к виртуальной машине для Linux.


Если в любой момент при изучении этой статьи вам потребуется дополнительная помощь, вы можете обратиться к экспертам по Azure на [форумах MSDN Azure и Stack Overflow](https://azure.microsoft.com/support/forums/). Кроме того, можно зарегистрировать обращение в службу поддержки Azure. Перейдите на [сайт поддержки Azure](https://azure.microsoft.com/support/options/) и щелкните **Получить поддержку**. Дополнительные сведения об использовании службы поддержки Azure см. в статье [Часто задаваемые вопросы о поддержке Microsoft Azure](https://azure.microsoft.com/support/faq/).

## <a name="quick-troubleshooting-steps"></a>Действия по устранению неполадок
После выполнения каждого шага устранения неполадок попробуйте подключиться к виртуальной машине еще раз.

1. [Сбросьте конфигурацию SSH](#reset-the-ssh-configuration).
2. [Сбросьте учетные данные](#reset-ssh-credentials-for-a-user) пользователя.
3. Убедитесь, что правила [группы безопасности сети](../../virtual-network/network-security-groups-overview.md) разрешают трафик SSH.
   * Убедитесь, что правило для разрешения трафика SSH есть в [группе безопасности сети](#check-security-rules) (по умолчанию — TCP-порт 22).
   * Нельзя использовать перенаправление и сопоставление портов, не используя Azure Load Balancer.
4. Проверьте [работоспособность ресурсов виртуальной машины](../../service-health/resource-health-overview.md).
   * Убедитесь, что виртуальная машина работоспособна.
   * Если [включена Диагностика загрузки](boot-diagnostics.md), убедитесь, что виртуальная машина не сообщает об ошибках загрузки в журналах.
5. [Перезапустите виртуальную машину](#restart-a-vm).
6. [Заново разверните виртуальную машину](#redeploy-a-vm).

Читайте статью дальше, если вам нужны более подробные инструкции или пояснения об исправлении неполадок.

## <a name="available-methods-to-troubleshoot-ssh-connection-issues"></a>Доступные методы устранения неполадок подключения SSH
Вы можете сбросить учетные данные или конфигурацию SSH одним из следующих методов:

* [Портал Azure](#use-the-azure-portal) отлично подходит, когда нужно быстро сбросить конфигурацию или ключ SSH, а у вас не установлены инструменты Azure.
* [Последовательная консоль виртуальной машины Azure](./serial-console-linux.md) . последовательная консоль виртуальной машины будет работать независимо от конфигурации SSH и предоставит вам интерактивную консоль для виртуальной машины. На самом деле, «не может SSH» — именно то, что последовательное консоль разрабатывалась для решения этой проблемы. Дополнительные сведения см. ниже.
* [Azure CLI](#use-the-azure-cli). Если вы уже открыли командную строку, быстро сбросьте конфигурацию SSH или учетные данные. Если вы работаете на классической виртуальной машине, можно использовать [классический интерфейс командной строки Azure](#use-the-azure-classic-cli).
* [Расширение Azure VMAccessForLinux.](#use-the-vmaccess-extension) Создайте и повторно используйте файлы определения JSON для сброса учетных данных пользователя или конфигурации SSH.

После выполнения каждого шага устранения неполадок попробуйте подключиться к виртуальной машине еще раз. Если все еще не удается подключиться, то попробуйте выполнить следующее действие.

## <a name="use-the-azure-portal"></a>Использование портала Azure
На портале Azure предусмотрена возможность быстрого сброса конфигурации SSH или учетных данных пользователей без установки каких-либо инструментов на локальном компьютере.

Чтобы начать работу, выберите свою виртуальную машину на портале Azure. Прокрутите вниз до раздела **Поддержка и устранение неполадок** и выберите **Сбросить пароль**, как в следующем примере:

![Сброс конфигурации SSH или учетных данных на портале Azure](./media/troubleshoot-ssh-connection/reset-credentials-using-portal.png)

### <a name="reset-the-ssh-configuration"></a>Сброс конфигурации SSH
Чтобы сбросить конфигурацию SSH, выберите `Reset configuration only` в разделе **Режим**, как показано на предыдущем снимке экрана, а затем — **Обновление**. Сделав это, попытайтесь снова войти в виртуальною машину.

### <a name="reset-ssh-credentials-for-a-user"></a>Сброс учетных данных SSH пользователя
Чтобы сбросить учетные данные имеющегося пользователя, в разделе **Режим** выберите `Reset SSH public key` или `Reset password`, как на приведенном выше снимке экрана. Укажите имя пользователя и ключ SSH или новый пароль, а затем щелкните **Обновление**.

Кроме того, в этом меню можно создать пользователя с привилегиями sudo на виртуальной машине. Введите новое имя пользователя и соответствующий пароль или ключ SSH, а затем щелкните **Обновление**.

### <a name="check-security-rules"></a>Проверка правил безопасности

Используйте [проверку IP-потока](../../network-watcher/diagnose-vm-network-traffic-filtering-problem.md) , чтобы проверить, блокирует ли правило в группе безопасности сети передачу трафика на виртуальную машину или из нее. Кроме того, вы можете просмотреть действующие правила группы безопасности и убедиться, что для порта SSH (22 по умолчанию) существует и является приоритетным правило NSG, разрешающее входящий трафик. Дополнительные сведения см. [в статье Использование действующих правил безопасности для устранения неполадок потока трафика виртуальной машины](../../virtual-network/diagnose-network-traffic-filter-problem.md).

### <a name="check-routing"></a>Проверка маршрутизации

Убедитесь, что маршрут не препятствуют маршрутизации трафика на виртуальную машину или с нее, воспользовавшись возможностью [Следующий прыжок](../../network-watcher/diagnose-vm-network-routing-problem.md) в службе "Наблюдатель за сетями". Кроме того, вы можете просмотреть фактические маршруты для сетевого интерфейса. Дополнительные сведения см. в статье об [использовании фактических маршрутов для устранения проблем с потоком трафика на виртуальной машине](../../virtual-network/diagnose-network-routing-problem.md).

## <a name="use-the-azure-vm-serial-console"></a>Использование последовательной консоли виртуальной машины Azure
[Последовательная консоль виртуальной машины Azure](./serial-console-linux.md) предоставляет доступ к текстовой консоли для виртуальных машин Linux. С помощью консоли можно устранять неполадки SSH-подключения в интерактивной оболочке. Убедитесь, что выполнены [Предварительные условия](./serial-console-linux.md#prerequisites) для использования последовательной консоли, и выполните приведенные ниже команды, чтобы устранить неполадки с подключением SSH.

### <a name="check-that-ssh-is-running"></a>Убедитесь, что SSH работает
Чтобы проверить, работает ли SSH на виртуальной машине, можно использовать следующую команду:

```console
ps -aux | grep ssh
```

При наличии выходных данных SSH работает и работает.

### <a name="check-which-port-ssh-is-running-on"></a>Проверьте, на каком порту работает SSH.

Чтобы проверить, на каком порту выполняется SSH, можно использовать следующую команду:

```console
sudo grep Port /etc/ssh/sshd_config
```

Выходные данные будут выглядеть примерно так:

```output
Port 22
```

## <a name="use-the-azure-cli"></a>Использование Azure CLI
Установите последнюю версию [Azure CLI](/cli/azure/install-az-cli2) (если вы еще этого не сделали) и войдите в учетную запись Azure, выполнив команду [az login](/cli/azure/reference-index).

Если вы создали и отправили пользовательский образ диска Linux, убедитесь, что установлен [агент Linux для Microsoft Azure](../extensions/agent-linux.md) версии 2.0.5 или более поздней. В виртуальных машинах, созданных с помощью образов из коллекции, это расширение для доступа уже установлено и настроено.

### <a name="reset-ssh-configuration"></a>Сбросьте конфигурацию SSH.
Вы можете сначала попробовать сбросить конфигурацию SSH к значениям по умолчанию и перезагрузить сервер SSH на виртуальной машине. При выполнении этого шага не изменяется имя учетной записи пользователя, пароль или ключи SSH.
В следующем примере используется команда [az vm user reset-ssh](/cli/azure/vm/user) для сброса конфигурации SSH на виртуальной машине с именем `myVM` в группе ресурсов `myResourceGroup`. Используйте свои значения следующим образом:

```azurecli
az vm user reset-ssh --resource-group myResourceGroup --name myVM
```

### <a name="reset-ssh-credentials-for-a-user"></a>Сброс учетных данных SSH пользователя
В следующем примере используется команда [aaz vm user update](/cli/azure/vm/user), чтобы сбросить учетные данные для `myUsername` к значению, указанному в `myPassword` на виртуальной машине `myVM` в группе ресурсов `myResourceGroup`. Используйте свои значения следующим образом:

```azurecli
az vm user update --resource-group myResourceGroup --name myVM \
     --username myUsername --password myPassword
```

При использовании аутентификации с помощью ключа SSH можно сбросить ключ SSH для отдельного пользователя. В следующем примере используется команда **az vm access set-linux-user**, чтобы сбросить учетные данные для `~/.ssh/id_rsa.pub` к значению, указанному в `myUsername` на виртуальной машине `myVM` в группе ресурсов `myResourceGroup`. Используйте свои значения следующим образом:

```azurecli
az vm user update --resource-group myResourceGroup --name myVM \
    --username myUsername --ssh-key-value ~/.ssh/id_rsa.pub
```

## <a name="use-the-vmaccess-extension"></a>Использование расширения VMAccess
Расширение доступа к виртуальной машине для Linux считывает файл JSON, который определяет действия для выполнения. Эти действия включают сброс SSHD, сброс ключа SSH или Добавление пользователя. Azure CLI по-прежнему используется для вызова расширения VMAccess, но при необходимости JSON-файлы можно использовать повторно в нескольких виртуальных машинах. Такой подход позволяет создать репозиторий JSON-файлов, которые можно впоследствии вызывать для заданных сценариев.

### <a name="reset-sshd"></a>Сброс SSHD
Создайте файл `settings.json` со следующим содержимым:

```json
{
    "reset_ssh":True
}
```

С помощью Azure CLI вызовите расширение `VMAccessForLinux` для сброса подключения SSHD, указав JSON-файл. В следующем примере используется команда [az vm extension set](/cli/azure/vm/extension) для сброса SSHD на виртуальной машине с именем `myVM` в группе ресурсов `myResourceGroup`. Используйте свои значения следующим образом:

```azurecli
az vm extension set --resource-group philmea --vm-name Ubuntu \
    --name VMAccessForLinux --publisher Microsoft.OSTCExtensions --version 1.2 --settings settings.json
```

### <a name="reset-ssh-credentials-for-a-user"></a>Сброс учетных данных SSH пользователя
Если SSHD работает корректно, можно сбросить учетные данные для отдельного пользователя. Чтобы сбросить пароль для пользователя, создайте файл с именем `settings.json`. В следующем примере сбрасываются учетные данные для имени пользователя `myUsername` до значения, указанного в пароле `myPassword`. Введите следующие строки в файл `settings.json`, используя свои значения:

```json
{
    "username":"myUsername", "password":"myPassword"
}
```

Чтобы сбросить ключ SSH для пользователя, сначала создайте файл с именем `settings.json`. В следующем примере сбрасываются учетные данные для имени пользователя `myUsername` до значения, указанного в пароле `myPassword` на виртуальной машине `myVM` в группе ресурсов `myResourceGroup`. Введите следующие строки в файл `settings.json`, используя свои значения:

```json
{
    "username":"myUsername", "ssh_key":"mySSHKey"
}
```

Создав JSON-файл, используйте Azure CLI, чтобы вызвать расширение `VMAccessForLinux` для сброса учетных данных пользователя SSH, указав JSON-файл. В следующем примере сбрасываются учетные данные на виртуальной машине `myVM` в группе ресурсов `myResourceGroup`. Используйте свои значения следующим образом:

```azurecli
az vm extension set --resource-group philmea --vm-name Ubuntu \
    --name VMAccessForLinux --publisher Microsoft.OSTCExtensions --version 1.2 --settings settings.json
```

## <a name="use-the-azure-classic-cli"></a>Использование классического интерфейса командной строки Azure
Если вы этого еще не сделали, [установите интерфейс командной строки Azure и подключитесь к подписке Azure](/cli/azure/install-classic-cli). Убедитесь, что используется режим Resource Manager следующим образом:

```azurecli
azure config mode arm
```

Если вы создали и отправили пользовательский образ диска Linux, убедитесь, что установлен [агент Linux для Microsoft Azure](../extensions/agent-linux.md) версии 2.0.5 или более поздней. В виртуальных машинах, созданных с помощью образов из коллекции, это расширение для доступа уже установлено и настроено.

### <a name="reset-ssh-configuration"></a>Сбросьте конфигурацию SSH.
Может быть неправильно настроена сама конфигурация SSHD, или в службе произошла ошибка. Чтобы убедиться, что конфигурация SSH действительна, можно выполнить сброс SSHD. При устранении неполадок сначала нужно сбросить SSHD.

В следующем примере перезапускается SSHD на виртуальной машине `myVM` в группе ресурсов `myResourceGroup`. Используйте собственные имена для виртуальной машины и группы ресурсов следующим образом:

```azurecli
azure vm reset-access --resource-group myResourceGroup --name myVM \
    --reset-ssh
```

### <a name="reset-ssh-credentials-for-a-user"></a>Сброс учетных данных SSH пользователя
Если SSHD работает корректно, можно сбросить пароль для отдельного пользователя. В следующем примере сбрасываются учетные данные для имени пользователя `myUsername` до значения, указанного в пароле `myPassword` на виртуальной машине `myVM` в группе ресурсов `myResourceGroup`. Используйте свои значения следующим образом:

```azurecli
azure vm reset-access --resource-group myResourceGroup --name myVM \
     --user-name myUsername --password myPassword
```

При использовании аутентификации с помощью ключа SSH можно сбросить ключ SSH для отдельного пользователя. В следующем примере обновляется ключ SSH, хранящийся в файле `~/.ssh/id_rsa.pub`, для пользователя с именем `myUsername` на виртуальной машине `myVM` в группе ресурсов `myResourceGroup`. Используйте свои значения следующим образом:

```azurecli
azure vm reset-access --resource-group myResourceGroup --name myVM \
    --user-name myUsername --ssh-key-file ~/.ssh/id_rsa.pub
```

## <a name="restart-a-vm"></a>Перезапуск виртуальной машины
Если вы сбросили учетные данные пользователя и конфигурацию SSH или столкнулись с ошибкой при этом, попробуйте перезапустить виртуальную машину, чтобы устранить неполадки с базовыми вычислительными ресурсами.

### <a name="azure-portal"></a>Портал Azure
Чтобы перезапустить виртуальную машину с помощью портала Azure, выберите виртуальную машину и щелкните **Перезапуск**, как показано в следующем примере:

![Перезапуск виртуальной машины на портале Azure](./media/troubleshoot-ssh-connection/restart-vm-using-portal.png)

### <a name="azure-cli"></a>Azure CLI
В следующем примере используется команда [az vm restart](/cli/azure/vm), чтобы перезапустить виртуальную машину `myVM` в группе ресурсов `myResourceGroup`. Используйте свои значения следующим образом:

```azurecli
az vm restart --resource-group myResourceGroup --name myVM
```

### <a name="azure-classic-cli"></a>Классический Azure CLI

[!INCLUDE [classic-vm-deprecation](../../../includes/classic-vm-deprecation.md)]

В следующем примере перезапускается виртуальная машина `myVM` в группе ресурсов `myResourceGroup`. Используйте свои значения следующим образом:

```console
azure vm restart --resource-group myResourceGroup --name myVM
```

## <a name="redeploy-a-vm"></a>Повторное развертывание виртуальной машины
Виртуальную машину можно повторно развернуть на другом узле в Azure, что поможет устранить любые базовые сетевые проблемы. Сведения о [повторном развертывании виртуальной машины на новом узле Azure см](./redeploy-to-new-node-windows.md?toc=/azure/virtual-machines/windows/toc.json).

> [!NOTE]
> Обратите внимание, что после этой операции будут потеряны данные на временном диске, а также изменятся динамические IP-адреса, связанные с виртуальной машиной.
>
>

### <a name="azure-portal"></a>Портал Azure
Чтобы повторно развернуть виртуальную машину с помощью портала Azure, выберите виртуальную машину и прокрутите вниз до раздела **Поддержка и устранение неполадок**. Щелкните **Повторно развернуть**, как показано в следующем примере.

![Повторное развертывание виртуальной машины на портале Azure](./media/troubleshoot-ssh-connection/redeploy-vm-using-portal.png)

### <a name="azure-cli"></a>Azure CLI
В следующем примере используется команда [az vm restart](/cli/azure/vm), чтобы повторно развернуть виртуальную машину `myVM` в группе ресурсов `myResourceGroup`. Используйте свои значения следующим образом:

```azurecli
az vm redeploy --resource-group myResourceGroup --name myVM
```

### <a name="azure-classic-cli"></a>Классический Azure CLI

В следующем примере повторно развертывается виртуальная машина `myVM` в группе ресурсов `myResourceGroup`. Используйте свои значения следующим образом:

```console
azure vm redeploy --resource-group myResourceGroup --name myVM
```

## <a name="vms-created-by-using-the-classic-deployment-model"></a>Виртуальные машины, созданные с использованием классической модели развертывания

[!INCLUDE [classic-vm-deprecation](../../../includes/classic-vm-deprecation.md)]

Для устранения наиболее распространенных сбоев SSH-подключения для виртуальных машин, созданных с помощью классической модели развертывания, попробуйте выполнить указанные ниже действия. После выполнения каждого шага попробуйте подключиться к виртуальной машине еще раз.

* Выполните сброс удаленного доступа на [портале Azure](https://portal.azure.com). На портале Azure выберите свою виртуальную машину и щелкните **Reset Remote...** (Удаленный сброс...).
* Перезапустите виртуальную машину. На [портале Azure](https://portal.azure.com) выберите свою виртуальную машину и щелкните **Перезапуск**.

* Повторно разверните виртуальную машину на новом узле Azure. Сведения о [повторном развертывании виртуальной машины на новом узле Azure см](./redeploy-to-new-node-windows.md?toc=/azure/virtual-machines/windows/toc.json).

    Обратите внимание, что после этой операции будут потеряны данные на временном диске, а также изменятся динамические IP-адреса, связанные с виртуальной машиной.
* Следуйте указаниям в статье о [сбросе пароля или ключа SSH в виртуальных машинах Linux](/previous-versions/azure/virtual-machines/linux/classic/reset-access-classic), чтобы сделать следующее:

  * сбросить пароль или ключ SSH;
  * Создайте учетную запись пользователя *sudo*.
  * сбросить конфигурацию SSH.
* Проверьте работоспособность ресурсов виртуальной машины, чтобы выявить любые проблемы, связанные с платформой.<br>
     Выберите виртуальную машину и прокрутите вниз **Параметры**  >  **проверить работоспособность**.

## <a name="additional-resources"></a>Дополнительные ресурсы
* Если вам по-прежнему не удается выполнить SSH-подключение к виртуальной машине, см. [дополнительные действия по устранению неполадок](detailed-troubleshoot-ssh-connection.md), которые позволят просмотреть дополнительные шаги по устранению проблемы.
* Дополнительные сведения об устранении неполадок с доступом к приложению см. в статье [Устранение неполадок доступа к приложению, выполняющемуся в виртуальной машине Azure](./troubleshoot-app-connection.md?toc=/azure/virtual-machines/linux/toc.json).
* Дополнительные сведения об устранении неполадок на виртуальных машинах, созданных с помощью классической модели развертывания, см. в статье о [сбросе пароля или ключа SSH в виртуальных машинах Linux](/previous-versions/azure/virtual-machines/linux/classic/reset-access-classic).