---
title: Цикл перезагрузки Windows на виртуальной машине Azure | Документация Майкрософт
description: Методы устранения неполадок при цикле перезагрузки Windows | Документация Майкрософт
services: virtual-machines-windows
documentationCenter: ''
author: genlin
manager: dcscontentpm
editor: ''
ms.service: virtual-machines-windows
ms.topic: troubleshooting
ms.tgt_pltfrm: vm-windows
ms.workload: infrastructure
ms.date: 10/15/2018
ms.author: genli
ms.openlocfilehash: ad0ed7e9619f0b789bf8949fe398aa27bc36b9e0
ms.sourcegitcommit: 484f510bbb093e9cfca694b56622b5860ca317f7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/21/2021
ms.locfileid: "98629646"
---
# <a name="windows-reboot-loop-on-an-azure-vm"></a>Цикл перезагрузки Windows на виртуальной машине Azure
В этой статье описан цикл перезагрузки, который может возникнуть на виртуальной машине Windows в Microsoft Azure.

## <a name="symptom"></a>Симптом

Когда вы используете [диагностику загрузки](./boot-diagnostics.md), чтобы получить снимки экрана виртуальной машины, вы обнаруживаете, что виртуальная машина загружается, но процесс загрузки прерывается и начинается заново.

![Начальный экран 1](./media/troubleshoot-reboot-loop/start-screen-1.png)

## <a name="cause"></a>Причина

Цикл перезагрузки возникает из-за перечисленных ниже причин.

### <a name="cause-1"></a>Причина 1

Имеется сторонняя служба, отмеченная как критически важная, и ее невозможно запустить. Это приводит к перезагрузке операционной системы.

### <a name="cause-2"></a>Причина 2

В операционную систему были внесены некоторые изменения. Как правило, они связаны с установкой обновления, установкой приложения или новой политикой. Для получения дополнительных сведений необходимо проверить следующие журналы:

- журналы событий;
- CBS.logWindows;
- Update.log.

### <a name="cause-3"></a>Причина 3

Причина может быть вызвана повреждением файловой системы. Тем не менее изменение, которое привело к повреждению операционной системы, трудно диагностировать и выявить.

## <a name="solution"></a>Решение

> [!TIP]
> Если у вас есть недавняя резервная копия виртуальной машины, можно попытаться [восстановить виртуальную машину из резервной копии](../../backup/backup-azure-arm-restore-vms.md) , чтобы устранить проблему загрузки.

Чтобы устранить эту проблему, необходимо [создать резервную копию диска ОС](../windows/snapshot-copy-managed-disk.md) и [подключить диск ОС к виртуальной машине спасения](./troubleshoot-recovery-disks-portal-windows.md). Затем необходимо применить соответствующие варианты решения или попробовать применить решения по очереди.

### <a name="solution-for-cause-1"></a>Решение для причины 1

1. Как только диск ОС будет подключен к рабочей виртуальной машине, в консоли управления дисками пометьте его как **В сети** и запишите букву диска раздела, в котором находится папка **\Windows**.

2. Если для диска установлено значение **Не в сети**, измените его на значение **В сети**.

3. Создайте копию папки **\Windows\System32\config**, если необходим откат в случае изменений.

4. Откройте редактор реестра Windows (regedit) на виртуальной машине спасения.

5. Выберите ключ **HKEY_LOCAL_MACHINE** , а затем в меню выберите **файл**  >  **Загрузить куст** .

6. Перейдите к файлу системы в папке **\Windows\System32\config**.

7. Выберите **Открыть**, в качестве имени введите **BROKENSYSTEM** и разверните раздел **HKEY_LOCAL_MACHINE**. Затем появится дополнительный раздел **BROKENSYSTEM**.

8. Проверьте, с какого контрольного набора загружается компьютер. В следующем разделе реестра появится его номер ключа.

    `HKEY_LOCAL_MACHINE\BROKENSYSTEM\Select\Current`

9. Проверьте, какой уровень серьезности назначен службе агента виртуальной машины, с помощью следующего раздела реестра.

    `HKEY_LOCAL_MACHINE\BROKENSYSTEM\ControlSet00x\Services\RDAgent\ErrorControl`

10. Если для раздела реестра не задано значение **2**, перейдите к следующим инструкциям по устранению рисков.

11. Если для раздела реестра задано значение **2**, замените **2** на **1**.

12. Если какой-либо из следующих разделов имеет значение **2** или **3**, замените эти значения на **1** соответственно:

    - `HKEY_LOCAL_MACHINE\BROKENSYSTEM\ControlSet00x\Services\AzureWLBackupCoordinatorSvc\ErrorControl`
    - `HKEY_LOCAL_MACHINE\BROKENSYSTEM\ControlSet00x\Services\AzureWLBackupInquirySvc\ErrorControl`
    - `HKEY_LOCAL_MACHINE\BROKENSYSTEM\ControlSet00x\Services\AzureWLBackupPluginSvc\ErrorControl`

13. Выберите ключ **BROKENSYSTEM** , а затем в меню выберите **файл**  >  **Выгрузить куст Hive** .

14. Отключите диск операционной системы от виртуальной машины для устранения неполадок.

15. Удалите диск из виртуальной машины для устранения неполадок и подождите около 2 минут, чтобы Azure освободил его.

16. [Создайте виртуальную машину, используя диск ОС](../windows/create-vm-specialized.md).

17. Если проблема устранена, необходимо переустановить [RDAgent](/archive/blogs/mast/install-the-vm-agent-on-an-existing-azure-vm) (WaAppAgent.exe).

### <a name="solution-for-cause-2"></a>Решение для причины 2

Восстановите виртуальную машину до последней удачной конфигурации. Для этого следуйте инструкциям в статье [How to start Azure Windows VM with Last Known Good Configuration](https://support.microsoft.com/help/4016731/) (Запуск виртуальной машины Windows Azure с последней удачной конфигурации).

### <a name="solution-for-cause-3"></a>Решение для причины 3
>[!NOTE]
>Эту процедуру следует применять только в крайнем случае. При восстановлении из regback может восстановиться доступ к машине, но ОС нестабильна, так как в реестре утеряны данные, созданные между меткой времени куста и текущим днем. Необходимо создать виртуальную машину и запланировать перенос данных.

1. После подключения диска к виртуальной машине для устранения неполадок в консоли управления дисками убедитесь, что он помечен как **В сети**.

2. Создайте копию папки **\Windows\System32\config**, если необходим откат в случае изменений.

3. Скопируйте файлы в папку **\Windows\System32\config\regback** и замените файлы в папке **\Windows\System32\config**.

4. Удалите диск из виртуальной машины для устранения неполадок и подождите около 2 минут, чтобы Azure освободил его.

5. [Создайте виртуальную машину, используя диск ОС](../windows/create-vm-specialized.md).
