---
title: Использование виртуальной машины Linux для устранения неполадок с помощью портала Azure | Документация Майкрософт
description: Узнайте, как устранять неполадки с виртуальными машинами Linux, подключив диск операционной системы к виртуальной машине восстановления с помощью портала Azure.
services: virtual-machines-linux
documentationCenter: ''
author: genlin
manager: dcscontentpm
editor: ''
ms.service: virtual-machines-linux
ms.topic: troubleshooting
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure
ms.date: 08/19/2019
ms.author: genli
ms.openlocfilehash: affdee6871649102ef7881fb0f540eba6ab450ca
ms.sourcegitcommit: 2bd0a039be8126c969a795cea3b60ce8e4ce64fc
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/14/2021
ms.locfileid: "98200963"
---
# <a name="troubleshoot-a-linux-vm-by-attaching-the-os-disk-to-a-recovery-vm-using-the-azure-portal"></a>Устранение неполадок с виртуальной машиной Linux при присоединении диска операционной системы к виртуальной машине восстановления с помощью портала Azure
Если возникает проблема с загрузкой или диском на виртуальной машине Linux, возможно, вам нужно устранить неполадки, связанные с самим виртуальным жестким диском. Например, такая ситуация возникает из-за неправильной записи в `/etc/fstab`, которая мешает успешно загрузить виртуальную машину. В этой статье подробно описано, как с помощью портала Azure подключить виртуальный жесткий диск к другой виртуальной машине Linux для устранения ошибок, а затем восстановить исходную виртуальную машину.

## <a name="recovery-process-overview"></a>Обзор процесса восстановления
Процесс устранения неполадок выглядит следующим образом.

1. Остановите затронутую виртуальную машину.
1. Создание моментального снимка для диска ОС виртуальной машины.
1. Создайте виртуальный жесткий диск из моментального снимка.
1. Присоедините и подключите виртуальный жесткий диск к другой виртуальной машине Linux для устранения неполадок.
1. Подключитесь к этой виртуальной машине. Измените файлы или запустите средства, которые нужны для устранения неполадок на исходном виртуальном жестком диске.
1. Отключите и отсоедините виртуальный жесткий диск от виртуальной машины, на которой выполняется устранение неполадок.
1. Замените диск операционной системы виртуальной машины.

> [!NOTE]
> Эта статья не относится к виртуальной машине с неуправляемым диском.

## <a name="determine-boot-issues"></a>Выявление проблем при загрузке
Изучите диагностические сведения о загрузке и снимки экранов виртуальной машины, чтобы определить, почему виртуальная машина не может правильно загрузиться. Например, причиной может быть неправильная запись в `/etc/fstab`, удаление или перемещение базового виртуального жесткого диска.

Выберите на портале эту виртуальную машину и прокрутите экран вниз до раздела **Поддержка и устранение неполадок**. Щелкните **Диагностика загрузки**, чтобы просмотреть сообщения консоли, транслируемые с виртуальной машины. Изучите журналы консоли и постарайтесь определить, что вызывает проблему на виртуальной машине. В следующем примере мы видим, что виртуальная машина не может выйти из режима обслуживания и требует вмешательства оператора.

![Просмотр журналов консоли для диагностики загрузки виртуальной машины](./media/troubleshoot-recovery-disks-portal-linux/boot-diagnostics-error.png)

Можно также щелкнуть **Снимок экрана** в верхней части журнала диагностики загрузки, чтобы загрузить снимок экрана виртуальной машины.

## <a name="take-a-snapshot-of-the-os-disk"></a>Создание моментального снимка диска ОС
Моментальный снимок — это полная копия виртуального жесткого диска, доступная только для чтения. Рекомендуется аккуратно завершить работу виртуальной машины перед созданием моментального снимка, чтобы очистить все выполняющиеся процессы. Чтобы создать моментальный снимок диска операционной системы, выполните следующие действия.

1. Перейдите в [портал Azure](https://portal.azure.com). Выберите **виртуальные машины** на боковой панели, а затем выберите виртуальную машину с проблемой.
1. На левой панели выберите **диски**, а затем выберите имя диска операционной системы.
    ![Изображение с именем диска ОС](./media/troubleshoot-recovery-disks-portal-windows/select-osdisk.png)
1. На странице **Обзор** диска операционной системы, а затем выберите **создать моментальный снимок**.
1. Создайте моментальный снимок в том же расположении, что и диск операционной системы.

## <a name="create-a-disk-from-the-snapshot"></a>Создание диска из моментального снимка
Чтобы создать диск на основе моментального снимка, выполните следующие действия.

1. Выберите **Cloud Shell** из портал Azure.

    ![Изображение об открытии Cloud Shell](./media/troubleshoot-recovery-disks-portal-windows/cloud-shell.png)
1. Выполните следующие команды PowerShell, чтобы создать управляемый диск из моментального снимка. Эти имена примеров следует заменить соответствующими именами.

    ```powershell
    #Provide the name of your resource group
    $resourceGroupName ='myResourceGroup'
    
    #Provide the name of the snapshot that will be used to create Managed Disks
    $snapshotName = 'mySnapshot' 
    
    #Provide the name of theManaged Disk
    $diskName = 'newOSDisk'
    
    #Provide the size of the disks in GB. It should be greater than the VHD file size. In this sample, the size of the snapshot is 127 GB. So we set the disk size to 128 GB.
    $diskSize = '128'
    
    #Provide the storage type for Managed Disk. Premium_LRS or Standard_LRS.
    $storageType = 'Standard_LRS'
    
    #Provide the Azure region (e.g. westus) where Managed Disks will be located.
    #This location should be same as the snapshot location
    #Get all the Azure location using command below:
    #Get-AzLocation
    $location = 'westus'
    
    $snapshot = Get-AzSnapshot -ResourceGroupName $resourceGroupName -SnapshotName $snapshotName 
     
    $diskConfig = New-AzDiskConfig -AccountType $storageType -Location $location -CreateOption Copy -SourceResourceId $snapshot.Id
     
    New-AzDisk -Disk $diskConfig -ResourceGroupName $resourceGroupName -DiskName $diskName
    ```
3. Если команды выполняются успешно, вы увидите новый диск в указанной группе ресурсов.

## <a name="attach-disk-to-another-vm"></a>Подключение диска к другой виртуальной машине
В следующих нескольких шагах описывается использование другой виртуальной машины для устранения неполадок. После подключения диска к виртуальной машине для устранения неполадок можно просмотреть и изменить содержимое диска. Этот процесс позволяет исправлять любые ошибки конфигурации или просматривать дополнительные файлы журналов приложений или систем. Чтобы подключить диск к другой виртуальной машине, выполните следующие действия.

1. Выберите на портале группу ресурсов и виртуальную машину для устранения неполадок. Выберите **диски**, выберите **изменить**, а затем щелкните **Добавить диск данных**:

    ![Присоединение существующего диска на портале](./media/troubleshoot-recovery-disks-portal-windows/attach-existing-disk.png)

2. В списке **диски данных** выберите диск операционной системы виртуальной машины, которую вы определили. Если диск операционной системы не отображается, убедитесь, что устранение неполадок виртуальной машины и диска ОС находятся в том же регионе (расположении). 
3. Нажмите кнопку **сохранить** , чтобы применить изменения.

## <a name="mount-the-attached-data-disk"></a>Подключение присоединенного диска данных

> [!NOTE]
> В следующих примерах описана процедура для виртуальной машины Ubuntu. Если вы используете другой дистрибутив Linux, например Red Hat Enterprise Linux или SUSE, команды `mount` и расположение файлов журнала могут немного отличаться. Используйте документацию к своему дистрибутиву, чтобы скорректировать команды соответствующим образом.

1. Подключитесь к виртуальной машине для устранения неполадок по протоколу SSH, используя соответствующие учетные данные. Если присоединенный вами диск является первым диском данных на этой виртуальной машине, он скорее всего подключен к `/dev/sdc`. Запустите команду `dmseg`, чтобы получить список присоединенных дисков.

    ```bash
    dmesg | grep SCSI
    ```
    Вы должны увидеть результат, аналогичный приведенному ниже.

    ```bash
    [    0.294784] SCSI subsystem initialized
    [    0.573458] Block layer SCSI generic (bsg) driver version 0.4 loaded (major 252)
    [    7.110271] sd 2:0:0:0: [sda] Attached SCSI disk
    [    8.079653] sd 3:0:1:0: [sdb] Attached SCSI disk
    [ 1828.162306] sd 5:0:0:0: [sdc] Attached SCSI disk
    ```

    В предыдущем примере диск операционной системы расположен в `/dev/sda`, а временный диск, предоставляемый для каждой виртуальной машины, расположен в `/dev/sdb`. Если у вас несколько дисков данных, они будут присоединены как `/dev/sdd`, `/dev/sde` и т. д.

2. Создайте каталог для подключения существующего виртуального жесткого диска. Следующая команда создает каталог с именем `troubleshootingdisk`.

    ```bash
    sudo mkdir /mnt/troubleshootingdisk
    ```

3. Если на существующем виртуальном жестком диске есть несколько разделов, подключите нужный. Следующая команда подключает первый основной разделу к каталогу `/dev/sdc1`.

    ```bash
    sudo mount /dev/sdc1 /mnt/troubleshootingdisk
    ```

    > [!NOTE]
    > Мы рекомендуем подключать диски данных к виртуальным машинам Azure с использованием глобального уникального идентификатора (UUID) виртуального жесткого диска. Для нашего упрощенного примера по устранению неполадок можно и не использовать UUID для подключения диска. Но в обычной ситуации, если вы измените `/etc/fstab` так, чтобы виртуальные жесткие диски подключались по имени устройства вместо UUID, у виртуальной машины могут быть проблемы с загрузкой.


## <a name="fix-issues-on-original-virtual-hard-disk"></a>Устранение неполадок на исходном виртуальном жестком диске
Теперь, когда существующий виртуальный жесткий диск подключен, вы можете выполнить любые необходимые действия по обслуживанию и (или) устранению неполадок. После устранения проблем выполните следующие действия.

## <a name="unmount-and-detach-original-virtual-hard-disk"></a>Отключение и отсоединение исходного виртуального жесткого диска
После устранения ошибок отсоедините существующий виртуальный жесткий диск от виртуальной машины, которую использовали для устранения неполадок. Виртуальный жесткий диск нельзя использовать с другой виртуальной машиной, пока вы не отмените аренду, присоединяющую виртуальный жесткий диск к виртуальной машине для устранения неполадок.

1. Используя открытый сеанс подключения по SSH к виртуальной машине для устранения неполадок, отключите существующий виртуальный жесткий диск. Прежде всего выйдите из каталога, в котором создана точка подключения.

    ```bash
    cd /
    ```

    Теперь отключите существующий виртуальный жесткий диск. В следующем примере диск отключается от каталога `/dev/sdc1`:

    ```bash
    sudo umount /dev/sdc1
    ```

2. Теперь отсоедините виртуальный жесткий диск от виртуальной машины. Выберите на портале нужную виртуальную машину и щелкните **Диски**. Выберите существующий виртуальный жесткий диск и щелкните **Отсоединить**.

    ![Отсоединение существующего виртуального жесткого диска](./media/troubleshoot-recovery-disks-portal-windows/detach-disk.png)

    Подождите, пока виртуальная машина успешно отсоединит диск данных, прежде чем продолжать процесс.

## <a name="swap-the-os-disk-for-the-vm"></a>Переключение диска операционной системы для виртуальной машины

Портал Azure теперь поддерживает изменение диска операционной системы виртуальной машины. Для этого выполните следующие действия:

1. Перейдите в [портал Azure](https://portal.azure.com). Выберите **виртуальные машины** на боковой панели, а затем выберите виртуальную машину с проблемой.
1. На левой панели выберите **диски**, а затем выберите вариант **переключить диск ОС**.
        ![Образ, посвященный замене диска ОС в портал Azure](./media/troubleshoot-recovery-disks-portal-windows/swap-os-ui.png)

1. Выберите новый диск, который вы восстановили, а затем введите имя виртуальной машины, чтобы подтвердить изменение. Если диск не отображается в списке, подождите 10 ~ 15 минут после отключения диска от виртуальной машины для устранения неполадок. Также убедитесь, что диск находится в том же расположении, что и виртуальная машина.
1. Нажмите кнопку "ОК".

## <a name="next-steps"></a>Дальнейшие действия
При возникновении проблем с подключением к виртуальной машине см. статью [Устранение неполадок с SSH-подключением к виртуальной машине Azure Linux: сбой, ошибка или отклонение](troubleshoot-ssh-connection.md). Для решения проблем с доступом к приложениям, выполняющимся на виртуальной машине, см. статью [Устранение проблем с подключением к приложениям на виртуальных машинах Linux в Azure](./troubleshoot-app-connection.md?toc=/azure/virtual-machines/linux/toc.json).

Дополнительные сведения об использовании Resource Manager вы найдете в статье [Общие сведения об Azure Resource Manager](../../azure-resource-manager/management/overview.md).
