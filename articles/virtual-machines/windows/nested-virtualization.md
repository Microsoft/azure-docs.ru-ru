---
title: Включение вложенной виртуализации в виртуальных машинах Azure.
description: Включение вложенной виртуализации в виртуальных машинах Azure.
author: cynthn
ms.author: cynthn
ms.date: 10/09/2017
ms.topic: how-to
ms.service: virtual-machines
ms.collection: windows
ms.workload: infrastructure
ms.openlocfilehash: 3988d0ed01e5aa75f498f17f9bbd23e567cb9c07
ms.sourcegitcommit: 7edadd4bf8f354abca0b253b3af98836212edd93
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/10/2021
ms.locfileid: "102556304"
---
# <a name="how-to-enable-nested-virtualization-in-an-azure-vm"></a>Как включить вложенную виртуализацию в виртуальных машинах Azure

Вложенная виртуализация поддерживается в нескольких семействах виртуальных машин Azure. Эта возможность обеспечивает большую гибкость при поддержке сценариев, например в средах разработки, тестирования, обучения и демонстрации.   

В этой статье приведены шаги по включению Hyper-V на виртуальной машине Azure и настройке подключения к Интернету в этой гостевой виртуальной машине.

## <a name="create-a-nesting-capable-azure-vm"></a>Создание вложенной виртуальной машины Azure

Создайте новую виртуальную машину Azure Windows Server 2016 или Windows Server 2019 для узла. Убедитесь, что выбран размер виртуальной машины, поддерживающей вложение, и достаточно большой, чтобы удовлетворить требования гостевых виртуальных машин. Список размеров виртуальных машин, поддерживающих вложение, см. в статье о [единице вычислений Azure](../acu.md) .

Можно просмотреть региональные сведения о доступности размеров виртуальных машин на странице [Доступные продукты по регионам](https://azure.microsoft.com/regions/services/) .

>[!NOTE]
>
>Подробные инструкции по созданию виртуальной машины см. в статье [Создание виртуальных машин Windows и управление ими с помощью модуля Azure PowerShell](./tutorial-manage-vm.md).
    
## <a name="connect-to-your-azure-vm"></a>Подключение к виртуальной машине Azure

Создайте подключение удаленного рабочего стола к виртуальной машине.

1. Нажмите кнопку **Подключиться** в свойствах виртуальной машины. Будет создан и скачан файл протокола удаленного рабочего стола (RDP-файл).

2. Чтобы подключиться к виртуальной машине, откройте скачанный RDP-файл. При появлении запроса нажмите кнопку **Подключиться**. На компьютере Mac вам понадобится клиент RDP, например [Remote Desktop Client](https://apps.apple.com/app/microsoft-remote-desktop/id1295203466?mt=12) из Mac App Store.

3. Введите имя пользователя и пароль, указанные при создании виртуальной машины, и нажмите кнопку **ОК**.

4. При входе в систему может появиться предупреждение о сертификате. Чтобы продолжить процесс подключения, нажмите кнопку **Да** или **Продолжить**.

## <a name="enable-the-hyper-v-feature-on-the-azure-vm"></a>Включение компонента Hyper-V на виртуальной машине Azure
Можно настроить эти параметры вручную или использовать предоставленный скрипт PowerShell, автоматизирующий настройку.

### <a name="option-1-use-a-powershell-script-to-configure-nested-virtualization"></a>Вариант 1. Использование скрипта PowerShell для настройки вложенной виртуализации
Скрипт PowerShell, который включает вложенную виртуализацию на узле Windows Server 2016, доступен на [GitHub](https://github.com/charlieding/Virtualization-Documentation/tree/live/hyperv-tools/Nested). Скрипт проверяет предварительные требования, а затем настраивает вложенную виртуализацию на виртуальной машине Azure. Для завершения настройки требуется перезагрузить виртуальную машину Azure. Этот скрипт может работать в других средах, однако это не гарантируется. Просмотрите запись блога Azure с видеодемонстрацией вложенной виртуализации, выполняемой в Azure! https://aka.ms/AzureNVblog.

### <a name="option-2-configure-nested-virtualization-manually"></a>Вариант 2. Настройка вложенной виртуализации вручную

1. На виртуальной машине Azure откройте PowerShell от имени администратора. 

2. Включите компонент Hyper-V и средства управления.

    ```powershell
    Install-WindowsFeature -Name Hyper-V -IncludeManagementTools -Restart
    ```

    >[!WARNING] 
    >
    >Эта команда перезапускает виртуальную машину Azure. Подключение RDP будет потеряно во время процесса перезагрузки.
    
3. После перезагрузки виртуальной машины Azure повторно подключитесь к виртуальной машине с помощью RDP.

## <a name="set-up-internet-connectivity-for-the-guest-virtual-machine"></a>Настройка подключения к Интернету для гостевой виртуальной машины
Создайте адаптер виртуальной сети для гостевой виртуальной машины и настройте шлюз NAT для подключения к Интернету.

### <a name="create-a-nat-virtual-network-switch"></a>Создание переключателя виртуальной сети NAT

1. На виртуальной машине Azure откройте PowerShell от имени администратора.
   
2. Создайте внутренний переключатель.

    ```powershell
    New-VMSwitch -Name "InternalNAT" -SwitchType Internal
    ```

3. Просмотрите свойства переключателя и запишите параметр ifIndex для нового адаптера.

    ```powershell
    Get-NetAdapter
    ```

    ![NetAdapter](./media/virtual-machines-nested-virtualization/get-netadapter.png)

    >[!NOTE] 
    >
    >Запишите "ifIndex" виртуального переключателя, который был только что создан.
    
4. Создайте IP-адрес шлюза NAT.
    
Чтобы настроить шлюз, необходимы некоторые сведения о сети:    
  * IP-адрес — IP-адрес шлюза NAT, который используется в качестве адреса шлюза по умолчанию для подсети виртуальной сети. Универсальный формат — a.b.c.1 (например, "192.168.0.1"). Хотя конечное расположение не обязательно должно быть равно 0,1, обычно это (на основе длины префикса). Обычно следует использовать адресное пространство для частной сети RFC 1918. 
  * PrefixLength. Длина префикса подсети определяет размер локальной подсети (маска подсети). Длина префикса подсети будет иметь целочисленное значение от 0 до 32. Значение 0 будет соответствовать всему Интернету, а 32 — разрешать только один сопоставленный IP-адрес. Обычный диапазон значений — от 24 до 12 в зависимости количества IP-адресов, которые необходимо подключить к NAT. Обычный PrefixLength равен 24. Это маска подсети 255.255.255.0.
  * InterfaceIndex. **ifIndex** — это индекс интерфейса виртуального переключателя, созданного на предыдущем шаге. 

    ```powershell
    New-NetIPAddress -IPAddress 192.168.0.1 -PrefixLength 24 -InterfaceIndex 13
    ```

### <a name="create-the-nat-network"></a>Создание сети NAT

Чтобы настроить шлюз, необходимо предоставить данные о сети и шлюзе NAT:
  * Name. Это имя сети NAT. 
  * InternalIPInterfaceAddressPrefix. Префикс подсети NAT описывает упомянутый выше IP-адрес шлюза NAT, а также длину префикса подсети NAT, описанную выше. Универсальный формат длины префикса подсети — a.b.c.0/NAT. 

Создайте сеть NAT в PowerShell.
```powershell
New-NetNat -Name "InternalNat" -InternalIPInterfaceAddressPrefix 192.168.0.0/24
```


## <a name="create-the-guest-virtual-machine"></a>Создание гостевой виртуальной машины

>[!IMPORTANT] 
>
>Гостевой агент Azure не поддерживается на вложенных виртуальных машинах и может вызвать проблемы как на узле, так и на вложенных виртуальных машинах. Не устанавливайте агент Azure на вложенных виртуальных машинах и не используйте образ для создания вложенных виртуальных машин, на которых уже установлен Гостевой агент Azure.

1. Откройте диспетчер Hyper-V и создайте виртуальную машину. Настройте виртуальную машину для использования созданной внутренней сети.
    
    ![NetworkConfig](./media/virtual-machines-nested-virtualization/configure-networking.png)
    
2. Установите операционную систему на гостевой виртуальной машине.
    
    >[!NOTE] 
    >
    >Вам потребуется установочный носитель для установки операционной системы на виртуальную машину. В этом случае используется Windows 10 Корпоративная.

## <a name="assign-an-ip-address-to-the-guest-virtual-machine"></a>Присвоение IP-адреса гостевой виртуальной машине

IP-адрес можно присвоить гостевой виртуальной машине, вручную установив статичный IP-адрес на ней или настроив DHCP на виртуальной машине Azure для динамического присвоения IP-адреса.

###  <a name="option-1-configure-dhcp-to-dynamically-assign-an-ip-address-to-the-guest-virtual-machine"></a>Вариант 1. Настройка DHCP для динамического присвоения IP-адреса для гостевой виртуальной машины
Выполните следующие действия, чтобы настроить DHCP на виртуальной машине узла для динамического присвоения адреса.

#### <a name="install-dhcp-server-on-the-azure-vm"></a>Установка DHCP-сервера на виртуальной машине Azure

1. Откройте диспетчер сервера. На панели мониторинга щелкните **Добавить роли и компоненты**. Откроется мастер добавления ролей и компонентов.
  
2. В мастере нажимайте кнопку **Далее**, пока не появится страница "Роли сервера".
  
3. Щелкните, чтобы установить флажок **DHCP-сервер**, а затем выберите **Добавить компоненты** и нажимайте кнопку **Далее** до завершения работы мастера.
  
4. Щелкните **Install**(Установить).

#### <a name="configure-a-new-dhcp-scope"></a>Настройка новой области DHCP

1. Откройте диспетчер DHCP.
  
2. В области навигации разверните имя сервера, щелкните правой кнопкой мыши **IPv4**, а затем щелкните **Создать область**. Когда откроется мастер создания области, нажмите кнопку **Далее**.
  
3. Введите имя и описание области и нажмите кнопку **Далее**.
  
4. Определите диапазон IP-адресов для DHCP-сервера (например, 192.168.0.100 на 192.168.0.200).
  
5. Нажимайте кнопку **Далее**, пока не появится страница шлюза по умолчанию. Введите IP-адрес, созданный ранее (например, 192.168.0.1) в качестве шлюза по умолчанию, а затем нажмите кнопку **Добавить**.
  
6. Нажимайте кнопку **Далее** до завершения работы мастера, оставляя все значения по умолчанию, а затем нажмите кнопку **Готово**.
    
### <a name="option-2-manually-set-a-static-ip-address-on-the-guest-virtual-machine"></a>Вариант 2. Настройка статического IP-адреса на гостевой виртуальной машине вручную
Если вы не настроили DHCP для динамического присвоения IP-адреса для гостевой виртуальной машины, выполните следующие шаги, чтобы установить статический IP-адрес.

1. На виртуальной машине Azure откройте PowerShell от имени администратора.

2. Щелкните правой кнопкой мыши гостевую виртуальную машину и выберите "Подключить".

3. Войдите на гостевую виртуальную машину.

4. На гостевой виртуальной машине откройте Центр управления сетями и общим доступом.

5. Настройте сетевой адаптер для адреса в диапазоне сети NAT, созданной в предыдущем разделе.

В этом примере будем использовать адрес в диапазоне 192.168.0.0/24.

## <a name="test-connectivity-in-guest-virtual-machine"></a>Проверка подключения на гостевой виртуальной машине

На гостевой виртуальной машине откройте браузер и перейдите на веб-страницу.
    ![GuestVM](./media/virtual-machines-nested-virtualization/guest-virtual-machine.png)

Инструкции по обеспечению прозрачного подключения между гостевыми виртуальными машинами и виртуальными машинами Azure см. [в этом документе](/virtualization/hyper-v-on-windows/user-guide/nested-virtualization).
