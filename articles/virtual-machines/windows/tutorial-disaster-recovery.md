---
title: Учебник. Настройка аварийного восстановления для виртуальных машин Windows с помощью Azure Site Recovery
description: Сведения о включении аварийного восстановления виртуальных машин Windows в другом регионе Azure с помощью службы Azure Site Recovery.
author: rayne-wiselman
ms.service: virtual-machines
ms.collection: windows
ms.subservice: recovery
ms.topic: tutorial
ms.date: 11/05/2020
ms.author: raynew
ms.custom: mvc
ms.openlocfilehash: e9f44ea2af832729a47bf4b719b90f9b14e401b9
ms.sourcegitcommit: e6de1702d3958a3bea275645eb46e4f2e0f011af
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "102555862"
---
# <a name="tutorial-enable-disaster-recovery-for-windows-vms"></a>Руководство по включению аварийного восстановления для виртуальных машин Windows

В этом учебнике показано, как настроить аварийное восстановление для виртуальных машин Azure под управлением Windows. В этой статье раскрываются следующие темы:

> [!div class="checklist"]
> * Включение аварийного восстановления для виртуальной машины Windows.
> * Отработка аварийного восстановления
> * Остановка репликации виртуальной машины после тестирования.

Когда вы включаете репликацию для виртуальной машины, расширение службы "Мобильность" Site Recovery устанавливается на этой виртуальной машине и регистрирует ее в [Azure Site Recovery](../../site-recovery/site-recovery-overview.md). В процессе репликации сведения об операциях записи на диск виртуальной машины отправляются в учетную запись хранения кэша в исходном регионе. Данные отправляются из этого расположения в целевой регион, и на их основе создаются точки восстановления.  При выполнении отработки отказа виртуальной машины во время аварийного восстановления для восстановления виртуальной машины в целевом регионе используется точка восстановления.

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись](https://azure.microsoft.com/pricing/free-trial/), прежде чем начинать работу.

## <a name="prerequisites"></a>Предварительные требования

1. Убедитесь, что ваша подписка Azure позволяет создать виртуальную машину в целевом регионе. Если вы создали бесплатную учетную запись Azure, вы являетесь администратором подписки и у вас есть необходимые разрешения.
2. Если вы не администратор подписки, свяжитесь с администратором, чтобы получить необходимые разрешения:
    - Встроенную роль "Участник виртуальных машин" или следующие конкретные разрешения:
        - разрешение на создание виртуальной машины в выбранной виртуальной сети;
        - разрешение на запись в учетную запись хранения Azure;
        - разрешение на запись на управляемый диск Azure.
    - Встроенную роль "Участник Site Recovery" для управления операциями Site Recovery в хранилище. 
3. Рекомендуем использовать виртуальную машину Windows под управлением Windows Server 2012 или более поздней версии. Для выполнения действий, описанных в этом учебнике, диск виртуальной машины не должен быть зашифрован.
4. Если для исходящих подключений виртуальной машины используется прокси-сервер на основе URL-адресов, убедитесь, что он имеет доступ к этим URL-адресам. Аутентифицированный прокси-сервер не поддерживается.

    **Название** | **Общедоступное облако** | **Облако для государственных организаций** | **Сведения**
    --- | --- | --- | ---
    Память | `*.blob.core.windows.net` | `*.blob.core.usgovcloudapi.net`| Записывает данные из виртуальной машины в учетную запись хранения кэша в исходном регионе. 
    Azure AD  | `login.microsoftonline.com` | `login.microsoftonline.us`| Позволяет выполнять авторизацию и проверку подлинности для URL-адресов службы Site Recovery. 
    Репликация | `*.hypervrecoverymanager.windowsazure.com` | `*.hypervrecoverymanager.windowsazure.com`  |Обеспечивает связь виртуальной машины со службой Site Recovery. 
    Cлужебная шина | `*.servicebus.windows.net` | `*.servicebus.usgovcloudapi.net` | Виртуальная машина записывает данные мониторинга и диагностики службы Site Recovery. 

4. Если вы используете группы безопасности сети (NSG) для ограничения сетевого трафика виртуальных машин, создайте правила NSG, которые разрешают исходящее подключение (HTTPS 443) для виртуальной машины, используя указанные теги службы (группы IP-адресов). Сначала ознакомьтесь с правилами тестовой группы NSG.

    **Тег** | **Разрешить** 
    --- | --- 
    Тег Storage | Позволяет записывать данные с виртуальной машины в учетную запись хранения кэша.
    Тег Azure AD | Разрешает доступ ко всем IP-адресам, которые соответствуют Azure AD.
    Тег EventsHub | Разрешает доступ к мониторингу Site Recovery.
    Тег AzureSiteRecovery | Разрешает доступ к службе Site Recovery в любом регионе.
    GuestAndHybridManagement | Используется для автоматического обновления агента службы "Мобильность" Site Recovery, работающего на виртуальных машинах, включенных для репликации.
5.  На виртуальных машинах Windows установите последние обновления Windows, чтобы гарантировать наличие корневых сертификатов последних версий.
 
## <a name="enable-disaster-recovery"></a>Включение аварийного восстановления

1. На портале Azure откройте страницу свойств виртуальной машины.
2. В разделе **Операции** щелкните **Аварийное восстановление**.
3. В разделе **Основные сведения** > **Целевой регион** выберите регион, в который необходимо реплицировать виртуальную машину. Исходные и целевые регионы должны быть в одном клиенте Azure Active Directory.
4. Щелкните **Обзор и запуск репликации**.

    :::image type="content" source="./media/tutorial-disaster-recovery/disaster-recovery.png" alt-text="Включение репликации на странице аварийного восстановления в свойствах виртуальной машины.":::

5. На вкладке **Обзор и запуск репликации** проверьте указанные ниже параметры.

    - **Целевые параметры.** По умолчанию Site Recovery отображает параметры источника для создания целевых ресурсов.
    - **Параметры хранилища — учетная запись хранения кэша.** Recovery использует учетную запись хранения в исходном регионе. Изменения в исходных виртуальных машинах кэшируются в этой учетной записи перед репликацией в целевое расположение.
    - **Параметры хранилища — диск реплики.** Site Recovery по умолчанию создает управляемые диски реплики в целевом регионе, которые соответствуют управляемым дискам исходной виртуальной машины с тем же типом хранилища (категории "Стандартный" или "Премиум").
    - **Параметры репликации.** Отображает сведения о хранилище и указывает, что точки восстановления, созданные Site Recovery, хранятся в течение 24 часов.
    - **Параметры расширения.** Указывает, что Site Recovery управляет обновлениями для расширения службы "Мобильность" Site Recovery, которое установлено на реплицируемых виртуальных машинах. Указанная учетная запись службы автоматизации Azure позволяет управлять процессом обновления.

    :::image type="content" source="./media/tutorial-disaster-recovery/settings-summary.png" alt-text="Страница со сводкой параметров целевого объекта и репликации.":::

2. Выберите **Запустить репликацию**. Запустится развертывание, и Site Recovery начнет создавать целевые ресурсы. Ход выполнения репликации можно отслеживать в разделе уведомлений.

    :::image type="content" source="./media/tutorial-disaster-recovery/notifications.png" alt-text="Уведомление о ходе выполнения репликации.":::

## <a name="check-vm-status"></a>Проверка состояния виртуальной машины

После завершения задания репликации можно проверить состояние репликации виртуальной машины.

1. Откройте страницу свойств виртуальной машины.
2. В разделе **Операции** щелкните **Аварийное восстановление**.
3. Разверните раздел **Основные компоненты**, чтобы ознакомиться с параметрами по умолчанию для хранилища, политиками репликации и целевыми параметрами.
4. В разделе **Работоспособность и состояние** получите сведения о состоянии репликации для виртуальной машины, версии агента, готовности к отработке отказа и последних точках восстановления. 

    :::image type="content" source="./media/tutorial-disaster-recovery/essentials.png" alt-text="Представление основных компонентов для аварийного восстановления виртуальной машины.":::

5. В разделе **Представление инфраструктуры** получите наглядное представление об исходных и целевых виртуальных машинах, управляемых дисках и учетной записи хранения кэша.

    :::image type="content" source="./media/tutorial-disaster-recovery/infrastructure.png" alt-text="Схема визуальной инфраструктуры для аварийного восстановления виртуальной машины.":::


## <a name="run-a-drill"></a>Запуск тестирования

Запустите тестирование, чтобы убедиться в надлежащей работе аварийного восстановления. При выполнении тестовой отработки отказа создается копия виртуальной машины. Это не влияет на текущую репликацию или рабочую среду. 

1. На странице аварийного восстановления виртуальной машины выберите **Тестовая отработка отказа**.
2. В разделе **Тестовая отработка отказа** оставьте значение по умолчанию **Latest processed (low RPO)** (Последняя обработанная (низкое значение RPO)) для точки восстановления.

   Этот параметр обеспечивает наименьшую целевую точку восстановления (RPO) и, как правило, самый быстрый запуск целевой виртуальной машины. Сначала обрабатываются все данные, отправленные в службу Site Recovery, чтобы создать точку восстановления для каждой виртуальной машины, прежде чем выполнять в нее отработку отказа. Эта точка восстановления имеет все реплицированные в Site Recovery данные на момент запуска отработки отказа.

3. Выберите виртуальную сеть, в которой виртуальная машина будет находиться после отработки отказа. 

     :::image type="content" source="./media/tutorial-disaster-recovery/test-failover-settings.png" alt-text="Страница для установки параметров тестовой отработки отказа.":::

4. Начнется тестовая отработка отказа. Ход выполнения можно отслеживать в разделе уведомлений.

    :::image type="content" source="./media/tutorial-disaster-recovery/test-failover-notification.png" alt-text="Уведомления о тестировании отработки отказа."::: 
    
   После завершения тестовой отработки отказа виртуальная машина находится в состоянии *Ожидание отработки отказа очистки теста* на странице **Основные компоненты**. 



## <a name="clean-up-resources"></a>Очистка ресурсов

Данные в виртуальной машине автоматически очищаются с помощью Site Recovery после тестирования.

1. Чтобы начать автоматическую очистку, выберите **Очистить тестовую отработку отказа**.

    :::image type="content" source="./media/tutorial-disaster-recovery/start-cleanup.png" alt-text="Запуск очистки на странице основных компонентов."::: 

2. В разделе **Очистка тестовой отработки отказа** введите любые заметки, которые необходимо записать для отработки отказа, а затем установите флажок **Тестирование завершено. Удалите виртуальную машину для тестовой отработки отказа**. Нажмите кнопку **ОК**.

    :::image type="content" source="./media/tutorial-disaster-recovery/delete-test.png" alt-text="Страница для записи заметок и удаления тестовой виртуальной машины."::: 

7. Начнется удаление. Ход выполнения можно отслеживать в разделе уведомлений.

    :::image type="content" source="./media/tutorial-disaster-recovery/delete-test-notification.png" alt-text="Раздел уведомлений для отслеживания удаления тестовой виртуальной машины."::: 

### <a name="stop-replicating-the-vm"></a>Остановка репликации виртуальной машины

После завершения тестирования аварийного восстановления рекомендуем выполнить полную отработку отказа. Если вы не хотите выполнять полную отработку отказа, можно отключить репликацию. Таким образом вы сделаете следующее:

- Удалите виртуальную машину из списка Site Recovery реплицированных компьютеров.
- Остановите выставление счетов Site Recovery за виртуальную машину.
- Автоматически очистите параметры репликации в источнике.

Остановите репликацию следующим образом.

1. На странице аварийного восстановления виртуальной машины выберите **Отключить репликацию**.
2. В разделе **Отключить репликацию** укажите причины, по которым необходимо отключить репликацию. Нажмите кнопку **ОК**.

    :::image type="content" source="./media/tutorial-disaster-recovery/disable-replication.png" alt-text="Страница отключения репликации с указанием причины."::: 


Расширение Site Recovery, установленное на виртуальной машине во время репликации, автоматически не удаляется. Если вы отключаете репликацию виртуальной машины и не хотите реплицировать ее позже, можете вручную удалить расширение Site Recovery следующим образом: 

1. Выберите "Виртуальная машина" > **Параметры** > **Расширения**.
2. На странице **Расширения** выберите каждую запись *Microsoft.Azure.RecoveryServices* для Linux.
3. На странице свойств расширения выберите **Удалить**.

   :::image type="content" source="./media/tutorial-disaster-recovery/uninstall-extension.png" alt-text="Страница удаления расширения виртуальной машины Site Recovery.":::



## <a name="next-steps"></a>Дальнейшие действия

В рамках работы с этим учебником вы настроили аварийное восстановление для виртуальной машины Azure и выполнили тестирование аварийного восстановления. Теперь можно выполнить полную отработку отказа для виртуальной машины.

> [!div class="nextstepaction"]
> [Отработка отказа виртуальной машины в другой регион](../../site-recovery/azure-to-azure-tutorial-dr-drill.md)
