---
title: Учебник. Настройка аварийного восстановления для виртуальных машин Windows с помощью Azure Site Recovery
description: Сведения о включении аварийного восстановления виртуальных машин Windows в другом регионе Azure с помощью службы Azure Site Recovery.
author: rayne-wiselman
ms.service: virtual-machines
ms.collection: windows
ms.subservice: recovery
ms.topic: tutorial
ms.date: 11/05/2020
ms.author: raynew
ms.custom: mvc
ms.openlocfilehash: fd5d8c3e2c6e4ee5556568ebd23ac99b48300e9d
ms.sourcegitcommit: 77d7639e83c6d8eb6c2ce805b6130ff9c73e5d29
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/05/2021
ms.locfileid: "106382036"
---
# <a name="tutorial-enable-disaster-recovery-for-windows-vms"></a>Руководство по включению аварийного восстановления для виртуальных машин Windows

В этом учебнике показано, как настроить аварийное восстановление для виртуальных машин Azure под управлением Windows. В этой статье раскрываются следующие темы:

> [!div class="checklist"]
> * Включение аварийного восстановления для виртуальной машины Windows.
> * Запустите аварийное восстановление, чтобы убедиться, что оно работает надлежащим образом
> * Остановка репликации виртуальной машины после тестирования.

Когда вы включаете репликацию для виртуальной машины, расширение службы "Мобильность" Site Recovery устанавливается на этой виртуальной машине и регистрирует ее в [Azure Site Recovery](../../site-recovery/site-recovery-overview.md). В процессе репликации сведения об операциях записи на диск виртуальной машины отправляются в учетную запись хранения кэша в исходном регионе. Данные отправляются из этого расположения в целевой регион, и на их основе создаются точки восстановления.  При выполнении отработки отказа виртуальной машины во время аварийного восстановления для создания виртуальной машины в целевом регионе используется точка восстановления.

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись](https://azure.microsoft.com/pricing/free-trial/), прежде чем начинать работу.

## <a name="prerequisites"></a>Предварительные требования

1. Убедитесь, что ваша подписка Azure позволяет создать виртуальную машину в целевом регионе. Если вы создали бесплатную учетную запись Azure, вы являетесь администратором подписки и у вас есть необходимые разрешения.
2. Если вы не администратор подписки, свяжитесь с администратором, чтобы получить необходимые разрешения:
    - Встроенную роль "Участник виртуальных машин" или следующие конкретные разрешения:
        - разрешение на создание виртуальной машины в выбранной виртуальной сети;
        - разрешение на запись в учетную запись хранения Azure;
        - разрешение на запись на управляемый диск Azure.
    - Встроенную роль "Участник Site Recovery" для управления операциями Site Recovery в хранилище. 
3. Рекомендуем использовать виртуальную машину Windows под управлением Windows Server 2012 или более поздней версии. Для выполнения действий, описанных в этом учебнике, диск виртуальной машины не должен быть зашифрован.
4. Если для исходящих подключений виртуальной машины используется прокси-сервер на основе URL-адресов, убедитесь, что он имеет доступ к этим URL-адресам. Аутентифицированный прокси-сервер не поддерживается.

    **Название** | **Общедоступное облако** | **Облако для государственных организаций** | **Сведения**
    --- | --- | --- | ---
    Память | `*.blob.core.windows.net` | `*.blob.core.usgovcloudapi.net`| Записывает данные из виртуальной машины в учетную запись хранения кэша в исходном регионе. 
    Azure AD  | `login.microsoftonline.com` | `login.microsoftonline.us`| Позволяет выполнять авторизацию и проверку подлинности для URL-адресов службы Site Recovery. 
    Репликация | `*.hypervrecoverymanager.windowsazure.com` | `*.hypervrecoverymanager.windowsazure.com`  |Обеспечивает связь виртуальной машины со службой Site Recovery. 
    Cлужебная шина | `*.servicebus.windows.net` | `*.servicebus.usgovcloudapi.net` | Виртуальная машина записывает данные мониторинга и диагностики службы Site Recovery. 

4. Если вы используете группы безопасности сети (NSG) для ограничения сетевого трафика виртуальных машин, создайте правила NSG, которые разрешают исходящее подключение (HTTPS 443) для виртуальной машины, используя указанные теги службы (группы IP-адресов). Сначала ознакомьтесь с правилами тестовой группы NSG.

    **Тег** | **Разрешить** 
    --- | --- 
    Тег Storage | Позволяет записывать данные с виртуальной машины в учетную запись хранения кэша.
    Тег Azure AD | Разрешает доступ ко всем IP-адресам, которые соответствуют Azure AD.
    Тег EventsHub | Разрешает доступ к мониторингу Site Recovery.
    Тег AzureSiteRecovery | Разрешает доступ к службе Site Recovery в любом регионе.
    GuestAndHybridManagement | Используется для автоматического обновления агента службы "Мобильность" Site Recovery, работающего на виртуальных машинах, включенных для репликации.
5.  На виртуальных машинах Windows установите последние обновления Windows, чтобы гарантировать наличие корневых сертификатов последних версий.

## <a name="create-a-vm-and-enable-disaster-recovery"></a>Создание виртуальной машины и включение аварийного восстановления

При необходимости можно включить аварийное восстановление при создании виртуальной машины.

1. [Создайте виртуальную машину](quick-create-portal.md).
2. На вкладке **Управление** выберите **Включить аварийное восстановление**.
3. В поле **Дополнительный регион** выберите целевой регион, в который вы хотите реплицировать виртуальную машину для аварийного восстановления.
4. В поле **Дополнительная подписка** выберите целевую подписку, в которой будет создана целевая виртуальная машина. Целевая виртуальная машина создается при выполнении отработки отказа исходной виртуальной машины из исходного региона в целевой.
5. В поле **Хранилище служб восстановления** выберите хранилище, которое вы хотите использовать для репликации. Если у вас нет хранилища, щелкните **Создать**. Выберите группу ресурсов, в которой будет размещено хранилище, и укажите имя хранилища.
6. В поле **Политика Site Recovery** оставьте политику по умолчанию или выберите **Создать**, чтобы задать пользовательские значения.

    - Точки восстановления создаются на основе моментальных снимков дисков виртуальной машины, сделанных в определенный момент времени. При отработке отказа виртуальной машины эти точки восстановления используются для восстановления виртуальной машины в целевом регионе. 
    - Отказоустойчивая точка восстановления создается каждые пять минут. Этот параметр нельзя изменить. Отказоустойчивый моментальный снимок содержит данные, которые находились на диске в момент создания моментального снимка. Он не содержит никакой информации из памяти компьютера. 
    - По умолчанию Site Recovery хранит отказоустойчивые точки восстановления в течение 24 часов. Можно задать пользовательское значение времени хранения в интервале от 0 до 72 часов.
    - Моментальный снимок с согласованием приложений создается каждые 4 часа. Моментальный снимок с согласованием приложений 
    - По умолчанию Site Recovery сохраняет точки восстановления в течение 24 часов.

7. В области **Параметры доступности** укажите, следует ли развертывать виртуальную машину как автономную, в зоне доступности или в группе доступности.

    :::image type="content" source="./media/tutorial-disaster-recovery/create-vm.png" alt-text="Включение репликации на странице свойств управления виртуальной машиной."

8. Завершите создание виртуальной машины.

## <a name="enable-disaster-recovery-for-an-existing-vm"></a>Включение аварийного восстановления для существующей виртуальной машины

Если вы хотите включить аварийное восстановление для существующей виртуальной машины, а не для новой виртуальной машины, используйте следующую процедуру.

1. На портале Azure откройте страницу свойств виртуальной машины.
2. В разделе **Операции** щелкните **Аварийное восстановление**.

    :::image type="content" source="./media/tutorial-disaster-recovery/existing-vm.png" alt-text="Откройте параметры аварийного восстановления для существующей виртуальной машины.":::

3. В разделе **Основные сведения** можно выбрать аварийное восстановление между зонами доступности, если виртуальная машина развернута в зоне доступности.
4. В разделе **Целевой регион** выберите регион, в который необходимо реплицировать виртуальную машину. Исходные и целевые регионы должны быть в одном клиенте Azure Active Directory.

    :::image type="content" source="./media/tutorial-disaster-recovery/basics.png" alt-text="Задайте базовые параметры аварийного восстановления для виртуальной машины.":::

5. По завершении выберите **Next: Расширенные параметры**.
6. В разделе **Расширенные параметры** можно просматривать параметры и изменять значения пользовательских параметров. По умолчанию Site Recovery отображает параметры источника для создания целевых ресурсов.

    - **Целевая подписка**. Подписка, в которой создается целевая виртуальная машина после отработки отказа.
    - **Группа ресурсов целевой виртуальной машины**. Группа ресурсов, в которой создается целевая виртуальная машина после отработки отказа.
    - **Target virtual network** (Целевая виртуальная сеть). Виртуальная сеть Azure, в которой находится целевая виртуальная машина, когда она создается после отработки отказа.
    - **Целевая группа или зона доступности**. Используется, если целевая виртуальная машина создается в виде одного экземпляра в группе доступности или зоне доступности.
    - **Группа размещения близкого взаимодействия**. Если применимо, выберите группу размещения близкого взаимодействия, в которой будет находиться целевая виртуальная машина после отработки отказа.
    - **Параметры хранилища — учетная запись хранения кэша.** Восстановление использует учетную запись хранения в исходном регионе в качестве временного хранилища данных. Изменения в исходных виртуальных машинах кэшируются в этой учетной записи перед репликацией в целевое расположение.
        - По умолчанию для каждого хранилища создается и повторно используется одна учетная запись хранения кэша.
        - Если вы хотите настроить учетную запись кэша для виртуальной машины, то вы можете выбрать другую учетную запись хранения.
    - **Параметры хранилища — управляемый диск реплики.** По умолчанию Site Recovery создает управляемые диски реплики в целевом регионе.
        -  По умолчанию на целевом управляемом диске создается зеркальное отображение управляемых дисков исходной виртуальной машины с использованием того же типа хранилища (диск HDD/SSD уровня "Стандартный" или диск SSD уровня "Премиум").
        - При необходимости можно задать желаемый тип хранилища.
    - **Параметры репликации.** Отображает хранилище, в котором находится виртуальная машина, и политику репликации, используемую для виртуальной машины. По умолчанию точки восстановления, созданные Site Recovery для виртуальной машины, хранятся в течение 24 часов.
    - **Параметры расширения.** Указывает, что Site Recovery управляет обновлениями для расширения службы "Мобильность" Site Recovery, которое установлено на реплицируемых виртуальных машинах.
        - Указанная учетная запись службы автоматизации Azure позволяет управлять процессом обновления.
        - Вы можете настроить учетную запись службы автоматизации.

    :::image type="content" source="./media/tutorial-disaster-recovery/settings-summary.png" alt-text="Страница со сводкой параметров целевого объекта и репликации.":::


6. Выберите **Обзор и запуск репликации**.

7. Выберите **Запустить репликацию**. Запустится развертывание, и Site Recovery начнет создавать целевые ресурсы. Ход выполнения репликации можно отслеживать в разделе уведомлений.

    :::image type="content" source="./media/tutorial-disaster-recovery/notifications.png" alt-text="Уведомление о ходе выполнения репликации.":::

## <a name="check-vm-status"></a>Проверка состояния виртуальной машины

После завершения задания репликации можно проверить состояние репликации виртуальной машины.

1. Откройте страницу свойств виртуальной машины.
2. В разделе **Операции** щелкните **Аварийное восстановление**.
3. Разверните раздел **Основные компоненты**, чтобы ознакомиться с параметрами по умолчанию для хранилища, политиками репликации и целевыми параметрами.
4. В разделе **Работоспособность и состояние** получите сведения о состоянии репликации для виртуальной машины, версии агента, готовности к отработке отказа и последних точках восстановления. 

    :::image type="content" source="./media/tutorial-disaster-recovery/essentials.png" alt-text="Представление основных компонентов для аварийного восстановления виртуальной машины.":::

5. В разделе **Представление инфраструктуры** получите наглядное представление об исходных и целевых виртуальных машинах, управляемых дисках и учетной записи хранения кэша.

    :::image type="content" source="./media/tutorial-disaster-recovery/infrastructure.png" alt-text="Схема визуальной инфраструктуры для аварийного восстановления виртуальной машины.":::


## <a name="run-a-drill"></a>Запуск тестирования

Запустите тестирование, чтобы убедиться в надлежащей работе аварийного восстановления. При выполнении тестовой отработки отказа создается копия виртуальной машины. Это не влияет на текущую репликацию или рабочую среду. 

1. На странице аварийного восстановления виртуальной машины выберите **Тестовая отработка отказа**.
2. В разделе **Тестовая отработка отказа** оставьте значение по умолчанию **Latest processed (low RPO)** (Последняя обработанная (низкое значение RPO)) для точки восстановления.

   Этот параметр обеспечивает наименьшую целевую точку восстановления (RPO) и, как правило, самый быстрый запуск целевой виртуальной машины. Сначала обрабатываются все данные, отправленные в службу Site Recovery, чтобы создать точку восстановления для каждой виртуальной машины, прежде чем выполнять в нее отработку отказа. Эта точка восстановления имеет все реплицированные в Site Recovery данные на момент запуска отработки отказа.

3. Выберите виртуальную сеть, в которой виртуальная машина будет находиться после отработки отказа. 

     :::image type="content" source="./media/tutorial-disaster-recovery/test-failover-settings.png" alt-text="Страница для установки параметров тестовой отработки отказа.":::

4. Начнется тестовая отработка отказа. Ход выполнения можно отслеживать в разделе уведомлений.

    :::image type="content" source="./media/tutorial-disaster-recovery/test-failover-notification.png" alt-text="Уведомления о тестировании отработки отказа."::: 
    
   После завершения тестовой отработки отказа виртуальная машина находится в состоянии *Ожидание отработки отказа очистки теста* на странице **Основные компоненты**. 



## <a name="clean-up-resources"></a>Очистка ресурсов

Данные в виртуальной машине автоматически очищаются с помощью Site Recovery после тестирования.

1. Чтобы начать автоматическую очистку, выберите **Очистить тестовую отработку отказа**.

    :::image type="content" source="./media/tutorial-disaster-recovery/start-cleanup.png" alt-text="Запуск очистки на странице основных компонентов."::: 

2. В разделе **Очистка тестовой отработки отказа** введите любые заметки, которые необходимо записать для отработки отказа, а затем установите флажок **Тестирование завершено. Удалите виртуальную машину для тестовой отработки отказа**. Нажмите кнопку **ОК**.

    :::image type="content" source="./media/tutorial-disaster-recovery/delete-test.png" alt-text="Страница для записи заметок и удаления тестовой виртуальной машины."::: 

7. Начнется удаление. Ход выполнения можно отслеживать в разделе уведомлений.

    :::image type="content" source="./media/tutorial-disaster-recovery/delete-test-notification.png" alt-text="Раздел уведомлений для отслеживания удаления тестовой виртуальной машины."::: 

### <a name="stop-replicating-the-vm"></a>Остановка репликации виртуальной машины

После завершения тестирования аварийного восстановления рекомендуем выполнить полную отработку отказа. Если вы не хотите выполнять полную отработку отказа, можно отключить репликацию. Таким образом вы сделаете следующее:

- Удалите виртуальную машину из списка Site Recovery реплицированных компьютеров.
- Остановите выставление счетов Site Recovery за виртуальную машину.
- Автоматически очистите параметры репликации в источнике.

Остановите репликацию следующим образом.

1. На странице аварийного восстановления виртуальной машины выберите **Отключить репликацию**.
2. В разделе **Отключить репликацию** укажите причины, по которым необходимо отключить репликацию. Нажмите кнопку **ОК**.

    :::image type="content" source="./media/tutorial-disaster-recovery/disable-replication.png" alt-text="Страница отключения репликации с указанием причины."::: 


Расширение Site Recovery, установленное на виртуальной машине во время репликации, автоматически не удаляется. Если вы отключаете репликацию виртуальной машины и не хотите реплицировать ее позже, можете вручную удалить расширение Site Recovery следующим образом: 

1. Выберите "Виртуальная машина" > **Параметры** > **Расширения**.
2. На странице **Расширения** выберите каждую запись *Microsoft.Azure.RecoveryServices* для Linux.
3. На странице свойств расширения выберите **Удалить**.

   :::image type="content" source="./media/tutorial-disaster-recovery/uninstall-extension.png" alt-text="Страница удаления расширения виртуальной машины Site Recovery.":::



## <a name="next-steps"></a>Дальнейшие действия

В рамках работы с этим учебником вы настроили аварийное восстановление для виртуальной машины Azure и выполнили тестирование аварийного восстановления. Теперь можно выполнить полную отработку отказа для виртуальной машины.

> [!div class="nextstepaction"]
> [Отработка отказа виртуальной машины в другой регион](../../site-recovery/azure-to-azure-tutorial-dr-drill.md)
