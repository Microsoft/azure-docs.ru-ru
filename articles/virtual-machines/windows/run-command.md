---
title: Выполнение сценариев PowerShell в виртуальной машине Windows Azure
description: В этом разделе описывается выполнение сценариев PowerShell в виртуальной машине Windows Azure с помощью функции выполнения команд
services: automation
ms.service: virtual-machines
author: bobbytreed
ms.author: robreed
ms.date: 04/26/2019
ms.topic: how-to
ms.custom: devx-track-azurecli
manager: carmonm
ms.openlocfilehash: eac6201f45b11cae223e2293644bd9d0144e6e31
ms.sourcegitcommit: 2bd0a039be8126c969a795cea3b60ce8e4ce64fc
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/14/2021
ms.locfileid: "98203360"
---
# <a name="run-powershell-scripts-in-your-windows-vm-by-using-run-command"></a>Выполнение сценариев PowerShell в виртуальной машине Windows с помощью функции выполнения команд

Функция выполнения команд использует агент виртуальной машины для выполнения сценариев PowerShell в виртуальной машине Windows Azure. Эти сценарии можно использовать для общего управления компьютерами или приложениями. Они могут помочь вам быстро диагностировать и исправлять проблемы доступа к виртуальной машине и сети, а также восстановить работоспособность виртуальной машины.



## <a name="benefits"></a>Преимущества

Доступ к виртуальным машинам можно получить несколькими способами. Выполнение команд может удаленно реализовывать скрипты на виртуальных машинах с помощью их агента. Выполнение команд используется на портале Microsoft Azure, [REST API](/rest/api/compute/virtual%20machines%20run%20commands/runcommand) или [PowerShell](/powershell/module/az.compute/invoke-azvmruncommand) для виртуальных машин Windows.

Эта возможность полезна во всех сценариях, где требуется выполнить скрипт на виртуальной машине. Это один из способов устранения неполадок и исправления виртуальной машины, на которой не открыт порт RDP или SSH из-за неправильной настройки сети или пользователя с правами администратора.

## <a name="restrictions"></a>Ограничения

При использовании выполнения команд следует принимать во внимание перечисленные ниже ограничения.

* Выводятся только последние 4096 байт.
* Минимальное время выполнения скрипта составляет около 20 секунд.
* Сценарии выполняются как системные в Windows.
* Два сценария не могут выполняться одновременно.
* Скрипты, которые запрашивают сведения (в интерактивном режиме), не поддерживаются.
* Вы не можете отменить выполнение скрипта.
* Максимальное время выполнения скрипта составляет 90 минут. После этого время ожидания истечет.
* Чтобы вернуть результаты скрипта, требуется разрешить исходящие подключения из виртуальной машины.
* Не рекомендуется запускать сценарий, который приведет к сбою или обновлению агента виртуальной машины. Это может позволить расширению перейти в состояние перехода, что приведет к превышению времени ожидания.

> [!NOTE]
> Чтобы выполнение команд работало правильно, требуется подключение (через порт 443) к общедоступным IP-адресам Azure. Если расширение не имеет доступа к этим конечным точкам, скрипты могут успешно выполняться, но результаты не будут возвращаться. Если вы блокируете трафик на виртуальной машине, вы можете использовать [теги служб](../../virtual-network/network-security-groups-overview.md#service-tags), чтобы разрешить трафик к общедоступным IP-адресам Azure с помощью тега `AzureCloud`.

## <a name="available-commands"></a>Доступные команды

В таблице ниже представлен список команд, доступных для виртуальных машин Windows. Команду **RunPowerShellScript** можно использоваться для выполнения любых пользовательских сценариев. При использовании Azure CLI или PowerShell для выполнения команды, значение, указанное для параметра `--command-id` или `-CommandId`, должно быть одним из приведенных ниже значений. При указании значения, которое не является доступной командой, появится следующее сообщение об ошибке.

```error
The entity was not found in this Azure location
```

|**имя**;|**Описание**|
|---|---|
|**RunPowerShellScript**|Выполняет сценарий PowerShell.|
|**EnableRemotePS**|Настраивает компьютер для удаленного подключения к PowerShell.|
|**EnableAdminAccount**|Проверяет, отключена ли учетная запись локального администратора, если да — включает ее.|
|**IPConfig**| Предоставляет подробные сведения об IP-адресе, маске подсети и шлюзе по умолчанию для каждого адаптера, использующего стек TCP/IP.|
|**RDPSettings**|Проверяет параметры реестра и параметры политики домена. Предлагает действия в рамках политики, если компьютер принадлежит домену, или сбрасывает параметры к значениям по умолчанию.|
|**ResetRDPCert**|Удаляет TLS/SSL-сертификат, привязанный к прослушивателю RDP, и восстанавливает по умолчанию его защиту. Используйте этот сценарий при появлении проблем с сертификатом.|
|**SetRDPPort**|Задает номер порта по умолчанию или указанный пользователем для подключений удаленного рабочего стола. Включает правило брандмауэра для входящего подключения к порту.|

## <a name="azure-cli"></a>Azure CLI

Ниже приведен пример с использованием команды [az vm run-command](/cli/azure/vm/run-command#az-vm-run-command-invoke) для запуска сценария оболочки на виртуальной машине Windows Azure.

```azurecli-interactive
# script.ps1
#   param(
#       [string]$arg1,
#       [string]$arg2
#   )
#   Write-Host This is a sample script with parameters $arg1 and $arg2

az vm run-command invoke  --command-id RunPowerShellScript --name win-vm -g my-resource-group \
    --scripts @script.ps1 --parameters "arg1=somefoo" "arg2=somebar"
```

## <a name="azure-portal"></a>Портал Azure

Перейдите к виртуальной машине на [портале Azure](https://portal.azure.com) и выберите **Выполнить команду** под пунктом **ОПЕРАЦИИ**. Появится список доступных команд, выполняемых на виртуальной машине.

![Список команд](./media/run-command/run-command-list.png)

Выберите команду для запуска. Некоторые команды могут иметь необязательные или обязательные входные параметры. Параметры для этих команд представлены в виде текстовых полей для ввода входных значений. В каждой команде можно развернуть **Просмотреть сценарий**, чтобы просмотреть выполняемый сценарий. Команда **RunPowerShellScript** отличается от других команд тем, что она позволяет использовать пользовательские сценарии.

> [!NOTE]
> Встроенные команды не редактируются.

Выбрав команду, выберите **Выполнить**, чтобы запустить скрипт. Сценарий выполняется и по завершении выдает результаты и возможные ошибки в окне вывода. На следующем рисунке показан пример сообщения после запуска команды **RDPSettings**.

![Вывод сценария команды запуска](./media/run-command/run-command-script-output.png)

## <a name="powershell"></a>PowerShell

Ниже приведен пример с использованием командлета [Invoke-AzVMRunCommand](/powershell/module/az.compute/invoke-azvmruncommand) для выполнения скрипта PowerShell на виртуальной машине Azure. Этот командлет ожидает, что скрипт, указанный в параметре `-ScriptPath`, расположен в локальной среде, в которой выполняется командлет.

```azurepowershell-interactive
Invoke-AzVMRunCommand -ResourceGroupName '<myResourceGroup>' -Name '<myVMName>' -CommandId 'RunPowerShellScript' -ScriptPath '<pathToScript>' -Parameter @{"arg1" = "var1";"arg2" = "var2"}
```

## <a name="limiting-access-to-run-command"></a>Ограничение доступа к команде запуска

Для получения списка команд выполнения или отображения сведений о команде требуется `Microsoft.Compute/locations/runCommands/read` разрешение на уровне подписки. Это разрешение имеется у встроенной роли [Читатель](../../role-based-access-control/built-in-roles.md#reader) и более высоких уровней.

Для выполнения команды требуется разрешение `Microsoft.Compute/virtualMachines/runCommand/action`. Это разрешение имеется у роли [Участник виртуальной машины](../../role-based-access-control/built-in-roles.md#virtual-machine-contributor) и более высоких уровней.

Можно использовать одну из [встроенных ролей](../../role-based-access-control/built-in-roles.md) или создать [пользовательскую роль](../../role-based-access-control/custom-roles.md) для использования функции выполнения команд.

## <a name="next-steps"></a>Дальнейшие действия

Сведения о других способах удаленного выполнения сценариев и команд на виртуальной машине см. в разделе [Выполнение сценариев в виртуальных машинах Windows](run-scripts-in-vm.md).
