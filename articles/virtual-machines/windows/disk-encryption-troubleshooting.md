---
title: Руководство по устранению неполадок шифрования дисков Azure
description: В этой статье приведены советы по устранению неполадок в шифровании дисков Microsoft Azure для виртуальных машин Windows.
author: msmbaldwin
ms.service: virtual-machines
ms.subservice: disks
ms.collection: windows
ms.topic: troubleshooting
ms.author: mbaldwin
ms.date: 08/06/2019
ms.custom: seodec18
ms.openlocfilehash: 057aba3e49d32694563f412101be499342f2aad0
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "102550609"
---
# <a name="azure-disk-encryption-troubleshooting-guide"></a>Руководство по устранению неполадок шифрования дисков Azure

Это руководство предназначено для ИТ-специалистов, аналитиков в сфере информационной безопасности и администраторов облака, организации которых используют шифрование дисков Azure. Здесь также содержатся рекомендации по устранению неполадок, связанных с шифрованием дисков.

Перед выполнением описанных ниже действий убедитесь, что виртуальные машины, которые вы пытаетесь зашифровать, имеют [поддерживаемые размеры и операционные системы](disk-encryption-overview.md#supported-vms-and-operating-systems) и что выполнены все предварительные требования:

- [Требования к сети](disk-encryption-overview.md#networking-requirements)
- [Требования групповой политики](disk-encryption-overview.md#group-policy-requirements)
- [Требования к хранилищу ключей шифрования](disk-encryption-overview.md#encryption-key-storage-requirements)

## <a name="troubleshooting-azure-disk-encryption-behind-a-firewall"></a>Устранение неполадок шифрования диска Azure в связи с брандмауэром

Если подключение ограничивается брандмауэром, требованиями прокси-сервера или параметрами группы безопасности сети (NGS), способности расширения выполнять необходимые задачи могут быть нарушены. В результате может появиться такое сообщение о состоянии: "Сведения о состоянии расширения недоступны на виртуальной машине". В предполагаемых сценариях может произойти сбой шифрования. В следующих разделах можно ознакомиться с некоторыми распространенными проблемами с брандмауэром.

### <a name="network-security-groups"></a>Группы безопасности сети
Любые применяемые параметры группы безопасности сети должны позволять конечной точке соответствовать предусмотренным [предварительным требованиям](disk-encryption-overview.md#networking-requirements) к конфигурации сети для шифрования диска.

### <a name="azure-key-vault-behind-a-firewall"></a>Azure Key Vault за брандмауэром

При включении шифрования [учетных данных Azure AD](disk-encryption-windows-aad.md#) целевая виртуальная машина должна обеспечить подключение к конечным точкам Azure Active Directory и конечным точкам хранилища ключей. Текущие конечные точки проверки подлинности Azure Active Directory поддерживаются в разделах 56 и 59 документации по [URL-адресам Microsoft 365 и диапазонам IP-адресов](/microsoft-365/enterprise/urls-and-ip-address-ranges) . Инструкции Key Vault приведены в статье [Доступ к хранилищу ключей Azure из-за брандмауэра](../../key-vault/general/access-behind-firewall.md).

### <a name="azure-instance-metadata-service"></a>Служба метаданных экземпляров Azure 
Виртуальная машина должна иметь доступ к конечной точке [службы метаданных экземпляров Azure](../windows/instance-metadata-service.md), использующей известный немаршрутизируемый IP-адрес (`169.254.169.254`), доступ к которому можно получить только из виртуальной машины.  Конфигурации прокси-сервера, которые изменяют локальный трафик HTTP к этому адресу (например, добавление заголовка X-Forwarded-For), не поддерживаются.

## <a name="troubleshooting-windows-server-2016-server-core"></a>Устранение неполадок в основных серверных компонентах Windows Server 2016

По умолчанию компонент bdehdcfg недоступен в основных серверных компонентах Windows Server 2016. Этот компонент требуется для шифрования дисков Azure. Он используется для разбиения системного тома и тома операционной системы (выполняется только один раз за все время существования виртуальной машины). Эти двоичные файлы не требуются во время последующих операций шифрования.

Чтобы решить эту проблему, скопируйте указанные ниже четыре файла из виртуальной машины центра обработки данных Windows Server 2016 в то же расположение (основные серверные компоненты):

   ```
   \windows\system32\bdehdcfg.exe
   \windows\system32\bdehdcfglib.dll
   \windows\system32\en-US\bdehdcfglib.dll.mui
   \windows\system32\en-US\bdehdcfg.exe.mui
   ```

1. Введите следующую команду:

   ```
   bdehdcfg.exe -target default
   ```

1. С помощью этой команды создается системный раздел на 550 МБ. Перезагрузите систему.

1. Используйте DiskPart, чтобы проверить тома, а затем продолжайте.  

Пример:

```
DISKPART> list vol

  Volume ###  Ltr  Label        Fs     Type        Size     Status     Info
  ----------  ---  -----------  -----  ----------  -------  ---------  --------
  Volume 0     C                NTFS   Partition    126 GB  Healthy    Boot
  Volume 1                      NTFS   Partition    550 MB  Healthy    System
  Volume 2     D   Temporary S  NTFS   Partition     13 GB  Healthy    Pagefile
```

## <a name="troubleshooting-encryption-status"></a>Устранение неполадок с состоянием шифрования 

Портал может отображать диск как зашифрованный даже после того, как он был расшифрован в виртуальной машине.  Это может произойти, если команды низкого уровня используются для непосредственного дешифрования диска в виртуальной машине вместо использования команд управления шифрованием дисков Azure более высокого уровня.  Команды более высокого уровня не только расшифровывают диск в виртуальной машине, но и за пределами виртуальной машины обновляют важные параметры шифрования уровня платформы и параметры расширения, связанные с виртуальной машиной.  Если не поддерживать их согласованность, платформа не сможет сообщить о состоянии шифрования или правильно подготовить к работе виртуальную машину.

Чтобы отключить шифрование дисков Azure с помощью PowerShell, используйте [Disable-AzVMDiskEncryption](/powershell/module/az.compute/disable-azvmdiskencryption), а затем [Remove-AzVMDiskEncryptionExtension](/powershell/module/az.compute/remove-azvmdiskencryptionextension). Выполнение команды Remove-AzVMDiskEncryptionExtension до отключения шифрования невозможно.

Чтобы отключить шифрование дисков Azure с помощью интерфейса командной строки, используйте [az vm encryption disable](/cli/azure/vm/encryption). 

## 



## <a name="next-steps"></a>Дальнейшие действия

В этом документе вы узнали о некоторых распространенных проблемах в шифровании дисков Azure и их устранении. Дополнительные сведения об этой службе и ее возможностях см. в статьях:

- [Шифрование диска в центре безопасности Azure](../../security-center/asset-inventory.md)
- [Шифрование неактивных данных в Azure](../../security/fundamentals/encryption-atrest.md)