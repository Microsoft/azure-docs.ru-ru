---
title: Временные диски ОС
description: Дополнительные сведения о временных дисках ОС для виртуальных машин Azure.
author: cynthn
ms.service: virtual-machines
ms.workload: infrastructure-services
ms.topic: how-to
ms.date: 07/23/2020
ms.author: cynthn
ms.subservice: disks
ms.openlocfilehash: 62f89106538ab7f57047e211fc8715878f889af1
ms.sourcegitcommit: b39cf769ce8e2eb7ea74cfdac6759a17a048b331
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/22/2021
ms.locfileid: "98684565"
---
# <a name="ephemeral-os-disks-for-azure-vms"></a>Временные диски ОС для виртуальных машин Azure

Временные диски ОС создаются в хранилище локальной виртуальной машины и не сохраняются в удаленном хранилище Azure. Диски с временными ОС хорошо подходят для рабочих нагрузок без отслеживания состояния, где приложения являются устойчивыми к сбоям отдельных виртуальных машин, но больше зависят от времени развертывания виртуальной машины или повторное создание образа отдельные экземпляры виртуальных машин. При использовании временного диска ОС вы получаете меньшую задержку при чтении и записи на диск ОС и ускоряете повторное создание образа виртуальной машины. 
 
Основные возможности временных дисков: 
- Идеально подходит для приложений без отслеживания состояния.
- Их можно использовать как в Marketplace, так и в пользовательских образах.
- Возможность быстрого сброса или повторного создания образов виртуальных машин и экземпляров масштабируемых наборов до исходного состояния загрузки.  
- Низкая задержка, аналогичная временному диску. 
- Временные диски ОС свободны, не взимается плата за диск операционной системы.
- Они доступны во всех регионах Azure. 
- Диск с временными ОС поддерживается [коллекцией общих образов](./shared-image-galleries.md). 
 

 
Основные различия между постоянными и временными дисками ОС:

|                             | Диск постоянного ОС                          | Временный диск ОС                              |
|-----------------------------|---------------------------------------------|------------------------------------------------|
| **Ограничение размера для диска ОС**      | 2 ТиБ                                                                                        | Размер кэша для размера виртуальной машины или 2TiB, в зависимости от того, что меньше. **Размер кэша в гиб** см. в разделе [DS](sizes-general.md), [ES](sizes-memory.md), [M](sizes-memory.md), [FS](sizes-compute.md)и [GS](sizes-previous-gen.md#gs-series) .              |
| **Поддерживаемые размеры виртуальных машин**          | Все                                                                                          | Размеры виртуальных машин, поддерживающие хранилище класса Premium, например DSv1, DSv2, DSv3, Esv3, FS, серия fsv2, GS, M                                               |
| **Поддержка типов дисков**           | Управляемый и неуправляемый диск ОС                                                                | Только управляемый диск ОС                                                               |
| **Поддержка регионов**              | все регионы.                                                                                  | все регионы.                              |
| **Сохраняемость данных**            | Данные диска ОС, записанные на диск ОС, хранятся в службе хранилища Azure.                                  | Данные, записанные на диск ОС, хранятся в локальном хранилище виртуальных машин и не сохраняются в службе хранилища Azure. |
| **Состояние отмены выделения**      | Виртуальные машины и экземпляры масштабируемых наборов могут быть остановлены и перезапущены из состояния "остановлено-освобождено". | Не удается освободить виртуальные машины и экземпляры масштабируемых наборов                                  |
| **Специальная поддержка диска ОС** | Да                                                                                          | Нет                                                                                 |
| **Изменение размера диска ОС**              | Поддерживается во время создания виртуальной машины и после отмены выделения виртуальной машины                                | Поддерживается только при создании виртуальной машины                                                  |
| **Изменение размера до нового размера виртуальной машины**   | Данные диска ОС сохранены                                                                    | Данные на диске ОС удалены, ОС повторно подготовлена       
| **Размещение файла подкачки**   | Для Windows файл подкачки хранится на диске ресурсов.                                              | Для Windows файл подкачки хранится на диске ОС   |

## <a name="size-requirements"></a>Требования к размеру

Образы виртуальных машин и экземпляров можно развернуть вплоть до размера кэша виртуальной машины. Например, к стандартным образам Windows Server из Marketplace соответствует 127 гиб. Это означает, что вам потребуется размер виртуальной машины с кэшем, превышающим 127 гиб. В этом случае [Standard_DS2_v2](dv2-dsv2-series.md) имеет размер кэша 86 гиб, который недостаточно велик. Standard_DS3_v2 имеет размер кэша 172 гиб, который достаточно большой. В этом случае Standard_DS3_v2 является наименьшим размером в серии DSv2, который можно использовать с этим изображением. Основные образы Linux в Marketplace и образах Windows Server, обозначенные с помощью, имеют `[smallsize]` около 30 гиб и могут использовать большинство доступных размеров виртуальных машин.

Для временных дисков также требуется, чтобы размер виртуальной машины поддерживал хранилище класса Premium. Обычно размеры (но не всегда) имеют `s` имя, например DSv2 и EsV3. Дополнительные сведения см. в статье [размеры виртуальных машин Azure](sizes.md) . Дополнительные сведения о том, какие размеры поддерживают хранилище класса Premium.

## <a name="preview---ephemeral-os-disks-can-now-be-stored-on-temp-disks"></a>Предварительная версия. временные диски ОС теперь можно хранить на временных дисках.
Диски с временными ОС теперь могут храниться на диске виртуальной машины или диска ресурсов в дополнение к кэшу виртуальной машины. Итак, теперь вы можете использовать временные диски ОС с виртуальной машиной, у которых нет кэша или не имеющей достаточного кэша, но имеющей диск TEMP или Resource для хранения временного диска ОС, например Dav3, Dav4, Eav4 и Eav3. Если у виртуальной машины достаточно места в кэше и временном пространстве, вы также сможете указать место хранения эфемерного диска ОС с помощью нового свойства с именем [диффдискплацемент](/rest/api/compute/virtualmachines/list#diffdiskplacement). С помощью этой функции при подготовке виртуальной машины Windows мы настроим файл подкачки, который будет находиться на диске операционной системы. Эта функция в настоящее время находится на стадии предварительной версии. Эта предварительная версия предоставляется без соглашения об уровне обслуживания и не рекомендована для использования рабочей среде. Чтобы начать работу, [запросите доступ](https://forms.office.com/Pages/ResponsePage.aspx?id=v4j5cvGGr0GRqy180BHbR6cQw0fZJzdIsnbfbI13601URTBCRUZPMkQwWFlCOTRIMFBSNkM1NVpQQS4u).

## <a name="powershell"></a>PowerShell

Чтобы использовать временный диск для развертывания виртуальной машины PowerShell, используйте [Set-азвмосдиск](/powershell/module/az.compute/set-azvmosdisk) в конфигурации виртуальной машины. Задайте `-DiffDiskSetting` для значение `Local` и `-Caching` равным `ReadOnly` .     

```powershell
Set-AzVMOSDisk -DiffDiskSetting Local -Caching ReadOnly
```

Для развертываний масштабируемых наборов используйте командлет [Set-азвмсссторажепрофиле](/powershell/module/az.compute/set-azvmssstorageprofile) в конфигурации. Задайте `-DiffDiskSetting` для значение `Local` и `-Caching` равным `ReadOnly` .


```powershell
Set-AzVmssStorageProfile -DiffDiskSetting Local -OsDiskCaching ReadOnly
```

## <a name="cli"></a>CLI

Чтобы использовать временный диск для развертывания виртуальной машины CLI, присвойте `--ephemeral-os-disk` параметру команды [AZ VM Create](/cli/azure/vm#az-vm-create) значение, `true` а параметр — значение `--os-disk-caching` `ReadOnly` .

```azurecli-interactive
az vm create \
  --resource-group myResourceGroup \
  --name myVM \
  --image UbuntuLTS \
  --ephemeral-os-disk true \
  --os-disk-caching ReadOnly \
  --admin-username azureuser \
  --generate-ssh-keys
```

Для масштабируемых наборов используйте один и тот же `--ephemeral-os-disk true` параметр для команды [AZ-vmss-Create](/cli/azure/vmss#az-vmss-create) и задайте `--os-disk-caching` для параметра значение `ReadOnly` .

## <a name="portal"></a>Портал

В портал Azure можно выбрать использование временных дисков при развертывании виртуальной машины, открыв раздел **Дополнительно** на вкладке **диски** . Для **использования временного диска ОС** выберите **Да**.

![Снимок экрана, показывающий переключатель для выбора использования временного диска ОС](./media/virtual-machines-common-ephemeral/ephemeral-portal.png)

Если параметр для использования временного диска неактивен, возможно, вы выбрали размер виртуальной машины, размер кэша которого не превышает образ ОС или не поддерживает хранилище класса Premium. Вернитесь на страницу " **основные** " и выберите другой размер виртуальной машины.

Вы также можете создавать масштабируемые наборы с временными дисками ОС с помощью портала. Просто убедитесь, что выбран размер виртуальной машины с достаточным размером кэша, а затем в списке **использовать временный диск ОС** выберите **Да**.

![Снимок экрана, показывающий переключатель для выбора использования временного диска ОС для масштабируемого набора](./media/virtual-machines-common-ephemeral/scale-set.png)

## <a name="scale-set-template-deployment"></a>Развертывание шаблона масштабируемого набора  
Процесс создания масштабируемого набора, использующего временный диск ОС, заключается в добавлении свойства в `diffDiskSettings` `Microsoft.Compute/virtualMachineScaleSets/virtualMachineProfile` тип ресурса в шаблоне. Кроме того, для политики кэширования необходимо задать значение `ReadOnly` для временного диска ОС. 


```json
{ 
  "type": "Microsoft.Compute/virtualMachineScaleSets", 
  "name": "myScaleSet", 
  "location": "East US 2", 
  "apiVersion": "2018-06-01", 
  "sku": { 
    "name": "Standard_DS2_v2", 
    "capacity": "2" 
  }, 
  "properties": { 
    "upgradePolicy": { 
      "mode": "Automatic" 
    }, 
    "virtualMachineProfile": { 
       "storageProfile": { 
        "osDisk": { 
          "diffDiskSettings": { 
            "option": "Local" 
          }, 
          "caching": "ReadOnly", 
          "createOption": "FromImage" 
        }, 
        "imageReference":  { 
          "publisher": "Canonical", 
          "offer": "UbuntuServer", 
          "sku": "16.04-LTS", 
          "version": "latest" 
        } 
      }, 
      "osProfile": { 
        "computerNamePrefix": "myvmss", 
        "adminUsername": "azureuser", 
        "adminPassword": "P@ssw0rd!" 
      } 
    } 
  } 
}  
```

## <a name="vm-template-deployment"></a>Развертывание шаблона виртуальной машины 
Вы можете развернуть виртуальную машину с временным диском ОС, используя шаблон. Процесс создания виртуальной машины, использующей временные диски ОС, заключается в добавлении свойства в `diffDiskSettings` тип ресурса Microsoft. COMPUTE/virtualMachines в шаблоне. Кроме того, для политики кэширования необходимо задать значение `ReadOnly` для временного диска ОС. 

```json
{ 
  "type": "Microsoft.Compute/virtualMachines", 
  "name": "myVirtualMachine", 
  "location": "East US 2", 
  "apiVersion": "2018-06-01", 
  "properties": { 
       "storageProfile": { 
            "osDisk": { 
              "diffDiskSettings": { 
                "option": "Local" 
              }, 
              "caching": "ReadOnly", 
              "createOption": "FromImage" 
            }, 
            "imageReference": { 
                "publisher": "MicrosoftWindowsServer", 
                "offer": "WindowsServer", 
                "sku": "2016-Datacenter-smalldisk", 
                "version": "latest" 
            }, 
            "hardwareProfile": { 
                 "vmSize": "Standard_DS2_v2" 
             } 
      }, 
      "osProfile": { 
        "computerNamePrefix": "myvirtualmachine", 
        "adminUsername": "azureuser", 
        "adminPassword": "P@ssw0rd!" 
      } 
    } 
 } 
```


## <a name="reimage-a-vm-using-rest"></a>Пересоздание образа виртуальной машины с помощью функции "ОСТАВШАЯся"
Вы можете переобразировать экземпляр виртуальной машины с эфемерным диском ОС с помощью REST API, как описано ниже, и через портал Azure, перейдя к панели Обзор виртуальной машины. Для масштабируемых наборов повторное создание образа уже доступно через PowerShell, CLI и портал.

```
POST https://management.azure.com/subscriptions/{sub-
id}/resourceGroups/{rgName}/providers/Microsoft.Compute/VirtualMachines/{vmName}/reimage?a pi-version=2018-06-01" 
```
 
## <a name="frequently-asked-questions"></a>Вопросы и ответы

**Вопрос. Каков размер локальных дисков ОС?**

Ответ. Мы поддерживаем платформу и пользовательские образы, вплоть до размера кэша виртуальной машины, где все операции чтения и записи на диск ОС будут локальными на том же узле, что и виртуальная машина. 

**Вопрос. можно ли изменить размер временного диска ОС?**

Ответ. нет, после подготовки диска с эфемерной ОС размер диска ОС изменить нельзя. 

**Вопрос. можно ли подключить управляемые диски к эфемерной виртуальной машине?**

Ответ. Да, вы можете подключить управляемый диск данных к виртуальной машине, которая использует временный диск ОС. 

**Вопрос. будут ли поддерживаться все размеры виртуальных машин для временных дисков ОС?**

Ответ. нет, поддерживаются большинство размеров виртуальных машин хранилища класса Premium (DS, ES, FS, GS, M и т. д.). Чтобы определить, поддерживает ли конкретный размер виртуальной машины временные диски ОС, можно:

Вызов `Get-AzComputeResourceSku` командлета PowerShell
```azurepowershell-interactive
 
$vmSizes=Get-AzComputeResourceSku | where{$_.ResourceType -eq 'virtualMachines' -and $_.Locations.Contains('CentralUSEUAP')} 

foreach($vmSize in $vmSizes)
{
   foreach($capability in $vmSize.capabilities)
   {
       if($capability.Name -eq 'EphemeralOSDiskSupported' -and $capability.Value -eq 'true')
       {
           $vmSize
       }
   }
}
```
 
**Вопрос. можно ли применять временный диск ОС к существующим виртуальным машинам и масштабируемым наборам?**

Ответ. нет, диск временного ОС можно использовать только во время создания виртуальной машины и масштабируемого набора. 

**Вопрос. можно ли смешивать временные и обычные диски ОС в масштабируемом наборе?**

Ответ. нет, в одном масштабируемом наборе нельзя использовать временные и постоянные экземпляры дисков ОС. 

**Вопрос. можно ли создать временный диск ОС с помощью PowerShell или CLI?**

Ответ. Да, вы можете создавать виртуальные машины с временными дисками ОС, используя функции RESTFUL, шаблоны, PowerShell и CLI.

**Вопрос. какие функции не поддерживаются для временного диска ОС?**

Ответ. временные диски не поддерживают:
- Запись образов виртуальных машин
- моментальными снимками дисков. 
- Шифрование дисков Azure 
- Azure Backup
- Azure Site Recovery  
- Переключение диска ОС 
 
## <a name="next-steps"></a>Следующие шаги
Вы можете создать виртуальную машину с эфемерным диском ОС, используя [Azure CLI](/cli/azure/vm#az-vm-create).