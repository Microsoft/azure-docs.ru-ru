---
title: CLI. Создание образа из моментального снимка или управляемого диска в общей коллекции образов
description: Узнайте, как создать образ из моментального снимка или управляемого диска в общей коллекции образов с помощью Azure CLI.
author: cynthn
ms.service: virtual-machines
ms.subservice: shared-image-gallery
ms.topic: how-to
ms.workload: infrastructure
ms.date: 06/30/2020
ms.author: cynthn
ms.reviewer: akjosh
ms.openlocfilehash: c809edd3699d0b9827fe15da53d5d18b12cbe6e6
ms.sourcegitcommit: e6de1702d3958a3bea275645eb46e4f2e0f011af
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "102556967"
---
# <a name="create-an-image-from-a-managed-disk-or-snapshot-in-a-shared-image-gallery-using-the-azure-cli"></a>Создание образа из управляемого диска или моментального снимка в коллекции общих образов с помощью Azure CLI

Если у вас есть моментальный снимок или управляемый диск, который вы хотите перенести в коллекцию общих образов, можно создать образ из коллекции общих образов непосредственно с управляемого диска или из моментального снимка. После тестирования нового образа можно удалить исходный управляемый диск или моментальный снимок. Вы также можете создать образ из управляемого диска или моментального снимка в коллекции общих образов с помощью [Azure PowerShell](image-version-snapshot-powershell.md).

Изображения в коллекции образов имеют два компонента, которые будут созданы в этом примере:
- **Определение образа** содержит сведения о образе и требования для его использования. Сюда входит, является ли образ Windows или Linux, специализированным или обобщенным, заметками о выпуске, а также минимальным и максимальным требованиями к памяти. Это определение типа образа. 
- **Версия образа** — это то, что используется для создания виртуальной машины при использовании общей коллекции образов. В зависимости от требований для вашей среды, у вас может быть несколько версий образа. При создании виртуальной машины используется версия образа для создания новых дисков для виртуальной машины. Версии образов можно использовать несколько раз.


## <a name="before-you-begin"></a>Перед началом

Для работы с этой статьей необходим моментальный снимок или управляемый диск. 

Если вы хотите включить диск данных, размер диска данных не может превышать 1 ТБ.

При работе с этой статьей при необходимости замените имена ресурсов.

## <a name="find-the-snapshot-or-managed-disk"></a>Поиск моментального снимка или управляемого диска 

Список моментальных снимков, доступных в группе ресурсов, можно просмотреть с помощью команды [AZ snapshot List](/cli/azure/snapshot#az-snapshot-list). 

```azurecli-interactive
az snapshot list --query "[].[name, id]" -o tsv
```

Вместо моментального снимка можно также использовать управляемый диск. Чтобы получить управляемый диск, используйте команду [AZ Disk List](/cli/azure/disk#az-disk-list). 

```azurecli-interactive
az disk list --query "[].[name, id]" -o tsv
```

Получив идентификатор моментального снимка или управляемого диска и присвойте его переменной, `$source` которая будет использоваться позднее.

Один и тот же процесс можно использовать для получения любых дисков данных, которые необходимо включить в образ. Назначьте их переменным, а затем используйте эти переменные позже при создании версии образа.


## <a name="find-the-gallery"></a>Поиск коллекции

Для создания определения образа потребуются сведения о коллекции образов.

Выведите список сведений о доступных галереях изображений с помощью команды [AZ SIG List](/cli/azure/sig#az-sig-list). Обратите внимание на имя коллекции, в которой находится коллекция ресурсов для дальнейшего использования.

```azurecli-interactive 
az sig list -o table
```


## <a name="create-an-image-definition"></a>Создание определения образа

Образы можно объединять в логические группы с помощью определений образов. Они используются для управления сведениями об образе. В имени определения образа можно использовать прописные и строчные буквы, цифры, точки и дефисы. 

При создании определения образа убедитесь, что содержит все правильные сведения. В этом примере предполагается, что моментальный снимок или управляемый диск относятся к используемой виртуальной машине и не были обобщены. Если управляемый диск или моментальный снимок был создан в обобщенной ОС (после запуска Sysprep для Windows или [waagent](https://github.com/Azure/WALinuxAgent) `-deprovision` или `-deprovision+user` для Linux), измените `-OsState` на `generalized` . 

Дополнительные сведения о значениях, которые можно указать для определения образа, см. в разделе [Определения образов](./shared-image-galleries.md#image-definitions).

Создайте в коллекции определение образа, используя команду [az sig image-definition create](/cli/azure/sig/image-definition#az-sig-image-definition-create).

В этом примере определение образа имеет имя *myImageDefinition* и предназначено для [специализированного](./shared-image-galleries.md#generalized-and-specialized-images) образа ОС Linux. Чтобы создать определение для образов с помощью ОС Windows, используйте `--os-type Windows`. 

В этом примере коллекция называется *мигаллери*, она находится в группе ресурсов *мигаллерирг* и имя определения образа будет *мимажедефинитион*.

```azurecli-interactive 
resourceGroup=myGalleryRG
gallery=myGallery
imageDef=myImageDefinition
az sig image-definition create \
   --resource-group $resourceGroup \
   --gallery-name $gallery \
   --gallery-image-definition $imageDef \
   --publisher myPublisher \
   --offer myOffer \
   --sku mySKU \
   --os-type Linux \
   --os-state specialized
```


## <a name="create-the-image-version"></a>Создание версии образа

Создайте версию образа с помощью команды [AZ Image Gallery создать-Image-Version](/cli/azure/sig/image-version#az-sig-image-version-create). 

Допустимыми знаками для имени версии образа являются цифры и точки. Числа должны быть в диапазоне 32-битного целого числа. Формат: *основной номер версии*.*дополнительный номер версии*.*исправление*.

В этом примере версия нашего образа — *1.0.0* , и мы создадим 1 реплику в *юго-центральном регионе США* и 1 реплику в регионе " *Восточная часть США 2* " с помощью хранилища, избыточного в пределах зоны. При выборе целевых регионов для репликации Помните, что также необходимо включить *Исходный* регион управляемого диска или моментальный снимок в качестве целевого объекта для репликации.

Передайте идентификатор моментального снимка или управляемого диска в `--os-snapshot` параметре.


```azurecli-interactive 
az sig image-version create \
   --resource-group $resourceGroup \
   --gallery-name $gallery \
   --gallery-image-definition $imageDef \
   --gallery-image-version 1.0.0 \
   --target-regions "southcentralus=1" "eastus2=1=standard_zrs" \
   --replica-count 2 \
   --os-snapshot $source
```

Если вы хотите включить диски данных в образ, необходимо включить оба `--data-snapshot-luns` параметра в номер LUN и `--data-snapshots` задать идентификатор диска данных или моментального снимка.

> [!NOTE]
> Прежде чем использовать тот же управляемый образ для создания другой версии образа, необходимо дождаться завершения сборки и репликации версии образа.
>
> Вы также можете хранить все реплики версии образа в хранилище, [избыточном](../storage/common/storage-redundancy.md) в виде зоны, путем добавления `--storage-account-type standard_zrs` при создании версии образа.
>

## <a name="next-steps"></a>Дальнейшие действия

Создайте виртуальную машину из [специализированной версии образа](vm-specialized-image-version-cli.md).

Сведения о том, как предоставить сведения о плане покупки, см. в разделе [предоставление сведений о плане покупки Azure Marketplace при создании образов](marketplace-images.md).