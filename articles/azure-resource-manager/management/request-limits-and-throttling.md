---
title: Ограничения запросов и регулирование
description: В данной статье описывается использование регулирования запросов Azure Resource Manager при достижении ограничений подписки.
ms.topic: conceptual
ms.date: 12/15/2020
ms.custom: seodec18
ms.openlocfilehash: 181ed1a3059d86f78e40a9949448af77a551efbc
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "97563132"
---
# <a name="throttling-resource-manager-requests"></a>Регулирование запросов Resource Manager

В этой статье описывается, как Azure Resource Manager регулирует запросы. Здесь показано, как отреагировать на количество запросов, оставшихся до достижения предела, и как ответить, если достигнут предел.

Регулирование происходит на двух уровнях. Azure Resource Manager регулирует запросы для подписки и клиента. Если запрос находится под пределами регулирования для подписки и клиента, диспетчер ресурсов направляет запрос поставщику ресурсов. Поставщик ресурсов применяет ограничения регулирования, адаптированные к его операциям. На следующем рисунке показано применение регулирования в качестве запроса от пользователя к Azure Resource Managerу и поставщику ресурсов.

![Регулирование запросов](./media/request-limits-and-throttling/request-throttling.svg)

## <a name="subscription-and-tenant-limits"></a>Ограничения подписки и клиента

Каждая операция на уровне подписки и уровня клиента регулируется ограничениями регулирования. К запросам подписки относятся передача идентификатора подписки, например получение групп ресурсов в подписке. Запросы клиента не включают идентификатор подписки (например, извлечение допустимых расположений Azure).

Ограничения по умолчанию для регулирования в час показаны в следующей таблице.

| Область | Операции | Ограничение |
| ----- | ---------- | ------- |
| Подписка | reads | 12000 |
| Подписка | deletes | 15 000 |
| Подписка | writes | 1200 |
| Клиент | reads | 12000 |
| Клиент | writes | 1200 |

Эти ограничения касаются субъекта безопасности (пользователь или приложение), выполняющего запросы, а также идентификатора подписки или идентификатора клиента. Если запросы поступают от нескольких субъектов безопасности, ваше ограничение для подписки или клиента превышает 12 000 и 1200 в час.

Эти ограничения применяются к каждому экземпляру Azure Resource Manager. В каждом регионе Azure существует несколько экземпляров, а Azure Resource Manager развертывается во всех регионах Azure.  Таким образом, на практике ограничения выше, чем эти ограничения. Запросы от пользователя обычно обрабатываются разными экземплярами Azure Resource Manager.

## <a name="resource-provider-limits"></a>Ограничения поставщика ресурсов

Поставщики ресурсов применяют собственные ограничения регулирования. Поскольку диспетчер ресурсов регулирования по ИДЕНТИФИКАТОРу субъекта и экземпляру диспетчер ресурсов, поставщик ресурсов может получить больше запросов, чем ограничения по умолчанию в предыдущем разделе.

В этом разделе обсуждаются ограничения по регулированию для некоторых широко используемых поставщиков ресурсов.

### <a name="storage-throttling"></a>Регулирование хранилища

[!INCLUDE [azure-storage-limits-azure-resource-manager](../../../includes/azure-storage-limits-azure-resource-manager.md)]

### <a name="network-throttling"></a>Регулирование сети

Поставщик ресурсов Microsoft. Network применяет следующие ограничения регулирования:

| Операция | Ограничение |
| --------- | ----- |
| запись и удаление (размещение) | 1000 за 5 минут |
| чтение (GET) | 10000 за 5 минут |

### <a name="compute-throttling"></a>Регулирование вычислений

Сведения об ограничениях регулирования для операций вычислений см. в разделе [Устранение ошибок регулирования API — вычисление](../../virtual-machines/troubleshooting/troubleshooting-throttling-errors.md).

Для проверки экземпляров виртуальных машин в масштабируемом наборе виртуальных машин используйте [операции масштабируемых наборов виртуальных машин](/rest/api/compute/virtualmachinescalesetvms). Например, используйте параметр виртуальные [машины масштабируемого набора виртуальных машин](/rest/api/compute/virtualmachinescalesetvms/list) с параметрами для проверки состояния электропитания экземпляров виртуальных машин. Этот API сокращает количество запросов.

### <a name="azure-resource-graph-throttling"></a>Регулирование графа ресурсов Azure

[Граф ресурсов Azure](../../governance/resource-graph/overview.md) ограничивает количество запросов к его операциям. Действия, описанные в этой статье, позволяют определить оставшиеся запросы и ответы на них, если достигнуто предельное значение, которое также применяется к графу ресурсов. Тем не менее, граф ресурсов устанавливает собственные ограничения и скорость сброса. Дополнительные сведения см. в разделе [заголовков регулирования для графика ресурсов](../../governance/resource-graph/concepts/guidance-for-throttled-requests.md#understand-throttling-headers).

### <a name="other-resource-providers"></a>Другие поставщики ресурсов

Сведения о регулировании в других поставщиках ресурсов см. в следующих статьях:

* [Руководство по регулированию хранилища ключей Azure](../../key-vault/general/overview-throttling.md)
* [Устранение неполадок с AKS](../../aks/troubleshooting.md#im-receiving-429---too-many-requests-errors)

## <a name="error-code"></a>Код ошибки

По достижении ограничения отображается код состояния HTTP **429 — слишком много запросов**. Ответ включает значение **Retry-After** , которое указывает количество секунд ожидания (или спящего режима) приложения перед отправкой следующего запроса. Если отправить запрос до истечения значения Retry-After, этот запрос не будет обработан, и будет возвращено новое значение Retry-After.

По истечении указанного времени можно также закрыть и снова открыть подключение к Azure. Сброс соединения позволяет подключиться к другому экземпляру Azure Resource Manager.

Если вы используете пакет SDK для Azure, пакет SDK может иметь конфигурацию автоматической повторной попытки. Дополнительные сведения см. в [статье Руководство по повторным попыткам для служб Azure](/azure/architecture/best-practices/retry-service-specific).

Некоторые поставщики ресурсов возвращают 429, чтобы сообщить о временной проблеме. Проблема может быть условием перегрузки, которое не вызывается напрямую вашим запросом. Или может представлять временную ошибку о состоянии целевого ресурса или зависимого ресурса. Например, поставщик сетевых ресурсов возвращает 429 с кодом ошибки **ретряблиррордуетоаносероператион** , если целевой ресурс заблокирован другой операцией. Чтобы определить, приходится ли эта ошибка от регулирования или временного состояния, просмотрите сведения об ошибке в ответе.

## <a name="remaining-requests"></a>Количество оставшихся запросов

Количество оставшихся запросов можно определить, проверяя заголовки ответов. Запросы на чтение возвращают значение в заголовке для количества оставшихся запросов на чтение. Запросы на запись включают значение числа оставшихся запросов на запись. В приведенной ниже таблице описаны заголовки ответов, в которых можно проверить эти значения.

| Заголовок ответа | Описание |
| --- | --- |
| x-ms-ratelimit-remaining-subscription-reads |Оставшееся число запросов на чтение для подписки. Это значение возвращается при операциях чтения. |
| x-ms-ratelimit-remaining-subscription-writes |Оставшееся число запросов на запись для подписки. Это значение возвращается при операциях записи. |
| x-ms-ratelimit-remaining-tenant-reads |Оставшееся количество запросов на чтение для клиента. |
| x-ms-ratelimit-remaining-tenant-writes |Оставшееся количество запросов на запись для клиента. |
| x-ms-ratelimit-remaining-subscription-resource-requests |Оставшееся количество запросов для типа ресурса для подписки.<br /><br />Это значение заголовка возвращается только в том случае, если служба переопределила ограничение по умолчанию. Resource Manager добавляет это значение вместо ограничения подписки на запросы на чтение или запись. |
| x-ms-ratelimit-remaining-subscription-resource-entities-read |Оставшееся количество запросов коллекции типов ресурсов для подписки.<br /><br />Это значение заголовка возвращается только в том случае, если служба переопределила ограничение по умолчанию. Это значение содержит число оставшихся запросов коллекции (вывод ресурсов). |
| x-ms-ratelimit-remaining-tenant-resource-requests |Оставшееся количество запросов для типа ресурса для клиента.<br /><br />Этот заголовок добавляется только для запросов уровня клиента и только в том случае, если служба переопределила ограничение по умолчанию. Resource Manager добавляет это значение вместо ограничения клиента на запросы на чтение или запись. |
| x-ms-ratelimit-remaining-tenant-resource-entities-read |Оставшееся количество запросов коллекции типов ресурсов для клиента.<br /><br />Этот заголовок добавляется только для запросов уровня клиента и только в том случае, если служба переопределила ограничение по умолчанию. |

Поставщик ресурсов также может возвращать заголовки ответа со сведениями о оставшихся запросах. Дополнительные сведения о заголовках ответов, возвращаемых поставщиком ресурсов вычислений, см. в разделе " [Частота вызовов](../../virtual-machines/troubleshooting/troubleshooting-throttling-errors.md#call-rate-informational-response-headers)".

## <a name="retrieving-the-header-values"></a>Получение значений заголовков

Получение этих значений заголовков в коде или сценарии ничем не отличается от извлечения любого другого значения заголовка. 

Например, приведенный ниже код **C#** извлекает значение заголовка из объекта **HttpWebResponse** с именем **response**.

```cs
response.Headers.GetValues("x-ms-ratelimit-remaining-subscription-reads").GetValue(0)
```

В **PowerShell** извлечь значение заголовка можно с помощью операции Invoke-WebRequest.

```powershell
$r = Invoke-WebRequest -Uri https://management.azure.com/subscriptions/{guid}/resourcegroups?api-version=2016-09-01 -Method GET -Headers $authHeaders
$r.Headers["x-ms-ratelimit-remaining-subscription-reads"]
```

Полный пример для PowerShell см. в разделе [Проверьте ограничения Resource Manager для подписки](https://github.com/Microsoft/csa-misc-utils/tree/master/psh-GetArmLimitsViaAPI).

Если же требуется узнать количество оставшихся запросов для отладки, можно указать параметр **-Debug** в командлете **PowerShell**.

```powershell
Get-AzResourceGroup -Debug
```

Он возвращает массу значений, включая следующее значение ответа.

```output
DEBUG: ============================ HTTP RESPONSE ============================

Status Code:
OK

Headers:
Pragma                        : no-cache
x-ms-ratelimit-remaining-subscription-reads: 11999
```

Чтобы получить ограничение на запись, используйте операцию записи: 

```powershell
New-AzResourceGroup -Name myresourcegroup -Location westus -Debug
```

Будет возвращено множество значений, включая следующие:

```output
DEBUG: ============================ HTTP RESPONSE ============================

Status Code:
Created

Headers:
Pragma                        : no-cache
x-ms-ratelimit-remaining-subscription-writes: 1199
```

В **интерфейсе командной строки Azure** извлечь значение заголовка можно с помощью параметра подробного вывода.

```azurecli
az group list --verbose --debug
```

Будет возвращено множество значений, включая следующие:

```output
msrest.http_logger : Response status: 200
msrest.http_logger : Response headers:
msrest.http_logger :     'Cache-Control': 'no-cache'
msrest.http_logger :     'Pragma': 'no-cache'
msrest.http_logger :     'Content-Type': 'application/json; charset=utf-8'
msrest.http_logger :     'Content-Encoding': 'gzip'
msrest.http_logger :     'Expires': '-1'
msrest.http_logger :     'Vary': 'Accept-Encoding'
msrest.http_logger :     'x-ms-ratelimit-remaining-subscription-reads': '11998'
```

Чтобы получить ограничение на запись, используйте операцию записи: 

```azurecli
az group create -n myresourcegroup --location westus --verbose --debug
```

Будет возвращено множество значений, включая следующие:

```output
msrest.http_logger : Response status: 201
msrest.http_logger : Response headers:
msrest.http_logger :     'Cache-Control': 'no-cache'
msrest.http_logger :     'Pragma': 'no-cache'
msrest.http_logger :     'Content-Length': '163'
msrest.http_logger :     'Content-Type': 'application/json; charset=utf-8'
msrest.http_logger :     'Expires': '-1'
msrest.http_logger :     'x-ms-ratelimit-remaining-subscription-writes': '1199'
```

## <a name="next-steps"></a>Дальнейшие действия

* Полный пример для PowerShell см. в разделе [Проверьте ограничения Resource Manager для подписки](https://github.com/Microsoft/csa-misc-utils/tree/master/psh-GetArmLimitsViaAPI).
* Дополнительные сведения об ограничениях и квотах см. в статье [Подписка Azure, границы, квоты и ограничения службы](../../azure-resource-manager/management/azure-subscription-service-limits.md).
* Сведения об обработке асинхронных запросов REST см. в статье [Track asynchronous Azure operations](async-operations.md) (Отслеживание асинхронных операций Azure).
