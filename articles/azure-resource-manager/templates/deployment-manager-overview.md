---
title: Надежное развертывание в разных регионах — Azure диспетчер развертывания
description: Узнайте, как развернуть службу в нескольких регионах с помощью диспетчер развертывания Azure и рекомендаций по обеспечению безопасного развертывания.
ms.topic: conceptual
ms.date: 11/21/2019
ms.custom: seodec18
ms.openlocfilehash: baed44e04a0beca02cc959d302a4a29906b4a78e
ms.sourcegitcommit: 44188608edfdff861cc7e8f611694dec79b9ac7d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/04/2021
ms.locfileid: "99539524"
---
# <a name="enable-safe-deployment-practices-with-azure-deployment-manager-public-preview"></a>Использование рекомендаций по обеспечению безопасного развертывания с помощью Azure диспетчер развертывания (общедоступная Предварительная версия)

Чтобы развернуть службу в нескольких регионах и обеспечить ее правильную работу в них, можно использовать диспетчер развертывания Azure, чтобы координировать поэтапное развертывание службы. Как и для любого развертывания Azure, ресурсы для службы определяются в [шаблонах Resource Manager](template-syntax.md). После создания шаблонов используйте диспетчер развертывания, чтобы описать топологию службы и ее развертывание.

Диспетчер развертывания — это компонент Resource Manager. Он расширяет возможности во время развертывания. Используйте диспетчер развертывания, если вам нужно развернуть сложную службу в нескольких регионах. Помещая выпуск службы на промежуточное хранение и обработку, можно обнаружить потенциальные проблемы, прежде чем он будет развернут во всех регионах. Если вам не нужны дополнительные меры предосторожности поэтапного развертывания, используйте стандартные [варианты развертывания](deploy-portal.md) с помощью Resource Manager. Диспетчер развертывания легко интегрируется со всеми имеющимися сторонними инструментами, которые поддерживают развертывания Resource Manager, такими как предложения для непрерывной интеграции и непрерывной доставки (CI/CD).

Azure диспетчер развертывания доступна в предварительной версии. Помогите нам улучшить эту функцию, предоставив [отзыв](https://aka.ms/admfeedback).

Чтобы использовать диспетчер развертывания, необходимо создать четыре файла:

* Шаблон топологии
* Шаблон развертывания
* файл параметров для топологии;
* файл параметров для развертывания.

Сначала развертывается шаблон топологии, а затем — шаблон развертывания.

Дополнительные ресурсы:

* [Справочник по REST API Azure диспетчер развертывания](/rest/api/deploymentmanager/).
* [Учебник. Использование Azure диспетчер развертывания с шаблонами диспетчер ресурсов](./deployment-manager-tutorial.md).
* [Руководство. Use health check in Azure Deployment Manager](./deployment-manager-tutorial-health-check.md) (Учебник по использованию проверки работоспособности в диспетчере развертывания Azure).
* [Пример диспетчер развертывания Azure](https://github.com/Azure-Samples/adm-quickstart).

## <a name="identity-and-access"></a>Удостоверение и доступ

Диспетчер развертывания использует [управляемое удостоверение, назначаемое пользователем](../../active-directory/managed-identities-azure-resources/overview.md), для выполнения операций развертывания. Это удостоверение создается перед началом развертывания. Ему должен быть предоставлен доступ к подписке, в которую развертывается служба, а также достаточные разрешения для выполнения развертывания. Сведения о действиях, предоставляемых через роли, см. [в статье встроенные роли Azure](../../role-based-access-control/built-in-roles.md).

Удостоверение должно находиться в том же расположении, что и развертывание.

## <a name="topology-template"></a>Шаблон топологии

Шаблон топологии описывает ресурсы Azure для создания службы и расположение их развертывания. На следующем рисунке показана топология для примера службы.

![Иерархия: от топологии службы к службам и модулям службы](./media/deployment-manager-overview/service-topology.png)

В шаблоне топологии указаны следующие ресурсы.

* Источник артефакта — там, где хранятся шаблоны и параметры диспетчер ресурсов.
* Топология службы — указывает на источник артефакта.
  * Службы — указывает расположение и идентификатор подписки Azure.
    * Единицы службы — определяет группу ресурсов, режим развертывания и путь к файлам шаблонов и параметров.

Чтобы понять, что происходит на каждом уровне, поможет выяснить, какие значения вы указываете.

![Значения для каждого уровня](./media/deployment-manager-overview/topology-values.png)

### <a name="artifact-source-for-templates"></a>Источник артефактов для шаблонов

В шаблоне топологии вы создаете источник артефактов, в котором расположены файлы шаблонов и параметров. Источник артефактов позволяет извлечь эти файлы для развертывания. Вы увидите другой источник артефактов для двоичных файлов далее в этой статье.

В следующем примере показан общий формат источника артефактов.

```json
{
  "type": "Microsoft.DeploymentManager/artifactSources",
  "apiVersion": "2018-09-01-preview",
  "name": "<artifact-source-name>",
  "location": "<artifact-source-location>",
  "properties": {
    "sourceType": "AzureStorage",
    "artifactRoot": "<root-folder-for-templates>",
    "authentication": {
      "type": "SAS",
      "properties": {
        "sasUri": "<SAS-URI-for-storage-container>"
      }
    }
  }
}
```

Дополнительные сведения см. в [справочнике по шаблону artifactSources](/azure/templates/Microsoft.DeploymentManager/artifactSources).

### <a name="service-topology"></a>Топология службы:

В следующем примере показан общий формат источника топологии службы. Следует указать идентификатор ресурса источника артефактов, который содержит файлы шаблонов и файл параметров. Топология службы включает в себя все ресурсы службы. Убедитесь, что источник артефакта доступен, так как от него зависит топология службы.

```json
{
  "type": "Microsoft.DeploymentManager/serviceTopologies",
  "apiVersion": "2018-09-01-preview",
  "name": "<topology-name>",
  "location": "<topology-location>",
  "dependsOn": [
    "<artifact-source>"
  ],
  "properties": {
    "artifactSourceId": "<resource-ID-artifact-source>"
  },
  "resources": [
    {
      "type": "services",
        ...
        }
    ]
}
```

Дополнительные сведения см. в [справочнике по шаблону serviceTopologies](/azure/templates/Microsoft.DeploymentManager/serviceTopologies).

### <a name="services"></a>Службы

В следующем примере показан общий формат ресурса служб. В каждой службе следует указать расположение и идентификатор подписки Azure, используемой для развертывания службы. Чтобы выполнить развертывание в нескольких регионах, нужно определить службу для каждого региона. Служба зависит от топологии службы.

```json
{
  "type": "services",
  "apiVersion": "2018-09-01-preview",
  "name": "<service-name>",
  "location": "<service-location>",
  "dependsOn": [
      "<service-topology>"
  ],
  "properties": {
    "targetSubscriptionId": "<subscription-ID>",
    "targetLocation": "<location-of-deployed-service>"
  },
  "resources": [
    {
      "type": "serviceUnits",
            ...
        }
    ]
}
```

Дополнительные сведения см. в [справочнике по шаблону services](/azure/templates/Microsoft.DeploymentManager/serviceTopologies/services).

### <a name="service-units"></a>Единицы измерения службы

В следующем примере показан общий формат ресурса модулей службы. В каждом модуле службы следует указать группу ресурсов, [режим развертывания](deployment-modes.md) и путь к файлу шаблона и файлу параметров. Если указать относительный путь к файлам шаблона и параметров, полный путь составляется на основе корневого каталога в источнике артефактов. Можно указать абсолютный путь к файлам шаблона и параметров, но вы не сможете легко управлять версиями выпусков. Модуль службы зависит от службы.

```json
{
  "type": "serviceUnits",
  "apiVersion": "2018-09-01-preview",
  "name": "<service-unit-name>",
  "location": "<service-unit-location>",
  "dependsOn": [
    "<service>"
  ],
  "tags": {
    "serviceType": "Service West US Web App"
  },
  "properties": {
    "targetResourceGroup": "<resource-group-name>",
    "deploymentMode": "Incremental",
    "artifacts": {
      "templateArtifactSourceRelativePath": "<relative-path-to-template>",
      "parametersArtifactSourceRelativePath": "<relative-path-to-parameter-file>"
    }
  }
}
```

Каждый шаблон должен включать в себя связанные ресурсы, которые вы хотите развернуть за один шаг. Например, модуль службы может определять шаблон, который развертывает все ресурсы для внешнего интерфейса службы.

Дополнительные сведения см. в [справочнике по шаблону serviceUnits](/azure/templates/Microsoft.DeploymentManager/serviceTopologies/services/serviceUnits).

## <a name="rollout-template"></a>Шаблон развертывания

Шаблон развертывания описывает действия, выполняемые при развертывании службы. Следует указать используемую топологию службы и определить порядок развертывания модулей службы. В шаблоне указывается источник артефактов для хранения двоичных файлов, необходимых для развертывания. В шаблоне развертывания следует определить следующую иерархию.

* Источник артефакта.
* Первом.
* Развертывания.
  * Группы шагов.
    * Операции развертывания.

На рисунке ниже показана иерархия шаблона развертывания.

![Иерархия: от развертывания к отдельным шагам](./media/deployment-manager-overview/Rollout.png)

Каждое развертывание может включать в себя несколько групп шагов. Каждая группа шагов содержит одну операцию развертывания, которая указывает на модуль службы в топологии службы.

### <a name="artifact-source-for-binaries"></a>Источник артефактов для двоичных файлов

В шаблоне развертывания следует создать источник артефактов для двоичных файлов, которые необходимо развернуть в службе. Он аналогичен [источнику артефактов для шаблонов](#artifact-source-for-templates), за исключением того, что содержит сценарии, веб-страницы, скомпилированный код или другие файлы, необходимые для вашей службы.

### <a name="steps"></a>Шаги

Вы можете определить шаг, выполняемый до или после операции развертывания. В настоящее время `wait` доступны только шаг и `healthCheck` шаг.

Этот `wait` шаг приостанавливает развертывание перед тем, как продолжить. Это позволяет проверить, что правильно ли работает служба, прежде чем развертывать следующий модуль службы. В следующем примере показан общий формат `wait` шага.

```json
{
    "type": "Microsoft.DeploymentManager/steps",
    "apiVersion": "2018-09-01-preview",
    "name": "waitStep",
    "location": "<step-location>",
    "properties": {
        "stepType": "wait",
        "attributes": {
          "duration": "PT1M"
        }
    }
},
```

Свойство duration использует [стандарт ISO 8601](https://en.wikipedia.org/wiki/ISO_8601#Durations). Предыдущий пример указывает длительность ожидания в 1 минуту.

Дополнительные сведения о проверке работоспособности см. в статье [Введение в интеграцию с работоспособностью в azure диспетчер развертывания](./deployment-manager-health-check.md) и [учебник. Использование проверки работоспособности в Azure диспетчер развертывания](./deployment-manager-tutorial-health-check.md).

Дополнительные сведения см. в [справочнике по шаблону steps](/azure/templates/Microsoft.DeploymentManager/steps).

### <a name="rollouts"></a>Выпуски

Убедитесь, что источник артефакта доступен, так как он зависит от развертывания. Развертывание определяет группы шагов для каждого модуля службы, который развертывается. Можно определить действия, выполняемые до или после развертывания. Например, можно указать, что развертывание будет ожидать после развертывания единицы службы. Можно определить порядок групп шагов.

Объект identity указывает [управляемое удостоверение, назначаемое пользователем](#identity-and-access), которое используется для выполнения действий по развертыванию.

В следующем примере показан общий формат развертывания.

```json
{
  "type": "Microsoft.DeploymentManager/rollouts",
  "apiVersion": "2018-09-01-preview",
  "name": "<rollout-name>",
  "location": "<rollout-location>",
  "Identity": {
    "type": "userAssigned",
    "identityIds": [
      "<managed-identity-ID>"
    ]
  },
  "dependsOn": [
    "<artifact-source>"
  ],
  "properties": {
    "buildVersion": "1.0.0.0",
    "artifactSourceId": "<artifact-source-ID>",
    "targetServiceTopologyId": "<service-topology-ID>",
    "stepGroups": [
      {
        "name": "stepGroup1",
        "dependsOnStepGroups": ["<step-group-name>"],
        "preDeploymentSteps": ["<step-ID>"],
        "deploymentTargetId":
          "<service-unit-ID>",
        "postDeploymentSteps": ["<step-ID>"]
      },
            ...
        ]
    }
}
```

Дополнительные сведения см. в [справочнике по шаблону rollouts](/azure/templates/Microsoft.DeploymentManager/rollouts).

## <a name="parameter-file"></a>Файл параметров

Следует создать два файла параметров. Один файл параметров используется при развертывании топологии службы, а другой — при развертывании ее ресурсов. Некоторые значения в обоих файлах параметров должны быть одинаковыми.

## <a name="containerroot-variable"></a>Переменная containerRoot

При развертывании с управлением версиями путь к артефактам изменяется с выпуском каждой новой версии. Сначала, при развертывании, это может быть путь `https://<base-uri-blob-container>/binaries/1.0.0.0`. Во второй раз это может быть путь `https://<base-uri-blob-container>/binaries/1.0.0.1`. Диспетчер развертывания упрощает получение правильного корневого пути для текущего развертывания с помощью переменной `$containerRoot`. Это значение изменяется для каждой версии, оно неизвестно до выполнения развертывания.

Используйте `$containerRoot` переменную в файле параметров для шаблона, который развертывает ресурсы Azure. Во время развертывания эта переменная заменяется фактическими значениями из развертывания.

Например, во время развертывания создается источник артефактов для двоичных артефактов.

```json
{
  "type": "Microsoft.DeploymentManager/artifactSources",
  "apiVersion": "2018-09-01-preview",
  "name": "[variables('rolloutArtifactSource').name]",
  "location": "[parameters('azureResourceLocation')]",
  "properties": {
    "sourceType": "AzureStorage",
      "artifactRoot": "[parameters('binaryArtifactRoot')]",
      "authentication" :
        {
          "type": "SAS",
          "properties": {
            "sasUri": "[parameters('artifactSourceSASLocation')]"
          }
        }
  }
},
```

Обратите внимание на свойства `artifactRoot` и `sasUri`. Для корня артефактов можно задать значение, например `binaries/1.0.0.0`. Универсальный код ресурса (URI) SAS — это универсальный код ресурса (URI) контейнера хранилища с маркером SAS для доступа. Диспетчер развертывания автоматически составляет значение переменной `$containerRoot`. Он объединяет эти значения в формате `<container>/<artifactRoot>`.

Файл шаблона и файл параметров должны содержать правильный путь для получения двоичных файлов с управлением версиями. Например, чтобы развернуть файлы для веб-приложения, создайте следующий файл параметров с `$containerRoot` переменной. Необходимо использовать две обратные косые черты (`\\`) в пути, так как первым указывается escape-символ.

```json
{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "deployPackageUri": {
      "value": "$containerRoot\\helloWorldWebAppWUS.zip"
    }
  }
}
```

Затем используйте этот параметр в шаблоне.

```json
{
  "name": "MSDeploy",
  "apiVersion": "2015-08-01",
  "type": "extensions",
  "location": "[parameters('location')]",
  "dependsOn": [
    "[concat('Microsoft.Web/sites/', parameters('WebAppName'))]"
  ],
  "tags": {
    "displayName": "WebAppMSDeploy"
  },
  "properties": {
    "packageUri": "[parameters('deployPackageURI')]"
  }
}
```

Управление версиями развертывания осуществляется путем создания новых папок и передачи этого корневого пути во время развертывания. Этот путь передается в шаблон, который развертывает ресурсы.

## <a name="next-steps"></a>Следующие шаги

В этой статье вы узнали о диспетчере развертывания. Перейдите к следующей статье, чтобы узнать, как выполнить развертывание с помощью диспетчера развертывания.

> [!div class="nextstepaction"]
> [Руководство. Использование диспетчера развертывания Azure с шаблонами Resource Manager](./deployment-manager-tutorial.md)
>
> [Краткое руководство. Попробуйте диспетчер развертывания Azure всего за несколько минут](https://github.com/Azure-Samples/adm-quickstart)
