---
title: Рекомендации по работе с шаблонами
description: Описывает Рекомендуемые подходы для создания шаблонов Azure Resource Manager (шаблоны ARM). Содержит рекомендации, как избежать распространенных проблем при использовании шаблонов.
ms.topic: conceptual
ms.date: 12/01/2020
ms.openlocfilehash: 583a113df9cdb1951daf1002dd69531f050cfb54
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "99258003"
---
# <a name="arm-template-best-practices"></a>Рекомендации по использованию шаблона ARM

В этой статье показано, как использовать рекомендуемые методики при создании шаблона Azure Resource Manager (шаблон ARM). Эти рекомендации помогут избежать распространенных проблем при использовании шаблона ARM для развертывания решения.

## <a name="template-limits"></a>Ограничения шаблонов

Ограничьте размер шаблона до 4 МБ, а каждый файл параметров — до 64 КБ. Ограничение 4 МБ применяется к окончательному состоянию шаблона после его расширения с помощью итерационных определений ресурсов, а также значений переменных и параметров.

Кроме того, ограничение распространяется на:

* 256 параметров;
* 256 переменных;
* 800 ресурсов (включая число копий);
* 64 выходных значения;
* 24 576 знаков в выражении шаблона.

Некоторые ограничения можно превысить, используя вложенные шаблоны. Дополнительные сведения см. [в статье Использование связанных и вложенных шаблонов при развертывании ресурсов Azure](linked-templates.md). Чтобы уменьшить число параметров, переменных или выходных данных, можно объединить несколько значений в объект. См. дополнительные сведения об [использовании объектов как параметров](/azure/architecture/guide/azure-resource-manager/advanced-templates/objects-as-parameters).

## <a name="resource-group"></a>Группа ресурсов

При развертывании ресурсов в группе ресурсов Группа ресурсов хранит метаданные о ресурсах. Метаданные хранятся в расположении группы ресурсов.

Если регион группы ресурсов временно недоступен, вы не сможете обновить ресурсы в группе ресурсов, так как недоступны их метаданные. Ресурсы в других регионах будут работать должным образом, но обновить их не получится. Чтобы свести риск к минимуму, размещайте группу ресурсов и ресурсы в одном регионе.

## <a name="parameters"></a>Параметры

[Здесь](template-parameters.md) приведены некоторые рекомендации по работе с параметрами.

### <a name="general-recommendations-for-parameters"></a>Общие рекомендации по работе с параметрами

* Используйте как можно меньше параметров. Вместо этого используйте переменные или литеральные значения для свойств, которые не указываются во время развертывания.

* Имена для параметров необходимо указывать в нижнем регистре.

* Используйте параметры для настроек, которые могут меняться в зависимости от среды, например SKU, размера или емкости.

* Используйте параметры для имен ресурсов, которые вы хотите задать, чтобы упростить идентификацию.

* Введите описание каждого параметра в метаданных.

    ```json
    "parameters": {
      "storageAccountType": {
        "type": "string",
        "metadata": {
          "description": "The type of the new storage account created to store the VM disks."
        }
      }
    }
    ```

* Укажите значения по умолчанию для конфиденциальных параметров. Указав значение по умолчанию, проще развернуть шаблон, и пользователи шаблона будут видеть пример соответствующего значения. Любое значение для параметра по умолчанию должно быть допустимым для всех пользователей в конфигурации развертывания по умолчанию.

    ```json
    "parameters": {
      "storageAccountType": {
        "type": "string",
        "defaultValue": "Standard_GRS",
        "metadata": {
          "description": "The type of the new storage account created to store the VM disks."
        }
      }
    }
    ```

* Чтобы указать дополнительный параметр, не используйте пустую строку в качестве значения по умолчанию. Вместо этого используйте литеральное значение или выражение языка для составления значения.

   ```json
   "storageAccountName": {
     "type": "string",
     "defaultValue": "[concat('storage', uniqueString(resourceGroup().id))]",
     "metadata": {
       "description": "Name of the storage account"
     }
   }
   ```

* Используйте `allowedValues` только в крайнем случае. Используйте ее только в том случае, когда необходимо убедиться в том, что некоторые значения не включены в разрешенные параметры. Если вы используете `allowedValues` слишком широкие возможности, вы можете блокировать допустимые развертывания, не поддерживая список обновлений.

* Если имя параметра в шаблоне совпадает с параметром в команде развертывания PowerShell, Resource Manager разрешает такие конфликты именования, добавляя постфикс **FromTemplate** к параметру шаблона. Предположим, вы добавили в шаблон параметр **ResourceGroupName**, и он конфликтует с параметром **ResourceGroupName** в командлете [New-AzResourceGroupDeployment](/powershell/module/az.resources/new-azresourcegroupdeployment). При развертывании вам будет предложено указать значение для параметра **ResourceGroupNameFromTemplate**.

### <a name="security-recommendations-for-parameters"></a>Рекомендации по безопасности параметров

* Всегда используйте параметры для имен пользователей и паролей (или секретов).

* Используйте `securestring` для всех паролей и секретов. При передаче конфиденциальных данных в объекте JSON используйте тип `secureObject`. Параметры шаблона с типами строки и объекта безопасности невозможно считать после развертывания ресурса.

    ```json
    "parameters": {
      "secretValue": {
        "type": "securestring",
        "metadata": {
          "description": "The value of the secret to store in the vault."
        }
      }
    }
    ```

* Не указывайте значения по умолчанию для имен пользователей, паролей или любое значение, которое требует тип `secureString`.

* Не указывайте значения по умолчанию для свойств, позволяющих увеличить контактную зону для атаки на приложения.

### <a name="location-recommendations-for-parameters"></a>Рекомендации по расположению параметров

* Используйте параметр для указания расположения ресурсов и задайте значения по умолчанию для `resourceGroup().location`. Указание параметра Location позволяет пользователям шаблона указать расположение, в котором у них есть разрешение на развертывание ресурсов.

   ```json
   "parameters": {
     "location": {
       "type": "string",
       "defaultValue": "[resourceGroup().location]",
       "metadata": {
         "description": "The location in which the resources should be deployed."
       }
     }
   }
   ```

* Не указывайте `allowedValues` для параметра расположения. Указываемые расположения могут оказаться недоступными во всех облаках.

* Используйте значение параметра расположения для ресурсов, которые могут находиться в одном расположении. Такой подход позволит реже обращаться к пользователю за информацией о расположении.

* Для ресурсов, которые недоступны во всех расположениях, используйте отдельный параметр или укажите литеральное значение расположения.

## <a name="variables"></a>Переменные

Ниже приведены некоторые рекомендации по работе с [переменными](template-variables.md).

* Имена переменных следует заменять регистром Camel.

* Применяйте переменные для значений, которые необходимо использовать в шаблоне более одного раза. Если значение используется только один раз, жестко задайте его. Это облегчит чтение шаблона.

* Используйте переменные для значений, составленных на основе сложного упорядочения функций шаблонов. Шаблон легче читать, если сложное выражение отображается только в переменных.

* Нельзя использовать функцию [Reference](template-functions-resource.md#reference) в `variables` разделе шаблона. `reference`Функция получает свое значение из состояния среды выполнения ресурса. а переменные разрешаются при начальной обработке шаблона. Создайте значения, для которых требуется `reference` функция непосредственно в `resources` `outputs` разделе или шаблона.

* Добавьте переменные для имен ресурсов, которые должны быть уникальными.

* Используйте [цикл копирования переменных](copy-variables.md), чтобы создать повторяющийся шаблон объектов JSON.

* Удалите неиспользуемые переменные.

## <a name="api-version"></a>Версия API

Задайте `apiVersion` для свойства жестко заданную версию API для типа ресурса. При создании нового шаблона рекомендуется использовать последнюю версию API для типа ресурса. Чтобы определить доступные значения, см. раздел [Справочник по шаблону](/azure/templates/).

Если шаблон работает правильно, рекомендуется продолжать использовать ту же версию API. Используя ту же версию API, вам не нужно беспокоиться о критических изменениях, которые могут быть представлены в более поздних версиях.

Не используйте параметр для версии API. Свойства и значения ресурсов могут различаться в зависимости от версии API. Функции IntelliSense в редакторах кода не могут определить правильную схему, если версия API указана в качестве значения параметра. Если передать версию API, которая не соответствует свойствам в шаблоне, развертывание завершится ошибкой.

Не используйте переменные для версии API. В частности, не используйте [функцию providers](template-functions-resource.md#providers) для динамического получения версий API во время развертывания. Динамически извлекаемая версия API может не соответствовать свойствам в шаблоне.

## <a name="resource-dependencies"></a>Зависимости ресурсов

При принятии решения о том, какие [зависимости](define-resource-dependency.md) следует задать, используйте следующие рекомендации.

* Используйте `reference` функцию и передайте имя ресурса, чтобы установить неявную зависимость между ресурсами, которым необходимо предоставить общий доступ к свойству. Не добавляйте явный элемент `dependsOn`, если неявная зависимость уже определена. Такой подход уменьшает риск появления ненужных зависимостей. Пример настройки неявной зависимости см. в разделе [функции Reference и List](define-resource-dependency.md#reference-and-list-functions).

* Назначайте дочерний ресурс зависимым от его родительского ресурса.

* Ресурсы, в которых установлено значение [элемента условия](conditional-resource-deployment.md) false, автоматически удаляются из порядка зависимостей. Назначайте зависимости так, как и при развернутом ресурсе.

* Позвольте зависимостям задействоваться последовательно, не задавая их явно. Например, виртуальная машина зависит от виртуального сетевого интерфейса, а он зависит от виртуальной сети и общедоступных IP-адресов. Таким образом, виртуальная машина развертывается только после всех трех ресурсов, но эта зависимость виртуальной машины от них не задана явным образом. Такой подход проясняет порядок зависимостей и упрощает последующее изменение шаблона.

* Если значение может быть определено до развертывания, попробуйте развернуть ресурс без зависимостей. Например, если в значении конфигурации требуется указать имя другого ресурса, можно обойтись и без зависимости. Эта рекомендация не всегда уместна, так как некоторые ресурсы проверяют наличие другого ресурса. Если произошла ошибка, добавьте зависимость.

## <a name="resources"></a>Ресурсы

Ниже приведены некоторые рекомендации по работе с [ресурсами](template-syntax.md#resources).

* Чтобы помочь другим участникам понять назначение ресурса, укажите `comments` для каждого ресурса в шаблоне.

    ```json
    "resources": [
      {
        "name": "[variables('storageAccountName')]",
        "type": "Microsoft.Storage/storageAccounts",
        "apiVersion": "2019-06-01",
        "location": "[resourceGroup().location]",
        "comments": "This storage account is used to store the VM disks.",
          ...
      }
    ]
    ```

* Если вы используете в шаблоне *общедоступную конечную точку* (например, общедоступную конечную точку хранилища BLOB-объектов Azure), то *не следует жестко кодировать* пространство имен. Используйте `reference` функцию, чтобы динамически получить пространство имен. Вы можете использовать этот подход, чтобы развернуть шаблон в другом общедоступном пространстве имен, не изменяя конечную точку в шаблоне вручную. Задайте в качестве версии API ту же версию, которую вы используете для учетной записи хранения в шаблоне.

    ```json
    "diagnosticsProfile": {
      "bootDiagnostics": {
        "enabled": "true",
        "storageUri": "[reference(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2019-06-01').primaryEndpoints.blob]"
      }
    }
    ```

   Если учетная запись хранения развернута в том же шаблоне, а имя учетной записи хранения не является общим для другого ресурса в шаблоне, то не нужно указывать пространство имен поставщика или `apiVersion` при ссылке на ресурс. В следующем примере показан упрощенный синтаксис.

    ```json
    "diagnosticsProfile": {
      "bootDiagnostics": {
        "enabled": "true",
        "storageUri": "[reference(variables('storageAccountName')).primaryEndpoints.blob]"
      }
    }
    ```

   Вы также можете ссылаться на существующую учетную запись хранения, которая находится в другой группе ресурсов.

    ```json
    "diagnosticsProfile": {
      "bootDiagnostics": {
        "enabled": "true",
        "storageUri": "[reference(resourceId(parameters('existingResourceGroup'), 'Microsoft.Storage/storageAccounts', parameters('existingStorageAccountName')), '2019-06-01').primaryEndpoints.blob]"
      }
    }
    ```

* Назначайте общедоступные IP-адреса виртуальной машине только в том случае, если это требуется для работы приложения. Чтобы подключиться к виртуальной машине с целью отладки, управления или администрирования, используйте правила преобразования сетевых адресов для входящих подключений, шлюз виртуальной машины или jumpbox.

     Дополнительные сведения о подключении к виртуальным машинам можно получить в приведенных ниже статьях.

   * [Run Windows VMs for an N-tier application](/azure/architecture/reference-architectures/n-tier/n-tier-sql-server) (Запуск виртуальных машин Windows в n-уровневом приложении)
   * [Настройка доступа WinRM для виртуальных машин в Azure Resource Manager](../../virtual-machines/windows/winrm.md)
   * [Открытие портов для виртуальной машины в Azure с помощью портала Azure](../../virtual-machines/windows/nsg-quickstart-portal.md)
   * [Открытие портов и конечных точек для виртуальной машины в Azure с помощью PowerShell](../../virtual-machines/windows/nsg-quickstart-powershell.md)
   * [Открытие портов и конечных точек для виртуальной машины Linux с помощью интерфейса командной строки Azure](../../virtual-machines/linux/nsg-quickstart.md)

* `domainNameLabel`Свойство для общедоступных IP-адресов должно быть уникальным. `domainNameLabel`Значение должно иметь длину от 3 до 63 символов и следовать правилам, заданным в этом регулярном выражении: `^[a-z][a-z0-9-]{1,61}[a-z0-9]$` . Поскольку `uniqueString` функция создает строку длиной 13 символов, длина `dnsPrefixString` параметра ограничена 50 символами.

    ```json
    "parameters": {
      "dnsPrefixString": {
        "type": "string",
        "maxLength": 50,
        "metadata": {
          "description": "The DNS label for the public IP address. It must be lowercase. It should match the following regular expression, or it will raise an error: ^[a-z][a-z0-9-]{1,61}[a-z0-9]$"
        }
      }
    },
    "variables": {
      "dnsPrefix": "[concat(parameters('dnsPrefixString'),uniquestring(resourceGroup().id))]"
    }
    ```

* При добавлении пароля в расширение пользовательского скрипта используйте `commandToExecute` свойство в `protectedSettings` свойстве.

    ```json
    "properties": {
      "publisher": "Microsoft.Azure.Extensions",
      "type": "CustomScript",
      "typeHandlerVersion": "2.0",
      "autoUpgradeMinorVersion": true,
      "settings": {
        "fileUris": [
          "[concat(variables('template').assets, '/lamp-app/install_lamp.sh')]"
        ]
      },
      "protectedSettings": {
        "commandToExecute": "[concat('sh install_lamp.sh ', parameters('mySqlPassword'))]"
      }
    }
    ```

   > [!NOTE]
   > Чтобы обеспечить шифрование секретов, когда они передаются в качестве параметров для виртуальных машин и расширений, используйте `protectedSettings` свойство соответствующих расширений.

* Укажите явные значения свойств, которые имеют значения по умолчанию, которые могут меняться со временем. Например, при развертывании кластера AKS можно либо указать, либо опустить `kubernetesVersion` свойство. Если вы не укажете его, [кластер по умолчанию будет иметь значение N-1 дополнительный номер версии и Последнее исправление](../../aks/supported-kubernetes-versions.md#azure-portal-and-cli-versions). При развертывании кластера с помощью шаблона ARM это поведение по умолчанию может отличаться от ожидаемого. Повторное развертывание шаблона может привести к непредвиденному обновлению кластера до новой версии Kubernetes. Вместо этого рекомендуется указать явный номер версии, а затем вручную изменить его при готовности к обновлению кластера.

## <a name="use-test-toolkit"></a>Использование набора средств тестирования

Набор средств тестирования шаблонов ARM — это сценарий, который проверяет, использует ли шаблон рекомендованные методы. Если шаблон не соответствует рекомендуемым методикам, он возвращает список предупреждений с предлагаемыми изменениями. Набор средств тестирования поможет вам научиться реализовывать рекомендации в шаблоне.

Завершив работу с шаблоном, запустите набор средств тестирования, чтобы узнать, есть ли способы улучшения его реализации. Дополнительные сведения см. в статье [Использование набора средств для тестирования шаблонов ARM](test-toolkit.md).

## <a name="next-steps"></a>Дальнейшие действия

* Сведения о структуре файла шаблона см. [в разделе понимание структуры и синтаксиса шаблонов ARM](template-syntax.md).
* Рекомендации по созданию шаблонов, которые работают во всех облачных средах Azure, см. в статье [Разработка шаблонов ARM для согласованности в облаке](templates-cloud-consistency.md).
