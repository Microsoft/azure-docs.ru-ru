---
title: Запуск фабрики образов из Azure DevOps в Azure DevTest Labs
description: В этой статье рассматриваются все подготовительные действия, необходимые для запуска фабрики образов из Azure DevOps (ранее Visual Studio Team Services).
ms.topic: article
ms.date: 06/26/2020
ms.openlocfilehash: fa7050bae1ff8681e04b6ab38220be9eaf38a64a
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "85476144"
---
# <a name="run-an-image-factory-from-azure-devops"></a>Запуск фабрики образов из Azure DevOps
В этой статье рассматриваются все подготовительные действия, необходимые для запуска фабрики образов из Azure DevOps (ранее Visual Studio Team Services).

> [!NOTE]
> Все подсистемы оркестрации будут работать! DevOps Azure не является обязательным. Фабрика образов запускается с помощью сценариев Azure PowerShell, поэтому ее можно запустить вручную, используя планировщик задач Windows, другие системы CI/CD и т. д.

## <a name="create-a-lab-for-the-image-factory"></a>Создание лаборатории для фабрики образов
Первым шагом в настройке фабрики образов является создание лаборатории в Azure DevTest Labs. Эта лабораторная работа является лабораторией фабрики образов, в которой мы создаем виртуальные машины и сохраняем пользовательские образы. Эта лабораторная работа рассматривается как часть процесса фабрики образов. После создания лаборатории обязательно сохраните имя, так как оно понадобится позже.

## <a name="scripts-and-templates"></a>Скрипты и шаблоны
Следующим шагом в внедрении фабрики образов для вашей команды является понимание доступных возможностей. Сценарии и шаблоны фабрики изображений доступны в [репозитории GitHub DevTest Labs](https://github.com/Azure/azure-devtestlab/tree/master/samples/DevTestLabs/Scripts/ImageFactory). Ниже приведена структура элементов.

- Фабрика изображений. Это корневая папка.
    - Настройка. Входные данные для фабрики образов
        - Голденимажес. Эта папка содержит файлы JSON, которые представляют определения пользовательских образов.
        - Labs.js. Файл, где команды подписываются для получения конкретных пользовательских образов.
- Script. Подсистема для фабрики образов.

В статьях этого раздела приводятся дополнительные сведения об этих скриптах и шаблонах.

## <a name="create-an-azure-devops-team-project"></a>Создание командного проекта Azure DevOps
Azure DevOps позволяет хранить исходный код, запускать Azure PowerShell в одном месте. Вы можете запланировать повторяющиеся запуски для обновления образов. Существуют хорошие средства для записи результатов в журнал для диагностики проблем.  Использовать Azure DevOps не обязательно. Однако вы можете использовать любую программу или механизм, которые могут подключаться к Azure и выполнять Azure PowerShell.

Если у вас уже есть учетная запись DevOps или проект, которые вы хотите использовать, пропустите этот шаг.

Чтобы приступить к работе, создайте бесплатную учетную запись в Azure DevOps. Посетите страницу https://www.visualstudio.com/ и выберите "начало **работы** " справа в разделе **Azure DEVOPS** (ранее — VSTS). Необходимо выбрать уникальное имя учетной записи и выбрать управление кодом с помощью Git. После создания этого файла сохраните URL-адрес в командном проекте. Вот пример URL-адреса: `https://<accountname>.visualstudio.com/MyFirstProject` .

## <a name="check-in-the-image-factory-to-git"></a>Возврат фабрики изображений в Git
Все PowerShell, шаблоны и конфигурация для фабрики изображений находятся в [репозитории GitHub общедоступной DevTest Labs](https://github.com/Azure/azure-devtestlab/tree/master/samples/DevTestLabs/Scripts/ImageFactory). Самый быстрый способ получить код в новом командном проекте — это импортировать репозиторий. Это извлекается во весь репозиторий DevTest Labs (поэтому вы получите дополнительные документы и примеры).

1. Посетите проект Azure DevOps, созданный на предыдущем шаге (URL-адрес выглядит как **https: \/ / \<accountname> . VisualStudio.com/MyFirstProject**).
2. Выберите **Импорт репозитория**.
3. Введите **URL-адрес клона** для репозитория DevTest Labs: `https://github.com/Azure/azure-devtestlab` .
4. Выберите **Импортировать**.

    ![Импорт репозитория Git](./media/set-up-devops-lab/import-git-repo.png)

Если вы решили только то, что нужно (файлы фабрики образов), выполните действия, описанные [здесь](https://www.visualstudio.com/en-us/docs/git/share-your-code-in-git-vs) , чтобы клонировать репозиторий Git и отправить только файлы, расположенные в каталоге **Scripts/имажефактори** .

## <a name="create-a-build-and-connect-to-azure"></a>Создание сборки и подключение к Azure
На этом этапе у вас есть исходные файлы, хранящиеся в репозитории Git в Azure DevOps. Теперь необходимо настроить конвейер для запуска Azure PowerShell. Существует множество вариантов выполнения этих действий. В этой статье определение сборки используется для простоты, но оно работает с DevOps сборкой, DevOps Release (одна или несколько сред), другими механизмами выполнения, такими как Windows планировщик задач или любой другой программой, которая может выполнять Azure PowerShell.

> [!NOTE]
> Важно помнить, что некоторые файлы PowerShell занимают много времени, когда создается большое число (10 +) пользовательских образов. У бесплатных агентов сборки и выпуска DevOps время ожидания составляет 30 минут, поэтому вы не сможете использовать бесплатный размещенный агент после создания большого количества образов. Эта проблема времени ожидания относится к любой используемой программе, поэтому лучше протестировать, что можно продлить типичные времена ожидания для долго выполняющихся Azure PowerShell сценариев. В случае с Azure DevOps можно либо использовать платные размещенные агенты, либо использовать собственный агент сборки.

1. Для начала выберите **Настройка сборки** на домашней странице проекта DevOps:

    ![Кнопка "Настроить сборку"](./media/set-up-devops-lab/setup-build-button.png)
2. Укажите **имя** сборки (например, создайте и доставьте образы в DevTest Labs).
3. Выберите **пустое** определение сборки и нажмите кнопку **Применить** , чтобы создать сборку.
4. На этом этапе можно выбрать **Размещение** для агента сборки.
5. **Сохраните** определение сборки.

    ![Определение сборки](./media/set-up-devops-lab/build-definition.png)

## <a name="configure-the-build-variables"></a>Настройка переменных сборки
Чтобы упростить параметры командной строки, необходимо инкапсулировать значения ключей, которые применяют фабрику образов к набору переменных сборки. Перейдите на вкладку **переменные** и отобразится список нескольких переменных по умолчанию. Ниже приведен список переменных для входа в Azure DevOps.


| Имя переменной | Значение | Примечания |
| ------------- | ----- | ----- |
| конфигуратионлокатион | /скриптс/имажефактори/конфигуратион | Это полный путь в репозитории к папке **конфигурации** . Если вы импортировали весь репозиторий выше, значение слева будет правильным. В противном случае обновите, чтобы указать расположение конфигурации. |
| девтестлабнаме | мимажефактори | Имя лаборатории в Azure DevTest Labs используемой в качестве фабрики для создания образов. Если у вас ее нет, создайте ее. Убедитесь, что лаборатория находится в той же подписке, к которой имеет доступ конечная точка службы. |
| имажеретентион | 1 | Число образов, которые необходимо сохранить для каждого типа. Задайте значение по умолчанию 1. |
| мачинепассворд | ******* | Встроенный пароль учетной записи администратора для виртуальных машин. Это временная учетная запись, поэтому убедитесь, что она безопасна. Щелкните маленький значок замка справа, чтобы убедиться, что это безопасная строка. |
| мачинеусернаме | имажефакторюсер | Имя пользователя встроенной учетной записи администратора для виртуальных машин. Это временная учетная запись. |
| стандардтимеаутминутес | 30 | Время ожидания следует ожидать для обычных операций Azure. |
| SubscriptionId |  0000000000-0000-0000-0000-0000000000000 | Идентификатор подписки, в которой существует Лаборатория, и доступ к которой имеет конечная точка службы. |
| VMSize | Standard_A3 | Размер виртуальной машины, используемой для шага **создания** . Созданные виртуальные машины являются временными. Размер должен быть [включен для лаборатории](devtest-lab-set-lab-policy.md). Убедитесь, что [Квота на количество ядер подписок](../azure-resource-manager/management/azure-subscription-service-limits.md)достаточна.

![Переменные сборки](./media/set-up-devops-lab/configure-build-variables.png)

## <a name="connect-to-azure"></a>Подключение к Azure
Следующим шагом является настройка субъекта-службы. Это удостоверение в Azure Active Directory, которое позволяет агенту сборки DevOps действовать в Azure от имени пользователя. Чтобы настроить его, начните с добавления первого Azure PowerShell этапа сборки.

1. Выберите **Добавить задачу**.
2. Выполните поиск по запросу **Azure PowerShell**.
3. После его нахождения нажмите кнопку **Добавить** , чтобы добавить задачу в сборку. После этого вы увидите, что задача отображается в левой части, как добавлено.

![Настройка шага PowerShell](./media/set-up-devops-lab/set-up-powershell-step.png)

Самый быстрый способ настроить субъект-службу — позволить Azure DevOps сделать это для нас.

1. Выберите только что добавленную **задачу** .
2. В качестве **типа подключения к Azure** выберите **Azure Resource Manager**.
3. Щелкните ссылку **Управление** , чтобы настроить субъект-службу.

Дополнительные сведения см. в этой [записи блога](https://devblogs.microsoft.com/devops/automating-azure-resource-group-deployment-using-a-service-principal-in-visual-studio-online-buildrelease-management/). Выбрав ссылку **Управление** , вы научитесь в нужном месте в DevOps (второй снимок экрана в записи блога), чтобы настроить подключение к Azure. При настройке обязательно выберите **конечную точку службы Azure Resource Manager** .

## <a name="complete-the-build-task"></a>Завершение задачи сборки
Если выбрать задачу сборка, отобразятся все сведения на правой панели, которые должны быть заполнены.

1. Сначала назовите задачу сборки: **Создание виртуальных машин**.
2. Выберите **субъект-службу** , которую вы создали, выбрав **Azure Resource Manager**
3. Выберите **конечную точку службы**.
4. В качестве **пути к сценарию** выберите **... (многоточие)** справа.
5. Перейдите к **MakeGoldenImageVMs.ps1ному** сценарию.
6. Параметры сценария должны выглядеть следующим образом: `-ConfigurationLocation $(System.DefaultWorkingDirectory)$(ConfigurationLocation) -DevTestLabName $(DevTestLabName) -vmSize $(VMSize) -machineUserName $(MachineUserName) -machinePassword (ConvertTo-SecureString -string '$(MachinePassword)' -AsPlainText -Force) -StandardTimeoutMinutes $(StandardTimeoutMinutes)`

    ![Завершение определения сборки](./media/set-up-devops-lab/complete-build-definition.png)


## <a name="queue-the-build"></a>Поставить сборку в очередь
Убедитесь, что все настроено правильно, поочередно создав новую сборку. Пока сборка выполняется, переключитесь на [портал Azure](https://portal.azure.com) и выберите **все виртуальные машины** в лаборатории образов, чтобы убедиться, что все работает правильно. В лаборатории должны быть созданы три виртуальные машины.

![Виртуальные машины в лаборатории](./media/set-up-devops-lab/vms-in-lab.png)

## <a name="next-steps"></a>Дальнейшие действия
Первый шаг в настройке фабрики образов на основе Azure DevTest Labs завершен. В следующей статье серии вы получаете обобщенные и сохраненные в пользовательских образах виртуальные машины. После этого они будут распространяться на все остальные лабораторные занятия. См. следующую статью серии: [Сохранение пользовательских образов и распространение в несколько лабораторий](image-factory-save-distribute-custom-images.md).
