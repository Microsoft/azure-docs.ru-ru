---
title: Расширение Azure DevTest Labs с помощью функций Azure | Документация Майкрософт
description: Узнайте, как расширить Azure DevTest Labs с помощью функций Azure.
ms.topic: article
ms.date: 06/26/2020
ms.openlocfilehash: 620cda83094ee65f421a5529a9d5b51e505ec48e
ms.sourcegitcommit: 15d27661c1c03bf84d3974a675c7bd11a0e086e6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/09/2021
ms.locfileid: "102501164"
---
# <a name="use-azure-functions-to-extend-devtest-labs"></a>Использование Функций Azure для расширения возможностей DevTest Labs
Вы можете использовать функции Azure для поддержки дополнительных сценариев, помимо тех, которые уже поддерживаются DevTest Labs. Функции Azure можно использовать для расширения встроенных функций службы в соответствии с потребностями конкретной организации. В следующем списке приведены некоторые из возможных сценариев. В этой статье показано, как реализовать один из этих примеров сценариев.

- Предоставление сводных данных о виртуальных машинах (ВМ) верхнего уровня в лаборатории
- [Настройка лаборатории для использования шлюза удаленных рабочих столов](configure-lab-remote-desktop-gateway.md)
- Отчеты о соответствии на странице "внутренняя поддержка"
- Разрешить пользователям выполнять операции, требующие повышенных разрешений в подписке
- [Запуск рабочих процессов на основе событий DevTest Labs](https://github.com/RogerBestMsft/DTL-SecureArtifactData)

## <a name="overview"></a>Обзор
[Функции Azure](../azure-functions/functions-overview.md) — это бессерверная вычислительная платформа в Azure. Использование функций Azure в решении с DevTest Labs позволяет нам расширить существующие возможности с помощью нашего собственного кода. Дополнительные сведения о функциях Azure см. в [документации по функциям Azure](../azure-functions/functions-overview.md). Чтобы продемонстрировать, как функции Azure могут помочь в выполнении требований или полных сценариев в DevTest Labs, в этой статье используется пример предоставления сводных данных о виртуальных машинах в лаборатории следующим образом:

**Пример требования или сценария**: пользователи могут просматривать сведения обо всех виртуальных машинах в лаборатории, включая операционную систему, владельца и все примененные артефакты.  Кроме того, если артефакт **Применить обновления Windows** не был недавно применен, существует простой способ его применения.

Для выполнения сценария используются две функции, как описано на следующей схеме.  

![Общий поток](./media/extend-devtest-labs-azure-functions/flow.png)

Исходный код для этих образцов функций находится в [репозитории GitHub DevTest Labs](https://github.com/Azure/azure-devtestlab/tree/master/samples/DevTestLabs/AzureFunctions) (доступны реализации как в C#, так и в PowerShell).

- **Упдатеинтерналсуппортпаже**. Эта функция запрашивает DevTest Labs и обновляет страницу внутренней поддержки непосредственно с подробными сведениями о виртуальных машинах.
- **Аппливиндовсупдатеартифакт**. для виртуальной машины в лаборатории эта функция применяет артефакт **центра обновления Windows** .

## <a name="how-it-works"></a>Принцип работы
Когда пользователи выбирают страницу **внутренней поддержки** в DevTest Labs, у них есть предварительно заполненная страница со сведениями о виртуальных машинах, владельцах лаборатории и контактах службы поддержки.  

При выборе кнопки **выбрать для обновления** страница вызывает первую функцию Azure: **упдатеинтерналсуппортпаже**. Функция запрашивает у DevTest Labs информацию, а затем перезаписывает страницу **внутренней поддержки** новыми сведениями.

Существует дополнительное действие, которое можно выполнить для всех виртуальных машин, на которых не были недавно применены Центр обновления Windows артефакты. на виртуальную машину будет добавлена кнопка для применения обновлений Windows. Если нажать кнопку ***запустить Windows Update** для виртуальной машины, страница вызывает вторую функцию Azure: **аппливиндовсупдатеартифакт**. Эта функция проверяет, запущена ли виртуальная машина, и применяет артефакт [Центр обновления Windows](https://github.com/Azure/azure-devtestlab/tree/master/Artifacts/windows-install-windows-updates) напрямую.

## <a name="step-by-step-walkthrough"></a>Пошаговое руководство
В этом разделе приводятся пошаговые инструкции по настройке ресурсов Azure, необходимых для обновления страницы **внутренней поддержки** . В этом пошаговом руководстве представлен один пример расширения DevTest Labs. Этот шаблон можно использовать для других сценариев.

### <a name="step-1-create-a-service-principal"></a>Шаг 1. Создание субъекта-службы 
Первым шагом является получение субъекта-службы с разрешением на доступ к подписке, содержащей лабораторию. Субъект-служба должен использовать проверку подлинности на основе пароля. Это можно сделать с помощью [Azure CLI](/cli/azure/create-an-azure-service-principal-azure-cli), [Azure PowerShell](/powershell/azure/create-azure-service-principal-azureps)или [портал Azure](../active-directory/develop/howto-create-service-principal-portal.md). Если у вас уже есть субъект-служба для использования, этот шаг можно пропустить.

Запишите **идентификатор приложения**, **ключ** и **идентификатор клиента** для субъекта-службы. Они понадобятся вам позже в этом пошаговом руководстве. 

### <a name="step-2-download-the-sample-and-open-in-visual-studio-2019"></a>Шаг 2. скачивание примера и открытие в Visual Studio 2019
Скачайте копию [примера "функции Azure](https://github.com/Azure/azure-devtestlab/tree/master/samples/DevTestLabs/AzureFunctions/CSharp) " для C# локально (путем клонирования репозитория или скачивания репозитория [отсюда).](https://github.com/Azure/azure-devtestlab/archive/master.zip)  

1. Откройте пример решения с помощью Visual Studio 2019.  
1. Установите рабочую нагрузку **разработки Azure** для Visual Studio, если она еще не установлена. Его можно установить с помощью   ->  пункта меню средства **получить инструменты и компоненты** .

    ![Рабочая нагрузка "Разработка для Azure".](./media/extend-devtest-labs-azure-functions/azure-development-workload-vs.png)
1. Создайте решение. Выберите **Сборка** , а затем — элемент меню **сборка решения** .

### <a name="step-3-deploy-the-sample-to-azure"></a>Шаг 3. развертывание примера в Azure
В Visual Studio в окне **Обозреватель решений** щелкните правой кнопкой мыши проект **Азурефунктионс** и выберите **Publish (опубликовать**). Следуйте указаниям мастера, чтобы завершить публикацию в новом или существующем приложение-функция Azure. Подробные сведения о разработке и развертывании функций Azure с помощью Visual Studio см. в статье [разработка функций Azure с помощью Visual Studio](../azure-functions/functions-develop-vs.md).

![Диалоговое окно публикации](./media/extend-devtest-labs-azure-functions/publish-dialog.png)


### <a name="step-4--gather-application-settings"></a>Шаг 4. Сбор параметров приложения
После публикации функций необходимо получить URL-адреса для этих функций из портал Azure. 

1. Перейдите на [портал Azure](https://portal.azure.com). 
1. Найдите приложение функции.
1. На странице **приложения-функции** выберите функцию. 
1. Выберите **получить URL-адрес функции** , как показано на следующем рисунке. 

    ![URL-адреса функций Azure](./media/extend-devtest-labs-azure-functions/function-url.png)
4. Скопируйте и сохраните URL-адрес. Повторите эти действия для другой функции Azure. 

Вам также потребуется дополнительная информация о субъекте-службе, например идентификатор приложения, ключ и идентификатор клиента.


### <a name="step-5--update-application-settings"></a>Шаг 5. Обновление параметров приложения
В Visual Studio после публикации функции Azure выберите **изменить параметры службы приложений Azure** в разделе **действия**. Обновите следующие параметры приложения (удаленные):

- AzureFunctionUrl_ApplyUpdates
- AzureFunctionUrl_UpdateSupportPage
- Виндовсупдатеалловеддайс (по умолчанию — 7)
- ServicePrincipal_AppId
- ServicePrincipal_Key
- ServicePrincipal_Tenant

    ![Параметры приложений](./media/extend-devtest-labs-azure-functions/application-settings.png)

### <a name="step-6-test-the-azure-function"></a>Шаг 6. Тестирование функции Azure
Последний шаг в этом пошаговом руководстве — тестирование функции Azure.  

1. Перейдите к функции **упдатеинтерналсуппортпаже** в приложении функции, созданном на шаге 3. 
1. Выберите **тест** в правой части страницы. 
1. Введите в свойствах маршрута (ЛАБНАМЕ, RESOURCEGROUPNAME и SUBSCRIPTIONID).
1. Выберите **выполнить** , чтобы выполнить функцию.  

    Эта функция обновляет страницу внутренней поддержки указанной лаборатории. Он также содержит кнопку для пользователей, которые непосредственно вызывают функцию в следующий раз.

    ![Функция Test](./media/extend-devtest-labs-azure-functions/test-function.png)

## <a name="next-steps"></a>Дальнейшие действия
Функции Azure помогут расширить возможности DevTest Labs, помимо встроенных, и помочь клиентам удовлетворить свои уникальные требования для своих команд. Этот шаблон можно расширить, & расширить его еще больше.  Дополнительные сведения о DevTest Labs см. в следующих статьях: 

- [Корпоративная Эталонная архитектура DevTest Labs](devtest-lab-reference-architecture.md)
- [Часто задаваемые вопросы](devtest-lab-faq.md)
- [Масштабирование DevTest Labs](devtest-lab-guidance-scale.md)
- [Автоматизация DevTest Labs с помощью PowerShell](https://github.com/Azure/azure-devtestlab/tree/master/samples/DevTestLabs/Modules/Library/Tests)








