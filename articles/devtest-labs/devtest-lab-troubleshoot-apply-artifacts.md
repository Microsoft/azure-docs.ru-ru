---
title: Устранение неполадок артефактов в Azure DevTest Labs | Документация Майкрософт
description: Узнайте, как устранять неполадки, возникающие при применении артефактов в Azure DevTest Labs виртуальной машине.
ms.topic: article
ms.date: 06/26/2020
ms.openlocfilehash: a89b675a1b3bf134b98e09c7278f0eccb594c325
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "85483199"
---
# <a name="troubleshoot-issues-when-applying-artifacts-in-an-azure-devtest-labs-virtual-machine"></a>Устранение неполадок при применении артефактов в Azure DevTest Labs виртуальной машине
Применение артефактов на виртуальной машине может завершиться сбоем по разным причинам. В этой статье описываются некоторые методы, помогающие определить возможные причины.

Если вам нужна дополнительная помощь в любой точке этой статьи, вы можете обратиться к специалистам по Azure DevTest Labs (менеджеру) на [форумах MSDN Azure и Stack overflow](https://azure.microsoft.com/support/forums/). Кроме того, можно зарегистрировать обращение в службу поддержки Azure. Перейдите на [сайт поддержки Azure](https://azure.microsoft.com/support/options/) и выберите получить поддержку.   

> [!NOTE]
> Эта статья относится как к виртуальным машинам Windows, так и не к Windows. Хотя есть некоторые отличия, они будут явно вызваны в этой статье.

## <a name="quick-troubleshooting-steps"></a>Действия по устранению неполадок
Убедитесь, что виртуальная машина запущена. Для DevTest Labs требуется, чтобы виртуальная машина была запущена, а [Microsoft Azure агент виртуальной машины (агент ВМ)](../virtual-machines/extensions/agent-windows.md) был установлен и готов.

> [!TIP]
> В **портал Azure** перейдите на страницу **Управление артефактами** виртуальной машины, чтобы убедиться, что виртуальная машина готова к применению артефактов. В верхней части этой страницы появится сообщение. 
> 
> С помощью **Azure PowerShell** Проверьте флаг **канаппляртифактс**, который возвращается, только если развернуть операцию Get. См. Следующий пример команды:

```powershell
Select-AzSubscription -SubscriptionId $SubscriptionId | Out-Null
$vm = Get-AzResource `
        -Name "$LabName/$VmName" `
        -ResourceGroupName $LabRgName `
        -ResourceType 'microsoft.devtestlab/labs/virtualmachines' `
        -ApiVersion '2018-10-15-preview' `
        -ODataQuery '$expand=Properties($expand=ComputeVm)'
$vm.Properties.canApplyArtifacts
```

## <a name="ways-to-troubleshoot"></a>Способы устранения неполадок 
Для устранения неполадок виртуальных машин, созданных с помощью DevTest Labs и модели развертывания диспетчер ресурсов, можно использовать один из следующих методов.

- **Портал Azure** — отлично, если вам нужно быстро получить визуальное указание того, что может быть причиной проблемы.
- **Azure PowerShell** — если вы умеете работать с командной строкой PowerShell, вы можете быстро запросить ресурсы DevTest Labs с помощью командлетов Azure PowerShell.

> [!TIP]
> Дополнительные сведения о том, как просмотреть выполнение артефактов в виртуальной машине, см. [в разделе Диагностика сбоев артефактов в лаборатории](devtest-lab-troubleshoot-artifact-failure.md).

## <a name="symptoms-causes-and-potential-resolutions"></a>Симптомы, причины и возможные решения 

### <a name="artifact-appears-to-stop-responding"></a>Артефакт перестает отвечать на запросы

Артефакт перестает отвечать, пока не истечет заранее определенный период ожидания, а артефакт помечается как **Failed**.

Когда артефакт кажется зависанием, сначала определите, где он зависает. Артефакт можно заблокировать на любом из следующих шагов во время выполнения:

- **Во время первоначального запроса**. DevTest Labs создает шаблон Azure Resource Manager для запроса использования расширения пользовательских скриптов (CSE). Таким образом, в фоновом режиме активируется развертывание группы ресурсов. При возникновении ошибки на этом уровне вы получаете сведения в **журналах действий** группы ресурсов для РАССМАТРИВАЕМОЙ виртуальной машины.  
    - Доступ к журналу действий можно получить на панели навигации на странице виртуальной машины лаборатории. При выборе этого параметра отображается запись о **применении артефактов к виртуальной машине** (если операция применения артефактов была активирована напрямую) или **Добавление или изменение виртуальных машин** (если операция применения артефактов была частью процесса создания виртуальной машины).
    - Найдите ошибки в этих записях. Иногда ошибка не будет помечаться соответствующим образом, и вам придется исследовать каждую запись.
    - При исследовании сведений о каждой записи обязательно ознакомьтесь с содержимым полезных данных JSON. В нижней части этого документа может появиться сообщение об ошибке.
- **При попытке выполнить артефакт**. Это может быть вызвано проблемами с сетью или хранилищем. Дополнительные сведения см. в соответствующем разделе далее в этой статье. Это также может произойти из-за способа создания скрипта. Пример:
    - Сценарий PowerShell имеет **обязательные параметры**, но один из них не может передать ему значение, так как пользователь может оставить его пустым или не имеет значения по умолчанию для свойства в artifactfile.jsфайле определения. Сценарий перестанет отвечать, так как ожидает ввода данных пользователем.
    - Сценарий PowerShell **требует ввода данных пользователем** в процессе выполнения. Сценарии должны быть написаны для автоматической работы без вмешательства пользователя.
- **Агент ВМ занимает продолжительное время**. При первом запуске виртуальной машины или при первой установке расширения пользовательских сценариев для обслуживания запроса на применение артефактов виртуальная машина может потребовать обновления агента виртуальной машины или ожидания инициализации агента виртуальной машины. Возможно, существуют службы, от которых зависит агент виртуальной машины, и инициализация которых занимает много времени. В таких случаях дополнительные сведения об устранении неполадок см. в статье [Обзор агента виртуальной машины Azure](../virtual-machines/extensions/agent-windows.md) .

### <a name="to-verify-if-the-artifact-appears-to-stop-responding-because-of-the-script"></a>Проверка того, что артефакт перестает отвечать на запросы из-за скрипта

1. Войдите на виртуальную машину.
2. Скопируйте скрипт локально на виртуальной машине или выберите его на виртуальной машине в разделе `C:\Packages\Plugins\Microsoft.Compute.CustomScriptExtension\<version>` . Это расположение, куда загружаются скрипты артефактов.
3. С помощью командной строки с повышенными привилегиями выполните скрипт локально, указав те же значения параметров, что и для этой проблемы.
4. Определите, страдает ли сценарий от любого нежелательного поведения. Если это так, то либо запросите обновление артефакта (если оно находится в общедоступном репозитории); или внесите необходимые исправления (если они находятся в частном репозитории).

> [!TIP]
> Вы можете устранить проблемы с артефактами, размещенными в нашем [общедоступном репозитории](https://github.com/Azure/azure-devtestlab) , и отправить изменения для нашей проверки и утверждения. См. раздел " **публикации** " в документе [readme.md](https://github.com/Azure/azure-devtestlab/blob/master/Artifacts/README.md) .
> 
> Сведения о создании собственных артефактов см. в разделе [AUTHORING.md](https://github.com/Azure/azure-devtestlab/blob/master/Artifacts/AUTHORING.md) Document.

### <a name="to-verify-if-the-artifact-appears-to-stop-responding-because-of-the-vm-agent"></a>Чтобы убедиться, что артефакт перестает отвечать на запросы из-за агента виртуальной машины:
1. Войдите на виртуальную машину.
2. С помощью проводника перейдите к **к:\виндовсазуре\логс**.
3. Перейдите к файлу **вааппажент. log** и откройте его.
4. Поиск записей, показывающих, когда запускается агент виртуальной машины и когда он завершает инициализацию (то есть отправляется первый пульс). Предпочитать более новые записи или, в частности, те, которые возникают в течение периода времени, в течение которого возникла проблема.

    ```
    [00000006] [11/14/2019 05:52:13.44] [INFO]  WindowsAzureGuestAgent starting. Version 2.7.41491.949
    ...
    [00000006] [11/14/2019 05:52:31.77] [WARN]  Waiting for OOBE to Complete ...
    ...
    [00000006] [11/14/2019 06:02:30.43] [WARN]  Waiting for OOBE to Complete ...
    [00000006] [11/14/2019 06:02:33.43] [INFO]  StateExecutor initialization completed.
    [00000020] [11/14/2019 06:02:33.43] [HEART] WindowsAzureGuestAgent Heartbeat.
    ```
    В этом примере можно увидеть, что время запуска агента виртуальной машины заняло 10 минут и 20 секунд, так как был отправлен пульс. Причина в этом случае была вызвана длительным временем запуска службы OOBE.

> [!TIP]
> Общие сведения о расширениях Azure см. в статье [расширения и компоненты виртуальной машины Azure](../virtual-machines/extensions/overview.md).

## <a name="storage-errors"></a>Ошибки хранилища
DevTest Labs требует доступа к учетной записи хранения лаборатории, созданной для кэширования артефактов. Когда DevTest Labs применяет артефакт, он будет считывать конфигурацию артефакта и ее файлы из настроенных репозиториев. По умолчанию DevTest Labs настраивает доступ к **репозиторию общедоступных артефактов**.

В зависимости от настройки виртуальной машины он может не иметь прямого доступа к этому репозиторию. Таким образом, при проектировании DevTest Labs кэширует артефакты в учетной записи хранения, которая создается при первой инициализации лаборатории.

Если доступ к этой учетной записи хранения блокируется каким-либо образом, как только блокируется трафик от виртуальной машины к службе хранилища Azure, может появиться сообщение об ошибке следующего вида:

```shell
CSE Error: Failed to download all specified files. Exiting. Exception: Microsoft.WindowsAzure.Storage.StorageException: The remote server returned an error: (403) Forbidden. ---> System.Net.WebException: The remote server returned an error: (403) Forbidden.
```

Описанная выше ошибка появится в разделе **сообщение о развертывании** на странице **результатов артефактов** в разделе **Управление артефактами**. Он также появится в **журналах действий** в группе ресурсов виртуальной машины.

### <a name="to-ensure-communication-to-the-azure-storage-service-isnt-being-blocked"></a>Чтобы убедиться, что обмен данными со службой хранилища Azure не заблокирован:

- **Проверьте наличие добавленных групп безопасности сети (NSG)**. Возможно, была добавлена политика подписки, где группы безопасности сети автоматически настраивается во всех виртуальных сетях. Это также повлияет на используемую по умолчанию виртуальную сеть лаборатории, если она используется, или другую виртуальную сеть, настроенную в лаборатории, которая используется для создания виртуальных машин.
- **Проверьте учетную запись хранения лаборатории по умолчанию** (то есть первую учетную запись хранения, созданную при создании лаборатории, имя которой обычно начинается с буквы "a" и заканчивается с помощью многозначного числа, равного \<labname\> #).
    1. Перейдите к группе ресурсов лаборатории.
    2. Выберите ресурс типа **учетная запись хранения**, имя которого соответствует соглашению.
    3. Перейдите на страницу учетной записи хранения под названием **брандмауэры и виртуальные сети**.
    4. Убедитесь, что для него задано значение **все сети**. Если выбран параметр **Выбранные сети** , убедитесь, что в список добавлены виртуальные сети лаборатории, используемые для создания виртуальных машин.

Более подробные сведения об устранении неполадок см. в статье [Настройка брандмауэров службы хранилища Azure и виртуальных сетей](../storage/common/storage-network-security.md).

> [!TIP]
> **Проверьте правила группы безопасности сети**. Используйте [проверку IP-потока](../network-watcher/diagnose-vm-network-traffic-filtering-problem.md#use-ip-flow-verify) , чтобы убедиться, что правило в группе безопасности сети блокирует входящий и исходящий трафик виртуальной машины. Вы также можете проверить действующие правила группы безопасности, чтобы убедиться, **что входящее правило** NSG существует. Дополнительные сведения см. [в статье Использование действующих правил безопасности для устранения неполадок потока трафика виртуальной машины](../virtual-network/diagnose-network-traffic-filter-problem.md).

## <a name="other-sources-of-error"></a>Другие источники ошибок
Существуют и менее распространенные возможные источники ошибок. Обязательно оцените каждую из них, чтобы узнать, применимы ли они к вашему случаю. Вот один из них: 

- **Личный маркер доступа с истекшим сроком действия для частного репозитория**. После истечения срока действия артефакт не будет указан, и все скрипты, ссылающиеся на артефакты из репозитория с закрытым маркером доступа с истекшим сроком действия, будут завершаться ошибкой соответствующим образом.

## <a name="next-steps"></a>Дальнейшие действия
Если ни одна из этих ошибок не существует и вы по-прежнему не можете применить артефакты, вы можете подать заявку на службу поддержки Azure. Перейдите на [сайт поддержки Azure](https://azure.microsoft.com/support/options/) и щелкните **Получить поддержку**.
