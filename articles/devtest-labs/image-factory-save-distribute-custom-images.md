---
title: Сохранение и распространение образов в Azure DevTest Labs | Документация Майкрософт
description: В этой статье содержатся инструкции по сохранению пользовательских образов из уже созданных виртуальных машин в Azure DevTest Labs.
ms.topic: article
ms.date: 06/26/2020
ms.openlocfilehash: a5278626f8cdd4299912f3c952786422436fe916
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "85476246"
---
# <a name="save-custom-images-and-distribute-to-multiple-labs"></a>Сохранение пользовательских образов и их распространение в несколько лабораторий
В этой статье содержатся инструкции по сохранению пользовательских образов из уже созданных виртуальных машин. Здесь также рассматривается распространение этих пользовательских образов в другие DevTest Labs в Организации.

## <a name="prerequisites"></a>Предварительные требования
Следующие элементы уже должны быть на месте:

- Лаборатория для фабрики изображений в Azure DevTest Labs.
- Проект Azure DevOps, используемый для автоматизации фабрики образов.
- Расположение исходного кода, содержащее скрипты и конфигурацию (в нашем примере — в том же проекте DevOps, который упоминался на предыдущем шаге).
- Определение сборки для управления задачами Azure PowerShell.

При необходимости выполните действия из раздела [Запуск фабрики образов из Azure DevOps](image-factory-set-up-devops-lab.md) , чтобы создать или настроить эти элементы. 

## <a name="save-vms-as-generalized-vhds"></a>Сохранение виртуальных машин в качестве обобщенных виртуальных жестких дисков
Сохраните существующие виртуальные машины в качестве обобщенных виртуальных жестких дисков.  Существует пример сценария PowerShell для сохранения существующих виртуальных машин в качестве обобщенных виртуальных жестких дисков. Чтобы использовать его, сначала добавьте в определение сборки еще одну задачу **Azure PowerShell** , как показано на следующем рисунке:

![Добавить Azure PowerShell шаг](./media/save-distribute-custom-images/powershell-step.png)

Когда в списке появится новая задача, выберите элемент, чтобы можно было заполнить все детали, как показано на следующем рисунке: 

![Параметры PowerShell](./media/save-distribute-custom-images/powershell-settings.png)


## <a name="generalized-vs-specialized-custom-images"></a>Обобщенные и специализированные пользовательские образы
В [портал Azure](https://portal.azure.com)при создании пользовательского образа из виртуальной машины можно выбрать обобщенный или специализированный пользовательский образ.

- **Специализированный пользовательский образ:** Средство Sysprep/unготовить не было запущено на компьютере. Это означает, что образ является точной копией диска ОС на существующей виртуальной машине (моментальный снимок).  Те же файлы, приложения, учетные записи пользователей, имена компьютеров и т. д. существуют, когда мы создаем новую машину из этого пользовательского образа.
- **Обобщенный пользовательский образ:** На компьютере был запущен Sysprep/unготовить.  При выполнении этого процесса удаляются учетные записи пользователей, удаляется имя компьютера, удаляются кусты реестра пользователя и т. д. с целью обобщения образа, чтобы его можно было настроить при создании другой виртуальной машины.  При подготовке виртуальной машины к работе (с помощью Sysprep) процесс удаляет текущую виртуальную машину — она больше не будет работать.

Скрипт для привязки пользовательских образов в фабрике образов сохранит виртуальные жесткие диски для всех виртуальных машин, созданных на предыдущем шаге (определяется на основе тега ресурса в Azure).

## <a name="update-configuration-for-distributing-images"></a>Обновление конфигурации распространения образов
Следующим этапом процесса является передача пользовательских образов из лаборатории фабрики образов в другие лабораторные работы, которым они необходимы. Основной частью этого процесса является **labs.js** файла конфигурации. Этот файл можно найти в папке **конфигурации** , входящей в фабрику образов.

В labs.jsфайла конфигурации есть два ключевых момента.

- Уникальная идентификация конкретной целевой лаборатории с помощью идентификатора подписки и имени лаборатории.
- Конкретный набор образов, которые должны быть переданы в лабораторию в качестве относительных путей к корню конфигурации. Можно указать всю папку (для получения всех образов в этой папке).

Ниже приведен пример labs.jsв файле с двумя лабораторными занятиями. В этом случае вы распространяете образы в две разные лабораторные занятия.

```json
{
   "Labs": [
      {
         "SubscriptionId": "<subscription ID that contains the lab>",
         "LabName": "<Name of the DevTest Lab>",
         "ImagePaths": [
               "Win2012R2",
               "Win2016/Datacenter.json"
         ]
      },
      {
         "SubscriptionId": "<subscription ID that contains the lab>",
         "LabName": "<Name of the DevTest Lab>",
         "ImagePaths": [
               "Win2016/Datacenter.json"
         ]
      }
   ]
}
```

## <a name="create-a-build-task"></a>Создание задачи сборки
С помощью тех же действий, которые были рассмотрены ранее в этой статье, добавьте дополнительную задачу сборки **Azure PowerShell** в определение сборки. Заполните сведения, как показано на следующем рисунке: 

![Задача сборки для распространения образов](./media/save-distribute-custom-images/second-build-task-powershell.png)

Параметры: `-ConfigurationLocation $(System.DefaultWorkingDirectory)$(ConfigurationLocation) -SubscriptionId $(SubscriptionId) -DevTestLabName $(DevTestLabName) -maxConcurrentJobs 20`

Эта задача принимает в фабрике образов пользовательские образы и отправляет их в любые лаборатории, определенные в Labs.jsфайле.

## <a name="queue-the-build"></a>Поставить сборку в очередь
После завершения задачи сборки распространителя поочередно создайте новую сборку, чтобы убедиться в том, что все работает. После успешного завершения сборки новые пользовательские образы будут отображаться в целевой лаборатории, которая была введена в Labs.jsфайла конфигурации.

## <a name="next-steps"></a>Дальнейшие действия
В следующей статье серии вы обновите фабрику образов, указав политику хранения и шаги очистки: [Настройка политики хранения и запуск скриптов очистки](image-factory-set-retention-policy-cleanup.md).
