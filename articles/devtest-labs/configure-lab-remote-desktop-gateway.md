---
title: Настройка лаборатории для использования шлюза удаленный рабочий стол в Azure DevTest Labs
description: Узнайте, как настроить лабораторию в Azure DevTest Labs с помощью шлюза удаленных рабочих столов, чтобы обеспечить безопасный доступ к виртуальным машинам лаборатории без необходимости предоставлять порт RDP.
ms.topic: article
ms.date: 06/26/2020
ms.openlocfilehash: dcf5191dea64c3d7bf28b9ce1c616d3d2defb73e
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "97695689"
---
# <a name="configure-your-lab-in-azure-devtest-labs-to-use-a-remote-desktop-gateway"></a>Настройка лаборатории в Azure DevTest Labs для использования шлюза удаленных рабочих столов
В Azure DevTest Labs можно настроить шлюз удаленных рабочих столов для лаборатории, чтобы обеспечить безопасный доступ к виртуальным машинам лаборатории, не открывая RDP-порт. Лаборатория предоставляет пользователям лабораторий централизованное представление и подключение ко всем виртуальным машинам, к которым у них есть доступ. Кнопка **подключить** на странице **виртуальной машины** создает файл RDP, зависящий от компьютера, который можно открыть для подключения к компьютеру. Вы можете дополнительно настроить и защитить подключение RDP, подключив свою лабораторию к шлюзу удаленных рабочих столов. 

Этот подход более безопасен, так как пользователь лаборатории выполняет проверку подлинности непосредственно на компьютере шлюза или может использовать учетные данные компании на компьютере шлюза, присоединенного к домену, для подключения к своим компьютерам. Кроме того, Лаборатория поддерживает использование аутентификации на основе маркеров для компьютера шлюза, который позволяет пользователям подключаться к виртуальным машинам лаборатории, не открывая через Интернет порт RDP. В этой статье рассматривается пример настройки лаборатории, использующей аутентификацию на основе маркеров для подключения к компьютерам лаборатории.

## <a name="architecture-of-the-solution"></a>Архитектура решения

![Архитектура решения](./media/configure-lab-remote-desktop-gateway/architecture.png)

1. Действие [получить содержимое файла RDP](/rest/api/dtl/virtualmachines/getrdpfilecontents) вызывается при нажатии кнопки **подключить** . 1. 
1. Действие Get RDP File Contents вызывается `https://{gateway-hostname}/api/host/{lab-machine-name}/port/{port-number}` для запроса маркера проверки подлинности.
    1. `{gateway-hostname}` — Это имя узла шлюза, указанное на странице **Параметры лаборатории** для лаборатории в портал Azure. 
    1. `{lab-machine-name}` — имя компьютера, к которому выполняется подключение.
    1. `{port-number}` порт, на котором необходимо установить соединение. Обычно это порт 3389. Если виртуальная машина лаборатории использует компонент [общего IP-адреса](devtest-lab-shared-ip.md) в DevTest Labs, порт будет отличаться.
1. Шлюз удаленных рабочих столов откладывает вызов `https://{gateway-hostname}/api/host/{lab-machine-name}/port/{port-number}` функции Azure для создания маркера проверки подлинности. Служба DevTest Labs автоматически включает ключ функции в заголовок запроса. Ключ функции необходимо сохранить в хранилище ключей лаборатории. Имя для этого секрета, которое будет отображаться как **секрет маркера шлюза** на странице **параметров лаборатории** для лаборатории.
1. Функция Azure должна вернуть маркер для проверки подлинности на основе сертификата на компьютере шлюза.  
1. Затем действие Get RDP File Contents возвращает полный RDP-файл, включая сведения о проверке подлинности.
1. Вы открываете RDP-файл с помощью предпочтительной программы подключения по протоколу RDP. Помните, что не все программы подключения RDP поддерживают проверку подлинности маркеров. Маркер проверки подлинности имеет дату окончания срока действия, заданную приложением функции. Установите подключение к виртуальной машине лаборатории до истечения срока действия маркера.
1. После того как компьютер шлюза удаленных рабочих столов пройдет проверку подлинности маркера в RDP-файле, подключение перенаправляется на компьютер лаборатории.

### <a name="solution-requirements"></a>Требования к решению
Для работы с функцией проверки подлинности маркеров DevTest Labs необходимо выполнить ряд требований к конфигурации для компьютеров шлюзов, служб доменных имен (DNS) и функций.

### <a name="requirements-for-remote-desktop-gateway-machines"></a>Требования к компьютерам шлюза удаленных рабочих столов
- Чтобы обрабатывать HTTPS-трафик, на компьютере шлюза должен быть установлен сертификат TLS/SSL. Сертификат должен соответствовать полному доменному имени (FQDN) балансировщика нагрузки для фермы шлюзов или полному доменному имени компьютера, если имеется только один компьютер. Сертификаты TLS/SSL с подстановочными знаками не работают.  
- Сертификат подписи, установленный на компьютерах шлюзов. Создайте сертификат подписи с помощью [Create-SigningCertificate.ps1](https://github.com/Azure/azure-devtestlab/blob/master/samples/DevTestLabs/GatewaySample/tools/Create-SigningCertificate.ps1) сценария.
- Установите [подключаемый модуль проверки подлинности](https://code.msdn.microsoft.com/windowsdesktop/Remote-Desktop-Gateway-517d6273) , поддерживающий аутентификацию на маркерах для шлюза удаленных рабочих столов. Одним из примеров такого модуля является `RDGatewayFedAuth.msi` то, что поставляется с [образами System Center Virtual Machine Manager (VMM)](/system-center/vmm/install-console?view=sc-vmm-1807). Дополнительные сведения о System Center см. в [документации по System Center](/system-center/) и [ценах](https://www.microsoft.com/cloud-platform/system-center-pricing).  
- Сервер шлюза может выполнять запросы, выполненные в `https://{gateway-hostname}/api/host/{lab-machine-name}/port/{port-number}` .

    Имя узла Gateway — это полное доменное имя балансировщика нагрузки в ферме шлюзов или полное доменное имя компьютера, если имеется только один компьютер. `{lab-machine-name}`— Это имя компьютера лаборатории, к которому вы пытаетесь подключиться, а `{port-number}` — порт, на который будет установлено соединение.  По умолчанию этот порт равен 3389.  Однако если виртуальная машина использует компонент [общего IP-адреса](devtest-lab-shared-ip.md) в DevTest Labs, порт будет отличаться.
- Модуль [запросов маршрутизации приложений](/iis/extensions/planning-for-arr/using-the-application-request-routing-module) для сервера IIS можно использовать для перенаправления `https://{gateway-hostname}/api/host/{lab-machine-name}/port/{port-number}` запросов в функцию Azure, которая обрабатывает запрос на получение маркера для проверки подлинности.


## <a name="requirements-for-azure-function"></a>Требования к функции Azure
Функция Azure обрабатывает запрос с форматом `https://{function-app-uri}/app/host/{lab-machine-name}/port/{port-number}` и возвращает маркер проверки подлинности на основе того же сертификата для подписи, установленного на компьютерах шлюзов. `{function-app-uri}`— Это универсальный код ресурса (URI), используемый для доступа к функции. Ключ функции автоматически передается в заголовке запроса. Пример функции см. в разделе [https://github.com/Azure/azure-devtestlab/blob/master/samples/DevTestLabs/GatewaySample/src/RDGatewayAPI/Functions/CreateToken.cs](https://github.com/Azure/azure-devtestlab/blob/master/samples/DevTestLabs/GatewaySample/src/RDGatewayAPI/Functions/CreateToken.cs) . 


## <a name="requirements-for-network"></a>Требования к сети

- DNS для полного доменного имени, связанного с сертификатом TLS/SSL, установленным на компьютерах шлюзов, должен направить трафик на компьютер шлюза или в подсистему балансировки нагрузки фермы компьютеров шлюза.
- Если компьютер лаборатории использует частные IP-адреса, должен быть указан сетевой путь от компьютера шлюза к компьютеру лаборатории с помощью совместного использования той же виртуальной сети или с помощью одноранговых виртуальных сетей.

## <a name="configure-the-lab-to-use-token-authentication"></a>Настройка лаборатории для использования проверки подлинности с помощью маркеров 
В этом разделе показано, как настроить лабораторию для использования компьютера шлюза удаленных рабочих столов, поддерживающего аутентификацию на маркерах. В этом разделе не рассматривается настройка самой фермы шлюза удаленных рабочих столов. Дополнительные сведения см. в разделе [Пример создания шлюза удаленных рабочих столов](#sample-to-create-a-remote-desktop-gateway) в конце этой статьи. 

Перед обновлением параметров лаборатории сохраните ключ, необходимый для успешного выполнения функции, чтобы вернуть маркер проверки подлинности в хранилище ключей лаборатории. Значение ключа функции можно получить на странице **Управление** для функции в портал Azure. Дополнительные сведения о сохранении секрета в хранилище ключей см. в разделе [Добавление секрета в Key Vault](../key-vault/secrets/quick-create-portal.md#add-a-secret-to-key-vault). Сохраните имя секрета для последующего использования.

Чтобы найти идентификатор хранилища ключей лаборатории, выполните следующую команду Azure CLI: 

```azurecli
az resource show --name {lab-name} --resource-type 'Microsoft.DevTestLab/labs' --resource-group {lab-resource-group-name} --query properties.vaultName
```

Настройте лабораторию для использования проверки подлинности на основе маркеров, выполнив следующие действия.

1. Войдите на [портал Azure](https://portal.azure.com).
1. Щелкните **Все службы** и выберите в списке **DevTest Labs**.
1. В списке лабораторий выберите свою **лабораторию**.
1. На странице лаборатории выберите **Конфигурация и политики**.
1. В меню слева в разделе **Параметры** выберите **Параметры лаборатории**.
1. В разделе **Удаленный рабочий стол** введите полное доменное имя (FQDN) или IP-адрес компьютера или фермы шлюза служб удаленных рабочих столов для поля **имя узла шлюза** . Это значение должно совпадать с полным доменным именем сертификата TLS/SSL, используемого на компьютерах шлюзов.

    ![Параметры удаленного рабочего стола в параметрах лаборатории](./media/configure-lab-remote-desktop-gateway/remote-desktop-options-in-lab-settings.png)
1. В разделе **Удаленный рабочий стол** для параметра секрет **маркера шлюза** введите имя созданного ранее секрета. Это значение не является ключом функции, а именем секрета в хранилище ключей лаборатории, которое содержит ключ функции.

    ![Секрет маркера шлюза в параметрах лаборатории](./media/configure-lab-remote-desktop-gateway/gateway-token-secret.png)
1. **Сохранение** Изменениями.

    > [!NOTE] 
    > Нажимая кнопку " **сохранить**", вы соглашаетесь с [условиями лицензии удаленный рабочий стол шлюза](https://www.microsoft.com/licensing/product-licensing/products). Дополнительные сведения об удаленном шлюзе см. [в статье Добро пожаловать в службы удаленных рабочих столов](/windows-server/remote/remote-desktop-services/Welcome-to-rds) и [развернуть среду удаленного рабочего стола](/windows-server/remote/remote-desktop-services/rds-deploy-infrastructure).


Если предпочтительнее настроить лабораторию с помощью службы автоматизации, см. [Set-DevTestLabGateway.ps1](https://github.com/Azure/azure-devtestlab/blob/master/samples/DevTestLabs/GatewaySample/tools/Set-DevTestLabGateway.ps1) пример сценария PowerShell для задания параметров **имени узла шлюза** и **секрета маркера шлюза** . [Репозиторий Azure DevTest Labs GitHub](https://github.com/Azure/azure-devtestlab) также предоставляет шаблон Azure Resource Manager, который создает или обновляет лабораторию с **именем узла шлюза** и параметрами **секрета маркера шлюза** .

## <a name="configure-network-security-group"></a>Настройка группы безопасности сети
Для дальнейшей защиты лаборатории в виртуальную сеть, используемую виртуальными машинами лаборатории, можно добавить группу безопасности сети (NSG). Инструкции по настройке NSG см. в статье [Создание, изменение или удаление группы безопасности сети](../virtual-network/manage-network-security-group.md).

Ниже приведен пример NSG, разрешающий только трафик, который сначала проходит через шлюз для доступа к компьютерам лаборатории. Источником в этом правиле является IP-адрес компьютера с одним шлюзом или IP-адрес балансировщика нагрузки перед компьютерами шлюза.

![Группа безопасности сети — правила](./media/configure-lab-remote-desktop-gateway/network-security-group-rules.png)

## <a name="sample-to-create-a-remote-desktop-gateway"></a>Пример создания шлюза удаленных рабочих столов

> [!NOTE] 
> Используя примеры шаблонов, вы соглашаетесь с [условиями лицензии удаленный рабочий стол шлюза](https://www.microsoft.com/licensing/product-licensing/products). Дополнительные сведения об удаленном шлюзе см. [в статье Добро пожаловать в службы удаленных рабочих столов](/windows-server/remote/remote-desktop-services/Welcome-to-rds) и [развернуть среду удаленного рабочего стола](/windows-server/remote/remote-desktop-services/rds-deploy-infrastructure).

[Репозиторий Azure DevTest Labs GitHub](https://github.com/Azure/azure-devtestlab) содержит несколько примеров, помогающих настроить ресурсы, необходимые для использования проверки подлинности маркеров и шлюза удаленных рабочих столов с DevTest Labs. Эти примеры включают Azure Resource Manager шаблоны для компьютеров шлюзов, параметры лаборатории и приложение функции.

Выполните следующие действия, чтобы настроить пример решения для фермы шлюзов удаленных рабочих столов.

1. Создайте сертификат подписи.  Запустите [Create-SigningCertificate.ps1](https://github.com/Azure/azure-devtestlab/blob/master/samples/DevTestLabs/GatewaySample/tools/Create-SigningCertificate.ps1). Сохраните отпечаток, пароль и кодировку Base64 для созданного сертификата.
2. Получите сертификат TLS/SSL. Полное доменное имя, связанное с сертификатом TLS/SSL, должно соответствовать домену, который вы контролируете. Сохраните отпечаток, пароль и кодировку Base64 для этого сертификата. Чтобы получить отпечаток с помощью PowerShell, используйте следующие команды.

    ```powershell
    $cer = New-Object System.Security.Cryptography.X509Certificates.X509Certificate;
    $cer.Import(‘path-to-certificate’);
    $hash = $cer.GetCertHashString()
    ```

    Чтобы получить кодировку base64 с помощью PowerShell, используйте следующую команду.

    ```powershell
    [System.Convert]::ToBase64String([System.IO.File]::ReadAllBytes(‘path-to-certificate’))
    ```
3. Скачивание файлов из [https://github.com/Azure/azure-devtestlab/tree/master/samples/DevTestLabs/GatewaySample/arm/gateway](https://github.com/Azure/azure-devtestlab/tree/master/samples/DevTestLabs/GatewaySample/arm/gateway) .

    Шаблону требуется доступ к некоторым другим шаблонам диспетчер ресурсов и связанным ресурсам с тем же базовым URI. Скопируйте все файлы из [https://github.com/Azure/azure-devtestlab/blob/master/samples/DevTestLabs/GatewaySample/arm/gateway](https://github.com/Azure/azure-devtestlab/blob/master/samples/DevTestLabs/GatewaySample/arm/gateway) и RDGatewayFedAuth.msi в контейнер больших двоичных объектов в учетной записи хранения.  
4. Развертывание **azuredeploy.jsна** из [https://github.com/Azure/azure-devtestlab/tree/master/samples/DevTestLabs/GatewaySample/arm/gateway](https://github.com/Azure/azure-devtestlab/tree/master/samples/DevTestLabs/GatewaySample/arm/gateway) . Шаблон принимает следующие параметры:
    - adminUsername — обязательное.  Имя пользователя администратора для компьютеров шлюза.
    - adminPassword — обязательное. Пароль для учетной записи администратора для компьютеров шлюза.
    - instanceCount — число создаваемых компьютеров шлюза.  
    - alwaysOn — указывает, следует ли использовать созданное приложение функций Azure в горячем состоянии. Если пользователи впервые пытаются подключиться к своей лабораторной виртуальной машине, это не повлияет на затраты.  
    - Токенлифетиме — период времени, в течение которого созданный маркер будет действителен. Формат — чч: мм: СС.
    - Сслцертификате — кодировка base64 сертификата TLS/SSL для компьютера шлюза.
    - Сслцертификатепассворд — пароль TLS/SSL-сертификата для компьютера шлюза.
    - Сслцертификатесумбпринт — отпечаток сертификата для идентификации в локальном хранилище сертификатов TLS/SSL-сертификата.
    - Сигнцертификате — кодировка Base64 для сертификата подписи для компьютера шлюза.
    - Сигнцертификатепассворд — пароль для подписи сертификата для компьютера шлюза.
    - Сигнцертификатесумбпринт — отпечаток сертификата для идентификации в локальном хранилище сертификатов для подписи сертификата.
    - _artifactsLocation — расположение URI, где можно найти все вспомогательные ресурсы. Это значение должно быть полным УИР, а не относительным путем.
    - _artifactsLocationSasToken — маркер подписанного URL-адрес (SAS), используемый для доступа к вспомогательным ресурсам, если расположение является учетной записью хранения Azure.

    Шаблон можно развернуть с помощью Azure CLI с помощью следующей команды:

    ```azurecli
    az deployment group create --resource-group {resource-group} --template-file azuredeploy.json --parameters @azuredeploy.parameters.json -–parameters _artifactsLocation="{storage-account-endpoint}/{container-name}" -–parameters _artifactsLocationSasToken = "?{sas-token}"
    ```

    Ниже приведены описания параметров.

    - {Storage-Account-Endpoint} можно получить, выполнив `az storage account show --name {storage-acct-name} --query primaryEndpoints.blob` .  {Storage-acct-name} — это имя учетной записи хранения, в которой хранятся отправленные файлы.  
    - {Container-name} — это имя контейнера в {Storage-acct-Name}, содержащего отправленные файлы.  
    - {SAS-token} можно получить, выполнив `az storage container generate-sas --name {container-name} --account-name {storage-acct-name} --https-only –permissions drlw –expiry {utc-expiration-date}` . 
        - {Storage-acct-name} — это имя учетной записи хранения, в которой хранятся отправленные файлы.  
        - {Container-name} — это имя контейнера в {Storage-acct-Name}, содержащего отправленные файлы.  
        - {UTC-Expires-Date} — это дата в формате UTC, с которой истекает срок действия маркера SAS, и маркер SAS больше не может использоваться для доступа к учетной записи хранения.

    Запишите значения для Гатевайфкдн и Гатевайип из выходных данных развертывания шаблона. Также необходимо сохранить значение функциональной клавиши для вновь созданной функции, которую можно найти на вкладке [Параметры приложения функции](../azure-functions/functions-how-to-use-azure-function-app-settings.md) .
5. Настройте DNS таким образом, чтобы полное доменное имя (FQDN) SSL-сертификата направлялось на IP-адрес Гатевайип из предыдущего шага.

    После создания фермы шлюзов удаленный рабочий стол и внесения соответствующих обновлений DNS, она готова к использованию в лаборатории в DevTest Labs. Параметры секрета **имени узла шлюза** и **маркера шлюза** должны быть настроены для использования развернутых компьютеров шлюзов. 

    > [!NOTE]
    > Если компьютер лаборатории использует частные IP-адреса, необходимо указать сетевой путь от компьютера шлюза к компьютеру лаборатории, используя совместное использование той же виртуальной сети или одноранговой виртуальной сети.

    После настройки шлюза и лаборатории файл подключения, создаваемый при щелчке **подключения** пользователем лаборатории, автоматически будет содержать сведения, необходимые для подключения с использованием проверки подлинности на основе маркеров.     

## <a name="next-steps"></a>Дальнейшие действия
Дополнительные сведения о службы удаленных рабочих столов и [документации по службы удаленных рабочих столов](/windows-server/remote/remote-desktop-services/Welcome-to-rds) см. в следующей статье.