---
title: Использование управляемых удостоверений Azure для создания сред в DevTest Labs | Документация Майкрософт
description: Узнайте, как использовать управляемые удостоверения в Azure для развертывания сред в лаборатории в Azure DevTest Labs.
ms.topic: article
ms.date: 06/26/2020
ms.openlocfilehash: 0f3e4b4d7030eb26c25b291e03caaa430d1979c4
ms.sourcegitcommit: 0aec60c088f1dcb0f89eaad5faf5f2c815e53bf8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/14/2021
ms.locfileid: "98185790"
---
# <a name="use-azure-managed-identities-to-deploy-environments-in-a-lab"></a>Использование управляемых удостоверений Azure для развертывания сред в лаборатории 

Как владелец лаборатории вы можете использовать управляемое удостоверение для развертывания сред в лаборатории. Эта функция полезна в сценариях, где среда содержит или содержит ссылки на ресурсы Azure, такие как хранилища ключей, общие галереи образов и сети, являющиеся внешними по отношению к группе ресурсов среды. Она позволяет создавать изолированные среды, которые не ограничиваются группой ресурсов этой среды.

> [!NOTE]
> В настоящее время для лаборатории поддерживается только одно назначенное пользователем удостоверение. 

## <a name="prerequisites"></a>Предварительные требования

- [Создание, перечисление, удаление или назначение роли назначенному пользователем управляемому удостоверению с помощью портал Azure](../active-directory/managed-identities-azure-resources/how-to-manage-ua-identity-portal.md). 
    
    Убедитесь, что управляемое удостоверение создано в том же регионе и подписке, что и ваша лаборатория. Управляемое удостоверение не обязательно должно находиться в той же группе ресурсов.

## <a name="use-azure-portal"></a>Использование портала Azure

В этом разделе вы, как владелец лаборатории, используете портал Azure, чтобы добавить управляемое пользователем удостоверение в лабораторию. 

1. Войдите на [портал Azure](https://portal.azure.com).
1. Выполните поиск по запросу **DevTest Labs**.
1. В списке лабораторий выберите нужную лабораторию.
1. Выберите **Конфигурация и**  ->  **удостоверение политик (Предварительная версия)**. 
1. Чтобы добавить удостоверение, назначенное пользователем, перейдите на вкладку **Назначенные пользователи** .
1. Нажмите кнопку **Добавить** .
1. Выберите существующего пользователя, которого вы создали и (или) имеете доступ к, из раскрывающегося списка.
 
    ![Добавление удостоверения, управляемого пользователем](./media/use-managed-identities-environments/add-user-managed-identity.png)
1. Нажмите кнопку **сохранить** в верхней части страницы.

    После сохранения лаборатория будет использовать это удостоверение при развертывании всех лабораторных сред. Вы также можете получить доступ к ресурсу удостоверений в Azure, выбрав удостоверение из списка. 

Владельцу лаборатории не нужно делать ничего особенного при развертывании среды при условии, что удостоверение, добавленное в лабораторию, имеет разрешения на доступ к внешним ресурсам, необходимым среде. 

Чтобы изменить управляемое пользователем удостоверение, которое было назначено лаборатории, сначала удалите удостоверение, присоединенное к лаборатории, а затем добавьте еще одну учетную запись в лабораторию. Чтобы удалить удостоверение, присоединенное к лаборатории, выберите **... (многоточие)** и нажмите кнопку **Удалить**. 

## <a name="use-api"></a>Использовать API

1. После создания удостоверения запишите идентификатор ресурса этого удостоверения. Он должен выглядеть, как в следующем примере: 

    `/subscriptions/0000000000-0000-0000-0000-00000000000000/resourceGroups/<RESOURCE GROUP NAME> /providers/Microsoft.ManagedIdentity/userAssignedIdentities/<NAME of USER IDENTITY>`.
1. Выполните метод размещения HTTPS, чтобы добавить новый `ServiceRunner` ресурс в лабораторию, как показано в следующем примере. Ресурс "средство запуска службы" — это прокси-ресурс для управления управляемыми удостоверениями и управления ими в DevTest Labs. Имя средства запуска службы может быть любым допустимым именем, но рекомендуется использовать имя управляемого ресурса удостоверений. 
 
    ```json
    PUT https://management.azure.com/subscriptions/{subId}/resourceGroups/{rg}/providers/Microsoft.Devtestlab/labs/{yourlabname}/serviceRunners/{serviceRunnerName}

    {
        "location": "{location}",
        "identity":{
            "type": "userAssigned",
            "userAssignedIdentities":{
                "[userAssignedIdentityResourceId]":{}
            }
        }
        "properties":{
            "identityUsageType":"Environment"
                     }
          
    }
    ```
 
    Ниже приведен пример: 

    ```json
    PUT https://management.azure.com/subscriptions/0000000000-0000-0000-0000-000000000000000/resourceGroups/exampleRG/providers/Microsoft.Devtestlab/labs/mylab/serviceRunners/sampleuseridentity

    {
        "location": "eastus",
        "identity":{
            "type": "userAssigned",
            "userAssignedIdentities":{
                "/subscriptions/0000000000-0000-0000-0000-000000000000000/resourceGroups/exampleRG/providers/Microsoft.ManagedIdentity/userAssignedIdentities/sampleuseridentity":{}
            }
        }
        "properties":{
            "identityUsageType":"Environment"
                     }
    }
    ```
 
После добавления удостоверения пользователя в лабораторию служба Azure DevTest Labs будет использовать ее при развертывании среды Azure Resource Manager. Например, если вам нужен шаблон диспетчер ресурсов для доступа к внешнему образу коллекции общих образов, убедитесь, что удостоверение, добавленное в лабораторию, имеет минимальные необходимые разрешения для ресурса коллекции общих образов. 
