---
title: Как отслеживать доступность кластера с помощью журналов Azure Monitor в HDInsight
description: Узнайте, как использовать журналы Azure Monitor для мониторинга работоспособности и доступности кластера.
ms.service: hdinsight
ms.topic: how-to
ms.date: 08/12/2020
ms.openlocfilehash: 3bc5c659d9871cb8f1d49d2a3bfde2ce03faea86
ms.sourcegitcommit: e559daa1f7115d703bfa1b87da1cf267bf6ae9e8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/17/2021
ms.locfileid: "100571904"
---
# <a name="how-to-monitor-cluster-availability-with-azure-monitor-logs-in-hdinsight"></a>Как отслеживать доступность кластера с помощью журналов Azure Monitor в HDInsight

Кластеры HDInsight включают в себя Azure Monitorную интеграцию журналов, которая предоставляет запрашиваемые метрики и журналы, а также настраиваемые оповещения. В этой статье показано, как использовать Azure Monitor для мониторинга кластера.

## <a name="azure-monitor-logs-integration"></a>Интеграция журналов Azure Monitor

Журналы Azure Monitor позволяют собирать и объединять данные, созданные несколькими ресурсами, например кластеры HDInsight, в одном месте для обеспечения единого мониторинга.

В качестве необходимого компонента для хранения собранных данных потребуется Log Analytics рабочей области. Если вы еще не создали его, выполните инструкции здесь: [создание log Analytics рабочей области](../azure-monitor/logs/quick-create-workspace.md).

## <a name="enable-hdinsight-azure-monitor-logs-integration"></a>Включение интеграции журналов Azure Monitor HDInsight

На портале на странице ресурсов кластера HDInsight выберите **Azure Monitor**. Затем выберите **включить** и выберите рабочую область log Analytics в раскрывающемся списке.

![HDInsight Operations Management Suite](media/cluster-availability-monitor-logs/azure-portal-monitoring.png)

По умолчанию агент OMS устанавливается на всех узлах кластера, кроме граничных узлов. Так как на граничных узлах кластера не установлен агент OMS, в Log Analytics по умолчанию отсутствуют данные телеметрии для пограничных узлов.

## <a name="query-metrics-and-logs-tables"></a>Таблицы метрик и журналов запросов

После включения интеграции журналов Azure Monitor (это может занять несколько минут) перейдите к ресурсу **рабочей области log Analytics** и выберите **журналы**.

![Журналы рабочей области Log Analytics](media/cluster-availability-monitor-logs/hdinsight-portal-logs.png)

В журнале перечислены некоторые примеры запросов, например:

| Имя запроса                      | Описание                                                               |
|---------------------------------|---------------------------------------------------------------------------|
| Доступность компьютеров сегодня    | Диаграмма количество компьютеров, отправляющих журналы, каждый час                     |
| Вывод списка пульсов                 | Перечислить все пакеты пульса компьютера за последний час                           |
| Последний пульс каждого компьютера | Отображение последнего пакета пульса, отправленного каждым компьютером                             |
| Недоступные компьютеры           | Список всех известных компьютеров, которые не отправляли пульс за последние 5 часов |
| Уровень доступности               | Вычисление частоты доступности для каждого подключенного компьютера                |

В качестве примера запустите запрос образца " **Частота доступности** ", выбрав **выполнить** в этом запросе, как показано на снимке экрана выше. В результате будет показана частота доступности каждого узла в кластере в процентах. Если вы включили несколько кластеров HDInsight для отправки метрик в ту же рабочую область Log Analytics, вы увидите частоту доступности для всех узлов (за исключением граничных узлов) в отображаемых кластерах.

![Образец запроса "частота доступности журналов Log Analytics рабочей области"](media/cluster-availability-monitor-logs/portal-availability-rate.png)

> [!NOTE]  
> Частота доступности измеряется в течение 24-часового периода, поэтому кластер должен работать в течение как минимум 24 часов, прежде чем будут отображены точные показатели доступности.

Вы можете закрепить эту таблицу на общей информационной панели, щелкнув **закрепить** в правом верхнем углу. Если у вас нет доступных для записи общих панелей мониторинга, вы можете увидеть, как ее создать: [Создание и общий доступ к панелям мониторинга в портал Azure](../azure-portal/azure-portal-dashboards.md#publish-and-share-a-dashboard).

## <a name="azure-monitor-alerts"></a>Оповещения Azure Monitor

Можно также настроить Azure Monitor оповещения, которые будут запускаться, когда значение метрики или результаты запроса соответствуют определенным условиям. Например, создадим оповещение для отправки сообщения электронной почты, когда один или несколько узлов не отправляли пульс в течение 5 часов (т. е. Предполагается, что он недоступен).

В **журналах** запустите образец запроса **недоступные компьютеры** , выбрав **выполнить** в этом запросе, как показано ниже.

![Пример недоступных компьютеров в журналах рабочей области Log Analytics](media/cluster-availability-monitor-logs/portal-unavailable-computers.png)

Если все узлы доступны, этот запрос должен вернуть нулевые результаты. Щелкните **новое правило генерации оповещений** , чтобы начать настройку оповещения для этого запроса.

![Новое правило генерации оповещений для рабочей области Log Analytics](media/cluster-availability-monitor-logs/portal-logs-new-alert-rule.png)

Существует три компонента оповещения: *ресурс* , для которого создается правило (в данном случае это рабочая область log Analytics), *условие* для запуска оповещения и *группы действий* , которые определяют, что произойдет при срабатывании оповещения.
Щелкните **заголовок условия**, как показано ниже, чтобы завершить настройку логики сигнала.

![Условие правила создания предупреждения на портале](media/cluster-availability-monitor-logs/portal-condition-title.png)

Откроется окно **Настройка логики сигнала**.

Задайте раздел **логики оповещения** следующим образом:

*На основе: количество результатов, условие: больше, пороговое значение: 0.*

Поскольку этот запрос возвращает недоступные узлы только в качестве результатов, если число результатов больше 0, предупреждение должно сработать.

В разделе **оценено на основе** задайте **период** и **частоту** в зависимости от частоты проверки на наличие недоступных узлов.

В целях этого оповещения необходимо проверить **период = Frequency.** Дополнительные сведения о периоде, частоте и других параметрах оповещений можно найти [здесь](../azure-monitor/alerts/alerts-unified-log.md#alert-logic-definition).

По завершении настройки логики сигнала нажмите кнопку **Готово** .

![Правило генерации оповещений настраивает логику сигнала](media/cluster-availability-monitor-logs/portal-configure-signal-logic.png)

Если у вас еще нет группы действий, щелкните **создать** в разделе **группы действий** .

![Правило генерации оповещений создает новую группу действий](media/cluster-availability-monitor-logs/portal-create-new-action-group.png)

Откроется **Группа добавить действие**. Выберите **имя группы действий**, **Краткое имя**, **подписку** и **группу ресурсов.** В разделе **действия** выберите **имя действия** и выберите **адрес электронной почты, SMS/Push/Voice** в качестве **типа действия.**

> [!NOTE]
> Существует несколько других действий, которые можно активировать с помощью предупреждения, помимо электронной почты, SMS/Push/Voice, например функции Azure, LogicApp, веб-перехватчика, ITSM и модуля Runbook службы автоматизации. [Подробнее.](../azure-monitor/alerts/action-groups.md#action-specific-information)

Откроется **Электронная почта, SMS, Push/Voice**. Выберите **имя** получателя, **Проверьте** поле адреса **электронной** почты и введите адрес электронной почты, по которому должно быть отправлено оповещение. Нажмите кнопку **ОК** в окне  **Электронная почта, SMS/Push/Voice**, а затем в **группе Добавить действие** , чтобы завершить настройку группы действий.

![Правило генерации оповещений создает группу действий](media/cluster-availability-monitor-logs/portal-add-action-group.png)

После того, как эти колонки будут закрыты, вы увидите группу действий, указанную в разделе **группы действий** . Наконец, заполните раздел **сведения о предупреждении** , введя имя и **Описание** **правила генерации оповещений** и выбрав **серьезность**. Щелкните **создать правило генерации оповещений** , чтобы завершить работу.

![Портал создает окончание правила генерации оповещений](media/cluster-availability-monitor-logs/portal-create-alert-rule-finish.png)

> [!TIP]
> Возможность указывать **серьезность** — это мощный инструмент, который можно использовать при создании нескольких предупреждений. Например, можно создать одно оповещение для вызова предупреждения (уровень серьезности 1), если один головной узел выходит из строя, и другое оповещение, которое вызывает критическое (уровень серьезности 0) в маловероятном случае, если оба головных узла выходят из строя.

При выполнении условия для этого предупреждения будет срабатывать предупреждение, и вы получите сообщение электронной почты со сведениями о предупреждении следующего вида:

![Пример оповещения по электронной почте Azure Monitor](media/cluster-availability-monitor-logs/portal-oms-alert-email.png)

Вы также можете просмотреть все оповещения, которые были запущены, сгруппированные по серьезности, перейдя к **оповещениям** в **рабочей области log Analytics**.

![Оповещения рабочей области Log Analytics](media/cluster-availability-monitor-logs/hdi-portal-oms-alerts.png)

При выборе группирования с уровнем серьезности ( **уровень серьезности 1,** как показано выше) будут показаны записи для всех предупреждений этой серьезности, которые были запущены, как показано ниже:

![Log Analytics рабочей области уровень серьезности одно оповещение](media/cluster-availability-monitor-logs/portal-oms-alerts-sev1.png)

## <a name="next-steps"></a>Дальнейшие шаги

* [Доступность кластера — Apache Ambari](./hdinsight-cluster-availability.md)
* [Использование журналов Azure Monitor](hdinsight-hadoop-oms-log-analytics-tutorial.md)
