---
title: Использование внешних хранилищ метаданных в Azure HDInsight
description: Используйте внешние хранилища метаданных с кластерами Azure HDInsight.
ms.service: hdinsight
ms.topic: how-to
ms.custom: hdinsightactive
ms.date: 08/06/2020
ms.openlocfilehash: d36c8f1f592bbe714a9e31cad8131523049f29ad
ms.sourcegitcommit: 2f9f306fa5224595fa5f8ec6af498a0df4de08a8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/28/2021
ms.locfileid: "98931352"
---
# <a name="use-external-metadata-stores-in-azure-hdinsight"></a>Использование внешних хранилищ метаданных в Azure HDInsight

HDInsight позволяет управлять данными и метаданными с помощью внешних хранилищ данных. Эта функция доступна для баз данных [Apache Hive хранилище метаданных](#custom-metastore), [Apache Oozie хранилище метаданных](#apache-oozie-metastore)и [Apache Ambari](#custom-ambari-db).

Хранилище метаданных Apache Hive в HDInsight является важной частью архитектуры Apache Hadoop. Хранилище метаданных — это центральное хранилище схем. Хранилище метаданных используется другими инструментами для доступа к данным больших данных, такими как Apache Spark, интерактивный запрос (LLAP), Presto или Apache Pig. HDInsight использует базу данных SQL Azure в качестве хранилища метаданных Hive.

![Архитектура хранилища метаданных Hive HDInsight](./media/hdinsight-use-external-metadata-stores/metadata-store-architecture.png)

Есть два способа настроить хранилище метаданных для кластеров HDInsight:

* [Хранилище метаданных по умолчанию](#default-metastore).
* [Пользовательское хранилище метаданных](#custom-metastore)

## <a name="default-metastore"></a>Хранилище метаданных по умолчанию

По умолчанию HDInsight создает хранилище метаданных с каждым типом кластера. Вместо этого можно указать пользовательское хранилище метаданных. При использовании хранилища метаданных по умолчанию учитывайте следующее:

* Дополнительные затраты не требуются. HDInsight создает хранилище метаданных с каждым типом кластера без дополнительных затрат с вашей стороны.

* Каждое хранилище метаданных по умолчанию является частью жизненного цикла кластера. При удалении кластера соответствующее хранилище метаданных и метаданные также удаляются.

* Вы не можете совместно использовать хранилище метаданных по умолчанию с другими кластерами.

* Хранилище метаданных по умолчанию рекомендуется использовать только для простых рабочих нагрузок. Рабочие нагрузки, которые не требуют наличия нескольких кластеров и не требуют сохранения метаданных за пределами жизненного цикла кластера.

> [!IMPORTANT]
> По умолчанию хранилище метаданных предоставляет базу данных SQL Azure с **базовым ограничением DTU уровня 5 (не обновляемым)**. Подходит для базовых целей тестирования. Для больших или рабочих нагрузок рекомендуется переходить на внешний хранилище метаданных.

## <a name="custom-metastore"></a>Пользовательское хранилище метаданных

HDInsight также поддерживает пользовательские хранилища метаданных, которые рекомендуется использовать для кластеров в рабочей среде:

* В качестве хранилища метаданных указывается собственная база данных SQL Azure.

* Жизненный цикл хранилище метаданных не привязан к жизненному циклу кластеров, поэтому вы можете создавать и удалять кластеры без потери метаданных. Метаданные, такие как схемы Hive, сохраняются даже после удаления и повторного создания кластера HDInsight.

* Пользовательское хранилище метаданных позволяет присоединять к этому хранилищу метаданных кластеры различных типов. Например, одно хранилище метаданных может совместно использоваться в кластерах Interactive Query, Hive и Hive в HDInsight.

* Вы платите за стоимость хранилище метаданных (базы данных SQL Azure) в соответствии с выбранным уровнем производительности.

* При необходимости хранилище метаданных можно масштабировать.

* Кластер и внешний хранилище метаданных должны размещаться в одном регионе.

![Вариант использования хранилища метаданных Hive HDInsight](./media/hdinsight-use-external-metadata-stores/metadata-store-use-case.png)

### <a name="create-and-config-azure-sql-database-for-the-custom-metastore"></a>Создание и Настройка базы данных SQL Azure для настраиваемого хранилище метаданных

Создайте или настройте существующую базу данных SQL Azure перед настройкой настраиваемого хранилище метаданных Hive для кластера HDInsight.  Дополнительные сведения см. [в разделе Краткое руководство. Создание отдельной базы данных в базе данных SQL Azure](../azure-sql/database/single-database-create-quickstart.md?tabs=azure-portal).

При создании кластера службе HDInsight необходимо подключиться к внешней хранилище метаданных и проверить учетные данные. Настройте правила брандмауэра базы данных SQL Azure, чтобы разрешить службам и ресурсам Azure доступ к серверу. Включите этот параметр в портал Azure, выбрав **настроить брандмауэр сервера**. Выберите **нет** под разрешающим **доступом к общедоступной сети** и нажмите **кнопку Да** ниже, **чтобы разрешить службам и ресурсам Azure доступ к этому серверу** для базы данных SQL Azure. Дополнительные сведения см. в разделе [Создание правил брандмауэра IP-адресов и управление ими](../azure-sql/database/firewall-configure.md#use-the-azure-portal-to-manage-server-level-ip-firewall-rules) .

Частные конечные точки для хранилищ SQL поддерживаются только в кластерах, созданных с помощью `outbound` ресаурцепровидерконнектион. Дополнительные сведения см. в этой [документации](./hdinsight-private-link.md).

![Кнопка установки брандмауэра сервера](./media/hdinsight-use-external-metadata-stores/configure-azure-sql-database-firewall1.png)

![разрешить доступ к службам Azure](./media/hdinsight-use-external-metadata-stores/configure-azure-sql-database-firewall2.png)

### <a name="select-a-custom-metastore-during-cluster-creation"></a>Выбор пользовательского хранилища метаданных во время создания кластера

Вы можете указать кластеру ранее созданную базу данных SQL Azure в любое время. Для создания кластера на портале этот параметр указывается в параметрах **Storage > хранилище метаданных**.

![Хранилище метаданных Hive HDInsight на портале Azure](./media/hdinsight-use-external-metadata-stores/azure-portal-cluster-storage-metastore.png)

## <a name="hive-metastore-guidelines"></a>Рекомендации по хранилище метаданных Hive

> [!NOTE]
> По возможности используйте пользовательское хранилище метаданных, так как это поможет разделить вычислительные ресурсы в выполняемом кластере и метаданные из хранилища метаданных. Начните с уровня S2, который предоставляет 50 DTU и 250 ГБ хранилища. Если вы видите узкое место, можно увеличить масштаб базы данных.

* Если требуется несколько кластеров HDInsight для доступа к отдельным данным, используйте отдельную базу данных для хранилища метаданных для каждого кластера. Если хранилище метаданных используется совместно в нескольких кластерах HDInsight, это означает, что кластеры используют одинаковые метаданные и базовые файлы данных пользователей.

* Периодически архивируйте пользовательское хранилище метаданных. База данных SQL Azure автоматически создает резервные копии, но период их хранения различается. Дополнительные сведения см. в статье [Подробнее об автоматическом резервном копировании базы данных SQL](../azure-sql/database/automated-backups-overview.md).

* Нахождение кластера хранилище метаданных и HDInsight в одном регионе. Эта конфигурация обеспечит наивысшую производительность и наименьшую плату за исходящий трафик сети.

* Отслеживайте производительность и доступность хранилище метаданных с помощью средств мониторинга базы данных SQL Azure или журналов Azure Monitor.

* При создании новой, более поздней версии Azure HDInsight для существующей пользовательской базы данных хранилище метаданных система обновляет схему хранилище метаданных. Обновление необратимо без восстановления базы данных из резервной копии.

* Если вы совместно используете хранилище метаданных в нескольких кластерах, убедитесь, что все кластеры имеют одну и ту же версию HDInsight. Различные версии Hive используют разные версии базы данных хранилища метаданных. Например, нельзя совместно использовать хранилище метаданных в кластерах Hive 2,1 и Hive 3,1 с версиями.

* В HDInsight 4.0 Spark и Hive используют независимые каталоги для доступа к таблицам SparkSQL или Hive. Таблица, созданная Spark, находится в каталоге Spark. Таблица, созданная Hive, находится в каталоге Hive. Такое поведение отличается от версии HDInsight 3.6, где Hive и Spark совместно использовали общий каталог. Интеграция Hive и Spark в HDInsight 4.0 основана на соединителе Hive Warehouse Connector (HWC). HWC работает как мост между Spark и Hive. [Сведения о соединителе хранилища Hive](../hdinsight/interactive-query/apache-hive-warehouse-connector.md).

* В HDInsight 4.0 можно настроить совместное использование хранилища метаданных для Hive и Spark, указав для свойства хранилища metastore.catalog.default значение hive в кластере Spark. Это свойство можно найти в Ambari Advanced spark2-hive-site-override. Важно понимать, что совместное использование хранилища метаданных работает только для внешних таблиц Hive, но не для внутренних или управляемых таблиц Hive или таблиц ACID.  

## <a name="apache-oozie-metastore"></a>Хранилище метаданных Apache Oozie

Apache Oozie — это система координации рабочих процессов, которая управляет заданиями Hadoop. Эта система поддерживает задания Hadoop для Apache MapReduce, Pig, Hive и т. д.  Oozie использует хранилище метаданных для хранения сведений о рабочих процессах. Для повышения производительности Oozie можно использовать Базу данных SQL Azure в качестве хранилища метаданных. Хранилище метаданных предоставляет доступ к данным задания Oozie после удаления кластера.

Дополнительные инструкции по созданию хранилища метаданных Oozie с базой данных SQL Azure см. в статье [Использование Oozie с Hadoop для определения и запуска рабочих процессов в Azure HDInsight под управлением Linux](hdinsight-use-oozie-linux-mac.md).

## <a name="custom-ambari-db"></a>Пользовательская база данных Ambari DB

Сведения о том, как использовать собственную внешнюю базу данных с Apache Ambari в HDInsight, см. в статье [пользовательские базы данных Apache Ambari](hdinsight-custom-ambari-db.md).

## <a name="next-steps"></a>Дальнейшие действия

* [Установка кластеров в HDInsight с использованием Apache Hadoop, Apache Spark, Apache Kafka и других технологий](./hdinsight-hadoop-provision-linux-clusters.md)