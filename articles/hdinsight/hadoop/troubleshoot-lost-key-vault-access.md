---
title: Кластеры Azure HDInsight с шифрованием дисков теряют Key Vault доступ
description: Действия по устранению неполадок и возможные способы устранения проблем с Key Vault доступом при взаимодействии с кластерами Azure HDInsight.
ms.service: hdinsight
ms.topic: troubleshooting
ms.date: 01/30/2020
ms.openlocfilehash: ce2929ca84746de1ab8b51882f3004c3699f17ca
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "98943110"
---
# <a name="scenario-azure-hdinsight-clusters-with-disk-encryption-lose-key-vault-access"></a>Сценарий. потеря доступа к кластерам Azure HDInsight с шифрованием диска Key Vault доступ

В этой статье описываются действия по устранению неполадок и возможные способы решения проблем при взаимодействии с кластерами Azure HDInsight.

## <a name="issue"></a>Проблема

Предупреждение Работоспособность ресурсов Center (RHC) `The HDInsight cluster is unable to access the key for BYOK encryption at rest` отображается для кластеров создание собственных ключей (BYOK), в которых узлы кластера потеряют доступ к клиентам Key Vault (KV). Аналогичные предупреждения также можно увидеть в пользовательском интерфейсе Apache Ambari.

## <a name="cause"></a>Причина

Предупреждение гарантирует, что KV будет доступен с узлов кластера, таким образом обеспечивая подключение к сети, работоспособность KV и политику доступа для управляемого удостоверения, назначенного пользователем. Это оповещение является лишь предупреждением о некотором завершении работы компонента Service Broker при последующих перезагрузках узла. работа кластера будет продолжаться до перезагрузки узлов.

Перейдите к пользовательскому интерфейсу Apache Ambari, чтобы получить дополнительные сведения о предупреждении, связанные с **шифрованием диска Key Vault состояние**. Это оповещение будет содержать подробные сведения о причине сбоя проверки.

## <a name="resolution"></a>Решение

### <a name="kvaad-outage"></a>Сбой KV/AAD

Дополнительные сведения см. на странице [Azure Key Vault доступность и избыточность](../../key-vault/general/disaster-recovery-guidance.md) и состояние Azure. https://status.azure.com/

### <a name="kv-accidental-deletion"></a>Случайное удаление KV

* Восстановление удаленного ключа в KV для автоматического восстановления. Дополнительные сведения см. в разделе [Восстановление удаленного ключа](/rest/api/keyvault/recoverdeletedkey).
* Чтобы восстановиться после случайных удалений, обратитесь к команде KV.

### <a name="kv-access-policy-changed"></a>Политика доступа KV изменена

Восстановите политики доступа для назначенного пользователю управляемого удостоверения, назначенного кластеру HDI для доступа к KV.

### <a name="key-permitted-operations"></a>Разрешенные операции с ключом

Для каждого ключа в KV можно выбрать набор разрешенных операций. Убедитесь, что для ключа BYOK включены операции переноса и распаковки.

### <a name="expired-key"></a>Ключ с истекшим сроком действия

Если срок действия истек, а ключ не был повернут, восстановите ключ из модуля резервного копирования HSM или обратитесь в службу KV, чтобы очистить дату окончания срока действия.

### <a name="kv-firewall-blocking-access"></a>KV доступ блокировки брандмауэра

Исправьте параметры брандмауэра KV, чтобы разрешить узлам кластера BYOK доступ к KV.

### <a name="nsg-rules-on-virtual-network-blocking-access"></a>Правила NSG для блокировки доступа к виртуальной сети

Проверьте правила NSG, связанные с виртуальной сетью, подключенной к кластеру.

## <a name="mitigation-and-prevention-steps"></a>Действия по устранению и предотвращению устранения проблем

### <a name="kv-accidental-deletion"></a>Случайное удаление KV

* Настройка Key Vault с [набором блокировок ресурсов](../../azure-resource-manager/management/lock-resources.md).
* Резервное копирование ключей в аппаратный модуль безопасности.

### <a name="key-deletion"></a>Удаление ключей

Перед удалением ключа кластер должен быть удален.

### <a name="kv-access-policy-changed"></a>Политика доступа KV изменена

Регулярное тестирование политик аудита и доступа.

### <a name="expired-key"></a>Ключ с истекшим сроком действия

* Резервное копирование ключей в HSM.
* Используйте ключ без указания срока действия.
* Если необходимо задать срок действия, поворачивайте ключи до даты окончания срока действия.

## <a name="next-steps"></a>Дальнейшие действия

Если вы не видите своего варианта проблемы или вам не удается ее устранить, дополнительные сведения можно получить, посетив один из следующих каналов.

* Получите ответы специалистов Azure на [сайте поддержки сообщества пользователей Azure](https://azure.microsoft.com/support/community/).

* Подпишитесь на [@AzureSupport](https://twitter.com/azuresupport) — официальный канал Microsoft Azure для работы с клиентами. Вступайте в сообщество Azure для получения нужных ресурсов: ответов, поддержки и советов экспертов.

* Если вам нужна дополнительная помощь, отправьте запрос в службу поддержки на [портале Azure](https://portal.azure.com/?#blade/Microsoft_Azure_Support/HelpAndSupportBlade/). Выберите **Поддержка** в строке меню или откройте центр **Справка и поддержка**. Дополнительные сведения см. в статье [Создание запроса на поддержку Azure](../../azure-portal/supportability/how-to-create-azure-support-request.md). Доступ к управлению подписками и поддержкой выставления счетов уже включен в вашу подписку Microsoft Azure, а техническая поддержка предоставляется в рамках одного из [планов Службы поддержки Azure](https://azure.microsoft.com/support/plans/).