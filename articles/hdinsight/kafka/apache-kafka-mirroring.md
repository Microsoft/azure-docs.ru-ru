---
title: Зеркальное отображение разделов Apache Kafka в Azure HDInsight
description: Узнайте, как использовать функцию зеркального отображения Apache Kafka, чтобы сохранить реплику Kafka в кластере HDInsight, создав зеркальную копию разделов во вторичном кластере.
ms.service: hdinsight
ms.topic: how-to
ms.custom: hdinsightactive
ms.date: 11/29/2019
ms.openlocfilehash: c2fce6d4ee95a56cc087d50184fcd69ac113620f
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "98940843"
---
# <a name="use-mirrormaker-to-replicate-apache-kafka-topics-with-kafka-on-hdinsight"></a>Репликация разделов Apache Kafka с помощью Kafka в HDInsight и MirrorMaker

Узнайте, как реплицировать разделы во вторичный кластер с помощью функции зеркального отображения Apache Kafka. Зеркальное отображение можно запустить как непрерывный процесс или периодически использовать для переноса данных из одного кластера в другой.

> [!NOTE]
> Эта статья содержит ссылки на термин *список разрешений*. Корпорация Майкрософт больше не использует его. Когда этот термин будет удален из программного обеспечения, мы удалим его из статьи.

В этом примере зеркальное отображение используется для репликации разделов между двумя кластерами HDInsight. Оба кластера находятся в разных виртуальных сетях в разных центрах обработки данных.

> [!WARNING]  
> Зеркальное отображение нельзя рассматривать как средство обеспечения отказоустойчивости. Смещение элементов внутри раздела отличается между основным и дополнительным кластерами, поэтому клиенты не могут использовать эти два взаимозаменяемости.
>
> Если вас интересует отказоустойчивость, настройте репликацию для разделов в пределах кластера. Дополнительные сведения см. в статье по [началу работы с Apache Kafka в HDInsight](apache-kafka-get-started.md).

## <a name="how-apache-kafka-mirroring-works"></a>Как работает зеркальное отображение Apache Kafka

Зеркальное отображение работает с помощью средства [MirrorMaker](https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=27846330) (входит в состав Apache Kafka), чтобы использовать записи из разделов основного кластера, а затем создать локальную копию на дополнительном кластере. MirrorMaker использует одного (или нескольких) *потребителей* , считывающих данные из основного кластера, и *производитель* , записывающий данные в локальный (дополнительный) кластер.

Наиболее полезная настройка зеркального отображения для аварийного восстановления использует кластеры Kafka в разных регионах Azure. Для этого виртуальные сети, в которых находятся кластеры, равноправны друг с другом.

На следующей схеме показан процесс зеркального отображения и обмен данными между кластерами.

![Схема процесса зеркального отображения](./media/apache-kafka-mirroring/kafka-mirroring-vnets2.png)

Основной и дополнительный кластеры могут отличаться в количестве узлов и секций, а смещения в разделах также отличаются. Зеркальное отображение сохраняет значение ключа, который используется для секционирования, поэтому порядок записей сохраняется вместе с этими значениями.

### <a name="mirroring-across-network-boundaries"></a>Зеркальное отображение в пределах сети

Чтобы реализовать зеркальное отображение между кластерами Kafka в разных сетях, следует учитывать следующее.

* **Шлюзы**. сети должны иметь возможность взаимодействия на уровне TCP/IP.

* **Серверная адресация**. Вы можете выбрать адреса узлов кластера, используя их IP-адреса или полные доменные имена.

    * **IP-адреса**. Если вы настраиваете кластеры Kafka для использования объявления IP-адресов, можно продолжить установку зеркального отображения, используя IP-адреса узлов брокера и узлов Zookeeper.
    
    * **Доменные имена**. Если вы не настраиваете кластеры Kafka для объявления IP-адресов, кластеры должны иметь возможность подключения друг к другу с помощью полных доменных имен (FQDN). Для этого требуется сервер службы доменных имен (DNS) в каждой сети, настроенной на пересылку запросов в другие сети. При создании виртуальной сети Azure вместо использования автоматического DNS, предоставленного сетью, необходимо указать пользовательские DNS-сервер и IP-адрес для сервера. Когда виртуальная сеть будет готова, создайте виртуальную машину Azure, использующую этот IP-адрес, а затем установите и настройте на ней программное обеспечение DNS.

    > [!WARNING]  
    > Создайте и настройте пользовательский DNS-сервер, прежде чем устанавливать HDInsight в виртуальной сети. HDInsight не нужно дополнительно настраивать для использования DNS-сервера, настроенного для виртуальной сети.

Дополнительные сведения о подключении двух виртуальных сетей Azure см. в статье [Настройка подключения между виртуальными сетями в развертывании Resource Manager с помощью PowerShell](../../vpn-gateway/vpn-gateway-vnet-vnet-rm-ps.md).

## <a name="mirroring-architecture"></a>Архитектура зеркального отображения

Эта архитектура включает в себя два кластера в разных группах ресурсов и виртуальных сетях: **первичный** и **вторичный**.

### <a name="creation-steps"></a>Шаги создания

1. Создайте две новые группы ресурсов:

    |Группа ресурсов | Расположение |
    |---|---|
    | Kafka-PRIMARY-RG | Центральная часть США |
    | Kafka-Secondary-RG | Центрально-северная часть США |

1. Создайте новую виртуальную сеть **Kafka-PRIMARY-vnet** в **Kafka-PRIMARY-RG**. Оставьте параметры по умолчанию.
1. Создайте новую виртуальную сеть **Kafka-Secondary-vnet** в **Kafka-Secondary-RG**, а также с параметрами по умолчанию.

1. Создайте два новых кластера Kafka:

    | Имя кластера | Группа ресурсов | Виртуальная сеть | Учетная запись хранения |
    |---|---|---|---|
    | Kafka — основной кластер | Kafka-PRIMARY-RG | Kafka-PRIMARY-vnet | кафкапримаристораже |
    | Kafka — дополнительный — кластер | Kafka-Secondary-RG | Kafka-Secondary-vnet | кафкасекондаристораже |

1. Создайте пиринг виртуальных сетей. На этом шаге будет создано два пиринга: один из **Kafka-PRIMARY-vnet** в **Kafka-Secondary-vnet** и один назад из **Kafka-Secondary-vnet** в **Kafka-PRIMARY-vnet**.
    1. Выберите виртуальную сеть **Kafka-PRIMARY-vnet** .
    1. Выберите **пиринг** в разделе **Параметры**.
    1. Выберите **Добавить**.
    1. На экране **Добавить пиринг** введите сведения, как показано на снимке экрана ниже.

        ![Добавление пиринга виртуальной сети HDInsight Kafka](./media/apache-kafka-mirroring/hdi-add-vnet-peering.png)

### <a name="configure-ip-advertising"></a>Настройка объявления IP-адресов

Настройте объявления IP-адресов, чтобы разрешить клиенту подключаться по IP-адресам компонента Service Broker вместо доменных имен.

1. Перейдите на панель мониторинга Ambari для основного кластера: `https://PRIMARYCLUSTERNAME.azurehdinsight.net` .
1. Выберите **службы**  >  **Kafka**. Клиселекткк на вкладке **конфигурации** .
1. Добавьте следующие строки конфигурации в нижнюю часть **шаблона Kafka-env** . Щелкните **Сохранить**.

    ```
    # Configure Kafka to advertise IP addresses instead of FQDN
    IP_ADDRESS=$(hostname -i)
    echo advertised.listeners=$IP_ADDRESS
    sed -i.bak -e '/advertised/{/advertised@/!d;}' /usr/hdp/current/kafka-broker/conf/server.properties
    echo "advertised.listeners=PLAINTEXT://$IP_ADDRESS:9092" >> /usr/hdp/current/kafka-broker/conf/server.properties
    ```

1. Введите примечание на экране **сохранения конфигурации** и нажмите кнопку **сохранить**.
1. Если появится предупреждение о настройке, нажмите кнопку **продолжить**.
1. Нажмите кнопку **ОК** в области **сохранить изменения конфигурации**.
1. Выберите **перезапустить**  >  **все, затронутое** в уведомлении **требуется перезагрузка** . Выберите пункт **подтвердить перезагрузку все**.

    ![Apache Ambari перезапускает все затронутые](./media/apache-kafka-mirroring/ambari-restart-notification.png)

### <a name="configure-kafka-to-listen-on-all-network-interfaces"></a>Настройте Kafka для прослушивания всех сетевых интерфейсов.
    
1. Оставайтесь на вкладке **конфигурации** в разделе **службы**  >  **Kafka**. В разделе **брокера Kafka** задайте для свойства **Listeners** значение `PLAINTEXT://0.0.0.0:9092` .
1. Щелкните **Сохранить**.
1. Выберите **перезапустить** и **Подтвердите перезапустить все**.

### <a name="record-broker-ip-addresses-and-zookeeper-addresses-for-primary-cluster"></a>IP-адреса брокера записи и адреса Zookeeper для основного кластера.

1. Выберите **узлы** на панели мониторинга Ambari.
1. Запишите IP-адреса для брокеров и Zookeeper. Узлы брокера **WN** первыми двумя буквами имени узла, а узлы Zookeeper имеют **ZK** в качестве первых двух букв имени узла.

    ![IP-адреса узла представления Apache Ambari](./media/apache-kafka-mirroring/view-node-ip-addresses2.png)

1. Повторите предыдущие три шага для второго кластера **Kafka-вторичного кластера**: Настройте объявления IP-адресов, настройте прослушиватели и запишите IP-адреса брокера и Zookeeper.

## <a name="create-topics"></a>Создание разделов

1. Подключитесь к **основному** кластеру по протоколу SSH:

    ```bash
    ssh sshuser@PRIMARYCLUSTER-ssh.azurehdinsight.net
    ```

    Замените **sshuser** именем пользователя SSH, которое использовалось при создании кластера. Замените **примариклустер** базовым именем, используемым при создании кластера.

    См. дополнительные сведения об [использовании SSH в HDInsight](../hdinsight-hadoop-linux-use-ssh-unix.md).

1. Используйте следующую команду, чтобы создать переменную с узлами Apache Zookeeper для основного кластера. Строки, такие как `ZOOKEEPER_IP_ADDRESS1` , должны быть заменены фактическими IP-адресами, записанными ранее, например `10.23.0.11` и `10.23.0.7` . Если вы используете разрешение полного доменного имени для настраиваемого DNS-сервера, выполните следующие [действия](apache-kafka-get-started.md#getkafkainfo) , чтобы получить имена брокера и Zookeeper.:

    ```bash
    # get the zookeeper hosts for the primary cluster
    export PRIMARY_ZKHOSTS='ZOOKEEPER_IP_ADDRESS1:2181, ZOOKEEPER_IP_ADDRESS2:2181, ZOOKEEPER_IP_ADDRESS3:2181'
    ```

1. Создайте раздел с именем `testtopic` с помощью следующей команды:

    ```bash
    /usr/hdp/current/kafka-broker/bin/kafka-topics.sh --create --replication-factor 2 --partitions 8 --topic testtopic --zookeeper $PRIMARY_ZKHOSTS
    ```

1. С помощью этой команды проверьте, создан ли раздел:

    ```bash
    /usr/hdp/current/kafka-broker/bin/kafka-topics.sh --list --zookeeper $PRIMARY_ZKHOSTS
    ```

    Ответ содержит `testtopic`.

1. Чтобы просмотреть сведения об узле Zookeeper для этого ( **основного**) кластера, используйте следующую команду:

    ```bash
    echo $PRIMARY_ZKHOSTS
    ```

    Эта команда возвращает следующую информацию:

    `10.23.0.11:2181,10.23.0.7:2181,10.23.0.9:2181`

    Сохраните эти сведения. Он используется в следующем разделе.

## <a name="configure-mirroring"></a>Настройка зеркального отображения

1. Подключитесь к **дополнительному** кластеру с помощью другого сеанса SSH:

    ```bash
    ssh sshuser@SECONDARYCLUSTER-ssh.azurehdinsight.net
    ```

    Замените **sshuser** именем пользователя SSH, которое использовалось при создании кластера. Замените **секондариклустер** именем, используемым при создании кластера.

    См. дополнительные сведения об [использовании SSH в HDInsight](../hdinsight-hadoop-linux-use-ssh-unix.md).

1. `consumer.properties`Файл используется для настройки связи с **основным** кластером. Чтобы создать файл, используйте следующую команду:

    ```bash
    nano consumer.properties
    ```

    Добавьте в файл `consumer.properties` следующее содержимое:

    ```yaml
    zookeeper.connect=PRIMARY_ZKHOSTS
    group.id=mirrorgroup
    ```

    Замените **PRIMARY_ZKHOSTS** IP-адресами Zookeeper из **основного** кластера.

    Этот файл описывает сведения о потребителе, используемые при чтении из основного кластера Kafka. Дополнительные сведения о конфигурации получателя см. в [этом разделе](https://kafka.apache.org/documentation#consumerconfigs) на сайте kafka.apache.org.

    Чтобы сохранить файл, нажмите клавиши **CTRL+X**, затем — **Y** и **ВВОД**.

1. Перед настройкой производителя, который обменивается данными с дополнительным кластером, настройте переменную для IP-адресов брокера **вторичного** кластера. Для создания этой переменной используйте следующие команды:

    ```bash
    export SECONDARY_BROKERHOSTS='BROKER_IP_ADDRESS1:9092,BROKER_IP_ADDRESS2:9092,BROKER_IP_ADDRESS2:9092'
    ```

    Команда `echo $SECONDARY_BROKERHOSTS` должна вернуть информацию, подобную приведенной ниже:

    `10.23.0.14:9092,10.23.0.4:9092,10.23.0.12:9092`

1. `producer.properties`Файл используется для связи с **дополнительным** кластером. Чтобы создать файл, используйте следующую команду:

    ```bash
    nano producer.properties
    ```

    Добавьте в файл `producer.properties` следующее содержимое:

    ```yaml
    bootstrap.servers=SECONDARY_BROKERHOSTS
    compression.type=none
    ```

    Замените **SECONDARY_BROKERHOSTS** IP-адресами брокера, которые использовались на предыдущем шаге.

    Дополнительные сведения о конфигурации производителя см. в [этом разделе](https://kafka.apache.org/documentation#producerconfigs) на сайте kafka.apache.org.

1. Используйте следующие команды, чтобы создать переменную среды с IP-адресами узлов Zookeeper для вторичного кластера:

    ```bash
    # get the zookeeper hosts for the secondary cluster
    export SECONDARY_ZKHOSTS='ZOOKEEPER_IP_ADDRESS1:2181,ZOOKEEPER_IP_ADDRESS2:2181,ZOOKEEPER_IP_ADDRESS3:2181'
    ```

1. Конфигурация по умолчанию для Kafka в HDInsight не позволяет автоматически создавать разделы. Прежде чем начать процесс зеркального отображения, используйте один из следующих параметров:

    * **Создание разделов в дополнительном кластере**. Этот параметр также позволяет задать количество секций и коэффициент репликации.

        Вы можете создать разделы заранее, выполнив следующую команду:

        ```bash
        /usr/hdp/current/kafka-broker/bin/kafka-topics.sh --create --replication-factor 2 --partitions 8 --topic testtopic --zookeeper $SECONDARY_ZKHOSTS
        ```

        Замените `testtopic` именем создаваемого раздела.

    * **Настроить кластер для автоматического создания раздела**: этот параметр позволяет MirrorMaker автоматически создавать разделы, однако он может создавать их с другим количеством разделов или фактором репликации, чем в основном разделе.

        Чтобы настроить дополнительный кластер для автоматического создания разделов, выполните следующие действия.

        1. Перейдите на панель мониторинга Ambari для дополнительного кластера: `https://SECONDARYCLUSTERNAME.azurehdinsight.net` .
        1. Щелкните **службы**  >  **Kafka**. Выберите вкладку **Configs** (Конфигурации).
        1. В поле __фильтра__ введите значение `auto.create` . Будет отфильтрован список свойств и отобразится параметр `auto.create.topics.enable`.
        1. Измените значение параметра `auto.create.topics.enable` на true и выберите __Сохранить__. Добавьте заметку, а затем нажмите кнопку __сохранить__ еще раз.
        1. Выберите службу __Kafka__ , нажмите кнопку __перезапустить__, а затем выберите __перезапустить все затронутые__. При появлении запроса выберите __Подтверждение перезапустить все__.

        ![разделы включения автоматического создания Kafka](./media/apache-kafka-mirroring/kafka-enable-auto-create-topics.png)

## <a name="start-mirrormaker"></a>Запуск MirrorMaker

1. Чтобы запустить процесс MirrorMaker, в SSH-подключении к **дополнительному** кластеру выполните следующую команду:

    ```bash
    /usr/hdp/current/kafka-broker/bin/kafka-run-class.sh kafka.tools.MirrorMaker --consumer.config consumer.properties --producer.config producer.properties --whitelist testtopic --num.streams 4
    ```

    В этом примере используются следующие параметры.

    |Параметр |Описание |
    |---|---|
    |--consumer.config|указывает файл, который содержит свойства получателя. Эти свойства используются для создания объекта-получателя, считывающего данные из *основного* кластера Kafka.|
    |--producer.config|указывает файл, который содержит свойства производителя. Эти свойства используются для создания производителя, записывающего данные в *дополнительный* кластер Kafka.|
    |--список разрешений|Список разделов, MirrorMaker репликацию из основного кластера на сервер-получатель.|
    |--num. Streams|число создаваемых потоков получателя.|

    Потребитель на вторичном узле ожидает получения сообщений.

2. Из SSH-подключения к **основному** кластеру используйте следующую команду для запуска производителя и отправки сообщений в раздел:

    ```bash
    export PRIMARY_BROKERHOSTS=BROKER_IP_ADDRESS1:9092,BROKER_IP_ADDRESS2:9092,BROKER_IP_ADDRESS2:9092
    /usr/hdp/current/kafka-broker/bin/kafka-console-producer.sh --broker-list $SOURCE_BROKERHOSTS --topic testtopic
    ```

     При переходе в пустую строку с курсором введите несколько текстовых сообщений. Сообщения отправляются в раздел **основного** кластера. По завершении нажмите клавиши **Ctrl+C**, чтобы завершить процесс производителя.

3. С помощью SSH-подключения к **дополнительному** кластеру нажмите **клавиши CTRL + C** , чтобы завершить процесс MirrorMaker. Завершение этого процесса может занять несколько секунд. Чтобы убедиться, что сообщения были реплицированы на сервер-получатель, используйте следующую команду:

    ```bash
    /usr/hdp/current/kafka-broker/bin/kafka-console-consumer.sh --bootstrap-server $SECONDARY_ZKHOSTS --topic testtopic --from-beginning
    ```

    Список разделов теперь включает `testtopic` , который создается, когда миррормастер дублирует раздел из основного кластера на сервер-получатель. Сообщения, полученные из раздела, совпадают с теми, которые были введены в основном кластере.

## <a name="delete-the-cluster"></a>Удаление кластера

[!INCLUDE [delete-cluster-warning](../../../includes/hdinsight-delete-cluster-warning.md)]

Действия, описанные в этом документе, создали кластеры в разных группах ресурсов Azure. Чтобы удалить все созданные ресурсы, можно удалить две созданные группы ресурсов: **Kafka-PRIMARY-RG** и **Kafka-secondary_rg**. При удалении групп ресурсов удаляются все ресурсы, созданные в следующем документе, включая кластеры, виртуальные сети и учетные записи хранения.

## <a name="next-steps"></a>Дальнейшие действия

Из этого документа вы узнали, как создать реплику кластера [Apache Kafka](https://kafka.apache.org/) с помощью [MirrorMaker](https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=27846330). Другие материалы, посвященные работе с Kafka, доступны по следующим ссылкам:

* [Документация по Apache Kafka MirrorMaker](https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=27846330) на сайте cwiki.apache.org.
* [Рекомендации для Kafka Mirror Maker](https://community.cloudera.com/t5/Community-Articles/Kafka-Mirror-Maker-Best-Practices/ta-p/249269)
* [Get started with Apache Kafka on HDInsight (preview)](apache-kafka-get-started.md) (Приступая к работе с Apache Kafka в HDInsight (предварительная версия))
* [Использование Apache Spark с Apache Kafka в HDInsight](../hdinsight-apache-spark-with-kafka.md)
* [Подключение к Apache Kafka с помощью виртуальной сети Azure](apache-kafka-connect-vpn-gateway.md)
