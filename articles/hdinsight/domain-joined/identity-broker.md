---
title: Брокер ИДЕНТИФИКАТОРов Azure HDInsight (ХИБ)
description: Сведения об Azure HDInsight ID Broker для упрощения проверки подлинности присоединенных к домену кластеров Apache Hadoop.
ms.service: hdinsight
ms.topic: how-to
ms.date: 11/03/2020
ms.openlocfilehash: 47ba11260c3b58566963e5a3ffac80ca461a8a23
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "98946819"
---
# <a name="azure-hdinsight-id-broker-hib"></a>Брокер ИДЕНТИФИКАТОРов Azure HDInsight (ХИБ)

В этой статье описывается, как настроить и использовать компонент брокера ИДЕНТИФИКАТОРов Azure HDInsight. Эту функцию можно использовать для получения современной проверки подлинности OAuth в Apache Ambari с применением многофакторной проверки подлинности без использования хэшей паролей прежних версий в Azure Active Directory доменных служб (Azure AD DS).

## <a name="overview"></a>Обзор

Брокер ИДЕНТИФИКАТОРов HDInsight упрощает сложные настройки проверки подлинности в следующих сценариях:

* Ваша организация полагается на Федерацию для проверки подлинности пользователей при доступе к облачным ресурсам. Ранее для использования кластеров HDInsight Корпоративный пакет безопасности необходимо было включить синхронизацию хэша паролей из локальной среды для Azure Active Directory (Azure AD). Это требование может быть затруднительным или нежелательным для некоторых организаций.
* Ваша организация хочет обеспечить многофакторную проверку подлинности для доступа к Apache Ambari и другим ресурсам на основе HTTP.

Брокер ИДЕНТИФИКАТОРов HDInsight предоставляет инфраструктуру проверки подлинности, которая позволяет переходить по протоколу OAuth (современный) в Kerberos (устаревший) без необходимости синхронизации хэшей паролей с Azure AD DS. Эта инфраструктура состоит из компонентов, работающих на виртуальной машине Windows Server с включенным узлом брокера ИДЕНТИФИКАТОРов HDInsight, а также узлами шлюза кластера.

Используйте следующую таблицу, чтобы определить оптимальный вариант проверки подлинности в зависимости от потребностей вашей организации.

|Параметры проверки подлинности |Конфигурация HDInsight | Факторы, которые следует учитывать |
|---|---|---|
| Полное OAuth | Брокер ИДЕНТИФИКАТОРов Корпоративный пакет безопасности + HDInsight | Наиболее безопасный вариант. (Поддерживается многофакторная проверка подлинности.) Передача хэш-синхронизации *не* требуется. Нет доступа SSH/kinit/keytab для локальных учетных записей, у которых нет хэша пароля в Azure AD DS. Только облачные учетные записи по-прежнему могут SSH/kinit/keytab. Веб-доступ к Ambari через OAuth. Требует обновления устаревших приложений (например, JDBC/ODBC) для поддержки OAuth.|
| Аутентификация OAuth + обычная проверка подлинности | Брокер ИДЕНТИФИКАТОРов Корпоративный пакет безопасности + HDInsight | Веб-доступ к Ambari через OAuth. Устаревшие приложения продолжают использовать обычную проверку подлинности. Многофакторная проверка подлинности должна быть отключена для базового доступа с проверкой подлинности. Передача хэш-синхронизации *не* требуется. Нет доступа SSH/kinit/keytab для локальных учетных записей, у которых нет хэша пароля в Azure AD DS. Только облачные учетные записи по-прежнему могут быть SSH/kinit. |
| Полностью базовая проверка подлинности | Корпоративный пакет безопасности | Наиболее похоже на локальные установки. Требуется синхронизация хэша паролей с Azure AD DS. Локальные учетные записи могут использовать SSH/kinit или keytab. Многофакторная проверка подлинности должна быть отключена, если резервное хранилище Azure Data Lake Storage 2-го поколенияо. |

На следующей схеме показана современная последовательность проверки подлинности на основе OAuth для всех пользователей, включая федеративных пользователей, после включения брокера ИДЕНТИФИКАТОРов HDInsight:

:::image type="content" source="media/identity-broker/identity-broker-architecture.png" alt-text="Схема, показывающая поток проверки подлинности с помощью брокера ИДЕНТИФИКАТОРов HDInsight.":::

На этой схеме клиент (то есть браузер или приложение) должен сначала получить маркер OAuth. Затем он представляет маркер шлюзу в HTTP-запросе. Если вы уже вошли в другие службы Azure, такие как портал Azure, вы можете войти в кластер HDInsight с помощью единого входа.

По-прежнему может быть несколько устаревших приложений, поддерживающих только обычную проверку подлинности (то есть имя пользователя и пароль). Для этих сценариев по-прежнему можно использовать обычную проверку подлинности HTTP для подключения к шлюзам кластера. В этой настройке необходимо обеспечить сетевое подключение между узлами шлюза с конечной точкой службы федерации Active Directory (AD FS) (AD FS), чтобы обеспечить прямую отправку информации из узлов шлюза.

На следующей схеме показана обычная последовательность проверки подлинности для федеративных пользователей. Сначала шлюз пытается выполнить проверку подлинности с помощью [ропк Flow](../../active-directory/develop/v2-oauth-ropc.md). Если в Azure AD не синхронизированы хэши паролей, то возвращается обнаружение конечной точки AD FS и завершает проверку подлинности путем доступа к конечной точке AD FS.

:::image type="content" source="media/identity-broker/basic-authentication.png" alt-text="Схема, на которой показана архитектура с обычной проверкой подлинности.":::


## <a name="enable-hdinsight-id-broker"></a>Включение брокера ИДЕНТИФИКАТОРов HDInsight

Чтобы создать кластер Корпоративный пакет безопасности с включенным компонентом "брокер ИДЕНТИФИКАТОРов HDInsight", выполните следующие действия.

1. Войдите на [портал Azure](https://portal.azure.com).
1. Выполните базовые действия по созданию кластера Корпоративный пакет безопасности. Дополнительные сведения см. в статье [Создание кластера HDInsight с корпоративный пакет безопасности](apache-domain-joined-configure-using-azure-adds.md#create-an-hdinsight-cluster-with-esp).
1. Выберите **включить брокер идентификаторов HDInsight**.

Функция брокера ИДЕНТИФИКАТОРов HDInsight добавляет в кластер одну лишнюю виртуальную машину. Эта виртуальная машина — это узел брокера ИДЕНТИФИКАТОРов HDInsight, который включает серверные компоненты для поддержки проверки подлинности. Узел брокера ИДЕНТИФИКАТОРов HDInsight — это домен, присоединенный к домену Azure AD DS.

![Схема, на которой показан параметр включения брокера ИДЕНТИФИКАТОРов HDInsight.](./media/identity-broker/identity-broker-enable.png)

### <a name="use-azure-resource-manager-templates"></a>Использование шаблонов Azure Resource Manager

Если вы добавите новую роль `idbrokernode` со следующими атрибутами в профиль вычислений шаблона, кластер будет создан с включенным узлом брокера идентификаторов HDInsight:

```json
.
.
.
"computeProfile": {
    "roles": [
        {
            "autoscale": null,
            "name": "headnode",
           ....
        },
        {
            "autoscale": null,
            "name": "workernode",
            ....
        },
        {
            "autoscale": null,
            "name": "idbrokernode",
            "targetInstanceCount": 2,
            "hardwareProfile": {
                "vmSize": "Standard_A2_V2"
            },
            "virtualNetworkProfile": {
                "id": "string",
                "subnet": "string"
            },
            "scriptActions": [],
            "dataDisksGroups": null
        }
    ]
}
.
.
.
```

Полный пример шаблона ARM см. в шаблоне, опубликованном [здесь](https://github.com/Azure-Samples/hdinsight-enterprise-security/tree/main/ESP-HIB-PL-Template).


## <a name="tool-integration"></a>Интеграция средств

Средства HDInsight обновлены для встроенной поддержки OAuth. Используйте эти средства для современного доступа на основе OAuth к кластерам. [Подключаемый модуль HDInsight IntelliJ](../spark/apache-spark-intellij-tool-plugin.md#integrate-with-hdinsight-identity-broker-hib) можно использовать для приложений на основе Java, таких как Scala. [Средства Spark и Hive для Visual Studio Code](../hdinsight-for-vscode.md) можно использовать для заданий PySpark и Hive. Эти средства поддерживают как пакетные, так и Интерактивные задания.

## <a name="ssh-access-without-a-password-hash-in-azure-ad-ds"></a>Доступ по протоколу SSH без хэша пароля в Azure AD DS

|Параметры SSH |Факторы, которые следует учитывать |
|---|---|
| Локальная учетная запись виртуальной машины (например, sshuser); | Вы указали эту учетную запись во время создания кластера. Для этой учетной записи проверка подлинности Kerberos отсутствует. |
| Учетная запись только для облака (например, alice@contoso.onmicrosoft.com ) | Хэш пароля доступен в Azure AD DS. Проверка подлинности Kerberos возможна через SSH Kerberos. |
| Локальная учетная запись (например, alice@contoso.com ) | Проверка подлинности по протоколу SSH Kerberos возможна, только если в Azure AD DS доступен хэш пароля. В противном случае этот пользователь не сможет получить доступ к кластеру по протоколу SSH. |

Для подключения SSH к виртуальной машине, присоединенной к домену, или для выполнения `kinit` команды необходимо указать пароль. Для аутентификации SSH Kerberos требуется, чтобы хэш был доступен в AD DS Azure. Если вы хотите использовать SSH только в административных сценариях, можно создать одну облачную учетную запись и использовать ее для подключения к кластеру по протоколу SSH. Другие локальные пользователи по-прежнему могут использовать средства Ambari или HDInsight или обычную проверку подлинности HTTP без использования хэша пароля в Azure AD DS.

Если ваша организация не синхронизирует хэши паролей с AD DS Azure, рекомендуется создать одного облачного пользователя в Azure AD. Затем назначьте его администратору кластера при создании кластера и используйте его в целях администрирования. Его можно использовать для получения корневого доступа к виртуальным машинам по протоколу SSH.

Сведения об устранении неполадок при проверке подлинности см. в [этом](./domain-joined-authentication-issues.md)разделе.

## <a name="clients-using-oauth-to-connect-to-an-hdinsight-gateway-with-hdinsight-id-broker"></a>Клиенты, использующие OAuth для подключения к шлюзу HDInsight с помощью Azure ID Broker

В программе установки брокера HDInsight ID можно обновить пользовательские приложения и клиенты, подключающиеся к шлюзу, чтобы сначала получить требуемый маркер OAuth. Выполните действия, описанные в [этом документе](../../storage/common/storage-auth-aad-app.md) , чтобы получить маркер со следующими сведениями:

*    URI ресурса OAuth: `https://hib.azurehdinsight.net` 
*   AppId: 7865c1d2-F040-46cc-875f-831a1ef6a28a
*    Разрешение: (имя: Cluster. ReadWrite, идентификатор: 8f89faa0-ffef-4007-974d-4989b39ad77d)

После получения маркера OAuth используйте его в заголовке авторизации HTTP-запроса к шлюзу кластера (например, https:// <clustername> -int.azurehdinsight.NET). Пример команды с фигурой на API Apache Livy может выглядеть следующим образом:
    
```bash
curl -k -v -H "Authorization: Bearer Access_TOKEN" -H "Content-Type: application/json" -X POST -d '{ "file":"wasbs://mycontainer@mystorageaccount.blob.core.windows.net/data/SparkSimpleTest.jar", "className":"com.microsoft.spark.test.SimpleFile" }' "https://<clustername>-int.azurehdinsight.net/livy/batches" -H "X-Requested-By:<username@domain.com>"
``` 

Для использования Beeline и Livy можно также воспользоваться приведенными [здесь](https://github.com/Azure-Samples/hdinsight-enterprise-security/tree/main/HIB/HIBSamples) кодами примеров, чтобы настроить клиент для использования OAuth и подключения к кластеру.

## <a name="faq"></a>Вопросы и ответы
### <a name="what-app-is-created-by-hdinsight-in-aad"></a>Какое приложение создано в HDInsight в AAD?
Для каждого кластера стороннее приложение будет зарегистрировано в AAD с универсальным кодом ресурса (URI) кластера в качестве identifierUri (например, `https://clustername.azurehdinsight.net` ).

### <a name="why-are-users-prompted-for-consent-before-using-hib-enabled-clusters"></a>Почему пользователям предлагается согласие перед использованием кластеров с поддержкой ХИБ?
В AAD согласие требуется для всех сторонних приложений, прежде чем оно сможет проходить проверку подлинности пользователей или доступа к данным.

### <a name="can-the-consent-be-approved-programatically"></a>Может ли согласие быть утверждено программно?
Microsoft Graph API позволяет автоматизировать согласие, см. [документацию по API](/graph/api/resources/oauth2permissiongrant) . последовательность действий для автоматизации согласия:

* Зарегистрируйте приложение и предоставьте приложению. ReadWrite. ALL разрешения на доступ к Microsoft Graph
* После создания кластера запросите приложение кластера на основе URI идентификатора.
* Регистрация согласия для приложения

При удалении кластера HDInsight удаляет приложение, и нет необходимости очищать какие-либо разрешения.

 


## <a name="next-steps"></a>Дальнейшие действия

* [Настройка кластера HDInsight с Корпоративный пакет безопасности с помощью доменных служб Azure Active Directory](apache-domain-joined-configure-using-azure-adds.md)
* [Синхронизация пользователей Azure Active Directory с кластером HDInsight](../hdinsight-sync-aad-users-to-cluster.md)
* [Мониторинг производительности кластера](../hdinsight-key-scenarios-to-monitor.md)