---
title: Общие рекомендации по корпоративной безопасности в Azure HDInsight
description: Некоторые рекомендации, которые должны упростить Корпоративный пакет безопасности развертывания и управления.
ms.service: hdinsight
ms.topic: conceptual
ms.date: 02/13/2020
ms.openlocfilehash: 92ad8362f75cdf0613d4ee95f39c23aa6d4819bb
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "98933568"
---
# <a name="enterprise-security-general-information-and-guidelines-in-azure-hdinsight"></a>Общие сведения и рекомендации по корпоративной безопасности в Azure HDInsight

При развертывании защищенного кластера HDInsight существуют некоторые рекомендации, которые упрощают развертывание и Управление кластерами. Некоторые общие сведения и рекомендации обсуждаются здесь.

## <a name="use-of-secure-cluster"></a>Использование безопасного кластера

### <a name="recommended"></a>Рекомендуемая

* Кластер будет использоваться несколькими пользователями одновременно.
* Пользователи имеют разные уровни доступа к одним и тем же данным.

### <a name="not-necessary"></a>Не требуется

* Вы собираетесь запускать только автоматические задания (например, учетную запись одного пользователя). Стандартный кластер достаточно хорош.
* Вы можете выполнить импорт данных с помощью стандартного кластера и использовать ту же учетную запись хранения в другом безопасном кластере, где пользователи могут запускать задания аналитики.

## <a name="use-of-local-account"></a>Использование локальной учетной записи

* Если используется общая учетная запись пользователя или локальная учетная запись, то будет трудно выяснить, кто использовал эту учетную запись для изменения конфигурации или службы.
* Использование локальных учетных записей вызывает затруднения, если пользователи больше не являются частью Организации.

## <a name="ranger"></a>Ranger

### <a name="policies"></a>Политики

* По умолчанию Ranger использует **Deny** в качестве политики.

* Когда доступ к данным осуществляется через службу, в которой включена авторизация:
  * Подключаемый модуль авторизации Ranger вызывается и получает контекст запроса.
  * Ranger применяет политики, настроенные для службы. При сбое политик Ranger проверка доступа отменяется для файловой системы. Некоторые службы, такие как MapReduce, проверяют только в том случае, если файл или папка принадлежат одному пользователю, отправляющему запрос. Такие службы, как Hive, проверяют либо соответствие владельца, либо соответствующие разрешения файловой системы ( `rwx` ).

* Для Hive, помимо разрешения на создание, обновление и удаление разрешений, пользователь должен иметь `rwx` разрешения на доступ к каталогу в хранилище и во всех подкаталогах.

* Политики можно применять к группам (предпочтительно), а не к отдельным пользователям.

* Ranger авторизации будет оценивать все политики Ranger для этой службы для каждого запроса. Эта оценка может оказать влияние на время, которое займет принятие задания или запроса.

### <a name="storage-access"></a>Доступ к хранилищу

* Если тип хранилища — WASB, токен OAuth не участвует.
* Если Ranger выполняет авторизацию, то доступ к хранилищу выполняется с помощью управляемого удостоверения.
* Если Ranger не выполнял авторизацию, доступ к хранилищу происходит с помощью маркера OAuth пользователя.

### <a name="hierarchical-name-space"></a>Иерархическое пространство имен

Если иерархическая область имен не включена:

* Унаследованные разрешения отсутствуют.
* Только разрешение файловой системы, которое работает с ролью Azure **data xxxx** , назначается пользователю непосредственно в портал Azure.

### <a name="default-hdfs-permissions"></a>Разрешения HDFS по умолчанию

* По умолчанию пользователи не имеют доступа к **/** папке в HDFS (они должны быть включены в роль владельца большого двоичного объекта хранилища для получения доступа к выполнению).
* Для промежуточного каталога для MapReduce и других пользовательских каталогов создаются и предоставляются `sticky _wx` разрешения. Пользователи могут создавать файлы и папки под, но не могут просматривать другие элементы.

### <a name="url-auth"></a>Проверка URL-адреса

Если включена проверка подлинности URL-адреса:

* В конфигурации будут содержаться префиксы, которые рассматриваются в проверке подлинности URL-адреса (например, `adl://` ).
* Если доступ предназначен для этого URL-адреса, Ranger проверит, входит ли пользователь в список разрешений.
* Ranger не будет проверять какие – либо детализированные политики.

## <a name="resource-groups"></a>Группы ресурсов

Используйте новую группу ресурсов для каждого кластера, чтобы можно было отличать ресурсы кластера.

## <a name="nsgs-firewalls-and-internal-gateway"></a>Группы безопасности сети, брандмауэры и внутренний шлюз

* Используйте группы безопасности сети (группы безопасности сети) для блокировки виртуальных сетей.
* Используйте брандмауэр для управления политиками исходящего трафика.
* Используйте внутренний шлюз, который не открыт в общедоступном Интернете.

## <a name="azure-active-directory"></a>Azure Active Directory

[Azure Active Directory](../../active-directory/fundamentals/active-directory-whatis.md) (Azure AD) — это облачная служба управления удостоверениями и доступом Майкрософт.

### <a name="policies"></a>Политики

* Отключите политику условного доступа с помощью политики IP-адресов. Для этого необходимо включить конечные точки службы в виртуальных сетей, где развернуты кластеры. Если вы используете внешнюю службу для MFA (что отличается от AAD), политика на основе IP-адресов не будет работать.

* `AllowCloudPasswordValidation` для федеративных пользователей требуется политика. Так как HDInsight использует имя пользователя и пароль непосредственно для получения маркеров из Azure AD, эта политика должна быть включена для всех федеративных пользователей.

* Включите конечные точки службы, если требуется обход условного доступа с помощью надежных IP-адресов.

### <a name="groups"></a>Группы

* Всегда развертывайте кластеры с группой.
* Используйте Azure AD для управления членством в группах (проще, чем пытаться управлять отдельными службами в кластере).

### <a name="user-accounts"></a>Учетные записи пользователей

* Для каждого сценария используйте уникальную учетную запись пользователя. Например, используйте учетную запись для импорта, используйте другую для запроса или других заданий обработки.
* Используйте политики Ranger на основе групп вместо отдельных политик.
* Поставьте план управления пользователями, которым больше не нужно иметь доступ к кластерам.

## <a name="azure-active-directory-domain-services"></a>Доменные службы Azure Active Directory

[Azure Active Directory доменных служб](../../active-directory-domain-services/overview.md) (Azure AD DS) предоставляет управляемые доменные службы, такие как присоединение к домену, групповая политика, протокол LDAP и проверка подлинности Kerberos/NTLM, полностью совместимые с Windows Server Active Directory.

Для защиты кластеров, присоединяемых к домену, требуется AD DS Azure.
HDInsight не может зависеть от локальных контроллеров домена или пользовательских контроллеров домена, так как он содержит слишком много точек сбоя, общий доступ к учетным данным, разрешения DNS и т. д. Дополнительные сведения см. в статье [вопросы и ответы по Azure AD DS](../../active-directory-domain-services/faqs.md).

### <a name="azure-ad-ds-instance"></a>Экземпляр AD DS Azure

* Создайте экземпляр с помощью `.onmicrosoft.com domain` . Таким образом, не будет нескольких DNS-серверов, обслуживающих домен.
* Создайте самозаверяющий сертификат для LDAPs и отправьте его в Azure AD DS.
* Используйте одноранговую виртуальную сеть для развертывания кластеров (при наличии нескольких групп, развертывающих кластеры HDInsight ESP, это будет полезно). Это гарантирует, что не нужно открывать порты (группы безопасности сети) в виртуальной сети с контроллером домена.
* Настройте DNS для правильной виртуальной сети (доменное имя Azure AD DS должно разрешаться без записей файлов узлов).
* Если вы ограничивали исходящий трафик, убедитесь, что прочитали [поддержку брандмауэра в HDInsight](../hdinsight-restrict-outbound-traffic.md) .

### <a name="properties-synced-from-azure-ad-to-azure-ad-ds"></a>Свойства, синхронизированные из Azure AD в Azure AD DS

* Azure AD Connect выполняет синхронизацию из локальной сети с Azure AD.
* Azure AD DS синхронизируется из Azure AD.

Azure AD DS периодически синхронизирует объекты Azure AD. В колонке Azure AD DS на портал Azure отображается состояние синхронизации. Во время каждого этапа синхронизации уникальные свойства могут стать конфликтом и переименованы. Обратите внимание на сопоставление свойств из Azure AD в Azure AD DS.

Дополнительные сведения см. в статьях о [заполнении userPrincipalName в Azure AD](../../active-directory/hybrid/plan-connect-userprincipalname.md)и [о том, как работает Синхронизация AD DS Azure](../../active-directory-domain-services/synchronization.md).

### <a name="password-hash-sync"></a>Синхронизация хэша паролей

* Пароли синхронизируются иначе, чем другие типы объектов. Только необратимые хэши паролей синхронизируются в Azure AD и Azure AD DS
* Локальная служба Azure AD должна быть включена через AD Connect
* Синхронизация Azure AD с Azure AD DS выполняется автоматически (задержка составляет 20 минут).
* Хэши паролей синхронизируются только при наличии измененного пароля. При включении синхронизации хэша паролей все существующие пароли не синхронизируются автоматически по мере их необратимого хранения. При изменении пароля синхронизируются хэши паролей.

### <a name="computer-objects-location"></a>Расположение объектов компьютеров

Каждый кластер связан с одним подразделением. Внутренний пользователь подготавливается в подразделении. Все узлы присоединены к домену в одном и том же подразделении.

### <a name="active-directory-administrative-tools"></a>Средства администрирования Active Directory

Инструкции по установке средств администрирования Active Directory на виртуальной машине Windows Server см. в разделе [Установка средств управления](../../active-directory-domain-services/tutorial-create-management-vm.md).

## <a name="troubleshooting"></a>Устранение неполадок

### <a name="cluster-creation-fails-repeatedly"></a>Создание кластера завершается сбоем повторно

Наиболее распространенные причины:

* Неправильная конфигурация DNS, присоединение к домену узлов кластера завершается сбоем.
* Группы безопасности сети является слишком узким, предотвращая присоединение к домену.
* Управляемое удостоверение не имеет достаточных разрешений.
* Имя кластера не является уникальным для первых шести символов (с другим динамическим кластером или с удаленным кластером).

## <a name="authentication-setup-and-configuration"></a>Настройка и Настройка проверки подлинности

### <a name="user-principal-name-upn"></a>Имя субъекта-пользователя (UPN)

* Используйте строчные буквы для всех служб — UPN не учитывают регистр в кластерах ESP, но
* Префикс UPN должен соответствовать обоим атрибутам SAMAccountName в Azure AD-DS. Сопоставление с полем "почта" не является обязательным.

### <a name="ldap-properties-in-ambari-configuration"></a>Свойства LDAP в конфигурации Ambari

Полный список свойств Ambari, влияющих на конфигурацию кластера HDInsight, см. в статье [Настройка проверки подлинности AMBARI LDAP](https://ambari.apache.org/1.2.1/installing-hadoop-using-ambari/content/ambari-chap2-4.html).

## <a name="next-steps"></a>Дальнейшие действия

* [Корпоративный пакет безопасности конфигураций с помощью доменных служб Azure Active Directory в HDInsight](./apache-domain-joined-configure-using-azure-adds.md)

* [Синхронизация Azure Active Directory пользователей с кластером HDInsight](../hdinsight-sync-aad-users-to-cluster.md).
