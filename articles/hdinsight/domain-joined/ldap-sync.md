---
title: Синхронизация LDAP в Ranger и Apache Ambari в Azure HDInsight
description: Устраните синхронизацию LDAP в Ranger и Ambari и предоставьте общие рекомендации.
ms.service: hdinsight
ms.topic: conceptual
ms.date: 02/14/2020
ms.openlocfilehash: fb9035b4d816c1af84b15e6865335aa1bdf86f5b
ms.sourcegitcommit: 2f9f306fa5224595fa5f8ec6af498a0df4de08a8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/28/2021
ms.locfileid: "98933417"
---
# <a name="ldap-sync-in-ranger-and-apache-ambari-in-azure-hdinsight"></a>Синхронизация LDAP в Ranger и Apache Ambari в Azure HDInsight

Кластеры HDInsight Корпоративный пакет безопасности (ESP) используют Ranger для авторизации. Apache Ambari и Ranger синхронизируют пользователей и группы независимо друг от друга и работают немного иначе. Эта статья предназначена для решения синхронизации LDAP в Ranger и Ambari.

## <a name="general-guidelines"></a>Общие рекомендации

* Всегда развертывайте кластеры с одной или несколькими группами.
* Если вы хотите использовать больше групп в кластере, проверьте, имеет ли смысл обновление членства в группах в Azure Active Directory (Azure AD).
* Если вы хотите изменить группы кластера, фильтры синхронизации можно изменить с помощью Ambari.
* Все изменения членства в группах в Azure AD отражаются в кластере при последующих операциях синхронизации. Сначала необходимо синхронизировать изменения с доменными службами Azure AD (Azure AD DS), а затем к кластерам.
* Кластеры HDInsight используют Samba/winbind для проецирования членства в группах на узлах кластера.
* Элементы группы синхронизируются транзитно (все подгруппы и их члены) как в Ambari, так и в Ranger. 

## <a name="users-are-synced-separately"></a>Пользователи синхронизируются отдельно

 * Ambari и Ranger не имеют общего доступа к пользовательской базе данных, так как они служат двум различным целям. 
   * Если пользователь должен использовать пользовательский интерфейс Ambari, необходимо синхронизировать пользователя с Ambari. 
   * Если пользователь не синхронизирован с Ambari, Пользовательский интерфейс или API-интерфейс Ambari отклонит его, но другие части системы будут работать (они защищены Ranger или диспетчер ресурсов, а не Ambari).
   * Чтобы включить пользователей или группы в политики Ranger, субъекты необходимо явным образом синхронизировать в Ranger.

## <a name="ambari-user-sync-and-configuration"></a>Синхронизация и Настройка пользователей Ambari

С головных узлов задание cron выполняется `/opt/startup_scripts/start_ambari_ldap_sync.py` каждый час, чтобы запланировать синхронизацию пользователей. Задание cron вызывает API-интерфейсы Ambari для выполнения синхронизации. Сценарий отправляет список пользователей и групп для синхронизации (так как пользователи могут не принадлежать к указанным группам, оба указываются по отдельности). Ambari синхронизирует sAMAccountName как имя пользователя и всех членов группы, транзитно.

Журналы должны быть в `/var/log/ambari-server/ambari-server.log` . Дополнительные сведения см. в статье [Настройка уровня ведения журнала Ambari](https://docs.cloudera.com/HDPDocuments/Ambari-latest/administering-ambari/content/amb_configure_ambari_logging_level.html).

В кластерах Data Lake для создания домашних папок для синхронизированных пользователей и их настройки в качестве владельцев домашних папок используется обработчик записи после создания пользователя. Если пользователь не синхронизирован с Ambari правильным образом, пользователь может столкнуться со сбоями в работе заданий, так как домашняя папка может быть неправильно настроена.

## <a name="ranger-user-sync-and-configuration"></a>Синхронизация и Настройка пользователей Ranger

Ranger имеет встроенный модуль синхронизации, который выполняется каждый час для синхронизации пользователей. Она не предоставляет доступ к пользовательской базе данных с помощью Ambari. HDInsight настраивает фильтр поиска для синхронизации пользователя с правами администратора, пользователя наблюдения и членов группы, указанной во время создания кластера. Элементы группы будут синхронизированы транзитным образом:

1. Отключить добавочную синхронизацию.
1. Включите карту синхронизации группы пользователей.
1. Укажите фильтр поиска для включения транзитивных членов группы.
1. Синхронизируйте атрибут sAMAccountName для пользователей и атрибут Name для групп.

### <a name="group-or-incremental-sync"></a>Группа или Добавочная синхронизация

Ranger поддерживает параметр синхронизации группы, но он работает как пересечение с фильтром пользователей, а не с объединением членства в группах и фильтра пользователей. Типичный вариант использования фильтра синхронизации групп в Ranger — фильтр группы: (DN = клустерадминграуп), Пользовательский фильтр: (City = Сиэтл).

Добавочная синхронизация работает только для пользователей, которые уже синхронизированы (в первый раз). Добавочная синхронизация не будет синхронизировать новых пользователей, добавленных в группы после начальной синхронизации.

### <a name="update-ranger-sync-filter"></a>Обновление фильтра синхронизации Ranger

Фильтр LDAP можно найти в пользовательском интерфейсе Ambari в разделе конфигурации Ranger User-Sync. Существующий фильтр будет иметь вид `(|(userPrincipalName=bob@contoso.com)(userPrincipalName=hdiwatchdog-core01@CONTOSO.ONMICROSOFT.COM)(memberOf:1.2.840.113556.1.4.1941:=CN=hadoopgroup,OU=AADDC Users,DC=contoso,DC=onmicrosoft,DC=com))` . Убедитесь, что в конце добавлен предикат, и проверьте фильтр, используя `net ads` команду поиска или ldp.exe или что-то подобное.

## <a name="ranger-user-sync-logs"></a>Журналы синхронизации пользователей Ranger

Синхронизация пользователей Ranger может происходить из любой из головных узлах. Журналы находятся в `/var/log/ranger/usersync/usersync.log` . Чтобы увеличить уровень детализации журналов, выполните следующие действия.

1. Войдите в Ambari.
1. Перейдите к разделу конфигурации Ranger.
1. Перейдите к разделу Advanced **усерсинк-log4j** .
1. Измените значение `log4j.rootLogger` на `DEBUG` уровень на. (После изменения он должен выглядеть следующим образом `log4j.rootLogger = DEBUG,logFile,FilterLog` ).
1. Сохраните конфигурацию и перезапустите Ranger.

## <a name="known-issues-with-ranger-user-sync"></a>Известные проблемы с синхронизацией пользователей Ranger
* Если имя группы содержит символы Юникода, Ranger Sync не сможет синхронизировать этот объект. Если пользователь принадлежит к группе, имеющей международные символы, Ranger синхронизирует частичное членство в группе.
* Имя пользователя (sAMAccountName) и имя группы (имя) должны быть длиной не более 20 символов. Если имя группы длиннее, то при вычислении разрешений пользователь будет считать, что он не принадлежит к группе.

## <a name="next-steps"></a>Дальнейшие действия

* [Проблемы проверки подлинности в Azure HDInsight](./domain-joined-authentication-issues.md)
* [Синхронизация пользователей Microsoft Azure AD с кластером HDInsight](../hdinsight-sync-aad-users-to-cluster.md)
