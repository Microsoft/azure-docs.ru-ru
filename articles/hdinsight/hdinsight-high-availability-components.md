---
title: Компоненты высокой доступности в Azure HDInsight
description: Общие сведения о различных компонентах высокой доступности, используемых кластерами HDInsight.
ms.service: hdinsight
ms.topic: conceptual
ms.date: 10/07/2020
ms.openlocfilehash: 93d2317c85f93ce8a22f2d434fbc081a88265a74
ms.sourcegitcommit: 42e4f986ccd4090581a059969b74c461b70bcac0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/23/2021
ms.locfileid: "104863723"
---
# <a name="high-availability-services-supported-by-azure-hdinsight"></a>Службы высокого уровня доступности, поддерживаемые Azure HDInsight

Чтобы обеспечить оптимальный уровень доступности для компонентов аналитики, HDInsight был разработан с уникальной архитектурой для обеспечения высокой доступности (HA) критически важных служб. Некоторые компоненты этой архитектуры были разработаны корпорацией Майкрософт для обеспечения автоматической отработки отказа. Другие компоненты — это стандартные компоненты Apache, которые развертываются для поддержки конкретных служб. В этой статье объясняется архитектура модели службы высокой доступности в HDInsight, способ поддержки отработки отказа для служб HA и рекомендации по восстановлению после других прерываний работы служб.

> [!NOTE]
> Эта статья содержит ссылки на термин « *Ведомый*» термин, который корпорация Майкрософт больше не использует. Когда этот термин будет удален из программного обеспечения, мы удалим его из статьи.

## <a name="high-availability-infrastructure"></a>Инфраструктура высокой доступности

HDInsight предоставляет настраиваемую инфраструктуру, обеспечивающую высокую доступность четырех основных служб с возможностью автоматического перехода на другой ресурс.

- Сервер Apache Ambari
- временная шкала приложения Server для Apache YARN
- Сервер журнала заданий для Hadoop MapReduce
- Apache Livy

Эта инфраструктура состоит из ряда служб и программных компонентов, некоторые из которых разработаны корпорацией Майкрософт. Следующие компоненты являются уникальными для платформы HDInsight:

- Контроллер отработки отказа подчиненных
- Главный отказоустойчивый контроллер
- Подчиненная служба высокого уровня доступности
- Главная служба высокой доступности

:::image type="content" source="./media/hdinsight-high-availability-components/high-availability-architecture.png" alt-text="Инфраструктура высокой доступности" border="false":::

Существуют также другие службы высокого уровня доступности, которые поддерживаются компонентами Apache надежности с открытым кодом. Эти компоненты также имеются в кластерах HDInsight:

- Файловая система Hadoop (HDFS) NameNode
- YARN ResourceManager
- HBase Master

В следующих разделах приводятся более подробные сведения о совместной работе этих служб.

## <a name="hdinsight-high-availability-services"></a>Службы HDInsight с высоким уровнем доступности

Корпорация Майкрософт предоставляет поддержку четырех служб Apache, перечисленных в следующей таблице в кластерах HDInsight. Чтобы отличить их от служб высокого уровня доступности, поддерживаемых компонентами Apache, они называются *службами HDINSIGHT Ha*.

| Служба | Узлы кластера | Типы кластера | Назначение |
|---|---|---|---|
| Сервер Apache Ambari| Активные головного узла | Все | Отслеживает кластер и управляет им.|
| временная шкала приложения Server для Apache YARN | Активные головного узла | Все, Кроме Kafka | Хранит сведения об отладке заданий YARN, выполняющихся в кластере.|
| Сервер журнала заданий для Hadoop MapReduce | Активные головного узла | Все, Кроме Kafka | Поддерживает данные отладки для заданий MapReduce.|
| Apache Livy | Активные головного узла | Spark | Обеспечивает простое взаимодействие с кластером Spark через интерфейс RESTFUL |

>[!Note]
> Кластеры HDInsight Корпоративный пакет безопасности (ESP) в настоящее время обеспечивают высокий уровень доступности сервера Ambari. Сервер временная шкала приложения, сервер журнала заданий и Livy работают только в headnode0 и не отработки отказа в headnode1 при Ambari фаилсовер. База данных временной шкалы приложения также находится на headnode0, а не на Ambari SQL Server.

### <a name="architecture"></a>Architecture

Каждый кластер HDInsight имеет два головных узлах в активном и резервном режимах соответственно. Службы HDInsight HA выполняются только на головных узлах. Эти службы всегда должны выполняться на активном головного узла и остановлены и переведены в режим обслуживания в резервной головного узла.

Чтобы обеспечить правильное состояние служб HA и обеспечить быструю отработку отказа, HDInsight использует Apache ZooKeeper, который является службой координации для распределенных приложений, для проведения активных выборов головного узла. HDInsight также подготавливает несколько фоновых процессов Java, которые координируют процедуру отработки отказа для служб HDInsight HA. К этим службам относятся следующие: главный контроллер отработки отказа, контроллер подчиненного *сервера, Master-Ha-Service* и *Slave-Ha-Service*.

### <a name="apache-zookeeper"></a>Apache ZooKeeper

Apache ZooKeeper — это высокопроизводительная Служба координации для распределенных приложений. В рабочей среде ZooKeeper обычно работает в реплицируемом режиме, где реплицированная группа ZooKeeper-серверов образует кворум. Каждый кластер HDInsight имеет три узла ZooKeeper, которые позволяют трем серверам ZooKeeper формировать кворум. В HDInsight есть два ZooKeeper кворума, параллельно взаимодействующие друг с другом. Один кворум решает активную головного узла в кластере, на котором должны выполняться службы HDInsight HA. Другой кворум используется для координации служб высокой доступности, предоставляемых Apache, как описано в последующих разделах.

### <a name="slave-failover-controller"></a>Контроллер отработки отказа подчиненных

Ведомый контроллер отработки отказа выполняется на каждом узле в кластере HDInsight. Этот контроллер отвечает за запуск агента Ambari и Slave- *Ha-Service* на каждом узле. Он периодически опрашивает первый ZooKeeper кворума об активном головного узла. При изменении активного и резервного головных узлах Контроллер подсистемы отработки отказа выполняет следующие действия:

1. Обновляет файл конфигурации узла.
1. Перезапускает агент Ambari.

*Ведомая служба (slave-Ha-Service* ) отвечает за остановку служб HDInsight HA (кроме сервера Ambari) в резервной головного узла.

### <a name="master-failover-controller"></a>Главный отказоустойчивый контроллер

Главный отказоустойчивый контроллер работает на обоих головных узлах. Оба основных контроллера отработки отказа взаимодействуют с первым ZooKeeper кворумом, чтобы назначить головного узла, на котором они выполняются в качестве активного головного узла.

Например, если в качестве основного контроллера отработки отказа на головного узла 0 была выполнена выборка, выполняются следующие изменения:

1. Головного узла 0 станет активным.
1. Главный отказоустойчивый Контроллер запускает Ambari Server и *master-Ha-Service* на головного узла 0.
1. Другой главный контроллер отработки отказа останавливает Ambari Server и *master-Ha-Service* на головного узла 1.

Служба Master-Ha-Service работает только на активном головного узла, она останавливает службы HDInsight HA (кроме сервера Ambari) в резервной головного узла и запускает их на активном головного узла.

### <a name="the-failover-process"></a>Процесс отработки отказа

:::image type="content" source="./media/hdinsight-high-availability-components/failover-steps.png" alt-text="Процесс отработки отказа" border="false":::

Монитор работоспособности работает на каждом головного узла, а также на главном контроллере отработки отказа для отправки уведомлений о пульсе в кворум Zookeeper. В этом сценарии головного узла рассматривается как служба высокой доступности. Монитор работоспособности проверяет, является ли каждая служба высокой доступности работоспособной и готова ли она к работе в выборов руководства. Если да, это головного узла будет конкурировать за выборы. В противном случае он завершит выбор до тех пор, пока не будет снова готово.

Если резервный головного узла когда-либо достигает лидерства и становится активным (например, в случае сбоя предыдущего активного узла), его главный контроллер отработки отказа запустит на нем все службы HDInsight HA. Главный контроллер отработки отказа также будет прекращать работу этих служб на другом головного узла.

Для сбоев службы HDInsight, таких как служба работает или неработоспособна, главный отказоустойчивый контроллер должен автоматически перезапускать или прекращать работу служб в соответствии с состоянием головного узла. Пользователям не следует вручную запускать службы HDInsight на обоих головных узлах. Вместо этого разрешите автоматическую или ручную отработку отказа, чтобы помочь восстановить службу.

### <a name="inadvertent-manual-intervention"></a>Случайное вмешательство вручную

Службы HDInsight высокой доступности должны выполняться только на активном головного узла и будут автоматически перезапущены при необходимости. Поскольку отдельные службы высокой доступности не имеют собственного монитора работоспособности, отработка отказа не может быть активирована на уровне отдельной службы. Отработка отказа обеспечивается на уровне узла, а не на уровне обслуживания.

### <a name="some-known-issues"></a>Некоторые известные проблемы

- При ручном запуске службы высокой доступности в режиме ожидания головного узла она не будет останавливаться до следующей отработки отказа. Когда службы HA выполняются на обеих головных узлах, некоторые потенциальные проблемы включают в себя: Пользовательский интерфейс Ambari недоступен, Ambari выдает ошибки, YARN, Spark и Oozie могут зависнуть.

- Когда служба высокой доступности на активном головного узла останавливается, она не перезапускается, пока не произойдет следующая отработка отказа или перезапустится главный контроллер отработки отказа/главный-Ha-Service. Когда одна или несколько служб HA останавливаются на активном головного узла, особенно когда Ambari Server останавливается, Пользовательский интерфейс Ambari недоступен, другие потенциальные проблемы включают в себя сбои заданий YARN, Spark и Oozie.

## <a name="apache-high-availability-services"></a>Службы Apache высокого уровня доступности

Apache обеспечивает высокий уровень доступности для HDFS NameNode, YARN ResourceManager и HBase Master, которые также доступны в кластерах HDInsight. В отличие от служб HDInsight с высоким уровнем доступности, они поддерживаются в кластерах ESP. Службы Apache HA взаимодействуют со вторым ZooKeeper кворумом (описанным в предыдущем разделе), чтобы выбрать активные и ждущие состояния и выполнить автоматическую отработку отказа. В следующих разделах подробно описано, как работают эти службы.

### <a name="hadoop-distributed-file-system-hdfs-namenode"></a>Распределенная файловая система Hadoop (HDFS) NameNode

Кластеры HDInsight на основе Apache Hadoop 2,0 или более поздней версии обеспечивают высокий уровень доступности NameNode. На головных узлах, которые настроены для автоматического перехода на другой ресурс, выполняются два Наменодес. Наменодес использует *зкфаиловерконтроллер* для взаимодействия с Zookeeper, чтобы выбрать состояние "активно/в ожидании". *Зкфаиловерконтроллер* выполняется на обоих головных узлах и работает так же, как и главный контроллер отработки отказа выше.

Второй кворум Zookeeper не зависит от первого кворума, поэтому активный NameNode может не работать на активном головного узла. Если активный NameNode неисправен или неработоспособен, резервный NameNode найдет выборы и станет активным.

### <a name="yarn-resourcemanager"></a>YARN ResourceManager

Кластеры HDInsight на основе Apache Hadoop 2,4 или более поздней версии поддерживают высокий уровень доступности YARN ResourceManager. Существует два ResourceManager, RM1 и RM2, которые выполняются в головного узла 0 и головного узла 1 соответственно. Как и NameNode, ResourceManager YARN также настроен для автоматического перехода на другой ресурс. Другой ResourceManager автоматически выбирается в активном состоянии при отключении или отклике текущего активного ResourceManager.

ResourceManager YARN использует внедренный *активестандбелектор* в качестве средства обнаружения сбоев и лидера електор. В отличие от HDFS NameNode, для YARN ResourceManager не требуется отдельная управляющая программа ЗКФК. Активный ResourceManager записывает свои состояния в Apache Zookeeper.

Высокий уровень доступности ResourceManager YARN не зависит от NameNode и других служб с высоким уровнем доступности HDInsight. Активный ResourceManager может не работать на активном головного узла или головного узла, где запущен активный NameNode. Дополнительные сведения о высокой доступности YARN ResourceManager см. в статье [высокий уровень доступности ResourceManager](https://hadoop.apache.org/docs/current/hadoop-yarn/hadoop-yarn-site/ResourceManagerHA.html).

### <a name="hbase-master"></a>HBase Master

Кластеры HDInsight HBase поддерживают HBase Master высокий уровень доступности. В отличие от других служб высокой доступности, которые выполняются на головных узлах, образцы HBase выполняются на трех узлах Zookeeper, где один из них является активным, а два других — в режиме ожидания. Как и в NameNode, HBase Master координаты с помощью Apache Zookeeper для выборов и выполняет автоматическую отработку отказа, если на текущем активном хозяине возникают проблемы. В любой момент времени имеется только одна активная HBase Master.

## <a name="next-steps"></a>Дальнейшие действия

- [Доступность и надежность кластеров Apache Hadoop в HDInsight](./hdinsight-business-continuity.md)
- [Архитектура виртуальной сети Azure HDInsight](hdinsight-virtual-network-architecture.md)