---
title: Подробный обзор шлюза и рекомендации по Apache Hive в Azure HDInsight
description: Узнайте, как перейти к рекомендациям по выполнению запросов Hive через шлюз Azure HDInsight.
ms.service: hdinsight
ms.topic: conceptual
ms.date: 04/01/2020
ms.openlocfilehash: 63484d882d8ccd387257c6f246c2048a09c77bc8
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "98933106"
---
# <a name="gateway-deep-dive-and-best-practices-for-apache-hive-in-azure-hdinsight"></a>Подробный обзор шлюза и рекомендации по Apache Hive в Azure HDInsight

Шлюз Azure HDInsight — это интерфейс HTTPS для кластеров HDInsight. Шлюз отвечает за: Аутентификация, разрешение узла, обнаружение служб и другие полезные компоненты, необходимые для современной распределенной системы. Функции, предоставляемые шлюзом, приводят к некоторым издержкам, для которых в этом документе описываются рекомендации по переходу. Также обсуждаются методы устранения неполадок шлюза.

## <a name="the-hdinsight-gateway"></a>Шлюз HDInsight

Шлюз HDInsight является единственной частью кластера HDInsight, доступ к которому осуществляется через Интернет. Доступ к службе шлюза можно получить без обращения к общедоступному Интернету с помощью `clustername-int.azurehdinsight.net` внутренней конечной точки шлюза. Внутренняя конечная точка шлюза позволяет устанавливать подключения к службе шлюза без выхода из виртуальной сети кластера. Шлюз обрабатывает все запросы, отправляемые в кластер, и перенаправляет такие запросы на правильные компоненты и узлы кластера.

На следующей диаграмме приведен пример того, как шлюз предоставляет абстракцию перед всеми различными возможностями разрешения узла в HDInsight.

![Схема разрешения узла](./media/gateway-best-practices/host-resolution-diagram.png "Схема разрешения узла")

## <a name="motivation"></a>Причины для использования

Цель размещения шлюза перед кластерами HDInsight — предоставить интерфейс для обнаружения служб и проверки подлинности пользователей. Механизмы проверки подлинности, предоставляемые шлюзом, особенно важны для кластеров с поддержкой ESP.

Для обнаружения служб преимущество шлюза состоит в том, что каждый компонент в кластере может быть доступен как другая конечная точка на веб-сайте шлюза ( `clustername.azurehdinsight.net/hive2` ), а не множество `host:port` пар.

Для проверки подлинности шлюз позволяет пользователям проходить проверку подлинности с помощью `username:password` пары учетных данных. Для кластеров с поддержкой ESP это учетные данные будут иметь имя пользователя и пароль домена пользователя. Для аутентификации в кластерах HDInsight через шлюз не требуется, чтобы клиент получал билет Kerberos. Поскольку шлюз принимает `username:password` учетные данные и получает билет Kerberos пользователя от имени пользователя, можно устанавливать безопасные подключения к шлюзу с любого узла клиента, включая клиенты, присоединенные к разным доменам DDS в качестве кластера (ESP).

## <a name="best-practices"></a>Рекомендации

Шлюз — это единая служба (сбалансированная нагрузка на два узла), отвечающая за пересылку запросов и проверку подлинности. Шлюз может стать узким местом пропускной способности для запросов Hive, превышающих определенный размер. Снижение производительности запросов может наблюдаться при выполнении очень больших запросов **SELECT** на шлюзе через ODBC или JDBC. "Очень крупный" означает запросы, которые составляют более 5 ГБ данных в строках или столбцах. Этот запрос может включать длинный список строк и или широкий счетчик столбцов.

Производительность шлюза снижается при запросах большого размера, так как данные должны передаваться из базового хранилища данных (ADLS 2-го поколения) в: сервер Hive HDInsight, шлюз и, наконец, через драйверы JDBC или ODBC на узел клиента.

На следующей схеме показаны шаги, связанные с запросом SELECT.

![Схема результатов](./media/gateway-best-practices/result-retrieval-diagram.png "Схема результатов")

Apache Hive является реляционной абстракцией поверх HDFS-совместимой файловой системы. Эта абстракция означает, что инструкции **SELECT** в Hive соответствуют операциям **чтения** файловой системы. Операции **чтения** преобразуются в соответствующую схему перед тем, как сообщить пользователю о них. Задержка этого процесса повышается за счет размера данных и общего числа прыжков, необходимых для достижения конечного пользователя.

Аналогичное поведение может возникнуть при выполнении инструкций **CREATE** или **INSERT** для больших данных, так как эти команды будут соответствовать операциям **записи** в базовой файловой системе. Рассмотрите возможность записи данных, например RAW ORC, в файловую систему/Data Lake вместо их загрузки с помощью инструкции **INSERT** или **Load**.

В кластерах с поддержкой пакета безопасности Enterprise, достаточно сложных политик Apache Ranger может привести к снижению времени компиляции запроса, что может привести к превышению времени ожидания шлюза. Если время ожидания шлюза замечено в кластере ESP, рекомендуется уменьшить или объединить число политик Ranger.

## <a name="troubleshooting-techniques"></a>Методы устранения неполадок

Существует несколько мест для устранения проблем с производительностью и их понимания в рамках описанного выше поведения. При снижении производительности запросов на шлюзе HDInsight используйте следующий контрольный список:

* Используйте предложение **Limit** при выполнении больших запросов **SELECT** . Предложение **Limit** сокращает общее число строк, передаваемых на клиентский узел. Предложение **Limit** влияет только на формирование результатов и не изменяет план запроса. Чтобы применить предложение **Limit** к плану запроса, используйте конфигурацию `hive.limit.optimize.enable` . **Ограничение** можно сочетать с смещением, используя ограничение в виде аргументов **x, y**.

* Назовите свои столбцы, представляющие интерес, при выполнении запросов **SELECT** , а не с помощью **SELECT \***. Если выбрать меньшее количество столбцов, объем считанных данных уменьшится.

* Попробуйте выполнить запрос по интересу через Apache Beeline. Если получение результатов через Apache Beeline занимает продолжительное время, при получении тех же результатов с помощью внешних средств необходимо задерживать задержки.

* Протестируйте базовый запрос Hive, чтобы обеспечить возможность установки подключения к шлюзу HDInsight. Попробуйте выполнить базовый запрос из двух или более внешних инструментов, чтобы убедиться, что отдельные средства не выполняются.

* Проверьте все оповещения Apache Ambari, чтобы убедиться в работоспособности служб HDInsight. Оповещения Ambari можно интегрировать с Azure Monitor для создания отчетов и анализа.

* Если вы используете внешний хранилище метаданных Hive, убедитесь, что значение DTU базы данных SQL Azure для Hive хранилище метаданных не достигло предела. Если количество DTU приближается к пределу, необходимо увеличить размер базы данных.

* Убедитесь, что любые сторонние средства, такие как PBI или Tableau, используют разбиение на страницы для просмотра таблиц или баз данных. Для получения помощи по разбивке на страницы обратитесь к своим партнерам службы поддержки. Основным инструментом, используемым для разбиения на страницы, является `fetchSize` параметр JDBC. Небольшой размер выборки может привести к снижению производительности шлюза, но слишком большой размер выборки может привести к превышению времени ожидания шлюза. Настройка размера выборки должна выполняться на основе рабочей нагрузки.

* Если конвейер данных включает в себя чтение большого объема данных из базового хранилища кластера HDInsight, рассмотрите возможность использования средства, которое напрямую взаимодействует с хранилищем Azure, например с фабрикой данных Azure.

* Рассмотрите возможность использования Apache Hive LLAP при выполнении интерактивных рабочих нагрузок, так как LLAP может предоставить более гладкий интерфейс для быстрого возврата результатов запроса.

* Попробуйте увеличить число потоков, доступных для службы Hive хранилище метаданных, с помощью `hive.server2.thrift.max.worker.threads` . Этот параметр особенно важен, когда большое число одновременных пользователей отправляет запросы в кластер.

* Сократите число повторных попыток, используемых для доступа к шлюзу, из любого внешнего средства. Если используется несколько повторных попыток, рассмотрите возможность применения политики экспоненциальной повторной попытки.

* Рассмотрите возможность включения сжатия Hive с помощью конфигураций `hive.exec.compress.output` и `hive.exec.compress.intermediate` .

## <a name="next-steps"></a>Дальнейшие действия

* [Apache Beeline в HDInsight](../hadoop/apache-hadoop-use-hive-beeline.md)
* [Этапы устранения неполадок со временем ожидания шлюза HDInsight](./troubleshoot-gateway-timeout.md)
* [Виртуальные сети для HDInsight](../hdinsight-plan-virtual-network-deployment.md)
* [HDInsight с помощью Express Route](../connect-on-premises-network.md)