---
title: Безопасность обновления устройства для центра Интернета вещей Azure | Документация Майкрософт
description: Узнайте, как обновление устройства для центра Интернета вещей гарантирует безопасное обновление устройств.
author: lichris
ms.author: lichris
ms.date: 2/11/2021
ms.topic: conceptual
ms.service: iot-hub
ms.openlocfilehash: 86b2dbe6a28d1440f93788eb40e133d9b62d3f0c
ms.sourcegitcommit: 8d1b97c3777684bd98f2cfbc9d440b1299a02e8f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/09/2021
ms.locfileid: "102489435"
---
# <a name="device-update-security-model"></a>Модель безопасности обновления устройства

Обновление устройства для центра Интернета вещей предоставляет безопасный способ развертывания обновлений для встроенного по устройства, образов и приложений на устройствах IoT. Рабочий процесс предоставляет сквозной безопасный канал с полноценной моделью цепочки поставок, которую устройство может использовать для доказательства, что обновление является доверенным, неизмененным и намеренным.

Каждый шаг в рабочем процессе обновления устройства защищается с помощью различных функций и процессов безопасности, чтобы гарантировать, что каждый шаг в конвейере выполняет защищенную передачу на следующий. Клиент обновления устройства определяет и правильно управляет любыми запросами на обновление столкновении. Клиент также проверяет каждую загрузку, чтобы убедиться, что содержимое является доверенным, неизмененным и намеренно.

## <a name="for-solution-operators"></a>Для операторов решений

Когда операторы решения импортируют обновления в экземпляр обновления устройства, служба отправляет и проверяет двоичные файлы обновления, чтобы убедиться, что они не были изменены или переключены злоумышленником. После проверки служба обновления устройства создает внутренний [манифест обновления](./update-manifest.md) с хэшами файлов из манифеста импорта и других метаданных. Затем этот манифест обновления подписывается службой обновления устройства.

Когда оператор решения запрашивает обновление устройства, подписанное сообщение отправляется через защищенный канал центра Интернета вещей на устройство. Подпись запроса проверяется агентом обновления устройства устройства как подлинное. 

Любая полученная двоичная Загрузка защищена с помощью проверки подписи манифеста обновления. Манифест обновления содержит хэши двоичных файлов, поэтому после того, как манифест является доверенным, агент обновления устройства доверяет хэшу и сопоставляет их с двоичными файлами. После скачивания и проверки двоичного файла обновления он передается установщику на устройстве.

## <a name="for-device-builders"></a>Для построителей устройств

Чтобы обеспечить масштабирование службы обновления устройств до простых, низкоуровневых устройств, в модели безопасности используются необработанные асимметричные ключи и необработанные подписи. Они используют форматы на основе JSON, такие как JSON Web tokens & веб-ключи JSON.

### <a name="securing-update-content-via-the-update-manifest"></a>Защита содержимого обновления с помощью манифеста обновления

Манифест обновления проверяется с помощью двух сигнатур. Подписи создаются с помощью структуры, состоящей из ключей *подписывания* и *корневых* ключей.

Агент обновления устройства содержит внедренные открытые ключи, которые используются для всех устройств, совместимых с обновлением устройств. Это *корневые* ключи. Соответствующие закрытые ключи контролируются корпорацией Майкрософт.

Корпорация Майкрософт также создает пару из открытого и закрытого ключей, которые не включены в агент обновления устройства или хранятся на устройстве. Это ключ *подписывания* .

При импорте обновления в центр обновления для центра Интернета вещей и создании манифеста обновления служба подписывает манифест с помощью ключа подписывания и включает сам ключ подписи, который подписывается корневым ключом. При отправке на устройство манифеста обновления агент обновления получает следующие данные подписи:

1. Само значение сигнатуры.
2. Алгоритм, используемый для создания #1.
3. Сведения об открытом ключе для ключа подписывания, используемого для создания #1.
4. Подпись открытого ключа подписи в #3.
5. Идентификатор открытого ключа корневого ключа, используемого для создания #3.
6. Алгоритм, используемый для создания #4.

Агент обновления устройства использует приведенные выше сведения для проверки подписи открытого ключа подписывания корневым ключом. Затем агент обновления устройства проверяет, подписана подпись манифеста обновления ключом подписывания. Если все подписи верны, агент обновления устройства доверяет манифесту обновления. Так как манифест обновления включает в себя хэши файлов, которые соответствуют самим файлам обновления, файлы обновления могут также быть доверенными, если хэши совпадают.

Наличие корневого ключа и ключей подписывания позволяет корпорации Майкрософт периодически выполнить ключ подписывания, что рекомендуется для обеспечения безопасности.

### <a name="json-web-signature-jws"></a>JSON Web Signature (JWS)

`updateManifestSignature`Используется, чтобы гарантировать, что сведения, содержащиеся в, `updateManifest` не были изменены. `updateManifestSignature`Создается с помощью веб-подписи JSON с веб-ключами JSON, что позволяет выполнять проверку исходного кода. Сигнатура представляет собой строку в кодировке Base64Url с тремя разделами, разделенными ".".  См. [вспомогательные методы jws_util. h](https://github.com/Azure/iot-hub-device-update/tree/main/src/utils/jws_utils) для синтаксического анализа и проверки ключей и маркеров JSON.

Веб-сигнатура JSON — широко используемый [стандарт IETF](https://tools.ietf.org/html/rfc7515) для подписывания содержимого с использованием структур данных на основе JSON. Это способ обеспечения целостности данных путем проверки подписи данных. Дополнительные сведения можно найти в веб-подписи JSON (ЖВС) [RFC 7515](https://www.rfc-editor.org/info/rfc7515).

### <a name="json-web-token"></a>JSON Web Token

Веб-маркеры JSON — это открытый промышленный [стандарт](https://tools.ietf.org/html/rfc7519) , обеспечивающий безопасное представление утверждений между двумя сторонами.

### <a name="root-keys"></a>Корневые ключи

Каждое устройство обновления устройства содержит набор корневых ключей. Эти ключи являются корнем доверия для всех подписей обновления устройства. Любая подпись должна быть установлена в цепочку через один из этих корневых ключей, чтобы считаться допустимой.

С течением времени набор корневых ключей будет изменяться по мере необходимости периодического вращения ключей подписывания в целях безопасности. В результате программное обеспечение агента обновления устройства нуждается в обновлении с последним набором корневых ключей. 

### <a name="signatures"></a>Сигнатуры

Все подписи будут обрабатываться ключом подписывания (открытый), подписанным одним из корневых ключей. Подпись определяет, какой корневой ключ использовался для подписания ключа подписывания. 

Агент обновления устройства должен проверять подписи, сначала подтверждая правильность подписи (открытого) подписанного ключа, ее допустимость и подписывание одним из утвержденных корневых ключей. После успешной проверки подписанного ключа подпись может быть проверена с помощью открытого ключа подписанного доверия.

Ключи подписывания поворачиваются на гораздо более быструю ритмичность, чем корневые ключи, поэтому следует рассчитывать на сообщения, подписанные различными ключами подписывания. 

Отзыв ключа подписывания управляется службой обновления устройств, поэтому пользователи не должны пытаться кэшировать ключи подписывания. Всегда используйте ключ подписывания, сопровождающий подпись.

### <a name="receiving-updates"></a>Получение обновлений

Запросы на обновление, получаемые агентом обновления устройства, будут содержать документ подписанного манифеста обновления (UM). Агент должен проверить правильность и неизменность подписи UM. Это делается путем проверки того, что ключ подписывания единой системы обмена сообщениями подписан с помощью правильного корневого ключа. После этого агент проверяет подпись UM с помощью ключа подписывания.

После проверки подписи UM агент обновления устройства может доверять его как источнику истинности. Все дальнейшие доверительные отношения с безопасностью из этого источника. 

В UM содержатся URL-адреса и хэши файлов содержимого для скачивания и установки. После того как агент загрузил двоичный файл обновления, он должен проверить обновление по хэшу файла, найденного в UM. Это обеспечивает модель транзитивное доверие для проверки загрузки. Он не только гарантирует, что содержимое не изменяется (не изменено), а также подтверждает, что загружаемый объект был действительно предназначен для загрузки. 

### <a name="securing-the-device"></a>Защита устройства

Важно обеспечить правильную защиту и защиту ресурсов безопасности, связанных с обновлением устройства, на устройстве. Ресурсы, такие как корневые ключи, должны быть защищены от изменения. Это можно сделать разными способами, например с помощью устройств безопасности (TPM, SGX, HSM, других устройств безопасности) или даже с жестким кодированием в агенте обновления устройства. В последнем случае необходимо, чтобы код агента обновления устройства был подписан цифровой подписью, а поддержка целостности кода системы была включена для защиты от вредоносного изменения кода агента.

Можно использовать дополнительные меры безопасности, такие как обеспечение безопасности передачи от компонента к компоненту. Например, регистрация конкретной изолированной учетной записи для выполнения различных компонентов. И ограничение сетевого взаимодействия (например, REST API вызовов) только к localhost.

**[Следующий шаг: Дополнительные сведения о том, как в обновлении устройства используется Azure RBAC](.\device-update-control-access.md)**