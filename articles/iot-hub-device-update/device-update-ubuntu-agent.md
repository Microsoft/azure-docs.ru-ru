---
title: 'Руководство по Обновлению устройств для Центра Интернета вещей Azure: использование агента пакетов Ubuntu Server 18.04 x64 | Документация Майкрософт'
description: 'Начало работы с Обновлением устройств для Центра Интернета вещей Azure: использование агента пакетов Ubuntu Server 18.04 x64.'
author: vimeht
ms.author: vimeht
ms.date: 2/16/2021
ms.topic: tutorial
ms.service: iot-hub-device-update
ms.openlocfilehash: 19be3b141fb663ea0f4f11d811bf6ffc33252504
ms.sourcegitcommit: b4647f06c0953435af3cb24baaf6d15a5a761a9c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/02/2021
ms.locfileid: "101659056"
---
# <a name="device-update-for-azure-iot-hub-tutorial-using-the-ubuntu-server-1804-x64-package-agent"></a>Руководство по Обновлению устройств для Центра Интернета вещей Azure: использование агента пакетов Ubuntu Server 18.04 x64

Обновление устройств для Центра Интернета вещей поддерживает два вида обновлений: на основе образов или пакетов.

Обновления на основе пакетов являются целевыми и изменяют только конкретный компонент или приложение на устройстве. Благодаря этому меньше используется пропускная способность и сокращается время скачивания и установки обновления. Обновления на основе пакетов, как правило, позволяют сократить время простоя обновляемых устройств и избежать расходов, связанных с созданием образов.

В этом руководстве даны пошаговые инструкции, которые помогут выполнить комплексное обновление на основе пакетов с помощью Обновления устройств для Центра Интернета вещей. В этом руководством описывается работа со взятым для примера агентом пакетов для Ubuntu Server 18.04 x64. Даже если вы планируете использовать другую конфигурацию платформы ОС, это руководство будет вам полезно — в нем содержится информация об инструментах Обновления устройств для Центра Интернета и связанных с ним основных понятиях. Дочитайте это введение в комплексный процесс обновления, а затем выберите предпочтительный способ обновления и платформу ОС, чтобы узнать больше. Это руководство поможет вам использовать Обновление устройств для Центра Интернета вещей, чтобы обновить устройства с поддержкой Интернета вещей Azure или Azure IoT Edge. 

Из этого учебного курса вы узнаете следующее:
> [!div class="checklist"]
> * Настройка репозитория пакетов обновления устройств
> * Скачивание и установка агента обновления устройств и его зависимостей
> * Добавление тега на устройство Интернета вещей
> * Импорт обновления
> * Создание группы устройств
> * Развертывание обновления на основе пакета
> * Слежение за развертыванием обновления

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

## <a name="prerequisites"></a>Предварительные требования
* Доступ к Центру Интернета вещей. Рекомендуется использовать уровень S1 (стандартный) или выше.
* Устройство с поддержкой Интернета вещей Azure или Azure IoT Edge под управлением Ubuntu Server 18.04 x64, подключенное к Центру Интернета вещей.
   * Если вы используете устройство с Azure IoT Edge, убедитесь, что на нем применяется среда выполнения Edge версии 1.2.0 или выше. 
* Если вы не используете устройство Azure IoT Edge, [установите последнюю (предварительную) версию пакета `aziot-identity-service` на устройстве Интернета вещей](https://github.com/Azure/iot-identity-service/actions/runs/575919358). 
* [Учетная запись Обновления устройств и экземпляр, связанный с упомянутым выше Центром Интернета вещей.](create-device-update-account.md)

## <a name="configure-device-update-package-repository"></a>Настройка репозитория пакетов обновления устройств

1. Установите конфигурацию репозитория, соответствующую операционной системе устройства. В этом руководстве речь идет об Ubuntu Server 18.04. 
   
   ```shell
      curl https://packages.microsoft.com/config/ubuntu/18.04/multiarch/prod.list > ./microsoft-prod.list
   ```

2. Скопируйте созданный список в каталог sources.list.d.

   ```shell
      sudo cp ./microsoft-prod.list /etc/apt/sources.list.d/
   ```
   
3. Установите открытый ключ Microsoft GPG.

   ```shell
      curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg
      sudo cp ./microsoft.gpg /etc/apt/trusted.gpg.d/
   ```

## <a name="install-device-update-deb-agent-packages"></a>Установка пакетов агента Обновления устройств в формате DEB

1. Обновите списки пакетов на устройстве.

   ```shell
      sudo apt-get update
   ```

2. Установите пакет deviceupdate-agent и его зависимости.

   ```shell
      sudo apt-get install deviceupdate-agent deliveryoptimization-plugin-apt
   ```

На программные пакеты Обновления устройств для Центра Интернета вещей Azure распространяются условия следующих лицензий:
   * [Лицензия на Обновление устройств для Центра Интернета вещей](https://github.com/Azure/iot-hub-device-update/blob/main/LICENSE.md)
   * [Клиентская лицензия на оптимизацию доставки](https://github.com/microsoft/do-client/blob/main/LICENSE.md)
   
Прежде чем использовать пакет, ознакомьтесь с условиями лицензии. Установка и использование пакета означают, что вы принимаете эти условия. Если вы с ними не согласны, не используйте пакет.

## <a name="configure-device-update-agent-using-azure-iot-identity-service-preview"></a>Настройка агента обновления устройств с помощью предварительной версии службы идентификации Интернета вещей Azure

После установки требуемых пакетов необходимо подготовить устройство, разместив на нем облачное удостоверение и сведения для проверки подлинности.

1. Откройте файл конфигурации.

   ```shell
      sudo nano /etc/aziot/config.toml
   ```

2. Найдите в нем раздел конфигурации подготовки. Раскомментируйте раздел "Подготовка вручную с помощью строки подключения". Замените значение connection_string на строку подключения для устройства Интернета вещей (Edge). Убедитесь, что все остальные разделы подготовки закомментированы.


   ```toml
      # Manual provisioning configuration using a connection string
      [provisioning]
      source = "manual"
      iothub_hostname = "<REQUIRED IOTHUB HOSTNAME>"
      device_id = "<REQUIRED DEVICE ID PROVISIONED IN IOTHUB>"
      dynamic_reprovisioning = false 
   ```

3. Сохраните и закройте файл, нажав клавиши CTRL+X, Y.

4. Примените конфигурацию. 

   Для устройства IoT Edge используйте следующую команду. 
   
   ```shell
      sudo iotedge config apply
   ```
   
   Для устройства Интернета вещей с установленным пакетом `aziot-identity-service` используйте следующую команду. 
      
   ```shell
      sudo aziotctl config apply
   ```

5. При необходимости можно проверить, работают ли службы:

    ```shell
       sudo systemctl list-units --type=service | grep 'adu-agent\.service\|deliveryoptimization-agent\.service'
    ```

    Результат должен выглядеть примерно так:

    ```markdown
       adu-agent.service                   loaded active running Device Update for IoT Hub Agent daemon.

       deliveryoptimization-agent.service               loaded active running deliveryoptimization-agent.service: Performs content delivery optimization tasks   `
    ```

## <a name="add-a-tag-to-your-device"></a>Добавление тега на устройство

1. Войдите на [портал Azure](https://portal.azure.com) и откройте Центр Интернета вещей.

2. В разделе "Устройства Интернета вещей" или "IoT Edge" на панели навигации слева найдите ваше устройство Интернета вещей и откройте “Двойник устройства”.

3. В разделе “Двойник устройства” удалите все существующие значения тега обновления устройства, присвоив им значение null.

4. Добавьте новое значение тега обновления устройства, как показано ниже.

```JSON
    "tags": {
            "ADUGroup": "<CustomTagValue>"
            }
```

## <a name="import-update"></a>Импорт обновлений

1. Скачайте следующий [файл манифеста APT](https://github.com/Azure/iot-hub-device-update/tree/main/docs/sample-artifacts/libcurl4-doc-apt-manifest.json) и [импортируйте его](https://github.com/Azure/iot-hub-device-update/tree/main/docs/sample-artifacts/sample-package-update-1.0.1-importManifest.json). Этот манифест APT установит последнюю доступную версию `libcurl4-doc package` на устройство Интернета вещей. 

   Либо скачайте этот [файл манифеста APT](https://github.com/Azure/iot-hub-device-update/tree/main/docs/sample-artifacts/libcurl4-doc-7.58-apt-manifest.json) и [импортируйте его](https://github.com/Azure/iot-hub-device-update/tree/main/docs/sample-artifacts/sample-package-update-2-2.0.1-importManifest.json). В этом случае на устройстве Интернета вещей будет установлен `libcurl4-doc package` особой версии 7.58.0. 

2. На портале Azure в Центре Интернета вещей выберите вариант “Обновления устройств” в разделе “Автоматическое управление устройствами” на панели навигации слева.

3. Откройте вкладку “Обновления”.

4. Выберите "+ Импортировать новое обновление".

5. Щелкните значок папки или текстовое поле в разделе "Выберите файл манифеста импорта". На экране появится диалоговое окно выбора файлов. Выберите ранее скачанный манифест импорта. Затем щелкните значок папки или текстовое поле в разделе "Выберите один или несколько файлов обновлений". На экране появится диалоговое окно выбора файлов. Выберите ранее скачанный файл обновления манифеста APT.
   
   :::image type="content" source="media/import-update/select-update-files.png" alt-text="Снимок экрана, на котором показан выбор файла обновления." lightbox="media/import-update/select-update-files.png":::

6. Щелкните значок папки или текстовое поле в разделе "Выберите контейнер хранилища". Затем выберите соответствующую учетную запись хранения.

7. Если контейнер уже создан, его можно использовать повторно. (В противном случае выберите "+ Контейнер", чтобы создать новый контейнер хранилища для обновлений.)  Выделите контейнер для использования и нажмите кнопку “Выбрать”.

   :::image type="content" source="media/import-update/container.png" alt-text="Снимок экрана, на котором показан выбор контейнера." lightbox="media/import-update/container.png":::

8. Нажмите кнопку “Отправить”, чтобы запустить процесс импорта.

9. Начнется процесс импорта, а на экране появится раздел "Журнал импорта". Выберите "Обновить", чтобы просмотреть, сколько осталось до завершения импорта. Этот процесс может занять несколько минут или несколько дольше — все зависит от размера обновления.
   
   :::image type="content" source="media/import-update/update-publishing-sequence-2.png" alt-text="Снимок экрана, на котором показана последовательность импорта обновления." lightbox="media/import-update/update-publishing-sequence-2.png":::

10. Если столбец “Состояние” сигнализирует, что импорт успешно выполнен, выберите заголовок "Готово к развертыванию". Импортированное обновление должно появиться в списке.

[Подробнее](import-update.md) об импорте обновлений.

## <a name="create-update-group"></a>Создание группы обновлений

1. Откройте Центр Интернета вещей, ранее подключенный к экземпляру Обновления устройств.

2. Выберите вариант “Обновления устройств” в разделе “Автоматическое управление устройствами” на панели навигации слева.

3. Щелкните вкладку “Группы” в верхней части страницы. 

4. Нажмите кнопку “Добавить”, чтобы создать новую группу.

5. Выберите из списка тег Центра Интернета вещей, созданный в предыдущем шаге. Щелкните “Создать группу обновлений”.

   :::image type="content" source="media/create-update-group/select-tag.PNG" alt-text="Снимок экрана, на котором показан выбор тега." lightbox="media/create-update-group/select-tag.PNG":::

[Подробнее](create-update-group.md) о добавлении тегов и создании групп обновлений


## <a name="deploy-update"></a>Развертывание обновления

1. Когда группа создана, должно появиться новое обновление, доступное вашей группе устройств. Ссылка на него будет отображаться в разделе “Ожидающие обновления”. Чтобы ее увидеть, возможно, потребуется обновить страницу. 

2. Щелкните доступное обновление.

3. Подтвердите, что целевая группа выбрана правильно. Запланируйте развертывание, а затем нажмите “Развернуть обновление”.

   :::image type="content" source="media/deploy-update/select-update.png" alt-text="Выбор обновления" lightbox="media/deploy-update/select-update.png":::

4. Посмотрите на диаграмму соответствия требованиям. По ней должно быть видно, что процесс обновления выполняется. 

   :::image type="content" source="media/deploy-update/update-in-progress.png" alt-text="Выполняется обновление" lightbox="media/deploy-update/update-in-progress.png":::

5. После успешного обновления устройства диаграмма соответствия требованиям и сведения о развертывании должны измениться, отражая одну и ту же информацию. 

   :::image type="content" source="media/deploy-update/update-succeeded.png" alt-text="Обновление выполнено" lightbox="media/deploy-update/update-succeeded.png":::

## <a name="monitor-an-update-deployment"></a>Слежение за развертыванием обновления

1. Щелкните вкладку “Развертывания” в верхней части страницы.

   :::image type="content" source="media/deploy-update/deployments-tab.png" alt-text="Вкладка “Развертывания”" lightbox="media/deploy-update/deployments-tab.png":::

2. Выберите созданное развертывание, чтобы просмотреть сведения о нем.

   :::image type="content" source="media/deploy-update/deployment-details.png" alt-text="Сведения о развертывании" lightbox="media/deploy-update/deployment-details.png":::

3. Щелкните “Обновить”, чтобы просмотреть последние данные о состоянии. Делайте так, пока состояние не изменится на "Выполнено".

Теперь вы успешно выполнили комплексное обновление на основе пакета на устройстве с Ubuntu Server 18.04 x64 с помощью Обновления устройств для Центра Интернета вещей. 

## <a name="bonus-steps"></a>Дополнительные шаги

1. Скачайте следующий [файл манифеста APT](https://github.com/Azure/iot-hub-device-update/tree/main/docs/sample-artifacts/libcurl4-doc-remove-apt-manifest.json) и [импортируйте его](https://github.com/Azure/iot-hub-device-update/tree/main/docs/sample-artifacts/sample-package-update-1.0.2-importManifest.json). Этот манифест APT удалит установленный `libcurl4-doc package` с устройства Интернета вещей. 

2. Повторите разделы "Импорт обновлений" и "Развертывание обновления"

## <a name="clean-up-resources"></a>Очистка ресурсов

Очистите учетную запись обновления устройства, экземпляр, Центр Интернета вещей и устройство Интернета вещей, если они больше не нужны. Чтобы это сделать, выбирайте каждый ресурс отдельно и нажимайте "Удалить". Обратите внимание, что перед очисткой учетной записи обновления устройства необходимо очистить экземпляр обновления устройства. 

## <a name="next-steps"></a>Дальнейшие действия

> [!div class="nextstepaction"]
> [Руководство по обновлению устройства Raspberry Pi 3 B+ с помощью образа](device-update-raspberry-pi.md)

