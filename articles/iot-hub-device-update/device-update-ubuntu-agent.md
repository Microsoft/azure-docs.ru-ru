---
title: 'Руководство по Обновлению устройств для Центра Интернета вещей Azure: использование агента пакетов Ubuntu Server 18.04 x64 | Документация Майкрософт'
description: 'Начало работы с Обновлением устройств для Центра Интернета вещей Azure: использование агента пакетов Ubuntu Server 18.04 x64.'
author: vimeht
ms.author: vimeht
ms.date: 2/16/2021
ms.topic: tutorial
ms.service: iot-hub-device-update
ms.openlocfilehash: 6464ad632251053ac481fbd1f6a3e1197aa470df
ms.sourcegitcommit: 9f4510cb67e566d8dad9a7908fd8b58ade9da3b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/01/2021
ms.locfileid: "106121308"
---
# <a name="device-update-for-azure-iot-hub-tutorial-using-the-package-agent-on-ubuntu-server-1804-x64"></a>Руководство по Обновлению устройств для Центра Интернета вещей Azure: использование агента пакетов Ubuntu Server 18.04 x64

Обновление устройств для Центра Интернета вещей поддерживает два вида обновлений: на основе образов или пакетов.

Обновления на основе пакетов являются целевыми и изменяют только конкретный компонент или приложение на устройстве. Благодаря этому меньше используется пропускная способность и сокращается время скачивания и установки обновления. Обновления на основе пакетов, как правило, позволяют сократить время простоя обновляемых устройств и избежать расходов, связанных с созданием образов.

Это полное руководство содержит инструкции по обновлению Azure IoT Edge на сервере Ubuntu 18.04 x64 с помощью агента пакета обновления устройства. Хотя в руководстве показано, как обновить IoT Edge, эту процедуру можно использовать для обновления других пакетов, например обработчика контейнера, который он использует.

Средства и основные понятия в этом руководстве применяются, даже если вы планируете использовать другую конфигурацию платформы ОС. Дочитайте это введение в комплексный процесс обновления, а затем выберите предпочтительный способ обновления и платформу ОС, чтобы узнать больше.

Из этого учебного курса вы узнаете следующее:
> [!div class="checklist"]
> * Скачивание и установка агента Обновления устройств и его зависимостей
> * Добавление тега на устройство
> * Импорт обновления
> * Создание группы устройств
> * Развертывание обновления на основе пакета
> * Слежение за развертыванием обновления

## <a name="prerequisites"></a>Предварительные требования

* Если вы еще это не сделали, создайте [учетную запись обновления устройства и экземпляр](create-device-update-account.md), включая настройку Центра Интернета вещей.
* [Строка подключения для устройства IoT Edge](../iot-edge/how-to-register-device.md?view=iotedge-2020-11&preserve-view=true#view-registered-devices-and-retrieve-connection-strings).

## <a name="prepare-a-device"></a>Подготовка устройства
### <a name="using-the-automated-deploy-to-azure-button"></a>Использование кнопки автоматического развертывания в Azure

Для удобства в этом руководстве используется [шаблон Azure Resource Manager](../azure-resource-manager/templates/overview.md) на основе [cloud-init](../virtual-machines/linux/using-cloud-init.md), который поможет быстро настроить виртуальную машину LTS Ubuntu 18.04. Он устанавливает среду выполнения IoT Edge, а также агента пакета Обновления устройств, а затем автоматически настраивает устройство с помощью сведений о подготовке, используя строку подключения устройства для предоставленного устройства IoT Edge (предварительное требование). Шаблон Azure Resource Manager также позволяет избежать необходимости запуска сеанса SSH для завершения установки.

1. Чтобы приступить, нажмите кнопку ниже.

   [![Кнопка "Развернуть в Azure" для iotedge-vm-deploy](https://aka.ms/deploytoazurebutton)](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fazure%2Fiotedge-vm-deploy%2Fdevice-update-tutorial%2FedgeDeploy.json)

1. В открывшемся окне заполните доступные поля формы.

    > [!div class="mx-imgBorder"]
    > [![Снимок экрана с шаблоном iotedge-vm-deploy](../iot-edge/media/how-to-install-iot-edge-ubuntuvm/iotedge-vm-deploy.png)](../iot-edge/media/how-to-install-iot-edge-ubuntuvm/iotedge-vm-deploy.png)

    **Подписка**. Активная подписка Azure для развертывания виртуальной машины.

    **Группа ресурсов**. Существующая или только что созданная группа ресурсов, содержащая виртуальную машину и связанные с ней ресурсы.

    **Префикс метки DNS**. Необходимое значение, которое используется для добавления префикса имени узла виртуальной машины.

    **Имя пользователя администратора**. Имя пользователя, которому при развертывании будут предоставлены привилегии суперпользователя.

    **Строка подключения устройства**. [Строка подключения](../iot-edge/how-to-register-device.md) для устройства, созданного в предполагаемом [Центре Интернета вещей](../iot-hub/about-iot-hub.md).

    **Размер виртуальной машины**. [Размер](../cloud-services/cloud-services-sizes-specs.md) развертываемой виртуальной машины.

    **Версия ОС Ubuntu**. Версия операционной системы Ubuntu, устанавливаемая на базовую виртуальную машину. Оставьте значение по умолчанию, поскольку для этого поля оно уже будет задано на Ubuntu 18.04-LTS.

    **Расположение**. [Географический регион](https://azure.microsoft.com/global-infrastructure/locations/) для развертывания виртуальной машины, это значение по умолчанию соответствует расположению выбранной группы ресурсов.

    **Тип проверки подлинности**. Выберите **sshPublicKey** или **пароль** в зависимости от ваших предпочтений.

    **Пароль или ключ администратора**. Значение открытого ключа SSH или значение пароля в зависимости от выбранного типа проверки подлинности.

    После заполнения всех полей установите флажок в нижней части страницы, чтобы принять условия, и выберите **Приобрести**, чтобы начать развертывание.

1. Убедитесь, что развертывание выполнено успешно. Подождите несколько минут после развертывания, чтобы дать процессам пост-установки и настройки завершить установку IoT Edge и агента обновления пакета устройства.

   Ресурс виртуальной машины должен быть развернут в выбранной группе ресурсов.  Запишите имя компьютера, которое должно быть указано в формате `vm-0000000000000`. Кроме того, запишите связанное **DNS-имя**, которое должно быть в формате `<dnsLabelPrefix>`.`<location>`.cloudapp.azure.com.

    **DNS-имя** указано в разделе **Обзор** развернутой виртуальной машины на портале Azure.

    > [!div class="mx-imgBorder"]
    > [![Экран "Снимок экрана: DNS-имя виртуальной машины iotedge"](../iot-edge/media/how-to-install-iot-edge-ubuntuvm/iotedge-vm-dns-name.png)](../iot-edge/media/how-to-install-iot-edge-ubuntuvm/iotedge-vm-dns-name.png)

   > [!TIP]
   > Если после завершения установки вы хотите подключиться к этой виртуальной машине по протоколу SSH, используйте соответствующее **DNS-имя** с помощью команды: `ssh <adminUsername>@<DNS_Name>`

### <a name="optional-manually-prepare-a-device"></a>(Необязательно) Подготовка устройства вручную
Как и в случае с процедурами, выполняемыми автоматически с помощью [скрипта cloud-init](https://github.com/Azure/iotedge-vm-deploy/blob/1.2.0-rc4/cloud-init.txt), для установки и настройки устройства необходимо выполнить вручную следующие действия. Их можно использовать для подготовки физического устройства.

1. Следуйте инструкциям из статьи [Установка среды выполнения Azure IoT Edge](../iot-edge/how-to-install-iot-edge.md?view=iotedge-2020-11&preserve-view=true).
   > [!NOTE]
   > Агент пакета обновления устройства не зависит от IoT Edge. Однако он использует управляющую программу службы идентификации Интернета вещей, которая устанавливается вместе с IoT Edge (версия 1.2.0 и более поздние) для получения удостоверения и подключения к Центру Интернета вещей.
   >
   > Хотя управляющая программа службы идентификации Интернета вещей не рассматривается в этом руководстве, [ее можно установить изолированно на устройствах Интернета вещей под управлением Linux](https://azure.github.io/iot-identity-service/packaging.html). Последовательность установки имеет большое значение. Агент пакета Обновления устройств необходимо устанавливать _после_ службы идентификации Интернета вещей. В противном случае агент пакета не будет зарегистрирован как авторизованный компонент для установления соединения с Центром Интернета вещей.

1. Затем установите DEB-пакеты агента Обновления устройств.

   ```bash
   sudo apt-get install deviceupdate-agent deliveryoptimization-plugin-apt 
   ```

На программные пакеты Обновления устройств для Центра Интернета вещей Azure распространяются условия следующих лицензий:
  * [Лицензия на Обновление устройств для Центра Интернета вещей](https://github.com/Azure/iot-hub-device-update/blob/main/LICENSE.md)
  * [Клиентская лицензия на оптимизацию доставки](https://github.com/microsoft/do-client/blob/main/LICENSE)

Прежде чем использовать пакет, ознакомьтесь с условиями лицензии. Установка и использование пакета означают, что вы принимаете эти условия. Если вы с ними не согласны, не используйте пакет.

## <a name="add-a-tag-to-your-device"></a>Добавление тега на устройство

1. Войдите на [портал Azure](https://portal.azure.com) и откройте Центр Интернета вещей.

2. В IoT Edge на панели навигации слева найдите свое устройство IoT Edge и откройте "Двойник устройства" или "Двойник модуля".

3. В двойнике модуля агента обновления устройства удалите все существующие значения тегов обновления устройства, присвоив им значение null. Если вы используете удостоверение устройства с агентом обновления устройства, внесите эти изменения в двойник устройства.

4. Добавьте новое значение тега обновления устройства, как показано ниже.

```JSON
    "tags": {
            "ADUGroup": "<CustomTagValue>"
            },
```

## <a name="import-update"></a>Импорт обновлений

1. Перейдите на страницу [выпусков Обновления устройств](https://github.com/Azure/iot-hub-device-update/releases) на GitHub и щелкните раскрывающийся список Assets (Ресурсы).

3. Скачайте файл `Edge.package.update.samples.zip`, щелкнув его.

5. Извлеките содержимое папки, чтобы найти пример обновления и соответствующие ему манифесты импорта. 

2. На портале Azure в Центре Интернета вещей выберите вариант “Обновления устройств” в разделе “Автоматическое управление устройствами” на панели навигации слева.

3. Откройте вкладку “Обновления”.

4. Выберите "+ Импортировать новое обновление".

5. Щелкните значок папки или текстовое поле в разделе "Выберите файл манифеста импорта". На экране появится диалоговое окно выбора файлов. Выберите манифест импорта `sample-1.0.1-aziot-edge-importManifest.json` из скачанной ранее папки. Затем щелкните значок папки или текстовое поле в разделе "Выберите один или несколько файлов обновлений". На экране появится диалоговое окно выбора файлов. Выберите файл обновления манифеста APT `sample-1.0.1-aziot-edge-apt-manifest.json` из скачанной ранее папки.
Это обновление обновит пакеты `aziot-identity-service` и `aziot-edge` до версии 1.2.0~rc4-1 на устройстве.

   :::image type="content" source="media/import-update/select-update-files.png" alt-text="Снимок экрана, на котором показан выбор файла обновления." lightbox="media/import-update/select-update-files.png":::

6. Щелкните значок папки или текстовое поле в разделе "Выберите контейнер хранилища". Затем выберите соответствующую учетную запись хранения.

7. Если контейнер уже создан, его можно использовать повторно. (В противном случае выберите "+ Контейнер", чтобы создать новый контейнер хранилища для обновлений.)  Выделите контейнер для использования и нажмите кнопку "Выбрать".

   :::image type="content" source="media/import-update/container.png" alt-text="Снимок экрана, на котором показан выбор контейнера." lightbox="media/import-update/container.png":::

8. Нажмите кнопку "Отправить", чтобы запустить процесс импорта.

9. Начнется процесс импорта, а на экране появится раздел "Журнал импорта". Выберите "Обновить", чтобы просмотреть, сколько осталось до завершения импорта. Процесс импорта может занять несколько минут или несколько дольше — все зависит от размера обновления.

   :::image type="content" source="media/import-update/update-publishing-sequence-2.png" alt-text="Снимок экрана, на котором показана последовательность импорта обновления." lightbox="media/import-update/update-publishing-sequence-2.png":::

10. Если столбец "Состояние" сигнализирует, что импорт успешно выполнен, выберите заголовок "Готово к развертыванию". Импортированное обновление должно появиться в списке.

[Подробнее](import-update.md) об импорте обновлений.

## <a name="create-update-group"></a>Создание группы обновлений

1. Откройте Центр Интернета вещей, ранее подключенный к экземпляру Обновления устройств.

1. Выберите вариант "Обновления устройств" в разделе "Автоматическое управление устройствами" на панели навигации слева.

1. Щелкните вкладку "Группы" в верхней части страницы.

1. Нажмите кнопку "Добавить", чтобы создать новую группу.

1. Выберите из списка тег Центра Интернета вещей, созданный в предыдущем шаге. Щелкните "Создать группу обновлений".

   :::image type="content" source="media/create-update-group/select-tag.PNG" alt-text="Снимок экрана, на котором показан выбор тега." lightbox="media/create-update-group/select-tag.PNG":::

[Подробнее](create-update-group.md) о добавлении тегов и создании групп обновлений

## <a name="deploy-update"></a>Развертывание обновления

1. После создания группы должно появиться новое обновление, доступное вашей группе устройств. Ссылка на него будет отображаться в столбце _Доступные обновления_. Чтобы ее увидеть, возможно, потребуется обновить страницу.

1. Щелкните ссылку на доступное обновление.

1. Подтвердите, что целевая группа выбрана правильно, и запланируйте развертывание.

   :::image type="content" source="media/deploy-update/select-update.png" alt-text="Выбор обновления" lightbox="media/deploy-update/select-update.png":::

   > [!TIP]
   > По умолчанию дата/время начала составляет 24 часа начиная от текущего времени. Если вы хотите, чтобы развертывание началось раньше, выберите другие дату и время.

1. Выберите Deploy update (Развертывание обновления).

1. Посмотрите на диаграмму соответствия требованиям. По ней должно быть видно, что процесс обновления выполняется. 

   :::image type="content" source="media/deploy-update/update-in-progress.png" alt-text="Выполняется обновление" lightbox="media/deploy-update/update-in-progress.png":::

1. После успешного обновления устройства диаграмма соответствия требованиям и сведения о развертывании должны измениться, отражая одну и ту же информацию. 

   :::image type="content" source="media/deploy-update/update-succeeded.png" alt-text="Обновление выполнено" lightbox="media/deploy-update/update-succeeded.png":::

## <a name="monitor-an-update-deployment"></a>Слежение за развертыванием обновления

1. Щелкните вкладку "Развертывания" в верхней части страницы.

   :::image type="content" source="media/deploy-update/deployments-tab.png" alt-text="Вкладка &quot;Развертывания&quot;" lightbox="media/deploy-update/deployments-tab.png":::

1. Выберите созданное развертывание, чтобы просмотреть сведения о нем.

   :::image type="content" source="media/deploy-update/deployment-details.png" alt-text="Сведения о развертывании" lightbox="media/deploy-update/deployment-details.png":::

1. Щелкните "Обновить", чтобы просмотреть последние данные о состоянии. Делайте так, пока состояние не изменится на "Выполнено".

Теперь вы успешно выполнили комплексное обновление на основе пакета на устройстве с Ubuntu Server 18.04 x64 с помощью Обновления устройств для Центра Интернета вещей. 

## <a name="clean-up-resources"></a>Очистка ресурсов

При необходимости очистите учетную запись обновления устройства, экземпляр, Центр Интернета вещей и устройство IoT Edge (если вы создали виртуальную машину с помощью кнопки "Развертывание в Azure"). Чтобы это сделать, выбирайте каждый ресурс отдельно и нажимайте "Удалить". Перед очисткой учетной записи обновления устройства необходимо очистить экземпляр обновления устройства.

## <a name="next-steps"></a>Дальнейшие действия

> [!div class="nextstepaction"]
> [Руководство по обновлению устройства Raspberry Pi 3 B+ с помощью образа](device-update-raspberry-pi.md)
