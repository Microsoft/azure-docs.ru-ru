---
title: 'Руководство по Обновлению устройств для Центра Интернета вещей Azure: использование эталонного образа Yocto для Raspberry Pi 3 B + | Документация Майкрософт'
description: 'Начало работы с Обновлением устройств для Центра Интернета вещей Azure: использование эталонного образа Yocto для Raspberry Pi 3 B +.'
author: valls
ms.author: valls
ms.date: 2/11/2021
ms.topic: tutorial
ms.service: iot-hub-device-update
ms.openlocfilehash: 143a7c411bea6a451645c860b7b5d12d2aa8d9f5
ms.sourcegitcommit: 9f4510cb67e566d8dad9a7908fd8b58ade9da3b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/01/2021
ms.locfileid: "106121342"
---
# <a name="device-update-for-azure-iot-hub-tutorial-using-the-raspberry-pi-3-b-reference-image"></a>Руководство по Обновлению устройств для Центра Интернета вещей Azure: использование эталонного образа для Raspberry Pi 3 B +

Обновление устройств для Центра Интернета вещей поддерживает два вида обновлений: на основе образов или пакетов.

Обновления на основе образов позволяют с большей вероятностью получить требуемое конечное состояние устройства. Результаты обновления, для которого использовался образ, обычно проще реплицировать между подготовительной и рабочей средой, так как в этом случае не возникают проблемы, связанные с пакетами и их зависимостями. Благодаря целостной природе такого обновления можно легко внедрить двухузловую модель отработки отказа.

В этом руководстве даны пошаговые инструкции, которые помогут выполнить комплексное обновление на основе образа с помощью Обновления устройств для Центра Интернета вещей. 

Из этого учебного курса вы узнаете следующее:
> [!div class="checklist"]
> * Скачивание изображения
> * Добавление тега на устройство Интернета вещей
> * Импорт обновления
> * Создание группы устройств
> * Развертывание обновления на основе образа.
> * Слежение за развертыванием обновления

## <a name="prerequisites"></a>Предварительные требования
* Если вы еще это не сделали, создайте [учетную запись обновления устройства и экземпляр](create-device-update-account.md), включая настройку Центра Интернета вещей.

## <a name="download-image"></a>Скачивание изображения

В данном [выпуске Обновления устройств от GitHub](https://github.com/Azure/iot-hub-device-update/releases) в разделе Assets (Ресурсы) доступны три образа. Здесь вы найдете базовый образ (adu-base-image) и один образ для обновления (adu-update-image), поэтому можно попробовать установить различные версии, не используя на устройстве SD-карту с образом. Для этого необходимо передать образы для обновления службе “Обновление устройств для Центра Интернета вещей” путем импорта.

## <a name="flash-sd-card-with-image"></a>Запись образа на SD-карту

Используйте ваше любимое средство для записи образа ОС на устройство флэш-памяти, чтобы установить на SD-карту базовый образ Обновления устройства (adu-base-image), который будет развернут на устройстве Raspberry Pi 3 B +.

### <a name="using-bmaptool-to-flash-sd-card"></a>Использование bmaptool для записи образа на SD-карту

1. Установите служебную программу `bmaptool` (если она еще не установлена).

   ```shell
   sudo apt-get install bmap-tools
   ```

2. Укажите путь к SD-карте в `/dev`. Путь должен выглядеть примерно так: `/dev/sd*` или `/dev/mmcblk*`. Чтобы правильно указать путь, можно использовать служебную программу `dmesg`.

3. Перед записью образа необходимо отключить все подключенные разделы.

   ```shell
   sudo umount /dev/<device>
   ```

4. Проверьте, есть ли у вас разрешения для записи данных на устройство.

   ```shell
   sudo chmod a+rw /dev/<device>
   ```

5. Необязательный параметр. Чтобы ускорить запись образа, скачайте файл bimap вместе с файлом образа и поместите его в тот же каталог.

6. Запишите образ на SD-карту.

   ```shell
   sudo bmaptool copy <path to image> /dev/<device>
   ```
   
На программу “Обновление устройств для Центра Интернета вещей Azure” распространяются условия следующих лицензий:
   * [Лицензия на Обновление устройств для Центра Интернета вещей](https://github.com/Azure/iot-hub-device-update/blob/main/LICENSE.md)
   * [Клиентская лицензия на оптимизацию доставки](https://github.com/microsoft/do-client/blob/main/LICENSE)
   
Перед использованием агента ознакомьтесь с условиями лицензии. Установка и использование агента означают, что вы принимаете эти условия. Если вы с ними не согласны, не используйте агент “Обновление устройств для Центра Интернета вещей”.

## <a name="create-device-in-iot-hub-and-get-connection-string"></a>Создание устройства в Центре Интернета вещей и получение строки подключения

Теперь устройство необходимо добавить в Центр Интернета вещей Azure.  Строку подключения для устройства генерирует Центр Интернета вещей Azure.

1. Зайдите на портал Azure и запустите Центр Интернета вещей Azure.
2. Создайте новое устройство.
3. В левой части страницы выберите "Обозреватели > Устройства Интернета вещей" и нажмите "Создать".
4. Укажите имя устройства в поле "Идентификатор устройства". Убедитесь, что установлен флажок "Автоматически создавать ключи".
5. Нажмите "Сохранить".
6. Перед вами снова появится страница "Устройства". Созданное устройство должно быть в списке. Выберите его.
7. В представлении устройств выберите значок "Копировать" рядом со строкой "Основная строка подключения".
8. Вставьте скопированные знаки в другое место — они пригодятся при выполнении следующих шагов.
   **Скопированная строка и есть строка подключения устройства**.

## <a name="provision-connection-string-on-sd-card"></a>Подготовка к переносу строки подключения на SD-карту

1. Убедитесь, что устройство Raspberry Pi3 подключено к сети.
2. В PowerShell используйте приведенную ниже команду, чтобы подключиться к устройству по протоколу SSH.
   ```markdown
   ssh raspberrypi3 -l root
      ```
4. Введите имя пользователя в качестве root, но пароль не указывайте.
5. После успешного подключения к устройству по протоколу SSH выполните приведенные ниже команды.
 
Замените`<device connection string>` на строку подключения.
 ```markdown
    echo "connection_string=<device connection string>" > /adu/adu-conf.txt  
    echo "aduc_manufacturer=ADUTeam" >> /adu/adu-conf.txt
    echo "aduc_model=RefDevice" >> /adu/adu-conf.txt
   ```

## <a name="connect-the-device-in-device-update-iot-hub"></a>Подключение устройства в Центре Интернета вещей для Обновления устройства

1. В левой части страницы выберите "Устройства Интернета вещей" в разделе "Обозреватели".
2. Выберите ссылку с именем устройства.
3. В верхней части страницы щелкните пункт “Двойник устройства”.
4. В разделе опубликованных свойств двойника устройства найдите версию ядра Linux.
У нового устройства, не получившего обновление от Обновления устройств, значение [DeviceManagement:DeviceInformation:1.swVersion](device-update-plug-and-play.md) отражает версию встроенного ПО устройства.  После развертывания обновления на устройстве для указания версии встроенного ПО устройства будет использоваться значение свойства [AzureDeviceUpdateCore:ClientMetadata:4.installedUpdateId](device-update-plug-and-play.md).
5. Номер версии базового образа и образа для обновления включен в имя соответствующего файла.

   ```markdown
   adu-<image type>-image-<machine>-<version number>.<extension>
   ```

Используйте его в шаге "Импорт обновлений", которые описывается далее.

## <a name="add-a-tag-to-your-device"></a>Добавление тега на устройство

1. Войдите на [портал Azure](https://portal.azure.com) и откройте Центр Интернета вещей.

2. В разделе "Устройства Интернета вещей" или "IoT Edge" на панели навигации слева найдите ваше устройство Интернета вещей и откройте "Двойник устройства" или "Двойник модуля".

3. В двойнике модуля агента обновления устройства удалите все существующие значения тегов обновления устройства, присвоив им значение null. Если вы используете удостоверение устройства с агентом обновления устройства, внесите эти изменения в двойник устройства.

4. Добавьте новое значение тега обновления устройства, как показано ниже.

```JSON
    "tags": {
            "ADUGroup": "<CustomTagValue>"
            }
```

## <a name="import-update"></a>Импорт обновлений

1. Создайте манифест импорта, следуя этим [инструкциям](import-update.md).
2. Выберите вариант "Обновления устройств" в разделе "Автоматическое управление устройствами" на панели навигации слева.
3. Откройте вкладку “Обновления”.
4. Выберите "+ Импортировать новое обновление".
5. Щелкните значок папки или текстовое поле в разделе "Выберите файл манифеста импорта". На экране появится диалоговое окно выбора файлов. Выберите созданный манифест импорта.  Затем щелкните значок папки или текстовое поле в разделе "Выберите один или несколько файлов обновлений". На экране появится диалоговое окно выбора файлов. Выберите файл обновления, который вы хотите развернуть на устройствах IoT.
   
   :::image type="content" source="media/import-update/select-update-files.png" alt-text="Снимок экрана, на котором показан выбор файла обновления." lightbox="media/import-update/select-update-files.png":::

5. Щелкните значок папки или текстовое поле в разделе "Выберите контейнер хранилища". Затем выберите соответствующую учетную запись хранения.

6. Если контейнер уже создан, его можно использовать повторно. (В противном случае выберите "+ Контейнер", чтобы создать новый контейнер хранилища для обновлений.)  Выделите контейнер для использования и нажмите кнопку "Выбрать".
  
  :::image type="content" source="media/import-update/container.png" alt-text="Снимок экрана, на котором показан выбор контейнера." lightbox="media/import-update/container.png":::

7. Нажмите кнопку "Отправить", чтобы запустить процесс импорта.

8. Начнется процесс импорта, а на экране появится раздел "Журнал импорта". Выберите "Обновить", чтобы просмотреть, сколько осталось до завершения импорта. Этот процесс может занять несколько минут или несколько дольше — все зависит от размера обновления.
   
   :::image type="content" source="media/import-update/update-publishing-sequence-2.png" alt-text="Снимок экрана, на котором показана последовательность импорта обновления." lightbox="media/import-update/update-publishing-sequence-2.png":::

9. Если столбец "Состояние" сигнализирует, что импорт успешно выполнен, выберите заголовок "Готово к развертыванию". Импортированное обновление должно появиться в списке.

[Подробнее](import-update.md) об импорте обновлений.

## <a name="create-update-group"></a>Создание группы обновлений

1. Откройте Центр Интернета вещей, ранее подключенный к экземпляру Обновления устройств.

2. Выберите вариант "Обновления устройств" в разделе "Автоматическое управление устройствами" на панели навигации слева.

3. Щелкните вкладку "Группы" в верхней части страницы. 

4. Нажмите кнопку "Добавить", чтобы создать новую группу.

5. Выберите из списка тег Центра Интернета вещей, созданный в предыдущем шаге. Щелкните "Создать группу обновлений".

   :::image type="content" source="media/create-update-group/select-tag.PNG" alt-text="Снимок экрана, на котором показан выбор тега." lightbox="media/create-update-group/select-tag.PNG":::

[Подробнее](create-update-group.md) о добавлении тегов и создании групп обновлений


## <a name="deploy-update"></a>Развертывание обновления

1. Когда группа создана, должно появиться новое обновление, доступное вашей группе устройств. Ссылка на него будет отображаться в разделе "Ожидающие обновления". Чтобы ее увидеть, возможно, потребуется обновить страницу. 

2. Щелкните доступное обновление.

3. Подтвердите, что целевая группа выбрана правильно. Запланируйте развертывание, а затем нажмите "Развернуть обновление".

   :::image type="content" source="media/deploy-update/select-update.png" alt-text="Выбор обновления" lightbox="media/deploy-update/select-update.png":::

4. Посмотрите на диаграмму соответствия требованиям. По ней должно быть видно, что процесс обновления выполняется. 

   :::image type="content" source="media/deploy-update/update-in-progress.png" alt-text="Выполняется обновление" lightbox="media/deploy-update/update-in-progress.png":::

5. После успешного обновления устройства диаграмма соответствия требованиям и сведения о развертывании должны измениться, отражая одну и ту же информацию. 

   :::image type="content" source="media/deploy-update/update-succeeded.png" alt-text="Обновление выполнено" lightbox="media/deploy-update/update-succeeded.png":::

## <a name="monitor-an-update-deployment"></a>Слежение за развертыванием обновления

1. Щелкните вкладку "Развертывания" в верхней части страницы.

   :::image type="content" source="media/deploy-update/deployments-tab.png" alt-text="Вкладка &quot;Развертывания&quot;" lightbox="media/deploy-update/deployments-tab.png":::

2. Выберите созданное развертывание, чтобы просмотреть сведения о нем.

   :::image type="content" source="media/deploy-update/deployment-details.png" alt-text="Сведения о развертывании" lightbox="media/deploy-update/deployment-details.png":::

3. Щелкните "Обновить", чтобы просмотреть последние данные о состоянии. Делайте так, пока состояние не изменится на "Выполнено".

Теперь вы успешно выполнили комплексное обновление на основе образа на устройстве Raspberry Pi 3 B + с помощью Обновления устройств для Центра Интернета вещей. 

## <a name="clean-up-resources"></a>Очистка ресурсов

Очистите учетную запись обновления устройства, экземпляр, Центр Интернета вещей и устройство Интернета вещей, если они больше не нужны. 

## <a name="next-steps"></a>Дальнейшие действия

> [!div class="nextstepaction"]
> [Агент ссылки на симулятор](device-update-simulator.md)
