---
title: Учебник по обновлению устройств для Центра Интернета вещей Azure с помощью имитированного эталонного агента Ubuntu 18.04 (x64) | Документация Майкрософт
description: Приступите к обновлению устройств для Центра Интернета вещей Azure с помощью имитированного эталонного агента Ubuntu 18.04 (x64).
author: valls
ms.author: valls
ms.date: 2/11/2021
ms.topic: tutorial
ms.service: iot-hub-device-update
ms.openlocfilehash: 90e72bd12d9115e5ff95213428ae4ac37979dcf3
ms.sourcegitcommit: 9f4510cb67e566d8dad9a7908fd8b58ade9da3b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/01/2021
ms.locfileid: "106120101"
---
# <a name="device-update-for-azure-iot-hub-tutorial-using-the-ubuntu-1804-x64-simulator-reference-agent"></a>Обновление устройств для Центра Интернета вещей Azure с помощью имитированного эталонного агента Ubuntu 18.04 (x64)

Обновление устройств для Центра Интернета вещей поддерживает два вида обновлений: на основе образов или пакетов.

Обновления на основе образов позволяют с большей вероятностью получить требуемое конечное состояние устройства. Результаты обновления, для которого использовался образ, обычно проще реплицировать между подготовительной и рабочей средой, так как в этом случае не возникают проблемы, связанные с пакетами и их зависимостями. Благодаря целостной природе такого обновления можно легко внедрить двухузловую модель отработки отказа.

В этом руководстве даны пошаговые инструкции, которые помогут выполнить комплексное обновление на основе образа с помощью Обновления устройств для Центра Интернета вещей. 

Из этого учебного курса вы узнаете следующее:
> [!div class="checklist"]
> * Скачивание и установка образа.
> * Добавление тега на устройство Интернета вещей.
> * Импорт обновления
> * Создание группы устройств
> * Развертывание обновления на основе образа.
> * Слежение за развертыванием обновления

## <a name="prerequisites"></a>Предварительные требования
* Если вы еще это не сделали, создайте [учетную запись обновления устройства и экземпляр](create-device-update-account.md), включая настройку Центра Интернета вещей.

### <a name="download-and-install"></a>Скачивание и установка

* Командлеты az (Azure CLI) для PowerShell:
  * Откройте PowerShell и установите Azure CLI (введите "Y" (Да) в ответ на подтверждение установки из "ненадежного" источника).

```powershell
PS> Install-Module Az -Scope CurrentUser
```

### <a name="enable-wsl-on-your-windows-device-windows-subsystem-for-linux"></a>Включение подсистемы Windows для Linux (WSL) на устройстве с Windows

1. Откройте PowerShell с правами администратора на своем компьютере и выполните приведенную ниже команду (после каждого шага может появиться запрос на перезапуск, который следует выполнить):

```powershell
PS> Enable-WindowsOptionalFeature -Online -FeatureName VirtualMachinePlatform
PS> Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Windows-Subsystem-Linux
```

(*После выполнения этого шага может появиться запрос на перезапуск.* )

2. Перейдите в Microsoft Store в Интернете и установите [Ubuntu 18.04 LTS](https://www.microsoft.com/p/ubuntu-1804-lts/9n9tngvndl3q?activetab=pivot:overviewtab`).

3. Запустите "Ubuntu 18.04 LTS" и выполните установку.

4. При установке вам будет предложено задать имя корня (имя пользователя) и пароль. Обязательно используйте запоминающийся пароль для корня.

5. В PowerShell выполните приведенную ниже команду, чтобы задать Ubuntu в качестве дистрибутива Linux по умолчанию:

```powershell
PS> wsl --setdefault Ubuntu-18.04
```

6. Выведите список всех дистрибутивов Linux и убедитесь, что Ubuntu используется по умолчанию.

```powershell
PS> wsl --list
```

7. Вы должны увидеть следующее: **Ubuntu-18.04 (Default)**

## <a name="download-device-update-ubuntu-1804-x64-simulator-reference-agent"></a>Скачивание имитированного эталонного агента обновления устройств Ubuntu 18.04 (x64)

Образ обновления Ubuntu можно скачать из раздела *Assets* (Ресурсы) заметок о выпуске, доступных [здесь](https://github.com/Azure/iot-hub-device-update/releases).

Существуют две версии агента. Если вы реализуете сценарий на основе образа, то используйте AducIotAgentSim-microsoft-swupdate, а если вы реализуете сценарий на основе пакетов, то используйте AducIotAgentSim-microsoft-apt.

## <a name="install-device-update-agent-simulator"></a>Установка имитированного агента обновления устройств

1. Запустите Ubuntu WSL и введите приведенную ниже команду (обратите внимание на дополнительный пробел и точку в конце).

  ```shell
  explorer.exe .
  ```

2. Скопируйте элемент AducIotAgentSim-microsoft-swupdate (или AducIotAgentSim-microsoft-apt) из локальной папки, в которую он был скачан в /mnt, в корневую папку в WSL.

3. Используйте следующую команду, чтобы сделать двоичные файлы исполняемыми:

  ```shell
  sudo chmod u+x AducIotAgentSim-microsoft-swupdate
  ```

  или

  ```shell
  sudo chmod u+x AducIotAgentSim-microsoft-apt
  ```
На программу "Обновление устройств для Центра Интернета вещей Azure" распространяются условия следующих лицензий:
   * [Лицензия на Обновление устройств для Центра Интернета вещей](https://github.com/Azure/iot-hub-device-update/blob/main/LICENSE.md)
   * [Клиентская лицензия на оптимизацию доставки](https://github.com/microsoft/do-client/blob/main/LICENSE)
   
Перед использованием агента ознакомьтесь с условиями лицензии. Установка и использование агента означают, что вы принимаете эти условия. Если вы с ними не согласны, не используйте агент "Обновление устройств для Центра Интернета вещей".

## <a name="add-device-to-azure-iot-hub"></a>Добавление устройства в Центр Интернета вещей Azure

После запуска агента обновления на устройстве IoT это устройство необходимо добавить в центр Интернета вещей Azure.  Центр Интернета вещей Azure создаст строку подключения для данного устройства.

1. Зайдите на портал Azure и запустите Обновление устройств для Центра Интернета вещей.
2. Создайте новое устройство.
3. В левой части страницы выберите "Обозреватели > Устройства Интернета вещей" и нажмите "Создать".
4. Укажите имя устройства в поле "Идентификатор устройства". Убедитесь, что установлен флажок "Автоматически создавать ключи".
5. Щелкните "Сохранить".
6. Снова отобразится страница "Устройства". Созданное вами устройство должно быть в списке. Выберите его.
7. В представлении устройств выберите значок "Копировать" рядом со строкой "Основная строка подключения".
8. Вставьте скопированные знаки в другое место — они пригодятся при выполнении следующих шагов. **Скопированная строка и есть строка подключения устройства**.

## <a name="add-connection-string-to-simulator"></a>Добавление строки подключения в симулятор

Запустите агент обновления устройств на новых программных устройствах.

1. Запустите Ubuntu.
2. Запустите агент обновления устройств и укажите строку подключения к устройству из предыдущего раздела, заключив ее в апострофы:

Замените`<device connection string>` своей строкой подключения.
```shell
./AducIotAgentSim-microsoft-swupdate -c '<device connection string>'
```

или диспетчер конфигурации служб

```shell
./AducIotAgentSim-microsoft-apt -c '<device connection string>'
```

3. Прокрутите экран вверх и найдите строку, указывающую, что устройство находится в состоянии "Idle" (Неактивное). Состояние "Idle" (Неактивное) означает, что устройство готово к выполнению команд обслуживания:

```markdown
Agent running. [main]
```

## <a name="add-a-tag-to-your-device"></a>Добавление тега на устройство

1. Войдите на [портал Azure](https://portal.azure.com) и откройте Центр Интернета вещей.

2. В разделе "Устройства Интернета вещей" или "IoT Edge" на панели навигации слева найдите ваше устройство Интернета вещей и откройте "Двойник устройства" или "Двойник модуля".

3. В двойнике модуля агента обновления устройства удалите все существующие значения тегов обновления устройства, присвоив им значение null. Если вы используете удостоверение устройства с агентом обновления устройства, внесите эти изменения в двойник устройства.

4. Добавьте новое значение тега обновления устройства, как показано ниже.

```JSON
    "tags": {
            "ADUGroup": "<CustomTagValue>"
            }
```

## <a name="import-update"></a>Импорт обновлений

1. Создайте манифест импорта, следуя этим [инструкциям](import-update.md).
2. Выберите вариант "Обновления устройств" в разделе "Автоматическое управление устройствами" на панели навигации слева.

3. Откройте вкладку “Обновления”.

4. Выберите "+ Импортировать новое обновление".

5. Щелкните значок папки или текстовое поле в разделе "Выберите файл манифеста импорта". На экране появится диалоговое окно выбора файлов. Выберите созданный манифест импорта.  Затем щелкните значок папки или текстовое поле в разделе "Выберите один или несколько файлов обновлений". На экране появится диалоговое окно выбора файлов. Выберите образ обновления Ubuntu, скачанный ранее. 

   :::image type="content" source="media/import-update/select-update-files.png" alt-text="Снимок экрана, на котором показан выбор файла обновления." lightbox="media/import-update/select-update-files.png":::

6. Щелкните значок папки или текстовое поле в разделе "Выберите контейнер хранилища". Затем выберите соответствующую учетную запись хранения.

7. Если контейнер уже создан, его можно использовать повторно. (В противном случае выберите "+ Контейнер", чтобы создать новый контейнер хранилища для обновлений.)  Выделите контейнер для использования и нажмите кнопку "Выбрать".
  
  :::image type="content" source="media/import-update/container.png" alt-text="Снимок экрана, на котором показан выбор контейнера." lightbox="media/import-update/container.png":::

8. Нажмите кнопку "Отправить", чтобы запустить процесс импорта.

9. Начнется процесс импорта, а на экране появится раздел "Журнал импорта". Выберите "Обновить", чтобы просмотреть, сколько осталось до завершения импорта. Этот процесс может занять несколько минут или несколько дольше — все зависит от размера обновления.
   
   :::image type="content" source="media/import-update/update-publishing-sequence-2.png" alt-text="Снимок экрана, на котором показана последовательность импорта обновления." lightbox="media/import-update/update-publishing-sequence-2.png":::

10. Если столбец "Состояние" сигнализирует, что импорт успешно выполнен, выберите заголовок "Готово к развертыванию". Импортированное обновление должно появиться в списке.

[Подробнее](import-update.md) об импорте обновлений.

## <a name="create-update-group"></a>Создание группы обновлений

1. Откройте Центр Интернета вещей, ранее подключенный к экземпляру Обновления устройств.

2. Выберите вариант "Обновления устройств" в разделе "Автоматическое управление устройствами" на панели навигации слева.

3. Щелкните вкладку "Группы" в верхней части страницы. 

4. Нажмите кнопку "Добавить", чтобы создать новую группу.

5. Выберите из списка тег Центра Интернета вещей, созданный в предыдущем шаге. Щелкните "Создать группу обновлений".

   :::image type="content" source="media/create-update-group/select-tag.PNG" alt-text="Снимок экрана, на котором показан выбор тега." lightbox="media/create-update-group/select-tag.PNG":::

[Подробнее](create-update-group.md) о добавлении тегов и создании групп обновлений


## <a name="deploy-update"></a>Развертывание обновления

1. Когда группа создана, должно появиться новое обновление, доступное вашей группе устройств. Ссылка на него будет отображаться в разделе "Ожидающие обновления". Чтобы ее увидеть, возможно, потребуется обновить страницу. 

2. Щелкните доступное обновление.

3. Подтвердите, что целевая группа выбрана правильно. Запланируйте развертывание, а затем нажмите "Развернуть обновление".

   :::image type="content" source="media/deploy-update/select-update.png" alt-text="Выбор обновления" lightbox="media/deploy-update/select-update.png":::

4. Посмотрите на диаграмму соответствия требованиям. По ней должно быть видно, что процесс обновления выполняется. 

   :::image type="content" source="media/deploy-update/update-in-progress.png" alt-text="Выполняется обновление" lightbox="media/deploy-update/update-in-progress.png":::

5. После успешного обновления устройства диаграмма соответствия требованиям и сведения о развертывании должны измениться, отражая одну и ту же информацию. 

   :::image type="content" source="media/deploy-update/update-succeeded.png" alt-text="Обновление выполнено" lightbox="media/deploy-update/update-succeeded.png":::

## <a name="monitor-an-update-deployment"></a>Слежение за развертыванием обновления

1. Щелкните вкладку "Развертывания" в верхней части страницы.

   :::image type="content" source="media/deploy-update/deployments-tab.png" alt-text="Вкладка &quot;Развертывания&quot;" lightbox="media/deploy-update/deployments-tab.png":::

2. Выберите созданное развертывание, чтобы просмотреть сведения о нем.

   :::image type="content" source="media/deploy-update/deployment-details.png" alt-text="Сведения о развертывании" lightbox="media/deploy-update/deployment-details.png":::

3. Щелкните "Обновить", чтобы просмотреть последние данные о состоянии. Делайте так, пока состояние не изменится на "Выполнено".

Вы успешно выполнили полное обновление образа с помощью обновления устройств для центра Интернета вещей, использовав имитированный эталонный агент Ubuntu 18.04 (x64).

## <a name="clean-up-resources"></a>Очистка ресурсов

Очистите учетную запись обновления устройства, экземпляр, Центр Интернета вещей и устройство Интернета вещей, если они больше не нужны. 

## <a name="next-steps"></a>Дальнейшие действия

> [!div class="nextstepaction"]
> [Устранение неполадок](troubleshoot-device-update.md)

