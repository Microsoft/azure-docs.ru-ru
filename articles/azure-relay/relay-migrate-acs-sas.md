---
title: Azure Relay — миграция на авторизацию подписанного URL-доступа
description: Описывает, как перенести Azure Relay приложения с помощью службы контроля доступа Azure Active Directory в авторизацию подписанного URL.
ms.topic: article
ms.date: 06/23/2020
ms.openlocfilehash: 3b793173270b0ddf25f0e971dbb2fed97cb10a55
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "87532872"
---
# <a name="azure-relay---migrate-from-azure-active-directory-access-control-service-to-shared-access-signature-authorization"></a>Azure Relay-миграция из службы контроля доступа Azure Active Directory в авторизацию подписанного URL-доступа

В приложениях ретранслятора Azure исторически доступно две различные модели авторизации: модель токена [подписанного URL-адреса (SAS)](../service-bus-messaging/service-bus-sas.md), предоставляемая службой ретрансляции, и федеративная модель, где управление правилами выполняется внутри с помощью службы контроля доступа (ACS) [Azure Active Directory](../active-directory/index.yml). Токены, полученные из службы ACS, передаются в службу ретранслятора для авторизации доступа к необходимым компонентам.

Модель авторизации ACS долго заменяла [авторизация SAS](../service-bus-messaging/service-bus-authentication-and-authorization.md), и такая модель считалась предпочтительной. Сейчас во всей документации, руководствах и примерах используется исключительно SAS. Кроме того, больше невозможно создавать пространства имен службы ретранслятора, связанные с ACS.

Преимущество подписанного URL-адреса заключается в том, что он не зависит от другой службы, и его можно использовать напрямую из клиента без посредников, предоставив клиенту доступ к имени и ключу правила SAS. Кроме того, с SAS можно легко использовать подход, при котором клиенту нужно сначала пройти проверку авторизации в другой службе, после чего будет выдан токен. Второй подход аналогичен шаблону использования ACS, но он позволяет выдавать маркеры доступа на основе условий конкретного приложения, которые трудно выразить в ACS.

Мы настоятельно рекомендуем перенести все имеющиеся приложения, работающие с ACS, и использовать SAS.

## <a name="migration-scenarios"></a>Сценарии миграции

ACS и служба ретранслятора интегрируются за счет известного *ключа подписи*. Ключ подписи использует пространство имен ACS для подписывания токенов авторизации и служба ретранслятора Azure, чтобы убедиться, что токен выдан сопряженным пространством имен ACS. Пространство имен ACS содержит удостоверения службы и правила авторизации. Правила авторизации определяют уровень доступа удостоверения службы или токена, выданного внешним поставщиком удостоверений к части пространства имен службы ретранслятора (по самому длинному префиксу).

Например, правило ACS может предоставить удостоверению службы утверждение **Отправка** для префикса пути `/`. Это означает, что токен, выданный ACS на основе этого правила, предоставляет клиенту права на отправку всем сущностям в пространстве имен. Если префикс пути — `/abc`, удостоверение ограничивается отправкой сущностям с именем `abc` или сущностям, организованным после этого префикса. Предполагается, что читатели этого руководства по миграции уже знакомы с этими понятиями.

Сценарии миграции делятся на три основные категории:

1.  **Неизмененные значения по умолчанию.** Некоторые клиенты используют объект [SharedSecretTokenProvider](/dotnet/api/microsoft.servicebus.sharedsecrettokenprovider) при передаче автоматически созданного удостоверения службы **владельца** и его секретный ключ для пространства имен ACS, связанного с пространством имен службы ретранслятора, не добавляя новые правила.

2.  **Пользовательские удостоверения службы с простыми правилами.** Некоторые клиенты добавляют новые удостоверения службы и предоставляют каждому из них разрешения на **отправку**, **ожидание передачи данных** и **управление** для конкретной сущности.

3.  **Пользовательские удостоверения службы со сложными правилами.** Очень мало клиентов имеют наборы сложных правил, в которых токены, выданные извне, сопоставляются с правами в службе ретранслятора, или в которых одному удостоверению службы назначаются разные права по нескольким путям пространств имен в нескольких правилах.

Чтобы получить помощь по миграции наборов сложных правил, обращайтесь в [службу поддержки Azure](https://azure.microsoft.com/support/options/). Другие два сценария позволяют выполнить простую миграцию.

### <a name="unchanged-defaults"></a>Неизмененные значения по умолчанию

Если в приложении не изменились значения по умолчанию ACS, [SharedSecretTokenProvider](/dotnet/api/microsoft.servicebus.sharedsecrettokenprovider) можно заменить на объект [SharedAccessSignatureTokenProvider](/dotnet/api/microsoft.servicebus.sharedaccesssignaturetokenprovider) и использовать параметр **RootManageSharedAccessKey**, предварительно настроенный в пространстве имен, вместо учетной записи **владельца** ACS. Обратите внимание, что мы не рекомендуем использовать эту конфигурацию даже с учетной записью **владельца** ACS, так как эта учетная запись или правило предоставляет все права на управление пространством имен, включая разрешения на удаление сущностей.

### <a name="simple-rules"></a>Простые правила

Если приложение использует пользовательские удостоверения службы с простыми правилами, процесс миграции достаточно прост (если удостоверение службы ACS создано, чтобы обеспечить управление доступом на конкретном ретрансляторе). Такой сценарий часто используется в решениях SaaS, где каждый ретранслятор используется в качестве моста для клиентского сайта или филиала, для которого создается удостоверение службы. В этом случае соответствующее удостоверение службы можно перенести в правило подписанного URL-адреса непосредственно на ретрансляторе. Имя удостоверения службы может стать именем правила SAS, а его ключ — ключом правила SAS. Затем права правила SAS настраиваются в соответствии с применимым правилом ACS для сущности.

Такую новую дополнительную настройку имеющегося SAS можно выполнить в любом имеющемся пространстве имен в федерации с ACS. Дальнейшая миграция из ACS выполняется с помощью [SharedAccessSignatureTokenProvider](/dotnet/api/microsoft.servicebus.sharedaccesssignaturetokenprovider), а не [SharedSecretTokenProvider](/dotnet/api/microsoft.servicebus.sharedsecrettokenprovider). Не нужно отменять привязку пространства имен к ACS.

### <a name="complex-rules"></a>Сложные правила

Правила SAS не считаются учетными записями. Это именованные ключи подписи, связанные с правами. Таким образом в сценариях, в которых приложение создает множество удостоверений службы и предоставляет им права доступа к нескольким сущностям или ко всему пространству имен, по-прежнему требуется посредник, выпускающий токены. Рекомендации по поводу такого посредника можно получить у [специалистов службы поддержки](https://azure.microsoft.com/support/options/).

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения об аутентификации с помощью ретранслятора Azure см. в следующих разделах:

* [Проверка подлинности и авторизация в ретрансляторе Azure](relay-authentication-and-authorization.md)
* [Аутентификация служебной шины с помощью подписанных URL-адресов](../service-bus-messaging/service-bus-sas.md)
