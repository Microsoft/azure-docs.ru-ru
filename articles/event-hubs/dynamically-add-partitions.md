---
title: Динамическое добавление секций в концентратор событий (Центры событий Azure)
description: Сведения о том, как динамически добавлять секции в концентратор событий в службе "Центры событий Azure"
ms.topic: how-to
ms.date: 06/23/2020
ms.openlocfilehash: e6efdc7bab309f825032555c97f1e1128f5addd6
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "98625271"
---
# <a name="dynamically-add-partitions-to-an-event-hub-apache-kafka-topic-in-azure-event-hubs"></a>Динамическое добавление секций в концентратор событий (раздел Apache Kafka) в службе "Центры событий Azure"
Центры событий обеспечивают потоковую передачу сообщений так, чтобы каждый секционированный потребитель считывал только определенное подмножество (секцию) потока сообщений. Этот шаблон обеспечивает горизонтальное масштабирование для обработки событий и предоставляет другие функции, ориентированные на поток, которые недоступны для очередей и разделов. Секция — это упорядоченная последовательность событий, хранящаяся в концентраторе событий. По мере поступления новых событий они добавляются в конец этой последовательности. Дополнительные сведения о секциях см. в разделе [Секции](event-hubs-scalability.md#partitions).

Количество секций можно указать во время создания концентратора событий. В некоторых случаях, возможно, потребуется добавить секции после создания концентратора событий. В этой статье описано, как динамически добавлять секции в уже существующий концентратор событий. 

> [!IMPORTANT]
> Динамическое добавление секций доступно только в **выделенных** кластерах в службе "Центры событий".

> [!NOTE]
> Для клиентов Apache Kafka **концентратор событий** соответствует **разделу Kafka**. Другие сопоставления аналогичных компонентов можно найти в разделе [Сопоставление понятий Kafka и концентратора событий](event-hubs-for-kafka-ecosystem-overview.md#kafka-and-event-hub-conceptual-mapping).


## <a name="update-the-partition-count"></a>Изменение числа секций
В этом разделе показано, как изменить число секций концентратора событий разными способами (PowerShell, CLI и т. д.).

### <a name="powershell"></a>PowerShell
Чтобы изменить секции в концентраторе событий, используйте команду PowerShell [Set-AzureRmEventHub](/powershell/module/azurerm.eventhub/Set-AzureRmEventHub). 

```azurepowershell-interactive
Set-AzureRmEventHub -ResourceGroupName MyResourceGroupName -Namespace MyNamespaceName -Name MyEventHubName -partitionCount 12
```

### <a name="cli"></a>CLI
Используйте [`az eventhubs eventhub update`](/cli/azure/eventhubs/eventhub#az-eventhubs-eventhub-update) команду CLI для обновления секций в концентраторе событий. 

```azurecli-interactive
az eventhubs eventhub update --resource-group MyResourceGroupName --namespace-name MyNamespaceName --name MyEventHubName --partition-count 12
```

### <a name="resource-manager-template"></a>Шаблон Resource Manager
Чтобы изменить ресурс, задайте новое значение свойства `partitionCount` в шаблоне Resource Manager и повторно разверните этот шаблон. 

```json
    {
        "apiVersion": "2017-04-01",
        "type": "Microsoft.EventHub/namespaces/eventhubs",
        "name": "[concat(parameters('namespaceName'), '/', parameters('eventHubName'))]",
        "location": "[parameters('location')]",
        "dependsOn": [
            "[resourceId('Microsoft.EventHub/namespaces', parameters('namespaceName'))]"
        ],
        "properties": {
            "messageRetentionInDays": 7,
            "partitionCount": 12
        }
    }
```

### <a name="apache-kafka"></a>Apache Kafka
Чтобы увеличить число секций, используйте API `AlterTopics` (например, через средство CLI **kafka-topics**). Дополнительные сведения см. в статье [об изменении разделов Kafka](http://kafka.apache.org/documentation/#basic_ops_modify_topic). 

## <a name="event-hubs-clients"></a>Клиенты Центров событий
Давайте рассмотрим, как работают клиенты Центров событий при изменении числа секций в концентраторе событий. 

При добавлении секции в существующий четный концентратор клиент концентратора событий получает `MessagingException` от службы, уведомляя клиентов, что метаданные сущности (сущность — ваш концентратор событий, а метаданные — сведения о секции) были изменены. Клиенты автоматически заново открывают ссылки AMQP, что позволяет им получить измененные сведения о метаданных. После этого клиенты работают обычным образом.

### <a name="senderproducer-clients"></a>Клиенты отправителя (производителя)
Концентраторы событий поддерживают три варианта отправителей.

- **Отправитель для секции** — в этом сценарии клиенты отправляют события непосредственно в секцию. Секции можно идентифицировать и события можно отправлять напрямую в них, поэтому мы не рекомендуем использовать этот шаблон. Добавление секций никак не влияет на этот сценарий. Мы рекомендуем перезапустить приложения, чтобы они обнаружили новые секции. 
- **Отправитель ключа секции** — в этом сценарии клиенты отправляют события с ключом, чтобы все события с одним значением ключа записывались в одну секцию. При этом служба хэширует ключ и отправляет события в соответствующую секцию. Обновление количества секций может привести к неупорядоченным проблемам из-за изменения хэширования. Таким образом, если упорядочение важно для вашего сценария, дождитесь обработки всех ожидающих событий в существующих секциях, прежде чем увеличивать число секций.
- Метод **циклического перебора (по умолчанию)** . в этом сценарии служба концентраторов событий округляет Робинс событий по секциям, а также использует алгоритм балансировки нагрузки. Служба "Центры событий" получает сведения о числе секций через несколько секунд после его изменения, и сразу начинает отправку событий в новые секции.

### <a name="receiverconsumer-clients"></a>Клиенты приемника (потребителя)
Служба "Центры событий" поддерживает прямые приемники и простую библиотеку потребителей, которая называется [Узел обработчика событий (старый пакет SDK)](event-hubs-event-processor-host.md) или просто [Обработчик событий (новый пакет SDK)](event-processor-balance-partition-load.md).

- **Прямые приемники** — прослушивают определенные секции. Их поведение в среде выполнения никак не изменяется при увеличении числа секций в концентраторе событий. Приложение, которое использует прямые приемники, должно учесть наличие новых секций и назначить для них приемники соответствующим образом.
- **Узел обработчика событий** — такой клиент не обновляет метаданные сущностей автоматически. Это означает, что он не узнает об увеличении числа секций. Повторное создание экземпляра обработчика событий приведет к получению метаданных сущности, что в свою очередь активирует создание новых BLOB-объектов для новых секций. Это никак не затронет существующие BLOB-объекты. Мы рекомендуем перезапустить все экземпляры обработчика событий, чтобы все экземпляры получили информацию о новых секциях и нормально работала балансировка нагрузки между потребителями.

    Если вы используете старую версию пакета SDK для .NET ([WindowsAzure.ServiceBus](https://www.nuget.org/packages/WindowsAzure.ServiceBus/)), узел обработчика событий после перезапуска удаляет существующую контрольную точку, если число секций в этой контрольной точке не совпадает с числом секций, полученным от службы. Такое поведение может повлиять на работу приложения. 

## <a name="apache-kafka-clients"></a>Клиенты Apache Kafka
В этом разделе описано поведение клиентов Apache Kafka, которые используют предоставленную службой "Центры событий" конечную точку Kafka, в случае изменения числа секций в концентраторе событий. 

Поведение клиентов Kafka, которые работают со службой "Центры событий" по протоколу Apache Kafka, отличается от поведения клиентов концентратора событий, которые используют протокол AMQP. Клиенты Kafka обновляют свои метаданные через определенное число миллисекунд (`metadata.max.age.ms`). Это значение можно указать в конфигурациях клиента. Библиотеки `librdkafka` также используют эту конфигурацию. Обновление метаданных позволяет клиентам узнать об изменениях в службе, в том числе об увеличении количества секций. Список конфигураций см. в разделе [конфигурации Apache Kafka для концентраторов событий](apache-kafka-configurations.md).

### <a name="senderproducer-clients"></a>Клиенты отправителя (производителя)
Производители всегда требуют, чтобы запросы на отправку содержали назначение секции для каждого набора созданных записей. Это означает, что любое секционирование выполняется на стороне клиента на основании тех метаданных, которые есть у брокера производителя. После добавления новых секций в представление метаданных производителя они становятся доступны для запросов производителя.

### <a name="consumerreceiver-clients"></a>Клиенты приемника (потребителя)
Когда член группы потребителей обновляет метаданные и получает сведения о новых секциях, он инициирует перераспределение группы. Метаданные потребителя обновляются для всех членов группы и выделенный лидер перераспределения назначает им новые секции.

## <a name="recommendations"></a>Рекомендации

- Если вы используете в приложениях производителя ключ секции и хэширование ключей для сохранения упорядочения в пределах секции, мы не рекомендуем динамически добавлять секции. 

    > [!IMPORTANT]
    > Несмотря на то, что порядок существующих данных сохранится, согласованность хэширования будет нарушена в случае изменения числа секций, например при добавлении новых секций.
- Добавление секции в существующий раздел или экземпляр концентратора событий рекомендуется в следующих случаях:
    - При использовании метода отправки событий по умолчанию
     - Kafka стратегии секционирования по умолчанию, пример: стратегия прикрепления к назначению


## <a name="next-steps"></a>Дальнейшие действия
Дополнительные сведения о секциях см. в разделе [Секции](event-hubs-scalability.md#partitions).

