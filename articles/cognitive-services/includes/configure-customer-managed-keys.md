---
title: Настройка ключей, управляемых клиентом, с помощью портал Azure
titleSuffix: Cognitive Services
description: Узнайте, как использовать портал Azure для настройки ключей, управляемых клиентом, с помощью Azure Key Vault. Управляемые клиентом ключи позволяют создавать, менять, отключать и отзывать элементы управления доступом.
services: cognitive-services
author: erindormier
ms.service: cognitive-services
ms.topic: include
ms.date: 05/28/2020
ms.author: egeaney
ms.openlocfilehash: c79846b0a5b675c34e4e7919e9ecd9d591bfefe5
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "96356364"
---
## <a name="customer-managed-keys-with-azure-key-vault"></a>Управляемые клиентом ключи с использованием Azure Key Vault

Для хранения ключей, управляемых клиентом, необходимо использовать Azure Key Vault. Можно либо создать собственные ключи и хранить их в хранилище ключей, либо использовать API-интерфейсы Azure Key Vault для их генерации. Ресурс Cognitive Services и хранилище ключей должны находиться в одном и том же регионе и в одном клиенте Azure Active Directory (Azure AD), но могут находиться в разных подписках. Дополнительные сведения о Azure Key Vault см. в разделе [что такое Azure Key Vault?](../../key-vault/general/overview.md).

При создании нового ресурса Cognitive Services он всегда шифруется с помощью ключей, управляемых корпорацией Майкрософт. Невозможно включить управляемые клиентом ключи на момент создания ресурса. Ключи, управляемые клиентом, хранятся в Azure Key Vault, а хранилище ключей должно быть подготовлено с политиками доступа, которые предоставляют ключевые разрешения для управляемого удостоверения, связанного с ресурсом Cognitive Services. Управляемое удостоверение доступно только после создания ресурса с использованием ценовой категории, необходимой для CMK.

Включение управляемых ключей клиентов также позволит назначить [управляемое системой удостоверение](../../active-directory/managed-identities-azure-resources/overview.md), компонент Azure AD. После включения управляемого удостоверения, назначенного системой, этот ресурс будет зарегистрирован в Azure Active Directory. После регистрации управляемому удостоверению будет предоставлен доступ к Key Vault, выбранному во время настройки управляемого ключа клиента. 

> [!IMPORTANT]
> При отключении управляемых удостоверений, назначенных системой, доступ к хранилищу ключей будет удален, а все данные, зашифрованные с помощью ключей клиента, станут недоступны. Все функции, зависящие от этих данных, перестанут работать.

> [!IMPORTANT]
> Сейчас управляемые удостоверения не поддерживаются в сценариях работы с разными каталогами. При настройке ключей, управляемых клиентом, в портал Azure управляемое удостоверение автоматически назначается в рамках. Если впоследствии вы перемещаете подписку, группу ресурсов или ресурс из одного каталога Azure AD в другой, управляемое удостоверение, связанное с ресурсом, не передается в новый клиент, поэтому управляемые клиентом ключи могут перестать работать. Дополнительные сведения см. в статье **Передача подписки между каталогами Azure AD** в [часто задаваемых вопросах и известных проблемах с управляемыми удостоверениями для ресурсов Azure](../../active-directory/managed-identities-azure-resources/known-issues.md#transferring-a-subscription-between-azure-ad-directories).  

## <a name="configure-azure-key-vault"></a>Настройка Azure Key Vault

Для использования ключей, управляемых клиентом, необходимо, чтобы в хранилище ключей были установлены два свойства: **обратимое удаление** и **не очищать**. Эти свойства не включены по умолчанию, но их можно включить с помощью PowerShell или Azure CLI в новом или существующем хранилище ключей.

> [!IMPORTANT]
> Если вы не включили функции **обратимого удаления** **и не удаляют свойства,** а вы удалите ключ, вы не сможете восстановить данные в своем ресурсе службы.

Чтобы узнать, как включить эти свойства в имеющемся хранилище ключей, см. разделы **Включение обратимого удаления** и **Включение защиты от очистки** в одной из следующих статей:

- [Как использовать обратимое удаление в Key Vault с помощью PowerShell](../../key-vault/general/key-vault-recovery.md).
- [Как использовать обратимое удаление в Key Vault с помощью интерфейса командной строки](../../key-vault/general/key-vault-recovery.md).

С шифрованием службы хранилища Azure поддерживаются только ключи RSA размером 2048. Дополнительные сведения о ключах см. в разделе **Key Vault Keys** раздела [о Azure Key Vault ключах, секретах и сертификатах](../../key-vault/general/about-keys-secrets-certificates.md).

## <a name="enable-customer-managed-keys-for-your-resource"></a>Включение управляемых клиентом ключей для ресурса

Чтобы включить управляемый клиентом ключ на портале Azure, выполните следующие действия.

1. Перейдите к ресурсу Cognitive Services.
1. В колонке **Параметры** для Cognitive Services ресурса щелкните **Шифрование**. Выберите параметр **управляемые ключи клиента** , как показано на следующем рисунке.

    ![Снимок экрана, показывающий, как выбрать управляемые пользователем ключи](../media/cognitive-services-encryption/selectcmk.png)

## <a name="specify-a-key"></a>Укажите ключ

После включения ключей, управляемых клиентом, можно указать ключ, связываемый с ресурсом Cognitive Services.

### <a name="specify-a-key-as-a-uri"></a>Указание ключа в качестве URI

Чтобы указать ключ в качестве универсального кода ресурса (URI), выполните следующие действия.

1. Чтобы найти URI ключа в портал Azure, перейдите в хранилище ключей и выберите параметр **ключи** . Выберите нужный ключ, а затем щелкните ключ, чтобы просмотреть его версии. Выберите версию ключа, чтобы просмотреть параметры для этой версии.
1. Скопируйте значение поля **идентификатор ключа** , которое предоставляет универсальный код ресурса (URI).

    ![Снимок экрана, показывающий URI ключа хранилища ключей](../media/cognitive-services-encryption/key-uri-portal.png)

1. В параметрах **шифрования** для учетной записи хранения выберите параметр **Введите URI ключа** .
1. Вставьте URI, скопированный в поле **ключа URI** .

   ![Снимок экрана, показывающий, как ввести URI ключа](../media/cognitive-services-encryption/ssecmk2.png)

1. Укажите подписку, которая содержит хранилище ключей.
1. Сохраните изменения.

### <a name="specify-a-key-from-a-key-vault"></a>Указание ключа из хранилища ключей

Чтобы указать ключ из хранилища ключей, сначала убедитесь, что у вас есть хранилище ключей, содержащее ключ. Чтобы указать ключ из хранилища ключей, выполните следующие действия.

1. Выберите параметр **Выбрать в Key Vault**.
1. Выберите хранилище ключей, содержащее ключ, который вы хотите использовать.
1. Выберите ключ из хранилища ключей.

   ![Снимок экрана с параметром ключа, управляемого клиентом](../media/cognitive-services-encryption/ssecmk3.png)

1. Сохраните изменения.

## <a name="update-the-key-version"></a>Обновление версии ключа

При создании новой версии ключа обновите ресурс Cognitive Services для использования новой версии. Выполните следующие действия.

1. Перейдите к ресурсу Cognitive Services и отобразите параметры **шифрования** .
1. Введите универсальный код ресурса (URI) для новой версии ключа. Кроме того, можно выбрать хранилище ключей и ключ еще раз, чтобы обновить версию.
1. Сохраните изменения.

## <a name="use-a-different-key"></a>Использовать другой ключ

Чтобы изменить ключ, используемый для шифрования, выполните следующие действия.

1. Перейдите к ресурсу Cognitive Services и отобразите параметры **шифрования** .
1. Введите универсальный код ресурса (URI) для нового ключа. Кроме того, можно выбрать хранилище ключей и выбрать новый ключ.
1. Сохраните изменения.

## <a name="rotate-customer-managed-keys"></a>Смена ключей, управляемых клиентом

Вы можете периодически сменять управляемый клиентом ключ в Azure Key Vault в соответствии с применяемыми политиками соответствия требованиям. При вращении ключа необходимо обновить ресурс Cognitive Services для использования нового URI ключа. Сведения о том, как обновить ресурс для использования новой версии ключа в портал Azure, см. в разделе [Обновление версии ключа](#update-the-key-version).

Вращение ключа не вызывает повторного шифрования данных в ресурсе. От пользователя не требуется предпринимать никаких действий.

## <a name="revoke-access-to-customer-managed-keys"></a>Отозвать доступ к ключам, управляемым клиентом

Чтобы отозвать доступ к ключам, управляемым клиентом, используйте PowerShell или Azure CLI. Дополнительные сведения см. в разделе [Azure Key Vault PowerShell](/powershell/module/az.keyvault//) или [Azure Key Vault CLI](/cli/azure/keyvault). Отзыв доступа позволяет блокировать доступ ко всем данным в Cognitive Services ресурсе, так как ключ шифрования недоступен для Cognitive Services.

## <a name="disable-customer-managed-keys"></a>Отключение ключей, управляемых клиентом

При отключении ключей, управляемых клиентом, Cognitive Services ресурс шифруется с помощью ключей, управляемых корпорацией Майкрософт. Чтобы отключить управляемые клиентом ключи, выполните следующие действия.

1. Перейдите к ресурсу Cognitive Services и отобразите параметры **шифрования** .
1. Снимите флажок рядом с параметром **использовать собственный ключ** .