---
title: Учебник. Использование голосов для работы с роботами с помощью речевого пакета SDK — служба речи
titleSuffix: Azure Cognitive Services
description: В этом учебнике вы создадите эхо-робота с помощью Microsoft Bot Framework, развернете его в Azure и зарегистрируете в канале Direct Line Speech. Затем вы настроите пример клиентского приложения для Windows, который позволит вам поговорить с программой-роботом и услышать ответ.
services: cognitive-services
author: trevorbye
manager: nitinme
ms.service: cognitive-services
ms.subservice: speech-service
ms.topic: conceptual
ms.date: 02/25/2020
ms.author: trbye
ms.custom: devx-track-csharp
ms.openlocfilehash: fa449ad3d9a0e26bd0754a67581c8d63fa025e55
ms.sourcegitcommit: b0557848d0ad9b74bf293217862525d08fe0fc1d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/07/2021
ms.locfileid: "106552314"
---
# <a name="tutorial-voice-enable-your-bot-using-the-speech-sdk"></a>Руководство. Включение голосовых команд в боте с помощью пакета SDK службы "Речь"

Вы можете использовать голосовую службу, чтобы включить голосовую программу чат-робота.

В этом руководстве вы создадите робота, который повторяет то, что вы говорите.
В этом учебнике вы создадите робота с помощью Microsoft Bot Framework, развернете его в Azure и зарегистрируете в канале Direct Line Speech.
Затем вы настроите пример клиентского приложения для Windows, который позволит вам поговорить с программой-роботом и услышать ответ.

Этот учебник предназначен для разработчиков, которые не знакомы с Azure, программами-роботами, созданными в Bot Framework, службой Direct Line Speech или речевым пакетом SDK, и хотят быстро создать рабочую систему без излишнего кода. Знание или опыт работы с этими службами не требуется.

Чат-бот с поддержкой голоса, которая используется в данном учебнике, работает следующим образом.

1. Пример клиентского приложения настроен для подключения к каналу голосовой речи и эхо-роботу.
1. Когда пользователь нажимает кнопку, из микрофона начинает приниматься звуковой поток. (Либо звук начинает записываться при использовании пользовательского ключевого слова.)
1. Если используется пользовательское ключевое слово, на локальном устройстве выполняется обнаружение ключевых слов, а звуковой поток отправляется через шлюз в облако.
1. С помощью пакета SDK для распознавания речи пример клиентского приложения подключается к каналу голосовой речи и начинает отправлять аудиопоток.
1. При необходимости в службе происходит проверка ключевых слов с более высокой точностью.
1. Звук передается в службу распознавания речи и расшифровывается в текст.
1. Распознанный текст передается в эхо-робот через посредство платформы Bot Framework.
1. Текст ответа переводится в аудио службой преобразования текста в речь (TTS) и передается обратно клиентскому приложению для воспроизведения.

<!-- svg src in User Story 1754106 -->
![Схема меток](media/tutorial-voice-enable-your-bot-speech-sdk/diagram.png "Поток речевого канала")

> [!NOTE]
> Для выполнения действий, описанных в этом руководстве, не требуется платная служба. Как новый пользователь Azure вы сможете использовать кредиты бесплатной пробной подписки Azure и бесплатный уровень службы речи для завершения этого руководства.

Темы, рассматриваемые в этом руководстве:
> [!div class="checklist"]
> * Создание ресурсов Azure
> * Создание, тестирование и развертывание образца эхо-бота в службе приложений Azure
> * Регистрация программы-робота с помощью канала Direct Line Speech
> * Создание и запуск клиента Windows Voice Assistant для взаимодействия с эхо-роботом
> * Активация по пользовательскому ключевому слову
> * Вы узнаете, как изменить язык распознаваемой и произносимой речи

## <a name="prerequisites"></a>Предварительные условия

Вот что вам потребуется для прохождения этого курса.

- Компьютер с Windows 10 с рабочим микрофоном и динамиками (или наушниками)
- [Visual Studio 2017](https://visualstudio.microsoft.com/downloads/) или выше, с установленной рабочей нагрузкой **Разработка приложений ASP.NET и веб-приложений**
- [.NET Framework Runtime 4.6.1](https://dotnet.microsoft.com/download) или более поздней версии
- Учетная запись Azure. [Зарегистрируйтесь для использования бесплатной версии](https://azure.microsoft.com/free/cognitive-services/)
- Учетная запись [GitHub](https://github.com/)
- [Git для Windows](https://git-scm.com/download/win)

## <a name="create-a-resource-group"></a>Создание группы ресурсов

В клиентском приложении, которое вы создадите в этом руководстве, используется несколько служб Azure. Чтобы сократить время приема-передачи для ответов от программы-робота, необходимо убедиться, что эти службы расположены в одном регионе Azure. В этом разделе вы создадите группу ресурсов в регионе "**Западная часть США**". Эта группа ресурсов будет использоваться при создании отдельных ресурсов для Bot Framework, канала Direct Line Speech и службы распознавания речи.

1. <a href="https://ms.portal.azure.com/#create/Microsoft.ResourceGroup" target="_blank">Создайте группу ресурсов</a>
1. Вам будет предложено ввести некоторые сведения.
   * Установите **бесплатную пробную версию** **подписки** (можно также использовать существующую подписку).
   * И введите имя **группы ресурсов**. Рекомендуется **SpeechEchoBotTutorial-ResourceGroup**.
   * В раскрывающемся списке **Регион** выберите **Западная часть США**.
1. Щелкните **Проверка и создание**. Вы увидите баннер с надписью **прошедший проверку**.
1. Нажмите кнопку **Создать**. Создание группы ресурсов займет несколько минут.
1. Как и в случае с ресурсами, которые будут созданы далее в этом учебнике, рекомендуется закрепить эту группу ресурсов на панели мониторинга для упрощения доступа. Если вы хотите закрепить эту группу ресурсов, щелкните значок закрепления справа от имени группы ресурсов.

### <a name="choosing-an-azure-region"></a>Выбор региона Azure

Если вы хотите использовать другой регион для этого руководства, нижеследующие факторы могут ограничить выбор.

* Убедитесь, что вы используете [поддерживаемый регион Azure](regions.md#voice-assistants).
* В канале Direct Line Speech используется служба преобразования текста в речь, в которой имеются нейронные и стандартные голоса. Нейронные и стандартные голоса доступны в этих [регионах Azure](regions.md#neural-and-standard-voices).

Дополнительные сведения о регионах Azure см. [здесь](https://azure.microsoft.com/global-infrastructure/locations/).

## <a name="create-resources"></a>Создание ресурсов

Теперь, когда у вас есть группа ресурсов в поддерживаемом регионе, необходимо создать отдельные ресурсы для каждой службы, которая будет использоваться в этом руководстве.

### <a name="create-a-speech-service-resource"></a>Создание ресурса службы "Речь"

Для создания речевого ресурса выполните следующее.

1. <a href="https://ms.portal.azure.com/#create/Microsoft.CognitiveServicesSpeechServices" target="_blank">Создание ресурса службы "Речь"</a>
4. Вам будет предложено ввести некоторые сведения.
   * Задайте **Имя** ресурса. Рекомендуем **SpeechEchoBotTutorial-Speech**
   * Убедитесь, что для **подписки** выбрана **Бесплатная пробная версия**.
   * В разделе **Расположение** выберите **Западная часть США**.
   * Выберите категорию **F0** в поле **Ценовая категория**. Эта категория является бесплатной.
   * В качестве **группы ресурсов** выберите **SpeechEchoBotTutorial-ResourceGroup**.
5. После введения всех необходимых сведений нажмите кнопку **Создать**. Создание ресурса может занять несколько минут.
6. Далее в этом учебнике вам понадобятся ключи подписки для этой службы. Доступ к этим ключам можно получить в любое время в разделах **Обзор** ресурса (управление ключами) и **Ключи**.

На этом этапе убедитесь, что в группе ресурсов (**SpeechEchoBotTutorial-ResourceGroup**) присутствует ресурс речи:

| Имя | Тип  | Location |
|------|-------|----------|
| SpeechEchoBotTutorial-Speech | Службы Cognitive Services | западная часть США |

### <a name="create-an-azure-app-service-plan"></a>Создание плана службы приложений Azure

Следующим шагом является создание плана службы приложений. План службы приложений определяет набор вычислительных ресурсов, на которых выполняется веб-приложение.

1. Создание плана <a href="https://ms.portal.azure.com/#create/Microsoft.AppServicePlanCreate" target="_blank">службы приложений Azure</a>
4. Вам будет предложено ввести некоторые сведения.
   * Установите **бесплатную пробную версию** **подписки** (можно также использовать существующую подписку).
   * В качестве **группы ресурсов** выберите **SpeechEchoBotTutorial-ResourceGroup**.
   * Задайте **Имя** ресурса. Рекомендуется **SpeechEchoBotTutorial-AppServicePlan**
   * **Операционная система**: выберите **Windows**.
   * В поле **Регион** выберите **Западная часть США**.
   * Убедитесь, что для **ценовой категории** выбрано значение **Стандартный S1**. Этот параметр указан по умолчанию. Если это не так, убедитесь, что в списке **Операционная система** выбрана **Windows**, как описано выше.
5. Щелкните **Проверка и создание**. Вы увидите баннер с надписью **прошедший проверку**.
6. Нажмите кнопку **Создать**. Создание группы ресурсов займет несколько минут.

На этом этапе убедитесь, что в группе ресурсов (**SpeechEchoBotTutorial-ResourceGroup**) присутствуют два ресурса:

| Имя | Тип  | Location |
|------|-------|----------|
| SpeechEchoBotTutorial-AppServicePlan | План службы приложений | западная часть США |
| SpeechEchoBotTutorial-Speech | Службы Cognitive Services | западная часть США |

## <a name="build-an-echo-bot"></a>Создание эхо-робота

Теперь, когда мы создали ресурсы, давайте создадим робота. Мы начнем с образца Echo Bot, который, как следует из названия, в качестве ответа озвучивает произнесенный ему текст. Не беспокойтесь, пример кода готов к использованию без каких-либо изменений. Он настроен для работы с каналом Direct Line Speech, который мы подключим после развертывания программы-робота в Azure.

> [!NOTE]
> Приведенные ниже инструкции, а также дополнительные сведения о программе Echo Bot доступны в [файле сведений данного примера на сайте GitHub](https://github.com/microsoft/BotBuilder-Samples/blob/master/samples/csharp_dotnetcore/02.echo-bot/README.md).

### <a name="run-the-bot-sample-on-your-machine"></a>Запуск экземпляра бота на компьютере

1. Клонирование репозитория примеров.

   ```bash
   git clone https://github.com/Microsoft/botbuilder-samples.git
   ```

2. Запустите Visual Studio.
3. На панели инструментов выберите **файл** > **Открыть** > **Проект/решение** и откройте решение проекта Echo Bot.

   ```
   samples\csharp_dotnetcore\02.echo-bot\EchoBot.sln
   ```

4. После загрузки проекта нажмите клавишу <kbd>F5</kbd>, чтобы собрать и запустить проект.
5. Будет запущен браузер, и появится экран, аналогичный приведенному.
    > [!div class="mx-imgBorder"]
    > [![На снимке экрана показана страница эхо-бота с сообщением о его готовности.](media/tutorial-voice-enable-your-bot-speech-sdk/echobot-running-on-localhost.png "Эхо-бот, выполняемый на локальном компьютере")](media/tutorial-voice-enable-your-bot-speech-sdk/echobot-running-on-localhost.png#lightbox)

### <a name="test-the-bot-sample-with-the-bot-framework-emulator"></a>Тестирование образца бота с помощью эмулятора Bot Framework

Эмулятор [Bot Framework Emulator](https://github.com/microsoft/botframework-emulator) — это классическое приложение, которое позволяет разработчикам тестировать и отлаживать ботов локально или удаленно, через туннель. В качестве входных данных эмулятор принимает текст (не голос). Отвечать он также будет текстом. Выполните следующие действия, чтобы использовать эмулятор Bot Framework для проверки функционирования эхо-робота, запущенного на локальном компьютере с текстовым вводом и выводом. После развертывания бота в Azure мы протестируем его с голосовым вводом и голосовым выводом.

1. Установите [Bot Framework Emulator](https://github.com/Microsoft/BotFramework-Emulator/releases/latest) версии 4.3.0 или выше
2. Запустите эмулятор Bot Framework и откройте файл робота.
   * **File** (Файл)  -> **Open Bot**(Открыть бота).
3. Введите URL-адрес для своего бота. Пример:

   ```
   http://localhost:3978/api/messages
   ```
   Щелкните "Connect" (Подключить).
4. Программа-робот должна поприветствовать вас словами "Hello and welcome!" . Введите любое текстовое сообщение и подтвердите получение ответа от программы-робота.
5. Вот как может выглядеть обмен данными с экземпляром эхо-робота: [![на снимке экрана показан эмулятор Bot Framework.](media/tutorial-voice-enable-your-bot-speech-sdk/bot-framework-emulator.png "Эмулятор Bot Framework")](media/tutorial-voice-enable-your-bot-speech-sdk/bot-framework-emulator.png#lightbox)

## <a name="deploy-your-bot-to-an-azure-app-service"></a>Развертывание приложения в службе приложений Azure

Далее следует развернуть эхо-бота в Azure. Существует несколько способов развертывания программы-робота, но в этом учебнике мы рассмотрим публикацию непосредственно из Visual Studio.

> [!NOTE]
> Кроме того, программу-робот можно развернуть с помощью [Azure CLI](/azure/bot-service/bot-builder-deploy-az-cli) и [шаблонов развертывания](https://github.com/microsoft/BotBuilder-Samples/tree/master/samples/csharp_dotnetcore/adaptive-dialog/03.core-bot).

> [!NOTE]
> Если опция **Опубликовать...** не отображается при выполнении следующих действий, используйте Visual Studio Installer, чтобы добавить рабочую нагрузку **ASP.NET и веб-разработка**.

1. В Visual Studio откройте эхо-робота, настроенного для использования с каналом Direct Line Speech.

   ```
   samples\csharp_dotnetcore\02.echo-bot\EchoBot.sln
   ```

1. В **обозревателе решений** щелкните правой кнопкой мыши проект **EchoBot** и выберите пункт **Опубликовать...** .
1. Откроется новое окно **Publish** (Публикация).
1. Выберите **Azure**, нажмите кнопку **Далее**, выберите **служба приложений Azure (Windows)** , нажмите кнопку **Далее** и щелкните **создать новую службу приложений Azure...** рядом с зеленым знаком "плюс".
1. Когда появится окно **службы приложений (Windows)** :
   * Щелкните **Добавить учетную запись** и выполните вход с использованием учетных данных учетной записи Azure. Если вы уже вошли, выберите нужную учетную запись из раскрывающегося списка.
   * В качестве **имени** необходимо ввести глобально уникальное имя для программы-робота. Это имя используется для создания уникального URL-адреса бота. Будет заполнено значение по умолчанию с включением даты и времени (например, "EchoBot20190805125647"). Для выполнения инструкций из этого руководства вы можете использовать имя по умолчанию.
   * Для параметра **Подписка** установите значение **Бесплатная пробная версия**
   * В качестве **группы ресурсов** выберите **SpeechEchoBotTutorial-ResourceGroup**
   * В качестве **плана размещения** выберите **SpeechEchoBotTutorial-AppServicePlan**
1. Нажмите кнопку **Создать**. На последнем экране мастера настройки нажмите **Finish** (Готово).
1. Щелкните **Опубликовать** в правой части экрана публикации. Visual Studio приступит к развертыванию бота в Azure.
1. В окне вывода Visual Studio должно отобразиться сообщение об успешном выполнении, которое выглядит следующим образом.

   ```
   Publish Succeeded.
   Web App was published successfully https://EchoBot20190805125647.azurewebsites.net/
   ```

1. Браузер по умолчанию должен открыть и отобразить страницу, на которой будет написано: "Your bot is ready!" (Ваш робот готов!).
1. На этом этапе проверьте группу ресурсов **SpeechEchoBotTutorial-ResourceGroup** в портале Azure и убедитесь, что эти три ресурса присутствуют:

| Имя | Тип  | Location |
|------|-------|----------|
| EchoBot20190805125647 | Служба приложений | западная часть США |
| SpeechEchoBotTutorial-AppServicePlan | План службы приложений | западная часть США |
| SpeechEchoBotTutorial-Speech | Службы Cognitive Services | западная часть США |

## <a name="enable-web-sockets"></a>Включение протокола WebSocket

Необходимо внести небольшое изменение в конфигурацию, чтобы программа-робот могла обмениваться данными с каналом Direct Line Speech с помощью веб-сокетов. Чтобы включить веб-сокеты, выполните следующие действия.

1. Войдите на [портал Azure](https://portal.azure.com) и перейдите к службе приложений. Имя ресурс должно быть похоже на **EchoBot20190805125647** (уникальное имя вашего приложения).
2. Выберите **Конфигурация** в разделе **Параметры** на левой панели навигации.
3. Далее щелкните вкладку **Общие параметры**.
4. Выберите переключатель для **веб-сокетов** и установите для него значение **Вкл**.
5. Выберите команду **Сохранить**.

> [!TIP]
> Вы можете использовать элементы управления в верхней части страницы службы приложений Azure, чтобы прерывать или перезапускать службу. Это может быть полезным при устранении неполадок.

## <a name="create-a-channel-registration"></a>Создание регистрации канала

Теперь, когда вы создали службу приложений Azure для размещения программы Bot, следующим шагом является создание **регистрации каналов программы-робота**. Создание регистрации канала — необходимое условие для регистрации программы-робота с каналами Bot Framework, включая Direct Line Speech. Если вы хотите узнать больше об использовании каналов программами-роботами, см. статью [Подключение бота к каналам](/azure/bot-service/bot-service-manage-channels).

1. <a href="https://ms.portal.azure.com/#create/Microsoft.BotServiceConnectivityGalleryPackage" target="_blank">Создание регистрации каналов Azure для робота</a>
2. Вам будет предложено ввести некоторые сведения.
   * В качестве **дескриптора бота** введите **SpeechEchoBotTutorial-BotRegistration-####** и замените **####** вашим выбором. Обратите внимание, что дескриптор бота должен быть глобально уникальным. Если при вводе дескриптора бота выводится сообщение об ошибке _The requested bot ID is not available_ (запрошенный идентификатор бота недоступен), то выберите другое число. В приведенных ниже примерах мы использовали 8726
   * В качестве **подписки** выберите **Бесплатная пробная версия**.
   * В качестве **группы ресурсов** выберите **SpeechEchoBotTutorial-ResourceGroup**.
   * В разделе **Расположение** выберите **Западная часть США**.
     * Выберите категорию **F0** в поле **Ценовая категория**.
     * В поле **Конечная точка обмена сообщениями** введите URL-адрес для веб-приложения, к которому добавляется путь `/api/messages` в конце. Например, если глобально уникальное имя приложения было **EchoBot20190805125647**, конечная точка обмена сообщениями будет выглядеть так: `https://EchoBot20190805125647.azurewebsites.net/api/messages/`.
     * Для **Application Insights** можно установить значение **Off**. Дополнительные сведения см. в статье [Что такое Bot Analytics?](/azure/bot-service/bot-service-manage-analytics).
     * Проигнорируйте пункт **Auto create App ID и password** (Автоматическое создание идентификатора и пароля приложения).
5. В нижней части колонки **регистрации каналов бота** щелкните **Создать**.

На этом этапе проверьте наличие группы ресурсов **SpeechEchoBotTutorial-ResourceGroup** в портале Azure. Теперь там должны отображаться по крайней мере четыре ресурса:

| Имя | Тип  | Location |
|------|-------|----------|
| EchoBot20190805125647 | Служба приложений | западная часть США |
| SpeechEchoBotTutorial-AppServicePlan | План службы приложений | западная часть США |
| SpeechEchoBotTutorial-BotRegistration-8726 | Регистрация каналов бота | Глобальный |
| SpeechEchoBotTutorial-Speech | Службы Cognitive Services | западная часть США |

> [!IMPORTANT]
> В ресурсе регистрации каналов бота будет показан глобальный регион, даже если вы выбрали "Западная часть США". Это ожидаемое поведение.

## <a name="optional-test-in-web-chat"></a>Необязательно: тестирование в веб-чате

На странице регистрации каналов Azure Bot в разделе **Управление программами-роботами** есть параметр **Тест в веб-чате**. По умолчанию эта функция не будет работать с нашим ботом, поскольку веб-чат нуждается в проверке подлинности программы. Если вы хотите протестировать развернутую программу-робот с текстовым входом, выполните следующие действия. Обратите внимание, что эти шаги не являются обязательными для продолжения работы со следующими шагами учебника. 

1. Перейдите к ресурсу **EchoBotTutorial-BotRegistration-####** в [портале Azure](https://portal.azure.com) и откройте его.
1. На панели навигации **Управление программами-роботами** выберите **Параметры**. Скопируйте значение поля **Microsoft App ID** (Идентификатор приложения Майкрософт)
1. Откройте решение в Visual Studio. В обозревателе решений перейдите к файлу **appsettings.js** и дважды щелкните его.
1. Замените пустую строку рядом с **MicrosoftAppId** в файле JSON значением скопированного идентификатора
1. Вернитесь к порталу Azure, на панели навигации **Управление программами-роботами** выберите **Параметры** и щелкните **(Управление)** рядом с пунктом **Идентификатор приложения Майкрософт**
1. Щелкните **Создать секрет клиента**. Добавьте описание (например, "интернет-чат") и нажмите кнопку **Добавить**. Скопируйте новый секретный ключ
1. Замените пустую строку рядом с **MicrosoftAppPassword** в файле JSON значением скопированного секретного ключа
1. Сохраните файл JSON. Должно отобразиться примерно следующее:
```json
{
  "MicrosoftAppId": "3be0abc2-ca07-475e-b6c3-90c4476c4370",
  "MicrosoftAppPassword": "-zRhJZ~1cnc7ZIlj4Qozs_eKN.8Cq~U38G"
}
```
9. Повторно опубликуйте приложение (щелкните правой кнопкой мыши проект **EchoBot** в обозревателе решений Visual Studio, выберите **Опубликовать...** и нажмите кнопку **Опубликовать**)
10. Теперь вы готовы к тестированию программы-робота в Интернете!

## <a name="register-the-direct-line-speech-channel"></a>Регистрация канала Direct Line Speech

Теперь пришло время зарегистрировать программу-робота с помощью канала Direct Line Speech. Этот канал создает подключение между роботом и клиентским приложением, скомпилированным с помощью речевого пакета SDK.

1. Перейдите к ресурсу **SpeechEchoBotTutorial-BotRegistration-####** в [портале Azure](https://portal.azure.com) и откройте его.
1. На панели навигации **Управление программами-роботами** выберите **Каналы**.
   * В разделе **Дополнительные каналы** выберите пункт **Прямое речевое распознавание**.
   * Просмотрите текст на странице **Настройка Direct Line Speech**, а затем раскройте выпадающее меню **Учетная запись когнитивной службы**.
   * Выберите созданный ранее ресурс речи (например, **SpeechEchoBotTutorial-Speech**) в меню, чтобы связать робота с ключом подписки на речь.
   * Проигнорируйте остальные необязательные поля.
   * Выберите команду **Сохранить**.

1. На панели навигации **Управление программами-роботами** щелкните **Параметры**.
   * Установите флажок **Включить конечную точку потоковой передачи**. Это необходимо для создания протокола связи, построенного на основе веб-сокетов между программой-роботом и каналом голосовой речи Direct Line Speech.
   * Выберите команду **Сохранить**.

> [!TIP]
> Дополнительные сведения см. в статье [Подключение программы-робота к Direct Line Speech](/azure/bot-service/bot-service-channel-connect-directlinespeech). На этой странице содержатся дополнительные сведения и известные проблемы.

## <a name="run-the-windows-voice-assistant-client"></a>Запуск клиента Windows Voice Assistant

На этом шаге вы запустите клиент помощника для работы с Windows Voice. Клиент — это приложение Windows Presentation Foundation (WPF) на C#, которое использует [речевой пакет SDK](./speech-sdk.md) для управления связью с программой-роботом с помощью канала голосовой речи Direct Line. Используйте его для взаимодействия с ботом и его тестирования перед написанием пользовательского клиентского приложения. Это приложение с открытым исходным кодом, поэтому можно загрузить исполняемый файл и запустить или собрать его самостоятельно.

Клиент помощника Windows Voice имеет простой пользовательский интерфейс, позволяющий настроить подключение к роботу, просмотреть текстовую версию разговора, просмотреть действия Bot Framework в формате JSON и отобразить адаптивные карточки. Он также поддерживает использование пользовательских ключевых слов. Этот клиент будет использоваться для разговора с программой-роботом и получения голосового ответа.

> [!NOTE]
> На этом этапе убедитесь, что микрофон и динамики включены и работают.

1. Перейдите в репозиторий GitHub для поиска [клиента Windows Voice Assistant](https://github.com/Azure-Samples/Cognitive-Services-Voice-Assistant/blob/master/clients/csharp-wpf/README.md).
1. Следуйте инструкциям, приведенным в этой статье, чтобы либо
   * скачать предварительно собранный исполняемый файл в ZIP-архиве для запуска, либо
   * соберите исполняемый файл самостоятельно путем клонирования репозитория и сборки проекта.

1. Запустите клиентское приложение `VoiceAssistantClient.exe` и настройте его для подключения к роботу, следуя инструкциям в репозитории GitHub.
1. Нажмите кнопку **Повторить подключение** и убедитесь, что отображается сообщение **Новый диалог начат — введите текст или нажмите кнопку с микрофоном**.
1. Давайте потестируем. Нажмите кнопку с изображением микрофона и скажите несколько слов на английском языке. Распознанный текст будет отображаться при диктовке. Когда речь закончится, робот ответит своим собственным голосом, говоря слово "echo", за которым следуют распознанные слова.
1. Можно также использовать текст для взаимодействия с ботом. Просто введите текст на нижней панели. 

### <a name="troubleshooting-errors-in-windows-voice-assistant-client"></a>Устранение ошибок в клиенте Windows Voice Assistant

Если в окне главного приложения появляется сообщение об ошибке, используйте следующую таблицу для обнаружения и устранения ошибки:

| Error | Что следует сделать? |
|-------|----------------------|
|Ошибка: обновление WebSocket завершилось ошибкой проверки подлинности (401). Проверьте правильность ключа подписки (или маркера авторизации) и имя региона| На странице "Параметры приложения" убедитесь, что вы правильно указали ключ подписки на речь и соответствующий регион.<br>Убедитесь, что ваш ключ распознавания речи и регион ключа введены правильно. |
|Ошибка (ConnectionFailure): соединение было закрыто удаленным узлом. Код ошибки 1011. Сведения об ошибке: не удалось подключиться к программе-роботу перед отправкой сообщения | Убедитесь, что [установлен флажок "Включить конечную точку потоковой передачи"](#register-the-direct-line-speech-channel) и (или) [переключаемые **веб-сокеты**](#enable-web-sockets).<br>Убедитесь, что служба приложений Azure запущена. Если это так, попробуйте перезапустить службу приложений.|
|Ошибка (ConnectionFailure): соединение было закрыто удаленным узлом. Код ошибки 1002. Сведения об ошибке: сервер вернул код состояния "503", когда ожидался код состояния "101" | Убедитесь, что [установлен флажок "Включить конечную точку потоковой передачи"](#register-the-direct-line-speech-channel) и (или) [переключаемые **веб-сокеты**](#enable-web-sockets).<br>Убедитесь, что служба приложений Azure запущена. Если это так, попробуйте перезапустить службу приложений.|
|Ошибка (ConnectionFailure): соединение было закрыто удаленным узлом. Код ошибки 1011. Сведения об ошибке: код состояния ответа не указывает на успешное выполнение: 500 (InternalServerError)| Ваш бот указал нейронный голос в поле выходного действия [Speak](https://github.com/microsoft/botframework-sdk/blob/master/specs/botframework-activity/botframework-activity.md#speak) (Проговорить), но регион Azure, связанный с ключом подписки на речь, не поддерживает нейронные голоса. См. раздел [Нейронные и стандартные голоса](./regions.md#neural-and-standard-voices).|

Если эта ошибка не устранена в таблице, см. раздел [Часто задаваемые вопросы о голосовом помощнике](faq-voice-assistants.md). Если после выполнения всех действий, описанных в этом руководстве, по-прежнему не удается устранить проблему, откройте новую проблему на [странице GitHub, посвященной голосовому помощнику](https://github.com/Azure-Samples/Cognitive-Services-Voice-Assistant/issues).

#### <a name="a-note-on-connection-time-out"></a>Примечание об истечении времени ожидания подключения

Если вы подключены к боту и за последние 5 минут не происходило никаких действий, служба автоматически закроет соединение WebSocket с клиентом и программой-роботом. Это сделано намеренно. На нижней панели появится сообщение: *"Время активного подключения истекло, но повторное подключение доступно по запросу"* . Не нужно нажимать кнопку "Повторное подключение". Просто нажмите кнопку микрофона и начните говорить, вводить текстовое сообщение или скажите ключевое слово (если эта функция активна). Соединение будет автоматически восстановлено.  
### <a name="view-bot-activities"></a>Просмотр действий программы-робота

Каждый бот отправляет и получает сообщения о **действиях**. В окне **Журнал действий** клиента голосового помощника Windows вы увидите журналы с метками времени каждого действия, полученного клиентом от бота. Вы также можете просмотреть действия, отправленные клиентом боту с помощью метода [`DialogServiceConnector.SendActivityAsync`](/dotnet/api/microsoft.cognitiveservices.speech.dialog.dialogserviceconnector.sendactivityasync). При выборе элемента журнала отображаются сведения о связанном действии в формате JSON.

Ниже приведен пример в формате JSON действия, полученного клиентом.

```json
{
    "attachments":[],
    "channelData":{
        "conversationalAiData":{
             "requestInfo":{
                 "interactionId":"8d5cb416-73c3-476b-95fd-9358cbfaebfa",
                 "version":"0.2"
             }
         }
    },
    "channelId":"directlinespeech",
    "conversation":{
        "id":"129ebffe-772b-47f0-9812-7c5bfd4aca79",
        "isGroup":false
    },
    "entities":[],
    "from":{
        "id":"SpeechEchoBotTutorial-BotRegistration-8726"
    },
    "id":"89841b4d-46ce-42de-9960-4fe4070c70cc",
    "inputHint":"acceptingInput",
    "recipient":{
        "id":"129ebffe-772b-47f0-9812-7c5bfd4aca79|0000"
    },
    "replyToId":"67c823b4-4c7a-4828-9d6e-0b84fd052869",
    "serviceUrl":"urn:botframework:websocket:directlinespeech",
    "speak":"<speak version='1.0' xmlns='https://www.w3.org/2001/10/synthesis' xml:lang='en-US'><voice name='Microsoft Server Speech Text to Speech Voice (en-US, AriaRUS)'>Echo: Hello and welcome.</voice></speak>",
    "text":"Echo: Hello and welcome.",
    "timestamp":"2019-07-19T20:03:51.1939097Z",
    "type":"message"
}
```

Дополнительные сведения о возможностях, возвращаемых в выходных данных JSON, см. в разделе [Поля действия](https://github.com/microsoft/botframework-sdk/blob/master/specs/botframework-activity/botframework-activity.md). В рамках этого руководства вы можете сосредоточиться на полях [Текст](https://github.com/microsoft/botframework-sdk/blob/master/specs/botframework-activity/botframework-activity.md#text) и [Речь](https://github.com/microsoft/botframework-sdk/blob/master/specs/botframework-activity/botframework-activity.md#speak).

### <a name="view-client-source-code-for-calls-to-the-speech-sdk"></a>Просмотр исходного кода клиента для поиска вызовов пакета SDK для распознавания речи

Клиент помощника по Windows Voice использует пакет NuGet [Microsoft.CognitiveServices.Speech](https://www.nuget.org/packages/Microsoft.CognitiveServices.Speech/), который содержит речевой пакет SDK. Хорошим местом для начала рассмотрения примера кода является метод InitSpeechConnector() в файле [`VoiceAssistantClient\MainWindow.xaml.cs`](https://github.com/Azure-Samples/Cognitive-Services-Voice-Assistant/blob/master/clients/csharp-wpf/VoiceAssistantClient/MainWindow.xaml.cs), который создает эти два объекта SDK для речи:
- [`DialogServiceConfig`](/dotnet/api/microsoft.cognitiveservices.speech.dialog.dialogserviceconfig) — для параметров конфигурации (например, ключ подписки на речь, регион ключа);
- [`DialogServiceConnector`](/dotnet/api/microsoft.cognitiveservices.speech.dialog.dialogserviceconnector.-ctor) — управление подключением канала и событиями клиентской подписки для обработки распознанных речевых ответов и сообщений бота.

## <a name="add-custom-keyword-activation"></a>Активация по пользовательскому ключевому слову

Пакет SDK для распознавания речи поддерживает активацию по пользовательскому ключевому слову. Как и в случае с "Привет, Кортана" для помощника Майкрософт, вы можете написать приложение, которое будет постоянно прослушивать ключевое слово, выбранное по вашему усмотрению. Помните, что ключевое слово может быть одиночным словом или словосочетанием из нескольких слов.

> [!NOTE]
> Термин *Ключевое слово* (keyword) часто используется с термином *Слово для пробуждения* (wake word), и оба могут отображаться и в документации Майкрософт.

Обнаружение ключевых слов выполняется в клиентском приложении. Если используется ключевое слово, то при обнаружении ключевого слова звук будет передаваться только в канал Direct Line Speech. Канал Direct Line Speech включает в себя компонент с названием *Проверка ключевого слова (KWV)* , который выполняет более сложную обработку в облаке, чтобы убедиться, что выбранное ключевое слово находится в начале аудиопотока. Если проверка ключевого слова прошла успешно, канал начнет взаимодействие с ботом.

Выполните следующие действия, чтобы создать модель ключевых слов, настроить клиент голосового помощника Windows для использования этой модели и, наконец, проверить ее в работе с программой-роботом.

1. Выполните эти инструкции, чтобы [создать настраиваемое ключевое слово с помощью службы распознавания речи](./custom-keyword-basics.md).
2. Распакуйте файл модели, скачанный на предыдущем этапе. Он должен называться согласно ключевому слову. Ищите файл с именем `kws.table`.
3. В клиенте голосового помощника Windows найдите меню **Параметры** (значок шестеренки в правом верхнем углу). Выберите **Путь к файлу модели** и введите полный путь к `kws.table` файлу из шага 2.
4. Убедитесь, что установлен флажок **Включено**. Это сообщение должно появиться рядом с флажком: "Будет прослушивать ключевое слово при следующем соединении". Если вы указали неправильный файл или недопустимый путь, появится сообщение об ошибке.
5. Введите **ключ подписки** на речь и **регион ключа подписки**, а затем нажмите кнопку **ОК**, чтобы закрыть меню **Параметры**.
6. Нажмите кнопку **Повторить подключение**. Должно отобразиться сообщение: "Начат новый диалог — начните печать, нажмите кнопку с изображением микрофона или произнесите ключевое слово". Теперь приложение находится в режиме постоянного прослушивания.
7. Произнесите любую фразу, которая начинается с ключевого слова. Например: " **{ваше ключевое слово}** , what time is it?". Не нужно останавливаться после озвучки ключевого слова. Когда вы закончите говорить, произойдут две вещи:
   * Вы увидите транскрипцию того, что сказали
   * Вскоре после этого вы услышите ответ бота
8. Продолжайте экспериментировать с тремя типами входных данных, которые поддерживает бот:
   * Текст, вводимый в нижней панели
   * Нажатие клавиши со значком микрофона и речь
   * Произнесение любой фразы, которая начинается с ключевого слова

### <a name="view-the-source-code-that-enables-keyword"></a>Просмотр исходного кода, активирующего ключевое слово

В исходном коде клиента голосового помощника Windows просмотрите эти файлы, чтобы просмотреть код, используемый для включения обнаружения ключевых слов:

1. [`VoiceAssistantClient\Models.cs`](https://github.com/Azure-Samples/Cognitive-Services-Voice-Assistant/blob/master/clients/csharp-wpf/VoiceAssistantClient/Models.cs) включает вызов метода Speech SDK [`KeywordRecognitionModel.fromFile()`](/javascript/api/microsoft-cognitiveservices-speech-sdk/keywordrecognitionmodel#fromfile-string-), который используется для создания экземпляра модели из локального файла на диске.
1. [`VoiceAssistantClient\MainWindow.xaml.cs`](https://github.com/Azure-Samples/Cognitive-Services-Voice-Assistant/blob/master/clients/csharp-wpf/VoiceAssistantClient/MainWindow.xaml.cs) включает в себя вызов метода Speech SDK [`DialogServiceConnector.StartKeywordRecognitionAsync()`](/dotnet/api/microsoft.cognitiveservices.speech.dialog.dialogserviceconnector.startkeywordrecognitionasync), который активирует непрерывное обнаружение ключевых слов.

## <a name="optional-change-the-language-and-bot-voice"></a>(Дополнительно) Изменение языка и голоса бота

Созданная программа-робот будет прослушивать и отвечать на английском языке, используя по умолчанию голосовую речь для английского языка (США). Однако вы не ограничены использованием английского языка или голоса по умолчанию. В этом разделе вы узнаете, как изменить язык, который будет прослушивать робот и на который он будет реагировать. Вы также узнаете, как выбрать другой голос для этого языка.

### <a name="change-the-language"></a>Изменение языка

Вы можете выбрать один из языков, упомянутых в таблице [преобразования речи в текст](language-support.md#speech-to-text). В приведенном ниже примере мы изменим язык на немецкий.

1. Откройте клиентское приложение голосового помощника Windows, нажмите кнопку параметров (значок шестеренки в правом верхнем углу) и введите `de-de` в поле Language (это значение локали, указанное в таблице преобразования [речи в текст](language-support.md#speech-to-text)). Это действие переписывает умолчание и задает распознаваемый язык (`en-us`). Также оно указывает каналу прямого перевода строки на использование немецкого голоса по умолчанию для ответа бота.
2. Закройте страницу параметров и нажмите кнопку повторного подключения, чтобы установить новое подключение к эхо-роботу.
3. Нажмите кнопку микрофона и произнесите фразу на немецком языке. Вы увидите распознанный текст, и эхо-робот ответит на немецком языке голосом по умолчанию.

### <a name="change-the-default-bot-voice"></a>Изменение голоса для по умолчанию для программы-робота

Выбор голоса для преобразования текста в речь и контроль произношения можно выполнить, если программа-робот задает ответ в формате [языка разметки речи](speech-synthesis-markup.md) (SSML) вместо простого текста. Программа нашего эхо-робота не использует SSML, но можно легко изменить код, чтобы сделать это. В приведенном ниже примере мы добавим SSML для ответа эхо-робота, чтобы вместо женского голоса по умолчанию использовался немецкий мужской голос Stefan Apollo. См. список [стандартных голосов](language-support.md#standard-voices) и [нейронных голосов](language-support.md#neural-voices), поддерживаемых для вашего языка.

1. Для начала откройте `samples\csharp_dotnetcore\02.echo-bot\echo-bot.cs`.
2. Найдите эти две строки:
    ```csharp
    var replyText = $"Echo: {turnContext.Activity.Text}";
    await turnContext.SendActivityAsync(MessageFactory.Text(replyText, replyText), cancellationToken);
    ```
3. Замените их следующим содержимым:
    ```csharp
    var replyText = $"Echo: {turnContext.Activity.Text}";
    var replySpeak = @"<speak version='1.0' xmlns='https://www.w3.org/2001/10/synthesis' xml:lang='de-DE'>
                    <voice name='Microsoft Server Speech Text to Speech Voice (de-DE, Stefan, Apollo)'>" +
                    $"{replyText}" + "</voice></speak>";
    await turnContext.SendActivityAsync(MessageFactory.Text(replyText, replySpeak), cancellationToken);
    ```
4. Создайте решение в Visual Studio и исправьте все ошибки сборки.

Второй аргумент в методе 'MessageFactory.Text. Text ' задает [поле действия говорения](https://github.com/Microsoft/botframework-sdk/blob/master/specs/botframework-activity/botframework-activity.md#speak) в ответе бота. При приведенном выше изменении он был заменен простым текстом на SSML для указания немецкого голоса не по умолчанию.

### <a name="redeploy-your-bot"></a>Заново разверните программу-робота

Теперь, когда вы внесли в программу необходимые изменения, следующим шагом является повторная публикация в службе приложений Azure и пробный запуск.

1. В обозревателе решений щелкните правой кнопкой мыши проект **EchoBot** и выберите пункт **Опубликовать**.
2. Предыдущая конфигурация развертывания уже загружена по умолчанию. Просто щелкните **Опубликовать** рядом с **EchoBot20190805125647 — Web Deploy**.
3. В окне вывода Visual Studio появится сообщение **Публикация завершена**, и откроется веб-страница с сообщением, что ваш робот готов.
4. Откройте клиентское приложение голосового помощника Windows, нажмите кнопку параметров (значок шестеренки с правом верхнем углу) и убедитесь, что в поле язык все еще введено значение `de-de`.
5. Следуйте инструкциям в разделе [Запуск клиента голосового помощника Windows](#run-the-windows-voice-assistant-client) для повторного подключения к заново развернутому роботу, скажите что-нибудь на новом языке и послушайте, как бот отвечает на этом языке новым голосом.

## <a name="clean-up-resources"></a>Очистка ресурсов

Если вы не собираетесь продолжать использовать эхо-бота, приведенного в этом руководстве, вы можете удалить его и все связанные с ним ресурсы Azure, просто удалив эту группу ресурсов Azure: **SpeechEchoBotTutorial-ResourceGroup**.

1. В [портале Microsoft Azure](https://portal.azure.com) щелкните **группы ресурсов** в области навигации **служб Azure**.
2. Найдите группу ресурсов с именем **SpeechEchoBotTutorial-ResourceGroup**. Щелкните три точки (...).
3. Выберите **Удалить группу ресурсов**.

## <a name="next-steps"></a>Дальнейшие действия

> [!div class="nextstepaction"]
> [Сборка собственного клиентского приложения с помощью пакета SDK для распознавания речи](./quickstarts/voice-assistants.md?pivots=programming-language-csharp)

## <a name="see-also"></a>См. также раздел

* Развертывание в [регионе Azure рядом с вами](https://azure.microsoft.com/global-infrastructure/locations/), чтобы сократить время ответа бота
* Развертывание в [регионе Azure, поддерживающем высококачественные нейронные голоса TTS](./regions.md#neural-and-standard-voices)
* Цены на использование услуг, связанных с каналом Direct Line Speech:
  * [Расценки службы ботов](https://azure.microsoft.com/pricing/details/bot-service/)
  * [Служба распознавания речи](https://azure.microsoft.com/pricing/details/cognitive-services/speech-services/)
* Создание и развертывание собственного робота с поддержкой голоса:
  * Сборка [бота на платформе Bot Framework](https://dev.botframework.com/). Регистрация его с помощью [канала Direct Line Speech](/azure/bot-service/bot-service-channel-connect-directlinespeech) и [настройка робота для голосовой коммуникации](/azure/bot-service/directline-speech-bot)
  * Знакомство с существующими [решениями для платформы Bot Framework](https://microsoft.github.io/botframework-solutions/index): сборка [виртуального помощника](https://microsoft.github.io/botframework-solutions/overview/virtual-assistant-solution/) и [его расширение для работы с Direct Line Speech](https://microsoft.github.io/botframework-solutions/clients-and-channels/tutorials/enable-speech/1-intro/)
