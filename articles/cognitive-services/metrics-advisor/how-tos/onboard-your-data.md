---
title: Подключение канала данных к помощнику по метрикам
titleSuffix: Azure Cognitive Services
description: Как приступить к подключению каналов данных к помощнику по метрикам.
services: cognitive-services
author: mrbullwinkle
manager: nitinme
ms.service: cognitive-services
ms.subservice: metrics-advisor
ms.topic: conceptual
ms.date: 09/14/2020
ms.author: mbullwin
ms.openlocfilehash: fe3b87c733f54d8bd52c4d973977e3c8cbfefe19
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "92043221"
---
# <a name="how-to-onboard-your-metric-data-to-metrics-advisor"></a>Практические советы: подключение данных метрик к помощнику по метрикам

Используйте эту статью, чтобы узнать о подключении данных к помощнику по метрикам. 

## <a name="data-schema-requirements-and-configuration"></a>Требования и конфигурация для схемы данных

[!INCLUDE [data schema requirements](../includes/data-schema-requirements.md)]

## <a name="avoid-loading-partial-data"></a>Избегайте загрузки частичных данных

Частичные данные вызваны несогласованностью данных, хранящихся в Advisor и в источнике данных. Это может произойти, когда источник данных обновляется после того, как помощник по метрикам завершил извлечение данных. Помощник по метрикам извлекает данные только один раз из заданного источника данных.

Например, если метрика была подключена к помощнику по метрикам для мониторинга. Помощник по метрикам успешно захватит данные метрики в метке времени а и выполняет обнаружение аномалий. Однако, если данные метрик этой определенной метки времени A были обновлены после приема данных. Новое значение данных не будет получено.

Вы можете попытаться проложить [исторические данные](manage-data-feeds.md#backfill-your-data-feed) (описанные далее), чтобы устранить несоответствия, но это не приведет к срабатыванию новых оповещений об аномалиях, если оповещения для этих точек времени уже активированы. Этот процесс может добавить к системе дополнительную рабочую нагрузку и не будет автоматическим.

Чтобы избежать загрузки частичных данных, рекомендуется использовать два подхода:

* Создавать данные в одной транзакции:

    Убедитесь, что значения метрик для всех комбинаций измерений в одной и той же метке времени хранятся в источнике данных в одной транзакции. В приведенном выше примере дождитесь готовности данных из всех источников данных, а затем загрузите их в помощник по метрикам в одной транзакции. Помощник по метрикам может периодически опрашивать канал данных до тех пор, пока данные не будут успешно получены (или частично).

* Откладывание приема данных путем установки правильного значения параметра **смещения времени приема** :

    Задайте параметр **смещения времени приема** для веб-канала данных, чтобы отложить прием, пока данные не будут полностью подготовлены. Это может быть полезно для некоторых источников данных, которые не поддерживают транзакции, такие как хранилище таблиц Azure. Дополнительные сведения см. в разделе [Дополнительные параметры](manage-data-feeds.md#advanced-settings) .

## <a name="add-a-data-feed-using-the-web-based-workspace"></a>Добавление потока данных с помощью веб-рабочей области

После входа на портал советника по метрикам и выбора рабочей области щелкните **Начало работы**. Затем на главной странице рабочей области щелкните **Добавить веб-канал данных** в меню слева.

### <a name="add-connection-settings"></a>Добавить параметры подключения

Затем введите набор параметров для подключения к источнику данных временных рядов. 
* **Source Type** (Тип источника). Это тип источника данных, в котором хранятся данные временных рядов.
* **Гранулярность**: интервал между последовательными точками данных в данных временных рядов. В настоящее время помощник по метрикам поддерживает следующие показатели: ежегодно, ежемесячно, еженедельно, ежедневно, каждый час и пользовательский. Минимальный интервал, поддерживаемый параметром настройки, составляет 60 секунд.
  * **Секунды**: количество секунд, в течение которых *грануларитинаме* задается для *настройки*.
* Прием **данных с момента (UTC)**: время начала работы с базовым временем приема данных. *стартоффсетинсекондс* часто используется для добавления смещения, помогающего обеспечить согласованность данных.

Далее необходимо указать сведения о соединении для источника данных, а также пользовательские запросы, используемые для преобразования данных в необходимую схему. Дополнительные сведения о других полях и подключении различных типов источников данных см. в разделе [Добавление веб-каналов данных из разных источников данных](../data-feeds-from-different-sources.md).

[!INCLUDE [query requirements](../includes/query-requirements.md)]

### <a name="verify-and-get-schema"></a>Проверка и получение схемы

После задания строки подключения и строки запроса выберите **проверить и получить схему** , чтобы проверить соединение и выполнить запрос, чтобы получить схему данных из источника данных. Обычно этот процесс занимает несколько секунд в зависимости от подключения к источнику данных. Если на этом этапе возникает ошибка, проверьте следующее:

* строка подключения и запрос указаны правильно;
* экземпляр Помощника по метрикам может подключиться к источнику данных, если настроены соответствующие параметры брандмауэра.

### <a name="schema-configuration"></a>Конфигурация схемы

После загрузки схемы данных выберите соответствующие поля.

Если метка времени точки данных пропущена, помощник по метрикам будет использовать отметку времени при приеме точки данных. Для каждого канала данных можно указать не более одного столбца в качестве метки времени. Если появляется сообщение о том, что столбец не может быть указан в качестве метки времени, проверьте запрос или источник данных и наличие нескольких меток времени в результатах запроса — не только в предварительных данных. При приеме данных помощник по метрикам может использовать только один блок (например, один день, один час в зависимости от степени детализации) данных временных рядов из заданного источника каждый раз.

|Выбор  |Описание  |Примечания  |
|---------|---------|---------|
| **Отображаемое имя** | Имя, отображаемое в рабочей области вместо исходного имени столбца. | |
|**Timestamp**     | Метка времени точки данных. Если этот параметр не указан, Помощник по метрикам будет использовать метку времени, которая соответствует времени приема точки данных. Для каждого канала данных можно указать не более одного столбца в качестве метки времени.        | Необязательный элемент. Здесь можно указать не более одного столбца. Если **столбец не может быть указан как ошибка метки времени** , проверьте запрос или источник данных на наличие повторяющихся меток времени.      |
|**Measure**     |  Числовые значения в веб-канале данных. Для каждого канала данных можно указать несколько мер, но по крайней мере один столбец должен быть выбран как мера.        | Должен быть указан по меньшей мере один столбец.        |
|**Измерение**     | Категориальные значения. Сочетание разных значений определяет конкретный временной ряд с одним измерением (страна, язык, арендатор). В качестве измерений можно выбрать не более одного столбца. Примечание. Будьте внимательны при выборе нестрокового столбца в качестве измерения. | Необязательный элемент.        |
|**Пропуск**     | Игнорировать выбранный столбец.        | Необязательный параметр. См. Приведенный ниже текст.       |

Если необходимо пропускать столбцы, рекомендуется обновить запрос или источник данных, чтобы исключить эти столбцы. Можно также пропускать столбцы, используя **Ignore Columns** , а затем **игнорировать** их в указанных столбцах. Если столбец должен быть измерением и по ошибке задается как *игнорируемый*, помощник по метрикам может привести к получению частичных данных. Например, предположим, что данные запроса представлены ниже:

| Идентификатор строки | Отметка времени | Страна или регион | Язык | Доходы |
| --- | --- | --- | --- | --- |
| 1 | 2019/11/10 | Китай | ZH-CN | 10000 |
| 2 | 2019/11/10 | Китай | EN-US | 1000 |
| 3 | 2019/11/10 | США | ZH-CN | 12000 |
| 4 | 2019/11/11 | США | EN-US | 23000 |
| ... | ...| ... | ... | ... |

Если параметр *Country* является измерением, а *язык* задан как *игнорируется*, то первая и вторая строки будут иметь одинаковые измерения. Помощник по метрикам будет произвольно использовать одно значение из двух строк. Помощник по метрикам не будет выполнять статистическую обработку строк в этом случае.

### <a name="automatic-roll-up-settings"></a>Параметры автоматического сведения

> [!IMPORTANT]
> Если вы хотите включить анализ основных причин и другие возможности диагностики, необходимо настроить **Параметры автоматического развертывания** . После включения параметры автоматического свертывания нельзя изменить.

Помощник по метрикам может автоматически выполнять агрегирование (например, SUM, MAX, MIN) для каждого измерения во время приема, а затем создает иерархию, которая будет использоваться в анализе корневого регистра и других диагностических функциях. 

Рассмотрим следующие сценарии.

* *Мне не нужно включать сводный анализ для моих данных.*

    Не нужно использовать сводный помощник по метрикам.

* *Мои данные уже сведены, а значение измерения представлено: NULL или Empty (по умолчанию), только NULL, другие.*

    Этот параметр означает, что помощнику по метрикам не нужно сводить данные, поскольку строки уже суммируются. Например, если выбрать *только значение NULL*, то Вторая строка данных в приведенном ниже примере будет рассматриваться как агрегирование всех стран и языка *en-US*. четвертая строка данных, имеющая пустое значение для *Country* , будет рассматриваться как обычная строка, которая может указывать на неполные данные.
    
    | Страна или регион | Язык | Доходы |
    |---------|----------|--------|
    | Китай   | ZH-CN    | 10000  |
    | ЗАКАНЧИВАЮЩ  | EN-US    | 999999 |
    | США      | EN-US    | 12000  |
    |         | EN-US    | 5000   |

* *Мне нужен помощник по метрикам для свертки данных путем вычисления Sum/max/min/AVG/Count и их представления по <some string>*

    Некоторые источники данных, такие как Cosmos DB или хранилище BLOB-объектов Azure, не поддерживают определенные вычисления, такие как *Group By* или *Cube*. Помощник по метрикам предоставляет возможность автоматического создания куба данных во время приема.
    Этот параметр означает, что вам нужен помощник по метрикам для вычисления свертки с помощью выбранного алгоритма и использовать указанную строку для представления свертки в помощнике по метрикам. Это не приведет к изменению данных в источнике данных.
    Например, предположим, что имеется набор временных рядов, который означает метрики продаж с измерением (страна, регион). Для данной метки времени она может выглядеть следующим образом:


    | Country       | Регион           | Sales |
    |---------------|------------------|-------|
    | Canada        | Alberta          | 100   |
    | Canada        | British Columbia | 500   |
    | США | Montana          | 100   |


    После включения автоматического свертывания с *суммой* помощник по метрикам вычисляет комбинации измерений и вычислит метрики во время приема данных. Результат может быть следующим:

    | Country       | Регион           | Sales |
    | ------------ | --------------- | ---- |
    | Canada        | Alberta          | 100   |
    | NULL          | Alberta          | 100   |
    | Canada        | British Columbia | 500   |
    | NULL          | British Columbia | 500   |
    | США | Montana          | 100   |
    | NULL          | Montana          | 100   |
    | NULL          | NULL             | 700   |
    | Canada        | NULL             | 600   |
    | США | NULL             | 100   |

    `(Country=Canada, Region=NULL, Sales=600)` означает сумму продаж в Канаде (все регионы) — 600.

    Ниже приведено преобразование в языке SQL.

    ```mssql
    SELECT
        dimension_1,
        dimension_2,
        ...
        dimension_n,
        sum (metrics_1) AS metrics_1,
        sum (metrics_2) AS metrics_2,
        ...
        sum (metrics_n) AS metrics_n
    FROM
        each_timestamp_data
    GROUP BY
        CUBE (dimension_1, dimension_2, ..., dimension_n);
    ```

    Прежде чем использовать функцию автоматического свертывания, примите во внимание следующее.

    * Если вы хотите использовать функцию *Sum* для статистической обработки данных, убедитесь, что в каждом измерении используются дополнительные метрики. Ниже приведены некоторые примеры *неаддитивных* метрик.
      * Метрики на основе дробей. Это относится к соотношениям, процентам и т. д. Например, не следует добавлять частоту unemployment для каждого состояния, чтобы вычислить ставку unemployment всей страны.
      * Пересекается в измерении. Например, не следует добавлять число сотрудников в каждый из этих видов для вычисления количества людей, имеющих отношение к спорту, поскольку между ними есть перекрытие, один человек может понравится в нескольких спортивных.
    * Чтобы обеспечить работоспособность всей системы, размер куба ограничен. В настоящее время ограничение составляет 1 000 000. Если данные превышают этот предел, прием для этой отметки времени завершится ошибкой.

## <a name="advanced-settings"></a>Дополнительные настройки

Существует несколько дополнительных параметров для включения данных, принимаемых настроенным способом, например с указанием смещения приема или параллелизма. Дополнительные сведения см. в разделе [Дополнительные параметры](manage-data-feeds.md#advanced-settings) статьи Управление веб-каналом данных.

## <a name="specify-a-name-for-the-data-feed-and-check-the-ingestion-progress"></a>Укажите имя для веб-канала данных и проверьте ход приема
 
Укажите для веб-канала данных пользовательское имя, которое будет отображаться в рабочей области. Затем нажмите кнопку **Отправить**. На странице сведения о веб-канале данных можно использовать индикатор выполнения приема для просмотра сведений о состоянии.

:::image type="content" source="../media/datafeeds/ingestion-progress.png" alt-text="Индикатор выполнения приема" lightbox="../media/datafeeds/ingestion-progress.png":::


Чтобы проверить сведения об ошибке приема: 

1. Щелкните " **отобразить подробности**".
2. Щелкните **состояние** , выберите **сбой** или **Ошибка**.
3. Наведите указатель мыши на неудачный прием и просмотрите подробное сообщение, которое отображается.

:::image type="content" source="../media/datafeeds/check-failed-ingestion.png" alt-text="Проверка приема с ошибками":::

Состояние *сбоя* указывает, что прием для этого источника данных будет повторен позже.
Состояние *ошибки* указывает, что помощник по метрикам не будет повторять попытку для источника данных. Чтобы перезагрузить данные, необходимо активировать обратную засыпку или перезагрузку вручную.

Можно также перезагрузить ход приема, нажав кнопку **обновить ход выполнения**. По завершении приема данных вы можете щелкнуть метрики и проверить результаты обнаружения аномалий.

## <a name="next-steps"></a>Дальнейшие действия
- [Управление веб-каналами данных](manage-data-feeds.md)
- [Конфигурации для разных источников данных](../data-feeds-from-different-sources.md)
- [Настройка метрик и детальная настройка конфигурации обнаружения](configure-metrics.md)
