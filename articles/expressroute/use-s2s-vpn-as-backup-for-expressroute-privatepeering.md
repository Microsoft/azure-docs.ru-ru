---
title: Использование S2S VPN в качестве резервной копии для частного пиринга Azure ExpressRoute | Документация Майкрософт
description: На этой странице приведены рекомендации по архитектуре для резервного копирования частного пиринга Azure ExpressRoute с помощью VPN типа S2S.
services: networking
author: duongau
ms.service: expressroute
ms.topic: how-to
ms.date: 02/05/2020
ms.author: duau
ms.openlocfilehash: 752edea8078cf55fc3965bdc7aa9e1b4269dee34
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "92207926"
---
# <a name="using-s2s-vpn-as-a-backup-for-expressroute-private-peering"></a>Использование S2S VPN в качестве резервной копии для частного пиринга ExpressRoute

В статье [проектирование для аварийного восстановления с помощью частного пиринга expressroute][DR-PP]мы обсуждали необходимость подключения резервного копирования для подключения частного пиринга expressroute и использования геоизбыточных каналов ExpressRoute для этой цели. В этой статье мы рассмотрим, как использовать VPN типа "сеть — сеть" (S2S) в качестве резервной копии для частного пиринга ExpressRoute. 

В отличие от геоизбыточных каналов ExpressRoute, можно использовать сочетание аварийного восстановления ExpressRoute-VPN только в режиме "активный — пассивный". Основной проблемой использования любого сетевого подключения резервного копирования в пассивном режиме является то, что пассивное подключение часто будет завершаться сбоем наряду с основным подключением. Распространенной причиной сбоев пассивного подключения является отсутствие активного обслуживания. Поэтому в этой статье основное внимание уделяется проверке и активному обслуживанию VPN-подключения S2S, которое выполняет резервное копирование частного пиринга ExpressRoute.

>[!NOTE] 
>При объявлении заданного маршрута через ExpressRoute и VPN Azure предпочитает маршрутизацию по ExpressRoute.  
>

В этой статье мы посмотрим, как проверить подключение как с точки зрения Azure, так и с точки зрения сети на стороне клиента. Возможность проверки с любого конца поможет не только управлять сетевыми устройствами на стороне клиента, которые являются одноранговыми для сетевых сущностей Майкрософт. 

## <a name="example-topology"></a>Пример топологии

В нашей настройке есть локальная сеть, подключенная к виртуальной сети концентратора Azure через канал ExpressRoute и VPN-подключение типа "S2S". Виртуальная сеть концентратора Azure, в свою очередь, подключена к периферийной виртуальной сети, как показано на следующей схеме:

![1][1]

В программе установки канал ExpressRoute завершается на паре маршрутизаторов "клиент" (CE) в локальной среде. Локальная локальная сеть подключена к маршрутизаторам CE через пару брандмауэров, которые работают в режиме выноски. VPN-подключение S2S напрямую завершается в брандмауэрах.

В следующей таблице перечислены ключевые IP-префиксы топологии.

| **Сущность** | **Prefix** |
| --- | --- |
| Локальная локальная сеть | 10.1.11.0/25 |
| Виртуальная сеть центра Azure | 10.17.11.0/25 |
| Периферийная виртуальная сеть Azure | 10.17.11.128/26 |
| Локальный тестовый сервер | 10.1.11.10 |
| Тестовая виртуальная машина с периферийной виртуальной сетью | 10.17.11.132 |
| Первичное подключение к сети ExpressRoute, подсеть P2P | 192.168.11.16/30 |
| Вторичное подключение к сети ExpressRoute, подсеть P2P | 192.168.11.20/30 |
| Первичный узел BGP VPN-шлюза | 10.17.11.76 |
| Вторичный IP-адрес узла VPN-шлюза BGP | 10.17.11.77 |
| Локальный IP-адрес узла BGP для VPN локального брандмауэра | 192.168.11.88 |
| Основной маршрутизатор CE (f) для IP-адреса брандмауэра | 192.168.11.0/31 |
| Брандмауэр, направленный на основной IP-адрес маршрутизатора CE | 192.168.11.1/31 |
| Дополнительный маршрутизатор CE (i/f) к IP-адресу брандмауэра | 192.168.11.2/31 |
| Брандмауэр, направленный на дополнительный IP-адрес маршрутизатора CE | 192.168.11.3/31 |


В следующей таблице перечислены ASN топологии.

| **Автономная система** | **ASN** |
| --- | --- |
| В локальной среде | 65020 |
| Microsoft Enterprise ребро | 12076 |
| Виртуальная сеть GW (Екср) | 65515 |
| Виртуальная сеть GW (VPN) | 65515 |

## <a name="high-availability-without-asymmetricity"></a>Высокий уровень доступности без асимметричности

### <a name="configuring-for-high-availability"></a>Настройка для обеспечения высокой доступности

[Настройка параллельных подключений expressroute и][Conf-CoExist] подключения типа "сеть — сеть" обсуждается настройка содействующего канала ExpressRoute и VPN-подключений S2S. Как мы обсуждали в разделе [проектирование для обеспечения высокого уровня доступности с помощью expressroute][HA], чтобы улучшить высокий уровень доступности expressroute, наша программа установки обеспечивает избыточность сети (позволяет избежать единой точки отказа) до конечных точек. Кроме того, как основное, так и вторичное подключения каналов ExpressRoute настроены для работы в режиме "активный — активный" путем объявления локальных префиксов таким же образом, как и для подключений. 

Объявление локального маршрута основного маршрутизатора CE через основное подключение канала ExpressRoute показано ниже (команды Жунос):

```console
user@SEA-MX03-01> show route advertising-protocol bgp 192.168.11.18 

Cust11.inet.0: 8 destinations, 8 routes (7 active, 0 holddown, 1 hidden)
  Prefix                  Nexthop              MED     Lclpref    AS path
* 10.1.11.0/25            Self                                    I
```

Объявление локального маршрута дополнительного маршрутизатора CE через дополнительное подключение канала ExpressRoute показано ниже (команды Жунос):

```console
user@SEA-MX03-02> show route advertising-protocol bgp 192.168.11.22 

Cust11.inet.0: 8 destinations, 8 routes (7 active, 0 holddown, 1 hidden)
  Prefix                  Nexthop              MED     Lclpref    AS path
* 10.1.11.0/25            Self                                    I
```

Чтобы повысить высокий уровень доступности резервного подключения, VPN-подключение S2S также настраивается в режиме "активный — активный". Ниже показана конфигурация VPN-шлюза Azure. Обратите внимание, что в VPN-конфигурации VPN указаны IP-адреса узлов шлюза BGP--10.17.11.76 и 10.17.11.77--.

![2][2]

Локальный маршрут объявляется брандмауэрами для основного и дополнительного узлов BGP VPN-шлюза. Объявления маршрутов показаны ниже (Жунос):

```console
user@SEA-SRX42-01> show route advertising-protocol bgp 10.17.11.76 

Cust11.inet.0: 14 destinations, 21 routes (14 active, 0 holddown, 0 hidden)
  Prefix                  Nexthop              MED     Lclpref    AS path
* 10.1.11.0/25            Self                                    I

{primary:node0}
user@SEA-SRX42-01> show route advertising-protocol bgp 10.17.11.77    

Cust11.inet.0: 14 destinations, 21 routes (14 active, 0 holddown, 0 hidden)
  Prefix                  Nexthop              MED     Lclpref    AS path
* 10.1.11.0/25            Self                                    I
```

>[!NOTE] 
>Настройка VPN-подключения S2S в режиме "активный — активный" не только обеспечивает высокую доступность для подключения к сети аварийного восстановления, но и повышает пропускную способность подключения к резервному копированию. Иными словами, рекомендуется настроить S2S VPN в режиме "активный — активный", так как он создает несколько базовых туннелей.
>

### <a name="configuring-for-symmetric-traffic-flow"></a>Настройка потока симметричного трафика

Мы заметили, что при объявлении локального маршрута через ExpressRoute и S2S VPN Azure предпочитает путь ExpressRoute. Чтобы принудительно использовать VPN-путь S2S по отношению к постоянно существующему ExpressRoute, необходимо объявить более конкретные маршруты (более длинные префиксы с более крупной маской подсети) через VPN-подключение. Наша цель — использовать VPN-подключения только в качестве резервной копии. Поэтому при выборе пути по умолчанию в Azure используется наша цель. 

Мы обязаны обеспечить, чтобы трафик, направляемый в Azure из локальной среды, также предпочитает путь ExpressRoute через VPN-подключение типа "сеть — сеть". По умолчанию локальные настройки маршрутизаторов и брандмауэров CE в локальной программе установки находятся в 100. Таким образом, настроив локальную настройку маршрутов, полученных через частные пиринга ExpressRoute больше 100 (скажем, 150), можно сделать так, чтобы трафик, предназначенный для канала ExpressRoute в Azure, был в стабильном состоянии.

Ниже показана конфигурация BGP для основного маршрутизатора CE, который завершает основное подключение канала ExpressRoute. Обратите внимание, что значение локального предпочтения маршрутов, объявленных в сеансе Ибгп, настроено как 150. Аналогичным образом необходимо убедиться, что локальная настройка вторичного маршрутизатора CE, который прерывает дополнительное подключение канала ExpressRoute, также настроена как 150.

```console
user@SEA-MX03-01> show configuration routing-instances Cust11
description "Customer 11 VRF";
instance-type virtual-router;
interface xe-0/0/0:0.110;
interface ae0.11;
protocols {
  bgp {
    group ibgp {
        type internal;
        local-preference 150;
        neighbor 192.168.11.1;
    }
    group ebgp {
        peer-as 12076;
        bfd-liveness-detection {
            minimum-interval 300;
            multiplier 3;
        }
        neighbor 192.168.11.18;
    }
  }
}
```

Таблица маршрутизации локальных брандмауэров (показана ниже) подтверждает, что для локального трафика, предназначенного для Azure, предпочитаемый путь находится на более высокой части ExpressRoute в стабильном состоянии.

```console
user@SEA-SRX42-01> show route table Cust11.inet.0 10.17.11.0/24

Cust11.inet.0: 14 destinations, 21 routes (14 active, 0 holddown, 0 hidden)
+ = Active Route, - = Last Active, * = Both

10.17.11.0/25      *[BGP/170] 2d 00:34:04, localpref 150
                      AS path: 12076 I, validation-state: unverified
                    > to 192.168.11.0 via reth1.11
                      to 192.168.11.2 via reth2.11
                    [BGP/170] 2d 00:34:01, localpref 150
                      AS path: 12076 I, validation-state: unverified
                     > to 192.168.11.2 via reth2.11
                    [BGP/170] 2d 21:12:13, localpref 100, from 10.17.11.76
                       AS path: 65515 I, validation-state: unverified
                    > via st0.118
                    [BGP/170] 2d 00:41:51, localpref 100, from 10.17.11.77
                       AS path: 65515 I, validation-state: unverified
                     > via st0.119
10.17.11.76/32     *[Static/5] 2d 21:12:16
                     > via st0.118
10.17.11.77/32     *[Static/5] 2d 00:41:56
                    > via st0.119
10.17.11.128/26    *[BGP/170] 2d 00:34:04, localpref 150
                       AS path: 12076 I, validation-state: unverified
                     > to 192.168.11.0 via reth1.11
                       to 192.168.11.2 via reth2.11
                    [BGP/170] 2d 00:34:01, localpref 150
                      AS path: 12076 I, validation-state: unverified
                     > to 192.168.11.2 via reth2.11
                    [BGP/170] 2d 21:12:13, localpref 100, from 10.17.11.76
                       AS path: 65515 I, validation-state: unverified
                    > via st0.118
                     [BGP/170] 2d 00:41:51, localpref 100, from 10.17.11.77
                       AS path: 65515 I, validation-state: unverified
                     > via st0.119
```

В приведенной выше таблице маршрутов для маршрутов концентратора и периферийной виртуальной сети — 10.17.11.0/25 и 10.17.11.128/26 — мы рекомендуем использовать канал ExpressRoute через VPN-подключения. 192.168.11.0 и 192.168.11.2 являются IP-адресами в интерфейсе брандмауэра для маршрутизаторов CE.

## <a name="validation-of-route-exchange-over-s2s-vpn"></a>Проверка обмена маршрутами через VPN-подключение S2S

Ранее в этой статье мы проверили локальное объявление маршрутов брандмауэров на основной и дополнительный узлы BGP VPN-шлюза. Кроме того, давайте подтверждаем, что маршруты Azure получены брандмауэрами от основного и дополнительного узлов BGP VPN-шлюза.

```console
user@SEA-SRX42-01> show route receive-protocol bgp 10.17.11.76 table Cust11.inet.0 

Cust11.inet.0: 14 destinations, 21 routes (14 active, 0 holddown, 0 hidden)
  Prefix                  Nexthop              MED     Lclpref    AS path
  10.17.11.0/25           10.17.11.76                             65515 I
  10.17.11.128/26         10.17.11.76                             65515 I

{primary:node0}
user@SEA-SRX42-01> show route receive-protocol bgp 10.17.11.77 table Cust11.inet.0    

Cust11.inet.0: 14 destinations, 21 routes (14 active, 0 holddown, 0 hidden)
  Prefix                  Nexthop              MED     Lclpref    AS path
  10.17.11.0/25           10.17.11.77                             65515 I
  10.17.11.128/26         10.17.11.77                             65515 I
```

Аналогичным образом проверяйте наличие префиксов маршрута локальной сети, полученных VPN-шлюзом Azure. 

```powershell
PS C:\Users\user> Get-AzVirtualNetworkGatewayLearnedRoute -ResourceGroupName SEA-Cust11 -VirtualNetworkGatewayName SEA-Cust11-VNet01-gw-vpn | where {$_.Network -eq "10.1.11.0/25"} | select Network, NextHop, AsPath, Weight

Network      NextHop       AsPath      Weight
-------      -------       ------      ------
10.1.11.0/25 192.168.11.88 65020        32768
10.1.11.0/25 10.17.11.76   65020        32768
10.1.11.0/25 10.17.11.69   12076-65020  32769
10.1.11.0/25 10.17.11.69   12076-65020  32769
10.1.11.0/25 192.168.11.88 65020        32768
10.1.11.0/25 10.17.11.77   65020        32768
10.1.11.0/25 10.17.11.69   12076-65020  32769
10.1.11.0/25 10.17.11.69   12076-65020  32769
```

Как показано выше, у VPN-шлюза есть маршруты, полученные на первичном и вторичном узлах BGP VPN-шлюза. Он также имеет возможность видеть маршруты, полученные с помощью основного и дополнительного подключения ExpressRoute (с префиксом AS-Path в начале 12076). Чтобы проверить маршруты, полученные через VPN-подключения, необходимо знать локальный одноранговый IP-адрес узла BGP для подключений. В рассматриваемой настройке мы 192.168.11.88, и мы видим полученные с них маршруты.

Теперь давайте проверим маршруты, объявляемые VPN-шлюзом Azure, на локальный брандмауэр BGP (192.168.11.88).

```powershell
PS C:\Users\user> Get-AzVirtualNetworkGatewayAdvertisedRoute -Peer 192.168.11.88 -ResourceGroupName SEA-Cust11 -VirtualNetworkGatewayName SEA-Cust11-VNet01-gw-vpn |  select Network, NextHop, AsPath, Weight

Network         NextHop     AsPath Weight
-------         -------     ------ ------
10.17.11.0/25   10.17.11.76 65515       0
10.17.11.128/26 10.17.11.76 65515       0
10.17.11.0/25   10.17.11.77 65515       0
10.17.11.128/26 10.17.11.77 65515       0
```

Невозможность увидеть Обмен маршрутами свидетельствует об ошибке подключения. См. раздел [Устранение неполадок: VPN-подключение типа "сеть — сеть" Azure не может подключиться и остановить работу][VPN Troubleshoot] для устранения неполадок VPN-подключения.

## <a name="testing-failover"></a>Тестирование отработки отказа

Теперь, когда мы подтвердили успешные обмены маршрутами через VPN-подключение (плоскость управления), мы настроили переключение трафика (плоскости данных) из подключения ExpressRoute к VPN-подключению. 

>[!NOTE] 
>В рабочей среде тестирование отработки отказа должно выполняться во время запланированного рабочего окна обслуживания сети, так как оно может быть нарушено.
>

Перед переключением трафика давайте перейдем к текущему пути в программе установки с локального тестового сервера на тестовую виртуальную машину в периферийной виртуальной сети.

```console
C:\Users\PathLabUser>tracert 10.17.11.132

Tracing route to 10.17.11.132 over a maximum of 30 hops

  1    <1 ms    <1 ms    <1 ms  10.1.11.1
  2    <1 ms    <1 ms    11 ms  192.168.11.0
  3    <1 ms    <1 ms    <1 ms  192.168.11.18
  4     *        *        *     Request timed out.
  5     6 ms     6 ms     5 ms  10.17.11.132

Trace complete.
```

Основной и дополнительный подсети ExpressRoute для подключения типа "точка — точка" в настройках, соответственно, 192.168.11.16/30 и 192.168.11.20/30. В приведенном выше маршруте трассировки в шаге 3 видно, что мы используем 192.168.11.18, который является IP-адресом интерфейса основной MSEE. Присутствие интерфейса MSEE подтверждает, что наш текущий путь находится над ExpressRoute.

Как показано [в этой операции, мы][RST]используем следующие команды PowerShell для отключения основного и дополнительного пиринга канала ExpressRoute.

```powershell
$ckt = Get-AzExpressRouteCircuit -Name "expressroute name" -ResourceGroupName "SEA-Cust11"
$ckt.Peerings[0].State = "Disabled"
Set-AzExpressRouteCircuit -ExpressRouteCircuit $ckt
```

Время переключения отработки отказа зависит от времени конвергенции BGP. В нашей настройке коммутатор отработки отказа занимает несколько секунд (меньше 10). После параметра Repeat в Traceroute отображается следующий путь:

```console
C:\Users\PathLabUser>tracert 10.17.11.132

Tracing route to 10.17.11.132 over a maximum of 30 hops

  1    <1 ms    <1 ms    <1 ms  10.1.11.1
  2     *        *        *     Request timed out.
  3     6 ms     7 ms     9 ms  10.17.11.132

Trace complete.
```

Результат Traceroute подтверждает, что подключение резервного копирования через S2S VPN активно и может обеспечить непрерывность обслуживания в случае сбоя основного и дополнительного подключений ExpressRoute. Чтобы выполнить тестирование отработки отказа, включите подключения ExpressRoute и выполните нормализацию потока трафика, используя следующий набор команд.

```powershell
$ckt = Get-AzExpressRouteCircuit -Name "expressroute name" -ResourceGroupName "SEA-Cust11"
$ckt.Peerings[0].State = "Enabled"
Set-AzExpressRouteCircuit -ExpressRouteCircuit $ckt
```

Чтобы убедиться, что трафик переключается обратно в ExpressRoute, повторите traceroute и убедитесь, что он проходит через частный пиринг ExpressRoute.

## <a name="next-steps"></a>Дальнейшие действия

ExpressRoute предназначен для обеспечения высокого уровня доступности без единой точки отказа в сети Microsoft. По-прежнему канал ExpressRoute ограничен одним географическим регионом и поставщиком услуг. VPN-подключение S2S может быть хорошим решением пассивного резервного копирования аварийного восстановления для канала ExpressRoute. Для надежного решения пассивного резервного копирования, регулярного обслуживания пассивной конфигурации и периодической проверки соединение имеет большое значение. Важно, чтобы конфигурация VPN была устаревшей и периодически (скажем, каждый квартал) повторить шаги проверки и отработки отказа, описанные в этой статье, во время периода обслуживания.

Сведения о включении мониторинга и оповещений на основе метрик VPN-шлюза см. в разделе [Настройка оповещений в метриках VPN-шлюза][VPN-alerts].

Чтобы ускорить конвергенцию BGP после сбоя ExpressRoute, [Настройте бфд через ExpressRoute][BFD].

<!--Image References-->
[1]: ./media/use-s2s-vpn-as-backup-for-expressroute-privatepeering/topology.png "Рассматриваемая топология"
[2]: ./media/use-s2s-vpn-as-backup-for-expressroute-privatepeering/vpn-gw-config.png "Конфигурация VPN GW"

<!--Link References-->
[DR-PP]: ./designing-for-disaster-recovery-with-expressroute-privatepeering.md
[Conf-CoExist]: ./expressroute-howto-coexist-resource-manager.md
[HA]: ./designing-for-high-availability-with-expressroute.md
[VPN Troubleshoot]: ../vpn-gateway/vpn-gateway-troubleshoot-site-to-site-cannot-connect.md
[VPN-alerts]: ../vpn-gateway/vpn-gateway-howto-setup-alerts-virtual-network-gateway-metric.md
[BFD]: ./expressroute-bfd.md
[RST]: ./expressroute-howto-reset-peering.md