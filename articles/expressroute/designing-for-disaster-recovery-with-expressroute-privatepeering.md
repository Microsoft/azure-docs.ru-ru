---
title: 'Azure ExpressRoute: проектирование аварийного восстановления'
description: На этой странице приведены рекомендации по архитектуре для аварийного восстановления при использовании Azure ExpressRoute.
services: expressroute
author: duongau
ms.service: expressroute
ms.topic: article
ms.date: 03/22/2021
ms.author: duau
ms.openlocfilehash: 3da044057784763df8d071af6c101f7baffbefc6
ms.sourcegitcommit: f0a3ee8ff77ee89f83b69bc30cb87caa80f1e724
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/26/2021
ms.locfileid: "105562313"
---
# <a name="designing-for-disaster-recovery-with-expressroute-private-peering"></a>Проектирование аварийного восстановления с помощью частного пиринга ExpressRoute

ExpressRoute обеспечивает высокий уровень доступности для обеспечения возможности подключения частной сети к ресурсам Майкрософт на несущей категории. Иными словами, в пути ExpressRoute в сети Microsoft нет единой точки отказа. Рекомендации по проектированию для повышения доступности канала ExpressRoute см. в статье [Разработка для обеспечения высокого уровня доступности с помощью expressroute][HA].

Тем не менее,*если бы что-то пойдет* в мерфие, то в этой статье мы расскажем о решениях, которые выходят за пределы сбоев, которые могут быть решены с помощью одного канала ExpressRoute. Мы будем рассматривать рекомендации по архитектуре сети для создания надежного сетевого подключения к серверу для аварийного восстановления с помощью геоизбыточных каналов ExpressRoute.

>[!NOTE]
>Основные понятия, описанные в этой статье, справедливы при создании канала ExpressRoute в виртуальной глобальной сети или за ее пределами.
>

## <a name="need-for-redundant-connectivity-solution"></a>Необходимость решения избыточного подключения

Существуют возможности и экземпляры, в которых вся региональная услуга (от Майкрософт, поставщики сетевых услуг, клиентов или другие поставщики облачных служб) снижена. Основная причина такого уровня влияния на общедоступную службу — естественное бедствия. Поэтому для обеспечения непрерывности бизнес-процессов и критически важных приложений важно спланировать аварийное восстановление.   

Независимо от того, выполняются ли критически важные приложения в регионе Azure или локально или в другом месте, вы можете использовать другой регион Azure в качестве сайта отработки отказа. Следующие статьи посвящены аварийному восстановлению приложений и интерфейсных перспектив доступа.

- [Аварийное восстановление корпоративного масштаба][Enterprise DR]
- [Аварийное восстановление для малого и среднего бизнеса с помощью Azure Site Recovery][SMB DR]

Если вы полагаетесь на подключение ExpressRoute между локальной сетью и корпорацией Майкрософт для критически важных операций, план аварийного восстановления также должен включать геоизбыточное подключение к сети. 

## <a name="challenges-of-using-multiple-expressroute-circuits"></a>Проблемы использования нескольких каналов ExpressRoute

При соединении одного набора сетей с несколькими подключениями используются параллельные пути между сетями. Параллельные пути, если они не спроектированы должным образом, могут привести к асимметричной маршрутизации. При наличии сущностей с отслеживанием состояния (например, NAT, брандмауэра) в пути асимметричная маршрутизация может блокировать поток трафика.  Как правило, по пути частного пиринга ExpressRoute вы не будете поступать между сущностями с отслеживанием состояния, например NAT или брандмауэрами. Именно поэтому асимметричная маршрутизация через частный пиринг ExpressRoute не обязательно блокирует поток трафика.
 
Однако, если нагрузка распределяет трафик между географически избыточными параллельными путями независимо от того, имеются ли у вас сущности с отслеживанием состояния или нет, то производительность сети будет несогласованной. Эти геоизбыточные параллельные пути могут быть с помощью одной линии метро или разных Metro на странице [поставщики по расположению](expressroute-locations-providers.md#partners) . 

### <a name="same-metro"></a>То же Metro

[Многие линии метро](expressroute-locations-providers.md#global-commercial-azure) имеют два расположения ExpressRoute. Примером может быть *Амстердам* и *Amsterdam2*. При проектировании избыточности можно создать два параллельных пути к Azure с обоими расположениями в одной линии метро. Преимущество такого подхода заключается в том, что происходит отработка отказа приложения, а также сквозная задержка между локальными приложениями и корпорацией Майкрософт. Однако если существует естественная авария, например землетрясения, то возможность подключения для обоих путей может быть недоступна.

### <a name="different-metros"></a>Различные линии метро

При использовании различных Metro для обеспечения избыточности вторичное расположение должно находиться в том же [географическом регионе](expressroute-locations-providers.md#locations). Чтобы выбрать расположение за пределами географического региона, необходимо использовать SKU уровня "Премиум" для обеих каналов в параллельных путях. Преимуществом этой конфигурации является вероятность стихийного сбоя, приводящая к тому, что переход на обе связи окажется намного ниже, но с увеличением времени задержки.

В этой статье мы рассмотрим, как решать проблемы, которые могут возникнуть при настройке геоизбыточных путей.

## <a name="small-to-medium-on-premises-network-considerations"></a>Рекомендации для малых и средних локальных сетей

Рассмотрим пример сети, показанный на следующей схеме. В этом примере геоизбыточное подключение ExpressRoute устанавливается между локальным расположением Contoso и виртуальной сетью Contoso в регионе Azure. На диаграмме сплошная зеленая линия указывает предпочтительный путь (через ExpressRoute 1), а пунктирный — путь (через ExpressRoute 2).

[![1]][1]

При проектировании подключения ExpressRoute для аварийного восстановления необходимо учитывать следующее.

- Использование геоизбыточных каналов ExpressRoute
- использование различных сетей поставщика услуг для разных каналов ExpressRoute
- Проектирование каждого канала ExpressRoute для обеспечения [высокой доступности][HA]
- прерывание другой цепи ExpressRoute в другом расположении в клиентской сети

По умолчанию, если вы объявляете маршруты одинаково по всем путям ExpressRoute, Azure будет балансировать нагрузку локального связанного трафика по всем путям ExpressRoute, используя маршрутизацию с одинаковой ценой (ECMP).

Однако при использовании геоизбыточных каналов ExpressRoute необходимо учитывать разные сетевые производительность с разными сетевыми путями (особенно для задержки в сети). Чтобы обеспечить более согласованную производительность сети во время нормальной работы, вы можете предпочесть канал ExpressRoute, предлагающий минимальную задержку.

Вы можете повлиять на Azure, чтобы предпочитать один канал ExpressRoute другим, используя один из следующих методов (перечисленных в порядке эффективности):

- объявление более конкретного маршрута по отношению к предпочтительному каналу ExpressRoute по сравнению с другими каналами ExpressRoute
- Настройка более высокого веса подключения для подключения, связывающего виртуальную сеть с предпочтительным каналом ExpressRoute
- Объявление маршрутов на основе менее предпочтительного канала ExpressRoute с более длинным путем (в начале пути)

### <a name="more-specific-route"></a>Более конкретный маршрут

На следующей схеме показано влияние на выбор пути ExpressRoute с использованием более конкретного объявления маршрута. В проиллюстрированном примере диапазон локальных и 24 IP-адресов Contoso объявляется как два/25 диапазонов адреса с помощью предпочтительного пути (ExpressRoute 1) и AS/24 через путь в режиме ожидания (ExpressRoute 2).

[![2]][2]

Поскольку/25 является более конкретным, по сравнению с/24, Azure отправляет трафик, предназначенный для 10.1.11.0/24, через ExpressRoute 1 в обычном состоянии. Если подключения ExpressRoute 1 отключаются, то виртуальная сеть будет видеть объявление маршрута 10.1.11.0/24 только через ExpressRoute 2; и поэтому в этом состоянии сбоя используется резервный канал.

### <a name="connection-weight"></a>Вес подключения

На следующем снимке экрана показано, как настроить вес подключения ExpressRoute с помощью портал Azure.

[![3-5]][3]

На следующей схеме показано влияние выбора пути ExpressRoute с помощью веса соединения. Значение веса соединения по умолчанию — 0. В приведенном ниже примере весовой коэффициент подключения для ExpressRoute 1 настроен как 100. Когда виртуальная сеть получает префикс маршрута, объявленный через несколько каналов ExpressRoute, виртуальная сеть предпочитает подключение с самым высоким весом.

[![четырех]][4]

Если подключения ExpressRoute 1 отключаются, то виртуальная сеть будет видеть объявление маршрута 10.1.11.0/24 только через ExpressRoute 2; и поэтому в этом состоянии сбоя используется резервный канал.

### <a name="as-path-prepend"></a>В начале пути

На следующей схеме показано влияние на выбор пути ExpressRoute с помощью AS в начале пути. На схеме объявление маршрута через ExpressRoute 1 указывает поведение eBGP по умолчанию. В объявлении маршрутов через ExpressRoute 2 локальная сеть ASN добавляется в начало в качестве пути к маршруту. При получении одного и того же маршрута через несколько каналов ExpressRoute в процессе выбора маршрута eBGP виртуальная сеть предпочитает маршрут с кратчайшим путем в качестве пути. 

[![5.0]][5]

Если подключения ExpressRoute 1 отключаются, то виртуальная сеть будет видеть объявление маршрута 10.1.11.0/24 только через ExpressRoute 2. В последовательном, более длинный путь будет неважен. Поэтому в этом состоянии сбоя будет использоваться резервный канал.

Используя любой из методов, если вы повлияете на Azure на использование одного из ExpressRoute поверх других, необходимо также убедиться, что в локальной сети также предпочтительный путь ExpressRoute для трафика, связанного с Azure, чтобы избежать использования асимметричных потоков. Как правило, локальное значение предпочтений используется для того, чтобы повлиять на локальную сеть, чтобы предпочитать один канал ExpressRoute другим. Локальная настройка — это внутренняя метрика BGP (Ибгп). Рекомендуется использовать маршрут BGP с самым высоким значением предпочтения.

> [!IMPORTANT]
> При использовании определенных каналов ExpressRoute в качестве изолированных необходимо активно управлять ими и периодически тестировать отработку отказа. 
> 

## <a name="large-distributed-enterprise-network"></a>Крупная распределенная Корпоративная сеть

При наличии крупной распределенной корпоративной сети, скорее всего, у вас есть несколько каналов ExpressRoute. В этом разделе показано, как спроектировать аварийное восстановление с помощью каналов ExpressRoute "активный — активный", не требуя наличия еще одной цепи. 

Рассмотрим пример, показанный на следующей схеме. В этом примере компания Contoso имеет два локальных расположения, подключенных к двум развертываниям Contoso IaaS в двух разных регионах Azure через каналы ExpressRoute в двух разных местах пиринга. 

[![6]][6]

Архитектура аварийного восстановления влияет на маршрутизацию трафика между регионами (Region1/region2 to location2/location1). Давайте рассмотрим две различные архитектурные ситуации, которые направляют трафик между регионами по-разному.

### <a name="scenario-1"></a>Сценарий 1

В первом случае настроим аварийное восстановление таким, что весь трафик между регионом Azure и локальным сетевым потоком проходит через локальный канал ExpressRoute в стабильном состоянии. Если локальный канал ExpressRoute завершается сбоем, то удаленный канал ExpressRoute используется для всех потоков трафика между Azure и локальной сетью.

Сценарий 1 показан на следующей схеме. На схеме зеленые линии обозначают пути для потока трафика между VNet1 и локальными сетями. Синие линии указывают пути для потока трафика между VNet2 и локальными сетями. Сплошные линии указывают нужный путь в стабильном состоянии, а пунктирные линии указывают путь трафика в случае сбоя соответствующего канала ExpressRoute, который переносит поток трафика устойчивого состояния. 

[![7]][7]

Вы можете спроектировать сценарий, используя вес подключения, чтобы повлиять на виртуальных сетей, чтобы предпочитать подключение к локальному расположению ExpressRoute для трафика, привязанного к локальной сети. Чтобы завершить решение, необходимо обеспечить симметричный обратный поток трафика. Вы можете использовать локальные предпочтения в сеансе Ибгп между маршрутизаторами BGP (на которых каналы ExpressRoute прерываются на локальной стороне), чтобы предпочитать канал ExpressRoute. Решение показано на следующей схеме. 

[![8]][8]

### <a name="scenario-2"></a>Сценарий 2

Сценарий 2 показан на следующей схеме. На схеме зеленые линии обозначают пути для потока трафика между VNet1 и локальными сетями. Синие линии указывают пути для потока трафика между VNet2 и локальными сетями. В стабильном состоянии (сплошные линии на схеме) весь трафик между виртуальных сетей и локальными расположениями передается через магистральную сеть Майкрософт, а затем проходит через подключение между локальными расположениями только в состоянии сбоя (пунктирные линии на схеме) ExpressRoute.

[![9]][9]

Решение показано на следующей схеме. Как проиллюстрировано, вы можете спроектировать сценарий с помощью более конкретного маршрута (вариант 1) или в начале пути (вариант 2), чтобы зависеть от выбора пути виртуальной сети. Чтобы выбрать сетевой маршрут для трафика, связанного с Azure, необходимо настроить связь между локальным расположением и менее предпочтительным. Лорд хау вы настраиваете связь между подключениями, как предпочтительно, зависит от протокола маршрутизации, используемого в локальной сети. Вы можете использовать локальные предпочтения с Ибгп или метрикой с ИГП (OSPF или имеет).

[![10]][10]


## <a name="next-steps"></a>Дальнейшие действия

В этой статье мы рассмотрели, как спроектировать аварийное восстановление подключения частного пиринга в канале ExpressRoute. Следующие статьи посвящены аварийному восстановлению приложений и интерфейсных перспектив доступа.

- [Аварийное восстановление корпоративного масштаба][Enterprise DR]
- [Аварийное восстановление для малого и среднего бизнеса с помощью Azure Site Recovery][SMB DR]

<!--Image References-->
[]: ./media/designing-for-disaster-recovery-with-expressroute-pvt/one-region.png "требования к локальной сети от 1 до среднего размера"
[2]: ./media/designing-for-disaster-recovery-with-expressroute-pvt/specificroute.png "влияние на выбор пути с помощью более конкретных маршрутов"
[3]: ./media/designing-for-disaster-recovery-with-expressroute-pvt/configure-weight.png. "Настройка веса подключения с помощью портал Azure"
[4]: ./media/designing-for-disaster-recovery-with-expressroute-pvt/connectionweight.png "влияние на выбор пути с помощью веса соединения"
[5]: ./media/designing-for-disaster-recovery-with-expressroute-pvt/aspath.png. "влияние выбора пути в начало пути в начале"
[6]: ./media/designing-for-disaster-recovery-with-expressroute-pvt/multi-region.png. "требования к распределенной локальной сети"
[7]: ./media/designing-for-disaster-recovery-with-expressroute-pvt/multi-region-arch1.png "Сценарий 1"
[8]: ./media/designing-for-disaster-recovery-with-expressroute-pvt/multi-region-sol1.png "активных-активных каналов ExpressRoute, решение 1"
[9]: ./media/designing-for-disaster-recovery-with-expressroute-pvt/multi-region-arch2.png "Сценарий 2"
[10]: ./media/designing-for-disaster-recovery-with-expressroute-pvt/multi-region-sol2.png "активных и активных каналов ExpressRoute, решение 2"

<!--Link References-->
[HA]: ./designing-for-high-availability-with-expressroute.md
[Enterprise DR]: https://azure.microsoft.com/solutions/architecture/disaster-recovery-enterprise-scale-dr/
[SMB DR]: https://azure.microsoft.com/solutions/architecture/disaster-recovery-smb-azure-site-recovery/
[con wgt]: ./expressroute-optimize-routing.md#solution-assign-a-high-weight-to-local-connection
[AS Path Pre]: ./expressroute-optimize-routing.md#solution-use-as-path-prepending
