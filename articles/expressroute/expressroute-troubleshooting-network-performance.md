---
title: 'Устранение неполадок сетевого канала: Azure'
description: Эта страница содержит сведения о стандартном методе тестирования производительности сетевого соединения Azure.
services: expressroute
author: duongau
ms.service: expressroute
ms.topic: troubleshooting
ms.date: 01/07/2021
ms.author: duau
ms.custom: seodec18
ms.openlocfilehash: 35e080e0fe45c18ad6a6d5392e0c78b116853c3e
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "98027474"
---
# <a name="troubleshooting-network-performance"></a>Устранение проблем с производительностью сети
## <a name="overview"></a>Обзор
Azure обеспечивает устойчивый и быстрый способ подключения из локальной сети к Azure. Небольшие и крупные компании успешно используют такие методы, как VPN-подключение "сеть — сеть" и ExpressRoute, для ведения бизнеса в Azure. Но что происходит, когда производительность не соответствует вашим ожиданиям или прежним показателям? Эта статья поможет стандартизировать способ тестирования и базовых показателей конкретной среды.

Вы узнаете, как легко и регулярно тестировать задержку в сети и пропускную способность между двумя узлами. Кроме того, вы получите рекомендации по способам просмотра сети Azure, помогающей изолировать проблемные точки. Для рассматриваемых скрипта PowerShell и средств требуется наличие двух узлов в сети (на обоих концах тестируемого соединения). Один узел должен быть Windows Server или рабочим столом, другой может быть Windows или Linux. 

>[!NOTE]
>Используемые подход к устранению неполадок, инструменты и методы зависят от личных предпочтений. В этом документе описывается подход и инструменты, которые я часто использую. Вы можете использовать собственный подход к решению проблем. Тем не менее если у вас нет установленного подхода, этот документ может помочь вам сформировать собственные методы и определить нужные инструменты для устранения неполадок сети.
>
>

## <a name="network-components"></a>Сетевые компоненты
Прежде чем углубиться в устранение неполадок, рассмотрим некоторые общие понятия и компоненты. Мы упомянем каждый компонент в сквозной цепочке, которая обеспечивает возможность подключения в Azure.
![1][1]

На высшем уровне описывается три основных домена сетевой маршрутизации:

- сеть Azure (синее облако справа);
- Интернет или глобальная сеть (зеленое облако в центре);
- корпоративная сеть (персиковое облако слева).

Кратко рассмотрим каждый компонент на схеме, идя справа налево.
 - **Виртуальная машина** . сервер может иметь несколько сетевых интерфейсов. Убедитесь, что все статические маршруты, маршруты по умолчанию и параметры операционной системы отправляют и получают трафик по своему мнению. Кроме того, каждый номер SKU виртуальной машины имеет ограничение пропускной способности. Если вы используете меньший номер SKU виртуальной машины, трафик ограничивается пропускной способностью, доступной в сетевом адаптере. Обычно я использую DS5v2 для тестирования (после чего удаляю эту виртуальную машину для экономии средств), чтобы обеспечить достаточную пропускную способность на виртуальной машине.
 - **Сетевой адаптер.** Убедитесь, что вы знаете частный IP-адрес, назначенный сетевому адаптеру.
 - **Группы безопасности сети, примененные к сетевому адаптеру.** На уровне сетевого адаптера могут применяться конкретные группы безопасности сети (NSG). Убедитесь, что набор правил группы безопасности сети подходит для передаваемого трафика. Например, убедитесь, что порты 5201 для iPerf, 3389 для RDP или 22 для SSH открыты для прохождения тестового трафика.
 - **Подсеть виртуальной сети.** Сетевой адаптер назначается конкретной подсети. Вам нужно знать, какой подсети и какие правила с ней связаны.
 - **Группа безопасности сети для подсети**. Аналогично сетевым адаптерам группы безопасности сети также могут применяться к подсети. Убедитесь, что набор правил группы безопасности сети подходит для передаваемого трафика. (Для трафика, входящего в сетевую карту, сначала применяется подсеть NSG, затем сетевая карта NSG. Когда трафик исходит из виртуальной машины, сетевой адаптер NSG применяется первыми, после чего применяется подсеть NSG.
 - **Подсеть UDR** -User-Defined маршруты могут направлять трафик на промежуточный прыжок (например, брандмауэр или балансировщик нагрузки). Убедитесь, что у вас есть UDR для трафика. Если да, то понять, где он находится, а также о том, что делает следующий прыжок для вашего трафика. Например, брандмауэр может передать некоторый трафик и запретить другой трафик между этими двумя узлами.
 - **Определяемый пользователем маршрут или NSG подсети шлюза.** Так же как подсеть виртуальной машины, подсеть шлюза может иметь группы безопасности сети и определяемые пользователем маршруты. Убедитесь, что вы знаете, есть ли у них и каковы их влияние на трафик.
 - **Шлюз виртуальной сети (ExpressRoute).** При использовании пиринга (ExpressRoute) или включения VPN не многие параметры могут повлиять на маршрутизацию трафика. При наличии шлюза виртуальной сети, подключенного к нескольким каналам ExpressRoute или VPN-туннелям, следует учитывать параметры веса подключения. Вес подключения влияет на настройки соединения и определяет путь, который принимает трафик.
 - **Фильтр маршрутов** (не показан) — фильтр маршрутов необходим при использовании пиринга Майкрософт через ExpressRoute. Если вы не получаете какие-либо маршруты, проверьте, правильно ли настроен фильтр маршрута и применен ли он к каналу.

Мы дошли к части глобальной сети соединения. Этим доменом маршрутизации может быть поставщик услуг, глобальная корпоративная сеть или Интернет. Существует много прыжков, устройств и компаний, участвующих в этих ссылках, что может усложнить устранение неполадок. Прежде чем можно будет исследовать прыжки между, необходимо сначала отфильтровать Azure и корпоративные сети.

На предыдущей схеме слева находится ваша корпоративная сеть. В зависимости от размера вашей компании этот домен маршрутизации может быть представлен несколькими сетевыми устройствами между вами и глобальной сетью или несколькими уровнями устройств в сети корпуса или предприятия.

Учитывая сложность этих трех различных сетевых сред высокого уровня. Часто лучше начать с краев и попытаться продемонстрировать, где производительность хорошо и где она снижается. Такой подход может помочь определить предмет проблемного домена маршрутизации трех. Затем вы можете сосредоточиться на устранении неполадок в этой конкретной среде.

## <a name="tools"></a>Инструменты
Большинство проблем сети можно проанализировать и изолировать с помощью базовых средств, таких как проверка связи и трассировка маршрута. В редких случаях необходимо пройти анализ пакетов с помощью таких средств, как Wireshark. 

Чтобы помочь в поиске и устранении неисправностей, был разработан набор средств подключения Azure (AzureCT), содержащий некоторые из этих средств. Для тестирования производительности такие средства, как iPerf и PSPing, могут предоставлять вам сведения о сети. iPerf — это часто используемое средство для базовых тестов производительность, которое довольно просто в использовании. PSPing — это средство проверки связи, разработанное компанией SysInternals. PSPing может выполнять проверки связи ICMP и TCP для доступа к удаленному узлу. Это упрощенные средства, которые легко установить, скопировав файлы в каталог на узле.

Эти средства и методы упаковываются в модуль PowerShell (AzureCT), который можно установить и использовать.

### <a name="azurect---the-azure-connectivity-toolkit"></a>AzureCT — набор средств подключения Azure
Модуль AzureCT PowerShell состоит из двух компонентов — [тестирования доступности][Availability Doc] и [тестирования производительности][Performance Doc]. В этом документе рассматривается только тестирование производительности, поэтому сосредоточимся на двух командах производительности соединения в этом модуле PowerShell.

Для использования этого набора средств для тестирования производительности следует выполнить три шага: 1) установить модуль PowerShell; 2) установить вспомогательные приложения iPerf и PSPing; 3) выполнить тест производительности.

1. Установите модуль PowerShell.

    ```powershell
    (new-object Net.WebClient).DownloadString("https://aka.ms/AzureCT") | Invoke-Expression
    
    ```

    Эта команда загружает модуль PowerShell и устанавливает его локально.

2. Установите вспомогательные приложения.
    ```powershell
    Install-LinkPerformance
    ```
    Эта команда AzureCT устанавливает iPerf и PSPing в новый каталог "C:\ACTTools", а также открывает порты брандмауэра Windows, чтобы разрешить трафик по протоколу ICMP через порт 5201 (iPerf).

3. Запустите тест производительности.

    Во-первых, на удаленном узле необходимо установить и запустить iPerf в режиме сервера. Убедитесь, что удаленный хост прослушивает порт 3389 (протокол удаленного рабочего стола для Windows) либо порт 22 (SSH для Linux) и разрешает трафик через порт 5201 для iPerf. Если удаленный узел — Windows, установите AzureCT и выполните команду Install-LinkPerformance. Команда настроит iPerf и правила брандмауэра, необходимые для успешного запуска iPerf в режиме сервера. 
    
    После подготовки удаленного компьютера откройте PowerShell на локальном компьютере и запустите тестирование:
    ```powershell
    Get-LinkPerformance -RemoteHost 10.0.0.1 -TestSeconds 10
    ```

    Эта команда выполняет серию параллельных нагрузочных тестов и тестов задержки, чтобы оценить пропускную способность и задержку вашего сетевого соединения.

4. Просмотрите результаты тестирования.

    Формат выходных данных PowerShell выглядит примерно так:

    ![4][4]

    Подробные результаты всех тестов iPerf и PSPing находятся в отдельных текстовых файлах в каталоге средств AzureCT в пути "C:\ACTTools".

## <a name="troubleshooting"></a>Устранение неполадок
Если тест производительности не дает ожидаемых результатов, выясните, почему это должен быть последовательный пошаговый процесс. Учитывая количество компонентов в пути, систематический подход обеспечит более быстрый путь к разрешению, чем переходить. Устраняя систематическое устранение неполадок, можно избежать многократного ненужного тестирования.

>[!NOTE]
>Рассматриваемый сценарий решает проблему с производительностью, а не проблему с подключением. Шаги будут отличаться, если передача трафика не происходит.
>
>

Во-первых, следует проверить правильность своих предположений. Целесообразны ли ваши ожидания? Например, при наличии канала ExpressRoute с 1 Гбит/с и 100 мс задержки. Не рекомендуется рассчитывать полный трафик 1 Гбит/с с учетом характеристик производительности TCP по каналам высокой задержки. Дополнительные сведения касательно предположений о производительности см. в разделе [Справка](#references).

Далее я рекомендую начать с границ между доменами маршрутизации и попытаться изолировать проблему с одним крупным доменом маршрутизации. Вы можете начать с корпоративной сети, глобальной сети или сети Azure. Часто люди обвинение «черный ящик» в пути. Несмотря на то, что обвиняет черный ящик очень просто, это может значительно замедлить разрешение. Особенно если проблема находится в области, которую можно изменить для устранения проблемы. Перед обращением к поставщику услуг или интернет-провайдеру убедитесь, что вы выполнили комплексную проверку.

Как только вы определили основной домен маршрутизации, с которым, как вы считаете, возникла проблема, составьте схему соответствующей области. Нарисовав схему на доске, в блокноте или в Visio, вы можете методичное работу и изолировать проблему. Вы можете запланировать тестовые точки и обновлять карту по мере выполнения тестирования.

Теперь, когда у вас есть схема, разделите сеть на сегменты, чтобы сузить область поиска проблемы. Проверьте, в которых из сегментов присутствуют и отсутствуют проблемы. Продолжайте перемещаться по тестовым точкам, чтобы определить проблемный компонент.

Кроме того, не забудьте проверить другие уровни модели OSI. Вы можете сразу сосредоточиться на сети и уровнях 1–3 (физический уровень, уровень данных и уровень сети), но проблемы также могут быть на уровне 7 на уровне приложений. Будьте непредвзяты и проверяйте любые предположения.

## <a name="advanced-expressroute-troubleshooting"></a>Расширенное устранение проблем с ExpressRoute
Если вы не знаете, где на самом деле находится граничная точка облака, это может усложнить изолирование компонентов Azure. При использовании ExpressRoute граничной точкой является сетевой компонент Microsoft Enterprise Edge (MSEE). **При использовании EXPRESSROUTE** MSEE является первой точкой контакта в сети корпорации Майкрософт и последним прыжком при уходе в сеть Майкрософт. Когда вы создаете объект подключения между шлюзом виртуальной сети и каналом ExpressRoute, вы фактически подключаетесь к MSEE. Распознавание MSEE в качестве первого или последнего прыжка в зависимости от того, какое направление трафика важно для изоляции проблемы сети Azure. Узнайте, какое направление будет продолжено, если эта ошибка возникла в Azure или в корпоративной сети или в более низком направлении. 

![2][2]

>[!NOTE]
> Обратите внимание, что MSEE не находится в облаке Azure. ExpressRoute фактически находится в граничной части сети Майкрософт, а не в Azure. После подключения ExpressRoute к MSEE вы подключаетесь к сети Майкрософт. Отсюда вы можете переходить к любой из облачных служб, например Microsoft 365 (с Пирингом Майкрософт) или Azure (с частным и/или пиринга Майкрософт).
>
>

Если два виртуальных сетей подключены к **одному** каналу ExpressRoute, можно выполнить ряд тестов, чтобы изолировать проблему в Azure.
 
### <a name="test-plan"></a>План тестирования
1. Запустите тест Get-LinkPerformance между ВМ1 и ВМ2. Этот тест помогает определить, является ли проблема локальной. Если результаты теста показывают приемлемые задержку и пропускную способность, вы можете отметить локальную виртуальную сеть как работоспособную.
2. При условии, что в виртуальной локальной сети трафик проходит без проблем, запустите тест Get-LinkPerformance между ВМ1 и ВМ3. Этот тест проверяет подключение через сеть Майкрософт к MSEE и обратно в Azure. Если результаты теста показывают приемлемые задержку и пропускную способность, вы можете отметить сеть Azure как работоспособную.
3. Если вы исправили Azure, то можете выполнить аналогичную последовательность тестов в корпоративной сети. Если тестирование прошло успешно, пора обратиться к поставщику услуг или интернет-провайдеру для диагностики вашего подключения к глобальной сети. Пример. Выполните этот тест между двумя филиалами или вашим компьютером и сервером центра обработки данных. В зависимости от того, что вы тестируете, найдите конечные точки, такие как серверы и клиентские компьютеры, которые могут использовать этот путь.

>[!IMPORTANT]
> Для каждого теста нужно отмечать время его запуска и записывать результаты, например, в OneNote или Excel. Каждый тестовый запуск должен иметь идентичные выходные данные, чтобы вы могли сравнивать их результаты без "пробелов" в данных. Согласованность нескольких тестов является основной причиной, по которой рекомендуется использовать AzureCT для устранения неполадок. Суть не в точных сценариях нагрузки. Она *заключается в том*, что *тесты и выходные данные* согласованы каждый раз. Сведения о времени выполнения и согласованные данные всех тестов особенно полезны, если позже вы обнаружите, что проблема является спорадической. Будьте внимательны и собирайте данные с самого начала, чтобы избежать повторного тестирования тех же сценариев.
>
>

## <a name="the-problem-is-isolated-now-what"></a>Область возникновения проблемы обнаружена, что делать дальше?
Чем больше вы изолируете проблему, тем быстрее можно будет найти решение. В то время вы достигли точки, где вы не можете продолжить устранение неполадок. Например, вы видите ссылку в поставщике услуг через Европа, но вы ожидаете, что путь останется в Азии. На этом этапе вы должны обратиться за помощью к специалисту. То, что вы запрашиваете, зависит от домена маршрутизации, в котором вы изолируете эту неполадку. Если вы можете сократить его до определенного компонента, который будет еще лучше.

В случае проблем с корпоративными сетями внутренний ИТ-отдел или поставщик услуг могут помочь в настройке устройства или восстановлении оборудования.

Чтобы получить доступ к результатам тестирования для глобальной сети, обратитесь к своему поставщику услуг или поставщику услуг Интернета. Это также позволит избежать дублирования той же работы, которая уже выполнена. Не следует полагаться на них, если нужно проверить свои результаты. "Доверяй, но проверяй" — это хороший девиз при устранении неполадок на основе результатов других людей.

В Azure, как только вы точно выделите проблему, просмотрите [документацию по работе с сетью Azure][Network Docs], а затем, если все еще нужно, [откройте запрос в службу поддержки][Ticket Link].

## <a name="references"></a>Ссылки
### <a name="latencybandwidth-expectations"></a>Ожидания задержки и пропускной способности
>[!TIP]
> Задержка, связанная с географическим расположением (мили или километры) между конечными точками, которые вы тестируете, на сегодняшний день является самой значительной. Хотя существует также задержка, связанная с оборудованием, (физические и виртуальные компоненты, количество прыжков и т. д.), географическая составляющаяся является самой существенной частью задержки при работе с подключениями к глобальной сети. Важно отметить, что расстояние соответствует протяженности оптоволоконной линии, а не расстоянию по прямой или на дорожной карте. Это расстояние невероятно сложно точно рассчитать. В результате я обычно использую калькулятор расстояния в Интернете. Конечно, этот метод не предоставляет точных показателей, но этого достаточно, чтобы получить общее представление.
>
>

Я использую расположение ExpressRoute — Сиэтл, штат Вашингтон в США. В приведенной ниже таблице показаны показатели задержки и пропускной способности, полученные в результате тестирования подключения в различных расположениях Azure. Я рассчитал географическое расстояние между каждым граничным объектом теста.

Настройка тестирования:
 - Физический сервер под управлением Windows Server 2016 с сетевым адаптером 10 Гбит/с, подключенный к каналу ExpressRoute.
 - Канал ExpressRoute уровня "Премиум" с пропускной способностью 10 Гбит/с в расположении с частным пирингом.
 - Виртуальная сеть Azure со шлюзом UltraPerformance в указанном регионе.
 - Виртуальная машина DS5v2, работающая под управлением Windows Server 2016 в виртуальной сети. Не присоединенная к домену виртуальная машина, созданная на основе образа Azure по умолчанию (без оптимизации или настройки), с установленным AzureCT.
 - Все тесты используют команду AzureCT Get-LinkPerformance с 5-минутным нагрузочным тестом для каждого из шести тестовых запусков. Пример:

    ```powershell
    Get-LinkPerformance -RemoteHost 10.0.0.1 -TestSeconds 300
    ```
 - Поток данных для каждого теста имел нагрузку, исходящую от локального физического сервера (клиент iPerf в Сиэтле) к виртуальной машине Azure (сервер iPerf в указанном регионе Azure).
 - Данные столбца "Задержка" взяты из теста "Без нагрузки" (тест задержки TCP без запуска iPerf).
 - Данные столбца "Максимальная пропускная способность" взяты из 16-го теста нагрузки потока данных TCP с размером окна 1 МБ.

![3][3]

### <a name="latencybandwidth-results"></a>Результаты задержки и пропускной способности
>[!IMPORTANT]
> Эти данные предназначены только для общего ознакомления. Многие факторы влияют на задержку, и, хотя эти значения в целом согласуются с течением времени, условия в пределах Azure или сети поставщиков услуг могут отправлять трафик по разным каналам, что может повлиять на задержку и пропускную способность. Как правило, последствия этих изменений не приводят к существенным различиям.
>
>

| ExpressRoute<br/>Расположение|Azure<br/>Регион | Приблизительно<br/>Расстояние (км) | Задержка|Сеанс 1<br/>Пропускная способность | Максимум<br/>Пропускная способность |
| ------------------------------------------ | --------------------------- |  - | - | - | - |
| Сиэтл | Западная часть США 2        |    191 км |   5 мс | 262 Мбит/с |  3,74 Гбит/с |
| Сиэтл | Западная часть США          |  1,094 км |  18 мс |  82,3 Мбит/с |  3,70 Гбит/с |
| Сиэтл | Центральная часть США       |  2,357 км |  40 мс |  38,8 Мбит/с |  2,55 Гбит/с |
| Сиэтл | Центрально-южная часть США |  2,877 км |  51 мс |  30,6 Мбит/с |  2,49 Гбит/с |
| Сиэтл | Центрально-северная часть США |  2,792 км |  55 мс |  27,7 Мбит/с |  2,19 Гбит/с |
| Сиэтл | восточная часть США 2        |  3,769 км |  73 мс |  21,3 Мбит/с |  1,79 Гбит/с |
| Сиэтл | Восточная часть США          |  3,699 км |  74 мс |  21,1 Мбит/с |  1,78 Гбит/с |
| Сиэтл | Japan East       |  7,705 км | 106 мс |  14,6 Мбит/с |  1,22 Гбит/с |
| Сиэтл | южная часть Соединенного Королевства         |  7,708 км | 146 мс |  10,6 Мбит/с |   896 Мбит/с |
| Сиэтл | Западная Европа      |  7,834 км | 153 мс |  10,2 Мбит/с |   761 Мбит/с |
| Сиэтл | Восточная Австралия   | 12,484 км | 165 мс |   9,4 Мбит/с |   794 Мбит/с |
| Сиэтл | Southeast Asia   | 12,989 км | 170 мс |   9,2 Мбит/с |   756 Мбит/с |
| Сиэтл | Южная Бразилия*   | 10,930 км | 189 мс |   8,2 Мбит/с |   699 Мбит/с |
| Сиэтл | Южная Индия      | 12,918 км | 202 мс |   7,7 Мбит/с |   634 Мбит/с |

\* Задержка передачи данных в Бразилию является хорошим примером того, что прямолинейное расстояние значительно отличается от расстояния протяженности оптоволоконной линии. Ожидаемая задержка будет находиться в окружении 160 мс, но на самом деле 189 МС. Разница в задержке может означать ошибку в сети. Но реальность заключается в том, что линия волокно не помещается в Бразилии в виде прямой линии. Поэтому вы должны получить дополнительный 1 000 км или т. д., чтобы перейти к Бразилии в Сиэтле.

## <a name="next-steps"></a>Дальнейшие действия
1. Скачайте набор средств подключения Azure из GitHub по адресу [https://aka.ms/AzCT][ACT]
2. Следуйте указаниям по [тестированию производительности сетевого соединения][Performance Doc].

<!--Image References-->
[1]: ./media/expressroute-troubleshooting-network-performance/network-components.png "Сетевые компоненты Azure"
[2]: ./media/expressroute-troubleshooting-network-performance/expressroute-troubleshooting.png "Устранение неполадок ExpressRoute"
[3]: ./media/expressroute-troubleshooting-network-performance/test-diagram.png "Тестовая среда тестирования производительности"
[4]: ./media/expressroute-troubleshooting-network-performance/powershell-output.png "Выходные данные PowerShell"

<!--Link References-->
[Performance Doc]: https://github.com/Azure/NetworkMonitoring/blob/master/AzureCT/PerformanceTesting.md
[Availability Doc]: https://github.com/Azure/NetworkMonitoring/blob/master/AzureCT/AvailabilityTesting.md
[Network Docs]: ../index.yml
[Ticket Link]: https://portal.azure.com/#blade/Microsoft_Azure_Support/HelpAndSupportBlade/overview
[ACT]: https://aka.ms/AzCT