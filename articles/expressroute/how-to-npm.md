---
title: 'Azure ExpressRoute: Настройка NPM для каналов'
description: Настройка решения облачного мониторинга сети (NPM) для каналов Azure ExpressRoute. В этой статье описан мониторинг с использованием частного пиринга ExpressRoute и пиринга Майкрософт.
services: expressroute
author: duongau
ms.service: expressroute
ms.topic: how-to
ms.date: 01/25/2019
ms.author: duau
ms.openlocfilehash: 907c03bd15463368def316e72f55ce214cb3e617
ms.sourcegitcommit: e559daa1f7115d703bfa1b87da1cf267bf6ae9e8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/17/2021
ms.locfileid: "100571044"
---
# <a name="configure-network-performance-monitor-for-expressroute"></a>Настройка решения "Монитор производительности сети" для ExpressRoute

Эта статья поможет вам настроить расширение "Монитор производительности сети" для мониторинга ExpressRoute. "Монитор производительности сети" (NPM) представляет собой сетевое решение для мониторинга на основе облака, с помощью которого можно отслеживать подключение между облачными развертываниями Azure и локальными расположениями (филиалами и т. д.). NPM является частью журналов Azure Monitor. NPM предлагает расширение для ExpressRoute, которое позволяет отслеживать производительность сети с использованием каналов ExpressRoute, настроенных для использования частного пиринга или пиринга Майкрософт. При настройке NPM для ExpressRoute вы можете обнаружить проблемы сети, определить их и устранить. Эта служба также доступна для облака Azure для государственных организаций.

[!INCLUDE [azure-monitor-log-analytics-rebrand](../../includes/azure-monitor-log-analytics-rebrand.md)]

Вы можете:

* отслеживать потери и задержки в различных виртуальных сетях и настроить оповещения;

* отслеживать все пути (включая избыточные) в сети;

* устранить временные неполадки в сети и неполадки в сети до точки во времени, которые усложняют репликацию;

* определить конкретный сегмент в сети, с которым связана низкая производительность;

* получить пропускную способность для каждой виртуальной сети (при установке агентов в каждой виртуальной сети);

* просмотреть состояние системы ExpressRoute из предыдущей точки во времени.

## <a name="workflow"></a><a name="workflow"></a>Рабочий процесс

Агенты мониторинга устанавливаются на нескольких серверах, как локально, так и в среде Azure. Они взаимодействуют друг с другом, но отправляют не данные, а пакеты подтверждения TCP. Такое взаимодействие позволяет Azure сопоставить топологию сети и путь передачи трафика.

1. Создайте рабочую область NPM. Это то же самое, что и рабочая область Log Analytics.
2. Установите и настройте агенты программного обеспечения. (Если вы хотите только отслеживать через пиринг Майкрософт, вам не обязательно устанавливать и настраивать агенты программного обеспечения.) 
    * Установите агенты мониторинга на локальных серверах и виртуальных машинах Azure (для частного пиринга).
    * Настройте параметры на серверах, на которых расположены агенты мониторинга, чтобы разрешить их взаимодействие. (Откройте порты брандмауэра и т. д.).
3. Настройте правила группы безопасности сети (NSG), чтобы разрешить агентам мониторинга, установленным на виртуальных машинах Azure, взаимодействовать с локальными агентами.
4. Настройте мониторинг. Выполните автоматическое обнаружение и определите видимые сети в NPM.

Если вы уже используете решение "Монитор производительности сети" для отслеживания других объектов или служб и у вас есть рабочая область в одном из поддерживаемых регионов, вы можете пропустить шаги 1 и 2 и сразу же приступить к выполнению шага 3.

## <a name="step-1-create-a-workspace"></a><a name="configure"></a>Шаг 1. Создание рабочей области

Создайте рабочую область (в подписке с виртуальной сетью, связанной с каналами ExpressRoute).

1. На [портале Azure](https://portal.azure.com) выберите подписку, которая включает виртуальные сети, подключенные с помощью пиринговой связи к каналу ExpressRoute. Затем найдите в списке служб в **Marketplace** решение "Монитор производительности сети". Щелкните возвращенный результат, чтобы открылась страница **Монитор производительности сети**.

   >[!NOTE]
   >Вы можете создать новую рабочую область или использовать имеющуюся. Если выбрана имеющаяся рабочая область, убедитесь, что она использует новый язык запросов. [Дополнительные сведения...](../azure-monitor/logs/log-query-overview.md)
   >

   ![портал](./media/how-to-npm/3.png)<br><br>
2. В нижней области главной страницы **Монитор производительности сети** щелкните **Создать**, чтобы открыть страницу **Монитор производительности сети — Создание решения**. Щелкните **"Рабочая область Log Analytics" — "Выберите рабочую область"**, чтобы открыть страницу рабочих областей. Щелкните **+ Create New Workspace** (+ Создать рабочую область), чтобы открыть страницу рабочей области.
3. На странице **log Analytics Рабочая область** выберите **создать**, а затем настройте следующие параметры.

   * Рабочая область Log Analytics. Введите имя рабочей области.
   * Подписка. Если у вас есть несколько подписок, выберите ту, которую нужно привязать к новой рабочей области.
   * Группа ресурсов. Создайте группу ресурсов или используйте имеющуюся.
   * Расположение. Указание расположения учетной записи хранения для журналов подключений агента.
   * Ценовая категория. Выберите ценовую категорию.
  
     >[!NOTE]
     >Канал ExpressRoute может находиться в любой точке мира. Он не обязательно находится в том же регионе, что и рабочая область.
     >
  
     ![Рабочая область](./media/how-to-npm/4.png)<br><br>
4. Нажмите кнопку **ОК**, чтобы сохранить и развернуть шаблон параметров. После проверки шаблона щелкните **Создать**, чтобы развернуть рабочую область.
5. После развертывания рабочей области перейдите в созданный ресурс **NetworkMonitoring(name)**. Проверьте значения параметров, а затем щелкните **Для решения требуется дополнительная настройка**.

   ![дополнительная настройка](./media/how-to-npm/5.png)

## <a name="step-2-install-and-configure-agents"></a><a name="agents"></a>Шаг 2. Установка и настройка агентов

### <a name="21-download-the-agent-setup-file"></a><a name="download"></a>2.1. Скачивание файла установки агента

1. На странице для ресурса **Конфигурация монитора производительности сети** перейдите на вкладку **Общие параметры**. В разделе **Install Log Analytics Agents** (Установка агентов Log Analytics) выберите агент, соответствующий процессору вашего сервера, и скачайте файл установки.
2. Затем скопируйте **идентификатор рабочего пространства** и **первичный ключ** в Блокнот.
3. В разделе **Configure Log Analytics Agents for monitoring using TCP protocol** (Настройка агентов Log Analytics для мониторинга по протоколу TCP) загрузите скрипт PowerShell. С его помощью вы сможете открыть соответствующий порт брандмауэра для транзакций TCP.

   ![Сценарий PowerShell](./media/how-to-npm/7.png)

### <a name="22-install-a-monitoring-agent-on-each-monitoring-server-on-each-vnet-that-you-want-to-monitor"></a><a name="installagent"></a>2.2. Установка агента мониторинга на каждом сервере мониторинга (в каждой виртуальной сети, которую нужно отслеживать)

Рекомендуется установить по крайней мере два агента на каждой стороне подключения ExpressRoute, чтобы обеспечить избыточность (например, локально, в виртуальных сетях Azure). Агент должен быть установлен на компьютере Windows Server 2008 с пакетом обновления 1 (SP1) или более поздней версии. Мониторинг каналов ExpressRoute с использованием ОС Windows Desktop и ОС Linux не поддерживается. Чтобы установить агенты, выполните следующие действия.
   
  >[!NOTE]
  >Для агентов, отправленных SCOM (в том числе [MMA](/previous-versions/system-center/system-center-2012-R2/dn465154(v=sc.12))), если они размещены в Azure, определение расположения может работать нестабильно. Рекомендуется не использовать эти агенты в виртуальных сетях Azure для мониторинга ExpressRoute.
  >

1. Запустите **установку**, чтобы установить агент на каждом сервере, который вы хотите использовать для отслеживания ExpressRoute. Сервером, используемым для мониторинга, может быть как виртуальная машина, так и локальный компьютер, но сервер обязательно должен иметь доступ к Интернету. Вам необходимо установить по крайней мере один агент локально, а также по одному агенту для каждого сегмента сети, которые вы хотите отслеживать в Azure.
2. На странице **Приветствие** нажмите кнопку **Далее**.
3. На странице **условия лицензии** Прочтите лицензию и нажмите кнопку **принимаю**.
4. На странице **Папка назначения** измените или сохраните папку установки по умолчанию, а затем нажмите кнопку **Далее**.
5. На странице **Параметры установки агента** можно выбрать подключение агента к Azure Monitor журналов или Operations Manager. Или можете не выбирать эти варианты, если хотите настроить агент позже. Выбрав нужный вариант, нажмите кнопку **Далее**.

   * Если выбрано подключение к **Azure Log Analytics**, вставьте **идентификатор рабочей области** и **ключ рабочей области** (первичный ключ), скопированные в Блокнот на предыдущих шагах. Затем щелкните **Далее**.

     ![Идентификатор и ключ](./media/how-to-npm/8.png)
   * Если выбрано подключение к **Operations Manager**, на странице **Management Group Configuration** (Конфигурация группы управления) введите **имя группы управления**, **сервер управления** и **порт сервера управления**. Затем щелкните **Далее**.

     ![Operations Manager](./media/how-to-npm/9.png)
   * На странице **Учетная запись действия агента** выберите **локальную системную** учетную запись или **учетную запись доменного или локального компьютера**. Затем щелкните **Далее**.

     ![Учетная запись](./media/how-to-npm/10.png)
6. На странице **все готово для установки** просмотрите выбранные параметры и нажмите кнопку **установить**.
7. На странице **Настройка успешно завершена** нажмите кнопку **Готово**.
8. После завершения установки на панели управления появится Microsoft Monitoring Agent. Вы можете проверить конфигурацию и убедиться, что агент подключен к журналам Azure Monitor. При подключении агент выдает следующее сообщение: **The Microsoft Monitoring Agent has successfully connected to the Microsoft Operations Management Suite service** (Microsoft Monitoring Agent успешно подключен к службе Microsoft Operations Management Suite).

9. Повторите эти действия для каждой виртуальной сети, которую нужно отслеживать.

### <a name="23-configure-proxy-settings-optional"></a><a name="proxy"></a>2.3. Настройка параметров прокси-сервера (необязательно)

Если вы используете веб-прокси для доступа к Интернету, выполните шаги ниже, чтобы настроить параметры прокси-сервера для Microsoft Monitoring Agent. Эти действия необходимо выполнить для каждого сервера. Если вам нужно настроить несколько серверов, возможно, проще использовать скрипт для автоматизации этого процесса. В таком случае мы рекомендуем ознакомиться с разделом [Как настроить параметры прокси-сервера для Microsoft Monitoring Agent с помощью скрипта](../azure-monitor/agents/agent-windows.md).

Чтобы настроить параметры прокси-сервера для Microsoft Monitoring Agent с помощью панели управления, сделайте следующее:

1. Откройте **Панель управления**.
2. Откройте **Microsoft Monitoring Agent**.
3. Перейдите на вкладку **Параметры прокси-сервера**.
4. Установите флажок **Использовать прокси-сервер** и введите URL-адрес и номер порта (если они нужны). Если для доступа к прокси-серверу требуется проверка подлинности, введите имя пользователя и пароль.

   ![proxy](./media/how-to-npm/11.png)

### <a name="24-verify-agent-connectivity"></a><a name="verifyagent"></a>2.4. Проверка подключения к агенту

Вы можете легко проверить, могут ли агенты обмениваться данными.

1. На сервере, на котором установлен агент мониторинга, откройте **панель управления**.
2. Откройте **Microsoft Monitoring Agent**.
3. Откройте вкладку **Azure Log Analytics**.
4. В столбце **состояние** вы увидите, что агент успешно подключился к Azure Monitor журналов.

   ![status](./media/how-to-npm/12.png)

### <a name="25-open-the-firewall-ports-on-the-monitoring-agent-servers"></a><a name="firewall"></a>2.5. Открытие портов брандмауэра на серверах агента мониторинга

Чтобы использовать протокол TCP, необходимо открыть порты брандмауэра, чтобы агенты мониторинга могли обмениваться данными.

Для создания разделов реестра, необходимых для монитора производительности сети, можно запустить сценарий PowerShell. Этот сценарий также создаст правила брандмауэра Windows, разрешающие агентам мониторинга создавать TCP-подключения между собой. В разделах реестра, созданных сценарием, укажите, следует ли записывать журналы отладки и путь к файлу журнала. Он также определяет TCP-порт агента, используемый для обмена данными. Значения этих разделов автоматически устанавливаются с помощью скрипта. Не изменяйте эти разделы вручную.

Открытый порт по умолчанию — 8084. Вы можете использовать пользовательский порт, задав в сценарии параметр portNumber. Тем не менее, если это сделать, необходимо указать один порт для всех серверов, на которых вы запускаете сценарий.

>[!NOTE]
>Сценарий PowerShell "EnableRules" настраивает правила брандмауэра Windows только на том сервере, где он выполняется. При наличии брандмауэра сети он должен разрешать пропуск трафика к TCP-порту, который используется монитором производительности сети.
>
>

На серверах агента откройте окно PowerShell от имени администратора. Запустите загруженный ранее сценарий PowerShell [EnableRules](https://aka.ms/npmpowershellscript). Больше никакие параметры не нужны.

![PowerShell_Script](./media/how-to-npm/script.png)

## <a name="step-3-configure-network-security-group-rules"></a><a name="opennsg"></a>Шаг 3. Настройка правил группы безопасности сети

Для отслеживания серверов агента, находящихся в Azure, необходимо настроить правила группы безопасности сети (NSG), разрешающие использование TCP-трафика портом, используемым NPM для искусственных транзакций. Используемый порт по умолчанию — 8084. Это обеспечит связь между агентами мониторинга, установленными на виртуальной машине Azure и в локальной среде.

Дополнительные сведения о группах безопасности сети см. в статье [Создание групп безопасности сети с помощью портала Azure](../virtual-network/tutorial-filter-network-traffic.md).

>[!NOTE]
>Прежде чем переходить к этому шагу, убедитесь, что агенты установлены (как для локального сервера, так и для сервера Azure) и сценарий PowerShell запущен.
>

## <a name="step-4-discover-peering-connections"></a><a name="setupmonitor"></a>Шаг 4. Обнаружение пиринговых подключений

1. Перейдите на плитку обзор Монитор производительности сети, перейдя на страницу **все ресурсы** , а затем щелкните рабочую область алловлистед NPM.

   ![рабочая область npm](./media/how-to-npm/npm.png)
2. Щелкните плитку обзора **Монитор производительности сети**, чтобы открыть панель мониторинга. Она будет содержать страницу ExpressRoute, на которой будет указано состояние ExpressRoute "Не настроено". Щелкните **Настройка функций**, чтобы открыть страницу конфигурации монитора производительности сети.

   ![настройка функций](./media/how-to-npm/npm2.png)
3. На странице конфигурации перейдите на вкладку "Пиринги ExpressRoute", расположенную на панели слева. Далее нажмите на кнопку **Обнаружить**.

   ![обнаружение](./media/how-to-npm/13.png)
4. Когда процесс обнаружения будет завершен, вы увидите список, содержащий следующие элементы:
   * Все подключения пиринга Майкрософт в канале (каналах) ExpressRoute, связанные с этой подпиской.
   * Все частные пиринговые подключения, подключенные к виртуальным сетям и связанные с этой подпиской.
            
## <a name="step-5-configure-monitors"></a><a name="configmonitor"></a>Шаг 5. Настройка мониторов

В этом разделе вы настроите мониторы. Выполните действия для типа пиринга, который требуется отслеживать: **частный пиринг** или **пиринг Майкрософт**.

### <a name="private-peering"></a>Частный пиринг

После завершении процесса обнаружения частного пиринга вы увидите правила для уникальных параметров **Имя цепи** и **Имя виртуальной сети**. Изначально эти правила отключены.

![правила](./media/how-to-npm/14.png)

1. Установите флажок **Отслеживать этот пиринг**.
2. Установите флажок **Включить наблюдение за работоспособностью для этого пиринга**.
3. Выберите условия мониторинга. Для создания событий работоспособности можно задать пороговые значения. Каждый раз, когда значение условия превышает выбранное пороговое значение для выбранной пары сетей или подсетей, создается событие работоспособности.
4. На вкладке "Локальные агенты" нажмите на кнопку **Добавить агенты**, чтобы добавить локальные серверы, из которых планируется отслеживать частное пиринговое подключение. Убедитесь, что выбраны только агенты с возможностью подключения к конечной точке службы Microsoft, указанной в разделе на шаге 2. Локальные агенты должны иметь доступ к конечной точке через подключение ExpressRoute.
5. Сохраните параметры.
6. После включения правил и выбора значений и агентов мониторинга необходимо подождать около 30–60 минут до заполнения значений. В течение этого времени также станут доступны плитки **мониторинга ExpressRoute**.

### <a name="microsoft-peering"></a>Пиринг Майкрософт

Для установки пиринга Майкрософт нажмите на подключение пиринга Майкрософт, которое необходимо отслеживать, и настройте параметры.

1. Установите флажок **Отслеживать этот пиринг**. 
2. (Необязательно). Вы можете изменить целевую конечную точку службы Microsoft. По умолчанию NPM выбирает конечную точку службы Microsoft в качестве целевой. NPM отслеживает возможность подключения с локальных серверов к целевой конечной точке через ExpressRoute. 
    * Чтобы изменить целевую конечную точку, нажмите ссылку **(правка)** в разделе **Целевой объект:** и выберите другую целевую конечную точку службы Microsoft в списке URL-адресов.
      ![изменение целевого объекта](./media/how-to-npm/edit_target.png)<br>

    * Вы можете использовать настраиваемый URL-адрес или IP-адрес. Этот параметр особенно важен в случае использования пиринга Майкрософт для создания подключения к службам Azure PaaS, таким как службы хранилища Azure, базы данных SQL и веб-сайты с общедоступными IP-адресами. Для этого нажмите ссылку **(использовать настраиваемый URL-адрес или IP-адрес)** внизу списка URL-адресов, затем введите общедоступную конечную точку службы Azure PaaS, подключенную через пиринг Майкрософт ExpressRoute.
    ![настраиваемый URL-адрес](./media/how-to-npm/custom_url.png)<br>

    * Если вы используете эти необязательные параметры, убедитесь, что здесь выбрана только одна конечная точка службы Microsoft. Конечная точка должна быть подключена к ExpressRoute и доступна для локальных агентов.
3. Установите флажок **Включить наблюдение за работоспособностью для этого пиринга**.
4. Выберите условия мониторинга. Для создания событий работоспособности можно задать пороговые значения. Каждый раз, когда значение условия превышает выбранное пороговое значение для выбранной пары сетей или подсетей, создается событие работоспособности.
5. На вкладке "Локальные агенты" нажмите на кнопку **Добавить агенты**, чтобы добавить локальные серверы, из которых планируется отслеживать частное пиринговое подключение. Убедитесь, что выбраны только агенты с возможностью подключения к конечным точкам службы Microsoft, указанным в разделе "Шаг 2". Локальные агенты должны иметь доступ к конечной точке через подключение ExpressRoute.
6. Сохраните параметры.
7. После включения правил и выбора значений и агентов мониторинга необходимо подождать около 30–60 минут до заполнения значений. В течение этого времени также станут доступны плитки **мониторинга ExpressRoute**.

## <a name="step-6-view-monitoring-tiles"></a><a name="explore"></a>Шаг 6. Просмотр плиток мониторинга

Как только вы увидите плитки мониторинга, NPM начнет отслеживать каналы ExpressRoute и ресурсы подключения. Вы можете нажать на плитку пиринга Майкрософт, чтобы получить детальную информацию о работоспособности соединения пиринга Майкрософт.

![плитки мониторинга](./media/how-to-npm/15.png)

### <a name="network-performance-monitor-page"></a><a name="dashboard"></a>Страница решения "Монитор производительности сети"

Страница NPM содержит страницу для ExpressRoute, на которой отображаются общие данные по работоспособности каналов ExpressRoute и пирингов.

![На снимке экрана показана панель мониторинга с обзором работоспособности каналов ExpressRoute и пирингов.](./media/how-to-npm/dashboard.png)

### <a name="list-of-circuits"></a><a name="circuits"></a>Список каналов

Чтобы увидеть список всех отслеживаемых каналов ExpressRoute, нажмите плитку **Каналы ExpressRoute**. Вы можете выбрать канал и просмотреть его состояние работоспособности, диаграммы тенденций потери пакетов, данные об использовании пропускной способности и задержке. Диаграммы интерактивны. Вы можете выбрать настраиваемое временное окно для построения диаграмм. Вы можете перетащить указатель мыши по области диаграммы, чтобы увеличить масштаб и увидеть мелкие фрагменты данных.

![circuit_list](./media/how-to-npm/circuits.png)

#### <a name="trend-of-loss-latency-and-throughput"></a><a name="trend"></a>Тенденции потери, задержки и пропускной способности

Диаграммы потерь, задержки и пропускной способности интерактивны. С помощью мыши вы можете увеличить любой фрагмент этих диаграмм. Можно также просмотреть данные о пропускной способности, задержках и потерь для других интервалов, нажав кнопку **Дата и время**, расположенную под кнопкой действия в левом верхнем углу.

![тенденции](./media/how-to-npm/16.png)

### <a name="peerings-list"></a><a name="peerings"></a>Список пирингов

Чтобы увидеть список всех подключений к виртуальным сетям через частный пиринг, нажмите плитку **Частный пиринг** на панели мониторинга. Здесь вы можете выбрать подключение виртуальной сети и просмотреть его состояние работоспособности, диаграммы тенденций потери пакетов, данные об использовании пропускной способности и задержке.

![список каналов](./media/how-to-npm/peerings.png)

### <a name="nodes-view"></a><a name="nodes"></a>Представление "узлы"

Чтобы увидеть список всех ссылок между локальными узлами и виртуальными машинами Azure или конечными точками службы Microsoft для выбранных соединений пиринга ExpressRoute, нажмите **Просмотреть ссылки на узлы**. Вы можете просмотреть состояние работоспособности каждой ссылки, а также тенденцию потери и задержки, связанную с ней.

![просмотр узлов](./media/how-to-npm/nodes.png)

### <a name="circuit-topology"></a><a name="topology"></a>Топология канала

Чтобы просмотреть топологию канала, щелкните плитку **Топология**. Откроется представление топологии выбранного канала или пиринга. Схема топологии показывает задержку для каждого сегмента в сети. Каждый скачок третьего уровня представлен узлом на схеме. Чтобы увидеть дополнительные сведения о скачке, необходимо его щелкнуть.

Вы можете увеличить уровень видимости, чтобы включить локальные скачки. Для этого необходимо переместить ползунок ниже параметра **Фильтры**. Перемещая ползунок влево или вправо, вы соответственно увеличиваете или уменьшаете количество скачков на схеме топологии. Видна задержка для каждого сегмента, что позволяет быстро изолировать соответствующие сегменты.

![filters](./media/how-to-npm/topology.png)

#### <a name="detailed-topology-view-of-a-circuit"></a>Подробное представление топологии канала

В этом представлении отображаются подключения виртуальных сетей.
![подробная топология](./media/how-to-npm/17.png)