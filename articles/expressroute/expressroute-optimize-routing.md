---
title: 'Azure ExpressRoute: Оптимизация маршрутизации'
description: В этой статье приведены сведения о том, как оптимизировать маршрутизацию при наличии нескольких каналов ExpressRoute, с помощью которых устанавливается подключение между сетью Майкрософт и корпоративной сетью.
services: expressroute
author: duongau
ms.service: expressroute
ms.topic: how-to
ms.date: 07/11/2019
ms.author: duau
ms.openlocfilehash: f35f1d390762d3f83176d7b36db8959dc5ed0157
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "92204883"
---
# <a name="optimize-expressroute-routing"></a>Оптимизация маршрутизации ExpressRoute
При наличии нескольких каналов ExpressRoute к сети Майкрософт можно подключиться по нескольким маршрутам. Поэтому маршрутизация может быть неоптимальной, а это значит, что при передаче трафика из вашей сети в сеть Майкрософт и наоборот он будет проходить более длинный маршрут. А это, в свою очередь, может стать причиной возникновения длительной задержки, которая прямо влияет на производительность приложения и работу пользователей. В настоящей статье описана эта проблема и объясняется, как оптимизировать маршрутизацию с помощью стандартных технологий.

## <a name="path-selection-on-microsoft-and-public-peerings"></a>Выбор пути на узлах Майкрософт и общедоступных пиринга
Важно убедиться, что при использовании или общедоступного пиринга, который проходит трафик по нужному пути, если имеется одна или несколько каналов ExpressRoute, а также пути к Интернету через Интернет Exchange (IX) или поставщик услуг Интернета (ISP). BGP использует оптимальный алгоритм выбора пути на основе ряда факторов, включая самое длинное совпадение префиксов (LPM). Чтобы убедиться, что трафик, предназначенный для Azure через Microsoft или общедоступный пиринг, проходит по пути ExpressRoute, клиенты должны реализовать атрибут *Local предпочтения* , чтобы путь всегда был предпочтительнее в ExpressRoute. 

> [!NOTE]
> Локальным приоритетом по умолчанию обычно является 100. Более предпочтительно использовать более высокие локальные настройки. 
>
>

Рассмотрим следующий пример сценария:

![Схема, на которой показана проблема с подключением ExpressRoute 1 — Неоптимальная Маршрутизация от клиента к корпорации Майкрософт](./media/expressroute-optimize-routing/expressroute-localPreference.png)

В приведенном выше примере, чтобы предпочитать пути ExpressRoute, настройте локальную настройку следующим образом. 

**Cisco IOS — конфигурация XE с точки зрения R1:**

- R1 (config) #route-Map-Екср, разрешение 10
- R1 (конфигурация-Route-Map) #set локальное предпочтение 150

- R1 (config) #router BGP 345
- R1 (config-router) #neighbor 1.1.1.2 с удаленным доступом как 12076
- R1 (config-router) #neighbor 1.1.1.2 активировать
- R1 (config-router) #neighbor 1.1.1.2 маршрутов — Map-Екср в

**Конфигурация жунос с точки зрения R1:**

- user@R1# Set протоколы BGP группа ибгп тип Internal
- user@R1# Set Protocols BGP Group ибгп Local-предпочтения 150



## <a name="suboptimal-routing-from-customer-to-microsoft"></a>Неоптимальная маршрутизация от клиента к Майкрософт
Рассмотрим проблему маршрутизации более детально на следующем примере. Предположим, что есть два офиса, расположенных в США: один — в Лос-Анджелесе, а другой — в Нью-Йорке. Эти офисы подключены к глобальной сети (WAN): либо к вашей собственной магистральной, либо к предоставленной поставщиком услуг VPN на базе IP-сети. У вас есть два канала ExpressRoute: один — в западной части США, а другой — в восточной. Они также подключены к глобальной сети. Очевидно, что подключение к сети Майкрософт можно установить по двум каналам. А теперь представьте, что и в западной, и в восточной части США расположены службы Azure (например, службы приложений Azure). Вы хотите подключить пользователей в Лос-Анджелесе к региону "Западная часть США", а пользователей в Нью-Йорке — к региону "Восточная часть США", так как администратор служб сообщил, что пользователи офисов используют ближайший регион Azure для оптимальной работы. К сожалению, этот вариант оптимален только для пользователей восточного, но не западного побережья. Причина заключается в следующем. Для каждого канала ExpressRoute объявляются префиксы: 23.100.0.0/16 — для канала в регионе "Восточная часть США" и 13.100.0.0/16 — для канала в регионе "Западная часть США" Azure. Не зная, какой префикс относится к тому или иному региону, вы не сможете должным образом управлять маршрутизацией. Глобальная сеть может распознать префиксы в качестве относящихся ближе к региону "Восточная часть США", чем к "Западная часть США" и направить трафик пользователей обоих офисов по каналу ExpressRoute в восточной части США. В результате пользователи в Лос-Анджелесе будут недовольны качеством передачи данных.

![Проблема маршрутизации ExpressRoute 1. Неоптимальная маршрутизация от клиента к Майкрософт](./media/expressroute-optimize-routing/expressroute-case1-problem.png)

### <a name="solution-use-bgp-communities"></a>Решение. Использование сообщества BGP
Чтобы оптимизировать маршрутизацию для обоих офисов, необходимо определить, какой префикс относится к региону Azure "Западная часть США", а какой — к региону "Восточная часть США". Эти сведения кодируются с использованием [значений сообществ BGP](expressroute-routing.md). Каждому региону Azure назначаются уникальные значения сообществ BGP, например 12076:51004 — восточной части США и 12076:51006 — западной. Теперь, определив префикс для каждого региона Azure, можно настроить канал ExpressRoute, который необходимо использовать. Так как для обмена сведениями маршрутизации используется протокол BGP, маршрутизацией можно управлять, используя значения локального предпочтения BGP. В нашем примере для префикса 13.100.0.0/16 западной части США можно установить более высокое значение локального предпочтения, чем для префикса восточной части США, и точно так же можно установить более высокое значение локального предпочтения для префикса 23.100.0.0/16 восточной части США по сравнению с префиксом западной. Эта конфигурация гарантирует, что когда доступно два маршрута к сети Майкрософт, для подключения к региону Azure "Западная часть США" пользователи в Лос-Анджелесе будут использовать канал ExpressRoute в западной части США, и аналогично для подключения к региону "Восточная часть США" пользователи в Нью-Йорке будут использовать канал ExpressRoute в восточной части США. Это обеспечивает оптимальную маршрутизацию на обоих сторонах. 

![Решение проблемы маршрутизации ExpressRoute 1. Использование сообщества BGP](./media/expressroute-optimize-routing/expressroute-case1-solution.png)

> [!NOTE]
> Локальное предпочтение также можно назначить для маршрутизации от клиента к виртуальной сети Azure. Мы не устанавливаем значение сообщества BGP для префиксов, объявленных в Azure для вашей сети. Тем не менее, так как известно, какое развертывание виртуальной сети ближе к каждому офису, можно настроить маршрутизаторы таким образом, чтобы они предпочитали один канал ExpressRoute другому.
>
>

## <a name="suboptimal-routing-from-microsoft-to-customer"></a>Неоптимальная маршрутизация от Майкрософт к клиенту
Рассмотрим еще один пример, когда подключения из сети Майкрософт проходят более длинный маршрут для подключения к вашей сети. В этом случае используются Exchange Online и локальные серверы Exchange в [гибридной среде](/exchange/exchange-hybrid). Офисы подключены к глобальной сети. Для подключения к сети Майкрософт через каналы ExpressRoute объявлены префиксы локальных серверов обоих офисов. При переносе почтовых ящиков Exchange Online будет инициировать подключения к локальным серверам. К сожалению, подключение к офису в Лос-Анджелесе перенаправляется на канал ExpressRoute в восточной части США, а затем весь трафик передается через весь континент обратно на западное побережье. В этом случае причина та же, что и в первом примере. Без соответствующих настроек сеть Майкрософт не распознает, какой префикс относится к восточной части США, а какой — к западной. Возможно, что подключение к офису в Лос-Анджелесе будет установлено по неправильному каналу.

![Проблема маршрутизации ExpressRoute 2. Неоптимальная маршрутизация от Майкрософт к клиенту](./media/expressroute-optimize-routing/expressroute-case2-problem.png)

### <a name="solution-use-as-path-prepending"></a>Решение. Использование атрибута AS PATH
Эту проблему можно решить двумя способами. Первый способ — это просто объявить локальный префикс канала в западной части США для офиса в Лос-Анджелесе (177.2.0.0/31) и в восточной части США для офиса в Нью-Йорке (177.2.0.2/31). В результате для подключения сети Майкрософт к каждому из офисов будет использоваться только один маршрут. Это позволяет избежать возможной неоднозначности и оптимизировать маршрутизацию. В этом случае следует обдумать стратегию отработки отказа. Если путь к сети Майкрософт через канал ExpressRoute по каким-либо причинам недоступен, необходимо убедиться, что Exchange Online может по-прежнему подключиться к вашим локальным серверам. 

Второе решение — вам также необходимо объявить префикс для обоих каналов ExpressRoute и, кроме того, предоставить сведения о том, какой префикс используется для каждого офиса. Так как Майкрософт поддерживает использование атрибута AS Path BGP, с его помощью можно управлять маршрутизацией. В этом примере можно удлинить атрибут AS PATH для 172.2.0.0/31 в восточной части США, чтобы для передачи трафика, предназначенного для этого префикса, использовался канал ExpressRoute в западной части США (сеть Майкрософт будет определять маршрут к этому префиксу как более короткий в западной части.) Точно так же можно удлинить атрибут AS PATH для 172.2.0.2/31 в западной части США, чтобы использовать канал ExpressRoute в восточной части США. Это позволит оптимизировать маршрутизацию для обоих офисов. Если один из каналов ExpressRoute недоступен, подключение Exchange Online к вашей сети будет установлено через другой канал ExpressRoute и вашу глобальную сеть. 

> [!IMPORTANT]
> Мы удаляем частные числа в качестве пути для префиксов, полученных на пиринг Майкрософт, когда пиринг использует частный номер AS. Необходимо иметь одноранговую связь с общедоступным именем и добавить общедоступные номера в качестве пути, чтобы повлиять на маршрутизацию для пиринга Майкрософт.
> 
> 

![Решение проблемы маршрутизации ExpressRoute 2. Использование атрибута AS PATH](./media/expressroute-optimize-routing/expressroute-case2-solution.png)

> [!NOTE]
> Хотя представленные здесь примеры предназначены для пиринга Майкрософт и общедоступного пиринга, их можно использовать и для частного пиринга. Кроме того, атрибут AS PATH можно использовать в отдельном канале ExpressRoute. Он влияет на выбор основного и дополнительного путей.
> 
> 

## <a name="suboptimal-routing-between-virtual-networks"></a>Неоптимальная маршрутизация виртуальных сетей
С помощью ExpressRoute вы можете обеспечить обмен данными между виртуальными сетями, связав их с каналом ExpressRoute. Если связать их с несколькими каналами ExpressRoute, это может вызвать неоптимальную маршрутизацию между виртуальными сетями. Рассмотрим пример. У вас есть два канала ExpressRoute: один — в западной части США, а другой — в восточной. В каждом регионе имеется две виртуальные сети. Веб-серверы развернуты в одной виртуальной сети, а серверы приложений — в другой. Чтобы обеспечить избыточность, вы связываете две виртуальные сети в каждом регионе с локальным каналом ExpressRoute и удаленным каналом ExpressRoute. Как показано ниже, между виртуальными сетями существует по два пути. Виртуальным сетям неизвестно, какой канал ExpressRoute является локальным, а какой удаленным. Так как для балансировки нагрузки трафика между сетями используется технология маршрутизации Equal-Cost-Multi-Path (ECMP), некоторые потоки трафика проходят более длинный маршрут и перенаправляются на удаленный канал ExpressRoute.

![Проблема маршрутизации ExpressRoute 3. Неоптимальная маршрутизация виртуальных сетей](./media/expressroute-optimize-routing/expressroute-case3-problem.png)

### <a name="solution-assign-a-high-weight-to-local-connection"></a>Решение. Назначение высокого веса для локального подключения
Решение простое. Зная, где расположены виртуальные сети и каналы, вы можете определить, какой путь подходит для каждой виртуальной сети. В нашем примере для локального подключения нужно назначить более высокий вес, чем для удаленного (пример конфигурации см. [здесь](expressroute-howto-linkvnet-arm.md#modify-a-virtual-network-connection)). Когда виртуальная сеть получит префикс другой виртуальной сети из нескольких подключений, то для отправки трафика к префиксу будет использоваться подключение с более высоким весом.

![Решение проблемы маршрутизации ExpressRoute 3. Назначение высокого веса для локального подключения](./media/expressroute-optimize-routing/expressroute-case3-solution.png)

> [!NOTE]
> При использовании нескольких каналов ExpressRoute также можно управлять маршрутизацией от виртуальной сети к локальной. Вместо того чтобы использовать атрибут AS PATHS, описанный во втором сценарии, в этом случае необходимо назначить вес подключения. При выборе способа отправки трафика для каждого префикса сначала просматривается вес подключения, а потом длина AS Path.
>
>