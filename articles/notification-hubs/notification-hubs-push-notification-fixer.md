---
title: Диагностика удаленных уведомлений в центрах уведомлений Azure
description: Узнайте, как определить распространенные проблемы с пропущенными уведомлениями в Центрах уведомлений Azure.
services: notification-hubs
documentationcenter: Mobile
author: sethmanheim
manager: femila
editor: jwargo
ms.assetid: b5c89a2a-63b8-46d2-bbed-924f5a4cce61
ms.service: notification-hubs
ms.workload: mobile
ms.tgt_pltfrm: NA
ms.devlang: multiple
ms.topic: article
ms.date: 02/25/2020
ms.author: sethm
ms.reviewer: jowargo
ms.lastreviewed: 04/04/2019
ms.custom: devx-track-csharp
ms.openlocfilehash: 787cf922fcee0ee613fc0874a490830da9adf38a
ms.sourcegitcommit: 6386854467e74d0745c281cc53621af3bb201920
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/08/2021
ms.locfileid: "102455031"
---
# <a name="diagnose-dropped-notifications-in-azure-notification-hubs"></a>Диагностика удаленных уведомлений в центрах уведомлений Azure

Распространенный вопрос о центрах уведомлений Azure — устранение неполадок, когда уведомления из приложения не отображаются на клиентских устройствах. Клиенты хотят понять, где и почему уведомления были удалены, а также как устранить проблему. В этой статье мы рассмотрим, почему уведомления удаляются и не доходят до устройств. В нем также объясняется, как определить основную причину.

Для начала очень важно понять, как Центры уведомлений отправляют уведомления на устройство.

![Архитектура Центров уведомлений][0]

В типичном потоке отправки уведомлений сообщение отправляется из *серверной части приложения* в Центры уведомлений. Центры уведомлений обрабатывают все регистрации. Он учитывает настроенные теги и выражения тегов для определения целевых объектов. Целевые объекты — это регистрации, которые должны получить push-уведомление. Эти регистрации могут охватывать любую из поддерживаемых платформ: Android, Baidu (устройства Android в Китае), пожарная ОС (Amazon) iOS, Windows и Windows Phone.

Определив цели, Центры уведомлений отправляют сообщения в *службу push-уведомлений* для платформы устройства. Примеры включают службу push-уведомлений Apple (APNs) для iOS и macOS, а также Firebase Cloud Messaging (FCM) для устройств Android. Центры уведомлений отправляют сообщения, разделенные по нескольким пакетам регистраций. Он выполняет проверку подлинности с помощью соответствующей службы push-уведомлений на основе учетных данных, установленных в портал Azure, в разделе **Настройка центра уведомлений**. Затем служба push-уведомлений пересылает уведомления на соответствующие *клиентские устройства*.

Последняя часть доставки уведомлений — это между службой push-уведомлений платформы и устройством. Доставка уведомлений может завершиться сбоем на любом из четырех этапов процесса push-уведомления (клиент, серверная часть приложения, центры уведомлений и Служба push-уведомлений платформы). Дополнительные сведения об архитектуре Центров уведомлений см. в [этой статье].

Ошибка доставки уведомлений может возникнуть на этапе первоначального тестирования или промежуточного этапа. что может указывать на проблему конфигурации. Если в рабочей среде происходит сбой доставки уведомлений, некоторые или все уведомления могут быть удалены. В этом случае указывается более подробное рассмотрение проблемы с шаблоном приложения или обмена сообщениями.

В следующем разделе рассматриваются сценарии, в которых уведомления могут быть удалены, от общего к редким.

## <a name="notification-hubs-misconfiguration"></a>Неправильная настройка Центров уведомлений

Чтобы отправлять уведомления в соответствующую службу push-уведомлений, центры уведомлений должны пройти проверку подлинности в контексте вашего приложения. Необходимо создать учетную запись разработчика с помощью службы уведомлений целевой платформы (Microsoft, Apple, Google и т. д.). Затем необходимо зарегистрировать приложение в операционной системе, где вы получаете маркер или ключ, используемые для работы с целевым PNS.

Учетные данные платформы необходимо добавить на портал Azure. Если ни одно из уведомлений не достигло устройства, сначала необходимо убедиться в том, что в концентраторах уведомлений настроены правильные учетные данные. Учетные данные должны соответствовать приложению, созданному в учетной записи разработчика для конкретной платформы.

Пошаговые инструкции для выполнения этого процесса см. в статье [Начало работы с Центрами уведомлений для приложений универсальной платформы Windows].

Ниже приведены некоторые распространенные сценарии неправильной настройки, которые следует проверить.

### <a name="notification-hub-name-location"></a>Расположение имени центра уведомлений

Убедитесь, что имя Центра уведомлений (без опечаток) одинаковое во всех следующих расположениях:

* Где выполняется регистрация из клиента
* Куда отправляются уведомления из серверной части
* Где вы настроили учетные данные службы push-уведомлений

Убедитесь, что в клиенте и серверной части приложения используются правильные строки конфигурации подписанного URL. Как правило, необходимо использовать **DefaultListenSharedAccessSignature** на клиенте и **DefaultFullSharedAccessSignature** в серверной части приложения. Это предоставляет разрешения на отправку уведомлений в концентраторы уведомлений.

### <a name="apn-configuration"></a>Конфигурация точки доступа

Необходимо поддерживать два разных концентратора: один для рабочей среды, а другой — для тестирования. Сертификат, используемый в изолированной среде, необходимо передать в отдельный центр, отличный от сертификата или концентратора, который будет использоваться в производстве. Не отправляйте разные типы сертификатов в один и тот же центр. Это приведет к сбоям уведомления.

Если вы случайно отправите разные типы сертификатов в один и тот же центр, следует удалить концентратор и начать с нового концентратора. Если по какой-либо причине невозможно удалить центр, необходимо по крайней мере удалить все существующие регистрации из концентратора.

### <a name="fcm-configuration"></a>Конфигурация FCM

1. Убедитесь, что *ключ сервера* , полученный от Firebase, совпадает с ключом сервера, зарегистрированным в портал Azure.

   ![Ключ сервера Firebase][3]

2. Убедитесь, что на клиенте настроен **идентификатор проекта**. Значение для **идентификатора проекта** можно получить на панели мониторинга Firebase.

   ![Идентификатор проекта Firebase][1]

## <a name="application-issues"></a>Проблемы с приложением

### <a name="tags-and-tag-expressions"></a>Теги и выражения тегов

Если вы используете теги или выражения тегов для сегментирования аудитории, возможно, при отправке уведомления целевой объект не будет найден. Эта ошибка основана на указанных тегах или выражениях тегов в вызове Send.

Проверьте регистрацию, чтобы убедиться, что теги совпадают при отправке уведомления. Затем проверьте уведомление уведомления только от клиентов, имеющих эти регистрации.

Например, предположим, что все регистрации в концентраторах уведомлений используют тег «политики». Если отправить уведомление с тегом "Спорт", уведомление не будет отправлено на устройство. В сложном случае могут использоваться выражения тегов, в которых вы зарегистрировались с помощью тега A *или* тега b, но вы предназначаете "тег a && тег b". В разделе Советы по самостоятельной диагностике далее в этой статье показано, как просматривать регистрации и их Теги.

### <a name="template-issues"></a>Проблемы с шаблонами

Если используются шаблоны, убедитесь, что вы следуете рекомендациям, приведенным в статье [Шаблоны].

### <a name="invalid-registrations"></a>Недопустимые регистрации

Если центр уведомлений настроен правильно и теги или выражения тегов были использованы правильно, будут найдены допустимые целевые объекты. которым необходимо отправить уведомления. Затем Центры уведомлений параллельно запускают несколько пакетов обработки. Каждый пакет отправляет сообщения набору регистраций.

> [!NOTE]
> Так как центры уведомлений параллельно обрабатывают пакеты, порядок доставки уведомлений не гарантируется.

Концентраторы уведомлений оптимизированы для модели доставки сообщений "не чаще всего один раз". Мы пытаемся выполнить дедупликацию так, чтобы уведомления доставлялись на устройство по одному разу. Регистрации проверяются, чтобы убедиться, что перед отправкой в службу push-уведомлений было отправлено только одно сообщение для каждого идентификатора устройства.

Каждый пакет отправляется в службу push-уведомлений, которая, в свою очередь, принимает и проверяет регистрации. В ходе этого процесса Служба push-уведомлений может обнаружить ошибку с одной или несколькими регистрациями в пакете. Затем служба push-уведомлений возвращает ошибку в центр уведомлений, и процесс останавливается. Служба push-уведомлений полностью удаляет такой пакет. Это особенно справедливо для APNs, в котором используется протокол TCP-потока.

В этом случае сбойная регистрация удаляется из базы данных. Затем мы повторяем попытку доставки уведомлений для остальных устройств в этом пакете.

Чтобы получить дополнительные сведения об ошибке неудачной попытки доставки для регистрации, можно использовать API-интерфейсы для интерфейсов RESTFUL для передачи сообщений [уведомлений](/rest/api/notificationhubs/get-notification-message-telemetry) и [PNS Отзывы](/previous-versions/azure/reference/mt705560(v=azure.100)). Пример кода приведен в [репозитории примеров для отправки с помощью REST](https://github.com/Azure/azure-notificationhubs-dotnet/tree/master/Samples/SendRestExample/).

## <a name="push-notification-service-issues"></a>Проблемы службы push-уведомлений

После того как служба push-уведомлений получит уведомление, она доставляет уведомление на устройство. На этом этапе центры уведомлений не контролируют доставку уведомлений на устройство.

Так как службы Notification Services являются надежными, уведомления обычно достигают устройства через несколько секунд. Если служба push-уведомлений регулируется регулированием, концентраторы уведомлений применяют стратегию экспоненциального отката. Если служба push-уведомлений остается недоступной в течение 30 минут, существует политика, позволяющая истечь и окончательно удалить сообщения.

Если служба push-уведомлений пытается доставить уведомление, но устройство находится в автономном режиме, уведомление сохраняется службой push-уведомлений. Он хранится в течение ограниченного периода времени. Уведомление доставляется на устройство, когда оно становится доступным.

Каждое приложение хранит только одно Последнее уведомление. При отправке нескольких уведомлений, когда устройство находится в автономном режиме, каждое новое уведомление приводит к отмене последнего. Хранение только нового уведомления называется *объединением* в APNs и *свертыванием* в FCM. (FCM использует ключ свертывания.) Когда устройство остается в автономном режиме в течение длительного времени, уведомления, сохраненные для устройства, отбрасываются. Дополнительные сведения см. в разделе Общие сведения о [APNs] и [сообщения FCM].

С помощью концентраторов уведомлений можно передать ключ объединения через заголовок HTTP, используя универсальный API SendNotification. Например, для пакета SDK для .NET можете использовать `SendNotificationAsync`. API SendNotification также принимает заголовки HTTP, которые передаются как есть в соответствующую службу push-уведомлений.

## <a name="self-diagnosis-tips"></a>Советы по самостоятельной диагностике

Ниже приведены пути для диагностики основной причины отброшенных уведомлений в центрах уведомлений.

### <a name="verify-credentials"></a>Проверка учетных данных

#### <a name="push-notification-service-developer-portal"></a>Портал разработчика службы push-уведомлений

Проверьте учетные данные на соответствующем портале разработчика службы push-уведомлений (APNs, FCM, служба уведомлений Windows и т. д.). Дополнительные сведения см. [в статье учебник. Отправка уведомлений в универсальная платформа Windows приложения с помощью центров уведомлений Azure](./notification-hubs-windows-store-dotnet-get-started-wns-push-notification.md).

#### <a name="azure-portal"></a>Портал Azure

Чтобы проверить и сопоставить учетные данные с данными, полученными на портале разработчика службы push-уведомлений, перейдите на вкладку **политики доступа** в портал Azure.

![Вкладка "Политики доступа" на портале Azure][4]

### <a name="verify-registrations"></a>Проверка регистраций

#### <a name="visual-studio"></a>Visual Studio

В Visual Studio можно подключиться к Azure с помощью обозреватель сервера для просмотра нескольких служб Azure, включая концентраторы уведомлений, и управления ими. Этот ярлык в первую очередь полезен для среды разработки и тестирования.

![Обозреватель серверов в Visual Studio.][9]

![Обозреватель серверов](media/notification-hubs-push-notification-fixer/vsserverexplorer2.png)

Вы можете просматривать все регистрации в центре и управлять ими. Регистрация может быть отнесена к категории по платформе, встроенной регистрации или шаблону, тегу, идентификатору службы push-уведомлений, ИДЕНТИФИКАТОРу регистрации и дате окончания срока действия. На этой странице можно также изменить регистрацию. Это особенно полезно для редактирования тегов.

Щелкните правой кнопкой мыши Центр уведомлений в **Обозреватель сервера** и выберите пункт **Диагностика**. 

![Обозреватель сервера Visual Studio: меню "Диагностика"](./media/notification-hubs-push-notification-fixer/diagnose-menu.png)

Вы увидите следующую страницу:

![Visual Studio: страница "Диагностика"](./media/notification-hubs-push-notification-fixer/diagnose-page.png)

Перейдите на страницу **регистрации устройств** .

![Visual Studio: регистрация устройств](./media/notification-hubs-push-notification-fixer/VSRegistrations.png)

Вы можете использовать страницу **Тестовая Отправка** для отправки тестового сообщения уведомления:

![Visual Studio: Тестовая Отправка](./media/notification-hubs-push-notification-fixer/test-send-vs.png)

> [!NOTE]
> Используйте Visual Studio для изменения регистраций только во время разработки или тестирования, а также с ограниченным количеством регистраций. Если вам необходимо выполнить многофункциональное изменение регистраций, рассмотрите возможность использования функций регистрации экспорта и импорта, описанных в статье [как выполнять операции экспорта и изменения регистраций](/previous-versions/azure/azure-services/dn790624(v=azure.100)).

#### <a name="service-bus-explorer"></a>Service Bus Explorer

Многие клиенты используют [Обозреватель служебной шины](https://github.com/paolosalvatori/ServiceBusExplorer) для просмотра концентраторов уведомлений и управления ими. который представляет собой проект с открытым кодом. 

### <a name="verify-message-notifications"></a>Проверка уведомлений о сообщениях

#### <a name="azure-portal"></a>Портал Azure

Чтобы отправить тестовые уведомления клиентам, не запуская серверную часть службы, в разделе **Поддержка и устранение неполадок** выберите **Тестовая отправка**.

![Функциональные возможности тестовой отправки в Azure][7]

#### <a name="visual-studio"></a>Visual Studio

Тестовые уведомления также можно отправлять с помощью Visual Studio.

![Функциональные возможности тестовой отправки в Visual Studio][10]

Дополнительные сведения об использовании Центров уведомлений с помощью обозревателя серверов в Visual Studio см. в следующих статьях:

* [Просмотр регистраций устройств для концентраторов уведомлений](/previous-versions/windows/apps/dn792122(v=win.10))
* [Подробный обзор релиз-кандидата Visual Studio 2013 с обновлением 2 и пакета Azure SDK 2.3]
* [Объявление о выпуске Visual Studio 2013 с обновлением 3 и пакета Azure SDK 2.4]

### <a name="debug-failed-notifications-and-review-notification-outcome"></a>Уведомления о сбоях отладки и просмотр результатов уведомлений

#### <a name="enabletestsend-property"></a>Свойство EnableTestSend

При отправке уведомления через центры уведомлений изначально уведомление помещается в очередь. Центры уведомлений определяют правильные цели, а затем отправляют уведомление в службу push-уведомлений. Если вы используете REST API или любое из клиентских пакетов SDK, возврат вызова Send означает только то, что сообщение помещается в очередь концентраторов уведомлений. Он не позволяет понять, что произошло, когда концентраторы уведомлений в конечном итоге отправили уведомление в службу push-уведомлений.

Если уведомление не поступает на клиентское устройство, то, возможно, произошла ошибка при попытке концентраторов уведомлений доставить службу push-уведомлений. Например, размер полезных данных может превышать максимально допустимый размер таких данных в службе push-уведомлений или настроенные в Центрах уведомлений учетные данные могут быть недоступными.

Информацию об ошибках службы push-уведомлений можно получить с помощью свойства [EnableTestSend]. Оно автоматически включается при отправке тестового сообщения с портала или клиентского приложения Visual Studio Это свойство можно использовать для просмотра подробных сведений об отладке, а также через API. Сейчас его можно использовать в пакете SDK для .NET. В конечном итоге он будет добавлен во все клиентские пакеты SDK.

Чтобы использовать свойство `EnableTestSend` с вызовом REST, добавьте параметр строки запроса с именем *test* в конце вызова отправки. Пример:

```text
https://mynamespace.servicebus.windows.net/mynotificationhub/messages?api-version=2013-10&test
```

#### <a name="net-sdk-example"></a>Пример пакета SDK для .NET

Ниже приведен пример отправки собственного всплывающего уведомления при использовании пакета SDK для .NET:

```csharp
NotificationHubClient hub = NotificationHubClient.CreateClientFromConnectionString(connString, hubName);
var result = await hub.SendWindowsNativeNotificationAsync(toast);
Console.WriteLine(result.State);
```

В конце выполнения `result.State` просто заявляет `Enqueued`. Результаты не позволяют понять, что произошло с push-уведомлением.

Далее вы можете использовать логическое свойство `EnableTestSend`. С помощью свойства `EnableTestSend` во время инициализации `NotificationHubClient` можно получить подробные сведения об ошибках службы push-уведомлений, произошедших при отправке уведомления. Для возврата вызова Send требуется дополнительное время, так как сначала требуется концентраторы уведомлений для доставки уведомлений в службу push-уведомлений.

```csharp
    bool enableTestSend = true;
    NotificationHubClient hub = NotificationHubClient.CreateClientFromConnectionString(connString, hubName, enableTestSend);

    var outcome = await hub.SendWindowsNativeNotificationAsync(toast);
    Console.WriteLine(outcome.State);

    foreach (RegistrationResult result in outcome.Results)
    {
        Console.WriteLine(result.ApplicationPlatform + "\n" + result.RegistrationId + "\n" + result.Outcome);
    }
```

#### <a name="sample-output"></a>Пример выходных данных

```text
DetailedStateAvailable
windows
7619785862101227384-7840974832647865618-3
The Token obtained from the Token Provider is wrong
```

Это сообщение указывает либо на то, что учетные данные, настроенные в центрах уведомлений, недействительны, либо возникла проблема с регистрацией в концентраторе. Удалите эту регистрацию и позвольте клиенту повторно создать регистрацию перед отправкой сообщения.

> [!NOTE]
> Использование свойства `EnableTestSend` строго регулируется. Используйте этот параметр только в среде разработки и тестирования и с ограниченным набором регистраций. Отладочные уведомления отправляются только на 10 устройств. Также существует ограничение на обработку отправок при отладке, 10 в минуту.

### <a name="review-telemetry"></a>Просмотр телеметрии

#### <a name="azure-portal"></a>Портал Azure

На портале вы можете получить краткий обзор всех операций, выполняемых в Центре уведомлений.

1. На вкладке **Обзор** можно просмотреть объединенное представление регистраций, уведомлений и ошибок каждой платформы.

   ![Панель мониторинга "Обзор" в Центре уведомлений][5]

2. На вкладке **Монитор** можно добавить дополнительные метрики для конкретной платформы, чтобы получить подробные сведения о состоянии. Вы можете просмотреть сообщения об ошибках, возвращаемых, когда концентраторы уведомлений попытаются отправить уведомление в службу push-уведомлений.

   ![Журнал действий на портале Azure][6]

3. Сначала просмотрите **входящие сообщения**, **операции регистрации** и **доставленные уведомления**. Затем перейдите на вкладку каждой платформы, чтобы просмотреть ошибки, связанные со службой push-уведомлений.

4. Если параметры проверки подлинности для Центра уведомлений неверные, будет получена ошибка **выполнения проверки подлинности PNS**. Это хороший показатель для проверки учетных данных службы push-уведомлений.

#### <a name="programmatic-access"></a>Программный доступ

Дополнительные сведения об программном доступе см. в разделе [программный доступ](/previous-versions/azure/azure-services/dn458823(v=azure.100)).

> [!NOTE]
> Некоторые функции, связанные с телеметрией, например экспорт и импорт данных регистраций и доступ к телеметрии с помощью API, доступны только на уровне служб "Стандартный". Если вы попытаетесь использовать эти функции на уровне службы Free или Basic, при использовании пакета SDK вы получите сообщение об исключении. Вы получите ошибку HTTP 403 (запрещено), если вы используете функции непосредственно из API-интерфейсов других компонентов.
>
> Чтобы использовать функции, связанные с телеметрии, сначала убедитесь, что в портал Azure используется уровень служб "Стандартный".  

<!-- IMAGES -->
[0]: ./media/notification-hubs-push-notification-fixer/Architecture.png
[1]: ./media/notification-hubs-push-notification-fixer/FCMConfigure.png
[3]: ./media/notification-hubs-push-notification-fixer/FCMServerKey.png
[4]: ../../includes/media/notification-hubs-portal-create-new-hub/notification-hubs-connection-strings-portal.png
[5]: ./media/notification-hubs-push-notification-fixer/PortalDashboard.png
[6]: ./media/notification-hubs-push-notification-fixer/PortalAnalytics.png
[7]: ./media/notification-hubs-ios-get-started/notification-hubs-test-send.png
[8]: ./media/notification-hubs-push-notification-fixer/VSRegistrations.png
[9]: ./media/notification-hubs-push-notification-fixer/vsserverexplorer.png
[10]: ./media/notification-hubs-push-notification-fixer/VSTestNotification.png

<!-- LINKS -->
[Общие сведения о концентраторах уведомлений]: notification-hubs-push-notification-overview.md
[Начало работы с Центрами уведомлений для приложений универсальной платформы Windows]: notification-hubs-windows-store-dotnet-get-started-wns-push-notification.md
[Шаблоны]: /previous-versions/azure/azure-services/dn530748(v=azure.100)
[Обзор APNs]: https://developer.apple.com/library/content/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/APNSOverview.html
[Сведения о сообщениях FCM]: https://firebase.google.com/docs/cloud-messaging/concept-options
[Export and modify registrations in bulk]: /previous-versions/azure/azure-services/dn790624(v=azure.100)
[Service Bus Explorer code]: https://code.msdn.microsoft.com/windowsazure/Service-Bus-Explorer-f2abca5a
[View device registrations for notification hubs]: /previous-versions/windows/apps/dn792122(v=win.10)
[Подробный обзор релиз-кандидата Visual Studio 2013 с обновлением 2 и пакета Azure SDK 2.3]: https://azure.microsoft.com/blog/2014/04/09/deep-dive-visual-studio-2013-update-2-rc-and-azure-sdk-2-3/#NotificationHubs
[Объявление о выпуске Visual Studio 2013 с обновлением 3 и пакета Azure SDK 2.4]: https://azure.microsoft.com/blog/2014/08/04/announcing-release-of-visual-studio-2013-update-3-and-azure-sdk-2-4/
[Сведения о свойстве EnableTestSend]: /dotnet/api/microsoft.azure.notificationhubs.notificationhubclient.enabletestsend
[Programmatic telemetry access]: /previous-versions/azure/azure-services/dn458823(v=azure.100)
