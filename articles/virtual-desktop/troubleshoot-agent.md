---
title: Устранение проблем с агентом виртуальных рабочих столов Windows — Azure
description: Устранение распространенных проблем с подключением к агенту и подключениям.
author: Sefriend
ms.topic: troubleshooting
ms.date: 12/16/2020
ms.author: sefriend
manager: clarkn
ms.openlocfilehash: 1500a635d5177ed8899cdc3f1364e57a8525892c
ms.sourcegitcommit: 24f30b1e8bb797e1609b1c8300871d2391a59ac2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/10/2021
ms.locfileid: "100099954"
---
# <a name="troubleshoot-common-windows-virtual-desktop-agent-issues"></a>Устранение распространенных проблем с агентом виртуальных рабочих столов Windows

Агент виртуальных рабочих столов Windows может вызвать проблемы с подключением из-за нескольких факторов.
   - Ошибка в брокере, который делает агент остановкой службы.
   - Проблемы с обновлениями.
   - Проблемы при установке во время установки агента, которые нарушают подключение к узлу сеансов.

В этой статье описаны решения для этих распространенных сценариев и способы устранения проблем с подключением.

## <a name="error-the-rdagentbootloader-andor-remote-desktop-agent-loader-has-stopped-running"></a>Ошибка: загрузчик агента Рдажентбутлоадер или удаленный рабочий стол прекратил работу

Если вы видите одну из следующих проблем, это означает, что загрузчик, загружающий агент, не смог правильно установить агент, а служба агента не запущена:
- **Рдажентбутлоадер** остановлен или не работает.
- Отсутствует состояние **загрузчика агента удаленный рабочий стол**.

Чтобы устранить эту проблему, запустите загрузчик Рдажент boot:

1. В окне службы щелкните правой кнопкой мыши **Удаленный рабочий стол загрузчик агента**.
2. Щелкните **Запуск**. Если этот параметр неактивен для вас, у вас нет разрешений администратора, и он потребуется для запуска службы.
3. Подождите 10 секунд, щелкните правой кнопкой мыши **Удаленный рабочий стол загрузчик агента**.
4. Выберите **Обновить**.
5. Если служба останавливается после запуска и обновления, возможно, произошла ошибка регистрации. Дополнительные сведения см. в разделе [INVALID_REGISTRATION_TOKEN](#error-invalid_registration_token).

## <a name="error-invalid_registration_token"></a>Ошибка: INVALID_REGISTRATION_TOKEN

Перейдите в **Просмотр событий**  >  **приложение журналов Windows**  >  . Если вы видите событие с ИДЕНТИФИКАТОРом 3277, которое говорит **INVALID_REGISTRATION_TOKEN** в описании, маркер регистрации, который не распознан как допустимый.

Чтобы устранить эту проблему, Создайте допустимый маркер регистрации:

1. Чтобы создать новый маркер регистрации, выполните действия, описанные в разделе [Создание нового ключа регистрации для виртуальной машины](#step-3-generate-a-new-registration-key-for-the-vm) .
2. откройте редактор реестра; 
3. Перейдите на **HKEY_LOCAL_MACHINE**  >  **Software**  >  **Microsoft**  >  **рдинфраажент**.
4. Выберите «с **регистрацией**». 
5. В поле **значение данных:** введите **0** и нажмите кнопку **ОК**. 
6. Выберите **регистратионтокен**. 
7. В поле **Value Data** (входные данные) Вставьте маркер регистрации из шага 1. 

   > [!div class="mx-imgBorder"]
   > ![Снимок экрана с регистратором 0](media/isregistered-token.png)

8. Откройте командную строку от имени учетной записи администратора.
9. Введите **net рдажентбутлоадер**. 
10. Введите **net start рдажентбутлоадер**. 
11. откройте редактор реестра;
12. Перейдите на **HKEY_LOCAL_MACHINE**  >  **Software**  >  **Microsoft**  >  **рдинфраажент**.
13. Убедитесь, что для параметра " **регистратор** " установлено значение 1, а в столбце данных для **регистратионтокен** нет ничего. 

   > [!div class="mx-imgBorder"]
   > ![Снимок экрана с регистрацией 1](media/isregistered-registry.png)

## <a name="error-agent-cannot-connect-to-broker-with-invalid_form-or-not_found-url"></a>Ошибка: агент не может подключиться к брокеру с INVALID_FORM или NOT_FOUND. URL-адрес

Перейдите в **Просмотр событий**  >  **приложение журналов Windows**  >  . Если вы видите событие с ИДЕНТИФИКАТОРом 3277, то это говорит **INVALID_FORM** или **NOT_FOUND. URL-адрес** в описании, что-то пошло не так с обменом данными между агентом и брокером. Агент не может подключиться к брокеру и не смог связаться с определенным URL-адресом. Это может быть вызвано параметрами брандмауэра или DNS.

Чтобы устранить эту проблему, убедитесь, что вы можете получить доступ к Брокерури и Брокеруриглобал:
1. Откройте редактор реестра. 
2. Перейдите на **HKEY_LOCAL_MACHINE**  >  **Software**  >  **Microsoft**  >  **рдинфраажент**. 
3. Запишите значения для **брокерури** и **брокеруриглобал**.

   > [!div class="mx-imgBorder"]
   > ![Снимок экрана: URI брокера и глобальный URI брокера](media/broker-uri.png)

 
4. Откройте браузер и перейдите в раздел *\<BrokerURI\> API/работоспособность*. 
   - Убедитесь, что вы используете значение из шага 3 в **брокерури**. В этом примере этого раздела будет <https://rdbroker-g-us-r0.wvd.microsoft.com/api/health> .
5. Откройте другую вкладку в браузере и перейдите в раздел *\<BrokerURIGlobal\> API/работоспособность*. 
   - Убедитесь, что вы используете значение из шага 3 в ссылке **брокеруриглобал** . В этом примере этого раздела будет <https://rdbroker.wvd.microsoft.com/api/health> .
6. Если сеть не блокирует подключение компонента Service Broker, то обе страницы будут успешно загружены и отобразится сообщение **"посредник удаленных рабочих столов работоспособен"** , как показано на следующих снимках экрана. 

   > [!div class="mx-imgBorder"]
   > ![Снимок экрана: доступ к URI компонента Service Broker успешно загружен](media/broker-uri-web.png)

   > [!div class="mx-imgBorder"]
   > ![Снимок экрана: успешно загруженный глобальный доступ URI компонента Service Broker](media/broker-global.png)
 

7. Если сеть блокирует подключение брокера, страницы не будут загружены, как показано на снимке экрана ниже. 

   > [!div class="mx-imgBorder"]
   > ![Снимок экрана: Неудачная загрузка доступа к брокеру](media/unsuccessful-broker-uri.png)

   > [!div class="mx-imgBorder"]
   > ![Снимок экрана: Неудачная загрузка глобального доступа к брокеру](media/unsuccessful-broker-global.png)

8. Если сеть блокирует эти URL-адреса, необходимо будет разблокировать необходимые URL-адреса. Дополнительные сведения см. в разделе [требуемый список URL-адресов](safe-url-list.md).
9. Если это не решит проблему, убедитесь, что у вас нет групповых политик с шифрами, которые блокируют подключение агента к компоненту Service Broker. Виртуальный рабочий стол Windows использует те же шифры TLS 1,2, что и [Передняя дверца Azure](../frontdoor/front-door-faq.MD#what-are-the-current-cipher-suites-supported-by-azure-front-door). Дополнительные сведения см. в разделе [Безопасность подключения](network-connectivity.md#connection-security).

## <a name="error-3703-or-3019"></a>Ошибка: 3703 или 3019

Перейдите в **Просмотр событий**  >  **приложение журналов Windows**  >  . Если вы видите событие с ИДЕНТИФИКАТОРом 3703, указывающее **URL-адрес шлюза удаленных рабочих столов: недоступен** или какое-либо событие с идентификатором 3019 в описании, агент не может получить доступ к URL-адресам шлюза или URL-адресам транспорта Web Socket. Для успешного подключения к узлу сеансов и разрешения сетевого трафика к этим конечным точкам для обхода ограничений необходимо разблокировать URL-адреса из [требуемого списка URL-](safe-url-list.md)адресов. Кроме того, убедитесь, что параметры брандмауэра или прокси-сервера не блокируют эти URL-адреса. Чтобы использовать виртуальный рабочий стол Windows, необходимо разблокировать эти URL-адреса.

Чтобы устранить эту проблему, убедитесь, что параметры брандмауэра и (или) DNS не блокируют следующие URL-адреса:
1. [Используйте брандмауэр Azure для защиты развертываний виртуальных рабочих столов Windows.](../firewall/protect-windows-virtual-desktop.md)
2. Настройте [параметры DNS брандмауэра Azure](../firewall/dns-settings.md).

## <a name="error-installmsiexception"></a>Ошибка: Инсталлмсиексцептион

Перейдите в **Просмотр событий**  >  **приложение журналов Windows**  >  . Если вы видите событие с ИДЕНТИФИКАТОРом 3277, которое говорит **инсталлмсиексцептион** в описании, установщик уже запущен для другого приложения, пока вы пытаетесь установить агент, или политика блокирует выполнение msiexec.exe программы.

Чтобы устранить эту проблему, отключите следующую политику:
   - Отключение установщик Windows  
      - Путь к категории: Конфигурация компьютера \ административные шаблоны \ компоненты Windows \ установщик
   
>[!NOTE]
>Это не полный список политик, а только тех, о которых мы сейчас осведомлены.

Чтобы отключить политику, выполните следующие действия.
1. Откройте командную строку от имени учетной записи администратора.
2. Введите и запустите **RSoP. msc**.
3. В появившемся окне **результирующего набора политик** перейдите по пути к категории.
4. Выберите политику.
5. Выберите **Отключено**.
6. Нажмите кнопку **Применить**.   

   > [!div class="mx-imgBorder"]
   > ![Снимок экрана политики установщик Windows в результирующем наборе политик](media/gpo-policy.png)

## <a name="error-win32exception"></a>Ошибка: Win32Exception

Перейдите в **Просмотр событий**  >  **приложение журналов Windows**  >  . Если вы видите событие с ИДЕНТИФИКАТОРом 3277, которое говорит **инсталлмсиексцептион** в описании, политика блокирует cmd.exe запуска. Блокирование этой программы препятствует запуску окна консоли, которое необходимо использовать для перезапуска службы при каждом обновлении агента.

Чтобы устранить эту проблему, отключите следующую политику:
   - запрет на использование командной строки;   
      - Путь к категории: Конфигурация пользователя \ административные Темплатес\систем
    
>[!NOTE]
>Это не полный список политик, а только тех, о которых мы сейчас осведомлены.

Чтобы отключить политику, выполните следующие действия.
1. Откройте командную строку от имени учетной записи администратора.
2. Введите и запустите **RSoP. msc**.
3. В появившемся окне **результирующего набора политик** перейдите по пути к категории.
4. Выберите политику.
5. Выберите **Отключено**.
6. Нажмите кнопку **Применить**.   

## <a name="error-stack-listener-isnt-working-on-windows-10-2004-vm"></a>Ошибка: прослушиватель стека не работает на виртуальной машине Windows 10 2004

Запустите **квинста** в командной строке и запишите номер версии, который отображается рядом с **RDP-SxS**. Если вы не видите компоненты **RDP-TCP** и **RDP-SxS** , **прослушивать** их рядом или они не отображаются вообще после запуска **квинста**, это означает, что существует ошибка стека. Обновления стека устанавливаются вместе с обновлениями агента, и когда эта установка переходит в вкось, прослушиватель виртуальных рабочих столов Windows не будет работать.

Для разрешения этой проблемы:
1. откройте редактор реестра;
2. Перейдите в раздел **HKEY_LOCAL_MACHINE**  >  **System**  >  **CurrentControlSet**  >  **Control**  >  **винстатионс сервера терминалов**  >  .
3. В разделе **винстатионс** можно увидеть несколько папок для разных версий стека, выбрать папку, соответствующую сведениям о версии, которые вы видели при запуске **Квинста** в командной строке.
4. Найдите **фреверсеконнектмоде** и убедитесь, что значение его данных равно **1**. Также убедитесь, что для **фенаблевинстатион** задано значение **1**.

   > [!div class="mx-imgBorder"]
   > ![Снимок экрана Фреверсеконнектмоде](media/fenable-2.png)

5. Если для **фреверсеконнектмоде** не задано значение **1**, выберите **фреверсеконнектмоде** и введите **1** в поле "значение". 
6. Если для **фенаблевинстатион** не задано значение **1**, выберите **фенаблевинстатион** и введите **1** в поле "значение".
7. Перезапустите виртуальную машину. 

>[!NOTE]
>Чтобы изменить режим **фреверсеконнектмоде** или **Фенаблевинстатион** для нескольких виртуальных машин за раз, можно выполнить одно из следующих действий.
>
>- Экспортируйте раздел реестра с компьютера, который уже работает, и импортируйте его на все остальные компьютеры, которым требуется это изменение.
>- Создайте объект общего типа политики (GPO), который задает значение раздела реестра для компьютеров, требующих изменения.

7. Перейдите в раздел **HKEY_LOCAL_MACHINE**  >  **System**  >  **CurrentControlSet**  >  **Control**  >  **ClusterSettings сервера терминалов**  >  .
8. В разделе **ClusterSettings** найдите **сессиондиректорилистенер** и убедитесь, что его значение данных — **RDP-SxS...**.
9. Если для **сессиондиректорилистенер** не задано значение **RDP-SxS...**, необходимо выполнить действия, описанные в разделе [Удаление агента и загрузчика](#step-1-uninstall-all-agent-boot-loader-and-stack-component-programs) , чтобы сначала удалить компоненты агента, загрузчика и стека, а затем [переустановить агент и загрузчик](#step-4-reinstall-the-agent-and-boot-loader). Это приведет к повторной установке стека параллельно.

## <a name="error-users-keep-getting-disconnected-from-session-hosts"></a>Ошибка: пользователи продолжают отключаться от узлов сеансов

Перейдите в **Просмотр событий**  >  **приложение журналов Windows**  >  . Если вы видите событие с ИДЕНТИФИКАТОРом 0, которое говорит **чекксессионхостдомаинисреачаблеасинк** в описании и (или) пользователи продолжают отключаться от узлов сеансов, сервер не выбирает пульс из службы виртуальных рабочих столов Windows.

Чтобы устранить эту проблему, измените пороговое значение пульса:
1. Откройте командную строку от имени администратора.
2. Введите команду **квинста** и запустите ее.
3. Должно отобразиться два компонента стека: **RDP-TCP** и **RDP-SxS**. 
   - В зависимости от версии ОС, которую вы используете, за **RDP-SxS** может следовать номер сборки. Если это так, обязательно напишите это число для дальнейшего использования.
4. откройте редактор реестра;
5. Перейдите в раздел **HKEY_LOCAL_MACHINE**  >  **System**  >  **CurrentControlSet**  >  **Control**  >  **винстатионс сервера терминалов**  >  .
6. В разделе **винстатионс** можно увидеть несколько папок для разных версий стека. Выберите папку, соответствующую номеру версии из шага 3.
7. Создайте реестр DWORD, щелкнув правой кнопкой мыши редактор реестра и выбрав пункт **New**  >  **DWORD (32 бит)**. При создании DWORD введите следующие значения:
   - Хеартбеатинтервал: 10000
   - Хеартбеатварнкаунт: 30 
   - Хеартбеатдропкаунт: 60 
8. Перезапустите виртуальную машину.

## <a name="error-downloadmsiexception"></a>Ошибка: Довнлоадмсиексцептион

Перейдите в **Просмотр событий**  >  **приложение журналов Windows**  >  . Если вы видите событие с ИДЕНТИФИКАТОРом 3277, которое говорит **довнлоадмсиексцептион** в описании, на диске недостаточно места для рдажент.

Чтобы устранить эту проблему, освободите место на диске, выполнив следующие действия.
   - Удаление файлов, которые больше не находятся в пользователе
   - Увеличение емкости хранилища виртуальной машины

## <a name="error-vms-are-stuck-in-unavailable-or-upgrading-state"></a>Ошибка: виртуальные машины находятся в недоступном состоянии или обновляют состояние

Откройте окно PowerShell с правами администратора и выполните следующий командлет:

```powershell
Get-AzWvdSessionHost -ResourceGroupName <resourcegroupname> -HostPoolName <hostpoolname> | Select-Object *
```

Если состояние, указанное для узла сеансов или узлов в пуле узлов, всегда говорит о **недоступности** или **обновлении**, возможно, произошел сбой установки агента или стека.

Чтобы устранить эту проблему, переустановите параллельный стек:
1. Откройте командную строку от имени учетной записи администратора.
2. Введите **net рдажентбутлоадер**. 
3. Последовательно выберите пункты **Панель управления** > **Программы** > **Программы и компоненты**.
4. Удалите последнюю версию **сетевого стека службы удаленных рабочих столов SxS** или версию, указанную в разделе **HKEY_LOCAL_MACHINE**  >  **System**  >  **CurrentControlSet**  >  **Control**  >  **Server**  >  **винстатионс** в **реверсеконнектлистенер**.
5. Откройте окно консоли от имени администратора и перейдите в раздел **Program Files**  >  **Microsoft рдинфра**.
6. Выберите компонент **скссстакк** или выполните команду **msiexec/i скссстакк- <version> . MSI** , чтобы установить MSI.
8. Перезапустите виртуальную машину.
9. Вернитесь в командную строку и выполните команду **квинста** .
10. Убедитесь, что компонент стека, установленный на шаге 6, указывает на **прослушивание** рядом с ним.
   - В этом случае введите **net start рдажентбутлоадер** в командной строке и ПЕРЕзапустите виртуальную машину.
   - В противном случае необходимо будет [повторно зарегистрировать виртуальную машину и переустановить компонент агента](#your-issue-isnt-listed-here-or-wasnt-resolved) .

## <a name="error-connection-not-found-rdagent-does-not-have-an-active-connection-to-the-broker"></a>Ошибка: подключение не найдено: Рдажент не имеет активного подключения к брокеру

У ваших виртуальных машин может быть ограничение на количество подключений, поэтому виртуальная машина не может принимать новые подключения.

Для разрешения этой проблемы:
   - Уменьшите ограничение максимального числа сеансов. Это обеспечит более равномерное распределение ресурсов между узлами сеансов и предотвратит исчерпание ресурсов.
   - Увеличьте емкость ресурсов виртуальных машин.

## <a name="error-operating-a-pro-vm-or-other-unsupported-os"></a>Ошибка: работа с виртуальной машиной Pro или другой неподдерживаемой ОС

Параллельный стек поддерживается только номерами SKU Windows Enterprise или Windows Server, то есть такие операционные системы, как виртуальная машина Pro, не поддерживаются. Если у вас нет номера SKU предприятия или сервера, стек будет установлен на виртуальной машине, но не будет активирован, поэтому он не появится при запуске **квинста** в командной строке.

Чтобы устранить эту проблему, создайте виртуальную машину Windows Enterprise или Windows Server.
1. Перейдите к [сведениям о виртуальной машине](create-host-pools-azure-marketplace.md#virtual-machine-details) и выполните шаги 1-12, чтобы настроить одно из следующих рекомендуемых образов:
   - Многосеансовая поддержка Windows 10 Корпоративная, версия 1909
   - Многосеансовая поддержка Windows 10 Корпоративная, версия 1909 и Microsoft 365 приложения
   - Windows Server 2019 Datacenter
   - Многосеансовая поддержка Windows 10 Корпоративная, версия 2004
   - Многосеансовая поддержка Windows 10 Корпоративная, версия 2004 и Microsoft 365 приложения
2. Выберите **Проверка и создать**.

## <a name="error-name_already_registered"></a>Ошибка: NAME_ALREADY_REGISTERED

Имя виртуальной машины уже зарегистрировано и, возможно, является дубликатом.

Для разрешения этой проблемы:
1. Выполните действия, описанные в разделе [Удаление узла сеанса из пула узлов](#step-2-remove-the-session-host-from-the-host-pool) .
2. [Создайте другую виртуальную машину](expand-existing-host-pool.md#add-virtual-machines-with-the-azure-portal). Обязательно выберите уникальное имя для этой виртуальной машины.
3. Перейдите в портал Azure] ( https://portal.azure.com) и откройте страницу **обзора** пула узлов, в котором находится ваша виртуальная машина. 
4. Откройте вкладку **узлы сеансов** и убедитесь, что все узлы сеансов находятся в этом пуле узлов.
5. Подождите 5-10 минут, пока состояние узла сеансов не поговорит о **доступности**.

   > [!div class="mx-imgBorder"]
   > ![Снимок экрана с доступным узлом сеансов](media/hostpool-portal.png)

## <a name="your-issue-isnt-listed-here-or-wasnt-resolved"></a>Ваша проблема не указана здесь или не устранена

Если вы не можете найти свою ошибку в этой статье или инструкции не помогают, рекомендуется удалить, переустановить и повторно зарегистрировать агент виртуальных рабочих столов Windows. Инструкции в этом разделе покажут, как повторно зарегистрировать виртуальную машину в службе виртуальных рабочих столов Windows, удалив все компоненты агента, загрузчика и стека, удаляя узел сеанса из пула узлов, создавая новый ключ регистрации для виртуальной машины и переустанавливая агент и загрузчик. Если один или несколько из следующих сценариев применимы к вам, выполните следующие инструкции:
- Виртуальная машина находится в процессе **обновления** или **недоступна**
- Прослушиватель стека не работает, и вы работаете в Windows 10 1809, 1903 или 1904
- Вы получаете ошибку **EXPIRED_REGISTRATION_TOKEN**
- Вы не видите виртуальные машины в списке узлов сеансов
- **Загрузчик агента удаленный рабочий стол** не отображается в окне "службы"
- Компонент **рдажентбутлоадер** не отображается в диспетчере задач.
- Инструкции в этой статье не помогли решить проблему

### <a name="step-1-uninstall-all-agent-boot-loader-and-stack-component-programs"></a>Шаг 1. Удаление всех программ, запускающих агент, загрузчик и компоненты стека

Перед переустановкой агента, загрузочного загрузчика и стека необходимо удалить все существующие программы из виртуальной машины. Чтобы удалить все программы агента, загрузчика и компонентов стека, выполните следующие действия.
1. Войдите в свою виртуальную машину с правами администратора. 
2. Последовательно выберите пункты **Панель управления** > **Программы** > **Программы и компоненты**.
3. Удалите следующие программы:
   - Загрузчик агента удаленный рабочий стол
   - Агент инфраструктуры службы удаленных рабочих столов
   - Агент Geneva инфраструктуры службы удаленных рабочих столов
   - Сетевой стек службы удаленных рабочих столов SxS
   
>[!NOTE]
>Может появиться несколько экземпляров этих программ. Обязательно удалите все из них.

   > [!div class="mx-imgBorder"]
   > ![Снимок экрана: удаление программ](media/uninstall-program.png)

### <a name="step-2-remove-the-session-host-from-the-host-pool"></a>Шаг 2. Удаление узла сеанса из пула узлов

При удалении узла сеанса из пула узлов узел сеансов больше не будет зарегистрирован в этом пуле узлов. Он действует как сброс для регистрации узла сеансов. Чтобы удалить узел сеанса из пула узлов, выполните следующие действия.
1. Перейдите на страницу **обзора** пула узлов, в котором находится ваша виртуальная машина, в [портал Azure](https://portal.azure.com). 
2. Перейдите на вкладку **узлы сеансов** , чтобы просмотреть список всех узлов сеансов в этом пуле узлов.
3. Просмотрите список узлов сеансов и выберите виртуальную машину, которую необходимо удалить.
4. Щелкните **Удалить**.  

   > [!div class="mx-imgBorder"]
   > ![Снимок экрана: Удаление виртуальной машины из пула узлов](media/remove-sh.png)

### <a name="step-3-generate-a-new-registration-key-for-the-vm"></a>Шаг 3. Создание нового ключа регистрации для виртуальной машины

Необходимо создать новый ключ регистрации, который будет использоваться для повторной регистрации виртуальной машины в пуле узлов и в службе. Чтобы создать новый ключ регистрации для виртуальной машины, выполните следующие действия.
1. Откройте [портал Azure](https://portal.azure.com) и перейдите на страницу **обзора** пула узлов виртуальной машины, которую необходимо изменить.
2. Выберите **ключ регистрации**.

   > [!div class="mx-imgBorder"]
   > ![Снимок экрана с ключом регистрации на портале](media/reg-key.png)

3. Откройте вкладку **ключ регистрации** и выберите **создать новый ключ**.
4. Введите дату окончания срока действия и нажмите кнопку **ОК**.  

>[!NOTE]
>Дата истечения срока действия не может быть меньше часа и не более 27 дней с момента ее создания и даты. Мы настоятельно рекомендуем установить дату истечения до 27 дней.

5. Скопируйте созданный ключ в буфер обмена. Этот ключ потребуется позже.

### <a name="step-4-reinstall-the-agent-and-boot-loader"></a>Шаг 4. переустановите агент и загрузчик

При повторной установке самой обновленной версии агента и загрузчика также устанавливается параллельный стек и агент мониторинга Geneva. Чтобы переустановить агент и загрузчик, выполните следующие действия.
1. Войдите в свою виртуальную машину от имени администратора и следуйте инструкциям в разделе [регистрация виртуальных машин](create-host-pools-powershell.md#register-the-virtual-machines-to-the-windows-virtual-desktop-host-pool) для загрузки **агента виртуальных рабочих столов Windows** и **загрузчика агента виртуальных рабочих столов Windows**.

   > [!div class="mx-imgBorder"]
   > ![Снимок экрана со страницей загрузки агентов и загрузчика](media/download-agent.png)

2. Щелкните правой кнопкой мыши агент и только что Скачанные установщики загрузки.
3. Выберите **Свойства**.
4. Выберите **Unblock** (Разблокировать).
5. Щелкните **ОК**.
6. Запустите установщик агента.
7. Когда установщик запросит у вас маркер регистрации, вставьте регистрационный ключ из буфера обмена. 

   > [!div class="mx-imgBorder"]
   > ![Снимок экрана вставленного маркера регистрации](media/pasted-agent-token.png)

8. Запустите установщик загрузчика загрузки.
9. Перезапустите виртуальную машину. 
10. Перейдите в [портал Azure](https://portal.azure.com) и откройте страницу **обзора** пула узлов, к которому принадлежит ваша виртуальная машина.
11. Перейдите на вкладку **узлы сеансов** , чтобы просмотреть список всех узлов сеансов в этом пуле узлов.
12. Теперь узел сеанса, зарегистрированный в пуле узлов, должен иметь состояние **доступно**. 

   > [!div class="mx-imgBorder"]
   > ![Снимок экрана с доступным узлом сеансов](media/hostpool-portal.png)

## <a name="next-steps"></a>Дальнейшие действия

Если проблема состоится, создайте обращение в службу поддержки и включите в него подробные сведения о возникшей проблеме и действиях, которые вы предоставили, чтобы попробовать ее устранить. В следующем списке содержатся другие ресурсы, которые можно использовать для устранения неполадок, связанных с развертыванием виртуальных рабочих столов Windows.

- Общие сведения об устранении неполадок с Виртуальным рабочим столом Windows и о путях эскалации см. в статье [Общие сведения об устранении неисправностей, отзывы и поддержка](troubleshoot-set-up-overview.md).
- Сведения об устранении неполадок при создании пула узлов в среде виртуальных рабочих столов Windows см. в разделе [Создание среды и пула узлов](troubleshoot-set-up-issues.md).
- Инструкции по устранению неполадок при настройке виртуальной машины через Виртуальный рабочий стол Windows см. в статье [Конфигурация виртуальной машины узла сеанса](troubleshoot-vm-configuration.md).
- Сведения об устранении неполадок подключения клиентов к виртуальным рабочим столам Windows см. в статье [подключения к службе виртуальных рабочих столов Windows](troubleshoot-service-connection.md).
- Сведения об устранении неполадок, связанных с удаленный рабочий стол клиентами, см. [в разделе Устранение неполадок клиента удаленный рабочий стол](troubleshoot-client.md).
- Инструкции по устранению неполадок при использовании PowerShell через Виртуальный рабочий стол Windows см. в статье [Виртуальный рабочий стол Windows — PowerShell](troubleshoot-powershell.md).
- Дополнительные сведения о службе см. в разделе [Среда виртуальных рабочих столов Windows](environment-setup.md).
- Сведения об устранении неполадок см. в статье [Tutorial: Troubleshoot Resource Manager template deployments](../azure-resource-manager/templates/template-tutorial-troubleshoot.md) (Руководство. Устранение неполадок развертывания шаблонов Resource Manager)
- Сведения о действиях аудита см. в статье [Операции аудита с помощью Resource Manager](../azure-resource-manager/management/view-activity-logs.md).
- Дополнительные сведения об определении ошибок во время развертывания см. в статье [Просмотр операций развертывания с помощью портала Azure](../azure-resource-manager/templates/deployment-history.md).
