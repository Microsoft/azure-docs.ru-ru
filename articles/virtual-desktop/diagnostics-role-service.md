---
title: Диагностика проблем с помощью Виртуального рабочего стола Windows — Azure
description: Узнайте, как использовать возможности диагностики в Виртуальном рабочем столе Windows для диагностики проблем.
author: Heidilohr
ms.topic: troubleshooting
ms.date: 09/21/2020
ms.author: helohr
manager: lizross
ms.openlocfilehash: 70676bd1a07acdfcbba071a906b390ed66d70074
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "91279864"
---
# <a name="identify-and-diagnose-windows-virtual-desktop-issues"></a>Определение и диагностика проблем с виртуальными рабочими столами Windows

>[!IMPORTANT]
>Это содержимое применимо к Виртуальному рабочему столу Windows с объектами Azure Resource Manager для Виртуального рабочего стола Windows. Если вы используете Виртуальный рабочий стол Windows (классический) без объектов Azure Resource Manager, ознакомьтесь с [этой статьей](./virtual-desktop-fall-2019/diagnostics-role-service-2019.md).

Виртуальный рабочий стол Windows включает функцию диагностики, которая позволяет администратору выявлять разные проблемы через единый интерфейс. Дополнительные сведения о возможностях диагностики виртуальных рабочих столов Windows см. в разделе [использование log Analytics для компонента диагностики](diagnostics-log-analytics.md).

Подключения, которые не достигают Виртуального рабочего стола Windows, не отображаются в результатах диагностики, так как служба роли диагностики является частью Виртуального рабочего стола Windows. Проблемы с подключением к Виртуальному рабочему столу Windows могут возникнуть, когда пользователь испытывает проблемы с сетевым подключением.

## <a name="common-error-scenarios"></a>Распространенные сценарии ошибок

Таблица Ввдеррорс отслеживает ошибки во всех типах действий. Столбец с именем "Сервицееррор" предоставляет дополнительный флаг, помеченный как "true" или "false". Этот флаг показывает, связана ли эта ошибка со службой.

* Если значение равно "true", группа разработчиков уже могла исследовать эту проблему. Если это влияет на взаимодействие с пользователем и появляется большое количество раз, мы рекомендуем отправить запрос в службу поддержки для виртуальных рабочих столов Windows.
* Если значение равно "false", это может быть неверной конфигурацией, которую можно исправить самостоятельно. В сообщении об ошибке можно указать, с чего начать.

В следующей таблице перечислены самые распространенные ошибки, с которыми могут столкнуться администраторы.

>[!NOTE]
>Этот список регулярно обновляется. Чтобы поддерживать актуальность информации, сверяйтесь с этой статьей хотя бы раз в месяц.

## <a name="management-errors"></a>Ошибки управления

|Сообщение об ошибке|Предлагаемое решение|
|---|---|
|Не удалось создать ключ регистрации |Не удалось создать токен регистрации. Попробуйте создать его еще раз с более коротким временем окончания срока действия (от 1 часа до 1 месяца). |
|Не удалось удалить ключ регистрации|Не удалось удалить токен регистрации. Попробуйте удалить его еще раз. Если он по-прежнему не работает, используйте PowerShell для проверки наличия маркера. Если это так, удалите его с помощью PowerShell.|
|Не удалось изменить режим стока узла сеанса |Не удалось изменить режим стока на виртуальной машине. Проверьте состояние виртуальной машины. Если виртуальная машина недоступна, режим стока не может быть изменен.|
|Не удалось отключить пользовательские сеансы |Не удалось отключить пользователя от виртуальной машины. Проверьте состояние виртуальной машины. Если виртуальная машина недоступна, сеанс пользователя не может быть отключен. Если виртуальная машина доступна, проверьте состояние сеанса пользователя, чтобы узнать, отключен ли он. |
|Не удалось завершить сеансы всех пользователей на узле сеансов |Не удалось подписать пользователей виртуальной машины. Проверьте состояние виртуальной машины. Если он недоступен, пользователи не могут выйти из нее. Проверьте состояние сеанса пользователя, чтобы убедиться, что они уже вышли. Вы можете принудительно выполнить выход с помощью PowerShell. |
|Не удалось отменить назначение пользователя из группы приложений|Не удалось отменить публикацию группы приложений для пользователя. Проверьте, доступен ли пользователь в Azure AD. Проверьте, является ли пользователь частью группы пользователей, в которой опубликована группа приложений. |
|Произошла ошибка при получении доступных расположений |Проверьте расположение виртуальной машины, используемой в мастере создания пула узлов. Если образ недоступен в этом расположении, добавьте образ в это расположение или выберите другое расположение виртуальной машины. |

### <a name="connection-error-codes"></a>Коды ошибок подключения

|Числовой код|Код ошибки|Предлагаемое решение|
|---|---|---|
|-2147467259|ConnectionFailedAdTrustedRelationshipFailure|Узел сеансов неправильно присоединен к Active Directory.|
|-2146233088|ConnectionFailedUserHasValidSessionButRdshIsUnhealthy|Не удалось установить подключение, так как узел сеансов недоступен. Проверьте работоспособность узла сеансов.|
|-2146233088|ConnectionFailedClientDisconnect|Если эта ошибка возникает часто, убедитесь, что компьютер пользователя подключен к сети.|
|-2146233088|ConnectionFailedNoHealthyRdshAvailable|Сеанс, к которому пытался подключиться пользователь узла, неработоспособен. Выполните отладку виртуальной машины.|
|-2146233088|ConnectionFailedUserNotAuthorized|У пользователя нет разрешений на доступ к опубликованному приложению или рабочему столу. Эта ошибка может появиться после того, как администратор удалит опубликованные ресурсы. Попросите пользователя обновить веб-канал в приложении удаленного рабочего стола.|
|2|FileNotFound|Приложение, к которому пользователь пытался получить доступ, установлено неправильно либо настроено с неправильным путем.<br><br>При публикации новых приложений во время работы пользователя с активным сеансом он не сможет получить доступ к этому приложению. Чтобы пользователь мог получить доступ к приложению, необходимо завершить работу и перезапустить сеанс. |
|3|InvalidCredentials|Имя пользователя или пароль, введенные пользователем, не совпадают с существующими именами пользователей и паролями. Проверьте учетные данные на наличие опечаток и повторите попытку.|
|8|ConnectionBroken|Подключение между клиентом и шлюзом или сервером разорвано. Никаких действий не требуется, если это не происходит неожиданно.|
|14|UnexpectedNetworkDisconnect|Подключение к сети разорвано. Попросите пользователя установить подключение.|
|24|ReverseConnectFailed|Виртуальная машина узла не имеет прямой связи с шлюзом удаленных рабочих столов. Убедитесь, что IP-адрес шлюза успешно разрешается.|

## <a name="error-cant-add-user-assignments-to-an-app-group"></a>Ошибка: не удается добавить назначения пользователей в группу приложений

После назначения пользователя группе приложений в портал Azure отображается предупреждение "конец сеанса" или "проблемы проверки подлинности-расширение Microsoft_Azure_WVD". После этого страница назначения не загружается, и после этого страницы перестают загружаться по всему портал Azure (например, Azure Monitor, Log Analytics, работоспособность службы и т. д.).

**Причина:** Возникла проблема с политикой условного доступа. Портал Azure пытается получить маркер для Microsoft Graph, который зависит от SharePoint Online. Клиент имеет политику условного доступа с именем "Microsoft Office 365 условий использования хранилища данных", которая требует от пользователей принять условия использования для доступа к хранилищу данных. Однако они еще не выполнили вход, поэтому портал Azure не может получить маркер.

**Исправление:** Перед входом в портал Azure администратор сначала должен войти в SharePoint и принять условия использования. После этого они смогут входить в портал Azure, как обычное.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о ролях для Виртуального рабочего стола Windows см. в статье [Среда Виртуального рабочего стола Windows](environment-setup.md).

Список доступных командлетов PowerShell для Виртуального рабочего стола Windows см. в [документации по PowerShell](/powershell/windows-virtual-desktop/overview).
