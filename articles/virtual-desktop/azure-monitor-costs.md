---
title: Мониторинг цен на виртуальные рабочие столы Windows — Azure
description: Как оценить затраты и цены на использование Azure Monitor для виртуальных рабочих столов Windows.
author: Heidilohr
ms.topic: conceptual
ms.date: 03/29/2021
ms.author: helohr
manager: lizross
ms.openlocfilehash: 099def5a29c8a9b46733ba435befed7210756012
ms.sourcegitcommit: dae6b628a8d57540263a1f2f1cdb10721ed1470d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/29/2021
ms.locfileid: "105709988"
---
# <a name="estimate-azure-monitor-costs"></a>Оценка затрат Azure Monitor

Журналы Azure Monitor — это служба, которая собирает, индексирует и хранит данные, созданные в вашей среде. В связи с этим модель ценообразования Azure Monitor основана на объеме данных, которые подносятся и обрабатываются (или принимаются) рабочей областью Log Analytics в гигабайтах в день. Стоимость рабочей области Log Analytics не только зависит от объема собираемых данных, но и от того, какой план оплаты Azure был выбран, и как долго вы решили хранить данные, создаваемые средой.

В этой статье рассматриваются следующие вопросы, которые помогут понять, как работают цены в Azure Monitor.

- Как оценить затраты на прием и хранение данных перед включением этой функции
- Как измерять и контролировать прием и хранение данных, чтобы снизить затраты при использовании этой функции

>[!NOTE]
> Все размеры и цены, перечисленные в этой статье, являются просто примерами для демонстрации работы оценки. Чтобы получить более точную оценку на основе модели ценообразования Azure Monitor Log Analytics и региона Azure, см. раздел [цены на Azure Monitor](https://azure.microsoft.com/pricing/details/monitor/).

## <a name="estimate-data-ingestion-and-storage-costs"></a>Оценка затрат на прием и хранение данных

Рекомендуется использовать предопределенный набор данных, записанных в виде журналов в рабочей области Log Analytics. В следующем примере оценки будут рассмотрены оплачиваемые данные в конфигурации по умолчанию.

Стандартные наборы данных для Azure Monitor для виртуальных рабочих столов Windows включают:

- Счетчики производительности на узлах сеансов
- Журналы событий Windows из узлов сеансов
- Диагностика виртуальных рабочих столов Windows из инфраструктуры службы

Стоимость приема и хранения данных зависит от размера, работоспособности и использования вашей среды. Пример оценки, который будет использоваться в этой статье для вычисления диапазонов [затрат, которые](/remote/remote-desktop-services/virtual-machine-recs)вы можете рассчитывать, зависит от работоспособных виртуальных машин, которые работают с низкой степенью энергопотребления.

В нашем примере используется виртуальная машина с низкой интенсивностью использования, которая включает в себя следующие компоненты:

- 4 виртуальных ЦП, 1 диск
- 16 сеансов в день
- Средняя длительность сеанса в 2 часа (120 минут)
- 100 процессов на сеанс

В нашем примере виртуальная машина использования энергии будет использоваться в следующих компонентах:

- 6 виртуальных ЦП, 1 диск
- 6 сеансов в день
- Средняя продолжительность сеанса в 4 часа (240 минут)
- 200 процессов на сеанс

## <a name="estimating-performance-counter-ingestion"></a>Оценка приема счетчика производительности

Счетчики производительности показывают, как выполняются системные ресурсы. Прием данных счетчика производительности зависит от размера и использования среды. В большинстве случаев счетчики производительности должны состоять 80 – 99% приема данных для Azure Monitor для виртуальных рабочих столов Windows.

Прежде чем начать оценку, важно понимать, что каждый счетчик производительности отправляет данные с определенной периодичностью. Мы устанавливаем частоту выборки по умолчанию (в минуту) (можно также изменить эту частоту в параметрах), но эта ставка будет применяться с различными коэффициентами умножения в зависимости от счетчика. На скорость влияют следующие факторы:

- Для каждого фактора виртуальной машины каждый счетчик отправляет данные на виртуальную машину в вашей среде с частотой выборки по умолчанию в минуту во время работы виртуальной машины. Вы можете оценить количество записей, отправляемых этими счетчиками в день, умножив частоту выборки по умолчанию в минуту на количество виртуальных машин в вашей среде, а затем умножая это число на среднее время выполнения виртуальной машины в день.

   Подведение итогов.

   Частота выборки по умолчанию в минуту × число ядер ЦП в номере SKU виртуальной машины # число виртуальных машин x среднее время выполнения виртуальной машины в день = число записей, отправляемых в день

- Для каждого фактора ЦП каждый счетчик отправляет по умолчанию частоту выборки в минуту для каждого виртуальных ЦП в каждой виртуальной машине в вашей среде во время работы виртуальной машины. Вы можете оценить количество записей, которые будут отправлены счетчиками за день, умножив частоту выборки по умолчанию в минуту на количество ядер ЦП в номере SKU виртуальной машины, а затем умножая это число на количество минут, в течение которых выполняется виртуальная машина, и число виртуальных машин в вашей среде.

   Подведение итогов.
   
   Частота выборки по умолчанию в минуту × число ядер ЦП в номере SKU виртуальной машины число минут, в течение которых виртуальная машина выполняется × число виртуальных машин = количество записей, отправленных в день

- Для фактора каждого диска каждый счетчик отправляет данные по частоте выборки по умолчанию для каждого диска в каждой виртуальной машине в вашей среде. Число записей, отправляемых этими счетчиками в день, равно частоте выборки по умолчанию в минуту, умноженной на число дисков в номере SKU виртуальной машины, умноженное на 60 минут в час, и, наконец, умножается на среднее количество активных часов для виртуальной машины.

   Подведение итогов.

   Частота выборки по умолчанию в минуту × число дисков в номере SKU виртуальной машины × 60 минут в час × число виртуальных машин × среднее время выполнения виртуальной машины в день = количество записей, отправляемых в день.

- Для каждого сеанса каждый счетчик отправляет данные по частоте выборки по умолчанию для каждого сеанса в среде во время подключения сеанса. Вы можете оценить количество записей, которые будут отправлены этими счетчиками в день. это может быть умножением частоты выборки по умолчанию в минуту на среднее число сеансов в день и среднюю продолжительность сеанса.

   Подведение итогов.

   Частота выборки по умолчанию в минуту × сеансов в день x средняя длительность сеанса = количество записей, отправленных в день

- Для каждого процесса каждый счетчик отправляет данные с частотой по умолчанию для каждого процесса в каждом сеансе в среде. Вы можете оценить количество записей, которые будут отправлены этими счетчиками за день, умножая частоту выборки по умолчанию в минуту на среднее количество сеансов в день, а затем умножая их на среднюю продолжительность сеанса и среднее число процессов на сеанс.
  
   Подведение итогов.

   Частота выборки по умолчанию в минуту × сеансов в день x средняя длительность сеанса × среднее число процессов на сеанс = число записей, отправляемых в день

В следующей таблице перечислены 20 счетчиков производительности, Azure Monitor собираемых для виртуальных рабочих столов Windows, и их тарифы по умолчанию.

| Имя счетчика | Частота выборки по умолчанию | Фактор частоты |
|--------------|---------------------|------------------|
| Логический диск (C:) \\ % свободного места | 60 секунд  | На диск             |
| Логический диск (C:) \\ Средняя длина очереди диска   | 30 секунд    | На диск             |
| Логический диск (C:) \\ Среднее время обращения к диску (сек.)  | 60 секунд       | На диск             |
| Логический диск (C:) \\ Текущая длина очереди диска  | 30 секунд      | На диск             |
| Объем доступной памяти, \* \\ МБ | 30 секунд    | На виртуальную машину  |
| Память ( \* ) \\ ошибок страниц/с | 30 секунд   | На виртуальную машину  |
| Память ( \* ) \\ страниц/с | 30 секунд   | На виртуальную машину  |
| Память ( \* ) \\ % используем фиксированных байтов | 30 секунд    | На виртуальную машину  |
| Физический диск ( \* ) \\ СР. Длина очереди диска | 30 секунд      | На диск             |
| Физический \* диск () \\ Среднее время чтения с диска (с) | 30 секунд  | На диск             |
| Физический \* диск () \\ — СР. время обмена (с) | 30 секунд  | На диск             |
| Физический \* диск () \\ СР. время записи с диска (сек.) | 30 секунд | На диск             |
| Сведения о процессоре (_Total) \\ % загруженности процессора | 30 секунд | На ядро или ЦП         |
| \*Активные сеансы служб терминалов () \\          | 60 секунд | На виртуальную машину  |
| \* \\ Неактивные сеансы служб терминалов        | 60 секунд | На виртуальную машину  |
| Всего сеансов служб терминалов ( \* ) \\ | 60 секунд | На виртуальную машину  |
| Максимальная задержка ввода данных пользователем на процесс ( \* ) \\         | 30 секунд | На процесс          |
| Максимальная задержка входных данных пользователя на сеанс ( \* ) \\        | 30 секунд | Для сеанса.          |
| \* \\ Текущий RTT-трафик сети RemoteFX () | 30 секунд | На виртуальную машину  |
| \* \\ Текущая пропускная способность сети RemoteFX ()     | 30 секунд | На виртуальную машину  |

Если мы предполагаем, что размер каждой записи составляет 200 байт, пример виртуальной машины, в которой используется легкая Рабочая нагрузка на частоте выборки по умолчанию, будет примерно 90 МБ данных счетчика производительности в день для каждой виртуальной машины. В то же время, пример виртуальной машины, в которой работает Рабочая нагрузка, будет примерно 130 МБ данных счетчика производительности в день на каждую виртуальную машину. Однако размер записи и использование среды могут различаться, поэтому количество мегабайт в день, используемых при развертывании, может отличаться.

Дополнительные сведения о счетчиках производительности задержки ввода см. в разделе [счетчики производительности задержки ввода данных пользователем](/windows-server/remote/remote-desktop-services/rds-rdsh-performance-counters/).

## <a name="estimating-windows-event-log-ingestion"></a>Оценка приема журнала событий Windows

Журналы событий Windows — это источники данных, собираемые агентами Log Analytics на виртуальных машинах Windows. Вы можете получать события из стандартных журналов, таких как система и приложение, а также пользовательские журналы, созданные приложениями, которые необходимо отслеживать.

Это события Windows по умолчанию для Azure Monitor для виртуальных рабочих столов Windows.

- Приложение
- Microsoft-Windows-Терминалсервицес-Ремотеконнектионманажер/администратор
- Microsoft-Windows-Терминалсервицес-Локалсессионманажер/эксплуатация
- Система
- Microsoft-Фслогикс-Apps/эксплуатация
- Microsoft-Фслогикс-Apps/администратор

События Windows отправляются при каждом выполнении условий события в среде. Компьютеры в работоспособном состоянии будут передавать меньше событий, чем компьютеры в неработоспособном состоянии. Так как число событий является непредсказуемым, мы используем диапазон от 1 000 до 10 000 событий на каждую виртуальную машину в день, основываясь на примерах работоспособных сред для этой оценки. Например, если мы оцениваем, что размер записи события в этом примере равен 1 500 байт, это происходит примерно от 2 до 15 мегабайт данных о событиях в день для указанной среды.

Дополнительные сведения о событиях Windows см. в разделе [свойства записей событий Windows](../azure-monitor/agents/data-sources-windows-events.md).

## <a name="estimating-diagnostics-ingestion"></a>Оценка приема диагностических сведений

Служба диагностики создает журналы действий как для пользователей, так и для административных действий.

Ниже приведены имена журналов действий, отслеживающих счетчики диагностики:

- WVDCheckpoints
- WVDConnections
- WVDErrors
- WVDFeeds
- WVDManagement
- WVDAgentHealthStatus

Служба отправляет диагностические сведения каждый раз, когда среда соответствует условиям, необходимым для создания записи. Так как счетчик записей диагностики является непредсказуемым, мы используем диапазон от 500 до 1000 событий на каждую виртуальную машину в день, основываясь на примерах работоспособных сред для этой оценки.

Например, если оценить размер записи диагностики в этом примере как 200 байт, то общий объем полученных данных будет менее 1 МБ на каждую виртуальную машину в день.

Дополнительные сведения о категориях журналов действий см. в статье [Диагностика виртуальных рабочих столов Windows](diagnostics-log-analytics.md).

## <a name="estimating-total-costs"></a>Оценка общих затрат

Наконец, давайте выполним оценку общей стоимости. В этом примере предположим, что мы получаем следующие результаты, основанные на примерах значений в предыдущих разделах:

| Источник данных        | Оценка размера в день (в мегабайтах)   |
|-------------------------------------|------------------------------------------|
| Счетчики производительности   | 90-130 |
| События    | 2–15 |
| Диагностика виртуальных рабочих столов Windows | \< одного |

В этом примере общий объем принимаемых данных для Azure Monitor для виртуального рабочего стола Windows составляет от 92 до 145 МБ на виртуальную машину в день. Иными словами, каждые 31 день каждая виртуальная машина принимает примерно 3 – 5 гигабайт данных.

Используя модель оплаты по мере использования по умолчанию для [log Analytics цен](https://azure.microsoft.com/pricing/details/monitor/), можно оценить Azure Monitor сбор данных и стоимость хранилища в месяц. В зависимости от приема данных вы также можете рассмотреть модель резервирования емкости для Log Analyticsных цен.

## <a name="manage-your-data-ingestion-to-reduce-costs"></a>Управление приемом данных для снижения затрат

В этом разделе объясняется, как измерять и управлять приемом данных для снижения затрат.

Дополнительные сведения об управлении правами и разрешениями для книги см. в разделе [Контроль доступа](../azure-monitor/visualize/workbooks-access-control.md).

>[!NOTE]
>Удаление точек данных повлияет на соответствующие визуальные элементы в Azure Monitor для виртуальных рабочих столов Windows.

### <a name="log-analytics-settings"></a>Параметры Log Analytics

Ниже приведены некоторые рекомендации по оптимизации параметров Log Analytics для управления приемом данных.

- Используйте назначенную рабочую область Log Analytics для ресурсов виртуальных рабочих столов Windows, чтобы гарантировать, что Log Analytics собирает только счетчики производительности и события для виртуальных машин в развертывании виртуальных рабочих столов Windows.
- Настройте параметры хранилища Log Analytics для управления затратами. Вы можете уменьшить срок хранения, оценить, является ли Фиксированная ценовая категория более экономичной, или задать границы объема данных, которые можно принять, чтобы ограничить влияние неработоспособного развертывания. Дополнительные сведения см. в статье [Управление использованием и затратами для Azure Monitor журналов](../azure-monitor/platform/manage-cost-storage.md).

### <a name="remove-excess-data"></a>Удалить лишние данные

Наша конфигурация по умолчанию — это единственный набор данных, рекомендуемый для Azure Monitor для виртуальных рабочих столов Windows. Вы всегда можете добавить дополнительные точки данных и просмотреть их в окне Диагностика узлов: обозреватель узлов или создать пользовательские диаграммы для них, однако добавленные данные увеличивают Log Analytics стоимость. Их можно удалить для экономии затрат.

### <a name="measure-and-manage-your-performance-counter-data"></a>Измерение и управление данными счетчиков производительности

Истинные затраты на мониторинг будут зависеть от размера, использования и работоспособности вашей среды. Чтобы понять, как измерять прием данных в рабочей области Log Analytics, см. раздел [Основные сведения о принятом томе данных журнала](../azure-monitor/logs/manage-cost-storage.md#understanding-ingested-data-volume).

Счетчики производительности, используемые узлами сеансов, вероятно, являются самым большим источником принимаемых данных для Azure Monitor для виртуальных рабочих столов Windows. Следующий пользовательский шаблон запроса для Log Analytics рабочей области может вести мониторинг частоты и мегабайтов, принимаемых для счетчика производительности за последний день:

```azure
let WVDHosts = dynamic(['Host1.MyCompany.com', 'Host2.MyCompany.com']);
Perf
| where TimeGenerated > ago(1d)
| where Computer in (WVDHosts)
| extend PerfCounter = strcat(ObjectName, ":", CounterName)
| summarize Records = count(TimeGenerated), InstanceNames = dcount(InstanceName), Bytes=sum(_BilledSize) by PerfCounter
| extend Billed_MBytes = Bytes / (1024 * 1024), BytesPerRecord = Bytes / Records
| sort by Records desc
```

>[!NOTE]
>Обязательно замените значения заполнителей шаблона значениями, используемыми в вашей среде, в противном случае запрос не будет работать.

В этом запросе будут показаны все счетчики производительности, включенные в среде, а не только значения по умолчанию для Azure Monitor для виртуальных рабочих столов Windows. Эти сведения помогут вам понять, в каких областях следует ориентироваться, чтобы снизить затраты, например уменьшить частоту счетчика или полностью удалить ее.

Вы также можете уменьшить затраты, удалив счетчики производительности. Чтобы узнать, как удалить счетчики производительности или изменить существующие счетчики, чтобы уменьшить их частоту, см. раздел [Настройка счетчиков производительности](../azure-monitor/platform/data-sources-performance-counters.md#configuring-performance-counters).

### <a name="manage-windows-event-logs"></a>Управление журналами событий Windows

События Windows вряд ли поступают в результате пикового приема данных, когда все узлы работоспособны. Неработоспособное основное приложение может увеличить количество событий, отправляемых в журнал, но эти сведения могут быть критически важными для устранения проблем узла. Рекомендуется сохранить их. Дополнительные сведения об управлении журналами событий Windows см. в разделе [Настройка журналов событий Windows](../azure-monitor/agents/data-sources-windows-events.md#configuring-windows-event-logs).

### <a name="manage-diagnostics"></a>Управление диагностикой

Диагностика виртуальных рабочих столов Windows должна быть меньше 1% затрат на хранение данных, поэтому мы не рекомендуем их удалять. Для управления диагностикой виртуальных рабочих столов Windows [используйте log Analytics для компонента диагностики](diagnostics-log-analytics.md).

## <a name="next-steps"></a>Дальнейшие шаги

Дополнительные сведения о Azure Monitor для виртуальных рабочих столов Windows см. в следующих статьях:

- [Используйте Azure Monitor для виртуальных рабочих столов Windows, чтобы отслеживать развертывание](azure-monitor.md).
- Используйте [Глоссарий](azure-monitor-glossary.md) для получения дополнительных сведений о терминах и концепциях.
- Если у вас возникла проблема, ознакомьтесь с нашим [руководством по устранению неполадок](troubleshoot-azure-monitor.md) .
- Ознакомьтесь с [оценкой использования и оценочными затратами в Azure Monitor](../azure-monitor/usage-estimated-costs.md) , чтобы узнать больше об управлении затратами на мониторинг.
