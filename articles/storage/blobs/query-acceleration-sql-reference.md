---
title: Справочник по языку SQL для ускорения запросов
titleSuffix: Azure Storage
description: Узнайте, как использовать синтаксис SQL для ускорения запросов.
services: storage
author: normesta
ms.service: storage
ms.topic: conceptual
ms.date: 09/09/2020
ms.author: normesta
ms.subservice: data-lake-storage-gen2
ms.reviewer: ereilebr
ms.openlocfilehash: 2eda67e377a3b61e696e732b916d788c00a18eae
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "95908784"
---
# <a name="query-acceleration-sql-language-reference"></a>Справочник по языку SQL для ускорения запросов

Ускорение запросов поддерживает язык ANSI, аналогичный SQL, для выражения запросов к содержимому большого двоичного объекта.  Диалект SQL для ускорения запросов — это подмножество ANSI SQL с ограниченным набором поддерживаемых типов данных, операторов и т. д., но оно также расширяется в стандарте ANSI SQL для поддержки запросов к иерархическим форматам данных, таким как JSON. 

## <a name="select-syntax"></a>Выбор синтаксиса

Единственной инструкцией SQL, поддерживаемой ускорением запросов, является инструкция SELECT. В этом примере возвращается каждая строка, для которой выражение возвращает значение true.

```sql
SELECT * FROM table [WHERE expression] [LIMIT limit]
```

Для данных в формате CSV *Таблица* должна иметь формат `BlobStorage` .  Это означает, что запрос будет выполняться для любого большого двоичного объекта, указанного в вызове функции RESTFUL.
Для данных в формате JSON *Таблица* является "дескриптором таблицы".   См. раздел [табличные дескрипторы](#table-descriptors) этой статьи.

В следующем примере для каждой строки, для которой *выражение* WHERE возвращает значение true, эта инструкция вернет новую строку, созданную на основе вычисления каждого выражения проекции.


```sql
SELECT expression [, expression …] FROM table [WHERE expression] [LIMIT limit]
```

В следующем примере возвращается статистическое вычисление (например, среднее значение конкретного столбца) для каждой строки, для которой *выражение* возвращает значение true. 

```sql
SELECT aggregate_expression FROM table [WHERE expression] [LIMIT limit]
```

В следующем примере возвращаются подходящие смещения для разделения большого двоичного объекта в формате CSV.  См. раздел [sys. Split](#sys-split) этой статьи.

```sql
SELECT sys.split(split_size)FROM BlobStorage
```

<a id="data-types"></a>

## <a name="data-types"></a>Типы данных

|Тип данных|Описание|
|---------|-------------------------------------------|
|INT      |64-разрядное целое число со знаком.                     |
|FLOAT    |64-разрядная ("двойная точность") с плавающей запятой.|
|STRING   |Строка переменной длины в Юникоде.            |
|timestamp|Момент времени.                           |
|BOOLEAN  |True или False.                             |

При чтении значений из данных в формате CSV все значения считываются как строки.  Строковые значения могут быть преобразованы в другие типы с помощью выражений ПРИВЕДЕНия.  Значения могут быть неявно приведены к другим типам в зависимости от контекста. Дополнительные сведения см. в разделе [приоритет типов данных (Transact-SQL)](/sql/t-sql/data-types/data-type-precedence-transact-sql).

## <a name="expressions"></a>Выражения

### <a name="referencing-fields"></a>Ссылки на поля

Для данных в формате JSON или данных в формате CSV со строкой заголовка поля могут ссылаться по имени.  Имена полей можно заключать в кавычки или без кавычек. Заключенные в кавычки имена полей заключаются в двойные кавычки ("), могут содержать пробелы и чувствительны к регистру.  В именах полей без кавычек регистр не учитывается и не может содержать специальные символы.

В форматированных CSV-данных поля также могут ссылаться по порядковому номеру с префиксом символа подчеркивания (_).  Например, на первое поле можно ссылаться как на _1, либо на одиннадцатое поле можно ссылаться как на _11.  Ссылки на поля по порядковому номеру удобно использовать для данных в формате CSV, которые не содержат строки заголовка. в этом случае единственный способ ссылки на конкретное поле — по порядковому номеру.

### <a name="operators"></a>Операторы

Поддерживаются следующие стандартные операторы SQL:

|Оператор|Описание|
|--|--|
|[=](/sql/t-sql/language-elements/equals-transact-sql)    |Проверяет равенство двух выражений (оператор сравнения).|
|[!=](/sql/t-sql/language-elements/not-equal-to-transact-sql-exclamation)    |Проверяет неравенство одного выражения другому (оператор сравнения).|
|[<>](/sql/t-sql/language-elements/not-equal-to-transact-sql-traditional)    |Сравнивает два выражения для неравенства (оператор сравнения).|
|[<](/sql/t-sql/language-elements/less-than-transact-sql)    |Сравнивает два выражения для меньшего (оператора сравнения).|
|[<=](/sql/t-sql/language-elements/less-than-or-equal-to-transact-sql)    |Сравнивает два выражения на наличие меньшего или равного (оператора сравнения).|
|[>](/sql/t-sql/language-elements/greater-than-transact-sql)    |Сравнивает два выражения для оператора "больше" (оператор сравнения). |
|[>=](/sql/t-sql/language-elements/greater-than-or-equal-to-transact-sql)    |Сравнивает два выражения на верность того, больше или равно одно выражение другому (оператор сравнения).|
|[+](/sql/t-sql/language-elements/add-transact-sql)    |складывает два числа. С помощью этого арифметического оператора сложения можно также прибавлять число дней к дате.|
|[-](/sql/t-sql/language-elements/subtract-transact-sql)    |Вычитает одно число из другого (оператор арифметического вычитания). |
|[/](/sql/t-sql/language-elements/divide-transact-sql)    |Выполняет деление одного числа на другое (арифметический оператор деления).|
|[*](/sql/t-sql/language-elements/multiply-transact-sql)    |Умножает два выражения (арифметический оператор умножения).|
|[%](/sql/t-sql/language-elements/modulo-transact-sql)    |Возвращает остаток от деления одного числа на другое.|
|[AND](/sql/t-sql/language-elements/bitwise-and-transact-sql)    |Выполняет побитовую логическую операцию «И» между двумя целочисленными значениями.|
|[OR](/sql/t-sql/language-elements/bitwise-or-transact-sql)    |Выполняет побитовую логическую операцию или между двумя указанными целочисленными значениями, преобразованными в двоичные выражения в инструкциях Transact-SQL.|
|[NOT](/sql/t-sql/language-elements/not-transact-sql)    |Инвертирует входное логическое значение.|
|[CAST](/sql/t-sql/functions/cast-and-convert-transact-sql)    |Преобразует выражение из одного типа данных в другой.|
|[BETWEEN](/sql/t-sql/language-elements/between-transact-sql)    |Определяет диапазон для проверки.|
|[IN](/sql/t-sql/language-elements/in-transact-sql)    |Определяет, совпадает ли указанное значение с одним из значений, содержащихся во вложенном запросе или списке.|
|[NULLIF](/sql/t-sql/language-elements/nullif-transact-sql)    |Возвращает значение NULL, если два указанных выражения равны.|
|[COALESCE](/sql/t-sql/language-elements/coalesce-transact-sql)    |Вычисляет аргументы по порядку и возвращает текущее значение первого выражения, которое изначально не имеет значения NULL.|

Если типы данных слева и справа от оператора различаются, автоматическое преобразование будет выполняться в соответствии с указанными здесь правилами: [приоритет типов данных (Transact-SQL)](/sql/t-sql/data-types/data-type-precedence-transact-sql).

Язык SQL с ускорением запросов поддерживает только небольшое подмножество типов данных, обсуждаемых в этой статье.  См. раздел [типы данных](#data-types) этой статьи.

### <a name="casts"></a>Приведения

Язык SQL с ускорением запросов поддерживает оператор CAST в соответствии с правилами, приведенными здесь: [Преобразование типов данных (ядро СУБД)](/sql/t-sql/data-types/data-type-conversion-database-engine).  

Язык SQL с ускорением запросов поддерживает только неограниченное подмножество типов данных, обсуждаемых в этой статье.  См. раздел [типы данных](#data-types) этой статьи.

### <a name="string-functions"></a>Строковые функции

Язык SQL для ускорения запросов поддерживает следующие стандартные строковые функции SQL:

|Компонент|Описание|
|--|--|
|CHAR_LENGTH    | Возвращает длину в символах строкового выражения, если строковое выражение имеет символьный тип данных; в противном случае возвращает длину строкового выражения в байтах (наименьшее целое число не меньше числа бит, деленного на 8). (Эта функция аналогична функции CHARACTER_LENGTH.)|
|CHARACTER_LENGTH    |Возвращает длину в символах строкового выражения, если строковое выражение имеет символьный тип данных; в противном случае возвращает длину строкового выражения в байтах (наименьшее целое число не меньше числа бит, деленного на 8). (Эта функция аналогична функции CHAR_LENGTH|
|[LOWER](/sql/t-sql/functions/lower-transact-sql)    |Возвращает символьное выражение после преобразования символов верхнего регистра в символы нижнего регистра.|
|[UPPER](/sql/t-sql/functions/upper-transact-sql)    |Возвращает символьное выражение, в котором символы нижнего регистра преобразованы в символы верхнего регистра.|
|[SUBSTRING](/sql/t-sql/functions/substring-transact-sql)    |Возвращает часть символьного, двоичного, текстового или графического выражения в SQL Server.|
|[TRIM](/sql/t-sql/functions/trim-transact-sql)    |Удаляет символ пробела (32) или другие указанные символы из начала и конца строки.|
|LEADING    |Описание|
|TRAILING    |Описание|

Вот несколько примеров:

|Функция|Пример|Результат|
|---|---|---|
|CHARACTER_LENGTH|``SELECT CHARACTER_LENGTH('abcdefg') from BlobStorage`` |``7``|
|CHAR_LENGTH|``SELECT CHAR_LENGTH(_1) from BlobStorage``|``1``|
|LOWER|``SELECT LOWER('AbCdEfG') from BlobStorage``|``abcdefg``|
|UPPER|``SELECT UPPER('AbCdEfG') from BlobStorage``|``ABCDEFG``|
|SUBSTRING|``SUBSTRING('123456789', 1, 5)``|``23456``|
|TRIM|``TRIM(BOTH '123' FROM '1112211Microsoft22211122')``|``Microsoft``|

### <a name="date-functions"></a>Функции данных

Поддерживаются следующие стандартные функции даты SQL:

``DATE_ADD``, ``DATE_DIFF``, ``EXTRACT``, ``TO_STRING``, ``TO_TIMESTAMP``.

Сейчас мы преобразуем все [форматы даты стандартного IS08601](https://www.w3.org/TR/NOTE-datetime). 

#### <a name="date_add-function"></a>Функция DATE_ADD

Язык SQL для ускорения запросов поддерживает год, месяц, день, час, минуту, секунду для ``DATE_ADD`` функции.

Примеры:

"" SQL DATE_ADD (datepart, Quantity, timestamp) DATE_ADD ("Minute", 1, CAST ("2017-01-02T03:04:05.006 Z" в качестве метки времени)
```

#### DATE_DIFF function

The query acceleration SQL language supports year, month, day, hour, minute, second for the ``DATE_DIFF`` function.

```sql
DATE_DIFF(datepart, timestamp, timestamp)
DATE_DIFF('hour','2018-11-09T00:00+05:30','2018-11-09T01:00:23-08:00') 
```

#### <a name="extract-function"></a>ИЗВЛЕЧЬ функцию

Для функции извлечения, отличной от даты, поддерживаемой ``DATE_ADD`` функцией, язык SQL с ускорением запросов поддерживает timezone_hour и timezone_minute в качестве части даты.

Примеры:

```sql
EXTRACT(datepart FROM timestampstring)
EXTRACT(YEAR FROM '2010-01-01T')
```

#### <a name="to_string-function"></a>Функция TO_STRING

Примеры:

```sql
TO_STRING(TimeStamp , format)
TO_STRING(CAST('1969-07-20T20:18Z' AS TIMESTAMP),  'MMMM d, y')
```

В этой таблице описаны строки, которые можно использовать для указания формата выходных данных ``TO_STRING`` функции.

|Строка форматирования    |Выходные данные                               |
|-----------------|-------------------------------------|
|yy               |Год в формате 2 цифр — 1999 как "99"|
|да                |Год в формате 4 цифр               |
|гггг             |Год в формате 4 цифр               |
|M                |Месяц года — 1                    |
|ММ               |Нуль-го месяца — 01               |
|MMM              |Abbr. месяц года-Янв            |
|ММММ:             |Полный месяц — Май                      |
|d                |День месяца (1-31)                  |
|дд               |Нулевой день месяца (01-31)     |
|а                |AM или PM                             |
|h                |Час дня (1-12)                   |
|hh               |Нулевые нули в днях OD (01-12)     |
|H                |Час дня (0-23)                   |
|HH               |Нулевой заполняющий час дня (00-23)      |
|m                |Минута часа (0-59)                |
|ММ               |Нулевая заданная минута (00-59)           |
|s                |Секунд (0-59)             |
|сс               |Обнуленные секунды (00-59)          |
|S                |Доля секунд (0,1-0.9)        |
|SS               |Доля секунд (0,01-0,99)      |
|SSS              |Доля секунд (0,001-0,999)    |
|X                |Смещение в часах                      |
|XX или XXXX       |Смещение в часах и минутах (+ 0430)  |
|XXX или XXXXX     |Смещение в часах и минутах (-07:00) |
|x                |Смещение в часах (7)                  |
|XX или XXXX       |Смещение в часах и минутах (+ 0530)    |
|Xxx или XXXXX     |Смещение в часах и минутах (+ 05:30)   |

#### <a name="to_timestamp-function"></a>Функция TO_TIMESTAMP

Поддерживаются только форматы IS08601.

Примеры:

```sql
TO_TIMESTAMP(string)
TO_TIMESTAMP('2007T')
```

> [!NOTE]
> Можно также использовать ``UTCNOW`` функцию для получения системного времени.


## <a name="aggregate-expressions"></a>Статистические выражения

Инструкция SELECT может содержать либо одно, либо несколько выражений проекции или одно статистическое выражение.  Поддерживаются следующие статистические выражения:

|Выражение|Описание|
|--|--|
|[COUNT ( \* )](https://docs.microsoft.com/sql/t-sql/functions/count-transact-sql)    |Возвращает количество записей, соответствующих выражению предиката.|
|[COUNT (выражение)](https://docs.microsoft.com/sql/t-sql/functions/count-transact-sql)    |Возвращает число записей, для которых выражение не имеет значение null.|
|[AVERAGE (выражение)](https://docs.microsoft.com/sql/t-sql/functions/avg-transact-sql)    |Возвращает среднее значение выражения, отличное от NULL.|
|[MIN (выражение)](https://docs.microsoft.com/sql/t-sql/functions/min-transact-sql)    |Возвращает минимальное значение выражения, отличное от NULL.|
|[MAX (выражение](https://docs.microsoft.com/sql/t-sql/functions/max-transact-sql)    |Возвращает максимальное значение выражения, отличное от NULL.|
|[SUM (выражение)](https://docs.microsoft.com/sql/t-sql/functions/sum-transact-sql)    |Возвращает сумму всех значений выражения, отличных от NULL.|

### <a name="missing"></a>ОТСУТСТВУЮЩ

``IS MISSING``Оператор является единственным нестандартным, поддерживаемым языком SQL для ускорения запросов.  Если в данных JSON отсутствует поле из определенной входной записи, то поле выражения ``IS MISSING`` будет иметь логическое значение true.

<a id="table-descriptors"></a>

## <a name="table-descriptors"></a>Дескрипторы таблиц

Для данных CSV имя таблицы всегда равно `BlobStorage` .  Пример:

```sql
SELECT * FROM BlobStorage
```

Для данных JSON доступны дополнительные параметры.

```sql
SELECT * FROM BlobStorage[*].path
```

Это позволяет выполнять запросы к подмножествам данных JSON.

Для запросов JSON можно указать путь в части предложения FROM. Эти пути могут помочь при анализе подмножества данных JSON. Эти пути могут ссылаться на значения массива и объекта JSON.

Давайте рассмотрим пример, чтобы понять это более подробно.

Вот пример данных:

```json
{
  "id": 1,
  "name": "mouse",
  "price": 12.5,
  "tags": [
    "wireless",
    "accessory"
  ],
  "dimensions": {
    "length": 3,
    "width": 2,
    "height": 2
  },
  "weight": 0.2,
  "warehouses": [
    {
      "latitude": 41.8,
      "longitude": -87.6
    }
  ]
}
```

Возможно, вас интересует только `warehouses` объект JSON из указанных выше данных. `warehouses`Объект является типом массива JSON, поэтому его можно упомянуть в предложении FROM. Пример запроса может выглядеть примерно так.

```sql
SELECT latitude FROM BlobStorage[*].warehouses[*]
```

Запрос получает все поля, но выбирает только широту.

Если требуется получить доступ только к `dimensions` значению объекта JSON, можно использовать ссылку на этот объект в запросе. Пример:

```sql
SELECT length FROM BlobStorage[*].dimensions
```

Это также ограничивает доступ к членам `dimensions` объекта. Если требуется получить доступ к другим членам полей JSON и внутренним значениям объектов JSON, можно использовать запросы, как показано в следующем примере:

```sql
SELECT weight,warehouses[0].longitude,id,tags[1] FROM BlobStorage[*]
```

> [!NOTE]
> Блобстораже и Блобстораже [ \* ] оба ссылаются на весь объект. Однако если в предложении FROM есть путь, необходимо использовать Блобстораже [ \* ]. Path.

<a id="sys-split"></a>

## <a name="syssplit"></a>Sys. Split

Это специальная форма инструкции SELECT, которая доступна только для данных в формате CSV.

```sql
SELECT sys.split(split_size)FROM BlobStorage
```

Используйте эту инструкцию в тех случаях, когда необходимо загрузить и затем обработать записи данных в формате CSV в пакетах. Таким образом, можно обрабатывать записи параллельно, вместо того чтобы загружать все записи за один раз. Эта инструкция не возвращает записи из CSV-файла. Вместо этого он возвращает коллекцию размеров пакетов. Затем можно использовать каждый размер пакета для получения пакета записей данных. 

Используйте параметр *split_size* , чтобы указать число байтов, которое должен содержать каждый пакет. Например, если вы хотите обрабатывать только 10 МБ данных одновременно, то оператор будет выглядеть следующим образом: `SELECT sys.split(10485760)FROM BlobStorage` так как 10 МБ равно 10 485 760 байт. Каждый пакет будет содержать столько записей, сколько может уместиться в 10 МБ. 

В большинстве случаев размер каждого пакета будет немного выше указанного числа. Это обусловлено тем, что пакет не может содержать частичную запись. Если последняя запись в пакете начинается до окончания порогового значения, пакет будет больше, чтобы он мог содержать всю запись. Размер последнего пакета, скорее всего, будет меньше указанного размера.

>[!NOTE]
> Значение split_size должно быть не менее 10 МБ (10485760).

## <a name="see-also"></a>См. также раздел

- [Ускорение запросов Azure Data Lake Storage](data-lake-storage-query-acceleration.md)
- [Фильтрация данных с помощью ускорения запросов Azure Data Lake Storage](data-lake-storage-query-acceleration-how-to.md)