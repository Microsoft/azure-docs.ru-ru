---
title: Канал изменений в хранилище BLOB-объектов Azure | Документация Майкрософт
description: Сведения о журналах каналов изменений в хранилище BLOB-объектов Azure и их использовании.
author: normesta
ms.author: normesta
ms.date: 02/08/2021
ms.topic: how-to
ms.service: storage
ms.subservice: blobs
ms.reviewer: sadodd
ms.openlocfilehash: 1366f24ec3bd35ec23d5bf0879fced367c9f6a45
ms.sourcegitcommit: b0557848d0ad9b74bf293217862525d08fe0fc1d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/07/2021
ms.locfileid: "106552451"
---
# <a name="change-feed-support-in-azure-blob-storage"></a>Поддержка канала изменений в хранилище BLOB-объектов Azure

Канал изменений предназначен для предоставления журналов транзакций всех изменений, происходящих в больших двоичных объектах и метаданных больших двоичных объектов в вашей учетной записи хранения. Канал изменений предоставляет **упорядоченный**, **гарантированный**, **устойчивый**, **неизменяемый** журнал этих изменений, предназначенный **только для чтения**. Клиентские приложения могут считывать эти журналы в любое время как в потоковой передаче, так и в пакетном режиме. Канал изменений позволяет создавать эффективные и масштабируемые решения, которые обрабатывают события изменения, происходящие в учетной записи хранения BLOB-объектов, с низкой стоимостью.

[!INCLUDE [storage-data-lake-gen2-support](../../../includes/storage-data-lake-gen2-support.md)]

## <a name="how-the-change-feed-works"></a>Как работает канал изменений

Канал изменений хранится в виде [больших двоичных объектов](/rest/api/storageservices/understanding-block-blobs--append-blobs--and-page-blobs) в специальном контейнере в учетной записи хранения со стандартной ценой [больших двоичных объектов](https://azure.microsoft.com/pricing/details/storage/blobs/). Вы можете контролировать срок хранения этих файлов в соответствии с вашими требованиями (см. [условия](#conditions) текущего выпуска). События изменения добавляются в канал изменений в виде записей в спецификации формата [Apache Avro](https://avro.apache.org/docs/1.8.2/spec.html): компактный, быстрый двоичный формат, обеспечивающий широкие возможности структуры данных со встроенной схемой. Этот формат широко используется в экосистеме Hadoop, Stream Analytics и фабрике данных Azure.

Эти журналы можно обрабатывать асинхронно, постепенно или полностью. Любое количество клиентских приложений может независимо считывать информацию канала изменений, параллельно и в собственном темпе. Такие приложения аналитики, как [Apache Drill](https://drill.apache.org/docs/querying-avro-files/) или [Apache Spark](https://spark.apache.org/docs/latest/sql-data-sources-avro.html), могут использовать журналы непосредственно в качестве файлов Avro, что позволяет обрабатывать их с низкой стоимостью, с высокой пропускной способностью и без необходимости писать пользовательское приложение.

На следующей схеме показано, как записи добавляются в канал изменений.

:::image type="content" source="media/storage-blob-change-feed/change-feed-diagram.png" alt-text="Диаграмма, показывающая, как работает канал изменений, чтобы предоставить упорядоченный журнал изменений в больших двоичных объектах":::

Поддержка канала изменений хорошо подходит для сценариев с обработкой данных на объектах, которые были изменены. Примеры операций, которые могут выполнить приложения, приведены ниже.

  - Обновление вторичного индекса, синхронизация с кэшем, поисковой системой или любыми другими сценариями управления содержимым.
  
  - Извлечение аналитических данных и метрик бизнес-аналитики с учетом изменений, происходящих с объектами в потоковом или пакетном режиме.
  
  - Хранение и анализ изменений в объектах за любой период времени для того, чтобы обеспечить безопасность, соблюдение нормативных требований или аналитику для управления корпоративными данными.

  - Создание решений для резервного копирования, зеркального отображения или репликации состояния объектов в учетной записи для аварийного управления или соблюдения нормативных требований.

  - Создание подключенных конвейеров приложений, реагирующих на события изменения или планирование выполнений на основе созданных или измененных объектов.
  
Канал изменений — это необходимый компонент для [репликации объектов](object-replication-overview.md) и [восстановления на момент времени для блочных BLOB-объектов](point-in-time-restore-overview.md).

> [!NOTE]
> Канал изменений предоставляет устойчивую упорядоченную модель журнала изменений, происходящих в большом двоичном объекте. Изменения записываются и становятся доступными в журнале канала изменений в течение нескольких минут после изменения. Если приложение должно реагировать на события гораздо быстрее, попробуйте использовать [события хранилища BLOB-объектов](storage-blob-event-overview.md). [События хранилища BLOB-объектов](storage-blob-event-overview.md) предоставляют одноразовые события в реальном времени, которые позволяют функциям и приложениям Azure быстро реагировать на изменения, происходящие в большом двоичном объекте. 

## <a name="enable-and-disable-the-change-feed"></a>Включение и отключение канала изменений

Необходимо включить канал изменений в учетной записи хранения, чтобы начать считывание и запись изменений. Отключите канал изменений для отмены записи изменений. Вы можете включать и отключать изменения с помощью шаблонов Azure Resource Manager на портале или в PowerShell.

Ниже приведены некоторые моменты, которые следует учитывать при включении канала изменений.

- Существует только один канал изменений для службы BLOB-объектов в каждой учетной записи хранения, и он хранится в контейнере **$blobchangefeed**.

- Создание, обновление и удаление изменений фиксируются только на уровне службы BLOB-объектов.

- Канал изменений фиксирует *все* изменения для всех доступных событий, происходящих в учетной записи. При необходимости клиентские приложения могут отфильтровывать типы событий. (См. [условия](#conditions) текущего выпуска.)

- Включить канал изменений могут только учетные записи GPv2 и хранилища BLOB-объектов. Учетные записи BlockBlobStorage класса "Premium" и учетные записи с включенным иерархическим пространством имен сейчас не поддерживаются. Учетные записи хранения GPv1 не поддерживаются, но их можно обновить до GPv2 без простоев. Дополнительные сведения см. в статье [Обновление до учетной записи хранения GPv2](../common/storage-account-upgrade.md).

### <a name="portal"></a>[Портал](#tab/azure-portal)

Чтобы включить канал изменений для BLOB-объектов в учетной записи хранения с помощью портала Azure, выполните следующее.

1. Выберите свою учетную запись хранения на [портале Azure](https://portal.azure.com/).
1. Перейдите к параметру **Защита данных** в разделе **Служба BLOB-объектов**.
1. В разделе **Отслеживание** выберите **Включить канал изменений BLOB-объекта**.
1. Нажмите кнопку **Сохранить**, чтобы подтвердить свои параметры защиты данных.

    :::image type="content" source="media/storage-blob-change-feed/change-feed-enable-portal.png" alt-text="Снимок экрана, показывающий, как включить канал изменений в портале Azure":::

### <a name="powershell"></a>[PowerShell](#tab/azure-powershell)

Чтобы включить канал изменений с помощью PowerShell, выполните действия ниже.

1. Установите последнюю версию PowershellGet.

   ```powershell
   Install-Module PowerShellGet –Repository PSGallery –Force
   ```

2. Закройте, а затем снова откройте консоль PowerShell.

3. Установите версию 2.5.0 или более позднюю версию модуля **Az.Storage**.

   ```powershell
   Install-Module Az.Storage –Repository PSGallery -RequiredVersion 2.5.0 –AllowClobber –Force
   ```

4. Чтобы выполнить проверку подлинности, войдите в подписку Azure с помощью команды `Connect-AzAccount` и следуйте инструкциям на экране.

   ```powershell
   Connect-AzAccount
   ```

5. Включите канал изменений для учетной записи хранения.

   ```powershell
   Update-AzStorageBlobServiceProperty -EnableChangeFeed $true
   ```

### <a name="template"></a>[Шаблон](#tab/template)
Используйте шаблон Azure Resource Manager, чтобы включить канал изменений в существующей учетной записи хранения с помощью портала Azure.

1. На портале Azure щелкните **Создать ресурс**.

2. В строке **Поиск в Marketplace** введите **развертывание шаблона** и нажмите клавишу **ВВОД**.

3. Выберите **[Развернуть настраиваемый шаблон](https://portal.azure.com/#create/Microsoft.Template)** , а затем в редакторе выберите **Создать собственный шаблон**.

4. В редакторе шаблонов вставьте следующий код JSON. Замените заполнитель `<accountName>` именем вашей учетной записи хранения.

   ```json
   {
       "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
       "contentVersion": "1.0.0.0",
       "parameters": {},
       "variables": {},
       "resources": [{
           "type": "Microsoft.Storage/storageAccounts/blobServices",
           "apiVersion": "2019-04-01",
           "name": "<accountName>/default",
           "properties": {
               "changeFeed": {
                   "enabled": true
               }
           } 
        }]
   }
   ```
    
5. Нажмите кнопку **Сохранить**, укажите группу ресурсов учетной записи, а затем нажмите кнопку **Покупка**, чтобы развернуть шаблон и включить канал изменений.

---

## <a name="consume-the-change-feed"></a>Чтение канала изменений

Канал изменений создает несколько файлов метаданных и журналов. Эти файлы находятся в контейнере **$blobchangefeed** учетной записи хранения. 

> [!NOTE]
> В текущем выпуске контейнер $blobchangefeed видим только в портале Azure, но не отображается в Обозревателе службы хранилища Azure. В настоящее время невозможно увидеть контейнер $blobchangefeed при вызове API ListContainers, но вы можете вызвать API ListBlobs непосредственно в контейнере для просмотра больших двоичных объектов

Клиентские приложения могут использовать канал изменений с помощью библиотеки обработчика канала изменения больших двоичных объектов, предоставляемой из пакета SDK для обработчика канала изменений. 

См. статью [Обработка журналов канала изменений в хранилище BLOB-объектов Azure](storage-blob-change-feed-how-to.md).

## <a name="understand-change-feed-organization"></a>Общие сведения об организации канала изменений

<a id="segment-index"></a>

### <a name="segments"></a>Сегменты

Канал изменений — это журнал изменений, который организован в **почасовые** *сегменты*, но пополняется и обновляется каждые несколько минут. Сегменты создаются только при наличии событий изменения большого двоичного объекта, произошедших за этот час. Это позволяет клиентскому приложению использовать изменения, происходящие в определенные диапазоны времени, без необходимости выполнять поиск по всему журналу. Дополнительные сведения см. на [странице со спецификациями](#specifications).

Доступный ежечасный сегмент канала изменений описывается в файле манифеста, который указывает пути к файлам канала изменений для этого сегмента. В списке `$blobchangefeed/idx/segments/` виртуальных каталогов показаны сегменты, упорядоченные по времени. Путь сегмента описывает начало почасового диапазона времени, который представляет сегмент. Этот список можно использовать для фильтрации сегментов интересующих вас журналов.

```text
Name                                                                    Blob Type    Blob Tier      Length  Content Type    
----------------------------------------------------------------------  -----------  -----------  --------  ----------------
$blobchangefeed/idx/segments/1601/01/01/0000/meta.json                  BlockBlob                      584  application/json
$blobchangefeed/idx/segments/2019/02/22/1810/meta.json                  BlockBlob                      584  application/json
$blobchangefeed/idx/segments/2019/02/22/1910/meta.json                  BlockBlob                      584  application/json
$blobchangefeed/idx/segments/2019/02/23/0110/meta.json                  BlockBlob                      584  application/json
```

> [!NOTE]
> `$blobchangefeed/idx/segments/1601/01/01/0000/meta.json` автоматически создается при включении канала изменений. Этот файл можно игнорировать. Это всегда пустой файл инициализации. 

В файле манифеста сегмента (`meta.json`) показан путь к файлам канала изменений для этого сегмента в свойстве `chunkFilePaths`. Ниже приведен пример сегмента файла манифеста.

```json
{
    "version": 0,
    "begin": "2019-02-22T18:10:00.000Z",
    "intervalSecs": 3600,
    "status": "Finalized",
    "config": {
        "version": 0,
        "configVersionEtag": "0x8d698f0fba563db",
        "numShards": 2,
        "recordsFormat": "avro",
        "formatSchemaVersion": 1,
        "shardDistFnVersion": 1
    },
    "chunkFilePaths": [
        "$blobchangefeed/log/00/2019/02/22/1810/",
        "$blobchangefeed/log/01/2019/02/22/1810/"
    ],
    "storageDiagnostics": {
        "version": 0,
        "lastModifiedTime": "2019-02-22T18:11:01.187Z",
        "data": {
            "aid": "55e507bf-8006-0000-00d9-ca346706b70c"
        }
    }
}
```

> [!NOTE]
> Контейнер `$blobchangefeed` отображается только после включения функции канала изменений в учетной записи. После включения канала изменений необходимо подождать несколько минут, прежде чем можно будет перечислить большие двоичные объекты в контейнере. 

<a id="log-files"></a>

### <a name="change-event-records"></a>Изменение записей событий

Файлы канала изменений содержат ряд записей о событиях изменения. Каждая запись события изменения соответствует одному изменению отдельного большого двоичного объекта. Записи выводятся в последовательность и записываются в файл, используя спецификацию формата [Apache Avro](https://avro.apache.org/docs/1.8.2/spec.html). Записи можно считывать с помощью спецификации формата файла Avro. Существует несколько библиотек, которые можно использовать для обработки файлов в этом формате.

Файлы канала изменений хранятся в виртуальном каталоге `$blobchangefeed/log/` как [добавочные BLOB-объекты](/rest/api/storageservices/understanding-block-blobs--append-blobs--and-page-blobs#about-append-blobs). Первый файл канала изменений в каждом пути будет содержать `00000` в имени файла (например, `00000.avro`). Имя каждого последующего файла журнала, добавляемого к этому пути, увеличится на 1 (например, `00001.avro`).

В записях канала изменений фиксируются следующие типы событий.
- BlobCreated
- BlobDeleted
- BlobPropertiesUpdated
- BlobSnapshotCreated

Ниже приведен пример записи события изменения из файла канала изменений, преобразованного в JSON.

```json
{
     "schemaVersion": 1,
     "topic": "/subscriptions/dd40261b-437d-43d0-86cf-ef222b78fd15/resourceGroups/sadodd/providers/Microsoft.Storage/storageAccounts/mytestaccount",
     "subject": "/blobServices/default/containers/mytestcontainer/blobs/mytestblob",
     "eventType": "BlobCreated",
     "eventTime": "2019-02-22T18:12:01.079Z",
     "id": "55e5531f-8006-0000-00da-ca3467000000",
     "data": {
         "api": "PutBlob",
         "clientRequestId": "edf598f4-e501-4750-a3ba-9752bb22df39",
         "requestId": "00000000-0000-0000-0000-000000000000",
         "etag": "0x8D698F13DCB47F6",
         "contentType": "application/octet-stream",
         "contentLength": 128,
         "blobType": "BlockBlob",
         "url": "",
         "sequencer": "000000000000000100000000000000060000000000006d8a",
         "storageDiagnostics": {
             "bid": "11cda41c-13d8-49c9-b7b6-bc55c41b3e75",
             "seq": "(6,5614,28042,28038)",
             "sid": "591651bd-8eb3-c864-1001-fcd187be3efd"
         }
  }
}
```

Дополнительные описания каждого свойства см. в статье [Схема событий службы "Сетка событий Azure" для хранилища BLOB-объектов](../../event-grid/event-schema-blob-storage.md?toc=%2fazure%2fstorage%2fblobs%2ftoc.json#event-properties). События BlobPropertiesUpdated и BlobSnapshotCreated в настоящее время являются эксклюзивными для канала изменений и пока не поддерживаются для событий хранилища BLOB-объектов.

> [!NOTE]
> Файлы канала изменений для сегмента не сразу появляются после создания сегмента. Продолжительность задержки находится в пределах обычного интервала задержки публикации канала изменений, который находится в течение нескольких минут после изменения.

<a id="specifications"></a>

## <a name="specifications"></a>Спецификации

- Записи о событиях изменения добавляются только в канал изменений. После добавления этих записей они являются неизменяемыми, а позиция записи — стабильной. Клиентские приложения могут сохранять собственную контрольную точку в позиции чтения канала изменений.

- Записи о событиях изменения добавляются в течение нескольких минут после изменения. Клиентские приложения могут использовать записи по мере их добавления в потоковый доступ или целиком, когда возникнет необходимость.

- Записи событий изменения упорядочиваются по порядку изменения **на большой двоичный объект**. Порядок изменений в больших двоичных объектах не определен в хранилище BLOB-объектов Azure. Все изменения в предыдущем сегменте произошли ранее изменений в последующем сегменте.

- Записи событий изменений сериализуются в файл журнала с помощью спецификации [Apache Avro 1.8.2](https://avro.apache.org/docs/1.8.2/spec.html).

- Записи событий изменения, для которых в параметре `eventType` задано значение `Control`, являются внутренними системными записями и не отражают изменений объектов в вашей учетной записи. Эти записи можно спокойно игнорировать.

- Значения в `storageDiagnostics` контейнере свойств предназначены только для внутреннего использования и не предназначены для использования приложением. Приложения не должны иметь контрактную зависимость от этих данных. Эти свойства можно спокойно игнорировать.

- Время, представленное сегментом, **приблизительно**, с учетом пределов в 15 минут. Таким образом, чтобы обеспечить потребление всех записей в течение заданного времени, следует использовать последовательно сегменты предыдущего и следующего часов.

- Каждый сегмент может иметь разное количество `chunkFilePaths` из-за внутреннего секционирования потока журнала для управления пропускной способностью публикации. Файлы журналов в каждом из `chunkFilePath` гарантированно содержат взаимоисключающие большие двоичные объекты, и их можно считывать и обрабатывать параллельно, не нарушая порядок изменений на большой двоичный объект во время итерации.

- Сначала сегменты имеют состояние `Publishing`. После завершения добавления записей в сегмент он будет иметь состояние `Finalized`. Файлы журнала в любом сегменте, который имеет дату после даты свойства `LastConsumable` в файле `$blobchangefeed/meta/Segments.json`, не должны использоваться приложением. Ниже приведен пример свойства `LastConsumable` в файле `$blobchangefeed/meta/Segments.json`.

```json
{
    "version": 0,
    "lastConsumable": "2019-02-23T01:10:00.000Z",
    "storageDiagnostics": {
        "version": 0,
        "lastModifiedTime": "2019-02-23T02:24:00.556Z",
        "data": {
            "aid": "55e551e3-8006-0000-00da-ca346706bfe4",
            "lfz": "2019-02-22T19:10:00.000Z"
        }
    }
}

```

<a id="conditions"></a>

## <a name="conditions-and-known-issues"></a>Ограничения и известные проблемы

В этом разделе описаны известные проблемы и условия в текущем выпуске канала изменений. 

- Записи событий изменения для любого отдельного изменения могут появиться в канале изменений несколько раз.
- Вы пока не можете управлять временем существования файлов журнала канала изменений, установив на них политику хранения на основе времени, и вы не сможете удалить большие двоичные объекты.
- Свойство `url` файла журнала в настоящее время всегда пусто.
- Свойство `LastConsumable` файла segments.json не содержит первый сегмент, финализованный каналом изменений. Эта проблема возникает только после финализации первого сегмента. Все последующие сегменты после первого часа будут без девиаций захвачены в свойстве `LastConsumable`.
- В настоящее время невозможно увидеть контейнер **$blobchangefeed** при вызове API ListContainers, и контейнер не отображается в портале Azure или Обозревателе службы хранилища. Содержимое можно просмотреть, вызвав API ListBlobs в контейнере $blobchangefeed напрямую.
- В учетных записях хранения, которые ранее инициировали [отработку отказа учетной записи](../common/storage-disaster-recovery-guidance.md), могут возникнуть проблемы с отображением файла журнала. Все последующие отработки отказа учетной записи также могут повлиять на файл журнала.

## <a name="faq"></a>Вопросы и ответы

### <a name="what-is-the-difference-between-change-feed-and-storage-analytics-logging"></a>В чем разница между каналом изменений и ведением журнала Аналитики Службы хранилища?
Журналы аналитики содержат записи всех операций чтения, записи, списка и удаления с успешными и неудачными запросами. Журналы аналитики лучше подходят, но их порядок не гарантируется.

Канал изменений — это решение, которое обеспечивает транзакционный журнал успешных мутаций или изменений вашей учетной записи, таких как создание, изменение и удаление больших двоичных объектов. Канал изменений гарантирует, что все события должны записываться и отображаться в порядке успешных изменений на большой двоичный объект, поэтому нет необходимости отфильтровать шум из огромного объема операций чтения или неудачных запросов. Канал изменений фундаментально спроектирован и оптимизирован для разработки приложений, требующих определенных гарантий.

### <a name="should-i-use-change-feed-or-storage-events"></a>Следует ли использовать канал изменений или события Службы хранилища?
Обе эти функции можно использовать, поскольку и канал изменений, и [события хранилища BLOB-объектов](storage-blob-event-overview.md) предоставляют те же сведения, что и гарантии надежности доставки. Основное различие заключается в значениях задержки, упорядочении и хранении записей событий. Канал изменений публикует записи в журнале в течение нескольких минут после изменения, а также гарантирует порядок операций изменения большого двоичного объекта. События хранилища отправляются в режиме реального времени и могут быть не упорядочены. События канала изменений хранятся в учетной записи хранения как стабильные журналы только для чтения с собственным заданным сроком хранения, а события хранилища являются временными для использования обработчиком событий, если они не сохранены явным образом. С помощью канала изменений любое количество приложений может применять журналы по своему усмотрению, используя API больших двоичных объектов или пакеты SDK. 

## <a name="next-steps"></a>Дальнейшие действия

- См. пример чтения канала изменений с помощью клиентского приложения .NET. См. статью [Обработка журналов канала изменений в хранилище BLOB-объектов Azure](storage-blob-change-feed-how-to.md).
- Узнайте, как реагировать на события в режиме реального времени. См. [Реагирование на события хранилища BLOB-объектов](storage-blob-event-overview.md)
- Сведения о ведении подробного журнала успешных и неудачных операций для всех запросов. См. [Ведение журнала Аналитики Службы хранилища Azure](../common/storage-analytics-logging.md)
