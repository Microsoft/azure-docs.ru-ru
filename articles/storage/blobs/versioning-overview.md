---
title: Управление версиями BLOB-объектов
titleSuffix: Azure Storage
description: Управление версиями хранилища BLOB-объектов автоматически сохраняет предыдущие версии объекта и определяет их с помощью меток времени. Вы можете восстановить предыдущие версии большого двоичного объекта, чтобы восстановить данные, если они были ошибочно изменены или удалены.
services: storage
author: tamram
ms.service: storage
ms.topic: conceptual
ms.date: 02/09/2021
ms.author: tamram
ms.subservice: blobs
ms.custom: devx-track-azurepowershell
ms.openlocfilehash: 692a820bea69071485a973a988ae91bd70b74f35
ms.sourcegitcommit: d4734bc680ea221ea80fdea67859d6d32241aefc
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/14/2021
ms.locfileid: "100380820"
---
# <a name="blob-versioning"></a>Управление версиями BLOB-объектов

Вы можете включить управление версиями хранилища BLOB-объектов, чтобы автоматически поддерживать предыдущие версии объекта.  Если управление версиями BLOB-объектов включено, можно восстановить более раннюю версию большого двоичного объекта, чтобы восстановить данные, если они ошибочно изменены или удалены.

Управление версиями BLOB-объектов включено в учетной записи хранения и применяется ко всем большим двоичным объектам в учетной записи хранения. После включения управления версиями BLOB-объектов для учетной записи хранения служба хранилища Azure автоматически сохраняет версии для каждого большого двоичного объекта в учетной записи хранения.

Корпорация Майкрософт рекомендует использовать управление версиями BLOB-объектов для поддержки более ранних версий большого двоичного объекта для обеспечения высокой защиты данных. По возможности используйте управление версиями больших двоичных объектов вместо моментальных снимков BLOB-объектов для поддержки предыдущих версий. Моментальные снимки больших двоичных объектов предоставляют аналогичные функциональные возможности в том, что они поддерживают более ранние версии большого двоичного объекта, но моментальные снимки должны поддерживаться приложением вручную.

Сведения о включении управления версиями BLOB-объектов см. в разделе [Включение управления версиями BLOB-объектов и управление ими](versioning-enable.md).

> [!IMPORTANT]
> Управление версиями BLOB-объектов не может помочь в восстановлении после случайного удаления учетной записи хранения или контейнера. Чтобы предотвратить случайное удаление учетной записи хранения, Настройте блокировку для ресурса учетной записи хранения. Дополнительные сведения о блокировке ресурсов Azure см. [в разделе Блокировка ресурсов для предотвращения непредвиденных изменений](../../azure-resource-manager/management/lock-resources.md). Чтобы защитить контейнеры от случайного удаления, настройте обратимое удаление контейнера для учетной записи хранения. Дополнительные сведения см. в статье [обратимое удаление для контейнеров (Предварительная версия)](soft-delete-container-overview.md).

[!INCLUDE [storage-data-lake-gen2-support](../../../includes/storage-data-lake-gen2-support.md)]

## <a name="how-blob-versioning-works"></a>Как работает управление версиями BLOB-объектов

Версия фиксирует состояние большого двоичного объекта в определенный момент времени. Если для учетной записи хранения включено управление версиями BLOB-объектов, служба хранилища Azure автоматически создает новую версию большого двоичного объекта каждый раз при изменении или удалении большого двоичного объекта.

При создании большого двоичного объекта с включенным управлением версиями новый большой двоичный объект является текущей версией большого двоичного объекта (или базового большого двоичного объекта). При последующем изменении этого большого двоичного объекта Служба хранилища Azure создает версию, которая фиксирует состояние большого двоичного объекта перед его изменением. Измененный большой двоичный объект станет новой текущей версией. Новая версия создается каждый раз при изменении большого двоичного объекта.

На следующей схеме показано, как создаются версии при операциях записи и удаления, а также о том, как предыдущая версия может быть повышена до текущей версии:

:::image type="content" source="media/versioning-overview/blob-versioning-diagram.png" alt-text="Диаграмма, показывающая, как работает управление версиями BLOB-объектов":::

Наличие большого количества версий на большой двоичный объект может увеличить задержку операций перечисления больших двоичных объектов. Корпорация Майкрософт рекомендует поддерживать менее 1000 версий на большой двоичный объект. Для автоматического удаления старых версий можно использовать управление жизненным циклом. Дополнительные сведения об управлении жизненным циклом см. [в статье Оптимизация затрат с помощью автоматизации уровней доступа к хранилищу BLOB-объектов Azure](storage-lifecycle-management-concepts.md).

При удалении большого двоичного объекта с включенным управлением версиями служба хранилища Azure создает версию, которая фиксирует состояние большого двоичного объекта перед его удалением. Текущая версия большого двоичного объекта удаляется, но версии больших двоичных объектов сохраняются, поэтому при необходимости ее можно создать заново. 

Версии больших двоичных объектов являются неизменяемыми. Нельзя изменять содержимое или метаданные существующей версии большого двоичного объекта.

Управление версиями BLOB-объектов доступно для учетных записей общего назначения версии 2, блочного BLOB-объекта и хранилища BLOB-объектов. Учетные записи хранения с иерархическим пространством имен, доступные для использования с Azure Data Lake Storage 2-го поколения, в настоящее время не поддерживаются.

Версия 2019-10-10 и более поздние версии REST API службы хранилища Azure поддерживают управление версиями BLOB-объектов.

### <a name="version-id"></a>Идентификатор версии

Каждая версия большого двоичного объекта определяется по ИДЕНТИФИКАТОРу версии. Значение идентификатора версии — это метка времени, когда большой двоичный объект был записан или обновлен. Идентификатор версии назначается во время создания версии.

Вы можете выполнять операции чтения или удаления для определенной версии большого двоичного объекта, указав его идентификатор версии. Если идентификатор версии не указан, операция выполняется с текущей версией (базовый большой двоичный объект).

При вызове операции записи для создания или изменения большого двоичного объекта Служба хранилища Azure возвращает в ответе заголовок *x-MS-Version-ID* . Этот заголовок содержит идентификатор версии для текущей версии большого двоичного объекта, созданного операцией записи.

Идентификатор версии остается неизменным в течение времени существования версии.

### <a name="versioning-on-write-operations"></a>Управление версиями при операциях записи

При включении управления версиями BLOB-объектов каждая операция записи в большой двоичный объект создает новую версию. Операции записи включают в себя [размещение большого двоичного объекта](/rest/api/storageservices/put-blob), [Размещение списка блокировок](/rest/api/storageservices/put-block-list), [копирование большого двоичного объекта](/rest/api/storageservices/copy-blob)и [Задание метаданных BLOB-объекта](/rest/api/storageservices/set-blob-metadata).

Если операция записи создает новый большой двоичный объект, полученный BLOB-объект будет являться текущей версией большого двоичного объекта. Если операция записи изменяет существующий большой двоичный объект, новые данные фиксируются в обновленном большом двоичном объекте, который является текущей версией, а служба хранилища Azure создает версию, сохраняющую предыдущее состояние BLOB-объекта.

Для простоты схемы, приведенные в этой статье, отображают идентификатор версии как простое целочисленное значение. В действительности ИДЕНТИФИКАТОРом версии является метка времени. Текущая версия показана синим цветом, а предыдущие версии показаны серым.

На следующей схеме показано, как операции записи влияют на версии BLOB-объектов. При создании большого двоичного объекта этот большой двоичный объект является текущей версией. При изменении того же большого двоичного объекта создается новая версия для сохранения предыдущего состояния BLOB-объекта, а обновленный большой двоичный объект становится текущей версией.

:::image type="content" source="media/versioning-overview/write-operations-blob-versions.png" alt-text="Диаграмма, показывающая, как операции записи влияют на двоичные объекты с версиями.":::

> [!NOTE]
> BLOB-объект, созданный до включения управления версиями для учетной записи хранения, не имеет идентификатора версии. При изменении этого большого двоичного объекта измененный большой двоичный объект становится текущей версией, и создается версия для сохранения состояния большого двоичного объекта перед обновлением. Версии назначается идентификатор версии, который является ее временем создания.

### <a name="versioning-on-delete-operations"></a>Управление версиями при операциях удаления

При удалении большого двоичного объекта Текущая версия большого двоичного объекта становится предыдущей версией, а базовый большой двоичный объект удаляется. Все существующие предыдущие версии большого двоичного объекта сохраняются при удалении большого двоичного объекта.

При вызове операции [удаления большого двоичного объекта](/rest/api/storageservices/delete-blob) без идентификатора версии базовый большой двоичный объект удаляется. Чтобы удалить определенную версию, укажите идентификатор этой версии в операции удаления.

На следующей схеме показан результат операции удаления для большого двоичного объекта с управлением версиями.

:::image type="content" source="media/versioning-overview/delete-versioned-base-blob.png" alt-text="Схема удаления большого двоичного объекта с управлением версиями.":::

При записи новых данных в большой двоичный объект создается новая версия большого двоичного объекта. Все существующие версии не затрагиваются, как показано на следующей схеме.

:::image type="content" source="media/versioning-overview/recreate-deleted-base-blob.png" alt-text="Схема, демонстрирующая повторное создание BLOB-объекта с управлением версиями после удаления.":::

### <a name="blob-types"></a>Типы BLOB-объектов

Если для учетной записи хранения включена поддержка управления версиями BLOB-объектов, все операции записи и удаления для блочных больших двоичных объектов активируют создание новой версии, за исключением операции [размещения блока](/rest/api/storageservices/put-block) .

Для страничных BLOB-объектов и добавления больших двоичных объектов только подмножество операций записи и удаления вызывают создание версии. например:

- [Put BLOB (Вставка BLOB-объекта)](/rest/api/storageservices/put-blob)
- [Put Block List (Вставка списка блокировки)](/rest/api/storageservices/put-block-list)
- [Удаление BLOB-объекта](/rest/api/storageservices/delete-blob)
- [Set BLOB Metadata (Задание метаданных BLOB-объекта)](/rest/api/storageservices/set-blob-metadata)
- [Копирование BLOB-объекта](/rest/api/storageservices/copy-blob)

Следующие операции не активируют создание новой версии. Чтобы записать изменения из этих операций, Создайте моментальный снимок вручную:

- [Страница размещения](/rest/api/storageservices/put-page) (страничный BLOB-объект)
- [Блок добавления](/rest/api/storageservices/append-block) (добавочный BLOB-объект)

Все версии большого двоичного объекта должны иметь один и тот же тип большого двоичного объекта. Если у большого двоичного объекта есть предыдущие версии, нельзя перезаписать большой двоичный объект одного типа другим типом, если только вы не удалите большой двоичный объект и все его версии.

### <a name="access-tiers"></a>Уровни доступа

Вы можете переместить любую версию блочного BLOB-объекта, включая текущую версию, в другой уровень доступа к большому двоичному объекту, вызвав операцию [задания уровня большого двоичного объекта](/rest/api/storageservices/set-blob-tier) . Вы можете воспользоваться преимуществами цен меньшей емкости, перемещая старые версии большого двоичного объекта на стильный или архивный уровень. Дополнительные сведения см. в статье [хранилище BLOB-объектов Azure: горячий, стильный и архивный уровни доступа](storage-blob-storage-tiers.md).

Чтобы автоматизировать процесс перемещения блочных BLOB-объектов на соответствующий уровень, используйте управление жизненным циклом больших двоичных объектов. Дополнительные сведения об управлении жизненным циклом см. в статье [Управление жизненным циклом хранилища BLOB-объектов Azure](storage-lifecycle-management-concepts.md).

## <a name="enable-or-disable-blob-versioning"></a>Включение или отключение управления версиями BLOB-объектов

Сведения о том, как включить или отключить управление версиями BLOB-объектов, см. в разделе [Включение управления версиями BLOB-объектов и управление ими](versioning-enable.md).

Отключение управления версиями BLOB-объектов не приводит к удалению существующих больших двоичных объектов, версий или моментальных снимков. При отключении управления версиями BLOB-объектов все существующие версии остаются доступными в вашей учетной записи хранения. Новые версии не создаются впоследствии.

Если большой двоичный объект был создан или изменен после отключения управления версиями в учетной записи хранения, при перезаписи большого двоичного объекта создается новая версия. Обновленный большой двоичный объект больше не является текущей версией и не имеет идентификатора версии. Все последующие обновления для большого двоичного объекта будут перезаписывать данные без сохранения предыдущего состояния.

Вы можете читать или удалять версии с помощью идентификатора версии после отключения управления версиями. Вы также можете вывести список версий больших двоичных объектов после отключения управления версиями.

На следующей схеме показано, как изменение большого двоичного объекта после отключения управления версиями создает большой двоичный объект, для которого не установлен контроль версий. Все существующие версии, связанные с большим двоичным объектом, сохраняются.

:::image type="content" source="media/versioning-overview/modify-base-blob-versioning-disabled.png" alt-text="На схеме показано изменение базового большого двоичного объекта после отключения управления версиями.":::

## <a name="blob-versioning-and-soft-delete"></a>Управление версиями BLOB-объектов и обратимое удаление

Управление версиями BLOB-объектов и обратимое удаление BLOB-объектов обеспечивает оптимальную защиту данных. При включении обратимого удаления вы указываете, как долго служба хранилища Azure должна хранить обратимо удаленные большие двоичные объекты. Любая обратимо удаленная версия BLOB-объекта остается в системе и может быть отменена в течение срока хранения с обратимым удалением. Дополнительные сведения об обратимом удалении BLOB-объектов см. в статье [обратимое удаление для больших двоичных объектов службы хранилища Azure](./soft-delete-blob-overview.md).

### <a name="deleting-a-blob-or-version"></a>Удаление большого двоичного объекта или версии

Обратимое удаление обеспечивает дополнительную защиту для удаления версий BLOB-объектов. Если в учетной записи хранения включены как управление версиями, так и обратимое удаление, то при удалении большого двоичного объекта Служба хранилища Azure создает новую версию для сохранения состояния большого двоичного объекта непосредственно перед удалением и удаляет текущую версию. Новая версия не удаляется без обратимого удаления и не будет удалена после истечения срока хранения обратимого удаления.

При удалении предыдущей версии большого двоичного объекта Эта версия обратимо удалена. Версия с обратимым удалением сохраняется в течение срока хранения, указанного в параметрах обратимого удаления для учетной записи хранения, и окончательно удаляется после истечения срока хранения обратимого удаления.

Чтобы удалить предыдущую версию большого двоичного объекта, явно удалите его, указав идентификатор версии.

На следующей схеме показано, что происходит при удалении большого двоичного объекта или версии большого двоичного объекта.

:::image type="content" source="media/versioning-overview/soft-delete-historical-version.png" alt-text="Диаграмма, показывающая удаление версии с включенным обратимым удалением.":::

Если в учетной записи хранения включены как управление версиями, так и обратимое удаление, то при изменении или удалении версии BLOB-объекта или большого двоичного объекта моментальный снимок не создается.

### <a name="restoring-a-soft-deleted-version"></a>Восстановление обратимо удаленных версий

Можно восстановить обратимо удаленную версию большого двоичного объекта, вызвав операцию [отмены удаления больших двоичных объектов](/rest/api/storageservices/undelete-blob) в версии, пока действует срок хранения обратимого удаления. Операция **отмены удаления большого двоичного объекта** восстанавливает все обратимо удаленные версии большого двоичного объекта.

Восстановление необратимо удаленных версий с помощью операции **отмены удаления BLOB-объектов** не повышает уровень текущей версии. Чтобы восстановить текущую версию, сначала восстановите все версии с обратимым удалением, а затем используйте операцию [копирования BLOB-объектов](/rest/api/storageservices/copy-blob) , чтобы скопировать предыдущую версию для восстановления большого двоичного объекта.

На следующей схеме показано, как восстановить обратимо удаленные версии BLOB-объектов с помощью операции **отмены удаления больших двоичных объектов** , а также как восстановить текущую версию большого двоичного объекта с помощью операции **копирования BLOB-объектов** .

:::image type="content" source="media/versioning-overview/undelete-version.png" alt-text="Схема восстановления версий с обратимым удалением.":::

После истечения срока хранения обратимого удаления все обратимо удаленные версии больших двоичных объектов удаляются без возможности восстановления.

## <a name="blob-versioning-and-blob-snapshots"></a>Управление версиями BLOB-объектов и моментальные снимки больших двоичных объектов

Моментальный снимок большого двоичного объекта — это доступная только для чтения копия большого двоичного объекта, выполняемая в конкретный момент времени. Моментальные снимки больших двоичных объектов и версии BLOB-объектов похожи, но моментальный снимок создается вручную или приложением, а версия большого двоичного объекта создается автоматически при операции записи или удаления, если для вашей учетной записи хранения включена поддержка управления версиями BLOB-объектов.

> [!IMPORTANT]
> Корпорация Майкрософт рекомендует после включения управления версиями BLOB-объектов обновить приложение, чтобы прекратить создание моментальных снимков блочных BLOB-объектов. Если для вашей учетной записи хранения включена поддержка управления версиями, все обновления и удаления блочных BLOB-объектов фиксируются и сохраняются в версиях. Создание моментальных снимков не предоставляет никаких дополнительных средств защиты данных блочного BLOB-объекта, если включено управление версиями больших двоичных объектов и может привести к увеличению затрат и сложности приложений.

### <a name="snapshot-a-blob-when-versioning-is-enabled"></a>Моментальный снимок большого двоичного объекта при включении управления версиями

Хотя это не рекомендуется, можно создать моментальный снимок большого двоичного объекта, который также имеет версию. Если не удается обновить приложение, чтобы прекратить создание моментальных снимков больших двоичных объектов при включении управления версиями, приложение может поддерживать как моментальные снимки, так и версии.

При создании моментального снимка двоичного объекта с управлением версиями создается новая версия одновременно с созданием моментального снимка. Новая текущая версия также создается при создании моментального снимка.

На следующей схеме показано, что происходит при создании моментального снимка BLOB-объекта с версией. На схеме версии BLOB-объектов и моментальные снимки с ИДЕНТИФИКАТОРами версии 2 и 3 содержат идентичные данные.

:::image type="content" source="media/versioning-overview/snapshot-versioned-blob.png" alt-text="Схема, показывающая моментальные снимки BLOB-объекта с версией.":::

## <a name="authorize-operations-on-blob-versions"></a>Авторизовать операции в версиях BLOB-объектов

Вы можете авторизовать доступ к версиям BLOB-объектов, используя один из следующих подходов:

- С помощью управления доступом на основе ролей Azure (Azure RBAC), чтобы предоставить разрешения для субъекта безопасности Azure Active Directory (Azure AD). Корпорация Майкрософт рекомендует использовать Azure AD для обеспечения более высокого уровня безопасности и простоты в использовании. Дополнительные сведения об использовании Azure AD с операциями BLOB-объектов см. в разделе [авторизация доступа к BLOB-объектам и очередям с помощью Azure Active Directory](../common/storage-auth-aad.md).
- С помощью подписанного URL-адрес (SAS) для делегирования доступа к версиям большого двоичного объекта. Укажите идентификатор версии для подписанного типа ресурса `bv` , представляющий версию BLOB-объекта, чтобы создать маркер SAS для операций в определенной версии. Дополнительные сведения о подписанных URL-адресах см. в статье об [использование подписанных URL-адресов SAS в службе хранилища Azure](../common/storage-sas-overview.md).
- С помощью ключей доступа к учетной записи для авторизации операций с версиями BLOB-объектов с общим ключом. Дополнительные сведения см. в статье [Авторизация с помощью общего ключа](/rest/api/storageservices/authorize-with-shared-key).

Управление версиями BLOB-объектов предназначено для защиты данных от случайного или вредоносного удаления. Для повышения уровня защиты при удалении версии большого двоичного объекта требуются специальные разрешения. В следующих разделах описываются разрешения, необходимые для удаления версии BLOB-объекта.

### <a name="azure-rbac-action-to-delete-a-blob-version"></a>Действие Azure RBAC для удаления версии BLOB-объекта

В следующей таблице показано, какие действия Azure RBAC поддерживают удаление большого двоичного объекта или версии большого двоичного объекта.

| Описание | Операция службы BLOB-объектов | Требуется действие данных RBAC Azure | Поддержка встроенных ролей Azure |
|----------------------------------------------|------------------------|---------------------------------------------------------------------------------------|-------------------------------|
| Удаление текущей версии большого двоичного объекта | Delete BLOB (Удаление BLOB-объекта) | **Microsoft.Storage/storageAccounts/blobServices/containers/blobs/delete** | Участник данных BLOB-объектов хранилища |
| Удаление версии | Delete BLOB (Удаление BLOB-объекта) | **Microsoft. Storage/storageAccounts/Блобсервицес/Containers/blobs/Делетеблобверсион/Action** | Владелец данных BLOB-объектов хранилища |

### <a name="shared-access-signature-sas-parameters"></a>Параметры подписи общего доступа (SAS)

Подписанный ресурс для версии BLOB-объекта — `bv` . Дополнительные сведения см. в статьях [Создание SAS службы](/rest/api/storageservices/create-service-sas) или [Создание SAS для делегирования пользователей](/rest/api/storageservices/create-user-delegation-sas).

В следующей таблице показано разрешение, необходимое для удаления версии BLOB-объекта на SAS.

| **Разрешение** | **Символ URI** | **Разрешенные операции** |
|----------------|----------------|------------------------|
| Удалить         | x              | Удаление версии большого двоичного объекта. |

## <a name="pricing-and-billing"></a>Цены и выставление счетов

Включение управления версиями BLOB-объектов может привести к дополнительным затратам на хранение данных в вашей учетной записи. При проектировании приложения важно учитывать, как эта плата может накапливаться, чтобы минимизировать затраты.

Счета за версии больших двоичных объектов, например моментальные снимки BLOB-объектов, выставляются по той же ставке, что и активные данные. Выбор способа оплаты версий зависит от того, был ли явно задан уровень для базового большого двоичного объекта или для любой из его версий (или моментальных снимков). Дополнительные сведения об уровнях для BLOB-объектов см. в статье [Хранилище BLOB-объектов Azure: горячий, холодный и архивный уровни](storage-blob-storage-tiers.md).

Если вы не изменили уровень BLOB-объекта или версии, Вам выставляется счет за уникальные блоки данных в большом двоичном объекте, его версиях и любых моментальных снимках, которые он может иметь. Дополнительные сведения см. [в разделе выставление счетов, если уровень большого двоичного объекта не задан явно](#billing-when-the-blob-tier-has-not-been-explicitly-set).

Если вы изменили уровень BLOB-объекта или версии, Вам выставляется счет за весь объект, независимо от того, находится ли BLOB-объект и версия в конечном итоге на одном и том же уровне. Дополнительные сведения см. [в разделе выставление счетов при явном задании уровня большого двоичного объекта](#billing-when-the-blob-tier-has-been-explicitly-set).

> [!NOTE]
> Включение управления версиями для часто перезаписанных данных может привести к увеличению затрат на емкость хранилища и увеличению задержки при выполнении операций перечисления. Чтобы устранить эти проблемы, храните часто перезаписанные данные в отдельной учетной записи хранения с отключенной системой управления версиями.

Дополнительные сведения о выставлении счетов за моментальные снимки BLOB-объектов см. в разделе [моментальные снимки BLOB-объектов](snapshots-overview.md).

### <a name="billing-when-the-blob-tier-has-not-been-explicitly-set"></a>Выставление счетов, если уровень большого двоичного объекта не задан явно

Если вы не установили явно уровень больших двоичных объектов для базового большого двоичного объекта или какой-либо из его версий, вы платите за уникальные блоки или страницы по большому двоичному объекту, его версиям и любым моментальным снимкам, которые он может иметь. Данные, общие для большого двоичного объекта и его версий, наставляются только один раз. При обновлении большого двоичного объекта данные в базовом большом двоичном объекте расходятся из данных, хранящихся в его версиях, и за каждый блок или страницу насчитывается ряд уникальных данных.

Когда вы заменяете блок в блочном большом двоичном объекте, за этот блок начинает взиматься плата как за уникальный. Это справедливо, даже если блок имеет тот же идентификатор блока и те же данные, что и в предыдущей версии. После того, как блок будет зафиксирован снова, он рассходится от его аналога в предыдущей версии, и вы получите оплату за его данные. Это же происходит и для страницы в страничном BLOB-объекте, обновляемом идентичными данными.

В хранилище BLOB-объектов нет средств для определения того, содержат ли два блока одинаковые данные. Каждый блок, который был загружен и зафиксирован, обрабатывается как уникальный, даже если он содержит те же данные и имеет тот же идентификатор блока. Поскольку расходы начисляются для уникальных блоков, важно помнить, что обновление большого двоичного объекта при включении управления версиями приведет к появлению дополнительных уникальных блоков и дополнительной оплаты.

Если управление версиями BLOB-объектов включено, вызывайте операции обновления для блочных BLOB-объектов, чтобы они могли обновить минимальное возможное число блоков. Операции записи, позволяющие детально управлять блоками, являются [блоками помещает](/rest/api/storageservices/put-block) блоки и [помещают их в список блокировок](/rest/api/storageservices/put-block-list). С другой стороны, операция [размещения большого двоичного объекта](/rest/api/storageservices/put-blob) заменяет все содержимое большого двоичного объекта, что может привести к дополнительным затратам.

В следующих сценариях показано, как начисляется плата за блочный BLOB-объект и его версии, если уровень большого двоичного объекта не задан явно.

#### <a name="scenario-1"></a>Сценарий 1

В сценарии 1 большой двоичный объект имеет предыдущую версию. Большой двоичный объект не был обновлен с момента создания версии, поэтому плата взимается только за уникальные блоки 1, 2 и 3.

![На схеме 1 показано выставление счетов за уникальные блоки в базовом BLOB-объекте и предыдущей версии.](./media/versioning-overview/versions-billing-scenario-1.png)

#### <a name="scenario-2"></a>Сценарий 2

В сценарии 2 был обновлен один блок (блок 3 на схеме) в большом двоичном объекте. Несмотря на то что обновленный блок содержит одни и те же данные и один и тот же идентификатор, он не совпадает с блоком 3 в предыдущей версии. В результате плата в учетной записи взимается за четыре блока.

![На схеме 2 показано выставление счетов за уникальные блоки в базовом BLOB-объекте и предыдущей версии.](./media/versioning-overview/versions-billing-scenario-2.png)

#### <a name="scenario-3"></a>Сценарий 3

В сценарии 3 большой двоичный объект был обновлен, но не имеет версии. Блок 3 был заменен блоком 4 в базовом большом двоичном объекте, но предыдущая версия по-прежнему соответствует блоку 3. В результате плата в учетной записи взимается за четыре блока.

![На схеме 3 показано выставление счетов за уникальные блоки в базовом BLOB-объекте и предыдущей версии.](./media/versioning-overview/versions-billing-scenario-3.png)

#### <a name="scenario-4"></a>Сценарий 4

В сценарии 4 базовый большой двоичный объект был полностью обновлен и не содержит никаких первоначальных блоков. В результате учетной записи выставляются счета за все восемь уникальных блоков &mdash; , четыре в базовом большом двоичном объекте, и четыре в предыдущей версии. Этот сценарий может возникнуть при записи в большой двоичный объект с помощью операции [размещения большого двоичного](/rest/api/storageservices/put-blob) объекта, так как он заменяет все содержимое базового большого двоичного объекта.

![На схеме 4 показано выставление счетов за уникальные блоки в базовом BLOB-объекте и предыдущей версии.](./media/versioning-overview/versions-billing-scenario-4.png)

### <a name="billing-when-the-blob-tier-has-been-explicitly-set"></a>Выставление счетов при явном задании уровня большого двоичного объекта

Если вы явно установили уровень больших двоичных объектов для большого двоичного объекта или версии (или моментального снимка), вы платите за полную длину содержимого объекта на новом уровне, независимо от того, использует ли он общий доступ к объекту на исходном уровне. Кроме того, вы платите за полную длину содержимого самой старой версии на исходном уровне. Все предыдущие версии или моментальные снимки, остающиеся на исходном уровне, взимается за уникальные блоки, которые они могут совместно использовать, как описано в разделе [выставление счетов, если уровень большого двоичного объекта не задан явно](#billing-when-the-blob-tier-has-not-been-explicitly-set).

#### <a name="moving-a-blob-to-a-new-tier"></a>Перемещение большого двоичного объекта на новый уровень

В следующей таблице описывается порядок выставления счетов для большого двоичного объекта или версии при перемещении на новый уровень.

| Когда уровень BLOB-объекта явно задан... | После этого выставляются счета за... |
|-|-|
| Базовый большой двоичный объект с предыдущей версией | Базовый BLOB-объект на новом уровне и самая старая версия на исходном уровне, а также все уникальные блоки в других версиях. <sup>1</sup> |
| Базовый большой двоичный объект с предыдущей версией и моментальным снимком | Базовый большой двоичный объект на новом уровне, самая старая версия на исходном уровне и самый старый моментальный снимок на исходном уровне, а также все уникальные блоки в других версиях или моментальных снимках<sup>1</sup>. |
| Предыдущая версия | Версия на новом уровне и базовый большой двоичный объект на исходном уровне, а также все уникальные блоки в других версиях. <sup>1</sup> |

<sup>1</sup> Если существуют другие предыдущие версии или моментальные снимки, которые не были перемещены с исходного уровня, плата за эти версии или моментальные снимки взимается на основе количества уникальных блоков, которые они содержат, как описано в разделе [выставление счетов, если уровень большого двоичного объекта не задан явно](#billing-when-the-blob-tier-has-not-been-explicitly-set).

На следующей схеме показано, как выставляются счета за объекты при перемещении большого двоичного объекта на другой уровень.

:::image type="content" source="media/versioning-overview/versioning-billing-tiers.png" alt-text="Диаграмма, показывающая, как взимается плата за объекты при явном уровне двоичного объекта с управлением версиями.":::

Явное задание уровня для большого двоичного объекта, версии или моментального снимка невозможно отменить. Если вы перемещаете большой двоичный объект на новый уровень и затем перемещаете его на исходный уровень, вы платите за полную длину содержимого объекта, даже если он разделяется на другие объекты на исходном уровне.

Операции, явно заданные в качестве уровня BLOB-объекта, версии или моментального снимка, включают:

- [Установка уровня большого двоичного объекта](/rest/api/storageservices/set-blob-tier)
- [Размещение большого двоичного объекта](/rest/api/storageservices/put-blob) с указанным уровнем
- [Разместить список блокировок](/rest/api/storageservices/put-block-list) с указанным уровнем
- [Копировать большой двоичный объект](/rest/api/storageservices/copy-blob) с указанным уровнем

#### <a name="deleting-a-blob-when-soft-delete-is-enabled"></a>Удаление большого двоичного объекта при включенном обратимом удалении

Если обратимое удаление BLOB-объектов включено, то при удалении или перезаписи базового большого двоичного объекта, для которого был явно задан уровень, все предыдущие версии большого двоичного объекта с обратимым удалением выставляются с полной длиной содержимого. Дополнительные сведения о совместном использовании версий и обратимого удаления BLOB-объектов см. в разделе [Управление версиями BLOB-объектов и обратимое удаление](#blob-versioning-and-soft-delete).

В следующей таблице описывается способ выставления счетов для большого двоичного объекта с обратимым удалением в зависимости от того, включено или отключено управление версиями. При включении управления версиями создается версия при обратимом удалении большого двоичного объекта. Если управление версиями отключено, обратимое удаление большого двоичного объекта создает моментальный снимок обратимого удаления.

| При перезаписи базового большого двоичного объекта с явно заданным уровнем... | После этого выставляются счета за... |
|-|-|
| Если включены обратимое удаление BLOB-объектов и управление версиями | Все существующие версии с полной длиной содержимого независимо от уровня. |
| Если обратимое удаление BLOB-объекта включено, но управление версиями отключено | Все существующие моментальные снимки обратимого удаления с полной длиной содержимого независимо от уровня. |

## <a name="see-also"></a>См. также раздел

- [Включение управления версиями BLOB-объектов и работа с ним](versioning-enable.md)
- [Создание моментального снимка большого двоичного объекта](/rest/api/storageservices/creating-a-snapshot-of-a-blob)
- [Обратимое удаление для больших двоичных объектов службы хранилища Azure](./soft-delete-blob-overview.md)