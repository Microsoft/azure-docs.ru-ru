---
title: Моментальные снимки BLOB-объектов
titleSuffix: Azure Storage
description: Узнайте, как работают моментальные снимки больших двоичных объектов и как выставляются счета за них.
services: storage
author: tamram
ms.service: storage
ms.topic: article
ms.date: 02/02/2021
ms.author: tamram
ms.subservice: blobs
ms.openlocfilehash: debce0a1b4c09bb89cdceb1cd29e59e1976c939a
ms.sourcegitcommit: 44188608edfdff861cc7e8f611694dec79b9ac7d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/04/2021
ms.locfileid: "99539164"
---
# <a name="blob-snapshots"></a>Моментальные снимки BLOB-объектов

Моментальный снимок — это версия BLOB-объекта только для чтения, сделанная в определенный момент времени.

> [!NOTE]
> Управление версиями BLOB-объектов — это старший способ поддерживать предыдущие версии большого двоичного объекта. Дополнительные сведения см. в разделе [Управление версиями BLOB-объектов](versioning-overview.md).

## <a name="about-blob-snapshots"></a>О моментальных снимках BLOB-объектов

[!INCLUDE [storage-multi-protocol-access-preview](../../../includes/storage-multi-protocol-access-preview.md)]

Моментальный снимок большого двоичного объекта идентичен объекту, на основе которого он создан. Единственное исключение: к URI большого двоичного объекта добавляется значение **DateTime**, которое указывает время создания снимка. Например, если страничный BLOB-объект имеет URI `http://storagesample.core.blob.windows.net/mydrives/myvhd`, то URI снимка будет иметь такой вид: `http://storagesample.core.blob.windows.net/mydrives/myvhd?snapshot=2011-03-09T01:42:34.9360000Z`.

> [!NOTE]
> Все моментальные снимки имеют одинаковый URI базового большого двоичного объекта. Большой двоичный объект и его моментальный снимок отличаются только добавлением значения **DateTime** .

Большой двоичный объект может иметь любое количество моментальных снимков. Моментальные снимки сохраняются до тех пор, пока они не будут удалены явным образом либо независимо, либо как часть операции [удаления большого двоичного](/rest/api/storageservices/delete-blob) объекта для базового большого двоичного объекта. Чтобы было удобнее контролировать моментальные снимки большого двоичного объекта, их можно пронумеровать.

При создании моментального снимка BLOB-объекта его системные свойства и их значения копируются в снимок. Метаданные базового большого двоичного объекта также копируются в моментальный снимок, если при его создании не были указаны отдельные метаданные для снимка. После создания моментального снимка его можно прочитать, скопировать или удалить, но вы не можете изменять его.

Свойства аренды, связанные с базовым BLOB-объектом, не влияют на моментальный снимок. Вы не можете получить аренду в моментальном снимке.

VHD-файл используется для хранения текущей информации о диске виртуальной машины и его состояния. Можно отключить диск в виртуальной машине или завершить ее работу, после чего создать моментальный снимок его VHD-файла. Этот файл моментального снимка можно будет использовать позже, чтобы получить VHD-файл на этот момент времени и повторно создать виртуальную машину.

## <a name="understand-how-snapshots-accrue-charges"></a>Общая информация о том, как моментальные снимки увеличивают плату

### <a name="important-billing-considerations"></a>Важные вопросы о выставлении счетов

Следующий список включает ключевые пункты, которые следует рассмотреть при создании моментального снимка.

- Плата взимается за уникальные блоки и страницы независимо от того, где они находятся: в большом двоичном объекте или моментальном снимке. Ваша учетная запись не влечет за собой дополнительных затрат на моментальные снимки, связанные с большим двоичным объектом, пока большой двоичный объект, на котором они основаны, не будет обновлен. После изменения базового большого двоичного объекта он начнет отличаться от своих моментальных снимков. Теперь вы будете оплачивать все уникальные блоки и страницы в каждом большом двоичном объекте или моментальном снимке.
- Когда вы заменяете блок в блочном большом двоичном объекте, за этот блок начинает взиматься плата как за уникальный. Это произойдет, даже если у блока тот же идентификатор блока и те же данные, что и в моментальном снимке. Как только блок фиксируется заново, он расходится со всеми своими дубликатами во всех моментальных снимках и вы будете оплачивать его данные. Это же происходит и для страницы в страничном BLOB-объекте, обновляемом идентичными данными.
- Обновление блочного BLOB-объекта путем вызова метода, который перезаписывает все содержимое большого двоичного объекта, приведет к замене всех блоков в большом двоичном объекте. Если с этим большим двоичным объектом связан моментальный снимок, то все блоки в базовом большом двоичном объекте перестанут совпадать с блоками в моментальном снимке, и вы будете оплачивать хранение всех блоков в обоих больших двоичных объектах. Это произойдет, даже если данные базового большого двоичного объекта и моментального снимка останутся идентичными.
- В службе BLOB-объектов Azure нет средств, позволяющих определить, содержат ли два блока идентичные данные. Каждый блок, который был загружен и зафиксирован, обрабатывается как уникальный, даже если он содержит те же данные и имеет тот же идентификатор блока. Так как плата добавляется за уникальные блоки, важно иметь в виду, что обновление большого двоичного объекта, содержащего моментальный снимок, приведет к появлению дополнительных уникальных блоков и дополнительным расходам.

### <a name="minimize-costs-with-snapshot-management"></a>Уменьшение затрат с помощью управления моментальными снимками

Рекомендуется управлять моментальными снимками осторожно, чтобы избежать наценок. Выполните приведенные ниже рекомендации, чтобы свести к минимуму затраты на хранение моментальных снимков.

- Удаляйте и повторно создавайте моментальные снимки, связанные с большим двоичным объектом, при обновлении этого объекта, даже если вы обновляете его идентичными данными, если только структура вашего приложения не требует сохранения моментальных снимков. За счет удаления и повторного создания моментальных снимков больших двоичных объектов можно исключить расхождение большого двоичного объекта с моментальными снимками.
- Если вы обслуживаете моментальные снимки для большого двоичного объекта, не вызывайте методы, которые перезапишут весь большой двоичный объект при обновлении большого двоичного объекта. Вместо этого обновите минимальное возможное число блоков, чтобы снизить затраты.

### <a name="snapshot-billing-scenarios"></a>Сценарии выставления счетов за моментальные снимки

В следующих сценариях показано, как добавляется плата за большой двоичный объект и его моментальные снимки.

## <a name="pricing-and-billing"></a>Цены и выставление счетов

Создание моментальных снимков, представляющих собой копии больших двоичных объектов с доступом только для чтения, может привести к дополнительной плате за хранение данных в вашей учетной записи. При проектировании приложения важно учитывать, как эта плата может накапливаться, чтобы минимизировать затраты.

Счета за моментальные снимки больших двоичных объектов, например версии BLOB-объектов, выставляются по той же ставке, что и активные данные. Оплата за использование моментальных снимков зависит от того, был ли явно задан уровень для базового большого двоичного объекта или для любого из его моментальных снимков (или версий). Дополнительные сведения об уровнях для BLOB-объектов см. в статье [Хранилище BLOB-объектов Azure: горячий, холодный и архивный уровни](storage-blob-storage-tiers.md).

Если вы не изменили уровень BLOB-объекта или моментального снимка, Вам выставляется счет за уникальные блоки данных в этом большом двоичном объекте, его моментальные снимки и любые версии, которые у него есть. Дополнительные сведения см. [в разделе выставление счетов, если уровень большого двоичного объекта не задан явно](#billing-when-the-blob-tier-has-not-been-explicitly-set).

Если вы изменили уровень BLOB-объекта или моментального снимка, Вам выставляется счет за весь объект, независимо от того, находится ли BLOB-объект и моментальный снимок в конечном итоге на одном и том же уровне. Дополнительные сведения см. [в разделе выставление счетов при явном задании уровня большого двоичного объекта](#billing-when-the-blob-tier-has-been-explicitly-set).

Дополнительные сведения о выставлении счетов за использование версий BLOB-объектов см. в разделе [Управление версиями BLOB](versioning-overview.md)-объектов.

### <a name="billing-when-the-blob-tier-has-not-been-explicitly-set"></a>Выставление счетов, если уровень большого двоичного объекта не задан явно

Если вы не установили явно уровень больших двоичных объектов для базового большого двоичного объекта или какого-либо из его моментальных снимков, вы платите за уникальные блоки или страницы в большом двоичном объекте, его моментальные снимки и любые версии, которые он может иметь. Данные, общие для большого двоичного объекта и его моментальных снимков, наставляются только один раз. При обновлении большого двоичного объекта данные в базовом большом двоичном объекте расходятся из данных, хранящихся в его моментальных снимках, и за каждый блок или страницу насчитывается ряд уникальных данных.

Когда вы заменяете блок в блочном большом двоичном объекте, за этот блок начинает взиматься плата как за уникальный. Это произойдет, даже если у блока тот же идентификатор блока и те же данные, что и в моментальном снимке. После того, как блок будет зафиксирован снова, он рассходится от его аналога в моментальном снимке, и вы получите оплату за его данные. Это же происходит и для страницы в страничном BLOB-объекте, обновляемом идентичными данными.

В хранилище BLOB-объектов нет средств для определения того, содержат ли два блока одинаковые данные. Каждый блок, который был загружен и зафиксирован, обрабатывается как уникальный, даже если он содержит те же данные и имеет тот же идентификатор блока. Поскольку расходы начисляются для уникальных блоков, важно помнить, что обновление большого двоичного объекта при наличии моментальных снимков или версий приведет к дополнительным блокам и дополнительной оплате.

Если BLOB-объект имеет моментальные снимки, вызывайте операции обновления для блочных BLOB-объектов, чтобы они могли обновить минимальное возможное число блоков. Операции записи, позволяющие детально управлять блоками, являются [блоками помещает](/rest/api/storageservices/put-block) блоки и [помещают их в список блокировок](/rest/api/storageservices/put-block-list). С другой стороны, операция [размещения большого двоичного объекта](/rest/api/storageservices/put-blob) заменяет все содержимое большого двоичного объекта, что может привести к дополнительным затратам.

В следующих сценариях показано, как начисляется плата за блочный BLOB-объект и его моментальные снимки, если уровень большого двоичного объекта не задан явно.

#### <a name="scenario-1"></a>Сценарий 1

В сценарии 1 базовый большой двоичный объект создания моментального снимка не обновлялся, поэтому плата начисляется только за уникальные блоки 1, 2 и 3.

![На схеме 1 показано выставление счетов за уникальные блоки в базовом BLOB-объекте и моментальном снимке.](./media/snapshots-overview/storage-blob-snapshots-billing-scenario-1.png)

#### <a name="scenario-2"></a>Сценарий 2

В сценарии 2 базовый большой двоичный объект изменился, а моментальный снимок — нет. Блок 3 был обновлен, и, хотя он содержит такие же данные и тот же идентификатор, он отличается от блока 3 в моментальном снимке. В результате плата в учетной записи взимается за четыре блока.

![На схеме 2 показано выставление счетов за уникальные блоки в базовом BLOB-объекте и моментальном снимке.](./media/snapshots-overview/storage-blob-snapshots-billing-scenario-2.png)

#### <a name="scenario-3"></a>Сценарий 3

В сценарии 3 базовый большой двоичный объект изменился, а моментальный снимок — нет. Блок 3 был заменен блоком 4 в базовом большом двоичном объекте, но моментальный снимок по-прежнему отражает блок 3. В результате плата в учетной записи взимается за четыре блока.

![На схеме 3 показано выставление счетов за уникальные блоки в базовом BLOB-объекте и моментальном снимке.](./media/snapshots-overview/storage-blob-snapshots-billing-scenario-3.png)

#### <a name="scenario-4"></a>Сценарий 4

В сценарии 4 базовый большой двоичный объект был полностью обновлен и не содержит никаких первоначальных блоков. В результате плата в учетной записи взимается за все восемь уникальных блоков.

![На схеме 4 показано выставление счетов за уникальные блоки в базовом BLOB-объекте и моментальном снимке.](./media/snapshots-overview/storage-blob-snapshots-billing-scenario-4.png)

> [!TIP]
> Избегайте вызова методов, которые перезапишут весь большой двоичный объект, а вместо этого обновляйте отдельные блоки, чтобы снизить затраты.

### <a name="billing-when-the-blob-tier-has-been-explicitly-set"></a>Выставление счетов при явном задании уровня большого двоичного объекта

Если вы явно установили уровень больших двоичных объектов для большого двоичного объекта или моментального снимка (или версии), вы платите за полную длину содержимого объекта на новом уровне, независимо от того, использует ли он общий доступ к объекту на исходном уровне. Кроме того, вы платите за полную длину содержимого самой старой версии на исходном уровне. Все версии или моментальные снимки, остающиеся на исходном уровне, взимается за уникальные блоки, которые они могут совместно использовать, как описано в разделе [выставление счетов, если уровень большого двоичного объекта не задан явно](#billing-when-the-blob-tier-has-not-been-explicitly-set).

#### <a name="moving-a-blob-to-a-new-tier"></a>Перемещение большого двоичного объекта на новый уровень

В следующей таблице описывается способ выставления счетов для большого двоичного объекта или моментального снимка при его перемещении на новый уровень.

| Когда уровень BLOB-объекта явно задан... | После этого выставляются счета за... |
|-|-|
| Базовый большой двоичный объект с моментальным снимком | Базовый большой двоичный объект на новом уровне и самый старый моментальный снимок на исходном уровне, а также все уникальные блоки в других моментальных снимках. <sup>1</sup> |
| Базовый большой двоичный объект с предыдущей версией и моментальным снимком | Базовый большой двоичный объект на новом уровне, самая старая версия на исходном уровне и самый старый моментальный снимок на исходном уровне, а также все уникальные блоки в других версиях или моментальных снимках<sup>1</sup>. |
| Моментальный снимок | Моментальный снимок на новом уровне и базовый большой двоичный объект на исходном уровне, а также все уникальные блоки в других моментальных снимках. <sup>1</sup> |

<sup>1</sup> Если существуют другие предыдущие версии или моментальные снимки, которые не были перемещены с исходного уровня, плата за эти версии или моментальные снимки взимается на основе количества уникальных блоков, которые они содержат, как описано в разделе [выставление счетов, если уровень большого двоичного объекта не задан явно](#billing-when-the-blob-tier-has-not-been-explicitly-set).

На следующей схеме показано, как выставляются счета за объекты при перемещении большого двоичного объекта с моментальными снимками на другой уровень.

:::image type="content" source="media/snapshots-overview/snapshot-billing-tiers.png" alt-text="Схема выставления счетов за объекты при явном уровне большого двоичного объекта с моментальными снимками.":::

Явное задание уровня для большого двоичного объекта, версии или моментального снимка невозможно отменить. Если вы перемещаете большой двоичный объект на новый уровень и затем перемещаете его на исходный уровень, вы платите за полную длину содержимого объекта, даже если он разделяется на другие объекты на исходном уровне.

Операции, явно заданные в качестве уровня BLOB-объекта, версии или моментального снимка, включают:

- [Установка уровня большого двоичного объекта](/rest/api/storageservices/set-blob-tier)
- [Размещение большого двоичного объекта](/rest/api/storageservices/put-blob) с указанным уровнем
- [Разместить список блокировок](/rest/api/storageservices/put-block-list) с указанным уровнем
- [Копировать большой двоичный объект](/rest/api/storageservices/copy-blob) с указанным уровнем

#### <a name="deleting-a-blob-when-soft-delete-is-enabled"></a>Удаление большого двоичного объекта при включенном обратимом удалении

Если обратимое удаление BLOB-объектов включено, то при удалении или перезаписи базового большого двоичного объекта, для которого был явно задан уровень, все предыдущие версии или моментальные снимки BLOB-объекта с обратимым удалением будут оплачиваться по всей длине содержимого. Дополнительные сведения о совместном использовании версий и обратимого удаления BLOB-объектов см. в разделе [Управление версиями BLOB-объектов и обратимое удаление](versioning-overview.md#blob-versioning-and-soft-delete).

В следующей таблице описывается способ выставления счетов для большого двоичного объекта с обратимым удалением в зависимости от того, включено или отключено управление версиями. При включении управления версиями создается новая версия при обратимом удалении большого двоичного объекта. Если управление версиями отключено, обратимое удаление большого двоичного объекта создает моментальный снимок обратимого удаления.

| При перезаписи базового большого двоичного объекта с явно заданным уровнем... | После этого выставляются счета за... |
|-|-|
| Если включены обратимое удаление BLOB-объектов и управление версиями | Все существующие версии с полной длиной содержимого независимо от уровня. |
| Если обратимое удаление BLOB-объекта включено, но управление версиями отключено | Все существующие моментальные снимки обратимого удаления с полной длиной содержимого независимо от уровня. |

## <a name="next-steps"></a>Следующие шаги

- [Управление версиями BLOB-объектов](versioning-overview.md)
- [Создание моментальных снимков больших двоичных объектов и управление ими в .NET](snapshots-manage-dotnet.md)
- [Архивация неуправляемых дисков виртуальной машины Azure с помощью добавочных моментальных снимков](../../virtual-machines/windows/incremental-snapshots.md)
