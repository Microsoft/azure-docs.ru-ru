---
title: Выполнение восстановления на момент времени в данных блочного BLOB-объекта
titleSuffix: Azure Storage
description: Узнайте, как использовать восстановление до точки во времени для восстановления набора блочных BLOB-объектов до их предыдущего состояния в определенный момент времени.
services: storage
author: tamram
ms.service: storage
ms.topic: how-to
ms.date: 01/29/2021
ms.author: tamram
ms.subservice: blobs
ms.openlocfilehash: b62e341d35a4ff7fd5a7ddd6d9f19b138aaf0aa9
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "99071653"
---
# <a name="perform-a-point-in-time-restore-on-block-blob-data"></a>Выполнение восстановления на момент времени в данных блочного BLOB-объекта

Вы можете использовать восстановление на момент времени, чтобы восстановить один или несколько наборов блочных BLOB-объектов в предыдущее состояние. В этой статье описывается, как включить восстановление на момент времени для учетной записи хранения и как выполнить операцию восстановления.

Дополнительные сведения о восстановлении до точки во времени см. в разделе [восстановление на момент времени для блочных BLOB-объектов](point-in-time-restore-overview.md).

> [!CAUTION]
> Восстановление до точки во времени поддерживает операции восстановления только для блочных BLOB-объектов. Операции с контейнерами не могут быть восстановлены. Если удалить контейнер из учетной записи хранения, вызвав операцию [удаления контейнера](/rest/api/storageservices/delete-container) , то этот контейнер нельзя будет восстановить с помощью операции восстановления. Вместо удаления всего контейнера Удалите отдельные большие двоичные объекты, если их потребуется восстановить позже. Кроме того, корпорация Майкрософт рекомендует включить обратимое удаление для контейнеров и больших двоичных объектов, чтобы защититься от случайного удаления. Дополнительные сведения см. в статье [обратимое удаление для контейнеров (Предварительная версия)](soft-delete-container-overview.md) и [обратимое удаление для больших двоичных объектов](soft-delete-blob-overview.md).

## <a name="enable-and-configure-point-in-time-restore"></a>Включение и Настройка восстановления на момент времени

Перед включением и настройкой восстановления на момент времени включите необходимые компоненты для учетной записи хранения: обратимое удаление, веб-канал изменений и управление версиями BLOB-объектов. Дополнительные сведения о включении каждой из этих функций см. в следующих статьях:

- [Включение обратимого удаления для больших двоичных объектов](./soft-delete-blob-enable.md)
- [Включение и отключение канала изменений](storage-blob-change-feed.md#enable-and-disable-the-change-feed)
- [Включение управления версиями BLOB-объектов и работа с ним](versioning-enable.md)

> [!IMPORTANT]
> Включение обратимого удаления, веб-канала изменений и управления версиями BLOB-объектов может привести к дополнительным издержкам. Дополнительные сведения см. в статье [обратимое удаление для больших двоичных объектов](soft-delete-blob-overview.md), [Поддержка веб-канала изменений в хранилище BLOB-объектов Azure](storage-blob-change-feed.md)и [Управление версиями BLOB-объектов](versioning-overview.md).

# <a name="azure-portal"></a>[Портал Azure](#tab/portal)

Чтобы настроить восстановление на момент времени с помощью портал Azure, выполните следующие действия.

1. Войдите в свою учетную запись хранения на портале Azure.
1. В разделе **Параметры** выберите **Защита данных**.
1. Выберите **включить восстановление на момент времени** . При выборе этого параметра также включаются обратимое удаление для больших двоичных объектов, управления версиями и веб-канала изменений.
1. Задайте максимальную точку восстановления для восстановления на момент времени в днях. Это число должно быть не меньше одного дня, чем срок хранения, указанный для обратимого удаления BLOB-объекта.
1. Сохраните изменения.

На следующем рисунке показана учетная запись хранения, настроенная для восстановления на определенный момент времени с точкой восстановления в семь дней назад, и срок хранения для обратимого удаления BLOB-объекта в течение 14 дней.

:::image type="content" source="media/point-in-time-restore-manage/configure-point-in-time-restore-portal.png" alt-text="Снимок экрана, показывающий, как настроить восстановление на момент времени в портал Azure":::

# <a name="powershell"></a>[PowerShell](#tab/powershell)

Чтобы настроить восстановление на момент времени с помощью PowerShell, сначала установите модуль [AZ. Storage](https://www.powershellgallery.com/packages/Az.Storage) 2.6.0 или более поздней версии. Затем вызовите команду [Enable-азсторажеблобрестореполици](/powershell/module/az.storage/enable-azstorageblobrestorepolicy) , чтобы включить восстановление на момент времени для учетной записи хранения.

В следующем примере активируется обратимое удаление и устанавливается срок хранения обратимого удаления, включается веб-канал изменений и управление версиями, а затем включается восстановление на момент времени. При выполнении примера не забудьте заменить значения в угловых скобках собственными значениями:

```powershell
# Set resource group and account variables.
$rgName = "<resource-group>"
$accountName = "<storage-account>"

# Enable blob soft delete with a retention of 14 days.
Enable-AzStorageBlobDeleteRetentionPolicy -ResourceGroupName $rgName `
    -StorageAccountName $accountName `
    -RetentionDays 14

# Enable change feed and versioning.
Update-AzStorageBlobServiceProperty -ResourceGroupName $rgName `
    -StorageAccountName $accountName `
    -EnableChangeFeed $true `
    -IsVersioningEnabled $true

# Enable point-in-time restore with a retention period of 7 days.
# The retention period for point-in-time restore must be at least
# one day less than that set for soft delete.
Enable-AzStorageBlobRestorePolicy -ResourceGroupName $rgName `
    -StorageAccountName $accountName `
    -RestoreDays 7

# View the service settings.
Get-AzStorageBlobServiceProperty -ResourceGroupName $rgName `
    -StorageAccountName $accountName
```

# <a name="azure-cli"></a>[Azure CLI](#tab/azure-cli)

Чтобы настроить восстановление на момент времени с Azure CLI, сначала установите Azure CLI версии 2.2.0 или более поздней. Чтобы включить восстановление на момент времени и другие необходимые параметры защиты данных для учетной записи хранения, вызовите команду [AZ Storage Account BLOB-Service-Properties Update](/cli/azure/ext/storage-blob-preview/storage/account/blob-service-properties#ext_storage_blob_preview_az_storage_account_blob_service_properties_update) .

В следующем примере активируется обратимое удаление и устанавливается срок хранения обратимого удаления в 14 дней, включается веб-канал изменений и управление версиями, а также обеспечивается восстановление на определенный момент времени с периодом восстановления в 7 дней. При выполнении примера не забудьте заменить значения в угловых скобках собственными значениями:

```azurecli
az storage account blob-service-properties update \
    --resource-group <resource_group> \
    --account-name <storage-account> \
    --enable-delete-retention true \
    --delete-retention-days 14 \
    --enable-versioning true \
    --enable-change-feed true \
    --enable-restore-policy true \
    --restore-days 7
```

---

## <a name="choose-a-restore-point"></a>Выбор точки восстановления

Точка восстановления — это дата и время восстановления данных. Служба хранилища Azure всегда использует значение даты и времени в формате UTC в качестве точки восстановления. Однако портал Azure позволяет указать точку восстановления в местном времени, а затем преобразует значение даты и времени в значение даты и времени в формате UTC для выполнения операции восстановления.

При выполнении операции восстановления с помощью PowerShell или Azure CLI необходимо указать точку восстановления как значение даты-времени в формате UTC. Если точка восстановления указана с использованием местного значения времени вместо значения времени в формате UTC, операция восстановления может по-прежнему работать в некоторых случаях. Например, если местное время — UTC минус пять часов, то при указании значения местного времени точка восстановления будет находиться в течение пяти часов раньше указанного значения. Если в течение этого 5-часового диапазона не были внесены изменения в данные в восстанавливаемом диапазоне, операция восстановления выдаст те же результаты независимо от того, какое значение времени было предоставлено. Чтобы избежать непредвиденных результатов, рекомендуется указать время в формате UTC для точки восстановления.

## <a name="perform-a-restore-operation"></a>Выполнение операции восстановления

Вы можете восстановить все контейнеры в учетной записи хранения или восстановить диапазон больших двоичных объектов в одном или нескольких контейнерах. Диапазон больших двоичных объектов определяется лексикографически, то есть в словарном порядке. Для каждой операции восстановления поддерживается до десяти диапазонов лексикографическом. Начало диапазона является инклюзивным, а конец диапазона — эксклюзивным.

Шаблон контейнера, указанный для начального диапазона и конечного диапазона, должен включать не менее трех символов. Косая черта (/), используемая для разделения имени контейнера из имени большого двоичного объекта, не учитывает этот минимум.

Подстановочные знаки не поддерживаются в диапазоне лексикографическом. Любые символы-шаблоны обрабатываются как стандартные символы.

Вы можете восстановить большие двоичные объекты в `$root` `$web` контейнерах и, явно указав их в диапазоне, переданном в операцию восстановления. `$root` `$web` Контейнеры и восстанавливаются только в том случае, если они заданы явным образом. Не удается восстановить другие системные контейнеры.

Восстанавливаются только блочные BLOB-объекты. Страничные BLOB-объекты и добавочные большие двоичные объекты не включаются в операцию восстановления. Дополнительные сведения об ограничениях, связанных с добавлением больших двоичных объектов, см. [в разделе Восстановление на момент времени для блочных BLOB-объектов](point-in-time-restore-overview.md).

> [!IMPORTANT]
> При выполнении операции восстановления служба хранилища Azure блокирует операции с большими двоичными объектами в восстанавливаемых диапазонах на протяжении операции. Операции чтения, записи и удаления блокируются в основном расположении. По этой причине такие операции, как вывод контейнеров в портал Azure, могут выполняться не так, как ожидалось, во время операции восстановления.
>
> Операции чтения из дополнительного расположения могут продолжаться во время операции восстановления, если учетная запись хранения является геореплицированной.
>
> Время, необходимое для восстановления набора данных, зависит от количества операций записи и удаления, выполненных в течение периода восстановления. Например, учетная запись с 1 000 000 объектами с 3 000 объектов, добавленных в день и 1 000 объектов в день, будет требовать примерно два часа для восстановления до точки на 30 дней в прошлом. Срок хранения и восстановление более 90 дней в прошлом не рекомендуются для учетной записи с такой частотой изменений.

### <a name="restore-all-containers-in-the-account"></a>Восстановить все контейнеры в учетной записи

Можно восстановить все контейнеры в учетной записи хранения, чтобы вернуть их в предыдущее состояние в определенный момент времени.

# <a name="azure-portal"></a>[Портал Azure](#tab/portal)

Чтобы восстановить все контейнеры и большие двоичные объекты в учетной записи хранения с портал Azure, выполните следующие действия.

1. Перейдите к списку контейнеров для своей учетной записи хранения.
1. На панели инструментов выберите **восстановить контейнеры**, а затем **восстановить все**.
1. На панели **восстановить все контейнеры** укажите точку восстановления, указав дату и время.
1. Убедитесь, что вы хотите выполнить установку, установив флажок.
1. Нажмите кнопку **восстановить** , чтобы начать операцию восстановления.

    :::image type="content" source="media/point-in-time-restore-manage/restore-all-containers-portal.png" alt-text="Снимок экрана, показывающий, как восстановить все контейнеры до указанной точки восстановления":::

# <a name="powershell"></a>[PowerShell](#tab/powershell)

Чтобы восстановить все контейнеры и большие двоичные объекты в учетной записи хранения с помощью PowerShell, вызовите команду **RESTORE-азсторажеблобранже** и укажите точку восстановления как значение даты и времени в формате UTC. По умолчанию команда **RESTORE-азсторажеблобранже** выполняется асинхронно и возвращает объект типа **псблобресторестатус** , который можно использовать для проверки состояния операции восстановления.

Следующий пример асинхронно восстанавливает контейнеры в учетной записи хранения до состояния 12 часов до текущего момента и проверяет некоторые свойства операции восстановления.

```powershell
# Specify -TimeToRestore as a UTC value
$restoreOperation = Restore-AzStorageBlobRange -ResourceGroupName $rgName `
    -StorageAccountName $accountName `
    -TimeToRestore (Get-Date).ToUniversalTime().AddHours(-12)

# Get the status of the restore operation.
$restoreOperation.Status
# Get the ID for the restore operation.
$restoreOperation.RestoreId
# Get the restore point in UTC time.
$restoreOperation.Parameters.TimeToRestore
```

Чтобы выполнить операцию восстановления синхронно, включите в команду параметр **-ваитфоркомплете** . Если присутствует параметр **-ваитфоркомплете** , PowerShell отображает сообщение, содержащее идентификатор восстановления для операции, а затем блокирует выполнение до завершения операции восстановления. Помните, что время, необходимое для операции восстановления, зависит от объема восстанавливаемых данных, и выполнение большого количества операций восстановления может занять до часа.

```powershell
Restore-AzStorageBlobRange -ResourceGroupName $rgName `
    -StorageAccountName $accountName `
    -TimeToRestore (Get-Date).AddHours(-12) -WaitForComplete
```

# <a name="azure-cli"></a>[Azure CLI](#tab/azure-cli)

Чтобы восстановить все контейнеры и большие двоичные объекты в учетной записи хранения с Azure CLI, вызовите команду [AZ Storage BLOB Restore](/cli/azure/storage/blob#az_storage_blob_restore) и укажите точку восстановления как значение даты и времени в формате UTC.

В следующем примере выполняется асинхронное восстановление всех контейнеров в учетной записи хранения в состояние 12 часов до указанной даты и времени. Чтобы проверить состояние операции восстановления, вызовите команду [AZ Storage Account показывать](/cli/azure/storage/account#az_storage_account_show):

```azurecli
az storage blob restore \
    --resource-group <resource_group> \
    --account-name <storage-account> \
    --time-to-restore 2021-01-14T06:31:22Z \
    --no-wait
```

Чтобы проверить свойства операции восстановления, вызовите команду [AZ Storage Account](/cli/azure/storage/account#az_storage_account_show) , чтобы отобразить и развернуть свойство **блобресторестатус** . В следующем примере показано, как проверить свойство **Status** .

```azurecli
az storage account show \
    --name <storage-account> \
    --resource-group <resource_group> \ 
    --expand blobRestoreStatus \
    --query blobRestoreStatus.status \
    --output tsv
```

Чтобы команда **AZ Storage BLOB Restore** выполнялась синхронно и блокируется на выполнение до завершения операции восстановления, опустите `--no-wait` параметр.

---

### <a name="restore-ranges-of-block-blobs"></a>Восстановление диапазонов блочных BLOB-объектов

Вы можете восстановить один или несколько лексикографическом диапазонов BLOB-объектов в одном контейнере или в нескольких контейнерах, чтобы вернуть эти большие двоичные объекты к их предыдущему состоянию в определенный момент времени.

# <a name="azure-portal"></a>[Портал Azure](#tab/portal)

Чтобы восстановить диапазон больших двоичных объектов в одном или нескольких контейнерах с портал Azure, выполните следующие действия.

1. Перейдите к списку контейнеров для своей учетной записи хранения.
1. Выберите контейнер или контейнеры для восстановления.
1. На панели инструментов выберите **восстановить контейнеры**, а затем — **восстановить выбранные**.
1. В области **восстановить выбранные контейнеры** укажите точку восстановления, указав дату и время.
1. Укажите диапазоны для восстановления. Используйте косую черту (/) для отделения имени контейнера от префикса большого двоичного объекта.
1. По умолчанию в области **восстановить выбранные контейнеры** указывается диапазон, включающий в себя все большие двоичные объекты в контейнере. Удалите этот диапазон, если не хотите восстанавливать весь контейнер. Диапазон по умолчанию показан на следующем рисунке.

    :::image type="content" source="media/point-in-time-restore-manage/delete-default-blob-range.png" alt-text="Снимок экрана, показывающий диапазон больших двоичных объектов по умолчанию для удаления перед указанием пользовательского диапазона":::

1. Убедитесь, что вы хотите выполнить установку, установив флажок.
1. Нажмите кнопку **восстановить** , чтобы начать операцию восстановления.

На следующем рисунке показана операция восстановления набора диапазонов.

:::image type="content" source="media/point-in-time-restore-manage/restore-multiple-container-ranges-portal.png" alt-text="Снимок экрана, показывающий, как восстановить диапазоны больших двоичных объектов в одном или нескольких контейнерах":::

Операция восстановления, показанная на образе, выполняет следующие действия.

- Восстанавливает полное содержимое *container1*.
- Восстанавливает большие двоичные объекты в диапазоне лексикографическом *blob1* через *blob5* в *контейнера container2*. Этот диапазон восстанавливает большие двоичные объекты с такими именами, как *blob1*, *blob11*, *blob100*, *blob2* и т. д. Так как конец диапазона является эксклюзивным, он восстанавливает большие двоичные объекты, имена которых начинаются с *blob4*, но не восстанавливает большие двоичные объекты, имена которых начинаются с *blob5*.
- Восстанавливает все большие двоичные объекты в *container3* и *container4*. Так как конец диапазона является эксклюзивным, этот диапазон не восстанавливает *container5*.

# <a name="powershell"></a>[PowerShell](#tab/powershell)

Чтобы восстановить один диапазон больших двоичных объектов, вызовите команду **RESTORE-азсторажеблобранже** и укажите диапазон лексикографическом для имени контейнера и большого двоичного объекта для `-BlobRestoreRange` параметра. Например, чтобы восстановить большие двоичные объекты в одном контейнере с именем *container1*, можно указать диапазон, начинающийся с *container1* и заканчивающийся на *контейнера container2*. Не требуется существование контейнеров с именами в начальном и конечном диапазонах. Так как конец диапазона является эксклюзивным, даже если учетная запись хранения содержит контейнер с именем *контейнера container2*, будет восстановлен только контейнер с именем *container1* :

```powershell
$range = New-AzStorageBlobRangeToRestore -StartRange container1 `
    -EndRange container2
```

Чтобы указать подмножество больших двоичных объектов в контейнере для восстановления, используйте косую черту (/), чтобы отделить имя контейнера от шаблона префикса BLOB-объектов. Например, следующий диапазон выбирает большие двоичные объекты в одном контейнере, имена которых начинаются с букв *d* по *f*:

```powershell
$range = New-AzStorageBlobRangeToRestore -StartRange container1/d `
    -EndRange container1/g
```

Затем укажите диапазон для команды **RESTORE-азсторажеблобранже** . Укажите точку восстановления, указав значение **даты и времени** в формате UTC для `-TimeToRestore` параметра. В следующем примере выполняется восстановление больших двоичных объектов в указанном диапазоне до текущего момента в течение 3 дней:

```powershell
# Specify -TimeToRestore as a UTC value
Restore-AzStorageBlobRange -ResourceGroupName $rgName `
    -StorageAccountName $accountName `
    -BlobRestoreRange $range `
    -TimeToRestore (Get-Date).AddDays(-3)
```

По умолчанию команда **RESTORE-азсторажеблобранже** выполняется асинхронно. При асинхронном запуске операции восстановления PowerShell немедленно отображает таблицу свойств для операции:  

```powershell
Status     RestoreId                            FailureReason Parameters.TimeToRestore     Parameters.BlobRanges
------     ---------                            ------------- ------------------------     ---------------------
InProgress 459c2305-d14a-4394-b02c-48300b368c63               2020-09-15T23:23:07.1490859Z ["container1/d" -> "container1/g"]
```

Чтобы восстановить несколько диапазонов блочных BLOB-объектов, укажите массив диапазонов для `-BlobRestoreRange` параметра. В следующем примере задаются два диапазона для восстановления полного содержимого *container1* и *container4* до состояния 24 часа назад и сохранения результата в переменную:

```powershell
# Specify a range that includes the complete contents of container1.
$range1 = New-AzStorageBlobRangeToRestore -StartRange container1 `
    -EndRange container2
# Specify a range that includes the complete contents of container4.
$range2 = New-AzStorageBlobRangeToRestore -StartRange container4 `
    -EndRange container5

$restoreOperation = Restore-AzStorageBlobRange -ResourceGroupName $rgName `
    -StorageAccountName $accountName `
    -TimeToRestore (Get-Date).AddHours(-24) `
    -BlobRestoreRange @($range1, $range2)

# Get the status of the restore operation.
$restoreOperation.Status
# Get the ID for the restore operation.
$restoreOperation.RestoreId
# Get the blob ranges specified for the operation.
$restoreOperation.Parameters.BlobRanges
```

Чтобы выполнить операцию восстановления синхронно и заблокировать ее выполнение до завершения, включите в команду параметр **-ваитфоркомплете** .

# <a name="azure-cli"></a>[Azure CLI](#tab/azure-cli)

Чтобы восстановить диапазон больших двоичных объектов, вызовите команду [AZ Storage BLOB Restore](/cli/azure/storage/blob#az_storage_blob_restore) и укажите лексикографическом диапазон имен контейнеров и больших двоичных объектов для `--blob-range` параметра. Чтобы указать несколько диапазонов, укажите `--blob-range` параметр для каждого отдельного диапазона.

Например, чтобы восстановить большие двоичные объекты в одном контейнере с именем *container1*, можно указать диапазон, начинающийся с *container1* и заканчивающийся на *контейнера container2*. Не требуется существование контейнеров с именами в начальном и конечном диапазонах. Так как конец диапазона является эксклюзивным, даже если учетная запись хранения содержит контейнер с именем *контейнера container2*, будет восстановлен только контейнер с именем *container1* .

Чтобы указать подмножество больших двоичных объектов в контейнере для восстановления, используйте косую черту (/), чтобы отделить имя контейнера от шаблона префикса BLOB-объектов. В приведенном ниже примере асинхронно восстанавливается диапазон больших двоичных объектов в контейнере, имена которых начинаются с `d` букв `f` .

```azurecli
az storage blob restore \
    --account-name <storage-account> \
    --time-to-restore 2021-01-14T06:31:22Z \
    --blob-range container1 container2
    --blob-range container3/d container3/g
    --no-wait
```

Чтобы команда **AZ Storage BLOB Restore** выполнялась синхронно и блокируется на выполнение до завершения операции восстановления, опустите `--no-wait` параметр.

---

## <a name="next-steps"></a>Дальнейшие действия

- [Восстановление до точки во времени для блочных BLOB-объектов](point-in-time-restore-overview.md)
- [Обратимое удаление](./soft-delete-blob-overview.md)
- [Веб-канал изменений](storage-blob-change-feed.md)
- [Управление версиями BLOB-объектов](versioning-overview.md)