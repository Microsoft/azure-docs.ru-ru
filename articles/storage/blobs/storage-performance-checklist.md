---
title: Контрольный список производительности и масштабируемости для хранилища BLOB-объектов в службе хранилища Azure
description: Контрольный список проверенных методов использования хранилища BLOB-объектов при разработке высокопроизводительных приложений.
services: storage
author: tamram
ms.service: storage
ms.topic: conceptual
ms.date: 10/10/2019
ms.author: tamram
ms.subservice: blobs
ms.custom: devx-track-csharp
ms.openlocfilehash: 14da8b6cb695703f1881b6b0b9858772bde386c5
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "95544757"
---
# <a name="performance-and-scalability-checklist-for-blob-storage"></a>Контрольный список для обеспечения масштабируемости и производительности для Хранилища таблиц

Корпорация Майкрософт разработала ряд проверенных методик разработки высокопроизводительных приложений с хранилищем BLOB-объектов. Этот контрольный список определяет основные методики, которые помогут разработчикам оптимизировать производительность. Учитывайте эти рекомендации при проектировании приложения и на протяжении всего процесса разработки.

Служба хранилища Azure имеет целевые показатели по масштабируемости и производительности, выраженные в объемах, скорости транзакций и пропускной способности. Дополнительные сведения о целевых показателях масштабируемости службы хранилища Azure см. в разделе [целевые показатели масштабируемости и производительности для стандартных учетных записей хранения](../common/scalability-targets-standard-account.md?toc=%2fazure%2fstorage%2fblobs%2ftoc.json) , [целевые показатели масштабируемости и производительности для хранилища BLOB-объектов](scalability-targets.md).

## <a name="checklist"></a>Контрольный список

В этой статье рассматриваются проверенные методы обеспечения производительности в контрольном списке, который можно выполнить при разработке приложения для хранения BLOB-объектов.

| Готово | Категория | Рекомендации по проектированию |
| --- | --- | --- |
| &nbsp; |Целевые показатели масштабируемости |[Можно ли спроектировать приложение так, чтобы количество используемых учетных записей хранения не превышало максимальное значение?](#maximum-number-of-storage-accounts) |
| &nbsp; |Целевые показатели масштабируемости |[Удастся ли вам избежать приближения к предельным значениям емкости и количеству транзакций?](#capacity-and-transaction-targets) |
| &nbsp; |Целевые показатели масштабируемости |[Есть ли большое количество клиентов, одновременно обращающихся к одному большому двоичному объекту?](#multiple-clients-accessing-a-single-blob-concurrently) |
| &nbsp; |Целевые показатели масштабируемости |[Ваше приложение находится в целевых показателях масштабируемости для одного большого двоичного объекта?](#bandwidth-and-operations-per-blob) |
| &nbsp; |Секционирование |[Помогает ли ваше соглашения об именовании улучшить распределение нагрузки?](#partitioning) |
| &nbsp; |Сеть |[Имеют ли клиентские устройства достаточно высокую пропускную способность и достаточно низкую задержку для достижения необходимой производительности?](#throughput) |
| &nbsp; |Сеть |[Имеют ли клиентские устройства достаточно высокое качество связи?](#link-quality) |
| &nbsp; |Сеть |[Размещено ли клиентское приложение в том же регионе, что и учетная запись хранения?](#location) |
| &nbsp; |Прямой клиентский доступ |[Используются ли подписанные URL-адреса (SAS) и общий доступ к ресурсам независимо от источника (CORS) для организации прямого доступа к службе хранилища Azure?](#sas-and-cors) |
| &nbsp; |Кэширование |[Данные кэширования приложения часто обращаются к данным и редко меняются?](#reading-data) |
| &nbsp; |Кэширование |[Обновляется ли пакетная обработка приложения путем их кэширования на клиенте и последующей их отправки в более крупные наборы?](#uploading-data-in-batches) |
| &nbsp; |Конфигурация .NET |[Используется ли .NET Core 2.1 или более поздней версии, чтобы обеспечить оптимальную производительность?](#use-net-core) |
| &nbsp; |Конфигурация .NET |[Вы настроили свой клиент на использование достаточного количества одновременных подключений?](#increase-default-connection-limit) |
| &nbsp; |Конфигурация .NET |[Настроено ли для приложений .NET использование достаточного количества потоков?](#increase-minimum-number-of-threads) |
| &nbsp; |Parallelism |[Ограничен ли параллелизм достаточным образом, чтобы нагрузка не превышала возможности клиента и не приближалась к целевым показателям масштабируемости?](#unbounded-parallelism) |
| &nbsp; |Инструменты |[Используются ли последние версии клиентских библиотек и инструментов, предоставленных корпорацией Майкрософт?](#client-libraries-and-tools) |
| &nbsp; |Повторы |[Используется ли политика повтора с экспоненциальной задержкой для ошибок регулирования и превышения времени ожидания?](#timeout-and-server-busy-errors) |
| &nbsp; |Повторы |[Ваше приложение избегает повторов неповторяемых ошибок?](#non-retryable-errors) |
| &nbsp; |Копирование больших двоичных объектов |[Копируются ли большие двоичные объекты наиболее эффективным способом?](#blob-copy-apis) |
| &nbsp; |Копирование больших двоичных объектов |[Используете ли вы последнюю версию AzCopy для операций с массовым копированием?](#use-azcopy) |
| &nbsp; |Копирование больших двоичных объектов |[Используете ли вы семейство Azure Data Box для импорта больших объемов данных?](#use-azure-data-box) |
| &nbsp; |Распространение содержимого |[Используете ли вы CDN для распределения содержимого?](#content-distribution) |
| &nbsp; |Использование метаданных |[Вы храните часто используемые метаданные, касающиеся BLOB-объектов, в их метаданных?](#use-metadata) |
| &nbsp; |Быстрая отправка |[При попытке быстро отправить один BLOB-объект вы осуществляете параллельную отправку блоков?](#upload-one-large-blob-quickly) |
| &nbsp; |Быстрая отправка |[При попытке быстро отправить множество BLOB-объектов вы отправляете BLOB-объекты параллельно?](#upload-many-blobs-quickly) |
| &nbsp; |Тип большого двоичного объекта |[Используете ли вы при необходимости страничные BLOB-объекты или блочные BLOB-объекты?](#choose-the-correct-type-of-blob) |

## <a name="scalability-targets"></a>Целевые показатели масштабируемости

Если приложение достигает одного из целевых показателей масштабируемости или превышает его, оно может столкнуться с увеличением задержки транзакций или запуском механизма регулировки количества запросов. Когда служба хранилища Azure применяет регулирование для приложения, она начинает возвращать коды ошибки 503 — Server busy (сервер занят) или 500 — Operation timeout (время ожидания операции истекло). Этих ошибок можно избежать, строго соблюдая ограничения для целевых показателей масштабируемости. Это важная часть стратегии по повышению производительности приложения.

См. сведения о [целевых показателях масштабируемости службы хранилища Azure для Службы очередей](../queues/scalability-targets.md#scale-targets-for-queue-storage).

### <a name="maximum-number-of-storage-accounts"></a>Максимальное количество учетных записей хранения

Если вы приближаетесь к максимальному числу учетных записей хранения, разрешенному для определенной комбинации подписки или региона, оцените сценарий и определите, применимы ли какие-либо из следующих условий.

- Вы используете учетные записи хранения для хранения неуправляемых дисков и добавляете эти диски в виртуальные машины? В этом сценарии Корпорация Майкрософт рекомендует использовать управляемые диски. Масштабирование управляемых дисков выполняется автоматически и без необходимости создавать отдельные учетные записи хранения и управлять ими. Дополнительные сведения см. [в статье Введение в управляемые диски Azure](../../virtual-machines/managed-disks-overview.md) .
- Вы используете одну учетную запись хранения для каждого клиента в целях изоляции данных? В этом сценарии Корпорация Майкрософт рекомендует использовать контейнер больших двоичных объектов для каждого клиента, а не всю учетную запись хранения. Служба хранилища Azure теперь позволяет назначать роли Azure отдельно для каждого контейнера. Дополнительные сведения см. в статье [использование портал Azure для назначения роли Azure для доступа к данным BLOB-объектов и очередей](../common/storage-auth-aad-rbac-portal.md).
- Вы используете несколько учетных записей хранения в сегментировании для увеличения количества входящих, исходящих, операций ввода-вывода в секунду или емкости? Для такой ситуации корпорация Майкрософт рекомендует увеличить ограничения по учетным записям хранения, если это возможно, чтобы сократить количество учетных записей хранения для рабочей нагрузки. Запрос на увеличение ограничений на количество учетных записей хранения следует направлять в [службу поддержки Azure](https://azure.microsoft.com/support/options/). Дополнительные сведения см. в [объявлении об учетных записях хранения большего размера и большего масштаба](https://azure.microsoft.com/blog/announcing-larger-higher-scale-storage-accounts/).

### <a name="capacity-and-transaction-targets"></a>Целевые показатели емкости и транзакций

Если приложение достигает целевых показателей масштабируемости, когда речь идет об одной учетной записи хранения, рассмотрите вопрос об использовании одного из следующих подходов:  

- Если приложение обращается к целевому объекту транзакции, рассмотрите возможность использования учетных записей хранения блочных BLOB-объектов, оптимизированных для высокой скорости транзакций и низкой и постоянной задержки. Дополнительные сведения см. в статье [Общие сведения об учетной записи хранения Azure](../common/storage-account-overview.md).
- Пересмотрите рабочую нагрузку, которая приводит к достижению приложением целевого показателя масштабируемости или его превышению. Вы можете спроектировать его по-другому, чтобы использовать меньшую полосу пропускания или производительность, или меньшее количество транзакций?
- Если приложение должно превышать какой-то из целевых показателей масштабируемости, создайте несколько учетных записей хранения и сегментируйте между ними данные приложения. При использовании этого подхода необходимо разработать приложение таким образом, чтобы в будущем для балансировки нагрузки в него можно было добавлять другие учетные записи хранения. Плата взимается только за потребление, то есть объем хранимых и передаваемых данных и совершенные транзакции, но не за сами учетные записи хранения.
- Если приложение приближается к целевым показателям пропускной способности, попробуйте применить сжатие данных на стороне клиента, чтобы снизить пропускную способность, требуемую для отправки данных в службу хранилища Azure.
    Этот способ снижает нагрузку на пропускную способность и повышает производительность сети, но может ухудшать общую производительность. Оцените, как дополнительная работа по сжатию и распаковке данных на стороне клиента влияет на производительность. Не забывайте также, что хранение данных в сжатом виде может усложнить устранение неполадок, так как затрудняет просмотр данных с помощью стандартных инструментов.
- Если приложение достигает целевых показателей масштабируемости, обязательно примените экспоненциальную задержку для повторов. Лучше всего сделать так, чтобы приложение не приближалось к целевым показателям масштабируемости. Для этого примените описанные в этой статье рекомендации. Если же потребуется выполнить регулирование, экспоненциальная задержка позволит избежать слишком частых повторов, которые только ухудшают ситуацию. Дополнительные сведения см. в разделе о [превышении времени ожидания и ошибках занятости сервера](#timeout-and-server-busy-errors).

### <a name="multiple-clients-accessing-a-single-blob-concurrently"></a>Несколько клиентов, одновременно обращающихся к одному большому двоичному объекту

При наличии большого числа клиентов, одновременно обращающихся к одному большому двоичному объекту, необходимо учитывать целевые показатели масштабируемости для каждого большого двоичного объекта и каждой учетной записи хранения. Точное число клиентов, которые могут получить доступ к одному большому двоичному объекту, зависит от таких факторов, как количество клиентов, запрашивающих BLOB-объект одновременно, размер большого двоичного объекта и условия сети.

Если большой двоичный объект может распространяться через сеть CDN, например изображения или видео, обслуживаемые с веб-сайта, можно использовать CDN. Дополнительные сведения см. в разделе [распространение содержимого](#content-distribution).

В других сценариях, например в научных моделировании, где данные конфиденциальны, у вас есть два варианта. Первый заключается в распределении доступа к рабочей нагрузке таким, чтобы доступ к большому двоичному объекту осуществлялся в течение некоторого времени и одновременно к нему осуществлялся доступ. Кроме того, можно временно скопировать большой двоичный объект в несколько учетных записей хранения, чтобы увеличить общее число операций ввода-вывода в секунду на большой двоичный объект и в учетных Результаты будут зависеть от поведения приложения, поэтому обязательно протестируйте шаблоны параллелизма во время проектирования.

### <a name="bandwidth-and-operations-per-blob"></a>Пропускная способность и операции на большой двоичный объект

Один большой двоичный объект поддерживает до 500 запросов в секунду. Если у вас есть несколько клиентов, которым необходимо считать один большой двоичный объект и вы можете превысить это ограничение, рассмотрите возможность использования учетной записи хранилища блочных BLOB-объектов. Учетная запись хранения блочного BLOB-объекта обеспечивает более высокий уровень запросов или операций ввода-вывода в секунду.

Для распределения операций в большом двоичном объекте можно также использовать сеть доставки содержимого (CDN), например Azure CDN. Дополнительные сведения о Azure CDN см. в разделе Общие сведения о [Azure CDN](../../cdn/cdn-overview.md).  

## <a name="partitioning"></a>Секционирование

Общие сведения о секционировании данных BLOB-объектов в хранилище Azure для повышения производительности. Служба хранилища Azure может обслуживать данные в одном разделе быстрее, чем данные, охватывающие несколько секций. Назвав соответствующие большие двоичные объекты, можно повысить эффективность запросов на чтение.

Хранилище BLOB-объектов использует схему секционирования на основе диапазона для масштабирования и балансировки нагрузки. Каждый BLOB-объект имеет ключ секции, состоящий из полного имени большого двоичного объекта (учетная запись + контейнер + BLOB-объект). Ключ секции используется для секционирования данных большого двоичного объекта в диапазоны. Затем диапазоны распределяются между хранилищем BLOB-объектов.

Секционирование на основе диапазона означает, что соглашения об именовании, использующие лексическую сортировку (например, *мипайролл*, *миперформанце*, *мемплойис* и т. д.) или метки времени (*log20160101*, *log20160102*, *log20160102* и т. д.), скорее всего, приводят к совместному размещению секций на одном сервере секционирования. , до увеличения нагрузки необходимо, чтобы они были разделены на меньшие диапазоны. Совместное размещение больших двоичных объектов на одном сервере секционирования повышает производительность, поэтому важная часть улучшения производительности включает в себя именование больших двоичных объектов способом, который наиболее эффективно организует их.

Например, все BLOB-объекты в контейнере могут обрабатываться одним и тем же сервером, пока нагрузка на эти BLOB-объекты не потребует дополнительного перераспределения диапазонов секций. Аналогичным образом группа нераспределенных учетных записей с именами, упорядоченными в лексической последовательности, может обслуживаться одним сервером до тех пор, пока нагрузка на одну или все из этих учетных записей не требует разбиения на несколько серверов секционирования.

Каждая операция балансировки нагрузки может вызывать задержку вызовов хранилища во время ее выполнения. Способность службы управлять резкой интенсивностью трафика в секцию ограничивается масштабируемостью односекционного сервера до тех пор, пока операция балансировки нагрузки не запустится и не будет перераспределять диапазон ключей секций.

Частоту выполнения таких операций можно уменьшить.  

- Если возможно, используйте большие двоичные объекты или размеры блоков, превышающие 4, для учетных записей хранения уровня "Стандартный" и более 256 КИБ для учетных записей хранения класса Premium. Больший размер большого двоичного объекта или блока автоматически активирует блочные BLOB-объекты высокой пропускной способности. Блочные BLOB-объекты с высокой пропускной способностью обеспечивают высокую производительность и не зависят от именования секций.
- Изучите соглашение об именовании, используемое для учетных записей, контейнеров, больших двоичных объектов, таблиц и очередей. Попробуйте предварительно исправить имена учетной записи, контейнера или BLOB-объекта с тремя цифрами, используя функцию хэширования, которая лучше подходит для ваших потребностей.
- Если данные упорядочиваются с помощью меток времени или числовых идентификаторов, убедитесь, что вы не используете шаблон трафика только для добавления (или только в начале). Эти шаблоны не подходят для системы секционирования на основе диапазона. Эти шаблоны могут привести к тому, что весь трафик помещается в одну секцию и ограничивает систему от эффективной балансировки нагрузки.

    Например, при наличии ежедневных операций, использующих большой двоичный объект с меткой времени, например *ГГГГММДД*, весь трафик для этой ежедневной операции направляется в один большой двоичный объект, обслуживаемый одним сервером секций. Определите, соответствуют ли ограничения для больших двоичных объектов и ограничения на секции в соответствии с вашими потребностями, и при необходимости рассмотрите возможность разбиения этой операции на несколько больших двоичных объектов. Аналогично, если данные временных рядов хранятся в таблицах, весь трафик может быть направлен к последней части пространства имен Key. Если вы используете числовые идентификаторы, добавьте префикс в идентификатор с тремя цифрами. Если используются метки времени, добавьте к метке времени значение секунд, например *ссииииммдд*. Если приложение выполняет операции перечисления и запроса, выберите функцию хэширования, которая ограничит количество запросов. В некоторых случаях может быть достаточно случайного префикса.
  
- Дополнительные сведения о схеме секционирования, используемой в службе хранилища Azure, см. в статье [хранилище Azure: высокодоступная служба облачного хранилища со строгой согласованностью](https://sigops.org/sosp/sosp11/current/2011-Cascais/printable/11-calder.pdf).

## <a name="networking"></a>Сеть

Физические ограничения сети, в которой работает приложение, оказывают существенное влияние на производительность. В следующих разделах описаны некоторые ограничения, с которыми могут столкнуться пользователи.  

### <a name="client-network-capability"></a>Возможности клиентской сети

Пропускная способность и качество сетевого подключения являются важными факторами, влияющими на производительность приложения, как описано в следующих разделах.

#### <a name="throughput"></a>Пропускная способность

Что касается полосы пропускания, частой проблемой являются возможности клиента. Очень крупные экземпляры Azure имеют сетевые карты, обладающие большими возможностями, поэтому если необходимы более высокие сетевые ограничения от одной машины, следует рассмотреть возможность использования более крупного экземпляра или большего количества виртуальных машин. Если локальное приложение будет обращаться к службе хранилища Azure, примените ту же стратегию. Оцените сетевые возможности клиентского устройства и подключения к расположению службы хранилища Azure, а затем увеличьте их до необходимого уровня или учтите эти ограничения при проектировании приложения.

#### <a name="link-quality"></a>Качество связи

Помните, что состояние любой используемой сети, приводящее к ошибкам и потере пакетов, снижает эффективную пропускную способность.  Использование инструмента WireShark или NetMon может помочь в диагностике этой проблемы.  

### <a name="location"></a>Расположение

В любой распределенной среде наилучшее быстродействие достигается при нахождении клиента рядом с сервером. Для доступа к хранилищу Azure с наименьшей задержкой лучшим местом для клиента будет его нахождение в том же регионе Azure. Например, если ваше веб-приложение Azure использует службу хранилища Azure, обе службы лучше разместить в пределах одного региона (западная часть США, Юго-Восточная Азия и т. д.). Совместное размещение ресурсов уменьшает задержку и снижает стоимость, так как трафик в пределах одного региона остается бесплатным.  

Если же клиентские приложения, которые используют службу хранилища Azure, не размещены в Azure (например, приложения для мобильных устройств или локальные корпоративные службы), учетную запись хранения следует разместить в регионе, максимально приближенном к этим клиентам, так как это может снизить задержку. Если клиенты разбросаны по всему миру (например, часть в Северной Америке, а остальные в Европе), обдумайте вариант с несколькими учетными записями хранения, по одной в каждом регионе. Такой подход легче реализовать, если данные, которые хранят приложения, предназначены для отдельных пользователей, и не требуют репликации между учетными записями хранения.

Для широкого распределения содержимого BLOB-объектов используйте сеть доставки данных, например Azure CDN. Для получения дополнительной информации о сети Azure CDN см. статью [Сеть кэширующих серверов](../../cdn/cdn-overview.md).  

## <a name="sas-and-cors"></a>SAS и CORS

Предположим, что вам нужно создать код JavaScript, который выполняется в веб-браузере пользователя или приложении на мобильном телефоне и обращается к данным в службе хранилища Azure. Один из вариантов — создать приложение-службу, которое выполнит роль прокси-сервера. Устройство пользователя проходит проверку подлинности в этой службе, которая, в свою очередь, предоставляет доступ к ресурсам службы хранилища Azure. Таким образом, на небезопасных устройствах можно не сообщать ключи своей учетной записи хранения. Но такой подход создает значительную нагрузку на приложение-службу, через которое проходят все данные, передаваемые между пользовательским устройством и службой хранилища Azure.

Вы можете обойтись без приложения-службы прокси-сервера, обращаясь к службе хранилища Azure с использованием подписанных URL-адресов (SAS). С технологией SAS вы можете разрешить пользовательскому устройству напрямую обращаться к службе хранилища Azure с маркером ограниченного доступа. Например, если пользователь хочет отправить фотографию в приложение, приложение-служба создаст SAS и отправит его на устройство пользователя. Маркер SAS может предоставлять разрешение на запись в ресурс службы хранилища Azure в течение указанного интервала времени. По истечении этого времени маркер SAS становится недействительным. Дополнительные сведения о подписанных URL-адресах см. в статье об [использование подписанных URL-адресов SAS в службе хранилища Azure](../common/storage-sas-overview.md).  

Обычно браузер не разрешает выполнять в коде JavaScript некоторые операции, например запись данных, в домене, отличном от домена размещения страницы с этим кодом. Эта политика использования одного источника не позволяет вредоносному коду с любой веб-страницы получить доступ к данным, размещенным на другой странице. Но при создании облачного решения политика использования одного источника становится неудобным ограничением. Реализуемая на уровне браузера технология CORS (общий доступ к ресурсам независимо от источника) позволяет целевому домену сообщать браузеру, что он доверяет запросам, поступающим из определенных исходных доменов.

Предположим, что выполняемое в Azure веб-приложение обращается к ресурсу в учетной записи хранения Azure. В этом сценарии веб-приложение выполняет роль исходного домена, а учетная запись хранения является целевым доменом. Вы можете настроить CORS для любой из служб хранилища Azure, чтобы она сообщала веб-браузеру о том, что служба хранилища Azure доверяет запросам, поступающим из исходного домена. Дополнительные сведения о технологии CORS см. в статье [Cross-Origin Resource Sharing (CORS) support for Azure Storage](/rest/api/storageservices/Cross-Origin-Resource-Sharing--CORS--Support-for-the-Azure-Storage-Services) (Поддержка общего доступа к ресурсам независимо от источника (CORS) для службы хранилища Azure).  
  
Технологии SAS и CORS помогают избавиться от лишней нагрузки на веб-приложения.  

## <a name="caching"></a>Кэширование

Кэширование играет важную роль в производительности. В следующих разделах рассматриваются рекомендации по кэшированию.

### <a name="reading-data"></a>Чтение данных

Как правило, чтение данных является предпочтительным для чтения в два раза. Рассмотрим пример веб-приложения, которое получило большой двоичный объект MiB 50 из службы хранилища Azure, который будет служить содержимым для пользователя. В идеале приложение кэширует большой двоичный объект локально на диск, а затем извлекает кэшированную версию для последующих запросов пользователей.

Одним из способов избежать извлечения большого двоичного объекта, если он не был изменен с момента кэширования, является уточнение операции GET с условным заголовком для времени изменения. Если время последнего изменения превышает время кэширования большого двоичного объекта, большой двоичный объект извлекается и повторно кэшируется. В противном случае кэшированный большой двоичный объект извлекается для оптимальной производительности.

Вы также можете разработать приложение, чтобы предположить, что большой двоичный объект остается неизменным в течение короткого периода после его получения. В этом случае приложению не нужно проверять, был ли изменен большой двоичный объект в течение этого интервала.

Данные конфигурации, данные подстановки и другие данные, часто используемые приложением, являются хорошим кандидатом для кэширования.  

Дополнительные сведения об использовании условных заголовков см. в разделе [Указание условных заголовков для операций службы BLOB-объектов](/rest/api/storageservices/specifying-conditional-headers-for-blob-service-operations).  

### <a name="uploading-data-in-batches"></a>Отправка данных в пакетах

В некоторых сценариях можно выполнить статистическую обработку данных локально, а затем периодически передать их в пакет, а не загружать каждый фрагмент данных немедленно. Например, предположим, что веб-приложение сохраняет файл журнала действий. Приложение может либо передавать сведения о каждом действии в таблицу (что требует большого количества операций с хранилищем), либо сохранять сведения о действиях в локальном файле журнала, а затем периодически отправлять все сведения о действиях в виде файла с разделителями в большой двоичный объект. Если размер каждой записи в журнале составляет 1 КБ, можно передать тысячи записей в одной транзакции. Одна транзакция поддерживает передачу большого двоичного объекта размером до 64 MiB. Разработчик приложения должен быть разработан для возможности клиентского устройства или сбоя передачи. Если данные действия необходимо скачать в течение интервала времени, а не для одного действия, рекомендуется использовать хранилище BLOB-объектов в хранилище таблиц.

## <a name="net-configuration"></a>Конфигурация .NET

В данном разделе перечислены несколько быстрых параметров конфигурации, которые можно использовать для значительного повышения производительности при использовании платформы .NET Framework.  При использовании других языков проверьте, применяются ли в выбранном языке подобные концепции.  

### <a name="use-net-core"></a>Использование .NET Core

Для разработки приложений, взаимодействующих со службой хранилища Azure, используйте .NET Core 2.1 или более поздних версий, в которых реализованы некоторые улучшения производительности. Мы рекомендуем использовать .NET Core 3.x всегда, когда это возможно.

Дополнительные сведения о повышении производительности в .NET Core вы можете получить в следующих записях блога:

- [о повышении производительности в .NET Core 3.0](https://devblogs.microsoft.com/dotnet/performance-improvements-in-net-core-3-0/);
- [о повышении производительности в .NET Core 2.1](https://devblogs.microsoft.com/dotnet/performance-improvements-in-net-core-2-1/).

### <a name="increase-default-connection-limit"></a>Увеличение стандартного ограничения на количество подключений

В .NET следующий код увеличивает ограничение числа подключений по умолчанию (обычно это два в клиентской среде или десять в серверной среде) до 100. В обычном случае следует установить значение, приблизительно соответствующее количеству потоков, используемых приложением. Ограничение количества подключений должно быть установлено до открытия каких-либо подключений.

```csharp
ServicePointManager.DefaultConnectionLimit = 100; //(Or More)  
```

Сведения о других языках программирования см. в документации, чтобы определить, как установить ограничение числа подключений.  

Дополнительные сведения см. в записи блога [Web Services: Concurrent Connections ](/archive/blogs/darrenj/web-services-concurrent-connections) (Веб-службы: параллельные подключения).  

### <a name="increase-minimum-number-of-threads"></a>Увеличение минимального количества потоков

Если вы используете синхронные вызовы с асинхронными задачами, есть смысл увеличить количество потоков в пуле потоков:

```csharp
ThreadPool.SetMinThreads(100,100); //(Determine the right number for your application)  
```

См. описание метода [ThreadPool.SetMinThreads](/dotnet/api/system.threading.threadpool.setminthreads).  

## <a name="unbounded-parallelism"></a>Неограниченный параллелизм

Параллелизм часто очень полезен для повышения производительности, но следует с настороженностью относиться к неограниченному параллелизму, то есть к отсутствию ограничений на количество потоков или параллельных запросов. Обязательно ограничьте количество параллельных запросов на отправку или скачивание данных, на доступ к нескольким секциям в одной учетной записи хранения и на доступ к нескольким элементам в одной секции. При неограниченном параллелизме приложение сможет превысить возможности клиентского устройства или целевые показатели масштабируемости для учетных записей хранения, что приведет к увеличению задержек и применению регулирования.  

## <a name="client-libraries-and-tools"></a>Клиентские библиотеки и средства

Для повышения производительности всегда используйте самые последние версии клиентских библиотек и средств, предоставляемых корпорацией Майкрософт. Клиентские библиотеки службы хранилища Azure доступны для многих языков. Обозреватель службы хранилища также поддерживает PowerShell и Azure CLI. Корпорация Майкрософт активно развивает эти клиентские библиотеки и средства, оптимизируя их производительность, поддерживая их согласованность с последними версиями служб и реализуя внутреннюю поддержку для многих проверенных методов повышения производительности.

## <a name="handle-service-errors"></a>Обработка ошибок службы

Служба хранилища Azure возвращает ошибку, если ей не удается обработать запрос. Понимание ошибок, которые возвращает служба хранилища Azure, и соответствующих сценариев, помогает оптимизировать производительность.

### <a name="timeout-and-server-busy-errors"></a>Ошибки времени ожидания и занятости сервера

Служба хранилища Azure может применять регулирование к приложению, когда его загрузка приближается к ограничениям масштабируемости. В некоторых случаях служба хранилища Azure не может обработать запрос из-за некоторого временного состояния. В обоих случаях служба может вернуть ошибку 503 — Server Busy (сервер занят) или 500 — Timeout (время ожидания истекло). Эти же ошибки могут возникать, когда служба перераспределяет сегменты данных для повышения пропускной способности. В большинстве случаев при получении таких ошибок приложению следует повторить операцию, которая их вызвала. Но если служба хранилища Azure применяет к приложению регулирование из-за превышения целевых показателей масштабируемости или по другим причинам, долго не позволяющим службе обработать запрос, агрессивная стратегия повторов только усугубит проблему. Мы рекомендуем использовать экспоненциальную задержку для политики повтора. Во всех клиентских библиотеках именно такое поведение является вариантом по умолчанию. Например, приложение может повторить действие через 2 секунды, затем через 4 секунды, затем через 10 секунд, затем через 30 секунд, а затем полностью отказаться от повторения. Это позволяет приложению значительно снизить нагрузку на службу и не усугублять проблемы, связанные с регулированием.  

Ошибки подключения могут вызывать немедленные повторы, так как они не являются результатом регулирования количества запросов и, как ожидается, будут временными.  

### <a name="non-retryable-errors"></a>Ошибки без возможности повтора

Клиентские библиотеки обрабатывают повторы с учетом того, допускает ли ошибка возможность повтора. Но если вы напрямую обращаетесь к REST API службы хранилища Azure, учитывайте ограничение на повтор для некоторых ошибок. Например, ошибка 400 — Bad Request (ошибка запроса) означает, что отправленный клиентским приложением запрос имеет неправильный формат и его невозможно обработать. Повторная отправка такого запроса каждый раз будет возвращать тот же ответ, и в таком повторе нет смысла. Если вы напрямую вызываете REST API службы хранилища Azure, учитывайте возможные варианты ошибок и применимость повторов для них.

Дополнительные сведения о кодах ошибок в службе хранилища Azure вы найдете в статье [Status and Error Codes](/rest/api/storageservices/status-and-error-codes2) (Коды ошибок и состояний).

## <a name="copying-and-moving-blobs"></a>Копирование и перемещение больших двоичных объектов

Служба хранилища Azure предоставляет ряд решений для копирования и перемещения больших двоичных объектов в учетной записи хранения, между учетными записями хранения и между локальными системами и облаком. В этом разделе описываются некоторые из этих параметров с точки зрения их влияния на производительность. Сведения о эффективном переносе данных в хранилище BLOB-объектов и из него см. в статье [Выбор решения Azure для передачи данных](../common/storage-choose-data-transfer-solution.md?toc=%2fazure%2fstorage%2fblobs%2ftoc.json).

### <a name="blob-copy-apis"></a>API копирования BLOB-объектов

Чтобы скопировать большие двоичные объекты в учетных записях хранения, используйте операцию [размещения блока из URL-адреса](/rest/api/storageservices/put-block-from-url) . Эта операция синхронно копирует данные из любого источника URL-адреса в блочный большой двоичный объект. Использование `Put Block from URL` операции может значительно снизить необходимую пропускную способность при переносе данных между учетными записями хранения. Поскольку операция копирования выполняется на стороне службы, вам не нужно скачивать и повторно отправлять данные.

Чтобы скопировать данные в одну и ту же учетную запись хранения, используйте операцию [копирования BLOB-объектов](/rest/api/storageservices/Copy-Blob) . Копирование данных в одной учетной записи хранения обычно выполняется быстро.  

### <a name="use-azcopy"></a>Использование AzCopy

Служебная программа командной строки AzCopy — это простой и эффективный вариант для выполнения групповой перемещения больших двоичных объектов в учетные записи хранения, из и между ними. AzCopy оптимизирован для этого сценария и может обеспечить высокую скорость передачи. AzCopy версии 10 использует `Put Block From URL` операцию для копирования данных большого двоичного объекта между учетными записями хранения. Дополнительные сведения см. в статье [копирование или перемещение данных в службу хранилища Azure с помощью AzCopy V10](../common/storage-use-azcopy-v10.md).  

### <a name="use-azure-data-box"></a>Использование Azure Data Box

Для импорта больших объемов данных в хранилище BLOB-объектов рассмотрите возможность использования семейства Azure Data Box для автономной передачи. Предоставляемые корпорацией Майкрософт устройства Data Box являются хорошим выбором для перемещения больших объемов данных в Azure, если вы ограничиваете время, доступность сети или расходы. Дополнительные сведения см. в [документации по Azure датабокс](../../databox/index.yml).

## <a name="content-distribution"></a>Распространение содержимого

Иногда приложение должно обслуживать одно и то же содержимое для многих пользователей (например, демонстрационный видеоролик о продукте, используемый на домашней странице веб-сайта), расположенном в одном или нескольких регионах. В этом сценарии используйте сеть доставки содержимого (CDN), например Azure CDN для распределения содержимого BLOB-объектов географически. В отличие от учетной записи хранилища Azure, которая существует в одном регионе и которая не может распространять содержимое с минимальной задержкой в другие регионы, сеть Azure CDN использует серверы, расположенные в нескольких центрах обработки данных по всему миру. Кроме того, сеть CDN обычно поддерживает гораздо более высокие ограничения на выходе, чем одна учетная запись хранения.  

Для получения дополнительной информации о сети Azure CDN см. статью [Сеть кэширующих серверов](../../cdn/cdn-overview.md).

## <a name="use-metadata"></a>Использование метаданных

Служба BLOB-объектов поддерживает запросы HEAD, которые могут включать свойства или метаданные большого двоичного объекта. Например, если приложению нужны данные из фотографии в формате "EXIF" (с форматом обмена изображениями), он может извлечь фотографию и извлечь ее. Чтобы сэкономить пропускную способность и повысить производительность, приложение может сохранять данные EXIF в метаданных большого двоичного объекта, когда приложение отправляет фотографию. Затем можно получить данные EXIF в метаданных, используя только запрос HEAD. Получение только метаданных, а не полного содержимого большого двоичного объекта экономит значительную пропускную способность и сокращает время обработки, необходимое для извлечения данных EXIF. Помните, что для большого двоичного объекта можно хранить 8 КИБ метаданных.  

## <a name="upload-blobs-quickly"></a>Быстрое отправку больших двоичных объектов

Чтобы быстро передать большие двоичные объекты, сначала определите, будет ли загружаться один или несколько больших двоичных объектов. Чтобы правильно выбрать метод работы, используйте сведения из приведенного ниже руководства.  

### <a name="upload-one-large-blob-quickly"></a>Быстрое перегрузка одного большого двоичного объекта

Чтобы быстро передать один большой большой двоичный объект, клиентское приложение может параллельно передавать блоки или страницы, учитывать из целевых показателей масштабируемости для отдельных больших двоичных объектов и учетной записи хранения в целом. Клиентские библиотеки службы хранилища Azure поддерживают отправку в параллельном режиме. Например, можно использовать следующие свойства, чтобы указать количество одновременных запросов, разрешенных в .NET или Java. Клиентские библиотеки для других поддерживаемых языков предоставляют аналогичные параметры.

- Для .NET задайте свойство [BlobRequestOptions. ParallelOperationThreadCount](/dotnet/api/microsoft.azure.storage.blob.blobrequestoptions.paralleloperationthreadcount) .
- Для Java/Android вызовите метод [BlobRequestOptions. сетконкуррентрекуесткаунт (окончательный целочисленный конкуррентрекуесткаунт)](/java/api/com.microsoft.azure.storage.blob.blobrequestoptions.setconcurrentrequestcount) .

### <a name="upload-many-blobs-quickly"></a>Быстрое перегрузка большого количества больших двоичных объектов

Чтобы быстро отправить множество BLOB-объектов, отправьте их параллельно. Передача в параллельном режиме выполняется быстрее, чем отправка одиночных больших двоичных объектов за раз с параллельной передачей на несколько секций, так как она распределяет нагрузку между несколькими разделами службы хранилища. AzCopy выполняет параллельную отправку по умолчанию, как и рекомендуется для данного случая. Дополнительные сведения см. в статье Начало [работы с AzCopy](../common/storage-use-azcopy-v10.md).  

## <a name="choose-the-correct-type-of-blob"></a>Выберите правильный тип большого двоичного объекта

Служба хранилища Azure поддерживает блочные, добавочные и страничные BLOB-объекты. В данном случае использования выбор типа BLOB-объекта будет влиять на производительность и масштабируемость решения.

Блочные BLOB-объекты подходят, если требуется эффективно передавать большие объемы данных. Например, клиентское приложение, которое отправляет фотографии или видео в хранилище BLOB-объектов, будет нацелено на блочные BLOB-объекты.

Добавочные большие двоичные объекты похожи на блочные BLOB-объекты в том, что они состоят из блоков. При изменении добавляемого большого двоичного объекта блоки добавляются только в конец большого двоичного объекта. Добавочные BLOB-объекты полезны для таких сценариев, как ведение журнала, когда приложению необходимо добавить данные в существующий большой двоичный объект.

Страничные BLOB-объекты подходят, если приложению требуется выполнять случайные операции записи данных. Например, диски виртуальной машины Azure хранятся в виде страничных BLOB-объектов. Дополнительные сведения см. в разделе [понятие блочных BLOB-объектов, Добавление больших двоичных объектов и страничных больших двоичных объектов](/rest/api/storageservices/understanding-block-blobs--append-blobs--and-page-blobs).  

## <a name="next-steps"></a>Дальнейшие действия

- [Целевые показатели масштабируемости и производительности для хранилища BLOB-объектов](scalability-targets.md)
- [Целевые показатели масштабируемости и производительности для учетных записей хранения ценовой категории "Стандартный"](../common/scalability-targets-standard-account.md?toc=%2fazure%2fstorage%2fblobs%2ftoc.json)
- [Коды состояний и ошибок](/rest/api/storageservices/Status-and-Error-Codes2)