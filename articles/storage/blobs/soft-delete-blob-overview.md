---
title: Обратимое удаление для больших двоичных объектов
titleSuffix: Azure Storage
description: Обратимое удаление для больших двоичных объектов обеспечивает защиту данных, позволяя легко восстанавливать данные при ошибочном изменении или удалении приложения или другого пользователя учетной записи хранения.
services: storage
author: tamram
ms.service: storage
ms.topic: conceptual
ms.date: 07/15/2020
ms.author: tamram
ms.subservice: blobs
ms.openlocfilehash: a2c26c3e41f64a1593a2d3386c76427c0b9682e9
ms.sourcegitcommit: 02b1179dff399c1aa3210b5b73bf805791d45ca2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/12/2021
ms.locfileid: "98127487"
---
# <a name="soft-delete-for-blobs"></a>Обратимое удаление для больших двоичных объектов

Обратимое удаление для больших двоичных объектов защищает данные от случайного или ошибочного изменения или удаления. При включении обратимого удаления для больших двоичных объектов для учетной записи хранения большие двоичные объекты, версии больших двоичных объектов и моментальные снимки в этой учетной записи хранения могут быть восстановлены после удаления в течение указанного срока хранения.

Если есть вероятность, что данные могут быть случайно изменены или удалены приложением или другим пользователем учетной записи хранения, Майкрософт рекомендует включить обратимое удаление. Дополнительные сведения о включении обратимого удаления см. в разделе Включение обратимого [удаления для больших двоичных объектов и управление ими](./soft-delete-blob-enable.md).

[!INCLUDE [storage-data-lake-gen2-support](../../../includes/storage-data-lake-gen2-support.md)]

## <a name="about-soft-delete-for-blobs"></a>Об обратимом удалении больших двоичных объектов

Когда обратимое удаление для больших двоичных объектов включено в учетной записи хранения, можно восстановить объекты после их удаления в течение указанного срока хранения данных. Эта защита распространяется на любые большие двоичные объекты (блочные BLOB-объекты, добавочные большие двоичные объекты или страничные BLOB-объекты), которые удаляются в результате перезаписи.

Если данные в существующем большом двоичном объекте или моментальном снимке удаляются при включенном обратимом удалении BLOB-объектов, но управление версиями BLOB-объектов не включено, создается Обратимо удаленный моментальный снимок для сохранения состояния перезаписанных данных. По истечении указанного срока хранения объект окончательно удаляется.

Если управление версиями BLOB-объектов и обратимое удаление BLOB-объектов включены в учетной записи хранения, то при удалении большого двоичного объекта вместо обратимо удаленного моментального снимка создается новая версия. Новая версия не удаляется без обратимого удаления и не будет удалена после истечения срока хранения обратимого удаления. Обратимо удаленные версии большого двоичного объекта можно восстановить в течение срока хранения, вызвав операцию [отмены удаления большого двоичного объекта](/rest/api/storageservices/undelete-blob) . Затем можно восстановить большой двоичный объект из одной из его версий, вызвав операцию [копирования BLOB-объектов](/rest/api/storageservices/copy-blob) . Дополнительные сведения об использовании управления версиями BLOB-объектов и обратимого удаления см. в разделе [Управление версиями BLOB-объектов и обратимое удаление](versioning-overview.md#blob-versioning-and-soft-delete).

Обратимо удаленные объекты невидимы, если их явно не перечислить.

Обратимое удаление BLOB-объектов обеспечивает обратную совместимость, поэтому вам не нужно вносить какие-либо изменения в приложения, чтобы воспользоваться преимуществами защиты, обеспечиваемой этой функцией. Тем не менее для [восстановления данных](#recovery) разработан новый API **отмены удаления большого двоичного объекта**.

Обратимое удаление BLOB-объектов доступно как для новых, так и для существующих учетных записей общего назначения версии 1, общего назначения v1 и хранилища BLOB-объектов. Поддерживаются типы учетных записей "Стандартный" и "Премиум". Обратимое удаление BLOB-объектов доступно для всех уровней хранилища, включая горячий, холодное и архивный. Обратимое удаление доступно для неуправляемых дисков, которые являются страничными BLOB-объектами на самом деле, но недоступны для управляемых дисков.

### <a name="configuration-settings"></a>Параметры конфигурации

При создании новой учетной записи обратимое удаление по умолчанию отключено. Обратимое удаление также отключено по умолчанию для существующих учетных записей хранения. Вы можете включить или отключить обратимое удаление для учетной записи хранения в любое время.

При включении обратимого удаления необходимо настроить срок хранения. Это количество времени, в течение которого обратимо удаленные данные хранятся и будут доступны для восстановления. Для объектов, которые явным образом удаляются, при удалении данных начинается период хранения. Для обратимо удаленных версий или моментальных снимков, созданных функцией обратимого удаления при переписывания данных, часы запускаются при создании версии или моментального снимка. Срок хранения может составлять от 1 до 365 дней.

Период хранения обратимо удаляемых данных можно изменить в любое время. Обновленный срок хранения применяется только к вновь удаленным данным. Срок действия ранее удаленных данных истекает в зависимости от срока хранения, настроенного при удалении этих данных. Попытка удалить Обратимо удаленный объект не влияет на время его окончания.

При отключении обратимого удаления можно продолжать получать доступ к обратимо удаленным данным в учетной записи хранения, сохраненной во время включения функции, и восстанавливать их.

### <a name="saving-deleted-data"></a>Сохранение удаленных данных

Обратимое удаление сохраняет данные во многих случаях, когда объекты удаляются или перезаписываются.

Когда большой двоичный объект перезаписывается с помощью функции **размещения большого двоичного объекта**, **размещения списка блокировок** или **копирования большого двоичного объекта**, версия или моментальный снимок состояния большого двоичного объекта, существовавшего до операции записи, создается автоматически. Этот объект невидим, если явно удаленные объекты не указаны явным образом. Чтобы узнать, как получить список обратимо удаляемых объектов, см. раздел [о восстановлении](#recovery).

![Схема, показывающая, как сохраняются моментальные снимки больших двоичных объектов с помощью команды размещение большого двоичного объекта, размещение списка блокировок или копирование большого двоичного объекта.](media/soft-delete-blob-overview/storage-blob-soft-delete-overwrite.png)

*Обратимо удаленные данные окрашены серым, а активные — синими. Последние записанные данные отображаются под старыми данными. Когда B0 перезаписывается с помощью B1, создается Обратимо удаленный моментальный снимок B0. Когда B1 перезаписывается с помощью B2, создается Обратимо удаленный моментальный снимок B1.*

> [!NOTE]  
> Функция обратимого удаления предоставляет защиту от перезаписи для операций копирования, только если она включена в учетной записи большого двоичного объекта назначения.

> [!NOTE]  
> Обратимое удаление не предоставляет защиту от перезаписи для больших двоичных объектов на архивном уровне. Если большой двоичный объект на архивном уровне перезаписывается новым большим двоичным объектом на любом уровне, перезаписанный большой двоичный объект будет удален навсегда.

Если операция **Delete BLOB** (Удаление большого двоичного объекта) вызывается в моментальном снимке, он помечается как обратимо удаленный. Новый моментальный снимок не создается.

![Схема, показывающая, как выполняется обратимое удаление моментальных снимков больших двоичных объектов при использовании удаления большого двоичного объекта.](media/soft-delete-blob-overview/storage-blob-soft-delete-explicit-delete-snapshot.png)

*Обратимо удаленные данные окрашены серым, а активные — синими. Последние записанные данные отображаются под старыми данными. При вызове **большого двоичного объекта моментального снимка** B0 становится моментальным снимком, а B1 — активным состоянием большого двоичного объекта. При удалении моментального снимка B0 он помечается как Обратимо удаленный.*

Когда вызывается операция **Delete Blob** для основного большого двоичного объекта (который не является моментальным снимком), он помечается как обратимо удаленный. В соответствии с предыдущим поведением, вызов операции **Delete Blob** для большого двоичного объекта с активными моментальными снимками завершается с ошибкой. Если вызвать операцию **Delete Blob** для большого двоичного объекта с обратимо удаленными моментальными снимками, это не приведет к возникновению ошибки. Когда обратимое удаление включено, большой двоичный объект и его моментальные снимки можно по прежнему удалить одной операцией. При этом основной большой двоичный объект и моментальные снимки помечаются как обратимо удаленные.

![Схема, показывающая, что происходит при вызове удаления блога для базового большого двоичного объекта.](media/soft-delete-blob-overview/storage-blob-soft-delete-explicit-include.png)

*Обратимо удаленные данные окрашены серым, а активные — синими. Последние записанные данные отображаются под старыми данными. Здесь выполняется вызов **удаления большого двоичного объекта** для удаления B2 и всех связанных с ним моментальных снимков. Активный большой двоичный объект, B2 и все связанные моментальные снимки помечаются как обратимо удаленные.*

> [!NOTE]  
> При перезаписи обратимо удаленного большого двоичного объекта автоматически создается обратимо удаленный моментальный снимок состояния большого двоичного объекта до операции записи. Новый большой двоичный объект наследует уровень перезаписанного большого двоичного объекта.

Обратимое удаление не сохраняет данные в случае удаления контейнера или учетной записи, а также при перезаписи метаданных больших двоичных объектов и свойств больших двоичных объектов. Чтобы защитить учетную запись хранения от удаления, можно настроить блокировку с помощью Azure Resource Manager. Дополнительные сведения см. в Azure Resource Manager статье [Блокировка ресурсов для предотвращения непредвиденных изменений](../../azure-resource-manager/management/lock-resources.md).

В следующей таблице описано ожидаемое поведение, если обратимое удаление включено:

| Операция REST API | Тип ресурса | Описание | Изменение в поведении |
|--------------------|---------------|-------------|--------------------|
| [Удалить](/rest/api/storagerp/StorageAccounts/Delete) | Учетная запись | Удаляет учетную запись хранения, а также все содержащиеся в ней контейнеры и большие двоичные объекты.                           | Без изменений. Контейнеры и большие двоичные объекты в удаленной учетной записи невозможно восстановить. |
| [Delete Container (Удаление контейнера)](/rest/api/storageservices/delete-container) | Контейнер | Удаляет контейнер вместе со всеми большими двоичными объектами, которые в нем содержатся. | Без изменений. Большие двоичные объекты в удаленном контейнере невозможно восстановить. |
| [Put BLOB (Вставка BLOB-объекта)](/rest/api/storageservices/put-blob) | Блокировка, Добавление и страничные BLOB-объекты | Создает новый большой двоичный объект или заменяет имеющийся большой двоичный объект в контейнере. | Если используется для замены имеющегося большого двоичного объекта, автоматически создается моментальный снимок состояния большого двоичного объекта до вызова. Это также относится к ранее обратимому удаленному большому двоичному объекту только в том случае, если он заменяется BLOB-объектом того же типа (блоком, добавлением или страницей). Если они заменяются большими двоичными объектами другого типа, все имеющиеся обратимо удаленные данные будет невозможно восстановить. |
| [Удалить BLOB-объект](/rest/api/storageservices/delete-blob) | Блокировка, Добавление и страничные BLOB-объекты | Отмечает для удаления большой двоичный объект или моментальный снимок большого двоичного объекта. Большой двоичный объект или моментальный снимок удаляется позднее при сборке мусора. | Если используется для удаления моментального снимка, он помечается как обратимо удаленный. Если используется для удаления большого двоичного объекта, он помечается как обратимо удаленный. |
| [Копирование BLOB-объекта](/rest/api/storageservices/copy-blob) | Блокировка, Добавление и страничные BLOB-объекты | Копирует исходный большой двоичный объект в большой двоичный объект назначения в той же или в другой учетной записи хранения. | Если используется для замены имеющегося большого двоичного объекта, автоматически создается моментальный снимок состояния большого двоичного объекта до вызова. Это также относится к ранее обратимому удаленному большому двоичному объекту только в том случае, если он заменяется BLOB-объектом того же типа (блоком, добавлением или страницей). Если они заменяются большими двоичными объектами другого типа, все имеющиеся обратимо удаленные данные будет невозможно восстановить. |
| [Put Block (Вставка блокировки)](/rest/api/storageservices/put-block) | Blob-блоки | Создает новую блокировку, которая фиксируется как часть блочного BLOB-объекта. | Если используется для фиксации блока в активном большом двоичном объекте, изменения отсутствуют. Если используется для блокировки в обратимо удаленном большом двоичном объекте, создается большой двоичный объект и автоматически создается моментальный снимок для записи состояния обратимо удаленного большого двоичного объекта. |
| [Put Block List (Вставка списка блокировки)](/rest/api/storageservices/put-block-list) | Blob-блоки | Фиксирует большой двоичный объект путем указания набора идентификаторов блокировок, представляющих блочный BLOB-объект. | Если используется для замены имеющегося большого двоичного объекта, автоматически создается моментальный снимок состояния большого двоичного объекта до вызова. Это также относится к ранее обратимому удаленному большому двоичному объекту только в том случае, если это блочный BLOB-объект. Если они заменяются большими двоичными объектами другого типа, все имеющиеся обратимо удаленные данные будет невозможно восстановить. |
| [Put Page](/rest/api/storageservices/put-page) | Страничные большие двоичные объекты | Записывает диапазон страниц в страничный BLOB-объект. | Без изменений. Страничные данные большого двоичного объекта, которые перезаписываются или очищаются с помощью этой операции, не сохраняются и не подлежит восстановлению. |
| [Append Block](/rest/api/storageservices/append-block) | Добавочные BLOB-объекты | Записывает блок данных в конец добавочного BLOB-объекта | Без изменений. |
| [Set BLOB Properties (Задание свойств службы BLOB-объекта)](/rest/api/storageservices/set-blob-properties) | Блокировка, Добавление и страничные BLOB-объекты | Задает значения для свойств системы, определенных для большого двоичного объекта. | Без изменений. Перезаписанные свойства большого двоичного объекта невозможно восстановить. |
| [Set BLOB Metadata (Задание метаданных BLOB-объекта)](/rest/api/storageservices/set-blob-metadata) | Блокировка, Добавление и страничные BLOB-объекты | Задает определяемые пользователем метаданные для определенного большого двоичного объекта в виде одной или нескольких пар "имя — значение". | Без изменений. Метаданные перезаписанного большого двоичного объекта не могут быть восстановлены. |

Важно отметить, что вызов **страницы размещения** для перезаписи или очистки диапазонов страничного BLOB-объекта не приводит к автоматическому формированию моментальных снимков. Диски виртуальной машины поддерживаются страничными BLOB-объектами и используют **страницу размещения** для записи данных.

### <a name="recovery"></a>Восстановление

При вызове операции [отмены удаления BLOB](/rest/api/storageservices/undelete-blob) -объекта на обратимо удаленном базовом двоичном объекте восстанавливается и все связанные обратимо удаленные моментальные снимки в активном состоянии. При вызове операции **отмены удаления BLOB** -объекта в активном базовом большом двоичном объекте все связанные обратимо удаленные моментальные снимки восстанавливаются как активные. Когда моментальные снимки восстановлены как активные, они выглядят как созданные пользователем моментальные снимки. Они не перезаписывают основной большой двоичный объект.

Чтобы восстановить большой двоичный объект до определенного обратимо удаленного моментального снимка, можно вызвать команду " **Отменить удаление BLOB** -объекта" в базовом большом двоичном объекте. Затем вы можете скопировать моментальный снимок в активный большой двоичный объект. Его также можно скопировать в новый большой двоичный объект.

![Схема, показывающая, что происходит при использовании отмены удаления большого двоичного объекта.](media/soft-delete-blob-overview/storage-blob-soft-delete-recover.png)

*Обратимо удаленные данные окрашены серым, а активные — синими. Последние записанные данные отображаются под старыми данными. Здесь для большого двоичного объекта B вызывается **Отмена удаления большого** двоичного объекта, таким образом восстанавливая базовый большой двоичный объект, B1 и все связанные с ним моментальные снимки. это просто B0 в активном состоянии. На втором шаге B0 копируется поверх базового большого двоичного объекта. Эта операция копирования создает Обратимо удаленный моментальный снимок B1.*

Чтобы просмотреть обратимо удаленные большие двоичные объекты и моментальные снимки, можно включить удаленные данные в результаты операции **List Blobs** (Вывод списка больших двоичных объектов). Можно просматривать только обратимо удаленные основные большие двоичные объекты или также включить обратимо удаленные моментальные снимки. Для всех обратимо удаленных данных можно просмотреть время, когда были удалены данные, а также число дней, оставшихся до окончательного удаления данных.

### <a name="example"></a>Пример

Ниже приведен вывод консоли сценария .NET, который отправляет, перезаписывает, моментальные снимки, удаляет и восстанавливает большой двоичный объект с именем *HelloWorld* , когда включается обратимое удаление:

```bash
Upload:
- HelloWorld (is soft deleted: False, is snapshot: False)

Overwrite:
- HelloWorld (is soft deleted: True, is snapshot: True)
- HelloWorld (is soft deleted: False, is snapshot: False)

Snapshot:
- HelloWorld (is soft deleted: True, is snapshot: True)
- HelloWorld (is soft deleted: False, is snapshot: True)
- HelloWorld (is soft deleted: False, is snapshot: False)

Delete (including snapshots):
- HelloWorld (is soft deleted: True, is snapshot: True)
- HelloWorld (is soft deleted: True, is snapshot: True)
- HelloWorld (is soft deleted: True, is snapshot: False)

Undelete:
- HelloWorld (is soft deleted: False, is snapshot: True)
- HelloWorld (is soft deleted: False, is snapshot: True)
- HelloWorld (is soft deleted: False, is snapshot: False)

Copy a snapshot over the base blob:
- HelloWorld (is soft deleted: False, is snapshot: True)
- HelloWorld (is soft deleted: False, is snapshot: True)
- HelloWorld (is soft deleted: True, is snapshot: True)
- HelloWorld (is soft deleted: False, is snapshot: False)
```

Чтобы получить сведения о приложении, которое создало эти выходные данные, см. раздел [Следующие шаги](#next-steps).

## <a name="pricing-and-billing"></a>Цены и выставление счетов

Все обратимо удаленные данные оплачиваются по той же ставке, что и активные данные. Плата не взимается за данные, которые были окончательно удалены по окончании заданного периода хранения. Более подробные сведения о моментальных снимках и их начислении см. в разделе [понимание того, как моментальные снимки начисляются за оплату](./snapshots-overview.md).

За транзакции, связанные с автоматическим созданием моментальных снимков, счет не выставляется. Плата за операции **отмены BLOB-объектов** будет взиматься по скорости операций записи.

Дополнительные сведения о ценах на хранилище BLOB-объектов Azure см. на [странице цен](https://azure.microsoft.com/pricing/details/storage/blobs/).

При первоначальном включении обратимого удаления Корпорация Майкрософт рекомендует использовать короткий срок хранения, чтобы лучше понять, как эта функция повлияет на ваш счет.

Включение обратимого удаления для часто перезаписанных данных может привести к увеличению расходов на емкость хранилища и увеличению задержки при перечислении больших двоичных объектов. Вы можете уменьшить эту дополнительную стоимость и задержку, сохранив часто перезаписанные данные в отдельной учетной записи хранения, в которой отключено обратимое удаление.

## <a name="faq"></a>ВОПРОСЫ И ОТВЕТЫ

### <a name="can-i-use-the-set-blob-tier-api-to-tier-blobs-with-soft-deleted-snapshots"></a>Можно ли использовать параметр настройки API уровня больших двоичных объектов для многоуровневых больших двоичных объектов с использованием обратимо удаленных моментальных снимков?

Да. Обратимо удаленные моментальные снимки останутся на исходном уровне, но базовый BLOB-объект будет перемещен на новый уровень.

### <a name="premium-storage-accounts-have-a-per-blob-snapshot-limit-of-100-do-soft-deleted-snapshots-count-toward-this-limit"></a>Учетная запись хранения уровня "Премиум" имеет ограничение на количество моментальных снимков большого двоичного объекта — 100. Учитываются ли в этом ограничении обратимо удаленные моментальные снимки?

Нет, обратимо удаленные моментальные снимки не учитываются в этом ограничении.

### <a name="if-i-delete-an-entire-account-or-container-with-soft-delete-turned-on-will-all-associated-blobs-be-saved"></a>Если удалить всю учетную запись или контейнер с включенным обратимым удалением, будут ли сохранены все связанные большие двоичные объекты?

Нет, если удалена вся учетная запись или контейнер, все связанные большие двоичные объекты будут удалены без возможности восстановления. Дополнительные сведения о том, как защитить учетную запись хранения от случайного удаления, см. [в разделе Блокировка ресурсов для предотвращения непредвиденных изменений](../../azure-resource-manager/management/lock-resources.md).

### <a name="can-i-view-capacity-metrics-for-deleted-data"></a>Можно ли просмотреть метрики емкости для удаленных данных?

Обратимо удаленные данные включены как часть общей емкости учетной записи хранения. Дополнительные сведения об отслеживании и мониторинге емкости хранилища см. в разделе [аналитика службы хранилища](../common/storage-analytics.md).

### <a name="can-i-read-and-copy-out-soft-deleted-snapshots-of-my-blob"></a>Можно ли читать и копировать обратимо удаленные моментальные снимки моего большого двоичного объекта?  

Да, но сначала необходимо вызвать отмену удаления большого двоичного объекта.

### <a name="is-soft-delete-available-for-virtual-machine-disks"></a>Доступно ли обратимое удаление для дисков виртуальных машин?  

Обратимое удаление доступно для неуправляемых дисков уровня "Премиум" и "Стандартный", которые являются страничными BLOB-объектами. Обратимое удаление поможет восстановить данные, удаленные с помощью **удаления большого двоичного объекта**, **размещения большого двоичного объекта**, **размещения списка блокировок** и **копирования операций BLOB-объекта** . Данные, перезаписанные с помощью вызова операции **Put Page**, невозможно восстановить.

Виртуальная машина Azure записывает данные на неуправляемый диск с помощью вызовов к **странице "разместить**", поэтому использование обратимого удаления для отмены записи на неуправляемый диск из виртуальной машины Azure не является поддерживаемым сценарием.

### <a name="do-i-need-to-change-my-existing-applications-to-use-soft-delete"></a>Нужно ли изменять свои существующие приложения, чтобы использовать обратимое удаление?

Воспользоваться преимуществами обратимого удаления можно вне зависимости от используемой версии API. Однако для перечисления и восстановления обратимо удаленных больших двоичных объектов и моментальных снимков больших двоичных объектов необходимо использовать службу [хранилища Azure](/rest/api/storageservices/Versioning-for-the-Azure-Storage-Services) версии 2017-07-29 REST API или более поздней. Корпорация Майкрософт рекомендует всегда использовать последнюю версию API службы хранилища Azure.

## <a name="next-steps"></a>Дальнейшие действия

- [Включение обратимого удаления для больших двоичных объектов](./soft-delete-blob-enable.md)
- [Управление версиями BLOB-объектов](versioning-overview.md)