---
title: Списки управления доступом в Azure Data Lake Storage 2-го поколения | Документация Майкрософт
description: Узнайте, как работают списки управления доступом, подобные стандарту POSIX, в Azure Data Lake Storage 2-го поколения.
author: normesta
ms.subservice: data-lake-storage-gen2
ms.service: storage
ms.topic: conceptual
ms.date: 02/17/2021
ms.author: normesta
ms.reviewer: jamesbak
ms.openlocfilehash: 4d75e60d0e497dcdd2aa121f8da73f11a7e2af5b
ms.sourcegitcommit: 225e4b45844e845bc41d5c043587a61e6b6ce5ae
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/11/2021
ms.locfileid: "103015222"
---
# <a name="access-control-lists-acls-in-azure-data-lake-storage-gen2"></a>Списки управления доступом (ACL) в Azure Data Lake Storage 2-го поколения

Azure Data Lake Storage 2-го поколения реализует модель управления доступом, поддерживающую управление доступом на основе ролей Azure (Azure RBAC) и списки управления доступом (ACL), аналогичные стандарту POSIX. В этой статье описываются списки управления доступом в Data Lake Storage 2-го поколения. Сведения о том, как внедрить Azure RBAC вместе с ACL и как система оценивает их для принятия решений об авторизации, см. [в разделе модель контроля доступа в Azure Data Lake Storage 2-го поколения](data-lake-storage-access-control-model.md).

<a id="access-control-lists-on-files-and-directories"></a>

## <a name="about-acls"></a>Сведения об ACL

[Субъект безопасности](../../role-based-access-control/overview.md#security-principal) можно связать с уровнем доступа для файлов и каталогов. Эти ассоциации фиксируются в *списке управления доступом (ACL)*. Каждый файл и каталог в вашей учетной записи хранения имеют список управления доступом. Когда участник безопасности пытается выполнить операцию с файлом или каталогом, проверка списка ACL определяет, имеет ли этот субъект безопасности (пользователя, группу, субъект-службу или управляемое удостоверение) правильный уровень разрешений для выполнения операции.

> [!NOTE]
> Списки управления доступом применяются только к субъектам безопасности в одном клиенте и не применяются к пользователям, использующим проверку подлинности с использованием общего ключа или подписи общего доступа (SAS). Это связано с тем, что с вызывающим объектом не связано удостоверение, поэтому не удается выполнить авторизацию на основе разрешений субъекта безопасности.  

<a id="set-access-control-lists"></a>

## <a name="how-to-set-acls"></a>Настройка списков управления доступом

Сведения о задании разрешений на уровне файлов и каталогов см. в следующих статьях:

| Среда | Статья |
|--------|-----------|
|Обозреватель службы хранилища Azure |[Использование Обозреватель службы хранилища Azure для задания списков управления доступом в Azure Data Lake Storage 2-го поколения](data-lake-storage-explorer-acl.md)|
|.NET |[Использование .NET для установки списков управления доступом в Azure Data Lake Storage 2-го поколения](data-lake-storage-acl-dotnet.md)|
|Java|[Использование Java для задания списков управления доступом в Azure Data Lake Storage 2-го поколения](data-lake-storage-acl-java.md)|
|Python|[Использование Python для установки списков управления доступом в Azure Data Lake Storage 2-го поколения](data-lake-storage-acl-python.md)|
|PowerShell|[Использование PowerShell для задания списков управления доступом в Azure Data Lake Storage 2-го поколения](data-lake-storage-acl-powershell.md)|
|Azure CLI|[Использование Azure CLI для задания списков управления доступом в Azure Data Lake Storage 2-го поколения](data-lake-storage-acl-cli.md)|
|REST API |[Путь — обновление](/rest/api/storageservices/datalakestoragegen2/path/update)|

> [!IMPORTANT]
> Если участник безопасности является субъектом- *службой* , важно использовать идентификатор объекта субъекта-службы, а не идентификатор объекта для регистрации соответствующего приложения. Чтобы получить идентификатор объекта субъекта-службы, откройте Azure CLI, а затем используйте следующую команду: `az ad sp show --id <Your App ID> --query objectId` . Обязательно замените `<Your App ID>` заполнитель идентификатором приложения для регистрации приложения.

## <a name="types-of-acls"></a>Типы списков ACL

Существует два вида списков управления доступом: ACL для *доступа* и *ACL по умолчанию*.

Списки ACL для доступа управляют доступом к тому или иному объекту. Они позволяют управлять доступом как к файлам, так и к каталогам.

Списки ACL по умолчанию — это шаблоны списков управления доступом, связанные с каталогом, который определяет списки ACL для доступа к любым дочерним элементам, созданным в этом каталоге. У файлов нет списков ACL по умолчанию.

Как ACL для доступа, так и ACL по умолчанию имеют одинаковую структуру.

> [!NOTE]
> Изменение списка ACL по умолчанию для родительского объекта не оказывает влияния на список ACL для доступа или список ACL по умолчанию для уже существующих дочерних элементов.

## <a name="levels-of-permission"></a>Уровни разрешений

Разрешения на каталоги и файлы в контейнере доступны для **чтения**, **записи** и **выполнения**, и их можно использовать для файлов и каталогов, как показано в следующей таблице.

|            |    Файл     |   Каталог |
|------------|-------------|----------|
| **Разрешение на чтение (R)** | Чтение содержимого файла | Для просмотра содержимого каталога требуются **разрешения на чтение** и **выполнение** |
| **Разрешение на запись (W)** | Запись или добавление данных в файл | Для создания дочерних элементов в каталоге требуются **разрешения на запись** и **выполнение** |
| **Разрешение на выполнение (X)** | Не имеет значения в контексте Data Lake Storage 2-го поколения | Требуется для просмотра дочерних элементов каталога |

> [!NOTE]
> Если разрешения предоставляются только с помощью ACL (без Azure RBAC), то чтобы предоставить субъекту безопасности доступ на чтение или запись к файлу, необходимо предоставить субъекту безопасности разрешения на **выполнение** для корневой папки контейнера, а также для каждой папки в иерархии папок, которая ведет к файлу.

### <a name="short-forms-for-permissions"></a>Сокращения для разрешений

**RWX** означает разрешения на **чтение, запись и выполнение**. Существует еще более краткая форма — цифровая, согласно которой **чтение = 4**, **запись = 2**, **выполнение = 1**, а их сумма выражает предоставленные разрешения. Ниже приводятся некоторые примеры.

| Цифровая форма | Краткая форма |      Что это означает     |
|--------------|------------|------------------------|
| 7            | `RWX`        | чтение, запись и выполнение |
| 5            | `R-X`        | Чтение + выполнение         |
| 4            | `R--`        | Чтение                   |
| 0            | `---`        | Нет разрешений         |

### <a name="permissions-inheritance"></a>Наследование разрешений

В модели на основе POSIX, используемой в Data Lake Storage 2-го поколения, разрешения для элемента хранятся в самом элементе. Иными словами, разрешения для элемента не могут наследоваться от родительских элементов, если их разрешения заданы уже после того, как дочерний элемент создан. Разрешения наследуются только в том случае, если для родительских элементов были установлены разрешения по умолчанию до создания дочерних элементов.

## <a name="common-scenarios-related-to-acl-permissions"></a>Распространенные сценарии, связанные с разрешениями ACL

В следующей таблице показаны записи ACL, необходимые для включения субъекта безопасности для выполнения операций, перечисленных в столбце **Операция** . 

В этой таблице показан столбец, представляющий каждый уровень вымышленной иерархии каталогов. Существует столбец для корневого каталога контейнера ( `\` ), подкаталог с именем « **Орегон**», вложенный каталог в каталоге «Орегон» и текстовый файл в каталоге «Портленде» с именем **Data.txt**. 

> [!IMPORTANT]
> В этой таблице предполагается, что вы используете **только** списки ACL без назначений ролей Azure. Для просмотра подобной таблицы, объединяющей Azure RBAC вместе с списками ACL, см. раздел [Таблица разрешений: объединение Azure RBAC и ACL](data-lake-storage-access-control-model.md#permissions-table-combining-azure-rbac-and-acl).

|    Операция             |    /    | Каталог Oregon/ | Portland/ | Data.txt     |
|--------------------------|---------|----------|-----------|--------------|
| Чтение файла Data.txt            |   `--X`   |   `--X`    |  `--X`      | `R--`          |
| Добавление в файл Data.txt       |   `--X`   |   `--X`    |  `--X`      | `RW-`          |
| Удаление файла Data.txt          |   `--X`   |   `--X`    |  `-WX`      | `---`          |
| Создание файла Data.txt          |   `--X`   |   `--X`    |  `-WX`      | `---`          |
| Перечисление /                   |   `R-X`   |   `---`    |  `---`      | `---`          |
| Перечисление для каталога /Oregon/           |   `--X`   |   `R-X`    |  `---`      | `---`          |
| Перечисление для каталога /Oregon/Portland/  |   `--X`   |   `--X`    |  `R-X`      | `---`          |

> [!NOTE]
> Для удаления файла разрешения на запись не требуются, пока выполняются два предыдущих условия.

## <a name="users-and-identities"></a>Пользователи и удостоверения

Каждый файл или каталог имеет отдельные разрешения для следующих удостоверений:

- Владелец
- группа владельцев;
- именованные пользователи;
- именованные группы;
- именованные субъекты-службы;
- Именованные управляемые удостоверения
- все остальные пользователи.

Удостоверения пользователей и групп являются удостоверениями Azure Active Directory (AAD). Поэтому, если не указано иное, *пользователь* в контексте Data Lake Storage 2-го поколения может ссылаться на пользователя Azure AD, субъекта-службы, управляемую идентификацию или группу безопасности.

### <a name="the-owning-user"></a>Владелец

Пользователь, создавший элемент, автоматически становится владельцем элемента. Владелец может:

* изменять разрешения файла, владельцем которого он является;
* изменять группу владельцев файла, владельцем которого он является, если владелец файла одновременно является участником целевой группы.

> [!NOTE]
> Владелец *не может* изменить владельца другого файла или каталога. Изменить владельца файла или каталога может только суперпользователь.

### <a name="the-owning-group"></a>группа владельцев;

В списках управления доступом POSIX каждый пользователь связан с *основной группой*. Например, пользователь «Мария» может принадлежать к группе «Finance». Алиса может также принадлежать к нескольким группам, но одна группа всегда назначается как основная группа. В интерфейсе POSIX, когда пользователь Aлиса создает файл, группа владельцев этого файла задается для основной группы этого пользователя, которой в данном случае является группа finance. В противном случае разрешения группы владельцев будут аналогичны разрешениям, назначенным другим пользователям или группам.

#### <a name="assigning-the-owning-group-for-a-new-file-or-directory"></a>Назначение группы владельцев для нового файла или каталога

* **Вариант 1**. корневой каталог "/". Этот каталог создается при создании контейнера Data Lake Storage 2-го поколения. В этом случае для группы-владельца задается пользователь, создавший контейнер, если он был выполнен с помощью OAuth. Если контейнер создается с использованием общего ключа, SAS учетной записи или SAS службы, то владельцем и группой владельцев присваивается значение **$superuser**.
* **Вариант 2** (все остальные случаи). при создании нового элемента Группа владельцев копируется из родительского каталога.

#### <a name="changing-the-owning-group"></a>Изменение группы владельцев

Группа владельцев может быть изменена:
* одним из суперпользователей;
* владельцем, если он является участником целевой группы.

> [!NOTE]
> Группа владельцев не может изменить списки ACL для файла или каталога.  Хотя группа-владелец настроена для пользователя, создавшего учетную запись в случае с корневым каталогом, **вариант 1** выше, одна учетная запись пользователя не является допустимой для предоставления разрешений через группу-владелец. Разрешение можно назначить допустимой группе пользователей, если это применимо.

## <a name="access-check-algorithm"></a>Алгоритм проверки доступа

Следующий псевдокод представляет алгоритм проверки доступа для учетных записей хранения.

```console
def access_check( user, desired_perms, path ) : 
  # access_check returns true if user has the desired permissions on the path, false otherwise
  # user is the identity that wants to perform an operation on path
  # desired_perms is a simple integer with values from 0 to 7 ( R=4, W=2, X=1). User desires these permissions
  # path is the file or directory
  # Note: the "sticky bit" isn't illustrated in this algorithm
  
  # Handle super users.
  if (is_superuser(user)) :
    return True

  # Handle the owning user. Note that mask isn't used.
  entry = get_acl_entry( path, OWNER )
  if (user == entry.identity)
      return ( (desired_perms & entry.permissions) == desired_perms )

  # Handle the named users. Note that mask IS used.
  entries = get_acl_entries( path, NAMED_USER )
  for entry in entries:
      if (user == entry.identity ) :
          mask = get_mask( path )
          return ( (desired_perms & entry.permissions & mask) == desired_perms)

  # Handle named groups and owning group
  member_count = 0
  perms = 0
  entries = get_acl_entries( path, NAMED_GROUP | OWNING_GROUP )
  mask = get_mask( path )
  for entry in entries:
    if (user_is_member_of_group(user, entry.identity)) :
        if ((desired_perms & entry.permissions & mask) == desired_perms)
            return True 
        
  # Handle other
  perms = get_perms_for_other(path)
  mask = get_mask( path )
  return ( (desired_perms & perms & mask ) == desired_perms)
```

### <a name="the-mask"></a>Маска

Как показано в разделе "Алгоритм проверки доступа", маска ограничивает доступ для именованных пользователей, группы владельцев и именованных групп.  

Для нового контейнера Data Lake Storage 2-го поколения маска для ACL доступа к корневому каталогу ("/") по умолчанию составляет **750** для каталогов и **640** для файлов. В следующей таблице показана символьная нотация этих уровней разрешений.

|Сущность|Каталоги|Файлы|
|--|--|--|
|владельца|`rwx`|`r-w`|
|группы владельцев|`r-x`|`r--`|
|Другое|`---`|`---`|

Файлы не получают бит X, так как он не имеет значения для файлов в системе, предусматривающей только хранение. 

Маску можно указать для каждого вызова. Это позволяет установить для разных потребляющих систем, например кластеров, разные действующие маски для файловых операций. Если маска указана в конкретном запросе, она полностью переопределяет маску по умолчанию.

### <a name="the-sticky-bit"></a>Бит фиксации

Закрепление — более сложная функция контейнера POSIX. В контексте Data Lake Storage 2-го поколения потребность в использовании бита фиксации маловероятна. Вкратце, если в каталоге включен бит фиксации, дочерний элемент может удалить или переименовать только владелец дочернего элемента.

Бит крепления не отображается в портал Azure.

## <a name="default-permissions-on-new-files-and-directories"></a>Разрешения по умолчанию для новых файлов и каталогов

При создании нового файла или каталога в существующем каталоге список ACL по умолчанию для родительского каталога определяет:

- Список ACL по умолчанию для списка ACL и доступа к дочернему каталогу.
- список ACL для доступа для дочернего файла (файлы не имеют списка ACL по умолчанию).

### <a name="umask"></a>umask

Когда создается файл или каталог, значение umask используется для изменения того, как для дочернего элемента устанавливаются списки ACL по умолчанию. umask — это 9-битное значение для родительских каталогов, содержащее значение RWX для **владельца**, **группы владельцев** и **других пользователей**.

umask для Azure Data Lake Storage 2-го поколения является константой со значением 007. Это значение преобразуется в следующие формы:

| Компонент umask     | Цифровая форма | Краткая форма | Значение |
|---------------------|--------------|------------|---------|
| umask.owning_user   |    0         |   `---`      | Для владельца стандартный список ACL родительского элемента копируется в список ACL для доступа дочернего элемента. | 
| umask.owning_group  |    0         |   `---`      | Для группы владельцев стандартный список ACL родительского элемента копируется в список ACL для доступа дочернего элемента. | 
| umask.other         |    7         |   `RWX`      | Для других пользователей все разрешения в списке ACL для доступа дочернего элемента удаляются. |

Значение umask, используемое Azure Data Lake Storage 2-го поколения фактически означает, что значение для **другого** никогда не передается по умолчанию для новых дочерних элементов, если только ACL по умолчанию не определен в родительском каталоге. В этом случае umask фактически игнорируется, а разрешения, определенные ACL по умолчанию, применяются к дочернему элементу. 

Следующий псевдокод показывает, как применяется umask при создании списков ACL для дочернего элемента.

```console
def set_default_acls_for_new_child(parent, child):
    child.acls = []
    for entry in parent.acls :
        new_entry = None
        if (entry.type == OWNING_USER) :
            new_entry = entry.clone(perms = entry.perms & (~umask.owning_user))
        elif (entry.type == OWNING_GROUP) :
            new_entry = entry.clone(perms = entry.perms & (~umask.owning_group))
        elif (entry.type == OTHER) :
            new_entry = entry.clone(perms = entry.perms & (~umask.other))
        else :
            new_entry = entry.clone(perms = entry.perms )
        child_acls.add( new_entry )
```

## <a name="faq"></a>ВОПРОСЫ И ОТВЕТЫ

### <a name="do-i-have-to-enable-support-for-acls"></a>Нужно ли мне активировать поддержку ACL?

Нет. Управление доступом через списки ACL включается для учетной записи хранения, если включена функция иерархического пространства имен (HNS).

Если служба HNS отключена, правила авторизации RBAC Azure Azure по-прежнему применяются.

### <a name="what-is-the-best-way-to-apply-acls"></a>Каким способом лучше всего применять списки ACL?

[!INCLUDE [Security groups](../../../includes/azure-storage-data-lake-groups.md)] 

### <a name="how-are-azure-rbac-and-acl-permissions-evaluated"></a>Как оцениваются разрешения Azure RBAC и ACL?

Сведения о том, как система оценивает Azure RBAC и списки ACL для принятия решений об авторизации ресурсов учетной записи хранения, см. в разделе [Оценка разрешений](data-lake-storage-access-control-model.md#how-permissions-are-evaluated).

### <a name="what-are-the-limits-for-azure-role-assignments-and-acl-entries"></a>Каковы ограничения для назначений ролей Azure и записей ACL?

В следующей таблице представлено общее представление об ограничениях, которые следует учитывать при использовании Azure RBAC для управления разрешениями «грубых» (разрешения, применяемые к учетным записям хранения или контейнерам), а также использованию списков управления доступом для управления разрешениями «точного просмотра» (разрешения, применяемые к файлам и каталогам). Используйте группы безопасности для назначений списков управления доступом. С помощью групп вероятность превышения максимального количества назначений ролей в каждой подписке и максимального количества записей ACL для каждого файла или каталога. 

[!INCLUDE [Security groups](../../../includes/azure-storage-data-lake-rbac-acl-limits.md)] 

### <a name="does-data-lake-storage-gen2-support-inheritance-of-azure-rbac"></a>Поддерживает ли Data Lake Storage 2-го поколения наследование Azure RBAC?

Назначения ролей Azure наследуют. Потоки назначений от ресурсов подписки, группы ресурсов и учетной записи хранения до ресурса контейнера.

### <a name="does-data-lake-storage-gen2-support-inheritance-of-acls"></a>Поддерживает ли Data Lake Storage 2-го поколения наследование списков ACL?

Списки управления доступом по умолчанию можно использовать для задания списков управления доступом для новых дочерних подкаталогов и файлов, созданных в родительском каталоге. Чтобы обновить списки управления доступом для существующих дочерних элементов, необходимо рекурсивно добавить, обновить или удалить списки управления доступом для нужной иерархии каталогов. Инструкции см. в разделе [Настройка списков управления доступом](#set-access-control-lists) этой статьи. 

### <a name="which-permissions-are-required-to-recursively-delete-a-directory-and-its-contents"></a>Какие разрешения требуются для рекурсивного удаления каталога и его содержимого?

- У вызывающего пользователя есть разрешения "суперпользователя",

либо

- Для родительского каталога требуются разрешения на запись и выполнение.
- Чтобы удалить каталог и все вложенные в него каталоги, требуются разрешения на чтение, запись и выполнение.

> [!NOTE]
> Для удаления файлов в каталогах не требуются разрешения на запись. Кроме того, корневой каталог "/" удалить невозможно.

### <a name="who-is-the-owner-of-a-file-or-directory"></a>Кто назначается владельцем файла или каталога?

Создатель файла или каталога становится его владельцем. В случае с корневым каталогом это идентификатор пользователя, создавшего контейнер.

### <a name="which-group-is-set-as-the-owning-group-of-a-file-or-directory-at-creation"></a>Как назначается группа владельцев файла или каталога при его создании?

Группа владельцев копируется из родительского каталога, в котором создан файл или каталог.

### <a name="i-am-the-owning-user-of-a-file-but-i-dont-have-the-rwx-permissions-i-need-what-do-i-do"></a>Я ответственным пользователем файла, но у меня нет необходимых разрешений RWX. Что делать?

Владелец может изменить разрешения на доступ к файлу на любое из требуемых RWX-разрешений.

### <a name="why-do-i-sometimes-see-guids-in-acls"></a>Почему в списках ACL иногда отображаются идентификаторы GUID?

Идентификатор GUID отображается, если запись представляет пользователя, которого больше не существует в Azure AD. Как правило, это происходит, если пользователь уволился или его учетная запись удалена из AAD. Кроме того, субъекты-службы и группы безопасности не имеют имени участника-пользователя (UPN) для их идентификации и поэтому они представлены атрибутом идентификатора объекта (идентификатором GUID).

### <a name="how-do-i-set-acls-correctly-for-a-service-principal"></a>Правильно ли Разделы справки задать списки ACL для субъекта-службы?

При определении списков управления доступом для субъектов-служб важно использовать идентификатор объекта (OID) *субъекта-службы* для созданной регистрации приложения. Важно отметить, что зарегистрированные приложения имеют отдельный субъект-службу в определенном клиенте Azure AD. Зарегистрированные приложения имеют идентификатор объекта, видимый в портал Azure, но у *субъекта-службы* другой OID (другой).

Чтобы получить идентификатор объекта субъекта-службы, соответствующий регистрации приложения, можно использовать `az ad sp show` команду. Укажите идентификатор приложения в качестве параметра. Ниже приведен пример получения идентификатора OID для субъекта-службы, соответствующего регистрации приложения с ИДЕНТИФИКАТОРом приложения 18218b12-1895-43e9-AD80-6e8fc1ea88ce. Выполните следующую команду в Azure CLI.

```azurecli
az ad sp show --id 18218b12-1895-43e9-ad80-6e8fc1ea88ce --query objectId
```

Будет отображен идентификатор объекта.

Если у субъекта-службы правильный идентификатор объекта, перейдите на страницу Обозреватель службы хранилища **Управление доступом** , чтобы добавить OID и назначить соответствующие разрешения для OID. Убедитесь, что выбран параметр **Сохранить**.

### <a name="can-i-set-the-acl-of-a-container"></a>Можно ли задать список управления доступом для контейнера?

Нет. Контейнер не имеет ACL. Однако можно задать список управления доступом для корневого каталога контейнера. Каждый контейнер имеет корневой каталог и имеет то же имя, что и контейнер. Например, если контейнер называется `my-container` , то корневой каталог будет называться `myContainer/` . 

REST API службы хранилища Azure содержит операцию [Set Container ACL](/rest/api/storageservices/set-container-acl), но эту операцию нельзя использовать для задания ACL контейнера или корневого каталога контейнера. Вместо этого эта операция используется, чтобы указать, [можно ли открыть общий доступ](anonymous-read-access-configure.md)к большим двоичным объектам в контейнере. 

### <a name="where-can-i-learn-more-about-posix-access-control-model"></a>Где можно получить дополнительную информацию о модели контроля доступа POSIX?

* [POSIX Access Control Lists on Linux](https://www.linux.com/news/posix-acls-linux) (Списки управления доступом POSIX для Linux)
* [HDFS Permission Guide](https://hadoop.apache.org/docs/current/hadoop-project-dist/hadoop-hdfs/HdfsPermissionsGuide.html) (Руководство по разрешениям в HDFS)
* [POSIX FAQ (POSIX: вопросы и ответы)](https://www.opengroup.org/austin/papers/posix_faq.html)
* [POSIX 1003.1 2008](https://standards.ieee.org/findstds/standard/1003.1-2008.html)
* [POSIX 1003.1 2013](https://pubs.opengroup.org/onlinepubs/9699919799.2013edition/)
* [POSIX 1003.1 2016](https://pubs.opengroup.org/onlinepubs/9699919799.2016edition/)
* [POSIX ACL on Ubuntu](https://help.ubuntu.com/community/FilePermissionsACLs) (POSIX ACL для Ubuntu)
* [ACL с использованием списков управления доступом в Linux](https://bencane.com/2012/05/27/acl-using-access-control-lists-on-linux/)

## <a name="see-also"></a>См. также раздел

- [Модель контроля доступа в Azure Data Lake Storage 2-го поколения](data-lake-storage-access-control-model.md)
