---
title: Миграция локального NAS в Синхронизация файлов Azure через Azure Датабокс
description: Узнайте, как перенести файлы из локального сетевого хранилища (NAS) в гибридное облачное развертывание с Синхронизация файлов Azure через Azure Датабокс.
author: fauhse
ms.service: storage
ms.topic: how-to
ms.date: 03/5/2021
ms.author: fauhse
ms.subservice: files
ms.openlocfilehash: 144b2f23e40f315441c3de2482ae8aeffe77ec75
ms.sourcegitcommit: e6de1702d3958a3bea275645eb46e4f2e0f011af
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "102584066"
---
# <a name="use-databox-to-migrate-from-network-attached-storage-nas-to-a-hybrid-cloud-deployment-with-azure-file-sync"></a>Используйте Датабокс для миграции из подключенного к сети хранилища (NAS) в гибридное облачное развертывание с Синхронизация файлов Azure

Эта статья о миграции является одним из нескольких ключевых слов: NAS, Синхронизация файлов Azure и Azure Датабокс. Проверьте, относится ли эта статья к вашему сценарию.

> [!div class="checklist"]
> * Источник данных: подключенное к сети хранилище (NAS)
> * Маршрут миграции: служба NAS &rArr; датабокс &rArr; файловый ресурс Azure &rArr; Sync с Windows Server
> * Локальное кэширование файлов: Да, последняя цель — это Синхронизация файлов Azure развертывание.

Если ваш сценарий отличается, просмотрите [таблицу руководств по миграции](storage-files-migration-overview.md#migration-guides).

Синхронизация файлов Azure работает в расположениях с прямым подключением к хранилищу (DAS) и не поддерживает синхронизацию с расположениями сетевого хранилища (NAS).
В этом случае выполняется миграция необходимых файлов, и в этой статье описывается планирование и выполнение такой миграции.

## <a name="migration-goals"></a>Цели миграции

Целью является перемещение общих папок на устройстве NAS на сервер Windows. Затем используйте Синхронизация файлов Azure для гибридного облачного развертывания. Эта миграция должна быть выполнена таким образом, чтобы гарантировать целостность рабочих данных и доступности во время миграции. Последний требует, чтобы время простоя не превышало минимального, так что оно может поместиться в или только немного больше, чем обычные периоды обслуживания.

## <a name="migration-overview"></a>Общие сведения о переносе

Процесс миграции состоит из нескольких этапов. Вам потребуется развернуть учетные записи хранения Azure и общие файловые ресурсы, развернуть локальный сервер Windows, настроить Синхронизация файлов Azure, выполнить миграцию с помощью средства Robocopy и, наконец, выполнить вырезание. В следующих разделах подробно описаны этапы процесса миграции.

> [!TIP]
> Если вы вернетесь к этой статье, воспользуйтесь навигацией в правой части экрана, чтобы перейти к этапу миграции, с которого вы остановились.

## <a name="phase-1-identify-how-many-azure-file-shares-you-need"></a>Этап 1. Определение необходимого количества файловых ресурсов Azure

[!INCLUDE [storage-files-migration-namespace-mapping](../../../includes/storage-files-migration-namespace-mapping.md)]

## <a name="phase-2-deploy-azure-storage-resources"></a>Этап 2. Развертывание ресурсов службы хранилища Azure

На этом этапе просмотрите таблицу сопоставления из фазы 1 и используйте ее для подсчета правильного числа учетных записей хранения Azure и файловых ресурсов в них.

[!INCLUDE [storage-files-migration-provision-azfs](../../../includes/storage-files-migration-provision-azure-file-share.md)]

## <a name="phase-3-determine-how-many-azure-databox-appliances-you-need"></a>Этап 3. Определение необходимого количества устройств Azure Датабокс

Этот шаг следует запускать только после завершения предыдущего этапа. В настоящее время необходимо создать ресурсы хранилища Azure (учетные записи хранения и общие файловые ресурсы). В процессе Датабокс необходимо указать, в какие учетные записи хранения Датабокс перемещаются данные.

На этом этапе необходимо соотнести результаты плана миграции с предыдущего этапа с ограничениями доступных параметров Датабокс. Эти рекомендации помогут вам создать план, для которого необходимо выбрать параметры Датабокс и сколько необходимо для перемещения общих ресурсов NAS в файловые ресурсы Azure.

Чтобы определить, сколько устройств какого типа вам нужно, учитывайте следующие важные ограничения.

* Любой Датабокс Azure может переместить данные в до 10 учетных записей хранения. 
* Каждый вариант Датабокс имеет свои собственные возможности. См. раздел [Параметры датабокс](#databox-options).

Просмотрите план миграции, чтобы узнать количество учетных записей хранения, которые вы решили создать, и общих папок в каждом из них. Затем просмотрите размер каждой общей папки на NAS. Объединение этих сведений позволит оптимизировать и решить, какое устройство должно отправлять данные в учетные записи хранения. Два Датабокс устройства могут перемещать файлы в одну и ту же учетную запись хранения, но не разбивать содержимое одной общей папки на два окна данных.

### <a name="databox-options"></a>Параметры Датабокс

Для стандартной миграции необходимо выбрать один или несколько комбинаций этих трех вариантов Датабокс: 

* Датабокс диски Корпорация Майкрософт отправит вам один и более пяти дисков SSD с емкостью 8 Тиб, что составляет максимум 40 тиб. Объем пригодной для использования емкости составляет примерно 20% по причине шифрования и издержек файловой системы. Дополнительные сведения см. в разделе [Датабокс Disks Documentation](../../databox/data-box-disk-overview.md).
* Датабокс. это наиболее распространенный вариант. Устройство износоустойчивое Датабокс, которое работает аналогично NAS, будет отправлено вам. Он имеет доступную для использования емкость 80 тиб. Дополнительные сведения см. в [документации по датабокс](../../databox/data-box-overview.md).
* Датабокс. Этот вариант включает в себя устройство износоустойчивое Датабокс на колесах, которое работает аналогично NAS, с емкостью 1 ПИБ. Объем пригодной для использования емкости составляет примерно 20% по причине шифрования и издержек файловой системы. Дополнительные сведения см. в разделе [Датабокс тяжелая документация](../../databox/data-box-heavy-overview.md).

## <a name="phase-4-provision-a-suitable-windows-server-on-premises"></a>Этап 4. предоставление подходящего локального сервера Windows Server

Пока вы ожидаете прибытия Azure Датабокс, вы уже можете ознакомиться с потребностями одного или нескольких серверов Windows, которые будут использоваться с Синхронизация файлов Azure.

* Создайте Windows Server 2019 — как минимум 2012 R2 — как виртуальную машину или физический сервер. Также поддерживается кластер с отработкой отказа Windows Server.
* Подготавливаете или добавляйте непосредственно подключенное хранилище (DAS по сравнению с NAS, которое не поддерживается).

Конфигурация ресурсов (вычислений и ОЗУ) развертываемого Windows Server зависит главным образом от количества элементов (файлов и папок), которые будут синхронизироваться. При наличии каких-либо проблем рекомендуется использовать более высокую конфигурацию производительности.

[Узнайте, как масштабировать Windows Server на основе количества элементов (файлов и папок), которые необходимо синхронизировать.](storage-sync-files-planning.md#recommended-system-resources)

> [!NOTE]
> Ранее связанная статья представляет собой таблицу с диапазоном памяти сервера (ОЗУ). Можно ориентироваться на меньшее число для сервера, но предполагается, что начальная синхронизация может занять значительно больше времени.

## <a name="phase-5-copy-files-onto-your-databox"></a>Этап 5. копирование файлов на Датабокс

Когда Датабокс поступит, необходимо настроить Датабокс в строке зрения на устройство NAS. Следуйте указаниям в документации по установке для типа Датабокс, который вы заказали.

* [Настройка Data Box](../../databox/data-box-quickstart-portal.md)
* [Настройка Диска Data Box](../../databox/data-box-disk-quickstart-portal.md)
* [Настройка Data Box Heavy](../../databox/data-box-heavy-quickstart-portal.md)

В зависимости от типа Датабокс могут быть доступны средства копирования Датабокс. На этом этапе они не рекомендуются для миграции в файловые ресурсы Azure, так как они не копируют файлы с полной точностью до Датабокс. Вместо этого используйте Robocopy.

Когда Датабокс поступит, он будет иметь предварительно подготовленные общие ресурсы SMB для каждой учетной записи хранения, указанной во время ее заказа.

* Если файлы попадают в файловый ресурс Azure уровня "Премиум", будет использоваться одна учетная запись хранения файлов общего ресурса SMB на уровне "Премиум".
* Если ваши файлы попадают в учетную запись хранения уровня "Стандартный", будет использоваться по три общих ресурса SMB для каждой стандартной учетной записи хранения (GPv1 и GPv2). Для миграции важны только общие файловые ресурсы, которые заканчиваются на `_AzFiles` . Игнорируйте все общие папки блочных и страничных BLOB-объектов.

Выполните действия, описанные в документации по Azure Датабокс:

1. [подключение к Data Box;](../../databox/data-box-deploy-copy-data.md)
1. копирование данных в Data Box;
1. [Подготовка Датабокс к уходу в Azure](../../databox/data-box-deploy-picked-up.md)

В связанной документации Датабокс указана команда Robocopy. Однако команда не подходит для сохранения полной точности файла и папки. Вместо этого используйте следующую команду:

[!INCLUDE [storage-files-migration-robocopy](../../../includes/storage-files-migration-robocopy.md)]


## <a name="phase-6-deploy-the-azure-file-sync-cloud-resource"></a>Этап 6. Развертывание облачного ресурса Синхронизация файлов Azure

Прежде чем продолжить работу с этим руководством, дождитесь поступления всех файлов в нужные файловые ресурсы Azure. Процесс доставки и приема данных Датабокс займет некоторое время.

[!INCLUDE [storage-files-migration-deploy-afs-sss](../../../includes/storage-files-migration-deploy-azure-file-sync-storage-sync-service.md)]

## <a name="phase-7-deploy-the-azure-file-sync-agent"></a>Этап 7. Развертывание агента Синхронизация файлов Azure

[!INCLUDE [storage-files-migration-deploy-afs-agent](../../../includes/storage-files-migration-deploy-azure-file-sync-agent.md)]

## <a name="phase-8-configure-azure-file-sync-on-the-windows-server"></a>Этап 8. Настройка Синхронизация файлов Azure в Windows Server

Зарегистрированный локальный сервер Windows должен быть готов к работе и подключен к Интернету для этого процесса.

[!INCLUDE [storage-files-migration-configure-sync](../../../includes/storage-files-migration-configure-sync.md)]

Включите функцию "распределение по уровням облака" и выберите "только пространство имен" в разделе "Начальная загрузка".

> [!IMPORTANT]
> Распределение по уровням в облаке — это функция AFS, которая позволяет локальному серверу иметь меньше ресурсов хранилища, чем хранится в облаке, но имеет доступное полное пространство имен. Локально интересные данные также кэшируются локально для повышения производительности доступа. Распределение по уровням облака — это необязательная функция для Синхронизация файлов Azure "конечная точка сервера". Эту функцию необходимо использовать, если на сервере Windows Server недостаточно места для хранения всех данных в облаке и вы хотите избежать загрузки всех данных из облака.

Повторите шаги создания группы синхронизации и добавления соответствующей серверной папки в качестве конечной точки сервера для всех общих файловых ресурсов Azure и расположений серверов, которые необходимо настроить для синхронизации. Дождитесь завершения синхронизации пространства имен. В следующем разделе подробно описано, как это сделать.

> [!NOTE]
> После создания конечной точки сервера Синхронизация работает. Однако служба синхронизации должна перечислить файлы и папки, перемещенные через Датабокс, в файловый ресурс Azure. В зависимости от размера пространства имен это может занять значительное время, прежде чем на сервере начнет отображаться пространство имен облака.

## <a name="phase-9-wait-for-the-namespace-to-fully-appear-on-the-server"></a>Этап 9. ожидание полного отображения пространства имен на сервере

Крайне важно дождаться последующих шагов миграции, когда сервер полностью скачал пространство имен из облачного общего ресурса. Если вы начинаете перемещать файлы слишком рано на сервер, вы можете угрожать ненужным передачам и даже конфликтам синхронизации файлов.

Чтобы определить, завершила ли сервер начальная синхронизация загрузки, откройте Просмотр событий на синхронизации Windows Server и используйте журнал событий телеметрии Синхронизация файлов Azure.
Журнал событий телеметрии находится в Просмотр событий в разделе Applications and Сервицес\микрософт\филесинк\ажент.

Найдите Последнее событие 9102. После завершения сеанса синхронизации регистрируется событие с идентификатором 9102. В тексте события есть поле для направления синхронизации загрузки. ( `HResult` должна быть равна нулю и файлы также будут скачаны).
 
Вы хотите просмотреть два последовательных события этого типа и содержимого, чтобы сообщить, что сервер завершил загрузку пространства имен. Это нормально, если между событиями 2 9102 возникают разные события.

## <a name="phase-10-catch-up-robocopy-from-your-nas"></a>Этап 10. перехватывать Robocopy с NAS

После того как сервер завершит первоначальную синхронизацию всего пространства имен из облачного общего ресурса, можно перейти к этому шагу. Перед тем как продолжить выполнение этого шага, крайне важно, чтобы этот шаг был завершен. Дополнительные сведения см. в предыдущем разделе.

На этом шаге вы выполните задания Robocopy, чтобы получить доступ к облачным общим ресурсам с последними изменениями на NAS с момента развилки общих ресурсов на Датабокс.
Такое дополнительное средство Robocopy может завершиться быстро или занять некоторое время в зависимости от объема изменений, произошедших в общих ресурсах NAS.

> [!WARNING]
> Из-за регрессионного поведения Robocopy в Windows Server 2019 коммутатор/мир не совместим с многоуровневый целевым каталогом. Для этого этапа миграции не следует использовать клиент Windows Server 2019 или Windows 10. Используйте Robocopy на промежуточном сервере Windows Server 2016.

Базовый подход к миграции — это средство Robocopy от устройства NAS до Windows Server, а также Синхронизация файлов Azure к общим файловым ресурсам Azure.

Запустите первую локальную копию в целевой папке Windows Server:

1. Найдите первое расположение на устройстве NAS.
1. Найдите соответствующую папку на сервере Windows, на которой уже настроен Синхронизация файлов Azure.
1. Запуск копирования с помощью средства Robocopy

Следующая команда Robocopy скопирует только различия (обновленные файлы и папки) из хранилища NAS в целевую папку Windows Server. Затем Windows Server синхронизирует их с файловыми ресурсами Azure. 

[!INCLUDE [storage-files-migration-robocopy](../../../includes/storage-files-migration-robocopy.md)]

Если вы подготовили меньше места на сервере Windows Server, чем файлы, заданные на устройстве NAS, вы настроили распределение по уровням облака. По мере заполнения локального тома Windows Server распределение по [уровням облака](storage-sync-cloud-tiering-overview.md) будет запущено в, а файлы уровня, которые были успешно синхронизированы. Распределение по уровням облака создаст достаточно места для продолжения копирования с устройства NAS. Распределение по уровням в облаке выполняется один раз в час, чтобы увидеть, что синхронизировано, и освободить место на диске, чтобы получить доступ к свободному объему тома 99%.
Возможно, что средство Robocopy должно перемещать многочисленные файлы, а не локальное хранилище для Windows Server. В среднем можно заждаться, что средство Robocopy будет переносить гораздо быстрее, чем Синхронизация файлов Azure можете передавать файлы на локальный том и распределять их по уровням. Команда Robocopy завершится ошибкой. Рекомендуется работать с общими ресурсами в последовательности, которая не позволяет это сделать. Например, не следует запускать задания Robocopy для всех общих ресурсов одновременно или только перемещать общие ресурсы, которые соответствуют текущему объему свободного пространства на сервере Windows Server, чтобы упомянуть несколько раз. Хорошая новость заключается в том, что параметр/мир будет перемещать только изменения, а после перемещения изменений перезапущенное задание не потребует повторного перемещения этого файла.

### <a name="user-cut-over"></a>Вырезание пользователя

При первом запуске команды Robocopy пользователи и приложения по-прежнему получают доступ к файлам на NAS и потенциально могут изменить их. Возможно, средство Robocopy обработало каталог, переходит к следующему, а затем пользователь в исходном расположении (NAS) добавляет, изменяет или удаляет файл, который сейчас не будет обрабатываться в текущем запуске средства Robocopy. Это ожидаемое поведение.

Первый запуск заключается в перемещении большого объема обработанных данных на сервер Windows Server и в облако с помощью Синхронизация файлов Azure. Эта первая копия может занять много времени, в зависимости от следующих:

* пропускная способность передачи
* скорость локальной сети и количество оптимальных потоков Robocopy.
* количество элементов (файлов и папок), которые должны быть обработаны средством Robocopy и Синхронизация файлов Azure

После завершения начального запуска выполните команду еще раз.

При втором запуске Robocopy для одной и той же общей папки она будет выполняться быстрее, так как ей нужно только передать изменения, произошедшие с момента последнего запуска. Вы можете выполнять повторяющиеся задания для одной и той же общей папки.

При рассмотрении времени простоя необходимо удалить доступ пользователей к общим ресурсам на основе NAS. Это можно сделать любыми шагами, которые не позволяют пользователям изменять структуру и содержимое файлов и папок. Например, можно указать DFS-Namespace несуществующее расположение или изменить корневой список ACL в общей папке.

Выполнить один последний цикл Robocopy. Он выберет все изменения, которые могли быть пропущены.
Время выполнения последнего шага зависит от скорости сканирования Robocopy. Вы можете оценить время (которое равно времени простоя), измеряя длительность предыдущего запуска.

Создайте общую папку в папке Windows Server и, возможно, настройте развертывание DFS-N, чтобы она указывала на нее. Не забудьте установить те же разрешения на уровне общего ресурса, что и в общем ресурсе SMB NAS. Если у вас есть присоединенный к домену NAS корпоративного класса, идентификаторы безопасности пользователя будут автоматически сопоставляться по мере того, как они существуют в Active Directory и Robocopy копирует файлы и метаданные с полной точностью. Если вы использовали локальных пользователей на NAS, необходимо повторно создать этих пользователей в качестве локальных пользователей Windows Server и сопоставлять существующие идентификаторы безопасности, которые средство Robocopy переместит на сервер Windows Server с идентификаторами безопасности новых локальных пользователей Windows Server.

Вы завершили миграцию общей папки или группы общих папок в общий корень или том. (В зависимости от вашего сопоставления из фазы 1)

Можно попытаться выполнить несколько из этих копий параллельно. Рекомендуется обрабатывать по одной общей папке Azure за раз.

## <a name="troubleshoot"></a>Диагностика

Наиболее вероятной причиной проблемы, с которой можно столкнуться, является то, что команда Robocopy завершается с ошибкой *"том Full"* на стороне Windows Server. Распределение по уровням в облаке действует один раз в час, чтобы эвакуировать содержимое с локального диска Windows Server, синхронизированного. Его целью является достижение 99% свободного места на томе.

Разрешите выполнение синхронизации и распределение по уровням облака, освободите место на диске. Это можно заметить в проводнике на Windows Server.

При наличии достаточной емкости Windows Server повторное выполнение команды устранит проблему. При возникновении этой ситуации ничего не происходит, и вы можете легко продвигаться вперед. Неудобство выполнения команды является единственным следствием.

Чтобы устранить неполадки Синхронизация файлов Azure, просмотрите ссылку в следующем разделе.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о файловых ресурсах Azure и Синхронизация файлов Azure см. здесь. Следующие статьи содержат сведения о дополнительных параметрах, рекомендациях, а также об устранении неполадок. В этих статьях содержатся ссылки на [документацию по общей папке Azure](storage-files-introduction.md) .

* [Общие сведения о миграции](storage-files-migration-overview.md)
* [Общие сведения о AFS](./storage-sync-files-planning.md)
* [Рекомендации по развертыванию AFS](./storage-how-to-create-file-share.md)
* [Устранение неполадок с AFS](storage-sync-files-troubleshoot.md)
