---
title: Управление тем, что может делать пользователь на уровне файлов — файловые ресурсы Azure
description: Узнайте, как настроить разрешения ACL Windows для локальной AD DS проверки подлинности в файловые ресурсы Azure. Позволяет воспользоваться преимуществами детализированного контроля доступа.
author: roygara
ms.service: storage
ms.subservice: files
ms.topic: how-to
ms.date: 09/16/2020
ms.author: rogarana
ms.openlocfilehash: 698b4ebedfc9b41e8c5732a0a81226a971d65585
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "103470759"
---
# <a name="part-three-configure-directory-and-file-level-permissions-over-smb"></a>Часть 3. Настройка разрешений на уровне каталога и файлов по протоколу SMB 

Перед началом работы с этой статьей убедитесь, что вы завершили предыдущую статью, [назначили удостоверению разрешения на уровне общего доступа](storage-files-identity-ad-ds-assign-permissions.md) , чтобы убедиться в наличии разрешений на уровне общего ресурса.

После назначения разрешений на уровне общего доступа с помощью Azure RBAC необходимо настроить соответствующие списки ACL Windows на уровне корня, каталога или файла, чтобы воспользоваться преимуществами детализированного контроля доступа. Разрешения уровня общего доступа Azure RBAC можно рассматривать как привратник высокого уровня, который определяет, может ли пользователь получить доступ к общей папке. Хотя списки управления доступом Windows работают на более детализированном уровне, чтобы определить, какие операции пользователь может выполнять на уровне каталога или файла. Разрешения на уровне общего доступа и уровня файлов и каталогов применяются, когда пользователь пытается получить доступ к файлу или каталогу, поэтому при наличии разницы между ними будет применено только наиболее строгое из них. Например, если пользователь имеет доступ на чтение и запись на уровне файла, но только считывает его на уровне общего доступа, он может только читать этот файл. То же самое было бы верно, если бы он был реверсирован, а у пользователя есть доступ на чтение и запись на уровне общего ресурса, но только читать на уровне файла, он все равно может только считывать файл.

## <a name="azure-rbac-permissions"></a>Разрешения RBAC в Azure

В следующей таблице содержатся разрешения RBAC Azure, связанные с этой конфигурацией.


| Встроенные роли  | Разрешение NTFS  | Итоговый доступ  |
|---------|---------|---------|
|Читатель общей папки файловых данных хранилища SMB | Полный доступ, изменение, чтение, запись, выполнение | Чтение и выполнение  |
|     |   Чтение |     Чтение  |
|Участник общей папки файловых данных хранилища SMB  |  Полный доступ    |  Изменение, чтение, запись, выполнение |
|     |  Изменить         |  Изменить    |
|     |  Чтение и выполнение |  Чтение и выполнение |
|     |  Чтение           |  Чтение    |
|     |  запись          |  запись   |
|Участник общих папок данных SMB службы хранилища с повышенными правами | Полный доступ  |  Изменение, чтение, запись, изменение, выполнение |
|     |  Изменить          |  Изменить |
|     |  Чтение и выполнение  |  Чтение и выполнение |
|     |  Чтение            |  Чтение   |
|     |  запись           |  запись  |



## <a name="supported-permissions"></a>Поддерживаемые разрешения

Служба файлов Azure поддерживает полный набор списков управления доступом Windows (базовый и расширенный). Вы можете просматривать и настраивать списки управления доступом Windows для каталогов и файлов в общем файловом ресурсе Azure, подключив общую папку, а затем используя проводник файлов Windows, выполнив команду Windows [icacls](/windows-server/administration/windows-commands/icacls) или команду [Set-ACL](/powershell/module/microsoft.powershell.security/set-acl) . 

Чтобы настроить списки ACL с разрешениями суперпользователя, необходимо подключить общий ресурс с помощью ключа учетной записи хранения на виртуальной машине, присоединенной к домену. Следуйте инструкциям в следующем разделе, чтобы подключить общую папку Azure из командной строки и настроить списки управления доступом Windows.

В корневой каталог общей папки включены следующие разрешения:

- BUILTIN\Administrators:(OI)(CI)(F);
- BUILTIN\Users:(RX);
- BUILTIN\Users:(OI)(CI)(IO)(GR,GE);
- NT AUTHORITY\Authenticated Users:(OI)(CI)(M);
- NT AUTHORITY\SYSTEM:(OI)(CI)(F);
- NT AUTHORITY\SYSTEM:(F);
- CREATOR OWNER:(OI)(CI)(IO)(F).

|Пользователи|Определение|
|---|---|
|BUILTIN\Administrators|Все пользователи, являющиеся администраторами домена локальной среды AD DS.
|Builtin \ пользователи|Встроенная группа безопасности в AD. По умолчанию он включает пользователей NT Аусорити\аусентикатед. Для традиционного файлового сервера можно настроить определение членства для каждого сервера. Для файлов Azure отсутствует сервер размещения, поэтому Builtin \ пользователи включает тот же набор пользователей, что и пользователи NT Аусорити\аусентикатед.|
|NT AUTHORITY\SYSTEM|Учетная запись службы для операционной системы файлового сервера. Такая учетная запись службы не применяется в контексте файлов Azure. Он включается в корневой каталог, чтобы соответствовать интерфейсу Windows Files Server для гибридных сценариев.|
|Пользователи NT Аусорити\аусентикатед|Все пользователи в AD, которые могут получить действительный токен Kerberos.|
|CREATOR OWNER|У каждого объекта либо каталога, либо файла есть владелец для этого объекта. Если для этого объекта назначены списки ACL, то пользователь, являющийся владельцем этого объекта, имеет разрешения на объект, определенный ACL.|



## <a name="mount-a-file-share-from-the-command-prompt"></a>Подключение файлового ресурса Azure из командной строки

Используйте команду Windows, `net use` чтобы подключить файловый ресурс Azure. Не забудьте заменить значения заполнителей в следующем примере собственными значениями. Дополнительные сведения о подключении общих файловых ресурсов см. [в статье использование файлового ресурса Azure с Windows](storage-how-to-use-files-windows.md). 

```
$connectTestResult = Test-NetConnection -ComputerName <storage-account-name>.file.core.windows.net -Port 445
if ($connectTestResult.TcpTestSucceeded)
{
  net use <desired-drive-letter>: \\<storage-account-name>.file.core.windows.net\<share-name> /user:Azure\<storage-account-name> <storage-account-key>
} 
else 
{
  Write-Error -Message "Unable to reach the Azure storage account via port 445. Check to make sure your organization or ISP is not blocking port 445, or use Azure P2S VPN,   Azure S2S VPN, or Express Route to tunnel SMB traffic over a different port."
}

```

Если при подключении к службе файлов Azure возникают проблемы, обратитесь к [средству устранения неполадок, опубликованному для ошибок подключения к службе файлов Azure в Windows](https://azure.microsoft.com/blog/new-troubleshooting-diagnostics-for-azure-files-mounting-errors-on-windows/). Мы также предоставляем [рекомендации](./storage-files-faq.md#on-premises-access) по обойти сценарии, когда порт 445 заблокирован. 

## <a name="configure-windows-acls"></a>Настройка списков управления доступом Windows

После подключения общей папки с ключом учетной записи хранения необходимо настроить списки ACL Windows (также называемые разрешениями NTFS). Списки управления доступом Windows можно настроить с помощью проводника Windows или icacls.

Если у вас есть каталоги или файлы на локальных файловых серверах со списками DACL Windows, настроенными для удостоверений AD DS, вы можете скопировать их в службу файлов Azure, сохраняющую списки ACL с помощью традиционных средств копирования файлов, таких как Robocopy или [Azure AzCopy v 10.4 +](https://github.com/Azure/azure-storage-azcopy/releases). Если каталоги и файлы распределены по уровням в службе файлов Azure с помощью Синхронизация файлов Azure, списки ACL переносятся и сохраняются в собственном формате.

### <a name="configure-windows-acls-with-icacls"></a>Настройка списков управления доступом Windows с помощью icacls

Используйте следующую команду Windows, чтобы предоставить полный набор разрешений для всех каталогов и файлов в файловом ресурсе, включая корневую папку. Не забудьте заменить значения заполнителей в примере собственными значениями.

```
icacls <mounted-drive-letter>: /grant <user-email>:(f)
```

Дополнительные сведения об использовании icacls для задания списков управления доступом Windows и различных типов поддерживаемых разрешений см. [в справочнике по командной строке для icacls](/windows-server/administration/windows-commands/icacls).

### <a name="configure-windows-acls-with-windows-file-explorer"></a>Настройка списков управления доступом Windows с помощью проводника Windows

Используйте проводник файлов Windows, чтобы предоставить полный доступ ко всем каталогам и файлам в общей папке, включая корневой каталог. Если вы не можете правильно загрузить сведения о домене Active Directory в проводнике Windows, это может быть связано с конфигурацией доверия в локальной среде AD. Клиентскому компьютеру не удалось подключиться к контроллеру домена AD, зарегистрированному для проверки подлинности службы файлов Azure. В этом случае используйте icacls для Настройка списков ACL Windows.

1. Откройте проводник Windows и щелкните правой кнопкой мыши файл или каталог и выберите пункт **Свойства**.
1. Перейдите на вкладку **Безопасность**.
1. Нажмите кнопку **изменить.** для изменения разрешений.
1. Можно изменить разрешения существующих пользователей или нажать кнопку **Добавить...** , чтобы предоставить разрешения новым пользователям.
1. В окне запроса для добавления новых пользователей введите целевое имя пользователя, которому нужно предоставить разрешения, в поле **Введите имена выбираемых объектов** и выберите **Проверить имена** , чтобы найти полное имя участника-пользователя.
1.    Щелкните **ОК**.
1.    На вкладке **Безопасность** выберите все разрешения, которые вы хотите предоставить новому пользователю.
1.    Нажмите кнопку **Применить**.


## <a name="next-steps"></a>Дальнейшие действия

Теперь, когда эта функция включена и настроена, перейдите к следующей статье, в которой вы подключаете файловый ресурс Azure с виртуальной машины, присоединенной к домену.

[Часть 4. Подключение общей папки из виртуальной машины, присоединенной к домену](storage-files-identity-ad-ds-mount-file-share.md)
