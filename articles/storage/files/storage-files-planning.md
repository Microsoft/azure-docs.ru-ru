---
title: Планирование развертывания службы файлов Azure | Документы Майкрософт
description: Общие сведения о планировании развертывания файлов Azure. Можно либо напрямую подключить файловый ресурс Azure, либо кэшировать файловый ресурс Azure локально с Синхронизация файлов Azure.
author: roygara
ms.service: storage
ms.topic: conceptual
ms.date: 09/15/2020
ms.author: rogarana
ms.subservice: files
ms.custom: references_regions
ms.openlocfilehash: e1b29d901630156471bbb9cb8b939bb4bb29c836
ms.sourcegitcommit: a4533b9d3d4cd6bb6faf92dd91c2c3e1f98ab86a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/22/2020
ms.locfileid: "97724239"
---
# <a name="planning-for-an-azure-files-deployment"></a>Планирование развертывания службы файлов Azure
Служба [файлов Azure](storage-files-introduction.md) может быть развернута двумя основными способами: путем прямого подключения файловых ресурсов Azure без сервера или путем кэширования файловых ресурсов Azure локально с помощью синхронизация файлов Azure. Выбор варианта развертывания изменяет те вещи, которые необходимо учитывать при планировании развертывания. 

- **Прямое подключение к файловому ресурсу Azure**. так как служба файлов Azure предоставляет доступ к серверу SMB или NFS, вы можете подключать общие файловые ресурсы Azure локально или в облаке с помощью стандартных клиентов SMB или NFS, доступных в вашей ОС. Так как файловые ресурсы Azure являются бессерверными, развертывание для рабочих сценариев не требует управления файловым сервером или устройством NAS. Это означает, что вам не нужно применять исправления программного обеспечения или подключать физические диски. 

- **Кэширование файлового ресурса Azure локально с помощью Синхронизации файлов Azure**: вы можете использовать службу Синхронизации файлов Azure, чтобы централизованно хранить файловые ресурсы организации в службе файлов Azure, обеспечивая гибкость, производительность и совместимость локального файлового сервера. Синхронизация файлов Azure преобразует локальный (или облачный) сервер Windows Server в быстрый кэш файлового ресурса SMB Azure. 

В этой статье в первую очередь рассматриваются вопросы развертывания для развертывания файлового ресурса Azure, которые напрямую подключаются к локальному или облачному клиенту. Сведения о планировании развертывания Синхронизация файлов Azure см. в разделе [Планирование развертывания Синхронизация файлов Azure](storage-sync-files-planning.md).

## <a name="available-protocols"></a>Доступные протоколы

Служба файлов Azure предлагает два протокола, которые могут использоваться при подключении общих файловых ресурсов, SMB и сетевой файловой системы (NFS). Дополнительные сведения об этих протоколах см. в статье [протоколы файловых ресурсов Azure](storage-files-compare-protocols.md).

> [!IMPORTANT]
> Большая часть содержимого этой статьи относится только к общим ресурсам SMB. Все, что применяется к общим папкам NFS, в частности, позволяет указать, что это применимо.

## <a name="management-concepts"></a>Основные принципы управления
[!INCLUDE [storage-files-file-share-management-concepts](../../../includes/storage-files-file-share-management-concepts.md)]

При развертывании файловых ресурсов Azure в учетных записях хранения рекомендуется:

- Развертывайте файловые ресурсы Azure только в учетных записях хранения с другими файловыми ресурсами Azure. Хотя учетные записи хранения GPv2 позволяют использовать смешанные учетные записи хранения, так как ресурсы хранилища, такие как файловые ресурсы Azure и контейнеры больших двоичных объектов, совместно используют ограничения учетной записи хранения, смешивание ресурсов может усложнить устранение проблем с производительностью позже. 

- Контроль ограничений операций ввода-вывода в секунду в учетной записи хранения при развертывании файловых ресурсов Azure. В идеале следует сопоставлять файловые ресурсы 1:1 с учетными записями хранения, однако это не всегда возможно в связи с различными ограничениями как в организации, так и в Azure. Если невозможно развернуть только один файловый ресурс в одной учетной записи хранения, определите, какие файловые ресурсы будут высоко активными, а какие — менее активными, чтобы не допустить одновременного размещения самых горячих файловых ресурсов в одной учетной записи хранения.

- Развертывайте учетные записи GPv2 и Филестораже и обновляйте GPv1 и классические учетные записи хранения, если они находятся в вашей среде. 

## <a name="identity"></a>Идентификация
Чтобы получить доступ к общему файловому ресурсу Azure, пользователь общей папки должен пройти проверку подлинности и предоставить разрешение на доступ к общей папке. Это делается на основе удостоверения пользователя, обращающегося к общей папке. Служба файлов Azure интегрируется с тремя основными поставщиками удостоверений:
- **Локальные домен Active Directory службы (AD DS или локально AD DS)**. учетные записи хранения Azure могут быть присоединены к домену, принадлежащему заказчику, а также к службам домен Active Directory, как к файловому серверу Windows Server или устройству NAS. Контроллер домена можно развернуть локально, на виртуальной машине Azure или даже в качестве виртуальной машины в другом поставщике облачных служб. Служба "файлы Azure" не зависит от того, где размещается контроллер домена. После того как учетная запись хранения присоединена к домену, конечный пользователь может подключить общую папку с учетной записью пользователя, выполнившего вход на ПК. Проверка подлинности на основе Active Directory использует протокол проверки подлинности Kerberos.
- **Azure Active Directory доменных служб (azure AD DS)**. AD DS Azure предоставляет управляемый корпорацией Майкрософт контроллер домена, который можно использовать для ресурсов Azure. Домен, присоединяемый к учетной записи хранения в Azure AD DS предоставляет те же преимущества, что и домен, присоединяющий его с Active Directory, принадлежащим клиенту. Этот вариант развертывания наиболее удобен для сценариев с прогнозированием и сдвигом приложений, требующих разрешений на основе AD. Так как Azure AD DS обеспечивает проверку подлинности на основе AD, этот параметр также использует протокол проверки подлинности Kerberos.
- **Ключ учетной записи хранения Azure**. файловые ресурсы Azure также можно подключить с помощью ключа учетной записи хранения Azure. Чтобы подключить общую папку таким образом, в качестве имени пользователя используется имя учетной записи хранения, а ключ учетной записи хранения используется в качестве пароля. Использование ключа учетной записи хранения для подключения файлового ресурса Azure фактически является операцией администратора, так как подключенная общая папка будет иметь полный набор разрешений для всех файлов и папок в общей папке, даже если у них есть списки управления доступом. При использовании ключа учетной записи хранения для подключения по протоколу SMB используется протокол проверки подлинности NTLMv2.

Для клиентов, выполняющих миграцию с локальных файловых серверов, или создания новых файловых ресурсов в файлах Azure, предназначенных для работы как файловые серверы Windows или устройства NAS, рекомендуется использовать домен, присоединяемый к учетной записи хранения к **Active Directory, принадлежащему заказчику** . Дополнительные сведения о присоединении учетной записи хранения к домену Active Directory, принадлежащему клиенту, см. в разделе [Обзор Active Directory Файлов Azure](storage-files-active-directory-overview.md).

Если вы планируете использовать ключ учетной записи хранения для доступа к файловым ресурсам Azure, рекомендуется использовать конечные точки службы, как описано в разделе о работе с [сетью](#networking) .

## <a name="networking"></a>Сеть
Файловые ресурсы Azure доступны из любого места через общедоступную конечную точку учетной записи хранения. Это обеспечивает безопасную отправку запросов с проверкой подлинности (например, с авторизацией по идентификатору входа пользователя) изнутри или извне Azure. Во многих клиентских средах первая попытка подключения общей папки Azure на локальной рабочей станции завершится сбоем, хотя подключения с виртуальных машин Azure проходят успешно. Причина в том, что многие организации и поставщики услуг Интернета (ISP) блокируют порт 445, используемый для обмена данными по протоколу SMB. Чтобы просмотреть сведения о поставщиках услуг Интернета, поддерживающих (или не поддерживающих) подключение через порт 445, перейдите на сайт [TechNet](https://social.technet.microsoft.com/wiki/contents/articles/32346.azure-summary-of-isps-that-allow-disallow-access-from-port-445.aspx).

Чтобы разблокировать доступ к общему файловому ресурсу Azure, у вас есть два основных варианта:

- Разблокируйте порт 445 для локальной сети вашей организации. Общие файловые ресурсы Azure могут быть доступны только через общедоступную конечную точку с помощью защищенных Интернет-протоколов, таких как SMB 3,0 и API Филерест. Это самый простой способ доступа к файловому ресурсу Azure из локальной среды, так как он не требует расширенной сетевой конфигурации, чем изменение правил исходящего порта Организации. Однако рекомендуется удалить устаревшие и устаревшие версии протокола SMB, а именно SMB 1,0. Сведения о том, как это сделать, см. в статье [Защита Windows и Windows Server](storage-how-to-use-files-windows.md#securing-windowswindows-server) и [Защита Linux](storage-how-to-use-files-linux.md#securing-linux).

- Доступ к общим файловым ресурсам Azure через подключение ExpressRoute или VPN. При доступе к файловому ресурсу Azure через сетевой туннель вы можете подключить файловый ресурс Azure как к локальной общей папке, так как трафик SMB не проходит через границы Организации.   

Хотя с технической точки зрения гораздо проще подключать файловые ресурсы Azure через общедоступную конечную точку, мы планируем, что большинство клиентов будет использовать для подключения файловых ресурсов Azure через подключение ExpressRoute или VPN. Подключение с этими параметрами возможно с помощью общих папок SMB и NFS. Для этого необходимо настроить следующие параметры для своей среды:  

- **Сетевое туннелирование с помощью ExpressRoute, типа "сеть — сеть" и VPN-подключения "точка — сеть**". туннелирование в виртуальной сети обеспечивает доступ к общим файловым ресурсам Azure из локальной среды, даже если порт 445 заблокирован.
- **Частные конечные** точки. частные конечные точки предоставляют учетной записи хранения выделенный IP-адрес из адресного пространства виртуальной сети. Это обеспечивает сетевое туннелирование без необходимости открывать локальные сети до всех диапазонов IP-адресов, принадлежащих кластерам службы хранилища Azure. 
- **Пересылка DNS**. Настройте локальный DNS-сервер, чтобы разрешить имя учетной записи хранения (например `storageaccount.file.core.windows.net` , для регионов общедоступного облака), чтобы разрешить IP-адрес закрытых конечных точек.

Сведения о планировании сети, связанной с развертыванием файлового ресурса Azure, см. в статье рекомендации по работе с [файлами Azure в сети](storage-files-networking-overview.md).

## <a name="encryption"></a>Шифрование
Служба файлов Azure поддерживает два разных типа шифрования: шифрование при передаче, которое относится к шифрованию, используемому при подключении или доступе к файловому ресурсу Azure, а также к шифрованию неактивных данных, которые связаны с тем, как данные шифруются при хранении на диске. 

### <a name="encryption-in-transit"></a>Шифрование при передаче

> [!IMPORTANT]
> В этом разделе описано шифрование при передаче для общих папок SMB. Дополнительные сведения о шифровании при передаче с использованием общих папок NFS см. в разделе [Безопасность](storage-files-compare-protocols.md#security).

По умолчанию для всех учетных записей хранения Azure включено шифрование при передаче. Это означает, что при подключении общей папки по протоколу SMB или доступе к ней по протоколу FileREST (например, с помощью портала Azure, PowerShell, CLI или пакетов SDK Azure) служба "Файлы Azure" разрешит подключение, только если оно установлено по протоколу SMB версии 3.0 или более поздней с шифрованием или по HTTPS. Клиенты, не поддерживающие SMB 3.0, или клиенты, поддерживающие SMB 3.0, но без шифрования SMB, не смогут подключать общую папку Azure, если включено шифрование при передаче. Дополнительные сведения о том, какие операционные системы поддерживают SMB 3.0 с шифрованием, см. в подробной документации по [Windows](storage-how-to-use-files-windows.md), [macOS](storage-how-to-use-files-mac.md) и [Linux](storage-how-to-use-files-linux.md). Все текущие версии PowerShell, CLI и пакетов SDK поддерживают протокол HTTPS.  

В учетной записи хранения Azure шифрование при передаче можно отключить. Если шифрование отключено, службы файлов Azure также разрешают протокол SMB 2,1, SMB 3,0 без шифрования и незашифрованные вызовы API Филерест по протоколу HTTP. Основная причина отключения шифрования при передаче заключается в поддержке устаревшего приложения, которое должно выполняться в более старой версии операционной системы, например Windows Server 2008 R2 или более старой версии Linux. Служба "Файлы Azure" разрешает только подключения по протоколу SMB 2.1 в том же регионе Azure, что и общая папка Azure. Клиент SMB 2.1 за пределами региона Azure общей папки Azure, например в локальной среде или в другом регионе Azure, не сможет получить доступ к общей папке.

Настоятельно рекомендуется включить шифрование данных при передаче.

Дополнительные сведения о шифровании при передаче см. в статье [Require secure transfer in Azure Storage](../common/storage-require-secure-transfer.md?toc=%2fazure%2fstorage%2ffiles%2ftoc.json) (Требование безопасной передачи в службе хранилища Azure).

### <a name="encryption-at-rest"></a>Шифрование при хранении
[!INCLUDE [storage-files-encryption-at-rest](../../../includes/storage-files-encryption-at-rest.md)]

## <a name="data-protection"></a>Защита данных
Служба файлов Azure имеет многоуровневый подход к обеспечению резервного копирования, восстановления и защиты данных от угроз безопасности.

### <a name="soft-delete"></a>Обратимое удаление
Обратимое удаление общих файловых ресурсов (Предварительная версия) — это параметр уровня учетной записи хранения, который позволяет восстановить файловый ресурс при случайном удалении. При удалении общей папки она переходит в обратимо Удаленное состояние, а не удаляется навсегда. Можно настроить время восстановления обратимо удаленных данных перед их окончательным удалением и отменить удаление общей папки в течение этого периода хранения. 

Мы рекомендуем включить обратимое удаление для большинства файловых ресурсов. Если у вас есть рабочий процесс, где удаление общего ресурса является общим и ожидаемым, возможно, вы решили очень короткий срок хранения или не включили обратимое удаление.

Дополнительные сведения об обратимом удалении см. в разделе [предотвращение случайного удаления данных](./storage-files-prevent-file-share-deletion.md).

### <a name="backup"></a>Резервное копирование
Вы можете создать резервную копию общего файлового ресурса Azure, используя [моментальные снимки общего ресурса](./storage-snapshots-files.md), которые предназначены только для чтения и представляют собой копии общего ресурса на момент времени. Моментальные снимки являются добавочными, то есть они содержат только столько данных, сколько было изменено с момента предыдущего снимка. Можно создать до 200 моментальных снимков на общую папку и хранить их в течение 10 лет. Можно либо вручную создать эти моментальные снимки в портал Azure, с помощью PowerShell или интерфейса командной строки (CLI), либо использовать [Azure Backup](../../backup/azure-file-share-backup-overview.md?toc=%2fazure%2fstorage%2ffiles%2ftoc.json). Моментальные снимки хранятся в общей папке. Это означает, что если вы удалите файловый ресурс, моментальные снимки также будут удалены. Чтобы защитить резервные копии моментальных снимков от случайного удаления, убедитесь, что для общей папки включено обратимое удаление.

[Azure Backup для файловых ресурсов Azure](../../backup/azure-file-share-backup-overview.md?toc=%2fazure%2fstorage%2ffiles%2ftoc.json) выполняет планирование и хранение моментальных снимков. Его возможности дед-отца-отец (GFS) означают, что можно создавать ежедневные, еженедельные, ежемесячные и ежегодные моментальные снимки, каждый из которых имеет свой собственный срок хранения. Azure Backup также управляет включением обратимого удаления и принимает блокировку удаления в учетной записи хранения, как только общая папка в ней настроена для резервного копирования. Наконец, Azure Backup предоставляет некоторые ключевые возможности мониторинга и оповещения, позволяющие клиентам получать объединенное представление о своей резервной копии.

Можно выполнять восстановление на уровне элементов и на уровне общего ресурса в портал Azure с помощью Azure Backup. Вам нужно всего лишь выбрать точку восстановления (определенный моментальный снимок), конкретный файл или каталог, а затем расположение (исходное или альтернативное), в которое вы хотите выполнить восстановление. Служба резервного копирования обрабатывает копирование данных моментального снимка и показывает ход выполнения восстановления на портале.

Дополнительные сведения о резервном копировании см. в статье [о резервном копировании файловых ресурсов Azure](../../backup/azure-file-share-backup-overview.md?toc=%2fazure%2fstorage%2ffiles%2ftoc.json).

### <a name="advanced-threat-protection-for-azure-files-preview"></a>Расширенная защита от угроз для файлов Azure (Предварительная версия)
Расширенная защита от угроз (ATP) для службы хранилища Azure предоставляет дополнительный уровень логики безопасности, который предоставляет предупреждения при обнаружении аномальных действий в учетной записи хранения, например необычных попыток доступа к учетной записи хранения. ATP также выполняет анализ репутации хэша вредоносных программ и оповещает об известных вредоносных программах. Вы можете настроить ATP в подписке или на уровне учетной записи хранения с помощью центра безопасности Azure. 

Дополнительные сведения см. в статье [Расширенная защита от угроз для службы хранилища Azure](../common/azure-defender-storage-configure.md).

## <a name="storage-tiers"></a>Уровни хранилища
[!INCLUDE [storage-files-tiers-overview](../../../includes/storage-files-tiers-overview.md)]

### <a name="enable-standard-file-shares-to-span-up-to-100-tib"></a>Включение стандартных файловых ресурсов для увеличения объема до 100 ТиБ
[!INCLUDE [storage-files-tiers-enable-large-shares](../../../includes/storage-files-tiers-enable-large-shares.md)]

#### <a name="limitations"></a>Ограничения
[!INCLUDE [storage-files-tiers-large-file-share-availability](../../../includes/storage-files-tiers-large-file-share-availability.md)]

## <a name="redundancy"></a>Избыточность
[!INCLUDE [storage-files-redundancy-overview](../../../includes/storage-files-redundancy-overview.md)]

## <a name="migration"></a>Миграция
Во многих случаях вы не будете устанавливать общий файловый ресурс для вашей организации, а вместо этого перенесите существующий файловый ресурс с локального файлового сервера или устройства NAS в службу файлов Azure. Выбор правильной стратегии и средства миграции для вашего сценария важен для успешного выполнения миграции. 

В [статье Общие сведения о миграции](storage-files-migration-overview.md) кратко рассматриваются основы и содержится таблица, в которой представлены руководства по миграции, которые, скорее всего, охватывают ваш сценарий.

## <a name="next-steps"></a>Дальнейшие действия
* [Планирование развертывания Синхронизация файлов Azure](storage-sync-files-planning.md)
* [How to deploy Azure Files](storage-files-deployment-guide.md) (Развертывание службы "Файлы Azure")
* [Развертывание службы синхронизации файлов Azure (предварительная версия)](storage-sync-files-deployment-guide.md)
* [Ознакомьтесь со статьей Обзор миграции, чтобы найти руководство по миграции для вашего сценария.](storage-files-migration-overview.md)
