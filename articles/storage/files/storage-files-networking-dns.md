---
title: Настройка пересылки DNS для службы файлов Azure | Документация Майкрософт
description: Узнайте, как настроить пересылку DNS для службы файлов Azure.
author: roygara
ms.service: storage
ms.topic: how-to
ms.date: 3/19/2020
ms.author: rogarana
ms.subservice: files
ms.openlocfilehash: 9abe306668a4b20e42e45c498bf85b540dfaaee5
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "94630198"
---
# <a name="configuring-dns-forwarding-for-azure-files"></a>Настройка перенаправления DNS для Файлов Azure
Служба файлов Azure позволяет создавать частные конечные точки для учетных записей хранения, содержащих общие файловые ресурсы. Для многих различных приложений частные конечные точки особенно полезны для подключения к файловым ресурсам Azure из локальной сети с помощью подключения VPN или ExpressRoute с помощью частного пиринга. 

Чтобы подключения к вашей учетной записи хранения могли проходить через сетевой туннель, полное доменное имя (FQDN) учетной записи хранения должно разрешаться в частный IP-адрес частной конечной точки. Для этого необходимо перенаправить суффикс конечной точки хранилища ( `core.windows.net` для регионов общедоступного облака) в закрытую службу DNS Azure, доступную в виртуальной сети. В этом руководство показано, как настроить перенаправление DNS для правильного разрешения на IP-адрес частной конечной точки вашей учетной записи хранения.

Перед выполнением действий, описанных в этой статье, мы настоятельно рекомендуем ознакомиться с [планированием развертывания файлов Azure](storage-files-planning.md) и сетевых возможностей службы [файлов Azure](storage-files-networking-overview.md) .

## <a name="overview"></a>Обзор
Файлы Azure предоставляют два основных типа конечных точек для доступа к общим папкам Azure: 
- общедоступные конечные точки, у которых есть общедоступный IP-адрес и к которым можно обращаться из любой точки мира;
- частные конечные точки, которые существуют только в виртуальной сети и имеют частный IP-адрес в пределах адресного пространства этой виртуальной сети.

Общедоступные и частные конечные точки размещаются в учетной записи хранения Azure. Учетная запись хранения — это конструкция управления, представляющая собой общий пул носителей, который можно использовать для развертывания нескольких общих папок и других ресурсов хранения, например контейнеров больших двоичных объектов или очередей.

Каждая учетная запись хранения имеет полное доменное имя (FQDN). Для регионов общедоступного облака это полное доменное имя соответствует шаблону, `storageaccount.file.core.windows.net` где `storageaccount` — это название учетной записи хранения. При выполнении запросов к этому имени, например при подключении общей папки на рабочей станции с помощью SMB, операционная система выполняет поиск DNS, чтобы разрешить полное доменное имя в IP-адрес, который может использоваться для отправки запросов SMB.

По умолчанию `storageaccount.file.core.windows.net` разрешается в IP-адрес общедоступной конечной точки. Общедоступная конечная точка для учетной записи хранения размещается в кластере службы хранилища Azure, где размещаются общедоступные конечные точки общих учетных записей хранения. При создании частной конечной точки частная зона DNS связывается с виртуальной сетью, в которую она была добавлена, с сопоставлением записи CNAME с записью `storageaccount.file.core.windows.net` a для частного IP-адреса частной конечной точки вашей учетной записи хранения. Это позволяет использовать `storageaccount.file.core.windows.net` полное доменное имя в виртуальной сети и разрешать его в IP-адрес частной конечной точки.

Так как нашей конечной целью является доступ к общим файловым ресурсам Azure, размещенным в учетной записи хранения, из локальной сети с помощью сетевого туннеля, такого как подключение VPN или ExpressRoute, необходимо настроить локальные DNS-серверы для перенаправления запросов к службе файлов Azure в службу "Частная DNS" Azure. Для этого необходимо настроить *условное перенаправление* `*.core.windows.net` (или соответствующий суффикс конечной точки хранилища для национальных облаков США, Германии или Китая) на DNS-сервер, размещенный в виртуальной сети Azure. Этот DNS-сервер рекурсивно перенаправит запрос в закрытую службу DNS Azure, которая будет разрешать полное доменное имя учетной записи хранения на соответствующий частный IP-адрес.

Для настройки пересылки DNS для службы файлов Azure потребуется запустить виртуальную машину для размещения DNS-сервера для пересылки запросов, однако это один раз для всех файловых ресурсов Azure, размещенных в виртуальной сети. Кроме того, это не является эксклюзивным требованием для службы файлов Azure. Любая служба Azure, которая поддерживает частные конечные точки, к которым вы хотите получить доступ из локальной среды, может использовать пересылку DNS, которая будет настроена в этом руководство: хранилище BLOB-объектов Azure, SQL Azure, Cosmos DB и т. д. 

В этом руководстве описаны действия по настройке пересылки DNS для конечной точки службы хранилища Azure, поэтому в дополнение к службе файлов Azure запросы на разрешение имен DNS для всех других служб хранилища Azure (хранилище BLOB-объектов Azure, хранилище таблиц Azure, хранилище очередей Azure и т. д.) будут перенаправлены в закрытую службу DNS Azure. При необходимости можно также добавить дополнительные конечные точки для других служб Azure. Также будет настроена пересылка DNS на локальные DNS-серверы, что позволяет использовать облачные ресурсы в виртуальной сети (например, сервер DFS-N) для разрешения имен локальных компьютеров. 

## <a name="prerequisites"></a>Предварительные условия
Перед настройкой DNS-пересылки в службу файлов Azure необходимо выполнить следующие действия.

- Учетная запись хранения, содержащая общую папку Azure, которую вы хотите подключить. Сведения о том, как создать учетную запись хранения и файловый ресурс Azure, см. в статье [Создание файлового ресурса Azure](storage-how-to-create-file-share.md).
- Частная конечная точка для учетной записи хранения. Сведения о создании частной конечной точки для службы файлов Azure см. в статье [Создание частной конечной точки](storage-files-networking-endpoints.md#create-a-private-endpoint).
- [Последняя версия](/powershell/azure/install-az-ps) модуля Azure PowerShell.

> [!Important]  
> В этом учебнике предполагается, что вы используете DNS-сервер в Windows Server в локальной среде. Все действия, описанные в этом руководстве, возможны при использовании любого DNS-сервера, а не только DNS-сервера Windows.

## <a name="manually-configuring-dns-forwarding"></a>Настройка пересылки DNS вручную
Если у вас уже есть DNS-серверы в виртуальной сети Azure или вы просто предпочитаете развертывать собственные виртуальные машины на DNS-серверах с использованием какой-либо методологии, используемой вашей организацией, можно вручную настроить DNS с помощью встроенных командлетов PowerShell для DNS-сервера.

На локальных DNS-серверах создайте сервер условной пересылки с помощью `Add-DnsServerConditionalForwarderZone` . Этот условный сервер пересылки должен быть развернут на всех локальных DNS-серверах, чтобы быть эффективным при правильной пересылке трафика в Azure. Не забудьте заменить `<azure-dns-server-ip>` соответствующими IP-адресами вашей среды.

```powershell
$vnetDnsServers = "<azure-dns-server-ip>", "<azure-dns-server-ip>"

$storageAccountEndpoint = Get-AzContext | `
    Select-Object -ExpandProperty Environment | `
    Select-Object -ExpandProperty StorageEndpointSuffix

Add-DnsServerConditionalForwarderZone `
        -Name $storageAccountEndpoint `
        -MasterServers $vnetDnsServers
```

На DNS-серверах в виртуальной сети Azure также потребуется разместить сервер пересылки, чтобы запросы к зоне DNS учетной записи хранения направляются в закрытую службу DNS Azure, которая находится в начале зарезервированного IP-адреса `168.63.129.16` . (Не забудьте заполнить, `$storageAccountEndpoint` Если вы используете команды в другом сеансе PowerShell.)

```powershell
Add-DnsServerConditionalForwarderZone `
        -Name $storageAccountEndpoint `
        -MasterServers "168.63.129.16"
```

## <a name="using-the-azure-files-hybrid-module-to-configure-dns-forwarding"></a>Использование гибридного модуля службы файлов Azure для настройки пересылки DNS
Чтобы настроить перенаправление DNS как можно проще, мы предоставили автоматизацию в гибридном модуле службы файлов Azure. Командлеты, предоставляемые для управления DNS в этом модуле, помогут развернуть DNS-серверы в виртуальной сети Azure и обновить локальные DNS-серверы, чтобы они перенаправлялись на них. 

Если вы никогда не использовали гибридный модуль "службы файлов Azure", сначала необходимо установить его на рабочей станции. Скачайте [последнюю версию](https://github.com/Azure-Samples/azure-files-samples/releases) гибридного модуля PowerShell для файлов Azure:

```PowerShell
# Unzip the downloaded file
Expand-Archive -Path AzFilesHybrid.zip

# Change the execution policy to unblock importing AzFilesHybrid.psm1 module
Set-ExecutionPolicy -ExecutionPolicy Unrestricted

# Navigate to where AzFilesHybrid is unzipped and stored and run to copy the files into your path
.\AzFilesHybrid\CopyToPSPath.ps1 

# Import AzFilesHybrid module
Import-Module -Name AzFilesHybrid
```

Развертывание решения переадресации DNS включает два шага: создание набора правил переадресации DNS, который определяет службы Azure, на которые требуется перенаправлять запросы, а также фактическое развертывание серверов пересылки DNS. 

В следующем примере запросы к учетной записи хранения, инклюзивным запросам к службе файлов Azure, хранилищу BLOB-объектов Azure, хранилищу таблиц Azure и хранилищу очередей Azure пересылаются. При необходимости можно добавить пересылку для дополнительной службы Azure в правило с помощью `-AzureEndpoints` параметра `New-AzDnsForwardingRuleSet` командлета. Не забудьте заменить `<virtual-network-resource-group>`, `<virtual-network-name>` и `<subnet-name>` соответствующими значениями из своей среды.

```PowerShell
# Create a rule set, which defines the forwarding rules
$ruleSet = New-AzDnsForwardingRuleSet -AzureEndpoints StorageAccountEndpoint

# Deploy and configure DNS forwarders
New-AzDnsForwarder `
        -DnsForwardingRuleSet $ruleSet `
        -VirtualNetworkResourceGroupName "<virtual-network-resource-group>" `
        -VirtualNetworkName "<virtual-network-name>" `
        -VirtualNetworkSubnetName "<subnet-name>"
```

Кроме того, вы можете найти полезные или необходимые параметры для предоставления нескольких дополнительных параметров:

| Имя параметра | Type | Описание |
|----------------|------|-------------|
| `DnsServerResourceGroupName` | `string` | По умолчанию DNS-серверы будут развернуты в той же группе ресурсов, что и виртуальная сеть. Если это не требуется, этот параметр позволяет выбрать альтернативную группу ресурсов для развертывания в. |
| `DnsForwarderRootName` | `string` | По умолчанию DNS-серверы, развернутые в Azure, имеют имена `DnsFwder-*` , где звездочка заполняется итератором. Этот параметр изменяет корень этого имени (т. е. `DnsFwder` ). |
| `VmTemporaryPassword` | `SecureString` | По умолчанию случайный пароль выбирается для временной учетной записи по умолчанию, которая находится на виртуальной машине до ее присоединения к домену. После присоединения к домену учетная запись по умолчанию будет отключена. |
| `DomainToJoin` | `string` | Домен, к которому необходимо присоединить виртуальные машины DNS. По умолчанию этот домен выбирается в зависимости от домена компьютера, на котором выполняются командлеты. |
| `DnsForwarderRedundancyCount` | `int` | Число виртуальных машин DNS для развертывания в виртуальной сети. По умолчанию `New-AzDnsForwarder` развертывает два DNS-сервера в виртуальной сети Azure в группе доступности, чтобы обеспечить избыточность. При необходимости это число можно изменить. |
| `OnPremDnsHostNames` | `HashSet<string>` | Вручную указанный список локальных имен узлов DNS для создания серверов пересылки. Этот параметр полезен, если вы не хотите применять серверы пересылки на всех локальных DNS-серверах, например при наличии диапазона клиентов с указанными вручную DNS-именами. |
| `Credential` | `PSCredential` | Учетные данные для использования при обновлении DNS-серверов. Это полезно, когда у учетной записи пользователя, выполнившего вход в систему, нет разрешений на изменение параметров DNS. |
| `SkipParentDomain` | `SwitchParameter` | По умолчанию серверы пересылки DNS применяются к домену самого высокого уровня, который существует в вашей среде. Например, если `northamerica.corp.contoso.com` является дочерним доменом `corp.contoso.com` , сервер пересылки будет создан для DNS-серверов, связанных с `corp.contoso.com` . Этот параметр приведет к созданию серверов пересылки в `northamerica.corp.contoso.com` . |

## <a name="confirm-dns-forwarders"></a>Подтверждение серверов пересылки DNS
Перед тестированием, чтобы узнать, успешно ли были применены серверы пересылки DNS, рекомендуется очистить кэш DNS на локальной рабочей станции с помощью `Clear-DnsClientCache` . Чтобы проверить, можно ли успешно разрешить полное доменное имя вашей учетной записи хранения, используйте `Resolve-DnsName` или `nslookup` .

```powershell
# Replace storageaccount.file.core.windows.net with the appropriate FQDN for your storage account.
# Note the proper suffix (core.windows.net) depends on the cloud your deployed in.
Resolve-DnsName -Name storageaccount.file.core.windows.net
```

Если разрешение имен прошло успешно, вы увидите, что разрешенный IP-адрес соответствует IP-адресу вашей учетной записи хранения.

```Output
Name                              Type   TTL   Section    NameHost
----                              ----   ---   -------    --------
storageaccount.file.core.windows. CNAME  29    Answer     csostoracct.privatelink.file.core.windows.net
net

Name       : storageaccount.privatelink.file.core.windows.net
QueryType  : A
TTL        : 1769
Section    : Answer
IP4Address : 192.168.0.4
```

Если вы уже настроили подключение VPN или ExpressRoute, можно также использовать, `Test-NetConnection` чтобы увидеть, что TCP-подключение к вашей учетной записи хранения может быть успешно установлено.

```PowerShell
Test-NetConnection -ComputerName storageaccount.file.core.windows.net -CommonTCPPort SMB
```

## <a name="see-also"></a>См. также раздел
- [Планирование развертывания Файлов Azure](storage-files-planning.md)
- [Рекомендации по работе с сетями Файлов Azure](storage-files-networking-overview.md)
- [Настройка сетевых конечных точек Файлов Azure](storage-files-networking-endpoints.md)