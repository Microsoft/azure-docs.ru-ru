---
title: Переход с Linux на Синхронизация файлов Azure
description: Узнайте, как перенести файлы из расположения на сервере Linux в гибридное облачное развертывание с помощью Синхронизация файлов Azure и файловых ресурсов Azure.
author: fauhse
ms.service: storage
ms.topic: how-to
ms.date: 03/19/2020
ms.author: fauhse
ms.subservice: files
ms.openlocfilehash: 0ef4faf14ec01a25419fd22ba8c73a8a033b4172
ms.sourcegitcommit: aaa65bd769eb2e234e42cfb07d7d459a2cc273ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/27/2021
ms.locfileid: "98879988"
---
# <a name="migrate-from-linux-to-a-hybrid-cloud-deployment-with-azure-file-sync"></a>Переход с Linux на гибридное облачное развертывание с помощью Синхронизация файлов Azure

Синхронизация файлов Azure работает на экземплярах Windows Server с прямым подключением к хранилищу (DAS). Она не поддерживает синхронизацию с клиентами Linux и от них, а также на удаленном ресурсе SMB или общих сетевых файловых систем (NFS).

В результате преобразование файловых служб в гибридное развертывание делает переход на Windows Server необходимым. В этой статье описывается планирование и выполнение такой миграции.

## <a name="migration-goals"></a>Цели миграции

Цель заключается в том, чтобы переместить общие папки на сервер Linux Samba в экземпляр Windows Server. Затем используйте Синхронизация файлов Azure для гибридного облачного развертывания. Эту миграцию необходимо выполнить таким образом, чтобы гарантировать целостность рабочих данных, а также доступность во время миграции. Последний требует, чтобы время простоя не превышало минимального, так что оно может поместиться в или только немного больше, чем обычные периоды обслуживания.

## <a name="migration-overview"></a>Общие сведения о переносе

Как упоминалось в [статье Обзор миграции](storage-files-migration-overview.md)файлов Azure, важно использовать правильное средство копирования и подход. Сервер Linux Samba предоставляет общие ресурсы SMB непосредственно в локальной сети. Средство Robocopy, встроенное в Windows Server, является лучшим способом перемещения файлов в этом сценарии миграции.

Если вы не используете Samba на сервере Linux и хотите перенести папки в гибридное развертывание на Windows Server, вместо Robocopy можно использовать средства копирования Linux. В этом случае помните о возможностях точности в средстве копирования файлов. Ознакомьтесь с [разделом основные](storage-files-migration-overview.md#migration-basics) сведения о миграции в статье Обзор миграции, чтобы узнать, что искать в средстве копирования.

## <a name="phase-1-identify-how-many-azure-file-shares-you-need"></a>Этап 1. Определение необходимого количества файловых ресурсов Azure

[!INCLUDE [storage-files-migration-namespace-mapping](../../../includes/storage-files-migration-namespace-mapping.md)]

## <a name="phase-2-provision-a-suitable-windows-server-instance-on-premises"></a>Этап 2. предоставление подходящего экземпляра Windows Server в локальной среде

* Создайте экземпляр Windows Server 2019 в качестве виртуальной машины или физического сервера. Windows Server 2012 R2 является минимальным требованием. Также поддерживается отказоустойчивый кластер Windows Server.
* Подготавливайте или добавляйте непосредственно подключенное хранилище (DAS). Запоминающее устройство, подключаемое к сети (NAS), не поддерживается.

  Объем предоставляемого хранилища может быть меньше, чем вы используете на сервере Linux Samba, если вы используете функцию распределения по [уровням облака](storage-sync-cloud-tiering.md) синхронизация файлов Azure. Однако при копировании файлов из более крупного серверного пространства Linux Samba на более короткий том Windows Server на более позднем этапе потребуется работать с пакетами:

  1. Переместите набор файлов, которые помещаются на диск.
  2. Разрешить синхронизацию файлов и участие в облаке по уровням облака.
  3. Если на томе создано больше свободного пространства, перейдите к следующему пакету файлов. 
    
  Этот подход к пакетной обработке можно избежать путем подготовки эквивалентного пространства на экземпляре Windows Server, занимаемого файлами на сервере Linux Samba. Рассмотрите возможность включения дедупликации в Windows. Если вы не хотите окончательно зафиксировать этот большой объем хранилища для экземпляра Windows Server, можно уменьшить размер тома после миграции и перед настройкой политик уровня облака. Это создает меньший локальный кэш файловых ресурсов Azure.

Конфигурация ресурсов (вычислительная и оперативная память) развертываемого экземпляра Windows Server зависит главным образом от количества элементов (файлов и папок), которые вы будете синхронизировать. При наличии каких-либо проблем рекомендуется использовать конфигурацию с более высокой производительностью.

[Узнайте, как изменить размер экземпляра Windows Server на основе числа элементов (файлов и папок), которые необходимо синхронизировать.](storage-sync-files-planning.md#recommended-system-resources)

> [!NOTE]
> Ранее связанная статья представляет собой таблицу с диапазоном памяти сервера (ОЗУ). Вы можете ориентироваться на меньший номер сервера, но предполагается, что начальная синхронизация может занять значительно больше времени.

## <a name="phase-3-deploy-the-azure-file-sync-cloud-resource"></a>Этап 3. Развертывание облачного ресурса Синхронизация файлов Azure

[!INCLUDE [storage-files-migration-deploy-afs-sss](../../../includes/storage-files-migration-deploy-azure-file-sync-storage-sync-service.md)]

## <a name="phase-4-deploy-azure-storage-resources"></a>Этап 4. Развертывание ресурсов службы хранилища Azure

На этом этапе просмотрите таблицу сопоставления из фазы 1 и используйте ее для подсчета правильного числа учетных записей хранения Azure и файловых ресурсов в них.

[!INCLUDE [storage-files-migration-provision-azfs](../../../includes/storage-files-migration-provision-azure-file-share.md)]

## <a name="phase-5-deploy-the-azure-file-sync-agent"></a>Этап 5. Развертывание агента Синхронизация файлов Azure

[!INCLUDE [storage-files-migration-deploy-afs-agent](../../../includes/storage-files-migration-deploy-azure-file-sync-agent.md)]

## <a name="phase-6-configure-azure-file-sync-on-the-windows-server-deployment"></a>Этап 6. Настройка Синхронизация файлов Azure в развертывании Windows Server

Зарегистрированный локальный экземпляр Windows Server должен быть готов к работе и подключен к Интернету для этого процесса.

[!INCLUDE [storage-files-migration-configure-sync](../../../includes/storage-files-migration-configure-sync.md)]

> [!IMPORTANT]
> Распределение по уровням облака — это Синхронизация файлов Azure функция, которая позволяет локальному серверу иметь меньше ресурсов хранилища, чем хранится в облаке, но имеет доступ к полному пространству имен. Локально интересные данные также кэшируются локально для повышения производительности доступа. Распределение по уровням облака является дополнительным компонентом для каждой конечной точки сервера Синхронизация файлов Azure.

> [!WARNING]
> Если объем хранилища, подготовленный на томах Windows Server, не превышает объем данных, используемых на сервере Linux Samba, распределение по уровням облака является обязательным. Если вы не включаете распределение по уровням облака, сервер не будет освобождать место для хранения всех файлов. Задайте политику распределения, временно предназначенную для миграции, на 99 процентов свободного места для тома. После завершения миграции обязательно вернитесь к параметрам уровня облака и задайте для политики более полезный уровень в долгосрочной перспективе.

Повторите шаги по созданию группы синхронизации и добавление соответствующей серверной папки в качестве конечной точки сервера для всех файловых ресурсов Azure и расположений серверов, которые должны быть настроены для синхронизации.

После создания всех конечных точек сервера Синхронизация будет работать. Вы можете создать тестовый файл и увидеть, как он синхронизируется из расположения на сервере с подключенным общим файловым ресурсом Azure (как описано в облачной конечной точке в группе синхронизации).

В обоих расположениях папки сервера и файловые ресурсы Azure в противном случае пусты и ожидают данные. На следующем шаге вы начнете копировать файлы в экземпляр Windows Server для Синхронизация файлов Azure их переноса в облако. Если вы включили распределение по уровням в облаке, сервер начнет использовать файлы уровня, если на локальных томах исчерпана емкость.

## <a name="phase-7-robocopy"></a>Этап 7. Robocopy

Базовый подход к миграции заключается в использовании средства Robocopy для копирования файлов и использования Синхронизация файлов Azure для синхронизации.

Запустите первую локальную копию в целевой папке Windows Server:

1. Найдите первое расположение на сервере Linux Samba.
1. Найдите совпадающую папку на экземпляре Windows Server, на котором уже настроен Синхронизация файлов Azure.
1. Начните копирование с помощью средства Robocopy.

Следующая команда Robocopy скопирует файлы из хранилища вашего сервера Linux Samba в целевую папку Windows Server. Windows Server синхронизирует его с файловыми ресурсами Azure. 

Если вы подготовили меньше места на экземпляре Windows Server по сравнению с тем, что файлы занимают сервер Linux Samba, вы настроили распределение по уровням облака. По мере заполнения локального тома Windows Server распределение по [уровням облака](storage-sync-cloud-tiering.md) будет запущено, а файлы уровней, которые уже были успешно синхронизированы. Распределение по уровням облака создаст достаточно места для продолжения копирования с сервера Linux Samba. Распределение по уровням в облаке выполняется один раз в час, чтобы увидеть, что синхронизировано, и освободить дисковое пространство для достижения политики свободного места в 99% для тома.

Возможно, средство Robocopy перемещает файлы быстрее, чем вы можете синхронизировать с облаком и уровнем локально, что приведет к нехватке места на локальном диске. После этого средство Robocopy завершится ошибкой. Рекомендуется работать с общими ресурсами в последовательности, которая не позволяет решить проблему. Например, рекомендуется не начинать задания Robocopy для всех общих ресурсов одновременно. Или рассмотрите возможность перемещения общих ресурсов, которые соответствуют текущему объему свободного пространства на экземпляре Windows Server. Если задание Robocopy завершается неудачно, вы всегда можете повторно выполнить команду, если вы используете следующий параметр зеркального отображения или очистки:

```console
Robocopy /MT:32 /UNILOG:<file name> /TEE /B /MIR /COPYALL /DCOPY:DAT <SourcePath> <Dest.Path>
```

Фон:

:::row:::
   :::column span="1":::
      /MT
   :::column-end:::
   :::column span="1":::
      Позволяет использовать средство Robocopy для работы с многопоточными потоками. Значение по умолчанию — 8, максимальное — 128.
   :::column-end:::
:::row-end:::
:::row:::
   :::column span="1":::
      /УНИЛОГ:\<file name\>
   :::column-end:::
   :::column span="1":::
      Выводит состояние в файл журнала в формате Юникод (перезаписывает существующий журнал).
   :::column-end:::
:::row-end:::
:::row:::
   :::column span="1":::
      /ти
   :::column-end:::
   :::column span="1":::
      Вывод в окно консоли. Используется в сочетании с выходными данными в файл журнала.
   :::column-end:::
:::row-end:::
:::row:::
   :::column span="1":::
      /B
   :::column-end:::
   :::column span="1":::
      Запускает Robocopy в том же режиме, в котором будет использоваться приложение резервного копирования. Это позволяет Robocopy перемещать файлы, к которым у текущего пользователя нет разрешений.
   :::column-end:::
:::row-end:::
:::row:::
   :::column span="1":::
      /мир
   :::column-end:::
   :::column span="1":::
      Позволяет выполнять эту команду Robocopy несколько раз подряд в том же целевом или целевом объекте. Он определяет и не пропускает скопированные ранее. Обрабатываются только изменения, добавления и удаления, произошедшие с момента последнего выполнения. Если команда не выполнялась ранее, ничего не пропускается. Флаг **/мир** является отличным вариантом для исходных расположений, которые по-прежнему используются и изменяются.
   :::column-end:::
:::row-end:::
:::row:::
   :::column span="1":::
      /COPY: копифлаг [s]
   :::column-end:::
   :::column span="1":::
      Точность копирования файлов (по умолчанию —/COPY: DAT). Флаги копирования: D = данные, A = атрибуты, T = метки времени, S = Security = NTFS ACL, O = сведения о владельце, U = сведения аудита.
   :::column-end:::
:::row-end:::
:::row:::
   :::column span="1":::
      /копялл
   :::column-end:::
   :::column span="1":::
      Копировать все сведения о файле (эквивалентно/COPY: ДАТСАУ).
   :::column-end:::
:::row-end:::
:::row:::
   :::column span="1":::
      /ДКОПИ: копифлаг [s]
   :::column-end:::
   :::column span="1":::
      Точность для копии каталогов (по умолчанию/ДКОПИ: DA). Флаги копирования: D = данные, A = атрибуты, T = метки времени.
   :::column-end:::
:::row-end:::

## <a name="phase-8-user-cut-over"></a>Этап 8. Вырезание пользователя

При первом запуске команды Robocopy пользователи и приложения по-прежнему получают доступ к файлам на сервере Linux Samba и потенциально изменяют их. Возможно, средство Robocopy обработало каталог и перейдет к следующему, а затем пользователь в исходном расположении (Linux) добавит, изменяет или удаляет файл, который сейчас не будет обрабатываться в текущем запуске средства Robocopy. Это ожидаемое поведение.

Первый запуск заключается в перемещении большого объема данных в экземпляр Windows Server и в облако с помощью Синхронизация файлов Azure. Эта первая копия может занять много времени, в зависимости от следующих:

* Пропускная способность загрузки.
* Пропускная способность передачи.
* Скорость локальной сети и число, по достижении которого количество потоков Robocopy соответствует этому количеству.
* Количество элементов (файлов и папок), которые необходимо обработать с помощью средства Robocopy и Синхронизация файлов Azure.

После завершения начального запуска выполните команду еще раз.

Он выполняется быстрее второго раза, поскольку ему необходимо передавать только изменения, произошедшие с момента последнего запуска. Во время этой второй операции все равно могут накапливаться.

Повторите эту процедуру, пока не будет удовлетворено, что время, необходимое для выполнения операции Robocopy в определенном расположении, находится в приемлемом окне для простоя.

Если вы считаете допустимое время простоя и готовы перевести расположение Linux в автономный режим, вы можете изменить списки управления доступом на корневом ресурсе, чтобы пользователи больше не могли получить доступ к этому расположению. Кроме того, можно выполнить любой другой шаг, позволяющий запретить изменение содержимого в этой папке на сервере Linux.

Выполнить один последний цикл Robocopy. Он выберет все изменения, которые могли быть пропущены. Срок действия этого последнего шага зависит от скорости сканирования Robocopy. Вы можете оценить время (которое равно времени простоя), измеряя длительность предыдущего запуска.

Создайте общую папку в папке Windows Server и, возможно, настройте развертывание DFS-N, чтобы она указывала на нее. Не забудьте установить те же разрешения уровня общего доступа, что и для общих ресурсов SMB сервера Samba в Linux. Если вы использовали локальных пользователей на сервере Linux Samba, необходимо повторно создать этих пользователей в качестве локальных пользователей Windows Server. Кроме того, необходимо соотнести существующие идентификаторы безопасности, которые средство Robocopy перешло на экземпляр Windows Server, с идентификаторами безопасности новых локальных пользователей Windows Server. Если вы использовали Active Directory учетные записи и списки управления доступом, средство Robocopy переместит их как есть и дальнейшие действия не требуются.

Вы завершили миграцию общей папки или группы общих ресурсов в общий корень или том (в зависимости от вашего сопоставления из фазы 1).

Можно попытаться выполнить несколько из этих копий параллельно. Рекомендуется обрабатывать по одной общей папке Azure за раз.

> [!WARNING]
> После переноса всех данных с сервера Linux Samba на экземпляр Windows Server и завершения миграции вернитесь ко *всем*  группам синхронизации в портал Azure. Измените процент свободного места для тома с распределением по уровням облака на что-то более подходящее для использования кэша, например 20 процентов. 

Политика свободного пространства в томе с распределением по уровням облака действует на уровне тома с потенциальной синхронизацией нескольких конечных точек сервера. Если вы забыли скорректировать свободное пространство даже на одной конечной точке сервера, то Sync продолжит применять наиболее ограниченное правило и попытается сохранить свободное место на диске в 99%. Локальный кэш может выполняться неверно. Производительность может быть приемлемой, если ваша цель состоит в том, чтобы иметь пространство имен для тома, содержащего только редко используемые архивные данные, и вы резервируете оставшуюся часть дискового пространства для другого сценария.

## <a name="troubleshoot"></a>Диагностика

Наиболее распространенной проблемой является то, что команда Robocopy завершается сбоем с **томом Full** на стороне Windows Server. Распределение по уровням в облаке действует один раз в час, чтобы эвакуировать содержимое с локального диска Windows Server, который синхронизирован. Его целью является доступ к свободному пространству 99% на томе.

Разрешите выполнение синхронизации и распределение по уровням облака, освободите место на диске. Это можно заметить в проводнике на Windows Server.

Если у экземпляра Windows Server достаточно свободного места, повторное выполнение команды позволит устранить проблему. При возникновении этой ситуации ничего не происходит, и вы можете легко продвигаться вперед. Неудобство выполнения команды является единственным следствием.

Чтобы устранить неполадки Синхронизация файлов Azure, просмотрите ссылку в следующем разделе.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о файловых ресурсах Azure и Синхронизация файлов Azure см. здесь. В следующих статьях содержатся дополнительные параметры, рекомендации и Справка по устранению неполадок. В этих статьях содержатся ссылки на [документацию по общей папке Azure](storage-files-introduction.md) .

* [Обзор Синхронизация файлов Azure](./storage-sync-files-planning.md)
* [Синхронизация файлов Azure рекомендации по развертыванию](./storage-how-to-create-file-share.md)
* [Устранение неполадок службы "Синхронизация файлов Azure"](storage-sync-files-troubleshoot.md)