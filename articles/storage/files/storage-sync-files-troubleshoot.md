---
title: Устранение неполадок службы "Синхронизация файлов Azure" | Документация Майкрософт
description: Устранение распространенных неполадок в развертывании на Синхронизация файлов Azure, которые можно использовать для преобразования Windows Server в быстрый кэш файлового ресурса Azure.
author: jeffpatt24
ms.service: storage
ms.topic: troubleshooting
ms.date: 1/15/2021
ms.author: jeffpatt
ms.subservice: files
ms.openlocfilehash: 49184778c7d6592f074e04df535b9bc221f3162e
ms.sourcegitcommit: aaa65bd769eb2e234e42cfb07d7d459a2cc273ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/27/2021
ms.locfileid: "98878805"
---
# <a name="troubleshoot-azure-file-sync"></a>Устранение неполадок службы "Синхронизация файлов Azure"
Используйте службу "Синхронизация файлов Azure", чтобы централизованно хранить файловые ресурсы организации в службе файлов Azure, обеспечивая гибкость, производительность и совместимость локального файлового сервера. Это достигается путем преобразования Windows Server в быстрый кэш общего файлового ресурса Azure. Для локального доступа к данным вы можете использовать любой протокол, доступный в Windows Server, в том числе SMB, NFS и FTPS. Кроме того, вы можете создать любое количество кэшей в любом регионе.

Эта статья поможет диагностировать и устранить проблемы, возникающие при развертывании службы синхронизации файлов Azure. Кроме того, здесь описано, как собирать важные журналы из системы, если требуется более глубокое исследование проблемы. Если вы не нашли ответ на свой вопрос, свяжитесь с нами, используя следующие каналы (в порядке эскалации):

1. [Страница Майкрософт с вопросами и ответами о службе хранилища Azure](/answers/products/azure?product=storage).
2. [UserVoice службы файлов Azure](https://feedback.azure.com/forums/217298-storage/category/180670-files).
3. Служба поддержки Майкрософт. Чтобы создать запрос на поддержку на портале Azure, на вкладке **Справка** нажмите кнопку **Справка и поддержка**, а затем выберите **Новый запрос на поддержку**.

## <a name="im-having-an-issue-with-azure-file-sync-on-my-server-sync-cloud-tiering-etc-should-i-remove-and-recreate-my-server-endpoint"></a>У меня возникла проблема со службой "Синхронизация файлов Azure" на сервере (синхронизация, распределение по уровням облака и т. д). Следует ли удалить конечную точку сервера и создать ее заново?
[!INCLUDE [storage-sync-files-remove-server-endpoint](../../../includes/storage-sync-files-remove-server-endpoint.md)]

## <a name="agent-installation-and-server-registration"></a>Установка агента и регистрация сервера
<a id="agent-installation-failures"></a>**Устранение сбоев при установке агента**  
Если при установке агента службы синхронизации файлов Azure происходит сбой, то в командной строке с повышенными привилегиями выполните следующую команду, чтобы включить ведение журнала во время установки агента:

```
StorageSyncAgent.msi /l*v AFSInstaller.log
```

Просмотрите файл installer.log, чтобы определить причину сбоя установки.

<a id="agent-installation-on-DC"></a>**Сбой установки агента на контроллере домена Active Directory**  
Если попытаться установить агент синхронизации на контроллере домена AD DS, где владелец роли PDC использует ОС Windows Server 2008 R2 или предыдущих версий, можно столкнуться с проблемой, когда будет возникать сбой установки агента синхронизации.

Чтобы устранить проблему, передайте роль PDC другому контроллеру домена, работающему под управлением Windows Server 2012 R2 или более поздней версии, а затем установите агент синхронизации.

<a id="parameter-is-incorrect"></a>**Сбой доступа к тому в Windows Server 2012 R2 с ошибкой: неверный параметр**  
После создания конечной точки сервера в Windows Server 2012 R2 возникает следующая ошибка при доступе к тому:

"Нет доступа к диску буква_диска:\.  
Неправильный параметр".

Чтобы устранить эту проблему, установите [KB2919355](https://support.microsoft.com/help/2919355/windows-rt-8-1-windows-8-1-windows-server-2012-r2-update-april-2014) и перезапустите сервер. Если это обновление не будет установлено из-за того, что позже уже установлена более поздняя версия, перейдите на Центр обновления Windows, установите последние обновления для Windows Server 2012 R2 и перезапустите сервер.

<a id="server-registration-missing-subscriptions"></a>**При регистрации сервера не отображается перечень подписок Azure**  
При регистрации сервера с помощью ServerRegistration.exe в раскрывающемся списке "Подписка Azure" пусто.

Эта проблема возникает из-за того, что ServerRegistration.exe будет получать подписки только из первых пяти клиентов Azure AD. 

Чтобы увеличить предельное число клиентов для регистрации серверов на сервере, создайте значение DWORD с именем Серверрегистратионтенантлимит в разделе HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Azure\StorageSync со значением больше 5.

Вы также можете решить эту проблему, используя следующие команды PowerShell для регистрации сервера:

```powershell
Import-Module "C:\Program Files\Azure\StorageSyncAgent\StorageSync.Management.PowerShell.Cmdlets.dll"
Login-AzureRmStorageSync -SubscriptionID "<guid>" -TenantID "<guid>"
Register-AzureRmStorageSyncServer -SubscriptionId "<guid>" -ResourceGroupName "<string>" -StorageSyncServiceName "<string>"
```

<a id="server-registration-prerequisites"></a>**При регистрации сервера отображается следующее сообщение: "Pre-requisites are missing" (Отсутствуют требуемые компоненты)**  
Это сообщение появляется, если модуль PowerShell Az или AzureRM не установлен в PowerShell 5.1. 

> [!Note]  
> ServerRegistration.exe не поддерживает PowerShell 6.x. Для регистрации сервера можно использовать командлет Register-AzStorageSyncServer в PowerShell 6.x.

Чтобы установить модуль Az или AzureRM в PowerShell 5.1, выполните следующие действия.

1. Откройте командную строку с повышенными привилегиями, введите **powershell** и нажмите клавишу ВВОД.
2. Установите последний модуль Az или AzureRM согласно документации.
    - [Модуль Az (требуется .NET 4.7.2)](/powershell/azure/install-az-ps?viewFallbackFrom=azps-1.1.0)
    - [Модуль AzureRM]( https://go.microsoft.com/fwlink/?linkid=856959)
3. Запустите ServerRegistration.exe и завершите работу мастера, чтобы зарегистрировать сервер в службе синхронизации хранилища.

<a id="server-already-registered"></a>**При регистрации сервера отображается следующее сообщение: "This server is already registered" (Сервер уже зарегистрирован)** 

![Снимок экрана диалогового окна регистрации сервера с сообщением об ошибке Server is already registered (Сервер уже зарегистрирован)](media/storage-sync-files-troubleshoot/server-registration-1.png)

Это сообщение появляется, если сервер был зарегистрирован в службе синхронизации хранилища ранее. Для отмены регистрации сервера в текущей службе синхронизации хранилища и регистрации в новой службе синхронизации хранилища выполните действия, описанные в разделе [Отмена регистрации сервера в службе синхронизации хранилища](storage-sync-files-server-registration.md#unregister-the-server-with-storage-sync-service).

Если сервер не указан в списке **Зарегистрированные серверы** в службе синхронизации хранилища, выполните следующие команды PowerShell на сервере, регистрацию которого вы хотите отменить.

```powershell
Import-Module "C:\Program Files\Azure\StorageSyncAgent\StorageSync.Management.ServerCmdlets.dll"
Reset-StorageSyncServer
```

> [!Note]  
> Чтобы также удалить регистрацию кластера, если сервер является частью кластера, можно использовать необязательный параметр *Reset-StorageSyncServer-CleanClusterRegistration*.

<a id="web-site-not-trusted"></a>**Во время регистрации сервера приходят многочисленные ответы, указывающее, что веб-сайт является ненадежным. Почему?**  
Эта ошибка возникает, если во время регистрации сервера включена политика **усиленной безопасности Internet Explorer**. Дополнительные сведения о том, как правильно отключить политику **усиленной безопасности Internet Explorer**, см. в разделе [Подготовка сервера Windows к работе со службой синхронизации файлов Azure](storage-sync-files-deployment-guide.md#prepare-windows-server-to-use-with-azure-file-sync) в статье [Развертывание службы синхронизации файлов Azure (предварительная версия)](storage-sync-files-deployment-guide.md).

<a id="server-registration-missing"></a>**Сервер не указан в списке зарегистрированных серверов на портале Azure**  
Если сервер не указан в списке **Зарегистрированные серверы** в службе синхронизации хранилища, сделайте следующее.
1. Войдите на сервер, который необходимо зарегистрировать.
2. Откройте проводник и перейдите в каталог установки агента синхронизации хранилища (расположение по умолчанию — C:\Program Files\Azure\StorageSyncAgent). 
3. Запустите ServerRegistration.exe и завершите работу мастера, чтобы зарегистрировать сервер в службе синхронизации хранилища.

## <a name="sync-group-management"></a>Управление группами синхронизации

### <a name="cloud-endpoint-creation-errors"></a>Ошибки создания облачной конечной точки

<a id="cloud-endpoint-using-share"></a>**Создание облачной конечной точки завершается сбоем с такой ошибкой: "The specified Azure FileShare is already in use by a different CloudEndpoint" (Указанный общий файловый ресурс Azure уже используется другой облачной конечной точкой)**  
Эта ошибка возникает, если общий файловый ресурс Azure уже используется другой облачной конечной точкой. 

Если вы видите это сообщение, а общий файловый ресурс Azure сейчас не используется облачной конечной точкой, выполните следующие действия, чтобы очистить метаданные службы синхронизации файлов Azure для общего файлового ресурса Azure:

> [!Warning]  
> Если вы удалите метаданные для общего файлового ресурса Azure, который в это время используется облачной конечной точкой, это приведет к сбою операций синхронизации в службе синхронизации файлов Azure. 

1. На портале Azure перейдите к общему файловому ресурсу Azure.  
2. Щелкните общий файловый ресурс Azure правой кнопкой мыши и выберите **Изменить метаданные**.
3. Щелкните **SyncService** правой кнопкой мыши и выберите **Удалить**.

<a id="cloud-endpoint-authfailed"></a>**Создание облачной конечной точки завершается сбоем с такой ошибкой: "AuthorizationFailed"**  
Эта ошибка возникает, если учетная запись пользователя не имеет нужных прав для создания облачной конечной точки. 

Чтобы создать облачную конечную точку, учетная запись пользователя должна иметь следующие разрешения авторизации Майкрософт:  
* Чтение. получение определения роли.
* Запись: Создание или изменение определения пользовательской роли
* Чтение. Получение назначения роли
* Запись: Создание назначения роли

Следующие встроенные роли имеют необходимые разрешения авторизации Майкрософт:  
* Владелец
* Администратор доступа пользователей

Чтобы определить, имеет ли ваша роль пользователя учетной записи необходимые разрешения:  
1. На портале Azure выберите **Группы ресурсов**.
2. Выберите группу ресурсов, в которой расположена учетная запись хранения, а затем выберите **Управление доступом (IAM)** .
3. Выберите вкладку **Назначения ролей**.
4. Выберите **роль** (например, владелец или участник) для учетной записи пользователя.
5. В списке **Поставщик ресурсов** выберите **Авторизация Майкрософт**. 
    * **Назначение ролей** должно иметь разрешения на **чтение** и **запись**.
    * **Определение роли** должно иметь разрешения на **чтение** и **запись**.

### <a name="server-endpoint-creation-and-deletion-errors"></a>Ошибки создания и удаления конечной точки сервера

<a id="-2134375898"></a>**Создание конечной точки сервера завершается сбоем с такой ошибкой: "MgmtServerJobFailed" (код ошибки: -2134375898 или 0x80c80226)**  
Эта ошибка возникает, если путь к конечной точке сервера расположен в системном томе и включено распределение по уровням облака. Но для системного тома не поддерживается распределение по уровням облака. Чтобы создать конечную точку сервера на системном томе, отключите распределение по уровням облака при ее создании.

<a id="-2147024894"></a>**Создание конечной точки сервера завершается сбоем с такой ошибкой: "MgmtServerJobFailed" (код ошибки: -2147024894 или 0x80070002)**  
Эта ошибка возникает, если указан недопустимый путь к конечной точке сервера. Убедитесь, что указанный путь к конечной точке сервера ведет к локально подключенному тому NTFS. Обратите внимание, Синхронизация файлов Azure не поддерживает пути к подключенным дискам в качестве путей к конечной точке сервера.

<a id="-2134375640"></a>**Создание конечной точки сервера завершается сбоем с такой ошибкой: "MgmtServerJobFailed" (код ошибки: -2134375640 или 0x80c80328)**  
Эта ошибка возникает, если указанный путь к конечной точке сервера не ведет к тому NTFS. Убедитесь, что указанный путь к конечной точке сервера ведет к локально подключенному тому NTFS. Обратите внимание, Синхронизация файлов Azure не поддерживает пути к подключенным дискам в качестве путей к конечной точке сервера.

<a id="-2134347507"></a>**Создание конечной точки сервера завершается сбоем с такой ошибкой: "MgmtServerJobFailed" (код ошибки: -2134347507 или 0x80c8710d)**  
Эта ошибка возникает из-за того, что Синхронизация файлов Azure не поддерживает конечные точки сервера для томов со сжатой папкой System Volume Information. Чтобы устранить эту проблему, распакуйте папку System Volume Information. Если папка System Volume Information является единственной сжатой папкой на этом томе, выполните следующие действия.

1. Скачайте средство [PsExec](/sysinternals/downloads/psexec).
2. Выполните следующую команду в командной строке с повышенными привилегиями, чтобы открыть командную строку, выполняемую под системной учетной записью: **PsExec.exe -i -s -d cmd**.
3. В командной строке, выполняемой под системной учетной записью, введите следующие команды и нажмите клавишу ВВОД:   
    **cd /d "буква диска:\System Volume Information"**  
    **compact /u /s**

<a id="-2134376345"></a>**Создание конечной точки сервера завершается сбоем с такой ошибкой: "MgmtServerJobFailed" (код ошибки: -2134376345 или 0x80C80067)**  
Эта ошибка возникает, если достигнуто максимальное число конечных точек на сервер. Сейчас служба "Синхронизация файлов Azure" поддерживает до 30 конечных точек на сервер. Дополнительные сведения см. в разделе [Целевые показатели масштабируемости службы синхронизации файлов Azure](./storage-files-scale-targets.md#azure-file-sync-scale-targets).

<a id="-2134376427"></a>**Создание конечной точки сервера завершается сбоем с такой ошибкой: "MgmtServerJobFailed" (код ошибки: -2134376427 или 0x80c80015)**  
Эта ошибка возникает, если с другой конечной точки сервера уже выполняется синхронизация по указанному пути к конечной точке сервера. Служба "Синхронизации файлов Azure" не поддерживает синхронизацию одного и того же каталога или тома с нескольких конечных точек сервера.

<a id="-2160590967"></a>**Создание конечной точки сервера завершается сбоем с такой ошибкой: "MgmtServerJobFailed" (код ошибки: -2160590967 или 0x80c80077)**  
Эта ошибка возникает, если путь к конечной точке сервера ведет к потерянным распределенным по уровням файлам. Если конечная точка сервера недавно удалена, дождитесь завершения очистки потерянных распределенных по уровням файлов. Событие с идентификатором 6662 регистрируется в журнале событий телеметрии после запуска очистки потерянных многоуровневых файлов. Событие с идентификатором 6661 регистрируется после завершения очистки потерянных распределенных по уровням файлов, и можно создать новую конечную точку сервера с помощью пути. Если после завершения очистки потерянных файлов, распределенных по уровням, происходит сбой при создании конечной точки сервера или не удается найти событие с идентификатором 6661 в журнале событий телеметрии из-за смены журнала событий, удалите потерянные многоуровневые файлы, выполнив действия, описанные в разделе [Многоуровневые файлы недоступны на сервере после удаления конечной точки сервера](?tabs=portal1%252cazure-portal#tiered-files-are-not-accessible-on-the-server-after-deleting-a-server-endpoint).

<a id="-2134347757"></a>**Удаление конечной точки сервера завершается сбоем с такой ошибкой: "MgmtServerJobExpired" (код ошибки: -2134347757 или 0x80c87013)**  
Эта ошибка возникает, если сервер находится вне сети или отсутствует подключение к сети. Если сервер больше не доступен, отмените его регистрацию на портале, что приведет к удалению конечных точек сервера. Чтобы удалить конечные точки сервера, выполните шаги, описанные в разделе [Отмена регистрации сервера в службе синхронизации хранилища](storage-sync-files-server-registration.md#unregister-the-server-with-storage-sync-service).

### <a name="server-endpoint-health"></a>Работоспособность конечной точки сервера

<a id="server-endpoint-provisioningfailed"></a>**Не удается открыть страницу свойств конечной точки сервера или обновить политику распределения по уровням облака**  
Эта проблема может возникнуть в случае сбоя операции управления на конечной точке сервера. Если страница свойств конечной точки сервера не открывается на портале Azure, попробуйте обновить конечную точку сервера, выполнив команды PowerShell с сервера, чтобы устранить эту проблему. 

```powershell
# Get the server endpoint id based on the server endpoint DisplayName property
Get-AzStorageSyncServerEndpoint `
    -ResourceGroupName myrgname `
    -StorageSyncServiceName storagesvcname `
    -SyncGroupName mysyncgroup | `
Tee-Object -Variable serverEndpoint

# Update the free space percent policy for the server endpoint
Set-AzStorageSyncServerEndpoint `
    -InputObject $serverEndpoint
    -CloudTiering `
    -VolumeFreeSpacePercent 60
```
<a id="server-endpoint-noactivity"></a>**Конечная точка сервера находится в состоянии работоспособности "Нет действия" или "Ожидание", а в колонке "Зарегистрированные серверы" для сервера показано состояние "Отображается как «Не в сети»"**  

Эта проблема может возникнуть, если процесс отслеживания синхронизации хранилища (AzureStorageSyncMonitor.exe) не запущен или сервер не может получить доступ к службе синхронизации файлов Azure.

Для сервера, который отображается на портале как "Не в сети", просмотрите событие с идентификатором 9301 в журнале событий телеметрии (в разделе Приложения и службы\Майкрософт\Синхронизация файлов\Агент в средстве просмотра событий), чтобы выяснить, почему серверу не удается получить доступ к службе синхронизации файлов Azure. 

- Если в журнале присутствует запись **GetNextJob завершено с состоянием: 0**, сервер может взаимодействовать со службой синхронизации файлов Azure. 
    - Откройте диспетчер задач на сервере и убедитесь, что процесс отслеживания синхронизации хранилища (AzureStorageSyncMonitor.exe) запущен. Если процесс не запущен, попробуйте сначала перезапустить сервер. Если перезапуск сервера не решил эту проблему, обновите до последней [версии агента](./storage-files-release-notes.md) службы "Синхронизация файлов Azure". 

- Если **жетнекстжоб завершено с состоянием:-2134347756** , то сервер не может взаимодействовать со службой Синхронизация файлов Azure из-за конфигурации заказа набора шифров брандмауэра, прокси или TLS. 
    - Если сервер находится за брандмауэром, убедитесь, что порт 443 для исходящих подключений разрешен. Если брандмауэр ограничивает трафик определенными доменами, подтвердите, что домены, перечисленные в [документации](./storage-sync-files-firewall-and-proxy.md#firewall) брандмауэра, доступны.
    - Если сервер находится за прокси-сервером, настройте параметры прокси-сервера для компьютера или конкретного приложения, выполнив действия, описанные в [документации](./storage-sync-files-firewall-and-proxy.md#proxy) прокси-сервера.
    - Используйте командлет Test-StorageSyncNetworkConnectivity, чтобы проверить сетевое подключение к конечным точкам службы. Дополнительные сведения см. в разделе [Проверка сетевого подключения к конечным точкам службы](./storage-sync-files-firewall-and-proxy.md#test-network-connectivity-to-service-endpoints).
    - Если порядок комплекта шифров TLS настроен на сервере, для добавления комплектов шифров можно использовать групповые политики или командлеты TLS:
        - Сведения об использовании групповой политики см. в разделе [Настройка порядка комплектов шифров TLS с помощью групповая политика](/windows-server/security/tls/manage-tls#configuring-tls-cipher-suite-order-by-using-group-policy).
        - Инструкции по использованию командлетов TLS см. в разделе [Настройка порядка комплектов шифров TLS с помощью командлетов TLS PowerShell](/windows-server/security/tls/manage-tls#configuring-tls-cipher-suite-order-by-using-tls-powershell-cmdlets).
    
        В настоящее время Синхронизация файлов Azure поддерживает следующие комплекты шифров для протокола TLS 1,2:  
        - TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384_P384  
        - TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256_P256  
        - TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA384_P384  
        - TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256_P256  
        - TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384_P256  
        - TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256_P256  
        - TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA_P256  
        - TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA_P256  
        - TLS_RSA_WITH_AES_256_GCM_SHA384  
        - TLS_RSA_WITH_AES_128_GCM_SHA256  
        - TLS_RSA_WITH_AES_256_CBC_SHA256  
        - TLS_RSA_WITH_AES_128_CBC_SHA256  

- Если в журнале появляется запись **GetNextJob завершено с состоянием:-2134347764**, сервер не может взаимодействовать со службой "Синхронизация файлов Azure" из-за того, что срок действия сертификата истек или сертификат был удален.  
    - Выполните следующую команду PowerShell на сервере, чтобы сбросить сертификат, используемый для проверки подлинности:
    ```powershell
    Reset-AzStorageSyncServerCertificate -ResourceGroupName <string> -StorageSyncServiceName <string>
    ```
<a id="endpoint-noactivity-sync"></a>**Конечная точка сервера находится в состоянии работоспособности "Нет действия", а в колонке "Зарегистрированные серверы" для сервера показано состояние "В сети"**  

Состояние работоспособности конечной точки сервера "Нет действия" означает, что конечная точка сервера не выполнила действие синхронизации за последние два часа.

Чтобы проверить текущее действие синхронизации на сервере, ознакомьтесь с разделом [Как отслеживать ход выполнения текущего сеанса синхронизации?](#how-do-i-monitor-the-progress-of-a-current-sync-session).

Конечная точка сервера может не регистрировать записи в журнале действий синхронизации в течение нескольких часов из-за ошибки или недостатка системных ресурсов. Убедитесь, что у вас установлена последняя [версия агента](./storage-files-release-notes.md) синхронизации файлов Azure. Если проблема не исчезла, откройте запрос на поддержку.

> [!Note]  
> Если в колонке "Зарегистрированные серверы" для сервера показано состояние "Отображается как «Не в сети»", выполните шаги, описанные в разделе [Конечная точка сервера находится в состоянии работоспособности "Нет действия" или "Ожидание", а в колонке "Зарегистрированные серверы" для сервера показано состояние "Отображается как «Не в сети»"](#server-endpoint-noactivity).

## <a name="sync"></a>Sync
<a id="afs-change-detection"></a>**Если файл создан непосредственно в файловом ресурсе Azure через SMB или портал, сколько времени требуется для синхронизации файла с серверами в группе синхронизации?**  
[!INCLUDE [storage-sync-files-change-detection](../../../includes/storage-sync-files-change-detection.md)]

<a id="serverendpoint-pending"></a>**Работоспособность конечной точки сервера находится в состоянии ожидания в течение нескольких часов**  
Эта ошибка возникает, если при создании облачной конечной точки вы указали общий файловый ресурс Azure, содержащий некоторые данные. Задание перечисления изменений, которое проверяет на наличие изменений в общем файловом ресурсе Azure, должно завершиться до синхронизации файлов между конечными точками облака и сервера. Время завершения задания зависит от размера пространства имен в общем файловом ресурсе Azure. После завершения задания перечисления изменений работоспособность конечной точки сервера должна обновиться.

### <a name="how-do-i-monitor-sync-health"></a><a id="broken-sync"></a>Как выполнить мониторинг работоспособности синхронизации?
# <a name="portal"></a>[Портал](#tab/portal1)
Внутри каждой группы синхронизации можно детализировать ее отдельные конечные точки сервера, чтобы просмотреть состояние последних завершенных сеансов синхронизации. Зеленый столбец работоспособности и значение 0 для параметра "Несинхронизирующиеся файлы" означает, что синхронизация работает должным образом. Если же это не так, ознакомьтесь с приведенным ниже списком распространенных ошибок синхронизации, а также со сведениями о том, как обработать файлы, которые не синхронизируются. 

![Снимок экрана портала Azure](media/storage-sync-files-troubleshoot/portal-sync-health.png)

# <a name="server"></a>[Server](#tab/server)
Перейдите в журналы телеметрии сервера, которые можно найти в средстве "Просмотр событий": `Applications and Services Logs\Microsoft\FileSync\Agent\Telemetry`. Событие 9102 соответствует завершенному сеансу синхронизации. Для получения последнего состояния синхронизации найдите последнее событие с идентификатором 9102. SyncDirection сообщит вам предназначение этого сеанса: передача или загрузка. Если результат HResult равен 0, сеанс синхронизации завершился успешно. Другой результат HResult означает, что во время синхронизации произошла ошибка. Ознакомьтесь со списком распространенных ошибок ниже. Если значение PerItemErrorCount больше 0, это означает, что некоторые файлы или папки не синхронизировались должным образом. Результат HResult может быть равен 0, а результат PerItemErrorCount при этом — больше 0.

Ниже приведен пример успешной отправки. Для краткости ниже перечислены только некоторые из значений, содержащиеся в каждом событии 9102. 

```
Replica Sync session completed.
SyncDirection: Upload,
HResult: 0, 
SyncFileCount: 2, SyncDirectoryCount: 0,
AppliedFileCount: 2, AppliedDirCount: 0, AppliedTombstoneCount 0, AppliedSizeBytes: 0.
PerItemErrorCount: 0,
TransferredFiles: 2, TransferredBytes: 0, FailedToTransferFiles: 0, FailedToTransferBytes: 0.
```

И наоборот, отправка, завершившаяся сбоем, может выглядеть примерно так:

```
Replica Sync session completed.
SyncDirection: Upload,
HResult: -2134364065,
SyncFileCount: 0, SyncDirectoryCount: 0, 
AppliedFileCount: 0, AppliedDirCount: 0, AppliedTombstoneCount 0, AppliedSizeBytes: 0.
PerItemErrorCount: 0, 
TransferredFiles: 0, TransferredBytes: 0, FailedToTransferFiles: 0, FailedToTransferBytes: 0.
```

Иногда сеансы синхронизации не выполняются в целом или содержат другое значение PerItemErrorCount, отличное от нуля, но тем не менее наблюдается прогресс и некоторые файлы успешно синхронизируются. Это можно увидеть в полях Applied* (AppliedFileCount, AppliedDirCount, AppliedTombstoneCount и AppliedSizeBytes) — в них содержатся сведения о том, насколько успешно продвигается сеанс синхронизации. Если несколько сеансов синхронизации подряд завершаются сбоем, а числа в полях Applied* увеличиваются, тогда нужно подождать повторной синхронизации, а не отправлять сразу же запрос в службу поддержки.

---

### <a name="how-do-i-monitor-the-progress-of-a-current-sync-session"></a>Как отслеживать ход выполнения текущего сеанса синхронизации?
# <a name="portal"></a>[Портал](#tab/portal1)
В своей группе синхронизации перейдите в соответствующую конечную точку сервера и просмотрите раздел "Действие синхронизации" — вы увидите количество отправленных или загруженных файлов в текущем сеансе синхронизации. Обратите внимание, что это состояние будет отложено примерно на 5 минут, и если ваш сеанс синхронизации можно завершить в течение этого периода, об этом может не быть уведомлений на портале. 

# <a name="server"></a>[Server](#tab/server)
Просмотрите последнее событие 9302 в журнале телеметрии на сервере (в средстве "Просмотр событий" перейдите в папку Applications and Services Logs\Microsoft\FileSync\Agent\Telemetry). Это событие указывает состояние текущего сеанса синхронизации. TotalItemCount обозначает количество файлов, которые нужно синхронизировать, AppliedItemCount — количество файлов, которые были синхронизированы к настоящему времени, а PerItemErrorCount — количество файлов, синхронизация которых завершилась сбоем (сведения о том, как исправить эту проблему, см. ниже).

```
Replica Sync Progress. 
ServerEndpointName: <CI>sename</CI>, SyncGroupName: <CI>sgname</CI>, ReplicaName: <CI>rname</CI>, 
SyncDirection: Upload, CorrelationId: {AB4BA07D-5B5C-461D-AAE6-4ED724762B65}. 
AppliedItemCount: 172473, TotalItemCount: 624196. AppliedBytes: 51473711577, 
TotalBytes: 293363829906. 
AreTotalCountsFinal: true. 
PerItemErrorCount: 1006.
```
---

### <a name="how-do-i-know-if-my-servers-are-in-sync-with-each-other"></a>Как узнать, синхронизируются ли серверы между собой?
# <a name="portal"></a>[Портал](#tab/portal1)
Для каждого сервера в данной группе синхронизации проверьте следующее:
- Метки времени последней попытки синхронизации для отправки и загрузки не устарели.
- Состояние отправки и загрузки имеет зеленый цвет.
- В поле "Действие синхронизации" нет файлов для синхронизации или их очень мало.
- В поле "Несинхронизирующиеся файлы" для отправки и загрузки стоит значение 0.

# <a name="server"></a>[Server](#tab/server)
Просмотрите завершенные сеансы синхронизации, которые отмечены событиями 9102 в журнале событий телеметрии для каждого сервера (в средстве "Просмотр событий" перейдите в `Applications and Services Logs\Microsoft\FileSync\Agent\Telemetry`). 

1. Вы можете проверить успешное завершение последних сеансов отправки и загрузки на заданном сервере. Для этого проверьте, чтобы для параметров HResult и PerItemErrorCount для отправки и загрузки стояло значение 0 (поле SyncDirection указывает тип заданного сеанса: отправка или загрузка). Обратите внимание, что если вы не видите недавно завершенного сеанса синхронизации, скорее всего, он выполняется в настоящий момент, чего с большой вероятностью можно ожидать, если вы только что добавили или изменили большой объем данных.
2. Когда сервер полностью синхронизирован с облаком и отсутствуют какие-либо изменения в синхронизации в любом направлении, вы увидите пустые сеансы синхронизации. Эти сеансы обозначаются событиями отправки и загрузки, в которых все поля Sync* (SyncFileCount, SyncDirCount, SyncTombstoneCount и SyncSizeBytes) равны нулю, а это означает, что объекты синхронизации отсутствовали. Обратите внимание, что эти пустые сеансы синхронизации могут отсутствовать на серверах с высокой активностью обработки данных, так как операция синхронизации всегда актуальна. Если действия синхронизации нет, пустые сеансы должны появляться каждые 30 минут. 
3. Если все серверы синхронизированы с облаком, то есть их недавние сеансы отправки и загрузки являются пустыми сеансами синхронизации, вы можете быть уверены в том, что система в целом синхронизирована. 
    
Обратите внимание, что если вы внесли изменения непосредственно в общем файловом ресурсе Azure, служба "Синхронизация файлов Azure" не обнаружит эти изменения до запуска задания перечисления изменений, которое инициируется каждые 24 часа. Можно получить уведомление сервера о состоянии синхронизации с облаком, когда фактически на нем нет последних изменений, внесенных непосредственно в общем файловом ресурсе Azure. 

---

### <a name="how-do-i-see-if-there-are-specific-files-or-folders-that-are-not-syncing"></a>Каким образом мне будет понятно, что есть определенные файлы и папки, которые не синхронизируются?
Если значение PerItemErrorCount на сервере или значение параметра "Несинхронизирующиеся файлы" на портале больше 0 для любого заданного сеанса синхронизации, это означает, что некоторые элементы синхронизировать не удалось. Файлы и папки могут иметь характеристики, препятствующие синхронизации. Эти характеристики могут быть постоянными и требуют явного действия для возобновления синхронизации, например удаления неподдерживаемых знаков из имени файла или папки. Также эти характеристики могут быть временными, то есть синхронизация файла или папки возобновляется автоматически. Например, файлы с открытыми дескрипторами автоматически возобновят синхронизацию при закрытии файла. Когда механизм службы "Синхронизация файлов Azure" обнаруживает такую проблему, создается журнал ошибок, который можно проанализировать, чтобы перечислить элементы, которые в настоящее время не синхронизируются должным образом.

Чтобы увидеть эти ошибки, запустите сценарий PowerShell **FileSyncErrorsReport.ps1** (расположенный в каталоге установки агента службы "Синхронизация файлов Azure"), чтобы определить файлы, которые не удалось синхронизировать из-за открытых дескрипторов, неподдерживаемых знаков или других проблем. Поле ItemPath указывает расположение файла относительно корневого каталога синхронизации. Ознакомьтесь со списком распространенных ошибок синхронизации ниже, чтобы применить действия по устранению.

> [!Note]  
> Если сценарий FileSyncErrorsReport.ps1 возвращает сообщение "Ошибки в файлах не найдены" или не указывает ошибки для каждого элемента группы синхронизации, причина может заключаться в следующем:
>
>- Причина 1. Последний завершенный сеанс синхронизации не содержал ошибок каких-либо элементов. Информация на портале вскоре будет обновлена, и отобразится сообщение "0 несинхронизирующихся файлов". 
>    - Проверьте [событие с идентификатором 9102](?tabs=server%252cazure-portal#broken-sync) в журнале событий телеметрии, чтобы убедиться, что параметр PerItemErrorCount имеет значение 0. 
>
>- Причина 2. Журнал событий ItemResults на сервере был начат сначала из-за слишком большого количества ошибок для каждого элемента, и поэтому в журнале событий больше нет ошибок для этой группы синхронизации.
>    - Чтобы предотвратить появление этой проблемы, увеличьте размер журнала событий ItemResults. Журнал событий телеметрии хранится в папке "Журналы приложений и служб\Майкрософт\Синхронизация файлов\Агент" в средстве "Просмотр событий". 

#### <a name="troubleshooting-per-filedirectory-sync-errors"></a>Устранение ошибок синхронизации в каталоге или файле
**Журнал ItemResults — ошибки синхронизации по каждому элементу**  

| HRESULT | HRESULT (десятичное число) | Строка ошибки | Проблема | Исправление |
|---------|-------------------|--------------|-------|-------------|
| 0x80070043 | -2147942467 | ERROR_BAD_NET_NAME | Многоуровневый файл на сервере недоступен. Такая ошибка возникает, если многоуровневый файл не был отозван перед удалением конечной точки сервера. | Чтобы решить эту проблему, см. раздел [Многоуровневые файлы недоступны на сервере после удаления конечной точки сервера](?tabs=portal1%252cazure-portal#tiered-files-are-not-accessible-on-the-server-after-deleting-a-server-endpoint). |
| 0x80c80207 | -2134375929 | ECS_E_SYNC_CONSTRAINT_CONFLICT | На этом этапе невозможно синхронизировать изменение файла или каталога, потому что зависимая папка еще не синхронизирована. Этот элемент будет синхронизирован после синхронизации зависимых изменений. | Действия не требуются. Если ошибка повторяется в течение нескольких дней, используйте сценарий PowerShell FileSyncErrorsReport.ps1, чтобы определить причину, по которой зависимая папка не синхронизируется. |
| 0x80C8028A | — 2134375798 | ECS_E_SYNC_CONSTRAINT_CONFLICT_ON_FAILED_DEPENDEE | На этом этапе невозможно синхронизировать изменение файла или каталога, потому что зависимая папка еще не синхронизирована. Этот элемент будет синхронизирован после синхронизации зависимых изменений. | Действия не требуются. Если ошибка повторяется в течение нескольких дней, используйте сценарий PowerShell FileSyncErrorsReport.ps1, чтобы определить причину, по которой зависимая папка не синхронизируется. |
| 0x80c80284 | -2134375804 | ECS_E_SYNC_CONSTRAINT_CONFLICT_SESSION_FAILED | Невозможно синхронизировать изменение файла или каталога, потому что зависимая папка еще не синхронизирована, а сеанс синхронизации завершился с ошибкой. Этот элемент будет синхронизирован после синхронизации зависимых изменений. | Действия не требуются. Если ошибка повторяется, выясните причину сбоя сеанса синхронизации. |
| 0x8007007b | -2147024773 | ERROR_INVALID_NAME | Недопустимое имя файла или каталога. | Переименуйте соответствующий файл или каталог. Дополнительные сведения см. в разделе [Обработка неподдерживаемых знаков](?tabs=portal1%252cazure-portal#handling-unsupported-characters). |
| 0x80c80255 | -2134375851 | ECS_E_XSMB_REST_INCOMPATIBILITY | Недопустимое имя файла или каталога. | Переименуйте соответствующий файл или каталог. Дополнительные сведения см. в разделе [Обработка неподдерживаемых знаков](?tabs=portal1%252cazure-portal#handling-unsupported-characters). |
| 0x80c80018 | -2134376424 | ECS_E_SYNC_FILE_IN_USE | Невозможно синхронизировать файл, так как он используется. По завершении использования файла он будет синхронизирован. | Действия не требуются. Служба "Синхронизация файлов Azure" раз в день создает на сервере временный моментальный снимок VSS для синхронизации файлов с открытыми дескрипторами. |
| 0x80c8031d | -2134375651 | ECS_E_CONCURRENCY_CHECK_FAILED | Файл был изменен, но механизм синхронизации еще не обнаружил это изменение. Синхронизация восстановится после обнаружения изменения. | Действия не требуются. |
| 0x80070002 | -2147024894 | ERROR_FILE_NOT_FOUND | Файл был удален, но службе синхронизации неизвестно об этом изменении. | Действия не требуются. Служба синхронизации перестанет регистрировать эту ошибку, когда при обнаружении изменений станет известно, что файл был удален. |
| 0x80070003 | -2147942403 | ERROR_PATH_NOT_FOUND | Невозможно синхронизировать удаление файла или каталога, потому что элемент уже удален в месте назначения, а у службы синхронизации еще нет информации об этом изменении. | Действия не требуются. Синхронизация прекратит регистрировать эту ошибку в журнале, когда в месте назначения будет запущено обнаружение изменений и синхронизация учтет, что этот элемент был удален. |
| 0x80c80205 | -2134375931 | ECS_E_SYNC_ITEM_SKIP | Файл или каталог был пропущен, но будет синхронизирован во время следующего сеанса синхронизации. Если при скачивании элемента появляется сообщение об ошибке, скорее всего, имя файла или каталога является недопустимым. | Никаких действий не требуется, если сообщение об ошибке появляется при отправке файла. Если сообщение об ошибке появляется при скачивании файла, переименуйте файл или каталог. Дополнительные сведения см. в разделе [Обработка неподдерживаемых знаков](?tabs=portal1%252cazure-portal#handling-unsupported-characters). |
| 0x800700B7 | -2147024713 | ERROR_ALREADY_EXISTS | Невозможно синхронизировать создание файла или каталога, потому что элемент уже существует в месте назначения, а у службы синхронизации еще нет информации об этом изменении. | Действия не требуются. Синхронизация прекратит регистрировать эту ошибку в журнале, когда в месте назначения будет запущено обнаружение изменений и синхронизация учтет этот новый элемент. |
| 0x80c8603e | -2134351810 | ECS_E_AZURE_STORAGE_SHARE_SIZE_LIMIT_REACHED | Невозможно синхронизировать файл, так как достигнут предел общей папки Azure. | Чтобы устранить эту проблему, обратитесь к разделу [Достигнут предельный размер хранилища общего файлового ресурса Azure](?tabs=portal1%252cazure-portal#-2134351810). |
| 0x80c8027C | -2134375812 | ECS_E_ACCESS_DENIED_EFS | Файл зашифрован с использованием неподдерживаемого решения (например, NTFS EFS). | Расшифруйте файл и воспользуйтесь поддерживаемым решением для шифрования. Список поддерживаемых решений см. в разделе [Решения для шифрования](./storage-sync-files-planning.md#encryption) руководства по планированию. |
| 0x80c80283 | -2160591491 | ECS_E_ACCESS_DENIED_DFSRRO | Файл находится в DFSR-папке репликации, доступной только для чтения. | Файл находится в DFSR-папке репликации, доступной только для чтения. Служба синхронизации файлов Azure не поддерживает конечные точки сервера на уровне папок репликации DFS-R только для чтения. Дополнительные сведения см. в разделе [Распределенная файловая система (DFS)](./storage-sync-files-planning.md#distributed-file-system-dfs). |
| 0x80070005 | -2147024891 | ERROR_ACCESS_DENIED | Файл находится в состоянии "Ожидание удаления". | Действия не требуются. Файл будет удален после закрытия всех открытых дескрипторов файла. |
| 0x80c86044 | -2134351804 | ECS_E_AZURE_AUTHORIZATION_FAILED | Не удается синхронизировать файл, так как в учетной записи хранения включены параметры брандмауэра и виртуальной сети. При этом у сервера нет доступа к учетной записи хранения. | Добавьте IP-адрес сервера или виртуальную сеть, выполнив действия, описанные в разделе [Настройка параметров брандмауэра и виртуальной сети](./storage-sync-files-deployment-guide.md?tabs=azure-portal#configure-firewall-and-virtual-network-settings) в руководстве по развертыванию. |
| 0x80c80243 | -2134375869 | ECS_E_SECURITY_DESCRIPTOR_SIZE_TOO_LARGE | Не удается синхронизировать файл, так как размер дескриптора безопасности превышает ограничение в 64 КиБ. | Чтобы устранить эту проблему, удалите элементы управления доступом (ACE) в файле, чтобы уменьшить размер дескриптора безопасности. |
| 0x8000ffff | -2147418113 | E_UNEXPECTED | Не удается синхронизировать файл из-за непредвиденной ошибки. | Если ошибка повторяется в течение нескольких дней, обратитесь в службу поддержки. |
| 0x80070020 | -2147024864 | ERROR_SHARING_VIOLATION | Невозможно синхронизировать файл, так как он используется. По завершении использования файла он будет синхронизирован. | Действия не требуются. |
| 0x80c80017 | -2134376425 | ECS_E_SYNC_OPLOCK_BROKEN | Файл изменен во время синхронизации, поэтому его необходимо синхронизировать повторно. | Действия не требуются. |
| 0x80070017 | -2147024873 | ERROR_CRC | Не удается синхронизировать файл из-за ошибки контрольной суммы. Такая ошибка может возникнуть, если многоуровневый файл не отозван перед удалением конечной точки сервера или этот файл поврежден. | Для решения проблемы выполните действия из раздела [Многоуровневые файлы недоступны на сервере после удаления конечной точки сервера](?tabs=portal1%252cazure-portal#tiered-files-are-not-accessible-on-the-server-after-deleting-a-server-endpoint), чтобы удалить потерянные файлы, распределенные по уровням. Если ошибка будет повторяться после удаления потерянных файлов, распределенных по уровням, выполните [chkdsk](/windows-server/administration/windows-commands/chkdsk) в томе. |
| 0x80c80200 | -2134375936 | ECS_E_SYNC_CONFLICT_NAME_EXISTS | Не удается синхронизировать файл, так как достигнуто максимальное число конфликтующих файлов. Синхронизация файлов Azure поддерживает 100 конфликтующих файлов для каждого файла. Дополнительные сведения о конфликтах файлов см. в разделе [часто задаваемых вопросов](./storage-files-faq.md#afs-conflict-resolution) о синхронизации файлов Azure. | Чтобы устранить эту проблему, уменьшите количество конфликтующих файлов. Файл будет синхронизирован, если число конфликтующих файлов меньше 100. |

#### <a name="handling-unsupported-characters"></a>Обработка неподдерживаемых знаков
Если **FileSyncErrorsReport.ps1** сценарий PowerShell показывает ошибки синхронизации для каждого элемента из-за неподдерживаемых символов (код ошибки 0x8007007B или 0x80c80255), следует удалить или переименовать символы из соответствующих имен файлов. PowerShell, скорее всего, выведет эти знаки как вопросительные знаки или пустые прямоугольники, так как большинство из этих знаков не имеют стандартного визуального кодирования. 
> [!Note]  
> [Средство оценки](storage-sync-files-planning.md#evaluation-cmdlet) можно использовать, чтобы идентифицировать знаки, которые не поддерживаются. Если набор данных содержит несколько файлов с недопустимыми символами, используйте сценарий [сканунсуппортедчарс](https://github.com/Azure-Samples/azure-files-samples/tree/master/ScanUnsupportedChars) для переименования файлов, которые содержат неподдерживаемые символы.

В приведенной ниже таблице содержатся все знаки Юникода, которые служба "Синхронизация файлов Azure" еще не поддерживает.

| Набор знаков | Количество знаков |
|---------------|-----------------|
| <ul><li>0x0000009D (osc: команда операционной системы)</li><li>0x00000090 (dcs: строка управления устройством)</li><li>0x0000008F (ss3: Single Shift Three)</li><li>0x00000081 (предустановленный большой набор октетов)</li><li>0x0000007F (del: удалить)</li><li>0x0000008D (ri: обратный перевод строки)</li></ul> | 6 |
| 0x0000FDD0 - 0x0000FDEF (арабские формы представления-a) | 32 |
| 0x0000FFF0 - 0x0000FFFF (специальные знаки) | 16 |
| <ul><li>0x0001FFFE - 0x0001FFFF = 2 (несимвольный)</li><li>0x0002FFFE - 0x0002FFFF = 2 (несимвольный)</li><li>0x0003FFFE - 0x0003FFFF = 2 (несимвольный)</li><li>0x0004FFFE - 0x0004FFFF = 2 (несимвольный)</li><li>0x0005FFFE - 0x0005FFFF = 2 (несимвольный)</li><li>0x0006FFFE - 0x0006FFFF = 2 (несимвольный)</li><li>0x0007FFFE - 0x0007FFFF = 2 (несимвольный)</li><li>0x0008FFFE - 0x0008FFFF = 2 (несимвольный)</li><li>0x0009FFFE - 0x0009FFFF = 2 (несимвольный)</li><li>0x000AFFFE - 0x000AFFFF = 2 (несимвольный)</li><li>0x000BFFFE - 0x000BFFFF = 2 (несимвольный)</li><li>0x000CFFFE - 0x000CFFFF = 2 (несимвольный)</li><li>0x000DFFFE - 0x000DFFFF = 2 (несимвольный)</li><li>0x000EFFFE - 0x000EFFFF = 2 (неопределенный)</li><li>0x000FFFFE - 0x000FFFFF = 2 (дополнительная область частного использования)</li></ul> | 30 |
| 0x0010FFFE, 0x0010FFFF | 2 |

### <a name="common-sync-errors"></a>Распространенные ошибки синхронизации
<a id="-2147023673"></a>**Сеанс синхронизации отменен.**  

| | |
|-|-|
| **HRESULT** | 0x800704c7 |
| **HRESULT (десятичное число)** | -2147023673 | 
| **Строка ошибки** | ERROR_CANCELLED |
| **Требуются действия по исправлению** | Нет |

Сеансы синхронизации могут завершиться ошибкой по разным причинам, включая перезапуск или обновление сервера, моментальные снимки VSS и т. д. Хотя эта ошибка выглядит так, будто требуются последующие действия, лучше проигнорировать ее, если только она не исчезнет в течение нескольких часов.

<a id="-2147012889"></a>**Не удается установить подключение к службе.**    

| | |
|-|-|
| **HRESULT** | 0x80072ee7 |
| **HRESULT (десятичное число)** | -2147012889 | 
| **Строка ошибки** | WININET_E_NAME_NOT_RESOLVED |
| **Требуются действия по исправлению** | Да |

[!INCLUDE [storage-sync-files-bad-connection](../../../includes/storage-sync-files-bad-connection.md)]

<a id="-2134376372"></a>**Служба применила регулирование к запросу пользователя.**  

| | |
|-|-|
| **HRESULT** | 0x80c8004c |
| **HRESULT (десятичное число)** | -2134376372 |
| **Строка ошибки** | ECS_E_USER_REQUEST_THROTTLED |
| **Требуются действия по исправлению** | Нет |

Никаких действий не требуется, сервер предпримет новую попытку. Если эта ошибка не исчезает в течение нескольких часов, создайте запрос в службу поддержки.

<a id="-2134364043"></a>**Синхронизация блокируется до завершения обнаружения изменений после восстановления**  

| | |
|-|-|
| **HRESULT** | 0x80c83075 |
| **HRESULT (десятичное число)** | -2134364043 |
| **Строка ошибки** | ECS_E_SYNC_BLOCKED_ON_CHANGE_DETECTION_POST_RESTORE |
| **Требуются действия по исправлению** | Нет |

Никаких действий не требуется. Если файл или общая папка (облачная конечная точка) восстанавливается с помощью Azure Backup, синхронизация блокируется до завершения обнаружения изменений в общей папке Azure. Обнаружение изменений выполняется сразу же после восстановления, а длительность зависит от числа файлов в общей папке.

<a id="-2147216747"></a>**Не удалось выполнить синхронизацию, так как база данных синхронизации выгружена.**  

| | |
|-|-|
| **HRESULT** | 0x80041295 |
| **HRESULT (десятичное число)** | -2147216747 |
| **Строка ошибки** | SYNC_E_METADATA_INVALID_OPERATION |
| **Требуются действия по исправлению** | Нет |

Эта ошибка обычно возникает, когда приложение резервного копирования создает моментальный снимок VSS, но база данных синхронизации выгружена. Если эта ошибка не исчезает в течение нескольких часов, создайте запрос в службу поддержки.

<a id="-2134364065"></a>**Служба синхронизации не может получить доступ к общему файловому ресурсу Azure, указанному в облачной конечной точке.**  

| | |
|-|-|
| **HRESULT** | 0x80c8305f |
| **HRESULT (десятичное число)** | -2134364065 |
| **Строка ошибки** | ECS_E_EXTERNAL_STORAGE_ACCOUNT_AUTHORIZATION_FAILED |
| **Требуются действия по исправлению** | Да |

Эта ошибка возникает из-за того, что агент службы "Синхронизация файлов Azure" не может получить доступ к общему файловому ресурсу Azure, что может быть связано с тем, что этого ресурса или учетной записи хранения, где он размещен, больше нет. Вы можете устранить эту ошибку, выполнив следующие шаги:

1. [Проверьте наличие учетной записи хранения.](#troubleshoot-storage-account)
2. [Проверьте наличие общего файлового ресурса Azure.](#troubleshoot-azure-file-share)
3. [Убедитесь, что служба "Синхронизация файлов Azure" имеет доступ к учетной записи хранения.](#troubleshoot-rbac)
4. [Убедитесь, что параметры брандмауэра и виртуальной сети в учетной записи хранения настроены правильно (если они включены).](./storage-sync-files-deployment-guide.md?tabs=azure-portal#configure-firewall-and-virtual-network-settings)

<a id="-2134351804"></a>**Синхронизация не удалась, поскольку у вызывающей стороны нет прав на выполнение этой операции.**  

| | |
|-|-|
| **HRESULT** | 0x80c86044 |
| **HRESULT (десятичное число)** | -2134351804 |
| **Строка ошибки** | ECS_E_AZURE_AUTHORIZATION_FAILED |
| **Требуются действия по исправлению** | Да |

Эта ошибка возникает из-за того, что агент синхронизации файлов Azure не имеет прав доступа к общей папке Azure. Вы можете устранить эту ошибку, выполнив следующие шаги:

1. [Проверьте наличие учетной записи хранения.](#troubleshoot-storage-account)
2. [Проверьте наличие общего файлового ресурса Azure.](#troubleshoot-azure-file-share)
3. [Убедитесь, что параметры брандмауэра и виртуальной сети в учетной записи хранения настроены правильно (если они включены).](./storage-sync-files-deployment-guide.md?tabs=azure-portal#configure-firewall-and-virtual-network-settings)
4. [Убедитесь, что служба "Синхронизация файлов Azure" имеет доступ к учетной записи хранения.](#troubleshoot-rbac)

<a id="-2134364064"></a><a id="cannot-resolve-storage"></a>**Не удалось разрешить имя используемой учетной записи хранения.**  

| | |
|-|-|
| **HRESULT** | 0x80C83060 |
| **HRESULT (десятичное число)** | -2134364064 |
| **Строка ошибки** | ECS_E_STORAGE_ACCOUNT_NAME_UNRESOLVED |
| **Требуются действия по исправлению** | Да |

1. Убедитесь, что вы можете разрешить DNS-имя хранилища с сервера.

    ```powershell
    Test-NetConnection -ComputerName <storage-account-name>.file.core.windows.net -Port 443
    ```
2. [Проверьте наличие учетной записи хранения.](#troubleshoot-storage-account)
3. [Убедитесь, что параметры брандмауэра и виртуальной сети в учетной записи хранения настроены правильно (если они включены).](./storage-sync-files-deployment-guide.md?tabs=azure-portal#configure-firewall-and-virtual-network-settings)

<a id="-2134364022"></a><a id="storage-unknown-error"></a>**Неизвестная ошибка при обращении к учетной записи хранения.**  

| | |
|-|-|
| **HRESULT** | 0x80c8308a |
| **HRESULT (десятичное число)** | -2134364022 |
| **Строка ошибки** | ECS_E_STORAGE_ACCOUNT_UNKNOWN_ERROR |
| **Требуются действия по исправлению** | Да |

1. [Проверьте наличие учетной записи хранения.](#troubleshoot-storage-account)
2. [Убедитесь, что параметры брандмауэра и виртуальной сети в учетной записи хранения настроены правильно (если они включены).](./storage-sync-files-deployment-guide.md?tabs=azure-portal#configure-firewall-and-virtual-network-settings)

<a id="-2134364014"></a>**Не удалось выполнить синхронизацию из-за блокировки учетной записи хранения.**  

| | |
|-|-|
| **HRESULT** | 0x80c83092 |
| **HRESULT (десятичное число)** | -2134364014 |
| **Строка ошибки** | ECS_E_STORAGE_ACCOUNT_LOCKED |
| **Требуются действия по исправлению** | Да |

Эта ошибка возникает из-за [блокировки ресурсов](../../azure-resource-manager/management/lock-resources.md) только для чтения в учетной записи хранения. Чтобы устранить эту проблему, удалите блокировку ресурсов только для чтения в учетной записи хранения. 

<a id="-1906441138"></a>**Сбой синхронизации из-за проблемы с базой данных синхронизации.**  

| | |
|-|-|
| **HRESULT** | 0x8e5e044e |
| **HRESULT (десятичное число)** | -1906441138 |
| **Строка ошибки** | JET_errWriteConflict |
| **Требуются действия по исправлению** | Да |

Эта ошибка появляется, если есть проблема с внутренней базой данных, используемой службой "Синхронизация файлов Azure". Создайте запрос в службу поддержки, и мы свяжемся с вами, чтобы решить эту проблему.

<a id="-2134364053"></a>**Установленная на сервере версия агента Синхронизации файлов Azure не поддерживается.**  

| | |
|-|-|
| **HRESULT** | 0x80C8306B |
| **HRESULT (десятичное число)** | -2134364053 |
| **Строка ошибки** | ECS_E_AGENT_VERSION_BLOCKED |
| **Требуются действия по исправлению** | Да |

Эта ошибка возникает, если установленная на сервере версия агента Синхронизации файлов Azure не поддерживается. Чтобы устранить эту проблему, [обновите]( https://docs.microsoft.com/azure/storage/files/storage-files-release-notes#upgrade-paths) до [поддерживаемой версии агента]( https://docs.microsoft.com/azure/storage/files/storage-files-release-notes#supported-versions).

<a id="-2134351810"></a>**Достигнут предельный размер хранилища общего файлового ресурса Azure.**  

| | |
|-|-|
| **HRESULT** | 0x80c8603e |
| **HRESULT (десятичное число)** | -2134351810 |
| **Строка ошибки** | ECS_E_AZURE_STORAGE_SHARE_SIZE_LIMIT_REACHED |
| **Требуются действия по исправлению** | Да |

Эта ошибка возникает, если достигнут предельный размер хранилища общего файлового ресурса Azure, что может произойти, если для этого ресурса применяется квота или использование превышает установленные лимиты. Дополнительные сведения см. в статье [Целевые показатели масштабируемости и производительности службы файлов Azure](storage-files-scale-targets.md).

1. Перейдите в группу синхронизации в службе синхронизации хранилища.
2. В группе синхронизации выберите облачную конечную точку.
3. Обратите внимание на имя общего файлового ресурса Azure в открытой области.
4. Выберите учетную запись хранения, на которую есть ссылка. Если переход по ссылке завершится ошибкой, значит связанная учетная запись хранения была удалена.

    ![Снимок экрана с областью сведений об облачной конечной точке и ссылкой на учетную запись хранения.](media/storage-sync-files-troubleshoot/file-share-inaccessible-1.png)

5. Выберите **Файлы** для просмотра списка общих файловых ресурсов.
6. Щелкните многоточие в конце строки для общего файлового ресурса Azure, на который ссылается облачная конечная точка.
7. Проверьте, чтобы значение в поле **Использование** было ниже значения в поле **Квота**. Обратите внимание, что если альтернативная квота не указана, квота будет соответствовать [максимальному размеру общего файла Azure](storage-files-scale-targets.md).

    ![Снимок экрана свойств общего файлового ресурса Azure.](media/storage-sync-files-troubleshoot/file-share-limit-reached-1.png)

Если общий ресурс заполнен и квота не установлена, одним из возможных способов устранения этой проблемы является переопределение всех подпапок текущей конечной точки сервера в их собственные конечные точки сервера в отдельных группах синхронизации. Таким образом, каждая вложенная папка будет синхронизироваться в отдельном хранилище файловых ресурсов Azure.

<a id="-2134351824"></a>**Не удалось найти общий файловый ресурс Azure.**  

| | |
|-|-|
| **HRESULT** | 0x80c86030 |
| **HRESULT (десятичное число)** | -2134351824 |
| **Строка ошибки** | ECS_E_AZURE_FILE_SHARE_NOT_FOUND |
| **Требуются действия по исправлению** | Да |

Эта ошибка возникает, когда общий файловый ресурс Azure недоступен. Чтобы устранить ошибку, сделайте следующее:

1. [Проверьте наличие учетной записи хранения.](#troubleshoot-storage-account)
2. [Проверьте наличие общего файлового ресурса Azure.](#troubleshoot-azure-file-share)

Если файловый ресурс Azure удален, создайте файловый ресурс и повторно создайте группу синхронизации. 

<a id="-2134364042"></a>**Синхронизация приостановлена, пока приостановлено использование этой подписки Azure.**  

| | |
|-|-|
| **HRESULT** | 0x80C83076 |
| **HRESULT (десятичное число)** | -2134364042 |
| **Строка ошибки** | ECS_E_SYNC_BLOCKED_ON_SUSPENDED_SUBSCRIPTION |
| **Требуются действия по исправлению** | Да |

Эта ошибка возникает, когда использование подписки Azure приостановлено. Синхронизация будет восстановлена после восстановления подписки Azure. Дополнительные сведения см. в статье [Почему подписка Azure отключена и как активировать ее повторно?](../../cost-management-billing/manage/subscription-disabled.md)

<a id="-2134375618"></a>**Для учетной записи хранения настроен брандмауэр или виртуальные сети.**  

| | |
|-|-|
| **HRESULT** | 0x80c8033e |
| **HRESULT (десятичное число)** | — 2134375618 |
| **Строка ошибки** | ECS_E_SERVER_BLOCKED_BY_NETWORK_ACL |
| **Требуются действия по исправлению** | Да |

Эта ошибка возникает, когда файловый ресурс Azure недоступен из-за брандмауэра учетной записи хранения или если учетная запись хранения принадлежит виртуальной сети. Убедитесь, что параметры брандмауэра и виртуальной сети в учетной записи хранения настроены правильно. Дополнительные сведения см. в статье [Настройка параметров брандмауэра и виртуальной сети](./storage-sync-files-deployment-guide.md?tabs=azure-portal#configure-firewall-and-virtual-network-settings). 

<a id="-2134375911"></a>**Сбой синхронизации из-за проблемы с базой данных синхронизации.**  

| | |
|-|-|
| **HRESULT** | 0x80c80219 |
| **HRESULT (десятичное число)** | -2134375911 |
| **Строка ошибки** | ECS_E_SYNC_METADATA_WRITE_LOCK_TIMEOUT |
| **Требуются действия по исправлению** | Нет |

Эта ошибка обычно разрешается самостоятельно. Причины ее появления:

* большое число изменений файла на серверах в группе синхронизации;
* большое количество ошибок в отдельных файлах и каталогах.

Если эта ошибка сохраняется в течение более нескольких часов, создайте запрос в службу поддержки, и мы свяжемся с вами, чтобы решить эту проблему.

<a id="-2146762487"></a>**Серверу не удалось установить безопасное подключение. Облачная служба получила непредвиденный сертификат.**  

| | |
|-|-|
| **HRESULT** | 0x800b0109 |
| **HRESULT (десятичное число)** | -2146762487 |
| **Строка ошибки** | CERT_E_UNTRUSTEDROOT |
| **Требуются действия по исправлению** | Да |

Эта ошибка может возникнуть, если ваша организация использует прокси-сервер с завершающим действием TLS или вредоносный объект перехватывает трафик между вашим сервером и службой "Синхронизация файлов Azure". Если вы уверены, что это ожидаемое поведение (потому что ваша организация использует прокси-сервер с завершающим действием TLS), можно пропустить проверку сертификата с переопределением реестра.

1. Создайте значение реестра SkipVerifyingPinnedRootCertificate.

    ```powershell
    New-ItemProperty -Path HKLM:\SOFTWARE\Microsoft\Azure\StorageSync -Name SkipVerifyingPinnedRootCertificate -PropertyType DWORD -Value 1
    ```

2. Перезапустите службу синхронизации для зарегистрированного сервера.

    ```powershell
    Restart-Service -Name FileSyncSvc -Force
    ```

Если задать это значение реестра, агент службы "Синхронизация файлов Azure" будет принимать любые локально доверенные TLS- или SSL-сертификаты при передаче данных между сервером и облачной службой.

<a id="-2147012894"></a>**Не удается установить подключение к службе.**  

| | |
|-|-|
| **HRESULT** | 0x80072ee2 |
| **HRESULT (десятичное число)** | -2147012894 |
| **Строка ошибки** | WININET_E_TIMEOUT |
| **Требуются действия по исправлению** | Да |

[!INCLUDE [storage-sync-files-bad-connection](../../../includes/storage-sync-files-bad-connection.md)]

<a id="-2134375680"></a>**Сбой синхронизации из-за проблемы с аутентификацией.**  

| | |
|-|-|
| **HRESULT** | 0x80c80300 |
| **HRESULT (десятичное число)** | -2134375680 |
| **Строка ошибки** | ECS_E_SERVER_CREDENTIAL_NEEDED |
| **Требуются действия по исправлению** | Да |

Эта ошибка обычно возникает из-за неправильного времени сервера. Если сервер запущен на виртуальной машине, проверьте правильность времени на узле.

<a id="-2134364040"></a>**Не удалось выполнить синхронизацию, так как срок действия сертификата истек.**  

| | |
|-|-|
| **HRESULT** | 0x80c83078 |
| **HRESULT (десятичное число)** | -2134364040 |
| **Строка ошибки** | ECS_E_AUTH_SRV_CERT_EXPIRED |
| **Требуются действия по исправлению** | Да |

Эта ошибка возникает, потому что истек срок действия сертификата, используемого для проверки подлинности.

Чтобы проверить, истек ли срок действия сертификата, выполните следующие действия:  
1. Откройте оснастку MMC для сертификатов, выберите учетную запись компьютера и перейдите в каталог Certificates (локальный компьютер)\Personal\Certificates.
2. Проверьте, не истек ли срок действия сертификата проверки подлинности клиента.

Если срок действия этого сертификата истек, выполните следующие действия, чтобы устранить проблему:

1. Убедитесь, что установлен агент службы "Синхронизация файлов Azure" версии 4.0.1.0 или более поздней.
2. На сервере выполните следующую команду PowerShell:

    ```powershell
    Reset-AzStorageSyncServerCertificate -ResourceGroupName <string> -StorageSyncServiceName <string>
    ```

<a id="-2134375896"></a>**Не удалось выполнить синхронизацию, так как сертификат проверки подлинности не найден.**  

| | |
|-|-|
| **HRESULT** | 0x80c80228 |
| **HRESULT (десятичное число)** | -2134375896 |
| **Строка ошибки** | ECS_E_AUTH_SRV_CERT_NOT_FOUND |
| **Требуются действия по исправлению** | Да |

Эта ошибка возникает, так как сертификат, используемый для проверки подлинности, не найден.

Чтобы устранить эту проблему, выполните описанные ниже шаги:

1. Убедитесь, что установлен агент службы "Синхронизация файлов Azure" версии 4.0.1.0 или более поздней.
2. На сервере выполните следующую команду PowerShell:

    ```powershell
    Reset-AzStorageSyncServerCertificate -ResourceGroupName <string> -StorageSyncServiceName <string>
    ```

<a id="-2134364039"></a>**Не удалось выполнить синхронизацию, так как удостоверение для проверки подлинности не найдено.**  

| | |
|-|-|
| **HRESULT** | 0x80c83079 |
| **HRESULT (десятичное число)** | -2134364039 |
| **Строка ошибки** | ECS_E_AUTH_IDENTITY_NOT_FOUND |
| **Требуются действия по исправлению** | Да |

Эта ошибка возникает из-за того, что удаление конечной точки сервера завершилось сбоем, и теперь конечная точка находится в состоянии "Частично удалено". Чтобы устранить эту проблему, попробуйте еще раз удалить конечную точку сервера.

<a id="-1906441711"></a><a id="-2134375654"></a><a id="doesnt-have-enough-free-space"></a>**Недостаточно места на томе, где расположена конечная точка сервера.**  

| | |
|-|-|
| **HRESULT** | 0x8e5e0211 |
| **HRESULT (десятичное число)** | -1906441711 |
| **Строка ошибки** | JET_errLogDiskFull |
| **Требуются действия по исправлению** | Да |

| | |
|-|-|
| **HRESULT** | 0x80c8031a |
| **HRESULT (десятичное число)** | -2134375654 |
| **Строка ошибки** | ECS_E_NOT_ENOUGH_LOCAL_STORAGE |
| **Требуются действия по исправлению** | Да |

Эта ошибка возникает, если недостаточно места на томе. Эта ошибка обычно возникает из-за того, что файлы за пределами конечной точки сервера используют пространство на томе. Освободите место на томе, добавив дополнительные конечные точки сервера, переместив файлы на другой том или увеличив размер тома, на котором установлена конечная точка сервера.

<a id="-2134364145"></a><a id="replica-not-ready"></a>**Служба еще не готова к синхронизации с этой конечной точкой сервера.**  

| | |
|-|-|
| **HRESULT** | 0x80c8300f |
| **HRESULT (десятичное число)** | -2134364145 |
| **Строка ошибки** | ECS_E_REPLICA_NOT_READY |
| **Требуются действия по исправлению** | Нет |

Эта ошибка возникает из-за того, что облачная конечная точка была создана с содержимым, уже существующим в общей папке Azure. Служба синхронизации файлов Azure должна проверить все содержимое общей папки Azure, прежде чем разрешит конечной точке сервера продолжить начальную синхронизацию.

<a id="-2134375877"></a><a id="-2134375908"></a><a id="-2134375853"></a>**Сбой синхронизации из-за проблем с большим количеством отдельных файлов.**  

| | |
|-|-|
| **HRESULT** | 0x80c8023b |
| **HRESULT (десятичное число)** | -2134375877 |
| **Строка ошибки** | ECS_E_SYNC_METADATA_KNOWLEDGE_SOFT_LIMIT_REACHED |
| **Требуются действия по исправлению** | Да |

| | |
|-|-|
| **HRESULT** | 0x80c8021c |
| **HRESULT (десятичное число)** | -2134375908 |
| **Строка ошибки** | ECS_E_SYNC_METADATA_KNOWLEDGE_LIMIT_REACHED |
| **Требуются действия по исправлению** | Да |

| | |
|-|-|
| **HRESULT** | 0x80c80253 |
| **HRESULT (десятичное число)** | -2134375853 |
| **Строка ошибки** | ECS_E_TOO_MANY_PER_ITEM_ERRORS |
| **Требуются действия по исправлению** | Да |

Сеансы синхронизации завершаются сбоем с одной из этих ошибок, если существует много файлов, которые не удается синхронизировать с ошибками для каждого элемента. Выполните действия, описанные в [разделы справки проверьте, есть ли в разделе определенные файлы или папки, которые не синхронизируются?](?tabs=portal1%252cazure-portal#how-do-i-see-if-there-are-specific-files-or-folders-that-are-not-syncing) для устранения ошибок, связанных с каждым элементом. Для ECS_E_SYNC_METADATA_KNOWLEDGE_LIMIT_REACHED ошибок синхронизации откройте обращение в службу поддержки.

> [!NOTE]
> Служба "Синхронизация файлов Azure" раз в день создает на сервере временный моментальный снимок VSS для синхронизации файлов с открытыми дескрипторами.

<a id="-2134376423"></a>**Сбой синхронизации из-за проблемы с путем к конечной точке сервера.**  

| | |
|-|-|
| **HRESULT** | 0x80c80019 |
| **HRESULT (десятичное число)** | -2134376423 |
| **Строка ошибки** | ECS_E_SYNC_INVALID_PATH |
| **Требуются действия по исправлению** | Да |

Проверьте наличие пути в локальном томе NTFS, и чтобы он не являлся точкой повторного анализа или имеющейся конечной точкой сервера.

<a id="-2134375817"></a>**Синхронизация не удалась, так как версия драйвера фильтра несовместима с версией агента**  

| | |
|-|-|
| **HRESULT** | 0x80C80277 |
| **HRESULT (десятичное число)** | -2134375817 |
| **Строка ошибки** | ECS_E_INCOMPATIBLE_FILTER_VERSION |
| **Требуются действия по исправлению** | Да |

Эта ошибка возникает из-за того, что загруженная версия драйвера фильтра для распределения по уровням в облаке (StorageSync.sys) несовместима со службой агента синхронизации хранилища (FileSyncSvc). Если агент службы "Синхронизация файлов Azure" был обновлен, перезапустите сервер, чтобы завершить установку. Если ошибка продолжает возникать, удалите агент, перезапустите сервер и переустановите агент службы "Синхронизация файлов Azure".

<a id="-2134376373"></a>**В настоящее время служба недоступна.**  

| | |
|-|-|
| **HRESULT** | 0x80c8004b |
| **HRESULT (десятичное число)** | -2134376373 |
| **Строка ошибки** | ECS_E_SERVICE_UNAVAILABLE |
| **Требуются действия по исправлению** | Нет |

Эта ошибка возникает, так как служба "Синхронизация файлов Azure" недоступна. Когда служба Синхронизации файлов Azure снова станет доступной, эта ошибка устранится автоматически.

<a id="-2146233088"></a>**Не удалось выполнить синхронизацию из-за исключения.**  

| | |
|-|-|
| **HRESULT** | 0x80131500 |
| **HRESULT (десятичное число)** | -2146233088 |
| **Строка ошибки** | COR_E_EXCEPTION |
| **Требуются действия по исправлению** | Нет |

Эта ошибка возникает, если произошел сбой синхронизации из-за исключения. Если эта ошибка не исчезает в течение нескольких часов, создайте запрос на поддержку.

<a id="-2134364045"></a>**Не удалось выполнить синхронизацию из-за отработки отказа учетной записи хранения в другой регион.**  

| | |
|-|-|
| **HRESULT** | 0x80c83073 |
| **HRESULT (десятичное число)** | -2134364045 |
| **Строка ошибки** | ECS_E_STORAGE_ACCOUNT_FAILED_OVER |
| **Требуются действия по исправлению** | Да |

Эта ошибка возникает из-за отработки отказа учетной записи хранения в другой регион. Служба "Синхронизация файлов Azure" не поддерживает функцию отработки отказа учетной записи хранения. Не следует применять отработку отказа для учетных записей хранения, которые содержат файловые ресурсы Azure, используемые в качестве облачных конечных точек в службе синхронизации файлов Azure. Это приведет к прекращению синхронизации или даже к непредвиденной потере данных, если некоторые файлы недавно стали многоуровневыми. Чтобы устранить эту проблему, переместите учетную запись хранения в основной регион.

<a id="-2134375922"></a>**Сбой синхронизации из-за временной проблемы с базой данных синхронизации.**  

| | |
|-|-|
| **HRESULT** | 0x80c8020e |
| **HRESULT (десятичное число)** | -2134375922 |
| **Строка ошибки** | ECS_E_SYNC_METADATA_WRITE_LEASE_LOST |
| **Требуются действия по исправлению** | Нет |

Эта ошибка возникает из-за внутренней проблемы с базой данных синхронизации. Эта ошибка устранится автоматически при повторной синхронизации. Если эта ошибка сохраняется в течение продолжительного периода времени, создайте запрос в службу поддержки, и мы свяжемся с вами, чтобы решить эту проблему.

<a id="-2134364024"></a>**Не удалось выполнить синхронизацию из-за изменения у клиента Azure Active Directory**  

| | |
|-|-|
| **HRESULT** | 0x80c83088 |
| **HRESULT (десятичное число)** | -2134364024 | 
| **Строка ошибки** | ECS_E_INVALID_AAD_TENANT |
| **Требуются действия по исправлению** | Да |

Убедитесь, что используется последняя версия агента службы синхронизации файлов Azure. Версия 10 агента синхронизации файлов Azure поддерживает перемещение подписки в другой клиент Azure Active Directory.
 
После установки последней версии агента необходимо предоставить приложению Microsoft.StorageSync доступ к учетной записи хранения (см. раздел о том, как [убедиться, что Синхронизация файлов Azure имеет доступ к учетной записи хранения](#troubleshoot-rbac)).

<a id="-2134364010"></a>**Не удалось выполнить синхронизацию, так как исключение брандмауэра и виртуальной сети не настроено**  

| | |
|-|-|
| **HRESULT** | 0x80c83096 |
| **HRESULT (десятичное число)** | -2134364010 | 
| **Строка ошибки** | ECS_E_MGMT_STORAGEACLSBYPASSNOTSET |
| **Требуются действия по исправлению** | Да |

Эта ошибка возникает, если параметры брандмауэра и виртуальной сети включены в учетной записи хранения, но флажок для исключения "Разрешить доверенным службам Майкрософт доступ к этой учетной записи хранения" не установлен. Чтобы устранить эту проблему, выполните действия, описанные в разделе [Настройка параметров брандмауэра и виртуальной сети](./storage-sync-files-deployment-guide.md?tabs=azure-portal#configure-firewall-and-virtual-network-settings) в руководстве по развертыванию.

<a id="-2147024891"></a>**Не удалось выполнить синхронизацию, так как разрешения для папки System Volume Information указаны неверно.**  

| | |
|-|-|
| **HRESULT** | 0x80070005 |
| **HRESULT (десятичное число)** | -2147024891 |
| **Строка ошибки** | ERROR_ACCESS_DENIED |
| **Требуются действия по исправлению** | Да |

Эта ошибка может возникать, если учетная запись NT AUTHORITY\SYSTEM не предоставляет разрешений на доступ к папке со сведениями о системном томе, где размещена конечная точка сервера. Обратите внимание: если отдельные файлы не удается синхронизировать из-за ошибки ERROR_ACCESS_DENIED, выполните действия, описанные в разделе [Устранение ошибок синхронизации в каталоге или файле](?tabs=portal1%252cazure-portal#troubleshooting-per-filedirectory-sync-errors).

Чтобы устранить эту проблему, выполните описанные ниже шаги:

1. Скачайте средство [PsExec](/sysinternals/downloads/psexec).
2. Выполните следующую команду в командной строке с повышенными привилегиями, чтобы открыть командную строку с использованием системной учетной записи: **PsExec.exe -i -s -d cmd**. 
3. В командной строке, запущенной из системной учетной записи, выполните следующую команду, чтобы убедиться, что у учетной записи NT AUTHORITY\SYSTEM нет доступа к папке со сведениями о системном томе: **cacls "буква диска:\system volume information" /T /C**.
4. Если у учетной записи NT AUTHORITY\SYSTEM нет доступа к папке со сведениями о системном томе, выполните следующую команду: **cacls "буква диска:\system volume information" /T /E /G "NT AUTHORITY\SYSTEM:F"** .
    - Если не удается выполнить шаг 4 и поступает сообщение об отказе в доступе, выполните следующую команду, чтобы получить права владения папкой со сведениями о системном томе, а затем повторите шаг 4: **takeown /A /R /F "буква диска:\System Volume Information"** .

<a id="-2134375810"></a>**Не удалось выполнить синхронизацию, так как общая папка Azure была удалена и создана повторно.**  

| | |
|-|-|
| **HRESULT** | 0x80c8027e |
| **HRESULT (десятичное число)** | -2134375810 |
| **Строка ошибки** | ECS_E_SYNC_REPLICA_ROOT_CHANGED |
| **Требуются действия по исправлению** | Да |

Причина в том, что Синхронизация файлов Azure не поддерживает удаление и повторное создание файлового ресурса Azure в одной и той же группе синхронизации. 

Чтобы устранить эту проблему, удалите и повторно создайте группу синхронизации. Для этого сделайте следующее:

1. Удалите все конечные точки сервера в группе синхронизации.
2. Удалите облачную конечную точку. 
3. Удалите группу синхронизации.
4. Если в конечной точке сервера было включено распределение по уровням в облаке, удалите потерянные распределенные по уровням файлы на сервере. Для этого выполните действия, описанные в разделе [Многоуровневые файлы недоступны на сервере после удаления конечной точки сервера](?tabs=portal1%252cazure-portal#tiered-files-are-not-accessible-on-the-server-after-deleting-a-server-endpoint).
5. Повторно создайте группу синхронизации.

<a id="-2145844941"></a>**Не удалось выполнить синхронизацию из-за перенаправления HTTP-запроса**  

| | |
|-|-|
| **HRESULT** | 0x80190133 |
| **HRESULT (десятичное число)** | -2145844941 |
| **Строка ошибки** | HTTP_E_STATUS_REDIRECT_KEEP_VERB |
| **Требуются действия по исправлению** | Да |

Эта ошибка возникает из-за того, Синхронизация файлов Azure не поддерживает перенаправление HTTP (код состояния 3xx). Чтобы устранить эту проблему, отключите перенаправление HTTP на прокси-сервере или сетевом устройстве.

<a id="-2134364027"></a>**При автономной передаче данных истекло время ожидания, но передача данных все еще выполняется.**  

| | |
|-|-|
| **HRESULT** | 0x80c83085 |
| **HRESULT (десятичное число)** | -2134364027 |
| **Строка ошибки** | ECS_E_DATA_INGESTION_WAIT_TIMEOUT |
| **Требуются действия по исправлению** | Нет |

Эта ошибка возникает, когда длительность операции приема данных превышает время ожидания. Эту ошибку можно пропустить, если выполняется синхронизация (AppliedItemCount больше 0). См. раздел [Как отслеживать ход выполнения текущего сеанса синхронизации?](#how-do-i-monitor-the-progress-of-a-current-sync-session).

<a id="-2134375814"></a>**Не удалось выполнить синхронизацию, так как не удается найти путь к конечной точке сервера на сервере.**  

| | |
|-|-|
| **HRESULT** | 0x80c8027a |
| **HRESULT (десятичное число)** | — 2134375814 |
| **Строка ошибки** | ECS_E_SYNC_ROOT_DIRECTORY_NOT_FOUND |
| **Требуются действия по исправлению** | Да |

Эта ошибка возникает, если каталог, используемый в качестве пути к конечной точке сервера, был переименован или удален. Если каталог был переименован, переименуйте каталог обратно на исходное имя и перезапустите службу агента синхронизации хранилища (FileSyncSvc).

Если каталог удален, выполните следующие действия, чтобы удалить существующую конечную точку сервера и создать новую конечную точку сервера, используя новый путь:

1. Удалите конечную точку сервера в группе синхронизации, выполнив действия, описанные в разделе [Удаление конечной точки сервера](./storage-sync-files-server-endpoint.md#remove-a-server-endpoint).
2. Создайте новую конечную точку сервера в группе синхронизации, выполнив действия, описанные в разделе [Добавление конечной точки сервера](./storage-sync-files-server-endpoint.md#add-a-server-endpoint).

### <a name="common-troubleshooting-steps"></a>Распространенные действия по устранению неполадок
<a id="troubleshoot-storage-account"></a>**Проверьте наличие учетной записи хранения.**  
# <a name="portal"></a>[Портал](#tab/azure-portal)
1. Перейдите в группу синхронизации в службе синхронизации хранилища.
2. В группе синхронизации выберите облачную конечную точку.
3. Обратите внимание на имя общего файлового ресурса Azure в открытой области.
4. Выберите учетную запись хранения, на которую есть ссылка. Если переход по ссылке завершится ошибкой, значит связанная учетная запись хранения была удалена.
    ![Снимок экрана с областью сведений об облачной конечной точке и ссылкой на учетную запись хранения.](media/storage-sync-files-troubleshoot/file-share-inaccessible-1.png)

# <a name="powershell"></a>[PowerShell](#tab/azure-powershell)
```powershell
# Variables for you to populate based on your configuration
$region = "<Az_Region>"
$resourceGroup = "<RG_Name>"
$syncService = "<storage-sync-service>"
$syncGroup = "<sync-group>"

# Log into the Azure account
Connect-AzAccount

# Check to ensure Azure File Sync is available in the selected Azure
# region.
$regions = [System.String[]]@()
Get-AzLocation | ForEach-Object { 
    if ($_.Providers -contains "Microsoft.StorageSync") { 
        $regions += $_.Location 
    } 
}

if ($regions -notcontains $region) {
    throw [System.Exception]::new("Azure File Sync is either not available in the " + `
        " selected Azure Region or the region is mistyped.")
}

# Check to ensure resource group exists
$resourceGroups = [System.String[]]@()
Get-AzResourceGroup | ForEach-Object { 
    $resourceGroups += $_.ResourceGroupName 
}

if ($resourceGroups -notcontains $resourceGroup) {
    throw [System.Exception]::new("The provided resource group $resourceGroup does not exist.")
}

# Check to make sure the provided Storage Sync Service
# exists.
$syncServices = [System.String[]]@()

Get-AzStorageSyncService -ResourceGroupName $resourceGroup | ForEach-Object {
    $syncServices += $_.StorageSyncServiceName
}

if ($syncServices -notcontains $syncService) {
    throw [System.Exception]::new("The provided Storage Sync Service $syncService does not exist.")
}

# Check to make sure the provided Sync Group exists
$syncGroups = [System.String[]]@()

Get-AzStorageSyncGroup -ResourceGroupName $resourceGroup -StorageSyncServiceName $syncService | ForEach-Object {
    $syncGroups += $_.SyncGroupName
}

if ($syncGroups -notcontains $syncGroup) {
    throw [System.Exception]::new("The provided sync group $syncGroup does not exist.")
}

# Get reference to cloud endpoint
$cloudEndpoint = Get-AzStorageSyncCloudEndpoint `
    -ResourceGroupName $resourceGroup `
    -StorageSyncServiceName $syncService `
    -SyncGroupName $syncGroup

# Get reference to storage account
$storageAccount = Get-AzStorageAccount | Where-Object { 
    $_.Id -eq $cloudEndpoint.StorageAccountResourceId
}

if ($storageAccount -eq $null) {
    throw [System.Exception]::new("The storage account referenced in the cloud endpoint does not exist.")
}
```
---

<a id="troubleshoot-azure-file-share"></a>**Проверьте наличие общего файлового ресурса Azure.**  
# <a name="portal"></a>[Портал](#tab/azure-portal)
1. Щелкните **Обзор** в таблице содержания слева, чтобы вернуться на главную страницу учетной записи хранения.
2. Выберите **Файлы** для просмотра списка общих файловых ресурсов.
3. Проверьте, что файловый ресурс, на который ссылается облачная конечная точка, отображается в списке файловых ресурсов (это должно быть отмечено на шаге 1 выше).

# <a name="powershell"></a>[PowerShell](#tab/azure-powershell)
```powershell
$fileShare = Get-AzStorageShare -Context $storageAccount.Context | Where-Object {
    $_.Name -eq $cloudEndpoint.AzureFileShareName -and
    $_.IsSnapshot -eq $false
}

if ($fileShare -eq $null) {
    throw [System.Exception]::new("The Azure file share referenced by the cloud endpoint does not exist")
}
```
---

<a id="troubleshoot-rbac"></a>**Убедитесь, что служба "Синхронизация файлов Azure" имеет доступ к учетной записи хранения.**  
# <a name="portal"></a>[Портал](#tab/azure-portal)
1. Щелкните **Управление доступом (IAM)** в таблице содержимого слева.
1. Щелкните вкладку **Назначение ролей** и откройте список пользователей и приложений (*субъекты-службы*), имеющих доступ к вашей учетной записи хранения.
1. Убедитесь в том, **Microsoft.StorageSync** или **гибридная служба "Синхронизация файлов"** (старое имя приложения) отображается в списке с ролью **чтения и доступа к данным**. 

    ![Снимок экрана субъекта-службы гибридной службы "Синхронизация файлов" на вкладке управления доступом учетной записи хранения](media/storage-sync-files-troubleshoot/file-share-inaccessible-3.png)

    Если **Microsoft.StorageSync** или **гибридная служба "Синхронизация файлов"** не отображается в списке, сделайте следующее.

    - Нажмите кнопку **Добавить**.
    - В поле **Роль** выберите **Модуль чтения и доступ к данным**.
    - В поле **выбора** введите фразу **Microsoft.StorageSync**, выберите роль и нажмите кнопку **Сохранить**.

# <a name="powershell"></a>[PowerShell](#tab/azure-powershell)
```powershell    
$role = Get-AzRoleAssignment -Scope $storageAccount.Id | Where-Object { $_.DisplayName -eq "Microsoft.StorageSync" }

if ($role -eq $null) {
    throw [System.Exception]::new("The storage account does not have the Azure File Sync " + `
                "service principal authorized to access the data within the " + ` 
                "referenced Azure file share.")
}
```
---

### <a name="how-do-i-prevent-users-from-creating-files-containing-unsupported-characters-on-the-server"></a>Как на сервере запретить пользователям создавать файлы, содержащие неподдерживаемые знаки?
Вы можете использовать [фильтры блокировки файлов диспетчера ресурсов файлового сервера (FSRM)](/windows-server/storage/fsrm/file-screening-management), чтобы блокировать создание на сервере файлов с неподдерживаемыми знаками в их именах. Возможно, это нужно будет сделать с помощью PowerShell, так как большинство неподдерживаемых знаков не выводятся, поэтому вам нужно сначала привести шестнадцатеричные представления к знаковым.

Сначала создайте группу файлов FSRM с помощью командлета [New-FsrmFileGroup](/powershell/module/fileserverresourcemanager/new-fsrmfilegroup). В этом примере группа будет содержать только два неподдерживаемых знака, но вы можете включить в группу файлов столько знаков, сколько нужно.

```powershell
New-FsrmFileGroup -Name "Unsupported characters" -IncludePattern @(("*"+[char]0x00000090+"*"),("*"+[char]0x0000008F+"*"))
```

После определения группы файлов FSRM можно создать фильтр блокировки файлов FSRM с помощью командлета New-FsrmFileScreen.

```powershell
New-FsrmFileScreen -Path "E:\AFSdataset" -Description "Filter unsupported characters" -IncludeGroup "Unsupported characters"
```

> [!Important]  
> Обратите внимание, что фильтры блокировки файлов должны использоваться только для блокировки создания знаков, не поддерживаемых службой "Синхронизация файлов Azure". Если фильтры блокировки файлов используются в других сценариях, служба синхронизации будет постоянно пытаться загружать файлы из общего файлового ресурса Azure на сервер и будет заблокирована фильтром блокировки файлов, что приведет к большому объему исходящих данных. 

## <a name="cloud-tiering"></a>Распределение по уровням облака 
Существует два сценария сбоев при распределении по уровням облака.

- Во-первых, может произойти сбой распределения файлов, когда служба "Синхронизация файлов Azure" не может успешно перенести файл в Файлы Azure.
- Во-вторых, может произойти сбой получения файлов, когда фильтр файловой системы (StorageSync.sys) службы "Синхронизация файлов Azure" не может успешно скачать данные перенесенного в облако файла, когда пользователь пытается к нему обратиться.

Для каждого из сценариев есть два основных класса сбоев:

- Сбои облачного хранилища
    - *Временные проблемы с доступностью службы хранилища*. Подробнее этот вопрос рассматривается в [Соглашении об уровне обслуживания (SLA) для службы хранилища Azure](https://azure.microsoft.com/support/legal/sla/storage/v1_2/).
    - *Недоступность общего файлового ресурса Azure*. Такая ошибка обычно происходит, когда вы удаляете общий файловый ресурс Azure, который назначен в качестве облачной конечной точки в группе синхронизации.
    - *Недоступность учетной записи хранения*. Такая ошибка обычно происходит, когда вы удаляете учетную запись хранения, которая содержит общую папку Azure, назначенную в качестве облачной конечной точки для группы синхронизации. 
- Ошибки сервера 
  - *Не загружен фильтр файловой системы (StorageSync.sys) службы синхронизации файлов Azure*. Чтобы обслуживать запросы на сохранение и восстановление файлов, должен быть загружен фильтр файловой системы службы синхронизации файлов Azure. Может быть несколько причин, по которым фильтр не будет загружен. Но чаще всего это означает, что администратор вручную отключил его. Фильтр файловой системы службы "Синхронизация файлов Azure" должен быть постоянно загружен, чтобы эта служба работала правильно.
  - *Точка повторного анализа отсутствует, повреждена или непригодна по другим причинам*. Точка повторной обработки — это специальная структура данных о файле, которая состоит из двух частей.
    1. Тег повторной обработки указывает, какая операционная система нужна фильтру файловой системы (StorageSync.sys) службы "Синхронизация файлов Azure" для операций ввода-вывода с этим файлом. 
    2. Данные повторной обработки сообщают фильтру файловой системы URI файла на соответствующей облачной конечной точке (в общем файловом ресурсе Azure). 
        
       Наиболее распространенная проблема с точкой повторной обработки — неудачная попытка администратора изменить в ней тег или данные. 
  - *Проблемы с сетевым подключением* Чтобы выполнять сохранение и восстановление файлов, сервер должен иметь подключение к Интернету.

В следующих разделах описывается устранение неполадок с распределением по уровням облака, которое позволит определить возможные проблемы с облачным хранилищем или сервером.

### <a name="how-to-monitor-tiering-activity-on-a-server"></a>Как на сервере отслеживать действие распределения по уровням  
Чтобы отслеживать на сервере действие распределения по уровням, используйте идентификаторы события 9003, 9016 и 9029 в журнале событий телеметрии (расположенном в папке Applications and Services\Microsoft\FileSync\Agent в средстве "Просмотр событий").

- Идентификатор события 9003 обеспечивает распределение ошибок для конечной точки сервера. Например, общее число ошибок, код ошибки и т. д. Обратите внимание, что на каждый код ошибки регистрируется одно событие.
- Идентификатор события 9016 предоставляет результаты копий для тома. Например, процент свободного пространства, количество скопированных файлов в сеансе, количество файлов, копии которых создать не удалось, и т. д.
- Идентификатор события 9029 предоставляет сведения о сеансе копирования для конечной точки сервера. Например, количество попыток копирования файла в сеансе, количество файлов, распределенных по уровням в сеансе, количество уже распределенных по уровням файлов и т. д.

### <a name="how-to-monitor-recall-activity-on-a-server"></a>Как на сервере отслеживать действие отзыва
Чтобы отслеживать на сервере действие отзыва, используйте идентификаторы события 9005, 9006, 9009 и 9059 в журнале событий телеметрии (расположенном в папке Applications and Services\Microsoft\FileSync\Agent в средстве "Просмотр событий").

- Идентификатор события 9005 обеспечивает надежность отзыва для конечной точки сервера. Например, общее число уникальных файлов, к которым получен доступ, общее число уникальных файлов, доступ к которым завершился сбоем, и т. д.
- Идентификатор события 9006 обеспечивает распределение ошибок отзыва для конечной точки сервера. Например, общее количество запросов, завершившихся сбоем, код ошибки и т. д. Обратите внимание, что на каждый код ошибки регистрируется одно событие.
- Идентификатор события 9009 предоставляет сведения о сеансе отзыва для конечной точки сервера. Например, DurationSeconds, CountFilesRecallSucceeded, CountFilesRecallFailed и др.
- Идентификатор события 9059 предоставляет сведения об отзыве приложения для конечной точки сервера. Например, ShareId, ApplicationName и TotalEgressNetworkBytes.

### <a name="how-to-troubleshoot-files-that-fail-to-tier"></a>Устранение неполадок при распределении файлов по уровням
Если файлы не удается распределить по уровням в службе файлов Azure, сделайте следующее:

1. В средстве "Просмотр событий" просмотрите журналы событий диагностики, операций и телеметрии, расположенные в папке Applications and Services\Microsoft\FileSync\Agent. 
   1. Проверьте наличие файлов в файловом ресурсе Azure.

      > [!NOTE]
      > Файлы должны быть синхронизированы с общими файловыми ресурсами Azure, прежде чем их можно будет распределить по уровням.

   2. Проверьте наличие подключения сервера к Интернету. 
   3. Убедитесь, что драйверы фильтра службы "Синхронизация файлов Azure" (StorageSync.sys и StorageSyncGuard.sys) запущены.
       - В командной строке с повышенными привилегиями запустите `fltmc`. Убедитесь, что указаны драйверы StorageSync.sys и StorageSyncGuard.sys фильтра файловой системы.

> [!NOTE]
> Идентификатор события 9003 регистрируется один раз в час в журнале событий телеметрии при сбое распределения файла по уровням (на один код ошибки регистрируется одно событие). Чтобы узнать, что можно сделать для исправления ошибки с тем или иным кодом, обратитесь к разделу [Ошибки распределения по уровням и их исправление](#tiering-errors-and-remediation).

### <a name="tiering-errors-and-remediation"></a>Ошибки распределения по уровням и их исправление

| HRESULT | HRESULT (десятичное число) | Строка ошибки | Проблема | Исправление |
|---------|-------------------|--------------|-------|-------------|
| 0x80c86045 | — 2134351803 | ECS_E_INITIAL_UPLOAD_PENDING | Не удалось прослойировать файл, так как выполняется начальная отправка. | Действия не требуются. После завершения начальной передачи файл будет распределяться по уровням. |
| 0x80c86043 | -2134351805 | ECS_E_GHOSTING_FILE_IN_USE | Не удалось переместить файл в многоуровневое хранилище, так как он используется. | Действия не требуются. По завершении использования файл будет помещен в многоуровневое хранилище. |
| 0x80c80241 | -2134375871 | ECS_E_GHOSTING_EXCLUDED_BY_SYNC | Не удалось переместить файл в многоуровневое хранилище, так как он исключен службой синхронизации. | Действия не требуются. Файлы из списка исключений синхронизации не могут храниться в многоуровневом хранилище. |
| 0x80c86042 | -2134351806 | ECS_E_GHOSTING_FILE_NOT_FOUND | Не удалось переместить файл в многоуровневое хранилище, так как он не найден на сервере. | Действия не требуются. Если ошибка повторится, проверьте, существует ли файл на сервере. |
| 0x80c83053 | -2134364077 | ECS_E_CREATE_SV_FILE_DELETED | Не удалось переместить файл в многоуровневое хранилище, так как он удален из общей папки Azure. | Действия не требуются. Файл должен быть удален на сервере при следующем запуске сеанса синхронизации скачивания. |
| 0x80c8600e | -2134351858 | ECS_E_AZURE_SERVER_BUSY | Не удалось переместить файл в многоуровневое хранилище из-за проблемы с сетью. | Действия не требуются. Если ошибка повторится, проверьте сетевое подключение к общей папке Azure. |
| 0x80072ee7 | -2147012889 | WININET_E_NAME_NOT_RESOLVED | Не удалось переместить файл в многоуровневое хранилище из-за проблемы с сетью. | Действия не требуются. Если ошибка повторится, проверьте сетевое подключение к общей папке Azure. |
| 0x80070005 | -2147024891 | ERROR_ACCESS_DENIED | Не удалось переместить файл в многоуровневое хранилище из-за отказа в доступе. Эта проблема может возникать из-за того, что файл находится в DFSR-папке репликации, доступной только для чтения. | Служба синхронизации файлов Azure не поддерживает конечные точки сервера на уровне папок репликации DFS-R только для чтения. Дополнительные сведения см. в разделе [Распределенная файловая система (DFS)](./storage-sync-files-planning.md#distributed-file-system-dfs). |
| 0x80072efe | -2147012866 | WININET_E_CONNECTION_ABORTED | Не удалось переместить файл в многоуровневое хранилище из-за проблемы с сетью. | Действия не требуются. Если ошибка повторится, проверьте сетевое подключение к общей папке Azure. |
| 0x80c80261 | -2134375839 | ECS_E_GHOSTING_MIN_FILE_SIZE | Не удалось переместить файл в многоуровневое хранилище, так как его размер файла меньше поддерживаемого размера. | Если версия агента меньше 9.0, то минимальный поддерживаемый размер файла — 64 КБ. Если версия агента — 9.0 и выше, то минимальный поддерживаемый размер файла зависит от размера кластера файловой системы и составляет два кластера файловой системы. Например, если размер кластера файловой системы равен 4 КБ, минимальный размер файла — 8 КБ. |
| 0x80c83007 | -2134364153 | ECS_E_STORAGE_ERROR | Не удалось переместить файл в многоуровневое хранилище из-за проблемы с хранилищем Azure. | Если ошибка повторяется, откройте запрос на поддержку. |
| 0x800703e3 | -2147023901 | ERROR_OPERATION_ABORTED | Не удалось переместить файл в многоуровневое хранилище, так как он был в это время отозван. | Действия не требуются. Файл будет распределяться по уровням после завершения отзыва, и он больше не используется. |
| 0x80c80264 | -2134375836 | ECS_E_GHOSTING_FILE_NOT_SYNCED | Не удалось переместить файл в многоуровневое хранилище, так как он не синхронизирован с общей папкой Azure. | Действия не требуются. Файл будет помещен в многоуровневое хранилище после синхронизации с общей папкой Azure. |
| 0x80070001 | -2147942401 | ERROR_INVALID_FUNCTION | Не удалось переместить файл в многоуровневое хранилище, так как не работает драйвер фильтра распределения по уровням в облаке (storagesync.sys). | Чтобы решить эту проблему, откройте командную строку с повышенными привилегиями и выполните следующую команду: `fltmc load storagesync`.<br>Если не удается загрузить драйвер фильтра storagesync при выполнении команды fltmc, удалите агент "Синхронизация файлов Azure", перезапустите сервер и переустановите агент "Синхронизация файлов Azure". |
| 0x80070070 | -2147024784 | ERROR_DISK_FULL | Не удалось переместить файл в многоуровневое хранилище из-за нехватки дискового пространства на томе, где расположена конечная точка сервера. | Чтобы устранить эту проблему, освободите по крайне мере 100 МБ дискового пространства на томе, где находится конечная точка сервера. |
| 0x80070490 | -2147023728 | ERROR_NOT_FOUND | Не удалось переместить файл в многоуровневое хранилище, так как он не синхронизирован с общей папкой Azure. | Действия не требуются. Файл будет помещен в многоуровневое хранилище после синхронизации с общей папкой Azure. |
| 0x80c80262 | -2134375838 | ECS_E_GHOSTING_UNSUPPORTED_RP | Не удалось переместить файл в многоуровневое хранилище из-за неподдерживаемой точки повторного анализа. | Если файл является точкой повторного анализа дедупликации данных, следуйте инструкциям в [руководстве по планированию](./storage-sync-files-planning.md#data-deduplication), чтобы включить поддержку дедупликации данных. Файлы с точками повторного анализа, отличными от точек повторного анализа дедупликации данных, не поддерживаются и не будут помещены в многоуровневое хранилище.  |
| 0x80c83052 | -2134364078 | ECS_E_CREATE_SV_STREAM_ID_MISMATCH | Не удалось переместить файл в многоуровневое хранилище, так как он был изменен. | Действия не требуются. Файл будет помещен в многоуровневое хранилище после синхронизации измененного файла с общей папкой Azure. |
| 0x80c80269 | -2134375831 | ECS_E_GHOSTING_REPLICA_NOT_FOUND | Не удалось переместить файл в многоуровневое хранилище, так как он не синхронизирован с общей папкой Azure. | Действия не требуются. Файл будет помещен в многоуровневое хранилище после синхронизации с общей папкой Azure. |
| 0x80072ee2 | -2147012894 | WININET_E_TIMEOUT | Не удалось переместить файл в многоуровневое хранилище из-за проблемы с сетью. | Действия не требуются. Если ошибка повторится, проверьте сетевое подключение к общей папке Azure. |
| 0x80c80017 | -2134376425 | ECS_E_SYNC_OPLOCK_BROKEN | Не удалось переместить файл в многоуровневое хранилище, так как он был изменен. | Действия не требуются. Файл будет помещен в многоуровневое хранилище после синхронизации измененного файла с общей папкой Azure. |
| 0x800705aa | -2147023446 | ERROR_NO_SYSTEM_RESOURCES | Не удалось переместить файл в многоуровневое хранилище из-за нехватки системных ресурсов. | Если ошибка повторится, выясните, какое приложение или драйвер режима ядра исчерпали системные ресурсы. |
| 0x8e5e03fe | — 1906441218 | JET_errDiskIO | Не удалось прослойировать файл из-за ошибки ввода-вывода при записи в базу данных уровня облака. | Если ошибка повторится, запустите на томе программу chkdsk и проверьте оборудование хранилища. |
| 0x8e5e0442 | — 1906441150 | JET_errInstanceUnavailable | Не удалось прослойировать файл, так как база данных уровней облака не запущена. | Чтобы устранить эту проблему, перезапустите службу FileSyncSvc или сервер. Если ошибка повторится, запустите на томе программу chkdsk и проверьте оборудование хранилища. |



### <a name="how-to-troubleshoot-files-that-fail-to-be-recalled"></a>Устранение неполадок в файлах, которые не удалось отозвать  
Если файлы не удалось отозвать:
1. В средстве "Просмотр событий" просмотрите журналы событий диагностики, операций и телеметрии, расположенные в папке Applications and Services\Microsoft\FileSync\Agent.
    1. Проверьте наличие файлов в файловом ресурсе Azure.
    2. Проверьте наличие подключения сервера к Интернету. 
    3. Откройте оснастку MMC служб и проверьте выполнение службы агента синхронизации хранилища (FileSyncSvc).
    4. Убедитесь, что драйверы фильтра службы "Синхронизация файлов Azure" (StorageSync.sys и StorageSyncGuard.sys) запущены.
        - В командной строке с повышенными привилегиями запустите `fltmc`. Убедитесь, что указаны драйверы StorageSync.sys и StorageSyncGuard.sys фильтра файловой системы.

> [!NOTE]
> Идентификатор события 9006 регистрируется один раз в час в журнале событий телеметрии при сбое отзыва файла (на один код ошибки регистрируется одно событие). Чтобы узнать, что можно сделать для исправления ошибки с тем или иным кодом, обратитесь к разделу [Ошибки отзыва и их исправление](#recall-errors-and-remediation).

### <a name="recall-errors-and-remediation"></a>Ошибки отзыва и их исправление

| HRESULT | HRESULT (десятичное число) | Строка ошибки | Проблема | Исправление |
|---------|-------------------|--------------|-------|-------------|
| 0x80070079 | -2147942521 | ERROR_SEM_TIMEOUT | Не удалось отозвать файл из-за истечения времени ожидания ввода-вывода. Эта проблема может возникнуть по нескольким причинам: ограничения ресурсов сервера, плохое сетевое подключение или проблема с хранилищем Azure (например, регулирование). | Действия не требуются. Если ошибка повторяется в течение нескольких часов, обратитесь в службу поддержки. |
| 0x80070036 | -2147024842 | ERROR_NETWORK_BUSY | Не удалось отозвать файл из-за проблемы с сетью.  | Если ошибка повторится, проверьте сетевое подключение к общей папке Azure. |
| 0x80c80037 | -2134376393 | ECS_E_SYNC_SHARE_NOT_FOUND | Не удалось отозвать файл, так как конечная точка сервера была удалена. | Чтобы решить эту проблему, см. раздел [Многоуровневые файлы недоступны на сервере после удаления конечной точки сервера](?tabs=portal1%252cazure-portal#tiered-files-are-not-accessible-on-the-server-after-deleting-a-server-endpoint). |
| 0x80070005 | -2147024891 | ERROR_ACCESS_DENIED | Не удалось отозвать файл из-за отказа в доступе. Эта проблема может возникнуть из-за того, что в учетной записи хранения включены параметры брандмауэра и виртуальной сети и у сервера нет доступа к учетной записи хранения. | Чтобы решить эту проблему, добавьте IP-адрес сервера или виртуальную сеть, выполнив действия, описанные в разделе [Настройка параметров брандмауэра и виртуальной сети](./storage-sync-files-deployment-guide.md?tabs=azure-portal#configure-firewall-and-virtual-network-settings) в руководстве по развертыванию. |
| 0x80c86002 | -2134351870 | ECS_E_AZURE_RESOURCE_NOT_FOUND | Не удалось отозвать файл, так как он недоступен в общей папке Azure. | Чтобы устранить проблему, убедитесь, что файл существует в общей папке Azure. Если файл существует в общей папке Azure, установите последнюю [версию агента](./storage-files-release-notes.md#supported-versions) синхронизации файлов Azure. |
| 0x80c8305f | -2134364065 | ECS_E_EXTERNAL_STORAGE_ACCOUNT_AUTHORIZATION_FAILED | Не удалось отозвать файл из-за сбоя авторизации в учетной записи хранения. | Чтобы решить эту проблему, убедитесь, что [Синхронизация файлов Azure имеет доступ к учетной записи хранения](?tabs=portal1%252cazure-portal#troubleshoot-rbac). |
| 0x80c86030 | -2134351824 | ECS_E_AZURE_FILE_SHARE_NOT_FOUND | Не удалось отозвать файл, так как общая папка Azure недоступна. | Убедитесь, что общая папка существует и доступна. Если общая папка была удалена и создана повторно, выполните действия, описанные в разделе [Не удалось выполнить синхронизацию, так как общая папка Azure была удалена и создана повторно](?tabs=portal1%252cazure-portal#-2134375810) для удаления и повторного создания группы синхронизации. |
| 0x800705aa | -2147023446 | ERROR_NO_SYSTEM_RESOURCES | Не удалось отозвать файл из-за нехватки системных ресурсов. | Если ошибка повторится, выясните, какое приложение или драйвер режима ядра исчерпали системные ресурсы. |
| 0x8007000e | -2147024882 | ERROR_OUTOFMEMORY | Не удалось отозвать файл из-за нехватки памяти. | Если ошибка повторится, выясните, какое приложение или драйвер режима ядра исчерпали память. |
| 0x80070070 | -2147024784 | ERROR_DISK_FULL | Не удалось отозвать файл из-за нехватки места на диске. | Чтобы устранить эту проблему, освободите место в томе. Для этого переместите файлы в другой том, увеличьте размер тома или переместите файлы в многоуровневое хранилище, выполнив командлет Invoke-StorageSyncCloudTiering. |

### <a name="tiered-files-are-not-accessible-on-the-server-after-deleting-a-server-endpoint"></a>Многоуровневые файлы недоступны на сервере после удаления конечной точки сервера
Многоуровневые файлы на сервере станут недоступными для использования, если их не отозвать перед удалением конечной точки сервера.

Ошибки, регистрируемые при недоступности многоуровневых файлов
- При синхронизации файла в журнале событий ItemResults появляется код ошибки -2147942467 (0x80070043-ERROR_BAD_NET_NAME)
- При отзыве файла в журнале событий ItemResults появляется код ошибки -2134376393 (0x80c80037-ECS_E_SYNC_SHARE_NOT_FOUND).

Восстановление доступа к многоуровневым файлам возможно, если выполняются следующие условия:
- конечная точка сервера удалена менее, чем 30 дней назад;
- облачная конечная точка не была удалена; 
- общая папка не была удалена;
- группа синхронизации не была удалена.

Если указанные выше условия выполнены, вы сможете в течение 30 дней восстановить доступ к файлам на сервере, повторно создав конечную точку сервера с тем же путем на сервере и в той же группе синхронизации. 

Если приведенные выше условия не выполнены, восстановление доступа невозможно, так как многоуровневые файлы на сервере уже стали потерянными. Следуйте приведенным ниже инструкциям, чтобы удалить потерянные многоуровневые файлы.

**Примечания**
- Если многоуровневые файлы недоступны на сервере, полный файл по-прежнему должен быть доступен, если вы напрямую обращаетесь к общей папке Azure.
- Чтобы предотвратить появление потерянных многоуровневых файлов в будущем, при удалении конечной точки сервера выполните действия, описанные в разделе [Удаление конечной точки сервера](./storage-sync-files-server-endpoint.md#remove-a-server-endpoint).

<a id="get-orphaned"></a>**Получение списка потерянных многоуровневых файлов** 

1. Убедитесь, что у вас установлен агент службы "Синхронизация файлов Azure" версии 5.1 или более поздней.
2. Выполните следующие команды PowerShell, чтобы вывести список потерянных многоуровневых файлов:
```powershell
Import-Module "C:\Program Files\Azure\StorageSyncAgent\StorageSync.Management.ServerCmdlets.dll"
$orphanFiles = Get-StorageSyncOrphanedTieredFiles -path <server endpoint path>
$orphanFiles.OrphanedTieredFiles > OrphanTieredFiles.txt
```
3. Сохраните полученный файл OrphanTieredFiles.txt, если необходимо восстановить файлы из резервной копии после их удаления.

<a id="remove-orphaned"></a>**Удаление потерянных многоуровневых файлов** 

*Вариант 1. Удаление потерянных многоуровневых файлов*

Этот параметр удаляет потерянные многоуровневые файлы в Windows Server, но требует удаления конечной точки сервера, если она существует, из-за необходимости повторно создать ее по истечении 30 дней, или если она подключена к другой группе синхронизации. Если файлы обновляются в Windows Server или в общей папке Azure до повторного создания конечной точки сервера, возникнут конфликты файлов.

1. Убедитесь, что у вас установлен агент службы "Синхронизация файлов Azure" версии 5.1 или более поздней.
2. Создайте резервную копию общей папки Azure и расположения конечной точки сервера.
3. Удалите конечную точку сервера из группы синхронизации (если она существует), выполнив действия, описанные в разделе [Удаление конечной точки сервера](./storage-sync-files-server-endpoint.md#remove-a-server-endpoint).

> [!Warning]  
> Если конечная точка сервера не была удалена до использования командлета Remove-StorageSyncOrphanedTieredFiles, удаление потерянного многоуровневого файла на сервере приведет к удалению полного файла в общей папке Azure. 

4. Выполните следующие команды PowerShell, чтобы вывести список потерянных многоуровневых файлов:

```powershell
Import-Module "C:\Program Files\Azure\StorageSyncAgent\StorageSync.Management.ServerCmdlets.dll"
$orphanFiles = Get-StorageSyncOrphanedTieredFiles -path <server endpoint path>
$orphanFiles.OrphanedTieredFiles > OrphanTieredFiles.txt
```
5. Сохраните полученный файл OrphanTieredFiles.txt, если необходимо восстановить файлы из резервной копии после их удаления.
6. Выполните следующие команды PowerShell, чтобы удалить потерянные многоуровневые файлы:

```powershell
Import-Module "C:\Program Files\Azure\StorageSyncAgent\StorageSync.Management.ServerCmdlets.dll"
$orphanFilesRemoved = Remove-StorageSyncOrphanedTieredFiles -Path <folder path containing orphaned tiered files> -Verbose
$orphanFilesRemoved.OrphanedTieredFiles > DeletedOrphanFiles.txt
```
**Примечания** 
- Многоуровневые файлы, измененные на сервере, которые не синхронизированы с общей папкой Azure, будут удалены.
- Доступные (не потерянные) многоуровневые файлы не будут удалены.
- Не распределенные по уровням файлы останутся на сервере.

7. Необязательное действие: Повторно создайте конечную точку сервера, если она была удалена на шаге 3.

*Вариант 2. Подключите общую папку Azure и локально скопируйте файлы, потерянные на сервере*

Этот параметр не требует удаления конечной точки сервера, но ему нужно достаточно места на диске для локального копирования полных файлов.

1. [Подключите](./storage-how-to-use-files-windows.md) общую папку Azure на сервере под управлением Windows Server, где расположены потерянные многоуровневые файлы.
2. Выполните следующие команды PowerShell, чтобы вывести список потерянных многоуровневых файлов:
```powershell
Import-Module "C:\Program Files\Azure\StorageSyncAgent\StorageSync.Management.ServerCmdlets.dll"
$orphanFiles = Get-StorageSyncOrphanedTieredFiles -path <server endpoint path>
$orphanFiles.OrphanedTieredFiles > OrphanTieredFiles.txt
```
3. Используйте полученный файл OrphanTieredFiles.txt, чтобы найти потерянные многоуровневые файлы на сервере.
4. Перезапишите потерянные многоуровневые файлы, скопировав полный файл из общей папки Azure в Windows Server.

### <a name="how-to-troubleshoot-files-unexpectedly-recalled-on-a-server"></a>Устранение неполадок с файлами, непредвиденно отозванными на сервере  
Антивирусные программы, приложения архивации, а также другие приложения, которые считывают большое количество файлов, вызывают непреднамеренные отзывы, если они не учитывают автономный атрибут пропуска и пропускают чтение содержимого этих файлов. Пропуск автономных файлов для продуктов, поддерживающих эту возможность, позволяет избежать непреднамеренных отзывов во время операций, таких как антивирусные проверки или задания резервного копирования.

Обратитесь к поставщику программного обеспечения за информацией о том, как настроить решение, чтобы пропустить чтение автономных файлов.

Непреднамеренные отзывы также могут возникать в других сценариях, например при просмотре файлов в проводнике. Открытие папки с облачными многоуровневыми файлами в проводнике может привести к непреднамеренным отзывам на сервере. Это еще более вероятно, если на сервере включено антивирусное решение.

> [!NOTE]
>Чтобы определить, какие приложения вызывают отзывы, используйте идентификатор события 9059 в журнале событий телеметрии. Это событие обеспечивает распределение ошибок отзыва приложения для конечной точки сервера и регистрируется каждый час.

### <a name="tls-12-required-for-azure-file-sync"></a>Для службы "Синхронизация файлов Azure" требуется TLS 1.2

Вы можете посмотреть параметры TLS на сервере в [параметрах реестра](/windows-server/security/tls/tls-registry-settings). 

Если вы используете прокси-сервер, обратитесь к документации прокси-сервера и убедитесь, что он использует TLS 1.2.

## <a name="general-troubleshooting"></a>Общие действия по устранению неполадок
При возникновении проблем на сервере со службой синхронизации файлов Azure для начала сделайте следующее:
1. В средстве "Просмотр событий" просмотрите журналы событий диагностики, операций и телеметрии.
    - Проблемы синхронизации, распределения по уровням и отзывов записываются в журналы событий диагностики, операций и телеметрии, которые расположены в папке Applications and Services\Microsoft\FileSync\Agent.
    - Проблемы, связанные с управлением сервером (например, параметры конфигурации), записываются в журналы событий диагностики и операций, которые расположены в папке Applications and Services\Microsoft\FileSync\Management.
2. Убедитесь, что служба "Синхронизация файлов Azure" выполняется на сервере.
    - Откройте оснастку MMC "Службы" и убедитесь, что выполняется служба агента синхронизации хранилища (FileSyncSvc).
3. Убедитесь, что драйверы фильтра службы "Синхронизация файлов Azure" (StorageSync.sys и StorageSyncGuard.sys) запущены.
    - В командной строке с повышенными привилегиями запустите `fltmc`. Убедитесь, что указаны драйверы StorageSync.sys и StorageSyncGuard.sys фильтра файловой системы.

Если проблема не устранена, запустите средство AFSDiag и отправьте его выходные данные в виде ZIP-файла инженеру службы поддержки, назначенному для дальнейшей диагностики вашего случая.

Чтобы запустить AFSDiag, выполните следующие действия.

Для агента версии версии 11 и более поздних версий:
1. Откройте окно PowerShell, а затем выполните следующие команды (нажимайте клавишу ВВОД после каждой команды).

    > [!NOTE]
    >Перед сбором журналов AFSDiag создаст выходной каталог и временную папку в нем, а после выполнения удалит эту папку. Укажите расположение для сохранения выходной информации, которое не содержит данных.
    
    ```powershell
    cd "c:\Program Files\Azure\StorageSyncAgent"
    Import-Module .\afsdiag.ps1
    Debug-AFS -OutputDirectory C:\output -KernelModeTraceLevel Verbose -UserModeTraceLevel Verbose
    ```

2. Воспроизведите проблему. После завершения введите **D**.
3. ZIP-файл, содержащий журналы и файлы трассировки, сохраняется в указанном вами каталоге выходных данных. 

Для агента версии V10 и более ранних версий:
1. Создайте каталог (например, C:\Output), в котором будут сохранены выходные данные средства AFSDiag.
    > [!NOTE]
    >Перед сбором журналов AFSDiag удалит все содержимое в выходном каталоге. Укажите расположение для сохранения выходной информации, которое не содержит данных.
2. Откройте окно PowerShell, а затем выполните следующие команды (нажимайте клавишу ВВОД после каждой команды).

    ```powershell
    cd "c:\Program Files\Azure\StorageSyncAgent"
    Import-Module .\afsdiag.ps1
    Debug-Afs c:\output # Note: Use the path created in step 1.
    ```

3. Для службы синхронизации файлов Azure в режиме ядра на уровне трассировки введите **1** (если не указано создание дополнительных подробных трассировок) и нажмите клавишу ВВОД.
4. Для службы синхронизации файлов Azure в пользовательском режиме на уровне трассировки введите **1** (если не указано создание дополнительных подробных трассировок) и нажмите клавишу ВВОД.
5. Воспроизведите проблему. После завершения введите **D**.
6. ZIP-файл, содержащий журналы и файлы трассировки, сохраняется в указанном вами каталоге выходных данных.


## <a name="see-also"></a>См. также раздел
- [Мониторинг Синхронизации файлов Azure](storage-sync-files-monitoring.md)
- [Часто задаваемые вопросы о службе "Файлы Azure"](storage-files-faq.md)
- [Устранение неполадок службы файлов Azure в Windows](storage-troubleshoot-windows-file-connection-problems.md)
- [Устранение неполадок службы файлов Azure в Linux](storage-troubleshoot-linux-file-connection-problems.md)