---
title: Планирование развертывания службы "Синхронизация файлов Azure" | Документация Майкрософт
description: Спланируйте развертывание с помощью Синхронизация файлов Azure, службы, которая позволяет кэшировать несколько файловых ресурсов Azure на локальном сервере Windows Server или облачной виртуальной машине.
author: roygara
ms.service: storage
ms.topic: conceptual
ms.date: 01/15/2020
ms.author: rogarana
ms.subservice: files
ms.custom: references_regions
ms.openlocfilehash: cfeb124aeb614906cef1dc710eb8485e63806539
ms.sourcegitcommit: aaa65bd769eb2e234e42cfb07d7d459a2cc273ab
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/27/2021
ms.locfileid: "98880581"
---
# <a name="planning-for-an-azure-file-sync-deployment"></a>Планирование развертывания службы синхронизации файлов Azure

:::row:::
    :::column:::
        [![Интервью и демо по Синхронизации файлов Azure — нажмите для воспроизведения.](./media/storage-sync-files-planning/azure-file-sync-interview-video-snapshot.png)](https://www.youtube.com/watch?v=nfWLO7F52-s)
    :::column-end:::
    :::column:::
        Синхронизация файлов Azure — это служба, которая позволяет кэшировать несколько файловых ресурсов Azure на локальном сервере Windows Server или облачной виртуальной машине. 
        
        В этой статье рассказывается о концепциях и возможностях Синхронизации файлов Azure. Когда вы узнаете больше о Синхронизации файлов Azure, ознакомьтесь с [руководством по развертыванию Синхронизации файлов Azure](storage-sync-files-deployment-guide.md), чтобы испытать эту службу.        
    :::column-end:::
:::row-end:::

Файлы будут храниться в облаке в [файловых ресурсах Azure](storage-files-introduction.md). Файловые ресурсы Azure можно использовать двумя способами: путем прямого подключения этих бессерверных файловых ресурсов Azure (SMB) или путем кэширования файловых ресурсов Azure в локальной среде с помощью Синхронизация файлов Azure. От выбора варианта развертывания зависят факторы, которые необходимо учитывать при планировании развертывания. 

- **Прямое подключение к файловому ресурсу Azure**: так как служба "Файлы Azure" предоставляет доступ к SMB, вы можете подключать файловые ресурсы Azure локально или в облаке с помощью стандартного клиента SMB, доступного в Windows, macOS и Linux. Так как файловые ресурсы Azure являются бессерверными, развертывание для рабочих сценариев не требует управления файловым сервером или устройством NAS. Это означает, что вам не нужно применять исправления программного обеспечения или подключать физические диски. 

- **Кэширование файлового ресурса Azure локально с помощью Синхронизации файлов Azure**: вы можете использовать службу Синхронизации файлов Azure, чтобы централизованно хранить файловые ресурсы организации в службе файлов Azure, обеспечивая гибкость, производительность и совместимость локального файлового сервера. Это достигается путем преобразования локального или облачного Windows Server в быстрый кэш файлового ресурса Azure. 

## <a name="management-concepts"></a>Основные принципы управления
Развертывание Синхронизации файлов Azure связано с тремя фундаментальными управляющими объектами:

- **Файловый ресурс Azure**. Файловый ресурс Azure — это бессерверный облачный файловый ресурс, который предоставляет *облачную конечную точку* для синхронизации в Синхронизации файлов Azure. Доступ к файлам в файловом ресурсе Azure можно получить напрямую по протоколу SMB или FileREST, хотя мы рекомендуем в основном обращаться к файлам через кэш Windows Server, когда файловый ресурс Azure используется с Синхронизацией файлов Azure. Это связано с тем, что на сегодняшний день в службе "Файлы Azure" отсутствует эффективный механизм обнаружения изменений, например Windows Server, поэтому изменения в файловом ресурсе Azure будут распространяться обратно на конечные точки сервера.
- **Конечная точка сервера**. Путь на Windows Server, который синхронизируется с файловым ресурсом Azure. Это может быть конкретная папка на томе или корень тома. В томе может располагаться несколько конечных точек сервера, если их пространства имен не перекрываются.
- **Группа синхронизации**. Объект, определяющий отношение синхронизации между **облачной конечной точкой** или файловым ресурсом Azure, а также конечной точкой сервера. Конечные точки в группе синхронизации синхронизируются. Если, например, есть два отдельных набора файлов, которыми можно управлять с помощью службы "Синхронизация файлов Azure", следует создать две группы синхронизации и добавить различные конечные точки для каждой.

### <a name="azure-file-share-management-concepts"></a>Основные понятия управления файловым ресурсом Azure
[!INCLUDE [storage-files-file-share-management-concepts](../../../includes/storage-files-file-share-management-concepts.md)]

### <a name="azure-file-sync-management-concepts"></a>Основные понятия управления в Синхронизации файлов Azure
Группы синхронизации развертываются в **службах синхронизации хранилища**, являющихся объектами верхнего уровня, которые регистрируют серверы для использования с Синхронизацией файлов Azure и содержат связи группы синхронизации. Ресурс службы синхронизации хранилища является одноранговым в отношении ресурса учетной записи хранения, поэтому его можно развернуть в группах ресурсов Azure. Служба синхронизации хранилища может создавать группы синхронизации, содержащие файловые ресурсы Azure в нескольких учетных записях хранения и нескольких зарегистрированных серверах Windows Server.

Прежде чем можно будет создать группу синхронизации в службе синхронизации хранилища, необходимо сначала зарегистрировать Windows Server в службе синхронизации хранилища. Будет создан объект **зарегистрированный сервер**, который представляет собой отношение доверия между сервером или кластером и службой синхронизации хранилища. Чтобы зарегистрировать службу синхронизации хранилища, необходимо сначала установить агент Синхронизации файлов Azure на сервере. Отдельный сервер или кластер можно зарегистрировать только в одной службе синхронизации хранилища.

Группа синхронизации содержит одну облачную конечную точку, файловый ресурс Azure и хотя бы одну конечную точку сервера. Объект конечной точки сервера содержит параметры, которые настраивают **распределение по уровням в облаке** для кэширования в Синхронизации файлов Azure. Для синхронизации с файловым ресурсом Azure учетная запись хранения, содержащая файловый ресурс Azure, должна находиться в том же регионе Azure, что и служба синхронизации хранилища.

> [!Important]  
> В группе синхронизации можно внести изменения в любую облачную конечную точку или конечную точку сервера в группе синхронизации и синхронизировать файлы в другие конечные точки. Если вы вносите изменения непосредственно в облачную конечную точку (общий файловый ресурс Azure), эти изменения сначала должны быть определены заданием обнаружения изменений службы "Синхронизация файлов Azure". Задание обнаружения изменений инициируется для облачной конечной точки каждые 24 часа. Дополнительные сведения см. в статье [Часто задаваемые вопросы о службе файлов Azure](storage-files-faq.md#afs-change-detection).

### <a name="management-guidance"></a>Руководство по управлению
При развертывании Синхронизации файлов Azure рекомендуется:

- Развертывание файловых ресурсов Azure 1:1 с файловыми ресурсами Windows. Объект конечной точки сервера обеспечивает высокую степень гибкости настройки топологии синхронизации на стороне сервера в отношении синхронизации. Чтобы упростить управление, необходимо, чтобы путь к конечной точке сервера совпадал с путем к файловому ресурсу Windows. 

- Использование минимального числа служб синхронизации хранилища. Это упростит управление при наличии групп синхронизации, содержащих несколько конечных точек сервера, так как Windows Server можно зарегистрировать только в одной службе синхронизации хранилища за раз. 

- Контроль ограничений операций ввода-вывода в секунду в учетной записи хранения при развертывании файловых ресурсов Azure. В идеале следует сопоставлять файловые ресурсы 1:1 с учетными записями хранения, однако это не всегда возможно в связи с различными ограничениями как в организации, так и в Azure. Если невозможно развернуть только один файловый ресурс в одной учетной записи хранения, определите, какие файловые ресурсы будут высоко активными, а какие — менее активными, чтобы не допустить одновременного размещения самых горячих файловых ресурсов в одной учетной записи хранения.

## <a name="windows-file-server-considerations"></a>Рекомендации по файловому серверу Windows
Чтобы включить функцию синхронизации в Windows Server, необходимо установить загружаемый агент Синхронизации файлов Azure. Агент Синхронизации файлов Azure предоставляет два основных компонента: `FileSyncSvc.exe`, фоновую службу Windows, ответственную за мониторинг изменений в конечных точках сервера и инициацию сеансов синхронизации, а также `StorageSync.sys`, фильтр файловой системы, обеспечивающий распределение по уровням в облаке и быстрое аварийное восстановление.  

### <a name="operating-system-requirements"></a>Требования к операционной системе
Синхронизация файлов Azure поддерживается в следующих версиях Windows Server:

| Версия | Поддерживаемые номера SKU | Поддерживаемые варианты развертывания |
|---------|----------------|------------------------------|
| Windows Server 2019 | Центр обработки данных, Стандартный и Интернет вещей | Полный и базовый |
| Windows Server 2016 | Центр обработки данных, Стандартный и Сервер хранения | Полный и базовый |
| Windows Server 2012 R2 | Центр обработки данных, Стандартный и Сервер хранения | Полный и базовый |

Новые версии Windows Server будут добавляться по мере их выпуска.

> [!Important]  
> Мы рекомендуем постоянно обновлять серверы, используемые со службой синхронизации файлов Azure, с помощью последних обновлений из Центра обновления Windows. 

### <a name="minimum-system-resources"></a>Минимальные системные ресурсы
Для Синхронизации файлов Azure требуется сервер, физический или виртуальный, по крайней мере с одним ЦП и минимум 2 ГиБ памяти.

> [!Important]  
> Если сервер выполняется на виртуальной машине с включенной динамической памятью, в виртуальной машине должна быть настроена память объемом не менее 2048 МиБ.

Для большинства рабочих нагрузок не рекомендуется настраивать сервер Синхронизации файлов Azure Sync только с минимальными требованиями. Дополнительные сведения см. в разделе [Рекомендуемые системные ресурсы](#recommended-system-resources).

### <a name="recommended-system-resources"></a>Рекомендуемые системные ресурсы
Как и для любого серверного компонента или приложения, требования к системным ресурсам для Синхронизации файлов Azure определяются масштабом развертывания — для более крупных развертываний на сервере требуются большие системные ресурсы. Для Синхронизации файлов Azure масштаб определяется количеством объектов в конечных точках сервера и изменением набора данных. Один сервер может иметь конечные точки в нескольких группах синхронизации и объектах, перечисленных в следующей таблице, для учетных записей для полного пространства имен, к которому подключен сервер. 

Например, конечная точка сервера A с 10 млн объектов + конечная точка сервера B с 10 млн объектов = 20 млн объектов. Для этого примера развертывания мы рекомендуем 8 ЦП, 16 ГиБ памяти для стабильного состояния и (если возможно) 48 ГиБ памяти для первоначальной миграции.
 
Данные пространства имен хранятся в памяти в целях повышения производительности. Из-за этого большие пространства имен требуют больше памяти для поддержания хорошей производительности, а для большего количества обновлений требуется больше ресурсов ЦП. 
 
В следующей таблице указан размер пространства имен и преобразование в емкость для типичных файловых ресурсов общего назначения, где средний размер файла — 512 КиБ. Если ваши файлы меньше, рекомендуется добавить дополнительную память для того же объема емкости. Настраивайте конфигурацию памяти на основе размера пространства имен.

| Размер пространства имен — файлы и каталоги (миллионы)  | Типичная емкость (ТиБ)  | Ядра ЦП  | Рекомендуемая память (ГиБ) |
|---------|---------|---------|---------|
| 3        | 1.4     | 2        | 8 (начальная синхронизация)/2 (типичное обновление)      |
| 5        | 2.3     | 2        | 16 (начальная синхронизация)/4 (типичное обновление)    |
| 10       | 4,7     | 4        | 32 (начальная синхронизация)/8 (типичное обновление)   |
| 30       | 14,0    | 8        | 48 (начальная синхронизация)/16 (типичное обновление)   |
| 50       | 23,3    | 16       | 64 (начальная синхронизация)/32 (типичное обновление)  |
| 100*     | 46,6    | 32       | 128 (начальная синхронизация)/32 (типичное обновление)  |

\*В настоящее время не рекомендуется выполнять синхронизацию более 100 млн файлов и каталогов. Это нестрогое ограничение, основанное на проверенных пороговых значениях. Дополнительные сведения см. в статье [Целевые показатели масштабируемости и производительности Файлов Azure](storage-files-scale-targets.md#azure-file-sync-scale-targets).

> [!TIP]
> Начальная синхронизация пространства имен является трудоемкой операцией, поэтому рекомендуется выделить больше памяти до ее завершения. Это не обязательно, но может ускорить начальную синхронизацию. 
> 
> Обычное обновление составляет 0,5 % от изменения пространства имен в день. Для более высоких уровней обновления рекомендуется добавить ЦП. 

- Локально подключенный том, отформатированный с помощью файловой системы NTFS.

### <a name="evaluation-cmdlet"></a>Командлет оценки
Прежде чем развертывать службу "Синхронизация файлов Azure", следует оценить, совместима ли она с вашей системой, с помощью командлета оценки этой службы. Этот командлет проверяет наличие потенциальных проблем с файловой системой и набором данных, таких как неподдерживаемые символы или неподдерживаемая версия операционной системы. Проверки охватывают большинство, но не все возможности, описанные ниже. Мы рекомендуем прочесть всю оставшуюся часть этого раздела очень внимательно, чтобы осуществить развертывание надлежащим образом. 

Командлет оценки можно установить, установив модуль Az PowerShell, следуя приведенным ниже инструкциям. [Установите и настройте Azure PowerShell](/powershell/azure/install-Az-ps).

#### <a name="usage"></a>Использование  
Средство оценки можно вызывать несколькими способами: можно выполнять системные проверки, проверки набора данных или и то, и другое. Выполнение проверки системы и набора данных: 

```powershell
Invoke-AzStorageSyncCompatibilityCheck -Path <path>
```

Проверка только набора данных:
```powershell
Invoke-AzStorageSyncCompatibilityCheck -Path <path> -SkipSystemChecks
```
 
Проверка только системных требований:
```powershell
Invoke-AzStorageSyncCompatibilityCheck -ComputerName <computer name> -SkipNamespaceChecks
```
 
Отображение результатов в CSV-файле:
```powershell
$validation = Invoke-AzStorageSyncCompatibilityCheck C:\DATA
$validation.Results | Select-Object -Property Type, Path, Level, Description, Result | Export-Csv -Path C:\results.csv -Encoding utf8
```

### <a name="file-system-compatibility"></a>Совместимые файловые системы
Синхронизация файлов Azure поддерживается только для непосредственно подключенных томов NTFS. Непосредственно подключенное хранилище (DAS) в Windows Server означает, что эта файловая система принадлежит операционной системе Windows Server. DAS можно предоставить с помощью физического подключения дисков к файловому серверу, присоединив виртуальные диски к виртуальной машине файлового сервера (например, к виртуальной машине, размещенной на Hyper-V) или даже через ISCSI.

Поддерживаются только тома NTFS; ReFS, FAT, FAT32 и другие файловые системы не поддерживаются.

В следующей таблице показано состояние взаимодействия функций файловой системы NTFS. 

| Компонент | Состояние поддержки | Примечания |
|---------|----------------|-------|
| Списки управления доступом (ACL) | полностью поддерживается. | Списки управления доступом в стиле Windows сохраняются службой "Синхронизация файлов Azure" и принудительно используются Windows Server для конечных точек сервера. Списки управления доступом также можно применять при непосредственном подключении файлового ресурса Azure, однако для этого требуется дополнительная настройка. Дополнительные сведения см. в разделе об [идентификаторах](#identity). |
| Жесткие связи. | Пропущено | |
| Символические связи | Пропущено | |
| Точки подключения | Поддерживается частично | Точки подключения могут располагаться в корне конечной точки сервера, но они пропускаются, если содержатся в пространстве имен конечной точки сервера. |
| Соединения | Пропущено | Например, папки DfrsrPrivate и DFSRoots распределенной файловой системы. |
| Точки повторного анализа | Пропущено | |
| Сжатие NTFS | полностью поддерживается. | |
| Разреженные файлы | полностью поддерживается. | Разреженные файлы синхронизируются (не блокируются) в облако в качестве полного файла. При изменении содержимого файла в облаке (или на другом сервере) он перестанет быть разреженным, когда скачана измененная версия. |
| Альтернативные потоки данных (ADS) | Сохраняются, но не синхронизируются | Например, теги классификации, созданные инфраструктурой классификации файлов, не синхронизируются. Имеющиеся теги классификации для файлов в каждой из конечных точек сервера использоваться не будут. |

<a id="files-skipped"></a>Синхронизация файлов Azure также будет пропускать некоторые временные файлы и системные папки:

| Файл или папка | Примечание |
|-|-|
| pagefile.sys | Системный файл |
| Desktop.ini | Системный файл |
| thumbs.db; | Временный файл для эскизов |
| ehthumbs.db; | Временный файл для эскизов мультимедиа |
| ~$\*.\* | Временный файл Office |
| \*.tmp; | Временный файл |
| \*.laccdb; | Файл блокировки базы данных Access|
| 635D02A9D91C401B97884B82B3BCDAEA.* | Внутренний файл синхронизации|
| \\System Volume Information | Папка для тома |
| $RECYCLE.BIN| Папка |
| \\SyncShareState | Папка для синхронизации |

### <a name="failover-clustering"></a>Отказоустойчивая кластеризация
Служба синхронизации файлов Azure поддерживает отказоустойчивую кластеризацию Windows Server для варианта развертывания "Файловый сервер общего использования". Отказоустойчивая кластеризация не поддерживается в вариантах "Масштабируемый файловый сервер для данных приложения" (SOFS) или в общих томах кластеров (CSV).

> [!Note]  
> Агент службы синхронизации файлов Azure должен быть установлен на каждом узле отказоустойчивого кластера для правильной работы синхронизации.

### <a name="data-deduplication"></a>Дедупликация данных
**Windows Server 2016 и Windows Server 2019**   
Дедупликация данных поддерживается в томах с включенным распределением по уровням в облаке в Windows Server 2016 и Windows Server 2019. Включив дедупликацию данных в томе с включенным распределением по уровням в облаке, вы можете кэшировать больше файлов локально без выделения дополнительного объема памяти. 

Если дедупликация данных включена на томе с включенным распределением по уровням в облаке, оптимизированные файлы дедупликации в расположении конечной точки сервера будут распределены по аналогии с обычными файлами на основе параметров политики распределения по уровням в облаке. После того как оптимизированные для дедупликации файлы будут распределены по уровням, задание сбора мусора для дедупликации данных автоматически запустится, чтобы освободить место на диске, удалив ненужные блоки, на которые больше не ссылаются другие файлы в томе.

Обратите внимание, что экономия емкости применяется только к серверу; данные в файловом ресурсе Azure не будут дедуплицироваться.

> [!Note]  
> Для поддержки дедупликации данных на томах с включенным распределением по уровням в облаке в Windows Server 2019 необходимо установить обновление Windows [KB4520062](https://support.microsoft.com/help/4520062) и агент Синхронизации файлов Azure версии 9.0.0.0 или более поздней.

**Windows Server 2012 R2**  
Синхронизация файлов Azure не поддерживает дедупликацию данных и распределение по уровням в облаке на одном томе в Windows Server 2012 R2. Если дедупликация данных включена на томе, необходимо отключить распределение по уровням в облаке. 

**Примечания**
- Если дедупликация данных установлена до установки агента Синхронизации файлов Azure, для поддержки дедупликации данных и распределения по уровням в облаке на том же томе требуется перезагрузка.
- Если дедупликация данных включена на томе после включения распределения по уровням в облаке, начальное задание оптимизации дедупликации оптимизирует файлы на томе, который еще не распределен по уровням, и будет иметь следующее влияние на распределение по уровням в облаке:
    - Политика свободного места будет по-прежнему распределять файлы по уровням в соответствии с объемом свободного пространства на томе с помощью тепловой карты.
    - Политика даты пропускает распределение по уровням для файлов, которые в ином случае могли бы распределяться, в связи с тем что задание оптимизации дедупликации обращается к этим файлам.
- Для текущих заданий оптимизации дедупликации распределение по уровням в облаке с применением политики дат будет отложено параметром дедупликации [MinimumFileAgeDays](/powershell/module/deduplication/set-dedupvolume?view=win10-ps), если файл еще не распределен по уровням. 
    - Пример Если значение параметра MinimumFileAgeDays составляет семь дней, а политики даты облачного распределения — 30 дней, политика дат будет распределять файлы по прошествии 37 дней.
    - Примечание. После того как файл распределен по уровням службой Синхронизации файлов Azure, задание оптимизации дедупликации пропускает этот файл.
- Если сервер под управлением Server 2012 R2 с установленным агентом Синхронизации файлов Azure обновляется до Windows Server 2016 или Windows Server 2019, для поддержки дедупликации данных и распределения по уровням в облаке на одном томе необходимо выполнить следующие действия.  
    - Удалите агент Синхронизации файлов Azure для Windows Server 2012 R2 и перезапустите сервер.
    - Скачайте агент Синхронизации файлов Azure для новой версии операционной системы сервера (Windows Server 2016 или Windows Server 2019).
    - Установите агент Синхронизации файлов Azure и перезапустите сервер.  
    
    Примечание. Параметры конфигурации Синхронизации файлов Azure на сервере сохраняются при удалении и повторной установке агента.

### <a name="distributed-file-system-dfs"></a>Распределенная файловая система (DFS)
Служба "Синхронизация файлов Azure" поддерживает взаимодействие с пространствами имен DFS (DFS-N) и репликацией DFS (DFS-R).

**Пространства имен DFS (DFS-N)** . Служба "Синхронизация файлов Azure" полностью поддерживается для серверов DFS-N. Вы можете установить агент службы "Синхронизация файлов Azure" на один или несколько членов DFS-N, чтобы синхронизировать данные между конечными точками сервера и облачными конечными точками. Дополнительные сведения см. в статье [Обзор пространств имен DFS](/windows-server/storage/dfs-namespaces/dfs-overview).
 
**Репликация DFS (DFS-R)** . Так как DFS-R и служба "Синхронизация файлов Azure" выполняют аналогичные функции (репликацию), в большинстве случаев мы рекомендуем полностью заменить DFS-R синхронизацией файлов Azure. Но есть несколько сценариев, в которых DFS-R и службу "Синхронизация файлов Azure" есть смысл использовать вместе.

- Если выполняется миграция с развернутой службы DFS-R в развернутую службу "Синхронизация файлов Azure". Дополнительные сведения см. в статье [Развертывание службы синхронизации файлов Azure (предварительная версия)](storage-sync-files-deployment-guide.md#migrate-a-dfs-replication-dfs-r-deployment-to-azure-file-sync).
- Если нет возможности подключить к Интернету напрямую каждый локальный сервер, на котором нужны копии файлов данных.
- Если серверы подразделений консолидируют данные на одном сервере-концентраторе, для которого вы намерены использовать службу "Синхронизация файлов Azure".

Если служба "Синхронизация файлов Azure" и DFS-R работают параллельно, следует учесть следующее.

1. В службе "Синхронизация файлов Azure" нужно отключить распределение по уровням облака для томов, на которых есть реплицируемые DFS-R папки.
2. Не следует настраивать конечные точки сервера для папок репликации DFS-R с доступом только для чтения.

Дополнительные сведения см. в статье [Обзор пространств имен DFS и репликации DFS](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj127250(v=ws.11)).

### <a name="sysprep"></a>Средство Sysprep
Использование средства sysprep на сервере, где установлен агент службы "Синхронизация файлов Azure", не поддерживается и может привести к непредвиденным результатам. Устанавливать агент и регистрировать сервер нужно после развертывания образа сервера и завершения мини-установки sysprep.

### <a name="windows-search"></a>Windows Search
Если на конечной точке сервера включено распределение по уровням облака, распределяемые по уровням файлы пропускаются и не индексируются службой Windows Search. Файлы, не распределяемые по уровням, индексируются должным образом.

### <a name="other-hierarchical-storage-management-hsm-solutions"></a>Другие решения по управлению иерархическим хранением (HSM)
Другие решения HSM не нужно использовать со службой синхронизации файлов Azure.

## <a name="identity"></a>Идентификация
Синхронизация файлов Azure работает со стандартным удостоверением на основе AD без специальной настройки, помимо настройки синхронизации. При использовании Синхронизации файлов Azure ожидается, что большинство обращений проходят через серверы кэширования Синхронизации файлов Azure, а не через файловый ресурс Azure. Так как конечные точки сервера находятся в Windows Server, а Windows Server уже давно поддерживает списки ACL в стиле AD и Windows, остается только убедиться, что файловые серверы Windows, зарегистрированные в службе синхронизации хранилища, присоединены к домену. Синхронизация файлов Azure сохранит списки управления доступом для файлов в файловом ресурсе Azure и будет реплицировать их во все конечные точки сервера.

Несмотря на то что изменения, внесенные непосредственно в файловый ресурс Azure, дольше синхронизируются с конечными точками сервера в группе синхронизации, рекомендуется принудительно применять разрешения AD для файлового ресурса непосредственно в облаке. Для этого необходимо присоединить учетную запись хранения к локальной службе AD, как файловые серверы Windows присоединены к домену. Дополнительные сведения о присоединении учетной записи хранения к домену Active Directory, принадлежащему клиенту, см. в разделе [Обзор Active Directory Файлов Azure](storage-files-active-directory-overview.md).

> [!Important]  
> Присоединение учетной записи хранения к домену Active Directory не требуется для успешного развертывания Синхронизации файлов Azure. Это необязательный шаг, который позволяет файловому ресурсу Azure применять локальные списки управления доступом, когда пользователи напрямую подключаются к файловому ресурсу Azure.

## <a name="networking"></a>Сеть
Агент Синхронизации файлов Azure взаимодействует с вашей службой синхронизации хранилища и файловым ресурсом Azure с помощью протокола Синхронизации файлов Azure REST и протокола FileREST, оба из которых всегда используют HTTPS через порт 443. SMB никогда не используется для отправки или загрузки данных между сервером Windows Server и файловым ресурсом Azure. Так как большинство организаций разрешают трафик по протоколу HTTPS через порт 443 в качестве требования для посещения большинства веб-сайтов, специальная настройка сети обычно не требуется для развертывания Синхронизации файлов Azure.

В зависимости от политики или уникальных нормативных требований организации вам может потребоваться более ограниченный обмен данными с Azure. Поэтому Синхронизация файлов Azure предоставляет несколько механизмов настройки сети. В зависимости от требований вам доступны следующие возможности.

- Синхронизация туннеля и трафика передачи/загрузки файлов через сеть ExpressRoute или Azure VPN. 
- Использование функций Файлов Azure и Сети Azure, таких как конечные точки служб и частные конечные точки.
- Настройка Синхронизации файлов Azure для поддержки прокси-сервера в вашей среде.
- Регулирование сетевой активности в Синхронизации файлов Azure.

Дополнительные сведения о Синхронизация файлов Azure и работе в сети см. в статье [Синхронизация файлов Azure рекомендации по сетям](storage-sync-files-networking-overview.md).

## <a name="encryption"></a>Шифрование
При использовании Синхронизации файлов Azure существует три разных уровня шифрования: шифрование при хранении в Windows Server, шифрование при передаче между агентом Синхронизации файлов Azure и Azure и шифрование данных при хранении в файловом ресурсе Azure. 

### <a name="windows-server-encryption-at-rest"></a>Шифрование при хранении в Windows Server 
Существуют две стратегии шифрования данных на сервере Windows Server, которые обычно подходят для Синхронизации файлов Azure: шифрование под файловой системой, так что файловая система и все данные, записанные в нее, шифруются, и шифрование в самом формате файла. Эти методы не исключают друг друга. При необходимости их можно использовать совместно, так как цель шифрования отличается.

Чтобы обеспечить шифрование под файловой системой, Windows Server предоставляет входящую папку BitLocker. BitLocker полностью прозрачен для Синхронизации файлов Azure. Основная причина использования механизма шифрования, такого как BitLocker, заключается в предотвращении физической утечки данных из локального центра обработки данных путем кражи дисков и защите от передачи на устройства неавторизованных ОС для выполнения несанкционированного чтения и записи данных. Дополнительные сведения о BitLocker см. в статье [Обзор BitLocker](/windows/security/information-protection/bitlocker/bitlocker-overview).

Сторонние продукты, которые похожи на BitLocker тем, что находятся под томом NTFS, должны также полностью прозрачно работать с Синхронизацией файлов Azure. 

Другим основным методом шифрования данных является шифрование потока данных файла, когда приложение сохраняет файл. Некоторые приложения могут делать это в собственном коде, но обычно это не так. Примером метода шифрования потока данных файла является Azure Information Protection (AIP)/Azure Rights Management Services (Azure RMS)/Active Directory RMS. Основная причина использования механизма шифрования, такого как AIP или RMS, заключается в предотвращении утечки данных из файлового ресурса в ситуации, когда кто-то копирует их в другое расположение, например на флеш-накопитель, или отправляет по электронной почте неавторизованному лицу. Когда поток данных файла шифруется как часть формата файла, этот файл будет по-прежнему зашифрован в файловом ресурсе Azure. 

Синхронизация файлов Azure не взаимодействует с системой шифрования файлов NTFS (NTFS EFS) или сторонними решениями шифрования, расположенными над файловой системой, но под потоком данных файла. 

### <a name="encryption-in-transit"></a>Шифрование при передаче

> [!NOTE]
> Служба "Синхронизация файлов Azure" не будет поддерживать TLS 1.0 и 1.1 с 1 августа 2020 года. Все поддерживаемые версии агента Синхронизации файлов Azure уже используют TLS 1.2 по умолчанию. Использование более ранней версии TLS может быть связано с тем, что протокол TLS 1.2 был отключен на сервере или используется прокси-сервер. Если вы используете прокси-сервер, рекомендуем проверить конфигурацию прокси-сервера. Регионы службы "Синхронизация файлов Azure", добавленные после 1 мая 2020 года, будут поддерживать TLS 1.2, а поддержка TLS 1.0 и 1.1 будет прекращена в существующих регионах 1 августа 2020 года.  Дополнительные сведения см. в [руководстве по устранению неполадок](storage-sync-files-troubleshoot.md#tls-12-required-for-azure-file-sync).

Агент Синхронизации файлов Azure взаимодействует с вашей службой синхронизации хранилища и файловым ресурсом Azure с помощью протокола Синхронизации файлов Azure REST и протокола FileREST, оба из которых всегда используют HTTPS через порт 443. Синхронизация файлов Azure не отправляет незашифрованные запросы по протоколу HTTP. 

Учетные записи хранения Azure содержат параметр для обязательного шифрования при передаче, который включен по умолчанию. Даже если параметр на уровне учетной записи хранения отключен, то есть возможен незашифрованный обмен данными с файловыми ресурсами Azure, Синхронизация файлов Azure будет по-прежнему использовать зашифрованные каналы для доступа к файловому ресурсу.

Основная причина отключения шифрования при передаче в учетной записи хранения заключается в поддержке устаревшего приложения, которое должно выполняться в более старой версии операционной системы, например Windows Server 2008 R2, или более старом дистрибутиве Linux, при взаимодействии с файловым ресурсом Azure напрямую. Если устаревшее приложение обращается к кэшу Windows Server файлового ресурса, переключение этого параметра не будет иметь эффекта. 

Настоятельно рекомендуется включить шифрование данных при передаче.

Дополнительные сведения о шифровании при передаче см. в статье [Require secure transfer in Azure Storage](../common/storage-require-secure-transfer.md?toc=%2fazure%2fstorage%2ffiles%2ftoc.json) (Требование безопасной передачи в службе хранилища Azure).

### <a name="azure-file-share-encryption-at-rest"></a>Шифрование файлового ресурса Azure при хранении
[!INCLUDE [storage-files-encryption-at-rest](../../../includes/storage-files-encryption-at-rest.md)]

## <a name="storage-tiers"></a>Уровни хранилища
[!INCLUDE [storage-files-tiers-overview](../../../includes/storage-files-tiers-overview.md)]

### <a name="enable-standard-file-shares-to-span-up-to-100-tib"></a>Включение стандартных файловых ресурсов для увеличения объема до 100 ТиБ
[!INCLUDE [storage-files-tiers-enable-large-shares](../../../includes/storage-files-tiers-enable-large-shares.md)]

#### <a name="regional-availability"></a>Доступность по регионам
[!INCLUDE [storage-files-tiers-large-file-share-availability](../../../includes/storage-files-tiers-large-file-share-availability.md)]

## <a name="azure-file-sync-region-availability"></a>Доступность Синхронизации файлов Azure по регионам
Синхронизация файлов Azure доступна в следующих регионах:

| Облако Azure | Географический регион | Регион Azure | Код региона |
|-------------|-------------------|--------------|-------------|
| Общедоступные | Азия | Восточная Азия | `eastasia` |
| Общедоступные | Азия | Юго-Восточная Азия | `southeastasia` |
| Общедоступные | Австралия | Восточная Австралия | `australiaeast` |
| Общедоступные | Австралия | Юго-Восточная часть Австралии | `australiasoutheast` |
| Общедоступные | Бразилия | Южная Бразилия | `brazilsouth` |
| Общедоступные | Canada | Центральная Канада | `canadacentral` |
| Общедоступные | Canada | Восточная Канада | `canadaeast` |
| Общедоступные | Европа | Северная Европа | `northeurope` |
| Общедоступные | Европа | Западная Европа | `westeurope` |
| Общедоступные | Франция | Центральная Франция | `francecentral` |
| Общедоступные | Франция | Южная Франция* | `francesouth` |
| Общедоступные | Индия | Центральная Индия | `centralindia` |
| Общедоступные | Индия | Южная Индия | `southindia` |
| Общедоступные | Япония | Восточная Япония | `japaneast` |
| Общедоступные | Япония | Западная Япония | `japanwest` |
| Общедоступные | Корея | Республика Корея, центральный регион | `koreacentral` |
| Общедоступные | Корея | Республика Корея, южный регион | `koreasouth` |
| Общедоступные | ЮАР | Северная часть ЮАР; | `southafricanorth` |
| Общедоступные | ЮАР | Западная часть ЮАР* | `southafricawest` |
| Общедоступные | ОАЭ | Центральная часть ОАЭ* | `uaecentral` |
| Общедоступные | ОАЭ | Северная часть ОАЭ; | `uaenorth` |
| Общедоступные | Соединенное Королевство | южная часть Соединенного Королевства | `uksouth` |
| Общедоступные | Соединенное Королевство | западная часть Соединенного Королевства | `ukwest` |
| Общедоступные | США | Центральная часть США | `centralus` |
| Общедоступные | США | Восточная часть США | `eastus` |
| Общедоступные | США | восточная часть США 2 | `eastus2` |
| Общедоступные | США | Центрально-северная часть США | `northcentralus` |
| Общедоступные | США | Центрально-южная часть США | `southcentralus` |
| Общедоступные | США | центрально-западная часть США | `westcentralus` |
| Общедоступные | США | западная часть США | `westus` |
| Общедоступные | США | западная часть США 2 | `westus2` |
| US Gov | США | US Gov (Аризона) | `usgovarizona` |
| US Gov | США | US Gov (Техас) | `usgovtexas` |
| US Gov | США | US Gov (Вирджиния) | `usgovvirginia` |

Синхронизация файлов Azure поддерживает только синхронизацию с файловым ресурсом Azure в том же регионе, что и служба синхронизации хранилища.

Необходимо обратиться в службу поддержки Azure, чтобы запросить доступ к службе хранилища Azure в регионах, помеченных звездочками. Данная процедура рассмотрена в [этом документе](https://azure.microsoft.com/global-infrastructure/geographies/).

## <a name="redundancy"></a>Избыточность
[!INCLUDE [storage-files-redundancy-overview](../../../includes/storage-files-redundancy-overview.md)]

> [!Important]  
> Геоизбыточное хранилище и хранилище с избыточностью по географическим зонам позволяет вручную отрабатывать отказ хранилища с переносом в дополнительный регион. Рекомендуется делать это только в случае аварии при использовании Синхронизации файлов Azure из-за повышенной вероятности потери данных. В случае аварии, когда вы хотите инициировать отработку отказа хранилища вручную, необходимо открыть обращение в службу поддержки Майкрософт, чтобы получить Синхронизацию файлов Azure и возобновить синхронизацию с дополнительной конечной точкой.

## <a name="migration"></a>Миграция
Если у вас есть существующий файловый сервер Windows, Синхронизацию файлов Azure можно установить непосредственно на месте без необходимости перемещения данных на новый сервер. Если вы планируете выполнить миграцию на новый файловый сервер Windows в рамках внедрения Синхронизации файлов Azure, существует несколько возможных подходов к перемещению данных:

- Создайте конечные точки сервера для старого файлового ресурса и нового файлового ресурса и позвольте Синхронизации файлов Azure синхронизировать данные между конечными точками сервера. Преимущество этого подхода заключается в том, что можно очень легко переподписать хранилище на новом файловом сервере, так как Синхронизация файлов Azure учитывает распределение по уровням в облаке. Когда будете готовы, вы сможете перенести конечных пользователей в файловый ресурс на новом сервере и удалить конечную точку старого сервера файлового ресурса.

- Создайте конечную точку сервера только на новом файловом сервере и скопируйте данные из старого файлового ресурса с помощью `robocopy`. В зависимости от топологии файловых ресурсов на новом сервере (количество папок на каждом томе и т. д.), возможно, следует временно подготовить дополнительное хранилище, так как ожидается, что операция `robocopy` из старого сервера на новый сервер в локальном центре обработки данных будет выполняться быстрее, чем Синхронизация файлов Azure переместит данные в Azure.

Можно также использовать Data Box для переноса данных в развертывание Синхронизации файлов Azure. В большинстве случаев, когда клиенты хотят использовать Data Box для приема данных, они считают, что увеличивают скорость развертывания или могут помочь в сценариях с ограниченной пропускной способностью. Несмотря на то что использование Data Box для приема данных в развертывании Синхронизации файлов Azure снизит загрузку пропускной способности, скорее всего, в большинстве случаев будет быстрее загружать данные одним из описанных выше методов. Дополнительные сведения об использовании Data Box для приема данных в развертывании Синхронизации файлов Azure см. в статье [Перенос данных в Синхронизацию файлов Azure с помощью Azure Data Box](storage-sync-offline-data-transfer.md).

Распространенные ошибки, которые делают пользователи при переносе данных в новое развертывание Синхронизации файлов Azure, — это копирование данных непосредственно в файловый ресурс Azure, а не на файловые серверы Windows. Хотя Синхронизация файлов Azure определит все новые файлы в файловом ресурсе Azure и синхронизирует их с файловыми ресурсами Windows, обычно это значительно медленнее, чем загрузка данных через файловый сервер Windows. При использовании средств копирования Azure, таких как AzCopy, важно использовать последнюю версию. Просмотрите [таблицу средств копирования файлов](storage-files-migration-overview.md#file-copy-tools) , чтобы получить общие сведения о средствах копирования Azure, чтобы скопировать все важные метаданные файла, такие как метки времени и списки ACL.

## <a name="antivirus"></a>Антивирусная программа
Поскольку антивирусная программа работает путем сканирования файлов на наличие известного вредоносного кода, антивирусный продукт может вызвать отзыв многоуровневых файлов, что приведет к высокой оплате за исходящий трафик. В агенте синхронизации файлов Azure начиная с версии 4.0 файлам, распределенным по уровням, задан атрибут безопасности Windows FILE_ATTRIBUTE_RECALL_ON_DATA_ACCESS. Рекомендуется обратиться к поставщику программного обеспечения за информацией о том, как настроить решение, чтобы пропускать чтение файлов с таким атрибутом (многие программы делают это автоматически). 

Антивирусные решения Майкрософт — Защитник Windows и служба регистрации сертификатов для сетевых устройств (SCEP) автоматически пропускают чтение файлов с таким атрибутом. В ходе их тестирования обнаружилась небольшая проблема — при добавлении сервера в существующую группу синхронизации файлы размером меньше 800 байт отзываются (скачиваются) на новый сервер. Эти файлы останутся на новом сервере и не будут передаваться, так как они не соответствуют требованиям к размерам для уровней (более 64 КБ).

> [!Note]  
> Поставщики антивирусных программ могут проверить совместимость своих продуктов и Синхронизации файлов Azure с помощью [Набора тестов для совместимости антивирусных программ с Синхронизацией файлов Azure](https://www.microsoft.com/download/details.aspx?id=58322), который доступен в центре загрузки Майкрософт.

## <a name="backup"></a>Резервное копирование 
Если включено распределение по уровням облака, не следует использовать решения, которые непосредственно зарезервировать конечную точку сервера или виртуальную машину, на которой находится конечная точка сервера. Распределение по уровням облака приводит к хранению только подмножества данных в конечной точке сервера с полным набором данных, размещенным в общем файловом ресурсе Azure. В зависимости от используемого решения резервного копирования многоуровневые файлы пропускаются и не архивируются (так как у них установлен FILE_ATTRIBUTE_RECALL_ON_DATA_ACCESS атрибут) или они будут отозваны на диск, что приведет к высокой оплате за исходящий трафик. Мы рекомендуем использовать решение облачного резервного копирования для непосредственного резервного копирования файлового ресурса Azure. Дополнительные сведения см. в статьях [о резервном копировании файловых ресурсов Azure](../../backup/azure-file-share-backup-overview.md?toc=%2fazure%2fstorage%2ffiles%2ftoc.json) или обратитесь к поставщику резервной копии, чтобы узнать, поддерживают ли они резервное копирование общих папок Azure.

Если вы предпочитаете использовать локальное решение резервного копирования, резервное копирование должно выполняться на сервере в группе синхронизации, для которой отключено распределение по уровням облака. При восстановлении используйте параметры восстановления на уровне тома или файла. Файлы, восстановленные с помощью функции восстановления на уровне файлов, будут синхронизированы со всеми конечными точками в группе синхронизации, а существующие файлы — заменены версией, восстановленной из резервной копии.  При восстановлении на уровне тома новые версии файлов в файловом ресурсе Azure или других конечных точках сервера не заменяются.

> [!Note]  
> Восстановление исходного состояния системы (BMR) может привести к непредвиденным результатам и сейчас не поддерживается.

> [!Note]  
> С агентом Синхронизации файлов Azure версии 9 моментальные снимки VSS (включая вкладку "Предыдущие версии") не поддерживаются в томах, для которых включено распределение по уровням в облаке. Однако необходимо включить совместимость с предыдущими версиями с помощью PowerShell. [Подробнее](storage-sync-files-deployment-guide.md#self-service-restore-through-previous-versions-and-vss-volume-shadow-copy-service).

## <a name="azure-file-sync-agent-update-policy"></a>Политика обновления агента службы синхронизации файлов Azure
[!INCLUDE [storage-sync-files-agent-update-policy](../../../includes/storage-sync-files-agent-update-policy.md)]

## <a name="next-steps"></a>Дальнейшие действия
* [Параметры брандмауэра и прокси-сервера Синхронизации файлов Azure](storage-sync-files-firewall-and-proxy.md)
* [Планирование развертывания службы файлов Azure](storage-files-planning.md)
* [Как развернуть службу файлов Azure](./storage-how-to-create-file-share.md)
* [Как развернуть службу синхронизации файлов Azure (предварительная версия)](storage-sync-files-deployment-guide.md)
* [Мониторинг Синхронизации файлов Azure](storage-sync-files-monitoring.md)
