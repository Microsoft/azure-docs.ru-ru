---
title: Управление многоуровневые файлы Синхронизация файлов Azure | Документация Майкрософт
description: Советы и командлеты PowerShell, помогающие управлять многоуровневыми файлами
author: roygara
ms.service: storage
ms.topic: how-to
ms.date: 1/4/2021
ms.author: rogarana
ms.subservice: files
ms.openlocfilehash: dc61792da669cd5d2c928eec0fd412d86725fc8c
ms.sourcegitcommit: dda0d51d3d0e34d07faf231033d744ca4f2bbf4a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/05/2021
ms.locfileid: "102204428"
---
# <a name="how-to-manage-tiered-files"></a>Управление многоуровневыми файлами

В этой статье содержатся рекомендации для пользователей, имеющих вопросы, связанные с управлением многоуровневыми файлами. Основные вопросы о распределении по уровням облака см. в статье [часто задаваемые вопросы о службе файлов Azure](storage-files-faq.md).

## <a name="how-to-check-if-your-files-are-being-tiered"></a>Как проверить, выполняется ли распределение по уровням файлов

Если файлы должны быть распределены по политикам набора, оцениваются один раз в час. При создании конечной точки сервера могут возникнуть две ситуации:

При первом добавлении новой конечной точки сервера в этом расположении сервера часто существуют файлы. Их необходимо отправить перед началом распределения по уровням облака. Политика свободного места тома не начнет свою работу, пока не завершится начальная отправка всех файлов. Однако необязательная политика дат начнет работать с отдельными файлами, как только файл будет передан. Также применяется интервал в один час. 

При добавлении новой конечной точки сервера можно подключить пустое расположение сервера к общему файловому ресурсу Azure с данными в нем. Если вы решили загрузить пространство имен и отозвать содержимое во время начальной загрузки на сервер, то после того, как пространство имен будет восстановлено, файлы будут отозваны на основе метки времени последнего изменения в политике свободного места тома, а также будут достигнуты необязательные ограничения политики дат.

Существует несколько способов определения перемещения файла в файловый ресурс Azure.
    
   *  **Проверьте атрибуты файла.**
     Щелкните файл правой кнопкой мыши, перейдите в раздел **Сведения** и прокрутите вниз до свойства **Атрибуты**. Перемещенному файлу будут заданы следующие атрибуты:     
        
        | Буква атрибута | attribute | Определение |
        |:----------------:|-----------|------------|
        | Объект | Архив | Указывает, что с помощью программного обеспечения для архивации должно быть выполнено резервное копирование файла. Этот атрибут задается всегда, независимо от того, перемещен файл или полностью расположен на диске. |
        | P | Разреженный файл | Указывает, что этот файл является разреженным. Это специализированный тип файла, который NTFS предлагает для эффективного использования при отсутствии файлового потока на диске. Служба синхронизации файлов Azure использует разреженные файлы, так как файл либо полностью перемещается, либо частично отзывается. Когда файл полностью перемещается, его файловый поток хранится только в облаке. Когда файл частично отзывается, часть этого файла уже на диске. Такое может случиться, когда файлы частично считываются приложениями, например мультимедийными проигрывателями или программами для сжатия. Если файл полностью отозван на диск, служба синхронизации файлов Azure преобразует его из разреженного файла в обычный файл. Этот атрибут задается только в Windows Server 2016 и более старых версиях.|
        | M | Отзыв при доступе к данным | Указывает, что данные файла не полностью представлены в локальном хранилище. При чтении файла по крайней мере часть содержимого файла будет получена из общего файлового ресурса Azure, к которому подключена конечная точка сервера. Этот атрибут задается только в Windows Server 2019. |
        | L | Точка повторного анализа | Указывает, что файл содержит точку повторного анализа. Она представляет собой специальный указатель, используемый фильтром файловой системы. Служба синхронизации файлов Azure использует точки повторного анализа, чтобы фильтр (StorageSync.sys) файловой системы в этой службе мог определить место хранения файла в облаке. Это обеспечивает прозрачный доступ без непосредственной осведомленности пользователя о задействовании службы синхронизации файлов Azure или о том, как получить доступ к файлу в файловом ресурсе Azure. После полного отзыва файла служба синхронизации файлов Azure удаляет точку повторного анализа из файла. |
        | O | Автономная миграция | Указывает, что некоторое (или все) содержимое файла не хранится на диске. После полного отзыва файла служба синхронизации файлов Azure удаляет этот атрибут. |

        ![Диалоговое окно свойств файла с выбранной вкладкой "Сведения"](media/storage-files-faq/azure-file-sync-file-attributes.png)
        
    
        > [!NOTE]
        > Вы можете просмотреть атрибуты для всех файлов в папке. Для этого необходимо добавить поле **Атрибуты** в окно таблицы проводника. Щелкните правой кнопкой мыши имеющийся столбец (например, **Размер**), выберите **Дополнительно**, а затем в раскрывающемся списке выберите **Атрибуты**.
        
        > [!NOTE]
        > Все эти атрибуты также будут видимы для частично отозванных файлов.
        
   * **Используйте `fsutil` для проверки точек повторного анализа в файле.**
       Как объяснялось выше, для перемещенного файла всегда задана точка повторного анализа. Точка повторного анализа позволяет Синхронизация файлов Azure драйверу фильтра файловой системы (StorageSync.sys) получать содержимое из файловых ресурсов Azure, которые не хранятся локально на сервере. 

       Проверить наличие точки повторного анализа для файла можно с помощью команды `fsutil`, выполнив ее в командной строке с повышенными привилегиями или сеансе PowerShell:

        ```powershell
        fsutil reparsepoint query <your-file-name>
        ```
       Если файл содержит точку повторного анализа, вы увидите сообщение **Значение тега повторной обработки: 0x8000001e**. Это шестнадцатеричное значение — это значение точки повторного анализа, которое принадлежит Синхронизация файлов Azure. В выходных данных также содержатся данные повторного анализа, представляющие путь к файлу в общей папке Azure.
        
        > [!WARNING]  
        > С помощью команды `fsutil reparsepoint` можно также удалить точку повторного анализа. Не выполняйте эту команду, пока вы не получите прямое указание от инженерной команды службы синхронизации файлов Azure, так как ее выполнение может привести к потере данных. 

## <a name="how-to-exclude-applications-from-cloud-tiering-last-access-time-tracking"></a>Как исключить приложения из отслеживания времени последнего доступа на уровне облака

С помощью Синхронизация файлов Azure агента версии 11,1 можно исключать приложения из отслеживания последнего доступа. Когда приложение обращается к файлу, время последнего доступа к файлу обновляется в базе данных уровня облака. Приложения, сканирующие файловую систему, например антивирусную программу, приводят к тому, что все файлы имеют одинаковое время последнего доступа, что влияет на распределение файлов по уровням.

Чтобы исключить приложения из отслеживания времени последнего доступа, добавьте имя процесса в параметр реестра Хеаттраккингпроцесснамиксклусионлист, расположенный в разделе HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Azure\StorageSync.

Пример: reg ADD "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Azure\StorageSync"/v Хеаттраккингпроцесснамиксклусионлист/t REG_MULTI_SZ/d "SampleApp.exe\0AnotherApp.exe"/f

> [!NOTE]
> Процессы дедупликации данных и файлового сервера диспетчер ресурсов (FSRM) исключаются по умолчанию. Изменения в списке исключений процесса учитываются системой каждые 5 минут.

## <a name="how-to-access-the-heat-store"></a>Доступ к теплового хранилища

Распределение по уровням в облаке использует время последнего доступа и частоту доступа к файлу, чтобы определить, какие файлы должны быть распределены по уровням. Драйвер фильтра по уровням облака (storagesync.sys) отслеживает время последнего доступа и регистрирует информацию в облачном хранилище уровня облака. Вы можете получить хранилище тепла и сохранить его в CSV-файл с помощью локального серверного командлета PowerShell.

Для всех файлов на одном томе имеется одно теплое хранилище. Банк данных может получить очень большой размер. Если вам нужно получить только "самое замечательное" количество элементов, используйте параметр-Limit и число, а также рассмотрите возможность фильтрации по вложенному пути и корню тома.

- Импортируйте модуль PowerShell:   `Import-Module '<SyncAgentInstallPath>\StorageSync.Management.ServerCmdlets.dll'`

- СВОБОДНОЕ место на томе: чтобы получить порядок, в котором файлы будут распределяться по уровням с помощью политики свободного места в томе:   `Get-StorageSyncHeatStoreInformation -VolumePath '<DriveLetter>:\' -ReportDirectoryPath '<FolderPathToStoreResultCSV>' -IndexName FilesToBeTieredBySpacePolicy`

- Политика даты: чтобы получить порядок, в котором файлы будут распределяться по уровням с помощью политики дат:   `Get-StorageSyncHeatStoreInformation -VolumePath '<DriveLetter>:\' -ReportDirectoryPath '<FolderPathToStoreResultCSV>' -IndexName FilesToBeTieredByDatePolicy`

- Поиск сведений о банке данных для определенного файла:   `Get-StorageSyncHeatStoreInformation -FilePath '<PathToSpecificFile>'`

- Просматривать все файлы в порядке убывания времени последнего доступа:   `Get-StorageSyncHeatStoreInformation -VolumePath '<DriveLetter>:\' -ReportDirectoryPath '<FolderPathToStoreResultCSV>' -IndexName DescendingLastAccessTime`

- Ознакомьтесь с порядком, по которому многоуровневые файлы будут отозваны при отзыве в фоновом режиме или по требованию с помощью PowerShell:   `Get-StorageSyncHeatStoreInformation -VolumePath '<DriveLetter>:\' -ReportDirectoryPath '<FolderPathToStoreResultCSV>' -IndexName OrderTieredFilesWillBeRecalled`

## <a name="how-to-force-a-file-or-directory-to-be-tiered"></a>Принудительное использование уровня файла или каталога

> [!NOTE]
> При выборе каталога, для которого будет выполняться Многоуровневое распределение, будут применяться только файлы, находящиеся в каталоге. Все файлы, созданные после этого времени, не будут автоматически распределены по уровням.

Если функция распределения по уровням облака включена, файлы распределяются по уровням автоматически на основе последнего времени доступа и изменения, чтобы достичь процента свободного пространства тома, указанного для конечной точки облака. Тем не менее иногда вам может понадобиться распределить файл по уровням вручную. Это может быть полезно, если вам нужно сохранить большие файлы, которые не планируется использовать повторно в течение долгого времени, и освободить пространство на томе для других файлов и папок. Вы можете принудительно распределить файлы по уровням с помощью следующих команд PowerShell:

```powershell
Import-Module "C:\Program Files\Azure\StorageSyncAgent\StorageSync.Management.ServerCmdlets.dll"
Invoke-StorageSyncCloudTiering -Path <file-or-directory-to-be-tiered>
```

## <a name="how-to-recall-a-tiered-file-to-disk"></a>Отзыв многоуровневого файла на диск

Самый простой способ отозвать файл на диск — открыть его. Фильтр файловой системы (StorageSync.sys) в службе синхронизации файлов Azure быстро скачает этот файл из файлового ресурса Azure без необходимости дополнительных действий. Для типов файлов, которые могут быть частично прочитаны или передаваться в потоке, такие как файлы мультимедиа или ZIP, простое открытие файла не гарантирует загрузку всего файла.

Чтобы обеспечить полную загрузку файла на локальный диск, необходимо использовать PowerShell для принудительного полного отзыва файла. Этот параметр также может быть полезен, если требуется отозвать сразу несколько файлов, например все файлы в папке. Откройте сеанс PowerShell на узле сервера, на котором установлена служба синхронизации файлов Azure, и выполните следующие команды PowerShell:
    
```powershell
Import-Module "C:\Program Files\Azure\StorageSyncAgent\StorageSync.Management.ServerCmdlets.dll"
Invoke-StorageSyncFileRecall -Path <path-to-to-your-server-endpoint>
```
Дополнительные параметры:
* `-Order CloudTieringPolicy` отзывает последние измененные или доступные файлы первыми и разрешается текущей политикой уровней. 
    * Если настроена политика свободного места в томе, файлы будут отозваны до тех пор, пока не будет достигнут параметр политики свободного места на томе. Например, если параметр политики свободного места на томе имеет значение 20%, то повторный вызов будет прерван, когда свободное место тома достигнет 20%.  
    * Если настроена политика "свободное место на томе" и "Дата", файлы будут отозваны до тех пор, пока не будет достигнут параметр политики "свободное место на томе" или "Дата". Например, если параметр политики свободного места на томе имеет значение 20%, а политика даты — 7 дней, то повторная попытка будет прервана, когда свободное место тома достигнет 20% или все файлы, которые были доступны или изменены в течение 7 дней, будут локальными.
* `-ThreadCount` Определяет, сколько файлов можно вызвать параллельно.
* `-PerFileRetryCount`Определяет, как часто будет пытаться отозвать заблокированный файл.
* `-PerFileRetryDelaySeconds`Определяет время в секундах между повторными попытками вызова и всегда используется в сочетании с предыдущим параметром.

Пример.
```powershell
Import-Module "C:\Program Files\Azure\StorageSyncAgent\StorageSync.Management.ServerCmdlets.dll"
Invoke-StorageSyncFileRecall -Path <path-to-to-your-server-endpoint> -ThreadCount 8 -Order CloudTieringPolicy -PerFileRetryCount 3 -PerFileRetryDelaySeconds 10
``` 

> [!Note]  
>- Если на локальном томе, на котором размещен сервер, недостаточно свободного места для отзыва всех многоуровневых данных, командлет `Invoke-StorageSyncFileRecall` завершится сбоем.  

> [!Note]
> Для отзыва файлов, которые были распределены по уровням, пропускная способность сети должна составлять не менее 1 Мбит/с. Если пропускная способность сети меньше 1 Мбит/с, то файлы могут не вызываться с ошибкой истечения времени ожидания.

## <a name="next-steps"></a>Дальнейшие действия
* [Вопросы и ответы о службе "Файлы Azure"](storage-files-faq.md)
