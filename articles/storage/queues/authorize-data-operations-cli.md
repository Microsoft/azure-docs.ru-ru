---
title: Выберите способ авторизации доступа к данным очереди с помощью Azure CLI
titleSuffix: Azure Storage
description: Укажите способ авторизации операций с данными из очереди с помощью Azure CLI. Вы можете авторизовать операции с данными с помощью учетных данных Azure AD, ключа доступа к учетной записи или маркера подписанного URL-доступа (SAS).
author: tamram
services: storage
ms.author: tamram
ms.reviewer: ozgun
ms.date: 02/10/2021
ms.topic: how-to
ms.service: storage
ms.subservice: common
ms.custom: devx-track-azurecli
ms.openlocfilehash: 2f7092d8ce184d7021774814e96935e46d1ffb56
ms.sourcegitcommit: d4734bc680ea221ea80fdea67859d6d32241aefc
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/14/2021
ms.locfileid: "100363174"
---
# <a name="choose-how-to-authorize-access-to-queue-data-with-azure-cli"></a>Выберите способ авторизации доступа к данным очереди с помощью Azure CLI

Служба хранилища Azure предоставляет расширения для Azure CLI, которые позволяют указать, как следует авторизовать операции с данными очереди. Авторизовать операции с данными можно следующими способами.

- С помощью субъекта безопасности Azure Active Directory (Azure AD). Корпорация Майкрософт рекомендует использовать учетные данные Azure AD для обеспечения высокого уровня безопасности и простоты использования.
- С помощью ключа доступа к учетной записи или маркера подписанного URL-доступа (SAS).

## <a name="specify-how-data-operations-are-authorized"></a>Указание порядка авторизации операций с данными

Azure CLI команды для чтения и записи данных очереди включают необязательный `--auth-mode` параметр. Укажите этот параметр, чтобы указать, как должна быть разрешена операция с данными:

- Задайте для параметра значение, чтобы выполнить `--auth-mode` `login` Вход с помощью субъекта безопасности Azure AD (рекомендуется).
- Присвойте `--auth-mode` параметру устаревшее `key` значение, чтобы попытаться получить ключ доступа к учетной записи, используемый для авторизации. Если опустить `--auth-mode` параметр, Azure CLI также попытается получить ключ доступа.

Чтобы использовать `--auth-mode` параметр, убедитесь, что установлен Azure CLI v 2.0.46 или более поздней версии. Выполните команду `az --version`, чтобы узнать установленную версию.

> [!NOTE]
> Если учетная запись хранения заблокирована с блокировкой Azure Resource Manager **только для чтения** , операция " [список ключей](/rest/api/storagerp/storageaccounts/listkeys) " не разрешена для этой учетной записи хранения. **Список ключей** является операцией POST, и все операции POST предотвращаются, если для учетной записи настроена блокировка **только для чтения** . По этой причине, если учетная запись заблокирована с блокировкой **только для чтения** , пользователи, которым не назначены ключи учетной записи, должны использовать учетные данные Azure AD для доступа к данным очереди.

> [!IMPORTANT]
> Если опустить `--auth-mode` параметр или присвоить ему значение `key` , Azure CLI пытается использовать ключ доступа учетной записи для авторизации. В этом случае корпорация Майкрософт рекомендует указать ключ доступа либо в команде, либо в `AZURE_STORAGE_KEY` переменной среды. Дополнительные сведения о переменных среды см. в разделе [Настройка переменных среды для параметров авторизации](#set-environment-variables-for-authorization-parameters).
>
> Если ключ доступа не предоставлен, Azure CLI пытается вызвать поставщик ресурсов службы хранилища Azure, чтобы получить его для каждой операции. Выполнение большого количества операций с данными, требующих вызова поставщика ресурсов, может привести к регулированию. Дополнительные сведения об ограничениях поставщиков ресурсов см. [в разделе целевые показатели масштабируемости и производительности для поставщика ресурсов службы хранилища Azure](../common/scalability-targets-resource-provider.md).

## <a name="authorize-with-azure-ad-credentials"></a>Авторизация с помощью учетных данных Azure AD

При входе в Azure CLI с учетными данными Azure AD возвращается маркер доступа OAuth 2,0. Этот маркер автоматически используется Azure CLI для авторизации последующих операций с данными в хранилище очередей. Для поддерживаемых операций больше не требуется передавать ключ учетной записи или маркер SAS с помощью команды.

Можно назначить разрешения на доступ к данным из очереди субъекту безопасности Azure AD через Управление доступом на основе ролей Azure (Azure RBAC). Дополнительные сведения о ролях Azure в службе хранилища Azure см. в статье [Управление правами доступа к данным службы хранилища Azure с помощью Azure RBAC](../common/storage-auth-aad-rbac-portal.md).

### <a name="permissions-for-calling-data-operations"></a>Разрешения для вызова операций с данными

Расширения службы хранилища Azure поддерживаются для операций с данными очереди. Действия, которые можно вызывать, зависят от разрешений, предоставленных субъекту безопасности Azure AD, с которым вы входите в Azure CLI. Разрешения для очередей назначаются через Azure RBAC. Например, если назначена роль **читателя данных очереди хранилища** , можно выполнять команды сценариев, считывающие данные из очереди. Если роль **участник данных очереди хранилища** назначена, можно выполнять команды сценариев, которые считывают, записывают или удаляют очередь или содержащиеся в них данные.

Дополнительные сведения о разрешениях, необходимых для каждой операции службы хранилища Azure в очереди, см. в разделе [операции хранилища вызовов с токенами OAuth](/rest/api/storageservices/authorize-with-azure-active-directory#call-storage-operations-with-oauth-tokens).  

### <a name="example-authorize-an-operation-to-create-a-queue-with-azure-ad-credentials"></a>Пример. авторизация операции для создания очереди с учетными данными Azure AD

В следующем примере показано, как создать очередь из Azure CLI с помощью учетных данных Azure AD. Чтобы создать очередь, необходимо войти в Azure CLI, и вам потребуется группа ресурсов и учетная запись хранения.

1. Перед созданием очереди назначьте себе роль [участника данных очереди хранилища](../../role-based-access-control/built-in-roles.md#storage-queue-data-contributor) . Несмотря на то, что вы являетесь владельцем учетной записи, вам нужны явные разрешения на выполнение операций с данными с учетной записью хранения. Дополнительные сведения о назначении ролей Azure см. в статье [использование портал Azure для назначения роли Azure доступа к данным BLOB-объектов и очередей](../common/storage-auth-aad-rbac-portal.md).

    > [!IMPORTANT]
    > Назначение ролей Azure может занимать несколько минут.

1. Вызовите [`az storage queue create`](/cli/azure/storage/queue#az-storage-queue-create) команду с `--auth-mode` параметром, имеющим значение, чтобы `login` создать очередь с использованием учетных данных Azure AD. Не забудьте заменить значения заполнителей в угловых скобках собственными значениями.

    ```azurecli
    az storage queue create \
        --account-name <storage-account> \
        --name sample-queue \
        --auth-mode login
    ```

## <a name="authorize-with-the-account-access-key"></a>Авторизация с помощью ключа доступа учетной записи

Если вы владеете ключом учетной записи, вы можете вызвать любую операцию с данными службы хранилища Azure. В общем случае использование ключа учетной записи менее безопасно. Если ключ учетной записи скомпрометирован, все данные в вашей учетной записи могут быть скомпрометированы.

В следующем примере показано, как создать очередь с помощью ключа доступа учетной записи. Укажите ключ учетной записи и укажите `--auth-mode` параметр со `key` значением:

```azurecli
az storage queue create \
    --account-name <storage-account> \
    --name sample-queue \
    --account-key <key>
    --auth-mode key
```

## <a name="authorize-with-a-sas-token"></a>Авторизация с помощью маркера SAS

Если вы владеете маркером SAS, вы можете вызывать операции с данными, разрешенные SAS. В следующем примере показано, как создать очередь с помощью маркера SAS:

```azurecli
az storage queue create \
    --account-name <storage-account> \
    --name sample-queue \
    --sas-token <token>
```

## <a name="set-environment-variables-for-authorization-parameters"></a>Установка переменных среды для параметров авторизации

Можно указать параметры авторизации в переменных среды, чтобы избежать их включения при каждом вызове операции с данными в хранилище Azure. В следующей таблице описаны доступные переменные среды.

| Переменная среды | Описание |
|--|--|
| **AZURE_STORAGE_ACCOUNT** | имя учетной записи хранения. Эту переменную следует использовать в сочетании с ключом учетной записи хранения или маркером SAS. Если они отсутствуют, Azure CLI пытается получить ключ доступа к учетной записи хранения с помощью учетной записи Azure AD с проверкой подлинности. Если одновременно выполняется большое количество команд, может быть достигнут предел регулирования поставщика ресурсов службы хранилища Azure. Дополнительные сведения об ограничениях поставщиков ресурсов см. [в разделе целевые показатели масштабируемости и производительности для поставщика ресурсов службы хранилища Azure](../common/scalability-targets-resource-provider.md). |
| **AZURE_STORAGE_KEY** | Ключ учетной записи хранения. Эта переменная должна использоваться в сочетании с именем учетной записи хранения. |
| **AZURE_STORAGE_CONNECTION_STRING** | Строка подключения, включающая ключ учетной записи хранения или маркер SAS. Эта переменная должна использоваться в сочетании с именем учетной записи хранения. |
| **AZURE_STORAGE_SAS_TOKEN** | Токен подписанного URL-доступа (SAS). Эта переменная должна использоваться в сочетании с именем учетной записи хранения. |
| **AZURE_STORAGE_AUTH_MODE** | Режим авторизации, с помощью которого выполняется команда. Допустимые значения: `login` (рекомендуется) или `key` . Если указать `login` , Azure CLI использует учетные данные Azure AD для авторизации операции с данными. При указании устаревшего `key` режима Azure CLI пытается запросить ключ доступа к учетной записи и авторизовать команду с помощью ключа. |

## <a name="next-steps"></a>Следующие шаги

- [Использование Azure CLI для назначения роли Azure доступа к данным BLOB-объектов и очередей](../common/storage-auth-aad-rbac-cli.md)
- [Авторизация доступа к данным BLOB-объектов и очередей с помощью управляемых удостоверений для ресурсов Azure](../common/storage-auth-aad-msi.md)
