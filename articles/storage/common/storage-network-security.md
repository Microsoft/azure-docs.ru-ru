---
title: Настройка брандмауэров службы хранилища Azure и виртуальных сетей | Документация Майкрософт
description: Настройка многоуровневой сетевой безопасности для учетной записи хранения с помощью брандмауэров службы хранилища Azure и виртуальной сети Azure.
services: storage
author: santoshc
ms.service: storage
ms.topic: how-to
ms.date: 12/08/2020
ms.author: tamram
ms.reviewer: santoshc
ms.subservice: common
ms.openlocfilehash: 13d1ad0b1b5e32ea2ca86e7556dd910c542bcbe2
ms.sourcegitcommit: 3af12dc5b0b3833acb5d591d0d5a398c926919c8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/11/2021
ms.locfileid: "98070581"
---
# <a name="configure-azure-storage-firewalls-and-virtual-networks"></a>Настройка брандмауэров службы хранилища Azure и виртуальных сетей

Служба хранилища Azure предоставляет многоуровневую модель безопасности. Эта модель позволяет защищать ваши учетные записи хранения и контролировать уровень доступа к ним, который требуется приложениям и корпоративным средам, в зависимости от типа и подмножества используемых сетей. После настройки сетевых правил доступ к учетной записи хранения могут получать только приложения, запрашивающие данные через этот определенный набор сетей. Вы можете разрешать доступ к учетной записи хранения только для запросов, исходящих из указанных IP-адресов, диапазонов IP-адресов или из списка подсетей в виртуальной сети Azure (VNet).

Учетные записи хранения имеют общедоступную конечную точку, доступную через Интернет. Вы также можете создать [частные конечные точки для учетной записи хранения](storage-private-endpoints.md), которые назначают учетной записи хранения частный IP-адрес из вашей виртуальной сети, а также защищают весь трафик между виртуальной сетью и учетной записью хранения с помощью приватного канала. Брандмауэр службы хранилища Azure предоставляет контроль доступа для общедоступной конечной точки вашей учетной записи хранения. Вы также можете использовать брандмауэр, чтобы блокировать доступ через общедоступную конечную точку при использовании частных конечных точек. Конфигурация брандмауэра службы хранилища также позволяет выбрать доверенные службы платформы Azure для безопасного доступа к учетной записи хранения.

При этом приложению, которое обращается к учетной записи хранения, когда действуют сетевые правила, по-прежнему необходима надлежащая авторизация для выполнения запроса. Авторизация обеспечивается учетными данными Azure Active Directory для больших двоичных объектов и очередей, действительным ключом доступа к учетной записи или маркером SAS.

> [!IMPORTANT]
> Включение правил брандмауэра для учетной записи хранения по умолчанию блокирует входящие запросы данных, за исключением запросов от служб, работающих внутри виртуальной сети Azure (VNet), или запросов, поступающих из разрешенных общедоступных IP-адресов. Запросы от других служб Azure, в том числе портала Azure, служб метрики и ведения журналов, блокируются.
>
> Вы можете предоставить доступ службам Azure, работающим в рамках виртуальной сети, разрешая трафик из подсети, в которой размещен экземпляр службы. Вы также можете разрешать ограниченное количество сценариев с помощью механизма [исключений](#exceptions), который описывается ниже. Доступ к данным учетной записи хранения через портал Azure возможен только с компьютера, находящегося в пределах настроенной доверенной границы (на основе протокола IP или VNet).

[!INCLUDE [updated-for-az](../../../includes/updated-for-az.md)]

## <a name="scenarios"></a>Сценарии

Чтобы защитить учетную запись хранения, необходимо сначала настроить правило, по умолчанию запрещающее доступ к трафику из всех сетей (включая интернет-трафик) в общедоступной конечной точке. Затем следует настроить правила, предоставляющие доступ к трафику из определенных виртуальных сетей. Можно также настроить правила, чтобы предоставить доступ к трафику из выбранных диапазонов общедоступных IP-адресов Интернета, разрешив подключения от конкретных клиентов в Интернете или локальных клиентах. Такая конфигурация позволяет создать для приложений границу в виде безопасной сети.

Вы можете сочетать правила брандмауэра, разрешающие доступ из конкретных виртуальных сетей, и правила, разрешающие доступ из диапазонов общедоступных IP-адресов, в одной и той же учетной записи хранения. Правила брандмауэра службы хранилища могут применяться к существующим учетным записям хранения, а также во время создания учетных записей хранения.

Правила брандмауэра службы хранилища применяются к общедоступной конечной точке учетной записи хранения. Вам не нужно задавать никакие правила доступа брандмауэра, чтобы разрешить трафик для частных конечных точек учетной записи хранения. Процесс утверждения создания частной конечной точки предоставляет неявный доступ к трафику из подсети, в которой размещается эта частная конечная точка.

Сетевые правила применяются ко всем сетевым протоколам в службе хранилища Azure, включая протоколы RESTFUL и SMB. Для доступа к данным с помощью таких инструментов, как портал Azure, Обозреватель службы хранилища и AZCopy, необходимо настроить явные правила сети.

Как только правила сети применены, они распространяются на все запросы. Токены SAS, позволяющие получить доступ к конкретному IP-адресу, служат для ограничения доступа владельца токена, а не предоставляют доступ к каким-либо новым ресурсам, не указанным в настроенных сетевых правилах.

Правила сети не влияют на трафик дисков виртуальных машин (включая операции подключения и отключения, а также дисковые операции ввода-вывода). Сетевые правила обеспечивают безопасность во время доступа REST к страничным BLOB-объектам.

Классические учетные записи хранения не поддерживают брандмауэры и виртуальные сети.

Чтобы использовать неуправляемые диски в учетных записях хранения с действующими правилами сети относительно резервного копирования и восстановления виртуальных машин, необходимо создать исключение. Эта процедура описана в разделе [Исключения](#exceptions) данной статьи. Исключения брандмауэра не применяются к управляемым дискам, так как ими уже управляет Azure.

## <a name="change-the-default-network-access-rule"></a>Изменение сетевого правила доступа по умолчанию

По умолчанию учетные записи хранения принимают запросы на подключение от клиентов в сети. Для ограничения доступа из выбранных сетей необходимо сначала изменить действие по умолчанию.

> [!WARNING]
> Изменение сетевых правил может повлиять на возможность подключения приложений к службе хранилища Azure. Когда для сетевого правила по умолчанию указано значение **deny**, доступ к данным блокируется полностью, если только не применяются специальные сетевые правила, **разрешающие** доступ. Предоставьте доступ для разрешенных сетей с помощью сетевых правил, прежде чем изменить правила по умолчанию и запретить доступ.

### <a name="managing-default-network-access-rules"></a>Управление сетевыми правилами доступа по умолчанию

Вы можете управлять сетевыми правилами доступа по умолчанию для учетных записей хранения с помощью портала Azure, PowerShell или CLI версии 2.

#### <a name="azure-portal"></a>Портал Azure

1. Перейдите к учетной записи хранения, которую нужно защитить.

1. В меню Параметры выберите пункт **сети**.

1. Чтобы запретить доступ по умолчанию, разрешите доступ в разделе **Выбранные сети**. Чтобы разрешить передачу трафика из всех сетей, разрешите доступ в разделе **Все сети**.

1. Щелкните **Сохранить**, чтобы применить изменения.

#### <a name="powershell"></a>PowerShell

1. Установите [Azure PowerShell](/powershell/azure/install-Az-ps) и [выполните вход](/powershell/azure/authenticate-azureps).

1. Отобразите состояние правила по умолчанию для учетной записи хранения.

    ```powershell
    (Get-AzStorageAccountNetworkRuleSet -ResourceGroupName "myresourcegroup" -AccountName "mystorageaccount").DefaultAction
    ```

1. Настройте в правиле по умолчанию запрет сетевого доступа по умолчанию.

    ```powershell
    Update-AzStorageAccountNetworkRuleSet -ResourceGroupName "myresourcegroup" -Name "mystorageaccount" -DefaultAction Deny
    ```

1. Настройте в правиле по умолчанию разрешение сетевого доступа по умолчанию.

    ```powershell
    Update-AzStorageAccountNetworkRuleSet -ResourceGroupName "myresourcegroup" -Name "mystorageaccount" -DefaultAction Allow
    ```

#### <a name="cliv2"></a>CLI 2.0

1. Установите [Azure CLI](/cli/azure/install-azure-cli) и [выполните вход](/cli/azure/authenticate-azure-cli).

1. Отобразите состояние правила по умолчанию для учетной записи хранения.

    ```azurecli
    az storage account show --resource-group "myresourcegroup" --name "mystorageaccount" --query networkRuleSet.defaultAction
    ```

1. Настройте в правиле по умолчанию запрет сетевого доступа по умолчанию.

    ```azurecli
    az storage account update --resource-group "myresourcegroup" --name "mystorageaccount" --default-action Deny
    ```

1. Настройте в правиле по умолчанию разрешение сетевого доступа по умолчанию.

    ```azurecli
    az storage account update --resource-group "myresourcegroup" --name "mystorageaccount" --default-action Allow
    ```

## <a name="grant-access-from-a-virtual-network"></a>Предоставление доступа из виртуальной сети

Вы можете настроить учетные записи хранения таким образом, чтобы они разрешали доступ только из определенных подсетей. Разрешенные подсети могут относиться к виртуальной сети как в той же, так и в другой подписке, включая подписки, принадлежащие другому клиенту Azure Active Directory.

Включите [конечную точку службы](../../virtual-network/virtual-network-service-endpoints-overview.md) для службы хранилища Azure, входящей в нужную виртуальную сеть. Конечная точка службы направляет трафик из виртуальной сети в службу хранилища Azure по оптимальному пути. В каждом запросе также передаются удостоверения подсети и виртуальной сети. Затем администраторы могут настроить сетевые правила для учетной записи хранения, разрешающие получение запросов из определенных подсетей в виртуальной сети. Клиенты, которым предоставлен доступ по этим сетевым правилам, по прежнему должны выполнять требования авторизации учетной записи хранения, чтобы получать доступ к данным.

Каждая учетная запись хранения поддерживает до 200 правил виртуальной сети, которые могут сочетаться с [правилами IP-сети](#grant-access-from-an-internet-ip-range).

### <a name="available-virtual-network-regions"></a>Доступные регионы виртуальной сети

Как правило, конечные точки служб работают между виртуальными сетями и экземплярами служб в одном регионе Azure. При использовании конечных точек служб со службой хранилища Azure область применения расширяется и включает [связанный регион](../../best-practices-availability-paired-regions.md). Конечные точки служб обеспечивают непрерывность работы при отработке регионального отказа, а также доступ на чтение к экземплярам геоизбыточного хранилища (RA-GRS). Правила сети, предоставляющие доступ к учетной записи хранения из виртуальной сети, также предоставляют доступ к любому экземпляру RA-GRS.

Планируя аварийное восстановление на случай регионального сбоя, следует заранее создать виртуальные сети в связанном регионе. Включите конечные точки для службы хранилища Azure с применением сетевых правил, разрешающих доступ из этих альтернативных виртуальных сетей. Затем примените эти правила к учетным записям своего геоизбыточного хранилища.

> [!NOTE]
> Конечные точки службы не применяются к трафику за пределами региона виртуальной сети и заданного связанного региона. Сетевые правила, предоставляющие доступ к учетным записям хранения из виртуальных сетей, применяются только в основном регионе учетной записи хранения или в заданном связанном регионе.

### <a name="required-permissions"></a>Необходимые разрешения

Чтобы применить правило виртуальной сети к учетной записи хранения, у пользователя должны быть соответствующие разрешения для добавляемых подсетей. Это разрешение *Join Service to a Subnet* (Добавить службу к подсети), включенное во встроенную роль *Участник учетных записей хранения*. Его также можно добавить к определениям пользовательских ролей.

Учетная запись хранения и виртуальные сети, которым предоставлен доступ, могут находиться в разных подписках, включая подписки, являющиеся частью другого клиента Azure AD.

> [!NOTE]
> Настройка правил, предоставляющих доступ к подсетям в виртуальных сетях, которые являются частью другого клиента Azure Active Directory, в настоящее время поддерживаются только с помощью PowerShell, интерфейса командной строки и интерфейсов REST API. Такие правила нельзя настроить с помощью портала Azure, хотя на портале их можно просматривать.

### <a name="managing-virtual-network-rules"></a>Управление правилами виртуальной сети

Правилами виртуальной сети для учетных записей хранения можно управлять с помощью портала Azure, PowerShell или CLI версии 2.

#### <a name="azure-portal"></a>Портал Azure

1. Перейдите к учетной записи хранения, которую нужно защитить.

1. В меню Параметры выберите пункт **сети**.

1. Убедитесь, что вы разрешили доступ в разделе **Выбранные сети**.

1. Чтобы предоставить доступ виртуальной сети с новым сетевым правилом, в разделе **Виртуальные сети** выберите команду **Добавить существующую виртуальную сеть**, укажите параметры для пунктов **Виртуальные сети** и **Подсети**, а затем нажмите **Добавить**. Чтобы создать виртуальную сеть и предоставить ей доступ, выберите команду **Добавить новую виртуальную сеть**. Укажите сведения, необходимые для создания виртуальной сети, а затем нажмите **Создать**.

    > [!NOTE]
    > Если конечная точка службы для службы хранилища Azure еще не настроена для выбранной виртуальной сети и подсетей, ее можно настроить в ходе этой операции.
    >
    > В настоящее время при создании правила можно выбирать только из виртуальных сетей, принадлежащих одному и тому же клиенту Azure Active Directory. Чтобы предоставить доступ к подсети в виртуальной сети, принадлежащей другому клиенту, используйте PowerShell, интерфейс командной строки или интерфейсы REST API.

1. Если нужно удалить правила виртуальной сети или подсети, щелкните **...** , чтобы открыть контекстное меню для виртуальной сети или подсети, и выберите пункт **Удалить**.

1. Щелкните **Сохранить**, чтобы применить изменения.

#### <a name="powershell"></a>PowerShell

1. Установите [Azure PowerShell](/powershell/azure/install-Az-ps) и [выполните вход](/powershell/azure/authenticate-azureps).

1. Выведите список правил виртуальной сети.

    ```powershell
    (Get-AzStorageAccountNetworkRuleSet -ResourceGroupName "myresourcegroup" -AccountName "mystorageaccount").VirtualNetworkRules
    ```

1. Включите конечную точку службы для службы хранилища Azure в имеющейся виртуальной сети и подсети.

    ```powershell
    Get-AzVirtualNetwork -ResourceGroupName "myresourcegroup" -Name "myvnet" | Set-AzVirtualNetworkSubnetConfig -Name "mysubnet" -AddressPrefix "10.0.0.0/24" -ServiceEndpoint "Microsoft.Storage" | Set-AzVirtualNetwork
    ```

1. Добавьте сетевое правило для виртуальной сети и подсети.

    ```powershell
    $subnet = Get-AzVirtualNetwork -ResourceGroupName "myresourcegroup" -Name "myvnet" | Get-AzVirtualNetworkSubnetConfig -Name "mysubnet"
    Add-AzStorageAccountNetworkRule -ResourceGroupName "myresourcegroup" -Name "mystorageaccount" -VirtualNetworkResourceId $subnet.Id
    ```

    > [!TIP]
    > Чтобы добавить сетевое правило для подсети, принадлежащей другому клиенту Azure AD, используйте полный параметр **VirtualNetworkResourceId** в форме "/подписки/ИД_подписки/группыРесурсов/Имя_группыРесурсов/поставщики/Microsoft.Network/виртуальныеСети/имя_виртуальнойСети/подсети/имя_подсети".

1. Удалите сетевое правило для виртуальной сети и подсети.

    ```powershell
    $subnet = Get-AzVirtualNetwork -ResourceGroupName "myresourcegroup" -Name "myvnet" | Get-AzVirtualNetworkSubnetConfig -Name "mysubnet"
    Remove-AzStorageAccountNetworkRule -ResourceGroupName "myresourcegroup" -Name "mystorageaccount" -VirtualNetworkResourceId $subnet.Id
    ```

> [!IMPORTANT]
> Обязательно [укажите для правила по умолчанию](#change-the-default-network-access-rule) значение **deny**, иначе сетевые правила не будут действовать.

#### <a name="cliv2"></a>CLI 2.0

1. Установите [Azure CLI](/cli/azure/install-azure-cli) и [выполните вход](/cli/azure/authenticate-azure-cli).

1. Выведите список правил виртуальной сети.

    ```azurecli
    az storage account network-rule list --resource-group "myresourcegroup" --account-name "mystorageaccount" --query virtualNetworkRules
    ```

1. Включите конечную точку службы для службы хранилища Azure в имеющейся виртуальной сети и подсети.

    ```azurecli
    az network vnet subnet update --resource-group "myresourcegroup" --vnet-name "myvnet" --name "mysubnet" --service-endpoints "Microsoft.Storage"
    ```

1. Добавьте сетевое правило для виртуальной сети и подсети.

    ```azurecli
    subnetid=$(az network vnet subnet show --resource-group "myresourcegroup" --vnet-name "myvnet" --name "mysubnet" --query id --output tsv)
    az storage account network-rule add --resource-group "myresourcegroup" --account-name "mystorageaccount" --subnet $subnetid
    ```

    > [!TIP]
    > Чтобы добавить правило для подсети, принадлежащей другому клиенту Azure AD, используйте полный идентификатор подсети в формате "/Subscriptions/ \<subscription-ID\> /ResourceGroups/ \<resourceGroup-Name\> /провидерс/Микрософт.Нетворк/виртуалнетворкс/ \<vNet-name\> /субнетс/ \<subnet-name\> ".
    >
    > Чтобы получить идентификатор подсети для виртуальной сети, принадлежащей другому клиенту Azure AD, можно использовать параметр **subscription**.

1. Удалите сетевое правило для виртуальной сети и подсети.

    ```azurecli
    subnetid=$(az network vnet subnet show --resource-group "myresourcegroup" --vnet-name "myvnet" --name "mysubnet" --query id --output tsv)
    az storage account network-rule remove --resource-group "myresourcegroup" --account-name "mystorageaccount" --subnet $subnetid
    ```

> [!IMPORTANT]
> Обязательно [укажите для правила по умолчанию](#change-the-default-network-access-rule) значение **deny**, иначе сетевые правила не будут действовать.

## <a name="grant-access-from-an-internet-ip-range"></a>Предоставление доступа из диапазона IP-адресов в Интернете

Вы можете настроить учетные записи хранения так, чтобы разрешить доступ из определенных диапазонов общедоступных IP-адресов в Интернете. Такая конфигурация позволяет предоставить доступ конкретным интернет-службам и локальным сетям, заблокировав при этом общий интернет-трафик.

Предоставьте разрешенные диапазоны адресов в Интернете, используя [нотацию CIDR](https://tools.ietf.org/html/rfc4632) в формате *16.17.18.0/24* или в виде отдельных IP-адресов, таких как *16.17.18.19*.

   > [!NOTE]
   > Небольшие адреса, использующие размеры с префиксом /31 или /32, не поддерживаются. Эти диапазоны следует настраивать с помощью отдельных правил для IP-адресов.

Правила IP-сети можно применять только для **общедоступных** IP-адресов в Интернете. Диапазоны IP-адресов, зарезервированные для частных сетей (как определено в документе [RFC 1918](https://tools.ietf.org/html/rfc1918#section-3)), запрещено использовать в правилах IP. К частным сетям относятся адреса, начинающиеся с _10.*_ , _172.16.*_  - _172.31.*_ и _192.168.*_ .

   > [!NOTE]
   > Правила IP-сети не затрагивают запросы, исходящие из того же региона Azure, к которому относится учетная запись хранения. Используйте [правила виртуальной сети](#grant-access-from-a-virtual-network) для разрешения запросов из того же региона.

  > [!NOTE]
  > Службы, развернутые в том же регионе, что и учетная запись хранения, используют для обмена данными частные IP-адреса Azure. Таким образом, нельзя ограничить доступ к определенным службам Azure на основе их диапазона общедоступных исходящих IP-адресов.

Для настройки правил брандмауэра службы хранилища поддерживаются только IPv4-адреса.

Каждая учетная запись хранения поддерживает до 200 правил сети IP.

### <a name="configuring-access-from-on-premises-networks"></a>Настройка доступа из локальных сетей

Чтобы предоставить доступ из вашей локальной сети к учетной записи хранения в правиле IP-сети, необходимо определить IP-адреса для Интернета, которые используются в вашей сети. За помощью обращайтесь к администратору сети.

Если вы используете [ExpressRoute](../../expressroute/expressroute-introduction.md) для локальной среды, для общедоступного пиринга или пиринга Майкрософт, то вам необходимо определить используемые IP-адреса NAT. Для общедоступного пиринга в каждом канале ExpressRoute по умолчанию используется два IP-адреса NAT для трафика служб Azure, когда он входит в основную магистральную сеть Microsoft Azure. Для пиринга Майкрософт используются IP-адреса NAT, предоставленные либо клиентом, либо поставщиком услуг. Чтобы разрешить доступ к ресурсам служб, необходимо разрешить эти общедоступные IP-адреса в настройках брандмауэра IP-адресов ресурсов. Чтобы найти IP-адреса канала ExpressRoute для общедоступного пиринга, [отправьте запрос по ExpressRoute в службу поддержки](https://portal.azure.com/#blade/Microsoft_Azure_Support/HelpAndSupportBlade/overview) через портал Azure. Узнайте больше о [NAT для общедоступного пиринга и пиринга Майкрософт](../../expressroute/expressroute-nat.md#nat-requirements-for-azure-public-peering).

### <a name="managing-ip-network-rules"></a>Управление правилами IP-сети

Правилами IP-сети для учетных записей хранения можно управлять с помощью портала Azure, PowerShell или CLI версии 2.

#### <a name="azure-portal"></a>Портал Azure

1. Перейдите к учетной записи хранения, которую нужно защитить.

1. В меню Параметры выберите пункт **сети**.

1. Убедитесь, что вы разрешили доступ в разделе **Выбранные сети**.

1. Чтобы предоставить доступ к диапазону IP-адресов в Интернете, введите IP-адрес или диапазон адресов (в формате CIDR) в разделе **Брандмауэр** > **Диапазон адресов**.

1. Чтобы удалить правило IP-сети, щелкните значок корзины рядом с диапазоном адресов.

1. Щелкните **Сохранить**, чтобы применить изменения.

#### <a name="powershell"></a>PowerShell

1. Установите [Azure PowerShell](/powershell/azure/install-Az-ps) и [выполните вход](/powershell/azure/authenticate-azureps).

1. Выведите список правил IP-сети.

    ```powershell
    (Get-AzStorageAccountNetworkRuleSet -ResourceGroupName "myresourcegroup" -AccountName "mystorageaccount").IPRules
    ```

1. Добавьте правило сети для отдельного IP-адреса.

    ```powershell
    Add-AzStorageAccountNetworkRule -ResourceGroupName "myresourcegroup" -AccountName "mystorageaccount" -IPAddressOrRange "16.17.18.19"
    ```

1. Добавьте правило сети для диапазона IP-адресов.

    ```powershell
    Add-AzStorageAccountNetworkRule -ResourceGroupName "myresourcegroup" -AccountName "mystorageaccount" -IPAddressOrRange "16.17.18.0/24"
    ```

1. Удалите правило сети для отдельного IP-адреса.

    ```powershell
    Remove-AzStorageAccountNetworkRule -ResourceGroupName "myresourcegroup" -AccountName "mystorageaccount" -IPAddressOrRange "16.17.18.19"
    ```

1. Удалите правило сети для диапазона IP-адресов.

    ```powershell
    Remove-AzStorageAccountNetworkRule -ResourceGroupName "myresourcegroup" -AccountName "mystorageaccount" -IPAddressOrRange "16.17.18.0/24"
    ```

> [!IMPORTANT]
> Обязательно [укажите для правила по умолчанию](#change-the-default-network-access-rule) значение **deny**, иначе сетевые правила не будут действовать.

#### <a name="cliv2"></a>CLI 2.0

1. Установите [Azure CLI](/cli/azure/install-azure-cli) и [выполните вход](/cli/azure/authenticate-azure-cli).

1. Выведите список правил IP-сети.

    ```azurecli
    az storage account network-rule list --resource-group "myresourcegroup" --account-name "mystorageaccount" --query ipRules
    ```

1. Добавьте правило сети для отдельного IP-адреса.

    ```azurecli
    az storage account network-rule add --resource-group "myresourcegroup" --account-name "mystorageaccount" --ip-address "16.17.18.19"
    ```

1. Добавьте правило сети для диапазона IP-адресов.

    ```azurecli
    az storage account network-rule add --resource-group "myresourcegroup" --account-name "mystorageaccount" --ip-address "16.17.18.0/24"
    ```

1. Удалите правило сети для отдельного IP-адреса.

    ```azurecli
    az storage account network-rule remove --resource-group "myresourcegroup" --account-name "mystorageaccount" --ip-address "16.17.18.19"
    ```

1. Удалите правило сети для диапазона IP-адресов.

    ```azurecli
    az storage account network-rule remove --resource-group "myresourcegroup" --account-name "mystorageaccount" --ip-address "16.17.18.0/24"
    ```

> [!IMPORTANT]
> Обязательно [укажите для правила по умолчанию](#change-the-default-network-access-rule) значение **deny**, иначе сетевые правила не будут действовать.

## <a name="exceptions"></a>Исключения

Сетевые правила помогают создать безопасную среду для подключений между вашими приложениями и данными в большинстве сценариев. Однако некоторые приложения зависят от служб Azure, которые не могут быть однозначно изолированы с помощью правил виртуальной сети или IP-адресов. Но эти службы должны быть предоставлены службе хранилища для обеспечения полной функциональности приложения. В таких ситуациях можно использовать **_Разрешить доверенные службы Майкрософт..._* _ параметр, позволяющий таким службам получать доступ к данным, журналам или аналитике.

### <a name="trusted-microsoft-services"></a>Доверенные службы Майкрософт

Некоторые службы Майкрософт работают с сетями, которые нельзя включить в сетевые правила. Вы можете предоставить подмножеству таких доверенных служб Майкрософт доступ к учетной записи хранения, поддерживая сетевые правила для других приложений. Эти доверенные службы будут затем использовать строгую проверку подлинности для безопасного подключения к вашей учетной записи хранения. Мы включили два режима доверенного доступа для служб Майкрософт.

- Ресурсы некоторых служб, _ * при регистрации в подписке * *, могут получить доступ к вашей учетной записи хранения **в той же подписке** для операций выбора, таких как запись журналов или резервное копирование.
- Ресурсам некоторых служб можно предоставить явный доступ к учетной записи хранения, **назначив роли Azure** управляемому удостоверению, назначенному системой.


При включении параметра **Разрешить доверенные службы Майкрософт...** ресурсам следующих служб, зарегистрированным в той же подписке, что и ваша учетная запись хранения, предоставляется доступ для выполнения ограниченного набора операций, как описано ниже.

| Служба                  | Имя поставщика ресурсов     | Разрешенные операции                 |
|:------------------------ |:-------------------------- |:---------------------------------- |
| Azure Backup             | Microsoft.RecoveryServices | Резервное копирование и восстановление неуправляемых дисков в виртуальных машинах IAAS. (Не требуется для управляемых дисков.) [Подробнее](../../backup/backup-overview.md). |
| Azure Data Box           | Microsoft.DataBox          | Позволяет импортировать данные в Azure с помощью Data Box. [Подробнее](../../databox/data-box-overview.md). |
| Azure DevTest Labs       | Microsoft.DevTestLab       | Создание пользовательских образов и установка артефактов. [Подробнее](../../devtest-labs/devtest-lab-overview.md). |
| Сетка событий Azure         | Microsoft.EventGrid        | Включение публикации событий в хранилище BLOB-объектов и предоставление службе "Сетка событий" разрешения на публикацию в хранилище очередей. См. дополнительные сведения о [событиях хранилища BLOB-объектов](../../event-grid/overview.md#event-sources) и [публикации в хранилище очередей](../../event-grid/event-handlers.md). |
| Центры событий Azure         | Microsoft.EventHub         | Архивация данных с помощью функции "Сбор" в Центрах событий. [Подробнее](../../event-hubs/event-hubs-capture-overview.md) |
| Служба синхронизации файлов Azure          | Microsoft.StorageSync      | Позволяет преобразовать локальный файловый сервер в кэш для общих папок Azure. Таким образом создается возможность многосайтовой синхронизации, быстрого аварийного восстановления и резервного копирования на стороне облака. [Дополнительные сведения](../files/storage-sync-files-planning.md) |
| Azure HDInsight          | Microsoft.HDInsight        | Подготавливает начальное содержимое файловой системы по умолчанию для нового кластера HDInsight. [Подробнее](../../hdinsight/hdinsight-hadoop-use-blob-storage.md). |
| Импорт и экспорт Azure      | Microsoft.ImportExport     | Позволяет импортировать данные в службу хранилища Azure или экспортировать данные из хранилища Azure с помощью службы импорта и экспорта хранилища Azure. [Подробнее](./storage-import-export-service.md).  |
| Azure Monitor            | Microsoft.Insights         | Позволяет записывать в защищенную учетную запись хранения данные мониторинга, в том числе журналы ресурсов, журналы входа и аудита Azure Active Directory, а также журналы Microsoft Intune. [Подробнее](../../azure-monitor/platform/roles-permissions-security.md). |
| Сеть Azure         | Microsoft.Network.          | Хранение и анализ журналов сетевого трафика, в том числе с помощью наблюдателя за сетями и служб Аналитика трафика. [Подробнее](../../network-watcher/network-watcher-nsg-flow-logging-overview.md). |
| Azure Site Recovery      | Microsoft.SiteRecovery     | Включение репликации для аварийного восстановления виртуальных машин IaaS Azure при использовании кэша, источника или целевых учетных записей хранения с поддержкой брандмауэра.  [Подробнее](../../site-recovery/azure-to-azure-tutorial-enable-replication.md). |

Параметр **Разрешить доверенные службы Майкрософт...** также позволяет определенному экземпляру следующих служб получить доступ к учетной записи хранения, если [роль Azure](storage-auth-aad.md#assign-azure-roles-for-access-rights) явно назначена [управляемому удостоверению, назначенному системой](../../active-directory/managed-identities-azure-resources/overview.md) для этого экземпляра ресурса. В таком случае область доступа для этого экземпляра соответствует роли Azure, назначенной управляемому удостоверению.

| Служба                        | Имя поставщика ресурсов                 | Назначение            |
| :----------------------------- | :------------------------------------- | :----------------- |
| Служба "Управление API Azure"           | Microsoft.ApiManagement/service        | Включает доступ службы управления API к учетным записям хранения за брандмауэром с помощью политик. [Подробнее.](../../api-management/api-management-authentication-policies.md#use-managed-identity-in-send-request-policy) |
| Когнитивный поиск Azure         | Microsoft.Search/searchServices        | Разрешает службам Когнитивного поиска доступ к учетным записям хранения для индексирования, обработки и выполнения запросов. |
| Azure Cognitive Services       | Microsoft. Когнитивесервице             | Разрешает Cognitive Services доступ к учетным записям хранения. |
| Задачи Реестра контейнеров Azure | Microsoft.ContainerRegistry/registries | Задачи Реестра контейнеров Azure могут получать доступ к учетным записям хранения при создании образов контейнеров. |
| Фабрика данных Azure             | Microsoft.DataFactory/factories;        | Разрешает доступ к учетным записям хранения через среду ADF. |
| Azure Data Share               | Microsoft.DataShare/accounts           | Разрешает доступ к учетным записям хранения через Data Share. |
| Центр Интернета вещей Azure                  | Microsoft.Devices/IotHubs              | Позволяет записывать данные из центра Интернета вещей в хранилище BLOB-объектов. [Дополнительные сведения](../../iot-hub/virtual-network-support.md#egress-connectivity-to-storage-account-endpoints-for-routing) |
| Azure Logic Apps               | Microsoft.Logic/workflows              | Позволяет приложениям логики получать доступ к учетным записям хранения. [Подробнее](../../logic-apps/create-managed-service-identity.md#authenticate-access-with-managed-identity). |
| Служба "Машинное обучение Azure" | Microsoft.MachineLearningServices      | Авторизованные рабочие области Машинного обучения Azure записывают выходные данные эксперимента, модели и журналы в хранилище BLOB-объектов и читают данные. [Подробнее](../../machine-learning/how-to-network-security-overview.md#secure-the-workspace-and-associated-resources). | 
| Azure Synapse Analytics       | Microsoft.Sql                          | Позволяет импортировать и экспортировать данные из конкретных баз данных SQL с помощью инструкции COPY или Polybase. [Подробнее.](../../azure-sql/database/vnet-service-endpoint-rule-overview.md) |
| База данных SQL Azure       | Microsoft.Sql                          | Позволяет [импортировать](/sql/t-sql/statements/bulk-insert-transact-sql#f-importing-data-from-a-file-in-azure-blob-storage) данные из учетных записей хранения и [записывать](../../azure-sql/database/audit-write-storage-account-behind-vnet-firewall.md) данные аудита в учетные записи хранения, защищенные брандмауэром. |
| Azure Stream Analytics         | Microsoft.StreamAnalytics             | Позволяет записывать данные из задания потоковой передачи в хранилище BLOB-объектов. [Подробнее](../../stream-analytics/blob-output-managed-identity.md). |
| Azure Synapse Analytics        | Microsoft.Synapse/workspaces          | Обеспечивает доступ к данным в службе хранилища Azure из Azure синапсе Analytics. |


### <a name="storage-analytics-data-access"></a>Доступ к данным аналитики хранилища

В некоторых случаях для чтения метрик и журналов ресурсов требуется доступ из-за пределов границ сети. При настройке доступа доверенных служб к учетной записи хранения можно разрешить доступ на чтение файлов журнала, таблиц метрик или и того, и другого. Дополнительные сведения о работе с аналитикой хранилища см. в [этой статье](./storage-analytics.md).

### <a name="managing-exceptions"></a>Управление исключениями

Исключениями из правил сети можно управлять с помощью портала Azure, PowerShell или Azure CLI v2.

#### <a name="azure-portal"></a>Портал Azure

1. Перейдите к учетной записи хранения, которую нужно защитить.

1. В меню Параметры выберите пункт **сети**.

1. Убедитесь, что вы разрешили доступ в разделе **Выбранные сети**.

1. В разделе **Исключения** выберите те исключения, которые нужно предоставить.

1. Щелкните **Сохранить**, чтобы применить изменения.

#### <a name="powershell"></a>PowerShell

1. Установите [Azure PowerShell](/powershell/azure/install-Az-ps) и [выполните вход](/powershell/azure/authenticate-azureps).

1. Отобразите исключения для сетевых правил учетной записи хранения.

    ```powershell
    (Get-AzStorageAccountNetworkRuleSet -ResourceGroupName "myresourcegroup" -Name "mystorageaccount").Bypass
    ```

1. Настройте исключения для сетевых правил учетной записи хранения.

    ```powershell
    Update-AzStorageAccountNetworkRuleSet -ResourceGroupName "myresourcegroup" -Name "mystorageaccount" -Bypass AzureServices,Metrics,Logging
    ```

1. Удалите исключения для сетевых правил учетной записи хранения.

    ```powershell
    Update-AzStorageAccountNetworkRuleSet -ResourceGroupName "myresourcegroup" -Name "mystorageaccount" -Bypass None
    ```

> [!IMPORTANT]
> Обязательно [укажите для правила по умолчанию](#change-the-default-network-access-rule) значение **deny**, иначе исключение не будет действовать.

#### <a name="cliv2"></a>CLI 2.0

1. Установите [Azure CLI](/cli/azure/install-azure-cli) и [выполните вход](/cli/azure/authenticate-azure-cli).

1. Отобразите исключения для сетевых правил учетной записи хранения.

    ```azurecli
    az storage account show --resource-group "myresourcegroup" --name "mystorageaccount" --query networkRuleSet.bypass
    ```

1. Настройте исключения для сетевых правил учетной записи хранения.

    ```azurecli
    az storage account update --resource-group "myresourcegroup" --name "mystorageaccount" --bypass Logging Metrics AzureServices
    ```

1. Удалите исключения для сетевых правил учетной записи хранения.

    ```azurecli
    az storage account update --resource-group "myresourcegroup" --name "mystorageaccount" --bypass None
    ```

> [!IMPORTANT]
> Обязательно [укажите для правила по умолчанию](#change-the-default-network-access-rule) значение **deny**, иначе исключение не будет действовать.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о конечных точках службы сети Azure см. в статье [Конечные точки службы виртуальной сети](../../virtual-network/virtual-network-service-endpoints-overview.md).

Более подробную информацию о безопасности службы хранилища Azure см. в статье [Руководство по безопасности службы хранилища Azure](../blobs/security-recommendations.md).
