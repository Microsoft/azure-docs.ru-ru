---
title: Настройка, оптимизация и устранение неполадок AzCopy в службе хранилища Azure | Документация Майкрософт
description: Настройка, оптимизация и устранение неполадок AzCopy в службе хранилища Azure. Измените расположение или удалите файлы плана и журнала. Измените уровень ведения журнала по умолчанию.
author: normesta
ms.service: storage
ms.topic: how-to
ms.date: 07/27/2020
ms.author: normesta
ms.subservice: common
ms.reviewer: dineshm
ms.openlocfilehash: 244012f0945f467fe79e95d652ba22e3b62a1b7a
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "100596936"
---
# <a name="configure-optimize-and-troubleshoot-azcopy"></a>Configure, optimize, and troubleshoot AzCopy (Настройка, оптимизация и устранение неполадок с AzCopy)

AzCopy — это служебная программа командной строки, которую можно использовать для копирования больших двоичных объектов или файлов в учетную запись хранения или из нее. Эта статья поможет вам выполнить дополнительные задачи по настройке и устранить неполадки, которые могут возникнуть при использовании AzCopy.

> [!NOTE]
> Если вы ищете содержимое, которое поможет приступить к работе с AzCopy, ознакомьтесь со следующими статьями:
> - [Get started with AzCopy](storage-use-azcopy-v10.md) (Начало работы с AzCopy)
> - [Transfer data with AzCopy and blob storage](./storage-use-azcopy-v10.md#transfer-data) (Передача данных с помощью AzCopy и хранилища BLOB-объектов)
> - [Transfer data with AzCopy and file storage](storage-use-azcopy-files.md) (Передача данных с помощью AzCopy и хранилища файлов)
> - [Передача данных с помощью AzCopy и контейнеров Amazon S3](storage-use-azcopy-s3.md)

## <a name="configure-proxy-settings"></a>Настройка параметров прокси

Чтобы настроить параметры прокси-сервера для AzCopy, задайте `HTTPS_PROXY` переменную среды. Если AzCopy выполняется в среде Windows, средство AzCopy автоматически определяет параметры прокси-сервера, поэтому в Windows этот параметр не нужно использовать. Если вы укажете этот параметр в Windows, он переопределит автоматически определяемое значение.

| Операционная система | Команда  |
|--------|-----------|
| **Windows** | В командной строке используйте `set HTTPS_PROXY=<proxy IP>:<proxy port>`.<br> В PowerShell используйте `$env:HTTPS_PROXY="<proxy IP>:<proxy port>"`.|
| **Linux** | `export HTTPS_PROXY=<proxy IP>:<proxy port>` |
| **macOS** | `export HTTPS_PROXY=<proxy IP>:<proxy port>` |

В настоящее время AzCopy не поддерживает прокси-серверы, для которых требуется проверка подлинности с помощью NTLM или Kerberos.

### <a name="bypassing-a-proxy"></a>Обход прокси-сервера ###

Если вы используете AzCopy в Windows и хотите, чтобы он _не использовал ни один_ прокси-сервер (вместо автоматического обнаружения параметров), используйте эти команды. С этими параметрами AzCopy не будет искать или пытаться использовать какой-либо прокси.

| Операционная система | Среда | Команды  |
|--------|-----------|----------|
| **Windows** | Командная строка (CMD) | `set HTTPS_PROXY=dummy.invalid` <br>`set NO_PROXY=*`|
| **Windows** | PowerShell | `$env:HTTPS_PROXY="dummy.invalid"` <br>`$env:NO_PROXY="*"`<br>|

В других операционных системах просто оставьте переменную HTTPS_PROXY неопределенной, если вы хотите использовать не прокси.

## <a name="optimize-performance"></a>Оптимизация производительности

Вы можете протестировать производительность, а затем использовать команды и переменные среды для поиска оптимального компромисса между производительностью и потреблением ресурсов.

Этот раздел поможет вам выполнить следующие задачи оптимизации:

> [!div class="checklist"]
> * Запуск тестов производительности
> * Оптимизация пропускной способности
> * Оптимизация использования памяти 
> * Оптимизация синхронизации файлов

### <a name="run-benchmark-tests"></a>Запуск тестов производительности

Вы можете запустить тест производительности для конкретных контейнеров больших двоичных объектов или файловых ресурсов, чтобы просмотреть общую статистику производительности и узкие места в производительности идентификации. Тест можно запустить путем отправки или скачивания созданных тестовых данных. 

Используйте следующую команду, чтобы запустить тест производительности.

|    |     |
|--------|-----------|
| **Синтаксис** | `azcopy benchmark 'https://<storage-account-name>.blob.core.windows.net/<container-name>'` |
| **Пример** | `azcopy benchmark 'https://mystorageaccount.blob.core.windows.net/mycontainer/myBlobDirectory?sv=2018-03-28&ss=bjqt&srs=sco&sp=rjklhjup&se=2019-05-10T04:37:48Z&st=2019-05-09T20:37:48Z&spr=https&sig=%2FSOVEFfsKDqRry4bk3qz1vAQFwY5DDzp2%2B%2F3Eykf%2FJLs%3D'` |

> [!TIP]
> В этом примере аргументы пути заключаются в одинарные кавычки (' '). Используйте одинарные кавычки во всех командных оболочках, кроме командной оболочки Windows (cmd.exe). Если вы используете командную оболочку Windows (cmd.exe), заключите аргументы пути в двойные кавычки ("") вместо одинарных кавычек ("").

Эта команда запускает нагрузочный тест производительности, загружая проверочные данные в указанное место назначения. Тестовые данные создаются в памяти, передаются в место назначения, а затем удаляются из места назначения после завершения теста. Можно указать количество создаваемых файлов и размер, который нужно создать, с помощью необязательных параметров команды.

Если вы предпочитаете выполнять этот тест, загрузив данные, задайте `mode` для параметра значение `download` . Подробную справочную документацию см. в разделе [azcopyный тест производительности](storage-ref-azcopy-bench.md). 

### <a name="optimize-throughput"></a>Оптимизация пропускной способности

Вы можете использовать `cap-mbps` флаг в командах, чтобы поместить потолк на скорость передачи данных. Например, следующая команда возобновляет задание и пропускную способность Caps `10` -Мбит/с (МБ) в секунду. 

```azcopy
azcopy jobs resume <job-id> --cap-mbps 10
```

Пропускная способность может уменьшиться при передаче небольших файлов. Можно увеличить пропускную способность, задав `AZCOPY_CONCURRENCY_VALUE` переменную среды. Эта переменная указывает количество одновременных запросов, которые могут быть выполнены.  

Если на компьютере установлено менее 5 ЦП, значение этой переменной будет равно `32` . В противном случае значение по умолчанию равно 16, умноженному на число ЦП. Максимальное значение по умолчанию для этой переменной равно `3000` , но можно вручную задать это значение выше или ниже. 

| Операционная система | Команда  |
|--------|-----------|
| **Windows** | `set AZCOPY_CONCURRENCY_VALUE=<value>` |
| **Linux** | `export AZCOPY_CONCURRENCY_VALUE=<value>` |
| **macOS** | `export AZCOPY_CONCURRENCY_VALUE=<value>` |

Используйте `azcopy env` для проверки текущего значения этой переменной. Если значение пустое, то можно считать, какое значение используется, просмотрев начало любого файла журнала AzCopy. Выбранное значение и причина, по которой он был выбран, включаются в отчет.

Перед установкой этой переменной рекомендуется запустить тест производительности. Процесс тестирования производительности будет сообщать о рекомендуемом значении параллелизма. Кроме того, если условия сети и полезные данные различаются, присвойте этой переменной слово, `AUTO` а не определенное число. Это приведет к тому, что AzCopy всегда будет выполнять тот же процесс автоматической настройки, который используется в тестах производительности.

### <a name="optimize-memory-use"></a>Оптимизация использования памяти

Задайте `AZCOPY_BUFFER_GB` переменную среды, чтобы указать максимальный объем системной памяти, который будет использоваться AzCopy при скачивании и отправке файлов.
Выразить это значение в гигабайтах (ГБ).

| Операционная система | Команда  |
|--------|-----------|
| **Windows** | `set AZCOPY_BUFFER_GB=<value>` |
| **Linux** | `export AZCOPY_BUFFER_GB=<value>` |
| **macOS** | `export AZCOPY_BUFFER_GB=<value>` |

### <a name="optimize-file-synchronization"></a>Оптимизация синхронизации файлов

Команда [Sync](storage-ref-azcopy-sync.md) определяет все файлы в месте назначения, а затем сравнивает имена файлов и метки времени последнего изменения перед началом операции синхронизации. Если у вас много файлов, можно повысить производительность, изменив эту обработку. 

Для этого используйте команду [azcopy Copy](storage-ref-azcopy-copy.md) , а затем установите `--overwrite` для флага значение `ifSourceNewer` . AzCopy будет сравнивать файлы при копировании без выполнения сквозной проверки и сравнения. Это обеспечивает производительность в тех случаях, когда требуется сравнить большое количество файлов.

Команда [azcopy Copy](storage-ref-azcopy-copy.md) не удаляет файлы из места назначения, поэтому если вы хотите удалить файлы в месте назначения, когда они больше не существуют в источнике, используйте команду [azcopy Sync](storage-ref-azcopy-sync.md) с `--delete-destination` флагом, установленным в значение `true` или `prompt` . 

## <a name="troubleshoot-issues"></a>Устранение неполадок

AzCopy создает файлы журналов и планов для каждого задания. Вы можете использовать журналы для исследования и устранения возможных проблем. 

Журналы будут содержать состояние сбой ( `UPLOADFAILED` , `COPYFAILED` и `DOWNLOADFAILED` ), полный путь и причину сбоя.

По умолчанию файлы журнала и плана находятся в `%USERPROFILE%\.azcopy` каталоге в Windows или `$HOME$\.azcopy` каталоге в Mac и Linux, но при необходимости вы можете изменить это расположение.

Соответствующая ошибка не обязательно является первой ошибкой, которая появляется в файле. Для таких ошибок, как ошибки сети, время ожидания и ошибки занятости сервера, AzCopy повторит попытку до 20 раз, и обычно повторная попытка будет выполнена.  Первая отображаемая ошибка может быть вызвана неудачной попыткой повторной попытки.  Поэтому вместо просмотра первой ошибки в файле найдите ошибки, которые находятся рядом с, `UPLOADFAILED` `COPYFAILED` или `DOWNLOADFAILED` . 

> [!IMPORTANT]
> При отправке запроса на служба поддержки Майкрософт (или при устранении неполадки, связанной с третьей стороной), предоставьте общий доступ к показана исправленная версия версии команды, которую нужно выполнить. Это гарантирует, что SAS не будет случайно предоставлен всем. Вы можете найти исправленную версию в начале файла журнала.

### <a name="review-the-logs-for-errors"></a>Проверка журналов на наличие ошибок

Следующая команда получит все ошибки с `UPLOADFAILED` состоянием из `04dc9ca9-158f-7945-5933-564021086c79` журнала:

**Windows (PowerShell)**

```
Select-String UPLOADFAILED .\04dc9ca9-158f-7945-5933-564021086c79.log
```

**Linux**

```
grep UPLOADFAILED .\04dc9ca9-158f-7945-5933-564021086c79.log
```

### <a name="view-and-resume-jobs"></a>Просмотр и возобновление задания

В рамках каждой операции передачи будет создано задание AzCopy. Чтобы просмотреть журнал заданий, используйте следующую команду:

```
azcopy jobs list
```

Чтобы просмотреть статистику задания, используйте следующую команду:

```
azcopy jobs show <job-id>
```

Чтобы отфильтровать операции передачи по состоянию, используйте следующую команду:

```
azcopy jobs show <job-id> --with-status=Failed
```

Используйте следующую команду, чтобы возобновить задание, завершившееся сбоем или отмененным. Эта команда использует свой идентификатор вместе с маркером SAS, так как он не является постоянным в целях безопасности:

```
azcopy jobs resume <job-id> --source-sas="<sas-token>"
azcopy jobs resume <job-id> --destination-sas="<sas-token>"
```

> [!TIP]
> Заключите аргументы пути, такие как маркер SAS, с одинарными кавычками (' '). Используйте одинарные кавычки во всех командных оболочках, кроме командной оболочки Windows (cmd.exe). Если вы используете командную оболочку Windows (cmd.exe), заключите аргументы пути в двойные кавычки ("") вместо одинарных кавычек ("").

При возобновлении задания AzCopy просматривает файл плана задания. В файле плана перечислены все файлы, обнаруженные для обработки при первом создании задания. При возобновлении задания AzCopy попытается перенести все файлы, перечисленные в файле плана, который еще не был передан.

## <a name="change-the-location-of-the-plan-and-log-files"></a>Изменение расположения файлов плана и журнала

По умолчанию файлы плана и журнала находятся в каталоге в `%USERPROFILE%\.azcopy` Windows или в `$HOME/.azcopy` каталоге на компьютерах Mac и Linux. Это расположение можно изменить.

### <a name="change-the-location-of-plan-files"></a>Изменение расположения файлов планов

Используйте любую из этих команд.

| Операционная система | Команда  |
|--------|-----------|
| **Windows** | Оболочк`$env:AZCOPY_JOB_PLAN_LOCATION="<value>"` <br> В командной строке используйте: `set AZCOPY_JOB_PLAN_LOCATION=<value>` |
| **Linux** | `export AZCOPY_JOB_PLAN_LOCATION=<value>` |
| **macOS** | `export AZCOPY_JOB_PLAN_LOCATION=<value>` |

Используйте `azcopy env` для проверки текущего значения этой переменной. Если значение пустое, файлы планов записываются в расположение по умолчанию.

### <a name="change-the-location-of-log-files"></a>Изменение расположения файлов журнала

Используйте любую из этих команд.

| Операционная система | Команда  |
|--------|-----------|
| **Windows** | Оболочк`$env:AZCOPY_LOG_LOCATION="<value>"` <br> В командной строке используйте: `set AZCOPY_LOG_LOCATION=<value>`|
| **Linux** | `export AZCOPY_LOG_LOCATION=<value>` |
| **macOS** | `export AZCOPY_LOG_LOCATION=<value>` |

Используйте `azcopy env` для проверки текущего значения этой переменной. Если значение пустое, журналы записываются в расположение по умолчанию.

## <a name="change-the-default-log-level"></a>Изменение уровня ведения журнала по умолчанию

По умолчанию для уровня ведения журнала AzCopy задано значение `INFO` . Если вы хотите уменьшить уровень детализации журнала, чтобы сэкономить место на диске, перепишите этот параметр с помощью ``--log-level`` параметра. 

Доступны следующие уровни ведения журнала: `NONE` , `DEBUG` , `INFO` ,,, `WARNING` `ERROR` `PANIC` и `FATAL` .

## <a name="remove-plan-and-log-files"></a>Удаление файлов плана и журнала

Если вы хотите удалить все файлы планов и журналов с локального компьютера, чтобы сэкономить место на диске, используйте `azcopy jobs clean` команду.

Чтобы удалить файлы плана и журнала, связанные только с одним заданием, используйте `azcopy jobs rm <job-id>` . Замените `<job-id>` заполнитель в этом примере идентификатором задания.
