---
title: Предоставление ограниченного доступа к данным с помощью подписанных URL-адресов (SAS)
titleSuffix: Azure Storage
description: Узнайте об использовании подписанных URL-адресов (SAS) для делегирования доступа к ресурсам службы хранилища Azure, включая большие двоичные объекты, очереди, таблицы и файлы.
services: storage
author: tamram
ms.service: storage
ms.topic: conceptual
ms.date: 12/28/2020
ms.author: tamram
ms.reviewer: dineshm
ms.subservice: common
ms.openlocfilehash: 51e73222233602491b0c8ed3835d032610c68e0d
ms.sourcegitcommit: e6de1702d3958a3bea275645eb46e4f2e0f011af
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "104722792"
---
# <a name="grant-limited-access-to-azure-storage-resources-using-shared-access-signatures-sas"></a>Предоставление ограниченного доступа к ресурсам службы хранилища Azure с помощью подписанных URL-адресов (SAS)

Подписанный URL-адрес (SAS) обеспечивает безопасный делегированный доступ к ресурсам в вашей учетной записи хранения. С помощью SAS вы можете детально контролировать, как клиент может получить доступ к данным. Пример:
 
- Ресурсы, к которым может получить доступ клиент.

- Какие разрешения они имеют для этих ресурсов.

- Срок действия SAS.

## <a name="types-of-shared-access-signatures"></a>Типы подписанных URL-адресов

Служба хранилища Azure поддерживает три типа подписанных URL:

- SAS делегирования пользователя

- SAS службы

- SAS учетной записи

### <a name="user-delegation-sas"></a>SAS делегирования пользователя

SAS делегирования пользователя защищен с учетными данными Azure Active Directory (Azure AD), а также с разрешениями, указанными для SAS. SAS делегирования пользователя применяется только к хранилищу BLOB-объектов.

Дополнительные сведения о сопоставлении безопасности для делегирования пользователей см. в статье [Создание SAS для делегирования пользователей (REST API)](/rest/api/storageservices/create-user-delegation-sas).

### <a name="service-sas"></a>SAS службы

SAS службы защищен с помощью ключа учетной записи хранения. SAS службы делегирует доступ к ресурсу только в одной из служб хранилища Azure: хранилище BLOB-объектов, хранилище очередей, хранилище таблиц или файлы Azure.

Дополнительные сведения об SAS службы см. в разделе [Создание SAS службы (REST API)](/rest/api/storageservices/create-service-sas).

### <a name="account-sas"></a>SAS учетной записи

SAS учетной записи защищен с помощью ключа учетной записи хранения. SAS учетной записи делегирует доступ к ресурсам в одной или нескольких службах хранилища. Все операции, доступные через SAS службы или делегирования пользователя, также доступны через SAS учетной записи. 

Вы также можете делегировать доступ следующим параметрам:

- Операции уровня службы (например, **свойства Get/Set Service** и **Get Service stats** ). 

- Операции чтения, записи и удаления, которые не разрешены с помощью SAS службы. 

Чтобы получить дополнительные сведения о SAS учетной записи, [Создайте SAS учетной записи (REST API)](/rest/api/storageservices/create-account-sas).

> [!NOTE]
> Корпорация Майкрософт рекомендует использовать учетные данные Azure AD, если это возможно в целях безопасности, вместо использования ключа учетной записи, что может быть более легко скомпрометировано. Если для разработки приложения требуются подписанные URL-адрес для доступа к хранилищу BLOB-объектов, используйте учетные данные Azure AD для создания SAS делегирования пользователя, если это возможно для обеспечения высокого уровня безопасности. Дополнительные сведения см. [в разделе Авторизация доступа к BLOB-объектам и очередям с помощью Azure Active Directory](storage-auth-aad.md).

Подпись общего доступа может принимать одну из следующих двух форм:

- **Нерегламентированные SAS**. При создании нерегламентированного SAS время начала, время окончания срока действия и разрешения указываются в URI SAS. Любой тип SAS может быть нерегламентированным SAS.

- **SAS службы с хранимой политикой доступа**. Хранимая политика доступа определяется в контейнере ресурсов, который может быть контейнером больших двоичных объектов, таблицей, очередью или общей папкой. Хранимую политику доступа можно использовать для управления ограничениями для одного или нескольких подписанных URL общих прав службы. При связывании SAS службы с хранимой политикой доступа SAS наследует ограничения &mdash; на время начала, время окончания срока действия и разрешения, &mdash; определенные для хранимой политики доступа.

> [!NOTE]
> SAS для делегирования пользователей или SAS учетной записи должен быть нерегламентированным SAS. Хранимые политики доступа не поддерживаются для подписок на делегирование пользователей или SAS учетной записи.

## <a name="how-a-shared-access-signature-works"></a>Принцип работы подписанного URL-адреса

Подпись общего доступа представляет собой подписанный универсальный код ресурса (URI), указывающий на один или несколько ресурсов хранилища. URI включает маркер, содержащий специальный набор параметров запроса. Маркер определяет способы доступа к ресурсам, предоставляемые клиенту. Один из параметров запроса, сигнатура, создается на основе параметров SAS и подписывается ключом, который использовался для создания SAS. Эта подпись используется в службе хранилища Azure для авторизации доступа к ресурсу хранилища.

> [!NOTE]
> Аудит создания маркеров SAS невозможен. Любой пользователь, имеющий права на создание маркера SAS с помощью ключа учетной записи или назначения роли RBAC Azure, может сделать это без знания владельца учетной записи хранения. Будьте внимательны, чтобы ограничить разрешения, позволяющие пользователям создавать маркеры SAS. Чтобы запретить пользователям создавать SAS, подписанный ключом учетной записи для рабочих нагрузок BLOB-объектов и очередей, можно запретить доступ к учетной записи хранения для общего ключа. Дополнительные сведения см. в разделе [предотвращение авторизации с помощью общего ключа](shared-key-authorization-prevent.md).

### <a name="sas-signature-and-authorization"></a>Подпись и авторизация SAS

Маркер SAS можно подписать с помощью ключа делегирования пользователя или ключа учетной записи хранения (общий ключ). 

#### <a name="signing-a-sas-token-with-a-user-delegation-key"></a>Подписывание маркера SAS с помощью ключа делегирования пользователя

Маркер SAS можно подписать с помощью *ключа делегирования пользователя* , созданного с помощью учетных данных Azure Active Directory (Azure AD). Подписанный URL-адрес делегирования пользователя подписывается с помощью ключа делегирования пользователя.

Чтобы получить ключ, а затем создать SAS, субъекту безопасности Azure AD должна быть назначена роль Azure, которая включает `Microsoft.Storage/storageAccounts/blobServices/generateUserDelegationKey` действие. Дополнительные сведения см. [в разделе Создание SAS для делегирования пользователей (REST API)](/rest/api/storageservices/create-user-delegation-sas).

#### <a name="signing-a-sas-token-with-an-account-key"></a>Подписывание маркера SAS с помощью ключа учетной записи

Как SAS службы, так и SAS учетной записи подписываются с помощью ключа учетной записи хранения. Чтобы создать SAS, подписанный с помощью ключа учетной записи, приложение должно иметь доступ к ключу учетной записи.

Если запрос включает маркер SAS, этот запрос является полномочным в зависимости от того, как подписан маркер SAS. Ключ доступа или учетные данные, используемые для создания маркера SAS, также используются службой хранилища Azure для предоставления доступа к клиенту, который имеет SAS.

В следующей таблице приведена сводка по авторизации каждого типа маркера SAS.

| Тип SAS | Тип авторизации |
|-|-|
| SAS делегирования пользователя (только хранилище BLOB-объектов) | Azure AD |
| SAS службы | Общий ключ |
| SAS учетной записи | Общий ключ |

Корпорация Майкрософт рекомендует использовать SAS для делегирования пользователей, если это возможно для обеспечения высокого уровня безопасности.

### <a name="sas-token"></a>Маркер SAS

Маркер SAS представляет собой строку, созданную на стороне клиента, например с помощью одной из клиентских библиотек службы хранилища Azure. По каким-либо образом служба хранилища Azure не следит за маркером SAS. На стороне клиента можно создать неограниченное число маркеров SAS. После создания SAS его можно распространить в клиентские приложения, которым требуется доступ к ресурсам в вашей учетной записи хранения.

Клиентские приложения предоставляют URI SAS в хранилище Azure как часть запроса. Затем служба проверяет параметры SAS и подпись, чтобы убедиться, что она действительна. Если служба подтверждает эту подпись, выполнение запроса разрешается. В противном случае запрос отклоняется и происходит ошибка с кодом 403 (запрещено).

Ниже приведен пример URI-кода SAS службы, в котором показаны URI ресурса и маркер SAS. Так как маркер SAS состоит из строки запроса URI, необходимо сначала указать URI ресурса, а затем — маркер SAS:

![Компоненты URI SAS службы](./media/storage-sas-overview/sas-storage-uri.png)

## <a name="when-to-use-a-shared-access-signature"></a>Когда следует использовать подписанный URL-доступ

Используйте SAS, чтобы предоставить защищенный доступ к ресурсам в вашей учетной записи хранения любому клиенту, который в противном случае не имеет разрешений для этих ресурсов.

Распространенным сценарием использования подписей общего доступа является служба, где пользователи считывают и записывают собственные данные в вашей учетной записи хранения. В сценарии, где в учетной записи хранения хранятся пользовательские данные, существует два направления разработки:

1. Клиенты отправляют и скачивают данные с помощью службы интерфейсного прокси-сервера, выполняющей аутентификацию. Эта служба внешнего прокси-сервера позволяет проверить бизнес-правила. Но для больших объемов данных или крупномасштабных транзакций создание службы, которая может масштабироваться в соответствии с потребностями, может быть дорогостоящей или сложной.

   ![Схема сценария. Служба интерфейсного прокси-сервера](./media/storage-sas-overview/sas-storage-fe-proxy-service.png)

2. Облегченная служба аутентифицирует клиент по мере необходимости, а затем создает SAS. После того как клиентское приложение получит SAS, он может получить доступ к ресурсам учетной записи хранения напрямую. Разрешения на доступ определяются SAS и для интервала, разрешенного SAS. Подпись общего доступа уменьшает потребность в маршрутизации всех данных через службу интерфейсного прокси-сервера.

   ![Схема сценария. Служба поставщика SAS](./media/storage-sas-overview/sas-storage-provider-service.png)

Многие реальные службы могут использовать сочетание этих двух подходов. Например, некоторые данные могут обрабатываться и проверяться через интерфейсный прокси-сервер. Другие данные сохраняются и/или считываются напрямую с помощью SAS.

Кроме того, SAS требуется для авторизации доступа к исходному объекту в операции копирования в определенных сценариях:

- При копировании большого двоичного объекта в другой большой двоичный объект, находящийся в другой учетной записи хранения. 
  
  По желанию вы можете использовать SAS еще и для авторизации доступа к конечному большому двоичному объекту.

- При копировании файла в другой файл, находящийся в другой учетной записи хранения. 

  По желанию вы можете использовать SAS еще и для авторизации доступа к конечному файлу.

- При копировании большого двоичного объекта в файл или файл в большой двоичный объект. 

  Необходимо использовать SAS, даже если исходный и целевой объекты находятся в одной и той же учетной записи хранения.

## <a name="best-practices-when-using-sas"></a>Рекомендации по использованию SAS

При использовании подписей общего доступа в приложениях необходимо иметь в виду две потенциальные проблемы:

- В случае утечки подписи ей сможет пользоваться любой человек, что потенциально может нарушить безопасность вашей учетной записи хранения.

- Если срок действия подписи, предоставленной клиентскому приложению, истекает и приложение не может получить новую подпись из вашей службы, это может нарушить работу приложения.

Следующие рекомендации по использованию подписанных URL-адресов помогут нейтрализовать эти риски:

- **Всегда используйте HTTPS** для создания подписанного URL-адреса или его распространения. Если SAS передается по протоколу HTTP и перехвачен, злоумышленник, выполняющий атаку "злоумышленник в середине", может читать SAS. Затем они могут использовать этот SAS так же, как у предполагаемого пользователя. Это может потенциально повредить конфиденциальные данные или позволить злоумышленнику повредить данные.

- **По возможности используйте сопоставление безопасности делегирования пользователя.** SAS для делегирования пользователей обеспечивает более высокую безопасность для SAS службы или SAS учетной записи. SAS для делегирования пользователей защищен с помощью учетных данных Azure AD, поэтому вам не нужно хранить ключ учетной записи вместе с кодом.

- **Поставьте план отзыва для SAS.** Убедитесь, что вы готовы ответить, если SAS скомпрометирован.

- **Определите хранимую политику доступа для SAS службы.** Хранимые политики доступа дают возможность отзывать разрешения для SAS службы без необходимости повторного создания ключей учетной записи хранения. Задайте для них очень большой (или бесконечный) срок действия и убедитесь, что он регулярно переносится на будущее время.

- **Используйте приближается время истечения срока действия на SAS нерегламентированной службы SAS или SAS учетной записи.** Таким образом, даже если SAS скомпрометирован, он будет действителен только в течение короткого времени. Это особенно важно в случаях, когда нельзя ссылаться на хранимую политику доступа. Небольшой срок также позволяет ограничить объем данных, который может быть записан в большой двоичный объект, путем ограничения времени на отправку этих данных.

- **Запрограммируйте автоматическое обновление подписи клиентами при необходимости.** Клиенты должны обновлять SAS задолго до окончания его срока действия, чтобы оставить время для повторных попыток в случае недоступности службы, предоставляющей SAS. В некоторых случаях это может оказаться ненужным. Например, вы можете использовать SAS для небольшого числа немедленных операций с кратковременным временем существования. Эти операции должны быть завершены в течение срока действия. В результате вы не ожидаете обновления SAS. Тем не менее, если у вас есть клиент, выполняющий регулярный доступ к запросам через SAS, то возможность истечения срока действия вступает в игру. 

- **Будьте осторожны со временем начала действия SAS.** Если в качестве времени начала для SAS задано текущее время, сбои могут происходить периодически в течение первых нескольких минут. Это происходит из-за того, что разные компьютеры имеют несколько различий в текущем времени (это называется отклонением по часам). В общем, устанавливайте время начала действия на 15 минут или более в прошлом времени. Или не задавайте вообще. Так SAS будет немедленно становиться действительным во всех случаях. То же касается и времени истечения срока действия. Помните, что для каждого запроса может наблюдаться рассинхронизация по времени до 15 минут в любом направлении. Для клиентов, использующих ОСТАВШУЮся версию до 2012-02-12, максимальная продолжительность для SAS, которая не ссылается на хранимую политику доступа, составляет 1 час. Все политики, которые задают более длительный срок, чем один час, завершатся ошибкой.

- **Будьте внимательны с форматом DateTime SAS.** Для некоторых служебных программ (например, AzCopy) требуется формат даты и времени "+% Y-% m-% dT% H:%M:% SZ". Этот формат, в частности, содержит секунды. 

- **Четко указывайте ресурс, к которому осуществляется доступ.** Из соображений безопасности рекомендуется предоставить пользователю минимально необходимый набор прав. Если пользователю требуется только доступ для чтения к отдельной сущности, предоставьте доступ на чтение к этой сущности, а не доступ на чтение, запись и удаление для всех сущностей. Это также позволяет уменьшить ущерб, если SAS скомпрометирован, так как такой SAS предоставляет меньше возможностей злоумышленнику.

- **Вы узнаете, что счет будет взиматься за использование, включая SAS.** Если вы предоставляете доступ на запись к большому двоичному объекту, пользователь может отправить большой двоичный объект размером 200 ГБ. Если вы также предоставляете доступ на чтение, пользователь может скачать его 10 раз, в результате чего вам потребуется оплачивать исходящий трафик объемом 2 ТБ. Опять же, ограниченные разрешения помогают сузить спектр возможностей злоумышленников. Используйте краткосрочные подписи, чтобы снизить угрозу (но помните о влиянии рассинхронизации часов на время окончания действия).

- **Проверка данных, записанных с помощью SAS.**  Когда клиентское приложение записывает данные в вашу учетную запись хранения, помните, что эти данные могут стать источником проблем. Если вы планируете проверить данные, выполните эту проверку после того, как данные будут записаны и до того, как они будут использоваться приложением. Такой подход также обеспечивает защиту от поврежденных или вредоносных данных, записываемых в вашу учетную запись как пользователем, который получил подпись правомерно, так и пользователем, использующим подпись после ее утечки.

- **Узнайте, когда не следует использовать SAS.** Иногда риски, связанные с определенной операцией с вашей учетной записью хранения, перевешивают преимущества использования SAS. Для таких операций создавайте службу среднего уровня, которая записывает данные в вашу учетную запись хранения после выполнения проверки, проверки подлинности и аудита на основании бизнес-правил. Кроме того, иногда проще организовать управление доступом другим образом. Например, если вы хотите сделать все BLOB-объекты в контейнере общедоступными для чтения, вместо предоставления всем клиентам подписанного URL-адреса можно сделать этот контейнер общедоступным.

- **Используйте Azure Monitor и журналы службы хранилища Azure для мониторинга приложения.** Ошибки авторизации могут возникать из-за сбоя в службе поставщика SAS. Они также могут возникать из-за непреднамеренного удаления хранимой политики доступа. Вы можете использовать Azure Monitor и ведение журнала аналитики хранилища, чтобы наблюдать за резкостью этих типов ошибок авторизации. Дополнительные сведения см. [в разделе метрики службы хранилища Azure в Azure Monitor](../blobs/monitor-blob-storage.md?toc=%252fazure%252fstorage%252fblobs%252ftoc.json) и [аналитика службы хранилища Azure ведение журнала](storage-analytics-logging.md?toc=%2fazure%2fstorage%2fblobs%2ftoc.json).

> [!NOTE]
> Хранилище не следит за количеством подписанных URL-имен, созданных для учетной записи хранения, и ни один API не может предоставить эти сведения. Если необходимо знать количество подписанных URL-имен, созданных для учетной записи хранения, необходимо отформатировать число вручную.

## <a name="get-started-with-sas"></a>Начало работы с SAS

Чтобы приступить к работе с подписанными URL, ознакомьтесь со следующими статьями по каждому из типов SAS.

### <a name="user-delegation-sas"></a>SAS делегирования пользователя

- [Создание SAS для делегирования пользователя для контейнера или большого двоичного объекта с помощью PowerShell](../blobs/storage-blob-user-delegation-sas-create-powershell.md)
- [Создание SAS делегирования пользователя для контейнера или большого двоичного объекта с помощью Azure CLI](../blobs/storage-blob-user-delegation-sas-create-cli.md)
- [Создание SAS делегирования пользователя для контейнера или большого двоичного объекта с помощью .NET](../blobs/storage-blob-user-delegation-sas-create-dotnet.md)

### <a name="service-sas"></a>SAS службы

- [Создание SAS службы для контейнера или большого двоичного объекта с помощью .NET](../blobs/sas-service-create.md)

### <a name="account-sas"></a>SAS учетной записи

- [Создание SAS учетной записи с помощью .NET](storage-account-sas-create-dotnet.md)

## <a name="next-steps"></a>Следующие шаги

- [Делегирование доступа с помощью подписанного URL-доступа (REST API)](/rest/api/storageservices/delegate-access-with-shared-access-signature)
- [Создание SAS для делегирования пользователей (REST API)](/rest/api/storageservices/create-user-delegation-sas)
- [Создание SAS службы (REST API)](/rest/api/storageservices/create-service-sas)
- [Создание SAS учетной записи (REST API)](/rest/api/storageservices/create-account-sas)
