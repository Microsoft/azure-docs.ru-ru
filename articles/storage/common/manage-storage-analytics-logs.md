---
title: Включение и управление журналами Аналитика Службы хранилища Azure (классическая модель) | Документация Майкрософт
description: Узнайте, как отслеживать учетную запись хранения в Azure с помощью Аналитика Службы хранилища Azure.
author: normesta
ms.service: storage
ms.topic: conceptual
ms.date: 01/29/2021
ms.author: normesta
ms.reviewer: fryu
ms.subservice: common
ms.custom: monitoring
ms.openlocfilehash: bc6632b55ba8fd90317a8b5046a3e84d863bf0ef
ms.sourcegitcommit: 54e1d4cdff28c2fd88eca949c2190da1b09dca91
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/31/2021
ms.locfileid: "99221718"
---
# <a name="enable-and-manage-azure-storage-analytics-logs-classic"></a>Включение и управление журналами Аналитика Службы хранилища Azure (классическая модель)

[Аналитика службы хранилища Azure](storage-analytics.md) предоставляет журналы для больших двоичных объектов, очередей и таблиц. Вы можете использовать [портал Azure](https://portal.azure.com) для настройки журналов, записываются для вашей учетной записи. В этой статье показано, как включить журналы и управлять ими. Сведения о том, как включить метрики, см. в статье [Включение и управление метриками аналитика службы хранилища Azure (классическая модель)](storage-monitor-storage-account.md).  Анализ и хранение данных мониторинга в портал Azureе связаны с затратами. Дополнительные сведения см. в [этой статье](storage-analytics.md).

> [!NOTE]
> Рекомендуется использовать журналы службы хранилища Azure в Azure Monitor вместо журналов Аналитика Службы хранилища. Журналы службы хранилища Azure в Azure Monitor предоставляются в общедоступной предварительной версии. Они также доступны для предварительного тестирования во всех регионах общедоступного облака. Эта предварительная версия включает журналы для больших двоичных объектов (в том числе Azure Data Lake Storage 2-го поколения), файлов, очередей и таблиц. Дополнительные сведения см. в следующих статьях:
>
> - [Мониторинг хранилища BLOB-объектов Azure](../blobs/monitor-blob-storage.md)
> - [Мониторинг файлов Azure](../files/storage-files-monitoring.md)
> - [Мониторинг хранилища очередей Azure](../queues/monitor-queue-storage.md)
> - [Мониторинг табличного хранилища Azure](../tables/monitor-table-storage.md)

Дополнительные указания о функциях аналитики хранилища и других инструментах идентификации, диагностики и устранения неполадок, связанных со службой хранилища Azure, см. в статье [Мониторинг, диагностика и устранение неполадок службы хранилища Microsoft Azure](storage-monitoring-diagnosing-troubleshooting.md).

<a id="configure-logging"></a>

## <a name="enable-logs"></a>Включение журналов

Можно указать службе хранилища Azure сохранять журналы диагностики для запросов на чтение, запись и удаление, отправляемых к службам BLOB-объектов, таблиц и очередей. Заданная политика хранения данных также применяется к этим журналам.

> [!NOTE]
> Сейчас служба "файлы Azure" поддерживает Аналитика Службы хранилища метрики, но не поддерживает ведение журнала Аналитика Службы хранилища.

### <a name="portal"></a>[Портал](#tab/azure-portal)

1. На [портале Azure](https://portal.azure.com) выберите **Учетные записи хранения**, а затем щелкните имя учетной записи хранения, чтобы открыть ее колонку.

2. Выберите **параметры диагностики (классическая модель)** в разделе **мониторинг (классический)** в колонке меню.

    ![Пункт меню "Диагностика" в разделе "Мониторинг" на портале Azure](./media/manage-storage-analytics-logs/storage-enable-metrics-00.png)

3. Убедитесь, что параметр **Состояние** имеет значение **Вкл.** , и выберите **службы**, для которых нужно включить ведение журнала.

   > [!div class="mx-imgBorder"]
   > ![Настройка ведения журнала на портале Azure](./media/manage-storage-analytics-logs/enable-diagnostics.png)    


4. Убедитесь, что установлен флажок **удалить данные** .  Затем задайте количество дней, в течение которых данные журнала должны храниться, перемещая ползунок под флажком или напрямую изменяя значение, которое отображается в текстовом поле рядом с элементом управления "ползунок". Значение по умолчанию для новых учетных записей хранения составляет семь дней. Если политику хранения задавать не нужно, введите ноль. Если политика хранения отсутствует, можно удалить данные журнала.

   > [!WARNING]
   > Журналы хранятся в учетной записи в виде данных. данные журнала могут накапливаться в вашей учетной записи с течением времени, что может увеличить стоимость хранилища. Если вам нужны данные журнала в течение небольшого периода времени, можно уменьшить затраты, изменив политику хранения данных. Устаревшие данные журнала (данные старше политики хранения) удаляются системой. Рекомендуется настроить политику хранения в зависимости от того, как долго требуется хранить данные журнала для вашей учетной записи. Дополнительные сведения см. в разделе [Выставление счетов за метрики хранилища](storage-analytics-metrics.md#billing-on-storage-metrics).

4. Выберите команду **Сохранить**.

   Журналы диагностики сохраняются в контейнере BLOB-объектов с именем *$logs* в вашей учетной записи хранения. Данные журнала можно просмотреть с помощью обозревателя хранилищ, например [Обозреватель службы хранилища Microsoft Azure](https://storageexplorer.com), или программно с помощью клиентской библиотеки хранилища или PowerShell.

   Дополнительные сведения о доступе к контейнеру $logs см. в статье [Ведение журнала аналитики службы хранилища Azure](storage-analytics-logging.md).

### <a name="powershell"></a>[PowerShell](#tab/azure-powershell)

1. Откройте командное окно Windows PowerShell.

2. Войдите в подписку Azure с помощью команды `Connect-AzAccount` и следуйте инструкциям на экране.

   ```powershell
   Connect-AzAccount
   ```

3. Если ваше удостоверение связано с более чем одной подпиской, установите активную подписку.

   ```powershell
   $context = Get-AzSubscription -SubscriptionId <subscription-id>
   Set-AzContext $context
   ```

   Замените значение заполнителя `<subscription-id>` идентификатором своей подписки.

5. Получите контекст учетной записи хранения, определяющий необходимую учетную запись хранения.

   ```powershell
   $storageAccount = Get-AzStorageAccount -ResourceGroupName "<resource-group-name>" -AccountName "<storage-account-name>"
   $ctx = $storageAccount.Context
   ```

   * Замените значение заполнителя `<resource-group-name>` именем своей группы ресурсов.

   * Замените значение заполнителя `<storage-account-name>` именем вашей учетной записи хранения. 

6. Используйте **Set-азсторажесервицелоггингпроперти** , чтобы изменить текущие параметры журнала. В командлетах, позволяющих управлять ведением журнала службы хранилища, используется параметр **LoggingOperations**, представляющий собой строку, содержащую разделенный запятыми список типов запросов, подлежащих занесению в журнал. Всего используются запросы трех типов — **чтение**, **запись** и **удаление**. Чтобы отключить ведение журнала, укажите для параметра **LoggingOperations** значение **none**.  

   Следующая команда включает занесение в журнал записей о запросах на чтение, запись и удаление службой очередей в учетной записи хранения по умолчанию, при этом устанавливается время хранения, равное пяти дням:  

   ```powershell
   Set-AzStorageServiceLoggingProperty -ServiceType Queue -LoggingOperations read,write,delete -RetentionDays 5 -Context $ctx
   ```  

   > [!WARNING]
   > Журналы хранятся в учетной записи в виде данных. данные журнала могут накапливаться в вашей учетной записи с течением времени, что может увеличить стоимость хранилища. Если вам нужны данные журнала в течение небольшого периода времени, можно уменьшить затраты, изменив политику хранения данных. Устаревшие данные журнала (данные старше политики хранения) удаляются системой. Рекомендуется настроить политику хранения в зависимости от того, как долго требуется хранить данные журнала для вашей учетной записи. Дополнительные сведения см. в разделе [Выставление счетов за метрики хранилища](storage-analytics-metrics.md#billing-on-storage-metrics).
   
   Следующая команда отключает ведение журнала для службы таблиц в учетной записи по умолчанию:  

   ```powershell
   Set-AzStorageServiceLoggingProperty -ServiceType Table -LoggingOperations none -Context $ctx 
   ```  

   Дополнительные сведения о настройке командлетов Azure PowerShell для работы с подпиской Azure и о выборе учетной записи хранения по умолчанию см. в статье с [общими сведениями об Azure PowerShell](/powershell/azure/).  

### <a name="net-v12"></a>[.NET (версии 12)](#tab/dotnet)

:::code language="csharp" source="~/azure-storage-snippets/queues/howto/dotnet/dotnet-v12/Monitoring.cs" id="snippet_EnableDiagnosticLogs":::

### <a name="net-v11"></a>[.NET (версии 11)](#tab/dotnet11)

```csharp
var storageAccount = CloudStorageAccount.Parse(connStr);  
var queueClient = storageAccount.CreateCloudQueueClient();  
var serviceProperties = queueClient.GetServiceProperties();  

serviceProperties.Logging.LoggingOperations = LoggingOperations.All;  
serviceProperties.Logging.RetentionDays = 2;  

queueClient.SetServiceProperties(serviceProperties);  
``` 

---

<a id="modify-retention-policy"></a>

## <a name="modify-log-data-retention-period"></a>Изменение срока хранения данных журнала

Данные журнала могут накапливаться в вашей учетной записи с течением времени, что может увеличить стоимость хранилища. Если вам нужны данные журнала в течение небольшого периода времени, можно уменьшить затраты, изменив срок хранения данных журнала. Например, если вам нужны журналы только за три дня, задайте для параметра срок хранения данных журнала значение `3` . В этом случае журналы будут автоматически удалены из вашей учетной записи через 3 дня. В этом разделе показано, как просмотреть текущий срок хранения данных журнала, а затем обновить этот период, если это нужно сделать.

> [!NOTE]
> Эти действия применяются только к учетным записям, для которых на них не включен параметр **иерархического пространства имен** . Если вы включили этот параметр в учетную запись, параметр срок хранения не поддерживается. Вместо этого необходимо вручную удалить журналы с помощью любого поддерживаемого средства, например Обозреватель службы хранилища Azure, RESTFUL или пакета SDK. Чтобы найти эти журналы в учетной записи хранения, см. раздел [как хранятся журналы](storage-analytics-logging.md#how-logs-are-stored).

### <a name="portal"></a>[Портал](#tab/azure-portal)

1. На [портале Azure](https://portal.azure.com) выберите **Учетные записи хранения**, а затем щелкните имя учетной записи хранения, чтобы открыть ее колонку.
2. Выберите **параметры диагностики (классическая модель)** в разделе **мониторинг (классический)** в колонке меню.

    ![Пункт меню "Диагностика" в разделе "Мониторинг" в портал Azure](./media/manage-storage-analytics-logs/storage-enable-metrics-00.png)

3. Убедитесь, что установлен флажок **удалить данные** .  Затем задайте количество дней, в течение которых данные журнала должны храниться, перемещая ползунок под флажком или напрямую изменяя значение, которое отображается в текстовом поле рядом с элементом управления "ползунок".

   > [!div class="mx-imgBorder"]
   > ![Измените срок хранения в портал Azure](./media/manage-storage-analytics-logs/modify-retention-period.png)

   Число дней по умолчанию для новых учетных записей хранения составляет семь дней. Если политику хранения задавать не нужно, введите ноль. Если политика хранения отсутствует, удаление данных мониторинга выполняется вручную.
   
4. Выберите команду **Сохранить**.

   Журналы диагностики сохраняются в контейнере BLOB-объектов с именем *$logs* в вашей учетной записи хранения. Данные журнала можно просмотреть с помощью обозревателя хранилищ, например [Обозреватель службы хранилища Microsoft Azure](https://storageexplorer.com), или программно с помощью клиентской библиотеки хранилища или PowerShell.

   Дополнительные сведения о доступе к контейнеру $logs см. в статье [Ведение журнала аналитики службы хранилища Azure](storage-analytics-logging.md).

### <a name="powershell"></a>[PowerShell](#tab/azure-powershell)

1. Откройте командное окно Windows PowerShell.

2. Войдите в подписку Azure с помощью команды `Connect-AzAccount` и следуйте инструкциям на экране.

   ```powershell
   Connect-AzAccount
   ```

3. Если ваше удостоверение связано с более чем одной подпиской, установите активную подписку.

   ```powershell
   $context = Get-AzSubscription -SubscriptionId <subscription-id>
   Set-AzContext $context
   ```

   Замените значение заполнителя `<subscription-id>` идентификатором своей подписки.

5. Получите контекст учетной записи хранения, который определяет учетную запись хранения.

   ```powershell
   $storageAccount = Get-AzStorageAccount -ResourceGroupName "<resource-group-name>" -AccountName "<storage-account-name>"
   $ctx = $storageAccount.Context
   ```

   * Замените значение заполнителя `<resource-group-name>` именем своей группы ресурсов.

   * Замените значение заполнителя `<storage-account-name>` именем вашей учетной записи хранения. 

6. Используйте [Get-азсторажесервицелоггингпроперти](https://docs.microsoft.com/powershell/module/az.storage/get-azstorageserviceloggingproperty) для просмотра текущей политики хранения журнала. В следующем примере на консоли выводится срок хранения для служб хранилища BLOB-объектов и очередей.

   ```powershell
   Get-AzStorageServiceLoggingProperty -ServiceType Blob, Queue -Context $ctx
   ```  

   В выходных данных консоли срок хранения отображается под `RetentionDays` заголовком столбца.

   > [!div class="mx-imgBorder"]
   > ![Политика хранения в выходных данных PowerShell](./media/manage-storage-analytics-logs/retention-period-powershell.png)

7. Чтобы изменить срок хранения, используйте [Set-азсторажесервицелоггингпроперти](https://docs.microsoft.com/powershell/module/az.storage/set-azstorageserviceloggingproperty) . В следующем примере срок хранения изменяется на 4 дня.  

   ```powershell
   Set-AzStorageServiceLoggingProperty -ServiceType Blob, Queue -RetentionDays 4 -Context $ctx
   ```  

   Дополнительные сведения о настройке командлетов Azure PowerShell для работы с подпиской Azure и о выборе учетной записи хранения по умолчанию см. в статье с [общими сведениями об Azure PowerShell](/powershell/azure/).  

### <a name="net-v12"></a>[.NET (версии 12)](#tab/dotnet)

В следующем примере на консоли выводится срок хранения для служб хранилища BLOB-объектов и очередей.

:::code language="csharp" source="~/azure-storage-snippets/queues/howto/dotnet/dotnet-v12/Monitoring.cs" id="snippet_ViewRetentionPeriod":::

В следующем примере срок хранения изменяется на 4 дня. 

:::code language="csharp" source="~/azure-storage-snippets/queues/howto/dotnet/dotnet-v12/Monitoring.cs" id="snippet_ModifyRetentionPeriod":::

### <a name="net-v11"></a>[.NET (версии 11)](#tab/dotnet11)

В следующем примере на консоли выводится срок хранения для служб хранилища BLOB-объектов и очередей.

```csharp
var storageAccount = CloudStorageAccount.Parse(connectionString);

var blobClient = storageAccount.CreateCloudBlobClient();
var queueClient = storageAccount.CreateCloudQueueClient();

var blobserviceProperties = blobClient.GetServiceProperties();
var queueserviceProperties = queueClient.GetServiceProperties();

Console.WriteLine("Retention period for logs from the blob service is: " +
   blobserviceProperties.Logging.RetentionDays.ToString());

Console.WriteLine("Retention period for logs from the queue service is: " +
   queueserviceProperties.Logging.RetentionDays.ToString());
```

В следующем примере изменяется срок хранения журналов для служб хранилища больших двоичных объектов и очередей на 4 дня. 

```csharp

blobserviceProperties.Logging.RetentionDays = 4;
queueserviceProperties.Logging.RetentionDays = 4;

blobClient.SetServiceProperties(blobserviceProperties);
queueClient.SetServiceProperties(queueserviceProperties);  
``` 

---

### <a name="verify-that-log-data-is-being-deleted"></a>Проверка удаления данных журнала

Чтобы убедиться, что журналы удаляются, просмотрите содержимое `$logs` контейнера учетной записи хранения. На следующем рисунке показано содержимое папки в `$logs` контейнере. Папка соответствует 2021 января, а каждая папка содержит журналы за один день. Если день сегодняшнего дня — 29 января 2021, а для политики хранения задано значение только один день, то эта папка должна содержать журналы только один день.

> [!div class="mx-imgBorder"]
> ![Список папок журналов на портале Azure](./media/manage-storage-analytics-logs/verify-and-delete-logs.png)

<a id="download-storage-logging-log-data"></a>

## <a name="view-log-data"></a>Просмотр данных журнала

 Для просмотра и анализа данных журнала необходимо скачать BLOB-объекты, содержащие требуемые данные журнала, на локальный компьютер. Многие средства обзора хранилища позволяют скачивать BLOB-объекты из учетной записи хранения. Кроме того, для скачивания данных журнала можно использовать средство командной строки Azure Copy Tool ([AzCopy](storage-use-azcopy-v10.md)), предоставляемое группой службы хранилища Azure.  
 
>[!NOTE]
> Контейнер `$logs` не интегрирован в Сетку событий, поэтому вы не будете получать уведомления при записи файлов журнала. 

 Чтобы скачать только нужные данные и избежать повторного скачивания тех же данных журнала, сделайте следующее.  

-   Примените соглашение об именовании по дате и времени к BLOB-объектам, чтобы отслеживать, какие из них уже были скачаны для анализа, и предотвратить их повторное скачивание.  

-   С помощью метаданных в BLOB-объектах, содержащих данные журнала, определите конкретный период, которому соответствуют содержащиеся в BLOB-объекте данные журнала. Это позволяет найти требуемый для скачивания BLOB-объект.  

Чтобы приступить к работе с AzCopy, см. сведения в статье [Начало работы с AzCopy](storage-use-azcopy-v10.md). 

В следующем примере показано, как можно скачать данные журнала для службы очереди, время начала которых соответствует 9:00, 10:00 и 11:00 20 мая 2014 г.

```
azcopy copy 'https://mystorageaccount.blob.core.windows.net/$logs/queue' 'C:\Logs\Storage' --include-path '2014/05/20/09;2014/05/20/10;2014/05/20/11' --recursive
```

Дополнительные сведения о загрузке конкретных файлов см. в статье [Загрузка больших двоичных объектов из хранилища BLOB-объектов Azure с помощью AzCopy V10](./storage-use-azcopy-blobs-download.md?toc=%2fazure%2fstorage%2fblobs%2ftoc.json).

После скачивания данных журнала можно просматривать записи журнала в файлах. В этих файлах журнала используется текстовый формат с разделителями, в котором могут анализироваться многие средства чтения журнала (Дополнительные сведения см. в разделе Руководство по [мониторингу, диагностике и устранению неполадок служба хранилища Microsoft Azure](storage-monitoring-diagnosing-troubleshooting.md)). Такие средства предоставляют различные возможности форматирования, фильтрации, сортировки и поиска содержимого файлов журнала. Дополнительные сведения о формате и содержимом файлов журнала службы хранилища см. в статьях [Формат журнала Аналитики Службы хранилища](/rest/api/storageservices/storage-analytics-log-format) и [Операции и сообщения о состоянии, заносимые в журнал Аналитики Службы хранилища](/rest/api/storageservices/storage-analytics-logged-operations-and-status-messages).

## <a name="next-steps"></a>Дальнейшие действия

* Дополнительные сведения о Аналитика Службы хранилища см. в разделе [аналитика службы хранилища](storage-analytics.md) for аналитика службы хранилища.
* [Настройка метрик аналитика службы хранилища](storage-monitor-storage-account.md).
* Дополнительные сведения о настройке ведения журнала службы хранилища с помощью языка .NET см. в [справочнике по клиентской библиотеке хранилища](/previous-versions/azure/dn261237(v=azure.100)). 
* Общие сведения о настройке ведения журнала службы хранилища с использованием REST API см. в статье [Включение и настройка Аналитики Службы хранилища](/rest/api/storageservices/Enabling-and-Configuring-Storage-Analytics).
* Дополнительные сведения о формате журналов Аналитика Службы хранилища. См. раздел [Формат журнала аналитика службы хранилища](/rest/api/storageservices/storage-analytics-log-format).