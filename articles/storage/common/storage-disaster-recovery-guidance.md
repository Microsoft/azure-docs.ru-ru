---
title: Аварийное восстановление и отработка отказа учетной записи хранения
titleSuffix: Azure Storage
description: Служба хранилища Azure поддерживает отработку отказа учетной записи для геоизбыточных учетных записей хранения. Отработка отказа учетной записи позволяет инициировать процесс отработки отказа для учетной записи хранения в тех случаях, когда основная конечная точка становится недоступной.
services: storage
author: tamram
ms.service: storage
ms.topic: conceptual
ms.date: 03/22/2021
ms.author: tamram
ms.reviewer: artek
ms.subservice: common
ms.openlocfilehash: 11d9b38d71d428a3c6c829b508318389338f5a15
ms.sourcegitcommit: ba3a4d58a17021a922f763095ddc3cf768b11336
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/23/2021
ms.locfileid: "104800355"
---
# <a name="disaster-recovery-and-storage-account-failover"></a>Аварийное восстановление и отработка отказа учетной записи хранения

Корпорация Майкрософт стремится непрерывно поддерживать доступность служб Azure. Но иногда могут происходить незапланированные сбои служб. Если приложению требуется устойчивость, корпорация Майкрософт рекомендует использовать геоизбыточное хранилище, чтобы данные копировались во второй регион. Кроме того, клиентам следует иметь план аварийного восстановления на случай регионального сбоя служб. Важной частью плана аварийного восстановления является подготовка к отработке отказа на вторичную конечную точку в случаях, когда основная конечная точка станет недоступной.

Служба хранилища Azure поддерживает отработку отказа учетной записи для геоизбыточных учетных записей хранения. Отработка отказа учетной записи позволяет инициировать процесс отработки отказа для учетной записи хранения в тех случаях, когда основная конечная точка становится недоступной. Отработка отказа преобразует вторичную конечную точку в основную конечную точку учетной записи хранения. Когда отработка отказа завершится, клиенты смогут записывать данные в новую основную конечную точку.

Отработка отказа учетной записи доступна для типов учетных записей общего назначения версии 1, общего назначения версии 2 и Хранилища BLOB-объектов с развертываниями Azure Resource Manager. Отработка отказа учетной записи поддерживается для всех общедоступных регионов, но в настоящее время недоступна в независимых или национальных облаках. Отработка отказа учетной записи не поддерживается для учетных записей хранения с включенным иерархией пространства имен.

В этой статье описываются концепции и процессы, применимые для отработки отказа учетной записи, а также обсуждается подготовка учетной записи хранения для восстановления, позволяющая снизить негативное влияние на клиентов. Чтобы узнать, как инициировать отработку отказа учетной записи в портал Azure или PowerShell, см. раздел [Запуск отработки отказа учетной записи](storage-initiate-account-failover.md).

[!INCLUDE [updated-for-az](../../../includes/updated-for-az.md)]

## <a name="choose-the-right-redundancy-option"></a>Выбор правильного уровня избыточности

Служба хранилища Azure поддерживает несколько копий учетной записи хранения, обеспечивая устойчивость и высокий уровень доступности. Выбор уровня избыточности для учетной записи зависит от требуемой степени устойчивости. Для защиты от региональных простоев настройте учетную запись для геоизбыточного хранилища с параметром доступа на чтение из дополнительного региона или без него:  

**Геоизбыточное хранилище (GRS) или хранилище, избыточное в геопоясе (гзрс)** , Асинхронно копирует данные в двух географических регионах, которые находятся не менее чем в сотнях миль друг от друга. Если в основном регионе произойдет сбой, дополнительный регион берет на себя роль резервного источника данных. Вы сможете запустить отработку отказа, чтобы вторичная конечная точка стала основной конечной точкой.

**Геоизбыточное хранилище с доступом на чтение (RA-GRS) или геоизбыточное хранилище с доступом на чтение (RA-гзрс)** предоставляет геоизбыточное хранилище с дополнительным преимуществом доступа для чтения к вторичной конечной точке. Если в основной конечной точке происходит сбой, приложения, настроенные для доступа на чтение к базе данных-получателю и предназначенные для обеспечения высокой доступности, могут продолжать чтение из вторичной конечной точки. Корпорация Майкрософт рекомендует использовать RA-ГЗРС для обеспечения максимальной доступности и устойчивости приложений.

Дополнительные сведения о избыточности в службе хранилища Azure см. в статье [избыточность службы хранилища Azure](storage-redundancy.md).

> [!WARNING]
> Геоизбыточное хранилище имеет риск потери данных. Данные копируются в дополнительный регион асинхронно, что означает задержку между записью данных, записываемых в основной регион, в дополнительный регион. В случае сбоя операции записи в основную конечную точку, которые еще не были скопированы во вторичную конечную точку, будут потеряны.

## <a name="design-for-high-availability"></a>Учет высокого уровня доступности при проектировании

Очень важно, чтобы разработка приложений изначально велась с учетом высокого уровня доступности. Здесь представлены ресурсы Azure, которые помогут вам в разработке приложений и при планировании аварийного восстановления.

- [Проектирование устойчивых приложений для Azure](/azure/architecture/framework/resiliency/app-design). Обзор основных концепций проектирования высокодоступных приложений в Azure.
- [Контрольный список устойчивости](/azure/architecture/checklist/resiliency-per-service). Контрольный список для проверки того, что приложение реализует лучшие методики проектирования для обеспечения высокого уровня доступности.
- [Используйте геоизбыточность для разработки высокодоступных приложений](geo-redundant-design.md): руководство по проектированию для создания приложений с целью использования преимуществ геоизбыточного хранилища.
- [Руководство. Создание высокодоступного приложения с хранилищем BLOB-объектов](../blobs/storage-create-geo-redundant-storage.md): руководство, в котором показано, как создать высокодоступное приложение, которое автоматически переключается между конечными точками в качестве сбоев и моделирует операции восстановления. 

Кроме того, учитывайте следующие рекомендации, которые помогут поддерживать высокий уровень доступности для данных в хранилище Azure.

- **Диски:** Используйте [Azure Backup](https://azure.microsoft.com/services/backup/) для резервного копирования дисков виртуальной машины, используемых виртуальными машинами Azure. Также рассмотрите возможность применить [Azure Site Recovery](https://azure.microsoft.com/services/site-recovery/) для защиты виртуальных машин на случай региональной аварии.
- **Блочные BLOB-объекты:** Включите [обратимое удаление](../blobs/soft-delete-blob-overview.md) , чтобы защититься от удаления на уровне объектов и перезаписи, или скопируйте блочные BLOB-объекты в другую учетную запись хранения в другом регионе, используя [AzCopy](./storage-use-azcopy-v10.md), [Azure PowerShell](/powershell/module/az.storage/)или [библиотеку перемещения данных Azure](storage-use-data-movement-library.md).
- **Файлы:** Используйте [Azure Backup](../../backup/azure-file-share-backup-overview.md) для резервного копирования файловых ресурсов. Также включите [обратимое удаление](../files/storage-files-prevent-file-share-deletion.md) , чтобы защититься от случайного удаления файловых ресурсов. Для геоизбыточности, если GRS недоступен, используйте [AzCopy](./storage-use-azcopy-v10.md) или [Azure PowerShell](/powershell/module/az.storage/) , чтобы скопировать файлы в другую учетную запись хранения в другом регионе.
- **Таблицы**. Используйте [AzCopy](./storage-use-azcopy-v10.md) для экспорта данных из таблиц в другую учетную запись хранения, относящуюся к другому региону.

## <a name="track-outages"></a>Отслеживание сбоев

Клиенты могут подписаться на использование [панели мониторинга Работоспособности служб Azure](https://azure.microsoft.com/status/), которая позволяет отслеживать работоспособность и состояние службы хранилища Azure и других служб Azure.

Кроме того, корпорация Майкрософт рекомендует учесть в приложении возможность сбоев при записи. Приложение должно информировать о сбоях при записи, чтобы вы своевременно получали сведения о возможных сбоях в основном регионе.

## <a name="understand-the-account-failover-process"></a>Сведения о процессе отработки отказа учетной записи

Отработка отказа учетной записи, управляемой клиентом, позволяет отключать всю учетную запись хранения к дополнительному региону, если основная причина недоступна по какой-либо причине Когда вы запустите отработку отказа в дополнительный регион, после ее завершения клиенты смогут записывать данные через дополнительную конечную точку. Отработка отказа обычно занимает около часа.

[!INCLUDE [storage-data-lake-gen2-support](../../../includes/storage-data-lake-gen2-support.md)]

### <a name="how-an-account-failover-works"></a>Процесс отработки отказа учетной записи

При нормальных обстоятельствах клиент записывает данные в учетную запись хранения Azure в основном регионе, и эти данные копируются асинхронно в дополнительный регион. Ниже представлен сценарий с доступным основным регионом:

![Клиенты записывают данные в учетную запись хранения в основном регионе](media/storage-disaster-recovery-guidance/primary-available.png)

Если основная конечная точка становится недоступной по любой причине, клиент не сможет записывать данные в эту учетную запись хранения. На следующем изображении представлен сценарий, в котором основная конечная точка стала недоступной, но восстановление еще не произошло:

![Основная конечная точка недоступна, клиенты не могут записывать данные](media/storage-disaster-recovery-guidance/primary-unavailable-before-failover.png)

Теперь клиент инициирует отработку отказа учетной записи на вторичную конечную точку. Процесс отработки отказа обновляет запись DNS, предоставленную службой хранилища Azure, и теперь вторичная конечная точка становится основной конечной точкой этой учетной записи хранения, как показано на следующем изображении:

![Клиент инициирует отработку отказа учетной записи на вторичную конечную точку](media/storage-disaster-recovery-guidance/failover-to-secondary.png)

Доступ на запись восстанавливается для геоизбыточных учетных записей после обновления DNS-записи, и запросы направляются на новую основную конечную точку. После отработки отказа сохраняются все существующие конечные точки службы хранилища для больших двоичных объектов, таблиц, очередей и файлов.

> [!IMPORTANT]
> Когда завершится отработка отказа, учетная запись хранения станет локально избыточной в новой основной конечной точке. Чтобы возобновить репликацию на новый сервер-получатель, настройте учетную запись для геоизбыточности еще раз.
>
> Помните, что преобразование учетной записи LRS для использования геоизбыточности влечет за собой стоимость. Эти затраты применяются для обновления учетной записи хранения в новом основном регионе после отработки отказа.  

### <a name="anticipate-data-loss"></a>Подготовка к потерям данных

> [!CAUTION]
> Отработка отказа учетной записи обычно сопровождается некоторой потерей данных. Важно хорошо понимать, какие последствия влечет за собой отработка отказа учетной записи.  

Поскольку данные записываются асинхронно из основного региона в дополнительный, всегда существует задержка перед тем, как запись в основной регион будет скопирована в дополнительный регион. Если основной регион становится недоступным, последние записи могут еще не копироваться в дополнительный регион.

При запуске отработки отказа все данные в основном регионе утрачиваются, так как дополнительный регион теперь становится новым основным регионом, а учетная запись хранения и дальше действует как локально избыточное хранилище. Все данные, уже скопированные во вторичную базу данных, сохраняются при отработке отказа. Однако все данные, записанные в базу данных-источник, не скопированные на сервер-получатель, теряются навсегда.

Свойство **Время последней синхронизации** обозначает самое позднее время, за которое гарантирована запись данных из основного в дополнительный регион. Все данные до момента последней синхронизации будут доступны на вторичной конечной точке, а более поздние данные могут быть утрачены, если они еще не были реплицированы. Используйте это свойство в случае сбоя, чтобы оценить объем данных, которые вы можете потерять при запуске отработки отказа учетной записи.

Мы рекомендуем проектировать приложение таким образом, чтобы время последней синхронизации позволяло оценить ожидаемую потерю данных. Например, если вы ведете журнал операций записи, у вас будет возможность сравнить время последней операции записи с временем последней синхронизации и определить, какие операции записи не синхронизированы в дополнительном регионе.

Дополнительные сведения о проверке свойства **время последней синхронизации** см. в разделе [Проверка свойства времени последней синхронизации для учетной записи хранения](last-sync-time-get.md).

### <a name="use-caution-when-failing-back-to-the-original-primary"></a>Соблюдайте осторожность при возврате на исходную основную конечную точку

После отработки отказа из основного в дополнительный регион для учетной записи хранения применяется режим локально избыточного хранилища в новом основном регионе. Затем можно снова настроить учетную запись для геоизбыточности. Когда учетная запись настроена для геоизбыточности после отработки отказа, новый основной регион немедленно начинает копирование данных в новый дополнительный регион, который был основным до первоначальной отработки отказа. Однако может потребоваться некоторое время, прежде чем существующие данные в первичном сервере будут полностью скопированы в новый сервер-получатель.

Когда завершится настройка географической избыточности для учетной записи хранения, вы сможете снова инициировать отработку отказа из нового основного региона в новый дополнительный. В этом случае регион, который был основным до отработки отказа, снова станет основным регионом в режиме локально избыточного хранилища. При этом утрачиваются все данные в регионе, который был основным после отработки отказа (исходном дополнительном регионе). Если большая часть данных в учетной записи хранения не была скопирована на новый сервер-получатель перед возвращением после сбоя, может снизиться значительная потеря данных.

Чтобы избежать критических потерь данных, обязательно проверьте значение свойства **Время последней синхронизации** перед восстановлением размещения. Сравните время последней синхронизации с временем последней записи данных на новую первичную конечную точку, чтобы оценить ожидаемые потери данных. 

## <a name="initiate-an-account-failover"></a>Инициирование отработки отказа учетной записи

Вы можете инициировать отработку отказа учетной записи с помощью портала Azure, PowerShell, Azure CLI или API поставщика ресурсов службы хранилища Azure. Дополнительные сведения о запуске отработки отказа см. в разделе [Инициация отработки отказа учетной записи](storage-initiate-account-failover.md).

## <a name="additional-considerations"></a>Дополнительные сведения

Ознакомьтесь с дополнительными сведениями, описанными в этом разделе, чтобы понять, как могут влиять приложения и службы при принудительной отработке отказа.

### <a name="storage-account-containing-archived-blobs"></a>Учетная запись хранения, содержащая архивные большие двоичные объекты

Учетные записи хранения, содержащие архивные BLOB-объекты, поддерживают отработку отказа После завершения отработки отказа все архивные большие двоичные объекты должны быть восстановлены на уровне сети, прежде чем учетная запись может быть настроена для геоизбыточности.

### <a name="storage-resource-provider"></a>Поставщик ресурсов хранилища

После завершения отработки отказа клиенты могут снова считывать и записывать данные службы хранилища Azure в новом основном регионе. Однако поставщик ресурсов хранилища Azure не выполняет отработку отказа, поэтому операции по управлению ресурсами должны выполняться в основном регионе. Если основной регион недоступен, вы не сможете выполнять операции управления учетной записью хранения.

Так как поставщик ресурсов хранилища Azure не выполняет отработку отказа, свойство [Location](/dotnet/api/microsoft.azure.management.storage.models.trackedresource.location) возвратит исходное первичное расположение после завершения перехода на другой ресурс.

### <a name="azure-virtual-machines"></a>Виртуальные машины Azure

Отработка отказа учетной записи не распространяется на виртуальные машины Azure. Если основной регион становится недоступным и вы выполняете отработку отказа в дополнительный регион, после нее потребуется повторно создать виртуальные машины. Кроме того, возможна потеря данных, связанная с отработкой отказа учетной записи. Корпорация Майкрософт рекомендует следующие рекомендации по обеспечению [высокого уровня доступности](../../virtual-machines/availability.md) и [аварийного восстановления](../../virtual-machines/backup-recovery.md) , относящиеся к виртуальным машинам в Azure.

### <a name="azure-unmanaged-disks"></a>Неуправляемые диски Azure

Корпорация Майкрософт рекомендует преобразовать все неуправляемые диски в управляемые диски. Тем не менее, если вам потребуется отработка отказа учетной записи, которая содержит неуправляемые диски, подключенные к виртуальным машинам Azure, перед выполнением такой отработки отказа вам придется завершить работу виртуальной машины.

Неуправляемые диски содержатся в службе хранилища Azure в виде страничных BLOB-объектов. Пока виртуальная машина работает в Azure, все подключенные к ней неуправляемые диски считаются арендованными. Но отработка отказа учетной записи не может выполняться, пока существует аренда большого двоичного объекта. В этой ситуации выполните следующие действия.

1. Перед началом отработки отказа запишите имена всех неуправляемых дисков, их логические номера устройств (LUN) и имена виртуальных машин, к которым они подключены. Это упростит восстановление подключений после отработки отказа.
2. Выключите виртуальную машину.
3. Удалите виртуальную машину, сохраняя файлы VHD для неуправляемых дисков. Зафиксируйте время удаления виртуальной машины.
4. Дождитесь, пока параметр **Время последней синхронизации** будет содержать более позднее время, чем время удаления виртуальной машины. Этот шаг очень важен! Если вторичная конечная точка не получит полностью файлы VHD перед отработкой отказа, то виртуальная машина в новом основном регионе может работать неправильно.
5. Запустите отработку отказа учетной записи.
6. Дождитесь, пока отработка отказа учетной записи завершится, и дополнительный регион станет новым основным регионом.
7. Создайте виртуальную машину в новом основном регионе и присоедините к ней виртуальные жесткие диски.
8. Запустите новую виртуальную машину.

Не забывайте, что все хранимые данные на временном диске теряются при выключении виртуальной машины.

## <a name="unsupported-features-and-services"></a>Неподдерживаемые функции и службы

Следующие функции и службы не поддерживаются для отработки отказа учетной записи.

- Служба синхронизации файлов Azure не поддерживает отработку отказа учетной записи хранения. Не следует применять отработку отказа для учетных записей хранения, которые содержат файловые ресурсы Azure, используемые в качестве облачных конечных точек в службе синхронизации файлов Azure. Это приведет к прекращению синхронизации или даже к непредвиденной потере данных, если некоторые файлы недавно стали многоуровневыми.
- Учетные записи хранения ADLS 2-го поколения (учетные записи с включенным иерархическим пространством имен) в настоящее время не поддерживаются.
- Невозможно выполнить отработку отказа для учетной записи хранения, которая содержит блочные BLOB-объекты уровня "Премиум". Учетные записи хранения, которые поддерживают блочные BLOB-объекты уровня "Премиум", сейчас не поддерживают географическую избыточность.
- Не удается выполнить отработку отказа учетной записи хранения, содержащей все контейнеры с включенной [политикой неизменности вирусов](../blobs/storage-blob-immutable-storage.md) . Разблокированная или заблокированная блокировка по времени или политики юридических удержаний предотвращает отработку отказа для обеспечения соответствия.

## <a name="copying-data-as-an-alternative-to-failover"></a>Копирование данных вместо отработки отказа

Если ваша учетная запись хранения настроена для доступа на чтение к базе данных-получателю, можно разработать приложение для считывания данных из вторичной конечной точки. В случае сбоя в основном регионе вы можете не применять отработку отказа, а просто скопировать данные из учетной записи хранения в дополнительном регионе в другую учетную запись в регионе, не испытывающем проблем, с помощью [AzCopy](./storage-use-azcopy-v10.md), [Azure PowerShell](/powershell/module/az.storage/) или [библиотеки перемещения данных Azure](../common/storage-use-data-movement-library.md). После этого направьте приложения в новую учетную запись хранения для всех операций чтения и записи.

> [!CAUTION]
> Отработку отказа учетной записи не следует использовать в рамках стратегии переноса данных.

## <a name="microsoft-managed-failover"></a>Отработка отказа под управлением корпорации Майкрософт

В экстренных ситуациях, когда значительная авария приводит к неработоспособности целого региона, корпорация Майкрософт может инициировать отработку отказа между регионами. В этом случае вам не нужно предпринимать какие-либо действия. До завершения отработки отказа под управлением корпорации Майкрософт вы не получите доступ на запись к учетной записи хранения. Приложения могут считывать данные из дополнительного региона, если ваша учетная запись хранения настроена для RA-GRS или RA-ГЗРС.

## <a name="see-also"></a>См. также раздел

- [Разработка высокодоступных приложений с геоизбыточностью](geo-redundant-design.md)
- [Инициирование отработки отказа учетной записи](storage-initiate-account-failover.md)
- [Проверка свойства "Время последней синхронизации" для учетной записи хранения](last-sync-time-get.md)
- [Руководство по Создание высокодоступного приложения с помощью хранилища BLOB-объектов](../blobs/storage-create-geo-redundant-storage.md)