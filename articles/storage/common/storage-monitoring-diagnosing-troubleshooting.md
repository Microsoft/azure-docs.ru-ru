---
title: Мониторинг, диагностика и устранение неполадок в работе службы хранилища Azure | Документация Майкрософт
description: Воспользуйтесь такими функциями, как аналитика хранилища, вход на стороне клиента, и другими сторонними инструментами для выявления, диагностики и устранения проблем, связанных со службой хранилища Azure.
author: normesta
ms.service: storage
ms.topic: troubleshooting
ms.date: 10/08/2020
ms.author: normesta
ms.reviewer: fryu
ms.subservice: common
ms.custom: monitoring, devx-track-csharp
ms.openlocfilehash: 50d78e83bbbeb4b0252c83f9f52e94599ea6946c
ms.sourcegitcommit: a055089dd6195fde2555b27a84ae052b668a18c7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/26/2021
ms.locfileid: "98787966"
---
# <a name="monitor-diagnose-and-troubleshoot-microsoft-azure-storage"></a>Мониторинг, диагностика и устранение неисправностей службы хранилища Microsoft Azure
[!INCLUDE [storage-selector-portal-monitoring-diagnosing-troubleshooting](../../../includes/storage-selector-portal-monitoring-diagnosing-troubleshooting.md)]

## <a name="overview"></a>Обзор
Диагностика и устранение неисправностей в распределенном приложении, размещенном в облачной среде, может представлять большую сложность в сравнении с традиционными средами. Развертывание приложений можно выполнять в инфраструктуре PaaS или IaaS, на площадке заказчика, на мобильном устройстве или в среде, в которой имеется их произвольное сочетание. Обычно сетевой трафик вашего приложения может проходить через общедоступные и частные сети, а ваше приложение может использовать множество технологий хранения данных, например таблицы службы хранилища Microsoft Azure, большие двоичные объекты, очереди или файлы, в дополнение к другим хранилищам данных, таким как реляционные базы данных и базы данных документов.

Чтобы добиться успешного управления такими приложениями необходимо обеспечить наблюдение за ними и понимать принципы диагностики и устранения неисправностей как во всех их аспектах, так и в зависимых от этих приложений технологиях. Как пользователю служб хранения Azure, вам необходимо постоянное наблюдение над службами хранения, которые использует ваше приложение, чтобы обнаружить любое неожиданное поведение (например, более медленный отклик, чем обычно), и использовать ведение журналов для сбора дополнительных подробных данных и их глубокого анализа. Диагностические сведения, которые вы получаете при наблюдении и ведении журналов, помогут установить главную причину неполадки, возникшей при использовании приложения. После этого вы можете выполнить поиск неисправности и определить шаги, необходимые для ее устранения. Хранилище Azure представляет собой главную службу Azure, и составляет важную часть большинства решений, развертываемых заказчиками в инфраструктуре Azure. Хранилище Azure включает функции, предназначенные для упрощения мониторинга, диагностики и поиска неисправностей хранилища для облачных приложений.

* [Введение]
  * [Структура руководства]
* [Мониторинг службы хранилища]
  * [Мониторинг работоспособности службы]
  * [Мониторинг мощностей]
  * [Мониторинг доступности]
  * [Мониторинг производительности]
* [Диагностика неполадок с хранилищем]
  * [Проблемы с работоспособностью службы]
  * [Проблемы с производительностью]
  * [Диагностика ошибок]
  * [Проблемы с эмулятором хранения]
  * [Инструменты для ведения журналов хранилища]
  * [Использование инструментов для ведения сетевого журнала]
* [Комплексная трассировка]
  * [Сопоставление данных журналов]
  * [Идентификатор запроса клиента]
  * [Идентификатор запроса сервера]
  * [Метки времени]
* [Рекомендации по устранению неполадок]
  * [Метрики содержат высокие значения AverageE2ELatency и низкие значения AverageServerLatency]
  * [Метрики содержат низкие значения AverageE2ELatency и низкие значения AverageServerLatency, но клиент сталкивается с большой задержкой]
  * [Метрики содержат высокие значения AverageServerLatency]
  * [При доставке сообщений в очередь возникают неожиданные задержки]
  * [Метрики показывают увеличение значения PercentThrottlingError]
  * [Метрики показывают увеличение значения PercentTimeoutError]
  * [Метрики показывают увеличение значения PercentNetworkError]
  * [Клиент получает сообщения «HTTP 403 (запрещено)»]
  * [Клиент получает сообщения «HTTP 404 (не найдено)»]
  * [Клиент получает сообщения HTTP 409 (конфликт)]
  * [Метрики содержат низкие значения PercentSuccess, или в записях журналов аналитики присутствуют операции с состоянием транзакции ClientOtherErrors]
  * [Метрики объема показывают неожиданное увеличение использования объема хранилища]
  * [Проблема связана с использованием эмулятора хранения на этапе разработки или тестирования]
  * [Возникают проблемы при установке пакета SDK для Azure для .NET]
  * [Возникла другая проблема со службой хранилища]
  * [Устранение неполадок виртуальных жестких дисков на виртуальных машинах Windows](../../virtual-machines/troubleshooting/index.yml)   
  * [Устранение неполадок виртуальных жестких дисков на виртуальных машинах Linux](../../virtual-machines/troubleshooting/index.yml)
  * [Устранение неполадок службы файлов Azure в Windows](../files/storage-troubleshoot-windows-file-connection-problems.md)   
  * [Устранение неполадок службы файлов Azure в Linux](../files/storage-troubleshoot-linux-file-connection-problems.md)
* [Приложения]
  * [Приложение 1. Отслеживание HTTP- и HTTPS-трафика с помощью Fiddler]
  * [Приложение 2. Отслеживание сетевого трафика с помощью Wireshark]
  * [Приложение 4. Просмотр метрик и данных журналов с помощью Excel]
  * [Приложение 5. Мониторинг с использованием Application Insights для Azure DevOps]

## <a name="introduction"></a><a name="introduction"></a>Введение
В этом руководстве показано, как с помощью таких функций, как Azure Storage Analytics, ведение журналов на стороне клиента в клиентской библиотеке хранилища Azure и прочих сторонних инструментов, выявлять, диагностировать и устранять неполадки, связанные с хранилищем Azure.

![Схема, показывающая поток информации между клиентскими приложениями и службами хранилища Azure.][1]

Это руководство в первую очередь предназначено для разработчиков веб-служб, использующих службы хранилища Azure, а также для ИТ-специалистов, ответственных за управление ими. Цели этого руководства:

* Помочь вам поддерживать работоспособность и производительность своих учетных записей хранилища Azure.
* Познакомить вас с процессами и инструментами, помогающими определить, связана ли возникшая в приложении проблема со службой хранилища Azure.
* Предоставить вам практические рекомендации по устранению проблем, связанных с хранилищем Azure.

### <a name="how-this-guide-is-organized"></a><a name="how-this-guide-is-organized"></a>Структура руководства
В разделе[Мониторинг службы хранилища]описывается, как с помощью метрик аналитики хранилища Azure (метрик хранилища) отслеживать работоспособность и производительность ваших служб хранилища Azure.

Раздел[Диагностика неполадок с хранилищем]посвящен диагностике проблем с использованием аналитических журналов хранилища Azure (журналов хранилища). Кроме того, в нем описывается, как включить ведение журналов на стороне клиента с использованием средств из одной или нескольких клиентских библиотек, таких как клиентская библиотека хранилища для .NET или Azure SDK для Java.

В разделе[Комплексная трассировка]вы найдете сведения о корреляции данных из различных журналов и метрик.

В разделе[Рекомендации по устранению неполадок]представлены инструкции по устранению самых распространенных неполадок хранилища, с которыми вы можете столкнуться.

В «[приложениях]» содержатся сведения об использовании других средств, таких как Wireshark и NetMon, для анализа данных сетевых пакетов, а также Fiddler для анализа сообщений HTTP/HTTPS.

## <a name="monitoring-your-storage-service"></a><a name="monitoring-your-storage-service"></a>Мониторинг службы хранилища
Если вы знакомы с системным монитором Windows, то можете считать, что метрики хранилища — эквивалент счетчиков службы хранилища Azure. Они предоставляют полный набор метрик (счетчиков в терминологии системного монитора Windows), позволяющих оценить, например, доступность службы, общее количество запросов к службе, а также процент успешно обработанных запросов. Полный список доступных метрик см. в статье [Storage Analytics Metrics Table Schema](/rest/api/storageservices/Storage-Analytics-Metrics-Table-Schema) (Схема таблицы метрик аналитики хранилища). Вы можете настроить службу хранилища так, чтобы она собирала и агрегировала метрики каждый час или каждую минуту. Дополнительные сведения о том, как включить метрики и отслеживать учетные записи хранения, см. в статье [Enabling storage metrics and viewing metrics data](../blobs/monitor-blob-storage.md) (Включение метрик хранилища и просмотр данных метрик).

Вы можете выбрать, какие ежечасные метрики должны отображаться на [портале Azure](https://portal.azure.com), и настроить правила для уведомления администраторов по электронной почте обо всех случаях, когда эти метрики превышают пороговые уровни. Дополнительные сведения см. в статье [Создание оповещений для служб Azure с помощью портала Azure](../../azure-monitor/platform/alerts-overview.md).

Рекомендуем ознакомиться со статьей [Azure Monitor для хранилищ](../../azure-monitor/insights/storage-insights-overview.md) (предварительная версия). Это функция Azure Monitor, которая обеспечивает комплексный мониторинг ваших учетных записей службы хранилища Azure, создавая единое представление данных о производительности, ресурсах и доступности ваших служб хранилища Azure. Для этого вам не требуется ничего включать или настраивать. Кроме того, вы можете мгновенно просматривать эти метрики в предварительно определенных интерактивных диаграммах и прочих доступных визуализациях.

Метрики позволяют получить довольно полную картину о состоянии службы хранилища, но иногда регистрируют не все операции.

На портале Azure можно просматривать такие метрики для учетной записи хранения, как доступность, общее количество запросов и средние показатели задержки. Кроме того, на этой странице настроено правило для оповещения администратора о спаде доступности ниже определенного уровня. Помимо этих данных, на возможные проблемы также может указывать то, что уровень успешной обработки службы таблиц составляет менее 100 % (дополнительные сведения см. в разделе [Метрики содержат низкие значения PercentSuccess, или в записях журналов аналитики присутствуют операции с состоянием транзакции ClientOtherErrors]).

Чтобы упростить постоянный контроль за работоспособностью и производительностью своих приложений Azure, рекомендуем вам:

* Установить базовые метрики, которые позволят сравнивать текущие данные и выявлять значительные изменения в работе хранилища Azure и вашего приложения. Во многих случаях значения базовых метрик будут зависеть от конкретного приложения — их нужно установить по результатам тестирования программы.
* С помощью ежеминутных метрик активно отслеживать непредвиденные ошибки и необычные изменения, например резкое увеличение числа ошибок или запросов.
* С помощью ежечасных метрик контролировать средние значения, например среднее число ошибок и запросов.
* Изучать потенциальные проблемы с помощью диагностических инструментов, описанных в разделе[Диагностика неполадок с хранилищем].

Диаграммы на представленном ниже рисунке демонстрируют, как усреднение, происходящее при сборе метрик каждый час, скрывает всплески активности. Ежечасные метрики отражают равномерный поток запросов, в то время как ежеминутные показывают колебания, которые происходят на самом деле.

![Диаграммы, показывающие, как усреднение, выполняемое для почасовых метрик, могут скрыть пиковые значения активности.][3]

Последняя часть этого раздела посвящена тому, какие метрики вы должны отслеживать и почему.

### <a name="monitoring-service-health"></a><a name="monitoring-service-health"></a>Мониторинг работоспособности службы
На [портале Azure](https://portal.azure.com) вы можете следить за работоспособностью службы хранилища (и других служб Azure) в любых регионах Azure по всему миру. Мониторинг позволяет мгновенно определить, не затронуто ли ваше приложение проблемой со службой хранилища, на которую вы никак не можете повлиять.

Кроме того, [портал Azure](https://portal.azure.com) может рассылать уведомления об инцидентах, влияющих на различные службы Azure.
Примечание. Ранее эта информация, наряду с данными журналов, была доступна на [панели мониторинга служб Azure](https://status.azure.com).
Дополнительные сведения об Application Insights для Azure DevOps см. в [приложении 5. "Мониторинг с использованием Application Insights для Azure DevOps"](#appendix-5).

### <a name="monitoring-capacity"></a><a name="monitoring-capacity"></a>Мониторинг мощностей
В метриках емкости учитывается только служба BLOB-объектов, так как именно они обычно занимают больше всего места (на момент подготовки этой статьи метрики хранилища невозможно использовать для мониторинга емкости таблиц и очередей). Если вы включили мониторинг службы BLOB-объектов, то можете найти эти данные в таблице **$MetricsCapacityBlob**. Метрики хранилища регистрируют подобные сведения каждый день. По значению **RowKey** вы можете определить, к чему относится запись в строке: к пользовательским (значение **data**) или к аналитическим данным (значение **analytics**). Каждая сохраненная запись содержит информацию о занятом месте (показатель **Capacity** в байтах), а также о том, сколько контейнеров (**ContainerCount**) и BLOB-объектов (**ObjectCount**) на данный момент используется в учетной записи хранилища. Дополнительные сведения о метриках емкости, хранящихся в таблице **$MetricsCapacityBlob**, см. в статье [Storage Analytics Metrics Table Schema](/rest/api/storageservices/Storage-Analytics-Metrics-Table-Schema) (Схема таблицы метрик аналитики хранилища).

> [!NOTE]
> Рекомендуем вам отслеживать эти значения, так как они позволяют заранее определить, что в вашей учетной записи хранилища скоро будут достигнуты пределы емкости. На портале Azure можно добавить правила генерации оповещений о превышении установленных пороговых значений используемой емкости.
>
>

Чтобы узнать, как оценить размер различных объектов для хранения данных, например больших двоичных объектов, прочтите запись блога [Общая информация о плате за использование хранилища Azure: пропускная способность, транзакции и емкость](/archive/blogs/patrick_butler_monterde/azure-storage-understanding-windows-azure-storage-billing-bandwidth-transactions-and-capacity).

### <a name="monitoring-availability"></a><a name="monitoring-availability"></a>Мониторинг доступности
Вы должны отслеживать доступность служб хранилища в своей учетной записи хранения путем мониторинга значения в столбце **Доступность** таблиц, содержащих метрики, которые фиксируются каждую минуту или каждый час: **$MetricsHourPrimaryTransactionsBlob**, **$MetricsHourPrimaryTransactionsTable**, **$MetricsHourPrimaryTransactionsQueue**, **$MetricsMinutePrimaryTransactionsBlob**, **$MetricsMinutePrimaryTransactionsTable**, **$MetricsMinutePrimaryTransactionsQueue** и **$MetricsCapacityBlob**. Столбец **Доступность** содержит процентное значение, которое отражает доступность службы или операции API, указанной в соответствующей строке (**Ключ строки** показывает, содержит ли строка метрики для службы в целом или только для конкретной операции API).

Если значение меньше 100 %, это означает, что некоторые запросы к хранилищу не были выполнены. Чтобы узнать, в чем причина сбоя, проверьте другие столбцы с данными метрик, означающих число запросов с ошибками разных типов, например **Ошибка времени ожидания сервера**. Вы должны быть готовы к тому, что иногда значение в столбце **Доступность** временно опускается ниже 100 % по определенным причинам (например, из-за превышения времени ожидания на сервере, когда служба перемещает разделы для балансировки нагрузки по запросам). Логический алгоритм повтора в вашем клиентском приложении должен обрабатывать эти периодически возникающие ситуации. В статье [Storage Analytics Logged Operations and Status Messages](/rest/api/storageservices/Storage-Analytics-Logged-Operations-and-Status-Messages) (Регистрируемые операции и сообщения о состоянии аналитики хранилища) перечислены типы транзакций, которые учитываются системой метрик хранилища при расчете значения **Availability**.

На [портале Azure](https://portal.azure.com)можно добавить правила генерации оповещений, чтобы получать уведомления, когда значение **Availability** для службы опустится ниже заданного порога.

В разделе[Рекомендации по устранению неполадок]этого руководства описаны некоторые распространенные проблемы со службой хранилища, связанные с доступностью.

### <a name="monitoring-performance"></a><a name="monitoring-performance"></a>Мониторинг производительности
Для отслеживания производительности можно использовать перечисленные ниже метрики из таблиц, содержащих метрики, которые фиксируются каждую минуту или каждый час.

* Значения в столбцах **AverageE2ELatency** и **AverageServerLatency** соответствуют среднему времени, затрачиваемому службой хранилища или операцией API на обработку запросов. **AverageE2ELatency** — это показатель сквозной задержки, который включает в себя время, затраченное на чтение запроса и отправку ответа, а также время обработки запроса (следовательно, сюда входит задержка в сети после того, как запрос достигнет службы хранилища). В метрике **AverageServerLatency** учитывается только время обработки, т. е. в это значение не включена задержка в сети, которая относится к взаимодействию с клиентом. В разделе [Метрики содержат высокие значения AverageE2ELatency и низкие значения AverageServerLatency] далее в этом руководстве рассматриваются причины, по которым эти два значения могут сильно отличаться друг от друга.
* Значения в столбцах **Всего исходящих** и **Всего входящих** показывают общий объем данных (в байтах), передаваемых в службу хранилища и из нее или получаемых и отправляемых с помощью определенной операции API.
* Значения в столбце **TotalRequests** (Всего запросов) показывают общее число запросов, получаемых службой хранилища или операцией API. **TotalRequests** — это общее число запросов, которые получает служба хранилища.

Обычно выполняется мониторинг неожиданных изменений каждого из этих значений, так как это говорит о том, что возникла проблема, требующая внимания.

На [портале Azure](https://portal.azure.com)можно добавить правила генерации оповещений, чтобы получать уведомления, когда значение любой из метрик производительности для службы опустится ниже заданного порога.

В разделе[Рекомендации по устранению неполадок]этого руководства описаны некоторые распространенные проблемы со службой хранилища, связанные с производительностью.

## <a name="diagnosing-storage-issues"></a><a name="diagnosing-storage-issues"></a>Диагностика неполадок с хранилищем
Понять, что в приложении возникла проблема или неполадка, можно по нескольким признакам. Вот некоторые из них:

* серьезный сбой, который приводит к прекращению или аварийному завершению работы приложения;
* существенные отклонения от базовых значений метрик, мониторинг которых выполняется в соответствии с описанием в предыдущем разделе[Мониторинг службы хранилища];
* сообщения от пользователей приложения, в которых сказано, что определенная операция не выполнена должным образом или что какая-то функция не работает;
* ошибки, сгенерированные приложением, о которых вы узнали из файлов журналов или благодаря полученным уведомлениям.

Обычно неполадки, связанные со службами хранилища Azure, можно отнести к одной из следующих четырех обширных категорий:

* в приложении возникла проблема с производительностью, о которой сообщают пользователи или свидетельствуют изменения метрик производительности;
* возникла проблема с инфраструктурой службы хранилища Azure в одном или нескольких регионах;
* в приложении произошла ошибка, о которой сообщают пользователи или свидетельствует увеличение значения одной из отслеживаемых вами метрик, являющейся счетчиком ошибок;
* если в ходе разработки и тестирования вы используете локальный эмулятор хранения, то могут возникать неполадки, связанные именно с этим.

В следующих разделах описаны шаги, которые нужно выполнить для диагностики и устранения неполадок, относящихся к каждой из четырех категорий. В разделе[Рекомендации по устранению неполадок]ниже в этом руководстве содержатся подробные сведения о некоторых распространенных неполадках.

### <a name="service-health-issues"></a><a name="service-health-issues"></a>Проблемы с работоспособностью службы
Чаще всего проблемы с работоспособностью службы находятся вне вашего контроля. На [портале Azure](https://portal.azure.com) содержится информация обо всех текущих неполадках со службами Azure, включая службы хранилища. Если при создании своей учетной записи хранения вы выбрали геоизбыточное хранилище с доступом на чтение, то в ситуации, когда ваши данные будут недоступны в основном расположении, приложение сможет временно переключиться на копию, доступную только для чтения, во вторичном расположении. Для считывания во вторичном расположении у приложения должна быть возможность переключаться между основным и вторичным расположениями хранилища и работать в режиме сниженной функциональности с данными, доступными только для чтения. С помощью клиентских библиотек службы хранилища Azure можно определить политику повтора, чтобы выполнять чтение из дополнительного хранилища, если чтение из основного хранилища завершается с ошибкой. Приложение также должно располагать сведениями о том, что данные во вторичном местоположении согласованы в конечном счете. Дополнительные сведения см. в записи блога [Параметры избыточности в службе хранилища Azure и геоизбыточное хранилище с доступом на чтение](https://blogs.msdn.microsoft.com/windowsazurestorage/2013/12/11/windows-azure-storage-redundancy-options-and-read-access-geo-redundant-storage/).

### <a name="performance-issues"></a><a name="performance-issues"></a>Проблемы с производительностью
Производительность приложения — субъективный показатель, особенно с точки зрения пользователя. По этой причине важно использовать базовые значения метрик, чтобы потом использовать их для выявления возможных проблем с производительностью. На производительность службы хранилища Azure с точки зрения клиентского приложения могут оказывать влияние многие факторы. Они могут относиться к службе хранилища, клиенту или сетевой инфраструктуре, поэтому важно сформировать стратегию, позволяющую определять источники проблем с производительностью.

После того как на основе метрик предположительно определено место, где возникла причина неполадки, вы можете воспользоваться подробными данными из файлов журналов для дальнейшей диагностики и устранения проблемы.

В разделе [Рекомендации по устранению неполадок] ниже в этом руководстве содержатся дополнительные сведения о некоторых распространенных неполадках.

### <a name="diagnosing-errors"></a><a name="diagnosing-errors"></a>Диагностика ошибок
Пользователи могут уведомлять вас об ошибках, о которых сообщает клиентское приложение. Система метрик хранилища также фиксирует количество ошибок разных типов, связанных со службами хранилища, в том числе **NetworkError** (Ошибка сети), **ClientTimeoutError** (Ошибка времени ожидания клиента) и **AuthorizationError** (Ошибка авторизации). В метриках хранилища фиксируется только количество ошибок каждого типа, но вы можете получить больше данных об отдельных запросах, просмотрев журналы на стороне сервера и клиента, а также сетевой журнал. Обычно по коду состояния HTTP, возвращенному службой хранилища, можно установить причину неудачного выполнения запроса.

> [!NOTE]
> Помните, что иногда будут возникать некоторые временные ошибки. Это могут быть, например, ошибки, связанные с кратковременным нарушением работоспособности сети, или ошибки приложения.
>
>

Чтобы подробно узнать о кодах состояний и ошибок, связанных с хранилищем, ознакомьтесь со следующими полезными ресурсами:

* [Общие коды ошибок API-интерфейса REST](/rest/api/storageservices/Common-REST-API-Error-Codes)
* [Коды ошибок службы BLOB-объектов](/rest/api/storageservices/Blob-Service-Error-Codes)
* [Коды ошибок службы очередей](/rest/api/storageservices/Queue-Service-Error-Codes)
* [Коды ошибок для службы таблиц](/rest/api/storageservices/Table-Service-Error-Codes)
* [Коды ошибок файловой службы](/rest/api/storageservices/File-Service-Error-Codes)

### <a name="storage-emulator-issues"></a><a name="storage-emulator-issues"></a>Проблемы с эмулятором хранения
Пакет Azure SDK содержит эмулятор хранения, который вы можете запустить на рабочей станции, где ведется разработка. Этот эмулятор почти полностью моделирует работу служб хранилища Azure и может пригодится на этапах разработки и тестирования: он позволяет запускать приложения, использующие службы хранилища Azure, без подписки Azure и учетной записи хранения Azure.

В разделе[Рекомендации по устранению неполадок]этого руководства описаны некоторые распространенные проблемы, связанные с эмулятором хранения.

### <a name="storage-logging-tools"></a><a name="storage-logging-tools"></a>Инструменты для ведения журналов хранилища
Ведение журналов хранилища подразумевает запись в журнал на стороне сервера запросов к хранилищу в вашей учетной записи хранения Azure. Дополнительные сведения о том, как включить ведение журнала на стороне сервера, и о доступе к данным журнала см. в статье [Enabling Storage Logging and Accessing Log Data](./storage-analytics-logging.md) (Включение ведения журнала и доступ к данным журнала хранилища).

С помощью клиентской библиотеки хранилища для .NET вы можете собирать на стороне клиента данные журнала, связанные с операциями хранилища, которые выполняются приложением. Дополнительные сведения см. в статье [Client-side Logging with the .NET Storage Client Library](/rest/api/storageservices/Client-side-Logging-with-the-.NET-Storage-Client-Library) (Ведение журналов на стороне клиента с помощью клиентской библиотеки хранилища для .NET).

> [!NOTE]
> В некоторых ситуациях (например, при ошибке авторизации SAS) пользователь может сообщить об ошибке, для которой вам не удастся найти данные запроса в журналах хранилища на стороне сервера. В таком случае воспользуйтесь возможностями ведения журналов, имеющимися в клиентской библиотеке хранилища, чтобы выяснить, не находится ли причина неполадки на стороне клиента. Кроме того, можно проверить сеть с помощью инструментов мониторинга сети.
>
>

### <a name="using-network-logging-tools"></a><a name="using-network-logging-tools"></a>Использование инструментов для ведения сетевого журнала
Вы можете фиксировать трафик между клиентом и сервером, чтобы собирать подробные сведения о том, какими данными они обмениваются, и о текущем состоянии сети. Ниже перечислены некоторые полезные инструменты для ведения сетевого журнала.

* [Fiddler](https://www.telerik.com/fiddler) — это бесплатный веб-прокси для отладки, с помощью которого можно проверять заголовки и полезные данные HTTP- и HTTPS-запросов, а также ответных сообщений. Дополнительные сведения см. в [приложении 1 "Отслеживание HTTP- и HTTPS-трафика с помощью Fiddler"](#appendix-1).
* [Microsoft Network Monitor (Netmon)](https://download.cnet.com/s/network-monitor/) и [Wireshark](https://www.wireshark.org/) — бесплатные средства для анализа сетевых протоколов, с помощью которых можно просматривать подробную информацию о пакетах для широкого спектра сетевых протоколов. Дополнительные сведения о Wireshark см. в [приложении 2 "Отслеживание сетевого трафика с помощью Wireshark"](#appendix-2).
* Если вы хотите выполнить базовый тест подключения, чтобы проверить, может ли клиентская машина подключиться к службе хранилища Azure по сети, этого не удастся сделать с помощью стандартного инструмента **ping** на клиенте. Однако вы можете воспользоваться для проверки подключения инструментом [**tcping**](https://www.elifulkerson.com/projects/tcping.php).

Во многих случаях данных журналов хранилища и клиентской библиотеки хранилища достаточно для диагностики проблемы, но иногда вам могут потребоваться более подробные сведения, чем способны предоставить эти инструменты. Например, используя Fiddler для просмотра сообщений HTTP и HTTPS, вы можете видеть заголовки и полезные данные, отправленные в службы хранилища и из них. Это позволяет проверить, как работает повтор операций хранилища в клиентском приложении. Средства для анализа протоколов, такие как Wireshark, работают на уровне пакетов, благодаря чему вы можете просматривать данные TCP и выявлять потерянные пакеты и проблемы с подключением. 

## <a name="end-to-end-tracing"></a><a name="end-to-end-tracing"></a>Комплексная трассировка
Комплексная трассировка с использованием разнообразных файлов журналов — это полезный метод выявления потенциальных проблем. Чтобы указать, с какого момента нужно просматривать файлы журналов в поисках подробной информации для диагностики и устранения неполадок, вы можете воспользоваться значениями даты и времени из данных метрик.

### <a name="correlating-log-data"></a><a name="correlating-log-data"></a>Сопоставление данных журналов
При просмотре журналов клиентских приложений, сетевой трассировки и журналов хранилища на стороне сервера очень важно иметь возможность сопоставлять между собой запросы из разных файлов журналов. Файлы журналов содержат некоторое количество различных полей, которые удобно использовать как идентификаторы при сопоставлении записей. Удобнее всего сопоставлять записи в разных журналах по идентификатору запроса клиента. Однако иногда бывает полезно использовать идентификатор запроса сервера или метки времени. Эти возможности рассматриваются подробнее в следующих разделах.

### <a name="client-request-id"></a><a name="client-request-id"></a>Идентификатор запроса клиента
Клиентская библиотека хранилища автоматически генерирует уникальный идентификатор каждого запроса клиента.

* В журнале на стороне клиента, создаваемом клиентской библиотекой хранилища, идентификатор запроса клиента отображается в поле **ИД запроса клиента** каждой записи, относящейся к запросу.
* В данных сетевой трассировки, например выполненной с помощью Fiddler, идентификатор запроса клиента можно увидеть в сообщениях запросов. Это значение заголовка HTTP **x-ms-client-request-id**.
* В журнале хранилища на стороне сервера идентификатор запроса клиента отображается в столбце "ИД запроса клиента".

> [!NOTE]
> Возможна ситуация, когда один идентификатор запроса клиента соответствует нескольким запросам. Это связано с тем, что клиент может назначить такое значение (хотя клиентская библиотека хранилища автоматически назначает новое значение). Если клиент выполняет повторные попытки, всем им присваивается один и тот же идентификатор клиентского запроса. Когда клиент отправляет пакет, ему присваивается один идентификатор запроса клиента.
>
>

### <a name="server-request-id"></a><a name="server-request-id"></a>Идентификатор запроса сервера
Служба хранилища автоматически генерирует идентификаторы запросов сервера.

* В журнале хранилища на стороне сервера идентификатор запроса сервера отображается в столбце **Request ID header** (Заголовок идентификатора запроса).
* В данных сетевой трассировки, например выполненной с помощью Fiddler, идентификатор запроса сервера можно увидеть в ответных сообщениях. Это значение заголовка HTTP **x-ms-request-id**.
* В журнале на стороне клиента, создаваемом клиентской библиотекой хранилища, идентификатор запроса сервера отображается в столбце **Operation Text** (Текст операции) записи, которая содержит подробные сведения об ответе сервера.

> [!NOTE]
> Служба хранилища всегда назначает новый идентификатор запроса сервера каждому полученному запросу, так что каждой повторной попытке, предпринятой клиентом, и каждой операции в пакете соответствует уникальный идентификатор запроса сервера.
>
>

# <a name="net-v12"></a>[.NET (версии 12)](#tab/dotnet)

В примере кода ниже показано, как использовать идентификатор настраиваемого запроса клиента. 

:::code language="csharp" source="~/azure-storage-snippets/blobs/howto/dotnet/dotnet-v12/Monitoring.cs" id="Snippet_UseCustomRequestID":::

# <a name="net-v11"></a>[.NET (версии 11)](#tab/dotnet11)

Если клиентская библиотека хранилища генерирует исключение **StorageException** в клиенте, то свойство **RequestInformation** содержит объект **RequestResult**, который включает в себя свойство **ServiceRequestID**. Объект **RequestResult** также доступен в экземпляре **OperationContext**.

В приведенном ниже примере кода показано, как настроить пользовательское значение **ClientRequestId**, прикрепив объект **OperationContext** к запросу к службе хранилища. Кроме того, показано, как извлечь значение **ServerRequestId** из ответного сообщения.

```csharp
//Parse the connection string for the storage account.
const string ConnectionString = "DefaultEndpointsProtocol=https;AccountName=account-name;AccountKey=account-key";
CloudStorageAccount storageAccount = CloudStorageAccount.Parse(ConnectionString);
CloudBlobClient blobClient = storageAccount.CreateCloudBlobClient();

// Create an Operation Context that includes custom ClientRequestId string based on constants defined within the application along with a Guid.
OperationContext oc = new OperationContext();
oc.ClientRequestID = String.Format("{0} {1} {2} {3}", HOSTNAME, APPNAME, USERID, Guid.NewGuid().ToString());

try
{
    CloudBlobContainer container = blobClient.GetContainerReference("democontainer");
    ICloudBlob blob = container.GetBlobReferenceFromServer("testImage.jpg", null, null, oc);  
    var downloadToPath = string.Format("./{0}", blob.Name);
    using (var fs = File.OpenWrite(downloadToPath))
    {
        blob.DownloadToStream(fs, null, null, oc);
        Console.WriteLine("\t Blob downloaded to file: {0}", downloadToPath);
    }
}
catch (StorageException storageException)
{
    Console.WriteLine("Storage exception {0} occurred", storageException.Message);
    // Multiple results may exist due to client side retry logic - each retried operation will have a unique ServiceRequestId
    foreach (var result in oc.RequestResults)
    {
            Console.WriteLine("HttpStatus: {0}, ServiceRequestId {1}", result.HttpStatusCode, result.ServiceRequestID);
    }
}
```

---

### <a name="timestamps"></a><a name="timestamps"></a>Метки времени
Для поиска связанных записей в журналах можно также использовать метки времени, однако при этом нужно учитывать возможное расхождение в значениях времени между клиентом и сервером. Поиск соответствующих записей на стороне сервера нужно выполнять в интервале, охватывающем по 15 минут до и после метки времени на клиенте. Помните, что метаданные больших двоичных объектов, содержащих метрики, определяют для них временной диапазон. Это полезно, если у вас есть много больших двоичных объектов с метриками, относящимися к одной минуте или часу.

## <a name="troubleshooting-guidance"></a><a name="troubleshooting-guidance"></a>Рекомендации по устранению неполадок
Сведения, приведенные в этом разделе, помогут вам диагностировать и устранять некоторые распространенные неполадки, которые могут возникнуть при работе вашего приложения со службами хранилища Azure. Чтобы найти информацию о конкретной проблеме, просмотрите список ниже.

**Дерево решений по устранению неполадок**

---
Относится ли ваша проблема к производительности одной из служб хранилища?

* [Метрики содержат высокие значения AverageE2ELatency и низкие значения AverageServerLatency]
* [Метрики содержат низкие значения AverageE2ELatency и низкие значения AverageServerLatency, но клиент сталкивается с большой задержкой]
* [Метрики содержат высокие значения AverageServerLatency]
* [При доставке сообщений в очередь возникают неожиданные задержки]

---
Связана ли неполадка с доступностью одной из служб хранилища?

* [Метрики показывают увеличение значения PercentThrottlingError]
* [Метрики показывают увеличение значения PercentTimeoutError]
* [Метрики показывают увеличение значения PercentNetworkError]

---
 Получает ли клиентское приложение ответ HTTP 4XX (например, с кодом 404) от службы хранилища?

* [Клиент получает сообщения «HTTP 403 (запрещено)»]
* [Клиент получает сообщения «HTTP 404 (не найдено)»]
* [Клиент получает сообщения HTTP 409 (конфликт)]

---
[Метрики содержат низкие значения PercentSuccess, или в записях журналов аналитики присутствуют операции с состоянием транзакции ClientOtherErrors]

---
[Метрики объема показывают неожиданное увеличение использования объема хранилища]

---
[Происходит неожиданный перезапуск виртуальных машин, имеющих большое количество виртуальных жестких дисков]

---
[Проблема связана с использованием эмулятора хранения на этапе разработки или тестирования]

---
[Возникают проблемы при установке пакета SDK для Azure для .NET]

---
[Возникла другая проблема со службой хранилища]

---
### <a name="metrics-show-high-averagee2elatency-and-low-averageserverlatency"></a><a name="metrics-show-high-AverageE2ELatency-and-low-AverageServerLatency"></a>Метрики содержат высокие значения AverageE2ELatency и низкие значения AverageServerLatency
На приведенной ниже иллюстрации из средства мониторинга на [портале Azure](https://portal.azure.com) показана ситуация, когда значение метрики **AverageE2ELatency** значительно выше значения метрики **AverageServerLatency**.

![Иллюстрация из портал Azure, в которой показан пример, где AverageE2ELatency значительно выше, чем значения averageserverlatency.][4]

Служба хранилища вычисляет только **AverageE2ELatency** метрики для успешных запросов и, в отличие от **значения averageserverlatency**, включает время, затрачиваемое клиентом на отправку данных и получение подтверждения от службы хранилища. Поэтому разница между значениями метрик **AverageE2ELatency** и **AverageServerLatency** может быть обусловлена либо медленным ответом клиентского приложения, либо состоянием сети.

> [!NOTE]
> Вы также можете просмотреть метрики **E2ELatency** и **ServerLatency** для отдельных операций хранилища в журнале хранилища.
>
>

#### <a name="investigating-client-performance-issues"></a>Изучение проблем с производительностью клиента
К возможным причинам медленного ответа клиента относится ограниченное количество доступных подключений или потоков, а также нехватка ресурсов, таких как ЦП, память и пропускная способность сети. Чтобы решить эту проблему, можно изменить код клиента, повысив его эффективность (например, с помощью асинхронных вызовов службы хранилища), или использовать виртуальную машину большего размера (с большим числом ядер или объемом памяти).

Для служб таблиц и очередей алгоритм Нейгла также может приводить к высокому значению метрики **AverageE2ELatency** по сравнению с метрикой **AverageServerLatency**. Дополнительные сведения см. в записи блога [Nagle’s Algorithm is Not Friendly towards Small Requests](/archive/blogs/windowsazurestorage/nagles-algorithm-is-not-friendly-towards-small-requests) (Алгоритм Нейгла не ориентирован на мелкие запросы). Вы можете отключить алгоритм Нейгла в коде с помощью класса **ServicePointManager** в пространстве имен **System.Net**. Это следует сделать до выполнения вызовов к службам таблиц или очередей в приложении, так как на открытые подключения это не распространяется. Приведенный ниже пример взят из метода **Application_Start** в рабочей роли.

# <a name="net-v12"></a>[.NET (версии 12)](#tab/dotnet)

:::code language="csharp" source="~/azure-storage-snippets/blobs/howto/dotnet/dotnet-v12/Monitoring.cs" id="Snippet_DisableNagle":::

# <a name="net-v11"></a>[.NET (версии 11)](#tab/dotnet11)

```csharp
var storageAccount = CloudStorageAccount.Parse(connStr);
ServicePoint queueServicePoint = ServicePointManager.FindServicePoint(storageAccount.QueueEndpoint);
queueServicePoint.UseNagleAlgorithm = false;
```

---

Вы должны просмотреть журналы на стороне клиента, чтобы понять, сколько запросов отправляет приложение, а также проверить общие узкие места, связанные с производительностью .NET, в приложении. К ним относятся использование процессора, сети и памяти, а также сборка мусора .NET. В качестве отправной точки для устранения неполадок в клиентских приложениях .NET используйте статью [Debugging, Tracing, and Profiling](/dotnet/framework/debug-trace-profile/) (Отладка, трассировка и профилирование).

#### <a name="investigating-network-latency-issues"></a>Изучение проблем, связанных с задержками в сети
Как правило, большие задержки в сети возникают из-за временных условий. Вы можете исследовать как временные, так и постоянные сетевые проблемы, такие как отброшенные пакеты, с помощью таких средств, как Wireshark.

Дополнительные сведения об устранении неполадок в сети с помощью Wireshark см. в [Приложение 2. Отслеживание сетевого трафика с помощью Wireshark].

### <a name="metrics-show-low-averagee2elatency-and-low-averageserverlatency-but-the-client-is-experiencing-high-latency"></a><a name="metrics-show-low-AverageE2ELatency-and-low-AverageServerLatency"></a>Метрики содержат низкие значения AverageE2ELatency и низкие значения AverageServerLatency, но клиент сталкивается с большой задержкой
В такой ситуации наиболее вероятной причиной является поступление запросов в службу хранилища с задержкой. Вам необходимо проанализировать, почему запросы от клиента не поступают в службу BLOB-объектов.

Одной из возможных причин задержек при отправке запросов клиентом является ограниченное количество доступных подключений или потоков.

Также следует проверить, не выполняет ли клиент несколько повторных попыток. Если выполняет, необходимо установить причину. Проверить, выполняет ли клиент несколько повторных попыток, можно следующими способами:

* Изучите журналы аналитики хранилища. Если выполняется сразу несколько попыток, вы увидите несколько операций с одинаковым идентификатором запроса клиента, но с разными идентификаторами запроса сервера.
* Изучите журналы клиента. Подробное ведение журнала позволит определить наличие повторной попытки.
* Выполните отладку кода и проверьте свойства объекта **OperationContext** , связанного с данным запросом. Если операция повторялась, свойство **RequestResults** будет содержать несколько уникальных идентификаторов запросов сервера. Можно также проверить время начала и окончания для каждого запроса. Для получения дополнительных сведений изучите пример кода в разделе [Идентификатор запроса сервера].

Если в клиенте неполадки не обнаружены, проверьте, нет ли проблем в сети (например, потери пакетов). Для анализа сетевых проблем можно использовать такие средства, как Wireshark.

Дополнительные сведения об устранении неполадок в сети с помощью Wireshark см. в [Приложение 2. Отслеживание сетевого трафика с помощью Wireshark].

### <a name="metrics-show-high-averageserverlatency"></a><a name="metrics-show-high-AverageServerLatency"></a>Метрики содержат высокие значения AverageServerLatency
В случае высокого значения **AverageServerLatency** для запросов на загрузку BLOB-объектов следует просмотреть журналы хранилища, чтобы проверить, нет ли повторных запросов для одного и того же BLOB-объекта (или набора BLOB-объектов). Для запросов на отправку больших двоичных объектов следует проверить, какой размер блоков используется в клиенте (например, блоки размером менее 64 КБ могут приводить к дополнительным издержкам, если только считывание не производится фрагментами размером менее 64 КБ) и не отправляются ли блоки в один большой двоичный объект параллельно несколькими клиентами. Следует также проверить поминутные метрики, чтобы определить наличие пиковых увеличений числа запросов, которые приводят к превышению посекундных целевых показателей масштабируемости. См. также раздел [Метрики показывают увеличение значения PercentTimeoutError].

Если высокое значение метрики **AverageServerLatency** для запросов загрузки BLOB-объектов наблюдается из-за повторяющихся запросов к одному и тому же BLOB-объекту или набору BLOB-объектов, рекомендуем кэшировать эти объекты с помощью кэша Azure или сети доставки содержимого (CDN) Azure. Для запросов отправки пропускную способность можно увеличить с помощью блоков большего размера. Для запросов к таблицам также можно реализовать кэширование на стороне клиента, если клиенты выполняют одни и те же операции запросов и если данные изменяются не часто.

Высокие значения метрики **AverageServerLatency** также могут быть симптомом неправильной структуры таблиц или запросов, которая приводит к выполнению операций сканирования или построена по ошибочному шаблону добавления в конец и начало. Дополнительные сведения см. в разделе [Метрики показывают увеличение значения PercentThrottlingError].

> [!NOTE]
> Вы можете найти комплексный контрольный список обеспечения производительности здесь: [Производительность хранилища Microsoft Azure и контрольный список масштабируемости](../blobs/storage-performance-checklist.md).
>
>

### <a name="you-are-experiencing-unexpected-delays-in-message-delivery-on-a-queue"></a><a name="you-are-experiencing-unexpected-delays-in-message-delivery"></a>При доставке сообщений в очередь возникают неожиданные задержки
Если после добавления сообщения в очередь приложением оно становится доступным для чтения из очереди с задержкой, то для диагностики этой неполадки следует выполнить указанные ниже действия.

* Убедитесь в том, что приложение успешно добавляет сообщения в очередь. Проверьте, не приходится ли приложению вызывать метод **AddMessage** несколько раз для добавления сообщения. В журналах клиентской библиотеки хранилища содержатся записи о повторных попытках выполнения операций с хранилищем.
* Проверьте, нет ли рассинхронизации по времени между рабочей ролью, добавляющей сообщение в очередь, и рабочей ролью, считывающей сообщение из очереди. Такая рассинхронизация может восприниматься как задержка обработки.
* Проверьте, нет ли сбоев рабочей роли, считывающей сообщения из очереди. Если клиент очереди **вызывает метод инвисибилититимеаут, но** не отвечает на подтверждение, сообщение остается невидимым в очереди, пока не истечет период  . После этого сообщение снова станет доступным для обработки.
* Проверьте, не увеличивается ли длина очереди со временем. Это может происходить из-за нехватки рабочих ролей для обработки всех сообщений, помещаемых в очередь другими рабочими ролями. Кроме того, следует проверить метрики, чтобы установить, не происходят ли сбои при выполнении запросов удаления, а также проверить счетчик удаления сообщений из очереди, который может указывать на повторяющиеся неудачные попытки удаления сообщений.
* Проверьте журналы хранилища на наличие операций с очередью, имеющих неожиданно высокие значения метрик **E2ELatency** и **ServerLatency** в течение более длительного периода времени, чем обычно.

### <a name="metrics-show-an-increase-in-percentthrottlingerror"></a><a name="metrics-show-an-increase-in-PercentThrottlingError"></a>Метрики показывают увеличение значения PercentThrottlingError
Ошибки регулирования происходят при превышении целевых показателей масштабируемости для службы хранилища. Регулирование службы хранилища происходит для того, чтобы ни один из клиентов не мог использовать службу хранилища в ущерб другим. Дополнительные сведения о целевых показателях масштабируемости для учетных записей хранилища и целевых показателях производительности для секций внутри учетных записей хранения см. в разделе [Целевые показатели производительности и масштабируемости для стандартных учетных записей хранения](scalability-targets-standard-account.md).

Если метрика **PercentThrottlingError** показывает увеличение процента запросов, при выполнении которых происходят ошибки регулирования, необходимо проверить два сценария:

* [Временное увеличение метрики PercentThrottlingError]
* [Постоянное увеличение метрики PercentThrottlingError]

Метрика **PercentThrottlingError** часто увеличивается одновременно с увеличением числа запросов к хранилищу или при первоначальном нагрузочном тестировании приложения. Это также может проявляться в получении сообщений о состоянии HTTP 503 "Сервер занят" или 500 "Время ожидания операции истекло" в клиенте при операциях с хранилищем.

#### <a name="transient-increase-in-percentthrottlingerror"></a><a name="transient-increase-in-PercentThrottlingError"></a>Временное увеличение метрики PercentThrottlingError
Если в значении метрики **PercentThrottlingError** наблюдаются пиковые скачки, совпадающие с периодами высокой активности приложения, следует реализовать стратегию повторения с экспоненциальной, а не линейной задержкой в клиенте. Это позволит снизить мгновенную нагрузку на секцию и сгладить пиковые скачки трафика. Дополнительные сведения о том, как реализовать политики повтора с помощью клиентской библиотеки хранилища, см. в статье [Пространство имен Microsoft.Azure.Storage.RetryPolicies](/dotnet/api/microsoft.azure.storage.retrypolicies).

> [!NOTE]
> В значении метрики **PercentThrottlingError** также могут наблюдаться пиковые скачки, не совпадающие с периодами высокой активности приложения. Наиболее вероятная причина в этом случае — перемещение секций службой хранилища для балансировки нагрузки.
>
>

#### <a name="permanent-increase-in-percentthrottlingerror-error"></a><a name="permanent-increase-in-PercentThrottlingError"></a>Постоянное увеличение метрики PercentThrottlingError
Если наблюдается стабильно высокое значение метрики **PercentThrottlingError** после постоянного увеличения объемов транзакций или при выполнении первоначального нагрузочного тестирования приложения, то нужно проанализировать, как приложение использует разделы хранилища и не достигнуты ли целевые показатели масштабируемости для учетной записи хранения. Например, если возникают ошибки регулирования в очереди (которая считается одним разделом), то мы рекомендуем использовать дополнительные очереди для распределения транзакций между несколькими разделами. Если ошибки регулирования возникают в таблице, следует пересмотреть схему секционирования с целью распределения транзакций между несколькими разделами благодаря большему числу значений ключей разделов. Распространенной причиной этой проблемы является ошибочный шаблон добавления в конец и начало, при котором в качестве ключа раздела выбирается дата, а затем все данные за определенный день записываются в один раздел. При нагрузке это может спровоцировать появление узкого места. Измените схему секционирования или оцените возможность использования хранилища BLOB-объектов как более оптимального решения. Также следует проверить, не является ли регулирование результатом пиковых скачков трафика, и попытаться оптимизировать схему запросов.

Если транзакции распределяются между несколькими разделами, следует тем не менее учитывать предельные значения масштабируемости, установленные для учетной записи хранения. Например, если используются десять очередей, каждая из которых обрабатывает максимум 2000 сообщений по 1 КБ в секунду, предельная масштабируемость для учетной записи составляет 20 000 сообщений в секунду. Если необходимо обрабатывать более 20 000 объектов в секунду, рекомендуем использовать несколько учетных записей хранения. Также следует иметь в виду, что размер запросов и объектов влияет на то, когда служба хранилища начинает регулировать работу клиентов: чем больше этот размер, тем раньше может включиться регулирование.

Неэффективная структура запросов также может привести к достижению предельных значений масштабируемости для разделов таблицы. Например, запросу с фильтром, выбирающим только один процент объектов в разделе, но сканирующим все объекты, потребуется обращаться к каждому объекту. Каждая операция чтения объекта увеличивает общее число транзакций в разделе, поэтому вы можете легко достичь целевых показателей масштабируемости.

> [!NOTE]
> Неэффективная структура запросов должна выявляться при тестировании производительности приложения.
>
>

### <a name="metrics-show-an-increase-in-percenttimeouterror"></a><a name="metrics-show-an-increase-in-PercentTimeoutError"></a>Метрики показывают увеличение значения PercentTimeoutError
Вы можете наблюдать увеличение метрики **PercentTimeoutError** для одной из служб хранилища. В то же время клиент может получать большое число сообщений о состоянии HTTP 500 "Время ожидания операции истекло" при операциях с хранилищем.

> [!NOTE]
> Ошибки времени ожидания могут возникать временно, когда служба хранилища выполняет балансировку нагрузки запросов, перемещая раздел на новый сервер.
>
>

Метрика **PercentTimeoutError** является сводной и состоит из следующих метрик: **ClientTimeoutError**, **AnonymousClientTimeoutError**, **SASClientTimeoutError**, **ServerTimeoutError**, **AnonymousServerTimeoutError** и **SASServerTimeoutError**.

Время ожидания сервера истекает из-за ошибок на сервере. Время ожидания клиента истекает из-за того, что при выполнении операции на сервере истекает время ожидания, установленное клиентом. Например, клиент, использующий клиентскую библиотеку хранилища, может установить время ожидания для операции с помощью свойства **ServerTimeout** класса **QueueRequestOptions**.

Ошибки времени ожидания сервера указывают на проблему со службой хранилища, которая требует дальнейшего изучения. С помощью метрик вы можете определить, не достигнуты ли предельные значения масштабируемости для службы и не связана ли проблема с пиковыми скачками трафика. Если проблема возникает периодически, она может быть вызвана балансировкой нагрузки в службе. Если проблема существует постоянно и не вызвана достижением предельных значений масштабируемости службы в приложении, вам следует обратиться в службу поддержки. В случае ошибок времени ожидания клиента необходимо определить, правильно ли задано время ожидания в клиенте, и либо изменить это значение, либо рассмотреть возможные способы повышения производительности операций в службе хранилища, например путем оптимизации запросов к таблицам или уменьшения размера сообщений.

### <a name="metrics-show-an-increase-in-percentnetworkerror"></a><a name="metrics-show-an-increase-in-PercentNetworkError"></a>Метрики показывают увеличение значения PercentNetworkError
Вы можете наблюдать увеличение метрики **PercentNetworkError** для одной из служб хранилища. Метрика **PercentNetworkError** является сводной и состоит из следующих метрик: **NetworkError**, **AnonymousNetworkError** и **SASNetworkError**. Это происходит, когда служба хранилища обнаруживает ошибку сети при выполнении клиентом запроса к хранилищу.

Наиболее распространенной причиной этой ошибки является отключение клиента, прежде чем в службе хранилища истекает время ожидания. Изучите код клиента, чтобы понять, когда и почему клиент отключается от службы хранилища. Можно также использовать Wireshark или Tcping для анализа проблем с сетевым подключением от клиента. Эти средства описываются в [Приложения].

### <a name="the-client-is-receiving-http-403-forbidden-messages"></a><a name="the-client-is-receiving-403-messages"></a>Клиент получает сообщения «HTTP 403 (запрещено)»
Если в клиентском приложении происходят ошибки HTTP 403 (Запрещено), наиболее вероятная причина заключается в использовании клиентом подписанного URL-адреса (SAS) с истекшим сроком действия при отправке запроса к хранилищу (хотя возможны и другие причины: рассинхронизация по времени, недействительные ключи и пустые заголовки). Если причина в просроченном ключе SAS, в журнале хранилища на стороне сервера не будет никаких записей об этом. В приведенной ниже таблице показан пример этой неполадки в журнале на стороне клиента, созданном клиентской библиотекой хранилища.

| Источник | Уровень детализации | Уровень детализации | Идентификатор запроса клиента | Operation Text |
| --- | --- | --- | --- | --- |
| Microsoft.Azure.Storage |Сведения |3 |85d077ab -… |Начинается выполнение операции с расположением «Основное» в режиме расположения PrimaryOnly. |
| Microsoft.Azure.Storage |Сведения |3 |85d077ab -… |Отправка синхронного запроса к <https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/Synchronous_and_Asynchronous_Requests#Synchronous_request> |
| Microsoft.Azure.Storage |Сведения |3 |85d077ab -… |Waiting for response (Ожидание ответа). |
| Microsoft.Azure.Storage |Предупреждение |2 |85d077ab -… |При ожидании ответа возникло исключение: Удаленный сервер вернул ошибку: (403) Forbidden (Удаленный сервер вернул ошибку: 403 — запрещено). |
| Microsoft.Azure.Storage |Сведения |3 |85d077ab -… |Response received. Код состояния = 403; идентификатор запроса = 9d67c64a-64ed-4b0d-9515-3b14bbcdc63d; Content-MD5 = ; ETag = . |
| Microsoft.Azure.Storage |Предупреждение |2 |85d077ab -… |Во время операции возникло исключение: Удаленный сервер вернул ошибку: (403) Forbidden (Удаленный сервер вернул ошибку: 403 — запрещено). |
| Microsoft.Azure.Storage |Сведения |3 |85d077ab -… |Проверка необходимости в повторной попытке выполнения операции. Число повторных попыток = 0; код состояния HTTP = 403; исключение = The remote server returned an error: (403) Forbidden (Удаленный сервер вернул ошибку: 403 — запрещено). |
| Microsoft.Azure.Storage |Сведения |3 |85d077ab -… |Следующим установлено расположение «Основное» в соответствием с режимом расположения. |
| Microsoft.Azure.Storage |Error |1 |85d077ab -… |Retry policy did not allow for a retry. Сбой с ошибкой The remote server returned an error: (403) Forbidden (Удаленный сервер вернул ошибку: 403 — запрещено). |

В этой ситуации вам нужно разобраться, почему срок действия маркера SAS истекает, до того как клиент отправит его серверу.

* Обычно при создании SAS для немедленного использования клиентом вам не нужно задавать время начала. Если между узлом, генерирующим SAS по текущему времени, и службой хранилища есть небольшая разница во времени, то может возникнуть ситуация, когда служба хранилища получает еще недействительный SAS.
* Не задавайте для SAS слишком короткий срок действия. Небольшая разница во времени между узлом, генерирующим SAS, и службой хранилища может привести к тому, что срок действия SAS истечет раньше, чем ожидалось.
* Проверьте, соответствует ли параметр версии в ключе SAS (например **sv=2015-04-05**) версии клиентской библиотеки хранилища, которую вы используете. Всегда используйте последнюю версию [клиентской библиотеки хранилища](https://www.nuget.org/packages/WindowsAzure.Storage/).
* Повторное создание ключей доступа к хранилищу может привести к тому, что существующие токены SAS станут недействительными. Эта проблема может возникнуть при генерации маркеров SAS с большим сроком действия для кэширования клиентскими приложениями.

Если вы генерируете маркеры SAS с помощью клиентской библиотеки хранилища, то можете легко создать действительный маркер. Но если вы используете REST API службы хранилища и создаете токены SAS вручную, внимательно прочтите статью о [делегировании доступа с помощью подписанного URL-адреса, т.е. SAS](/rest/api/storageservices/delegate-access-with-shared-access-signature).

### <a name="the-client-is-receiving-http-404-not-found-messages"></a><a name="the-client-is-receiving-404-messages"></a>Клиент получает сообщения «HTTP 404 (не найдено)»
Если клиентское приложение получает от сервера сообщение HTTP 404 (не найдено), подразумевается, что объект, который приложение пытается использовать (например, субъект, таблица, BLOB-объект, контейнер или очередь), не существует в службе хранилища. Это может быть вызвано несколькими причинами, включая перечисленные ниже.

* [Объект удален ранее клиентом или другим процессом]
* [Проблема с авторизацией подписанного URL-адреса (SAS)]
* [У кода JavaScript на стороне клиента нет разрешения на доступ к объекту]
* [Сбой сети]

#### <a name="the-client-or-another-process-previously-deleted-the-object"></a><a name="client-previously-deleted-the-object"></a>Объект удален ранее клиентом или другим процессом
В ситуациях, когда клиент пытается прочитать, обновить или удалить данные в службе хранилища, обычно легко найти в журналах на стороне сервера предыдущую операцию, которая привела к удалению нужного объекта из этой службы. По данным журнала очень часто можно увидеть, что объект удален другим пользователем или объектом. В журнале хранилища на стороне сервера есть столбцы Operation-type (Тип операции) и Requested-object-key (Ключ запрошенного объекта), по которым можно понять, когда объект был удален клиентом.

В случае, когда клиент пытается вставить объект, не всегда можно сразу понять, почему появляется сообщение HTTP 404 (не найдено), ведь речь идет о создании нового объекта. Однако если клиент создает BLOB-объект, ему требуется найти контейнер BLOB-объектов, при создании сообщения нужно найти очередь, а при добавлении строки — таблицу.

Чтобы лучше понять, когда клиент отправляет конкретные запросы к службе хранилища, обратитесь к журналу из клиентской библиотеки хранилища на стороне клиента.

В приведенном ниже журнале, сгенерированном клиентской библиотекой хранилища, показана проблема, связанная с тем, что клиент не может найти контейнер для создаваемого BLOB-объекта. Журнал содержит подробные данные о таких операциях хранилища:

| Request ID (ИД запроса) | Операция |
| --- | --- |
| 07b26a5d-... |**DeleteIfExists** для удаления контейнера BLOB-объектов. Обратите внимание, что эта операция включает в себя запрос **HEAD** , который проверяет существование контейнера. |
| e2d06d78-… |**CreateIfNotExists** для создания контейнера BLOB-объектов. Обратите внимание: эта операция включает в себя запрос **HEAD** для проверки существования контейнера. **HEAD** возвращает сообщение 404, но работа не прерывается. |
| de8b1c3c-... |**UploadFromStream** для создания BLOB-объекта. **PUT** завершается сбоем с сообщением 404. |

Записи журнала:

| Request ID (ИД запроса) | Operation Text |
| --- | --- |
| 07b26a5d-... |Отправка синхронного запроса к `https://domemaildist.blob.core.windows.net/azuremmblobcontainer`. |
| 07b26a5d-... |StringToSign = HEAD............x-ms-client-request-id:07b26a5d-....x-ms-date:Tue, 03 Jun 2014 10:33:11 GMT.x-ms-version:2014-02-14./domemaildist/azuremmblobcontainer.restype:container. |
| 07b26a5d-... |Waiting for response (Ожидание ответа). |
| 07b26a5d-... |Response received. Status code = 200, Request ID = eeead849-...Content-MD5 = , ETag =    &quot;0x8D14D2DC63D059B&quot;. |
| 07b26a5d-... |Response headers were processed successfully, proceeding with the rest of the operation (Заголовки ответа успешно обработаны, продолжается выполнение операции). |
| 07b26a5d-... |Downloading response body (Загружается тело ответа). |
| 07b26a5d-... |Operation completed successfully (Операция выполнена успешно). |
| 07b26a5d-... |Отправка синхронного запроса к `https://domemaildist.blob.core.windows.net/azuremmblobcontainer`. |
| 07b26a5d-... |StringToSign = DELETE............x-ms-client-request-id:07b26a5d-....x-ms-date:Tue, 03 Jun 2014 10:33:12    GMT.x-ms-version:2014-02-14./domemaildist/azuremmblobcontainer.restype:container. |
| 07b26a5d-... |Waiting for response (Ожидание ответа). |
| 07b26a5d-... |Response received. Status code = 202, Request ID = eeead849-...Content-MD5 = , ETag = . (Ответ получен. Код состояния = 202, ИД запроса = eeead849-...Content-MD5 = , ETag = .) |
| 07b26a5d-... |Response headers were processed successfully, proceeding with the rest of the operation (Заголовки ответа успешно обработаны, продолжается выполнение операции). |
| 07b26a5d-... |Downloading response body (Загружается тело ответа). |
| 07b26a5d-... |Operation completed successfully (Операция выполнена успешно). |
| e2d06d78-... |Отправка асинхронного запроса к `https://domemaildist.blob.core.windows.net/azuremmblobcontainer`.</td> |
| e2d06d78-... |StringToSign = HEAD............x-ms-client-request-id:e2d06d78-....x-ms-date:Tue, 03 Jun 2014 10:33:12 GMT.x-ms-version:2014-02-14./domemaildist/azuremmblobcontainer.restype:container. |
| e2d06d78-... |Waiting for response (Ожидание ответа). |
| de8b1c3c-... |Отправка синхронного запроса к `https://domemaildist.blob.core.windows.net/azuremmblobcontainer/blobCreated.txt`. |
| de8b1c3c-... |StringToSign = PUT...64.qCmF+TQLPhq/YYK50mP9ZQ==........x-ms-blob-type:BlockBlob.x-ms-client-request-id:de8b1c3c-....x-ms-date:Tue, 03 Jun 2014 10:33:12 GMT.x-ms-version:2014-02-14./domemaildist/azuremmblobcontainer/blobCreated.txt. |
| de8b1c3c-... |Preparing to write request data (Подготовка к записи данных запроса). |
| e2d06d78-... |При ожидании ответа возникло исключение: Удаленный сервер вернул ошибку: (404) Not Found (Удаленный сервер вернул ошибку: 404 — не найдено). |
| e2d06d78-... |Response received. Status code = 404, Request ID = 353ae3bc-..., Content-MD5 = , ETag = . (Ответ получен. Код состояния = 404, ИД запроса = 353ae3bc-..., Content-MD5 = , ETag = .) |
| e2d06d78-... |Response headers were processed successfully, proceeding with the rest of the operation (Заголовки ответа успешно обработаны, продолжается выполнение операции). |
| e2d06d78-... |Downloading response body (Загружается тело ответа). |
| e2d06d78-... |Operation completed successfully (Операция выполнена успешно). |
| e2d06d78-... |Отправка асинхронного запроса к `https://domemaildist.blob.core.windows.net/azuremmblobcontainer`. |
| e2d06d78-... |StringToSign = PUT...0.........x-ms-client-request-id:e2d06d78-....x-ms-date:Tue, 03 Jun 2014 10:33:12 GMT.x-ms-version:2014-02-14./domemaildist/azuremmblobcontainer.restype:container. |
| e2d06d78-... |Waiting for response (Ожидание ответа). |
| de8b1c3c-... |Writing request data (Запись данных запроса). |
| de8b1c3c-... |Waiting for response (Ожидание ответа). |
| e2d06d78-... |При ожидании ответа возникло исключение: Удаленный сервер вернул ошибку: (409) Conflict (Удаленный сервер вернул ошибку: 409 — конфликт). |
| e2d06d78-... |Response received. Status code = 409, Request ID = c27da20e-..., Content-MD5 = , ETag = . (Ответ получен. Код состояния = 409, ИД запроса = c27da20e-..., Content-MD5 = , ETag = .) |
| e2d06d78-... |Downloading error response body (Загружается тело ответа с ошибкой). |
| de8b1c3c-... |При ожидании ответа возникло исключение: Удаленный сервер вернул ошибку: (404) Not Found (Удаленный сервер вернул ошибку: 404 — не найдено). |
| de8b1c3c-... |Response received. Status code = 404, Request ID = 0eaeab3e-..., Content-MD5 = , ETag = . (Ответ получен. Код состояния = 404, ИД запроса = 0eaeab3e-..., Content-MD5 = , ETag = .) |
| de8b1c3c-... |Во время операции возникло исключение: Удаленный сервер вернул ошибку: (404) Not Found (Удаленный сервер вернул ошибку: 404 — не найдено). |
| de8b1c3c-... |Retry policy did not allow for a retry. Сбой с ошибкой The remote server returned an error: (404) Not Found (Удаленный сервер вернул ошибку: 404 — не найдено). |
| e2d06d78-... |Retry policy did not allow for a retry. Сбой с ошибкой The remote server returned an error: (409) Conflict (Удаленный сервер вернул ошибку: 409 — конфликт). |

В этом примере из записей журнала видно, что клиент чередует запросы от метода **CreateIfNotExists** (идентификатор запроса — e2d06d78…) с запросами от метода **UploadFromStream** (de8b1c3c-...). Это происходит потому, что клиентское приложение вызывает эти методы асинхронно. Измените код с асинхронными вызовами в клиенте таким образом, чтобы он создавал контейнер до того, как попытается передать какие-либо данные в большой двоичный объект в этом контейнере. В идеале нужно создавать все контейнеры заранее.

#### <a name="a-shared-access-signature-sas-authorization-issue"></a><a name="SAS-authorization-issue"></a>Проблема с авторизацией подписанного URL-адреса (SAS)
Если клиентское приложение пытается использовать ключ SAS, который не содержит необходимых разрешений для операции, служба хранилища возвращает клиенту сообщение HTTP 404 (не найдено). В то же время вы увидите в метриках ненулевое значение **SASAuthorizationError** (Ошибка авторизации SAS).

В этой таблице показан пример сообщения журнала на стороне сервера из файла журнала хранилища:

| Имя | Значение |
| --- | --- |
| Request start time (Время начала запроса) | 2014-05-30T06:17:48.4473697Z |
| Operation type (Тип операции)     | GetBlobProperties            |
| Request status (Состояние запроса)     | SASAuthorizationError        |
| HTTP status code (Код состояния HTTP)   | 404                            |
| Authentication type (Тип проверки подлинности)| SAS                          |
| Service type (Тип службы)       | BLOB-объект                         |
| Request URL (URL-адрес запроса)         | `https://domemaildist.blob.core.windows.net/azureimblobcontainer/blobCreatedViaSAS.txt` |
| &nbsp;                 |   ?sv=2014-02-14&sr=c&si=mypolicy&sig=XXXXX&;api-version=2014-02-14 |
| Request ID header (Заголовок идентификатора запроса)  | a1f348d5-8032-4912-93ef-b393e5252a3b |
| Идентификатор запроса клиента  | 2d064953-8436-4ee0-aa0c-65cb874f7929 |


Найдите причину того, что клиентское приложение пытается выполнить операцию, для которой ему не предоставлены разрешения.

#### <a name="client-side-javascript-code-does-not-have-permission-to-access-the-object"></a><a name="JavaScript-code-does-not-have-permission"></a>У кода JavaScript на стороне клиента нет разрешения на доступ к объекту
Если вы используете клиент JavaScript и служба хранилища возвращает сообщения HTTP 404, проверьте в браузере, нет ли следующих ошибок JavaScript:

```
SEC7120: Origin http://localhost:56309 not found in Access-Control-Allow-Origin header.
SCRIPT7002: XMLHttpRequest: Network Error 0x80070005, Access is denied.
```

> [!NOTE]
> При диагностике и устранении неполадок на стороне клиента JavaScript вы можете воспользоваться средствами разработчика F12 в Internet Explorer для трассировки сообщений, которыми обмениваются браузер и служба хранилища.
>
>

Эти ошибки появляются из-за того, что браузер применяет ограничение безопасности по [принципу одинакового источника](https://www.w3.org/Security/wiki/Same_Origin_Policy), в связи с чем веб-страница не может вызвать API ни из каких других доменов, кроме собственного.

Чтобы решить эту проблему JavaScript обходным путем, вы можете настроить для службы хранилища, к которой обращается клиент, общий доступ к ресурсам независимо от источника (CORS). Дополнительные сведения см. в статье [Cross-Origin Resource Sharing (CORS) Support for Azure Storage Services](/rest/api/storageservices/Cross-Origin-Resource-Sharing--CORS--Support-for-the-Azure-Storage-Services) (Поддержка общего доступа к ресурсам независимо от источника (CORS) для служб хранилища Azure).

В этом примере кода показано, как настроить службу BLOB-объектов, чтобы разрешить работу приложения JavaScript в домене Contoso для получения доступа к хранящемуся в ней BLOB-объекту:

# <a name="net-v12"></a>[.NET (версии 12)](#tab/dotnet)

:::code language="csharp" source="~/azure-storage-snippets/blobs/howto/dotnet/dotnet-v12/Monitoring.cs" id="Snippet_ConfigureCORS":::

# <a name="net-v11"></a>[.NET (версии 11)](#tab/dotnet11)

```csharp
CloudBlobClient client = new CloudBlobClient(blobEndpoint, new StorageCredentials(accountName, accountKey));
// Set the service properties.
ServiceProperties sp = client.GetServiceProperties();
sp.DefaultServiceVersion = "2013-08-15";
CorsRule cr = new CorsRule();
cr.AllowedHeaders.Add("*");
cr.AllowedMethods = CorsHttpMethods.Get | CorsHttpMethods.Put;
cr.AllowedOrigins.Add("http://www.contoso.com");
cr.ExposedHeaders.Add("x-ms-*");
cr.MaxAgeInSeconds = 5;
sp.Cors.CorsRules.Clear();
sp.Cors.CorsRules.Add(cr);
client.SetServiceProperties(sp);
```

---

#### <a name="network-failure"></a><a name="network-failure"></a>Сбой сети
В некоторых обстоятельствах потеря сетевых пакетов может привести к тому, что служба хранилища будет возвращать клиенту сообщения HTTP 404. Например, когда клиентское приложение удаляет субъект из службы таблиц, это вызывает исключение хранилища и вы увидите сообщение о состоянии HTTP 404 (не найдено) от службы таблиц. Если вы посмотрите на таблицу в службе таблиц, то поймете, что субъект удален в соответствии с запросом.

Данные об исключении на клиенте содержат идентификатор запроса (7e84f12d…), присвоенный запросу службой таблиц. С помощью этой информации вы можете найти подробные данные о запросе в журналах хранилища на стороне сервера. Для этого нужно выполнить поиск в столбце **request-id-header** в файле журнала. Кроме того, можно проверить метрики для того, чтобы выяснить, когда возникают такие ошибки, а затем выполнить поиск в файлах журналов по зафиксированному в метриках времени. Эта запись журнала указывает на то, что удаление не выполнено и возвращено сообщение о состоянии HTTP (404) Client Other Error (Другая ошибка клиента). Аналогичная запись журнала также содержит идентификатор запроса, сгенерированный клиентом, в столбце **client-request-id** (813ea74f…).

В журнале на стороне сервера есть еще одна запись с тем же значением **client-request-id** (813ea74f…), которая соответствует успешной операции удаления того же субъекта по запросу от того же клиента. Успешная операция удаления была выполнена непосредственно перед тем, как запрос на удаление завершился с ошибкой.

Наиболее вероятная причина этого сценария заключается в том, что клиент отправил запрос на удаление сущности в службу таблиц, которая завершилась успешно, но не получила подтверждения от сервера (возможно, из-за временной проблемы с сетью). Затем клиент автоматически повторил операцию, используя то же значение **client-request-id**, и она завершилась с ошибкой, так как субъект уже был удален.

Если эта проблема возникает часто, следует выяснить, почему клиент не может получить подтверждения от службы таблиц. Если проблема не постоянна, вам нужно обработать ошибку «HTTP (404) — не найдено» и внести ее в журнал клиента, но позволить клиенту продолжить работу.

### <a name="the-client-is-receiving-http-409-conflict-messages"></a><a name="the-client-is-receiving-409-messages"></a>Клиент получает сообщения HTTP 409 (конфликт)
В следующей таблице приведена выдержка из журнала на стороне сервера для двух операций клиента: **DeleteIfExists**, за которой сразу следует **CreateIfNotExists** с тем же именем контейнера больших двоичных объектов. Каждая клиентская операция приводит к отправке на сервер двух запросов: сначала отправляется запрос **GetContainerProperties** для проверки существования контейнера, а затем — **DeleteContainer** или **CreateContainer**.

| Отметка времени | Операция | Результат | Имя контейнера | Идентификатор запроса клиента |
| --- | --- | --- | --- | --- |
| 05:10:13.7167225 |GetContainerProperties |200 |mmcont |c9f52c89-… |
| 05:10:13.8167325 |DeleteContainer |202 |mmcont |c9f52c89-… |
| 05:10:13.8987407 |GetContainerProperties |404 |mmcont |bc881924-… |
| 5:10:14.2147723 |CreateContainer |409 |mmcont |bc881924-… |

Код клиентского приложения удаляет и сразу же снова создает контейнер BLOB-объектов с тем же именем: метод **CreateIfNotExists** (идентификатор запроса клиента bc881924-…) завершается с ошибкой HTTP 409 (конфликт). Когда клиент удаляет контейнер BLOB-объектов, таблицу или очередь, имя удаленного элемента становится снова доступным через небольшой промежуток времени.

Если операции удаления и повторного создания выполняются часто, то клиентское приложение должно использовать уникальные имена при создании каждого контейнера.

### <a name="metrics-show-low-percentsuccess-or-analytics-log-entries-have-operations-with-transaction-status-of-clientothererrors"></a><a name="metrics-show-low-percent-success"></a>Метрики содержат низкие значения PercentSuccess, или в записях журналов аналитики присутствуют операции с состоянием транзакции ClientOtherErrors
В метрике **PercentSuccess** (Процент удачных завершений) фиксируется доля успешно завершенных операций с учетом кода состояния HTTP. Операции с кодом состояния 2XX относятся к успешным, а с кодом 3XX, 4XX или 5XX — к неудачным и приводят к уменьшению значения метрики **PercentSuccess**. В файлах журналов хранилища на стороне сервера такие операции отображаются с состоянием транзакции **ClientOtherErrors**(Другие ошибки клиента).

Важно отметить, что эти операции успешно выполнены и поэтому не влияют на другие метрики, например доступность. Вот несколько примеров операций, которые при успешном выполнении могут сопровождаться кодами состояния HTTP, свидетельствующими о неудаче:

* **ResourceNotFound** (Not Found 404) (Ресурс не найден, не найдено 404), например, после запроса GET к несуществующему BLOB-объекту;
* **ResourceAlreadyExists** (Conflict 409) (Ресурс уже существует, конфликт 409), например после операции **CreateIfNotExist**, если ресурс уже существует.
* **ConditionNotMet** (Not Modified 304) (Условие не выполнено, не изменено 304), например после условной операции, когда клиент отправляет значение **ETag** и заголовок HTTP **If-None-Match**, чтобы запросить изображение только в том случае, если оно было изменено после последней операции.

Полный список кодов ошибок REST API, возвращаемых службами хранилища, см. на странице [Общие коды ошибок API-интерфейса REST](/rest/api/storageservices/Common-REST-API-Error-Codes).

### <a name="capacity-metrics-show-an-unexpected-increase-in-storage-capacity-usage"></a><a name="capacity-metrics-show-an-unexpected-increase"></a>Метрики объема показывают неожиданное увеличение использования объема хранилища
Если наблюдаются внезапные, неожиданные изменения используемой емкости в учетной записи хранения, то для установления причины сначала можно проверить метрики доступности. Например, увеличение числа сбоев при выполнении запросов на удаление может приводить к увеличению используемого объема хранилища BLOB-объектов, так как связанные с приложением операции очистки, которые должны освобождать пространство, могут работать неправильно (например, из-за того что срок действия токенов SAS, используемых для освобождения пространства, истек).

### <a name="your-issue-arises-from-using-the-storage-emulator-for-development-or-test"></a><a name="your-issue-arises-from-using-the-storage-emulator"></a>Проблема связана с использованием эмулятора хранения на этапе разработки или тестирования
Эмулятор хранения, как правило, используется во время разработки и тестирования, избавляя от необходимости в учетной записи хранения Azure. Вот наиболее распространенные проблемы, которые могут возникать при использовании эмулятора хранения:

* [Функция X не работает в эмуляторе хранения]
* [При использовании эмулятора хранения происходит ошибка «Неправильный формат значения одного из заголовков HTTP»]
* [Для запуска эмулятора хранения требуются права администратора]

#### <a name="feature-x-is-not-working-in-the-storage-emulator"></a><a name="feature-X-is-not-working"></a>Функция X не работает в эмуляторе хранения
Эмулятор хранения поддерживает не все функции служб хранилища Azure, например файловой службы. Дополнительные сведения см. в статье [Использование эмулятора хранения Azure для разработки и тестирования](storage-use-emulator.md).

Если вам нужны функции, не поддерживаемые эмулятором хранения, используйте службу хранилища Azure в облаке.

#### <a name="error-the-value-for-one-of-the-http-headers-is-not-in-the-correct-format-when-using-the-storage-emulator"></a><a name="error-HTTP-header-not-correct-format"></a>При использовании эмулятора хранения происходит ошибка «Неправильный формат значения одного из заголовков HTTP»
При тестировании приложения, использующего клиентскую библиотеку хранилища в локальном эмуляторе хранения, вызовы методов, таких как **CreateIfNotExists**, могут завершаться сбоем с сообщением об ошибке The value for one of the HTTP headers is not in the correct format (Значение одного из заголовков HTTP имеет неправильный формат). Это означает, что версия эмулятора хранения не поддерживает используемую версию клиентской библиотеки хранилища. Клиентская библиотека хранилища добавляет заголовок **x-ms-version** ко всем выполняемым ею запросам. Если эмулятор хранения не распознаёт значение в заголовке **x-ms-version** , он отклоняет запрос.

Для просмотра значения, отправляемого в **заголовке x-ms-version** , можно воспользоваться журналами клиентской библиотеки хранилища. Значение **заголовка x-ms-version** также можно просмотреть, если вы используете Fiddler для трассировки запросов от клиентского приложения.

Такая ситуация обычно возникает, если вы устанавливаете и используете последнюю версию клиентской библиотеки хранилища, не обновляя эмулятор хранения. Вам следует установить последнюю версию эмулятора хранения или использовать вместо него облачное хранилище для разработки и тестирования.

#### <a name="running-the-storage-emulator-requires-administrative-privileges"></a><a name="storage-emulator-requires-administrative-privileges"></a>Для запуска эмулятора хранения требуются права администратора
При запуске эмулятора хранения появляется запрос на ввод учетных данных администратора. Это происходит только при первоначальной инициализации эмулятора хранения. После этого для повторного запуска права администратора не требуются.

Дополнительные сведения см. в статье [Использование эмулятора хранения Azure для разработки и тестирования](storage-use-emulator.md). Чтобы инициализировать эмулятор хранения в Visual Studio, вам также потребуются права администратора.

### <a name="you-are-encountering-problems-installing-the-azure-sdk-for-net"></a><a name="you-are-encountering-problems-installing-the-Windows-Azure-SDK"></a>Возникают проблемы при установке пакета SDK для Azure для .NET
При попытке установить пакет SDK не удается установить эмулятор хранения на локальном компьютере. В журнале установки содержится одно из следующих сообщений:

* CAQuietExec:  Ошибка: Unable to access SQL instance (Не удалось получить доступ к экземпляру SQL).
* CAQuietExec:  Ошибка: Unable to create database (Не удалось создать базу данных).

Причина заключается в проблемах с существующей установкой LocalDB. По умолчанию эмулятор хранения использует базу данных LocalDB для хранения данных при эмуляции служб хранилища Azure. Вы можете переустановить экземпляр LocalDB, прежде чем пытаться установить пакет SDK, выполнив указанные ниже команды в окне командной строки.

```
sqllocaldb stop v11.0
sqllocaldb delete v11.0
delete %USERPROFILE%\WAStorageEmulatorDb3*.*
sqllocaldb create v11.0
```

Команда **delete** удаляет старые файлы базы данных, оставшиеся от предыдущих установок эмулятора хранения.

### <a name="you-have-a-different-issue-with-a-storage-service"></a><a name="you-have-a-different-issue-with-a-storage-service"></a>Возникла другая проблема со службой хранилища
Если в предыдущих разделах не описывается возникающая у вас проблема со службой хранилища, используйте следующий подход к диагностике и устранению неполадок.

* Проверьте метрики на наличие отклонений от ожидаемого поведения. На основе метрик можно определить, является ли неполадка временной или постоянной и какие операции с хранилищем она затрагивает.
* Значения метрик могут помочь в поиске более подробной информации о возникающих ошибках в журналах на стороне сервера. Эта информация может помочь в диагностировании и устранении проблемы.
* Если сведения в журналах на стороне сервера недостаточно для успешного устранения проблемы, можно использовать журналы клиентской библиотеки хранилища для изучения поведения клиентского приложения и таких средств, как Fiddler, Wireshark для изучения сети.

Дополнительные сведения об использовании Fiddler см. в [Приложение 1. Отслеживание HTTP- и HTTPS-трафика с помощью Fiddler].

Дополнительные сведения об использовании Wireshark см. в [Приложение 2. Отслеживание сетевого трафика с помощью Wireshark].

## <a name="appendices"></a><a name="appendices"></a>Приложения
В приложениях описывается ряд средств, которые могут оказаться полезными при диагностике и устранении неполадок службы хранилища Azure (и других служб). Эти средства не входят в состав службы хранилища Azure, а некоторые из них предоставляются сторонними разработчиками. В связи с этим на средства, рассматриваемые в этих приложениях, не распространяются соглашения о поддержке Microsoft Azure или службы хранилища Azure. В процессе оценки следует рассмотреть варианты лицензирования и поддержки, предоставляемые поставщиками этих средств.

### <a name="appendix-1-using-fiddler-to-capture-http-and-https-traffic"></a><a name="appendix-1"></a>Приложение 1. Отслеживание HTTP- и HTTPS-трафика с помощью Fiddler
[Fiddler](https://www.telerik.com/fiddler) — это полезное средство для анализа трафика HTTP и HTTPS между клиентским приложением и используемой службой хранилища Azure.

> [!NOTE]
> Средство Fiddler может декодировать трафик HTTPS. Внимательно ознакомьтесь с документацией Fiddler, чтобы понять, как это осуществляется и какие последствия может иметь для безопасности.
>
>

В этом приложении приводится краткое пошаговое руководство по настройке средства Fiddler для захвата трафика между локальным компьютером, на котором установлено средство, и службами хранилища Azure.

После запуска средства Fiddler оно начинает захват трафика HTTP и HTTPS на локальном компьютере. Вот некоторые полезные команды для управления Fiddler:

* Остановка и запуск захвата трафика. В главном меню выберите пункт **Файл**, а затем щелкните **Захват трафика**, чтобы включить или отключить захват.
* Сохранение захваченных данных трафика. В главном меню выберите пункт **Файл**, щелкните **Сохранить** и **Все сеансы**. Так вы можете сохранить трафик в файле архива сеанса. Позже вы можете загрузить архив сеанса для анализа или отправить его в службу поддержки Майкрософт по запросу.

Чтобы ограничить объем трафика, захватываемого средством Fiddler, можно использовать фильтры, которые настраиваются на вкладке **Filters** (Фильтры). На снимке экрана ниже показан фильтр, с помощью которого захватывается только трафик, передаваемый в конечную точку хранилища **contosoemaildist.table.core.windows.net** .

![Снимок экрана, на котором показан фильтр, который фиксирует только трафик, отправленный в конечную точку хранилища contosoemaildist.table.core.windows.net.][5]

### <a name="appendix-2-using-wireshark-to-capture-network-traffic"></a><a name="appendix-2"></a>Приложение 2. Отслеживание сетевого трафика с помощью Wireshark
[Wireshark](https://www.wireshark.org/) — это анализатор сетевых протоколов, который позволяет просматривать подробную информацию о пакетах для широкого спектра сетевых протоколов.

Ниже приведена процедура получения подробной информации о пакетах для трафика, отправляемого с локального компьютера, на котором установлено средство Wireshark, в службу таблиц в учетной записи хранения Azure.

1. Запустите Wireshark на локальном компьютере.
2. В разделе **Start** (Запуск) выберите локальный сетевой интерфейс или интерфейсы, подключенные к Интернету.
3. Щелкните **Capture Options**(Параметры захвата).
4. В текстовом поле **Capture Filter** (Фильтр захвата) добавьте фильтр. Например, при использовании фильтра **host contosoemaildist.table.core.windows.net** Wireshark будет захватывать только пакеты, отправляемые в конечную точку службы таблиц в учетной записи хранения **contosoemaildist** или из нее. Ознакомьтесь с [полным списком фильтров захвата](https://wiki.wireshark.org/CaptureFilters).

   ![Снимок экрана, показывающий, как добавить фильтр в текстовое поле фильтра записи.][6]
5. Нажмите **Запуск**. Средство Wireshark будет захватывать все пакеты, отправляемые в конечную точку службы таблиц или из нее в процессе работы клиентского приложения на локальном компьютере.
6. По завершении в главном меню выберите пункт **Захват**, а затем пункт **Остановить**.
7. Чтобы сохранить полученные данные в файл захвата Wireshark, в главном меню выберите пункт **Файл**, а затем пункт **Сохранить**.

Обнаруженные ошибки будут выделены в окне со **списком пакетов** WireShark. Вы также можете просмотреть сводку ошибок и предупреждений в окне **Расширенная информация** (в меню **Анализ** выберите пункт **Expert Info**).

![Снимок экрана, на котором отображается окно сведений экспертов, где можно просмотреть сводку по ошибкам и предупреждениям.][7]

Кроме того, вы можете просмотреть данные TCP так, как они видны прикладному уровню. Для этого щелкните данные TCP правой кнопкой мыши и выберите пункт **Отслеживать поток TCP**. Это полезно в том случае, если дамп был получен без использования фильтра захвата. Дополнительные сведения см. в разделе [Following TCP Streams](https://www.wireshark.org/docs/wsug_html_chunked/ChAdvFollowTCPSection.html) (Отслеживание потоков TCP).

![Снимок экрана, показывающий, как просмотреть данные TCP по мере его отображения на уровне приложения.][8]

> [!NOTE]
> Дополнительную информацию об использовании Wireshark см. в [руководстве пользователя Wireshark](https://www.wireshark.org/docs/wsug_html_chunked).
>
>

### <a name="appendix-4-using-excel-to-view-metrics-and-log-data"></a><a name="appendix-4"></a>Приложение 4. Просмотр метрик и данных журналов с помощью Excel
Многие средства позволяют загружать данные метрик хранилища из хранилища таблиц Azure в формате с разделителями. Данные в таком формате можно легко загрузить в Excel для просмотра и анализа. Данные журнала хранилища из хранилища BLOB-объектов Azure уже находятся в формате с разделителями, который можно загрузить в Excel. Однако вам нужно добавить соответствующие заголовки столбцов согласно информации в статьях [Формат журналов аналитики хранилища](/rest/api/storageservices/Storage-Analytics-Log-Format) и [Схема таблицы метрик аналитики хранилища](/rest/api/storageservices/Storage-Analytics-Metrics-Table-Schema).

Чтобы импортировать данные журналов хранилища в Excel после их загрузки из хранилища BLOB-объектов, выполните указанные ниже действия.

* В меню **Данные** выберите пункт **Из текста**.
* Выберите файл журнала, который нужно просмотреть, и нажмите кнопку **Импорт**.
* На первом шаге **мастера импорта текста** выберите параметр **С разделителями**.

На втором шаге **мастера импорта текста** выберите **точку с запятой** в качестве единственного разделителя и двойные кавычки в качестве **ограничителя строк**. Нажмите кнопку **Готово** и выберите место размещения данных в книге.

### <a name="appendix-5-monitoring-with-application-insights-for-azure-devops"></a><a name="appendix-5"></a>Приложение 5. Мониторинг с использованием Application Insights для Azure DevOps
Вы также можете использовать компонент Application Insights для Azure DevOps при мониторинге производительности и доступности. Это средство предоставляет указанные ниже возможности.

* Проверка того, что веб-служба доступна и отвечает на запросы. Вне зависимости от того, является ли ваше приложение, использующее веб-службу, приложением для веб-сайта или для устройства, этот инструмент может каждые несколько минут тестировать ваш URL-адрес из разных мест мира и сообщать о возникших проблемах.
* Быстрая диагностика любых проблем с производительностью или исключений в веб-службе. Определяйте, не исчерпаны ли ресурсы ЦП и другие ресурсы, получайте данные трассировки стека исключений и легко выполняйте поиск по журналам трассировки. Если производительность приложения опустится ниже допустимого предела, мы можем оповестить вас по электронной почте. Вы можете отслеживать веб-службы .NET и Java.

Дополнительные сведения см. в статье [Что такое Azure Application Insights?](../../azure-monitor/app/app-insights-overview.md)

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения об аналитике в службе хранилища Azure см. в следующих статьях:

* [Мониторинг учетной записи хранения на портале Azure](storage-monitor-storage-account.md)
* [Аналитика службы хранилища](storage-analytics.md)
* [Метрики аналитики службы хранилища](storage-analytics-metrics.md)
* [Схема таблицы метрик аналитики службы хранилища](/rest/api/storageservices/storage-analytics-metrics-table-schema)
* [Журналы аналитики службы хранилища](storage-analytics-logging.md)
* [Формат журналов аналитики службы хранилища](/rest/api/storageservices/storage-analytics-log-format)

<!--Anchors-->
[Введение]: #introduction
[Структура руководства]: #how-this-guide-is-organized

[Мониторинг службы хранилища]: #monitoring-your-storage-service
[Мониторинг работоспособности службы]: #monitoring-service-health
[Мониторинг мощностей]: #monitoring-capacity
[Мониторинг доступности]: #monitoring-availability
[Мониторинг производительности]: #monitoring-performance

[Диагностика неполадок с хранилищем]: #diagnosing-storage-issues
[Проблемы с работоспособностью службы]: #service-health-issues
[Проблемы с производительностью]: #performance-issues
[Диагностика ошибок]: #diagnosing-errors
[Проблемы с эмулятором хранения]: #storage-emulator-issues
[Инструменты для ведения журналов хранилища]: #storage-logging-tools
[Использование инструментов для ведения сетевого журнала]: #using-network-logging-tools

[Комплексная трассировка]: #end-to-end-tracing
[Сопоставление данных журналов]: #correlating-log-data
[Идентификатор запроса клиента]: #client-request-id
[Идентификатор запроса сервера]: #server-request-id
[Метки времени]: #timestamps

[Рекомендации по устранению неполадок]: #troubleshooting-guidance
[Метрики содержат высокие значения AverageE2ELatency и низкие значения AverageServerLatency]: #metrics-show-high-AverageE2ELatency-and-low-AverageServerLatency
[Метрики содержат низкие значения AverageE2ELatency и низкие значения AverageServerLatency, но клиент сталкивается с большой задержкой]: #metrics-show-low-AverageE2ELatency-and-low-AverageServerLatency
[Метрики содержат высокие значения AverageServerLatency]: #metrics-show-high-AverageServerLatency
[При доставке сообщений в очередь возникают неожиданные задержки]: #you-are-experiencing-unexpected-delays-in-message-delivery

[Метрики показывают увеличение значения PercentThrottlingError]: #metrics-show-an-increase-in-PercentThrottlingError
[Временное увеличение метрики PercentThrottlingError]: #transient-increase-in-PercentThrottlingError
[Постоянное увеличение метрики PercentThrottlingError]: #permanent-increase-in-PercentThrottlingError
[Метрики показывают увеличение значения PercentTimeoutError]: #metrics-show-an-increase-in-PercentTimeoutError
[Метрики показывают увеличение значения PercentNetworkError]: #metrics-show-an-increase-in-PercentNetworkError

[Клиент получает сообщения «HTTP 403 (запрещено)»]: #the-client-is-receiving-403-messages
[Клиент получает сообщения «HTTP 404 (не найдено)»]: #the-client-is-receiving-404-messages
[Объект удален ранее клиентом или другим процессом]: #client-previously-deleted-the-object
[Проблема с авторизацией подписанного URL-адреса (SAS)]: #SAS-authorization-issue
[У кода JavaScript на стороне клиента нет разрешения на доступ к объекту]: #JavaScript-code-does-not-have-permission
[Сбой сети]: #network-failure
[Клиент получает сообщения HTTP 409 (конфликт)]: #the-client-is-receiving-409-messages

[Метрики содержат низкие значения PercentSuccess, или в записях журналов аналитики присутствуют операции с состоянием транзакции ClientOtherErrors]: #metrics-show-low-percent-success
[Метрики объема показывают неожиданное увеличение использования объема хранилища]: #capacity-metrics-show-an-unexpected-increase
[Проблема связана с использованием эмулятора хранения на этапе разработки или тестирования]: #your-issue-arises-from-using-the-storage-emulator
[Функция X не работает в эмуляторе хранения]: #feature-X-is-not-working
[При использовании эмулятора хранения происходит ошибка «Неправильный формат значения одного из заголовков HTTP»]: #error-HTTP-header-not-correct-format
[Для запуска эмулятора хранения требуются права администратора]: #storage-emulator-requires-administrative-privileges
[Возникают проблемы при установке пакета SDK для Azure для .NET]: #you-are-encountering-problems-installing-the-Windows-Azure-SDK
[Возникла другая проблема со службой хранилища]: #you-have-a-different-issue-with-a-storage-service

[Приложения]: #appendices
[Приложение 1. Отслеживание HTTP- и HTTPS-трафика с помощью Fiddler]: #appendix-1
[Приложение 2. Отслеживание сетевого трафика с помощью Wireshark]: #appendix-2
[Приложение 4. Просмотр метрик и данных журналов с помощью Excel]: #appendix-4
[Приложение 5. Мониторинг с использованием Application Insights для Azure DevOps]: #appendix-5

<!--Image references-->
[1]: ./media/storage-monitoring-diagnosing-troubleshooting/overview.png
[3]: ./media/storage-monitoring-diagnosing-troubleshooting/hour-minute-metrics.png
[4]: ./media/storage-monitoring-diagnosing-troubleshooting/high-e2e-latency.png
[5]: ./media/storage-monitoring-diagnosing-troubleshooting/fiddler-screenshot.png
[6]: ./media/storage-monitoring-diagnosing-troubleshooting/wireshark-screenshot-1.png
[7]: ./media/storage-monitoring-diagnosing-troubleshooting/wireshark-screenshot-2.png
[8]: ./media/storage-monitoring-diagnosing-troubleshooting/wireshark-screenshot-3.png
[9]: ./media/storage-monitoring-diagnosing-troubleshooting/mma-screenshot-1.png
[10]: ./media/storage-monitoring-diagnosing-troubleshooting/mma-screenshot-2.png
