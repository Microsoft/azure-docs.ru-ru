---
title: Использование частных конечных точек
titleSuffix: Azure Storage
description: Общие сведения о частных конечных точках для безопасного доступа к учетным записям хранения из виртуальных сетей.
services: storage
author: normesta
ms.service: storage
ms.topic: conceptual
ms.date: 03/12/2020
ms.author: normesta
ms.reviewer: santoshc
ms.subservice: common
ms.openlocfilehash: 13e274a0d43ba4399e039d1280aa5ada3c94afe5
ms.sourcegitcommit: 27cd3e515fee7821807c03e64ce8ac2dd2dd82d2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/16/2021
ms.locfileid: "103601480"
---
# <a name="use-private-endpoints-for-azure-storage"></a>Использование частных конечных точек для службы хранилища Azure

Вы можете использовать [частные конечные точки](../../private-link/private-endpoint-overview.md) для учетных записей хранения Azure, чтобы разрешить клиентам в виртуальной сети (VNet) безопасный доступ к данным по [частной ссылке](../../private-link/private-link-overview.md). Частная конечная точка использует IP-адрес из адресного пространства виртуальной сети для вашей службы учетной записи хранения. Сетевой трафик между клиентами в виртуальной сети и учетной записью хранения проходит по виртуальной сети и частной ссылке на магистральную сеть Майкрософт, что устраняет уязвимость в общедоступном Интернете.

Использование частных конечных точек для учетной записи хранения позволяет выполнять следующие задачи:

- Защитите учетную запись хранения, настроив брандмауэр хранилища для блокировки всех подключений в общедоступной конечной точке для службы хранилища.
- Увеличьте уровень безопасности для виртуальной сети, позволяя блокировать утечка данных из сети.
- Безопасное подключение к учетным записям хранения из локальных сетей, подключающихся к виртуальной сети с помощью [VPN](../../vpn-gateway/vpn-gateway-about-vpngateways.md) или [которыми](../../expressroute/expressroute-locations.md) с частными пиринга.

## <a name="conceptual-overview"></a>Общие сведения

![Общие сведения о частных конечных точках для службы хранилища Azure](media/storage-private-endpoints/storage-private-endpoints-overview.jpg)

Частная конечная точка — это специальный сетевой интерфейс для службы Azure в [виртуальной сети](../../virtual-network/virtual-networks-overview.md) (VNet). При создании частной конечной точки для учетной записи хранения обеспечивается безопасное подключение между клиентами в виртуальной сети и хранилищем. Частной конечной точке назначается IP-адрес из диапазона IP-адресов виртуальной сети. Соединение между частной конечной точкой и службой хранилища использует защищенную закрытую ссылку.

Приложения в виртуальной сети могут легко подключаться к службе хранилища через закрытую конечную точку, **используя те же строки подключения и механизмы авторизации, которые используются в противном случае**. Частные конечные точки можно использовать со всеми протоколами, поддерживаемыми учетной записью хранения, включая остальные и SMB.

Частные конечные точки можно создавать в подсетях, использующих [конечные точки служб](../../virtual-network/virtual-network-service-endpoints-overview.md). Таким образом клиенты в подсети могут подключаться к одной учетной записи хранения с помощью частной конечной точки, а также использовать конечные точки службы для доступа к другим пользователям.

Когда вы создаете в виртуальной сети частную конечную точку для службы хранилища, соответствующий запрос на предоставление согласия отправляется владельцу учетной записи хранения. Если пользователь, запрашивающий создание частной конечной точки, также является владельцем учетной записи хранения, этот запрос на согласие автоматически утверждается.

Владельцы учетных записей хранения могут управлять запросами на согласие и закрытыми конечными точками через вкладку "*частные конечные точки*" для учетной записи хранения в [портал Azure](https://portal.azure.com).

> [!TIP]
> Если вы хотите ограничить доступ к учетной записи хранения только через закрытую конечную точку, настройте брандмауэр службы хранилища для запрета или управления доступом через общедоступную конечную точку.

Вы можете защитить учетную запись хранения, чтобы принимать подключения только из виртуальной сети, [настроив брандмауэр хранилища](storage-network-security.md#change-the-default-network-access-rule) на запрет доступа через общедоступную конечную точку по умолчанию. Правило брандмауэра не требуется, чтобы разрешить трафик из виртуальной сети, имеющей закрытую конечную точку, так как брандмауэр хранилища управляет доступом только через общедоступную конечную точку. Вместо этого частные конечные точки используют поток согласия для предоставления подсетям доступа к службе хранилища.

> [!NOTE]
> При копировании больших двоичных объектов между учетными записями хранения клиент должен иметь сетевой доступ к обеим учетным записям. Поэтому, если вы решили использовать частную ссылку только для одной учетной записи (источника или назначения), убедитесь, что у клиента есть сетевой доступ к другой учетной записи. Дополнительные сведения о других способах настройки сетевого доступа см. в статье [Настройка брандмауэров службы хранилища Azure и виртуальных сетей](storage-network-security.md?toc=/azure/storage/blobs/toc.json). 

<a id="private-endpoints-for-azure-storage"></a>

## <a name="creating-a-private-endpoint"></a>Создание частной конечной точки

При создании частной конечной точки необходимо указать учетную запись хранения и службу хранилища, к которой она подключается. 

Вам потребуется отдельная частная конечная точка для каждого ресурса хранилища, к которому необходимо получить доступ, а именно [большие двоичные объекты](../blobs/storage-blobs-overview.md), [Data Lake Storage 2-го поколения](../blobs/data-lake-storage-introduction.md), [файлы](../files/storage-files-introduction.md), [очереди](../queues/storage-queues-introduction.md), [таблицы](../tables/table-storage-overview.md)или [статические веб-сайты](../blobs/storage-blob-static-website.md). В частной конечной точке эти службы хранилища определяются как **целевой вспомогательный ресурс** связанной учетной записи хранения. 

Если вы создаете закрытую конечную точку для ресурса хранилища Data Lake Storage 2-го поколения, вы также должны создать его для ресурса хранилища BLOB-объектов. Это связано с тем, что операции, нацеленные на конечную точку Data Lake Storage 2-го поколения, могут перенаправляться в конечную точку большого двоичного объекта. Создавая закрытую конечную точку для обоих ресурсов, можно гарантировать успешное завершение операций.

> [!TIP]
> Создайте отдельную закрытую конечную точку для дополнительного экземпляра службы хранилища, чтобы повысить производительность чтения в учетных записях RA-GRS.
> Обязательно создайте учетную запись хранения общего назначения версии 2 (Standard или Premium).

Для доступа на чтение к дополнительному региону с учетной записью хранения, настроенной для геоизбыточного хранилища, требуются отдельные частные конечные точки как для основного, так и для дополнительного экземпляра службы. Для **отработки отказа** не нужно создавать закрытую конечную точку для вторичного экземпляра. Частная конечная точка будет автоматически подключаться к новому основному экземпляру после отработки отказа. Дополнительные сведения о параметрах избыточности хранилища см. в статье [избыточность хранилища Azure](storage-redundancy.md).

Более подробные сведения о создании частной конечной точки для учетной записи хранения см. в следующих статьях:

- [Подключайтесь к учетной записи хранения из учетной записи хранения в портал Azure](../../private-link/tutorial-private-endpoint-storage-portal.md)
- [Создание частной конечной точки с помощью частного центра ссылок в портал Azure](../../private-link/create-private-endpoint-portal.md)
- [Создание частной конечной точки с помощью Azure CLI](../../private-link/create-private-endpoint-cli.md)
- [Создание частной конечной точки с помощью Azure PowerShell](../../private-link/create-private-endpoint-powershell.md)

<a id="connecting-to-private-endpoints"></a>

## <a name="connecting-to-a-private-endpoint"></a>Подключение к частной конечной точке

Клиенты в виртуальной сети, использующие частную конечную точку, должны использовать одну и ту же строку подключения для учетной записи хранения, так как клиенты подключаются к общедоступной конечной точке. Мы используем разрешение DNS, чтобы автоматически маршрутизировать подключения из виртуальной сети к учетной записи хранения по частной ссылке.

> [!IMPORTANT]
> Используйте ту же строку подключения для подключения к учетной записи хранения с помощью частных конечных точек, как и в противном случае. Не подключайтесь к учетной записи хранения, используя ее `privatelink` URL-адрес поддомена.

Мы создадим [закрытую зону DNS](../../dns/private-dns-overview.md) , подключенную к виртуальной сети, с необходимыми обновлениями для частных конечных точек по умолчанию. Однако если вы используете собственный DNS-сервер, может потребоваться внести дополнительные изменения в конфигурацию DNS. В разделе об [изменениях DNS](#dns-changes-for-private-endpoints) ниже описаны обновления, необходимые для частных конечных точек.

## <a name="dns-changes-for-private-endpoints"></a>Изменения DNS для частных конечных точек

При создании частной конечной точки запись ресурса DNS CNAME для учетной записи хранения обновляется до псевдонима в поддомее с префиксом `privatelink` . По умолчанию также создается [Частная зона DNS](../../dns/private-dns-overview.md), соответствующая `privatelink` поддомену, с записями ресурсов DNS a для частных конечных точек.

При разрешении URL-адреса конечной точки хранилища извне виртуальной сети с закрытой конечной точкой она разрешается в общедоступную конечную точку службы хранилища. При разрешении из виртуальной сети, в которой размещается частная конечная точка, URL-адрес конечной точки хранилища разрешается в IP-адрес частной конечной точки.

В приведенном выше примере записи ресурсов DNS для учетной записи хранения "Сторажеаккаунта" при разрешении из-за пределов виртуальной сети, в которой размещается частная конечная точка, будут:

| Имя                                                  | Тип  | Значение                                                 |
| :---------------------------------------------------- | :---: | :---------------------------------------------------- |
| ``StorageAccountA.blob.core.windows.net``             | CNAME. | ``StorageAccountA.privatelink.blob.core.windows.net`` |
| ``StorageAccountA.privatelink.blob.core.windows.net`` | CNAME. | \<storage service public endpoint\>                   |
| \<storage service public endpoint\>                   | A     | \<storage service public IP address\>                 |

Как упоминалось ранее, вы можете запретить или контролировать доступ клиентов за пределами виртуальной сети через общедоступную конечную точку с помощью брандмауэра хранилища.

Записи ресурсов DNS для Сторажеаккаунта, разрешенные клиентом в виртуальной сети, где размещается частная конечная точка, будут:

| Имя                                                  | Тип  | Значение                                                 |
| :---------------------------------------------------- | :---: | :---------------------------------------------------- |
| ``StorageAccountA.blob.core.windows.net``             | CNAME. | ``StorageAccountA.privatelink.blob.core.windows.net`` |
| ``StorageAccountA.privatelink.blob.core.windows.net`` | A     | 10.1.1.5                                              |

Такой подход обеспечивает доступ к учетной записи хранения **, используя ту же строку подключения** для клиентов в виртуальной сети, где размещаются частные конечные точки, а также клиенты за пределами виртуальной сети.

При использовании пользовательского DNS-сервера в сети клиенты должны иметь возможность разрешить полное доменное имя конечной точки учетной записи хранения в IP-адрес частной конечной точки. Необходимо настроить DNS-сервер для делегирования поддомена частной связи в частную зону DNS для виртуальной сети или настроить записи A для "*StorageAccountA.privatelink.BLOB.Core.Windows.NET*" с IP-адресом частной конечной точки.

> [!TIP]
> При использовании пользовательского или локального DNS-сервера следует настроить DNS-сервер для разрешения имени учетной записи хранения в `privatelink` поддомене на IP-адрес частной конечной точки. Это можно сделать, делегируя `privatelink` поддомен частной зоне DNS виртуальной сети, или настроив зону DNS на DNS-сервере и добавив записи A DNS.

Рекомендуемые имена зон DNS для частных конечных точек служб хранилища и связанных с ними вспомогательных ресурсов конечной точки:

| Служба хранилища        | Целевой подресурс | Имя зоны                            |
| :--------------------- | :------------------ | :----------------------------------- |
| Служба больших двоичных объектов           | большой двоичный объект                | `privatelink.blob.core.windows.net`  |
| Data Lake Storage 2-го поколения | наборов                 | `privatelink.dfs.core.windows.net`   |
| Служба файлов           | файл                | `privatelink.file.core.windows.net`  |
| Служба очередей          | очередь               | `privatelink.queue.core.windows.net` |
| Служба таблиц          | table               | `privatelink.table.core.windows.net` |
| Статические веб-сайты        | web                 | `privatelink.web.core.windows.net`   |

Дополнительные сведения о настройке собственного DNS-сервера для поддержки частных конечных точек см. в следующих статьях:

- [Разрешение имен ресурсов в виртуальных сетях Azure](../../virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances.md#name-resolution-that-uses-your-own-dns-server)
- [Конфигурация DNS для частных конечных точек](../../private-link/private-endpoint-overview.md#dns-configuration)

## <a name="pricing"></a>Цены

Дополнительные сведения о ценах см. на [странице цен на службу "Приватный канал" Azure](https://azure.microsoft.com/pricing/details/private-link).

## <a name="known-issues"></a>Известные проблемы

Учитывайте следующие известные проблемы, связанные с частными конечными точками для службы хранилища Azure.

### <a name="storage-access-constraints-for-clients-in-vnets-with-private-endpoints"></a>Ограничения доступа к хранилищу для клиентов в виртуальных сетей с частными конечными точками

При доступе к другим учетным записям хранения, имеющим частные конечные точки, клиенты в виртуальных сетей с существующими закрытыми конечными точками имеют ограничения. Например, предположим, что у виртуальной сети N1 есть частная конечная точка для учетной записи хранения a1 для хранилища BLOB-объектов. Если у учетной записи хранения a2 есть частная конечная точка в виртуальной сети N2 для хранилища BLOB-объектов, клиенты в виртуальной сети N1 также должны иметь доступ к хранилищу BLOB-объектов в учетной записи a2 с помощью частной конечной точки. Если в учетной записи хранения a2 нет закрытых конечных точек для хранилища BLOB-объектов, клиенты в виртуальной сети N1 могут получить доступ к хранилищу больших двоичных объектов в этой учетной записи без закрытой конечной точки.

Это ограничение является результатом изменений DNS, внесенных при создании частной конечной точки учетной записью a2.

### <a name="network-security-group-rules-for-subnets-with-private-endpoints"></a>Правила групп безопасности сети для сетей с частными конечными точками

Сейчас нельзя настроить правила [группы безопасности сети](../../virtual-network/network-security-groups-overview.md) (NSG) и определяемые пользователем маршруты для частных конечных точек. Правила NSG, применяемые к подсети, в которой размещается частная конечная точка, не применяются к частной конечной точке. Они применяются только к другим конечным точкам (например, к контроллерам сетевых интерфейсов). Для этой проблемы ограниченный обходной путь заключается в реализации правил доступа для частных конечных точек в исходных подсетях, хотя этот подход может потребовать более высоких затрат на управление.

### <a name="copying-blobs-between-storage-accounts"></a>Копирование больших двоичных объектов между учетными записями хранения

Вы можете копировать большие двоичные объекты между учетными записями хранения, используя частные конечные точки, только если вы используете REST API Azure или средства, использующие REST API. К этим средствам относятся AzCopy, Обозреватель службы хранилища, Azure PowerShell, Azure CLI и пакеты SDK хранилища BLOB-объектов Azure. 

Поддерживаются только частные конечные точки, предназначенные для ресурса хранилища BLOB-объектов. Частные конечные точки, предназначенные для Data Lake Storage 2-го поколения или файлового ресурса, пока не поддерживаются. Кроме того, копирование между учетными записями хранения с помощью протокола NFS пока не поддерживается. 

## <a name="next-steps"></a>Дальнейшие действия

- [Настройка брандмауэров службы хранилища Azure и виртуальных сетей](storage-network-security.md)
- [Рекомендации по обеспечению безопасности для хранилища BLOB-объектов](../blobs/security-recommendations.md)
