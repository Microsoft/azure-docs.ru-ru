---
title: Ведение журнала Аналитики Службы хранилища Azure
description: Используйте Аналитика Службы хранилища, чтобы заносить в журнал сведения о запросах к службе хранилища Azure. Узнайте, какие запросы заносятся в журнал, как хранятся журналы, как включить ведение журнала хранилища и многое другое.
author: normesta
ms.service: storage
ms.subservice: common
ms.topic: conceptual
ms.date: 01/29/2021
ms.author: normesta
ms.reviewer: fryu
ms.custom: monitoring, devx-track-csharp
ms.openlocfilehash: f1d254eecc41ebef690b4fc9f8294bee5a368ae4
ms.sourcegitcommit: e559daa1f7115d703bfa1b87da1cf267bf6ae9e8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/17/2021
ms.locfileid: "100570025"
---
# <a name="azure-storage-analytics-logging"></a>Ведение журнала Аналитики Службы хранилища Azure

В аналитике хранилища регистрируется подробная информация об успешных и неудачных запросах к службе хранилища. Эта информация может использоваться для мониторинга отдельных запросов и диагностики неполадок в службе хранилища. Запросы вносятся в журнал наилучшим возможным образом.

> [!NOTE]
> Рекомендуется использовать журналы службы хранилища Azure в Azure Monitor вместо журналов Аналитика Службы хранилища. Журналы службы хранилища Azure в Azure Monitor предоставляются в общедоступной предварительной версии. Они также доступны для предварительного тестирования во всех регионах общедоступного облака. Эта предварительная версия включает журналы для больших двоичных объектов (в том числе Azure Data Lake Storage 2-го поколения), файлов, очередей и таблиц. Дополнительные сведения см. в следующих статьях:
>
> - [Мониторинг хранилища BLOB-объектов Azure](../blobs/monitor-blob-storage.md)
> - [Мониторинг файлов Azure](../files/storage-files-monitoring.md)
> - [Мониторинг хранилища очередей Azure](../queues/monitor-queue-storage.md)
> - [Мониторинг табличного хранилища Azure](../tables/monitor-table-storage.md)

 Ведение журнала "Аналитики Службы хранилища" по умолчанию для учетной записи хранения не предусмотрено. Его можно включить в [портал Azure](https://portal.azure.com/) или с помощью PowerShell или Azure CLI. Пошаговые инструкции см. в статье [Включение и управление журналами аналитика службы хранилища Azure (классическая модель)](manage-storage-analytics-logs.md). 

Кроме того, журналы Аналитика Службы хранилища можно включить программно с помощью REST API или клиентской библиотеки. Чтобы включить Аналитику Службы хранилища для каждой службы, можно использовать операции [Получить свойства службы BLOB-объектов](/rest/api/storageservices/Blob-Service-REST-API), [Получить свойства службы очередей](/rest/api/storageservices/Get-Queue-Service-Properties) [Получить свойства службы таблиц](/rest/api/storageservices/Get-Table-Service-Properties). Пример, включающий журналы Аналитика Службы хранилища с помощью .NET, см. в разделе [Включение журналов](manage-storage-analytics-logs.md) .

 Записи журнала создаются только при получении запроса к конечной точке службы. Например, если обнаруживается действие учетной записи хранения в конечной точке службы BLOB-объектов, но не в ее конечных точках служб таблиц или очередей, то будут созданы журналы, которые относятся только к службе BLOB-объектов.

> [!NOTE]
>  Ведение журнала Аналитики Службы хранилища доступно только для служб BLOB-объектов, очередей и таблиц. Ведение журнала Аналитики Службы хранилища также доступно для высокопроизводительных учетных записей [BlockBlobStorage](../blobs/storage-blob-create-account-block-blob.md). Однако оно недоступно для высокопроизводительных учетных записей общего назначения версии 2.

## <a name="requests-logged-in-logging"></a>Регистрация запросов
### <a name="logging-authenticated-requests"></a>Ведение журналов запросов, прошедших аутентификацию

 Регистрируются запросы, прошедшие аутентификацию, следующих типов:

- Успешные запросы.
- Неудачные запросы, в том числе из-за ошибок, связанных со временем ожидания, регулированием, сетью, авторизацией и т. п.
- Запросы, в которых используется подписанный URL-адрес (SAS) или OAuth, в том числе неудачные и успешные запросы.
- Запросы к данным аналитики.

  Запросы, выполненные в самой аналитике хранилища, такие как запросы на создание или удаление журнала, не регистрируются. Полный список регистрируемых данных приведен в разделах [Операции с протоколированием и сообщения о состоянии аналитики хранилища](/rest/api/storageservices/storage-analytics-logged-operations-and-status-messages) и [Формат журналов аналитики хранилища](/rest/api/storageservices/storage-analytics-log-format).

### <a name="logging-anonymous-requests"></a>Ведение журналов анонимных запросов

 Регистрируются анонимные запросы следующих типов:

- Успешные запросы.
- ошибки сервера;
- Ошибки времени ожидания для клиента и сервера.
- Неудачные запросы GET с кодом ошибки 304 (не изменено).

  Остальные неудачные анонимные запросы не регистрируются. Полный список регистрируемых данных приведен в разделах [Операции с протоколированием и сообщения о состоянии аналитики хранилища](/rest/api/storageservices/storage-analytics-logged-operations-and-status-messages) и [Формат журналов аналитики хранилища](/rest/api/storageservices/storage-analytics-log-format).

## <a name="how-logs-are-stored"></a>Хранение журналов

Все журналы хранятся в блочных BLOB-объектах в контейнере с именем `$logs`, который автоматически создается при включении Аналитики Службы хранилища для учетной записи хранилища. Контейнер `$logs` находится в пространстве имен BLOB-объекта учетной записи хранения, например: `http://<accountname>.blob.core.windows.net/$logs`. После включения аналитики хранилища этот контейнер нельзя удалить, но вы можете удалить его содержимое. Если вы используете средство просмотра хранилища для непосредственного перехода к контейнеру, вы увидите все BLOB-объекты, содержащие данные журнала.

> [!NOTE]
>  Контейнер `$logs` не отображается при выполнении операции перечисления контейнеров, например с использованием операции перечисления контейнеров. Доступ к нему можно получить только непосредственно. Например, для доступа к BLOB-объектам в контейнере `$logs` можно использовать операцию перечисления BLOB-объектов.

По мере регистрации запросов в аналитике хранилища промежуточные результаты передаются в качестве блоков. Периодически эти блоки фиксируются в аналитике хранилища и к ним предоставляется доступ как к большим двоичным объектам. Появление данных журнала в BLOB-объектах в контейнере **$logs** может занимать до одного часа, что определяется периодичностью очистки задач записи в журнал Службой хранилища. В журналах, созданных в один и тот же час, могут присутствовать повторяющиеся записи. Вы можете определить, является ли запись двойной, проверив идентификатор запроса **RequestId** и **номер операции**.

Если каждый час появляется большой объем данных журнала в нескольких файлах, то для определения того, какие данные должны содержаться в журнале, следует руководствоваться метаданными BLOB-объектов в полях метаданных. Этот прием также полезен по той причине, что иногда при записи данных в файл журнала имеет место задержка. Метаданные содержат более точные сведения о содержимом BLOB-объекта, чем имя BLOB-объекта.

Большая часть средств обзора позволяет просматривать метаданные BLOB-объектов; кроме того, эти сведения также можно считывать с использованием PowerShell или программным способом. Следующий фрагмент команды PowerShell является примером фильтрации списка BLOB-объектов журнала по имени для указания времени, а также по метаданным с целью определения только тех журналов, которые содержат операции **записи**.  

 ```powershell
 Get-AzStorageBlob -Container '$logs' |  
 Where-Object {  
     $_.Name -match 'blob/2014/05/21/05' -and   
     $_.ICloudBlob.Metadata.LogType -match 'write'  
 } |  
 ForEach-Object {  
     "{0}  {1}  {2}  {3}" –f $_.Name,   
     $_.ICloudBlob.Metadata.StartTime,   
     $_.ICloudBlob.Metadata.EndTime,   
     $_.ICloudBlob.Metadata.LogType  
 }  
 ```  

Сведения о программном методе отображения BLOB-объектов см. в статьях [Перечисление ресурсов хранилища BLOB-объектов](/rest/api/storageservices/Enumerating-Blob-Resources) и [Настройка и получение свойств и метаданных для ресурсов службы BLOB-объектов](/rest/api/storageservices/Setting-and-Retrieving-Properties-and-Metadata-for-Blob-Resources).  

### <a name="log-naming-conventions"></a>Соглашения об именовании журналов

 Каждый журнал записывается в следующем формате.

 `<service-name>/YYYY/MM/DD/hhmm/<counter>.log`

 В следующей таблице описан каждый атрибут имени журнала.

|attribute|Описание|
|---------------|-----------------|
|`<service-name>`|имя службы хранилища. Например, `blob`, `table` или `queue`.|
|`YYYY`|Четырехзначное обозначение года создания журнала. Например: `2011`|
|`MM`|Двузначное обозначение месяца создания журнала. Например: `07`|
|`DD`|Двузначное обозначение дня создания журнала. Например: `31`|
|`hh`|Двузначное обозначение часа, которое указывает час начала ведения журналов, в 24-часовом формате UTC. Например: `18`|
|`mm`|Двузначное обозначение минуты, которое указывает минуту начала ведения журналов. **Примечание.**  Это значение не поддерживается в текущей версии Аналитики Службы хранилища, а его значение всегда равно `00`.|
|`<counter>`|Шестизначный счетчик с отсчетом от нуля, который показывает количество больших двоичных объектов журнала, созданных для службы хранилища в течение часа. Отсчет этого счетчика начинается с `000000`. Например: `000001`|

 Ниже приведено полное имя журнала, в котором представлены вместе все упомянутые примеры.

 `blob/2011/07/31/1800/000001.log`

 Ниже приведен пример URI, который может использоваться для получения доступа к указанному журналу.

 `https://<accountname>.blob.core.windows.net/$logs/blob/2011/07/31/1800/000001.log`

 При регистрации запроса хранилища имя результирующего журнала сопоставляется с часом завершения запрошенной операции. Например, если запрос GetBlob был завершен в 18:30 31.07.2011 г., то журнал должен быть записан со следующим префиксом: `blob/2011/07/31/1800/`.

### <a name="log-metadata"></a>Метаданные журнала

 Все большие двоичные объекты журнала хранятся с метаданными, с помощью которых можно определить, какие данные журнала содержит большой двоичный объект. В следующей таблице описан каждый атрибут метаданных.

|attribute|Описание|
|---------------|-----------------|
|`LogType`|Описывает, содержит ли журнал информацию, относящуюся к операциям чтения, записи или удаления. Это значение может содержать данные одного типа или сочетание всех трех типов данных, разделенных запятыми.<br /><br /> Пример 1: `write`<br /><br /> Пример 2: `read,write`<br /><br /> Пример 3: `read,write,delete`|
|`StartTime`|Время первой записи в журнале в форме `YYYY-MM-DDThh:mm:ssZ`. Например: `2011-07-31T18:21:46Z`|
|`EndTime`|Время самой последней записи в журнале в форме `YYYY-MM-DDThh:mm:ssZ`. Например: `2011-07-31T18:22:09Z`|
|`LogVersion`|Версия формата журнала.|

 В следующем списке отображается полный образец метаданных, в котором используются приведенные выше примеры.

-   `LogType=write`
-   `StartTime=2011-07-31T18:21:46Z`
-   `EndTime=2011-07-31T18:22:09Z`
-   `LogVersion=1.0`


## <a name="next-steps"></a>Дальнейшие шаги

* [Включение и управление журналами Аналитика Службы хранилища Azure (классическая модель)](manage-storage-analytics-logs.md)
* [Формат журналов аналитик хранилища](/rest/api/storageservices/storage-analytics-log-format)
* [Операции с протоколированием и сообщения о состоянии аналитик хранилища](/rest/api/storageservices/storage-analytics-logged-operations-and-status-messages)
* [Метрики Аналитики Службы хранилища (классические)](storage-analytics-metrics.md)
