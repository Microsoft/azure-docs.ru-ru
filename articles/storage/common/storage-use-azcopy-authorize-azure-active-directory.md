---
title: Авторизация доступа к BLOB-объектам с помощью AzCopy & Azure Active Directory | Документация Майкрософт
description: Учетные данные авторизации для операций AzCopy можно предоставить с помощью Azure Active Directory (Azure AD).
author: normesta
ms.service: storage
ms.topic: how-to
ms.date: 12/17/2020
ms.author: normesta
ms.subservice: common
ms.openlocfilehash: 99e06a36c2afa66f2874c14990d50c6287623efd
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "97672497"
---
# <a name="authorize-access-to-blobs-with-azcopy-and-azure-active-directory-azure-ad"></a>Авторизация доступа к BLOB-объектам с помощью AzCopy и Azure Active Directory (Azure AD)

Вы можете предоставить AzCopy с учетными данными авторизации с помощью Azure AD. Таким образом, вам не придется добавлять маркер подписанного URL-адрес (SAS) для каждой команды. 

Начните с проверки назначений ролей. Затем выберите тип _субъекта безопасности_ , который требуется авторизовать. [Удостоверение пользователя](../../active-directory/fundamentals/add-users-azure-active-directory.md), [управляемое удостоверение](../../active-directory/managed-identities-azure-resources/overview.md)и [субъект-служба](../../active-directory/develop/app-objects-and-service-principals.md) — это каждый тип субъекта безопасности.

Удостоверение пользователя — это любой пользователь, имеющий удостоверение в Azure AD. Это самый простой субъект безопасности для авторизации. Управляемые удостоверения и субъекты-службы являются отличными вариантами, если вы планируете использовать AzCopy внутри сценария, который выполняется без взаимодействия с пользователем. Управляемое удостоверение лучше подходит для сценариев, запускаемых с виртуальной машины Azure, а субъект-служба лучше подходит для сценариев, выполняемых локально. 

Дополнительные сведения о AzCopy см. в статье Приступая [к работе с AzCopy](storage-use-azcopy-v10.md).

## <a name="verify-role-assignments"></a>Проверка назначений ролей

Необходимый уровень авторизации зависит от того, планируется ли отправка файлов или просто их загрузка.

Если вы хотите просто скачать файлы, убедитесь, что роли [читателя данных BLOB-объекта хранилища](../../role-based-access-control/built-in-roles.md#storage-blob-data-reader) назначены удостоверение пользователя, управляемое удостоверение или субъект-служба.

Если вы хотите передать файлы, убедитесь, что участнику безопасности назначена одна из этих ролей:

- [участник данных BLOB-объектов хранилища](../../role-based-access-control/built-in-roles.md#storage-blob-data-contributor);
- [владелец данных BLOB-объектов хранилища](../../role-based-access-control/built-in-roles.md#storage-blob-data-owner);

Эти роли могут быть назначены субъекту безопасности в любой из этих областей:

- Контейнер (файловая система)
- Учетная запись хранения
- Группа ресурсов
- Подписка

Сведения о проверке и назначении ролей см. в статье [использование портал Azure для назначения роли Azure доступа к данным BLOB-объектов и очередей](./storage-auth-aad-rbac-portal.md?toc=%2fazure%2fstorage%2fblobs%2ftoc.json).

> [!NOTE]
> Помните, что для распространения назначений ролей Azure может потребоваться до пяти минут.

Если субъект безопасности добавлен в список управления доступом (ACL) целевого контейнера или каталога, вам не нужно назначать одну из этих ролей субъекту безопасности. В списке управления доступом субъекту безопасности необходимо разрешение на запись в целевой каталог и разрешение EXECUTE для контейнера и каждого родительского каталога.

Дополнительные сведения см. [в разделе модель контроля доступа в Azure Data Lake Storage 2-го поколения](../blobs/data-lake-storage-access-control-model.md).

## <a name="authorize-a-user-identity"></a>Авторизация удостоверения пользователя

Убедившись, что удостоверению пользователя предоставлен необходимый уровень авторизации, откройте командную строку, введите следующую команду и нажмите клавишу ВВОД.

```azcopy
azcopy login
```

Если появляется сообщение об ошибке, попробуйте включить идентификатор клиента организации, к которой принадлежит учетная запись хранения.

```azcopy
azcopy login --tenant-id=<tenant-id>
```

Замените `<tenant-id>` заполнитель идентификатором клиента организации, к которой принадлежит учетная запись хранения. Чтобы найти идентификатор клиента, выберите **Azure Active Directory > свойства > идентификатор каталога** в портал Azure.

Эта команда возвращает код проверки подлинности и URL-адрес веб-сайта. Откройте веб-сайт, укажите код и нажмите кнопку **Далее**.

![Создание контейнера](media/storage-use-azcopy-v10/azcopy-login.png)

Откроется окно входа. В этом окне войдите в свою учетную запись Azure с помощью соответствующих данных. Выполнив вход, можно закрыть окно браузера и начать работу с AzCopy.

<a id="managed-identity"></a>

## <a name="authorize-a-managed-identity"></a>Авторизация управляемого удостоверения

Это отличный вариант, если вы планируете использовать AzCopy внутри сценария, который выполняется без участия пользователя, и сценарий выполняется из виртуальной машины Azure. При использовании этого параметра не нужно хранить учетные данные на виртуальной машине.

Вы можете войти в свою учетную запись с помощью управляемого удостоверения на уровне системы, включенного на виртуальной машине, или с помощью идентификатора клиента, идентификатора объекта или идентификатора ресурса назначенного пользователем управляемого удостоверения, назначенного вашей виртуальной машине.

Дополнительные сведения о том, как включить управляемое удостоверение для всей системы или создать управляемое пользователем удостоверение, см. в статье [Настройка управляемых удостоверений для ресурсов Azure на виртуальной машине с помощью портал Azure](../../active-directory/managed-identities-azure-resources/qs-configure-portal-windows-vm.md#enable-system-assigned-managed-identity-on-an-existing-vm).

#### <a name="authorize-by-using-a-system-wide-managed-identity"></a>Авторизация с помощью управляемого удостоверения на уровне системы

Во-первых, убедитесь, что вы включили управляемое удостоверение на уровне системы на виртуальной машине. См. раздел [управляемое системой удостоверение](../../active-directory/managed-identities-azure-resources/qs-configure-portal-windows-vm.md#system-assigned-managed-identity).

Затем в командной консоли введите следующую команду и нажмите клавишу ВВОД.

```azcopy
azcopy login --identity
```

#### <a name="authorize-by-using-a-user-assigned-managed-identity"></a>Авторизация с помощью управляемого удостоверения, назначенного пользователем

Во-первых, убедитесь, что на виртуальной машине вы включили управляемое удостоверение, назначенное пользователем. См. раздел [назначенное пользователем управляемое удостоверение](../../active-directory/managed-identities-azure-resources/qs-configure-portal-windows-vm.md#user-assigned-managed-identity).

Затем в командной консоли введите любую из следующих команд и нажмите клавишу ВВОД.

```azcopy
azcopy login --identity --identity-client-id "<client-id>"
```

Замените `<client-id>` заполнитель идентификатором клиента управляемого удостоверения, назначенного пользователем.

```azcopy
azcopy login --identity --identity-object-id "<object-id>"
```

Замените `<object-id>` заполнитель идентификатором объекта управляемого удостоверения, назначенного пользователем.

```azcopy
azcopy login --identity --identity-resource-id "<resource-id>"
```

Замените `<resource-id>` заполнитель идентификатором ресурса управляемого удостоверения, назначаемого пользователем.

<a id="service-principal"></a>

## <a name="authorize-a-service-principal"></a>Авторизация субъекта-службы

Это отличный вариант, если вы планируете использовать AzCopy внутри сценария, который выполняется без взаимодействия с пользователем, особенно при работе в локальной среде. Если вы планируете запускать AzCopy на виртуальных машинах, работающих в Azure, управляемое удостоверение службы проще администрировать. Дополнительные сведения см. в разделе [авторизация управляемого удостоверения](#authorize-a-managed-identity) этой статьи.

Перед запуском скрипта необходимо войти в интерактивном режиме по крайней мере один раз, чтобы вы могли предоставить AzCopy с учетными данными субъекта-службы.  Эти учетные данные хранятся в защищенном и зашифрованном файле, поэтому сценарий не должен предоставлять эти конфиденциальные сведения.

Вы можете войти в свою учетную запись с помощью секрета клиента или пароля сертификата, связанного с регистрацией приложения субъекта-службы.

Дополнительные сведения о создании субъекта-службы см. в статье [как использовать портал для создания приложения Azure AD и субъекта-службы, которые могут получать доступ к ресурсам](../../active-directory/develop/howto-create-service-principal-portal.md).

Дополнительные сведения о субъектах-службах см. в разделе [объекты приложения и субъекта-службы в Azure Active Directory](../../active-directory/develop/app-objects-and-service-principals.md)

#### <a name="authorize-a-service-principal-by-using-a-client-secret"></a>Авторизация субъекта-службы с помощью секрета клиента

Начните с установки `AZCOPY_SPA_CLIENT_SECRET` переменной среды в секрет клиента регистрации приложения субъекта-службы.

> [!NOTE]
> Обязательно задайте это значение в командной строке, а не в параметрах переменной среды операционной системы. Таким образом, значение будет доступно только текущему сеансу.

В этом примере показано, как это можно сделать в PowerShell.

```azcopy
$env:AZCOPY_SPA_CLIENT_SECRET="$(Read-Host -prompt "Enter key")"
```

> [!NOTE]
> Рассмотрите возможность использования запроса, как показано в этом примере. В этом случае ваш пароль не будет отображаться в журнале команд консоли.  

Затем введите следующую команду и нажмите клавишу ВВОД.

```azcopy
azcopy login --service-principal  --application-id application-id --tenant-id=tenant-id
```

Замените `<application-id>` заполнитель идентификатором приложения для регистрации приложения субъекта-службы. Замените `<tenant-id>` заполнитель идентификатором клиента организации, к которой принадлежит учетная запись хранения. Чтобы найти идентификатор клиента, выберите **Azure Active Directory > свойства > идентификатор каталога** в портал Azure. 

#### <a name="authorize-a-service-principal-by-using-a-certificate"></a>Авторизация субъекта-службы с помощью сертификата

Если вы предпочитаете использовать собственные учетные данные для авторизации, вы можете отправить сертификат в регистрацию приложения, а затем использовать этот сертификат для входа.

Кроме отправки сертификата в регистрацию приложения, вам также потребуется копия сертификата, сохраненная на компьютере или виртуальной машине, где будет выполняться AzCopy. Эта копия сертификата должна быть в. PFX или. Формат PEM и должен включать закрытый ключ. Закрытый ключ должен быть защищен паролем. Если вы используете Windows и ваш сертификат существует только в хранилище сертификатов, обязательно экспортируйте этот сертификат в PFX-файл (включая закрытый ключ). Инструкции см. в разделе [Export-PfxCertificate](/powershell/module/pkiclient/export-pfxcertificate) .

Затем задайте `AZCOPY_SPA_CERT_PASSWORD` для переменной среды пароль сертификата.

> [!NOTE]
> Обязательно задайте это значение в командной строке, а не в параметрах переменной среды операционной системы. Таким образом, значение будет доступно только текущему сеансу.

В этом примере показано, как можно выполнить эту задачу в PowerShell.

```azcopy
$env:AZCOPY_SPA_CERT_PASSWORD="$(Read-Host -prompt "Enter key")"
```

Затем введите следующую команду и нажмите клавишу ВВОД.

```azcopy
azcopy login --service-principal --certificate-path <path-to-certificate-file> --tenant-id=<tenant-id>
```

Замените `<path-to-certificate-file>` заполнитель относительным или полным путем к файлу сертификата. AzCopy сохраняет путь к этому сертификату, но не сохраняет копию сертификата, поэтому обязательно сохраните этот сертификат на месте. Замените `<tenant-id>` заполнитель идентификатором клиента организации, к которой принадлежит учетная запись хранения. Чтобы найти идентификатор клиента, выберите **Azure Active Directory > свойства > идентификатор каталога** в портал Azure.

> [!NOTE]
> Рассмотрите возможность использования запроса, как показано в этом примере. В этом случае ваш пароль не будет отображаться в журнале команд консоли. 

## <a name="authorize-without-a-secret-store"></a>Авторизация без хранилища секретов

`azcopy login`Команда извлекает маркер OAuth и помещает его в хранилище секретов в системе. Если у вашей операционной системы нет секретного хранилища, такого как набор *ключей* Linux, `azcopy login` команда не будет работать, так как не поместит маркер. 

Вместо использования `azcopy login` команды можно задать переменные среды в памяти. Затем выполните любую команду AzCopy. AzCopy будет получать маркер проверки подлинности, необходимый для завершения операции. После завершения операции маркер исчезает из памяти. 

### <a name="authorize-a-user-identity"></a>Авторизация удостоверения пользователя

Убедившись, что удостоверению пользователя предоставлен необходимый уровень авторизации, введите следующую команду и нажмите клавишу ВВОД.

```bash
export AZCOPY_AUTO_LOGIN_TYPE=DEVICE
```

Затем выполните любую команду azcopy (например: `azcopy list https://contoso.blob.core.windows.net` ).

Эта команда возвращает код проверки подлинности и URL-адрес веб-сайта. Откройте веб-сайт, укажите код и нажмите кнопку **Далее**.

![Создание контейнера](media/storage-use-azcopy-v10/azcopy-login.png)

Откроется окно входа. В этом окне войдите в свою учетную запись Azure с помощью соответствующих данных. После успешного входа операция может завершиться.

### <a name="authorize-by-using-a-system-wide-managed-identity"></a>Авторизация с помощью управляемого удостоверения на уровне системы

Во-первых, убедитесь, что вы включили управляемое удостоверение на уровне системы на виртуальной машине. См. раздел [управляемое системой удостоверение](../../active-directory/managed-identities-azure-resources/qs-configure-portal-windows-vm.md#system-assigned-managed-identity).

Введите следующую команду и нажмите клавишу ВВОД.

```bash
export AZCOPY_AUTO_LOGIN_TYPE=MSI
```

Затем выполните любую команду azcopy (например: `azcopy list https://contoso.blob.core.windows.net` ).

### <a name="authorize-by-using-a-user-assigned-managed-identity"></a>Авторизация с помощью управляемого удостоверения, назначенного пользователем

Во-первых, убедитесь, что на виртуальной машине вы включили управляемое удостоверение, назначенное пользователем. См. раздел [назначенное пользователем управляемое удостоверение](../../active-directory/managed-identities-azure-resources/qs-configure-portal-windows-vm.md#user-assigned-managed-identity).

Введите следующую команду и нажмите клавишу ВВОД.

```bash
export AZCOPY_AUTO_LOGIN_TYPE=MSI
```

Затем введите любую из следующих команд и нажмите клавишу ВВОД.

```bash
export AZCOPY_MSI_CLIENT_ID=<client-id>
```

Замените `<client-id>` заполнитель идентификатором клиента управляемого удостоверения, назначенного пользователем.

```bash
export AZCOPY_MSI_OBJECT_ID=<object-id>
```

Замените `<object-id>` заполнитель идентификатором объекта управляемого удостоверения, назначенного пользователем.

```bash
export AZCOPY_MSI_RESOURCE_STRING=<resource-id>
```

Замените `<resource-id>` заполнитель идентификатором ресурса управляемого удостоверения, назначаемого пользователем.

После задания этих переменных можно выполнить любую команду azcopy (например: `azcopy list https://contoso.blob.core.windows.net` ).

### <a name="authorize-a-service-principal"></a>Авторизация субъекта-службы

Вы можете войти в свою учетную запись с помощью секрета клиента или пароля сертификата, связанного с регистрацией приложения субъекта-службы.

#### <a name="authorize-a-service-principal-by-using-a-client-secret"></a>Авторизация субъекта-службы с помощью секрета клиента

Введите следующую команду и нажмите клавишу ВВОД.

```bash
export AZCOPY_AUTO_LOGIN_TYPE=SPN
export AZCOPY_SPA_APPLICATION_ID=<application-id>
export AZCOPY_SPA_CLIENT_SECRET=<client-secret>
```

Замените `<application-id>` заполнитель идентификатором приложения для регистрации приложения субъекта-службы. Замените `<client-secret>` заполнитель секретом клиента.

> [!NOTE]
> Рассмотрите возможность использования запроса на получение пароля от пользователя. В этом случае ваш пароль не будет отображаться в журнале команд. 

Затем выполните любую команду azcopy (например: `azcopy list https://contoso.blob.core.windows.net` ).

#### <a name="authorize-a-service-principal-by-using-a-certificate"></a>Авторизация субъекта-службы с помощью сертификата

Если вы предпочитаете использовать собственные учетные данные для авторизации, вы можете отправить сертификат в регистрацию приложения, а затем использовать этот сертификат для входа.

Кроме отправки сертификата в регистрацию приложения, вам также потребуется копия сертификата, сохраненная на компьютере или виртуальной машине, где будет выполняться AzCopy. Эта копия сертификата должна быть в. PFX или. Формат PEM и должен включать закрытый ключ. Закрытый ключ должен быть защищен паролем. 

Введите следующую команду и нажмите клавишу ВВОД.

```bash
export AZCOPY_AUTO_LOGIN_TYPE=SPN
export AZCOPY_SPA_CERT_PATH=<path-to-certificate-file>
export AZCOPY_SPA_CERT_PASSWORD=<certificate-password>
```

Замените `<path-to-certificate-file>` заполнитель относительным или полным путем к файлу сертификата. AzCopy сохраняет путь к этому сертификату, но не сохраняет копию сертификата, поэтому обязательно сохраните этот сертификат на месте. Замените `<certificate-password>` заполнитель паролем сертификата.

> [!NOTE]
> Рассмотрите возможность использования запроса на получение пароля от пользователя. В этом случае ваш пароль не будет отображаться в журнале команд. 

Затем выполните любую команду azcopy (например: `azcopy list https://contoso.blob.core.windows.net` ).

## <a name="next-steps"></a>Дальнейшие действия

- Дополнительные сведения о AzCopy см. [в статье Начало работы с AzCopy](storage-use-azcopy-v10.md) .

- Если у вас есть вопросы, проблемы или общие отзывы, отправьте их [на страницу GitHub](https://github.com/Azure/azure-storage-azcopy) .