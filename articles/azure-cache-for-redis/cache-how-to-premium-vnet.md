---
title: Настройка виртуальной сети — кэша Azure уровня "Премиум" для экземпляра Redis
description: Узнайте, как создавать и администрировать поддержку виртуальных сетей для кэша Azure уровня "Премиум" для экземпляров Redis.
author: yegu-ms
ms.author: yegu
ms.service: cache
ms.custom: devx-track-csharp
ms.topic: conceptual
ms.date: 10/09/2020
ms.openlocfilehash: 9343bc424a0a38da173a56701528c4fd7549aabd
ms.sourcegitcommit: f7084d3d80c4bc8e69b9eb05dfd30e8e195994d8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/22/2020
ms.locfileid: "97734663"
---
# <a name="configure-virtual-network-support-for-a-premium-tier-azure-cache-for-redis-instance"></a>Настройка поддержки виртуальной сети для кэша Azure уровня "Премиум" для экземпляра Redis

Кэш Azure для Redis предлагается во множестве различных вариантов, отличающихся между собой размером и функциями. К функциям уровня Premium относятся Кластеризация, сохраняемость и поддержка виртуальных сетей. Виртуальная сеть — это частная сеть в облаке. Если для экземпляра кэша Azure для Redis настроена виртуальная сеть, он не является общедоступным и доступен только из виртуальных машин и приложений в виртуальной сети. В этой статье описывается, как настроить поддержку виртуальной сети для кэша Azure уровня "Премиум" для экземпляра Redis.

> [!NOTE]
> Кэш Azure для Redis поддерживает как классическую модель развертывания, так и виртуальные сети Azure Resource Manager.
> 

## <a name="why-virtual-network"></a>Зачем нужна виртуальная сеть?

Развертывание [виртуальной сети Azure](https://azure.microsoft.com/services/virtual-network/) обеспечивает повышенную безопасность и изоляцию для экземпляра Redis в кэше Azure, а также подсети, политики управления доступом и другие функции для дальнейшего ограничения доступа.

## <a name="virtual-network-support"></a>Поддержка виртуальной сети

Поддержка виртуальных сетей настраивается в **новом кэше Azure для Redis** на панели при создании кэша.

1. Чтобы создать кэш уровня "Премиум", войдите в [портал Azure](https://portal.azure.com) и выберите **создать ресурс**. Помимо создания кэшей в портал Azure их также можно создать с помощью шаблонов диспетчер ресурсов, PowerShell или Azure CLI. Дополнительные сведения о создании кэша Azure для экземпляра Redis см. в разделе [создание кэша](cache-dotnet-how-to-use-azure-redis-cache.md#create-a-cache).

    :::image type="content" source="media/cache-private-link/1-create-resource.png" alt-text="Снимок экрана, на котором показано создание ресурса.":::
   
1. На странице **Создание** выберите **базы данных**. Затем выберите **кэш Azure для Redis**.

    :::image type="content" source="media/cache-private-link/2-select-cache.png" alt-text="Снимок экрана, на котором показано, как выбрать кэш Azure для Redis.":::

1. На странице **новый кэш Redis** настройте параметры для нового кэша уровня "Премиум".
   
   | Параметр      | Рекомендуемое значение  | Description |
   | ------------ |  ------- | -------------------------------------------------- |
   | **DNS-имя** | Введите глобально уникальное имя | Имя кэша должно быть строкой от 1 до 63 символов, содержащих только цифры, буквы или дефисы. Имя должно начинаться и заканчиваться цифрой или буквой и не может содержать последовательные дефисы. *Имя узла* для экземпляра кэша получит значение *\<DNS name>.redis.cache.windows.net*. |
   | **подписка** | Выберите подписку в раскрывающемся списке. | В этой подписке будет создан новый экземпляр кэша Redis для Azure. |
   | **Группа ресурсов** | Выберите группу ресурсов из раскрывающегося списка или щелкните **создать** и введите имя новой группы ресурсов. | Имя группы ресурсов, в которой создается кэш и другие ресурсы. Поместив все ресурсы приложения в одну группу ресурсов, вы сможете легко управлять ими и/или удалить их вместе. |
   | **Местоположение** | Выберите расположение из раскрывающегося списка. | Выберите оптимальный [регион](https://azure.microsoft.com/regions/) для других служб, которые будут использовать кэш. |
   | **Тип кэша** |Выберите кэш уровня "Премиум" из раскрывающегося списка, чтобы настроить функции уровня "Премиум". Дополнительные сведения см. на странице [Цены на Кэш Azure для Redis](https://azure.microsoft.com/pricing/details/cache/). |  Ценовая категория определяет размер, производительность и функции, доступные для кэша. Дополнительные сведения см. в статье [Общие сведения о кэше Azure для Redis](cache-overview.md). |

1. Перейдите на вкладку " **сеть** " или нажмите кнопку " **сеть** " в нижней части страницы.

1. На вкладке " **сеть** " в качестве метода подключения выберите **виртуальные сети** . Чтобы использовать новую виртуальную сеть, сначала создайте ее, выполнив действия, описанные в статье [Создание виртуальной сети с помощью портал Azure](../virtual-network/manage-virtual-network.md#create-a-virtual-network) или [Создание классической виртуальной сети с помощью портал Azure](/previous-versions/azure/virtual-network/virtual-networks-create-vnet-classic-pportal). Затем вернитесь на панель " **новый кэш Azure для Redis** ", чтобы создать и настроить кэш уровня "Премиум".

   > [!IMPORTANT]
   > При развертывании кэша Azure для Redis в виртуальной сети диспетчер ресурсов кэш должен находиться в выделенной подсети, которая не содержит других ресурсов, за исключением кэша Azure для экземпляров Redis. При попытке развернуть кэш Azure для экземпляра Redis в подсети виртуальной сети диспетчер ресурсов, которая содержит другие ресурсы, происходит сбой развертывания.
   > 
   > 

   | Параметр      | Рекомендуемое значение  | Описание |
   | ------------ |  ------- | -------------------------------------------------- |
   | **Виртуальная сеть** | Выберите виртуальную сеть из раскрывающегося списка. | Выберите виртуальную сеть в той же подписке и расположении, что и ваш кэш. |
   | **Подсеть** | Выберите подсеть из раскрывающегося списка. | Диапазон адресов подсети должен быть в нотации CIDR (например, 192.168.1.0/24). Он должен содержаться в адресном пространстве виртуальной сети. |
   | **Статический IP-адрес** | Используемых Введите статический IP-адрес. | Если не указать статический IP-адрес, IP-адрес будет выбран автоматически. |

   > [!IMPORTANT]
   > Azure резервирует некоторые IP-адреса в каждой подсети, которые нельзя использовать. Зарезервированы первый и последний IP-адреса подсетей (для соответствия требованиям протокола), а также еще три адреса, используемые для служб Azure. Дополнительные сведения см. в разделе [Существуют ли ограничения на использование IP-адресов в пределах этих подсетей?](../virtual-network/virtual-networks-faq.md#are-there-any-restrictions-on-using-ip-addresses-within-these-subnets)
   > 
   > В дополнение к IP-адресам, используемым инфраструктурой виртуальной сети Azure, каждый экземпляр кэша Azure для Redis в подсети использует два IP-адреса для каждого сегмента и один дополнительный IP-адрес для балансировщика нагрузки. Некластеризованный кэш считается одним сегментом.
   > 

1. Выберите вкладку **следующее: дополнительно** или нажмите кнопку **Далее: дополнительно** в нижней части страницы.

1. На вкладке **Дополнительно** для экземпляра кэша уровня Premium настройте параметры для неtls-портов, кластеризации и сохраняемости данных.

1. Перейдите на вкладку **следующий: Теги** или нажмите кнопку **Далее: Теги** в нижней части страницы.

1. При необходимости на вкладке **теги** введите имя и значение, если требуется классифицировать ресурс.

1. Выберите **Review + create** (Просмотреть и создать). Вы перейдете на вкладку " **Проверка и создание** ", где Azure проверяет конфигурацию.

1. После появления сообщения "Зеленая **Проверка пройдена** " выберите **создать**.

На создание кэша требуется некоторое время. Вы можете отслеживать ход выполнения на странице **обзорных сведений** кэша Azure для Redis. Когда **Состояние** примет значение **Running** (Выполняется), кэш будет готов к использованию. После создания кэша можно просмотреть конфигурацию виртуальной сети, выбрав пункт **Виртуальная сеть** в меню **ресурс** .

![Виртуальная сеть][redis-cache-vnet-info]

Чтобы подключиться к кэшу Azure для экземпляра Redis при использовании виртуальной сети, укажите имя узла кэша в строке подключения, как показано в следующем примере:

```csharp
private static Lazy<ConnectionMultiplexer>
    lazyConnection = new Lazy<ConnectionMultiplexer> (() =>
    {
        return ConnectionMultiplexer.Connect("contoso5premium.redis.cache.windows.net,abortConnect=false,ssl=true,password=password");
    });

public static ConnectionMultiplexer Connection
{
    get
    {
        return lazyConnection.Value;
    }
}
```

## <a name="azure-cache-for-redis-virtual-network-faq"></a>Часто задаваемые вопросы о кэше Azure для виртуальной сети Redis

В приведенном ниже списке представлены ответы на часто задаваемые вопросы о масштабировании кэша Azure для Redis.

* Каковы распространенные проблемы с конфигурацией кэша Azure для Redis и виртуальных сетей?
* [Как проверить, работает ли кэш в виртуальной сети?](#how-can-i-verify-that-my-cache-is-working-in-a-virtual-network)
* Почему при попытке подключиться к моему кэшу Azure для экземпляра Redis в виртуальной сети выводится сообщение об ошибке, сообщающее, что удаленный сертификат недействителен?
* [Можно ли использовать виртуальные сети с кэшем уровня "Стандартный" или "базовый"?](#can-i-use-virtual-networks-with-a-standard-or-basic-cache)
* Почему создание кэша Azure для экземпляра Redis завершается сбоем в некоторых подсетях, но не в других?
* [Каковы требования к адресному пространству подсети?](#what-are-the-subnet-address-space-requirements)
* [Работают ли все функции кэша при размещении кэша в виртуальной сети?](#do-all-cache-features-work-when-a-cache-is-hosted-in-a-virtual-network)

### <a name="what-are-some-common-misconfiguration-issues-with-azure-cache-for-redis-and-virtual-networks"></a>Каковы распространенные проблемы с конфигурацией кэша Azure для Redis и виртуальных сетей?

Если кэш Azure для Redis размещается в виртуальной сети, используются порты в следующих таблицах.

>[!IMPORTANT]
>Если порты в следующих таблицах заблокированы, кэш может работать неправильно. Блокировка одного или нескольких этих портов является наиболее распространенной проблемой необычной настройки при использовании кэша Azure для Redis в виртуальной сети.
> 

- [Обязательные порты для исходящего трафика](#outbound-port-requirements)
- [Обязательные порты для входящего трафика](#inbound-port-requirements)

#### <a name="outbound-port-requirements"></a>Обязательные порты для исходящего трафика

Существует девять требований к исходящему порту. Исходящие запросы в этих диапазонах являются либо исходящими для других служб, необходимых для функционирования кэша, либо внутренними в подсети Redis для взаимодействия между узлами. Для георепликации существуют дополнительные требования к исходящему трафику между подсетями первичного и репликового кэша.

| порты; | Направление | Транспортный протокол | Назначение | Локальный IP-адрес | Удаленный IP-адрес |
| --- | --- | --- | --- | --- | --- |
| 80, 443 |Исходящие |TCP |Зависимости Redis в службе хранилища Azure или PKI (Интернет) | (Подсеть Redis) |* <sup>четырех</sup> |
| 443 | Исходящие | TCP | Зависимость Redis от Azure Key Vault и Azure Monitor | (Подсеть Redis) | AzureKeyVault, Азуремонитор <sup>1</sup> |
| 53 |Исходящий трафик |TCP/UDP |Зависимости Redis от DNS (Интернет или виртуальная сеть) | (Подсеть Redis) | 168.63.129.16 и 169.254.169.254 <sup>2</sup> , а также любой пользовательский DNS-сервер для подсети <sup>3</sup> |
| 8443 |Исходящие |TCP |Внутренний обмен данными для Redis | (Подсеть Redis) | (Подсеть Redis) |
| 10221-10231 |Исходящие |TCP |Внутренний обмен данными для Redis | (Подсеть Redis) | (Подсеть Redis) |
| 20226 |Исходящие |TCP |Внутренний обмен данными для Redis | (Подсеть Redis) |(Подсеть Redis) |
| 13000-13999 |Исходящие |TCP |Внутренний обмен данными для Redis | (Подсеть Redis) |(Подсеть Redis) |
| 15000-15999 |Исходящие |TCP |Внутренние коммуникации для Redis и георепликации | (Подсеть Redis) |(Подсеть Redis) (Геореплика одноранговая подсеть) |
| 6379-6380 |Исходящие |TCP |Внутренний обмен данными для Redis | (Подсеть Redis) |(Подсеть Redis) |

<sup>1</sup> вы можете использовать теги службы AzureKeyVault и азуремонитор с диспетчер ресурсов группами безопасности сети (группы безопасности сети).

<sup>2</sup> эти IP-адреса, принадлежащие корпорации Майкрософт, используются для адресации виртуальной машины узла, которая обслуживает Azure DNS.

<sup>3</sup> эта информация не требуется для подсетей без пользовательского DNS-сервера или более новых кэшей Redis, которые игнорируют пользовательский DNS.

<sup>4</sup> дополнительные сведения см. в разделе [Дополнительные требования к подключению виртуальной сети](#additional-virtual-network-connectivity-requirements).

#### <a name="geo-replication-peer-port-requirements"></a>Требования к портам, связанные с георепликацией

Если вы используете георепликацию между кэшами в виртуальных сетях Azure, разблокируйте порты 15000-15999 для всей подсети в качестве входящих *и* исходящих направлений для обоих кэшей. В такой конфигурации все компоненты реплики в подсети могут напрямую взаимодействовать друг с другом, даже если в будущем географической отработки отказа произошла ошибка.

#### <a name="inbound-port-requirements"></a>Обязательные порты для входящего трафика

Существует восемь обязательных диапазонов портов для входящего трафика. Входящие запросы в этих диапазонах являются либо входящими из других служб, размещенными в той же виртуальной сети, либо внутренними для обмена данными с подсетью Redis.

| порты; | Направление | Транспортный протокол | Назначение | Локальный IP-адрес | Удаленный IP-адрес |
| --- | --- | --- | --- | --- | --- |
| 6379, 6380 |Входящий трафик |TCP |Обмен данными между клиентом и Redis, балансировка нагрузки Azure | (Подсеть Redis) | (Подсеть Redis), (подсеть клиента), AzureLoadBalancer <sup>1</sup> |
| 8443 |Входящий трафик |TCP |Внутренний обмен данными для Redis | (Подсеть Redis) |(Подсеть Redis) |
| 8500 |Входящий трафик |TCP/UDP |Балансировка нагрузки Azure | (Подсеть Redis) | AzureLoadBalancer |
| 10221-10231 |Входящий трафик |TCP |Взаимодействие клиента с кластерами Redis, внутренняя связь для Redis | (Подсеть Redis) |(Подсеть Redis), AzureLoadBalancer, (подсеть клиента) |
| 13000-13999 |Входящий трафик |TCP |Обмен данными между клиентом и кластерами Redis, балансировка нагрузки Azure | (Подсеть Redis) | (Подсеть Redis), (подсеть клиента), AzureLoadBalancer |
| 15000-15999 |Входящий трафик |TCP |Взаимодействие клиента с кластерами Redis, балансировкой нагрузки Azure и георепликацией | (Подсеть Redis) | (Подсеть Redis), (подсеть клиента), AzureLoadBalancer, (одноранговая подсеть геореплики) |
| 16001 |Входящий трафик |TCP/UDP |Балансировка нагрузки Azure | (Подсеть Redis) | AzureLoadBalancer |
| 20226 |Входящий трафик |TCP |Внутренний обмен данными для Redis | (Подсеть Redis) |(Подсеть Redis) |

<sup>1</sup> можно использовать тег службы AzureLoadBalancer для диспетчер ресурсов или AZURE_LOADBALANCER для классической модели развертывания для создания правил NSG.

#### <a name="additional-virtual-network-connectivity-requirements"></a>Дополнительные требования к подключению виртуальной сети

Существуют требования к сетевому подключению для кэша Azure для Redis, которые могут быть изначально не выполнены в виртуальной сети. Для использования кэша Azure для Redis необходимо, чтобы все следующие элементы правильно работали при использовании в виртуальной сети:

* Исходящие сетевые подключения к конечным точкам хранилища Azure по всему миру. Включены конечные точки, расположенные в том же регионе, что и кэш Azure для экземпляра Redis и конечные точки хранилища, расположенные в *других* регионах Azure. Конечные точки службы хранилища Azure разрешаются в следующих доменах DNS: *Table.Core.Windows.NET*, *BLOB.Core.Windows.NET*, *Queue.Core.Windows.NET* и *File.Core.Windows.NET*.
* Исходящее сетевое подключение к *OCSP.DigiCert.com*, *crl4.DigiCert.com*, *OCSP.msocsp.com*, *mscrl.Microsoft.com*, *crl3.DigiCert.com*, *cacerts.DigiCert.com*, *oneocsp.Microsoft.com* и *CRL.Microsoft.com*. Это подключение требуется для поддержки функций TLS/SSL.
* Конфигурация DNS для виртуальной сети должна поддерживать разрешение всех конечных точек и доменов, указанных в предыдущих точках. Эти требования DNS обеспечиваются за счет настройки допустимой инфраструктуры DNS и ее поддержания для виртуальной сети.
* Исходящее сетевое подключение к следующим Azure Monitor конечным точкам, которые разрешаются в следующих доменах DNS: *shoebox2-Black.shoebox2.Metrics.nsatc.NET*, *North-prod2.prod2.Metrics.nsatc.NET*, *azglobal-Black.azglobal.Metrics.nsatc.NET*, *shoebox2-Red.shoebox2.Metrics.nsatc.NET*, *East-prod2.prod2.Metrics.nsatc.NET* и *azglobal-Red.azglobal.Metrics.nsatc.NET*.

### <a name="how-can-i-verify-that-my-cache-is-working-in-a-virtual-network"></a>Как проверить, работает ли кэш в виртуальной сети?

>[!IMPORTANT]
>При подключении к кэшу Azure для экземпляра Redis, размещенного в виртуальной сети, клиенты кэша должны находиться в одной виртуальной сети или в виртуальной сети с включенным пирингом виртуальных сетей в одном регионе Azure. В настоящее время пиринг глобальной виртуальной сети не поддерживается. Это требование относится к любым тестовым приложениям или средствам диагностики проверки связи. Независимо от того, где размещается клиентское приложение, группы безопасности сети или другие уровни сети должны быть настроены таким, чтобы сетевой трафик клиента был доступен в кэше Azure для экземпляра Redis.
>

После настройки требований к портам, как описано в предыдущем разделе, можно убедиться, что кэш работает, выполнив следующие действия.

- [Перезагрузите](cache-administration.md#reboot) все узлы кэша. Если не удается связаться со всеми необходимыми зависимостями кэша, как описано в статье [требования к входящему порту](cache-how-to-premium-vnet.md#inbound-port-requirements) и [требования к исходящему порту](cache-how-to-premium-vnet.md#outbound-port-requirements), кэш не сможет успешно перезапуститься.
- После перезапуска узлов кэша, сообщаемых состоянием кэша в портал Azure, можно выполнить следующие тесты:
  - Проверка связи с конечной точкой кэша с помощью порта 6380 с компьютера, находящихся в той же виртуальной сети, что и кэш, с помощью [tcping](https://www.elifulkerson.com/projects/tcping.php). Пример:
    
    `tcping.exe contosocache.redis.cache.windows.net 6380`
    
    Если `tcping` средство сообщает о том, что порт открыт, то кэш доступен для подключения клиентов в виртуальной сети.

  - Другой способ проверки — создать тестовый клиент кэша (это может быть простое консольное приложение, использующее StackExchange.Redis), который подключается к кэшу и добавляет какие-то элементы в кэш или извлекает их из него. Установите пример клиентского приложения на виртуальную машину, которая находится в той же виртуальной сети, что и кэш. Затем запустите его, чтобы проверить подключение к кэшу.


### <a name="when-i-try-to-connect-to-my-azure-cache-for-redis-instance-in-a-virtual-network-why-do-i-get-an-error-stating-the-remote-certificate-is-invalid"></a>Почему при попытке подключиться к моему кэшу Azure для экземпляра Redis в виртуальной сети выводится сообщение об ошибке, сообщающее, что удаленный сертификат недействителен?

При попытке подключения к экземпляру кэша Azure для Redis в виртуальной сети отображается ошибка проверки сертификата, как показано ниже.

`{"No connection is available to service this operation: SET mykey; The remote certificate is invalid according to the validation procedure.; …"}`

Причиной может быть подключение к узлу по IP-адресу. Рекомендуется использовать имя узла. Иными словами, используйте следующую строку:

`[mycachename].redis.windows.net:6380,password=xxxxxxxxxxxxxxxxxxxx,ssl=True,abortConnect=False`

Не используйте IP-адрес, похожий на следующую строку подключения:

`10.128.2.84:6380,password=xxxxxxxxxxxxxxxxxxxx,ssl=True,abortConnect=False`

Если не удается разрешить DNS-имя, некоторые клиентские библиотеки включают параметры конфигурации, такие как `sslHost` , предоставляемые клиентом StackExchange. Redis. Этот параметр позволяет переопределить имя узла, используемое для проверки сертификата. Пример:

`10.128.2.84:6380,password=xxxxxxxxxxxxxxxxxxxx,ssl=True,abortConnect=False;sslHost=[mycachename].redis.windows.net`

### <a name="can-i-use-virtual-networks-with-a-standard-or-basic-cache"></a>Можно ли использовать виртуальные сети с кэшем уровня "Стандартный" или "базовый"?

Виртуальные сети можно использовать только с кэшем уровня "Премиум".

### <a name="why-does-creating-an-azure-cache-for-redis-instance-fail-in-some-subnets-but-not-others"></a>Почему создание кэша Azure для экземпляра Redis завершается сбоем в некоторых подсетях, но не в других?

Если вы развертываете кэш Azure для экземпляра Redis в виртуальной сети, кэш должен находиться в выделенной подсети, которая не содержит других типов ресурсов. Если предпринята попытка развернуть кэш Azure для экземпляра Redis в подсети диспетчер ресурсов виртуальной сети, которая содержит другие ресурсы, такие как экземпляры шлюза приложений Azure и исходящий трафик NAT, развертывание обычно завершится сбоем. Прежде чем можно будет создать новый кэш Azure для экземпляра Redis, необходимо удалить существующие ресурсы других типов.

Кроме того, необходимо иметь достаточное количество доступных IP-адресов в подсети.

### <a name="what-are-the-subnet-address-space-requirements"></a>Каковы требования к адресному пространству подсети?

Azure резервирует некоторые IP-адреса в каждой подсети, которые нельзя использовать. Зарезервированы первый и последний IP-адреса подсетей (для соответствия требованиям протокола), а также еще три адреса, используемые для служб Azure. Дополнительные сведения см. в разделе [Существуют ли ограничения на использование IP-адресов в пределах этих подсетей?](../virtual-network/virtual-networks-faq.md#are-there-any-restrictions-on-using-ip-addresses-within-these-subnets)

Помимо IP-адресов, используемых инфраструктурой виртуальной сети Azure, каждый экземпляр кэша Azure для экземпляра Redis в подсети использует два IP-адреса для сегмента кластера, а также дополнительные IP-адреса для дополнительных реплик, если таковые имеются. Для балансировщика нагрузки используется один дополнительный IP-адрес. Некластеризованный кэш считается одним сегментом.

### <a name="do-all-cache-features-work-when-a-cache-is-hosted-in-a-virtual-network"></a>Работают ли все функции кэша при размещении кэша в виртуальной сети?

Если кэш является частью виртуальной сети, доступ к кэшу могут получить только клиенты из виртуальной сети. В результате следующие функции управления кэшем в настоящее время не работают:

* **Консоль Redis**: так как консоль Redis работает в локальном браузере, который обычно находится на компьютере разработчика, который не подключен к виртуальной сети, он не может подключиться к кэшу.

## <a name="use-expressroute-with-azure-cache-for-redis"></a>Использование ExpressRoute с кэшем Azure для Redis

Клиенты могут подключить канал [Azure ExpressRoute](https://azure.microsoft.com/services/expressroute/) к своей инфраструктуре виртуальной сети. Таким образом, они расширяют свою локальную сеть в Azure.

По умолчанию вновь созданный канал ExpressRoute не выполняет принудительное туннелирование (объявление маршрута по умолчанию 0.0.0.0/0) в виртуальной сети. В результате исходящее подключение к Интернету разрешается непосредственно из виртуальной сети. Клиентские приложения могут подключаться к другим конечным точкам Azure, включая кэш Azure для экземпляра Redis.

Распространенная Конфигурация клиента — использование принудительного туннелирования (объявление маршрута по умолчанию), при котором исходящий Интернет-трафик передается в локальный поток. Этот поток трафика прерывает подключение к кэшу Azure для Redis, если исходящий трафик блокируется локально, так что кэш Azure для экземпляра Redis не может взаимодействовать со своими зависимостями.

Решение заключается в определении одного или нескольких определяемых пользователем маршрутов (определяемые пользователем маршруты) в подсети, содержащей кэш Azure для экземпляра Redis. Определяемые пользователем маршруты задают маршруты для подсети, которые будут использоваться вместо основного маршрута.

По возможности используйте следующую конфигурацию.

* Конфигурация ExpressRoute объявляет 0.0.0.0/0 и по умолчанию принудительно туннелируют весь исходящий трафик в локальной среде.
* UDR, применяемый к подсети, содержащей экземпляр кэша Azure для Redis, определяет 0.0.0.0/0 с рабочим маршрутом трафика TCP/IP к общедоступному Интернету. Например, он устанавливает тип следующего прыжка в *Интернет*.

В результате этого действия UDR уровня подсети имеет приоритет над принудительным туннелированием ExpressRoute, что обеспечивает исходящий доступ в Интернет из кэша Azure для экземпляра Redis.

Подключение к кэшу Azure для экземпляра Redis из локального приложения с помощью ExpressRoute не является типичным сценарием использования из-за соображений производительности. Для лучшей производительности кэш Azure для клиентов Redis должен находиться в том же регионе, что и кэш Azure для экземпляра Redis.

>[!IMPORTANT]
>Маршруты, определенные в UDR, *должны* быть достаточно конкретными, чтобы иметь приоритет над любыми маршрутами, объявленными в конфигурации ExpressRoute. В следующем примере используется широкий диапазон адресов 0.0.0.0/0, который может быть случайно переопределен объявлениями маршрутов, использующими более конкретные диапазоны адресов.

>[!WARNING]
>Кэш Azure для Redis не поддерживается в конфигурациях ExpressRoute, которые *неправильно перекрестно объявляют маршруты из пути общедоступного пиринга в путь частного пиринга*. Конфигурации ExpressRoute, для которых настроен общедоступный пиринг, будут получать объявления маршрутов от корпорации Майкрософт для большого набора диапазонов IP-адресов Microsoft Azure. Если эти диапазоны адресов неправильно перекрестно объявляются в пути частного пиринга, то все исходящие сетевые пакеты из подсети экземпляра кэша Azure для Redis ошибочно принудительно туннелируются в локальную сетевую инфраструктуру клиента. Такой сетевой поток нарушает работу кэша Azure для Redis. Решением этой проблемы является остановка перекрестного объявления маршрутов между путем общедоступного и закрытого пиринга.

Общие сведения о определяемые пользователем маршруты доступны в [маршрутизации трафика виртуальной сети](../virtual-network/virtual-networks-udr-overview.md).

Дополнительные сведения об ExpressRoute см. в статье [Технический обзор ExpressRoute](../expressroute/expressroute-introduction.md).

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о кэше Azure для функций Redis.

* [Кэш Azure для уровней службы Redis Premium](cache-overview.md#service-tiers)

<!-- IMAGES -->

[redis-cache-vnet]: ./media/cache-how-to-premium-vnet/redis-cache-vnet.png

[redis-cache-vnet-ip]: ./media/cache-how-to-premium-vnet/redis-cache-vnet-ip.png

[redis-cache-vnet-info]: ./media/cache-how-to-premium-vnet/redis-cache-vnet-info.png
