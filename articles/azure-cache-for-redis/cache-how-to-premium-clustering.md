---
title: Настройка кластеризации Redis — кэш Azure уровня Premium для Redis
description: Узнайте, как создать и управлять кластеризацией Redis для кэша Azure уровня "Премиум" для экземпляров Redis
author: yegu-ms
ms.author: yegu
ms.service: cache
ms.topic: conceptual
ms.date: 02/08/2021
ms.openlocfilehash: f1e84c838d310721cba604274388ae2767eb1502
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "100389677"
---
# <a name="configure-redis-clustering-for-a-premium-azure-cache-for-redis-instance"></a>Настройка кластеризации Redis для кэша Azure уровня "Премиум" для экземпляра Redis

Кэш Azure для Redis предлагает кластер Redis в том виде, как это [реализовано в Redis](https://redis.io/topics/cluster-tutorial). При использовании кластера Redis вы получаете такие преимущества: 

* Возможность автоматически разделить набор данных между несколькими узлами. 
* Возможность продолжить работу, когда на подмножестве узлов возникают ошибки или узлы не могут обмениваться данными с остальной частью кластера. 
* Более высокая пропускная способность: пропускная способность линейно увеличивается по мере увеличения числа сегментов. 
* Больший объем памяти: объем памяти линейно увеличивается по мере увеличения числа сегментов.  

Кластеризация не увеличивает число подключений, доступных для кластеризованного кэша. Дополнительные сведения о размере, пропускной способности и пропускной способности кэша уровня "Премиум" см. [в разделе Выбор правильного уровня](cache-overview.md#choosing-the-right-tier) .

В Azure кластер Redis предоставляется в виде основной или реплицированной модели, где у каждого сегмента есть основная или реплицированная пара с репликацией, управляемой кэшем Azure для службы Redis. 

## <a name="set-up-clustering"></a>Настройка кластеризации

Кластеризация доступна во время создания кэша в колонке **Новый кэш Azure для Redis**. 

1. Чтобы создать кэш уровня "Премиум", войдите в [портал Azure](https://portal.azure.com) и выберите **создать ресурс**. Кэши можно создавать не только на портале Azure, но и с помощью шаблонов Resource Manager, PowerShell или интерфейса командной строки Azure. Дополнительные сведения о создании кэша Azure для Redis см. в разделе [Создание кэша](cache-dotnet-how-to-use-azure-redis-cache.md#create-a-cache).

    :::image type="content" source="media/cache-private-link/1-create-resource.png" alt-text="Создать ресурс.":::
   
2. На странице **Создание** выберите **Базы данных**, а затем **Кэш Azure для Redis**.

    :::image type="content" source="media/cache-private-link/2-select-cache.png" alt-text="Выбор элемента &quot;Кэш Azure для Redis&quot;.":::

3. На странице **новый кэш Redis** настройте параметры для нового кэша Premium.
   
   | Параметр      | Рекомендуемое значение  | Description |
   | ------------ |  ------- | -------------------------------------------------- |
   | **DNS-имя** | Введите глобально уникальное имя | Имя кэша должно быть строкой длиной от 1 до 63 символов и содержать только цифры, буквы и дефисы. Имя должно начинаться и заканчиваться цифрой или буквой и не может содержать более одного дефиса подряд. *Имя узла* для экземпляра кэша получит значение *\<DNS name>.redis.cache.windows.net*. | 
   | **подписка** | Раскрывающийся список и выберите свою подписку. | В этой подписке будет создан новый экземпляр кэша Redis для Azure. | 
   | **Группа ресурсов** | Выберите группу ресурсов или щелкните **создать** и введите новое имя группы ресурсов. | Имя группы ресурсов, в которой будут созданы кэш и другие ресурсы. Поместив все ресурсы приложения в одну группу ресурсов, вы сможете легко управлять ими и/или удалить их вместе. | 
   | **Местоположение** | Раскрывающийся список и выберите расположение. | Выберите оптимальный [регион](https://azure.microsoft.com/regions/) для других служб, которые будут использовать кэш. |
   | **Тип кэша** | И выберите кэш уровня "Премиум", чтобы настроить функции уровня "Премиум". Дополнительные сведения см. в статье о [ценах на кэш Azure для Redis](https://azure.microsoft.com/pricing/details/cache/). |  Ценовая категория определяет размер, производительность и функции, доступные для кэша. Дополнительные сведения см. в [обзоре предложения "Кэш Redis для Azure"](cache-overview.md). |

4. Выберите вкладку **Сети** или нажмите кнопку **Сети** в нижней части страницы.

5. На вкладке **Сети** выберите способ подключения. Для экземпляров кэша уровня "Премиум" можно подключаться к публичному, через общедоступные IP-адреса или конечные точки службы или в частном порядке с помощью частной конечной точки.

6. Нажмите кнопку **Далее: дополнительно** в нижней части страницы или выберите вкладку **Далее: дополнительно**.

7. На вкладке **Дополнительно** для экземпляра кэша уровня "Премиум" настройте параметры для неtls-порта, кластеризации и сохраняемости данных. Чтобы включить кластеризацию, нажмите кнопку **включить**.

    :::image type="content" source="media/cache-how-to-premium-clustering/redis-cache-clustering.png" alt-text="Переключить кластеризацию.":::

    Кластер может включать до 10 сегментов. После нажатия кнопки **включить** переместите ползунок или введите число от 1 до 10 для **счетчика сегментов** и нажмите кнопку **ОК**.

    Каждый сегмент представляет собой пару основного экземпляра кэша и реплики кэша, которыми управляет Azure. Общий размер кэша вычисляется путем умножения количества сегментов на размер кэша, выбранный в ценовой категории.

    :::image type="content" source="media/cache-how-to-premium-clustering/redis-cache-clustering-selected.png" alt-text="Выбран переключатель кластеризации.":::

    Создав кэш, вы подключаетесь к нему, используя как некластеризованный кэш, а Redis распределяет данные между его сегментами. Если диагностика [включена](cache-how-to-monitor.md#enable-cache-diagnostics), то метрики собираются отдельно для каждого сегмента и могут [отображаться](cache-how-to-monitor.md) в колонке кэша Azure для Redis. 

8. Нажмите кнопку **Далее: теги** или нажмите кнопку **Далее: теги** в нижней части страницы.

9. При необходимости на вкладке **Теги** введите имя и значение, чтобы классифицировать ресурс. 

10. Выберите **Проверить и создать**. Вы будете перенаправлены на вкладку "Просмотр и создание", где Azure проверит вашу конфигурацию.

11. Когда отобразится сообщение "Проверка пройдена" зеленого цвета, выберите **Создать**.

На создание кэша требуется некоторое время. Вы можете отслеживать ход выполнения на странице **обзорных сведений** кэша Azure для Redis. Когда **Состояние** примет значение **Running** (Выполняется), кэш будет готов к использованию. 

> [!NOTE]
> 
> Существует ряд незначительных отличий, необходимых в клиентском приложении для настройки кластеризации. Дополнительные сведения см. в разделе [Нужно ли вносить изменения в клиентское приложение, чтобы использовать кластеризацию?](#do-i-need-to-make-any-changes-to-my-client-application-to-use-clustering).
> 
> 

Пример кода по работе с кластеризацией клиента StackExchange.Redis см. в разделе [clustering.cs](https://github.com/rustd/RedisSamples/blob/master/HelloWorld/Clustering.cs) примера [Hello World](https://github.com/rustd/RedisSamples/tree/master/HelloWorld).

<a name="cluster-size"></a>

## <a name="change-the-cluster-size-on-a-running-premium-cache"></a>Изменение размера кластера на работающем кэше категории "Премиум"
Чтобы изменить размер кластера в работающем кэше уровня "Премиум" с включенной кластеризацией, щелкните **Размер кластера** в **меню ресурсов**.

![Размер кластера Redis][redis-cache-redis-cluster-size]

Чтобы изменить размер кластера, воспользуйтесь ползунком или введите число от 1 до 10 в текстовом поле **Shard count** (Количество сегментов), а затем нажмите кнопку **ОК** для сохранения изменений.

Увеличение размера кластера увеличивает максимальную пропускную способность и размер кэша. Увеличение размера кластера не приводит к увеличению максимального количества . подключений, доступных для клиентов.

> [!NOTE]
> Масштабирование кластера запускает ресурсоемкую команду [MIGRATE](https://redis.io/commands/migrate). Чтобы избежать перегрузки, мы не рекомендуем выполнять эту операцию в рабочие часы. Во время миграции вы заметите резкое увеличение нагрузки на сервер. Масштабирование кластера — это длительный процесс, время выполнения которого зависит от числа ключей и размера значений, связанных с этими ключами.
> 
> 

## <a name="clustering-faq"></a>Часто задаваемые вопросы по кластеризации

Следующий список содержит ответы на часто задаваемые вопросы о кэше Azure для кластеризации Redis.

* [Нужно ли вносить изменения в клиентское приложение, чтобы использовать кластеризацию?](#do-i-need-to-make-any-changes-to-my-client-application-to-use-clustering)
* [Распределение ключей в кластере](#how-are-keys-distributed-in-a-cluster)
* [Каков максимальный размер кэша, который можно создать?](#what-is-the-largest-cache-size-i-can-create)
* [Все ли клиенты Redis поддерживают кластеризацию?](#do-all-redis-clients-support-clustering)
* [Как подключиться к кэшу, если кластеризация включена?](#how-do-i-connect-to-my-cache-when-clustering-is-enabled)
* [Можно ли напрямую подключаться к отдельным сегментам кэша?](#can-i-directly-connect-to-the-individual-shards-of-my-cache)
* [Можно ли настроить кластеризацию для ранее созданного кэша?](#can-i-configure-clustering-for-a-previously-created-cache)
* [Можно ли настроить кластеризацию для кэша уровней Базовый и Стандартный?](#can-i-configure-clustering-for-a-basic-or-standard-cache)
* [Можно ли использовать кластеризацию с поставщиками состояний сеансов и кэширования выходных данных ASP.NET Redis?](#can-i-use-clustering-with-the-redis-aspnet-session-state-and-output-caching-providers)
* [При использовании StackExchange.Redis и кластеризации порождаются исключения MOVE. Что делать?](#i-am-getting-move-exceptions-when-using-stackexchangeredis-and-clustering-what-should-i-do)

### <a name="do-i-need-to-make-any-changes-to-my-client-application-to-use-clustering"></a>Нужно ли вносить изменения в клиентское приложение, чтобы использовать кластеризацию?
* Если кластеризация включена, доступна только база данных 0. Если клиентское приложение использует несколько баз данных и пытается выполнить чтение или запись в базе данных, отличной от 0, порождается приведенное ниже исключение. `Unhandled Exception: StackExchange.Redis.RedisConnectionException: ProtocolFailure on GET --->` `StackExchange.Redis.RedisCommandException: Multiple databases are not supported on this server; cannot switch to database: 6`
  
  Дополнительные сведения см. в разделе "Implemented subset" (Реализованное подмножество) статьи [Redis Cluster Specification](https://redis.io/topics/cluster-spec#implemented-subset) (Спецификация кластера Redis).
* Если вы используете клиент [StackExchange.Redis](https://www.nuget.org/packages/StackExchange.Redis/), необходимо установить версию 1.0.481 или более позднюю. Вы можете подключаться к кэшу с помощью тех же [конечных точек, портов и ключей](cache-configure.md#properties) , которые используются для подключения к кэшу с отключенной кластеризацией. Единственное отличие заключается в том, что все операции чтения и записи должны выполняться в базе данных 0.
  
  Требования других клиентов могут отличаться. Ознакомьтесь с разделом [Все ли клиенты Redis поддерживают кластеризацию?](#do-all-redis-clients-support-clustering)
* Если приложение использует несколько операций с ключом, объединенных в одну команду, все ключи должны быть расположены в одном сегменте. Чтобы найти ключи, расположенные в одном сегменте, см. раздел [Как ключи распределены в кластере?](#how-are-keys-distributed-in-a-cluster)
* Если вы используете поставщик состояний сеансов ASP.NET Redis, вам необходимо установить версию 2.0.1 или более позднюю версию. Ознакомьтесь с разделом [Можно ли использовать кластеризацию с поставщиками состояний сеансов и кэширования выходных данных ASP.NET Redis?](#can-i-use-clustering-with-the-redis-aspnet-session-state-and-output-caching-providers)

### <a name="how-are-keys-distributed-in-a-cluster"></a>Распределение ключей в кластере
В соответствии с документацией по [модели распределения ключей](https://redis.io/topics/cluster-spec#keys-distribution-model) в Redis пространство ключей разбивается на 16 384 слота. Каждый ключ хэшируется и присваивается одному из этих слотов, распределенных между узлами кластера. С помощью хэш-тегов вы можете указать хэшируемую часть ключа, чтобы убедиться в том, что несколько ключей находятся в одном сегменте.

* Ключи с хэш-тегом. Если любая часть ключа заключена в фигурные скобки — `{` и `}`, — для определения хэш-слота ключа хэшируется только эта часть. Например, три ключа — `{key}1`, `{key}2` и `{key}3` — будут расположены в одном сегменте, так как хэшируется только часть имени `key`. Полный список спецификаций для хэш-тегов ключей см. в разделе [Keys hash tags](https://redis.io/topics/cluster-spec#keys-hash-tags) (Хэш-теги ключей).
* Ключи без хэш-тега. Для хэширования используется полное имя ключа. Это позволяет достичь статистически равномерного распределения по сегментам кэша.

Для оптимальной производительности и пропускной способности рекомендуется равномерно распределять ключи. Если вы используете ключи с хэш-тегом, приложение должно обеспечивать равномерное распределение ключей.

Дополнительные сведения см. в разделах [Keys distribution model](https://redis.io/topics/cluster-spec#keys-distribution-model) (Модель распределения ключей), [Redis Cluster data sharding](https://redis.io/topics/cluster-tutorial#redis-cluster-data-sharding) (Сегментирование данных в кластере Redis) и [Keys hash tags](https://redis.io/topics/cluster-spec#keys-hash-tags) (Хэш-теги ключей).

Пример кода по работе с кластеризацией и поиска ключей в одном сегменте для клиента StackExchange.Redis см. в части [clustering.cs](https://github.com/rustd/RedisSamples/blob/master/HelloWorld/Clustering.cs) примера [Hello World](https://github.com/rustd/RedisSamples/tree/master/HelloWorld).

### <a name="what-is-the-largest-cache-size-i-can-create"></a>Каков максимальный размер кэша, который можно создать?
Самый крупный размер кэша уровня "Премиум" составляет 120 ГБ. Можно создать до 10 сегментов, предоставляя максимальный размер в 1,2 ТБ Гб. Если требуется больший размер, вы можете [отправить запрос на получение дополнительного места](mailto:wapteams@microsoft.com?subject=Redis%20Cache%20quota%20increase). Дополнительные сведения см. на странице [Цены на Кэш Azure для Redis](https://azure.microsoft.com/pricing/details/cache/).

### <a name="do-all-redis-clients-support-clustering"></a>Все ли клиенты Redis поддерживают кластеризацию?
Не все клиенты поддерживают кластеризацию Redis! Ознакомьтесь с документацией по используемой библиотеке, чтобы убедиться, что вы используете библиотеку и версию, поддерживающие кластеризацию. StackExchange. Redis — это одна библиотека, которая поддерживает кластеризацию в более новых версиях. Дополнительные сведения о других клиентах см. в разделе [Playing with the cluster](https://redis.io/topics/cluster-tutorial#playing-with-the-cluster) (Эксперименты с кластером) [руководства по кластерам Redis](https://redis.io/topics/cluster-tutorial). 

Для протокола кластеризации Redis требуется, чтобы каждый клиент подключаться к каждому сегменту напрямую в режиме кластеризации, а также определяет новые ответы об ошибках, например "ПЕРЕМЕЩЕНо" КРОСССЛОТС ". Попытка использования клиента, который не поддерживает кластеризацию с кэшем в режиме кластера, может привести к многократному [перемещению исключений перенаправления](https://redis.io/topics/cluster-spec#moved-redirection)или простому прерыванию работы приложения при выполнении многоключовых запросов между слотами.

> [!NOTE]
> Если вы используете клиент [StackExchange.Redis](https://www.nuget.org/packages/StackExchange.Redis/), убедитесь, что у вас установлена версия 1.0.481 или более поздняя. Это необходимо для правильного выполнения кластеризации. При возникновении проблем с исключениями MOVE ознакомьтесь с дополнительными сведениями [здесь](#move-exceptions).
>

### <a name="how-do-i-connect-to-my-cache-when-clustering-is-enabled"></a>Как подключиться к кэшу, если кластеризация включена?
Вы можете подключаться к кэшу с помощью тех же [конечных точек](cache-configure.md#properties), [портов](cache-configure.md#properties) и [ключей](cache-configure.md#access-keys), которые используются для подключения к кэшу с отключенной кластеризацией. Redis управляет кластеризацией на сервере, поэтому управлять ей из клиента не нужно.

### <a name="can-i-directly-connect-to-the-individual-shards-of-my-cache"></a>Можно ли напрямую подключаться к отдельным сегментам кэша?
В соответствии с требованиями протокола кластеризации, клиент должен подключаться к надлежащему сегменту. Поэтому нужно обеспечить правильное подключение клиента. Тем не менее каждый сегмент включает пару, которая включает основной кэш и его реплику и называется экземпляром кэша. Вы можете подключиться к этим экземплярам кэша с помощью служебной программы redis-cli из ветви [нестабильных версий](https://redis.io/download) репозитория Redis на портале GitHub. Эта версия реализует базовую поддержку при запуске с параметром `-c`. Дополнительные сведения см. в разделе [Воспроизведение с кластером](https://redis.io/topics/cluster-tutorial#playing-with-the-cluster) в [https://redis.io](https://redis.io) руководстве по [кластеру Redis](https://redis.io/topics/cluster-tutorial).

Для нестандартного TLS используйте следующие команды.

```bash
Redis-cli.exe –h <<cachename>> -p 13000 (to connect to instance 0)
Redis-cli.exe –h <<cachename>> -p 13001 (to connect to instance 1)
Redis-cli.exe –h <<cachename>> -p 13002 (to connect to instance 2)
...
Redis-cli.exe –h <<cachename>> -p 1300N (to connect to instance N)
```

Для протокола TLS замените `1300N` на `1500N` .

### <a name="can-i-configure-clustering-for-a-previously-created-cache"></a>Можно ли настроить кластеризацию для ранее созданного кэша?
Да. Сначала убедитесь, что кэш имеет значение Premium, масштабирование, если нет. Далее вы увидите параметры конфигурации кластера, включая параметр включения кластера. Размер кластера можно изменить после создания кэша или после первого включения кластеризации в первый раз.

   >[!IMPORTANT]
   >Вы не можете отменить Включение кластеризации. И кэш с включенной кластеризацией, и только один сегмент ведет себя *иначе* , чем кэш такого же размера *без кластеризации* .

### <a name="can-i-configure-clustering-for-a-basic-or-standard-cache"></a>Можно ли настроить кластеризацию для кэша уровней Базовый и Стандартный?
Кластеризация доступна только для кэша уровня Премиум.

### <a name="can-i-use-clustering-with-the-redis-aspnet-session-state-and-output-caching-providers"></a>Можно ли использовать кластеризацию с поставщиками состояний сеансов и кэширования выходных данных ASP.NET Redis?
* **Поставщик кэша вывода Redis** — изменения не требуются.
* **Поставщик состояний сеансов Redis** — для кластеризации необходимо использовать [RedisSessionStateProvider](https://www.nuget.org/packages/Microsoft.Web.RedisSessionStateProvider) 2.0.1 или более поздней версии. В противном случае будет порождено исключение. Это критическое изменение; Дополнительные сведения см. в разделе [v 2.0.0 критическое изменение сведений об изменении](https://github.com/Azure/aspnet-redis-providers/wiki/v2.0.0-Breaking-Change-Details).

<a name="move-exceptions"></a>

### <a name="i-am-getting-move-exceptions-when-using-stackexchangeredis-and-clustering-what-should-i-do"></a>При использовании StackExchange.Redis и кластеризации порождаются исключения MOVE. Что делать?
Если вы применяете StackExchange.Redis и получаете исключения `MOVE` при кластеризации, убедитесь, что вы используете [StackExchange.Redis 1.1.603](https://www.nuget.org/packages/StackExchange.Redis/) или более позднюю версию. Инструкции по настройке приложений .NET для использования StackExchange.Redis см. в разделе [Настройка клиентов кэша](cache-dotnet-how-to-use-azure-redis-cache.md#configure-the-cache-clients).

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о кэше Azure для функций Redis.

* [Кэш Azure для уровней службы Redis Premium](cache-overview.md#service-tiers)

<!-- IMAGES -->

[redis-cache-clustering]: ./media/cache-how-to-premium-clustering/redis-cache-clustering.png

[redis-cache-clustering-selected]: ./media/cache-how-to-premium-clustering/redis-cache-clustering-selected.png

[redis-cache-redis-cluster-size]: ./media/cache-how-to-premium-clustering/redis-cache-redis-cluster-size.png
