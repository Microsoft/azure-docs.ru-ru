---
title: Руководство по Создание масштабируемого набора виртуальных машин и управление им с помощью Azure CLI
description: Сведения об использовании Azure CLI для создания масштабируемого набора виртуальных машин и выполнения некоторых стандартных задач управления, включая запуск и остановку экземпляра или изменение емкости масштабируемого набора.
author: ju-shim
ms.author: jushiman
ms.topic: tutorial
ms.service: virtual-machine-scale-sets
ms.subservice: management
ms.date: 03/27/2018
ms.reviewer: mimckitt
ms.custom: mimckitt, devx-track-azurecli
ms.openlocfilehash: 0f94823b958ae5f95789dd4ef9a62057bdf764a8
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "94517472"
---
# <a name="tutorial-create-and-manage-a-virtual-machine-scale-set-with-the-azure-cli"></a>Руководство по Создание масштабируемого набора виртуальных машин и управление им с помощью Azure CLI
Масштабируемый набор виртуальных машин обеспечивает развертывание и администрирование набора идентичных автомасштабируемых виртуальных машин. На протяжении жизненного цикла масштабируемого набора виртуальных машин может возникнуть необходимость выполнить одну или несколько задач управления. Из этого руководства вы узнаете, как выполнить следующие задачи:

> [!div class="checklist"]
> * Создание масштабируемого набора виртуальных машин и подключение к нему.
> * Выбор и использование образов виртуальных машин
> * Просмотр и использование определенных размеров экземпляров виртуальных машин.
> * Масштабирование масштабируемого набора вручную.
> * Выполнение стандартных задач управления масштабируемым набором.

[!INCLUDE [quickstarts-free-trial-note](../../includes/quickstarts-free-trial-note.md)]

[!INCLUDE [azure-cli-prepare-your-environment.md](../../includes/azure-cli-prepare-your-environment.md)]

- Для работы с этой статьей требуется Azure CLI версии 2.0.29 или более поздней. Если вы используете Azure Cloud Shell, последняя версия уже установлена. 


## <a name="create-a-resource-group"></a>Создание группы ресурсов
Группа ресурсов Azure является логическим контейнером, в котором происходит развертывание ресурсов Azure и управление ими. Группу ресурсов следует создать до создания масштабируемого набора виртуальных машин. Создайте группу ресурсов с помощью команды [az group create](/cli/azure/group). В этом примере создается группа ресурсов с именем *myResourceGroup* в регионе *eastus*. 

```azurecli-interactive
az group create --name myResourceGroup --location eastus
```

Имя группы ресурсов указывается при создании или изменении масштабируемого набора в этом руководстве.


## <a name="create-a-scale-set"></a>Создание масштабируемого набора
Создайте масштабируемый набор виртуальных машин, выполнив команду [az vmss create](/cli/azure/vmss). В следующем примере создаются масштабируемый набор *myScaleSet* и ключи SSH, если они еще не созданы.

```azurecli-interactive
az vmss create \
  --resource-group myResourceGroup \
  --name myScaleSet \
  --image UbuntuLTS \
  --admin-username azureuser \
  --generate-ssh-keys
```

Создание и настройка всех ресурсов и экземпляров виртуальных машин масштабируемого набора занимает несколько минут. Чтобы распределить трафик между отдельными экземплярами виртуальных машин, создается еще и подсистема балансировки нагрузки.


## <a name="view-the-vm-instances-in-a-scale-set"></a>Просмотр экземпляров виртуальных машин в масштабируемом наборе
Чтобы просмотреть список экземпляров виртуальных машин в масштабируемом наборе, выполните команду [az vmss list-instances](/cli/azure/vmss), как показано ниже.

```azurecli-interactive
az vmss list-instances \
  --resource-group myResourceGroup \
  --name myScaleSet \
  --output table
```

В следующем примере выходных данных показано два экземпляра виртуальной машины в масштабируемом наборе.

```output
  InstanceId  LatestModelApplied    Location    Name          ProvisioningState    ResourceGroup    VmId
------------  --------------------  ----------  ------------  -------------------  ---------------  ------------------------------------
           1  True                  eastus      myScaleSet_1  Succeeded            MYRESOURCEGROUP  c059be0c-37a2-497a-b111-41272641533c
           3  True                  eastus      myScaleSet_3  Succeeded            MYRESOURCEGROUP  ec19e7a7-a4cd-4b24-9670-438f4876c1f9
```


В первом столбце выходных данных показан *InstanceId*. Чтобы просмотреть дополнительные сведения о конкретном экземпляре виртуальной машины, добавьте параметр `--instance-id` в команду [az vmss get-instance-view](/cli/azure/vmss). Следующий пример возвращает сведения об экземпляре виртуальной машины *1*.

```azurecli-interactive
az vmss get-instance-view \
  --resource-group myResourceGroup \
  --name myScaleSet \
  --instance-id 1
```


## <a name="list-connection-information"></a>Вывод списка со сведениями о подключении
Общедоступный IP-адрес назначен подсистеме балансировки нагрузки, перенаправляющей трафик к отдельным экземплярам виртуальных машин. По умолчанию правила преобразования сетевых адресов (NAT) добавляются в подсистему балансировки нагрузки Azure для переадресации трафика удаленного подключения на каждую виртуальную машину на определенном порте. Чтобы подключиться к экземплярам виртуальных машин в масштабируемом наборе, необходимо создать удаленное подключение по назначенному общедоступному IP адресу и номеру порта.

Чтобы получить список адресов и портов для подключения к экземплярам виртуальных машин в масштабируемом наборе, выполните команду [az vmss list-instance-connection-info](/cli/azure/vmss).

```azurecli-interactive
az vmss list-instance-connection-info \
  --resource-group myResourceGroup \
  --name myScaleSet
```

В следующем примере выходных данных показано имя экземпляра, общедоступный IP-адрес подсистемы балансировки нагрузки и номер порта, в который правила преобразования сетевых адресов перенаправляют трафик.

```output
{
  "instance 1": "13.92.224.66:50001",
  "instance 3": "13.92.224.66:50003"
}
```

Установите SSH-подключение к первому экземпляру виртуальной машины. Укажите общедоступный IP-адрес и номер порта с помощью параметра `-p`, как показано в предыдущей команде.

```console
ssh azureuser@13.92.224.66 -p 50001
```

После входа в экземпляр виртуальной машины вы можете выполнить некоторые изменения конфигурации вручную. Сейчас закройте сеанс SSH, как обычно:

```console
exit
```


## <a name="understand-vm-instance-images"></a>Описание образов экземпляра виртуальной машины
При создании масштабируемого набора в начале этого руководства для экземпляров виртуальных машин был указан образ `--image`*UbuntuLTS*. Azure Marketplace содержит множество образов, которые можно использовать для создания экземпляров виртуальных машин. Чтобы просмотреть список наиболее часто используемых образов, используйте команду [az vm image list](/cli/azure/vm/image).

```azurecli-interactive
az vm image list --output table
```

В указанном ниже примере выходных данных показаны общие образы виртуальной машины в Azure. С помощью *UrnAlias* можно указать один из этих общих образов при создании масштабируемого набора.

```output
Offer          Publisher               Sku                 Urn                                                             UrnAlias             Version
-------------  ----------------------  ------------------  --------------------------------------------------------------  -------------------  ---------
CentOS         OpenLogic               7.3                 OpenLogic:CentOS:7.3:latest                                     CentOS               latest
CoreOS         CoreOS                  Stable              CoreOS:CoreOS:Stable:latest                                     CoreOS               latest
Debian         credativ                8                   credativ:Debian:8:latest                                        Debian               latest
openSUSE-Leap  SUSE                    42.2                SUSE:openSUSE-Leap:42.2:latest                                  openSUSE-Leap        latest
RHEL           RedHat                  7.3                 RedHat:RHEL:7.3:latest                                          RHEL                 latest
SLES           SUSE                    12-SP2              SUSE:SLES:12-SP2:latest                                         SLES                 latest
UbuntuServer   Canonical               16.04-LTS           Canonical:UbuntuServer:16.04-LTS:latest                         UbuntuLTS            latest
WindowsServer  MicrosoftWindowsServer  2016-Datacenter     MicrosoftWindowsServer:WindowsServer:2016-Datacenter:latest     Win2016Datacenter    latest
WindowsServer  MicrosoftWindowsServer  2012-R2-Datacenter  MicrosoftWindowsServer:WindowsServer:2012-R2-Datacenter:latest  Win2012R2Datacenter  latest
WindowsServer  MicrosoftWindowsServer  2012-Datacenter     MicrosoftWindowsServer:WindowsServer:2012-Datacenter:latest     Win2012Datacenter    latest
WindowsServer  MicrosoftWindowsServer  2008-R2-SP1         MicrosoftWindowsServer:WindowsServer:2008-R2-SP1:latest         Win2008R2SP1         latest
```

Чтобы просмотреть полный список образов, добавьте аргумент `--all`. Кроме того, список образов можно отфильтровать по издателю или предложению с помощью аргумента `--publisher` или `–-offer` соответственно. В следующем примере список образов отфильтрован по предложению *CentOS*.

```azurecli-interactive
az vm image list --offer CentOS --all --output table
```

В следующем сжатом примере выходных данных показаны некоторые доступные образы CentOS 7.3.

```output
Offer    Publisher   Sku   Urn                                 Version
-------  ----------  ----  ----------------------------------  -------------
CentOS   OpenLogic   7.3   OpenLogic:CentOS:7.3:7.3.20161221   7.3.20161221
CentOS   OpenLogic   7.3   OpenLogic:CentOS:7.3:7.3.20170421   7.3.20170421
CentOS   OpenLogic   7.3   OpenLogic:CentOS:7.3:7.3.20170517   7.3.20170517
CentOS   OpenLogic   7.3   OpenLogic:CentOS:7.3:7.3.20170612   7.3.20170612
CentOS   OpenLogic   7.3   OpenLogic:CentOS:7.3:7.3.20170707   7.3.20170707
CentOS   OpenLogic   7.3   OpenLogic:CentOS:7.3:7.3.20170925   7.3.20170925
```

Чтобы развернуть масштабируемый набор, в котором используется определенный образ, используйте значение из столбца *Urn*. При указании образа его номер версии можно заменить ключевым словом *latest*. В этом случае будет выбрана последняя версия дистрибутива. В указанном ниже примере добавлен аргумент `--image`, чтобы указать последнюю версию образа CentOS 7.3.

> [!IMPORTANT]
> Мы советуем использовать образ *последней* (latest) версии. Укажите "latest", чтобы использовать последнюю версию образа, доступную во время развертывания. Обратите внимание: несмотря на то, что указано "latest", образ виртуальной машины не будет автоматически обновляться после развертывания, даже если станет доступной его новая версия.

Так как создание и настройка всех ресурсов и экземпляров виртуальных машин масштабируемого набора занимает несколько минут, вам не нужно развертывать следующий масштабируемый набор.

```azurecli-interactive
az vmss create \
  --resource-group myResourceGroup \
  --name myScaleSetCentOS \
  --image OpenLogic:CentOS:7.3:latest \
  --admin-user azureuser \
  --generate-ssh-keys
```


## <a name="understand-vm-instance-sizes"></a>Описание размеров экземпляра виртуальной машины
Размер экземпляра виртуальной машины (или *номер SKU*) определяет количество выделяемых ему вычислительных ресурсов, таких как ЦП, GPU и память. Размеры экземпляров виртуальных машин в масштабируемом наборе должны соответствовать ожидаемой рабочей нагрузке.

### <a name="vm-instance-sizes"></a>Размеры экземпляров виртуальных машин
В приведенной ниже таблице указаны категории распространенных размеров виртуальной машины и варианты использования.

| Тип                     | Распространенные размеры           |    Описание       |
|--------------------------|-------------------|------------------------------------------------------------------------------------------------------------------------------------|
| [Универсальные](../virtual-machines/sizes-general.md)         |Dsv3, Dv3, DSv2, Dv2, DS, D, Av2, A0–7| Сбалансированное соотношение ресурсов ЦП и памяти. Идеально подходят для разработки и тестирования малых и средних приложений и решений для обработки данных.  |
| [Оптимизированные для вычислений](../virtual-machines/sizes-compute.md)   | Fs, F             | Высокое соотношение ресурсов ЦП и памяти. Подходят для приложений со средним объемом трафика, сетевых устройств и пакетных процессов.        |
| [Оптимизированные для памяти](../virtual-machines/sizes-memory.md)    | Esv3, Ev3, M, GS, G, DSv2, DS, Dv2, D   | Высокое соотношение ресурсов памяти и числа ядер. Отлично подходят для реляционных баз данных, кэша среднего и большого объема, а также выполняющейся в памяти аналитики.                 |
| [Оптимизированные для хранилища](../virtual-machines/sizes-storage.md)      | Ls                | Высокая пропускная способность дисков и количество операций ввода-вывода. Идеальный вариант для работы с большими данными, а также с базами данных SQL и NoSQL.                                                         |
| [GPU](../virtual-machines/sizes-gpu.md)          | NV, NC            | Специализированные виртуальные машины, предназначенные для ресурсоемкой отрисовки изображений и редактирования видео.       |
| [Высокопроизводительные](../virtual-machines/sizes-hpc.md) | H, A8–A11          | Виртуальные машины с самыми мощными ЦП, для которых можно настроить сетевые интерфейсы с высокой пропускной способностью (RDMA). 

### <a name="find-available-vm-instance-sizes"></a>Поиск доступных размеров экземпляров виртуальной машины
Чтобы просмотреть список доступных размеров экземпляров виртуальных машин в определенном регионе, выполните команду [az vm list-sizes](/cli/azure/vm).

```azurecli-interactive
az vm list-sizes --location eastus --output table
```

Вывод команды будет примерно таким, как в следующем сокращенном примере, в котором показаны ресурсы, назначенные каждому размеру виртуальной машины:

```output
  MaxDataDiskCount    MemoryInMb  Name                      NumberOfCores    OsDiskSizeInMb    ResourceDiskSizeInMb
------------------  ------------  ----------------------  ---------------  ----------------  ----------------------
                 4          3584  Standard_DS1_v2                       1           1047552                    7168
                 8          7168  Standard_DS2_v2                       2           1047552                   14336
[...]
                 1           768  Standard_A0                           1           1047552                   20480
                 2          1792  Standard_A1                           1           1047552                   71680
[...]
                 4          2048  Standard_F1                           1           1047552                   16384
                 8          4096  Standard_F2                           2           1047552                   32768
[...]
                24         57344  Standard_NV6                          6           1047552                   38912
                48        114688  Standard_NV12                        12           1047552                  696320
```

### <a name="create-a-scale-set-with-a-specific-vm-instance-size"></a>Создание масштабируемого набора с экземпляром виртуальной машины определенного размера
При создании масштабируемого набора в начале этого руководство для экземпляров виртуальной машины был указан стандартный номер SKU виртуальной машины *Standard_D1_v2*. Вы можете указать другой размер экземпляра виртуальной машины на основе выходных данных команды [az vm list-sizes](/cli/azure/vm). В указанном ниже примере будет создан масштабируемый набор с использованием параметра `--vm-sku`, который позволяет указать размер экземпляра виртуальной машины *Standard_F1*. Так как создание и настройка всех ресурсов и экземпляров виртуальных машин масштабируемого набора занимает несколько минут, вам не нужно развертывать следующий масштабируемый набор.

```azurecli-interactive
az vmss create \
  --resource-group myResourceGroup \
  --name myScaleSetF1Sku \
  --image UbuntuLTS \
  --vm-sku Standard_F1 \
  --admin-user azureuser \
  --generate-ssh-keys
```


## <a name="change-the-capacity-of-a-scale-set"></a>Изменение емкости масштабируемого набора
При создании масштабируемого набора в начале этого руководства по умолчанию было развернуто два экземпляра. Вы можете указать параметр `--instance-count` в команде [az vmss create](/cli/azure/vmss), чтобы изменить число экземпляров, создаваемых в масштабируемом наборе. Чтобы увеличить или уменьшить число экземпляров виртуальных машин в имеющемся масштабируемом наборе, можно изменить его емкость вручную. Масштабируемый набор создает или удаляет необходимое количество экземпляров виртуальной машины, а затем настраивает подсистему балансировки нагрузки для распределения трафика.

Чтобы вручную увеличить или уменьшить число экземпляров виртуальных машин в масштабируемом наборе, выполните команду [az vmss scale](/cli/azure/vmss). В следующем примере число экземпляров виртуальных машин в масштабируемом наборе определяется равным *3*:

```azurecli-interactive
az vmss scale \
    --resource-group myResourceGroup \
    --name myScaleSet \
    --new-capacity 3
```

На обновление емкости масштабируемого набора требуется несколько минут. Чтобы просмотреть количество экземпляров, присутствующих в масштабируемом наборе, выполните команду [az vmss show](/cli/azure/vmss) и отправьте запрос для *sku.capacity*.

```azurecli-interactive
az vmss show \
    --resource-group myResourceGroup \
    --name myScaleSet \
    --query [sku.capacity] \
    --output table
```


## <a name="common-management-tasks"></a>Общие задачи управления
Теперь вы можете создать масштабируемый набор, вывести сведения о подключениях и подключиться к экземплярам виртуальных машин. Вы узнали, как использовать разные образы операционной системы для экземпляров виртуальных машин, выбирать разные размеры виртуальной машины и изменять количество экземпляров вручную. В рамках повседневных задач по управлению вам может понадобиться остановить, запустить или перезапустить экземпляры виртуальных машин в масштабируемом наборе.

### <a name="stop-and-deallocate-vm-instances-in-a-scale-set"></a>Остановка и освобождение экземпляров виртуальных машин в масштабируемом наборе
Чтобы остановить один или несколько экземпляров виртуальных машин в масштабируемом наборе, выполните команду [az vmss stop](/cli/azure/vmss). С помощью параметра `--instance-ids` можно указать один или несколько экземпляров виртуальной машины, которые нужно остановить. Если не указать идентификатор экземпляра, останавливаются все экземпляры виртуальных машин в масштабируемом наборе. Следующий пример останавливает экземпляр *1*.

```azurecli-interactive
az vmss stop --resource-group myResourceGroup --name myScaleSet --instance-ids 1
```

Остановленные экземпляры виртуальных машин остаются выделенными, и за них по-прежнему взимается плата за вычислительные операции. Если вместо этого требуется освободить экземпляры виртуальных машин, чтобы плата взималась только за хранение данных, выполните команду [az vmss deallocate](/cli/azure/vmss). Следующий пример останавливает и освобождает экземпляр *1*.

```azurecli-interactive
az vmss deallocate --resource-group myResourceGroup --name myScaleSet --instance-ids 1
```

### <a name="start-vm-instances-in-a-scale-set"></a>Запуск экземпляров виртуальных машин в масштабируемом наборе
Чтобы запустить один или несколько экземпляров виртуальных машин в масштабируемом наборе, выполните команду [az vmss start](/cli/azure/vmss). С помощью параметра `--instance-ids` можно указать один или несколько экземпляров виртуальных машин, которые нужно запустить. Если не указать идентификатор экземпляра, запускаются все экземпляры виртуальных машин в масштабируемом наборе. Следующий пример запускает экземпляр *1*.

```azurecli-interactive
az vmss start --resource-group myResourceGroup --name myScaleSet --instance-ids 1
```

### <a name="restart-vm-instances-in-a-scale-set"></a>Перезапуск экземпляров виртуальных машин в масштабируемом наборе
Чтобы перезапустить один или несколько экземпляров виртуальных машин в масштабируемом наборе, выполните команду [az vmss restart](/cli/azure/vmss). С помощью параметра `--instance-ids` можно указать один или несколько экземпляров виртуальных машин, которые нужно перезапустить. Если не указать идентификатор экземпляра, перезапускаются все экземпляры виртуальных машин в масштабируемом наборе. Следующий пример перезапускает экземпляр *1*.

```azurecli-interactive
az vmss restart --resource-group myResourceGroup --name myScaleSet --instance-ids 1
```


## <a name="clean-up-resources"></a>Очистка ресурсов
При удалении группы ресурсов будут также удалены все содержащиеся в ней ресурсы: экземпляры виртуальной машины, виртуальная сеть и диски. При использовании параметра `--no-wait` управление возвращается в командную строку без ожидания завершения операции. Параметр `--yes` подтверждает, что вы хотите удалить ресурсы без дополнительного запроса.

```azurecli-interactive
az group delete --name myResourceGroup --no-wait --yes
```


## <a name="next-steps"></a>Дальнейшие действия
Из этого руководства вы узнали, как создавать стандартный масштабируемый набор и выполнять задачи управления с помощью Azure CLI:

> [!div class="checklist"]
> * Создание масштабируемого набора виртуальных машин и подключение к нему.
> * Выбор и использование образов виртуальных машин
> * Просмотр и использование определенных размеров виртуальных машин
> * Масштабирование масштабируемого набора вручную.
> * Выполнение стандартных задач управления масштабируемым набором.

Перейдите к следующему руководству, чтобы узнать о дисках масштабируемого набора.

> [!div class="nextstepaction"]
> [Использование дисков данных с масштабируемыми наборами](tutorial-use-disks-cli.md)
