---
title: Защита экземпляров для экземпляров масштабируемых наборов виртуальных машин Azure
description: Узнайте, как защитить экземпляры масштабируемых наборов виртуальных машин Azure от операций изменения масштаба.
author: avirishuv
ms.author: avverma
ms.topic: conceptual
ms.service: virtual-machine-scale-sets
ms.subservice: instance-protection
ms.date: 02/26/2020
ms.reviewer: jushiman
ms.custom: avverma
ms.openlocfilehash: 8b331eaf52a0a97232d481dccfff932221cd5faa
ms.sourcegitcommit: 32e0fedb80b5a5ed0d2336cea18c3ec3b5015ca1
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/30/2021
ms.locfileid: "105933463"
---
# <a name="instance-protection-for-azure-virtual-machine-scale-set-instances"></a>Защита экземпляров для экземпляров масштабируемых наборов виртуальных машин Azure

Масштабируемые наборы виртуальных машин Azure обеспечивают более высокую эластичность рабочих нагрузок с помощью [автомасштабирования](virtual-machine-scale-sets-autoscale-overview.md), поэтому можно настроить условия увеличения и уменьшения горизонтального масштаба инфраструктуры. Масштабируемые наборы также позволяют централизованно администрировать, настраивать и обновлять большое количество виртуальных машин с помощью различных [политик обновления](virtual-machine-scale-sets-upgrade-scale-set.md#how-to-bring-vms-up-to-date-with-the-latest-scale-set-model). Вы можете настроить обновление для модели масштабируемого набора, и новая конфигурация будет автоматически применена к каждому экземпляру масштабируемого набора, если настроена политика автоматического или последовательного обновления.

Так как приложение обрабатывает трафик, возможны ситуации, когда требуется, чтобы определенные экземпляры обрабатывались не так, как остальная часть экземпляра масштабируемого набора. Например, некоторые экземпляры в масштабируемом наборе могут выполнять длительные операции, и вы не хотите, чтобы эти экземпляры масштабировались до завершения операций. Кроме того, несколько экземпляров в масштабируемом наборе может быть отведено для выполнения дополнительных или других задач. Эти "специальные" виртуальные машины нельзя изменять с помощью других экземпляров в масштабируемом наборе. Защита экземпляра предоставляет дополнительные меры контроля для применения этих и других сценариев в приложении.

В этой статье описывается, как применять различные возможности защиты для экземпляров масштабируемых наборов.

## <a name="types-of-instance-protection"></a>Типы защиты экземпляров
Масштабируемые наборы предоставляют два типа возможностей защиты экземпляров:

-   **Защита от уменьшения горизонтального масштаба**
    - Включается с помощью свойства **protectFromScaleIn** в экземпляре масштабируемого набора
    - Защищает экземпляр от уменьшения горизонтального масштаба, запущенного автомасштабированием
    - Операции с экземплярами, инициированные пользователем (включая удаление экземпляра), **не блокируются**
    - Операции, инициированные в масштабируемом наборе (обновление, повторное создание образа, освобождение и т. д.), **не блокируются**

-   **Защита от действий масштабируемого набора**
    - Включается с помощью свойства **protectFromScaleSetActions** в экземпляре масштабируемого набора
    - Защищает экземпляр от уменьшения горизонтального масштаба, запущенного автомасштабированием
    - Защищает экземпляр от операций, инициированных в масштабируемом наборе (обновление, повторное создание образа, освобождение и т. д.).
    - Операции с экземплярами, инициированные пользователем (включая удаление экземпляра), **не блокируются**
    - Удаление всего масштабируемого набора **не блокируется**

## <a name="protect-from-scale-in"></a>Защита от уменьшения горизонтального масштаба
Защиту экземпляра можно применить к экземплярам масштабируемого набора после их создания. Защита применяется и изменяется только в [модели экземпляра](virtual-machine-scale-sets-upgrade-scale-set.md#the-scale-set-vm-model-view), а не в [модели масштабируемого набора](virtual-machine-scale-sets-upgrade-scale-set.md#the-scale-set-model).

Существует несколько способов применения защиты от уменьшения горизонтального масштаба к экземплярам масштабируемого набора, как описано в примерах ниже.

### <a name="azure-portal"></a>Портал Azure

Вы можете применить защиту от уменьшения горизонтального масштаба к экземпляру в масштабируемом наборе с помощью портала Azure. Нельзя изменять более одного экземпляра одновременно. Повторите эти шаги для каждого экземпляра, который нужно защитить.
 
1. Перейдите к существующему масштабируемому набору виртуальных машин.
1. Выберите **Экземпляры** в меню слева, в разделе **Параметры**.
1. Выберите имя нужного экземпляра.
1. Перейдите на вкладку **Политика защиты**.
1. В колонке **Политика защиты** установите флажок **Защита от уменьшения горизонтального масштаба**.
1. Щелкните **Сохранить**. 

### <a name="rest-api"></a>REST API

В следующем примере применяется защита от уменьшения горизонтального масштаба для экземпляра в масштабируемом наборе.

```
PUT on `/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/virtualMachineScaleSets/{vmScaleSetName}/virtualMachines/{instance-id}?api-version=2019-03-01`
```

```json
{
  "properties": {
    "protectionPolicy": {
      "protectFromScaleIn": true
    }
  }        
}

```

> [!NOTE]
>Защита экземпляра поддерживается только с API версии 2019-03-01 и более поздней

### <a name="azure-powershell"></a>Azure PowerShell

Используйте командлет [Update-AzVmssVM](/powershell/module/az.compute/update-azvmssvm), чтобы применить защиту от масштабирования к экземпляру масштабируемого набора.

В следующем примере применяется защита от уменьшения горизонтального масштаба для экземпляра в масштабируемом наборе с идентификатором 0.

```azurepowershell-interactive
Update-AzVmssVM `
  -ResourceGroupName "myResourceGroup" `
  -VMScaleSetName "myVMScaleSet" `
  -InstanceId 0 `
  -ProtectFromScaleIn $true
```

### <a name="azure-cli-20"></a>Azure CLI 2.0

Используйте командлет [az vmss update](/cli/azure/vmss#az-vmss-update), чтобы применить защиту от масштабирования к экземпляру масштабируемого набора.

В следующем примере применяется защита от уменьшения горизонтального масштаба для экземпляра в масштабируемом наборе с идентификатором 0.

```azurecli-interactive
az vmss update \  
  --resource-group <myResourceGroup> \
  --name <myVMScaleSet> \
  --instance-id 0 \
  --protect-from-scale-in true
```

## <a name="protect-from-scale-set-actions"></a>Защита от действий масштабируемого набора
Защиту экземпляра можно применить к экземплярам масштабируемого набора после их создания. Защита применяется и изменяется только в [модели экземпляра](virtual-machine-scale-sets-upgrade-scale-set.md#the-scale-set-vm-model-view), а не в [модели масштабируемого набора](virtual-machine-scale-sets-upgrade-scale-set.md#the-scale-set-model).

Защита экземпляра от действий масштабируемого набора также защищает экземпляр от масштабирования, инициированного автомасштабированием.

Существует несколько способов применения защиты от действий к экземплярам масштабируемого набора, как описано в примерах ниже.

### <a name="azure-portal"></a>Портал Azure

Вы можете применить защиту от действий масштабируемого набора к экземпляру в масштабируемом наборе с помощью портала Azure. Нельзя изменять более одного экземпляра одновременно. Повторите эти шаги для каждого экземпляра, который нужно защитить.
 
1. Перейдите к существующему масштабируемому набору виртуальных машин.
1. Выберите **Экземпляры** в меню слева, в разделе **Параметры**.
1. Выберите имя нужного экземпляра.
1. Перейдите на вкладку **Политика защиты**.
1. В колонке **Политика защиты** установите флажок **Защита от действий масштабируемого набора**.
1. Щелкните **Сохранить**. 

### <a name="rest-api"></a>REST API

В следующем примере применяется защита от действий масштабируемого набора для экземпляра в масштабируемом наборе.

```
PUT on `/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/virtualMachineScaleSets/{vMScaleSetName}/virtualMachines/{instance-id}?api-version=2019-03-01`
```

```json
{
  "properties": {
    "protectionPolicy": {
      "protectFromScaleIn": true,
      "protectFromScaleSetActions": true
    }
  }        
}

```

> [!NOTE]
>Защита экземпляра поддерживается только с API версии 2019-03-01 и более поздней.</br>
Защита экземпляра от действий масштабируемого набора также защищает экземпляр от масштабирования, инициированного автомасштабированием. Нельзя указать для параметра protectFromScaleIn значение false, если для параметра protectFromScaleSetActions задано значение true

### <a name="azure-powershell"></a>Azure PowerShell

Используйте командлет [Update-AzVmssVM](/powershell/module/az.compute/update-azvmssvm), чтобы применить защиту от действий масштабируемого набора к экземпляру масштабируемого набора.

В следующем примере применяется защита от действий масштабируемого набора для экземпляра в масштабируемом наборе с идентификатором 0.

```azurepowershell-interactive
Update-AzVmssVM `
  -ResourceGroupName "myResourceGroup" `
  -VMScaleSetName "myVMScaleSet" `
  -InstanceId 0 `
  -ProtectFromScaleIn $true `
  -ProtectFromScaleSetAction $true
```

### <a name="azure-cli-20"></a>Azure CLI 2.0

Используйте командлет [az vmss update](/cli/azure/vmss#az-vmss-update), чтобы применить защиту от действий масштабируемого набора к экземпляру масштабируемого набора.

В следующем примере применяется защита от действий масштабируемого набора для экземпляра в масштабируемом наборе с идентификатором 0.

```azurecli-interactive
az vmss update \  
  --resource-group <myResourceGroup> \
  --name <myVMScaleSet> \
  --instance-id 0 \
  --protect-from-scale-in true \
  --protect-from-scale-set-actions true
```

## <a name="troubleshoot"></a>Диагностика
### <a name="no-protectionpolicy-on-scale-set-model"></a>Отсутствие protectionPolicy в модели масштабируемого набора
Защита экземпляра применима только к экземплярам масштабируемых наборов, а не к модели масштабируемого набора.

### <a name="no-protectionpolicy-on-scale-set-instance-model"></a>Отсутствие protectionPolicy в модели экземпляра масштабируемого набора
По умолчанию политика защиты не применяется к экземпляру при его создании.

Защиту экземпляра можно применить к экземплярам масштабируемого набора после их создания.

### <a name="not-able-to-apply-instance-protection"></a>Не удается применить защиту экземпляра
Защита экземпляра поддерживается только с API версии 2019-03-01 и более поздней. Проверьте используемую версию API и обновите ее при необходимости. Возможно, также потребуется обновить PowerShell или CLI до последней версии.

## <a name="next-steps"></a>Дальнейшие действия
Узнайте, как [развертывать приложение](virtual-machine-scale-sets-deploy-app.md) в масштабируемых наборах виртуальных машин.
