---
title: Создание масштабируемого набора, использующего виртуальные машины Azure
description: Узнайте, как создавать масштабируемые наборы виртуальных машин Azure, использующие виртуальные машины Azure для сохранения затрат.
author: JagVeerappan
ms.author: jagaveer
ms.topic: how-to
ms.service: virtual-machine-scale-sets
ms.subservice: spot
ms.date: 02/26/2021
ms.reviewer: cynthn
ms.custom: devx-track-azurecli, devx-track-azurepowershell
ms.openlocfilehash: ec73d1363fb18d1d6c46589fe69879a8f6df1dab
ms.sourcegitcommit: e6de1702d3958a3bea275645eb46e4f2e0f011af
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "104722571"
---
# <a name="azure-spot-virtual-machines-for-virtual-machine-scale-sets"></a>Виртуальные машины Azure для масштабируемых наборов виртуальных машин 

Использование виртуальных машин Azure для размещения в масштабируемых наборах позволяет использовать преимущества нашей неиспользуемой емкости с значительной экономией затрат. В любой момент, когда Azure нужна емкость, инфраструктура Azure выполнит исключение экземпляров виртуальных машин Azure. Таким образом, экземпляры виртуальных машин Azure для рабочих нагрузок отлично подходят для рабочей нагрузки, которая может обрабатывать прерывания, такие как задания пакетной обработки, среды разработки и тестирования, большие вычислительные рабочие нагрузки и многое другое.

Объем доступной емкости может варьироваться в зависимости от размера, региона, времени суток и других параметров. При развертывании экземпляров виртуальных машин точки Azure в масштабируемых наборах Azure выделит экземпляр только при наличии доступной емкости, но соглашение об уровне обслуживания для этих экземпляров отсутствует. Масштабируемый набор виртуальных машин Azure развернут в одном домене сбоя и не предоставляет гарантии высокого уровня доступности.


## <a name="pricing"></a>Цены

Цены на экземпляры виртуальных машин Azure для точки на основе региона и SKU. Дополнительные сведения см. в статье цены на [Linux](https://azure.microsoft.com/pricing/details/virtual-machine-scale-sets/linux/) и [Windows](https://azure.microsoft.com/pricing/details/virtual-machine-scale-sets/windows/). 


С помощью переменных цен вы можете задать максимальную цену (в долларах США), используя до пяти десятичных разрядов. Например, значение `0.98765` определяет максимальную цену 0,98765 долларов США в час. Если для параметра Максимальная цена задано значение `-1` , то экземпляр не будет удален на основе цены. Ценой для экземпляра будет текущая цена на виртуальную машину Azure для машинного типа или цена на стандартный экземпляр, которая когда-либо будет меньше, если есть доступная емкость и квота.


## <a name="limitations"></a>Ограничения

Следующие размеры не поддерживаются для виртуальных машин Azure на месте:
 - Серия B
 - Рекламные версии любого размера (например, рекламные размеры Dv2, NV, NC и H)

Виртуальную машину для точки Azure можно развернуть в любом регионе, кроме Microsoft Azure Китая 21Vianet.

<a name="channel"></a>

В настоящее время поддерживаются следующие [типы предложений](https://azure.microsoft.com/support/legal/offer-details/) :

-   Соглашение Enterprise
-   Код предложения с оплатой по мере использования (003P)
-   Спонсорские (0036P и 0136P)
- Для поставщика облачных служб (CSP) обратитесь к [центру партнеров](/partner-center/azure-plan-get-started) или непосредственно обратитесь к своему партнеру.

## <a name="eviction-policy"></a>Политика вытеснения

При создании масштабируемого набора с помощью виртуальных машин Azure в качестве политики вытеснения можно задать отмену *выделения* (по умолчанию) или *Удалить*. 

Политика *освобождения* перемещает вытесненные экземпляры в остановленное состояние, что позволяет повторно развертывать исключенные экземпляры. Однако нет гарантии, что распределение будет выполнено успешно. Виртуальные машины, распределение которых отменено, будут учитываться в квоте экземпляра масштабируемого набора, и вам будет выставлен счет за базовые диски. 

Если вы хотите, чтобы экземпляры удалялись при их удалении, можно задать политику вытеснения для *удаления*. Если установлена политика вытеснения с действием удаления, то можно создавать новые виртуальные машины, увеличивая свойство количества экземпляров масштабируемого набора. Вытесненные виртуальные машины удаляются вместе с их базовыми дисками, и поэтому вы не будете платить за хранение. Также можно использовать функцию автомасштабирования масштабируемых наборов, чтобы автоматически попытаться компенсировать вытесненные виртуальные машины, однако нет гарантии, что распределение будет успешным. Рекомендуется использовать функцию автомасштабирования в масштабируемых наборах виртуальных машин Azure, если политика вытеснения будет удалена, чтобы избежать затрат на использование дисков и предельных квот. 

Пользователи могут принять участие в получении уведомлений в виртуальной машине с помощью [Azure запланированные события](../virtual-machines/linux/scheduled-events.md). Вы получите информацию о предстоящем вытеснении виртуальных машин, и у вас будет 30 секунд до вытеснения для завершения всех заданий и корректной остановки работы. 

<a name="bkmk_try"></a>
## <a name="try--restore-preview"></a>Попробуйте & восстановить (Предварительная версия)

Эта новая функция уровня платформы будет использовать AI, чтобы автоматически попытаться восстановить удаленные экземпляры виртуальных машин Azure в масштабируемом наборе для поддержания числа целевых экземпляров. 

> [!IMPORTANT]
> Пробная версия & восстановления в настоящее время доступна в общедоступной предварительной версии.
> Эта предварительная версия предоставляется без соглашения об уровне обслуживания и не рекомендована для использования рабочей среде. Некоторые функции могут не поддерживаться или их возможности могут быть ограничены. Дополнительные сведения см. в статье [Дополнительные условия использования предварительных выпусков Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).

Попробуйте & восстановить преимущества:
- Пытается восстановить виртуальные машины Azure, исключенные из-за емкости.
- Ожидается, что восстановленные виртуальные машины Azure будут выполняться дольше, чем вероятность вытеснений с повышенной вероятностью.
- Увеличивает время существования виртуальной машины в точке Azure, поэтому рабочие нагрузки выполняются дольше.
- Помогает масштабируемым наборам виртуальных машин поддерживать целевое количество виртуальных машин Azure, аналогично функции "вести подсчет целевых объектов", которая уже существует для виртуальных машин с оплатой по мере использования.

Попробуйте & восстановление отключено в масштабируемых наборах, использующих [Автомасштабирование](virtual-machine-scale-sets-autoscale-overview.md). Количество виртуальных машин в масштабируемом наборе определяется правилами автомасштабирования.

### <a name="register-for-try--restore"></a>Регистрация для восстановления & try

Перед использованием функции "попробовать & восстановление" необходимо зарегистрировать подписку для предварительной версии. Для завершения регистрации может потребоваться несколько минут. Для завершения регистрации компонентов можно использовать Azure CLI или PowerShell.


**Использование CLI**

Чтобы включить предварительную версию подписки, используйте команду [AZ Feature Register](/cli/azure/feature#az-feature-register) . 

```azurecli-interactive
az feature register --namespace Microsoft.Compute --name SpotTryRestore 
```

Регистрация компонентов может занять до 15 минут. Чтобы проверить состояние регистрации, сделайте следующее: 

```azurecli-interactive
az feature show --namespace Microsoft.Compute --name SpotTryRestore 
```

После регистрации функции для подписки завершите процесс согласия, добавив изменения в поставщик ресурсов вычислений. 

```azurecli-interactive
az provider register --namespace Microsoft.Compute 
```
**Использование PowerShell** 

Используйте командлет [Register-азпровидерфеатуре](/powershell/module/az.resources/register-azproviderfeature) , чтобы включить предварительную версию для подписки. 

```azurepowershell-interactive
Register-AzProviderFeature -FeatureName SpotTryRestore -ProviderNamespace Microsoft.Compute 
```

Регистрация компонентов может занять до 15 минут. Чтобы проверить состояние регистрации, сделайте следующее: 

```azurepowershell-interactive
Get-AzProviderFeature -FeatureName SpotTryRestore -ProviderNamespace Microsoft.Compute 
```

После регистрации функции для подписки завершите процесс согласия, добавив изменения в поставщик ресурсов вычислений. 

```azurepowershell-interactive
Register-AzResourceProvider -ProviderNamespace Microsoft.Compute 
```

## <a name="placement-groups"></a>Группы размещения

Группа размещения — это конструкция, аналогичная группе доступности Azure с собственными доменами сбоя и доменами обновления. По умолчанию масштабируемый набор содержит одну группу размещения максимум со 100 виртуальными машинами. Если свойство масштабируемого набора `singlePlacementGroup` имеет значение *false*, масштабируемый набор может состоять из нескольких групп размещения и иметь диапазон от 0 до 1000 виртуальных машин. 

> [!IMPORTANT]
> Если вы не используете InfiniBand с HPC, настоятельно рекомендуется установить свойство масштабируемого набора `singlePlacementGroup` в *значение false* , чтобы включить несколько групп размещения для более эффективного масштабирования по регионам или зонам. 

## <a name="deploying-azure-spot-virtual-machines-in-scale-sets"></a>Развертывание виртуальных машин Azure на месте в масштабируемых наборах

Чтобы развернуть виртуальные машины Azure в масштабируемых наборах, можно установить для нового флага *приоритета* значение " *плашечная*". Все виртуальные машины в масштабируемом наборе будут иметь значение "точечная". Чтобы создать масштабируемый набор с помощью виртуальных машин Azure, используйте один из следующих методов.
- [Портал Azure](#portal)
- [Azure CLI](#azure-cli)
- [Azure PowerShell](#powershell)
- [Шаблоны диспетчера ресурсов Azure](#resource-manager-templates)

## <a name="portal"></a>Портал

Процесс создания масштабируемого набора, использующего виртуальные машины Azure, аналогичен описанному в [статье Приступая к работе](quick-create-portal.md). При развертывании масштабируемого набора можно задать параметр точки, а политика вытеснения — ![ создать масштабируемый набор с помощью виртуальных машин Azure.](media/virtual-machine-scale-sets-use-spot/vmss-spot-portal-max-price.png)


## <a name="azure-cli"></a>Azure CLI

Процесс создания масштабируемого набора с помощью виртуальных машин Azure на месте аналогичен описанному в [статье Приступая к работе](quick-create-cli.md). Просто добавьте точку с приоритетом "--Priority" и добавьте `--max-price` . В этом примере мы используем `-1` для, `--max-price` чтобы экземпляр не был исключен на основе цены.

```azurecli
az vmss create \
    --resource-group myResourceGroup \
    --name myScaleSet \
    --image UbuntuLTS \
    --upgrade-policy-mode automatic \
    --single-placement-group false \
    --admin-username azureuser \
    --generate-ssh-keys \
    --priority Spot \
    --max-price -1 
```

## <a name="powershell"></a>PowerShell

Процесс создания масштабируемого набора с помощью виртуальных машин Azure на месте аналогичен описанному в [статье Приступая к работе](quick-create-powershell.md).
Просто добавьте точку с приоритетом и укажите `-max-price` для [New-азвмссконфиг](/powershell/module/az.compute/new-azvmssconfig).

```powershell
$vmssConfig = New-AzVmssConfig `
    -Location "East US 2" `
    -SkuCapacity 2 `
    -SkuName "Standard_DS2" `
    -UpgradePolicyMode Automatic `
    -Priority "Spot" `
    -max-price -1
```

## <a name="resource-manager-templates"></a>Шаблоны Resource Manager

Процесс создания масштабируемого набора, использующего виртуальные машины Azure, аналогичен описанному в статье Приступая к работе для [Linux](quick-create-template-linux.md) или [Windows](quick-create-template-windows.md). 

Для развертывания шаблона виртуальной машины Azure выберите `"apiVersion": "2019-03-01"` или более поздней версии. 

Добавьте `priority` `evictionPolicy` `billingProfile` Свойства и в `"virtualMachineProfile":` раздел и `"singlePlacementGroup": false,` свойство в `"Microsoft.Compute/virtualMachineScaleSets"` раздел шаблона.

```json

{
  "type": "Microsoft.Compute/virtualMachineScaleSets",
  },
  "properties": {
    "singlePlacementGroup": false,
    }

        "virtualMachineProfile": {
              "priority": "Spot",
                "evictionPolicy": "Deallocate",
                "billingProfile": {
                    "maxPrice": -1
                }
            },
```

Чтобы удалить экземпляр после его исключения, измените значение `evictionPolicy` параметра на `Delete` .


## <a name="simulate-an-eviction"></a>Имитация вытеснения

Вы можете [имитировать вытеснение](/rest/api/compute/virtualmachines/simulateeviction) виртуальной машины Azure, чтобы проверить, насколько хорошо ваше приложение будет реагировать на внезапное вытеснение. 

Замените следующие сведения: 

- `subscriptionId`
- `resourceGroupName`
- `vmName`


```rest
POST https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/virtualMachines/{vmName}/simulateEviction?api-version=2020-06-01
```

`Response Code: 204` означает, что имитация вытеснения прошла успешно. 

## <a name="faq"></a>Вопросы и ответы

**Вопрос.** После создания виртуальный экземпляр виртуальной машины Azure совпадает со стандартным экземпляром?

Ответ **.** Да, за исключением соглашений об уровне обслуживания для виртуальных машин Azure, которые можно удалить в любое время.


**Вопрос.** Что делать, если вытеснена виртуальная машина, а емкость по-прежнему нужна?

Ответ **.** Мы рекомендуем использовать стандартные виртуальные машины вместо виртуальных машин Azure на месте, если вам нужна достаточная емкость.


**Вопрос.** Как квота управляет виртуальной машиной Azure на месте?

Ответ **.** Экземпляры виртуальных машин и экземпляры Standard в Azure будут иметь отдельные пулы квот. Квота виртуальной машины для точки Azure будет совместно использоваться между виртуальными машинами и экземплярами масштабируемых наборов. Дополнительные сведения см. в статье [Подписка Azure, границы, квоты и ограничения службы](../azure-resource-manager/management/azure-subscription-service-limits.md).


**Вопрос.** Можно ли запросить дополнительную квоту для виртуальной машины Azure на месте?

Ответ **.** Да, вы сможете отправить запрос на увеличение квоты виртуальных машин Azure с помощью [стандартного процесса запроса квоты](../azure-portal/supportability/per-vm-quota-requests.md).


**Вопрос.** Можно ли преобразовать существующие масштабируемые наборы в масштабируемые наборы виртуальных машин Azure?

Ответ **.** Нет, установка `Spot` флага поддерживается только во время создания.


**Вопрос.** Если я использовался `low` для масштабируемых наборов с низким приоритетом, мне нужно начать использовать `Spot` вместо этого?

Ответ **.** Пока `low` и, и `Spot` будет работать, но следует начать переход на использование `Spot` .


**Вопрос.** Можно ли создать масштабируемый набор с обычными ВМ и виртуальными машинами Azure?

Ответ **.** Нет, масштабируемый набор не поддерживает более одного типа приоритета.


**Вопрос.**  Можно ли использовать Автомасштабирование для масштабируемых наборов виртуальных машин Azure?

Ответ **.** Да, вы можете задать правила автоматического масштабирования в масштабируемом наборе виртуальных машин Azure. Если виртуальные машины исключены, автомасштабирование может попытаться создать новые виртуальные машины Azure. Однако помните, что получение этой емкости не гарантируется. 


**Вопрос.**  Работает ли автомасштабирование с обеими политиками вытеснения (освобождение и удаление)?

Ответ **.** Да, но при использовании автомасштабирования рекомендуется задать удаление политики вытеснения. Причина этого состоит в том, что экземпляры, распределение которых отменено, учитываются в емкости масштабируемого набора. При использовании автомасштабирования, скорее всего, вы быстро достигнете целевого количества из-за вытесненных экземпляров, распределение которых отменено. Кроме того, операции масштабирования могут повлиять на выполнение точечных вытеснений. Например, экземпляры масштабируемого набора виртуальных машин могут попадать под число минут, заданное в результате нескольких расвытеснений во время операций масштабирования. 


**Вопрос.** Где можно задать вопрос?

**Ответ.** Разместите вопрос с тегом `azure-spot` в разделе [вопросов и ответов](/answers/topics/azure-spot.html). 

## <a name="next-steps"></a>Следующие шаги

Ознакомьтесь со сведениями о ценах на [странице для определения тарифа масштабируемых наборов виртуальных машин](https://azure.microsoft.com/pricing/details/virtual-machine-scale-sets/linux/).
