---
title: Создание масштабируемого набора Azure, использующего Зоны доступности
description: Узнайте, как создавать масштабируемые наборы виртуальных машин Azure, которые используют зоны доступности для повышения избыточности и минимизации простоев
author: mimckitt
ms.author: mimckitt
ms.topic: conceptual
ms.service: virtual-machine-scale-sets
ms.subservice: availability
ms.date: 08/08/2018
ms.reviewer: jushiman
ms.custom: mimckitt, devx-track-azurecli
ms.openlocfilehash: c5ddd5846be91e9fc99a251d6ad45ade8bde2937
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "96016664"
---
# <a name="create-a-virtual-machine-scale-set-that-uses-availability-zones"></a>Создание масштабируемого набора Azure, который использует зоны доступности

Чтобы предотвратить сбои масштабируемых наборов виртуальных машин на уровне центра обработки данных, можно создать масштабируемые наборы в зонах доступности. Регионы Azure, которые поддерживают зоны доступности, имеют по крайней мере три отдельные зоны, для каждой из которых предусмотрены собственные независимые источники питания, сети и системы охлаждения. Дополнительные сведения см. в статье [Общие сведения о зонах доступности в Azure (предварительная версия)](../availability-zones/az-overview.md).

## <a name="availability-considerations"></a>Вопросы доступности

При развертывании регионального масштабируемого набора (не зональные) в одной или нескольких зонах, начиная с версии API *2017-12-01*, доступны следующие варианты доступности.
- Максимальное распространение (platformFaultDomainCount = 1)
- Статическое фиксированное распространение (platformFaultDomainCount = 5)
- Распространение по доменам сбоя дисков хранилища (Платфорфаултдомаинкаунт = 2 или 3)

Если выбрать максимальное распространение, масштабируемый набор распределяет виртуальные машины между максимальным количеством доступных доменов сбоя в каждой зоне. Это может быть больше или меньше пяти доменов сбоя на зону. Благодаря статическому фиксированному распространению масштабируемый набор распределяет виртуальные машины в пределах пяти доменов сбоя на каждую зону. Если масштабируемому набору не удается найти 5 отдельных доменов сбоя в каждой зоне для удовлетворения запроса на распределение, запрос завершится ошибкой.

**Для большинства рабочих нагрузок рекомендуется вариант развертывания с использованием максимального распространения**, так как этот подход обеспечивает лучшее распространение. Если необходимо, чтобы реплики распространялись между отдельными изолированными аппаратными блоками, рекомендуется распространять их между несколькими доступными зонами и использовать максимальное распространение в каждой зоне.

> [!NOTE]
> При максимальном распространении в представлении экземпляра масштабируемого набора виртуальных машин и в метаданных экземпляра отображается только один домен сбоя, независимо от количества доменов сбоя, по которым распределены виртуальные машины. Распределение в каждой зоне является неявным.

### <a name="placement-groups"></a>Группы размещения

При развертывании масштабируемого набора можно выбрать развертывание с одной или несколькими [группами размещения](./virtual-machine-scale-sets-placement-groups.md) на зону доступности. Для региональных масштабируемых наборов (не зональные) выбор должен иметь одну группу размещения в регионе или иметь несколько в регионе. Для большинства рабочих нагрузок рекомендуется несколько групп размещения, что обеспечивает лучшее масштабирование. В API версии *2017-12-01* масштабируемые наборы по умолчанию имеют несколько групп размещения для масштабируемых наборов с одной зоной и между зонами, но они по умолчанию используют одну группу размещения для региональных (не зональные) масштабируемых наборов.

> [!NOTE]
> При выборе максимального распределения необходимо использовать несколько групп размещения.

### <a name="zone-balancing"></a>Балансировка зоны

И наконец, для масштабируемых наборов, развернутых в нескольких зонах, также можно выбрать между вариантом наилучшей балансировки зон и строгой балансировки зон. Масштабируемый набор считается сбалансированным, если каждая зона имеет одинаковое количество виртуальных машин или +\\- 1 VM во всех остальных зонах для набора шкалы. Пример:

- Масштабируемый набор с 2 виртуальными машинами в зоне 1, 3 виртуальными машинами в зоне 2 и 3 виртуальными машинами в зоне 3 считается сбалансированным. Существует только одна зона с различным количеством виртуальных машин, и она только на 1 меньше, чем в других зонах. 
- Масштабируемый набор с 1 виртуальной машиной в зоне 1, 3 виртуальными машинами в зоне 2 и 3 виртуальными машинами в зоне 3 считается несбалансированным. Зона 1 имеет на 2 виртуальные машины меньшее, чем зоны 2 и 3.

Виртуальные машины в масштабируемом наборе могут быть успешно созданы, но развертывание расширения на этих виртуальных машинах завершится сбоем. Эти виртуальные машины с ошибкой расширения все еще будут учитываться в процессе определения того, является ли масштабируемый набор сбалансированным. Например, масштабируемый набор с 3 виртуальными машинами в зоне 1, 3 виртуальными машинами в зоне 2 и 3 виртуальными машинами в зоне 3 считается сбалансированным, даже если все расширения завершились ошибкой в зоне 1, а все расширения в зонах 2 и 3 были успешными.

При выборе наилучшей балансировки зон масштабируемый набор пытается выполнять свертывание и развертывание виртуальных машин, поддерживая баланс. Однако, если по какой-либо причине это невозможно (например, если одна зона выходит из строя, масштабируемый набор не сможет создать виртуальную машину в этой зоне), масштабируемый набор допускает временный дисбаланс для успешного масштабирования. При последующих попытках масштабирования масштабируемый набор добавляет виртуальные машины в зоны, которым требуется больше виртуальных машин для балансировки масштабируемого набора. Аналогичным образом при последующих попытках масштабирования масштабируемый набор удаляет виртуальные машины из зон, где их должно быть меньше. При использовании строгой балансировки зон масштабирование будет завершено ошибкой, если оно приведет к несбалансированному состоянию.

Чтобы использовать вариант наилучшей балансировки зон, установите для параметра *zoneBalance* значение *false*. Это значение установлено по умолчанию в версии API *2017-12-01*. Чтобы использовать ограниченный баланс зоны, установите для *zoneBalance* значение *true*.

## <a name="single-zone-and-zone-redundant-scale-sets"></a>Однозонные масштабируемые наборы и масштабируемые наборы, избыточные между зонами

При развертывании масштабируемого набора виртуальных машин можно использовать одну или несколько зон доступности в регионе.

Когда вы создаете масштабируемый набор в одной зоне, вы определяете, в какой зоне задействованы все экземпляры виртуальных машин, а управление масштабируемым набором и его автоматическое масштабирование осуществляется только в этой зоне. Масштабируемый набор, избыточный между зонами, позволяет создать единый масштабируемый набор в рамках нескольких зон. При создании экземпляров виртуальных машин по умолчанию они будут равномерно распределяется в пределах зон. Если прерывание происходит в одной из зон, масштабируемый набор не масштабируется автоматически для увеличения емкости. Лучше всего настроить правила автоматического масштабирования на основе использования ЦП или памяти. Правила автоматического масштабирования позволят масштабируемому набору реагировать на потерю экземпляров виртуальных машин в этой зоне путем развертывания новых экземпляров в остальных рабочих зонах.

Чтобы использовать зоны доступности, масштабируемый набор должен быть создан в [поддерживаемом регионе Azure](../availability-zones/az-region.md). Вы можете создать масштабируемый набор, использующий зоны доступности, с помощью одного из следующих методов:

- [Портал Azure](#use-the-azure-portal)
- Azure CLI
- [Azure PowerShell](#use-azure-powershell)
- [Шаблоны диспетчера ресурсов Azure](#use-azure-resource-manager-templates)

## <a name="use-the-azure-portal"></a>Использование портала Azure

Процесс создания масштабируемого набора, использующего зону доступности, описан в статье [Создание масштабируемого набора виртуальных машин с помощью Azure PowerShell](quick-create-portal.md). При выборе поддерживаемого региона Azure можно создать масштабируемый набор в одной или нескольких из доступных зон, как показано в следующем примере:

![Создание масштабируемого набора в одной зоне доступности](media/virtual-machine-scale-sets-use-availability-zones/vmss-az-portal.png)

Масштабируемый набор и вспомогательные ресурсы, такие как подсистема балансировки нагрузки Azure и общедоступный IP-адрес, создаются в одной зоне, указанной вами.

## <a name="use-the-azure-cli"></a>Использование Azure CLI

Процесс создания масштабируемого набора, использующего зону доступности, описан в статье [Создание масштабируемого набора виртуальных машин с помощью Azure PowerShell](quick-create-cli.md). Чтобы использовать зоны доступности, необходимо создать масштабируемый набор в поддерживаемом регионе Azure.

Добавьте параметр `--zones` в команду [az vmss create](/cli/azure/vmss) и укажите, какую зону использовать (например, зону *1*, *2* или *3*). В следующем примере создается однозонный масштабируемый набор *myScaleSet* в зоне *1*:

```azurecli
az vmss create \
    --resource-group myResourceGroup \
    --name myScaleSet \
    --image UbuntuLTS \
    --upgrade-policy-mode automatic \
    --admin-username azureuser \
    --generate-ssh-keys \
    --zones 1
```

Полный пример однозонного масштабируемого набора и сетевых ресурсов см. в этом [примере сценария CLI](https://github.com/Azure/azure-docs-cli-python-samples/blob/master/virtual-machine-scale-sets/create-single-availability-zone/create-single-availability-zone.sh).

### <a name="zone-redundant-scale-set"></a>Масштабируемый набор, избыточный между зонами

Чтобы создать масштабируемый набор, избыточный между зонами, используйте общедоступный IP-адрес и подсистему балансировки нагрузки с номером SKU *Стандартный*. Для повышения избыточности в рамках номера SKU *Стандартный* создаются сетевые ресурсы, избыточные между зонами. Дополнительные сведения см. в разделе [Обзор Azure Load Balancer уровня "Стандартный"](../load-balancer/load-balancer-overview.md) и [Azure Load Balancer уровня "Стандартный" и зоны доступности](../load-balancer/load-balancer-standard-availability-zones.md).

Чтобы создать масштабируемый набор, избыточный между зонами, укажите несколько зон с помощью параметра `--zones`. В следующем примере создается масштабируемый набор, избыточный между зонами, с именем *myScaleSet* в зонах *1, 2 и 3*:

```azurecli
az vmss create \
    --resource-group myResourceGroup \
    --name myScaleSet \
    --image UbuntuLTS \
    --upgrade-policy-mode automatic \
    --admin-username azureuser \
    --generate-ssh-keys \
    --zones 1 2 3
```

Создание и настройка всех ресурсов и виртуальных машин масштабируемого набора в указанных зонах занимает несколько минут. Полный пример масштабируемого набора, избыточного между зонами, и сетевых ресурсов см. в этом [примере сценария CLI](https://github.com/Azure/azure-docs-cli-python-samples/blob/master/virtual-machine-scale-sets/create-zone-redundant-scale-set/create-zone-redundant-scale-set.sh).

## <a name="use-azure-powershell"></a>Использование Azure PowerShell

Чтобы использовать зоны доступности, необходимо создать масштабируемый набор в поддерживаемом регионе Azure. Добавьте параметр `-Zone` в команду [New-AzVmssConfig](/powershell/module/az.compute/new-azvmssconfig) и укажите требуемую зону (например, *1*, *2* или *3*).

В следующем примере создается однозонный масштабируемый набор с именем *myScaleSet* в зоне *1* региона *Восточная часть США 2*. Сетевые ресурсы Azure для виртуальной сети, общедоступный IP-адрес и подсистема балансировки нагрузки создаются автоматически. При появлении запроса введите учетные данные администратора для экземпляров виртуальных машин в масштабируемом наборе:

```powershell
New-AzVmss `
  -ResourceGroupName "myResourceGroup" `
  -Location "EastUS2" `
  -VMScaleSetName "myScaleSet" `
  -VirtualNetworkName "myVnet" `
  -SubnetName "mySubnet" `
  -PublicIpAddressName "myPublicIPAddress" `
  -LoadBalancerName "myLoadBalancer" `
  -UpgradePolicy "Automatic" `
  -Zone "1"
```

### <a name="zone-redundant-scale-set"></a>Масштабируемый набор, избыточный между зонами

Чтобы создать масштабируемый набор, избыточный между зонами, укажите несколько зон с помощью параметра `-Zone`. В следующем примере создается масштабируемый набор, избыточный между зонами, с именем *myScaleSet* в зонах *1, 2 и 3* региона *Восточная часть США 2*. Сетевые ресурсы Azure, избыточные между зонами, для виртуальной сети, общедоступный IP-адрес и подсистема балансировки нагрузки создаются автоматически. При появлении запроса введите учетные данные администратора для экземпляров виртуальных машин в масштабируемом наборе:

```powershell
New-AzVmss `
  -ResourceGroupName "myResourceGroup" `
  -Location "EastUS2" `
  -VMScaleSetName "myScaleSet" `
  -VirtualNetworkName "myVnet" `
  -SubnetName "mySubnet" `
  -PublicIpAddressName "myPublicIPAddress" `
  -LoadBalancerName "myLoadBalancer" `
  -UpgradePolicy "Automatic" `
  -Zone "1", "2", "3"
```

## <a name="use-azure-resource-manager-templates"></a>Использование шаблонов Azure Resource Manager

Создание масштабируемого набора, использующего зону доступности, описано в статьях о начале работы для [Linux](quick-create-template-linux.md) или [Windows](quick-create-template-windows.md). Чтобы использовать зоны доступности, необходимо создать масштабируемый набор в поддерживаемом регионе Azure. Добавьте свойство `zones` в тип ресурса *Microsoft.Compute/virtualMachineScaleSets* в шаблон и укажите требуемую зону (например, *1*, *2* или *3*).

В следующем примере создается однозонный масштабируемый набор Linux с именем *myScaleSet* в зоне *1* региона *Восточная часть США 2*:

```json
{
  "type": "Microsoft.Compute/virtualMachineScaleSets",
  "name": "myScaleSet",
  "location": "East US 2",
  "apiVersion": "2017-12-01",
  "zones": ["1"],
  "sku": {
    "name": "Standard_A1",
    "capacity": "2"
  },
  "properties": {
    "upgradePolicy": {
      "mode": "Automatic"
    },
    "virtualMachineProfile": {
      "storageProfile": {
        "osDisk": {
          "caching": "ReadWrite",
          "createOption": "FromImage"
        },
        "imageReference":  {
          "publisher": "Canonical",
          "offer": "UbuntuServer",
          "sku": "16.04-LTS",
          "version": "latest"
        }
      },
      "osProfile": {
        "computerNamePrefix": "myvmss",
        "adminUsername": "azureuser",
        "adminPassword": "P@ssw0rd!"
      }
    }
  }
}
```

Полный пример однозонного масштабируемого набора и сетевых ресурсов см. в этом [примере шаблона Resource Manager](https://github.com/Azure/vm-scale-sets/blob/master/preview/zones/singlezone.json).

### <a name="zone-redundant-scale-set"></a>Масштабируемый набор, избыточный между зонами

Чтобы создать масштабируемый набор, избыточный между зонами, укажите несколько значений в свойстве `zones` типа ресурса *Microsoft.Compute/virtualMachineScaleSets*. В следующем примере создается масштабируемый набор, избыточный между зонами, с именем *myScaleSet* в зонах *1, 2 и 3* региона *Восточная часть США 2*:

```json
{
  "type": "Microsoft.Compute/virtualMachineScaleSets",
  "name": "myScaleSet",
  "location": "East US 2",
  "apiVersion": "2017-12-01",
  "zones": [
        "1",
        "2",
        "3"
      ]
}
```

При создании общедоступного IP-адреса или подсистемы балансировки нагрузки укажите свойство *"sku": { "name": "Standard" }"* для создания сетевых ресурсов, избыточных между зонами. Необходимо также создать группы безопасности сети и правила, чтобы разрешить любой трафик. Дополнительные сведения см. в разделе [Обзор Azure Load Balancer уровня "Стандартный"](../load-balancer/load-balancer-overview.md) и [Azure Load Balancer уровня "Стандартный" и зоны доступности](../load-balancer/load-balancer-standard-availability-zones.md).

Полный пример масштабируемого набора, избыточного между зонами, и сетевых ресурсов см. в этом [примере шаблона Resource Manager](https://github.com/Azure/vm-scale-sets/blob/master/preview/zones/multizone.json).

## <a name="next-steps"></a>Дальнейшие действия

После создания масштабируемого набора в зоне доступности см. статьи [Развертывание приложения в масштабируемых наборах виртуальных машин](tutorial-install-apps-cli.md) или [Обзор автомасштабирования с помощью масштабируемых наборов виртуальных машин Azure](tutorial-autoscale-cli.md).
