---
title: Прерывание уведомления для экземпляров масштабируемых наборов виртуальных машин Azure
description: Узнайте, как включить уведомление об увольнении для экземпляров масштабируемых наборов виртуальных машин Azure.
author: avirishuv
ms.author: avverma
ms.topic: conceptual
ms.service: virtual-machine-scale-sets
ms.subservice: management
ms.date: 02/26/2020
ms.reviewer: jushiman
ms.custom: avverma, devx-track-azurecli
ms.openlocfilehash: c4d6de1b3406e6d82bdac5ff9b5c72a2286da988
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "92747744"
---
# <a name="terminate-notification-for-azure-virtual-machine-scale-set-instances"></a>Прерывание уведомления для экземпляров масштабируемых наборов виртуальных машин Azure
Экземпляры масштабируемых наборов могут использовать для получения уведомлений об увольнении экземпляра и задать предопределенное время ожидания задержки для операции завершения. Уведомление об увольнении отправляется через службу метаданных Azure — [запланированные события](../virtual-machines/windows/scheduled-events.md), которая предоставляет уведомления для и задержки таких операций, как перезагрузка и повторное развертывание. Решение добавляет еще одно событие — завершение — в список Запланированные события, а связанная задержка события завершения будет зависеть от предельной задержки, заданной пользователями в конфигурации модели масштабируемого набора.

После регистрации в компоненте для экземпляров масштабируемого набора не требуется ждать истечения заданного времени ожидания до удаления экземпляра. После получения уведомления об увольнении экземпляр можно удалить в любое время до истечения времени ожидания завершения.

## <a name="enable-terminate-notifications"></a>Включить уведомления о прекращении
Существует несколько способов включения уведомлений об увольнении в экземплярах масштабируемого набора, как описано в примерах ниже.

### <a name="azure-portal"></a>Портал Azure

Следующие шаги включают уведомление о завершении при создании нового масштабируемого набора. 

1. Перейдите к **масштабируемым наборам виртуальных машин**.
1. Выберите **+ Добавить** , чтобы создать новый масштабируемый набор.
1. Перейдите на вкладку **Управление** . 
1. Откройте раздел **завершение экземпляра** .
1. Для **уведомления об окончании экземпляра** выберите **вкл**.
1. Для параметра **Задержка завершения (в минутах)** задайте требуемое время ожидания по умолчанию.
1. Завершив создание нового масштабируемого набора, нажмите кнопку " **проверить и создать** ". 

> [!NOTE]
> Не удается задать уведомления о прекращении работы в существующих масштабируемых наборах в портал Azure

### <a name="rest-api"></a>REST API

В следующем примере включается уведомление о завершении для модели масштабируемого набора.

```
PUT on `/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/virtualMachineScaleSets/{vmScaleSetName}?api-version=2019-03-01`
```

```json
{
  "properties": {
    "virtualMachineProfile": {
            "scheduledEventsProfile": {
                "terminateNotificationProfile": {
                    "notBeforeTimeout":"PT5M",
                    "enable":true
                }
            }
        }
    }        
}

```

Указанный выше блок задает задержку времени ожидания в 5 минут (как указано в *PT5M*) для любой операции завершения всех экземпляров в масштабируемом наборе. Поле *нотбефоретимеаут* может принимать любое значение от 5 до 15 минут в формате ISO 8601. Вы можете изменить время ожидания по умолчанию для операции завершения, изменив свойство *нотбефоретимеаут* в разделе *терминатенотификатионпрофиле* , описанном выше.

После включения *счедуледевентспрофиле* в модели масштабируемого набора и установки *нотбефоретимеаут* обновите отдельные экземпляры до [последней модели](virtual-machine-scale-sets-upgrade-scale-set.md#how-to-bring-vms-up-to-date-with-the-latest-scale-set-model) , чтобы отразить изменения.

> [!NOTE]
>Уведомления об увольнении в экземплярах масштабируемых наборов можно включить только с помощью API версии 2019-03-01 и выше.

### <a name="azure-powershell"></a>Azure PowerShell
При создании нового масштабируемого набора можно включить уведомления об увольнении в масштабируемом наборе с помощью командлета [New-азвмссконфиг](/powershell/module/az.compute/new-azvmssconfig) .

Этот пример скрипта проходит по созданию масштабируемого набора и связанных ресурсов с помощью файла конфигурации: [Создание полного масштабируемого набора виртуальных машин](./scripts/powershell-sample-create-complete-scale-set.md). Вы можете предоставить уведомление о прекращении настройки, добавив параметры *терминатесчедуледевентс* и *терминатесчедуледевентнотбефоретимеаутинминутес* в объект конфигурации для создания масштабируемого набора. В следующем примере функция включает время ожидания задержки в 10 минут.

```azurepowershell-interactive
New-AzVmssConfig `
  -Location "VMSSLocation" `
  -SkuCapacity 2 `
  -SkuName "Standard_DS2" `
  -UpgradePolicyMode "Automatic" `
  -TerminateScheduledEvents $true `
  -TerminateScheduledEventNotBeforeTimeoutInMinutes 10
```

Используйте командлет [Update-азвмсс](/powershell/module/az.compute/update-azvmss) , чтобы включить уведомления об увольнении в существующем масштабируемом наборе.

```azurepowershell-interactive
Update-AzVmss `
  -ResourceGroupName "myResourceGroup" `
  -VMScaleSetName "myScaleSet" `
  -TerminateScheduledEvents $true `
  -TerminateScheduledEventNotBeforeTimeoutInMinutes 15
```
Приведенный выше пример включает уведомления о прекращении для существующего масштабируемого набора и устанавливает время ожидания в 15 минут для события Terminate.

После включения запланированных событий в модели масштабируемого набора и установки времени ожидания обновите отдельные экземпляры до [последней модели](virtual-machine-scale-sets-upgrade-scale-set.md#how-to-bring-vms-up-to-date-with-the-latest-scale-set-model) , чтобы отразить изменения.

### <a name="azure-cli-20"></a>Azure CLI 2.0

В следующем примере показано, как включить уведомление об увольнении при создании нового масштабируемого набора.

```azurecli-interactive
az group create --name <myResourceGroup> --location <VMSSLocation>
az vmss create \
  --resource-group <myResourceGroup> \
  --name <myVMScaleSet> \
  --image UbuntuLTS \
  --admin-username <azureuser> \
  --generate-ssh-keys \
  --terminate-notification-time 10
```

В приведенном выше примере сначала создается группа ресурсов, а затем создается новый масштабируемый набор с включенными уведомлениями о прекращении по умолчанию для интервала в 10 минут.

В следующем примере показано, как включить уведомление о завершении в существующем масштабируемом наборе.

```azurecli-interactive
az vmss update \  
  --resource-group <myResourceGroup> \
  --name <myVMScaleSet> \
  --enable-terminate-notification true \
  --terminate-notification-time 10
```

## <a name="get-terminate-notifications"></a>Получение уведомлений о прекращении

Уведомления о прекращении доставки доставляются через [запланированные события](../virtual-machines/windows/scheduled-events.md), которая является службой метаданных Azure. Служба метаданных Azure предоставляет сведения о работающих виртуальных машинах через конечную точку REST, доступную из виртуальной машины. Эта информация доступна через IP-адрес, не поддерживающий маршрутизацию, поэтому он не предоставляется за пределами виртуальной машины.

Запланированные события включен для масштабируемого набора при первом выполнении запроса на события. Отложенный ответ можно ждать при первом вызове до двух минут. Периодически выполняйте запрос к конечной точке для обнаружения ближайших событий обслуживания и состояния текущих действий по обслуживанию.

Запланированные события отключено для масштабируемого набора, если экземпляры масштабируемых наборов не делают запрос в течение 24 часов.

### <a name="endpoint-discovery"></a>Обнаружение конечной точки
Для виртуальных машин с поддержкой виртуальной сети служба метаданных доступна из статического IP-адреса, не поддерживающего маршрутизацию, 169.254.169.254.

Полная конечная точка для последней версии службы "Запланированные события" выглядит так:
> 'http://169.254.169.254/metadata/scheduledevents?api-version=2019-01-01'

### <a name="query-response"></a>Ответ на запрос
Ответ содержит массив запланированных событий. Если это будет пустой массив, значит сейчас запланированных событий нет.

Если передаются запланированные события, массив событий в ответе выглядит так: Для события "Terminate" ответ будет выглядеть следующим образом:
```
{
    "DocumentIncarnation": {IncarnationID},
    "Events": [
        {
            "EventId": {eventID},
            "EventType": "Terminate",
            "ResourceType": "VirtualMachine",
            "Resources": [{resourceName}],
            "EventStatus": "Scheduled",
            "NotBefore": {timeInUTC},
        }
    ]
}
```
*Документинкарнатион* является ETag и предоставляет простой способ проверить, изменились ли полезные данные событий с момента последнего запроса.

Дополнительные сведения о каждом из полей см. в документации по Запланированные события для [Windows](../virtual-machines/windows/scheduled-events.md#event-properties) и [Linux](../virtual-machines/linux/scheduled-events.md#event-properties).

### <a name="respond-to-events"></a>Реагирование на события
После того как вы узнаете о предстоящем событии и выполнили логику для корректного завершения работы, вы можете утвердить это событие, сделав вызов POST в службу метаданных с кодом EventId. Вызов POST указывает Azure на возможность продолжения удаления виртуальной машины.

Ниже приведен JSON-код, ожидаемый в тексте запроса POST. Запрос должен содержать список Стартрекуестс. Каждый Стартрекуест содержит EventId для события, которое вы хотите ускорить:
```
{
    "StartRequests" : [
        {
            "EventId": {EventId}
        }
    ]
}
```

Убедитесь, что каждая виртуальная машина в масштабируемом наборе утверждает только события EventID, относящиеся только к этой виртуальной машине. Виртуальная машина может получить собственное имя виртуальной машины [через метаданные экземпляра](virtual-machine-scale-sets-instance-ids.md#instance-metadata-vm-name). Это имя имеет вид "{Scale-set-name} _ {Instance-ID}" и будет отображаться в разделе "Resources" в ответе на запрос, описанном выше.

Вы также можете ознакомиться со сценариями примеров для запроса и реагирования на события [Python](../virtual-machines/linux/scheduled-events.md#python-sample).

## <a name="tips-and-best-practices"></a>Советы и рекомендации
-   Прерывать уведомления только для операций "Delete" — все операции удаления (горизонтальное удаление или автоматическое масштабирование, инициированное вручную) будут создавать события завершения, если масштабируемый набор включен *счедуледевентспрофиле* . Другие операции, такие как перезагрузка, пересоздание образа, повторное развертывание, остановка и освобождение, не создают события завершения. Невозможно включить уведомления о прекращении для виртуальных машин с низким приоритетом.
-   Нет обязательного ожидания для времени ожидания — можно запустить операцию завершения в любое время после получения события и до истечения времени *NotBefore* события.
-   Обязательное удаление во время ожидания — отсутствует возможность расширения значения времени ожидания после создания события. По истечении времени ожидания будет обработано событие ожидания завершения, и виртуальная машина будет удалена.
-   Изменяемое значение времени ожидания — вы можете изменить значение времени ожидания в любое время до удаления экземпляра, изменив свойство *нотбефоретимеаут* в модели масштабируемого набора и обновив экземпляры виртуальной машины до последней модели.
-   Утвердить все ожидающие удаления — если имеется Ожидающее удаление в VM_1, которое не было утверждено, и вы утвердили другое событие Terminate на VM_2, то VM_2 не удаляется до тех пор, пока не будет утверждено событие завершения для VM_1 или истекло время его ожидания. После утверждения события Terminate для VM_1 удаляются и VM_1, и VM_2.
-   Утвердить все одновременные удаления — расширение приведенного выше примера, если VM_1 и VM_2 имеют одинаковое *NotBefore* время, то оба события завершения должны быть утверждены или ни одна виртуальная машина не будет удалена до истечения времени ожидания.

## <a name="troubleshoot"></a>Диагностика
### <a name="failure-to-enable-scheduledeventsprofile"></a>Не удалось включить Счедуледевентспрофиле
Если возникает ошибка "BadRequest" с сообщением об ошибке "не удалось найти член" Счедуледевентспрофиле "для объекта типа" VirtualMachineProfile "", проверьте версию API, используемую для операций масштабируемого набора. Требуется API вычислений версии **2019-03-01** или более поздней. 

### <a name="failure-to-get-terminate-events"></a>Не удалось получить события завершения
Если вы не получаете события **завершения** через запланированные события, проверьте версию API, используемую для получения событий. Для завершения событий требуется API службы метаданных версии **2019-01-01** или более поздней.
>'http://169.254.169.254/metadata/scheduledevents?api-version=2019-01-01'

### <a name="getting-terminate-event-with-incorrect-notbefore-time"></a>Получение события завершения с неправильным временем NotBefore  
После включения *счедуледевентспрофиле* в модели масштабируемого набора и установки *нотбефоретимеаут* обновите отдельные экземпляры до [последней модели](virtual-machine-scale-sets-upgrade-scale-set.md#how-to-bring-vms-up-to-date-with-the-latest-scale-set-model) , чтобы отразить изменения.

## <a name="next-steps"></a>Дальнейшие действия
Узнайте, как [развертывать приложение](virtual-machine-scale-sets-deploy-app.md) в масштабируемых наборах виртуальных машин.
