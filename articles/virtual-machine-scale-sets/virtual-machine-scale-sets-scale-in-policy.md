---
title: Использование настраиваемых политик масштабирования с масштабируемыми наборами виртуальных машин Azure
description: Узнайте, как использовать настраиваемые политики масштабирования с масштабируемыми наборами виртуальных машин Azure, которые используют конфигурацию автомасштабирования для управления числом экземпляров.
services: virtual-machine-scale-sets
author: ju-shim
ms.author: jushiman
ms.topic: how-to
ms.service: virtual-machine-scale-sets
ms.subservice: autoscale
ms.date: 02/26/2020
ms.reviewer: avverma
ms.custom: avverma, devx-track-azurecli
ms.openlocfilehash: 9ca6310705d54d563aae746ab2dbfe6cb412e6a9
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "92747796"
---
# <a name="use-custom-scale-in-policies-with-azure-virtual-machine-scale-sets"></a>Использование настраиваемых политик масштабирования с масштабируемыми наборами виртуальных машин Azure

Развертывание масштабируемого набора виртуальных машин можно масштабировать или масштабировать на основе массива метрик, включая пользовательские метрики платформы и пользователя. Хотя при горизонтальном масштабировании создаются новые виртуальные машины на основе модели масштабируемого набора, масштабирование влияет на работу виртуальных машин, которые могут иметь разные конфигурации и (или) функции по мере развития рабочей нагрузки масштабируемого набора. 

Функция масштабирования предоставляет пользователям способ настройки порядка масштабирования виртуальных машин с помощью трех конфигураций с горизонтальным масштабированием: 

1. По умолчанию
2. невествм
3. олдествм

### <a name="default-scale-in-policy"></a>Политика масштабирования по умолчанию

По умолчанию масштабируемый набор виртуальных машин применяет эту политику, чтобы определить, в каких экземплярах будут масштабироваться элементы. При использовании политики *по умолчанию* виртуальные машины выбираются для масштабирования в следующем порядке:

1. Балансировка виртуальных машин в разных зонах доступности (если масштабируемый набор развернут в конфигурации зональные)
2. Балансировка виртуальных машин в доменах сбоя (наилучшие усилия)
3. Удаление виртуальной машины с наибольшим ИДЕНТИФИКАТОРом экземпляра

Пользователям не нужно указывать политику масштабирования, если необходимо выполнить упорядочение по умолчанию.

Обратите внимание, что балансировка в зонах доступности или доменах сбоя не приводит к перемещению экземпляров между зонами доступности или доменами сбоя. Балансировка обеспечивается за счет удаления виртуальных машин из несбалансированных зон доступности или доменов сбоя до тех пор, пока распределение виртуальных машин не будет сбалансировано.

### <a name="newestvm-scale-in-policy"></a>Политика масштабирования Невествм

Эта политика удалит последнюю созданную виртуальную машину в масштабируемом наборе после распределения виртуальных машин между зонами доступности (для развертываний зональные). Для включения этой политики необходимо изменить конфигурацию модели масштабируемого набора виртуальных машин.

### <a name="oldestvm-scale-in-policy"></a>Политика масштабирования Олдествм

Эта политика удаляет старую созданную виртуальную машину в масштабируемом наборе после распределения виртуальных машин между зонами доступности (для развертываний зональные). Для включения этой политики необходимо изменить конфигурацию модели масштабируемого набора виртуальных машин.

## <a name="enabling-scale-in-policy"></a>Включение политики масштабирования

Политика масштабирования определяется в модели масштабируемого набора виртуальных машин. Как отмечалось в разделах выше, определение политики масштабирования требуется при использовании политик "Невествм" и "Олдествм". Масштабируемый набор виртуальных машин будет автоматически использовать политику масштабирования "по умолчанию", если в модели масштабируемого набора не найдено определение политики масштабирования. 

Политику масштабирования можно определить в модели масштабируемого набора виртуальных машин следующими способами.

### <a name="azure-portal"></a>Портал Azure
 
Следующие шаги определяют политику масштабирования при создании нового масштабируемого набора. 
 
1. Перейдите к **масштабируемым наборам виртуальных машин**.
1. Выберите **+ Добавить** , чтобы создать новый масштабируемый набор.
1. Перейдите на вкладку **масштабирование** . 
1. Откройте раздел " **Политика масштабирования** ".
1. Выберите политику масштабирования из раскрывающегося списка.
1. Завершив создание нового масштабируемого набора, нажмите кнопку " **проверить и создать** ".

### <a name="using-api"></a>С помощью API

Выполните процедуру размещения в масштабируемом наборе виртуальных машин с помощью API 2019-03-01:

```
PUT
https://management.azure.com/subscriptions/<sub-id>/resourceGroups/<myRG>/providers/Microsoft.Compute/virtualMachineScaleSets/<myVMSS>?api-version=2019-03-01

{ 
"location": "<VMSS location>", 
    "properties": { 
        "scaleInPolicy": {  
            "rules": ["OldestVM"]  
        } 
    }    
} 
```
### <a name="azure-powershell"></a>Azure PowerShell

Создайте группу ресурсов, а затем создайте новый масштабируемый набор с политикой масштабирования, установленной как *олдествм*.

```azurepowershell-interactive
New-AzResourceGroup -ResourceGroupName "myResourceGroup" -Location "<VMSS location>"
New-AzVmss `
  -ResourceGroupName "myResourceGroup" `
  -Location "<VMSS location>" `
  -VMScaleSetName "myScaleSet" `
  -ScaleInPolicy “OldestVM”
```

### <a name="azure-cli-20"></a>Azure CLI 2.0

В следующем примере политика масштабирования добавляется при создании нового масштабируемого набора. Сначала создайте группу ресурсов, а затем создайте масштабируемый набор с политикой масштабирования в качестве *олдествм*. 

```azurecli-interactive
az group create --name <myResourceGroup> --location <VMSSLocation>
az vmss create \
  --resource-group <myResourceGroup> \
  --name <myVMScaleSet> \
  --image UbuntuLTS \
  --admin-username <azureuser> \
  --generate-ssh-keys \
  --scale-in-policy OldestVM
```

### <a name="using-template"></a>Использование шаблона

В шаблоне в разделе "Свойства" добавьте следующее:

```json
"scaleInPolicy": {  
      "rules": ["OldestVM"]  
}
```

Приведенные выше блоки указывают, что масштабируемый набор виртуальных машин удаляет самую старую виртуальную машину в масштабируемом наборе с балансировкой зоны при активации масштабирования (с помощью автомасштабирования или ручного удаления).

Если масштабируемый набор виртуальных машин не сбалансирован с зонами, то масштабируемый набор сначала удалит виртуальные машины в несбалансированных зонах. В несбалансированных зонах в масштабируемом наборе используется политика масштабирования, указанная выше, чтобы определить, в какой виртуальной машине будет выполнено масштабирование. В этом случае в пределах несбалансированной зоны в масштабируемом наборе будет выбрана самая старая виртуальная машина, которая будет удалена в этой зоне.

Для масштабируемых наборов виртуальных машин, отличных от зональные, политика выбирает самую раннюю виртуальную машину в масштабируемом наборе для удаления.

Тот же процесс применяется при использовании "Невествм" в указанной выше политике масштабирования.

## <a name="modifying-scale-in-policies"></a>Изменение политик масштабирования

Изменение политики масштабирования соответствует тому же процессу, что и применение политики масштабирования. Например, если в приведенном выше примере вы хотите изменить политику с "Олдествм" на "Невествм", это можно сделать следующим образом.

### <a name="azure-portal"></a>Портал Azure

Политику масштабирования существующего масштабируемого набора можно изменить с помощью портал Azure. 
 
1. В существующем масштабируемом наборе виртуальных машин выберите **масштабирование** в меню слева.
1. Перейдите на вкладку **Политика масштабирования** .
1. Выберите политику масштабирования из раскрывающегося списка.
1. По завершении нажмите кнопку **Сохранить**. 

### <a name="using-api"></a>С помощью API

Выполните процедуру размещения в масштабируемом наборе виртуальных машин с помощью API 2019-03-01:

```
PUT
https://management.azure.com/subscriptions/<sub-id>/resourceGroups/<myRG>/providers/Microsoft.Compute/virtualMachineScaleSets/<myVMSS>?api-version=2019-03-01 

{ 
"location": "<VMSS location>", 
    "properties": { 
        "scaleInPolicy": {  
            "rules": ["NewestVM"]  
        } 
    }    
}
```
### <a name="azure-powershell"></a>Azure PowerShell

Обновите политику масштабирования для существующего масштабируемого набора:

```azurepowershell-interactive
Update-AzVmss `
 -ResourceGroupName "myResourceGroup" `
 -VMScaleSetName "myScaleSet" `
 -ScaleInPolicy “OldestVM”
```

### <a name="azure-cli-20"></a>Azure CLI 2.0

Ниже приведен пример обновления политики масштабирования для существующего масштабируемого набора. 

```azurecli-interactive
az vmss update \  
  --resource-group <myResourceGroup> \
  --name <myVMScaleSet> \
  --scale-in-policy OldestVM
```

### <a name="using-template"></a>Использование шаблона

В шаблоне в разделе "Свойства" измените шаблон, как показано ниже, и выполните повторное развертывание: 

```json
"scaleInPolicy": {  
      "rules": ["NewestVM"]  
} 
```

Тот же процесс будет применен, если вы решили изменить "Невествм" на "default" или "Олдествм"

## <a name="instance-protection-and-scale-in-policy"></a>Политика защиты экземпляра и масштабирования

Масштабируемые наборы виртуальных машин предоставляют два типа [защиты экземпляров](./virtual-machine-scale-sets-instance-protection.md#types-of-instance-protection):

1. Защита от уменьшения горизонтального масштаба
2. Защита от действий масштабируемого набора

Защищенная виртуальная машина не удаляется с помощью действия масштабирования, независимо от примененной политики масштабирования. Например, если VM_0 (самая старая виртуальная машина в масштабируемом наборе) защищена от масштабирования и в масштабируемом наборе включена политика масштабирования "Олдествм", VM_0 не будет считаться масштабируемым в, даже если это самая старая виртуальная машина в масштабируемом наборе. 

Защищенная виртуальная машина может быть вручную удалена пользователем в любое время, независимо от политики масштабирования, включенной в масштабируемом наборе. 

## <a name="usage-examples"></a>Примеры использования 

В приведенных ниже примерах показано, как масштабируемый набор виртуальных машин выбирает виртуальные машины, которые будут удалены при активации события увеличения. Виртуальные машины с самыми высокими идентификаторами экземпляров считаются последними виртуальными машинами в масштабируемом наборе, а виртуальные машины с наименьшими идентификаторами экземпляров считаются самыми старыми виртуальными машинами в масштабируемом наборе. 

### <a name="oldestvm-scale-in-policy"></a>Политика масштабирования Олдествм

| Событие                 | Идентификаторы экземпляров в Zone1  | Идентификаторы экземпляров в)  | Идентификаторы экземпляров в Zone3  | Выбор масштаба                                                                                                               |
|-----------------------|------------------------|------------------------|------------------------|----------------------------------------------------------------------------------------------------------------------------------|
| Initial               | 3, 4, 5, 10            | 2, 6, 9, 11            | 1, 7, 8                |                                                                                                                                  |
| Масштабирование              | 3, 4, 5, 10            | ***2***, 6, 9, 11      | 1, 7, 8                | Выберите между зона 1 и 2, несмотря на то, что зона 3 имеет самую раннюю виртуальную машину. Удалите VM2 из зона 2, так как это самая старая виртуальная машина в этой зоне.   |
| Масштабирование              | ***3***, 4, 5, 10      | 6, 9, 11               | 1, 7, 8                | Выберите зона 1 Несмотря на то, что зона 3 имеет самую раннюю виртуальную машину. Удалите VM3 из зона 1, так как это самая старая виртуальная машина в этой зоне.                  |
| Масштабирование              | 4, 5, 10               | 6, 9, 11               | ***1***, 7, 8          | Зоны сбалансированы. Удалите VM1 в зона 3, так как это самая старая виртуальная машина в масштабируемом наборе.                                               |
| Масштабирование              | ***4***, 5, 10         | 6, 9, 11               | 7, 8                   | Выберите между зона 1 и зона 2. Удалите VM4 в зона 1, так как это самая старая виртуальная машина в двух зонах.                              |
| Масштабирование              | 5, 10                  | ***6***, 9, 11         | 7, 8                   | Выберите зона 2 Несмотря на то, что зона 1 имеет самую раннюю виртуальную машину. Удалите VM6 необходима в зона 1, так как это самая старая виртуальная машина в этой зоне.                    |
| Масштабирование              | ***5***, 10            | 9, 11                  | 7, 8                   | Зоны сбалансированы. Удалите VM5 в зона 1, так как это самая старая виртуальная машина в масштабируемом наборе.                                                |

Для масштабируемых наборов виртуальных машин, отличных от зональные, политика выбирает самую раннюю виртуальную машину в масштабируемом наборе для удаления. Любая "защищенная" виртуальная машина будет пропущена для удаления.

### <a name="newestvm-scale-in-policy"></a>Политика масштабирования Невествм

| Событие                 | Идентификаторы экземпляров в Zone1  | Идентификаторы экземпляров в)  | Идентификаторы экземпляров в Zone3  | Выбор масштаба                                                                                                               |
|-----------------------|------------------------|------------------------|------------------------|----------------------------------------------------------------------------------------------------------------------------------|
| Initial               | 3, 4, 5, 10            | 2, 6, 9, 11            | 1, 7, 8                |                                                                                                                                  |
| Масштабирование              | 3, 4, 5, 10            | 2, 6, 9, ***11***      | 1, 7, 8                | Выберите между зона 1 и 2. Удалите VM11 из зона 2, так как это самая новая виртуальная машина в двух зонах.                                |
| Масштабирование              | 3, 4, 5, ***10***      | 2, 6, 9                | 1, 7, 8                | Выберите зона 1, так как в нем больше виртуальных машин, чем в двух других зонах. Удалите VM10 из зона 1, так как это самая новая виртуальная машина в этой зоне.          |
| Масштабирование              | 3, 4, 5                | 2, 6, ***9***          | 1, 7, 8                | Зоны сбалансированы. Удалите виртуальная машина VM9 в зона 2, так как это последняя виртуальная машина в масштабируемом наборе.                                                |
| Масштабирование              | 3, 4, 5                | 2, 6                   | 1, 7, ***8***          | Выберите между зона 1 и зона 3. Удалите VM8 в зона 3, так как это самая новая виртуальная машина в этой зоне.                                      |
| Масштабирование              | 3, 4, ***5***          | 2, 6                   | 1, 7                   | Выберите зона 1 Несмотря на то, что зона 3 имеет самую новую виртуальную машину. Удалите VM5 в зона 1, так как это самая новая виртуальная машина в этой зоне.                    |
| Масштабирование              | 3, 4                   | 2, 6                   | 1, ***7***             | Зоны сбалансированы. Удалите VM7 в зона 3, так как это последняя виртуальная машина в масштабируемом наборе.                                                |

Для масштабируемых наборов виртуальных машин, отличных от зональные, политика выбирает последнюю виртуальную машину в масштабируемом наборе для удаления. Любая "защищенная" виртуальная машина будет пропущена для удаления. 

## <a name="troubleshoot"></a>Диагностика

1. Сбой включения Скалеинполици при получении ошибки "BadRequest" с сообщением об ошибке "не удалось найти член" Скалеинполици "для объекта типа" Properties ", проверьте версию API, используемую для масштабируемого набора виртуальных машин. Для этой функции требуется API версии 2019-03-01 или выше.

2. Неправильное выделение виртуальных машин для масштабирования см. в приведенных выше примерах. Если масштабируемый набор виртуальных машин является зональные развертыванием, политика масштабирования сначала применяется к несбалансированным зонам, а затем по масштабируемому набору после того, как он распределяется по зонам. Если порядок масштабирования не согласуется с приведенными выше примерами, создайте запрос с помощью команды масштабируемого набора виртуальных машин для устранения неполадок.

## <a name="next-steps"></a>Дальнейшие действия

Узнайте, как [развертывать приложение](virtual-machine-scale-sets-deploy-app.md) в масштабируемых наборах виртуальных машин.
