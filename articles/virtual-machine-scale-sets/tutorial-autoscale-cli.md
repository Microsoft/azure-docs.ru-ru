---
title: Руководство. Автомасштабирование масштабируемого набора с помощью Azure CLI
description: Узнайте, как использовать Azure CLI для автомасштабирования масштабируемого набора виртуальных машин по мере увеличения и уменьшения нагрузки на ЦП.
author: ju-shim
ms.author: jushiman
ms.topic: tutorial
ms.service: virtual-machine-scale-sets
ms.subservice: autoscale
ms.date: 05/18/2018
ms.reviewer: avverma
ms.custom: avverma, devx-track-azurecli
ms.openlocfilehash: b7fdf6d4893a6f6a970223671b28fdae6db3ef3d
ms.sourcegitcommit: 4b0e424f5aa8a11daf0eec32456854542a2f5df0
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/20/2021
ms.locfileid: "107762996"
---
# <a name="tutorial-automatically-scale-a-virtual-machine-scale-set-with-the-azure-cli"></a>Руководство по Автоматическое масштабирование масштабируемых наборов виртуальных машин с помощью Azure CLI

При создании масштабируемого набора вы определяете количество экземпляров виртуальных машин для запуска. По мере изменения потребностей приложения можно автоматически увеличивать или уменьшать это количество. Возможность автоматического масштабирования позволяет удовлетворить пользовательский спрос или среагировать на изменения производительности приложения на протяжении его жизненного цикла. Из этого руководства вы узнаете, как выполнить следующие задачи:

> [!div class="checklist"]
> * автомасштабирование масштабируемого набора;
> * создание и использование правил автомасштабирования;
> * нагрузочное тестирование экземпляров виртуальных машин и активация правил автомасштабирования;
> * обратное автомасштабирование при уменьшении потребности в ресурсах.

[!INCLUDE [quickstarts-free-trial-note](../../includes/quickstarts-free-trial-note.md)]

[!INCLUDE [azure-cli-prepare-your-environment.md](../../includes/azure-cli-prepare-your-environment.md)]

- Для работы с этим учебником требуется Azure CLI версии 2.0.32 или более поздней. Если вы используете Azure Cloud Shell, последняя версия уже установлена.

## <a name="create-a-scale-set"></a>Создание масштабируемого набора

Создайте группу ресурсов с помощью команды [az group create](/cli/azure/group), как показано ниже:

```azurecli-interactive
az group create --name myResourceGroup --location eastus
```

Создайте масштабируемый набор виртуальных машин с помощью команды [az vmss create](/cli/azure/vmss). В следующем примере создается масштабируемый набор с *двумя* экземплярами и ключи SSH, если они еще не созданы.

```azurecli-interactive
az vmss create \
  --resource-group myResourceGroup \
  --name myScaleSet \
  --image UbuntuLTS \
  --upgrade-policy-mode automatic \
  --instance-count 2 \
  --admin-username azureuser \
  --generate-ssh-keys
```

## <a name="define-an-autoscale-profile"></a>Определение профиля автомасштабирования

Чтобы включить автомасштабирование в масштабируемом наборе, сначала необходимо определить профиль автомасштабирования. Этот профиль определяет используемую по умолчанию, минимальную и максимальную емкости масштабируемого набора. Эти ограничения позволяют контролировать затраты за счет того, что экземпляры виртуальных машин не создаются непрерывно, и сбалансировать приемлемую производительность с минимальным числом экземпляров, которые остаются в масштабируемом событии. Создайте профиль автомасштабирования с помощью команды [az monitor autoscale create](/cli/azure/monitor/autoscale#az_monitor_autoscale_create). В примере ниже задаются минимальная и максимальная емкости (*2* и *10*), а также емкость по умолчанию экземпляров виртуальной машины.

```azurecli-interactive
az monitor autoscale create \
  --resource-group myResourceGroup \
  --resource myScaleSet \
  --resource-type Microsoft.Compute/virtualMachineScaleSets \
  --name autoscale \
  --min-count 2 \
  --max-count 10 \
  --count 2
```

## <a name="create-a-rule-to-autoscale-out"></a>Создание правила для автоматического горизонтального увеличения масштаба

При увеличении потребностей приложения в масштабируемом наборе увеличивается нагрузка на экземпляры виртуальной машины. Если такая увеличенная нагрузка представляет собой не просто краткий спрос, а является согласованной, можно настроить правила автомасштабирования, чтобы увеличить число экземпляров виртуальной машины в масштабируемом наборе. После создания этих экземпляров виртуальных машин и развертывания приложений масштабируемые наборы запускают распределение трафика между ними через подсистему балансировки нагрузки. Вы можете контролировать, какие метрики отслеживать, например ЦП или диск, продолжительность соответствия нагрузки приложения заданному пороговому значению, а также количество экземпляров виртуальной машины для добавления в масштабируемый набор.

Используя команду [az monitor autoscale rule create](/cli/azure/monitor/autoscale/rule#az_monitor_autoscale_rule_create), мы создадим правило, в соответствии с которым количество экземпляров виртуальной машины в масштабируемом наборе увеличивается, когда средняя загрузка ЦП превышает 70 % в течение 5 минут. При активации правила количество экземпляров виртуальных машин увеличивается до трех.

```azurecli-interactive
az monitor autoscale rule create \
  --resource-group myResourceGroup \
  --autoscale-name autoscale \
  --condition "Percentage CPU > 70 avg 5m" \
  --scale out 3
```

## <a name="create-a-rule-to-autoscale-in"></a>Создание правила для автоматического горизонтального уменьшения масштаба

В вечерние часы или выходные дни потребность в приложении может снизиться. Если такая сниженная нагрузка является согласованной в течение некоторого периода времени, можно настроить правила автомасштабирования, чтобы уменьшить число экземпляров виртуальных машин в масштабируемом наборе. Это действие снижает стоимость запуска масштабируемого набора, так как вы запускаете только то количество экземпляров, которое необходимо для удовлетворения текущего спроса.

Используя команду [az monitor autoscale rule create](/cli/azure/monitor/autoscale/rule#az_monitor_autoscale_rule_create), создайте другое правило, в соответствии с которым количество экземпляров виртуальной машины в масштабируемом наборе уменьшается, когда средняя загрузка ЦП не превышает 30 % в течение 5 минут. В следующем примере определяется правило горизонтального уменьшения масштаба для уменьшения количества экземпляров виртуальных машин на один экземпляр:

```azurecli-interactive
az monitor autoscale rule create \
  --resource-group myResourceGroup \
  --autoscale-name autoscale \
  --condition "Percentage CPU < 30 avg 5m" \
  --scale in 1
```

## <a name="generate-cpu-load-on-scale-set"></a>Создание нагрузки на ЦП в масштабируемом наборе

Чтобы проверить правила автомасштабирования, создайте нагрузку на ЦП в экземплярах виртуальных машин в масштабируемом наборе. В результате этой имитации нагрузки на ЦП происходит автоматическое горизонтальное увеличение масштаба и увеличение числа экземпляров виртуальных машин. Когда имитированная нагрузка на ЦП снижается, в соответствии с правилами автомасштабирования выполняется горизонтальное уменьшение масштаба и снижение числа экземпляров виртуальных машин.

Сначала нужно получить список адресов и портов для подключения к экземплярам виртуальных машин в масштабируемом наборе. Для этого введите команду [az vmss list-instance-connection-info](/cli/azure/vmss):

```azurecli-interactive
az vmss list-instance-connection-info \
  --resource-group myResourceGroup \
  --name myScaleSet
```

В следующем примере выходных данных показано имя экземпляра, общедоступный IP-адрес подсистемы балансировки нагрузки и номер порта, на который правила преобразования сетевых адресов перенаправляют трафик.

```json
{
  "instance 1": "13.92.224.66:50001",
  "instance 3": "13.92.224.66:50003"
}
```

Установите SSH-подключение к первому экземпляру виртуальной машины. Укажите собственный общедоступный IP-адрес и номер порта с помощью параметра `-p`, как показано в предыдущей команде.

```console
ssh azureuser@13.92.224.66 -p 50001
```

После входа в систему установите служебную программу **stress**. Запустите *10* **нагрузочных** рабочих процессов, которые создают нагрузку на ЦП. Эти рабочие процессы выполняются на протяжении *420* секунд. Этого достаточно, чтобы активировать правила автомасштабирования для реализации нужного действия.

```console
sudo apt-get update
sudo apt-get -y install stress
sudo stress --cpu 10 --timeout 420 &
```

Когда в служебной программе **stress** отобразятся выходные данные, аналогичные *stress: info: [2688] dispatching hogs: 10 cpu, 0 io, 0 vm, 0 hdd*, нажмите клавишу *ВВОД*, чтобы вернуться к командной строке.

Чтобы убедиться, что программа **stress** создает нагрузку на ЦП, проверьте активную нагрузку на систему с помощью служебной программы **top**.

```console
top
```

Выйдите из программы **top** и разорвите подключение к экземпляру виртуальной машины. Служебная программа **stress** продолжает работать на экземпляре виртуальной машины.

```console
Ctrl-c
exit
```

Подключитесь ко второму экземпляру виртуальной машины, используя номер порта, указанный в предыдущей команде [az vmss list-instance-connection-info](/cli/azure/vmss).

```console
ssh azureuser@13.92.224.66 -p 50003
```

Установите и запустите служебную программу **stress**, затем запустите десять рабочих процессов на втором экземпляре виртуальной машины.

```console
sudo apt-get -y install stress
sudo stress --cpu 10 --timeout 420 &
```

Опять-таки, когда в служебной программе **stress** отобразятся выходные данные, аналогичные *stress: info: [2713] dispatching hogs: 10 cpu, 0 io, 0 vm, 0 hdd*, нажмите клавишу *ВВОД*, чтобы вернуться к командной строке.

Разорвите подключение ко второму экземпляру виртуальной машины. Служебная программа **stress** продолжает работать на экземпляре виртуальной машины.

```console
exit
```

## <a name="monitor-the-active-autoscale-rules"></a>Мониторинг активных правил автомасштабирования

Чтобы отслеживать количество экземпляров виртуальных машин в масштабируемом наборе, используйте **watch**. Потребуется 5 минут, чтобы в соответствии с правилами автомасштабирования началось увеличение масштаба с учетом нагрузки на ЦП, созданной служебной программой **stress** на каждом экземпляре виртуальной машины.

```azurecli-interactive
watch az vmss list-instances \
  --resource-group myResourceGroup \
  --name myScaleSet \
  --output table
```

Когда достигается порог нагрузки на ЦП, в соответствии с правилами автомасштабирования увеличивается число экземпляров виртуальных машин в масштабируемом наборе. В следующих выходных данных показано, что при автомасштабировании масштабируемого набора создано три виртуальные машины.

```output
Every 2.0s: az vmss list-instances --resource-group myResourceGroup --name myScaleSet --output table

  InstanceId  LatestModelApplied    Location    Name          ProvisioningState    ResourceGroup    VmId
------------  --------------------  ----------  ------------  -------------------  ---------------  ------------------------------------
           1  True                  eastus      myScaleSet_1  Succeeded            myResourceGroup  4f92f350-2b68-464f-8a01-e5e590557955
           2  True                  eastus      myScaleSet_2  Succeeded            myResourceGroup  d734cd3d-fb38-4302-817c-cfe35655d48e
           4  True                  eastus      myScaleSet_4  Creating             myResourceGroup  061b4c90-0d73-49fc-a066-19eab0b3d95c
           5  True                  eastus      myScaleSet_5  Creating             myResourceGroup  4beff8b9-4e65-40cb-9652-43899309da27
           6  True                  eastus      myScaleSet_6  Creating             myResourceGroup  9e4133dd-2c57-490e-ae45-90513ce3b336
```

После остановки служебной программы **stress** на начальных экземплярах виртуальной машины восстанавливается нормальная нагрузка на ЦП. На протяжении следующих 5 минут в соответствии с правилами автомасштабирования осуществляется горизонтальное уменьшение масштаба для числа виртуальных машин. При горизонтальном уменьшении масштаба сначала удаляются экземпляры виртуальных машин с более высокими значениями идентификатора. Если в масштабируемом наборе используются группы доступности или зоны доступности, действия горизонтального уменьшения масштаба равномерно распределяются между экземплярами виртуальных машин. В следующем примере выходных данных показано удаление одного экземпляра виртуальной машины при автоматическом уменьшении масштаба масштабируемого набора:

```output
           6  True                  eastus      myScaleSet_6  Deleting             myResourceGroup  9e4133dd-2c57-490e-ae45-90513ce3b336
```

Выйдите из программы *watch* с помощью команды `Ctrl-c`. Каждые 5 минут будет происходить горизонтальное уменьшение масштаба масштабируемого набора с удалением одного экземпляра виртуальной машины, пока не будет достигнуто минимальное число экземпляров (2 экземпляра).

## <a name="clean-up-resources"></a>Очистка ресурсов

Чтобы удалить масштабируемый набор и дополнительные ресурсы, удалите группу ресурсов и все входящие в нее ресурсы с помощью команды [az group delete](/cli/azure/group). При использовании параметра `--no-wait` управление возвращается в командную строку без ожидания завершения операции. Параметр `--yes` подтверждает, что вы хотите удалить ресурсы без дополнительного запроса.

```azurecli-interactive
az group delete --name myResourceGroup --yes --no-wait
```

## <a name="next-steps"></a>Дальнейшие действия

Из этого руководства вы узнали, как выполнять горизонтальное увеличение или уменьшение масштаба для масштабируемого набора с помощью Azure CLI:

> [!div class="checklist"]
> * автомасштабирование масштабируемого набора;
> * создание и использование правил автомасштабирования;
> * нагрузочное тестирование экземпляров виртуальных машин и активация правил автомасштабирования;
> * обратное автомасштабирование при уменьшении потребности в ресурсах.
