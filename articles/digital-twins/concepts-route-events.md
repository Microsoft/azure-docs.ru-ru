---
title: Маршрутизация событий
titleSuffix: Azure Digital Twins
description: Узнайте, как маршрутизировать события в Azure Digital двойников и в другие службы Azure.
author: baanders
ms.author: baanders
ms.date: 10/12/2020
ms.topic: conceptual
ms.service: digital-twins
ms.openlocfilehash: ea412b695c12f3ff7fdfa6250e2a474b618b8032
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "102430927"
---
# <a name="route-events-within-and-outside-of-azure-digital-twins"></a>Маршрутизация событий внутри и за пределами Azure Digital двойников

Azure Digital двойников использует **маршруты событий** для отправки данных потребителям за пределами службы. 

Существует два основных варианта отправки данных Azure Digital двойников:
* Отправка данных из одного двойника в графе Azure Digital двойников на другой. Например, при изменении свойства одного цифрового двойника может потребоваться уведомление и обновление другого цифрового двойника соответствующим образом.
* Отправка данных в службы нисходящих данных для дополнительного хранения или обработки (также известной как исходящие *данные*). Например,
  - В больницы может потребоваться отправить данные событий Azure Digital двойников в службу ["аналитика временных рядов" (TSI)](../time-series-insights/overview-what-is-tsi.md), чтобы записывать данные временных рядов событий, связанных с хандвашинг, для аналитики.
  - Компания, которая уже использует [Azure Maps](../azure-maps/about-azure-maps.md) , может использовать Azure Digital двойников для улучшения своих решений. Они могут быстро включить карту Azure после настройки Azure Digital двойников, перенести сущности в Azure Digital двойников в виде [цифровых двойников](concepts-twins-graph.md) в графе двойника или выполнять эффективные запросы, использующие их Azure Maps и данные Azure Digital двойников.

В обоих сценариях используются маршруты событий.

## <a name="about-event-routes"></a>О маршрутах событий

Маршрут событий позволяет отправить данные событий из Digital двойников в Azure Digital двойников в пользовательские конечные точки в подписках. Сейчас для конечных точек поддерживаются три службы Azure: [концентратор событий](../event-hubs/event-hubs-about.md), служба " [Сетка событий](../event-grid/overview.md)" и [служебная шина](../service-bus-messaging/service-bus-messaging-overview.md). Каждая из этих служб Azure может быть подключена к другим службам и выступает в качестве середины, отправляя данные в конечные назначения, такие как TSI или Azure Maps для любой необходимой обработки.

На следующей схеме показан поток данных событий с помощью более крупного решения Интернета вещей с аспектом Azure Digital двойников:

:::image type="content" source="media/concepts-route-events/routing-workflow.png" alt-text="Данные маршрутизации Azure Digital двойников через конечные точки для нескольких нижестоящих служб" border="false":::

Типичные нисходящие цели для маршрутов событий — это ресурсы, такие как TSI, Azure Maps, хранилища и аналитики.

### <a name="event-routes-for-internal-digital-twin-events"></a>Маршруты событий для внутренних событий Digital двойника

Маршруты событий также используются для управления событиями в графе двойника и отправки данных из Digital двойника в Digital двойника. Это делается путем подключения маршрутов событий через службу "Сетка событий" к ресурсам для вычислений, таким как [функции Azure](../azure-functions/functions-overview.md). Затем эти функции определяют, как двойников должна принимать события и реагировать на них. 

Когда ресурсу вычислений требуется изменить граф двойника на основе события, полученного с помощью маршрута событий, полезно, чтобы он знал, какой двойника необходимо изменить заранее. 

Кроме того, сообщение о событии также содержит идентификатор источника двойника, отправившего сообщение, поэтому ресурсы вычислений могут использовать запросы или просматривать связи, чтобы найти целевой двойника для нужной операции. 

Ресурсу вычислений также необходимо установить разрешения безопасности и доступа независимо.

Чтобы проанализировать процесс настройки функции Azure для обработки событий Digital двойника, см. инструкции по [*настройке функции Azure для обработки данных*](how-to-create-azure-function.md).

## <a name="create-an-endpoint"></a>Создание конечной точки

Чтобы определить маршрут события, разработчики сначала должны определить конечные точки. **Конечная точка** — это назначение за пределами цифрового двойников Azure, которое поддерживает подключение маршрута. В число поддерживаемых назначений входят следующие:
* Пользовательские разделы сетки событий
* Концентратор событий
* Cлужебная шина

Чтобы создать конечную точку, можно использовать интерфейсы API-интерфейса двойников для службы цифровых учетных записи Azure [, команды интерфейса командной строки](how-to-manage-routes-apis-cli.md#create-an-endpoint-for-azure-digital-twins)или [портал Azure](how-to-manage-routes-portal.md#create-an-endpoint-for-azure-digital-twins).

При определении конечной точки необходимо предоставить:
* Имя конечной точки
* Тип конечной точки (сетка событий, концентратор событий или служебная шина)
* Основная строка подключения и вторичная строка подключения для проверки подлинности 
* Путь к разделу конечной точки, например *Your-Topic.westus2.eventgrid.Azure.NET*

Ниже перечислены API-интерфейсы конечных точек, доступные в плоскости управления.
* Создать конечную точку
* Получение списка конечных точек
* Получить конечную точку по имени
* Удалить конечную точку по имени

## <a name="create-an-event-route"></a>Создание маршрута события
 
Чтобы создать маршрут событий, можно использовать интерфейсы API-интерфейса двойников для Azure Digital [, команды интерфейса командной строки](how-to-manage-routes-apis-cli.md#create-an-event-route)или [портал Azure](how-to-manage-routes-portal.md#create-an-event-route).

Ниже приведен пример создания маршрута события в клиентском приложении с помощью `CreateOrReplaceEventRouteAsync` вызова [.NET (C#) SDK](/dotnet/api/overview/azure/digitaltwins/client) : 

:::code language="csharp" source="~/digital-twins-docs-samples/sdks/csharp/eventRoute_operations.cs" id="CreateEventRoute":::

1. Сначала `DigitalTwinsEventRoute` создается объект, а конструктор принимает имя конечной точки. Это `endpointName` поле определяет конечную точку, например концентратор событий, службу "Сетка событий" или служебную шину. Эти конечные точки должны быть созданы в подписке и подключены к Azure Digital двойников с помощью API-интерфейсов плоскости управления перед выполнением этого вызова регистрации.

2. Объект маршрута события также имеет поле [**фильтра**](how-to-manage-routes-apis-cli.md#filter-events) , которое можно использовать для ограничения типов событий, которые следуют за этим маршрутом. Фильтр `true` включает маршрут без дополнительной фильтрации (фильтр `false` отключает маршрут). 

3. Затем этот объект маршрута события передается в `CreateOrReplaceEventRouteAsync` , а также имя маршрута.

> [!TIP]
> Все функции пакета SDK имеют синхронные и асинхронные версии.

## <a name="dead-letter-events"></a>События недоставленных сообщений

Если конечная точка не может доставить событие в течение определенного периода времени или после попытки доставить событие определенное количество раз, оно может отправить недоставленное событие в учетную запись хранения. Этот процесс называется **недоставленным**. При выполнении **одного из следующих** условий Azure Digital двойников будет использовать событие недоставленного письма. 

* Событие не доставлено в течение срока жизни
* Число попыток доставки события превысило предельное значение

Если одно из условий выполнено, событие удаляется или недоставлено. По умолчанию каждая конечная точка **не** включает недоставленные письма. Чтобы включить его, необходимо указать учетную запись хранения для хранения недоставленных событий при создании конечной точки. Затем можно извлечь события из этой учетной записи хранения для разрешения поставок.

Прежде чем задать параметры расположения недоставленных сообщений, необходимо создать учетную запись хранения с контейнером. При создании конечной точки вы предоставляете URL-адрес для этого контейнера. Недоставленная буква предоставляется как URL-адрес контейнера с маркером SAS. Этот маркер должен иметь только `write` разрешение для целевого контейнера в пределах учетной записи хранения. Полностью сформированный URL-адрес будет иметь формат: `https://<storageAccountname>.blob.core.windows.net/<containerName>?<SASToken>`

Дополнительные сведения о маркерах SAS см. в статье [ *предоставление ограниченного доступа к ресурсам службы хранилища Azure с помощью подписанных URL-адресов (SAS)* .](../storage/common/storage-sas-overview.md)

Сведения о настройке конечной точки с недоставленными сообщениями см. в разделе [*руководство. Управление конечными точками и маршрутами в Azure Digital двойников (API и CLI)*](how-to-manage-routes-apis-cli.md#create-an-endpoint-with-dead-lettering).

### <a name="types-of-event-messages"></a>Типы сообщений о событиях

Различные типы событий в центре Интернета вещей и Azure Digital двойников создают различные типы сообщений уведомлений, как описано ниже.

[!INCLUDE [digital-twins-notifications.md](../../includes/digital-twins-notifications.md)]

## <a name="next-steps"></a>Дальнейшие действия

См. статью Настройка маршрута событий и управление им.
* [*Руководство. Управление конечными точками и маршрутами*](how-to-manage-routes-apis-cli.md)

Или см. статью использование функций Azure для маршрутизации событий в Azure Digital двойников:
* [*Пошаговое руководство. Настройка функции Azure для обработки данных*](how-to-create-azure-function.md)