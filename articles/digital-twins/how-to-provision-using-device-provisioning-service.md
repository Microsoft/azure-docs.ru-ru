---
title: Автоматическое управление устройствами с помощью службы подготовки устройств
titleSuffix: Azure Digital Twins
description: Узнайте, как настроить автоматизированный процесс подготовки и снятия с учета устройств IoT в Azure Digital двойников с помощью службы подготовки устройств (DPS).
author: baanders
ms.author: baanders
ms.date: 3/21/2021
ms.topic: how-to
ms.service: digital-twins
ms.openlocfilehash: a571d92dd9663c7d2d0a576b59e5cd2b3352cb76
ms.sourcegitcommit: ac035293291c3d2962cee270b33fca3628432fac
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/24/2021
ms.locfileid: "104951107"
---
# <a name="auto-manage-devices-in-azure-digital-twins-using-device-provisioning-service-dps"></a>Автоматическое управление устройствами в цифровом двойников Azure с помощью службы подготовки устройств (DPS)

Из этой статьи вы узнаете, как интегрировать Azure Digital двойников со [службой подготовки устройств (DPS)](../iot-dps/about-iot-dps.md).

Решение, описанное в этой статье, позволит автоматизировать процесс **_подготовки_** и **_снятия с учета_** устройств центра Интернета вещей в Azure Digital двойников с помощью службы подготовки устройств. 

Дополнительные сведения о стадиях _подготовки_ и _снятия с учета_ и ознакомлении с набором общих стадий управления устройствами, общих для всех корпоративных проектов IOT, см. в [разделе *жизненный цикл устройства*](../iot-hub/iot-hub-device-management-overview.md#device-lifecycle) документации по управлению устройствами в центре Интернета вещей.

## <a name="prerequisites"></a>Предварительные условия

Перед настройкой подготовки необходимо настроить следующие настройки.
* **экземпляр Digital двойников для Azure**. Следуйте инструкциям в разделе [*как настроить экземпляр и проверку подлинности*](how-to-set-up-instance-portal.md) для создания экземпляра Digital двойников для Azure. Соберите **_имя узла_** экземпляра в портал Azure ([инструкции](how-to-set-up-instance-portal.md#verify-success-and-collect-important-values)).
* **центр Интернета вещей**. Инструкции см. в разделе " *Создание центра Интернета вещей* " этого [руководства центра Интернета вещей](../iot-hub/quickstart-send-telemetry-cli.md).
* [**функция Azure**](../azure-functions/functions-overview.md) , которая обновляет сведения о цифровом двойника на основе данных центра Интернета вещей. Следуйте инструкциям в разделе [*как принимайте данные центра Интернета вещей*](how-to-ingest-iot-hub-data.md) для создания этой функции Azure. Соберите **_имя_** функции, чтобы использовать ее в этой статье.

В этом примере также используется **симулятор устройств** , который включает подготовку с помощью службы подготовки устройств. Симулятор устройства расположен здесь: [пример интеграции Azure Digital двойников и центра Интернета вещей](/samples/azure-samples/digital-twins-iothub-integration/adt-iothub-provision-sample/). Получите пример проекта на своем компьютере, перейдя по ссылке с образцом и нажав кнопку *скачать ZIP-файл* под заголовком. Распакуйте скачанный каталог.

Вам потребуется [**Node.js**](https://nodejs.org/download) , установленный на компьютере. Симулятор устройства основан на **Node.js** версии 10.0. x или более поздней.

## <a name="solution-architecture"></a>Архитектура решения

На рисунке ниже показана архитектура этого решения с использованием Azure Digital двойников со службой подготовки устройств. В нем показаны поток инициализации устройства и снятия с учета.

:::image type="content" source="media/how-to-provision-using-dps/flows.png" alt-text="Схема устройства и несколько служб Azure в комплексном сценарии. Данные передаются между устройством термостата и службой DPS. Данные также передаются из DPS в центр Интернета вещей и в Azure Digital двойников с помощью функции Azure с меткой &quot;выделение&quot;. Данные из действия &quot;Удаление устройства&quot; вручную проходят через центр Интернета вещей, > концентраторы событий > функции Azure > Azure Digital двойников." lightbox="media/how-to-provision-using-dps/flows.png":::

Эта статья разделена на две части:
* [*Автоматическая подготовка устройства с помощью службы подготовки устройств*](#auto-provision-device-using-device-provisioning-service)
* [*Автоматическое прекращение использования устройства с помощью событий жизненного цикла центра Интернета вещей*](#auto-retire-device-using-iot-hub-lifecycle-events)

Более подробные объяснения каждого шага в архитектуре см. в разделе отдельные разделы этой статьи.

## <a name="auto-provision-device-using-device-provisioning-service"></a>Автоматическая подготовка устройства с помощью службы подготовки устройств

В этом разделе вы будете присоединить службу подготовки устройств к Azure Digital двойников для автоматической подготовки устройств по указанному ниже пути. Это выдержка из полной показанной [выше](#solution-architecture)архитектуры.

:::image type="content" source="media/how-to-provision-using-dps/provision.png" alt-text="Схема последовательности инициализации — выдержка из схемы архитектуры решения с числами, обозначенными разделами последовательности. Данные передаются между устройством термостата и DP (1 для устройства > DP и 5 для > диагностики). Данные также передаются из DPS в центр Интернета вещей (4) и в Azure Digital двойников (3) с помощью функции Azure с меткой &quot;выделение&quot; (2)." lightbox="media/how-to-provision-using-dps/provision.png":::

Ниже приведено описание потока процесса.
1. Устройство обращается к конечной точке DPS, передавая идентификационные данные для подтверждения своей личности.
2. Служба DPS проверяет удостоверение устройства, проверяя идентификатор регистрации и ключ в списке регистрации и вызывает [функцию Azure](../azure-functions/functions-overview.md) для выделения.
3. Функция Azure создает новый [двойника](concepts-twins-graph.md) в Azure Digital двойников для устройства. Двойника будет иметь то же имя, что и **идентификатор регистрации** устройства.
4. DPS регистрирует устройство в центре Интернета вещей и заполняет требуемое состояние двойникаа устройства.
5. Центр Интернета вещей возвращает сведения об ИДЕНТИФИКАТОРе устройства и сведения о подключении центра Интернета вещей на устройстве. Теперь устройство может подключаться к центру Интернета вещей.

В следующих разделах описаны действия по настройке этого потока устройства автоматической инициализации.

### <a name="create-a-device-provisioning-service"></a>Создание службы подготовки устройств

При подготовке нового устройства с помощью службы подготовки устройств в Azure Digital двойников можно создать новый двойника для этого устройства с тем же именем, что и у идентификатора регистрации.

Создайте экземпляр службы подготовки устройств, который будет использоваться для подготовки устройств IoT. Можно либо использовать приведенные ниже инструкции Azure CLI, либо использовать портал Azure: Краткое руководство по [*настройке службы подготовки устройств для центра Интернета вещей с помощью портал Azure*](../iot-dps/quick-setup-auto-provision.md).

Следующая команда Azure CLI создаст службу подготовки устройств. Необходимо указать имя службы подготовки устройств, группу ресурсов и регион. Чтобы узнать, какие регионы поддерживают службу подготовки устройств, посетите страницу [*продукты Azure, доступные по регионам*](https://azure.microsoft.com/global-infrastructure/services/?products=iot-hub).
Команду можно выполнить в [Cloud Shell](https://shell.azure.com)или локально, если [на компьютере установлен](/cli/azure/install-azure-cli)Azure CLI.

```azurecli-interactive
az iot dps create --name <Device Provisioning Service name> --resource-group <resource group name> --location <region>
```

### <a name="add-a-function-to-use-with-device-provisioning-service"></a>Добавление функции для использования со службой подготовки устройств

В проекте приложения-функции, созданном в разделе [Предварительные требования](#prerequisites) , вы создадите новую функцию для использования со службой подготовки устройств. Эта функция будет использоваться службой подготовки устройств в [пользовательской политике выделения](../iot-dps/how-to-use-custom-allocation-policies.md) для подготовки нового устройства.

Для начала откройте проект приложения функции в Visual Studio на своем компьютере и выполните следующие действия.

#### <a name="step-1-add-a-new-function"></a>Шаг 1. Добавление новой функции 

Добавьте новую функцию типа *http-Trigger* в проект приложения-функции в Visual Studio.

:::image type="content" source="media/how-to-provision-using-dps/add-http-trigger-function-visual-studio.png" alt-text="Снимок экрана представления Visual Studio для добавления функции Azure типа триггера HTTP в проект приложения-функции." lightbox="media/how-to-provision-using-dps/add-http-trigger-function-visual-studio.png":::

#### <a name="step-2-fill-in-function-code"></a>Шаг 2. заполнение в коде функции

Добавьте новый пакет NuGet в проект: [Microsoft. Azure. Devices. подготовка. Служба](https://www.nuget.org/packages/Microsoft.Azure.Devices.Provisioning.Service/). Также может потребоваться добавить дополнительные пакеты в проект, если пакеты, используемые в коде, не являются частью проекта.

В созданном файле кода функции вставьте следующий код, переименуйте функцию в *дпсадталлокатионфунк. CS* и сохраните файл.

:::code language="csharp" source="~/digital-twins-docs-samples-dps/functions/DpsAdtAllocationFunc.cs":::

#### <a name="step-3-publish-the-function-app-to-azure"></a>Шаг 3. Публикация приложения функции в Azure

Опубликуйте проект с помощью функции *дпсадталлокатионфунк. CS* в приложении функции в Azure.

[!INCLUDE [digital-twins-publish-and-configure-function-app.md](../../includes/digital-twins-publish-and-configure-function-app.md)]

### <a name="create-device-provisioning-enrollment"></a>Создание регистрации устройства

Далее необходимо создать регистрацию в службе подготовки устройств с помощью **пользовательской функции выделения**. Следуйте инструкциям в разделе [*Создание регистрации*](../iot-dps/how-to-use-custom-allocation-policies.md#create-the-enrollment) статьи пользовательские политики распределения в документации по службе подготовки устройств.

Проходясь по этому потоку, убедитесь, что вы выбрали следующие параметры, чтобы связать регистрацию с только что созданной функцией.

* **Выберите способ назначения устройств для концентраторов**: настраиваемый (используйте функцию Azure).
* **Выберите центры Интернета вещей, которым может быть назначена эта Группа:** Выберите имя центра Интернета вещей или нажмите кнопку *связать новый центр Интернета вещей* и выберите центр Интернета вещей из раскрывающегося списка.

Затем нажмите кнопку *выбрать новую функцию* , чтобы связать приложение-функцию с группой регистрации. Затем заполните следующие значения:

* **Подписка**. Ваша подписка Azure заполняется автоматически. Убедитесь, что это правильная подписка.
* **Приложение-функция**. Выберите имя приложения функции.
* **Функция**: выберите дпсадталлокатионфунк.

Сохраните сведения.                  

:::image type="content" source="media/how-to-provision-using-dps/link-enrollment-group-to-iot-hub-and-function-app.png" alt-text="Снимок экрана: окно сведений о группе таможенной регистрации. чтобы выбрать настраиваемую (использовать функцию Azure) и имя центра Интернета вещей в разделах, выберите способ назначения устройств концентраторам и выберите центры Интернета вещей, которым может быть назначена эта группа. Кроме того, выберите подписку, приложение функции из раскрывающегося списка и выберите Дпсадталлокатионфунк." lightbox="media/how-to-provision-using-dps/link-enrollment-group-to-iot-hub-and-function-app.png":::

После создания регистрации **первичный ключ** для регистрации будет использоваться позже для настройки симулятора устройства для этой статьи.

### <a name="set-up-the-device-simulator"></a>Настройка симулятора устройств

В этом примере используется симулятор устройства, который включает подготовку с помощью службы подготовки устройств. Симулятор устройства расположен здесь: [пример интеграции Azure Digital двойников и центра Интернета вещей](/samples/azure-samples/digital-twins-iothub-integration/adt-iothub-provision-sample/). Если вы еще не скачали пример, получите его сейчас, перейдя по ссылке образца и нажав кнопку *скачать ZIP-файл* под заголовком. Распакуйте скачанный каталог.

#### <a name="upload-the-model"></a>Отправка модели

Симулятор устройства — это устройство типа термостата, которое использует модель с таким ИДЕНТИФИКАТОРом: `dtmi:contosocom:DigitalTwins:Thermostat;1` . Необходимо отправить эту модель в Azure Digital двойников, прежде чем можно будет создать двойника этого типа для устройства.

[!INCLUDE [digital-twins-thermostat-model-upload.md](../../includes/digital-twins-thermostat-model-upload.md)]

Дополнительные сведения о моделях см. в разделе «Практические руководства. [*Управление моделями*](how-to-manage-model.md#upload-models)».

#### <a name="configure-and-run-the-simulator"></a>Настройка и запуск симулятора

В командном окне перейдите к скачанному образцу *интегрированной службы Digital двойников и центра Интернета вещей Azure* , который вы выгрузили ранее, а затем в каталог *Device-симулятор* . Затем установите зависимости для проекта с помощью следующей команды:

```cmd
npm install
```

Затем в каталоге симулятора устройства скопируйте файл. env. Template в новый файл с именем. env и соберите следующие значения для заполнения параметров:

* PROVISIONING_IDSCOPE. чтобы получить это значение, перейдите к службе подготовки устройств в [портал Azure](https://portal.azure.com/), а затем выберите *Обзор* в меню Параметры и найдите *область идентификатор* поля.

    :::image type="content" source="media/how-to-provision-using-dps/id-scope.png" alt-text="Снимок экрана с представлением портал Azure на странице &quot;Обзор подготовки устройств&quot; для копирования значения области идентификатора." lightbox="media/how-to-provision-using-dps/id-scope.png":::

* PROVISIONING_REGISTRATION_ID. Вы можете выбрать идентификатор регистрации для устройства.
* ADT_MODEL_ID: `dtmi:contosocom:DigitalTwins:Thermostat;1`
* PROVISIONING_SYMMETRIC_KEY: это первичный ключ для регистрации, который вы настроили ранее. Чтобы снова получить это значение, перейдите к службе подготовки устройств в портал Azure, выберите *Управление регистрациями*, затем выберите группу регистрации, созданную ранее, и скопируйте *первичный ключ*.

    :::image type="content" source="media/how-to-provision-using-dps/sas-primary-key.png" alt-text="Снимок экрана портал Azure представления службы подготовки устройств на странице &quot;Управление регистрацией&quot; для копирования значения первичного ключа SAS." lightbox="media/how-to-provision-using-dps/sas-primary-key.png":::

Теперь используйте значения, приведенные выше, для обновления параметров файла. env.

```cmd
PROVISIONING_HOST = "global.azure-devices-provisioning.net"
PROVISIONING_IDSCOPE = "<Device Provisioning Service Scope ID>"
PROVISIONING_REGISTRATION_ID = "<Device Registration ID>"
ADT_MODEL_ID = "dtmi:contosocom:DigitalTwins:Thermostat;1"
PROVISIONING_SYMMETRIC_KEY = "<Device Provisioning Service enrollment primary SAS key>"
```

Сохраните файл и закройте его.

### <a name="start-running-the-device-simulator"></a>Начало работы симулятора устройства

Находясь в каталоге *симулятора устройства* в командном окне, запустите симулятор устройства с помощью следующей команды:

```cmd
node .\adt_custom_register.js
```

Вы должны увидеть зарегистрированное устройство и подключиться к центру Интернета вещей, а затем начать отправку сообщений.
:::image type="content" source="media/how-to-provision-using-dps/output.png" alt-text="Снимок экрана командное окно, показывающий регистрацию устройств и отправку сообщений" lightbox="media/how-to-provision-using-dps/output.png":::

### <a name="validate"></a>Проверить

В результате выполнения последовательности, настроенной в этой статье, устройство будет автоматически зарегистрировано в Azure Digital двойников. Используйте следующую команду [интерфейса командной строки Azure Digital двойников](how-to-use-cli.md) , чтобы найти двойника устройства в созданном вами экземпляре Azure Digital двойников.

```azurecli-interactive
az dt twin show -n <Digital Twins instance name> --twin-id "<Device Registration ID>"
```

Вы должны увидеть двойника устройства в экземпляре цифрового двойников Azure.
:::image type="content" source="media/how-to-provision-using-dps/show-provisioned-twin.png" alt-text="Снимок экрана командное окно с вновь созданным двойника." lightbox="media/how-to-provision-using-dps/show-provisioned-twin.png":::

## <a name="auto-retire-device-using-iot-hub-lifecycle-events"></a>Автоматическое прекращение использования устройства с помощью событий жизненного цикла центра Интернета вещей

В этом разделе вы будете присоединить события жизненного цикла центра Интернета вещей к Azure Digital двойников для автоматического снятия с учета устройств по указанному ниже пути. Это выдержка из полной показанной [выше](#solution-architecture)архитектуры.

:::image type="content" source="media/how-to-provision-using-dps/retire.png" alt-text="Схема потока для устройства снятия с учета — выдержка из схемы архитектуры решения с числами, обозначенными разделами последовательности. Устройство термостата отображается без подключения к службам Azure на схеме. Данные из действия &quot;Удаление устройства&quot; вручную проходят через центр Интернета вещей (1) > концентраторов событий (2) > функциях Azure > Azure Digital двойников (3)." lightbox="media/how-to-provision-using-dps/retire.png":::

Ниже приведено описание потока процесса.
1. Внешний или ручной процесс инициирует удаление устройства в центре Интернета вещей.
2. Центр Интернета вещей удаляет устройство и создает событие [жизненного цикла устройства](../iot-hub/iot-hub-device-management-overview.md#device-lifecycle) , которое будет направляться в [концентратор событий](../event-hubs/event-hubs-about.md).
3. Функция Azure удаляет двойника устройства в Azure Digital двойников.

В следующих разделах описаны действия по настройке этого потока устройств, поддерживающего автоматическое снятие с учета.

### <a name="create-an-event-hub"></a>Создание концентратора событий

Далее предстоит создать [концентратор событий](../event-hubs/event-hubs-about.md) Azure для получения событий жизненного цикла центра Интернета вещей. 

Выполните действия, описанные в кратком руководстве по [*созданию концентратора событий*](../event-hubs/event-hubs-create.md) . Назовите концентратор событий *лифецикливентс*. Это имя концентратора событий будет использоваться при настройке маршрута центра Интернета вещей и функции Azure в следующих разделах.

На следующем снимке экрана показано создание концентратора событий.
:::image type="content" source="media/how-to-provision-using-dps/create-event-hub-lifecycle-events.png" alt-text="Снимок экрана портал Azure окна для создания концентратора событий с именем лифецикливентс." lightbox="media/how-to-provision-using-dps/create-event-hub-lifecycle-events.png":::

#### <a name="create-sas-policy-for-your-event-hub"></a>Создание политики SAS для концентратора событий

Далее необходимо создать [политику подписанного URL-адрес (SAS)](../event-hubs/authorize-access-shared-access-signature.md) для настройки концентратора событий с помощью приложения-функции.
Для этого сделайте следующее.
1. Перейдите к концентратору событий, который вы только что создали в портал Azure, и выберите **политики общего доступа** в параметрах меню слева.
2. Выберите **Добавить**. В открывшемся окне *Добавление политики SAS* введите имя политики по своему усмотрению и установите флажок Listen ( *слушать* ).
3. Нажмите кнопку **создания**.
    
:::image type="content" source="media/how-to-provision-using-dps/add-event-hub-sas-policy.png" alt-text="Снимок экрана портал Azure добавить политику SAS концентратора событий." lightbox="media/how-to-provision-using-dps/add-event-hub-sas-policy.png":::

#### <a name="configure-event-hub-with-function-app"></a>Настройка концентратора событий с помощью приложения-функции

Затем настройте приложение-функцию Azure, настроенное в разделе " [Предварительные требования](#prerequisites) ", для работы с новым концентратором событий. Это можно сделать, задав в приложении-функции переменную среды с помощью строки подключения концентратора событий.

1. Откройте только что созданную политику и скопируйте значение параметра **строка подключения — первичный ключ** .

    :::image type="content" source="media/how-to-provision-using-dps/event-hub-sas-policy-connection-string.png" alt-text="Снимок экрана портал Azure для копирования первичного ключа строки подключения." lightbox="media/how-to-provision-using-dps/event-hub-sas-policy-connection-string.png":::

2. Добавьте строку подключения в качестве переменной в параметры приложения-функции с помощью следующей команды Azure CLI. Команду можно выполнить в [Cloud Shell](https://shell.azure.com)или локально, если [на компьютере установлен](/cli/azure/install-azure-cli)Azure CLI.

    ```azurecli-interactive
    az functionapp config appsettings set --settings "EVENTHUB_CONNECTIONSTRING=<Event Hubs SAS connection string Listen>" -g <resource group> -n <your App Service (function app) name>
    ```

### <a name="add-a-function-to-retire-with-iot-hub-lifecycle-events"></a>Добавление функции для снятия с учета событий жизненного цикла центра Интернета вещей

В проекте приложения-функции, созданном в разделе [Предварительные требования](#prerequisites) , вы создадите новую функцию для снятия с учета существующего устройства с помощью событий жизненного цикла центра Интернета вещей.

Дополнительные сведения о событиях жизненного цикла см. в статье [*события, не связанные с телеметрии центра Интернета вещей*](../iot-hub/iot-hub-devguide-messages-d2c.md#non-telemetry-events). Дополнительные сведения об использовании концентраторов событий с функциями Azure см. в статье [*триггер концентраторов событий Azure для функций Azure*](../azure-functions/functions-bindings-event-hubs-trigger.md).

Для начала откройте проект приложения функции в Visual Studio на своем компьютере и выполните следующие действия.

#### <a name="step-1-add-a-new-function"></a>Шаг 1. Добавление новой функции
     
Добавьте новую функцию типа *триггер концентратора событий* в проект приложения-функции в Visual Studio.

:::image type="content" source="media/how-to-provision-using-dps/create-event-hub-trigger-function.png" alt-text="Снимок экрана: окно Visual Studio. Добавление функции Azure типа &quot;триггер концентратора событий&quot; в проект приложения-функции." lightbox="media/how-to-provision-using-dps/create-event-hub-trigger-function.png":::

#### <a name="step-2-fill-in-function-code"></a>Шаг 2. заполнение в коде функции

В созданном файле кода функции вставьте следующий код, переименуйте функцию в `DeleteDeviceInTwinFunc.cs` и сохраните файл.

:::code language="csharp" source="~/digital-twins-docs-samples-dps/functions/DeleteDeviceInTwinFunc.cs":::

#### <a name="step-3-publish-the-function-app-to-azure"></a>Шаг 3. Публикация приложения функции в Azure

Опубликуйте проект с помощью функции *делетедевицеинтвинфунк. CS* в приложении функции в Azure.

[!INCLUDE [digital-twins-publish-and-configure-function-app.md](../../includes/digital-twins-publish-and-configure-function-app.md)]

### <a name="create-an-iot-hub-route-for-lifecycle-events"></a>Создание маршрута центра Интернета вещей для событий жизненного цикла

Теперь вы настроите маршрут центра Интернета вещей для маршрутизации событий жизненного цикла устройства. В этом случае вы будете отдельно прослушивать события удаления устройства, идентифицируемые `if (opType == "deleteDeviceIdentity")` . Это вызовет удаление элемента Digital двойника, окончательное прекращение использования устройства и его цифровой двойника.

Сначала необходимо создать конечную точку концентратора событий в центре Интернета вещей. Затем вы добавите маршрут в центр Интернета вещей для отправки событий жизненного цикла в эту конечную точку концентратора событий.
Чтобы создать конечную точку концентратора событий, выполните следующие действия.

1. В [портал Azure](https://portal.azure.com/)перейдите к центру Интернета вещей, созданному в разделе [Предварительные требования](#prerequisites) , и выберите **Маршрутизация сообщений** в меню слева.
2. Выберите вкладку **Пользовательские конечные точки**.
3. Выберите **+ Добавить** и щелкните **концентраторы событий** , чтобы добавить конечную точку типа концентраторов событий.

    :::image type="content" source="media/how-to-provision-using-dps/event-hub-custom-endpoint.png" alt-text="Снимок экрана: окно Visual Studio для добавления пользовательской конечной точки концентратора событий." lightbox="media/how-to-provision-using-dps/event-hub-custom-endpoint.png":::

4. В окне *Добавьте конечную точку концентратора событий* , которая откроется, и выберите следующие значения:
    * **Имя конечной точки**: выберите имя конечной точки.
    * **Пространство имен концентратора событий**. Выберите пространство имен концентратора событий из раскрывающегося списка.
    * **Экземпляр концентратора событий**. Выберите имя концентратора событий, созданного на предыдущем шаге.
5. Нажмите кнопку **создания**. Не закрывайте это окно, чтобы добавить маршрут на следующем шаге.

    :::image type="content" source="media/how-to-provision-using-dps/add-event-hub-endpoint.png" alt-text="Снимок экрана: окно Visual Studio для добавления конечной точки концентратора событий." lightbox="media/how-to-provision-using-dps/add-event-hub-endpoint.png":::

Далее вы добавите маршрут, который подключается к конечной точке, созданной на предыдущем шаге, с запросом маршрутизации, который отправляет события удаления. Чтобы создать маршрут, выполните следующие действия.

1. Перейдите на вкладку *Routes (маршруты* ) и выберите **Добавить** , чтобы добавить маршрут.

    :::image type="content" source="media/how-to-provision-using-dps/add-message-route.png" alt-text="Снимок экрана: окно Visual Studio для добавления маршрута к отправке событий." lightbox="media/how-to-provision-using-dps/add-message-route.png":::

2. На открывшейся странице *Добавление маршрута* выберите следующие значения:

   * **Имя**: выберите имя для маршрута. 
   * **Конечная точка**. Выберите созданную ранее конечную точку концентраторов событий из раскрывающегося списка.
   * **Источник данных**: выберите *события жизненного цикла устройства*.
   * **Запрос маршрутизации**: введите `opType='deleteDeviceIdentity'` . Этот запрос ограничивает события жизненного цикла устройства для отправки только событий удаления.

3. Щелкните **Сохранить**.

    :::image type="content" source="media/how-to-provision-using-dps/lifecycle-route.png" alt-text="Снимок экрана портал Azure окна для добавления маршрута для отправки событий жизненного цикла." lightbox="media/how-to-provision-using-dps/lifecycle-route.png":::

Когда вы пройдете этот поток, все будет настроено на снятие устройств с учета.

### <a name="validate"></a>Проверить

Чтобы активировать процесс выхода из эксплуатации, необходимо вручную удалить устройство из центра Интернета вещей.

Это можно сделать с помощью [команды Azure CLI](/cli/azure/ext/azure-iot/iot/hub/module-identity#ext_azure_iot_az_iot_hub_module_identity_delete) или в портал Azure. Выполните следующие действия, чтобы удалить устройство в портал Azure.

1. Перейдите в центр Интернета вещей и выберите **устройства IOT** в меню слева. 
2. Вы увидите устройство с ИДЕНТИФИКАТОРом регистрации устройства, выбранным в [первой половине этой статьи](#auto-provision-device-using-device-provisioning-service). Кроме того, можно выбрать любое другое устройство для удаления, если оно содержит двойника в Azure Digital двойников, поэтому вы можете проверить, что двойника автоматически удаляется после удаления устройства.
3. Выберите устройство и нажмите кнопку **Удалить**.

:::image type="content" source="media/how-to-provision-using-dps/delete-device-twin.png" alt-text="Снимок экрана портал Azure для удаления двойникаа устройства с устройств IoT." lightbox="media/how-to-provision-using-dps/delete-device-twin.png":::

Просмотр изменений в Azure Digital двойников может занять несколько минут.

Используйте следующую команду [Azure Digital ДВОЙНИКОВ CLI](how-to-use-cli.md) , чтобы проверить, был ли удален двойника устройства в экземпляре Digital двойников Azure.

```azurecli-interactive
az dt twin show -n <Digital Twins instance name> --twin-id "<Device Registration ID>"
```

Вы увидите, что двойника устройства больше не может быть найдено в экземпляре Azure Digital двойников.

:::image type="content" source="media/how-to-provision-using-dps/show-retired-twin.png" alt-text="Снимок экрана командное окно, на котором отображается двойника, не найден." lightbox="media/how-to-provision-using-dps/show-retired-twin.png":::

## <a name="clean-up-resources"></a>Очистка ресурсов

Если ресурсы, созданные в этой статье, больше не нужны, выполните следующие действия, чтобы удалить их.

С помощью Azure Cloud Shell или локального Azure CLI можно удалить все ресурсы Azure в группе ресурсов с помощью команды [AZ Group Delete](/cli/azure/group#az-group-delete) . Это приведет к удалению группы ресурсов. экземпляр Azure Digital двойников; центр Интернета вещей и регистрация устройств концентратора; раздел "Сетка событий" и связанные подписки; пространство имен концентраторов событий и оба приложения функций Azure, включая связанные ресурсы, такие как хранилище.

> [!IMPORTANT]
> Удаление группы ресурсов — процесс необратимый. Группа ресурсов и все содержащиеся в ней ресурсы удаляются без возможности восстановления. Будьте внимательны, чтобы случайно не удалить не ту группу ресурсов или не те ресурсы. 

```azurecli-interactive
az group delete --name <your-resource-group>
```

Затем удалите папку примера проекта, скачанную с локального компьютера.

## <a name="next-steps"></a>Дальнейшие действия

Цифровые двойников, созданные для устройств, хранятся в виде плоской иерархии в Azure Digital двойников, но их можно расширить с помощью информации о модели и многоуровневой иерархии для Организации. Дополнительные сведения об этой концепции см. в следующих статье:

* [*Основные понятия: Цифровые двойников и двойника Graph*](concepts-twins-graph.md)

Дополнительные сведения об использовании HTTP-запросов с помощью функций Azure см. в следующих статьях:

* [*Триггер HTTP-запроса Azure для функций Azure*](../azure-functions/functions-bindings-http-webhook-trigger.md)

Вы можете написать настраиваемую логику для автоматического предоставления этих сведений с помощью модели и данных графа, уже сохраненных в Azure Digital двойников. Дополнительные сведения об управлении, обновлении и извлечении данных из графа двойников см. в следующих статьях:

* [*Практические руководства. Управление цифровым двойника*](how-to-manage-twin.md)
* [*Пошаговое руководство. запрос графа двойника*](how-to-query-graph.md)