---
title: Прием данных телеметрии из Центра Интернета вещей
titleSuffix: Azure Digital Twins
description: Узнайте, как получать сообщения телеметрии устройства из центра Интернета вещей.
author: alexkarcher-msft
ms.author: alkarche
ms.date: 9/15/2020
ms.topic: how-to
ms.service: digital-twins
ms.openlocfilehash: 3223a1c8e20d8b0caced5d940132c32fa0aba97c
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "103149104"
---
# <a name="ingest-iot-hub-telemetry-into-azure-digital-twins"></a>Прием данных телеметрии центра Интернета вещей в Azure Digital двойников

Azure Digital двойников управляет данными из устройств IoT и других источников. Общий источник данных устройства для использования в цифровом двойников Azure — это [центр Интернета вещей](../iot-hub/about-iot-hub.md).

Процесс приема данных в Azure Digital двойников заключается в настройке внешнего ресурса вычислений, например функции, выполняемой с помощью [функций Azure](../azure-functions/functions-overview.md). Функция получает данные и использует [API дигиталтвинс](/rest/api/digital-twins/dataplane/twins) для задания свойств или запуска событий телеметрии в [цифровом двойников](concepts-twins-graph.md) соответственно. 

В этом документе описывается процесс создания функции, которая может принимать данные телеметрии из центра Интернета вещей.

## <a name="prerequisites"></a>Предварительные требования

Прежде чем продолжить работу с этим примером, необходимо настроить следующие ресурсы в качестве необходимых компонентов:
* **Центр Интернета вещей**. Инструкции см. в разделе " *Создание центра Интернета вещей* " [этого руководства центра Интернета вещей](../iot-hub/quickstart-send-telemetry-cli.md).
* **Экземпляр цифрового двойников Azure** , который будет принимать данные телеметрии устройства. Инструкции см. [*в статье Настройка экземпляра и проверки подлинности Azure Digital двойников*](./how-to-set-up-instance-portal.md).

### <a name="example-telemetry-scenario"></a>Пример сценария телеметрии

В этой инструкции показано, как отправить сообщения из центра Интернета вещей в Azure Digital двойников с помощью функции в Azure. Существует множество возможных конфигураций и стратегий сопоставления, которые можно использовать для отправки сообщений, но пример для этой статьи содержит следующие компоненты.
* Устройство термостата в центре Интернета вещей с известным ИДЕНТИФИКАТОРом устройства
* Цифровой двойника для представления устройства с совпадающим ИДЕНТИФИКАТОРом

> [!NOTE]
> В этом примере используется понятный идентификатор, совпадающий с идентификатором устройства и соответствующим ИДЕНТИФИКАТОРом цифрового двойника, но можно предоставить более сложные сопоставления между устройством и его двойника (например, с таблицей сопоставлений).

Каждый раз, когда устройство термостата отправляет событие телеметрии температуры, функция обрабатывает данные телеметрии и свойство *температуры* цифрового двойника должно обновляться. Этот сценарий описан в схеме ниже:

:::image type="content" source="media/how-to-ingest-iot-hub-data/events.png" alt-text="Схема, показывающая блок-диаграмму. На диаграмме устройство центра Интернета вещей отправляет данные телеметрии температуры через центр Интернета вещей в функцию в Azure, которая обновляет свойство температуры двойника в Azure Digital двойников." border="false":::

## <a name="add-a-model-and-twin"></a>Добавление модели и двойника

В этом разделе вы настроите [цифровое двойника](concepts-twins-graph.md) в Azure Digital двойников, которое будет представлять устройство термостата и будет обновлено с информацией из центра Интернета вещей.

Чтобы создать термостата-тип двойника, сначала необходимо передать в экземпляр [модель](concepts-models.md) термостата, которая описывает свойства термостата и будет использоваться позже для создания двойника. 

Модель выглядит следующим образом:
:::code language="json" source="~/digital-twins-docs-samples/models/Thermostat.json":::

Чтобы **передать эту модель в экземпляр двойников**, выполните следующую команду Azure CLI, которая передает указанную выше модель в виде встроенного JSON. Можно выполнить команду в [Azure Cloud Shell](/cloud-shell/overview.md) в браузере или на компьютере, если интерфейс командной строки [установлен локально](/cli/azure/install-azure-cli.md).

```azurecli-interactive
az dt model create --models '{  "@id": "dtmi:contosocom:DigitalTwins:Thermostat;1",  "@type": "Interface",  "@context": "dtmi:dtdl:context;2",  "contents": [    {      "@type": "Property",      "name": "Temperature",      "schema": "double"    }  ]}' -n {digital_twins_instance_name}
```

Затем необходимо **создать один двойника с помощью этой модели**. Используйте следующую команду, чтобы создать термостата двойника с именем **thermostat67** и задать 0,0 в качестве начального значения температуры.

```azurecli-interactive
az dt twin create --dtmi "dtmi:contosocom:DigitalTwins:Thermostat;1" --twin-id thermostat67 --properties '{"Temperature": 0.0,}' --dt-name {digital_twins_instance_name}
```

>[!NOTE]
> При использовании Cloud Shell в среде PowerShell может потребоваться escape-последовательность символов кавычек во встроенных полях JSON, чтобы их значения были проанализированы должным образом. Ниже приведены команды для отправки модели и создания двойника с этим изменением.
>
> Модель передачи:
> ```azurecli-interactive
> az dt model create --models '{  \"@id\": \"dtmi:contosocom:DigitalTwins:Thermostat;1\",  \"@type\": \"Interface\",  \"@context\": \"dtmi:dtdl:context;2\",  \"contents\": [    {      \"@type\": \"Property\",      \"name\": \"Temperature\",      \"schema\": \"double\"    }  ]}' -n {digital_twins_instance_name}
> ```
>
> Создайте двойника:
> ```azurecli-interactive
> az dt twin create --dtmi "dtmi:contosocom:DigitalTwins:Thermostat;1" --twin-id thermostat67 --properties '{\"Temperature\": 0.0,}' --dt-name {digital_twins_instance_name}
> ```

После успешного создания двойника выходные данные CLI команды должны выглядеть примерно следующим образом:
```json
{
  "$dtId": "thermostat67",
  "$etag": "W/\"0000000-9735-4f41-98d5-90d68e673e15\"",
  "$metadata": {
    "$model": "dtmi:contosocom:DigitalTwins:Thermostat;1",
    "Temperature": {
      "ackCode": 200,
      "ackDescription": "Auto-Sync",
      "ackVersion": 1,
      "desiredValue": 0.0,
      "desiredVersion": 1
    }
  },
  "Temperature": 0.0
}
```

## <a name="create-a-function"></a>Создание функции

В этом разделе вы создадите функцию Azure для доступа к Azure Digital двойников и Update двойников на основе полученных событий телеметрии IoT. Выполните следующие действия, чтобы создать и опубликовать функцию.

#### <a name="step-1-create-a-function-app-project"></a>Шаг 1. Создание проекта приложения-функции

Сначала создайте новый проект приложения-функции в Visual Studio. Инструкции по выполнению этой задачи см. в разделе [**Создание приложения-функции в Visual Studio**](how-to-create-azure-function.md#create-a-function-app-in-visual-studio) статьи инструкции. *Настройка функции для обработки данных* .

#### <a name="step-2-fill-in-function-code"></a>Шаг 2. заполнение в коде функции

Добавьте в проект следующие пакеты:
* [Azure. Дигиталтвинс. Core](https://www.nuget.org/packages/Azure.DigitalTwins.Core/)
* [Azure. Identity](https://www.nuget.org/packages/Azure.Identity/)
* [Microsoft.Azure.WebJobs.Extensions.EventGrid](https://www.nuget.org/packages/Microsoft.Azure.WebJobs.Extensions.EventGrid/)

Переименуйте демонстрационную функцию *функция1. CS* , созданную Visual Studio с новым проектом, на *иосубтотвинс. CS*. Замените код в файле следующим кодом:

:::code language="csharp" source="~/digital-twins-docs-samples/sdks/csharp/IoTHubToTwins.cs":::

Сохраните код функции.

#### <a name="step-3-publish-the-function-app-to-azure"></a>Шаг 3. Публикация приложения функции в Azure

Опубликуйте проект в приложении-функции в Azure.

Инструкции по выполнению этой задачи см. в разделе [**Публикация приложения-функции в Azure**](how-to-create-azure-function.md#publish-the-function-app-to-azure) статьи *как настроить функцию для обработки данных* .

#### <a name="step-4-configure-the-function-app"></a>Шаг 4. Настройка приложения функции

Затем **назначьте роль доступа** для функции и **Настройте параметры приложения** таким образом, чтобы она могла получить доступ к вашему экземпляру Digital двойников для Azure. Инструкции о том, как это сделать, см. в разделе [**Настройка доступа к безопасности для приложения-функции**](how-to-create-azure-function.md#set-up-security-access-for-the-function-app) статьи *инструкции. Настройка функции для обработки данных* .

## <a name="connect-your-function-to-iot-hub"></a>Подключение функции к центру Интернета вещей

В этом разделе вы настроите функцию в качестве назначения события для данных устройства центра Интернета вещей. Это обеспечит отправку данных с устройства термостата в центре Интернета вещей в функцию Azure для обработки.

В [портал Azure](https://portal.azure.com/)перейдите к экземпляру центра Интернета вещей, созданному в разделе [*Предварительные требования*](#prerequisites) . В разделе **события** создайте подписку для функции.

:::image type="content" source="media/how-to-ingest-iot-hub-data/add-event-subscription.png" alt-text="Снимок экрана портал Azure, который показывает добавление подписки на события.":::

На странице **Создание подписки на события** заполните поля следующим образом:
  1. В поле **имя** выберите любое имя для подписки на события.
  2. Для **схемы событий** выберите _Схема сетки событий_.
  3. В качестве **имени системного раздела** выберите любое имя.
  1. **Чтобы применить фильтр к типам событий**, установите флажок _телеметрии устройства_ и снимите флажки для других типов событий.
  1. В качестве **типа конечной точки** выберите _функция Azure_.
  1. Для **конечной точки** используйте ссылку _Выбор конечной точки_ , чтобы выбрать функцию Azure, которая будет использоваться для конечной точки.
    
:::image type="content" source="media/how-to-ingest-iot-hub-data/create-event-subscription.png" alt-text="Снимок экрана портал Azure для создания сведений о подписке на события":::

На открывшейся странице _Выбор функции Azure_ проверьте или заполните указанные ниже сведения.
 1. **Подписка**: Вашу подписку Azure.
 2. **Группа ресурсов**. Ваша группа ресурсов.
 3. **Приложение функции**: имя приложения функции.
 4. **Слот**: _Рабочая_.
 5. **Функция**. Выберите в раскрывающемся списке функцию из предыдущего *иосубтотвинс*.

Сохраните данные с помощью кнопки _подтвердить выбор_ .            
      
:::image type="content" source="media/how-to-ingest-iot-hub-data/select-azure-function.png" alt-text="Снимок экрана портал Azure для выбора функции.":::

Нажмите кнопку _создать_ , чтобы создать подписку на событие.

## <a name="send-simulated-iot-data"></a>Отправка смоделированных данных IoT

Чтобы протестировать новую функцию, используйте симулятор устройств из руководства по [*подключению комплексного решения*](./tutorial-end-to-end.md). Этот учебник основан на примере проекта, написанного на языке C#. Пример кода расположен здесь: [Azure Digital двойников Samples](/samples/azure-samples/digital-twins-samples/digital-twins-samples). Вы будете использовать проект **девицесимулатор** в этом репозитории.

В сквозном руководстве выполните следующие действия.
1. [*Регистрация имитированного устройства в Центре Интернета вещей*](./tutorial-end-to-end.md#register-the-simulated-device-with-iot-hub)
2. [*Настройка и запуск имитации*](./tutorial-end-to-end.md#configure-and-run-the-simulation)

## <a name="validate-your-results"></a>Проверка результатов

При выполнении приведенного выше симулятора устройства значение температуры цифрового двойника будет изменено. В Azure CLI выполните следующую команду, чтобы увидеть значение температуры.

```azurecli-interactive
az dt twin query -q "select * from digitaltwins" -n {digital_twins_instance_name}
```

Выходные данные должны содержать значение температуры следующим образом:

```json
{
  "result": [
    {
      "$dtId": "thermostat67",
      "$etag": "W/\"0000000-1e83-4f7f-b448-524371f64691\"",
      "$metadata": {
        "$model": "dtmi:contosocom:DigitalTwins:Thermostat;1",
        "Temperature": {
          "ackCode": 200,
          "ackDescription": "Auto-Sync",
          "ackVersion": 1,
          "desiredValue": 69.75806974934324,
          "desiredVersion": 1
        }
      },
      "Temperature": 69.75806974934324
    }
  ]
}
```

Чтобы увидеть изменение значения, повторно выполните команду запроса выше.

## <a name="next-steps"></a>Следующие шаги

Узнайте о поступлении и исходящих данных в Azure Digital двойников:
* [*Основные понятия: интеграция с другими службами*](concepts-integration.md)
