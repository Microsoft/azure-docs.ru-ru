---
title: Интеграция со службой Azure SignalR
titleSuffix: Azure Digital Twins
description: Узнайте, как выполнять потоковую передачу данных телеметрии Azure Digital двойников в клиенты с помощью Azure SignalR.
author: dejimarquis
ms.author: aymarqui
ms.date: 02/12/2021
ms.topic: how-to
ms.service: digital-twins
ms.openlocfilehash: 89bd77c30ec52a72087598b86f22e85659fa1b0e
ms.sourcegitcommit: dda0d51d3d0e34d07faf231033d744ca4f2bbf4a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/05/2021
ms.locfileid: "102203901"
---
# <a name="integrate-azure-digital-twins-with-azure-signalr-service"></a>Интеграция Azure Digital двойников со службой Azure SignalR

Из этой статьи вы узнаете, как интегрировать Azure Digital двойников со [службой Azure SignalR](../azure-signalr/signalr-overview.md).

Решение, описанное в этой статье, позволяет отправлять данные телеметрии Digital двойника на подключенные клиенты, например одну веб-страницу или мобильное приложение. В результате клиенты обновляются с учетом метрик и состояния в реальном времени с устройств Интернета вещей без необходимости опрашивать сервер или отправлять новые HTTP-запросы на обновление.

## <a name="prerequisites"></a>Предварительные требования

Ниже приведены предварительные требования, которые необходимо выполнить перед продолжением.

* Перед интеграцией решения с помощью службы Azure SignalR в этой статье вы должны пройти руководство по работе с цифровыми Двойниковми Azure [_**: подключение комплексного решения**_](tutorial-end-to-end.md), поскольку эта статья посвящена сборке. В этом руководстве описано, как настроить экземпляр Digital двойников для Azure, который работает с виртуальным устройством IoT, чтобы активировать цифровые двойника обновления. В этой статье описывается, как подключить эти обновления к образцу веб-приложения с помощью службы Azure SignalR.

* В учебнике потребуются следующие значения:
  - Раздел "Сетка событий"
  - Группа ресурсов
  - Имя службы приложений или приложения-функции
    
* Вам потребуется [**Node.js**](https://nodejs.org/) , установленный на компьютере.

Также вы можете войти в [портал Azure](https://portal.azure.com/) с помощью учетной записи Azure.

## <a name="solution-architecture"></a>Архитектура решения

Вы будете присоединить службу Azure SignalR к Azure Digital двойников по указанному ниже пути. Разделы A, B и C на схеме основаны на схеме архитектуры [комплексного требования учебника](tutorial-end-to-end.md). В этом пошаговом руководстве вы создадите раздел D в существующей архитектуре.

:::image type="content" source="media/how-to-integrate-azure-signalr/signalr-integration-topology.png" alt-text="Обзор служб Azure в комплексном сценарии. Описание данных, передаваемых из устройства в центр Интернета вещей, с помощью функции Azure (стрелка б) в экземпляре Azure Digital двойников (раздел A), а затем из службы &quot;Сетка событий&quot; в другую функцию Azure для обработки (стрелка C). Раздел г показывает данные, передаваемые из одной и той же сетки событий с помощью стрелки C в функцию Azure с меткой &quot;вещание&quot;. &quot;Broadcast&quot; обменивается данными с другой функцией Azure, обозначенной как &quot;Negotiate&quot;, и &quot;Broadcast&quot; и &quot;Negotiate&quot; обмениваются данными с устройствами компьютера." lightbox="media/how-to-integrate-azure-signalr/signalr-integration-topology.png":::

## <a name="download-the-sample-applications"></a>Загрузка примеров приложений

Сначала скачайте необходимые примеры приложений. Потребуется следующее:
* [**Комплексные примеры для цифровых двойников Azure**](/samples/azure-samples/digital-twins-samples/digital-twins-samples/). Этот пример содержит *адтсамплеапп* , в котором содержатся две функции Azure для перемещения данных по экземпляру цифрового двойников Azure (Дополнительные сведения об этом сценарии см. в [*руководстве по подключению комплексного решения*](tutorial-end-to-end.md)). Он также содержит пример приложения *девицесимулатор* , которое имитирует устройство IOT, создавая новое значение температуры каждую секунду.
    - Если вы еще не скачали пример как часть руководства в разделе [*Предварительные требования*](#prerequisites), перейдите к образцу [ссылки](/samples/azure-samples/digital-twins-samples/digital-twins-samples/) и нажмите кнопку *обзора кода* под заголовком. Вы перейдете в репозиторий GitHub для примеров, которые можно скачать как *ZIP*-файлы. Для этого нажмите кнопку *Код* и выберите элемент *Скачать ZIP-файл*.

        :::image type="content" source="media/includes/download-repo-zip.png" alt-text="Представление репозитория примеров Digital Twins в GitHub. Выбрана кнопка &quot;Код&quot;, в результате чего отображается небольшое диалоговое окно с выделенной кнопкой &quot;Скачать ZIP-файл&quot;." lightbox="media/includes/download-repo-zip.png":::

    Это приведет к скачиванию копии примера репозитория на компьютер **digital-twins-samples-master.zip**. Распакуйте папку.
* [**Пример веб-приложения для интеграции SignalR**](/samples/azure-samples/digitaltwins-signalr-webapp-sample/digital-twins-samples/): это пример веб-приложения, которое будет использовать данные телеметрии Azure Digital двойников из службы Azure SignalR.
    -  Перейдите к образцу ссылки и используйте тот же процесс загрузки, чтобы скачать копию примера на свой компьютер, как _**digitaltwins-signalr-webapp-sample-main.zip**_. Распакуйте папку.

[!INCLUDE [Create instance](../azure-signalr/includes/signalr-quickstart-create-instance.md)]

Оставьте окно браузера открытым для портал Azure, так как оно будет использоваться снова в следующем разделе.

## <a name="publish-and-configure-the-azure-functions-app"></a>Публикация и настройка приложения "функции Azure"

В этом разделе вы настроите две функции Azure:
* **Negotiate** — функция триггера HTTP. Он использует входную привязку *сигналрконнектионинфо* для создания и возврата допустимых сведений о соединении.
* **Broadcast** — функция триггера [сетки событий](../event-grid/overview.md) . Он получает данные телеметрии Azure Digital двойников через сетку событий и использует выходную привязку экземпляра *SignalR* , созданного на предыдущем шаге, для передачи сообщения во все подключенные клиентские приложения.

Запустите Visual Studio (или другой редактор кода по своему усмотрению) и откройте решение Code в папке *Digital-двойников-Samples-master > адтсамплеапп* . Затем выполните следующие действия, чтобы создать функции.

1. В проекте *самплефунктионсапп* создайте новый класс C# с именем **SignalRFunctions.CS**.

1. Замените содержимое файла класса следующим кодом:
    
    :::code language="csharp" source="~/digital-twins-docs-samples/sdks/csharp/signalRFunction.cs":::

1. В окне *консоли диспетчера пакетов* Visual Studio или любом командном окне на компьютере перейдите к папке *дигитал-Твинс-самплес-мастер\адтсамплеапп\самплефунктионсапп* и выполните следующую команду, чтобы установить `SignalRService` пакет NuGet в проект:
    ```cmd
    dotnet add package Microsoft.Azure.WebJobs.Extensions.SignalRService --version 1.2.0
    ```

    Это должно устранить все проблемы с зависимостями в классе.

1. Опубликуйте свою функцию в Azure, выполнив действия, описанные в разделе " [ *Публикация приложения*](tutorial-end-to-end.md#publish-the-app) " руководства *Подключение комплексного решения* . Вы можете опубликовать его в той же функциональной службе приложений или приложении-функции, которая использовалась в комплексном [предварительном](#prerequisites)руководстве, или создать новую, но вы можете использовать один и тот же параметр, чтобы избежать дублирования. 

Затем настройте функции для взаимодействия с вашим экземпляром SignalR Azure. Сначала необходимо собрать **строку подключения** экземпляра SignalR, а затем добавить ее в параметры приложения "функции".

1. Перейдите на [портал Azure](https://portal.azure.com/) и найдите имя своего экземпляра SignalR в строке поиска в верхней части портала. Выберите экземпляр, чтобы открыть его.
1. Выберите **ключи** в меню экземпляр, чтобы просмотреть строки подключения для экземпляра службы SignalR.
1. Щелкните значок *копирования* , чтобы скопировать основную строку подключения.

    :::image type="content" source="media/how-to-integrate-azure-signalr/signalr-keys.png" alt-text="Снимок экрана портал Azure, на которой показана страница &quot;ключи&quot; для экземпляра SignalR. Будет выделен значок &quot;Копировать в буфер обмена&quot; рядом с основной СТРОКой подключения." lightbox="media/how-to-integrate-azure-signalr/signalr-keys.png":::

1. Наконец, добавьте **строку подключения** Azure SignalR в параметры приложения функции, используя следующую команду Azure CLI. Кроме того, замените заполнители на имя группы ресурсов и службы приложений или приложения-функции из [предварительных требований учебника](how-to-integrate-azure-signalr.md#prerequisites). Команду можно выполнить в [Azure Cloud Shell](https://shell.azure.com)или локально, если [на компьютере установлен](/cli/azure/install-azure-cli)Azure CLI.
 
    ```azurecli-interactive
    az functionapp config appsettings set -g <your-resource-group> -n <your-App-Service-(function-app)-name> --settings "AzureSignalRConnectionString=<your-Azure-SignalR-ConnectionString>"
    ```

    Выходные данные этой команды выводят все параметры приложения, настроенные для функции Azure. Найдите `AzureSignalRConnectionString` в нижней части списка, чтобы убедиться, что он добавлен.

    :::image type="content" source="media/how-to-integrate-azure-signalr/output-app-setting.png" alt-text="Фрагмент выходных данных в командном окне, отображающий элемент списка с именем &quot;Азуресигналрконнектионстринг&quot;":::

#### <a name="connect-the-function-to-event-grid"></a>Подключение функции к Сетке событий

Затем подпишите функцию *широковещательной рассылки* Azure в службу " **Сетка событий** ", созданную во время [предварительного требования учебника](how-to-integrate-azure-signalr.md#prerequisites). Это позволит передавать данные телеметрии из thermostat67 двойника через раздел сетки событий и в функцию. Здесь функция может транслировать данные на все клиенты.

Для этого вы создадите **подписку на события** в разделе "Сетка событий", чтобы *транслировать* функцию Azure в качестве конечной точки.

На [портале Azure](https://portal.azure.com/) перейдите к своему разделу Сетки событий, выполнив поиск по его имени в верхней строке поиска. Выберите *+ Event Subscription* (+ Подписка на события).

:::image type="content" source="media/how-to-integrate-azure-signalr/event-subscription-1b.png" alt-text="Портал Azure: подписка на события Сетки событий":::

На странице *Создание подписки на событие* заполните поля следующим образом (поля, заполненные по умолчанию, не указываются):
* *СВЕДЕНИЯ О ПОДПИСКЕ НА СОБЫТИЯ* > **Имя**: укажите имя для подписки на события.
* *СВЕДЕНИЯ О КОНЕЧНОЙ ТОЧКЕ* > **Тип конечной точки**: выберите в меню пункт *Функция Azure*.
* *СВЕДЕНИЯ О КОНЕЧНОЙ ТОЧКЕ* > **Конечная точка**: нажмите ссылку *Выбор конечной точки*. Откроется окно *Выбор функции Azure*:
    - Заполните **подписку**, **группу ресурсов**, **приложение-функцию** и **функцию** (*вещание*). После выбора подписки некоторые из этих полей могут быть заполнены автоматически.
    - Нажмите кнопку **Подтвердить выбор**.

:::image type="content" source="media/how-to-integrate-azure-signalr/create-event-subscription.png" alt-text="Портал Azure представление о создании подписки на события. Поля, указанные выше, заполнены, а кнопки &quot;подтвердить выделение&quot; и &quot;создать&quot; выделены.":::

Вернитесь на страницу *Создание подписки на события* и нажмите кнопку **Создать**.

На этом этапе вы должны увидеть две подписки на события на странице *раздела "Сетка событий* ".

:::image type="content" source="media/how-to-integrate-azure-signalr/view-event-subscriptions.png" alt-text="Портал Azure представление двух подписок на события на странице раздела &quot;Сетка событий&quot;." lightbox="media/how-to-integrate-azure-signalr/view-event-subscriptions.png":::

## <a name="configure-and-run-the-web-app"></a>Настройка и запуск веб-приложения

В этом разделе вы увидите результат в действии. Сначала настройте **Пример клиентского веб-приложения** для подключения к настроенному потоку SignalR Azure. Далее вы запустили **пример приложения для имитации устройства** , которое отправляет данные телеметрии через ваш экземпляр Azure Digital двойников. После этого вы сможете просмотреть пример веб-приложения, чтобы увидеть данные имитации устройства, обновляющие пример веб-приложения в режиме реального времени.

### <a name="configure-the-sample-client-web-app"></a>Настройка примера клиентского веб-приложения

Далее вы настроите пример клиентского веб-приложения. Начните с сбора **URL-адреса конечной точки HTTP** функции *Negotiate* , а затем используйте ее для настройки кода приложения на компьютере.

1. Перейдите на страницу приложений- [функций](https://portal.azure.com/#blade/HubsExtension/BrowseResource/resourceType/Microsoft.Web%2Fsites/kind/functionapp) портал Azure и выберите приложение-функцию из списка. В меню приложение выберите *функции* и выберите функцию *согласовать* .

    :::image type="content" source="media/how-to-integrate-azure-signalr/functions-negotiate.png" alt-text="Портал Azure представление приложения функции, в меню которого выделено &quot;функции&quot;. Список функций отображается на странице, и функция &quot;Negotiate&quot; также выделяется.":::

1. Нажмите *получить URL-адрес функции* и скопируйте значение **до _/API_ (не включайте последние _/неготиате?_)**. Это можно будет использовать на следующем шаге.

    :::image type="content" source="media/how-to-integrate-azure-signalr/get-function-url.png" alt-text="Портал Azure представление функции &quot;Negotiate&quot;. Кнопка &quot;получить URL-адрес функции&quot; выделена и часть URL-адреса с начала до &quot;/API&quot;":::

1. Используя Visual Studio или любой другой редактор кода, откройте папку unzipped дигиталтвинс- _**webapp-Sample-Main**_ , скачанную в разделе [*Загрузка примеров приложений*](#download-the-sample-applications) .

1. Откройте файл *src/App.js* и замените URL-адрес функции в `HubConnectionBuilder` URL-адресом конечной точки HTTP функции **Negotiate** , сохраненной на предыдущем шаге.

    ```javascript
        const hubConnection = new HubConnectionBuilder()
            .withUrl('<Function URL>')
            .build();
    ```
1. В *командной строке разработчика* Visual Studio или любом командном окне на компьютере перейдите в папку *дигиталтвинс-сигналр-вебапп-сампле-маин\срк* . Выполните следующую команду, чтобы установить пакеты зависимых узлов:

    ```cmd
    npm install
    ```

Затем задайте разрешения в приложении функции в портал Azure:
1. На странице приложения- [функции](https://portal.azure.com/#blade/HubsExtension/BrowseResource/resourceType/Microsoft.Web%2Fsites/kind/functionapp) портал Azure выберите экземпляр приложения-функции.

1. Прокрутите вниз в меню экземпляр и выберите *CORS*. На странице CORS добавьте в `http://localhost:3000` качестве разрешенного источника, введя его в пустое поле. Установите флажок *включить доступ — управление-разрешить-учетные данные* и нажмите кнопку *сохранить*.

    :::image type="content" source="media/how-to-integrate-azure-signalr/cors-setting-azure-function.png" alt-text="Параметр CORS в функции Azure":::

### <a name="run-the-device-simulator"></a>Запуск симулятора устройства

Во время комплексного требования к учебнику вы [настроили симулятор устройств](tutorial-end-to-end.md#configure-and-run-the-simulation) для отправки данных через центр Интернета вещей и ваш экземпляр Azure Digital двойников.

Теперь все, что нужно сделать, — это запустить проект симулятора, расположенный в *цифровом двойников-Samples-master > девицесимулатор > девицесимулатор. sln*. Если вы используете Visual Studio, вы можете открыть проект, а затем запустить его с помощью этой кнопки на панели инструментов:

:::image type="content" source="media/how-to-integrate-azure-signalr/start-button-simulator.png" alt-text="Кнопка запуска Visual Studio (проект DeviceSimulator)":::

Откроется окно консоли, в котором будут отображаться сымитированные сообщения телеметрии температуры. Они отправляются через экземпляр Azure Digital двойников, где они затем выбираются функциями и SignalR Azure.

Вам не нужно ничего делать в этой консоли, но оставить ее в процессе выполнения следующего шага.

### <a name="see-the-results"></a>Просмотр результатов

Чтобы увидеть результаты в действии, запустите **Пример веб-приложения "Интеграция SignalR**". Это можно сделать в любом окне консоли в расположении *дигиталтвинс-сигналр-вебапп-сампле-маин\срк* , выполнив следующую команду:

```cmd
npm start
```

Откроется окно браузера с примером приложения, в котором отображается датчик температуры визуального элемента. После запуска приложения вы должны увидеть значения телеметрии температуры из симулятора устройств, распространяемого через Azure Digital двойников, которые веб-приложение отражает в режиме реального времени.

:::image type="content" source="media/how-to-integrate-azure-signalr/signalr-webapp-output.png" alt-text="Выдержка из примера клиентского веб-приложения, показывающая визуальный датчик температуры. Температура отражена в 67,52":::

## <a name="clean-up-resources"></a>Очистка ресурсов

Если ресурсы, созданные в этой статье, больше не нужны, выполните следующие действия, чтобы удалить их. 

С помощью Azure Cloud Shell или локального Azure CLI можно удалить все ресурсы Azure в группе ресурсов с помощью команды [AZ Group Delete](/cli/azure/group#az-group-delete) . Удаление группы ресурсов также приведет к удалению...
* экземпляр Azure Digital двойников (из комплексного руководства)
* центр Интернета вещей и регистрация устройств концентратора (из комплексного руководства)
* раздел "Сетка событий" и связанные подписки
* приложение функций Azure, включая все три функции и связанные ресурсы, такие как хранилище.
* экземпляр Azure SignalR

> [!IMPORTANT]
> Удаление группы ресурсов — процесс необратимый. Группа ресурсов и все содержащиеся в ней ресурсы удаляются без возможности восстановления. Будьте внимательны, чтобы случайно не удалить не ту группу ресурсов или не те ресурсы. 

```azurecli-interactive
az group delete --name <your-resource-group>
```

Наконец, удалите примеры папок проекта, загруженные на локальный компьютер (*digital-twins-samples-master.zip*, *digitaltwins-signalr-webapp-sample-main.zip* и их несжатые аналоги).

## <a name="next-steps"></a>Дальнейшие действия

В этой статье вы настроите функции Azure с SignalR, чтобы транслировать события телеметрии Digital двойников в пример клиентского приложения.

Далее вы узнаете о службе Azure SignalR:
* [*Сведения о службе Azure SignalR*](../azure-signalr/signalr-overview.md)

Или Узнайте больше о проверке подлинности службы Azure SignalR с помощью функций Azure:
* [*Проверка подлинности службы Azure SignalR*](../azure-signalr/signalr-tutorial-authenticate-azure-functions.md)