---
title: Доставка и повторные попытки доставки сетки событий Azure
description: В статье описывается, как сетка событий Azure передает события и обрабатывает недоставленные сообщения.
ms.topic: conceptual
ms.date: 10/29/2020
ms.openlocfilehash: 3c4ed6ec2c9eae4dbcf70a831e3e7f70a28a57a0
ms.sourcegitcommit: 08458f722d77b273fbb6b24a0a7476a5ac8b22e0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/15/2021
ms.locfileid: "98247375"
---
# <a name="event-grid-message-delivery-and-retry"></a>Доставка и повторные попытки доставки сообщений сетки событий

В этой статье описывается, как Сетка событий Azure обрабатывает события, когда доставка не подтверждена.

Сетка событий обеспечивает надежную доставку. Он доставляет каждое сообщение **по крайней мере один раз** для каждой подписки. Отправка событий для зарегистрированных веб-перехватчиков каждой подписки осуществляется мгновенно. Если конечная точка не подтверждает получения события, "Сетка событий" предпринимает повторную попытку доставить событие.

> [!NOTE]
> Сетка событий не гарантирует порядок доставки событий, поэтому подписчик может получить их не по порядку. 

## <a name="batched-event-delivery"></a>Пакетная доставка событий

По умолчанию сетка событий отправляет каждое событие по отдельности подписчикам. Каждый подписчик получает массив с одним событием. Вы можете настроить в службе "Сетка событий" пакетные события для доставки, чтобы улучшить производительность HTTP в сценариях с высокой пропускной способностью.

Пакетная доставка имеет два параметра:

* Максимальное число **событий на пакет** — максимально допустимое количество событий в сетке событий для каждого пакета. Это число никогда не будет превышено, однако если во время публикации не будут доступны другие события, может доставляться меньшее количество событий. Сетка событий не задерживает события, чтобы создать пакет, если доступно меньшее количество событий. Должно быть в диапазоне от 1 до 5 000.
* **Предпочтительный размер пакета в килобайтах** — размер пакета в килобайтах. Как и в случае с Max Events, размер пакета может быть меньше, если в момент публикации больше событий не будет доступно. Возможно, что пакет больше, чем размер предпочтительного размера пакета, *Если* одно событие больше предпочтительного размера. Например, если предпочтительный размер равен 4 КБ, а событие 10 КБ отправлено в сетку событий, то событие 10 КБ по-прежнему будет доставлено в отдельном пакете, а не удалено.

Пакетная доставка, настроенная на основе подписки на события, осуществляется с помощью портала, интерфейса командной строки, PowerShell или пакетов SDK.

### <a name="azure-portal"></a>Портал Azure: 
![Параметры пакетной доставки](./media/delivery-and-retry/batch-settings.png)

### <a name="azure-cli"></a>Azure CLI
При создании подписки на события используйте следующие параметры: 

- **Max-Events-для каждого пакета** — максимальное количество событий в пакете. Должно быть числом от 1 до 5000.
- **предпочтительный — пакетный — размер в килобайтах** — предпочтительный размер пакета в килобайтах. Должно быть числом от 1 до 1024.

```azurecli
storageid=$(az storage account show --name <storage_account_name> --resource-group <resource_group_name> --query id --output tsv)
endpoint=https://$sitename.azurewebsites.net/api/updates

az eventgrid event-subscription create \
  --resource-id $storageid \
  --name <event_subscription_name> \
  --endpoint $endpoint \
  --max-events-per-batch 1000 \
  --preferred-batch-size-in-kilobytes 512
```

Дополнительные сведения об использовании Azure CLI с таблицей событий см. в разделе [Маршрутизация событий хранилища в веб-конечную точку с Azure CLI](../storage/blobs/storage-blob-event-quickstart.md).

## <a name="retry-schedule-and-duration"></a>График повторных попыток и длительность

Когда EventGrid получает ошибку для попытки доставки события, EventGrid определяет, следует ли повторить доставку или недоставленное сообщение или удалить событие в зависимости от типа ошибки. 

Если ошибка, возвращенная конечной точкой подписки, связана с ошибкой конфигурации, которую невозможно исправить с повторными попытками (например, если конечная точка удалена), EventGrid будет выполнять недоставленное событие или удалить событие, если недоставленная буква не настроена.

Ниже приведены типы конечных точек, для которых не происходит повторная попытка.

| Тип конечной точки | Коды ошибок |
| --------------| -----------|
| ресурсов Azure | 400. недопустимый запрос, слишком большой объект запроса 413, 403 запрещено | 
| webhook | 400. недопустимый запрос, слишком большой объект запроса 413, 403, 404 не найден, 401 не авторизовано |
 
> [!NOTE]
> Если Dead-Letter не настроена для конечной точки, события будут удаляться при возникновении ошибок выше. Рассмотрите возможность настройки недоставленных сообщений, если вы не хотите, чтобы эти виды событий были удалены.

Если ошибка, возвращенная конечной точкой подписки, не входит в список выше, EventGrid выполняет повторную попытку с помощью политик, описанных ниже.

Сетка событий ожидает ответа в течение 30 секунд после доставки сообщения. Через 30 секунд, если конечная точка не ответила, сообщение помещается в очередь для повтора. Для доставки событий сетка событий использует политику экспоненциального увеличения задержки повтора. Сетка событий повторяет доставку по следующему расписанию с учетом оптимального объема:

- 10 с
- 30 секунд
- 1 минута
- 5 мин
- 10 минут.
- 30 минут
- 1 час
- 3 часа
- 6 часов.
- Каждые 12 часов до 24 часов


Если конечная точка отвечает в течение 3 минут, то сетка событий попытается удалить событие из очереди повторов с наибольшей вероятностью, но повторы по-прежнему могут быть получены.

Сетка событий добавляет небольшой случай для всех шагов повтора и может рационально пропускать определенные повторные попытки, если конечная точка постоянно неработоспособна, не работает в течение длительного времени или перегружена.

Для детерминированного поведения задайте для параметра время события значение Live и максимальное число попыток доставки в [политиках повтора подписки](manage-event-delivery.md).

По умолчанию служба "Сетка событий" завершает срок действия всех событий, которые не были доставлены в течение 24 часов. [Политику повтора можно настроить](manage-event-delivery.md) во время создания подписки на события. Укажите максимальное число попыток доставки (по умолчанию — 30) и срок жизни события (по умолчанию — 1440 минут).

## <a name="delayed-delivery"></a>Отложенная доставка

В качестве конечной точки происходит сбой доставки, и сетка событий начинает откладывать доставку и повторы событий в эту конечную точку. Например, если первые 10 событий, опубликованных в конечной точке, завершатся ошибкой, то сетка событий будет считать, что в конечной точке возникли проблемы, и будет задерживать все последующие повторы *и новые* доставки на некоторое время в течение нескольких часов.

Функциональное назначение отложенной доставки заключается в защите неработоспособных конечных точек, а также системы сетки событий. Без резервного копирования и задержки доставки к неработоспособным конечным точкам политика повтора и возможности тома сетки событий могут легко перегружать систему.

## <a name="dead-letter-events"></a>События недоставленных сообщений
Когда сетка событий не может доставить событие в течение определенного периода времени или после попытки доставить событие определенное количество раз, оно может отправить недоставленное событие в учетную запись хранения. Этот процесс называется **недоставленным**. При выполнении **одного из следующих** условий сетка событий не отменяет письма. 

- Событие не доставлено в течение срока **жизни** . 
- **Число попыток** доставки события превысило предельное значение.

Если одно из условий выполнено, событие удаляется или недоставлено.  По умолчанию в службе "Сетка событий Azure" не включено перемещение в очередь недоставленных сообщений. Чтобы его включить, необходимо указать учетную запись хранения недоставленных событий при создании подписки на событие. Можно извлекать события из этой учетной записи хранения, чтобы продолжать доставку.

"Сетка событий" отправляет событие расположение недоставленных в том случае, когда действие выполнялось все повторные попытки. Если сетка событий получает код ответа 400 (недопустимый запрос) или 413 (слишком большой объект запроса), он немедленно планирует событие для недоставленного письма. Эти коды отклика указывают, что доставка события никогда не будет выполнена успешно.

Срок действия срока жизни проверяется только при следующей попытке запланированной доставки. Таким образом, даже если срок действия срока жизни истекает до следующей запланированной попытки доставки, срок действия события проверяется только во время следующей доставки, а затем помещается в недоставленное письмо. 

Предусмотрена 5-минутная задержка между последней попыткой доставить событие и доставкой этого события в расположение недоставленных сообщений. Эта задержка предназначена для уменьшения количества операций в хранилище BLOB-объектов. Если расположение недоставленных сообщений недоступно в течение четырех часов, событие удаляется.

Прежде чем задать параметры расположения недоставленных сообщений, необходимо создать учетную запись хранения с контейнером. При создании подписки на событие необходимо ввести конечную точку для этого контейнера. Конечная точка имеет следующий формат: `/subscriptions/<subscription-id>/resourceGroups/<resource-group-name>/providers/Microsoft.Storage/storageAccounts/<storage-name>/blobServices/default/containers/<container-name>`

Может потребоваться получать уведомления, когда события был отправлен в расположение недоставленных сообщений. Чтобы использовать службу "Сетка событий Azure" для реагирования на недоставленные события, [создайте подписку на события](../storage/blobs/storage-blob-event-quickstart.md?toc=%2fazure%2fevent-grid%2ftoc.json) для хранилища больших двоичных объектов недоставленных сообщений. Каждый раз, когда ваше хранилище больших двоичных объектов недоставленных сообщений получает недоставленное событие, служба "Сетка событий Azure" уведомляет вашего обработчика. Обработчик отвечает действиями, которые необходимо предпринять для согласования недоставленных событий. Пример настройки расположения недоставленных сообщений и политик повтора см. в статье [политики недоставленных сообщений и повторных](manage-event-delivery.md)попыток.

## <a name="delivery-event-formats"></a>Форматы событий доставки
В этом разделе приводятся примеры событий и событий с недоставленными сообщениями в различных форматах схемы доставки (схема сетки событий, схема Клаудевентс 1,0 и пользовательская схема). Дополнительные сведения об этих форматах см. в статье [Схема сетки событий](event-schema.md) и [облачные события 1,0](cloud-event-schema.md) . 

### <a name="event-grid-schema"></a>Схема службы "Сетка событий"

#### <a name="event"></a>Событие 
```json
{
    "id": "93902694-901e-008f-6f95-7153a806873c",
    "eventTime": "2020-08-13T17:18:13.1647262Z",
    "eventType": "Microsoft.Storage.BlobCreated",
    "dataVersion": "",
    "metadataVersion": "1",
    "topic": "/subscriptions/000000000-0000-0000-0000-00000000000000/resourceGroups/rgwithoutpolicy/providers/Microsoft.Storage/storageAccounts/myegteststgfoo",
    "subject": "/blobServices/default/containers/deadletter/blobs/myBlobFile.txt",    
    "data": {
        "api": "PutBlob",
        "clientRequestId": "c0d879ad-88c8-4bbe-8774-d65888dc2038",
        "requestId": "93902694-901e-008f-6f95-7153a8000000",
        "eTag": "0x8D83FACDC0C3402",
        "contentType": "text/plain",
        "contentLength": 0,
        "blobType": "BlockBlob",
        "url": "https://myegteststgfoo.blob.core.windows.net/deadletter/myBlobFile.txt",
        "sequencer": "00000000000000000000000000015508000000000005101c",
        "storageDiagnostics": { "batchId": "cfb32f79-3006-0010-0095-711faa000000" }
    }
}
```

#### <a name="dead-letter-event"></a>Недоставленное событие

```json
{
    "id": "93902694-901e-008f-6f95-7153a806873c",
    "eventTime": "2020-08-13T17:18:13.1647262Z",
    "eventType": "Microsoft.Storage.BlobCreated",
    "dataVersion": "",
    "metadataVersion": "1",
    "topic": "/subscriptions/0000000000-0000-0000-0000-000000000000000/resourceGroups/rgwithoutpolicy/providers/Microsoft.Storage/storageAccounts/myegteststgfoo",
    "subject": "/blobServices/default/containers/deadletter/blobs/myBlobFile.txt",    
    "data": {
        "api": "PutBlob",
        "clientRequestId": "c0d879ad-88c8-4bbe-8774-d65888dc2038",
        "requestId": "93902694-901e-008f-6f95-7153a8000000",
        "eTag": "0x8D83FACDC0C3402",
        "contentType": "text/plain",
        "contentLength": 0,
        "blobType": "BlockBlob",
        "url": "https://myegteststgfoo.blob.core.windows.net/deadletter/myBlobFile.txt",
        "sequencer": "00000000000000000000000000015508000000000005101c",
        "storageDiagnostics": { "batchId": "cfb32f79-3006-0010-0095-711faa000000" }
    },

    "deadLetterReason": "MaxDeliveryAttemptsExceeded",
    "deliveryAttempts": 1,
    "lastDeliveryOutcome": "NotFound",
    "publishTime": "2020-08-13T17:18:14.0265758Z",
    "lastDeliveryAttemptTime": "2020-08-13T17:18:14.0465788Z" 
}
```

### <a name="cloudevents-10-schema"></a>Схема Клаудевентс 1,0

#### <a name="event"></a>Событие

```json
{
    "id": "caee971c-3ca0-4254-8f99-1395b394588e",
    "source": "mysource",
    "dataversion": "1.0",
    "subject": "mySubject",
    "type": "fooEventType",
    "datacontenttype": "application/json",
    "data": {
        "prop1": "value1",
        "prop2": 5
    }
}
```

#### <a name="dead-letter-event"></a>Недоставленное событие

```json
{
    "id": "caee971c-3ca0-4254-8f99-1395b394588e",
    "source": "mysource",
    "dataversion": "1.0",
    "subject": "mySubject",
    "type": "fooEventType",
    "datacontenttype": "application/json",
    "data": {
        "prop1": "value1",
        "prop2": 5
    },

    "deadletterreason": "MaxDeliveryAttemptsExceeded",
    "deliveryattempts": 1,
    "lastdeliveryoutcome": "NotFound",
    "publishtime": "2020-08-13T21:21:36.4018726Z",
}
```

### <a name="custom-schema"></a>Пользовательская схема

#### <a name="event"></a>Событие

```json
{
    "prop1": "my property",
    "prop2": 5,
    "myEventType": "fooEventType"
}

```

#### <a name="dead-letter-event"></a>Недоставленное событие
```json
{
    "id": "8bc07e6f-0885-4729-90e4-7c3f052bd754",
    "eventTime": "2020-08-13T18:11:29.4121391Z",
    "eventType": "myEventType",
    "dataVersion": "1.0",
    "metadataVersion": "1",
    "topic": "/subscriptions/00000000000-0000-0000-0000-000000000000000/resourceGroups/rgwithoutpolicy/providers/Microsoft.EventGrid/topics/myCustomSchemaTopic",
    "subject": "subjectDefault",
  
    "deadLetterReason": "MaxDeliveryAttemptsExceeded",
    "deliveryAttempts": 1,
    "lastDeliveryOutcome": "NotFound",
    "publishTime": "2020-08-13T18:11:29.4121391Z",
    "lastDeliveryAttemptTime": "2020-08-13T18:11:29.4277644Z",
  
    "data": {
        "prop1": "my property",
        "prop2": 5,
        "myEventType": "fooEventType"
    }
}
```


## <a name="message-delivery-status"></a>Состояние доставки сообщения

Сетка событий использует коды ответов HTTP для подтверждения получения событий. 

### <a name="success-codes"></a>Коды успешного завершения

В сетке событий в качестве успешных поставок рассматриваются **только** следующие коды ответов HTTP. Все другие коды состояния считаются неудачными доставкой, которые будут повторены или недоставленное по мере необходимости. После получения успешного кода состояния сетка событий считает, что доставка завершена.

- 200 ОК
- 201 Создано
- 202 — принято
- 203. неофициальная информация
- 204 No Content (содержимое отсутствует)

### <a name="failure-codes"></a>Коды сбоя доставки

Все остальные коды, отсутствующие в указанном выше наборе (200-204), считаются ошибками и будут повторены (при необходимости). Некоторые из них привязаны к указанным ниже политикам повтора, все остальные следуют стандартной модели экспоненциального возврата. Важно помнить, что из-за высокой параллелизации архитектуры сетки событий поведение повторов не детерминировано. 

| Код состояния | Поведение при повторе |
| ------------|----------------|
| 400 — недопустимый запрос | Повторных попыток |
| 401 — недостаточно прав | Повторите попытку через 5 минут или больше для конечных точек ресурсов Azure |
| 403. Запрещено | Повторных попыток |
| 404 — не найдено | Повторите попытку через 5 минут или больше для конечных точек ресурсов Azure |
| 408 — Истекло время ожидания запроса | Повторить через 2 минуты или больше |
| 413 — размер запрашиваемой сущности слишком большой | Повторных попыток |
| 503 — Служба недоступна | Повторная попытка через 30 секунд или более |
| Все остальные | Повторная попытка через 10 секунд или более |


## <a name="next-steps"></a>Дальнейшие действия

* Сведения о том, как просмотреть состояние доставки событий, см. в статье [Мониторинг доставки сообщений Сетки событий](monitor-event-delivery.md).
* Чтобы настроить параметры доставки событий, см. в разделе [Недоставленные сообщения и политики повтора](manage-event-delivery.md).
