---
title: Устранение неполадок с сетевым подключением в службе "Сетка событий Azure" | Документация Майкрософт
description: Эта статья содержит сведения об устранении проблем с сетевым подключением в службе "Сетка событий Azure".
author: batrived
ms.topic: article
ms.date: 06/21/2020
ms.author: batrived
ms.openlocfilehash: fa119784715b8c88ef3c9f2700b2cac1cc467234
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "96339751"
---
# <a name="troubleshoot-connectivity-issues---azure-event-grid"></a>Устранение неполадок подключения — служба "Сетка событий Azure"

Существуют различные причины, по которым клиентские приложения не могут подключаться к разделу или домену сетки событий. Возникающие проблемы с подключением могут быть постоянными или временными. Если эта ошибка происходит постоянно, может потребоваться проверить параметры брандмауэра организации, параметры брандмауэра IP-адресов, Теги службы, частные конечные точки и многое другое. Для временных проблем выполнение команд для проверки пропущенных пакетов и получение трассировки сети может помочь в устранении неполадок.

В этой статье приводятся советы по устранению проблем с подключением к службе "Сетка событий Azure".

## <a name="troubleshoot-permanent-connectivity-issues"></a>Устранение проблем с постоянным подключением

Если приложение не может подключиться к сетке событий, выполните действия из этого раздела, чтобы устранить проблему.

### <a name="check-if-theres-a-service-outage"></a>Проверка сбоя службы

Проверьте наличие сбоя службы "Сетка событий Azure" на [сайте состояния службы Azure](https://azure.microsoft.com/status/).

### <a name="check-if-the-ports-required-to-communicate-with-event-grid-arent-blocked-by-organizations-firewall"></a>Убедитесь, что порты, необходимые для взаимодействия со службой "Сетка событий", не заблокированы брандмауэром организации.

Убедитесь, что порты, используемые для связи со службой "Сетка событий Azure", не заблокированы в брандмауэре вашей организации. В следующей таблице приведены исходящие порты, которые необходимо открыть для взаимодействия со службой "Сетка событий Azure".

| Протокол | порты; |
| -------- | ----- |
| HTTPS    | 443   |

Ниже приведен пример команды, которая проверяет, заблокирован ли порт 443.

```powershell
.\psping.exe -n 25 -i 1 -q {sampletopicname}.{region}-{suffix}.eventgrid.azure.net:443 -nobanner
```

В Linux

```shell
telnet {sampletopicname}.{region}-{suffix}.eventgrid.azure.net 443
```

### <a name="verify-that-ip-addresses-are-allowed-in-your-corporate-firewall"></a>Убедитесь, что IP-адреса разрешены в корпоративном брандмауэре.

При работе с Azure иногда необходимо разрешить определенные диапазоны IP-адресов или URL-адреса в корпоративном брандмауэре или прокси, чтобы получить доступ ко всем используемым службам Azure или по мере использования. Убедитесь, что трафик разрешен для IP-адресов, используемых службой "Сетка событий". IP-адреса, используемые службой "Сетка событий Azure": см. в разделе [диапазоны IP-адресов Azure и теги службы — общедоступное облако](https://www.microsoft.com/download/details.aspx?id=56519) и [тег службы — азуривентгрид](network-security.md#service-tags).

[Диапазоны IP-адресов и теги службы Azure — общедоступный облачный](https://www.microsoft.com/download/details.aspx?id=56519) документ также перечисляет IP-адреса **по регионам**. Вы можете разрешить диапазоны адресов для **региона раздела** и **парного региона** в корпоративном брандмауэре или прокси-сервере. Сведения о постоянном регионе для региона см. в разделе [непрерывность бизнес-процессов и аварийное восстановление (BCDR): Парные регионы Azure](../best-practices-availability-paired-regions.md). 

> [!NOTE]
> Новые IP-адреса можно добавить в тег службы Азуривентгрид, хотя обычно это не так. Поэтому рекомендуется выполнять еженедельную проверку тегов службы.

### <a name="verify-that-azureeventgrid-service-tag-is-allowed-in-your-network-security-groups"></a>Убедитесь, что тег службы Азуривентгрид разрешен в группах безопасности сети.

Если приложение работает в подсети и имеется связанная группа безопасности сети, убедитесь, что разрешено использование исходящего трафика из Интернета или разрешается использовать тег службы Азуривентгрид. См. [теги служб](../virtual-network/service-tags-overview.md)

### <a name="check-the-ip-firewall-settings-for-your-topicdomain"></a>Проверьте параметры брандмауэра IP-адресов для раздела или домена.

Убедитесь, что общедоступный IP-адрес компьютера, на котором работает приложение, не заблокирован в разделе EventGrid или брандмауэре IP-адреса домена.

По умолчанию разделы и домены сетки событий доступны через Интернет, если запрос сопровождается действительной проверкой подлинности и авторизацией. С помощью брандмауэра для IP-адресов такой доступ можно дополнительно ограничить набором или диапазоном IPv4-адресов в нотации [CIDR](https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing).

Правила брандмауэра IP-адресов применяются на уровне раздела или домена сетки событий. Поэтому они действуют для всех клиентских подключений по любым поддерживаемым протоколам. Любые попытки подключения с IP-адреса, который не соответствует разрешенному правилу IP-адресов в разделе или домене сетки событий, отклоняются как запрещенные. В ответе не упоминается правило IP-адресов.

Дополнительные сведения см. в [статье Настройка правил брандмауэра для IP-адресов для раздела или домена службы "Сетка событий Azure](configure-firewall.md)".

#### <a name="find-the-ip-addresses-blocked-by-ip-firewall"></a>Поиск IP-адресов, блокируемых брандмауэром IP

Включение журналов диагностики для раздела или домена сетки событий [Включение журналов диагностики](enable-diagnostic-logs-topic.md#enable-diagnostic-logs-for-a-custom-topic). Вы увидите IP-адрес для запрещенного подключения.

```json
{
  "time": "2019-11-01T00:17:13.4389048Z",
  "resourceId": "/SUBSCRIPTIONS/SAMPLE-SUBSCTIPTION-ID/RESOURCEGROUPS/SAMPLE-RESOURCEGROUP-NAME/PROVIDERS/MICROSOFT.EVENTGRID/TOPICS/SAMPLE-TOPIC-NAME",
  "category": "PublishFailures",
  "operationName": "Post",
  "message": "inputEventsCount=null, requestUri=https://SAMPLE-TOPIC-NAME.region-suffix.eventgrid.azure.net/api/events, publisherInfo=PublisherInfo(category=User, inputSchema=EventGridEvent, armResourceId=/SUBSCRIPTIONS/SAMPLE-SUBSCTIPTION-ID/RESOURCEGROUPS/SAMPLE-RESOURCEGROUP-NAME/PROVIDERS/MICROSOFT.EVENTGRID/TOPICS/SAMPLE-TOPIC-NAME), httpStatusCode=Forbidden, errorType=ClientIPRejected, errorMessage=Publishing to SAMPLE-TOPIC-NAME.{region}-{suffix}.EVENTGRID.AZURE.NET by client {clientIp} is rejected due to IpAddress filtering rules."
}
```

### <a name="check-if-the-eventgrid-topicdomain-can-be-accessed-using-only-a-private-endpoint"></a>Проверьте, можно ли получить доступ к разделу или домену EventGrid, используя только закрытую конечную точку

Если раздел или домен сетки событий настроен на доступ только через закрытую конечную точку, убедитесь, что клиентское приложение обращается к разделу или домену через частную конечную точку. Чтобы подтвердить это, проверьте, выполняется ли клиентское приложение в подсети, и существует ли частная конечная точка для раздела или домена службы "Сетка событий" в этой подсети.

[Служба "Частная связь Azure](../private-link/private-link-overview.md) " позволяет получить доступ к сетке событий Azure через **частную конечную точку** в виртуальной сети. Частная конечная точка — это сетевой интерфейс, который защищенно и надежно подключается к службе через Приватный канал Azure. Частная конечная точка использует частный IP-адрес из виртуальной сети, по сути перемещая службу в виртуальную сеть. Весь трафик к службе может маршрутизироваться через частную конечную точку, поэтому шлюзы, устройства преобразования сетевых адресов (NAT), подключения ExpressRoute и VPN, а также общедоступные IP-адреса не требуются. Трафик между виртуальной сетью и службой проходит через магистральную сеть Майкрософт, что позволяет избежать рисков общедоступного Интернета. Вы можете подключиться к экземпляру ресурса Azure, обеспечивая наивысшую степень детализации в управлении доступом.

Дополнительные сведения см. в разделе [Настройка частных конечных точек](configure-private-endpoints.md).

## <a name="troubleshoot-transient-connectivity-issues"></a>Устранение проблем с временным подключением

Если у вас возникают временные проблемы с подключением, просмотрите советы по устранению неполадок в следующих разделах.

### <a name="run-the-command-to-check-dropped-packets"></a>Выполните команду, чтобы проверить пропущенные пакеты.

При наличии периодических проблем с подключением выполните следующую команду, чтобы проверить наличие пропущенных пакетов. Эта команда попытается установить 25 разных TCP-подключений каждые 1 секунду со службой. После этого можно проверить, сколько из них прошло успешное выполнение и завершилось сбоем, а также увидеть задержку подключения TCP. Это средство можно загрузить `psping` [отсюда](/sysinternals/downloads/psping).

```shell
.\psping.exe -n 25 -i 1 -q {sampletopicname}.{region}-{suffix}.eventgrid.azure.net:443 -nobanner
```

Аналогичные команды можно использовать, если вы используете другие средства, например `tcpping` [tcpping.exe](https://www.elifulkerson.com/projects/tcping.php).

Найдите трассировку сети, если предыдущие шаги не помогают и не анализируют их с помощью таких средств, как [Wireshark](https://www.wireshark.org/). При необходимости обратитесь в [Служба поддержки Майкрософт](https://support.microsoft.com/) .

### <a name="service-upgradesrestarts"></a>Обновление или перезапуск службы

Проблемы с временным подключением могут возникать из-за обновления и перезапуска серверной части службы. Когда они возникнут, могут возникнуть следующие симптомы.

- Может существовать перетаскивание входящих сообщений или запросов.
- Файл журнала может содержать сообщения об ошибках.
- Приложения могут быть отключены от службы в течение нескольких секунд.
- Запросы могут быть продолжены с немедленным регулированием.

Перехват этих временных ошибок, резервное копирование и повторная попытка вызова гарантирует устойчивость кода к этим временным проблемам.

## <a name="next-steps"></a>Дальнейшие действия

Если вам нужна дополнительная помощь, опубликуйте свой вопрос на [форуме Stack Overflow](https://stackoverflow.com/questions/tagged/azure-eventgrid) или отправьте [запрос в службу поддержки](https://azure.microsoft.com/support/options/).