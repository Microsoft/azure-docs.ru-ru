---
title: Доставка событий веб-перехватчика
description: В этой статье описываются процессы доставки событий веб-перехватчика и проверки конечной точки при использовании веб-перехватчиков.
ms.topic: conceptual
ms.date: 07/07/2020
ms.openlocfilehash: e9a52d0cb3e4e880d91e1b748d97ef3041298930
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "87461244"
---
# <a name="webhook-event-delivery"></a>Доставка событий веб-перехватчика
Веб-перехватчики — это один из многих способов получения событий из службы "Сетка событий Azure". При возникновении нового события служба "Сетка событий" отправляет в настроенную конечную точку HTTP-запрос, в тексте которого находится событие.

Как и многие другие службы, поддерживающие веб-перехватчики, служба "Сетка событий" требует, чтобы вы подтвердили право собственности на конечную точку веб-перехватчика до того, как служба начнет доставку событий в эту конечную точку. Это требование не позволяет пользователю-злоумышленнику переполнить вашу конечную точку событиями. Инфраструктура Azure автоматически обрабатывает эту проверку, когда вы используете любую из следующих трех служб Azure:

- Azure Logic Apps с [соединителем Сетки событий](/connectors/azureeventgrid/);
- служба автоматизации Azure через [веб-перехватчик](../event-grid/ensure-tags-exists-on-new-virtual-machines.md);
- Функции Azure с [триггером службы "Сетка событий"](../azure-functions/functions-bindings-event-grid.md).

## <a name="endpoint-validation-with-event-grid-events"></a>Проверка конечной точки с помощью событий Сетки событий
При использовании любого другого типа конечной точки, такого как функция Azure на основе триггера HTTP, код конечной точки должен участвовать в подтверждении проверки со службой "Сетка событий". Сетка событий поддерживает два типа проверки подписки.

1. **Синхронное подтверждение**. Во время создания подписки на события Сетка событий отправляет в вашу конечную точку событие проверки подписки. Схема этого события похожа на любое другое событие Сетки событий. Часть данных этого события включает свойство `validationCode`. Ваше приложение проверяет, предназначен ли запрос проверки для ожидаемой подписки на события, и синхронно возвращает код проверки в ответе. Этот механизм подтверждения поддерживается во всех версиях Сетки событий.

2. **Асинхронное подтверждение**. В некоторых случаях вы не можете синхронно возвращать ValidationCode в ответе. Например, если вы используете стороннюю службу (например, [`Zapier`](https://zapier.com) или [IFTTT](https://ifttt.com/)), то не можете ответить программным способом с использованием кода проверки.

   Начиная с версии 2018-05-01-preview Сетка событий поддерживает подтверждение проверки вручную. Если вы создаете подписку на события с помощью пакета SDK или инструмента, который использует версию API 2018-05-01-preview или более позднюю, Сетка событий отправит свойство `validationUrl` в часть данных события проверки подписки. Чтобы выполнить подтверждение, найдите URL-адрес в данных события и отправьте по нему запрос GET. Вы можете использовать клиент REST или свой веб-браузер.

   Предоставленный URL-адрес проверки действителен около **5 минут**. В течение этого времени состояние подготовки подписки на событие находится в `AwaitingManualAction`. Если вы не завершили проверку вручную в течение 5 минут, состояние обеспечения установится на `Failed`. Прежде чем выполнить проверку вручную, потребуется создать подписку на событие еще раз.

   Для этого механизма проверки подлинности также требуется, чтобы конечная точка веб-перехватчика возвращала код состояния HTTP 200 для подтверждения, что POST для события проверки был принят, прежде чем он может быть переведен в режим ручной проверки. Другими словами, если конечная точка возвращает код 200, но синхронно не возвращает ответ проверки, режим переходит в режим ручной проверки. Если в течение 5 минут на URL-адресе проверки есть GET, подтверждение проверки считается успешным.

> [!NOTE]
> Использование самозаверяющих сертификатов для проверки не поддерживается. Вместо этого используйте подписанный сертификат из коммерческого центра сертификации (ЦС).

### <a name="validation-details"></a>Сведения о проверке

- Во время создания или обновления подписки на события Сетка событий публикует в целевую конечную точку событие проверки подписки.
- В качестве заголовка событие содержит значение "aeg-event-type: SubscriptionValidation".
- Текст события имеет ту же схему, что и другие события сетки событий.
- Свойству события eventType соответствует значение `Microsoft.EventGrid.SubscriptionValidationEvent`.
- К свойству данных события относится свойство `validationCode` со строкой, сгенерированной случайным образом. Например "validationCode: acb13…".
- Данные о событии включают свойство `validationUrl` с URL-адресом для проверки подписки вручную.
- Массив содержит только событие проверки. Другие события отправляются в отдельном запросе после возврата кода проверки.
- Пакеты SDK EventGrid DataPlane содержат классы, соответствующие данным события проверки подписки и ответу на проверку подписки.

Пример SubscriptionValidationEvent показан в следующем примере:

```json
[
  {
    "id": "2d1781af-3a4c-4d7c-bd0c-e34b19da4e66",
    "topic": "/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
    "subject": "",
    "data": {
      "validationCode": "512d38b6-c7b8-40c8-89fe-f46f9e9622b6",
      "validationUrl": "https://rp-eastus2.eventgrid.azure.net:553/eventsubscriptions/estest/validate?id=512d38b6-c7b8-40c8-89fe-f46f9e9622b6&t=2018-04-26T20:30:54.4538837Z&apiVersion=2018-05-01-preview&token=1A1A1A1A"
    },
    "eventType": "Microsoft.EventGrid.SubscriptionValidationEvent",
    "eventTime": "2018-01-25T22:12:19.4556811Z",
    "metadataVersion": "1",
    "dataVersion": "1"
  }
]
```

Чтобы подтвердить владение конечной точкой, в свойстве validationResponse возвращается код проверки, как показано в следующем примере:

```json
{
  "validationResponse": "512d38b6-c7b8-40c8-89fe-f46f9e9622b6"
}
```

Должен возвратиться код состояния ответа HTTP 200 OK. HTTP 202 Accepted не распознается как действительный ответ проверки подписки Сетки событий. HTTP-запрос должен быть выполнен в течение 30 секунд. Если операция не завершится в течение 30 секунд, она будет отменена и ее можно будет повторить через 5 секунд. Если все попытки завершаются ошибкой, это будет считаться ошибкой подтверждения проверки.

Можно также вручную проверить подписку, отправив запрос GET по URL-адресу проверки. Подписка на событие остается в состоянии ожидания, пока проверка не будет завершена. URL-адрес проверки использует порт 553. Если правила брандмауэра блокируют порт 553, возможно, для успешного подтверждения вручную необходимо обновить правила.

Пример обработки подтверждения проверки подписки на C# см. на [сайте GitHub](https://github.com/Azure-Samples/event-grid-dotnet-publish-consume-events/blob/master/EventGridConsumer/EventGridConsumer/Function1.cs).

## <a name="endpoint-validation-with-cloudevents-v10"></a>Проверка конечной точки с помощью CloudEvents версии 1.0
Если вы уже знакомы со службой "Сетка событий", то, возможно, знаете о проверке конечной точки Сетки событий для предотвращения нарушений. CloudEvents версии 1.0 реализует собственную [семантику защиты от нарушений](webhook-event-delivery.md) с помощью метода HTTP OPTIONS. Подробнее об этом можно прочитать [здесь](https://github.com/cloudevents/spec/blob/v1.0/http-webhook.md#4-abuse-protection). При использовании схемы CloudEvents для вывода служба "Сетка событий" используется с защитой CloudEvents версии 1.0 вместо механизма событий проверки Сетки событий.

## <a name="next-steps"></a>Дальнейшие действия
Сведения о том, как устранить неполадки при проверках подписок на события, см. в следующей статье: 

[Устранение неполадок при проверках подписок](troubleshoot-subscription-validation.md)
