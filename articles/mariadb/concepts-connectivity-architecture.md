---
title: Архитектура подключения к базе данных Azure для MariaDB
description: Описывает архитектуру подключения для сервера базы данных Azure для MariaDB.
author: Bashar-MSFT
ms.author: bahusse
ms.service: mariadb
ms.topic: conceptual
ms.date: 2/11/2021
ms.openlocfilehash: 50aaae9e71ac9de366ee4db1981e633491094946
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "103199971"
---
# <a name="connectivity-architecture-in-azure-database-for-mariadb"></a>Архитектура подключения в базе данных Azure для MariaDB
В этой статье описывается архитектура подключения к базе данных Azure для MariaDB, а также сведения о том, как трафик направляется в базу данных Azure для экземпляра MariaDB от клиентов как внутри, так и за пределами Azure.

## <a name="connectivity-architecture"></a>Архитектура подключения

Подключение к базе данных Azure для MariaDB устанавливается через шлюз, который отвечает за маршрутизацию входящих подключений к физическому расположению сервера в наших кластерах. На следующей схеме показан поток трафика.

![Обзор архитектуры подключения](./media/concepts-connectivity-architecture/connectivity-architecture-overview-proxy.png)


Когда клиент подключается к базе данных, строка подключения к серверу разрешается в IP-адрес шлюза. Шлюз прослушивает IP-адрес порта 3306. В кластере базы данных трафик перенаправляется в соответствующую базу данных Azure для MariaDB. Поэтому для подключения к серверу, например из корпоративных сетей, необходимо открыть **брандмауэр на стороне клиента, чтобы разрешить исходящий трафик для доступа к нашим шлюзам**. Ниже приведен полный список IP-адресов, используемых нашими шлюзами в каждом регионе.

## <a name="azure-database-for-mariadb-gateway-ip-addresses"></a>IP-адреса шлюза базы данных Azure для MariaDB

Служба шлюза размещается в группе вычислений без отслеживания состояния, расположенных за IP-адресом, который при попытке подключения к серверу базы данных Azure для MariaDB будет достигнут первый клиент. 

В рамках текущего обслуживания службы мы периодически обновляем вычисление оборудования, в котором размещаются шлюзы, чтобы обеспечить наиболее безопасный и производительный интерфейс. При обновлении оборудования шлюза сначала создается новое кольцо для таких кластерных узлов. Это новое кольцо обслуживает трафик всех недавно созданных серверов базы данных Azure для MariaDB, и он будет иметь другой IP-адрес из старых колец шлюзов в том же регионе, чтобы отличать трафик. После того, как новое кольцо будет полностью работоспособным, вы планируете списание существующих серверов с помощью старого шлюза, обслуживающего существующие серверы. Перед списанием оборудования шлюза клиенты, работающие с серверами и подключающиеся к старым кольцам шлюза, будут уведомлены по электронной почте и в портал Azure за три месяца перед списанием. Списание шлюзов может повлиять на подключение к серверам, если 

* IP-адреса шлюза жестко заменяются в строке подключения приложения. Это **не рекомендуется**. В строке подключения для приложения следует использовать полное доменное имя (FQDN) сервера в формате <servername> . MariaDB.Database.Azure.com. 
* Вы не обновляете более новые IP-адреса шлюза в брандмауэре на стороне клиента, чтобы разрешить исходящему трафику доступ к нашим новым кольцам шлюза.

В следующей таблице перечислены IP-адреса шлюзов для шлюза базы данных Azure для MariaDB для всех областей данных. Наиболее актуальные сведения об IP-адресах шлюза для каждого региона см. в таблице ниже. В таблице ниже представлены следующие столбцы.

* **IP-адреса шлюза:** В этом столбце перечислены текущие IP-адреса шлюзов, размещенных на последнем поколение оборудования. При подготовке нового сервера рекомендуется открыть брандмауэр на стороне клиента, чтобы разрешить исходящий трафик для IP-адресов, перечисленных в этом столбце.
* **IP-адреса шлюза (списание):** В этом столбце перечислены IP-адреса шлюзов, размещенных в старом поколении оборудования, которое сейчас выводится из эксплуатации. При подготовке нового сервера эти IP-адреса можно игнорировать. Если у вас есть существующий сервер, продолжайте хранить правило исходящего трафика для брандмауэра для этих IP-адресов, так как мы еще не списаны. При удалении правил брандмауэра для этих IP-адресов могут возникнуть ошибки подключения. Вместо этого вы должны заранее добавить новые IP-адреса, указанные в столбце IP-адреса шлюза, в правило исходящего брандмауэра, как только вы получите уведомление об списании. Это гарантирует, что при миграции сервера на новейшее оборудование шлюза нет перерывов в подключении к серверу.
* **IP-адреса шлюза (списанные):** В этих столбцах перечислены IP-адреса колец шлюзов, которые списаны и больше не находятся в операциях. Эти IP-адреса можно безопасно удалить из правила брандмауэра для исходящего трафика. 


| **Имя региона** | **IP-адреса шлюза** |**IP-адреса шлюза (списание)** | **IP-адреса шлюза (списанные)** |
|:----------------|:-------------------------|:-------------------------------------------|:------------------------------------------|
| Центральная Австралия| 20.36.105.0  | | |
| Central2 Австралия     | 20.36.113.0  | | |
| Восточная Австралия | 13.75.149.87, 40.79.161.1     |  | |
| Юго-Восточная Австралия |191.239.192.109, 13.73.109.251   |  | |
| Brazil South |191.233.201.8, 191.233.200.16    |  | 104.41.11.5|
| Центральная Канада |40.85.224.249  | | |
| Восточная Канада | 40.86.226.166    | | |
| Центральная часть США | 23.99.160.139, 52.182.136.37, 52.182.136.38 | 13.67.215.62 | |
| Восточный Китай | 139.219.130.35    | | |
| Восточный Китай 2 | 40.73.82.1  | | |
| Северный Китай | 139.219.15.17    | | |
| Северный Китай 2 | 40.73.50.0     | | |
| Восточная Азия | 191.234.2.139, 52.175.33.150, 13.75.33.20, 13.75.33.21     | | |
| Восточная часть США |40.71.8.203, 40.71.83.113 |40.121.158.30|191.238.6.43 |
| восточная часть США 2 | 40.70.144.38, 52.167.105.38  | 52.177.185.181 | |
| Центральная Франция | 40.79.137.0, 40.79.129.1  | | |
| Южная Франция | 40.79.177.0     | | |
| Центральная Германия | 51.4.144.100     | | |
| Северная Германия | 51.116.56.0 | |
| Северо-восточная Германия | 51.5.144.179  | | |
| Центрально-Западная Германия | 51.116.152.0 | |
| Центральная Индия | 104.211.96.159     | | |
| Южная Индия | 104.211.224.146  | | |
| Западная Индия | 104.211.160.80    | | |
| Japan East | 40.79.192.23, 40.79.184.8 | 13.78.61.196 | |
| Западная Япония | 191.238.68.11, 40.74.96.6, 40.74.96.7     | 104.214.148.156 | |
| Республика Корея, центральный регион | 52.231.17.13   | 52.231.32.42 | |
| Республика Корея, южный регион | 52.231.145.3     | 52.231.200.86 | |
| Центрально-северная часть США | 52.162.104.35, 52.162.104.36    | 23.96.178.199 | |
| Северная Европа | 52.138.224.6, 52.138.224.7  | 40.113.93.91 |191.235.193.75 |
| Северная часть ЮАР;  | 102.133.152.0    | | |
| Западная часть ЮАР | 102.133.24.0   | | |
| Центрально-южная часть США |104.214.16.39, 20.45.120.0  |13.66.62.124  |23.98.162.75 |
| Юго-Восточная Азия | 40.78.233.2, 23.98.80.12     | 104.43.15.0 | |
| Северная Швейцария | 51.107.56.0 ||
| Западная Швейцария | 51.107.152.0| ||
| Центральная часть ОАЭ. | 20.37.72.64  | | |
| Северная часть ОАЭ; | 65.52.248.0    | | |
| южная часть Соединенного Королевства | 51.140.184.11   | | |
| западная часть Соединенного Королевства | 51.141.8.11  | | |
| центрально-западная часть США | 13.78.145.25     | | |
| Западная Европа |13.69.105.208, 104.40.169.187 | 40.68.37.158 | 191.237.232.75 |
| Западная часть США |13.86.216.212, 13.86.217.212 |104.42.238.205  | 23.99.34.75|
| Западная часть США 2 | 13.66.226.202  | | |
||||

## <a name="connection-redirection"></a>Перенаправление соединения

База данных Azure для MariaDB поддерживает дополнительную политику подключения, **Перенаправление**, которая помогает снизить задержку в сети между клиентскими приложениями и серверами MariaDB. С помощью этой функции после установки начального сеанса TCP на сервер базы данных Azure для MariaDB сервер возвращает внутренний адрес узла, на котором размещен сервер MariaDB, клиенту. После этого все последующие пакеты поступают непосредственно на сервер, минуя шлюз. Так как пакеты поступают непосредственно на сервер, задержка и пропускная способность повышают производительность.

Эта функция поддерживается на серверах базы данных Azure для MariaDB с версиями 10,2 и 10,3.

Поддержка перенаправления доступна в расширении [MYSQLND_AZURE](https://github.com/microsoft/mysqlnd_azure) PHP, разработанном корпорацией Майкрософт и доступно в [PECL](https://pecl.php.net/package/mysqlnd_azure). Дополнительные сведения о том, как использовать перенаправление в приложениях, см. в статье [Настройка перенаправления](./howto-redirection.md) .

> [!IMPORTANT]
> Поддержка перенаправления в расширении PHP [mysqlnd_azure](https://github.com/microsoft/mysqlnd_azure) в настоящее время доступна в предварительной версии.

## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы

### <a name="what-you-need-to-know-about-this-planned-maintenance"></a>Что необходимо знать об этом плановом обслуживании?
Это только изменение DNS, которое делает его прозрачным для клиентов. При изменении IP-адреса FQDN на DNS-сервере локальный кэш DNS будет обновляться в течение 5 минут и автоматически выполняется операционными системами. После локального обновления DNS все новые подключения будут подключаться к новому IP-адресу, все существующие подключения будут оставаться подключенными к старому IP-адресу без прерывания до тех пор, пока старые IP-адреса не будут полностью списаны. Старый IP-адрес займет от трех до четырех недель, прежде чем выступить из эксплуатации. Поэтому он не должен оказывать никакого влияния на клиентские приложения.

### <a name="what-are-we-decommissioning"></a>Что мы списаны?
Будут списаны только узлы шлюза. Когда пользователи подключаются к своим серверам, первый останавливает подключение к узлу шлюза, прежде чем подключение перенаправляется на сервер. Мы списаны старые кольца шлюза (не клиентские кольца, где работает сервер). Дополнительные сведения см. в разделе [Архитектура подключения](#connectivity-architecture) .

### <a name="how-can-you-validate-if-your-connections-are-going-to-old-gateway-nodes-or-new-gateway-nodes"></a>Как проверить, будут ли подключения переходить к старым узлам шлюза или новым узлам шлюза?
Выполните проверку связи с полным доменным именем сервера, например  ``ping xxx.mariadb.database.azure.com`` . Если возвращенный IP-адрес является одним из IP-адресов, указанных в разделе IP Address (списание) шлюза в приведенном выше документе, это означает, что подключение будет проходить по старому шлюзу. Контрарили. Если возвращенный IP-адрес является одним из IP-адресов, указанных в разделе шлюз, то это означает, что подключение будет проходить через новый шлюз.

Вы также можете протестировать [PSPing](https://docs.microsoft.com/sysinternals/downloads/psping) или TCPPing сервер базы данных из клиентского приложения с помощью порта 3306 и убедиться, что возвращаемый IP-адрес не является одним из IP-адресов списания.

### <a name="how-do-i-know-when-the-maintenance-is-over-and-will-i-get-another-notification-when-old-ip-addresses-are-decommissioned"></a>Разделы справки узнать, когда обслуживание выполняется, и будет ли я получать другое уведомление при списании старых IP-адресов?
Вы получите сообщение электронной почты, чтобы сообщить вам о начале работы по обслуживанию. Обслуживание может занять до одного месяца в зависимости от количества серверов, которые необходимо перенести в регионах Al. Подготовьте клиент для подключения к серверу базы данных с помощью полного доменного имени или используйте новый IP-адрес из приведенной выше таблицы. 

### <a name="what-do-i-do-if-my-client-applications-are-still-connecting-to-old-gateway-server-"></a>Что делать, если клиентские приложения по-прежнему подключаются к старому серверу шлюза?
Это означает, что приложения подключаются к серверу, используя статический IP-адрес вместо полного доменного имени. Проверьте строки подключения и параметры пулов соединений, параметр AKS или даже в исходном коде.

### <a name="is-there-any-impact-for-my-application-connections"></a>Есть ли какие-либо последствия для подключений приложений?
Это обслуживание является лишь изменением DNS, поэтому оно является прозрачным для клиента. После обновления кэша DNS на клиенте (автоматически выполненной системой операций) все новое подключение будет подключаться к новому IP-адресу, и все существующее подключение будет работать нормально, пока старый IP-адрес не станет полностью списан, что обычно несколько недель позже. И логика повторных попыток в этом случае не требуется, но можно увидеть, что в приложении настроена логика повторных попыток. Либо используйте полное доменное имя для подключения к серверу базы данных, либо включите вывод списка новых IP-адресов шлюза в строке подключения приложения.
Эта операция обслуживания не приведет к удалению существующих соединений. Он только ставит новые запросы на подключение к новому кругу шлюза.

### <a name="can-i-request-for-a-specific-time-window-for-the-maintenance"></a>Можно ли запросить конкретное временное окно для обслуживания? 
Так как миграция должна быть прозрачной и не влияет на подключение клиента, мы планируем, что у большинства пользователей не будет никаких проблем. Просматривайте приложение в активном состоянии и убедитесь, что для подключения к серверу базы данных используется полное доменное имя, или включите вывод списка новых IP-адресов шлюза в строке подключения приложения.

### <a name="i-am-using-private-link-will-my-connections-get-affected"></a>Я использую закрытую ссылку, будут ли мои подключения затронуты?
Нет, это оборудование шлюза списано и не имеет связи с частными или частными IP-адресами, оно будет влиять только на общедоступные IP-адреса, упомянутые по IP-адресам списания.


## <a name="next-steps"></a>Следующие шаги

* [Создание правил брандмауэра MariaDB в Базе данных Azure для MariaDB и управление ими на портале Azure](./howto-manage-firewall-portal.md)
* [Создание правил брандмауэра Базы данных Azure для MariaDB и управление ими с помощью Azure CLI](./howto-manage-firewall-cli.md)
