---
title: Автоматизация управления затратами Azure
description: В этой статье объясняется, как можно управлять затратами Azure с помощью автоматизации.
author: bandersmsft
ms.author: banders
ms.date: 03/08/2021
ms.topic: conceptual
ms.service: cost-management-billing
ms.subservice: cost-management
ms.reviewer: adwise
ms.openlocfilehash: f5cebffeaba1ce198be347758004068e8c03133b
ms.sourcegitcommit: 15d27661c1c03bf84d3974a675c7bd11a0e086e6
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/09/2021
ms.locfileid: "102499685"
---
# <a name="manage-costs-with-automation"></a>Автоматизация управления затратами

С помощью автоматизации Управления затратами Azure можно создавать пользовательские наборы решений для получения данных о затратах и управления ими. В этой статье описаны распространенные сценарии автоматизации Управления затратами и параметры, доступные в зависимости от конкретной ситуации. Если вы хотите разрабатывать интерфейсы API, ознакомьтесь с представленными примерами общих запросов API, которые помогут ускорить процесс разработки.

## <a name="automate-cost-data-retrieval-for-offline-analysis"></a>Автоматизация получения данных о затратах для автономного анализа

Вам может потребоваться скачать данные о затратах Azure, чтобы объединить их с другими наборами данных. Вы также можете захотеть интегрировать данные о затратах в собственные системы. Существуют разные варианты сделать это, в зависимости от объема интересующих вас данных. В любом случае для использования API и инструментов вам необходимы разрешения Управления затратами в соответствующей области. Дополнительные сведения см. в разделе [Назначение доступа к данным](./assign-access-acm-data.md).

## <a name="suggestions-for-handling-large-datasets"></a>Рекомендации по обработке больших наборов данных

Если ваша организация широко использует многие ресурсы и подписки Azure, у вас будет большой объем данных об использовании. Excel часто не может загружать такие большие файлы. В этом случае мы рекомендуем следующие варианты.

**Power BI**

Power BI используется для приема и обработки больших объемов данных. Если вы являетесь клиентом Соглашения Enterprise, то можете использовать приложение-шаблон Power BI для анализа затрат согласно выставленным счетам. Этот отчет содержит основные представления, используемые клиентами. Дополнительные сведения см. в разделе [Анализ затрат на Azure с помощью приложения-шаблона Power BI](./analyze-cost-data-azure-cost-management-power-bi-template-app.md).

**Соединитель данных Power BI**

Если вы хотите анализировать данные ежедневно, мы рекомендуем использовать [соединитель данных Power BI](/power-bi/connect-data/desktop-connect-azure-cost-management), чтобы получать данные для подробного анализа. Все созданные вами отчеты будут поддерживаться соединителем в актуальном состоянии по мере начисления затрат.

**Функция экспорта в Управлении затратами**

Возможно, вам не требуется анализировать данные ежедневно. В этом случае подумайте об использовании функции [экспорта](./tutorial-export-acm-data.md) в службе "Управление затратами" для планирования экспорта данных в учетную запись хранения Azure. Затем можно загружать данные в Power BI по мере необходимости или анализировать их в Excel, если размер файла это позволяет. Функция экспорта доступна на портале Azure. Вы также можете настроить экспорт с помощью [API экспорта](/rest/api/cost-management/exports).

**API сведений о потреблении**

Если ваш набор данных о затратах невелик, рассмотрите возможность использования [API сведений о потреблении](/rest/api/consumption/usageDetails). При наличии большого количества данных о затратах следует запрашивать минимально возможный объем данных о потреблении за некоторый период. Для этого либо укажите небольшой диапазон времени, либо используйте в запросе фильтр. Например, если требуется получить данные о затратах за 3 года, этот API будет работать лучше, если вы будете вызывать его несколько раз для разных диапазонов времени, чем если вы сделаете один вызов для всего диапазона времени. После этого можно загрузить данные в Excel для дальнейшего анализа.

## <a name="automate-retrieval-with-usage-details-api"></a>Автоматизация получения с помощью API сведений о потреблении

[API сведений о потреблении](/rest/api/consumption/usageDetails) — это простой способ получения необработанных и неагрегированных данных о затратах, соответствующих счету за использование Azure. Этот API полезен, если вашей организации требуется программное решение для получения данных. Если вы хотите анализировать небольшие наборы данных о затратах, рассмотрите возможность использования этого API. Однако при наличии больших наборов данных следует использовать другие решения, указанные ранее. Данные в сведениях о потреблении предоставляются в единицах измерения в день. Они используются при выставлении ежемесячного счета. Общедоступная версия этих API — `2019-10-01`. Используйте `2019-04-01-preview`, чтобы получить доступ к предварительной версии для резервирования и приобретения в Azure Marketplace с помощью этих API.

Если вы хотите регулярно получать большие объемы экспортируемых данных, см. статью [Периодическое извлечение больших наборов данных о затратах с помощью функции экспорта](ingest-azure-usage-at-scale.md).

### <a name="usage-details-api-suggestions"></a>Предложения API сведений о потреблении

**Расписание запроса**

Рекомендуется делать _не более одного запроса_ в API сведений о потреблении в день. Дополнительные сведения о частоте обновления данных о затратах и обработке округления см. в разделе [Обзор данных службы "Управление затратами"](./understand-cost-mgt-data.md).

**Целевые области верхнего уровня без фильтрации**

Используйте API для получения всех необходимых данных в области наивысшего уровня. Перед выполнением фильтрации, группирования или обзорного анализа дождитесь приема всех необходимых данных. Этот API оптимизирован для предоставления больших объемов необработанных неагрегированных данных. Дополнительные сведения об областях, доступных в службе "Управление затратами", см. в разделе [Основные сведения об областях и работе с ними](./understand-work-scopes.md). После загрузки необходимых данных для области используйте Excel для дальнейшего анализа данных с помощью фильтров и сводных таблиц.

### <a name="notes-about-pricing"></a>Примечания о ценах

Если вам нужно сверить данные о потреблении и расходах с данными в прейскуранте или накладной, примите во внимание следующие сведения.

Цены в прейскуранте. В прейскуранте отображаются цены, полученные из Azure. Они дифференцированы в зависимости от определенной единицы измерения. К сожалению, эта единица измерения не всегда соответствует той единице измерения, которая указана при создании фактических данных о потреблении ресурсов и о расходах.

Цены в данных о потреблении. В файлах о потреблении содержатся дифференцированные данные, которые не всегда в точности соответствуют данным в прейскуранте. В частности:

- Цена за единицу. Цена дифференцируется в соответствии с единицей измерения, с помощью которой формируются фактические расходы на ресурсы Azure. Если происходит дифференцирование, цена не будет соответствовать цене, отображаемой в прейскуранте.
- Единица измерения. Единица измерения, с помощью которой формируются фактические расходы на ресурсы Azure.
- Фактическая цена или тариф на ресурс. Фактический итоговый тариф, сформированный после применения скидок. По этому тарифу за единицу с вас и взимается плата. Это цена, которую следует использовать при умножении цены на количество для выверки расходов. При формировании цены учитываются указанные ниже сценарии и пересчитанная цена за единицу, которая также присутствует в файлах. В результате цена может отличаться от пересчитанной цены за единицу.
  - Пример дифференцированного ценообразования: 10 долл. США за 100 единиц, 8 долл. США за следующие 100 единиц.
  - Пример включенного количества: первые 100 единиц предоставляются бесплатно, а за последующие взимается плата по тарифу 10 долл. США за единицу.
  - Резервирование
  - Округление при подсчете: при округлении учитывается потребленное количество, дифференцированная цена или цена с учетом включенного количества и пересчитанная цена за единицу.

## <a name="example-usage-details-api-requests"></a>Примеры запросов API сведений о потреблении

Следующие примеры запросов используются клиентами Майкрософт во многих распространенных сценариях.

### <a name="get-usage-details-for-a-scope-during-specific-date-range"></a>Получение сведений о потреблении для области в определенном диапазоне дат

Данные, возвращаемые запросом, соответствуют дате получения сведений о потреблении системой выставления счетов. Могут быть включены затраты из нескольких счетов. Используемый вызов зависит от типа подписки.

Для пользователей с устаревшим типом подписки с Соглашением Enterprise (EA) или оплатой по мере использования используйте следующий вызов:

```http
GET https://management.azure.com/{scope}/providers/Microsoft.Consumption/usageDetails?$filter=properties%2FusageStart%20ge%20'2020-02-01'%20and%20properties%2FusageEnd%20le%20'2020-02-29'&$top=1000&api-version=2019-10-01
```

Для пользователей с современным типом подписки с Клиентским соглашением Майкрософт используйте следующий вызов:

```http
GET https://management.azure.com/{scope}/providers/Microsoft.Consumption/usageDetails?startDate=2020-08-01&endDate=&2020-08-05$top=1000&api-version=2019-10-01
```

### <a name="get-amortized-cost-details"></a>Получение сведений об амортизационной стоимости

Если вы хотите увидеть фактические затраты на покупки по мере их возникновения, в следующем запросе измените значение *metric* на `ActualCost`. Для получения сведений об амортизационной стоимости и фактических затратах необходимо использовать версию `2019-04-01-preview`. Текущая версия API работает так же, как версия `2019-10-01`, кроме нового атрибута type/metric и измененных имен свойств. Если у вас имеется Клиентское соглашение Майкрософт, в следующем примере ваши фильтры будут `startDate` и `endDate`.

```http
GET https://management.azure.com/{scope}/providers/Microsoft.Consumption/usageDetails?metric=AmortizedCost&$filter=properties/usageStart+ge+'2019-04-01'+AND+properties/usageEnd+le+'2019-04-30'&api-version=2019-04-01-preview
```

## <a name="automate-alerts-and-actions-with-budgets"></a>Автоматизация оповещений и действий с бюджетами

Для повышения окупаемости инвестиций в облако требуется два критически важных компонента. Один — автоматическое создание бюджета. Другой — настройка оркестрации на основе затрат в ответ на оповещения для бюджета. Создание бюджета Azure можно автоматизировать различными способами. При превышении настроенных пороговых значений для оповещений в ответ на предупреждения происходят различные события.

В следующих разделах описываются доступные варианты и предоставляются примеры запросов API, которые помогут начать процесс автоматизации бюджета.

### <a name="how-costs-are-evaluated-against-your-budget-threshold"></a>Оценка затрат по порогу бюджета

Затраты оцениваются по порогу бюджета один раз в день. При создании бюджета или в день его сброса затраты, сравниваемые с пороговым значением, обнуляются (принимают значение 0 или NULL), так как вычисление, возможно, не выполнялось.

Когда Azure обнаруживает, что стоимость превысила пороговое значение, не позже чем через час в течение периода обнаружения будет активировано уведомление.

### <a name="view-your-current-cost"></a>Просмотр текущих затрат

Чтобы просмотреть текущие затраты, необходимо выполнить вызов GET с помощью [API запросов](/rest/api/cost-management/query).

Вызов GET в API бюджетов не будет возвращать текущие затраты, указанные в анализе затрат. Вместо этого он возвращает последние вычисленные затраты.

### <a name="automate-budget-creation"></a>Автоматизация создания бюджета

Вы можете автоматизировать создание бюджета с помощью [API бюджетов](/rest/api/consumption/budgets). Вы также можете создать бюджет с помощью [шаблона бюджета](quick-create-budget-template.md). Шаблоны позволяют с легкостью стандартизировать развертывания Azure, обеспечивая правильную настройку и принудительное применение управления затратами.

### <a name="supported-locales-for-budget-alert-emails"></a>Поддерживаемые языковые стандарты для сообщений электронной почты с оповещениями о бюджете

При использовании бюджетов вы получите оповещение, если затраты превышают пороговое значение. Для каждого бюджета можно настроить до пяти получателей сообщений электронной почты. Получателям отправляется оповещение по электронной почте в течение 24 часов с момента превышения порогового значения. При этом получателю может потребоваться получить сообщение электронной почты на другом языке. С помощью API бюджетов можно использовать следующие коды языка и региональных параметров. Задайте код языка и региональных параметров с помощью параметра `locale`, как показано в следующем примере.

```json
{
  "eTag": "\"1d681a8fc67f77a\"",
  "properties": {
    "timePeriod": {
      "startDate": "2020-07-24T00:00:00Z",
      "endDate": "2022-07-23T00:00:00Z"
    },
    "timeGrain": "BillingMonth",
    "amount": 1,
    "currentSpend": {
      "amount": 0,
      "unit": "USD"
    },
    "category": "Cost",
    "notifications": {
      "actual_GreaterThan_10_Percent": {
        "enabled": true,
        "operator": "GreaterThan",
        "threshold": 20,
        "locale": "en-us",
        "contactEmails": [
          "user@contoso.com"
        ],
        "contactRoles": [],
        "contactGroups": [],
        "thresholdType": "Actual"
      }
    }
  }
}

```

Языки, поддерживаемые кодом языка и региональных параметров:

| Код языка и региональных параметров| Язык |
| --- | --- |
| ru-ru | Английский (США) |
| ja-jp | Японский (Япония) |
| zh-cn | Китайский (упрощенное письмо, Китай) |
| de-de | Немецкий (Германия) |
| es-es | Испанский (Испания, международный) |
| fr-fr | Французский (Франция) |
| it-it | Итальянский (Италия) |
| ko-kr | корейский (Корея) |
| pt-br | Португальский (Бразилия) |
| ru-ru | Русский (Россия) |
| zh-tw | Китайский (традиционный, Тайвань) |
| cs-cz | Чешский (Чешская Республика) |
| pl-pl | Польский (Польша) |
| tr-tr | Турецкий (Турция) |
| da-dk | Датский (Дания) |
| dn-gb | Английский (Великобритания) |
| hu-hu | Венгерский (Венгрия) |
| nb-bo | Норвежский (букмол, Норвегия) |
| nl-nl | Нидерландский (Нидерланды) |
| pt-pt | Португальский (Португалия) |
| sv-se | Шведский (Швеция) |

### <a name="common-budgets-api-configurations"></a>Общие конфигурации API бюджетов

Бюджеты в среде Azure можно настроить множеством способов. Сначала проанализируйте свой сценарий, а затем определите параметры конфигурации, которые позволят его реализовать. Проверьте перечисленные ниже параметры.

- **Интервал времени**. Представляет период повторения, используемый бюджетом для начисления и вычисления затрат. Наиболее распространенные варианты — ежемесячно, ежеквартально и ежегодно.
- **Период времени**. Указывает срок действия бюджета. Отслеживание бюджета и оповещение о связанных с ним событиях активны только пока он остается действительным.
- **Уведомления**
  - Контактные адреса электронной почты — это те адреса, на которые поступают оповещения при начислении затрат и превышении заданных пороговых значений для бюджета.
  - Роли контактов — при выборе этого параметра, все пользователи, имеющие соответствующую роль в Azure для заданной области, получают оповещения по электронной почте. Например, владельцы подписки могут получать оповещение для бюджета, созданного в области действия подписки.
  - Группы контактов — при превышении порога оповещения бюджет вызывает настроенные группы действий.
- **Фильтры измерения затрат** — для бюджета можно выполнить ту же фильтрацию, которая выполняется при анализе затрат или использовании API запросов. Используйте этот фильтр, чтобы сократить диапазон затрат, мониторинг которых осуществляется с помощью бюджета.

Определив параметры создания бюджета в соответствии со своими потребностями, создайте бюджет с помощью API. Приведенный ниже пример поможет вам начать настройку общей конфигурации бюджета.

**Создание бюджета, отфильтрованного по нескольким ресурсам и тегам**

URL-адрес запроса: `PUT https://management.azure.com/subscriptions/{SubscriptionId} /providers/Microsoft.Consumption/budgets/{BudgetName}/?api-version=2019-10-01`

```json
{
  "eTag": "\"1d34d016a593709\"",
  "properties": {
    "category": "Cost",
    "amount": 100.65,
    "timeGrain": "Monthly",
    "timePeriod": {
      "startDate": "2017-10-01T00:00:00Z",
      "endDate": "2018-10-31T00:00:00Z"
    },
    "filter": {
      "and": [
        {
          "dimensions": {
            "name": "ResourceId",
            "operator": "In",
            "values": [
              "/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/virtualMachines/{meterName}",
              "/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Compute/virtualMachines/{meterName}"
            ]
          }
        },
        {
          "tags": {
            "name": "category",
            "operator": "In",
            "values": [
              "Dev",
              "Prod"
            ]
          }
        },
        {
          "tags": {
            "name": "department",
            "operator": "In",
            "values": [
              "engineering",
              "sales"
            ]
          }
        }
      ]
    },
    "notifications": {
      "Actual_GreaterThan_80_Percent": {
        "enabled": true,
        "operator": "GreaterThan",
        "threshold": 80,
        "contactEmails": [
          "user1@contoso.com",
          "user2@contoso.com"
        ],
        "contactRoles": [
          "Contributor",
          "Reader"
        ],
        "contactGroups": [
          "/subscriptions/{subscriptionID}/resourceGroups/{resourceGroupName}/providers/microsoft.insights/actionGroups/{actionGroupName}
        ],
        "thresholdType": "Actual"
      }
    }
  }
}
```

### <a name="configure-cost-based-orchestration-for-budget-alerts"></a>Настройка оркестрации на основе затрат для оповещений бюджета

С помощью групп действий Azure можно настроить для бюджетов запуск автоматических действий. Дополнительные сведения см. в статье об [автоматизации действий с использованием бюджетов Azure](../manage/cost-management-budget-scenario.md).

## <a name="data-latency-and-rate-limits"></a>Задержка данных и ограничения скорости

Рекомендуется вызывать интерфейсы API не чаще одного раза в день. Данные Управления затратами обновляются каждые четыре часа по мере получения новых данных о потреблении от поставщиков ресурсов Azure. При более частых вызовах вы не получите дополнительные данные, но нагрузка возрастет. Дополнительные сведения о частоте изменения данных и обработке задержки данных см. в разделе [Общие сведения о данных Управления затратами](understand-cost-mgt-data.md).

### <a name="error-code-429---call-count-has-exceeded-rate-limits"></a>Код ошибки 429 — количество вызовов превысило ограничения скорости

Чтобы обеспечить согласованную работу всех подписчиков Управления затратами, интерфейсы API Управления затратами имеют ограничения скорости. По достижении ограничения отображается код состояния HTTP `429: Too many requests`. Текущие ограничения пропускной способности для наших API приведены ниже.

- 30 вызовов в минуту — на область, пользователя или приложение.
- 200 вызовов в минуту — на клиента, пользователя или приложение.

## <a name="next-steps"></a>Дальнейшие действия

- [Анализ затрат на Azure с помощью приложения-шаблона Power BI](./analyze-cost-data-azure-cost-management-power-bi-template-app.md).
- [Создание данных для экспорта и управление ими](./tutorial-export-acm-data.md) с помощью функции экспорта.
- Узнайте больше об [API сведений о потреблении](/rest/api/consumption/usageDetails).