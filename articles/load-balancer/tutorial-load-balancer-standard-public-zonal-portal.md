---
title: Руководство по Виртуальные машины подсистемы балансировки нагрузки в пределах зоны — портал Azure | Документация Майкрософт
titleSuffix: Azure Load Balancer
description: В этом руководстве описано, как с помощью портала Azure создать Load Balancer ценовой категории "Стандартный" с зональным внешним интерфейсом для распределения нагрузки на виртуальные машины в пределах зоны доступности
services: load-balancer
documentationcenter: na
author: asudbring
manager: twooley
Customer intent: As an IT administrator, I want to create a load balancer that load balances incoming internet traffic to virtual machines within a specific zone in a region.
ms.service: load-balancer
ms.devlang: na
ms.topic: tutorial
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 02/27/2019
ms.author: allensu
ms.custom: seodec18
ms.openlocfilehash: f91c9c0f401a455543b12af81eed48bd1a3349bd
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "94696444"
---
# <a name="tutorial-load-balance-vms-within-an-availability-zone-with-standard-load-balancer-by-using-the-azure-portal"></a>Руководство по Распределение нагрузки на виртуальные машины в пределах зоны доступности с помощью Load Balancer ценовой категории "Стандартный" и портала Azure

При работе с этим руководством мы с помощью портала Azure создадим [экземпляр Load Balancer ценовой категории "Стандартный"](https://aka.ms/azureloadbalancerstandard) с зональным внешним интерфейсом и присвоим ему общедоступный IP-адрес уровня "Стандартный". В этом сценарии нужно указать определенную зону для серверных и интерфейсных экземпляров, чтобы сопоставить путь к данным и ресурсы с определенной зоной. Вы узнаете, как выполнять следующие функции:

> [!div class="checklist"]
> * создание Load Balancer ценовой категории "Стандартный" с зональным внешним интерфейсом;
> * создание групп безопасности сети для определения правил входящего трафика;
> * создание зональных виртуальных машины и присоединение их к подсистеме балансировки нагрузки;
> * создание пробы работоспособности для подсистемы балансировки нагрузки;
> * создание правил трафика для подсистемы балансировки нагрузки;
> * создание простого сайта Internet Information Services (IIS);
> * наблюдение за работой подсистемы балансировки нагрузки.

Дополнительные сведения о том, как работают зоны доступности с Load Balancer ценовой категории "Стандартный", см. в статье [Azure Load Balancer уровня "Стандартный" и зоны доступности](load-balancer-standard-availability-zones.md).

Также при работе с этим руководством вы можете использовать [Azure CLI](./quickstart-load-balancer-standard-public-cli.md).

## <a name="prerequisites"></a>Предварительные требования

* Подписка Azure

## <a name="sign-in-to-azure"></a>Вход в Azure

Войдите на портал Azure по адресу [https://portal.azure.com](https://portal.azure.com).

## <a name="create-a-public-standard-load-balancer-instance"></a>Создание общедоступного экземпляра Load Balancer ценовой категории "Стандартный"

Load Balancer ценовой категории "Стандартный" поддерживает только стандартные общедоступные IP-адреса. Если общедоступный IP-адрес создается вместе с подсистемой балансировки нагрузки, он автоматически настраивается в качестве стандартной версии SKU. Также он автоматически является избыточным в пределах зоны.

1. Вверху с левой стороны экрана последовательно выберите **Создать ресурс** > **Сети** > **Подсистема балансировки нагрузки**.
2. На вкладке **Основные сведения** страницы **Создание подсистемы балансировки нагрузки** введите или выберите следующие сведения, примите значения по умолчанию для остальных параметров и нажмите кнопку **Review + create** (Проверить и создать).

    | Параметр                 | Значение                                              |
    | ---                     | ---                                                |
    | Подписка               | Выберите свою подписку.    |    
    | Группа ресурсов         | Выберите **Создать** и введите *MyResourceGroupZLB* в текстовом поле.|
    | Имя                   | *myLoadBalancer*                                   |
    | Регион         | Выберите **Западная Европа**.                                        |
    | Тип          | Щелкните **Общедоступный**.                                        |
    | номер SKU           | Выберите **Стандартная**.                          |
    | Общедоступный IP-адрес | Выберите **Создать**. |
    | Имя общедоступного IP-адреса              | Введите *myPublicIP* в текстовом поле.   |
    |Зона доступности| Выберите **1**.    |
3. На вкладке **Review + create** (Проверить и создать) щелкните **Создать**.   

## <a name="create-backend-servers"></a>Создание внутренних серверов

В этом разделе вы создадите виртуальную сеть. Вы также создадите две виртуальные машины в одной зоне (в нашем примере это "зона 1") для региона и добавите их в пул серверной части подсистемы балансировки нагрузки. Затем вы установите службы IIS на виртуальных машинах, чтобы проверить работу подсистемы балансировки нагрузки с избыточностью в пределах зоны. В случае сбоя одной виртуальной машины перестает работать и проба работоспособности для виртуальной машины в той же зоне. Трафик при этом обслуживается другими виртуальными машинами в той же зоне.

## <a name="virtual-network-and-parameters"></a>Виртуальные сети и параметры

В этом разделе необходимо заменить в выполняемых действиях указанные параметры приведенными ниже сведениями.

| Параметр                   | Значение                |
|-----------------------------|----------------------|
| **\<resource-group-name>**  | myResourceGroupZLB (Select existing resource group) |
| **\<virtual-network-name>** | myVNet          |
| **\<region-name>**          | Западная Европа      |
| **\<IPv4-address-space>**   | 10.0.0.0\16          |
| **\<subnet-name>**          | myBackendSubnet        |
| **\<subnet-address-range>** | 10.0.0.0\24          |

[!INCLUDE [virtual-networks-create-new](../../includes/virtual-networks-create-new.md)]

## <a name="create-a-network-security-group"></a>Создание группы безопасности сети

1. Вверху с левой стороны экрана выберите **Создать ресурс**. В поле поиска введите фразу **группа безопасности сети**. На странице группы безопасности сети выберите **Создать**.
2. На странице **создания группы безопасности сети** введите следующие значения:
   - **myNetworkSecurityGroup** — имя группы безопасности сети;
   - **myResourceGroupLBAZ** — имя существующей группы ресурсов.
   
     ![Создание группы безопасности сети](./media/tutorial-load-balancer-standard-zonal-portal/create-network-security-group.png)

### <a name="create-nsg-rules"></a>Создание правил NSG

В этом разделе вы создадите с помощью портала Azure правила группы безопасности сети (NSG), чтобы разрешить входящие подключения по протоколу HTTP и протоколу удаленного рабочего стола Microsoft (RDP).

1. На портале Azure щелкните в меню слева **Все ресурсы**. Выполните поиск **myNetworkSecurityGroup** и выберите соответствующий элемент. Он находится в группе ресурсов **myResourceGroupZLB**.
2. В разделе **Параметры** выберите **Правила безопасности для входящего трафика**. Нажмите кнопку **Добавить**.
3. Чтобы разрешить входящие подключения HTTP через порт 80, введите следующие значения для правила безопасности для входящего трафика с именем **myHTTPRule**:
    - **Service Tag** в поле **Источник**;
    - **Internet** в поле **Тег службы источника**;
    - **80** в поле **Диапазоны портов назначения**;
    - **TCP** в поле **Протокол**;
    - **Разрешить** в поле **Действие**;
    - **100** в поле **Приоритет**;
    - **myHTTPRule** в поле **Имя**;
    - **Разрешить HTTP** в поле **Описание**.
4. Нажмите кнопку **ОК**.
 
   ![Создание правил NSG](./media/load-balancer-standard-public-availability-zones-portal/8-load-balancer-nsg-rules.png)

5. Повторите шаги со 2 по 4, чтобы создать еще одно правило с именем **myRDPRule**. Это правило разрешает входящее подключение по протоколу RDP, который использует порт 3389. Для него укажите следующие значения.
    - **Service Tag** в поле **Источник**;
    - **Internet** в поле **Тег службы источника**;
    - **3389** в поле **Диапазоны портов назначения**.
    - **TCP** в поле **Протокол**.
    - **Разрешить** в поле **Действие**;
    - **200** в поле **Приоритет**;
    - **myRDPRule** в поле **Имя**.
    - **Разрешить RDP** в поле **Описание**.

      ![Создание правила для протокола RDP](./media/tutorial-load-balancer-standard-zonal-portal/create-rdp-rule.png)

### <a name="create-virtual-machines"></a>Создание виртуальных машин

1. В верхней левой части экрана последовательно выберите **Создать ресурс** > **Вычисления** > **Windows Server 2016 Datacenter**. Введите следующие значения для виртуальной машины:
    - **myVM1** — имя виртуальной машины.        
    - **azureuser** — имя пользователя для учетной записи администратора;    
    - **myResourceGroupLB** — **Группа ресурсов**. Щелкните **Использовать существующую** и выберите группу **myResourceGroupZLB**.
2. Нажмите кнопку **ОК**.
3. Выберите значение **DS1_V2** в качестве размера виртуальной машины. Щелкните **Выбрать**.
4. Введите следующие значения для параметров виртуальной машины.
    - **Зона 1** — зона доступности, в которой размещается виртуальная машина.
    -  **myVNet**. Убедитесь, что это значение выбрано для виртуальной сети.
    - **myVM1PIP** — новый общедоступный IP-адрес уровня "Стандартный". Выберите **Создать**. Выберите тип имени **myVM1PIP**. В поле **Зона** выберите **1**. Номер SKU для IP-адреса по умолчанию имеет значение "Стандартный".
    - **myBackendSubnet**. Убедитесь, что это значение выбрано для подсети.
    - **myNetworkSecurityGroup** — имя существующей группы безопасности сети (брандмауэра).
5. Выберите **Отключено**, чтобы отключить диагностику загрузки.
6. Нажмите кнопку **ОК**. Проверьте все параметры на странице сводной информации. Щелкните **Создать**.
7. Повторите шаги с 1 по 6, чтобы создать вторую виртуальную машину с именем **myVM2** в зоне 1. В качестве виртуальной сети выберите **myVnet**. В качестве общедоступного IP-адреса уровня "Стандартный" выберите **myVM2PIP**. Выберите подсеть **myBackendSubnet**. Выберите **myNetworkSecurityGroup** в качестве группы безопасности сети.

    ![Создание виртуальных машин](./media/tutorial-load-balancer-standard-zonal-portal/create-virtual-machine.png) 

### <a name="install-iis-on-vms"></a>Установка служб IIS на виртуальные машины

1. Выберите **Все ресурсы** в меню слева. В списке ресурсов выберите **myVM1**. Он находится в группе ресурсов **myResourceGroupZLB**.
2. На странице **Обзор** щелкните **Подключить**, чтобы обратиться к виртуальной машине по протоколу RDP.
3. Выполните вход с именем пользователя и паролем, которые вы указали при создании виртуальной машины. Возможно, для ввода этих учетных данных потребуется выбрать **Дополнительные варианты**. а затем выберите **Использовать другую учетную запись**. Затем нажмите кнопку **ОК**. При входе в систему может появиться предупреждение о сертификате. Чтобы продолжить процесс подключения, выберите **Да**.
4. На рабочем столе сервера перейдите к **Средства администрирования Windows** > **Windows PowerShell**.
6. В окне **PowerShell** выполните следующие команды, чтобы установить сервер IIS. Кроме того, эти команды удаляют стандартный файл iisstart.htm и добавляют новый файл iisstart.htm с именем виртуальной машины:

   ```azurepowershell-interactive
    # install IIS server role
    Install-WindowsFeature -name Web-Server -IncludeManagementTools
    # remove default htm file
     remove-item  C:\inetpub\wwwroot\iisstart.htm
    # Add a new htm file that displays server name
     Add-Content -Path "C:\inetpub\wwwroot\iisstart.htm" -Value $("Hello World from" + $env:computername)
   ```
7. Закройте сеанс RDP для **myVM1**.
8. Повторите шаги 1–7, чтобы установить IIS на виртуальную машину **myVM2**.

## <a name="create-load-balancer-resources"></a>Создание ресурсов подсистемы балансировки нагрузки

Из этого раздела вы узнаете, как настроить параметры подсистемы балансировки нагрузки для внутреннего пула адресов и пробы работоспособности. Также вы настроите правила для подсистемы балансировки нагрузки и преобразования сетевых адресов.


### <a name="create-a-backend-address-pool"></a>Создание внутреннего пула адресов

Для распределения трафика между виртуальными машинами во внутреннем пуле содержатся IP-адреса виртуальных сетевых интерфейсов, подключенных к подсистеме балансировки нагрузки. Создайте внутренний пул адресов **myBackendPool**, куда будут входить виртуальные машины **VM1** и **VM2**.

1. Выберите **Все ресурсы** в меню слева. Выберите **myLoadBalancer** из списка ресурсов.
2. В разделе **Параметры** выберите **Внутренние пулы**. Нажмите кнопку **Добавить**.
3. На странице **Add a backend pool** (Добавление серверного пула) выполните следующие действия:
    - В качестве имени серверного пула введите **myBackEndPool**.
    - В раскрывающемся меню **Виртуальная сеть** щелкните **myVNet**. 
    - В полях **Виртуальная машина** и **IP-адрес** укажите имена **myVM1**, **myVM2** и соответствующие общедоступные IP-адреса.
4. Выберите **Добавить**.
5. Убедитесь, что в настройках серверного пула подсистемы балансировки нагрузки отображаются обе виртуальные машины (**myVM1** и **myVM2**).
 
    ![Создание внутреннего пула.](./media/tutorial-load-balancer-standard-zonal-portal/create-backend-pool.png) 

### <a name="create-a-health-probe"></a>Создание пробы работоспособности

Настройте пробу работоспособности, чтобы подсистема балансировки нагрузки могла следить за состоянием приложения. Проба работоспособности динамически добавляет или удаляет виртуальные машины из балансировщика нагрузки на основе их ответа на проверки работоспособности. Создайте зонд работоспособности **myHealthProbe**, чтобы отслеживать работоспособность виртуальных машин.

1. Выберите **Все ресурсы** в меню слева. Выберите **myLoadBalancer** из списка ресурсов.
2. В разделе **Параметры** выберите **Зонды работоспособности**. Нажмите кнопку **Добавить**.
3. Для создания зонда работоспособности используйте следующие значения:
    - **myHealthProbe** — имя пробы работоспособности.
    - **HTTP** — тип протокола.
    - **80** — номер порта.
    - **15** — **интервал** между попытками выполнения пробы (в секундах).
    - **2** — значение **порога неработоспособности**, которое обозначает количество последовательных сбоев пробы, после которых виртуальная машина будет считаться неработоспособной.
4. Нажмите кнопку **ОК**.

   ![Добавление пробы работоспособности](./media/load-balancer-standard-public-availability-zones-portal/4-load-balancer-probes.png)

### <a name="create-a-load-balancer-rule"></a>Создание правила балансировщика нагрузки

Правило подсистемы балансировки нагрузки определяет режим распределения трафика между виртуальными машинами. Вы определяете конфигурацию внешнего IP-адреса для входящего трафика и пул внутренних IP-адресов для приема трафика, а также требуемый порт источника и назначения. Создайте правило подсистемы балансировки нагрузки с именем **myLoadBalancerRuleWeb** для ожидания передачи данных на порту 80 во внешнем интерфейсе **FrontendLoadBalancer**. Это правило перенаправляет трафик, для которого настроена балансировка нагрузки, ко внутреннему пулу адресов **myBackEndPool** (на порт 80). 

1. Выберите **Все ресурсы** в меню слева. Выберите **myLoadBalancer** из списка ресурсов.
2. В разделе **Параметры** выберите **Правила балансировки нагрузки**. Нажмите кнопку **Добавить**.
3. Для настройки правила балансировки нагрузки используйте следующие значения:
    - **myHTTPRule** — имя правила балансировки нагрузки.
    - **TCP** — тип протокола.
    - **80** — номер порта.
    - **80** — номер порта внутреннего пула.
    - **myBackendPool** — имя серверного пула.
    - **myHealthProbe** — имя пробы работоспособности.
4. Нажмите кнопку **ОК**.
    
    ![Добавление правила балансировки нагрузки](./media/tutorial-load-balancer-standard-zonal-portal/load-balancing-rule.png)

## <a name="test-the-load-balancer"></a>Тестирование подсистемы балансировки нагрузки
1. Найдите общедоступный IP-адрес для подсистемы балансировки нагрузки на экране **обзора**. Щелкните **Все ресурсы**. Теперь выберите **myPublicIP**. 

2. Скопируйте общедоступный IP-адрес. Вставьте этот адрес в адресную строку браузера. В браузере отображается страница по умолчанию, которая содержит имя веб-сервера.

      ![Веб-сервер IIS](./media/tutorial-load-balancer-standard-zonal-portal/load-balancer-test.png)
3. Чтобы проверить работу подсистемы балансировки нагрузки, принудительно остановите ту виртуальную машину, имя которой отобразилось на странице. Обновите страницу в браузере и убедитесь, что теперь отображается имя другого сервера.

## <a name="clean-up-resources"></a>Очистка ресурсов

Удалите группу ресурсов, подсистему балансировки нагрузки и все связанные с ними ресурсы, когда надобность в них отпадет. Выберите группу ресурсов, которая содержит подсистему балансировки нагрузки. Теперь щелкните **Удалить**.

## <a name="next-steps"></a>Дальнейшие действия

Ознакомиться со следующей статьей о балансировке нагрузки для виртуальных машин в разных зонах доступности.
> [!div class="nextstepaction"]
> [Распределение нагрузки виртуальных машин в пределах зон доступности](tutorial-load-balancer-standard-public-zone-redundant-portal.md)