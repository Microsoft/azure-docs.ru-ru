---
title: Устранение неполадок Azure Load Balancer
description: Узнайте, как устранять известные неполадки Azure Load Balancer.
services: load-balancer
documentationcenter: na
author: asudbring
manager: dcscontentpm
ms.custom: seodoc18
ms.service: load-balancer
ms.devlang: na
ms.topic: troubleshooting
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 01/28/2020
ms.author: allensu
ms.openlocfilehash: bfe2b21a86f2ce4b4630ba69cde87796fd367f4b
ms.sourcegitcommit: e46f9981626751f129926a2dae327a729228216e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "98029224"
---
# <a name="troubleshoot-azure-load-balancer-backend-traffic-responses"></a>Устранение неполадок Azure Load Balancer ответах на серверный трафик

На этой странице содержатся сведения об устранении неполадок для Azure Load Balancerных вопросов.

## <a name="vms-behind-load-balancer-are-not-responding-to-traffic-on-the-configured-data-port"></a>Виртуальные машины, находящиеся за подсистемой балансировки нагрузки, не отвечают на трафик на настроенном порте данных

Если виртуальная машина внутреннего пула указана в списке как работоспособная и отвечает на пробы работоспособности, но по-прежнему не участвует в балансировке нагрузки или не отвечает на трафик данных, то это может быть вызвано следующими причинами:
* Виртуальная машина внутреннего пула подсистемы балансировки нагрузки не ожидает передачи данных через порт данных.
* Группа безопасности сети блокирует порт на виртуальной машине внутреннего пула подсистемы балансировки нагрузки.  
* Доступ к подсистеме балансировки нагрузки осуществляется с одной виртуальной машины и сетевой карты.
* Доступ к интерфейсу Интернета Load Balancer осуществляется из виртуальной машины серверного пула подсистемы Load Balancer.

## <a name="cause-1-load-balancer-backend-pool-vm-is-not-listening-on-the-data-port"></a>Причина 1. Виртуальная машина внутреннего пула подсистемы балансировки нагрузки не ожидает передачи данных через порт данных.

Если виртуальная машина не отвечает на трафик данных, то это может быть вызвано тем, что целевой порт не открыт на виртуальной машине, входящей в пул, или виртуальная машина не ожидает передачи данных через этот порт. 

**Проверка и способы устранения**

1. Войдите в виртуальную машину внутреннего пула. 
2. Откройте командную строку и выполните следующую команду, чтобы убедиться, что приложение ожидает передачи данных через порт данных:  
            netstat -an 
3. Если для состояния порта не указано значение "Ожидает вызова", настройте соответствующий порт прослушивателя. 
4. Если порт отмечен как "Ожидает вызова", то проверьте наличие неполадок в целевом приложении на этом порте.

## <a name="cause-2-network-security-group-is-blocking-the-port-on-the-load-balancer-backend-pool-vm"></a>Причина 2. Группа безопасности сети блокирует порт на виртуальной машине внутреннего пула подсистемы балансировки нагрузки.  

Если одна или несколько групп безопасности сети, настроенных в подсети или на виртуальной машине, блокируют исходный IP-адрес или порт, то виртуальная машина не может ответить.

В общедоступной подсистеме балансировки нагрузки для обмена данными между клиентами и серверными виртуальными машинами подсистемы балансировки нагрузки будут использоваться IP-адреса клиентов Интернета. Убедитесь, что IP-адреса клиентов разрешены в группе безопасности сети серверной виртуальной машины.

1. Откройте список групп безопасности сети, настроенных на виртуальной машине внутреннего пула. Дополнительные сведения см. в статье об [управлении группами безопасности сети](../virtual-network/manage-network-security-group.md)
1. В списке групп безопасности сети проверьте:
    - наличие помех для входящего или исходящего трафика через порт данных; 
    - наличие правила групп безопасности сети **Запретить все** в сетевой карте виртуальной машины или подсети, которое имеет более высокий приоритет, чем правило по умолчанию, позволяющее выполнение проб и трафик подсистемы балансировки нагрузки (в группах безопасности сети необходимо разрешить IP-адрес подсистемы балансировки нагрузки 168.63.129.16, который является портом пробы).
1. Если любое из правил блокирует трафик, то удалите и перенастройте правила, чтобы они разрешали трафик данных.  
1. Проверьте, начала ли виртуальная машина отвечать на пробы работоспособности.

## <a name="cause-3-accessing-the-load-balancer-from-the-same-vm-and-network-interface"></a>Причина 3. Доступ к подсистеме балансировки нагрузки осуществляется с одной виртуальной машины и сетевого интерфейса 

Если приложение, размещенное в виртуальной машине внутреннего пула подсистемы балансировки нагрузки, попытается получить доступ к другому приложению, размещенному в той же виртуальной машине внутреннего пула, через тот же сетевой интерфейс, то такой сценарий не поддерживается, и операция завершится ошибкой. 

**Способы устранения**. Чтобы устранить эту проблему, используйте один из указанных ниже способов.
* Настройте для каждого приложения отдельные виртуальные машины внутреннего пула. 
* Настройте приложение в виртуальных машинах с двумя сетевыми картами, чтобы каждое приложение использовало свои собственные сетевой интерфейс и IP-адрес. 

## <a name="cause-4-accessing-the-internal-load-balancer-frontend-from-the-participating-load-balancer-backend-pool-vm"></a>Причина 4. Доступ к интерфейсу внутреннего Load Balancer осуществляется из виртуальной машины серверного пула Load Balancer

Если внутренний Load Balancer настроен в виртуальной сети, а одна из участвующих серверных виртуальных машин пытается получить доступ к интерфейсу внутреннего Load Balancer, то когда поток сопоставляется с исходной виртуальной машиной, могут произойти сбои. Такой сценарий не поддерживается.

**Разрешение** Существует несколько способов разблокировать этот сценарий, включая использование прокси-сервера. Оцените шлюз приложений или другие сторонние прокси-серверы (например, nginx или haproxy). Дополнительные сведения о шлюзе приложений см. в статье [Обзор шлюза приложений](../application-gateway/overview.md).

**Сведения.** Внутренние подсистемы балансировки нагрузки не преобразуют исходящие подключения к внешнему интерфейсу внутренней подсистемы балансировки нагрузки, так как оба они находятся в диапазоне частных IP-адресов. Общедоступные подсистемы балансировки нагрузки предоставляют [исходящие подключения](load-balancer-outbound-connections.md) от частных IP-адресов внутри виртуальной сети к общедоступным IP-адресам. Для внутренних подсистем балансировки нагрузки этот подход исключает вероятность возникновения нехватки портов SNAT в рамках уникального диапазона внутренних IP-адресов, в котором не требуется проводить преобразование.

Побочным эффектом является то, что если исходящий поток из виртуальной машины в серверном пуле направляется к внешнему интерфейсу внутреннего балансировщика нагрузки, в пуле которого она находится, _и_ сопоставляется с собой, и два элемента потока не совпадают. Так как они не совпадают, происходит сбой потока. Поток передается успешно, если в серверном пуле он не сопоставляется с той же виртуальной машиной, которая создала поток к внешнему интерфейсу.

Когда поток сопоставляется с собой, получается, что исходящий поток передается из виртуальной машины на внешний интерфейс, а соответствующий входящий поток поступает от виртуальной машины к себе. С точки зрения гостевой операционной системы входящие и исходящие части того же потока не совпадают в виртуальной машине. Стек TCP не будет распознавать эти половины одного потока как часть того же потока. Источник и назначение не совпадают. При сопоставлении потока с любой другой виртуальной машиной в серверном пуле половины потока будут соответствовать друг другу, и виртуальная машина сможет реагировать на поток.

Симптомом этого сценария является периодическое истечение времени ожидания подключения, когда поток возвращается к той же серверной части, из которой он возник. К общим обходным решениям относятся вставка уровня прокси-сервера за внутренней подсистемой балансировки нагрузки и использование правил прямого ответа от сервера (DSR). Дополнительные сведения см. в статье [Несколько внешних интерфейсов для Azure Load Balancer](load-balancer-multivip-overview.md).

Вы можете объединить внутреннюю систему балансировки нагрузки со сторонним прокси-сервером или использовать внутренний [шлюз приложений](../application-gateway/overview.md) для сценариев прокси-сервера с протоколами HTTP и HTTPS. Хотя вы можете использовать общедоступный Load Balancer в качестве обходного решения, полученный сценарий подвержен [исчерпанию SNAT](load-balancer-outbound-connections.md). Избегайте этого второго подхода, если не сможете осуществить его тщательно.

## <a name="next-steps"></a>Дальнейшие действия

Если описанные выше шаги не устранят проблему, отправьте [запрос в службу поддержки](https://azure.microsoft.com/support/options/).