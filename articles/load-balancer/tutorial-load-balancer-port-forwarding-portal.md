---
title: Руководство по настройке перенаправления портов — портал Azure
titleSuffix: Azure Load Balancer
description: В этом руководстве описано, как настроить перенаправление портов с помощью Azure Load Balancer, чтобы создать подключения к виртуальным машинам в виртуальной сети Azure.
services: load-balancer
documentationcenter: na
author: asudbring
manager: twooley
ms.service: load-balancer
ms.devlang: na
ms.topic: tutorial
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 02/26/2019
ms.author: allensu
ms.custom: seodec18
ms.openlocfilehash: 27851a44dbe3085610fadc8b9bdaf400b4d2876c
ms.sourcegitcommit: 73fb48074c4c91c3511d5bcdffd6e40854fb46e5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/31/2021
ms.locfileid: "106056068"
---
# <a name="tutorial-configure-port-forwarding-in-azure-load-balancer-using-the-portal"></a>Руководство по Настройка перенаправления портов в Azure Load Balancer с помощью портала

Перенаправление портов позволяет подключаться к виртуальным машинам в виртуальной сети Azure с помощью общедоступного IP-адреса Azure Load Balancer и номера порта. 

В этом руководстве вы настроите перенаправление портов в Azure Load Balancer. Вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * Создание общедоступного Load Balancer (цен. категория "Стандартный"), чтобы сбалансировать сетевой трафик виртуальных машин. 
> * Создайте виртуальную сеть и виртуальные машины с помощью правила группы безопасности сети (NSG). 
> * Добавьте виртуальные машины для внутреннего пула адресов подсистемы балансировки нагрузки.
> * Создание пробы работоспособности для подсистемы балансировки нагрузки и правил трафика.
> * Создание правил NAT для входящего трафика в подсистеме балансировки нагрузки для перенаправления портов.
> * Установка и настройка службы IIS на виртуальных машинах для представления балансировки нагрузки и перенаправления портов в действии.

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу. 

Чтобы выполнить все действия из этого руководства, войдите на портал Azure по адресу [https://portal.azure.com](https://portal.azure.com).

## <a name="prerequisites"></a>Предварительные требования

* Подписка Azure.

## <a name="create-a-standard-load-balancer"></a>Создание подсистемы балансировки нагрузки уровня "Стандартный"

Сначала создайте общедоступный Load Balancer (цен. категория "Стандартный"), который может осуществлять балансировку нагрузки трафика через виртуальные машины. Load Balancer (цен. категория "Стандартный") поддерживает только стандартные общедоступные IP-адреса. Вместе с подсистемой балансировки нагрузки категории "Стандартный" необходимо также создать новый стандартный общедоступный IP-адрес, настроенный в качестве интерфейсного LB с именем **LoadBalancerFrontend** по умолчанию. 

1. В верхней левой части экрана выберите **Создать ресурс** > **Сети** > **Балансировщик нагрузки**.
2. На вкладке **Основные сведения** страницы **Создание подсистемы балансировки нагрузки** введите или выберите следующие сведения, примите значения по умолчанию для остальных параметров и нажмите кнопку **Review + create** (Проверить и создать).

    | Параметр                 | Значение                                              |
    | ---                     | ---                                                |
    | Подписка               | Выберите свою подписку.    |    
    | Группа ресурсов         | Выберите **Создать** и введите *MyResourceGroupLB* в текстовом поле.|
    | Имя                   | *myLoadBalancer*                                   |
    | Регион         | Выберите **Западная Европа**.                                        |
    | Тип          | Щелкните **Общедоступный**.                                        |
    | номер SKU           | Выберите **Стандартная**.                          |
    | Общедоступный IP-адрес | Выберите **Создать**. |
    | Имя общедоступного IP-адреса              | Введите *myPublicIP* в текстовом поле.   |
    |Зона доступности| Выберите **Zone redundant** (Избыточно в пределах зоны).    |
     
    >[!NOTE]
     >Убедитесь в создании Load Balancer и всех необходимых ресурсов в расположении, которое поддерживает Зоны доступности. Дополнительные сведения см. в разделе [Регионы с поддержкой Зон доступности](../availability-zones/az-region.md). 

3. На вкладке **Review + create** (Проверить и создать) щелкните **Создать**.  
  
## <a name="create-and-configure-back-end-servers"></a>Создание и настройка внутренних серверов

Создайте виртуальную сеть с двумя виртуальными машинами и добавьте виртуальные машины для серверного пула подсистемы балансировки нагрузки. 

## <a name="virtual-network-and-parameters"></a>Виртуальные сети и параметры

В этом разделе необходимо заменить в выполняемых действиях указанные параметры приведенными ниже сведениями.

| Параметр                   | Значение                |
|-----------------------------|----------------------|
| **\<resource-group-name>**  | myResourceGroupLB (Выберите существующую группу ресурсов) |
| **\<virtual-network-name>** | myVNet          |
| **\<region-name>**          | Западная Европа      |
| **\<IPv4-address-space>**   | 10.3.0.0\16          |
| **\<subnet-name>**          | myBackendSubnet        |
| **\<subnet-address-range>** | 10.3.0.0\24          |

[!INCLUDE [virtual-networks-create-new](../../includes/virtual-networks-create-new.md)]

### <a name="create-vms-and-add-them-to-the-load-balancer-back-end-pool"></a>Создание виртуальных машин и их добавление во внутренний пул подсистемы балансировки нагрузки

1. В верхней левой части портала выберите **Создать ресурс** > **Вычисления** > **Windows Server 2016 Datacenter**. 
   
1. В разделе **Создание виртуальной машины** введите или выберите следующие значения на вкладке **Основные сведения**:
   - **Подписка** > **Группа ресурсов**. В раскрывающемся списке выберите **MyResourceGroupLB**.
   - **Имя виртуальной машины**. Введите *MyVM1*.
   - **Регион**. Выберите **Западная Европа**. 
   - **Имя пользователя**. Введите *azureuser*.
   - **Пароль**. Введите *Azure1234567*. 
     В поле **Подтверждение пароля** введите пароль еще раз.
   
1. Выберите вкладку **Сеть** или **Далее: диски**, затем **Далее: сеть**. 
   
   Выберите следующее:
   - **Виртуальная сеть.** **MyVNet**
   - **Подсеть.** **MyBackendSubnet**
   
1. В разделе **Общедоступный IP-адрес** на странице **Создать общедоступный IP-адрес** выберите **Создать новый**, далее — **Стандартный**, а затем нажмите кнопку **ОК**. 
   
1. Чтобы создать группу безопасности сети (NSG) типа брандмауэра, в разделе **Группа безопасности сети** выберите **Дополнительно**. 
   1. В поле **Настройка группы безопасности сети** выберите **Создать новый**. 
   1. Введите *MyNetworkSecurityGroup* и нажмите кнопку **ОК**. 
   
   >[!NOTE]
   >Обратите внимание, что по умолчанию в группе безопасности сети уже есть правило для входящего трафика, чтобы открыть порт 3389 (порт удаленного рабочего стола (RDP)).
   
1. Добавьте виртуальную машину в созданный пул серверной части подсистемы балансировки нагрузки.
   
   1. В разделе **Балансировка нагрузки** > **Разместить эту виртуальную машину за существующим решением по балансировке нагрузки?** выберите **Да**. 
   1. В раскрывающемся списке **Параметры балансировки нагрузки** выберите **Балансировщик нагрузки Azure**. 
   1. В раскрывающемся списке **Выбрать балансировщик нагрузки** выберите **MyLoadBalancer**. 
   1. В разделе **Выберите внутренний пул** выберите **Создать новый**, затем введите *MyBackendPool*, затем — **Создать**. 
   
   ![Создание виртуальной сети](./media/tutorial-load-balancer-port-forwarding-portal/create-vm-networking.png)
   
1. Выберите вкладку **Управление** или **Далее** > **Управление**. В разделе **Мониторинг** задайте **Выкл.** для параметра **Диагностика загрузки**.
   
1. Выберите **Review + create** (Просмотреть и создать).
   
1. Проверьте параметры, если проверка прошла успешно, выберите **Создать**. 

1. Выполните действия, чтобы создать вторую виртуальную машину с именем *MyVM2* с такими же остальными параметрами, как у MyVM1. 
   
   После выбора **Дополнительно** выберите созданную **MyNetworkSecurityGroup** в раскрывающемся списке **Группа безопасности сети**. 
   
   В разделе **Выберите внутренний пул**, убедитесь, что выбран **MyBackendPool**. 

### <a name="create-an-nsg-rule-for-the-vms"></a>Создание правила NSG для виртуальных машин

Создайте правило группы безопасности сети для виртуальных машин, чтобы разрешить входящие подключения к Интернету (HTTP).

>[!NOTE]
>По умолчанию в группе безопасности сети уже есть правило, чтобы открыть порт 3389 (порт удаленного рабочего стола (RDP)).

1. Выберите **Все ресурсы** в меню слева. В списке ресурсов выберите **MyNetworkSecurityGroup** в группе ресурсов **MyResourceGroupLB**.
   
1. В разделе **Параметры** выберите **Правила безопасности для входящего трафика**, а затем щелкните **Добавить**.
   
1. В диалоговом окне **Добавление правила безопасности для входящего трафика** введите или выберите следующее:
   
   - **Источник**. Выберите **Тег службы**.  
   - **Тег службы источника**. Выберите **Internet**. 
   - **Диапазоны портов назначения**. Введите *80*.
   - **Протокол**. Выберите **TCP**. 
   - **Действие**. Выберите **Разрешить**.  
   - **Приоритет**. Введите *100*. 
   - **Имя**. Введите *MyHTTPRule*. 
   - **Описание**. Введите *Разрешить HTTP*. 
   
1. Выберите **Добавить**. 
   
   ![Создание правила NSG](./media/tutorial-load-balancer-port-forwarding-portal/8-load-balancer-nsg-rules.png)
   
## <a name="create-load-balancer-resources"></a>Создание ресурсов подсистемы балансировки нагрузки

В этом разделе вы проверите внутренний пул подсистемы балансировки нагрузки и настроите правила трафика и пробы работоспособности балансировщика нагрузки.

### <a name="view-the-back-end-address-pool"></a>Просмотр серверного пула адресов

Для распределения трафика между виртуальными машинами подсистема балансировки нагрузки использует внутренний пул адресов, который содержит IP-адреса виртуальных сетевых интерфейсов, подключенных к подсистеме балансировки нагрузки. 

Вы создали свой внутренний пул подсистемы балансировки нагрузки и добавили туда созданные виртуальные машины. Кроме того, вы можете создавать внутренние пулы и добавлять или удалять виртуальные машины из подсистемы балансировки нагрузки на странице **Серверные пулы**. 

1. Щелкните **Все ресурсы** в меню слева, а затем из списка ресурсов выберите **MyLoadBalancer**.
   
1. В разделе **Параметры** выберите **Внутренние пулы**.
   
1. На странице **Серверные пулы** разверните узел **MyBackendPool** и убедитесь, что там перечислены обе виртуальные машины (**VM1** и **VM2**).

1. Выберите **MyBackendPool**. 
   
   На странице **MyBackendPool** в разделе **Виртуальная машина** и **IP-адрес** вы можете удалить или добавить доступные виртуальные машины в пул.

Внутренние пулы можно создать, выбрав **Добавить** на странице **Серверные пулы**.

### <a name="create-a-health-probe"></a>Создание пробы работоспособности

Чтобы подсистема балансировки нагрузки могла отслеживать состояние виртуальной машины, необходимо настроить пробу работоспособности. Проба работоспособности динамически добавляет или удаляет виртуальные машины из балансировщика нагрузки на основе их ответа на проверки работоспособности. 

1. Щелкните **Все ресурсы** в меню слева, а затем из списка ресурсов выберите **MyLoadBalancer**.
   
1. В разделе **Параметры** выберите **Проверки работоспособности**, а затем щелкните **Добавить**.
   
1. На странице **Add a health probe** (Добавление пробы работоспособности) введите или выберите следующие значения:
   
   - **Имя**: введите *MyHealthProbe*.
   - **Протокол**. В раскрывающемся списке выберите **HTTP**. 
   - **Порт**: введите *80*. 
   - **Путь**. Примите */* для универсального кода ресурса (URI) по умолчанию. Это значение можно заменить любым другим URI. 
   - **Интервал**: введите *15*. Интервал — количество секунд между попытками выполнения пробы.
   - **Пороговое значение сбоя**: введите *2*. Это значение количества последовательных сбоев пробы, которые произойдут, прежде чем виртуальная машина будет считаться неработоспособной.
   
1. Нажмите кнопку **ОК**.
   
   ![Добавление пробы](./media/tutorial-load-balancer-port-forwarding-portal/4-load-balancer-probes.png)

### <a name="create-a-load-balancer-rule"></a>Создание правила балансировщика нагрузки

Правило подсистемы балансировки нагрузки определяет режим распределения трафика между виртуальными машинами. Правило определяет интерфейсную конфигурацию IP-адресов для входящего трафика и серверный пул IP-адресов для приема трафика, а также требуемый порт источника и назначения. 

Правило подсистемы балансировки нагрузки с именем **MyLoadBalancerRule** прослушивает порт 80 во внешнем интерфейсе **LoadBalancerFrontEnd**. Это правило перенаправляет трафик к серверному пулу адресов **MyBackendPool** (также на порт 80). 

1. Щелкните **Все ресурсы** в меню слева, а затем из списка ресурсов выберите **MyLoadBalancer**.
   
1. В разделе **Параметры** выберите **Правила балансировки нагрузки**, а затем щелкните **Добавить**.
   
1. На странице **Добавить правило балансировки нагрузки** введите или выберите следующие значения:
   
   - **Имя**: введите *MyLoadBalancerRule*.
   - **Протокол**. Выберите **TCP**.
   - **Порт**: введите *80*.
   - **Серверный порт**: введите *80*.
   - **Серверный пул**. Выберите **MyBackendPool**.
   - **Зонд работоспособности**. Выберите **MyHealthProbe**. 
   
1. Щелкните **ОК**.
   
   ![Добавление правила подсистемы балансировки нагрузки](./media/tutorial-load-balancer-port-forwarding-portal/5-load-balancing-rules.png)

## <a name="create-an-inbound-nat-port-forwarding-rule"></a>Создание правила NAT для входящего трафика для перенаправления портов

Создайте правило преобразования сетевых адресов (NAT) для входящего сетевого трафика в подсистеме балансировки нагрузки для его перенаправления от определенного порта интерфейсного IP-адреса к определенному порту внутренней виртуальной машины.

1. Щелкните **Все ресурсы** в меню слева, а затем из списка ресурсов выберите **MyLoadBalancer**.
   
1. В разделе **Параметры** выберите **Правила NAT для входящего трафика**, а затем щелкните **Добавить**. 
   
1. На странице **Добавление правила NAT для входящего трафика** введите или выберите следующие значения:
   
   - **Name** (Имя). Введите *MyNATRuleVM1*.
   - **Порт**: Введите *4221*.
   - **Целевая виртуальная машина**. Выберите **MyVM1** в раскрывающемся списке.
   - **IP-конфигурация сети**. Выберите **ipconfig1** в раскрывающемся списке.
   - **Сопоставление портов**. Выберите **Пользовательский**.
   - **Целевой порт**. Введите *3389*.
   
1. Нажмите кнопку **ОК**.
   
1. Повторите шаги, чтобы добавить правило NAT для входящего трафика с именем *MyNATRuleVM2*, используя **Порт** — *4222* и **Целевая виртуальная машина** — **MyVM2**.

## <a name="test-the-load-balancer"></a>Тестирование подсистемы балансировки нагрузки

В этом разделе вы установите службы IIS на внутренних серверах и настроите веб-страницы по умолчанию для отображения имени компьютера. Затем вы используете общедоступный IP-адрес для тестирования подсистемы балансировки нагрузки. 

Каждая серверная виртуальная машина служит другой версией веб-страницы IIS по умолчанию, на которой можно увидеть, как подсистема балансировки нагрузки распределяет запросы между двумя виртуальными машинами.

### <a name="connect-to-the-vms-with-rdp"></a>Подключение к виртуальным машинам по протоколу RDP

Подключитесь к каждой виртуальной машине с помощью удаленного рабочего стола (RDP). 

1. На портале в меню слева выберите **Все ресурсы**. В списке ресурсов выберите каждую виртуальную машину в группе ресурсов **MyResourceGroupLB**.
   
1. На странице **Обзор** выберите **Подключиться**, а затем — **Скачать RDP-файл**. 
   
1. Откройте скачанный RDP-файл и выберите **Подключиться**.
   
1. На экране безопасности Windows выберите **More choices** (Дополнительные варианты) и нажмите **Использовать другую учетную запись**. 
   
   Введите имя пользователя *azureuser* и пароль *Azure1234567*, и нажмите кнопку **ОК**.
   
1. Ответьте **Да** для любого запроса сертификата. 
   
   В новом окне откроется рабочий стол виртуальной машины. 

### <a name="install-iis-and-replace-the-default-iis-web-page"></a>Установка служб IIS и замена страницы IIS по умолчанию 

С помощью PowerShell установите IIS и замените веб-страницы IIS по умолчанию страницей, которая отображает имя виртуальной машины.

1. На MyVM1 и MyVM2 запустите **Windows PowerShell** из меню **Пуск**. 

2. Выполните следующие команды, чтобы установить службы IIS и заменить веб-страницу IIS по умолчанию.
   
   ```powershell-interactive
    # Install IIS
      Install-WindowsFeature -name Web-Server -IncludeManagementTools
    
    # Remove default htm file
     remove-item  C:\inetpub\wwwroot\iisstart.htm
    
    #Add custom htm file that displays server name
     Add-Content -Path "C:\inetpub\wwwroot\iisstart.htm" -Value $("Hello World from " + $env:computername)
    
   ```
   
1. Закройте подключения по протоколу RDP к MyVM1 и MyVM2, выбрав **Отключить**. Не выключайте виртуальные машины.

### <a name="test-load-balancing"></a>Тестирование балансировки нагрузки

1. На портале на странице **Обзор** в разделе **Общедоступный IP-адрес** скопируйте общедоступный IP-адрес **MyLoadBalancer**. Наведите указатель на адрес и выберите значок **Копировать**, чтобы скопировать его. В нашем примере это **40.67.218.235**. 
   
1. Вставьте или введите общедоступный IP-адрес подсистемы балансировки нагрузки (*40.67.218.235*) в адресную строку браузера. 
   
   В браузере появится настроенная страница веб-сервера IIS по умолчанию. Появится сообщение **Hello World от MyVM1** или **Hello World от MyVM2**.
   
   ![Новая страница IIS по умолчанию](./media/tutorial-load-balancer-port-forwarding-portal/9-load-balancer-test.png) 
   
1. Обновите браузер, чтобы увидеть, как подсистема балансировки нагрузки распределяет трафик между виртуальными машинами. Иногда отображается страница **MyVM1**, а в других случаях — **MyVM2**, так как подсистема балансировки нагрузки распределяет эти запросы к каждой серверной виртуальной машине.
   
   >[!NOTE]
   >Может потребоваться очистить кэш браузера или открыть новое окно браузера между попытками.

## <a name="test-port-forwarding"></a>Проверка перенаправления портов

С помощью перенаправления портов вы можете через удаленный рабочий стол подключиться к внутренней виртуальной машине, используя IP-адрес подсистемы балансировки нагрузки и значение внешнего порта, определенное правилом преобразования сетевых адресов (NAT). 

1. На портале на странице **Обзор** скопируйте общедоступный IP-адрес **MyLoadBalancer**. Наведите указатель на адрес и выберите значок **Копировать**, чтобы скопировать его. В нашем примере это **40.67.218.235**. 
   
1. Откройте командную строку и используйте следующую команду, чтобы создать сеанс удаленного рабочего стола с MyVM2, используя общедоступный IP-адрес подсистемы балансировки нагрузки и внешний порт, определенный правилом преобразования сетевых адресов (NAT) для виртуальной машины. 
   
   ```
   mstsc /v:40.67.218.235:4222
   ```
  
1. Откройте скачанный RDP-файл и выберите **Подключиться**.
   
1. На экране безопасности Windows выберите **More choices** (Дополнительные варианты) и нажмите **Использовать другую учетную запись**. 
   
   Введите имя пользователя *azureuser* и пароль *Azure1234567*, и нажмите кнопку **ОК**.
   
1. Ответьте **Да** для любого запроса сертификата. 
   
   В новом окне откроется рабочий стол виртуальной машины MyVM2. 

RDP-подключение устанавливается с использованием правила NAT для входящего трафика **MyNATRuleVM2**, которое перенаправляет трафик от интерфейсного порта 4222 подсистемы балансировки нагрузки к порту 3389 виртуальной машины MyVM2 (порт RDP).

## <a name="clean-up-resources"></a>Очистка ресурсов

Чтобы удалить подсистему балансировки нагрузки и все связанные ресурсы, если они больше не нужны, откройте группу ресурсов **MyResourceGroupLB** и выберите **Удалить группу ресурсов**.

## <a name="next-steps"></a>Дальнейшие действия

В этом руководстве вы создали общедоступный Load Balancer (цен. категория "Стандартный"). Вы создали и настроили сетевые ресурсы, внутренние серверы, пробу работоспособности и правила для подсистемы балансировки нагрузки. Вы установили службы IIS на серверных виртуальных машинах и с помощью общедоступного IP-адреса подсистемы балансировки нагрузки протестировали LB. Настроили и проверили перенаправление портов от указанного порта в подсистеме балансировки нагрузки к порту на внутренней виртуальной машине. 

Чтобы узнать больше об Azure Load Balancer, ознакомьтесь с другими руководствами по этой службе.

> [!div class="nextstepaction"]
> [Руководства по Azure Load Balancer](tutorial-load-balancer-standard-public-zone-redundant-portal.md)
