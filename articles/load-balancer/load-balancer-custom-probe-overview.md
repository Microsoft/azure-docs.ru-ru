---
title: Пробы работоспособности для масштабирования и обеспечения высокой доступности вашей службы
titleSuffix: Azure Load Balancer
description: Из этой статьи вы узнаете, как использовать зонды работоспособности для наблюдения за экземплярами Azure Load Balancer
services: load-balancer
documentationcenter: na
author: asudbring
manager: kumudD
ms.service: load-balancer
ms.devlang: na
ms.topic: how-to
ms.custom: seodec18
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 09/17/2019
ms.author: allensu
ms.openlocfilehash: a008d7b26738b9552a7a43ab026391bd9afe0aa8
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "96780949"
---
# <a name="load-balancer-health-probes"></a>Пробы работоспособности Load Balancer

При использовании правил балансировки нагрузки с Azure Load Balancer необходимо указать зонды работоспособности, чтобы разрешить Load Balancer обнаруживать состояние конечной точки серверной части.  Конфигурация проверки работоспособности и проверочных ответов определяет, какие экземпляры внутреннего пула будут принимать новые потоки. Пробы работоспособности можно использовать для обнаружения сбоя приложения на конечной точке серверной части. Вы также можете создать пользовательский ответ на пробу работоспособности и использовать ее для управления потоком, чтобы управлять нагрузкой или запланированным временем простоя. При сбое проверки работоспособности Load Balancer перестанет отправлять новые потоки в соответствующий неработоспособный экземпляр. Исходящее подключение не затронуто, влияет только на входящее подключение.

Пробы работоспособности поддерживают множественные протоколы. Доступность конкретного протокола проверки работоспособности зависит от номера SKU Load Balancer.  Кроме того, поведение службы зависит от Load Balancer SKU, как показано в следующей таблице.

| | SKU "Стандартный" | SKU "Базовый" |
| --- | --- | --- |
| **[Типы проб](#types)** | TCP, HTTP, HTTPS | TCP, HTTP |
| **[Поведение при пробном отключении](#probedown)** | При сбое всех проб работоспособности потоки TCP продолжаются. | Все вызонды выключаются, истекает срок действия всех TCP-потоков. | 


>[!IMPORTANT]
>Ознакомьтесь с этим документом целиком, включая важные [рекомендации по проектированию](#design) , приведенные ниже, чтобы создать надежную службу.

>[!IMPORTANT]
>Пробы работоспособности Load Balancer поступают с IP-адреса 168.63.129.16 и не должны блокироваться, чтобы они отметили экземпляр как работоспособный.  Дополнительные сведения см. в разделе [IP-адрес источника пробы](#probesource).

>[!IMPORTANT]
>Независимо от настроенного порогового значения времени ожидания HTTP (S) Load Balancer зонды работоспособности автоматически проверяют экземпляр, если сервер возвращает код состояния, отличный от HTTP 200 OK, или если соединение разорвано через TCP Reset.

## <a name="probe-configuration"></a><a name="probes"></a>Конфигурация зонда

Конфигурация проверки работоспособности состоит из следующих элементов:

- Длительность интервала между отдельными зондами
- Число проверочных ответов, которые должны быть замечены перед переходом зонда в другое состояние
- Протокол пробы
- Порт пробы
- Путь HTTP, используемый для HTTP GET при использовании зондов HTTP (S)

>[!NOTE]
>Определение зонда не является обязательным или не проверяется при использовании Azure PowerShell, Azure CLI, шаблонов или API. Тесты проверки зонда выполняются только при использовании портала Azure.

## <a name="understanding-application-signal-detection-of-the-signal-and-reaction-of-the-platform"></a>Основные сведения о сигнальном приложении, обнаружении сигнала и реакции платформы

Число откликов на зонды применяется как к

- количество успешных проверок, которые позволяют пометить экземпляр как Up, и
- число проверок с превышением времени ожидания, которые приводят к пометке экземпляра.

Указанные значения времени ожидания и интервала определяют, будет ли экземпляр помечаться как вверх или вниз.  Длительность интервала, умноженного на количество проверочных ответов, определяет длительность обнаружения откликов зонда.  И служба будет реагировать после достижения требуемой пробы.

В качестве примера можно пояснить поведение. Если вы установили число откликов пробы равным 2, а интервал — 5 секундам, это означает, что в течение 10-секундного интервала времени ожидания для пробного использования необходимо наблюдать 2.  Поскольку время отправки пробы не синхронизировано, когда приложение может изменить состояние, можно привязать время для обнаружения двумя сценариями:

1. Если приложение начинает создавать ответ проверки времени ожидания непосредственно перед поступлением первой проверки, обнаружение этих событий займет 10 секунд (2 x 5 секунд) плюс время, когда приложение начинает сообщать о времени ожидания до наступления первой проверки.  Можно предположить, что обнаружение займет немного больше 10 секунд.
2. Если приложение начинает создавать ответ о превышении времени ожидания сразу после получения первой проверки, обнаружение этих событий не начнется, пока не будет получен следующий зонд (и истечет время ожидания), а также еще 10 секунд (2 x 5 секунды).  Можно предположить, что это обнаружение займет всего 15 секунд.

В этом примере после обнаружения платформа будет принимать небольшое количество времени на реагирование на это изменение.  Это означает, что в зависимости от 

1. Когда приложение начинает изменять состояние и
2. При обнаружении этого изменения и выполнении требуемых условий (число проб, отправленных с указанным интервалом) и
3. когда обнаружено взаимодействие между платформой 

Вы можете предположить, что реакция на проверку времени ожидания может занять от минимум более 10 секунд и не более 15 секунд, чтобы реагировать на изменение сигнала из приложения.  В этом примере показано, что происходит, но нельзя прогнозировать точную длительность, превышающую приведенную выше приблизительную рекомендацию, показанную в этом примере.

>[!NOTE]
>Зонд работоспособности проверит все выполняющиеся экземпляры во внутреннем пуле. Если экземпляр остановлен, он не будет проверен до запуска.

## <a name="probe-types"></a><a name="types"></a>

Для протокола, используемого зондом работоспособности, можно настроить один из следующих способов.

- [прослушиватели TCP](#tcpprobe);
- [конечные точки HTTP.](#httpprobe)
- [конечные точки HTTPS](#httpsprobe);

Доступные протоколы зависят от используемого номера SKU Load Balancer:

|| TCP | HTTP | HTTPS |
| --- | --- | --- | --- |
| **SKU "Стандартный"** |    &#9989; |   &#9989; |   &#9989; |
| **SKU "Базовый"** |   &#9989; |   &#9989; | &#10060; |

### <a name="tcp-probe"></a><a name="tcpprobe"></a>Проба TCP

Проверки TCP инициализируют подключение, выполняя трехстороннее подтверждение по открытому TCP-протоколу на определенном порту.  Пробы протокола TCP завершают подключение с помощью закрытого четырехстороннего подтверждения протокола TCP.

Минимальный интервал проверки составляет 5 секунд, а минимальное количество ответов о неработоспособности — 2.  Общая продолжительность всех интервалов не может превышать 120 секунд.

Проба TCP завершается сбоем в следующих случаях:
* Прослушиватель TCP в экземпляре не отвечает в течение периода времени ожидания.  Проба помечается в зависимости от числа запросов проверки времени ожидания, которые были настроены на отправку ответа перед пометкой пробы.
* Проба получает сброс TCP-соединения от экземпляра.

Ниже показано, как можно выразить этот тип конфигурации пробы в шаблоне диспетчер ресурсов.

```json
    {
      "name": "tcp",
      "properties": {
        "protocol": "Tcp",
        "port": 1234,
        "intervalInSeconds": 5,
        "numberOfProbes": 2
      },
```

### <a name="http--https-probe"></a><a name="httpprobe"></a> <a name="httpsprobe"></a>Проба HTTP/HTTPS

>[!NOTE]
>Проба HTTPS доступна только для [Load Balancer (цен. категория "Стандартный")](./load-balancer-overview.md).

Пробы HTTP и HTTPS основываются на пробе протокола TCP и выдают запрос HTTP GET с указанным расположением. Обе пробы поддерживают относительные пути для HTTP GET. Пробы HTTPS аналогичны пробам HTTP, но к ним добавлены оболочки TLS (это протокол ранее назывался SSL). Проба работоспособности отмечается как работоспособная, когда экземпляр отвечает с HTTP-состоянием 200 в течение периода ожидания.  По умолчанию эта проба работоспособности пытается проверить настроенный порт каждые 15 секунд. Минимальный интервал проверки составляет 5 секунд. Общая продолжительность всех интервалов не может превышать 120 секунд.

Проверки HTTP/HTTPS также могут быть полезны для реализации собственной логики для удаления экземпляров из вращения балансировщика нагрузки, если порт пробы также является прослушивателем для самой службы. Например, можно удалить экземпляр, если он использует более 90 % ресурсов ЦП и возвращает состояние HTTP, отличное от кода 200. 

> [!NOTE] 
> Проверка HTTPS требует использования сертификатов, основанных на сертификатах с минимальным хэшем сигнатуры SHA256 во всей цепочке.

Если вы используете облачные службы и у вас есть веб-роли, использующие w3wp.exe, вам доступен также автоматический мониторинг веб-сайта. Ошибки в коде веб-сайта возвращают проверке подсистемы балансировки нагрузки состояние с кодом, отличным от 200.

Проба HTTP/HTTPS завершается сбоем в следующих случаях:
* Конечная точка пробы возвращает код ответа HTTP, отличный от 200 (например, 403, 404 или 500). В этом случае проба будет сразу же отмечена как неработоспособная. 
* Конечная точка проверки не реагирует на запросы в течение минимального интервала пробы и 30-секундного периода ожидания. Множество запросов на пробу могут оставаться без ответа до того, как проба будет отмечена как неработоспособная, и пока не будет достигнуто суммы всех интервалов времени ожидания.
* Конечная точка пробы закрывает подключение путем сброса TCP-соединения.

Ниже показано, как можно выразить этот тип конфигурации пробы в шаблоне диспетчер ресурсов.

```json
    {
      "name": "http",
      "properties": {
        "protocol": "Http",
        "port": 80,
        "requestPath": "/",
        "intervalInSeconds": 5,
        "numberOfProbes": 2
      },
```

```json
    {
      "name": "https",
      "properties": {
        "protocol": "Https",
        "port": 443,
        "requestPath": "/",
        "intervalInSeconds": 5,
        "numberOfProbes": 2
      },
```

### <a name="guest-agent-probe-classic-only"></a><a name="guestagent"></a>Проба гостевого агента (только для классической версии)

Роли облачной службы (рабочие роли и веб-роли) используют гостевой агент для мониторинга проб по умолчанию.  Проба гостевого агента является последней инстанцией.  Всегда явно используйте пробу работоспособности как пробу TCP или HTTP. Проба гостевого агента не так эффективна, как явно определенные пробы для большинства сценариев приложений.

Проба гостевого агента представляет собой проверку гостевого агента внутри виртуальной машины. Затем она ожидает передачу данных и передает ответ HTTP с кодом 200 (ОК) только в том случае, если экземпляр находится в состоянии готовности. (Другие возможные состояния: занято, перезапуск или остановлено.)

Дополнительные сведения см. в статьях [Azure Service Configuration Schema (.cscfg File)](/previous-versions/azure/reference/ee758710(v=azure.100)) (Схема конфигурации службы Azure (CSCFG-файл)) и [Приступая к работе по созданию общедоступного балансировщика нагрузки для облачных служб](/previous-versions/azure/load-balancer/load-balancer-get-started-internet-classic-cloud#check-load-balancer-health-status-for-cloud-services).

Если гостевой агент не отправляет ответ HTTP с кодом 200 (ОК), подсистема балансировки нагрузки отмечает экземпляр как неработоспособный. Затем он прекращает отправлять потоки к этому экземпляру. Подсистема балансировки нагрузки продолжит проверять связь с этим экземпляром. 

Если гостевой агент отправляет ответ HTTP с кодом 200, подсистема балансировки нагрузки снова начинает отправлять потоки к этому экземпляру.

При использовании веб-роли код веб-сайта обычно выполняется в процессе w3wp.exe, который не отслеживается структурой Azure или гостевым агентом. Ошибки в w3wp.exe (например, ответы HTTP с кодом 500) не передаются в гостевой агент. Следовательно, подсистема балансировки нагрузки не убирает этот экземпляр из ротации.

<a name="health"></a>
## <a name="probe-up-behavior"></a><a name="probehealth"></a>Поведение при пробном запуске

Проверки работоспособности TCP, HTTP и HTTPS считаются работоспособными и помечает конечную точку сервера как работоспособную, если:

* Проба работоспособности выполнена успешно уже после загрузки виртуальной машины.
* Указанное число зондов, необходимое для пометки серверной конечной точки как работоспособное, достигнуто.

Любая конечная точка внутреннего сервера, имеющая работоспособное состояние, может получать новые потоки.  

> [!NOTE]
> Если проба работоспособности не меняется, подсистема балансировки нагрузки ожидает более длительное время, прежде чем поместит серверную конечную точку в работоспособное состояние. Это дополнительное время ожидания защищает пользователя и инфраструктуру и преднамеренно заложено в политику.

## <a name="probe-down-behavior"></a><a name="probedown"></a>Реакция на сбой пробы работоспособности

### <a name="tcp-connections"></a>TCP-подключения

Новые TCP-подключения будут выполнены для оставшихся работоспособных конечных точек сервера.

Если проверка работоспособности конечной точки серверной части завершается неудачно, устанавливает TCP-подключения к этой конечной точке серверной части.

При сбое в серверном пуле всех проб для всех экземпляров новые потоки в этот пул передаваться не будут. Load Balancer (цен. категория "Стандартный") позволит поддерживать установленные потоки TCP.  Load Balancer (цен. категория "Базовый") завершит передачу всех имеющихся потоков TCP в серверный пул.
 
Load Balancer – это сквозная служба (не прерывает соединения протокола TCP), и поток всегда находится между клиентом, гостевой ОС виртуальной машины и приложением. Пул со всеми зондами не отвечает на запросы открытых подключений TCP (SYN), так как нет работоспособной конечной точки для получения последовательности и ответа на SYN-ACK.

### <a name="udp-datagrams"></a>Датаграммы UDP

UDP-датаграммы будут доставляться в работоспособные конечные точки сервера.

UDP не требует соединения, поэтому состояние этого потока не отслеживается. Если проверка работоспособности конечной точки серверной части завершается неудачно, существующие UDP-потоки переходят на другой работоспособный экземпляр в серверном пуле.

Если в серверном пуле все пробы всех экземпляров завершатся сбоем, будут прекращены все имеющиеся потоки UDP для служб Load Balancer (цен. категория "Базовый" и "Стандартный").

<a name="source"></a>
## <a name="probe-source-ip-address"></a><a name="probesource"></a>IP-адрес источника пробы

Балансировщик нагрузки использует распределенную службу проверки работоспособности для внутренней модели работоспособности. Служба проб находится на каждом узле, на котором размещаются виртуальные машины, и по требованию может быть запрограммирована для создания проверок работоспособности для каждой конфигурации клиента. Трафик проверок работоспособности находится непосредственно между службой проб, которая создает проверку, и виртуальной машиной клиента. Все пробы работоспособности Load Balancer поступают с IP-адреса 168.63.129.16. Он является их источником.  Вы можете использовать в виртуальной сети диапазон IP-адресов, который не является пространством RFC1918.  Использование глобально зарезервированного IP-адреса, принадлежащего Майкрософт, снижает вероятность конфликта IP-адресов с диапазоном IP-адресов, который вы используете в виртуальной сети.  Этот IP-адрес одинаков во всех регионах, он не меняется и не являет собой угрозу безопасности, поскольку с этого IP-адреса отправлять пакеты может только внутренний компонент платформы Azure. 

Тег службы AzureLoadBalancer определяет этот исходный IP-адрес в ваших [группах безопасности сети](../virtual-network/network-security-groups-overview.md) и разрешает трафик проверки работоспособности по умолчанию.

В дополнение к Load Balancer пробы работоспособности [следующие операции используют этот IP-адрес](../virtual-network/what-is-ip-address-168-63-129-16.md):

- Позволяет агенту виртуальной машины взаимодействовать с платформой, чтобы сигнализировать, что он находится в состоянии "Готов".
- Включает связь с виртуальным сервером DNS для предоставления разрешения отфильтрованных имен для клиентов, которые не указывают настраиваемые DNS-серверы.  Эта фильтрация гарантирует, что клиенты могут разрешать имена узлов для их развертывания.
- Позволяет виртуальной машине получить динамический IP-адрес от службы DHCP в Azure.

## <a name="design-guidance"></a><a name="design"></a> Руководство по проектированию

Пробы работоспособности используются для повышения устойчивости вашей службы и ее масштабирования. Неправильная конфигурация или неправильный конструктивный шаблон могут повлиять на доступность и масштабируемость вашей службы. Просмотрите весь этот документ и подумайте, как повлияет на ваш сценарий то, что эта проба отмечена как "отключен" или "подключен" и как это влияет на доступность сценария вашего приложения.

При проектировании модели работоспособности для приложения необходимо протестировать порт на конечной точке внутреннего сервера, отражающий работоспособность этого экземпляра __и__ предоставляемую службу приложений.  Порт приложения и порт пробы не должны обязательно совпадать.  В некоторых случаях желательно, чтобы порт пробы отличался от функционального порта вашего приложения.  

Иногда для вашего приложения может быть полезно сгенерировать ответ пробы работоспособности, чтобы не только определить его работоспособность, но и напрямую подать сигнал Load Balancer о том, должен ли ваш экземпляр получать или не получать новые потоки.  Вы можете использовать ответ пробы, чтобы позволить своему приложению создавать противодавление и регулировать поставку новых потоков в экземпляр путем проведения неудачной пробы работоспособности или подготовки к обслуживанию вашего приложения и инициирования опустошения вашего сценария.  При использовании Load Balancer (цен. категория "Стандартный") сигнал [пробы "отключен"](#probedown) будет всегда разрешать потокам протокола TCP продолжаться, пока не начнется время ожидания или не прервется подключение. 

Для балансировки нагрузки UDP следует создать настраиваемый сигнал проверки работоспособности из конечной точки внутреннего сервера и использовать проверку работоспособности TCP, HTTP или HTTPS, предназначенную для соответствующего прослушивателя, чтобы отразить работоспособность вашего приложения UDP.

При использовании [правил балансировки нагрузки портов HA](load-balancer-ha-ports-overview.md) с [Load Balancer (цен. категория "Стандартный")](./load-balancer-overview.md) на всех портах выполняется балансировка нагрузки, а в одном ответе пробы работоспособности должно отражаться состояние всего экземпляра.

Не преобразовывайте или не используйте прокси-сервер через экземпляр, который получает пробу работоспособности к другому экземпляру в виртуальной сети, так как эта конфигурация может привести к каскадным сбоям в сценарии.  Рассмотрим следующий сценарий. Набор сторонних устройств развернут в серверном пуле ресурса Load Balancer, чтобы обеспечить масштабирование и избыточность для устройств, а датчик работоспособности настроен на проверку порта, который стороннее устройство передает через прокси-сервер или преобразовывает на другие виртуальные машины вне устройства.  Если вы проверяете тот же порт, который используете для преобразования или прокси-запросов к другим виртуальным машинам вне устройства, любой результат пробы от одной виртуальной машины вне устройства отметит само устройство как неработоспособное. Эта конфигурация может привести к каскадному сбою всего сценария приложения в результате выполнения одной серверной конечной точки за устройством.  Триггером может быть прерывистый сбой пробы, который приведет к тому, что Load Balancer будет отмечать исходное место назначения (экземпляр устройства) и, в свою очередь, может отключить весь сценарий приложения. Вместо этого проверьте работоспособность самого устройства. Выбор пробы для определения сигнала работоспособности является важным фактором для сценариев сетевых виртуальных устройств (NVA), и вы должны проконсультироваться с поставщиком приложения о том, какой сигнал работоспособности подходит для таких сценариев.

Если вы не разрешите [исходный IP-адрес](#probesource) пробы в политиках брандмауэра, то проба работоспособности завершится сбоем, поскольку она не может достичь вашего экземпляра.  В свою очередь, из-за сбоя пробы Load Balancer пометит экземпляр как неработоспособный.  Эта неверная конфигурация может привести к сбою сценария приложения с балансировкой нагрузки.

Чтобы проба Load Balancer отметила ваш экземпляр как работоспособный, **необходимо** разрешить этот IP-адрес во всех [группах безопасности сетей](../virtual-network/network-security-groups-overview.md) Azure и политиках локального брандмауэра.  По умолчанию каждая группа безопасности сети включает [служебный тег](../virtual-network/network-security-groups-overview.md#service-tags) AzureLoadBalancer для разрешения трафика пробы работоспособности.

Если вы хотите проверить сбой проверки работоспособности или выделить отдельный экземпляр, вы можете использовать [группы безопасности сети](../virtual-network/network-security-groups-overview.md), чтобы явно заблокировать проверку работоспособности (порт назначения или [исходный IP-адрес](#probesource)) и моделировать сбой пробы.

Не настраивайте свою виртуальную сеть с диапазоном IP-адресов, принадлежащим корпорации Майкрософт, который содержит 168.63.129.16.  Такие конфигурации будут конфликтовать с IP-адресом пробы работоспособности и могут вызвать сбой вашего сценария.

Если на вашей виртуальной машине имеется несколько интерфейсов, нужно ответить на пробу в интерфейсе, куда поступил запрос.  Вам может потребоваться, чтобы исходный сетевой адрес преобразовал этот адрес в виртуальную машину для каждого интерфейса.

Не включайте [метки времени протокола TCP](https://tools.ietf.org/html/rfc1323).  Включение отметок времени TCP может вызвать сбой пробы работоспособности из-за разрыва пакетов TCP в стеке TCP гостевой ОС виртуальной машины, что приводит к Load Balancer пометке соответствующей конечной точки.  Метки времени протокола TCP обычно включены по умолчанию на защищенных образах виртуальных машин и должны быть отключены.

## <a name="monitoring"></a>Мониторинг

Как общедоступные, так и внутренние [Load Balancer (цен. Категория "Стандартный")](./load-balancer-overview.md) предоставляют состояние зонда работоспособности для конечных точек и внутренних конечных точек как многомерные метрики с помощью Azure Monitor. Эти метрики можно использовать в других службах Azure или партнерских приложениях. 

Базовый общедоступный Load Balancer предоставляет сводное состояние проверки работоспособности для каждого внутреннего пула с помощью журналов Azure Monitor.  Журналы Azure Monitor недоступны для внутренних базовых подсистем балансировки нагрузки.  Вы можете использовать [журналы Azure Monitor](load-balancer-monitor-log.md) , чтобы проверить состояние работоспособности и число проб для общедоступной подсистемы балансировки нагрузки. Функция ведения журналов в Power BI или Azure Operational Insights позволяет получать статистические данные о работоспособности подсистемы балансировки нагрузки.

## <a name="limitations"></a>Ограничения

- Пробы HTTPS не поддерживают взаимную проверку подлинности с помощью сертификата клиента.
- При включении отметок времени TCP следует предположить, что зонды работоспособности завершаются ошибкой.

## <a name="next-steps"></a>Дальнейшие действия

- Дополнительные сведения о [Load Balancer (цен. Категория "Стандартный")](./load-balancer-overview.md)
- [Краткое руководство. Создание общедоступной подсистемы балансировки нагрузки с помощью Azure PowerShell](quickstart-load-balancer-standard-public-powershell.md)
- [Load Balancer Probes - Get](/rest/api/load-balancer/loadbalancerprobes/) (Получение проб работоспособности Load Balancer)
- Запросите новые возможности пробы работоспособности на [платформе Uservoice для Load Balancer](https://aka.ms/lbuservoice).
