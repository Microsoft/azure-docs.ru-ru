---
title: Руководство по балансировке нагрузки виртуальных машин в пределах зон доступности на портале Azure
titleSuffix: Azure Load Balancer
description: В этом руководстве показано, как создать подсистему балансировки нагрузки уровня "Стандартный" с избыточным между зонами внешним интерфейсом для балансировки нагрузки виртуальных машин между зонами доступности с помощью портала Azure
services: load-balancer
documentationcenter: na
author: asudbring
manager: twooley
ms.service: load-balancer
ms.devlang: na
ms.topic: tutorial
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 02/27/2019
ms.author: allensu
ms.custom: seodec18
ms.openlocfilehash: 54dbc5f4000c9ae10592b04ca55c0fc528f40633
ms.sourcegitcommit: 73fb48074c4c91c3511d5bcdffd6e40854fb46e5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/31/2021
ms.locfileid: "106056085"
---
# <a name="tutorial-load-balance-vms-across-availability-zones-with-a-standard-load-balancer-using-the-azure-portal"></a>Руководство по Распределение нагрузки виртуальных машин в пределах зон доступности с помощью Load Balancer уровня "Стандартный" и портала Azure

Балансировка нагрузки обеспечивает более высокий уровень доступности за счет распределения входящих запросов между несколькими виртуальными машинами. В этом руководстве описывается процесс создания Load Balancer (цен. категория "Стандартный"), который распределяет нагрузку виртуальных машин между зонами доступности. Это позволяет защитить приложения и данные от маловероятных сбоев и потери всего центра обработки данных. При избыточности в пределах зоны в одной или нескольких зонах доступности может произойти сбой, и путь к данным выдерживает его, пока одна зона в регионе остается работоспособной. Вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * Создание подсистемы балансировки нагрузки уровня "Стандартный"
> * создание групп безопасности сети для определения правил входящего трафика;
> * создание избыточных между зонами виртуальных машин в нескольких зонах и их подключение к подсистеме балансировки нагрузки;
> * Создание пробы работоспособности подсистемы балансировки нагрузки
> * создавать правила трафика подсистемы балансировки нагрузки;
> * создание простого сайта IIS;
> * Просмотр балансировщика нагрузки в действии

Дополнительные сведения о том, как работают зоны доступности с Load Balancer уровня "Стандартный", см. в статье [Azure Load Balancer уровня "Стандартный" и зоны доступности](load-balancer-standard-availability-zones.md).

При необходимости инструкции из этого руководства можно выполнить с помощью [Azure CLI](./quickstart-load-balancer-standard-public-cli.md).

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу. 

## <a name="prerequisites"></a>Предварительные требования

* Подписка Azure

## <a name="sign-in-to-azure"></a>Вход в Azure

Войдите на портал Azure по адресу [https://portal.azure.com](https://portal.azure.com).

## <a name="create-a-standard-load-balancer"></a>Создание подсистемы балансировки нагрузки уровня "Стандартный"

Подсистема балансировки нагрузки уровня "Стандартный" поддерживает только стандартные общедоступные IP-адреса. При создании общедоступного IP-адреса во время создания подсистемы балансировки нагрузки он автоматически настраивается в качестве стандартной версии SKU и избыточной между зонами.

1. В верхней левой части экрана выберите **Создать ресурс** > **Сети** > **Балансировщик нагрузки**.
2. На вкладке **Основные сведения** страницы **Создание подсистемы балансировки нагрузки** введите или выберите следующие сведения, примите значения по умолчанию для остальных параметров и нажмите кнопку **Review + create** (Проверить и создать).

    | Параметр                 | Значение                                              |
    | ---                     | ---                                                |
    | Подписка               | Выберите свою подписку.    |    
    | Группа ресурсов         | Выберите **Создать** и введите *MyResourceGroupLBAZ* в текстовом поле.|
    | Имя                   | *myLoadBalancer*                                   |
    | Регион         | Выберите **Западная Европа**.                                        |
    | Тип          | Щелкните **Общедоступный**.                                        |
    | номер SKU           | Выберите **Стандартная**.                          |
    | Общедоступный IP-адрес | Выберите **Создать**. |
    | Имя общедоступного IP-адреса              | Введите *myPublicIP* в текстовом поле.   |
    |Зона доступности| Выберите **Zone redundant** (Избыточно в пределах зоны).    |
   

## <a name="create-backend-servers"></a>Создание внутренних серверов

В этом разделе вы создадите виртуальную сеть, виртуальные машины в разных зонах региона, а затем установите службы IIS на виртуальных машинах для проверки подсистемы балансировки нагрузки, избыточной между зонами. Таким образом при сбое зоны происходит сбой проверки работоспособности виртуальной машины в той же зоне, а трафик продолжает обслуживаться виртуальными машинами в других зонах.

## <a name="virtual-network-and-parameters"></a>Виртуальные сети и параметры

В этом разделе необходимо заменить в выполняемых действиях указанные параметры приведенными ниже сведениями.

| Параметр                   | Значение                |
|-----------------------------|----------------------|
| **\<resource-group-name>**  | myResourceGroupLBAZ (Select existing resource group) |
| **\<virtual-network-name>** | myVNet          |
| **\<region-name>**          | Западная Европа      |
| **\<IPv4-address-space>**   | 10.0.0.0/16          |
| **\<subnet-name>**          | myBackendSubnet        |
| **\<subnet-address-range>** | 10.0.0.0/24          |

[!INCLUDE [virtual-networks-create-new](../../includes/virtual-networks-create-new.md)]

## <a name="create-a-network-security-group"></a>Создание группы безопасности сети

Создайте группу безопасности сети для определения входящих подключений к виртуальной сети.

1. В верхней левой части экрана щелкните **Создать ресурс**, в поле поиска введите *Группа безопасности сети*, а на странице группы безопасности сети щелкните **Создать**.
2. На странице группы безопасности сети введите следующие значения:
    - *myNetworkSecurityGroup* — для имени группы безопасности сети;
    - *myResourceGroupLBAZ* — для имени имеющейся группы ресурсов.
   
![Снимок экрана: область создания группы безопасности сети](./media/load-balancer-standard-public-availability-zones-portal/create-nsg.png)

### <a name="create-network-security-group-rules"></a>Создание правил группы безопасности сети

В этом разделе вы создаете правила группы безопасности сети, чтобы разрешить входящие подключения по протоколу HTTP и протоколу удаленного рабочего стола (RDP) с помощью портала Azure.

1. На портале Azure в меню слева щелкните **Все ресурсы**, а затем найдите и щелкните **myNetworkSecurityGroup**, расположенную в группе ресурсов **myResourceGroupLB**.
2. В разделе **Параметры** щелкните **Правила безопасности для входящего трафика**, а затем — **Добавить**.
3. Введите (выберите) следующие значения для правила безопасности для входящего трафика с именем *myHTTPRule*, чтобы разрешить входящие подключения HTTP через порт 80:
    - *Service Tag* — для **источника**;
    - *Internet* — для **тега службы источника**;
    - *80* — для **диапазонов портов назначения**;
    - *TCP* — для **протокола**;
    - *Разрешить* — для **действия**;
    - *100* — для значения **приоритета**;
    - *myHTTPRule* — для имени правила подсистемы балансировки нагрузки;
    - *Разрешить HTTP* — для описания правила подсистемы балансировки нагрузки.
4. Нажмите кнопку **ОК**.
 
   ![Снимок экрана: область добавления правила безопасности для входящего трафика](./media/load-balancer-standard-public-availability-zones-portal/8-load-balancer-nsg-rules.png)
5. Еще раз выполните шаги 2–4, чтобы создать другое правило с именем *myRDPRule*, разрешающее входящее подключение по RDP через порт 3389. Введите (выберите) следующие значения:
    - *Service Tag* — для **источника**;
    - *Internet* — для **тега службы источника**;
    - *3389* — для **диапазонов портов назначения**;
    - *TCP* — для **протокола**;
    - *Разрешить* — для **действия**;
    - *200* — для значения **приоритета**;
    - *myRDPRule* — для имени;
    - *Разрешить RDP* — для описания.

### <a name="create-virtual-machines"></a>Создание виртуальных машин

Создайте виртуальные машины в разных зонах (зона 1, зона 2 и зона 3) региона, которые могут выступать в качестве внутренних серверов для подсистемы балансировки нагрузки.

1. В верхней части экрана слева щелкните **Создать ресурс** > **Вычисления** > **Windows Server 2016 Datacenter**, а затем введите следующие значения для виртуальной машины:
    - *myVM1* — для имени виртуальной машины;        
    - *azureuser* — для имени пользователя учетной записи администратора;    
    - *myResourceGroupLBAZ* — для **группы ресурсов**. Установите флажок **Использовать существующую** и выберите *myResourceGroupLBAZ*.
2. Нажмите кнопку **ОК**.
3. Выберите значение **DS1_V2** в качестве размера виртуальной машины и нажмите кнопку **Выбрать**.
4. Введите следующие значения для параметров виртуальной машины.
    - *zone 1* (зона 1) — для зоны, в которой размещается виртуальная машина.
    -  В качестве виртуальной сети выберите *myVNet*.
    - В качестве подсети выберите *myBackendSubnet*.
    - *myNetworkSecurityGroup* — для имени группы безопасности сети (брандмауэра).
5. Щелкните **Отключено**, чтобы отключить диагностику загрузки.
6. Нажмите кнопку **ОК**, просмотрите параметры на странице сводки и нажмите кнопку **Создать**.
7. Создайте вторую виртуальную машину с именем *VM2* в зоне 2 и третью виртуальную машину в зоне 3, настроив *myVnet* в качестве виртуальной сети, *myBackendSubnet* как подсеть и \**myNetworkSecurityGroup* как группу безопасности сети и выполнив шаги 1–6.

### <a name="install-iis-on-vms"></a>Установка служб IIS на виртуальные машины

1. В меню слева щелкните **Все ресурсы**, а затем выберите в списке виртуальную машину **myVM1**, расположенную в группе ресурсов *myResourceGroupLBAZ*.
2. На странице **обзора** щелкните **Подключить**, чтобы подключиться по протоколу RDP к виртуальной машине.
3. Войдите в виртуальную машину с именем пользователя *azureuser*.
4. На рабочем столе сервера перейдите к **Средства администрирования Windows**>**Windows PowerShell**.
5. В окне PowerShell выполните следующие команды, чтобы установить сервер IIS, удалить файл по умолчанию iisstart.htm и добавить новый файл iisstart.htm с именем виртуальной машины:
   ```azurepowershell-interactive
    
    # install IIS server role
    Install-WindowsFeature -name Web-Server -IncludeManagementTools
    
    # remove default htm file
     remove-item  C:\inetpub\wwwroot\iisstart.htm
    
    # Add a new htm file that displays server name
     Add-Content -Path "C:\inetpub\wwwroot\iisstart.htm" -Value $("Hello World from" + $env:computername)
   ```
6. Закройте сеанс RDP для *myVM1*.
7. Повторите шаги 1–6, чтобы установить IIS и добавить обновленный файл iisstart.htm на *myVM2* и *myVM3*.

## <a name="create-load-balancer-resources"></a>Создание ресурсов подсистемы балансировки нагрузки

В этом разделе вы настроите параметры подсистемы балансировки нагрузки для внутреннего пула адресов и пробы работоспособности, а также укажете правила подсистемы балансировки нагрузки и правила преобразования сетевых адресов (NAT).


### <a name="create-a-backend-address-pool"></a>Создание внутреннего пула адресов

Для распределения трафика между виртуальными машинами внутренний пул адресов содержит IP-адреса виртуальных сетевых карт, подключенных к балансировщику нагрузки. Создайте внутренний пул адресов *myBackendPool*, куда будут входить виртуальные машины *VM1*, *VM2* и *VM3*.

1. Щелкните **Все ресурсы** в меню слева, а затем из списка ресурсов выберите **myLoadBalancer**.
2. В разделе **Параметры** выберите **Серверные пулы** и нажмите кнопку **Добавить**.
3. На странице **Add a backend pool** (Добавление серверного пула) сделайте следующее:
    - В поле имени внутреннего пула введите *myBackEndPool*.
    - В поле **Виртуальная сеть** в раскрывающемся меню щелкните **myVNet**.
    - В поле **Виртуальная машина** в раскрывающемся меню щелкните **myVM1**.
    - В поле **IP-адрес** в раскрывающемся меню щелкните IP-адрес myVM1.
4. Щелкните **Добавить новый внутренний ресурс**, чтобы добавить каждую виртуальную машину (*myVM2* и *myVM3*) во внутренний пул подсистемы балансировки нагрузки.
5. Нажмите кнопку **Добавить**.

    ![Добавление в серверный пул адресов](./media/load-balancer-standard-public-availability-zones-portal/add-backend-pool.png)

3. Убедитесь, что в настройках внутреннего пула подсистемы балансировки нагрузки отображаются все три виртуальные машины (**myVM1**, **myVM2** и **myVM3**).

### <a name="create-a-health-probe"></a>Создание пробы работоспособности

Чтобы балансировщик нагрузки мог следить за состоянием приложения, необходимо настроить пробу работоспособности. Проба работоспособности динамически добавляет или удаляет виртуальные машины из балансировщика нагрузки на основе их ответа на проверки работоспособности. Создайте зонд работоспособности *myHealthProbe*, чтобы отслеживать работоспособность виртуальных машин.

1. Щелкните **Все ресурсы** в меню слева, а затем из списка ресурсов выберите **myLoadBalancer**.
2. В разделе **Параметры** щелкните **Зонды работоспособности** и нажмите кнопку **Добавить**.
3. Для создания зонда работоспособности используйте следующие значения:
    - *myHealthProbe* — для имени зонда работоспособности;
    - **HTTP** — для типа протокола;
    - *80* — для номера порта;
    - *15* — для **интервала** между попытками выполнения зонда (в секундах);
    - *2* — для числа **порога состояния неработоспособности** или последовательных сбоев зонда, которые должны произойти, прежде чем виртуальная машина будет считаться неработоспособной.
4. Нажмите кнопку **ОК**.

   ![Добавление пробы](./media/load-balancer-standard-public-availability-zones-portal/4-load-balancer-probes.png)

### <a name="create-a-load-balancer-rule"></a>Создание правила балансировщика нагрузки

Правило балансировщика нагрузки позволяет определить распределение трафика между виртуальными машинами. Вы определяете интерфейсную конфигурацию IP-адресов для входящего трафика и внутренний пул IP-адресов для приема трафика, а также требуемый порт источника и назначения. Создайте правило балансировки нагрузки *myLoadBalancerRuleWeb* для прослушивания порта 80 в интерфейсном сервере *FrontendLoadBalancer* и отправки сетевого трафика со сбалансированной нагрузкой во внутренний пул адресов *myBackEndPool*, также используя порт 80. 

1. Щелкните **Все ресурсы** в меню слева, а затем из списка ресурсов выберите **myLoadBalancer**.
2. В разделе **Параметры** выберите **Правила балансировки нагрузки**, а затем щелкните **Добавить**.
3. Для настройки правила балансировки нагрузки используйте следующие значения:
    - *myHTTPRule* — для имени правила балансировки нагрузки;
    - **TCP** — для типа протокола;
    - *80* — для номера порта;
    - *80* — для внутреннего порта;
    - *myBackendPool* — для имени серверного пула;
    - *myHealthProbe* — для имени зонда работоспособности;
4. Нажмите кнопку **ОК**.
    
    
    ![Добавление правила балансировки нагрузки](./media/load-balancer-standard-public-availability-zones-portal/load-balancing-rule.png)

## <a name="test-the-load-balancer"></a>Тестирование подсистемы балансировки нагрузки
1. Найдите общедоступный IP-адрес для подсистемы балансировки нагрузки на экране **обзора**. Выберите **Все ресурсы**, а затем щелкните **myPublicIP**.

2. Скопируйте общедоступный IP-адрес и вставьте его в адресную строку браузера. В браузере отобразится страница по умолчанию веб-сервера IIS.

      ![Веб-сервер IIS](./media/tutorial-load-balancer-standard-zonal-portal/load-balancer-test.png)

Чтобы увидеть, как подсистема балансировки нагрузки распределяет трафик между виртуальными машинами, распределенными по зоне, принудительно обновите веб-браузер.

## <a name="clean-up-resources"></a>Очистка ресурсов

Ставшие ненужными группу ресурсов, подсистему балансировки нагрузки и все связанные ресурсы можно удалить. Для этого выберите группу ресурсов, содержащую подсистему балансировки нагрузки, и щелкните **Удалить**.

## <a name="next-steps"></a>Дальнейшие действия

Изучите возможности по балансировке нагрузки виртуальной машины в определенной зоне доступности.
> [!div class="nextstepaction"]
> [Балансировка нагрузки виртуальных машин в пределах зоны доступности](tutorial-load-balancer-standard-public-zonal-portal.md)