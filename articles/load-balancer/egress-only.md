---
title: Конфигурация подсистемы балансировки нагрузки только для исходящего трафика
titleSuffix: Azure Load Balancer
description: В этой статье вы узнаете, как создать внутреннюю подсистему балансировки нагрузки с исходящим NAT
services: load-balancer
documentationcenter: na
author: asudbring
ms.custom: seodec18
ms.service: load-balancer
ms.devlang: na
ms.topic: how-to
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 08/07/2020
ms.author: allensu
ms.openlocfilehash: ee264a22de5ce094e8a4c1335ace77cbbba49270
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "94694999"
---
# <a name="outbound-only-load-balancer-configuration"></a>Конфигурация подсистемы балансировки нагрузки только для исходящего трафика

Используйте сочетание внутренних и внешних стандартных подсистем балансировки нагрузки для создания исходящих подключений для виртуальных машин за внутренней подсистемой балансировки нагрузки. 

Эта конфигурация обеспечивает исходящий трафик NAT для внутреннего подсистемы балансировки нагрузки, создавая установку только исходящего трафика для серверного пула.


<p align="center">
  <img src="./media/egress-only/load-balancer-egress-only.png" alt="Figure depicts a egress only load balancer configuration." width="500" title="NAT виртуальной сети">
</p>


<!-- 
:::image type="content" source="./media/egress-only/load-balancer-egress-only.png" alt-text="Figure depicts a egress only load balancer configuration" border="true":::
-->


*Рисунок. Конфигурация подсистемы балансировки нагрузки только для исходящего трафика*

Необходимые действия:

1. Создайте виртуальную сеть с узлом бастиона.
2. Создайте виртуальную машину только с частным IP-адресом.
3. Создайте как внутренние, так и общедоступные стандартные подсистемы балансировки нагрузки.
4. Добавьте серверные пулы в оба подсистемы балансировки нагрузки и разместите виртуальную машину в каждом пуле.
5. Подключитесь к виртуальной машине через узел бастиона и выполните следующие действия.
    1. Проверьте исходящее подключение, 
    2. Настройте правило исходящего трафика для общедоступной подсистемы балансировки нагрузки.
    3. Повторно проверьте исходящее подключение.

## <a name="create-virtual-network-and-virtual-machine"></a>Создание виртуальной сети и виртуальной машины

Создайте виртуальную сеть с двумя подсетями:

* Первичная подсеть
* Подсеть бастиона

Создайте виртуальную машину в новой виртуальной сети.

### <a name="create-the-virtual-network"></a>Создание виртуальной сети

1. [Войдите](https://portal.azure.com) на портал Azure.

2. Слева вверху экрана щелкните **Создать ресурс > Сеть > Виртуальная сеть** или выполните поиск по фразе **виртуальная сеть**.

2. В подменю **Создать виртуальную сеть** введите или выберите следующую информацию на вкладке **Основные сведения**:

    | **Параметр**          | **Значение**                                                           |
    |------------------|-----------------------------------------------------------------|
    | **Сведения о проекте**  |                                                                 |
    | Подписка     | Выбор подписки Azure                                  |
    | Группа ресурсов   | Выберите **Создать**. </br> Введите **myResourceGroupLB**. </br> Щелкните **ОК**. |
    | **Сведения об экземпляре** |                                                                 |
    | Имя             | Введите **myVNet**.                                    |
    | Регион           | Выберите регион **Восточная часть США 2** |

3. Откройте вкладку **IP-адрес** или нажмите кнопку **Далее: IP-адреса** внизу страницы.

4. На вкладке **IP-адреса** укажите следующие сведения:

    | Параметр            | Значение                      |
    |--------------------|----------------------------|
    | Диапазон IPv4-адресов | Введите **10.1.0.0/16**. |

5. В разделе **Имя подсети** выберите **по умолчанию**.

6. В окне **Изменение подсети** введите следующие сведения:

    | Параметр            | Значение                      |
    |--------------------|----------------------------|
    | Имя подсети | Введите **myBackendSubnet**. |
    | Диапазон адресов подсети | Введите **10.1.0.0/24**. |

7. Щелкните **Сохранить**.

8. Перейдите на вкладку **Безопасность**.

9. В разделе **BastionHost** выберите **Включить**. Введите такие сведения:

    | Параметр            | Значение                      |
    |--------------------|----------------------------|
    | Имя бастиона | Введите **myBastionHost**. |
    | Адресное пространство AzureBastionSubnet | Введите **10.1.1.0/24**. |
    | Общедоступный IP-адрес | Выберите **Создать**. </br> В поле **Имя** введите **myBastionIP**. </br> Щелкните **ОК**. |


8. Перейдите на вкладку **Просмотр и создание** или нажмите кнопку **Просмотр и создание**.

9. Нажмите кнопку **Создать**.

### <a name="create-a-virtual-machine"></a>Создание виртуальной машины

1. В верхнем левом углу страницы портала выберите **Создать ресурс** > **Вычисления** > **Виртуальная машина**. 
   
2. В разделе **Создание виртуальной машины** на вкладке **Основные сведения** укажите следующее.

    | Параметр | Значение                                          |
    |-----------------------|----------------------------------|
    | **Сведения о проекте** |  |
    | Подписка | Выбор подписки Azure |
    | Группа ресурсов | Выберите **myResourceGroupLB**. |
    | **Сведения об экземпляре** |  |
    | Имя виртуальной машины | Введите **myVM**. |
    | Регион | Выберите регион **Восточная часть США 2** |
    | Параметры доступности | Выберите **Избыточность инфраструктуры не требуется**. |
    | Образ — | Выберите **Windows Server 2019 Datacenter**. |
    | Точечный экземпляр Azure | Выберите **Нет**. |
    | Размер | Выберите размер виртуальной машины или подтвердите значение по умолчанию. |
    | **Учетная запись администратора** |  |
    | Имя пользователя | Введите имя пользователя. |
    | Пароль | Введите пароль. |
    | Подтверждение пароля | Введите пароль еще раз. |
    | **Правила входящего порта** |  |
    | Общедоступные входящие порты | Выберите **Разрешить выбранные порты** |
    | Выбрать входящие порты | Выбор **протокола удаленного рабочего стола (3389)** |

3. Выберите вкладку **Сеть** или **Далее: диски**, затем **Далее: сеть**.
  
4. На вкладке "Сеть" укажите следующее.

    | Параметр | Значение |
    |-----|------------|
    | **Сетевой интерфейс** |  |
    | Виртуальная сеть | **myVNet** |
    | Подсеть | **myBackendSubnet** |
    | Общедоступный IP-адрес | Выберите **Отсутствует**. |
    | Сетевая группа безопасности сетевого адаптера | Выберите **Нет**.|
    | Разместить эту виртуальную машину за существующим решением для балансировки нагрузки? | Выберите **Нет**. |
   
5. Выберите вкладку **Управление** или **Далее** > **Управление**.

6. На вкладке **Управление** укажите следующее.
    
    | Параметр | Значение |
    |-|-|
    | **Мониторинг** |  |
    | Диагностика загрузки | Выберите **Выкл.** |
   
7. Выберите **Review + create** (Просмотреть и создать). 
  
8. Проверьте параметры, а затем нажмите кнопку **Создать**.

## <a name="create-load-balancers-and-test-connectivity"></a>Создание подсистем балансировки нагрузки и проверка подключения

Используйте портал Azure для создания:

* Внутренняя подсистема балансировки нагрузки
* Общедоступная подсистема балансировки нагрузки
 
Добавьте созданную виртуальную машину во внутренний пул каждого из них.  Затем вы настроите конфигурацию, разрешающую только исходящие подключения с виртуальной машины, проверяя до и после.

### <a name="create-internal-load-balancer"></a>Создание внутренней подсистемы балансировки нагрузки

1. Вверху слева выберите последовательно **Создать ресурс** > **Сети** > **Load Balancer**.

2. На странице **Создание подсистемы балансировки нагрузки** на вкладке **Основные сведения** укажите следующее. 

    | Параметр                 | Значение                                              |
    | ---                     | ---                                                |
    | Подписка               | Выберите свою подписку.    |    
    | Группа ресурсов         | Выберите группу ресурсов **myResourceGroupLB**, созданную на предыдущем шаге.|
    | Имя                   | Введите **минтерналлоадбаланцер**                                   |
    | Регион         | Выберите регион **Восточная часть США 2**.                                        |
    | Тип          | Выберите **Внутренний**.                                        |
    | номер SKU           | Выберите **Стандартный** |
    | Виртуальная сеть | Выберите виртуальную сеть **myVNet**, созданную на предыдущем шаге. |
    | Подсеть  | Выберите подсеть **myBackendSubnet**, созданную на предыдущем шаге. |
    | Назначение IP-адресов | Выберите **Динамический**. |

3. Оставьте значения по умолчанию для остальных параметров и нажмите кнопку **Просмотр и создание**.

4. На вкладке **Отзыв и создание** выберите **Создать**.   

### <a name="create-public-load-balancer"></a>Создание общедоступной подсистемы балансировки нагрузки

1. Вверху слева выберите последовательно **Создать ресурс** > **Сети** > **Load Balancer**.

2. На странице **Создание подсистемы балансировки нагрузки** на вкладке **Основные сведения** укажите следующее. 

    | Параметр                 | Значение                                              |
    | ---                     | ---                                                |
    | Подписка               | Выберите свою подписку.    |    
    | Группа ресурсов         | Выберите **Создать** и введите строку **MyResourceGroupLB** в текстовом поле.|
    | Имя                   | Введите **мипубликлоадбаланцер**                                   |
    | Регион         | Выберите регион **Восточная часть США 2**.                                        |
    | Тип          | Щелкните **Общедоступный**.                                        |
    | номер SKU           | Выберите **Стандартный** |
    | Общедоступный IP-адрес | Выберите **Создать**. |
    | Имя общедоступного IP-адреса | Введите **мифронтендип** в текстовом поле.|
    | Зона доступности | Выберите **Избыточное в пределах зоны**. |
    | Добавление общедоступного IPv6-адреса | Выберите вариант **Нет**. |

3. Оставьте значения по умолчанию для остальных параметров и нажмите кнопку **Просмотр и создание**.

4. На вкладке **Отзыв и создание** выберите **Создать**.   
   
### <a name="create-internal-backend-address-pool"></a>Создать внутренний серверный пул адресов

Создайте серверный пул адресов **минтерналбаккендпул**:

1. Выберите **все службы** в меню слева, выберите **все ресурсы**, а затем в списке ресурсов выберите **минтерналлоадбаланцер** .

2. В разделе **Параметры** выберите **Серверные пулы**, затем щелкните **Добавить**.

3. На странице **Добавление внутреннего пула** в поле Имя введите **минтерналбаккендпул** в качестве имени для серверного пула.
 
4. В разделе **Виртуальная сеть** выберите **myVNet**.

5. В разделе **виртуальные машины** щелкните **Добавить** и выберите **myVM**.
 
6. Нажмите кнопку **Добавить**.

### <a name="create-public-backend-address-pool"></a>Создание пула адресов общедоступной внутренней службы

Создайте серверный пул адресов **мипубликбаккендпул**:

1. Выберите **все службы** в меню слева, выберите **все ресурсы**, а затем в списке ресурсов выберите **мипубликлоадбаланцер** .

2. В разделе **Параметры** выберите **Серверные пулы**, затем щелкните **Добавить**.

3. На странице **Добавление внутреннего пула** в поле Имя введите **мипубликбаккендпул** в качестве имени для серверного пула.

4. В разделе **Виртуальная сеть** выберите **myVNet**.
 
5. В разделе **виртуальные машины** щелкните **Добавить** и выберите **myVM**.
 
6. Нажмите кнопку **Добавить**.

### <a name="test-connectivity-before-outbound-rule"></a>Проверка подключения перед исходящим правилом

1. Выберите **все службы** в меню слева, выберите **все ресурсы**, а затем из списка ресурсов выберите **myVM** , расположенный в группе ресурсов **myResourceGroupLB** .

2. На странице **Обзор** выберите **Подключиться** и **Бастион**.

4. Введите имя пользователя и пароль, введенные в процессе создания виртуальной машины.

5. Выберите **Подключиться**.

6. Откройте обозреватель Internet Explorer.

7. В адресной строке введите **https://whatsmyip.org** .

8. Соединение должно завершиться ошибкой. По умолчанию общедоступная подсистема балансировки нагрузки уровня "Стандартный" [не разрешает исходящий трафик без определенного правила для исходящего трафика](load-balancer-overview.md#securebydefault).
 
### <a name="create-a-public-load-balancer-outbound-rule"></a>Создание правила для исходящего трафика подсистемы балансировки нагрузки

1. Выберите **все службы** в меню слева, выберите **все ресурсы**, а затем в списке ресурсов выберите **мипубликлоадбаланцер** .

2. В разделе **Параметры** выберите **Правила для исходящего трафика**, а затем — **Добавить**.

3. Для настройки правила для исходящего трафика используйте следующие значения:

    | Параметр | Значение |
    | ------- | ----- |
    | Название | Введите **myOutboundRule**. |
    | Интерфейсный IP-адрес | Выберите **лоадбаланцерфронтенд**.|
    | Время ожидания простоя (в минутах) | Переместите ползунок на **15 минут**.|
    | Сброс TCP | Щелкните **Включено**.|
    | Серверный пул | Выберите **мипубликбаккендпул**.| |
    | "Выделение портов" -> "Выделение портов" | Выберите **использовать число исходящих портов по умолчанию** |

4. Выберите **Добавить**.

### <a name="test-connectivity-after-outbound-rule"></a>Проверка подключения после исходящего правила

1. Выберите **все службы** в меню слева, выберите **все ресурсы**, а затем из списка ресурсов выберите **myVM** , расположенный в группе ресурсов **myResourceGroupLB** .

2. На странице **Обзор** выберите **Подключиться** и **Бастион**.

4. Введите имя пользователя и пароль, введенные в процессе создания виртуальной машины.

5. Выберите **Подключиться**.

6. Откройте обозреватель Internet Explorer.

7. В адресной строке введите **https://whatsmyip.org** .

8. Соединение должно быть установлено.

9. Отображаемый IP-адрес должен быть интерфейсным IP-адресом **мипубликлоадбаланцер**.

## <a name="clean-up-resources"></a>Очистка ресурсов

Удалите группу ресурсов, подсистемы балансировки нагрузки, виртуальную машину и все связанные ресурсы, если они больше не нужны. 

Для этого выберите группу ресурсов **myResourceGroupLB** и щелкните **Удалить**.

## <a name="next-steps"></a>Дальнейшие действия

В этом руководстве вы создали конфигурацию "только исходящие" с помощью сочетания общедоступных и внутренних подсистем балансировки нагрузки.  

Эта конфигурация позволяет сбалансировать трафик входящего внутреннего трафика в серверный пул, не мешая всем общедоступным входящим подключениям.

- Дополнительные сведения о [Azure Load Balancer](load-balancer-overview.md).
- Сведения об [исходящих подключениях в Azure](load-balancer-outbound-connections.md).
- [Часто задаваемые вопросы](load-balancer-faqs.md)о подсистеме балансировки нагрузки.
- Дополнительные сведения об [Azure бастиона](../bastion/bastion-overview.md)