---
title: Правила исходящего трафика Azure Load Balancer
description: В этой статье объясняется, как настроить правила исходящего трафика для управления исходящим трафиком Интернета с Azure Load Balancer.
services: load-balancer
author: asudbring
ms.service: load-balancer
ms.topic: conceptual
ms.custom: contperf-fy21q1
ms.date: 10/13/2020
ms.author: allensu
ms.openlocfilehash: 2fc703e0532c86bfc0874c8dccbb17c6142aeed0
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "104590217"
---
# <a name="outbound-rules-azure-load-balancer"></a><a name="outboundrules"></a>Правила исходящего трафика Azure Load Balancer

Правила исходящего трафика позволяют явно определить значение SNAT (преобразование адресов источника) для общедоступной подсистемы балансировки нагрузки уровня "Стандартный". Эта конфигурация позволяет использовать общедоступные IP-адреса подсистемы балансировки нагрузки для обеспечения исходящего подключения к Интернету для экземпляров серверной части.

Эта конфигурация включает:

* Маскировка IP-адресов
* Упрощение списков разрешений.
* Сокращает число общедоступных IP-ресурсов для развертывания.

Правила исходящего трафика позволяют полностью декларативно управлять исходящим подключением к Интернету. Правила исходящего трафика позволяют масштабировать и настраивать эту возможность для конкретных нужд. 

Исходящие правила будут выполнены только в том случае, если на внутренней виртуальной машине не установлен общедоступный IP-адрес уровня экземпляра (ILPIP).

![Правила для исходящего трафика Load Balancer](media/load-balancer-outbound-rules-overview/load-balancer-outbound-rules.png)

С помощью правил исходящего трафика можно явно определить поведение исходящего подключения **SNAT** .

Правила для исходящего трафика позволяют управлять следующим:

* **На каких виртуальных машинах выполняется преобразование общедоступных IP-адресов.**
     * В качестве серверного пула 1 используются два правила: синий IP-адрес 1 и 2, серверный пул 2 использует желтый префикс IP-адреса.
* **Как выделяются исходящие порты SNAT.**
     * Если внутренний пул 2 является единственным пулом, выполняющим исходящие подключения, предоставьте все порты SNAT серверному пулу 2 и None в серверный пул 1.
* **Протоколы для предоставления исходящего преобразования.**
     * Если серверному пулу 2 требуются UDP-порты для исходящего трафика, а серверному пулу 1 требуется протокол TCP, присвойте портам TCP значение 1 и порту UDP значение 2.
* **Какая продолжительность истечения времени ожидания бездействия исходящего подключения (4-120 минут).**
     * Если имеются длительные подключения к проверку активности, резервируете неактивные порты для длительных подключений до 120 минут. Предполагается, что устаревшие подключения отброшены и порты выпускаются в течение 4 минут для новых подключений. 
* **Указывает, следует ли отправить сброс TCP при превышении времени ожидания простоя.**
     * Если время ожидания простаивающих подключений истекло, мы отправляем TCP RST клиенту и серверу, чтобы они обзнали, что поток отброшен?

## <a name="outbound-rule-definition"></a>Определение правила для исходящего трафика

Правила исходящего трафика следуют тому же привычному синтаксису, что и правила балансировки нагрузки и входящего трафика NAT: **интерфейсный**  +    +  **Пул внутренних** параметров. 

Правило для исходящего трафика настраивает NAT для исходящего трафика, предусматривающее преобразование _всех виртуальных машин, определенных с помощью серверного пула_, во _внешний интерфейс_.  

_Параметры_ обеспечивают дополнительный детализированный контроль над алгоритмом исходящего трафика NAT.

## <a name="scale-outbound-nat-with-multiple-ip-addresses"></a><a name="scale"></a> Масштабирование NAT для исходящего трафика при использовании нескольких IP-адресов

Каждый дополнительный IP-адрес, предоставляемый интерфейсом, предоставляет дополнительные 64 000 временных портов для подсистемы балансировки нагрузки для использования в качестве портов SNAT. 

Используйте несколько IP-адресов для планирования крупномасштабных сценариев. Используйте правила исходящего трафика для устранения [нехватки SNAT](troubleshoot-outbound-connection.md#snatexhaust). 

[Префикс общедоступного IP-адреса](./load-balancer-outbound-connections.md#outboundrules) можно также использовать непосредственно с исходящим правилом. 

Префикс общедоступного IP-адреса увеличивает масштаб развертывания. Префикс можно добавить в список разрешенных потоков, исходящих из ресурсов Azure. Можно настроить интерфейсную IP-конфигурацию в подсистеме балансировки нагрузки для ссылки на префикс общедоступного IP-адреса.  

Подсистема балансировки нагрузки управляет префиксом общедоступного IP-адреса. Правило исходящего трафика будет автоматически использовать все общедоступные IP-адреса, содержащиеся в префиксе общедоступного IP-адрес для исходящих соединений. 

Каждый IP-адрес в пределах префикса общедоступного IP-адреса предоставляет дополнительные 64 000 временных портов для каждого IP-адреса балансировщика нагрузки для использования в качестве портов SNAT.

## <a name="outbound-flow-idle-timeout-and-tcp-reset"></a><a name="idletimeout"></a> Тайм-аут простоя исходящего потока и сброс TCP

Правила для исходящего трафика обеспечивают параметр конфигурации для управления временем ожидания перед переходом исходящего потока в режим простоя и сопоставляют его с потребностями приложения. По умолчанию время ожидания перед переходом исходящего потока в режим простоя составляет 4 минуты. Дополнительные сведения см. в разделе [Настройка времени ожидания простоя](load-balancer-tcp-idle-timeout.md). 

Поведение подсистемы балансировки нагрузки по умолчанию заключается в автоматическом удалении потока при достижении времени ожидания истечения исходящего трафика. `enableTCPReset`Параметр обеспечивает предсказуемое поведение приложения и управление им. Параметр определяет, следует ли отсылать двунаправленный сброс TCP (TCP RST) по истечении времени ожидания истечения срока действия исходящего трафика. 

Чтобы получить сведения о доступности региона, проверьте [Сброс TCP на время ожидания простоя](./load-balancer-tcp-reset.md) .

## <a name="securing-and-controlling-outbound-connectivity-explicitly"></a><a name="preventoutbound"></a>Явная защита исходящих подключений и управление ими

Правила балансировки нагрузки обеспечивают автоматическое программирование исходящего NAT. В некоторых сценариях используется преимущество или требуется отключить автоматическое программирование исходящего NAT в рамках правила балансировки нагрузки. Отключение с помощью правила позволяет управлять поведением или уточнять его.  

Этот параметр можно использовать двумя способами:

1. Предотвращение входящего IP-адреса для исходящей SNAT. Отключите исходящее значение SNAT в правиле балансировки нагрузки.
  
2. Настройте параметры исходящего трафика **SNAT** для IP-адреса, используемого для входящих и исходящих подключений одновременно. Для получения управления исходящим правилом необходимо отключить автоматический исходящий NAT. Чтобы изменить распределение портов SNAT для адреса, которое также используется для входящего трафика, `disableOutboundSnat` параметр должен иметь значение true. 

При попытке переопределить IP-адрес, используемый для входящего трафика, операция настройки правила для исходящего трафика завершится ошибкой.  Сначала отключите исходящий NAT правила балансировки нагрузки.

>[!IMPORTANT]
> Виртуальная машина не будет иметь исходящего подключения, если для этого параметра задано значение true и отсутствует правило исходящего трафика для определения исходящих подключений.  Некоторые операции на виртуальной машине или в приложении могут зависеть от доступности исходящего подключения. Ознакомьтесь с зависимостями сценария и проанализируйте влияние этого изменения.

Иногда нежелательно, чтобы виртуальная машина была создана в качестве исходящего потока. Может существовать требование для управления тем, какие назначения получают исходящие потоки, или назначения, которые начинают входящие потоки. Используйте [группы безопасности сети](../virtual-network/network-security-groups-overview.md) для управления назначениями, которые достигает виртуальная машина. Используйте группы безопасности сети для управления тем, какие общедоступные назначения начинают входящие потоки.

При использовании NSG для виртуальной машины с балансировкой нагрузки обратите внимание на [теги службы](../virtual-network/network-security-groups-overview.md#service-tags) и [правила безопасности по умолчанию](../virtual-network/network-security-groups-overview.md#default-security-rules). 

Убедитесь, что виртуальная машина может принимать запросы проверки работоспособности от Azure Load Balancer.

Если NSG блокирует запросы проверки работоспособности от тега AZURE_LOADBALANCER по умолчанию, проверка работоспособности виртуальной машины завершается сбоем, а виртуальная машина помечается как недоступная. Балансировщик нагрузки прекращает отправку новых потоков на эту виртуальную машину.

## <a name="scenarios-with-outbound-rules"></a>Сценарии с правилами исходящего трафика
        

### <a name="outbound-rules-scenarios"></a>Сценарии исходящих правил


* Настройте исходящие подключения к определенному набору общедоступных IP-адресов или префикса.
* Измените выделение портов [SNAT](load-balancer-outbound-connections.md) .
* Включить только исходящие.
* Исходящий трафик NAT только для виртуальных машин (без входящего трафика).
* Исходящий NAT для внутренней подсистемы балансировки нагрузки уровня "Стандартный".
* Включите протокол TCP & UDP для исходящего NAT с помощью общедоступной подсистемы балансировки нагрузки уровня "Стандартный".


### <a name="scenario-1-configure-outbound-connections-to-a-specific-set-of-public-ips-or-prefix"></a><a name="scenario1out"></a>Сценарий 1. Настройка исходящих подключений к определенному набору общедоступных IP-адресов или префикса


#### <a name="details"></a>Сведения


Используйте этот сценарий, чтобы настроить исходящие подключения от набора общедоступных IP-адресов. Добавьте общедоступные IP-адреса или префиксы в список разрешений или запретов на основе происхождения.


Этот общедоступный IP-адрес или префикс может совпадать с именем, используемым правилом балансировки нагрузки. 


Чтобы использовать другой общедоступный IP-адрес или префикс, отличный от используемого правилом балансировки нагрузки, выполните следующие действия. 


1. Создайте префикс общедоступного IP-адреса или общедоступный IP-адрес.
2. Создание общедоступной подсистемы балансировки нагрузки уровня "Стандартный" 
3. Создайте интерфейс, ссылающийся на префикс общедоступного IP-адреса или общедоступный IP-адрес, который вы хотите использовать. 
4. Повторное использование серверного пула или создание внутреннего пула и размещение виртуальных машин в серверном пуле общедоступной подсистемы балансировки нагрузки
5. Настройте правило исходящего трафика в общедоступной подсистеме балансировки нагрузки, чтобы включить исходящий трафик NAT для виртуальных машин с помощью внешнего интерфейса. Не рекомендуется использовать правило балансировки нагрузки для исходящего трафика, отключить исходящий SNAT в правиле балансировки нагрузки.


### <a name="scenario-2-modify-snatport-allocation"></a><a name="scenario2out"></a>Сценарий 2. изменение распределения портов [SNAT](load-balancer-outbound-connections.md)


#### <a name="details"></a>Сведения


Правила для исходящего трафика можно использовать для настройки [автоматического выделения портов SNAT на основе размера внутреннего пула](load-balancer-outbound-connections.md#preallocatedports). 


При возникновении нехватки SNAT увеличьте число портов [SNAT](load-balancer-outbound-connections.md), заданное по умолчанию (1024). 


Каждый общедоступный IP-адрес участвует в 64 000 временных портов. Число виртуальных машин в серверном пуле определяет количество портов, передаваемых на каждую виртуальную машину. Одна виртуальная машина во внутреннем пуле имеет доступ к максимуму 64 000 портов. Для двух виртуальных машин максимальное число портов [SNAT](load-balancer-outbound-connections.md)(32 000) может быть задано с помощью исходящего правила (2x 32 000 = 64 000). 


Для настройки портов SNAT, заданных по умолчанию, можно использовать правила для исходящего трафика. Вы предоставляете больше или меньше, чем выделение портов [SNAT](load-balancer-outbound-connections.md)по умолчанию. Каждый общедоступный IP-адрес из внешнего интерфейса правила для исходящего трафика составляет до 64 000 временных портов для использования в качестве портов [SNAT](load-balancer-outbound-connections.md). 


Балансировщик нагрузки предоставляет порты [SNAT](load-balancer-outbound-connections.md), кратные 8. Если вы предоставляете значение, которое не делится на 8, операция конфигурации будет отклонена. Каждое правило балансировки нагрузки и правило NAT для входящего трафика будут использовать диапазон из 8 портов. Если в правиле балансировки нагрузки или входящего трафика NAT используется один и тот же диапазон 8, никакие дополнительные порты не будут использоваться.


Если вы попытаетесь предоставить больше портов [SNAT](load-balancer-outbound-connections.md), чем доступно в зависимости от числа общедоступных IP-адресов, операция настройки отклоняется. Например, если вы выдаете 10 000 портов на виртуальную машину и семь виртуальных машин в серверном пуле совместно используют один общедоступный IP-адрес, конфигурация отклоняется. Семь, умноженное на 10 000, превышает предельное число портов 64 000. Добавьте дополнительные общедоступные IP-адреса на интерфейсное правило исходящего трафика, чтобы включить этот сценарий. 


Вернитесь к [выделению порта по умолчанию](load-balancer-outbound-connections.md#preallocatedports) , указав 0 в качестве числа портов. Первые 50 экземпляров виртуальных машин получают порты 1024, 51-100 512 экземпляров виртуальных машин — до максимума. Дополнительные сведения о выделении портов SNAT по умолчанию см. в разделе [Таблица распределения портов SNAT](./load-balancer-outbound-connections.md#preallocatedports).


### <a name="scenario-3-enable-outbound-only"></a><a name="scenario3out"></a>Сценарий 3. Включение только исходящего трафика


#### <a name="details"></a>Сведения


Используйте общедоступную подсистему балансировки нагрузки уровня "Стандартный", чтобы предоставить исходящий трафик NAT для группы виртуальных машин. В этом случае используйте правило исходящего трафика отдельно, не настроив никаких дополнительных правил.


> [!NOTE]
> **Виртуальная сеть Azure NAT** может предоставлять исходящие подключения для виртуальных машин без подсистемы балансировки нагрузки. Дополнительные сведения см. в статье [что такое NAT для виртуальной сети Azure?](../virtual-network/nat-overview.md) .

### <a name="scenario-4-outbound-nat-for-vms-only-no-inbound"></a><a name="scenario4out"></a>Сценарий 4. исходящий трафик NAT только для виртуальных машин (без входящего трафика)


> [!NOTE]
> **Виртуальная сеть Azure NAT** может предоставлять исходящие подключения для виртуальных машин без подсистемы балансировки нагрузки. Дополнительные сведения см. в статье [что такое NAT для виртуальной сети Azure?](../virtual-network/nat-overview.md) .

#### <a name="details"></a>Сведения


Для этого сценария: Azure Load Balancer правила исходящих подключений и NAT виртуальной сети — это параметры, доступные для исходящего трафика из виртуальной сети.


1. Создайте общедоступный IP-адрес или префикс.
2. Создайте общедоступную подсистему балансировки нагрузки уровня "Стандартный". 
3. Создайте интерфейс, связанный с общедоступным IP-адресом или префиксом, выделенным для исходящего трафика.
4. Создайте серверный пул для виртуальных машин.
5. Разместите виртуальные машины в серверном пуле.
6. Настройте правило исходящего трафика, чтобы включить исходящий трафик NAT.



Используйте префикс или общедоступный IP-адрес для масштабирования портов [SNAT](load-balancer-outbound-connections.md). Добавьте источник исходящих соединений в список разрешений или запретов.



### <a name="scenario-5-outbound-nat-for-internal-standard-load-balancer"></a><a name="scenario5out"></a>Сценарий 5. исходящий трафик NAT для внутренней подсистемы балансировки нагрузки уровня "Стандартный"


> [!NOTE]
> **Виртуальная сеть Azure NAT** может предоставлять исходящие подключения для виртуальных машин, использующих внутренний балансировщик нагрузки уровня "Стандартный". Дополнительные сведения см. в статье [что такое NAT для виртуальной сети Azure?](../virtual-network/nat-overview.md) .

#### <a name="details"></a>Сведения


Исходящее подключение недоступно для внутренней подсистемы балансировки нагрузки уровня "Стандартный" до тех пор, пока она не была явно объявлена через общедоступные IP-адреса на уровне экземпляра или NAT виртуальной сети, либо путем связывания членов серверного пула с конфигурацией подсистемы балансировки нагрузки только для исходящего трафика. 


Дополнительные сведения см. в разделе [Конфигурация подсистемы балансировки нагрузки только для исходящих подключений](./egress-only.md).




### <a name="scenario-6-enable-both-tcp--udp-protocols-for-outbound-nat-with-a-public-standard-load-balancer"></a><a name="scenario6out"></a>Сценарий 6. Включение протоколов TCP & UDP для исходящего NAT с помощью общедоступной подсистемы балансировки нагрузки уровня "Стандартный"


#### <a name="details"></a>Сведения


При использовании общедоступного стандартного балансировщика нагрузки автоматически предоставляемый исходящий трафик NAT соответствует транспортному протоколу правила балансировки нагрузки. 


1. Отключите исходящий [SNAT](load-balancer-outbound-connections.md)в правиле балансировки нагрузки. 
2. Настройте правило исходящего трафика для той же подсистемы балансировки нагрузки.
3. Повторно используйте серверный пул, который уже использовался для виртуальных машин. 
4. Укажите для протокола значение "Все" как часть правила для исходящего трафика. 


Если используются только правила NAT для входящего трафика, NAT для исходящего трафика обеспечиваться не будет. 


1. Поместите виртуальные машины в серверный пул.
2. Определить одну или несколько IP-конфигураций интерфейсов с общедоступными IP-адресами или префиксом общедоступного IP-адреса 
3. Настройте правило исходящего трафика для той же подсистемы балансировки нагрузки. 
4. Укажите для протокола значение "Все" как часть правила для исходящего трафика.


## <a name="limitations"></a>Ограничения

- Максимальное количество используемых эфемерных портов на один интерфейсный IP-адрес составляет 64 000.
- Диапазон настраиваемого времени ожидания перед переходом исходящих подключений в режим простоя составляет 4–120 минут (240–7200 секунд).
- Балансировщик нагрузки не поддерживает ICMP для исходящего NAT.
- Правила исходящего трафика могут применяться только к основной IP-конфигурации сетевого адаптера.  Невозможно создать правило исходящего трафика для вторичного IP-адреса виртуальной машины или NVA. Поддерживается несколько сетевых карт.
- Все виртуальные машины в группе **доступности** должны быть добавлены во внутренний пул для исходящих подключений. 
- Все виртуальные машины в **масштабируемом наборе виртуальных машин** должны быть добавлены во внутренний пул для исходящих подключений.

## <a name="next-steps"></a>Дальнейшие действия

- Дополнительные сведения об [Azure Load Balancer (цен. Категория "Стандартный")](load-balancer-overview.md)
- Ознакомьтесь с [ответами на часто задаваемые вопросы о Azure Load Balancer](load-balancer-faqs.md)
