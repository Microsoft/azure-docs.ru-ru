---
title: Load Balancer сброса TCP и времени ожидания простоя в Azure
titleSuffix: Azure Load Balancer
description: В этой статье содержатся сведения о Azure Load Balancer с двунаправленными пакетами TCP RST при ожидании простоя.
services: load-balancer
documentationcenter: na
author: asudbring
ms.custom: seodec18
ms.service: load-balancer
ms.devlang: na
ms.topic: how-to
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 10/07/2020
ms.author: allensu
ms.openlocfilehash: 0d02b46345af13770f77a7dac452127a665e01fd
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "94696750"
---
# <a name="load-balancer-tcp-reset-and-idle-timeout"></a>Load Balancer сброс TCP и время ожидания простоя

Чтобы создать более предсказуемое поведение приложения для ваших сценариев, вы можете использовать [Load Balancer (цен. категория "Стандартный")](./load-balancer-overview.md), включив сброс протокола TCP в неактивный режим для данного правила. По умолчанию, когда истекает время ожидания простоя потока, Load Balancer автоматически прерывает его.  Включение этой функции приведет к тому, что Load Balancer будет отправлять двунаправленные сбросы TCP (пакет RST TCP) по истечении времени простоя.  Это сообщит конечным точкам вашего приложения о том, что время соединения истекло и оно больше не используется.  При необходимости конечные точки могут немедленно установить новое соединение.

![Сброс TCP-подключений в Load Balancer](media/load-balancer-tcp-reset/load-balancer-tcp-reset.png)
 
## <a name="tcp-reset"></a>Сброс TCP

Изменить это поведение по умолчанию и включить отправку признаков TCP Reset при истечении времени ожидания простоя можно в правилах NAT для входящего трафика, правилах балансировки нагрузки и [правилах для исходящего трафика](./load-balancer-outbound-connections.md#outboundrules).  Если эта функция включена для отдельного правила, Load Balancer отправляет двунаправленные признаки TCP Reset (TCP-пакеты RST) клиентским и серверным конечным точкам при истечении времени ожидания простоя для всех соответствующих потоков.

Конечные точки, получившие TCP-пакеты RST, немедленно закрывают соответствующий сокет. Таким образом конечные точки немедленно уведомляются об освобождении соединения, и дальнейшие попытки передачи данных по этому TCP-соединению будут завершаться неудачно.  Приложения могут очищать соединения при закрытии сокета и повторно устанавливать их по мере необходимости, не дожидаясь, когда время ожидания TCP-соединения окончательно истечет.

Во многих ситуациях это позволяет уменьшить количество сообщений об активности TCP (или прикладного уровня), которые требуется отправлять для обновления времени ожидания потока. 

Однако если время простоя превышает допускаемое конфигурацией или приложение демонстрирует нежелательное поведение при включенном сбросе TCP, вам может требоваться использовать сообщения об активности TCP (или прикладного уровня) для отслеживания активности TCP-соединений.  Кроме того, сообщения об активности, особенно об активности прикладного уровня, могут по-прежнему быть полезными, если где-то на пути соединения есть прокси-сервер.  

Тщательно проанализируйте весь сценарий, чтобы решить, даст ли преимущества включение сброса TCP и настройка времени ожидания простоя, а также потребуются ли дополнительные действия для обеспечения требуемого поведения приложения.

## <a name="configurable-tcp-idle-timeout"></a>Настраиваемое время ожидания в режиме простоя для TCP-подключения

Azure Load Balancer имеет следующий диапазон времени ожидания простоя:
-  от 4 минут до 100 минут для исходящих правил
-  от 4 до 30 минут для правил Load Balancer и правил NAT для входящего трафика

По умолчанию установлено значение 4 минуты. Если период бездействия превышает значение времени ожидания, нет никакой гарантии, что сеанс TCP или HTTP между клиентом и облачной службой возобновится.

При закрытии подключения клиентское приложение может получить такое сообщение об ошибке: "Базовое соединение закрыто. Соединение, которое должно было работать, было разорвано сервером".

Распространенной практикой является проверка активности TCP. Такой подход позволяет поддерживать подключения активными в течение более длительного периода. Дополнительные сведения вы найдете в следующих [примерах для .NET](/dotnet/api/system.net.servicepoint.settcpkeepalive). Когда проверка активности включена, пакеты отправляются в периоды простоя подключений. Благодаря пакетам проверки активности значение времени ожидания простоя не достигается и подключение сохраняется в течение длительного времени.

Этот параметр применяется только для входящих подключений. Чтобы избежать потери подключения, настройте пакеты проверки активности для TCP с интервалом меньше, чем настроенное время ожидания простоя. Можно также увеличить значение времени ожидания простоя. Для поддержки таких сценариев добавлена возможность настройки времени ожидания простоя.

Проверки активности TCP хорошо подходят для сценариев, в которых не нужно беспокоиться о расходе заряда аккумулятора. Мы не рекомендуем использовать этот вариант для мобильных приложений. Использование этого метода в мобильном приложении может привести к ускоренной разрядке аккумулятора устройства.


## <a name="limitations"></a>Ограничения

- Сброс TCP отправлен только во время подключения TCP в УСТАНОВЛЕНном состоянии.
- Сброс TCP не отправляется для внутренних подсистем балансировки нагрузки с настроенными портами высокой доступности.
- Время ожидания простоя TCP не влияет на правила балансировки нагрузки по протоколу UDP.

## <a name="next-steps"></a>Дальнейшие действия

- Дополнительные сведения о [Load Balancer (цен. Категория "Стандартный")](./load-balancer-overview.md).
- Узнайте о [правилах исходящих подключений](./load-balancer-outbound-connections.md#outboundrules).
- [Настройка TCP RST при истечении времени ожидания простоя](load-balancer-tcp-idle-timeout.md)