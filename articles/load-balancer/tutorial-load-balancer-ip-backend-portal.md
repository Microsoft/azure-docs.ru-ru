---
title: Руководство. Создание общедоступной подсистемы балансировки нагрузки с серверным пулом на основе IP-адресов с помощью портала Azure
titleSuffix: Azure Load Balancer
description: В этом руководстве вы узнаете, как создать общедоступную подсистему балансировки нагрузки с серверным пулом на основе IP-адресов.
author: asudbring
ms.author: allensu
ms.service: load-balancer
ms.topic: tutorial
ms.date: 3/31/2021
ms.custom: template-tutorial
ms.openlocfilehash: f8174d46d1674e0cf81e36e89f6fb6180091a9b9
ms.sourcegitcommit: 9f4510cb67e566d8dad9a7908fd8b58ade9da3b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/01/2021
ms.locfileid: "106123018"
---
# <a name="tutorial-create-a-public-load-balancer-with-an-ip-based-backend-using-the-azure-portal"></a>Руководство. Создание общедоступной подсистемы балансировки нагрузки с серверным пулом на основе IP-адресов с помощью портала Azure

В этом руководстве вы узнаете, как создать общедоступную подсистему балансировки нагрузки с серверным пулом на основе IP-адресов. 

В традиционном развертывании подсистемы балансировки нагрузки Azure используется сетевой интерфейс виртуальных машин. При использовании серверной части на основе IP-адреса виртуальные машины добавляются в серверную часть по IP-адресу.

В этом руководстве описано следующее:

> [!div class="checklist"]
> * Создание виртуальной сети
> * Создание шлюза NAT для исходящего подключения
> * создание Azure Load Balancer;
> * Создание серверного пула на основе IP-адресов
> * Создание двух виртуальных машин
> * Тестирование подсистемы балансировки нагрузки
## <a name="prerequisites"></a>Предварительные требования

- Учетная запись Azure с активной подпиской. [Создайте учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F) бесплатно.

## <a name="create-a-virtual-network"></a>Создание виртуальной сети

В этом разделе вы создадите виртуальную сеть для подсистемы балансировки нагрузки, шлюз NAT и виртуальные машины.

1. Войдите на [портал Azure](https://portal.azure.com).

1. Слева вверху экрана щелкните **Создать ресурс > Сеть > Виртуальная сеть** или выполните поиск по фразе **виртуальная сеть**.

2. Нажмите кнопку **создания**. 

3. В подменю **Создать виртуальную сеть** введите или выберите следующую информацию на вкладке **Основные сведения**:

    | **Параметр**          | **Значение**                                                           |
    |------------------|-----------------------------------------------------------------|
    | **Сведения о проекте**  |                                                                 |
    | Подписка     | Выбор подписки Azure                                  |
    | Группа ресурсов   | Выберите **TutorPubLBIP-rg** |
    | **Сведения об экземпляре** |                                                                 |
    | Имя             | Введите **myVNet**.                                    |
    | Регион           | Выберите регион **(США) Восточная часть США**. |

4. Откройте вкладку **IP-адрес** или нажмите кнопку **Далее: IP-адреса** внизу страницы.

5. На вкладке **IP-адреса** укажите следующие сведения:

    | Параметр            | Значение                      |
    |--------------------|----------------------------|
    | Диапазон IPv4-адресов | Введите **10.1.0.0/16**. |

6. В разделе **Имя подсети** выберите **по умолчанию**.

7. В окне **Изменение подсети** введите следующие сведения:

    | Параметр            | Значение                      |
    |--------------------|----------------------------|
    | Имя подсети | Введите **myBackendSubnet**. |
    | Диапазон адресов подсети | Введите **10.1.0.0/24**. |

8. Щелкните **Сохранить**.

9. Перейдите на вкладку **Безопасность**.

10. В разделе **BastionHost** выберите **Включить**. Введите такие сведения:

    | Параметр            | Значение                      |
    |--------------------|----------------------------|
    | Имя бастиона | Введите **myBastionHost**. |
    | Адресное пространство AzureBastionSubnet | Введите **10.1.1.0/27** |
    | Общедоступный IP-адрес | Выберите **Создать**. </br> В поле **Имя** введите **myBastionIP**. </br> Щелкните **ОК**. |


11. Перейдите на вкладку **Просмотр и создание** или нажмите кнопку **Просмотр и создание**.

12. Нажмите кнопку **создания**.
## <a name="create-nat-gateway"></a>Создание шлюза NAT

В этом разделе вы научитесь создавать шлюз NAT и назначать его подсети в виртуальной сети, созданной ранее.

1. В левом верхнем углу экрана выберите **Создать ресурс >Сеть > Шлюз NAT** или введите **Шлюз NAT** в поле поиска.

2. Нажмите кнопку **создания**. 

3. В разделе **Создание шлюза NAT** на вкладке **Основные сведения** введите или выберите следующие сведения:

    | **Параметр**          | **Значение**                                                           |
    |------------------|-----------------------------------------------------------------|
    | **Сведения о проекте**  |                                                                 |
    | Подписка     | Выберите подписку Azure.                                  |
    | Группа ресурсов   | Нажмите **Создать** и введите **TutorPubLBIP-rg** в текстовом поле. </br> Щелкните **ОК**. |
    | **Сведения об экземпляре** |                                                                 |
    | Имя             | Введите **myNATgateway**.                                    |
    | Регион           | Выберите регион **(США) Восточная часть США**.  |
    | Зона доступности | Выберите **Отсутствует**. |
    | Время ожидания простоя (в минутах) | Введите **10**. |

4. Откройте вкладку **Outbound IP** (Исходящий IP-адрес) или нажмите кнопку **Next: Outbound IP** (Далее: исходящий IP-адрес) внизу страницы.

5. На вкладке **Outbound IP** (Исходящий IP-адрес) введите или выберите следующие значения параметров:

    | **Параметр** | **Значение** |
    | ----------- | --------- |
    | Общедоступные IP-адреса | Выберите **Создание общедоступного IP-адреса**. </br> В поле **Имя** введите **myPublicIP-NAT**. </br> Щелкните **ОК**. |

6. Откройте вкладку **Подсеть** или нажмите кнопку **Next: Subnet** (Далее: подсеть) внизу страницы.

7. На вкладке **подсеть** в раскрывающемся списке **Виртуальная сеть** выберите **myVNet**.

8. Установите флажок рядом с **myBackendSubnet**.

9. Перейдите на вкладку **Просмотр и создание** или нажмите синюю кнопку **Просмотр и создание** внизу страницы.

10. Нажмите кнопку **создания**.
## <a name="create-load-balancer"></a>Создание подсистемы балансировки нагрузки

В этом разделе вы узнаете, как создать Azure Load Balancer (цен. категория "Стандартный"). 

1. Войдите на [портал Azure](https://portal.azure.com).
2. Выберите **Создать ресурс**. 
3. В поле поиска введите **подсистема балансировки нагрузки**. В результатах поиска выберите **Подсистема балансировки нагрузки**.
4. На странице **Подсистема балансировки нагрузки** щелкните **Создать**.
5. На странице **Создание подсистемы балансировки нагрузки** введите или выберите следующие значения: 

    | Параметр                 | Значение                                              |
    | ---                     | ---                                                |
    | **Сведения о проекте** |   |
    | Подписка               | Выберите свою подписку.    |    
    | Группа ресурсов         | Выберите **TutorPubLBIP-rg**.|
    | **Сведения об экземпляре** |   |
    | Имя                   | Введите **myLoadBalancer**.                                   |
    | Регион         | Выберите регион **(США) Восточная часть США**.                                        |
    | Тип          | Щелкните **Общедоступный**.                                        |
    | номер SKU           | Оставьте значение по умолчанию **Стандартная**. |
    | Уровень          | Оставьте значение по умолчанию **Региональная**. |
    | **Общедоступный IP-адрес** |   |
    | Общедоступный IP-адрес | Выберите **Создать**. </br> Если вы хотите использовать существующий общедоступный IP-адрес, выберите **Использовать существующий**. |
    | Имя общедоступного IP-адреса | Введите в текстовое поле **myPublicIP-LB**.|
    | Зона доступности | Введите **Избыточная между зонами**, чтобы создать устойчивую подсистему балансировки нагрузки. Чтобы создать подсистему балансировки нагрузки в определенной зоне, выберите нужную зону (1, 2 или 3). |
    | Добавление общедоступного IPv6-адреса | Выберите вариант **Нет**. </br> Дополнительные сведения об IPv6-адресах и подсистеме балансировки нагрузки см. в статье [Что такое IPv6 для виртуальной сети Azure?](../virtual-network/ipv6-overview.md)  |
    | Предпочтение маршрутизации | Оставьте значение по умолчанию **Сеть Майкрософт**. </br> Дополнительные сведения о предпочтительном варианте маршрутизации см. в статье [Что такое предпочтение маршрутизации?](../virtual-network/routing-preference-overview.md) |

6. Оставьте значения по умолчанию для остальных параметров и нажмите кнопку **Просмотр и создание**.

7. На вкладке **Отзыв и создание** выберите **Создать**.

## <a name="create-load-balancer-resources"></a>Создание ресурсов подсистемы балансировки нагрузки

В этом разделе показано, как настроить следующее:

* параметры подсистемы балансировки нагрузки для пула адресов внутренней части;
* пробу работоспособности;
* Правило подсистемы балансировки нагрузки:

### <a name="create-a-backend-pool"></a>Создание внутреннего пула.

Внутренний пул адресов содержит IP-адреса виртуальных сетевых карт, подключенных к подсистеме балансировки нагрузки. 

Создайте внутренний пул адресов **myBackendPool**, чтобы включить виртуальные машины для балансировки нагрузки интернет-трафика.

1. В меню слева щелкните **Все службы**, выберите **Все ресурсы**, а затем из списка ресурсов выберите **myLoadBalancer**.

2. В разделе **Параметры** выберите **Серверные пулы**, затем щелкните **+ Добавить**.

3. На странице **Добавление серверного пула** введите или выберите следующие сведения:

    | Параметр | Значение |
    | ------- | ----- |
    | Имя | Введите **MyBackendPool**. |
    | Виртуальная сеть | Выберите **myVNet**. |
    | Конфигурация серверного пула | Выберите **IP-адрес**. |
    | Версия IP-адреса | Выберите значение **IPv4**. |

4. Выберите **Добавить**.

### <a name="create-a-health-probe"></a>Создание пробы работоспособности

Подсистема балансировки нагрузки отслеживает состояние приложения, выполняя пробу работоспособности. 

Проба работоспособности добавляет виртуальные машины в балансировщик нагрузки или удаляет их оттуда на основе их ответа на проверки работоспособности. 

Создайте зонд работоспособности с именем **myHealthProbe**, чтобы отслеживать работоспособность виртуальных машин.

1. В меню слева щелкните **Все службы**, выберите **Все ресурсы**, а затем из списка ресурсов выберите **myLoadBalancer**.

2. В разделе **Параметры** выберите **Пробы работоспособности**, а затем щелкните **+ Добавить**.
    
    | Параметр | Значение |
    | ------- | ----- |
    | Имя | Введите **myHealthProbe**. |
    | Протокол | Выберите **TCP**. |
    | Порт | Введите **80**.|
    | Интервал | В качестве **интервала** между попытками выполнения пробы (в секундах) введите **15**. |
    | Пороговое значение сбоя | Выберите **2**. |
   
3. Сохраните остальные значения по умолчанию и нажмите кнопку **Добавить**.

### <a name="create-a-load-balancer-rule"></a>Создание правила балансировщика нагрузки

Правило балансировщика нагрузки позволяет определить распределение трафика между виртуальными машинами. Вы определяете конфигурацию внешнего IP-адреса для входящего трафика и пул внутренних IP-адресов для приема трафика. В этом правиле определяются исходный и конечный порты. 

В этом разделе показано, как создать правило подсистемы балансировки нагрузки, которая имеет следующие характеристики:

* имеет имя **myHTTPRule**;
* находится в интерфейсной части с именем **LoadBalancerFrontEnd**;
* ожидает передачи данных на **порт 80**;
* отправляет трафик балансировки нагрузки на внутреннюю часть с именем **myBackendPool** через **порт 80**.

1. В меню слева щелкните **Все службы**, выберите **Все ресурсы**, а затем из списка ресурсов выберите **myLoadBalancer**.

2. В разделе **Параметры** выберите **Правила балансировки нагрузки**, а затем щелкните **+ Добавить**.

3. Введите или выберите следующие сведения для правила подсистемы балансировки нагрузки:
    
    | Параметр | Значение |
    | ------- | ----- |
    | Имя | Введите **myHTTPRule**. |
    | Версия IP-адреса | Выберите **IPv4**. |
    | Интерфейсный IP-адрес | Выберите **LoadBalancerFrontEnd**. |
    | Протокол | Выберите **TCP**. |
    | Порт | Введите **80**.|
    | Серверный порт | Введите **80**. |
    | Серверный пул | Выберите **myBackendPool**.|
    | Проверка работоспособности | Выберите **myHealthProbe**. |
    | Сохранение сеанса | Оставьте значение по умолчанию **Нет**. |
    | Время ожидания простоя (в минутах) | Введите **15** минут. |
    | Сброс TCP | Щелкните **Включено**. |
    | Плавающий IP-адрес | Выберите **Отключено**. |
    | Преобразование исходных сетевых адресов (SNAT) для исходящего трафика | Выберите **(Рекомендуется) Используйте правила для исходящего трафика, чтобы предоставить участникам внутреннего пула доступ к Интернету**. |

4. Сохраните остальные значения по умолчанию и нажмите кнопку **Добавить**.

## <a name="create-virtual-machines"></a>Создание виртуальных машин

В этом разделе вы узнаете, как создать две виртуальные машины (**myVM1** и **myVM2**) в двух разных зонах (**зона 1** и **зона 2**).

Эти виртуальные машины добавляются во внутренний пул подсистемы балансировки нагрузки, которую вы создали ранее.

1. В верхнем левом углу страницы портала выберите **Создать ресурс** > **Вычисления** > **Виртуальная машина**. 
   
2. В разделе **Создание виртуальной машины** на вкладке **Основные сведения** введите или выберите следующие значения:

    | Параметр | Значение                                          |
    |-----------------------|----------------------------------|
    | **Сведения о проекте** |  |
    | Подписка | Выбор подписки Azure |
    | Группа ресурсов | Выберите **TutorPubLBIP-rg** |
    | **Сведения об экземпляре** |  |
    | Имя виртуальной машины | Введите **myVM1**. |
    | Регион | Выберите регион **(США) Восточная часть США**. |
    | Параметры доступности | Выберите **Зоны доступности**. |
    | Зона доступности | Выберите **1**. |
    | Образ — | Выберите **Windows Server 2019 Datacenter**. |
    | Точечный экземпляр Azure | Оставьте значение по умолчанию. |
    | Размер | Выберите размер виртуальной машины или подтвердите значение по умолчанию. |
    | **Учетная запись администратора** |  |
    | Имя пользователя | Введите имя пользователя. |
    | Пароль | Введите пароль. |
    | Подтверждение пароля | Введите пароль еще раз. |
    | **Правила входящего порта** |  |
    | Общедоступные входящие порты | Выберите **Нет**. |

3. Выберите вкладку **Сеть** или **Далее: диски**, затем **Далее: сеть**.
  
4. На вкладке "Сеть" укажите следующее.

    | Параметр | Значение |
    |-|-|
    | **Сетевой интерфейс** |  |
    | Виртуальная сеть | **myVNet** |
    | Подсеть | **myBackendSubnet** |
    | Общедоступный IP-адрес | Выберите **Отсутствует**. |
    | Сетевая группа безопасности сетевого адаптера | Нажмите кнопку **Дополнительно**.|
    | Настройка группы безопасности сети | Выберите **Создать**. </br> В разделе **Создание группы безопасности сети** введите строку **myNSG** в поле **Имя**. </br> В разделе **Правила для входящего трафика** выберите **+ Добавить правило для входящих подключений**. </br> В поле **Служба** выберите **HTTP**. </br> В поле **Приоритет** введите значение **100**. </br> В поле **Имя** введите **myHTTPRule** </br> Выберите **Добавить**. </br> Нажмите кнопку **ОК**. |
    | **Балансировка нагрузки**  |
    | Настроить эту виртуальную машину для работы с существующим решением по балансировке нагрузки? | Установите флажок.|
    | **Параметры балансировки нагрузки** |
    | Параметры балансировки нагрузки | Выберите **подсистему балансировки нагрузки Azure** |
    | Выберите подсистему балансировки нагрузки | Выберите **myLoadBalancer**.  |
    | Выберите серверный пул | Выберите **MyBackendPool**. |
   
5. Выберите **Review + create** (Просмотреть и создать). 
  
6. Проверьте параметры, а затем нажмите кнопку **Создать**.

7. Выполните шаги 1–6, чтобы создать виртуальную машину со следующими значениями (все остальные параметры совпадают с параметрами виртуальной машины **myVM1**):

    | Параметр | Виртуальная машина 2 |
    | ------- | ----- |
    | Имя |  **myVM2** |
    | Зона доступности | **2** |
    | Группа безопасности сети | Выберите существующий вариант **myNSG**.| 

## <a name="install-iis"></a>Установка служб IIS

1. В меню слева щелкните **Все службы**, выберите **Все ресурсы**, а затем в списке ресурсов выберите виртуальную машину **myVM1**, расположенную в группе ресурсов **TutorPubLBIP-rg**.

2. На странице **Обзор** выберите **Подключиться** и **Бастион**.

3. Нажмите кнопку **Использовать Бастион**.

4. Введите имя пользователя и пароль, введенные в процессе создания виртуальной машины.

5. Выберите **Подключиться**.

6. На рабочем столе сервера перейдите к **Средства администрирования Windows** > **Windows PowerShell**.

7. В окне PowerShell выполните команды, чтобы:

    * установить сервер IIS;
    * удалить файл iisstart.htm по умолчанию;
    * добавить новый файл iisstart.htm, в котором отображается имя виртуальной машины.

   ```powershell
    # install IIS server role
    Install-WindowsFeature -name Web-Server -IncludeManagementTools
    
    # remove default htm file
    Remove-Item C:\inetpub\wwwroot\iisstart.htm
    
    # Add a new htm file that displays server name
    Add-Content -Path "C:\inetpub\wwwroot\iisstart.htm" -Value $("Hello World from " + $env:computername)
   ```
8. Закройте сеанс Бастиона с **myVM1**.

9. Повторите шаги 1–7, чтобы установить IIS и разместить обновленный файл iisstart.htm на **myVM2**.

## <a name="test-the-load-balancer"></a>Тестирование подсистемы балансировки нагрузки

1. Найдите общедоступный IP-адрес для подсистемы балансировки нагрузки на экране **обзора**. В меню слева щелкните **Все службы**, выберите **Все ресурсы**, а затем — **myPublicIP-LB**.

2. Скопируйте общедоступный IP-адрес и вставьте его в адресную строку браузера. В браузере отобразится страница по умолчанию веб-сервера IIS.

   ![Веб-сервер IIS](./media/tutorial-load-balancer-standard-zonal-portal/load-balancer-test.png)

Чтобы увидеть, как подсистема балансировки нагрузки распределяет трафик на виртуальную машину myVM2, принудительно обновите веб-браузер на клиентском компьютере.
## <a name="clean-up-resources"></a>Очистка ресурсов

Если вы не собираетесь продолжать использовать это приложение, удалите виртуальную сеть, виртуальную машину и шлюз NAT, выполнив следующие действия.

1. В меню слева выберите **Группы ресурсов**.

2. Выберите группу ресурсов **TutorPubLBIP-rg**.

3. Выберите **Удалить группу ресурсов**.

4. Введите **TutorPubLBIP-rg** и нажмите **Удалить**.

## <a name="next-steps"></a>Дальнейшие действия

Изучив этот учебник, вы:

* Создали виртуальную сеть
* Создали шлюз NAT
* Создали подсистему балансировки нагрузки с серверным пулом на основе IP-адресов
* Протестировали подсистему балансировки нагрузки

Перейдите к следующей статье, чтобы узнать, как создавать подсистему балансировки нагрузки в нескольких регионах:
> [!div class="nextstepaction"]
> [Создание Azure Load Balancer в нескольких регионах с помощью портала Azure](tutorial-cross-region-portal.md)
