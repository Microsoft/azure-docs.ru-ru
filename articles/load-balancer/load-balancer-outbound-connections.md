---
title: SNAT для исходящих соединений
description: Описывает, как Azure Load Balancer используется для выполнения SNAT для исходящего подключения к Интернету
services: load-balancer
author: asudbring
ms.service: load-balancer
ms.topic: conceptual
ms.custom: contperf-fy21q1
ms.date: 10/13/2020
ms.author: allensu
ms.openlocfilehash: d1632c66791dd5e697b95a2c5aaaddea81629abf
ms.sourcegitcommit: d1e56036f3ecb79bfbdb2d6a84e6932ee6a0830e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/29/2021
ms.locfileid: "99052828"
---
# <a name="using-snat-for-outbound-connections"></a>Использование SNAT для исходящих соединений

IP-адреса интерфейсов общедоступной подсистемы балансировки нагрузки Azure можно использовать для обеспечения исходящего подключения к Интернету для внутренних экземпляров. Эта конфигурация использует **преобразование адресов исходной сети (SNAT)**. SNAT переписывает IP-адрес серверной части в общедоступный IP-адрес балансировщика нагрузки. 

SNAT включает **IP-маскировку** экземпляра серверной части. Это маскировка не позволяет внешним источникам напрямую обращаться к экземплярам серверной части. Совместное использование IP-адреса между экземплярами серверной части сокращает затраты на статические общедоступные IP-адреса и поддерживает такие сценарии, как упрощение списков разрешений IP с трафиком с известных общедоступных IP-адресов 

>[!Note]
> Для приложений, требующих большого количества исходящих подключений или корпоративных клиентов, которым требуется один набор IP-адресов из заданной виртуальной сети, рекомендуется использовать [сеть NAT](../virtual-network/nat-overview.md) . Динамическое выделение обеспечивает простую конфигурацию и > наиболее эффективное использование портов SNAT с каждого IP-адреса. Он также позволяет всем ресурсам в виртуальной сети совместно использовать набор IP-адресов без необходимости совместного использования > балансировщика нагрузки.

>[!Important]
> Даже без настроенной исходящей настройки SNAT учетные записи хранения Azure в одном регионе будут доступны, а серверные ресурсы по-прежнему будут иметь доступ к службам Майкрософт, таким как обновления Windows.

>[!NOTE] 
>В этой статье рассматриваются только Azure Resource Manager развертывания. Рекомендации по использованию классической модели развертывания в Azure можно найти в [этой статье](/previous-versions/azure/load-balancer/load-balancer-outbound-connections-classic).

## <a name="sharing-frontend-ip-address-across-backend-resources"></a><a name ="snat"></a> Совместное использование внешнего IP-адреса в внутренних ресурсах

Если серверные ресурсы балансировщика нагрузки не имеют общедоступных IP-адресов уровня экземпляра (ILPIP), они устанавливают исходящие подключения через интерфейсный IP-адрес общедоступной подсистемы балансировки нагрузки. Порты используются для создания уникальных идентификаторов, используемых для поддержки различных потоков. Для предоставления такого отличия в Интернете используется пять кортежей.

Пять кортежей состоит из следующих компонентов:

* Конечный IP-адрес
* Конечный порт
* Исходный IP-адрес
* Исходный порт и протокол для обеспечения этого различия.

Если порт используется для входящих подключений, он будет иметь **прослушиватель** для входящих запросов на подключение к этому порту и не может использоваться для исходящих соединений. Чтобы установить исходящее подключение, необходимо использовать **временный порт** , чтобы предоставить назначение порту, на котором будет осуществляться обмен и обслуживание отдельного потока трафика. Если эти временные порты используются для выполнения SNAT, они называются **портами SNAT** . 

По определению каждый IP-адрес имеет 65 535 портов. Каждый порт может использоваться для входящих или исходящих соединений TCP (протокол управления передачей) и UDP (протокол датаграммы пользователя). Когда общедоступный IP-адрес добавляется в подсистему балансировки нагрузки в качестве внешнего IP-адреса, Azure предоставляет 64 000 для использования в качестве портов SNAT. 

>[!NOTE]
> Каждый порт, используемый для правила балансировки нагрузки или входящего трафика NAT, будет использовать диапазон из восьми портов из этих портов 64 000, уменьшая количество портов, подходящих для SNAT. Если правило балансировки > нагрузки или NAT находится в том же диапазоне, что и другое, это не потребует дополнительных портов. 

С помощью [правил исходящего трафика](./outbound-rules.md) и правил балансировки нагрузки эти порты SNAT можно распространить на внутренние экземпляры, чтобы они могли совместно использовать общедоступные IP-адреса подсистемы балансировки нагрузки для исходящих соединений.

При настройке [сценария 2](#scenario2) узел для каждого внутреннего экземпляра будет выполнять команду SNAT для пакетов, которые являются частью исходящего подключения. При выполнении SNAT для исходящего подключения к внутреннему экземпляру узел переписывает исходный IP-адрес на один из интерфейсов переднего плана. Чтобы обеспечить уникальность потоков, узел переписывает исходный порт каждого исходящего пакета на один из портов SNAT, выделенных для внутреннего экземпляра.

## <a name="outbound-connection-behavior-for-different-scenarios"></a>Поведение исходящего подключения для различных сценариев
  * Виртуальная машина с общедоступным IP-адресом.
  * Виртуальная машина без общедоступного IP-адреса.
  * Виртуальная машина без общедоступного IP-адреса и без стандартной подсистемы балансировки нагрузки.
        

 ### <a name="scenario-1-virtual-machine-with-public-ip"></a><a name="scenario1"></a> Сценарий 1. Виртуальная машина с общедоступным IP-адресом


 | Сопоставления | Метод | Протоколы IP |
 | ---------- | ------ | ------------ |
 | Общедоступная подсистема балансировки нагрузки или изолированная | [SNAT (преобразование адресов исходной сети)](#snat) </br> не используется. | TCP (протокол управления передачей) </br> UDP (протокол датаграммы пользователя) </br> ICMP (Протокол управляющих сообщений Интернета) </br> ESP (Инкапсуляция полезных данных безопасности) |


 #### <a name="description"></a>Описание


 Azure использует общедоступный IP-адрес, назначенный IP-конфигурации сетевого адаптера экземпляра для всех исходящих потоков. Доступны все временные порты экземпляра. Не имеет значения, сбалансирована ли виртуальная машина. Этот сценарий приоритетнее остальных. 


 Общедоступный IP-адрес назначается виртуальной машине в соотношении "один к одному" (а не "один ко многим") через NAT типа "один к одному" без отслеживания состояния.


 ### <a name="scenario-2-virtual-machine-without-public-ip-and-behind-standard-public-load-balancer"></a><a name="scenario2"></a>Сценарий 2. Виртуальная машина без общедоступного IP-адреса и стандартного общедоступного Load Balancer


 | Сопоставления | Метод | Протоколы IP |
 | ------------ | ------ | ------------ |
 | Стандартная общедоступная подсистема балансировки нагрузки | Использование интерфейсных IP-адресов балансировщика нагрузки для [SNAT](#snat).| TCP </br> UDP |


 #### <a name="description"></a>Описание


 Для ресурса балансировщика нагрузки настроено правило исходящего трафика или правило балансировки нагрузки, которое включает SNAT по умолчанию. Это правило используется для создания связи между общедоступным IP-интерфейсом и внутренним пулом. 


 Если вы не завершите эту конфигурацию правила, поведение будет описано в сценарии 3. 


 Для завершения проверки работоспособности не требуется правило с прослушивателем.


 Когда виртуальная машина создает исходящий поток, Azure преобразует исходный IP-адрес в общедоступный IP-адрес внешнего интерфейса подсистемы балансировки нагрузки. Это преобразование выполняется с помощью [SNAT](#snat). 


 Временные порты внешнего общедоступного IP-адреса балансировщика нагрузки используются для различения отдельных потоков, исходящих от виртуальной машины. При создании исходящих потоков в ходе SNAT динамически используются [предварительно выделенные временные порты](#preallocatedports). 


 В этом контексте временные порты, используемые для SNAT, называются портами SNAT. Настоятельно рекомендуется явно настроить [правило исходящего трафика](./outbound-rules.md) . При использовании SNAT по умолчанию с помощью правила балансировки нагрузки порты SNAT предварительно выделяются, как описано в [таблице распределения портов SNAT по умолчанию](#snatporttable).

 ### <a name="scenario-3-virtual-machine-without-public-ip-and-behind-standard-internal-load-balancer"></a><a name="scenario3"></a>Сценарий 3. Виртуальная машина без общедоступного IP-адреса и стандартного внутреннего Load Balancer


 | Сопоставления | Метод | Протоколы IP |
 | ------------ | ------ | ------------ |
 | Стандартный внутренний балансировщик нагрузки | Нет подключения к Интернету.| Нет |

 #### <a name="description"></a>Описание
 
При использовании стандартного внутреннего балансировщика нагрузки использование временных IP-адресов для SNAT не используется. Это обеспечивает поддержку безопасности по умолчанию и гарантирует, что все IP-адреса, используемые ресурсом, будут настраиваться и могут быть зарезервированы. Чтобы обеспечить исходящее подключение к Интернету при использовании стандартной внутренней подсистемы балансировки нагрузки, настройте общедоступный IP-адрес уровня экземпляра для соблюдения поведения в (сценарий 1) [#scenario1] или добавьте серверные экземпляры в стандартную общедоступную подсистему балансировки нагрузки с помощью правила исходящего трафика, настроенного в аддитон, во внутреннюю подсистему балансировки нагрузки для выполнения действия в #scenario2 ( 

 ### <a name="scenario-4-virtual-machine-without-public-ip-and-behind-basic-load-balancer"></a><a name="scenario4"></a>Сценарий 4. Виртуальная машина без общедоступного IP-адреса и основной Load Balancer


 | Сопоставления | Метод | Протоколы IP |
 | ------------ | ------ | ------------ |
 |Нет </br> Базовая подсистема балансировки нагрузки | [SNAT](#snat) с динамическим IP-адресом на уровне экземпляра| TCP </br> UDP | 

 #### <a name="description"></a>Описание


 Когда виртуальная машина создает исходящий поток, Azure преобразует исходный IP-адрес в динамически выделенный общедоступный исходный IP-адрес. Этот общедоступный IP-адрес **не настраивается** и не может быть зарезервирован. Этот адрес не учитывается в ограничении ресурсов общедоступного IP-адреса подписки. 


 Общедоступный IP-адрес будет освобожден, а при повторном развертывании — запрос нового общедоступного IP-адреса. 


 * Виртуальная машина
 * Группа доступности
 * Набор масштабирования виртуальных машин 


 Не используйте этот сценарий для добавления IP-адресов в список разрешений. Используйте сценарий 1 или 2, где явно объявляется исходящее поведение. Порты [SNAT](#snat) предварительно выделяются, как описано в [таблице распределения портов SNAT по умолчанию](#snatporttable).

## <a name="exhausting-ports"></a><a name="scenarios"></a> Исчерпание портов

Каждое подключение к одному и тому же IP-адресу назначения и порту назначения будет использовать порт SNAT. Это подключение поддерживает отдельный **поток трафика** от экземпляра серверной части или **клиента** до **сервера**. Этот процесс дает серверу отдельный порт для адресации трафика. Без этого процесса клиентский компьютер не знает, в какой поток входит пакет.

Представьте, что у вас есть несколько браузеров https://www.microsoft.com :

* IP-адрес назначения = 23.53.254.142
* Порт назначения = 443
* Протокол = TCP

Без различных портов назначения для возвращаемого трафика (порт SNAT, используемый для установления соединения) клиент не сможет разделить один результат запроса от другого.

Исходящие подключения могут быть пакетными. Экземпляру серверной части можно выделить недостаточные порты. Если не включить **повторное использование подключения** , то риск **нехватки портов** SNAT увеличится.

При нехватке портов новые исходящие подключения к целевому IP-адресу будут завершаться ошибкой. Подключения будут выполнены, если порт станет доступным. Это нехватка возникает, когда порты 64 000 с IP-адреса распределяются тонким по нескольким экземплярам серверной части. Инструкции по устранению нехватки портов SNAT см. в руководстве по [устранению неполадок](./troubleshoot-outbound-connection.md).  

Для подключений TCP подсистема балансировки нагрузки будет использовать один порт SNAT для каждого целевого IP-адреса и порта. Эта многократное включает несколько подключений к одному и тому же IP-адресу назначения с одним и тем же портом SNAT. Это многократное ограничено, если подключение не относится к разным портам назначения.

Для подключений UDP балансировщик нагрузки использует алгоритм **NAT с ограниченным портом** , который потребляет один порт SNAT на конечный IP-адрес, что и порт назначения. 

Порт используется повторно для неограниченного числа подключений. Порт используется повторно только в том случае, если указан другой IP-адрес или порт.

## <a name="default-port-allocation"></a><a name="preallocatedports"></a> Выделение портов по умолчанию

Каждому общедоступному IP-адресу, назначенному в качестве внешнего IP-адреса балансировщика нагрузки, назначаются порты SNAT 64 000 для членов серверного пула. Порты нельзя совместно использовать с элементами внутреннего пула. Диапазон портов SNAT может использоваться только одним внутренним экземпляром для обеспечения правильной маршрутизации возвращаемых пакетов. 

Для настройки выделения портов SNAT рекомендуется использовать явное правило исходящего трафика. Это правило позволит максимально увеличить число портов SNAT, доступных для исходящих подключений на каждом экземпляре сервера. 

Если вы используете автоматическое выделение исходящей SNAT с помощью правила балансировки нагрузки, то в таблице распределения будет определено распределение портов.

В следующей <a name="snatporttable"></a> таблице показано предварительное выделение портов SNAT для уровней размеров серверного пула.

| Размер пула (экземпляры виртуальных машин) | Предварительно выделяемые порты SNAT на каждую конфигурацию IP-адресов |
| --- | --- |
| 1–50 | 1024 |
| 51–100 | 512 |
| 101–200 | 256 |
| 201–400 | 128 |
| 401–800 | 64 |
| 801–1000 | 32 | 

>[!NOTE]
> Если имеется внутренний пул с максимальным размером 10, то каждый экземпляр может иметь 64000/10 = 6 400 портов, если определено явное правило исходящего трафика. В соответствии с приведенной выше таблицей в каждой из них будет 1 024, если выбрано автоматическое выделение.

## <a name="outbound-rules-and-virtual-network-nat"></a><a name="outboundrules"></a> Исходящие правила и NAT виртуальной сети

Azure Load Balancer правила исходящих подключений и NAT виртуальной сети — это параметры, которые можно использовать для выхода из виртуальной сети.

Дополнительные сведения о правилах исходящих подключений см. в разделе [правила исходящих подключений](outbound-rules.md).

Дополнительные сведения об NAT виртуальной сети Azure см. в статье [что такое NAT в виртуальной сети Azure](../virtual-network/nat-overview.md).

## <a name="constraints"></a>Ограничения

*   Когда подключение бездействует, а новые пакеты не отправляются, порты будут освобождены после 4 – 120 минут.
  * Это пороговое значение можно настроить с помощью правил исходящего трафика.
*   Каждый IP-адрес предоставляет порты 64 000, которые можно использовать для SNAT.
*   Каждый порт можно использовать для подключений TCP и UDP к конечному IP-адресу.
  * Порт SNAT UDP необходим независимо от того, является ли порт назначения уникальным. Для каждого подключения UDP к IP-адресу назначения используется один порт UDP SNAT.
  * Порт TCP SNAT можно использовать для нескольких подключений к одному и тому же IP-адресу назначения, если указаны другие порты назначения.
*   Нехватка SNAT возникает, когда на внутреннем экземпляре не хватает портов SNAT. Подсистема балансировки нагрузки может по-прежнему иметь неиспользуемые порты SNAT. Если порт SNAT, используемый экземпляром сервера, превышает заданные порты SNAT, он не сможет установить новые исходящие подключения.

## <a name="next-steps"></a>Дальнейшие действия

*   [Устранение сбоев исходящих подключений из-за нехватки SNAT](./troubleshoot-outbound-connection.md)
*   [Просмотрите метрики SNAT](./load-balancer-standard-diagnostics.md#how-do-i-check-my-snat-port-usage-and-allocation) и ознакомьтесь с правильным способом фильтрации, разбиения и просмотра.
