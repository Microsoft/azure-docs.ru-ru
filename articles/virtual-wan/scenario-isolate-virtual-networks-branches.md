---
title: 'Сценарий: Пользовательская Изоляция для виртуальных сетей и ветвей'
titleSuffix: Azure Virtual WAN
description: Сценарии для маршрутизации — предотвращение того, что выбранные виртуальных сетей и ветви не смогут связаться друг с другом
services: virtual-wan
author: wellee
ms.service: virtual-wan
ms.topic: conceptual
ms.date: 01/25/2021
ms.author: wellee
ms.openlocfilehash: e8e5a5a1b9325f40fdd51133155a0daffaa55a7b
ms.sourcegitcommit: d49bd223e44ade094264b4c58f7192a57729bada
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/02/2021
ms.locfileid: "99408499"
---
# <a name="scenario-custom-isolation-for-virtual-networks-and-branches"></a>Сценарий: Пользовательская Изоляция для виртуальных сетей и ветвей

При работе с маршрутизацией виртуальных сетей виртуальной глобальной сети существует несколько доступных сценариев. В пользовательском сценарии изоляции как для виртуальных сетей (виртуальных сетей), так и для ветвей, цель — предотвратить достижение определенного набора виртуальных сетей другим набором виртуальных сетей. Аналогичным образом ветви (VPN/ER/VPN-пользователь) могут обращаться только к определенным наборам виртуальных сетей.

Мы также представляем дополнительное требование, которое брандмауэр Azure должен проверять ветвь на виртуальную сеть и ветвь к трафику виртуальной сети, но **не**  подсеть к трафику виртуальной сети.  

Дополнительные сведения о маршрутизации виртуальных концентраторов см. в статье [о маршрутизации виртуальных концентраторов](about-virtual-hub-routing.md).

## <a name="design"></a><a name="design"></a>Конструирование

Чтобы определить, сколько таблиц маршрутов потребуется, можно создать матрицу подключения. В этом сценарии он будет выглядеть следующим образом, где каждая ячейка показывает, может ли источник (строка) обмениваться данными с целевым объектом (столбцом):

| От | на:| *Синий виртуальных сетей* | *Красный виртуальных сетей* | *Красные ветви*| *Синие ветви*| 
|---|---|---|---|---|---|
| **Синий виртуальных сетей** |   &#8594;|   Прямой доступ     |           |   |  азфв|
| **Красный виртуальных сетей**  |   &#8594;|              |   Прямой доступ  |  азфв  | 
| **Красные ветви**   |   &#8594;|   |   азфв  |  Прямой доступ | Прямой доступ
| **Синие ветви**| &#8594;| азфв  |   |Прямой доступ   | Прямой доступ

Каждая ячейка в предыдущей таблице описывает, взаимодействует ли виртуальная Глобальная сеть (сторона "from", заголовки строк) с назначением (сторона "to" последовательности, заголовки столбцов, выделенные курсивом). **Direct** означает, что трафик передается напрямую через ВИРТУАЛЬную глобальную сеть, а **азфв** означает, что трафик проверяется брандмауэром Azure перед пересылкой в назначение. Пустая запись означает, что последовательность заблокирована в программе установки.

В этом случае две таблицы маршрутов для виртуальных сетей необходимы для достижения цели изоляции виртуальной сети без использования брандмауэра Azure в пути. Эти таблицы маршрутов будут вызываться **RT_BLUE** и **RT_RED**.

Кроме того, ветви должны всегда быть связаны с таблицей маршрутов  **по умолчанию** . Чтобы обеспечить проверку трафика между ветвями и из них с помощью брандмауэра Azure, мы добавим статические маршруты в таблицах **по умолчанию**, **RT_RED** и **RT_BLUE** таблицы маршрутов, указывающие трафик в брандмауэр Azure, и настройте сетевые правила, чтобы разрешить нужный трафик. Также убедитесь, что ветви **не** распространяются на **RT_BLUE** и **RT_RED**.

В результате это окончательный проект:

* Синие виртуальные сети:
  * Связанная таблица маршрутов: **RT_BLUE**
  * Распространение на таблицы маршрутов: **RT_BLUE**
* Красные виртуальные сети:
  * Связанная таблица маршрутов: **RT_RED**
  * Распространение на таблицы маршрутов: **RT_RED** 
* Ветк
  * Связанная таблица маршрутов: **по умолчанию**
  * Распространение на таблицы маршрутов: **по умолчанию**
* Статические маршруты:
    * **Таблица маршрутов по умолчанию**: адресные пространства виртуальной сети с брандмауэром следующего прыжка Azure
    * **RT_RED**: 0.0.0.0/0 с брандмауэром следующего прыжка Azure
    * **RT_BLUE**: 0.0.0.0/0 с брандмауэром следующего прыжка Azure
* Правила сети брандмауэра:
    * **Разрешить** **префикс источника** правила: код синего адреса филиала **префикс назначения**: синие префиксы виртуальной сети 
    * **Разрешить**  **префикс источника** правила: адрес красной ветви **префикс места назначения**: красные префиксы виртуальной сети

> [!NOTE]
> Так как все ветви необходимо связать с таблицей маршрутов по умолчанию, а также распространить на один и тот же набор таблиц маршрутизации, все ветви будут иметь один и тот же профиль подключения. Иными словами, в ветви нельзя применить концепцию красного или синего для виртуальных сетей. Однако для обеспечения настраиваемой маршрутизации ветвей можно пересылать трафик из ветвей в брандмауэр Azure.

> [!NOTE]
> По умолчанию брандмауэр Azure запрещает трафик в модели с нулевым доверием. Если нет явного правила **разрешения** , соответствующего проверенному пакету, брандмауэр Azure удалит пакет.

Дополнительные сведения о маршрутизации виртуальных концентраторов см. в статье [о маршрутизации виртуальных концентраторов](about-virtual-hub-routing.md).



## <a name="workflow"></a><a name="architecture"></a>Рабочий процесс

На **рис. 1** есть синие и красные виртуальных сетей, а также ветви, которые могут получить доступ к синему или красному виртуальных сетей.

* Синяя подключенная виртуальных сетей может взаимодействовать друг с другом и может обращаться ко всем подключениям Blue Branch (VPN/ER/P2S). На схеме синяя ветвь — это VPN-сайт типа "сеть — сеть".
* Красные подключенные виртуальных сетей могут соединять друг с другом и могут обращаться ко всем подключениям Red ветвей (VPN/ER/P2S). На схеме Красная ветвь — это VPN-пользователи типа "точка — сеть".

При настройке маршрутизации примите во внимание следующие шаги.

1. Создайте две пользовательские таблицы маршрутов в портал Azure, **RT_BLUE** и **RT_RED** , чтобы настроить трафик для этих виртуальных сетей.
2. Для таблицы маршрутов **RT_BLUE** примените следующие параметры, чтобы убедиться в том, что синий виртуальных сетей изучит префиксы адресов всех других синих виртуальных сетей.:
   * **Ассоциация**: выберите все синие виртуальных сетей.
   * **Распространение**: выберите все синие виртуальных сетей.
3. Повторите те же действия для таблицы маршрутов **RT_RED** для Red виртуальных сетей.
4. Подготавливает брандмауэр Azure в виртуальной глобальной сети. Дополнительные сведения о брандмауэре Azure в виртуальном концентраторе глобальной сети см. в статье [Настройка брандмауэра Azure в виртуальном концентраторе глобальной сети](howto-firewall.md).
5. Добавьте статический маршрут к таблице маршрутов **по умолчанию** виртуального концентратора, направляющего весь трафик, предназначенный для адресных пространств виртуальной сети (синие и красные), в брандмауэр Azure. Этот шаг гарантирует, что все пакеты из ветвей будут отправлены в брандмауэр Azure для проверки.
    * Пример: **префикс назначения**: 10.0.0.0/24 **следующий прыжок**: брандмауэр Azure
    >[!NOTE]
    > Этот шаг можно также выполнить с помощью диспетчера брандмауэров, выбрав параметр "безопасный частный трафик". При этом будет добавлен маршрут для всех частных IP-адресов АДРЕСНЫЕ пространства RFC1918, применимых к виртуальных сетей и ветвям. Вам потребуется вручную добавить в любые ветви или виртуальные сети, которые не соответствуют АДРЕСНЫЕ пространства RFC1918. 

6. Добавьте статический маршрут к **RT_RED** и **RT_BLUE** перенаправлять весь трафик в брандмауэр Azure. Этот шаг гарантирует, что виртуальных сетей не сможет напрямую обращаться к ветвям. Этот шаг невозможно выполнить через диспетчер брандмауэров, так как эти виртуальные сети не связаны с таблицей маршрутов по умолчанию.
    * Пример: **префикс назначения**: 0.0.0.0/0 **следующий прыжок**: брандмауэр Azure

    > [!NOTE]
    > Маршрутизация выполняется с использованием наиболее длинного совпадения префикса (LPM). В результате статические маршруты 0.0.0.0/0 **не** будут предпочтительнее, чем точные префиксы, существующие в **BLUE_RT** и **RED_RT**. В результате трафик внутри виртуальной сети не будет проверяться брандмауэром Azure.

Это приведет к изменению конфигурации маршрутизации, как показано на рисунке ниже.

**Рис. 1** 
 [ ![ Рис. ](./media/routing-scenarios/custom-branch-vnet/custom-branch.png) 1](./media/routing-scenarios/custom-branch-vnet/custom-branch.png#lightbox)

## <a name="next-steps"></a>Дальнейшие действия

* Дополнительные сведения о виртуальной глобальной сети см. в статье, содержащей [Часто задаваемые вопросы](virtual-wan-faq.md) о ней.
* Дополнительные сведения о маршрутизации виртуальных концентраторов см. в статье [о маршрутизации виртуальных концентраторов](about-virtual-hub-routing.md).
