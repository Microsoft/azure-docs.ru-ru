---
title: Рекомендации по автоматизации партнеров виртуальной глобальной сети Azure | Документация Майкрософт
description: Настройте среду автоматизации, чтобы подключить и настроить локальное устройство VPN или устройства SD-WAN, или на устройстве филиала для виртуальной глобальной сети Azure.
services: virtual-wan
author: cherylmc
ms.service: virtual-wan
ms.topic: conceptual
ms.date: 06/29/2020
ms.author: cherylmc
ms.openlocfilehash: 29fff3a6a430e3bc1a0b3a13876b55d22f7cb545
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "94566475"
---
# <a name="automation-guidelines-for-virtual-wan-partners"></a>Руководства по службе автоматизации для партнеров Виртуальной глобальной сети

Эта статья поможет понять, как настроить среду автоматизации для подключения и настроить устройство филиала (на локальном VPN-устройстве клиента или SDWAN CPE) Виртуальной глобальной сети Azure. Если вы являетесь поставщиком, предоставляющим устройства для филиалов, обеспечивающие работу VPN-подключения через IPsec/IKEv2 или IPsec/IKEv1, эта статья предназначена для вас.

Устройство филиала (на локальном VPN-устройстве клиента или SDWAN CPE) обычно использует панели мониторинга контроллера или устройства для подготовки к работе. Администраторы SD-WAN решений часто могут использовать консоль управления для предварительной подготовки к работе устройства, прежде чем оно подключается к сети. Это VPN-устройство получает логику плоскости управления от контроллера. VPN-устройство или контроллер SD-WAN могут использовать API-интерфейсы Azure для автоматизации подключения к Виртуальной глобальной сети Azure. Для этого типа подключения требуется локальное устройство для назначения внешнего общедоступного IP-адреса.

## <a name="before-you-begin-automating"></a><a name ="before"></a>Перед началом автоматизации

* Убедитесь, что ваше устройство поддерживает IPsec IKEv1 или IKEv2. Ознакомьтесь с [политиками по умолчанию](#default).
* Просмотрите [интерфейсы API](#additional) , используемые для автоматизации подключения к виртуальной глобальной сети Azure.
* Протестируйте возможности портала Виртуальной глобальной сети Azure.
* Затем решите, какие шаги по подключению требуется автоматизировать. Как минимум мы рекомендуем автоматизировать:

  * Управление доступом
  * Отправку сведений об устройстве филиала в Виртуальную глобальную сеть Azure.
  * Загрузку конфигурации Azure и настройку подключения с устройства филиала в Виртуальной глобальной сети Azure.

### <a name="additional-information"></a><a name ="additional"></a>Дополнительные сведения

* [REST API](/rest/api/virtualwan/virtualhubs) для автоматизации создания виртуальных концентраторов
* [REST API](/rest/api/virtualwan/vpngateways) автоматизации VPN-шлюза Azure для виртуальной глобальной сети
* [REST API](/rest/api/virtualwan/vpnconnections) подключение Впнсите к концентратору VPN Azure
* [Политики IPsec по умолчанию](#default)

## <a name="customer-experience"></a><a name ="ae"></a>Взаимодействие с пользователем

Определите ожидаемое качество обслуживания клиентов для Виртуальной глобальной сети Azure.

  1. Как правило, пользователь Виртуальной глобальной сети начнет с создания ресурса Виртуальной глобальной сети.
  2. Пользователь настроит доступ к группе ресурсов на основе субъекта-службы в локальной системе (вашего контроллера филиала или программного обеспечения для подготовки устройства VPN) для записи сведений о филиале в Виртуальной глобальной сети Azure.
  3. Пользователь может решить в данный момент войти в ваш пользовательский интерфейс и настроить учетные данные субъекта-службы. После завершения настройки ваш контроллер должен автоматически отправить сведения о филиале, которые вы укажете. Ручной эквивалент этого на стороне Azure — функция "Создание сайта".
  4. Когда сведения о сайте (устройстве филиала) будут доступны в Azure, пользователь подключится к концентратору. Виртуальный концентратор — это виртуальная сеть, управляемая корпорацией Майкрософт. Концентратор содержит разные конечные точки службы, чтобы обеспечить подключения с локальной сетью (vpnsite). Концентратор является основой сети в регионе. Может существовать только один центр в каждом регионе Azure, а конечная точка VPN (vpngateway) внутри него создается во время этого процесса. VPN-шлюз — это масштабируемый шлюз, размер которого зависит от пропускной способности и потребностей подключения. Вы можете выбрать автоматизирование виртуального центра и создание vpngateway на панели мониторинга контроллера устройства филиала.
  5. После связи виртуального центра с сайтом для пользователя формируется файл конфигурации для загрузки вручную. Вот где может пригодиться автоматизация, упрощающая работу пользователя. Чтобы пользователю не приходилось вручную загружать и настраивать устройство филиала, вы можете настроить автоматизацию и предоставить пользовательский интерфейс с минимальным количеством переходов по щелчку, тем самым сокращая распространенные проблемы с подключением, например несоответствие общего ключа, несоответствие параметра IPSec, читаемость файла конфигурации и т. д.
  6. В конце этого этапа в вашем решении у пользователя будет надежное подключение типа "сеть — сеть" между устройством филиала и виртуальным центром. Кроме того, можно настроить дополнительные подключения через другие центры. Каждое соединение является туннелем в режиме "активный — активный". Клиент может выбрать разные поставщики услуг Интернета для каждой ссылки туннеля.
  7. Рассмотрите возможность устранения неполадок и мониторинга в интерфейсе управления CPE. Типичные сценарии включают "клиент не может получить доступ к ресурсам Azure из-за проблемы с CPE", "Показывать параметры IPsec на стороне АБОНЕНТа" и т. д.

## <a name="automation-details"></a><a name ="understand"></a>Сведения об автоматизации

###  <a name="access-control"></a><a name="access"></a>Управление доступом

Клиенты должны иметь возможность установить соответствующее управление доступом для Виртуальной глобальной сети в пользовательском интерфейсе устройства. Этот вариант рекомендуется с помощью субъекта-службы Azure. Доступ на основе субъекта-службы обеспечивает правильную аутентификацию контроллера устройства для загрузки информации о филиале. Дополнительные сведения см. в разделе [Проверка прав доступа к подпискам Azure](../active-directory/develop/howto-create-service-principal-portal.md#register-an-application-with-azure-ad-and-create-a-service-principal). Хотя эта функциональность не входит в предложение Виртуальной глобальной сети Azure, ниже перечислены стандартные действия по настройке доступа в Azure, после чего соответствующие данные вводятся на панели мониторинга для управления устройствами.

* Создание приложения Azure Active Directory для вашего локального контроллера устройства
* Получение идентификатора приложения и ключа проверки подлинности
* Получение идентификатора клиента
* Назначение приложению роли "Участник".

###  <a name="upload-branch-device-information"></a><a name="branch"></a>Отправка информации об устройстве филиала

Необходимо разработать взаимодействие с пользователем для отправки сведений о ветви (локального сайта) в Azure. Для создания сведений о сайте в виртуальной глобальной сети можно использовать [интерфейсы API-интерфейсов](/rest/api/virtualwan/vpnsites) впнсите. Вы можете выбрать все VPN-устройства или SDWAN для филиалов или выбрать соответствующие настройки устройств.

### <a name="device-configuration-download-and-connectivity"></a><a name="device"></a>Загрузка конфигурации устройства и подключение

Этот шаг включает в себя загрузку конфигурации Azure и настройку подключения с устройства филиала к Виртуальной глобальной сети Azure. На этом этапе клиент, который не использует поставщик, может вручную загрузить конфигурацию Azure и применить ее к своему локальному VPN-устройству или SDWAN. Вам как поставщику следует автоматизировать этот этап. Дополнительные сведения см. в [API-интерфейсах RESTful](/rest/api/virtualwan/vpnsitesconfiguration/download) для загрузки. Контроллер устройства может вызвать "Жетвпнконфигуратион" REST API, чтобы скачать конфигурацию Azure.

**Примечания к конфигурации**

  * Если виртуальные сети Azure присоединяются к виртуальному центру, они отображаются как ConnectedSubnets.
  * VPN-подключение использует конфигурацию на основе маршрутов и поддерживает протоколы IKEv1 и IKEv2.

## <a name="device-configuration-file"></a><a name="devicefile"></a>Файл конфигурации устройства

Файл конфигурации устройства содержит параметры, которые необходимо использовать при настройке локального VPN-устройства. При просмотре этого файла обратите внимание на следующие сведения:

* **vpnSiteConfiguration**. В этом разделе указаны сведения об устройстве, настроенные как сайт, подключенный к виртуальной глобальной сети. Они содержат имя и общедоступный IP-адрес устройства филиала.
* **vpnSiteConnections**. В этом разделе представлены следующие сведения:

    * **Адресное пространство** виртуальной сети виртуальных концентраторов.<br>Пример:
 
        ```
        "AddressSpace":"10.1.0.0/24"
        ```
    * **Адресное пространство** виртуальных сетей, подключенных к концентратору.<br>Пример

         ```
        "ConnectedSubnets":["10.2.0.0/16","10.3.0.0/16"]
         ```
    * **IP-адреса** VPN-шлюзов виртуального концентратора. Так как каждое подключение VPN-шлюза состоит из 2 туннелей в конфигурации "активный — активный", в этом файле будут указаны оба IP-адреса. В данном примере вы видите Instance0 и Instance1 для каждого сайта.<br>Пример

        ``` 
        "Instance0":"104.45.18.186"
        "Instance1":"104.45.13.195"
        ```
    * **Сведения о конфигурации подключения к Vpngateway**, такие как протокол BGP, общий ключ и т. д. PSK — это автоматически созданный общий ключ. Вы всегда можете изменить подключение на странице обзора для настраиваемого ключа PSK.
  
**Пример файла конфигурации устройства**

  ```
  { 
      "configurationVersion":{ 
         "LastUpdatedTime":"2018-07-03T18:29:49.8405161Z",
         "Version":"r403583d-9c82-4cb8-8570-1cbbcd9983b5"
      },
      "vpnSiteConfiguration":{ 
         "Name":"testsite1",
         "IPAddress":"73.239.3.208"
      },
      "vpnSiteConnections":[ 
         { 
            "hubConfiguration":{ 
               "AddressSpace":"10.1.0.0/24",
               "Region":"West Europe",
               "ConnectedSubnets":[ 
                  "10.2.0.0/16",
                  "10.3.0.0/16"
               ]
            },
            "gatewayConfiguration":{ 
               "IpAddresses":{ 
                  "Instance0":"104.45.18.186",
                  "Instance1":"104.45.13.195"
               }
            },
            "connectionConfiguration":{ 
               "IsBgpEnabled":false,
               "PSK":"bkOWe5dPPqkx0DfFE3tyuP7y3oYqAEbI",
               "IPsecParameters":{ 
                  "SADataSizeInKilobytes":102400000,
                  "SALifeTimeInSeconds":3600
               }
            }
         }
      ]
   },
   { 
      "configurationVersion":{ 
         "LastUpdatedTime":"2018-07-03T18:29:49.8405161Z",
         "Version":"1f33f891-e1ab-42b8-8d8c-c024d337bcac"
      },
      "vpnSiteConfiguration":{ 
         "Name":" testsite2",
         "IPAddress":"66.193.205.122"
      },
      "vpnSiteConnections":[ 
         { 
            "hubConfiguration":{ 
               "AddressSpace":"10.1.0.0/24",
               "Region":"West Europe"
            },
            "gatewayConfiguration":{ 
               "IpAddresses":{ 
                  "Instance0":"104.45.18.187",
                  "Instance1":"104.45.13.195"
               }
            },
            "connectionConfiguration":{ 
               "IsBgpEnabled":false,
               "PSK":"XzODPyAYQqFs4ai9WzrJour0qLzeg7Qg",
               "IPsecParameters":{ 
                  "SADataSizeInKilobytes":102400000,
                  "SALifeTimeInSeconds":3600
               }
            }
         }
      ]
   },
   { 
      "configurationVersion":{ 
         "LastUpdatedTime":"2018-07-03T18:29:49.8405161Z",
         "Version":"cd1e4a23-96bd-43a9-93b5-b51c2a945c7"
      },
      "vpnSiteConfiguration":{ 
         "Name":" testsite3",
         "IPAddress":"182.71.123.228"
      },
      "vpnSiteConnections":[ 
         { 
            "hubConfiguration":{ 
               "AddressSpace":"10.1.0.0/24",
               "Region":"West Europe"
            },
            "gatewayConfiguration":{ 
               "IpAddresses":{ 
                  "Instance0":"104.45.18.187",
                  "Instance1":"104.45.13.195"
               }
            },
            "connectionConfiguration":{ 
               "IsBgpEnabled":false,
               "PSK":"YLkSdSYd4wjjEThR3aIxaXaqNdxUwSo9",
               "IPsecParameters":{ 
                  "SADataSizeInKilobytes":102400000,
                  "SALifeTimeInSeconds":3600
               }
            }
         }
      ]
   }
  ```

## <a name="connectivity-details"></a><a name="default"></a>Сведения о подключении

Ваша конфигурация локальных VPN-устройств / SDWAN или SD-WAN должна совпадать со следующими алгоритмами и параметрами, указанными в политике Azure IPsec/IKE, или содержать их.

* Алгоритм шифрования IKE
* Алгоритм проверки целостности IKE
* Группа DH
* Алгоритм шифрования IPsec
* Алгоритм проверки целостности IPsec
* Группа PFS

### <a name="default-policies-for-ipsec-connectivity"></a><a name="default"></a>Политики по умолчанию для подключения IPsec

[!INCLUDE [IPsec Default](../../includes/virtual-wan-ipsec-include.md)]

### <a name="custom-policies-for-ipsec-connectivity"></a><a name="custom"></a>Пользовательские политики для подключения IPsec

[!INCLUDE [IPsec Custom](../../includes/virtual-wan-ipsec-custom-include.md)]

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о Виртуальной глобальной сети см. в разделе [Сведения о Виртуальной глобальной сети Azure](virtual-wan-about.md) и [Часто задаваемые вопросы о Виртуальной глобальной сети Azure (WAN)](virtual-wan-faq.md).

Для получения дополнительных сведений отправьте электронное сообщение по адресу <azurevirtualwan@microsoft.com>. В строке темы заключите название компании в скобки [].