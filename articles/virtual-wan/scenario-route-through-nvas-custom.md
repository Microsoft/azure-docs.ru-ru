---
title: Маршрутизация трафика через NVA с помощью пользовательских параметров
titleSuffix: Azure Virtual WAN
description: Этот сценарий помогает маршрутизировать трафик через NVA, используя другой NVA для трафика, связанного с Интернетом.
services: virtual-wan
author: cherylmc
ms.service: virtual-wan
ms.topic: conceptual
ms.date: 09/22/2020
ms.author: cherylmc
ms.custom: fasttrack-edit
ms.openlocfilehash: 8e51d7d00120f6facb0fb53a8e379d157ae79ea4
ms.sourcegitcommit: 2f9f306fa5224595fa5f8ec6af498a0df4de08a8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/28/2021
ms.locfileid: "98938580"
---
# <a name="scenario-route-traffic-through-nvas-by-using-custom-settings"></a>Сценарий: маршрутизация трафика через NVA с помощью пользовательских параметров

При работе с маршрутизацией виртуальных глобальных сетей Azure доступно несколько вариантов. В этой статье рассматривается маршрутизация трафика через виртуальный сетевой модуль (NVA) для обмена данными между виртуальными сетями и ветвями, а также использование другого NVA для трафика, связанного с Интернетом. Дополнительные сведения см. в статье [о маршрутизации виртуальных концентраторов](about-virtual-hub-routing.md).

## <a name="design"></a>Конструирование

* **Периферийные серверы** для виртуальных сетей, подключенных к виртуальному концентратору. (Например, VNet 1, VNet 2 и VNet 3 на схеме далее в этой статье).
* Виртуальная **сеть службы** для виртуальных сетей, в которой пользователи развернули NVA для проверки трафика, не входящего в Интернет, и, возможно, с общими службами, к которым обращаются периферийные серверы. (Например, виртуальная сеть 4 на схеме далее в этой статье). 
* **Периметр виртуальной сети** для виртуальных сетей, в которых пользователи развернули NVA для проверки трафика, связанного с Интернетом. (Например, виртуальная сеть 5 на схеме далее в этой статье.)
* **Концентраторы** для виртуальных КОНЦЕНТРАТОРОВ глобальной сети, управляемые корпорацией Майкрософт.

В следующей таблице перечислены подключения, поддерживаемые в этом сценарии.

| От          | Кому|Периферийные точки|Виртуальная сеть службы|Ветви|Интернет|
|---|---|:---:|:---:|:---:|:---:|:---:|
| **Периферийные точки**| ->| напрямую; |напрямую; | через виртуальную сеть службы |через периметр виртуальной сети |
| **Виртуальная сеть службы**| ->| напрямую; |н/д| напрямую; | |
| **Ветви** | ->| через виртуальную сеть службы |напрямую;| напрямую; |  |

Каждая ячейка в матрице подключения описывает, поступают ли подключения напрямую через виртуальную глобальную сеть или одну из виртуальных сетей с помощью NVA. 

Обратите внимание на следующие сведения:
* Периферийных зон
  * Периферийные серверы будут достигать других периферийных устройств непосредственно через виртуальные концентраторы глобальной сети.
  * Периферийные серверы получают возможность подключения к ветвям через статический маршрут, указывающий на виртуальную сеть службы. Они не изучит конкретные префиксы из ветвей, так как они более специфичны и переопределяют сводку.
  * Периферийные серверы отправляют Интернет-трафик в сеть периметра через пиринг прямого подключения к сети.
* Ветви будут получать периферийные серверы через статическую маршрутизацию, указывающую на виртуальную сеть службы. Они не изучит конкретные префиксы из виртуальных сетей, переопределяющих обобщенный статический маршрут.
* Виртуальная сеть службы будет похожа на виртуальную сеть общих служб, которая должна быть доступна из каждой виртуальной сети и каждой ветви.
* Сети периметра не требуется подключение через виртуальную сеть WAN, так как трафик, который он будет поддерживать, поступает через прямые соединения между виртуальными сетями. Однако для упрощения конфигурации используйте ту же модель подключения, что и для сети периметра.

Существует три разных шаблона подключения, которые преобразуются в три таблицы маршрутов. Связи с различными виртуальными сетями:

* Периферийных зон
  * Связанная таблица маршрутов: **RT_V2B**
  * Распространение на таблицы маршрутов: **RT_V2B** и **RT_SHARED**
* NVA виртуальных сетей (виртуальная сеть и ДЕМИЛИТАРИЗОВАНная зона службы):
  * Связанная таблица маршрутов: **RT_SHARED**
  * Распространение на таблицы маршрутов: **RT_SHARED**
* Ветк
  * Связанная таблица маршрутов: **по умолчанию**
  * Распространение на таблицы маршрутов: **RT_SHARED** и **по умолчанию**

> [!NOTE] 
> Убедитесь, что периферийная виртуальных сетей не распространяется на метку по умолчанию. Это гарантирует, что трафик из ветвей в периферийную виртуальных сетей будет перенаправлен в NVA.

Эти статические маршруты обеспечивают передачу входящего и исходящего трафика между виртуальной сетью и ветвью через NVA в виртуальной сети службы (VNet 4):

| Описание | Таблица маршрутов | Статический маршрут              |
| ----------- | ----------- | ------------------------- |
| Ветви    | RT_V2B      | 10.2.0.0/16-> vnet4conn  |
| NVA спицы  | По умолчанию     | 10.1.0.0/16-> vnet4conn  |

Теперь можно использовать виртуальную глобальную сеть для выбора правильного подключения для отправки пакетов. Кроме того, необходимо использовать виртуальную глобальную сеть для выбора правильного действия, выполняемого при получении этих пакетов. Для этого используются таблицы маршрутов подключения следующим образом:

| Описание | Соединение | Статический маршрут            |
| ----------- | ---------- | ----------------------- |
| VNet2Branch | vnet4conn  | 10.2.0.0/16-> 10.4.0.5 |
| Branch2VNet | vnet4conn  | 10.1.0.0/16-> 10.4.0.5 |

Дополнительные сведения см. в статье [о маршрутизации виртуальных концентраторов](about-virtual-hub-routing.md).

## <a name="architecture"></a>Architecture

Ниже приведена схема архитектуры, описанной выше в этой статье.

Существует один концентратор, именуемый **Hub 1**.

* **Концентратор 1** напрямую подключен к NVA виртуальных сетей **vnet 4** и **vnet 5**.

* Трафик между виртуальных сетей 1, 2 и 3 и ветвями должен проходить через **виртуальную сеть 4 NVA** 10.4.0.5.

* Весь Интернет-трафик, связанный с виртуальных сетей 1, 2 и 3, должен проходить через **виртуальную сеть 5 NVA** 10.5.0.5.

:::image type="content" source="./media/routing-scenarios/nva-custom/figure-1.png" alt-text="Схема сетевой архитектуры.":::

## <a name="workflow"></a>Рабочий процесс

Чтобы настроить маршрутизацию через NVA, выполните следующие действия:

1. Для трафика, связанного с Интернетом, через виртуальную сеть 5 требуется виртуальных сетей 1, 2 и 3 для прямого подключения через пиринг виртуальных сетей к виртуальной сети 5. Кроме того, необходимо настроить определяемый пользователем маршрут в виртуальных сетях для 0.0.0.0/0 и следующего прыжка 10.5.0.5. В настоящее время Виртуальная глобальная сеть не допускает NVA следующего прыжка в виртуальном концентраторе для 0.0.0.0/0.

1. В портал Azure перейдите к своему виртуальному концентратору и создайте настраиваемую таблицу маршрутов с именем **RT_Shared**. В этой таблице описаны маршруты через распространение из всех виртуальных сетей и подключений филиалов. Эту пустую таблицу можно увидеть на следующей схеме.

   * **Маршруты:** Нет необходимости добавлять статические маршруты.

   * **Ассоциация:** Выберите виртуальных сетей 4 и 5, что означает, что подключения этих виртуальных сетей связаны с таблицей маршрутов **RT_Shared**.

   * **Распространение:** Так как все ветви и виртуальные сети должны динамически распространять свои маршруты в эту таблицу маршрутов, выберите пункт ветви и все виртуальные сети.

1. Создайте пользовательскую таблицу маршрутов с именем **RT_V2B** для направления трафика от виртуальных сетей 1, 2 и 3 к ветвям.

   * **Маршруты:** Добавьте агрегированную статическую запись маршрута для ветвей со следующим прыжком в качестве подключения к виртуальной сети 4. Настройте статический маршрут в подключении к виртуальной сети 4 для префиксов ветвей и укажите следующий прыжок в качестве конкретного IP-адреса NVA в виртуальной сети 4.

   * **Ассоциация:** Выберите все виртуальных сетей 1, 2 и 3. Это подразумевает, что подключения к виртуальной сети 1, 2 и 3 будут связаны с этой таблицей маршрутов и смогут изучать маршруты (статические и динамические через распространение) в этой таблице маршрутов.

   * **Распространение:** Подключения распространяют маршруты в таблицы маршрутов. Выбор виртуальных сетей 1, 2 и 3 включает распространение маршрутов из виртуальных сетей 1, 2 и 3 в эту таблицу маршрутов. Нет необходимости распространять маршруты от подключений филиала к **RT_V2B**, так как трафик виртуальной сети филиала проходит через NVA в VNet 4.
  
1. Измените таблицу маршрутов по умолчанию **дефаултраутетабле**.

   Все VPN, Azure ExpressRoute и VPN-подключения пользователей связаны с таблицей маршрутов по умолчанию. Все VPN-подключения ExpressRoute и User VPN распространяют маршруты на один и тот же набор таблиц маршрутов.

   * **Маршруты:** Добавьте агрегированную статическую запись маршрута для виртуальных сетей 1, 2 и 3 со следующим прыжком в качестве подключения к виртуальной сети 4. Настройте статический маршрут в подключении к виртуальной сети 4 для VNet 1, 2 и 3 обобщенных префиксов и укажите следующий прыжок в качестве конкретного IP-адреса NVA в виртуальной сети 4.

   * **Ассоциация:** Убедитесь, что выбран параметр для ветвей (VPN/ER/P2S), чтобы локальные подключения филиала сопоставлены с таблицей маршрутов по умолчанию.

   * **Распространение из:** Убедитесь, что выбран параметр для ветвей (VPN/ER/P2S), что позволяет локальным подключениям распространять маршруты в таблицу маршрутов по умолчанию.

:::image type="content" source="./media/routing-scenarios/nva-custom/figure-2.png" alt-text="Схема рабочего процесса." lightbox="./media/routing-scenarios/nva-custom/figure-2.png":::

## <a name="next-steps"></a>Дальнейшие действия

* Дополнительные сведения о виртуальной глобальной сети см. в статье, содержащей [Часто задаваемые вопросы](virtual-wan-faq.md) о ней.
* Дополнительные сведения о маршрутизации виртуальных концентраторов см. в статье [о маршрутизации виртуальных концентраторов](about-virtual-hub-routing.md).
