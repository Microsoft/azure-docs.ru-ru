---
title: Подключение к виртуальной машине SQL Azure для индексирования поиска
titleSuffix: Azure Cognitive Search
description: Включите шифрование подключений и настройте брандмауэр, чтобы разрешить подключения к SQL Server на виртуальной машине Azure из индексатора в Azure Когнитивный поиск.
author: markheff
ms.author: maheff
ms.service: cognitive-search
ms.topic: conceptual
ms.date: 03/19/2021
ms.openlocfilehash: 1f9169d4f3f6361e557c41a4d612cf6c439257fb
ms.sourcegitcommit: e6de1702d3958a3bea275645eb46e4f2e0f011af
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "104722520"
---
# <a name="configure-a-connection-from-an-azure-cognitive-search-indexer-to-sql-server-on-an-azure-vm"></a>Настройка подключения из индексатора Когнитивный поиск Azure для SQL Server на виртуальной машине Azure

При настройке [индексатора SQL Azure](search-howto-connecting-azure-sql-database-to-azure-search-using-indexers.md#faq) для извлечения содержимого из базы данных на виртуальной машине Azure для защищенных соединений требуются дополнительные действия. 

Подключение из Когнитивный поиск Azure к SQL Server на виртуальной машине является общедоступным подключением к Интернету. Чтобы обеспечить успешную безопасность подключений, выполните следующие действия.

+ Получение сертификата от [поставщика центра сертификации](https://en.wikipedia.org/wiki/Certificate_authority#Providers) для полного доменного имени экземпляра SQL Server на виртуальной машине

+ Установите сертификат на виртуальной машине, а затем включите и настройте зашифрованные подключения на виртуальной машине, используя инструкции, приведенные в этой статье.

## <a name="enable-encrypted-connections"></a>Активация зашифрованных подключений

Когнитивный поиск Azure требуется зашифрованный канал для всех запросов индексатора через общедоступное подключение к Интернету. В данном разделе перечислены действия, необходимые для выполнения этого требования.

1. Проверьте свойства сертификата, чтобы убедиться, что имя субъекта является полным доменным именем (FQDN) виртуальной машины Azure. Чтобы просмотреть свойства, можно воспользоваться инструментом, таким как CertUtils, или оснасткой диспетчера сертификатов. Полное доменное имя можно найти на **портале Azure** в колонке служб виртуальных машин (в разделе "Основные сведения" в поле [Общедоступный IP-адрес/Метка DNS-имени](https://portal.azure.com/)).
  
   + Для виртуальных машин, созданных с помощью более нового шаблона **Resource Manager**, полное доменное имя имеет формат `<your-VM-name>.<region>.cloudapp.azure.com`.

   + Для более старых виртуальных машин, созданных как **классические** виртуальные машины, полное доменное имя имеет формат `<your-cloud-service-name.cloudapp.net>`.

1. С помощью редактора реестра (regedit) настройте SQL Server для использования сертификата. 

   Несмотря на то, что диспетчер конфигурации SQL Server часто используется для данной задачи, его нельзя использовать в этом сценарии. Он не найдет импортированный сертификат, так как полное доменное имя виртуальной машины в Azure не соответствует полному доменному имени, определенному виртуальной машиной (он определяет домен как локальный компьютер или как сетевой домен, к которому он присоединен). Если имена не совпадают, воспользуйтесь редактором реестра, чтобы указать сертификат.

   + В редакторе реестра перейдите к разделу реестра: `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Microsoft SQL Server\[MSSQL13.MSSQLSERVER]\MSSQLServer\SuperSocketNetLib\Certificate`.

     Часть `[MSSQL13.MSSQLSERVER]` зависит от версии и имени экземпляра. 

   + В качестве значения ключа **сертификата** задайте **отпечаток** сертификата TLS/SSL, импортированного на виртуальную машину.

     Есть несколько способов получить это значение отпечатка, из которых некоторые удобнее других. Если скопировать его из оснастки **диспетчера сертификатов** в MMC, то вероятно вы также скопируете невидимый начальный знак, как описано в [этой справочной статье](https://support.microsoft.com/kb/2023869/), что приведет к ошибке при попытке подключения. Для этой проблемы существует несколько обходных решений. Самый простой способ — это стереть клавишей BACKSPACE, а затем повторно ввести первый знак отпечатка, чтобы удалить начальный знак в поле значения ключа в редакторе реестра. Также для копирования отпечатка можно воспользоваться другим инструментом.

1. Предоставьте разрешения учетной записи службы. 

    Убедитесь, что учетной записи службы SQL Server предоставлено соответствующее разрешение для закрытого ключа сертификата TLS/SSL. Если пренебречь этим шагом, то SQL Server не запустится. Для выполнения этой задачи можно использовать оснастку **сертификатов** или инструмент **CertUtils**.

1. Перезапустите службу SQL Server.

## <a name="configure-sql-server-connectivity-in-the-vm"></a>Настройка подключения к SQL Server на виртуальной машине

После настройки зашифрованного подключения, необходимого для Когнитивный поиск Azure, необходимо выполнить дополнительные действия по настройке SQL Server на виртуальных машинах Azure. Если вы еще не сделали этого, выполните следующие действия, чтобы завершить настройку с помощью одной из следующих статей:

+ Если вы используете виртуальную машину **Resource Manager** , то ознакомьтесь с разделом [Подключение к виртуальной машине SQL Server в Azure (диспетчер ресурсов)](../azure-sql/virtual-machines/windows/ways-to-connect-to-sql.md). 

+ Если вы используете **классическую** виртуальную машину, см. статью [Подключение к виртуальной машине SQL Server в Azure (классическое развертывание)](/previous-versions/azure/virtual-machines/windows/sqlclassic/virtual-machines-windows-classic-sql-connect).

В частности, в каждой из этих статей ознакомьтесь с разделом "Подключение к SQL Server через Интернет".

## <a name="configure-the-network-security-group-nsg"></a>Настройка группы безопасности сети (NSG)

Обычной практикой является настройка группы безопасности сети и соответствующей конечной точки Azure или списка управления доступом (ACL) таким образом, чтобы виртуальная машина Azure стала доступной для других сторон. Есть вероятность, что вы уже выполнили эту настройку, чтобы разрешить логике своего приложения подключаться к виртуальной машине SQL Azure. Подключение Azure Когнитивный поиск к виртуальной машине SQL Azure не отличается. 

Приведенные ниже ссылки содержат инструкции по настройке групп безопасности сети для развертывания виртуальной машины. Используйте эти инструкции для ACL для конечной точки Azure Когнитивный поиск в соответствии с ее IP-адресом.

> [!NOTE]
> Основные сведения см. в статье [Группа безопасности сети](../virtual-network/network-security-groups-overview.md).

+ Если вы используете виртуальную машину **Resource Manager**, см. статью [Как управлять сетевыми группами безопасности с помощью портала предварительной версии](../virtual-network/tutorial-filter-network-traffic.md).

+ Если вы используете **классическую** виртуальную машину, см. статью [Как создать группы безопасности сети (классические) в PowerShell](/previous-versions/azure/virtual-network/virtual-networks-create-nsg-classic-ps).

Назначение IP-адресов может создать некоторые сложности, но их можно легко преодолеть, если знать о проблеме и о возможных путях ее решения. В дальнейших разделах приводятся рекомендации по устранению проблем, связанных с IP-адресами в списке управления доступом.

### <a name="restrict-access-to-the-azure-cognitive-search"></a>Ограничение доступа к Когнитивный поиск Azure

Мы настоятельно рекомендуем ограничить доступ к IP-адресу службы поиска и к диапазону IP-адресов `AzureCognitiveSearch` [](../virtual-network/service-tags-overview.md#available-service-tags) в списке ACL, а не сделать так, чтобы SQL Azure виртуальные машины открывались для всех запросов на подключение.

IP-адрес можно узнать, обратившись к полному доменному имени (например, `<your-search-service-name>.search.windows.net` ) службы поиска. Хотя IP-адрес службы поиска может измениться, маловероятно, что он изменится. IP-адрес может быть статическим в течение времени существования службы.

Диапазон IP-адресов для `AzureCognitiveSearch` [тега службы](../virtual-network/service-tags-overview.md#available-service-tags) можно узнать с помощью [загружаемых файлов JSON](../virtual-network/service-tags-overview.md#discover-service-tags-by-using-downloadable-json-files) или через [API обнаружения тегов служб](../virtual-network/service-tags-overview.md#use-the-service-tag-discovery-api-public-preview). Диапазон IP-адресов обновляется еженедельно.

### <a name="include-the-azure-cognitive-search-portal-ip-addresses"></a>Включение IP-адресов портала Когнитивный поиск Azure

Если вы используете портал Azure для создания индексатора, логике портала Когнитивный поиск Azure также требуется доступ к виртуальной машине SQL Azure во время создания. IP-адреса портала Когнитивный поиск Azure можно найти с помощью команды ping `stamp2.search.ext.azure.com` , которая является доменом диспетчера трафика.

Кластеры в разных регионах подключаются к этому диспетчеру трафика. Проверка связи может вернуть IP-адрес и домен `stamp2.search.ext.azure.com` , но если служба находится в другом регионе, IP-адреса и имена доменов будут отличаться. IP-адрес, возвращенный при проверке связи, является верным для портал Azure в вашем регионе.

## <a name="next-steps"></a>Следующие шаги

После настройки вы можете указать SQL Server на виртуальной машине Azure в качестве источника данных для индексатора Azure Когнитивный поиск. Дополнительные сведения см. [в статье подключение базы данных SQL Azure к azure когнитивный Поиск с помощью индексаторов](search-howto-connecting-azure-sql-database-to-azure-search-using-indexers.md).