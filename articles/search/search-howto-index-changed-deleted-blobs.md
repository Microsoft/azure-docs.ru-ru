---
title: Измененные и удаленные BLOB-объекты
titleSuffix: Azure Cognitive Search
description: После создания исходного индекса поиска, который импортирует данные из хранилища BLOB-объектов Azure, последующее индексирование может занимать только те большие двоичные объекты, которые были изменены или удалены. В этой статье описываются подробные сведения.
manager: nitinme
author: MarkHeff
ms.author: maheff
ms.service: cognitive-search
ms.topic: conceptual
ms.date: 01/29/2021
ms.openlocfilehash: b23dabb4388331de9e37ee9db1d4b9d727ccde68
ms.sourcegitcommit: eb546f78c31dfa65937b3a1be134fb5f153447d6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/02/2021
ms.locfileid: "99430566"
---
# <a name="how-to-set-up-change-and-deletion-detection-for-blobs-in-azure-cognitive-search-indexing"></a>Как настроить обнаружение изменений и удалений для больших двоичных объектов в Azure Когнитивный поиск индексирование

После создания исходного индекса поиска может потребоваться, чтобы последующие задания индексатора получали только новые и измененные документы. Для поиска содержимого, полученного из хранилища BLOB-объектов Azure, обнаружение изменений происходит автоматически при использовании расписания для активации индексирования. По умолчанию служба переиндексирует только измененные большие двоичные объекты, как определено меткой времени большого двоичного объекта `LastModified` . В отличие от других источников данных, поддерживаемых индексаторами поиска, большие двоичные объекты всегда имеют метку времени, что устраняет необходимость ручной настройки политики обнаружения изменений.

Несмотря на то, что обнаружение изменений задано, обнаружение удаления не является. Если вы хотите обнаружить удаленные документы, обязательно используйте метод обратимого удаления. Если просто удалить большие двоичные объекты, соответствующие документы останутся в индексе поиска.

Существует два способа реализации подхода обратимого удаления:

+ Собственное обратимое удаление BLOB-объектов (Предварительная версия), описанное далее
+ [Обратимое удаление с помощью пользовательских метаданных](#soft-delete-using-custom-metadata)

## <a name="native-blob-soft-delete-preview"></a>Нативная функция обратимого удаления большого двоичного объекта (предварительная версия)

Для этого подхода к обнаружению удаления Когнитивный поиск зависит от функции [обратимого удаления больших двоичных объектов](../storage/blobs/soft-delete-blob-overview.md) в хранилище BLOB-объектов Azure, чтобы определить, перешли ли большие двоичные объекты в обратимо Удаленное состояние. При обнаружении больших двоичных объектов в этом состоянии индексатор поиска использует эти сведения для удаления соответствующего документа из индекса.

> [!IMPORTANT]
> Поддержка обратимого удаления больших двоичных объектов доступна в предварительной версии. Для предварительной версии функции соглашение об уровне обслуживания не предусмотрено. Мы не рекомендуем использовать ее в рабочей среде. Дополнительные сведения см. в статье [Дополнительные условия использования предварительных выпусков Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/). Эта функция доступна в [REST API версии 2020-06-30-Preview](./search-api-preview.md) . В настоящее время нет поддержки портала или пакета SDK для .NET.

### <a name="prerequisites"></a>Обязательные условия

+ [Включить обратимое удаление для больших двоичных объектов](../storage/blobs/soft-delete-blob-enable.md).
+ Большие двоичные объекты должны находиться в контейнере хранилища BLOB-объектов Azure. Политика обратимого удаления больших двоичных объектов Когнитивный поиск не поддерживается для больших двоичных объектов из Azure Data Lake Storage 2-го поколения.
+ Ключи документов для документов в индексе должны быть сопоставлены как свойства большого двоичного объекта или метаданные большого двоичного объекта.
+ Для настройки поддержки обратимого удаления необходимо использовать предварительную версию REST API ( `api-version=2020-06-30-Preview` ).

### <a name="how-to-configure-deletion-detection-using-native-soft-delete"></a>Настройка обнаружения удаления с помощью собственного обратимого удаления

1. В хранилище BLOB-объектов при включении обратимого удаления задайте для политики хранения значение, превышающее расписание интервала индексатора. Таким образом, если возникла проблема с индексатором или если имеется большое количество документов для индексирования, то в конечном итоге индексатор будет обрабатывать обратимо удаленные большие двоичные объекты. Индексаторы Когнитивный поиск Azure удаляют документ из индекса, только если он обрабатывает большой двоичный объект, когда он находится в обратимо удаленном состоянии.

1. В Когнитивный поиск установите политику обнаружения обратимого удаления больших двоичных объектов в источнике данных. Ниже приведен соответствующий пример. Так как эта функция находится на этапе предварительной версии, необходимо использовать предварительную версию REST API.

    ```http
    PUT https://[service name].search.windows.net/datasources/blob-datasource?api-version=2020-06-30-Preview
    Content-Type: application/json
    api-key: [admin key]
    {
        "name" : "blob-datasource",
        "type" : "azureblob",
        "credentials" : { "connectionString" : "<your storage connection string>" },
        "container" : { "name" : "my-container", "query" : null },
        "dataDeletionDetectionPolicy" : {
            "@odata.type" :"#Microsoft.Azure.Search.NativeBlobSoftDeleteDeletionDetectionPolicy"
        }
    }
    ```

1. [Запустите индексатор](/rest/api/searchservice/run-indexer) или задайте выполнение индексатора [по расписанию](search-howto-schedule-indexers.md). Когда индексатор запускается и обрабатывает большой двоичный объект с состоянием обратимого удаления, соответствующий документ поиска будет удален из индекса.

### <a name="reindexing-undeleted-blobs-using-native-soft-delete-policies"></a>Повторное индексирование неудаленных больших двоичных объектов (с использованием собственных политик обратимого удаления)

При восстановлении обратимо удаленного большого двоичного объекта в хранилище BLOB-объектов индексатор не всегда будет переиндексирован. Это обусловлено тем, что индексатор использует метку времени большого двоичного объекта, `LastModified` чтобы определить, требуется ли индексация. При отмене удаления обратимо удаляемого большого двоичного объекта его `LastModified` Метка времени не обновляется, поэтому, если индексатор уже обработал большие двоичные объекты с более последними `LastModified` отметками времени, он не будет повторно индексировать неудаленный большой двоичный объект. 

Чтобы гарантировать повторное индексирование неудаленного большого двоичного объекта, необходимо обновить метку времени большого двоичного объекта `LastModified` . Один из способов сделать это — повторное сохранение метаданных этого большого двоичного объекта. Вам не нужно изменять метаданные, но при повторном сохранении метаданных будет обновлена метка времени большого двоичного объекта, `LastModified` чтобы индексатор знал о том, что его следует выбрать.

## <a name="soft-delete-using-custom-metadata"></a>Обратимое удаление с помощью пользовательских метаданных

Этот метод использует метаданные большого двоичного объекта, чтобы определить, следует ли удалить документ поиска из индекса. Этот метод требует два отдельных действия: Удаление документа поиска из индекса, за которым следует удаление большого двоичного объекта в службе хранилища Azure.

Существуют действия, которые необходимо выполнить в хранилище BLOB-объектов и Когнитивный поиск, но нет других зависимостей компонентов. Эта возможность поддерживается в общедоступных интерфейсах API.

1. Добавьте пару "ключ — значение" пользовательских метаданных в большой двоичный объект, чтобы указать Когнитивный поиск Azure логически удалена.

1. Настройте политику обнаружения столбцов обратимого удаления в источнике данных. Например, в соответствии с приведенной ниже политикой большой двоичный объект считается удаленным, если у него есть свойство метаданных `IsDeleted` со значением `true`.

    ```http
    PUT https://[service name].search.windows.net/datasources/blob-datasource?api-version=2020-06-30
    Content-Type: application/json
    api-key: [admin key]

    {
        "name" : "blob-datasource",
        "type" : "azureblob",
        "credentials" : { "connectionString" : "<your storage connection string>" },
        "container" : { "name" : "my-container", "query" : null },
        "dataDeletionDetectionPolicy" : {
            "@odata.type" :"#Microsoft.Azure.Search.SoftDeleteColumnDeletionDetectionPolicy",
            "softDeleteColumnName" : "IsDeleted",
            "softDeleteMarkerValue" : "true"
        }
    }
    ```

1. После того как индексатор обработал большой двоичный объект и удалил документ из индекса, можно удалить большой двоичный объект в хранилище BLOB-объектов Azure.

### <a name="reindexing-undeleted-blobs-using-custom-metadata"></a>Повторное индексирование неудаленных больших двоичных объектов (с помощью пользовательских метаданных)

После того как индексатор обрабатывает удаленный большой двоичный объект и удаляет соответствующий документ поиска из индекса, он не будет повторно посещать этот большой двоичный объект, если он будет восстановлен позже, если отметка времени большого двоичного объекта `LastModified` старше, чем последний запуск индексатора.

Если вы хотите переиндексировать этот документ, измените `"softDeleteMarkerValue" : "false"` для этого большого двоичного объекта и повторно запустите индексатор.

## <a name="next-steps"></a>Дальнейшие действия

+ [Indexers in Azure Cognitive Search](search-indexer-overview.md) (Индексаторы в службе "Когнитивный поиск Azure")
+ [Настройка индексатора больших двоичных объектов](search-howto-indexing-azure-blob-storage.md)
+ [Общие сведения об индексировании BLOB-объектов](search-blob-storage-integration.md)