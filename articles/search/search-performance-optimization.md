---
title: Масштабирование для производительности
titleSuffix: Azure Cognitive Search
description: Методики и рекомендации по настройке производительности когнитивного поиска Azure и выбору оптимального масштаба.
manager: nitinme
author: LiamCavanagh
ms.author: liamca
ms.service: cognitive-search
ms.topic: conceptual
ms.date: 02/01/2021
ms.custom: references_regions
ms.openlocfilehash: 60371888dbc4f0cbc33f1ad1b2a685dbb071c01a
ms.sourcegitcommit: f28ebb95ae9aaaff3f87d8388a09b41e0b3445b5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/29/2021
ms.locfileid: "101670707"
---
# <a name="scale-for-performance-on-azure-cognitive-search"></a>Масштабирование для повышения производительности в службе "Когнитивный поиск Azure"

В этой статье описываются методики по расширенным сценариям с особенными требованиями к масштабируемости и доступности.

## <a name="start-with-baseline-numbers"></a>Начинаем с базовых показателей

Прежде чем выполнять мероприятия по крупному развертыванию, убедитесь, что вы знаете, какой будет нагрузка по запросам. Приведенные ниже рекомендации помогут вам получить базовые показатели, характеризующие объем запросов.

1. Выберите целевую задержку (или максимальное количество времени), которая типична для выполнения запроса на поиск.

1. Сформируйте и протестируйте реальную рабочую нагрузку на своей службе поиска, используя правдоподобный набор данных, чтобы измерить в этих условиях показатели задержки.

1. Начните с небольшого количества запросов в секунду (QPS) и увеличивайте это значение по мере выполнения теста, пока задержка при обработке запросов не превысит предварительно определенное пороговое значение. Это важный тест производительности, который поможет спланировать масштабирование приложения по мере того, как оно будет охватывать все больше пользователей.

1. По возможности повторно используйте подключения HTTP. Если используется пакет SDK .NET для когнитивного поиска Azure, то это означает, что следует повторно использовать один и тот же экземпляр или экземпляр [SearchClient](/dotnet/api/azure.search.documents.searchclient), а если используется REST API, то следует повторно использовать один HttpClient.

1. Изменяйте содержание запросов, чтобы поиск производился по разным частям индекса. Изменение запросов чрезвычайно важно, так как если постоянно выполнять одинаковые поисковые запросы, то из-за кэширования данных производительность может представляться более высокой, чем может быть в ситуации с более требовательным по нагрузке набором запросов.

1. Изменяйте структуру запросов, чтобы типы запросов были разными. Не все поисковые запросы выполняются на одном и том же уровне. Например, поиск документа или предоставление поисковой подсказки обычно происходит быстрее, чем выполнение запроса со значительным количеством аспектов и фильтров. Составляемые для тестирования запросы должны быть разнообразными, примерно в тех же соотношениях, что и в рабочей среде.  

При создании этих тестовых рабочих нагрузок следует учитывать некоторые характеристики Когнитивного поиска Azure:

+ Отправка слишком большого количества поисковых запросов за один раз может перегрузить эту службу. В этом случае вы увидите коды ответов HTTP 503. Для исключения ошибки 503 при тестировании рекомендуется начать с поисковых запросов из разных диапазонов, чтобы отслеживать изменения показателя задержки по мере добавления поисковых запросов.

+ Когнитивный поиск Azure не выполняет задания по индексированию в фоновом режиме. Если ваша служба одновременно обрабатывает рабочие нагрузки, формируемые запросами и индексированием, следует учесть это, и либо включить рабочие задания по индексации на этапе тестирования обработки запросов, либо рассмотреть варианты для выполнения заданий по индексации не в часы пиковой нагрузки.

> [!Tip]
> Смоделировать реалистичную нагрузку по обработке запросов можно с помощью тестовых инструментов, формирующих нагрузку. Попробуйте выполнить [тестирование по нагрузке с помощью Azure DevOps](/azure/devops/test/load-test/get-started-simple-cloud-load-test) или воспользуйтесь одним из этих [вариантов](/azure/devops/test/load-test/overview#alternatives).

## <a name="scale-for-high-query-volume"></a>Масштабирование для большого объема запросов

Служба испытывает перегрузку, когда обработка запросов занимает слишком много времени или когда служба начинает отбрасывать запросы. В такой ситуации решить проблему можно одним из двух способов:

+ **Добавление реплик**  

  Реплика — это копия ваших данных, позволяющая службе балансировать нагрузку по запросам, распределяя их между несколькими копиями.  Всеми операциями балансировки нагрузки и репликации данных управляет служба когнитивного поиска Azure, и в любое время можно изменить число реплик, выделенных для вашей службы. Можно выделить до 12 реплик для службы поиска уровня "Стандартный" и до 3 реплик для службы поиска уровня "Базовый". Реплики можно изменить на [портале Azure](search-create-service-portal.md) или в [PowerShell](search-manage-powershell.md).

+ **Создание новой службы на более высоком уровне**  

  Когнитивный поиск Azure предоставляется на [нескольких уровнях](https://azure.microsoft.com/pricing/details/search/), и каждый из них обеспечивает разные уровни производительности. В некоторых случаях запросов может быть настолько много, что используемый уровень окажется не в состоянии обеспечить достаточный объем ресурсов, даже если реплики будут полностью израсходованы. В этом случае необходимо рассмотреть возможность перехода на более высокий уровень, такой как стандартный уровень S3, предназначенный для сценариев с большим количеством документов и чрезвычайно высокой рабочей нагрузкой по запросам.

## <a name="scale-for-slow-individual-queries"></a>Масштабирование для отдельных медленно обрабатываемых запросов

Еще одна возможная причина высоких задержек — слишком долгая обработка какого-либо одного запроса. В этом случае добавление реплик не улучшит ситуацию. Ниже приводятся два варианта, которые могут оказаться эффективными.

+ **Увеличение секций**

  С помощью секций данные разделяются между дополнительными вычислительными ресурсами. Две секции разбивают данные пополам, третья секция разделяет их на три части и т. д. Один из положительных побочных эффектов проявляется в том, что медленные запросы иногда выполняются быстрее из-за параллельной обработки. Мы заметили эффективность распараллеливания в отношении запросов с низким уровнем избирательности, например для запросов, которые соответствуют многим документам или аспектам при подсчетах с большим количеством документов. Поскольку для оценки релевантности документов или подсчета количества документов требуются значительные объемы вычислений, добавление дополнительных секций позволяет ускорить выполнение запросов.  
   
  Для службы поиска уровня "Стандартный" можно использовать до 12 секций, а для службы поиска уровня "Базовый" — только 1 секцию. Секции можно изменить на [портале Azure](search-create-service-portal.md) или в [PowerShell](search-manage-powershell.md).

+ **Ограничение числа полей с высокой кратностью**

  К полям с высокой кратностью относятся поля, которые допускают применение аспектов и фильтров со значительным числом уникальных значений и которым поэтому требуются большие объемы ресурсов для расчета результатов. Например, если указать поля "Код продукта" или "Описание" как поддерживающие аспекты или фильтры, они станут полями с высокой кратностью, так как большинство значений в разных документах являются уникальными. По возможности ограничивайте число полей с высокой кратностью.

+ **Повышение уровня поиска**  

  Переход на более высокий уровень когнитивного поиска Azure может также ускорить обработку медленно выполняемых запросов. Более высокий уровень предусматривает предоставление более быстрых процессоров и большего объема памяти, что может положительно отразиться на производительности по обработке запросов.

## <a name="scale-for-availability"></a>Масштабирование для обеспечения доступности

Реплики не только уменьшают задержки при обработке запросов, но и могут обеспечить высокий уровень доступности. При использовании одной реплики следует ожидать периодических простоев из-за перезагрузки сервера после обновления программного обеспечения или других операций технического обслуживания. Поэтому важно определить, требуется ли приложению высокий уровень доступности операций поиска (запросов) и записи (событий индексирования). Когнитивный поиск Azure предоставляет различные варианты соглашений об уровне обслуживания для всех платных предложений по поиску со следующими атрибутами:

+ Две реплики для обеспечения высокой доступности рабочих нагрузок для чтения (запросов).

+ Три реплики или больше для обеспечения высокой доступности рабочих нагрузок чтения и записи (запросов и индексирования)

Дополнительные сведения по этой теме см. в статье [Соглашение об уровне обслуживания для когнитивного поиска Azure](https://azure.microsoft.com/support/legal/sla/search/v1_0/).

Так как реплики являются копиями данных, наличие нескольких реплик позволяет службе когнитивного поиска Azure выполнять перезагрузку и обслуживание машины с одной репликой, в то время как выполнение запроса продолжается на других репликах. И наоборот, если реплики удаляются, происходит снижение производительности по обработке запросов при условии, что эти реплики были недостаточно загруженными ресурсами.

<a name="availability-zones"></a>

### <a name="availability-zones"></a>зоны доступности;

С помощью [Зон доступности](../availability-zones/az-overview.md) выполняется разделение центров обработки данных региона на отдельные группы по физическому местонахождению для обеспечения высокой доступности в пределах одного региона. Для службы когнитивного поиска отдельные реплики являются единицами для назначения зон. Служба поиска работает в одном регионе; ее реплики работают в разных зонах.

Вы можете использовать Зоны доступности с когнитивным поиском Azure, добавив в службу поиска две реплики или более. Каждая реплика будет помещаться в другую зону доступности в пределах региона. Если реплик у вас больше, чем Зон доступности, реплики будут распределяться по Зонам доступности как можно более равномерно.

В настоящее время Когнитивный поиск Azure поддерживает Зоны доступности для служб поиска уровня "Стандартный" или выше, которые были созданы в одном из следующих регионов:

+ Восточная Австралия (дата создания 30 января 2021 г. или позже)
+ Центральная Канада (дата создания 30 января 2021 г. или позже)
+ Центральная часть США (дата создания 4 декабря 2020 г. или позже)
+ Восточная часть США (дата создания 27 января 2021 г. или позже)
+ Восточная часть США 2 (дата создания 30 января 2021 г. или позже)
+ Центральная Франция (дата создания 23 октября 2020 г. или позже)
+ Восточная часть Японии (дата создания 30 января 2021 г. или позже)
+ Северная Европа (дата создания 28 января 2021 г. или позже)
+ Юго-Восточная Азия (дата создания 31 января 2021 г. или позже)
+ Южная часть Соединенного Королевства (дата создания 30 января 2021 г. или позже)
+ Западная Европа (дата создания 29 января 2021 г. или позже)
+ Западная часть США 2 (дата создания 30 января 2021 г. или позже)

Зоны доступности не влияют на [Соглашение об уровне обслуживания для службы когнитивного поиска Azure](https://azure.microsoft.com/support/legal/sla/search/v1_0/). Для обеспечения высокой доступности при обработке запросов по-прежнему требуется 3 реплики или больше.

## <a name="scale-for-geo-distributed-workloads-and-geo-redundancy"></a>Масштабирование для географически распределенных рабочих нагрузок и обеспечения географически распределенной избыточности

Для географически распределенных рабочих нагрузок у пользователей, находящихся на значительном удалении от базового центра обработки данных, будут наблюдаться более высокие показатели задержки. Одним из способов устранения этой проблемы является предоставление нескольких служб поиска в регионах, наиболее близких к этим пользователям.

В настоящее время служба Когнитивного поиска Azure не предоставляет метод автоматической географически распределенной репликации индексов Когнитивного поиска Azure между регионами, однако имеются некоторые методы, с помощью которых легко реализовать этот процесс и управлять им. Они описаны в нескольких следующих разделах.

Целью географически распределенного набора служб поиска является предоставление двух или более индексов, доступных в двух или более регионах. С помощью этих индексов пользователь будет перенаправляться к службе Когнитивного поиска Azure с наименьшей задержкой, как показано в следующем примере:

   ![Перекрестные запросы к службам по региону][1]

### <a name="keep-data-synchronized-across-multiple-services"></a>Поддержка синхронизации данных в нескольких службах

Существует два варианта, позволяющих обеспечить синхронизацию распределенных служб поиска: использовать либо [индексатор службы Когнитивного поиска Azure](search-indexer-overview.md), либо API Push (называемый также [REST API Когнитивного поиска Azure](/rest/api/searchservice/)).  

### <a name="use-indexers-for-updating-content-on-multiple-services"></a>Использование индексаторов для обновления содержимого в нескольких службах

Если вы уже используете индексатор в одной службе, во второй службе можно настроить второй индексатор, чтобы использовать один и тот же объект в качестве источника данных и получать данные из одного и того же расположения. Каждая служба в каждом регионе имеет собственный индексатор и целевой индекс (индекс поиска не является общим, а это означает, что данные дублируются), но каждый индексатор ссылается на один и тот же источник данных.

Ниже приведено высокоуровневое визуальное представление того, как будет выглядеть архитектура в таком случае.

   ![Один источник данных с сочетаниями распределенного индексатора и службы][2]

### <a name="use-rest-apis-for-pushing-content-updates-on-multiple-services"></a>Использование API-интерфейсов REST для отправки обновлений содержимого в несколько служб

При использовании API REST службы Когнитивного поиска Azure для [обновления содержимого в индексе Когнитивного поиска Azure](/rest/api/searchservice/update-index) можно обеспечить синхронизацию различных служб поиска, отправляя изменения во все службы поиска всякий раз, когда это потребуется. Убедитесь, что в коде обрабатываются ситуации, когда обновление одной службы поиска завершается сбоем, но для других служб оно выполняется успешно.

## <a name="leverage-azure-traffic-manager"></a>Использование диспетчера трафика Azure

[Диспетчер трафика Azure](../traffic-manager/traffic-manager-overview.md) позволяет перенаправлять запросы на несколько географически распределенных веб-сайтов, которые поддерживаются несколькими службами поиска. Одним из преимуществ диспетчера трафика является то, что он может проверять доступность службы Когнитивного поиска Azure и направлять пользователей к альтернативным службам поиска в случае сбоя. Кроме того, если маршрутизация поисковых запросов осуществляется через веб-сайты Azure, то диспетчер трафика Azure позволяет балансировать нагрузку в случаях, когда веб-сайт работает, а Когнитивный поиск Azure — нет. Ниже приведен пример архитектуры, использующей диспетчер трафика.

   ![Перекрестные запросы к службам по региону с использованием диспетчера трафика][3]

## <a name="next-steps"></a>Дальнейшие действия

Чтобы больше узнать о ценовых категориях и ограничениях служб, ознакомьтесь с разделом [Ограничения служб](search-limits-quotas-capacity.md). Статья [Планирование ресурсов](search-capacity-planning.md) поможет больше узнать о различных сочетаниях секций и реплик.

С обсуждением вопросов производительности и демонстрацией методик, описанных в этой статье, можно ознакомиться в следующем видеоролике:

> [!VIDEO https://channel9.msdn.com/Events/Microsoft-Azure/AzureCon-2015/ACON319/player]
> 

<!--Image references-->
[1]: ./media/search-performance-optimization/geo-redundancy.png
[2]: ./media/search-performance-optimization/scale-indexers.png
[3]: ./media/search-performance-optimization/geo-search-traffic-mgr.png