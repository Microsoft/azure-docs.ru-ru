---
title: Подключение индексатора через закрытую конечную точку
titleSuffix: Azure Cognitive Search
description: Настройте подключения индексатора для доступа к содержимому других ресурсов Azure, защищенных с помощью частной конечной точки.
manager: nitinme
author: arv100kri
ms.author: arjagann
ms.service: cognitive-search
ms.topic: conceptual
ms.date: 10/14/2020
ms.openlocfilehash: 762db9d165358f3347fc9b7f3aaaf39f0c762308
ms.sourcegitcommit: 1a98b3f91663484920a747d75500f6d70a6cb2ba
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/29/2021
ms.locfileid: "99063202"
---
# <a name="make-indexer-connections-through-a-private-endpoint"></a>Создание подключений индексатора через частную конечную точку

Многие ресурсы Azure, такие как учетные записи хранения Azure, могут быть настроены на прием подключений из списка виртуальных сетей и отклонять внешние подключения, исходящие из общедоступной сети. Если вы используете индексатор для индексирования данных в Когнитивный поиск Azure, а источник данных находится в частной сети, можно создать исходящее [Подключение к частной конечной точке](../private-link/private-endpoint-overview.md) для достижения данных.

Этот метод соединения индексатора подчиняется следующим двум требованиям:

+ Ресурс Azure, предоставляющий содержимое или код, должен быть предварительно зарегистрирован в [службе частной связи Azure](https://azure.microsoft.com/services/private-link/).

+ Служба Когнитивный поиск Azure должна быть на уровне Basic или выше. Эта функция недоступна на уровне Free. Кроме того, если у индексатора есть набор навыков, уровень должен быть Standard 2 (S2) или выше. Дополнительные сведения см. в разделе [ограничения службы](search-limits-quotas-capacity.md#shared-private-link-resource-limits).

## <a name="shared-private-link-resources-management-apis"></a>Общие интерфейсы API управления ресурсами частной связи

Частные конечные точки защищенных ресурсов, созданные с помощью Azure Когнитивный поиск API, называются *общими ресурсами частной ссылки*. Это связано с тем, что вы используете общий доступ к ресурсу, например к учетной записи хранения, интегрированной со [службой частной связи Azure](https://azure.microsoft.com/services/private-link/).

С помощью REST API управления Azure Когнитивный поиск предоставляет операцию [CreateOrUpdate](/rest/api/searchmanagement/sharedprivatelinkresources/createorupdate) , которую можно использовать для настройки доступа из индексатора когнитивный Поиск Azure.

Подключения к частным конечным точкам можно создавать только с помощью предварительной версии API управления поиском (версия *2020-08-01-Preview* или более поздняя), которая предназначена для *просмотра* в следующей таблице. Ресурсы без *предварительного просмотра* можно создать либо с помощью предварительной версии API, либо через общедоступную версию (*2020-08-01* или более поздней).

В следующей таблице перечислены ресурсы Azure, для которых можно создать исходящие частные конечные точки из Когнитивный поиск Azure. Чтобы создать ресурс общей частной ссылки, введите значения **идентификаторов групп** точно так же, как они записываются в API. Эти значения чувствительны к регистру.

| Ресурс Azure | Идентификатор группы. |
| --- | --- |
| Хранилище Azure — BLOB-объект (или) ADLS Gen 2 | `blob`|
| Службы хранилища Azure — таблицы | `table`|
| API Azure Cosmos DB-SQL | `Sql`|
| База данных SQL Azure | `sqlServer`|
| База данных Azure для MySQL (Предварительная версия) | `mysqlServer`|
| Azure Key Vault | `vault` |
| Функции Azure (Предварительная версия) | `sites` |

Вы также можете запросить ресурсы Azure, для которых поддерживаются исходящие подключения к частным конечным точкам, с помощью [списка поддерживаемых интерфейсов API](/rest/api/searchmanagement/privatelinkresources/listsupported).

В оставшейся части этой статьи для демонстрации REST APIных вызовов используется сочетание [Azure CLI](https://docs.microsoft.com/cli/azure/) (или [ARMClient](https://github.com/projectkudu/ARMClient) , если вы предпочитаете), и [POST](https://www.postman.com/) (или любой другой HTTP-клиент [, например,](https://curl.se/) с помощью элемента «текст»).

> [!NOTE]
> Примеры в этой статье основаны на следующих допущениях:
> * Имя службы поиска — _contoso-Search_, который существует в группе ресурсов _contoso_ подписки с идентификатором _00000000-0000-0000-0000-000000000000_. 
> * Идентификатор ресурса этой службы поиска — _/Subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/Contoso/providers/Microsoft.Search/searchServices/Contoso-Search_.

В остальных примерах показано, как можно настроить службу _поиска Contoso_ , чтобы ее индексаторы могли получать доступ к данным из защищенной учетной записи хранения _/Subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/Contoso/providers/Microsoft.Storage/storageAccounts/Contoso-Storage_.

## <a name="secure-your-storage-account"></a>Защита учетной записи хранения

Настройте учетную запись хранения, [разрешающую доступ только из конкретных подсетей](../storage/common/storage-network-security.md#grant-access-from-a-virtual-network). В портал Azure, если выбран этот параметр и оставить набор пустым, это означает, что трафик из виртуальных сетей не разрешен.

   ![Снимок экрана: панель "брандмауэры и виртуальные сети", в которой отображается параметр для разрешения доступа к выбранным сетям. ](media\search-indexer-howto-secure-access\storage-firewall-noaccess.png)

> [!NOTE]
> Можно использовать [доверенный подход к службам Майкрософт](../storage/common/storage-network-security.md#trusted-microsoft-services) для обхода ограничений виртуальной сети или IP-адресов в учетной записи хранения. Можно также включить службу поиска для доступа к данным в учетной записи хранения. Сведения о том, как сделать это, см. в разделе [доступ индексатора к службе хранилища Azure с исключением доверенной службы](search-indexer-howto-access-trusted-service-exception.md). 
>
> Однако при использовании этого подхода обмен данными между Azure Когнитивный поиск и учетной записью хранения осуществляется через общедоступный IP-адрес учетной записи хранения через безопасную магистральную сеть Майкрософт.

### <a name="step-1-create-a-shared-private-link-resource-to-the-storage-account"></a>Шаг 1. Создание общего ресурса частной ссылки для учетной записи хранения

Чтобы запросить Azure Когнитивный поиск для создания исходящего подключения частной конечной точки к учетной записи хранения, выполните следующий вызов API, например с [Azure CLI](https://docs.microsoft.com/cli/azure/): 

`az rest --method put --uri https://management.azure.com/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/contoso/providers/Microsoft.Search/searchServices/contoso-search/sharedPrivateLinkResources/blob-pe?api-version=2020-08-01 --body @create-pe.json`

Или, если вы предпочитаете использовать [ARMClient](https://github.com/projectkudu/ARMClient):

`armclient PUT https://management.azure.com/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/contoso/providers/Microsoft.Search/searchServices/contoso-search/sharedPrivateLinkResources/blob-pe?api-version=2020-08-01 create-pe.json`

Содержимое *create-pe.jsв* файле, которое представляет текст запроса для API, имеет следующий вид:

```json
{
      "name": "blob-pe",
      "properties": {
        "privateLinkResourceId": "/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/contoso/providers/Microsoft.Storage/storageAccounts/contoso-storage",
        "groupId": "blob",
        "requestMessage": "please approve"
      }
}
```

`202 Accepted`В случае успешного выполнения возвращается ответ. Процесс создания исходящей частной конечной точки — это длительно выполняемая (асинхронная) операция. Включает развертывание следующих ресурсов:

* Частная конечная точка, выделенная с частным IP-адресом в `"Pending"` состоянии. Частный IP-адрес получается из адресного пространства, выделенного виртуальной сети среды выполнения для частного индексатора, относящегося к службе поиска. После утверждения частной конечной точки любое взаимодействие Когнитивный поиск Azure с учетной записью хранения происходит от частного IP-адреса и защищенного канала частной связи.

* Частная зона DNS для типа ресурса на основе `groupId` . Развернув этот ресурс, вы убедитесь, что все DNS-запросы к частному ресурсу используют IP-адрес, связанный с частной конечной точкой.

Обязательно укажите правильный `groupId` тип ресурса, для которого создается частная конечная точка. Любое несоответствие приведет к неудачному ответному сообщению.

Как и во всех асинхронных операциях Azure, `PUT` вызов возвращает `Azure-AsyncOperation` значение заголовка, которое выглядит следующим образом:

`"Azure-AsyncOperation": "https://management.azure.com/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/contoso/providers/Microsoft.Search/searchServices/contoso-search/sharedPrivateLinkResources/blob-pe/operationStatuses/08586060559526078782?api-version=2020-08-01"`

Вы можете периодически опрашивать этот URI, чтобы получить состояние операции. Прежде чем продолжать, рекомендуется подождать, пока состояние операции ресурса общей частной ссылки достигнет состояния терминала (то есть состояние операции — " *выполнено*").

`az rest --method get --uri https://management.azure.com/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/contoso/providers/Microsoft.Search/searchServices/contoso-search/sharedPrivateLinkResources/blob-pe/operationStatuses/08586060559526078782?api-version=2020-08-01`

Или с помощью ARMClient:

`armclient GET https://management.azure.com/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/contoso/providers/Microsoft.Search/searchServices/contoso-search/sharedPrivateLinkResources/blob-pe/operationStatuses/08586060559526078782?api-version=2020-08-01"`

```json
{
    "status": "running" | "succeeded" | "failed"
}
```

### <a name="step-2a-approve-the-private-endpoint-connection-for-the-storage-account"></a>Шаг 2A. Утверждение подключения к частной конечной точке для учетной записи хранения

> [!NOTE]
> В этом разделе вы используете портал Azure, чтобы проанализировать поток утверждения для частной конечной точки в хранилище. Кроме того, можно использовать [REST API](/rest/api/storagerp/privateendpointconnections) , доступные через поставщик ресурсов хранилища.
>
> Другие поставщики, такие как Azure Cosmos DB или Azure SQL Server, предлагают аналогичные API поставщика ресурсов хранилища для управления подключениями к частным конечным точкам.

1. На портал Azure выберите вкладку подключения к **частной конечной точке** вашей учетной записи хранения. После успешной асинхронной операции должен быть запрос на подключение к частной конечной точке с сообщением запроса из предыдущего вызова API.

   ![Снимок экрана портал Azure, отображающий область "подключения к частным конечным точкам".](media\search-indexer-howto-secure-access\storage-privateendpoint-approval.png)

1. Выберите закрытую конечную точку, созданную Когнитивный поиск Azure. В столбце **Частная конечная точка** укажите подключение к частной конечной точке по имени, указанному в предыдущем API, выберите **утвердить**, а затем введите соответствующее сообщение. Содержимое сообщения не имеет значения. 

   Убедитесь, что подключение к частной конечной точке отображается, как показано на следующем снимке экрана. Обновление состояния на портале может занять от 1 до 2 минут.

   ![Снимок экрана портал Azure, отображающий состояние "утверждено" на панели "подключения к частным конечным точкам".](media\search-indexer-howto-secure-access\storage-privateendpoint-after-approval.png)

После утверждения запроса на подключение к частной конечной точке трафик *может* проходить через закрытую конечную точку. После утверждения частной конечной точки Azure Когнитивный поиск создает необходимые сопоставления зон DNS в созданной для нее зоне DNS.

### <a name="step-2b-query-the-status-of-the-shared-private-link-resource"></a>Шаг 2b. запрос состояния общего ресурса частной ссылки

Чтобы убедиться, что общий ресурс частной ссылки был обновлен после утверждения, получите его состояние с помощью [API Get](/rest/api/searchmanagement/sharedprivatelinkresources/get).

`az rest --method get --uri https://management.azure.com/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/contoso/providers/Microsoft.Search/searchServices/contoso-search/sharedPrivateLinkResources/blob-pe?api-version=2020-08-01`

Или с помощью ARMClient:

`armclient GET https://management.azure.com/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/contoso/providers/Microsoft.Search/searchServices/contoso-search/sharedPrivateLinkResources/blob-pe?api-version=2020-08-01`

Если `properties.provisioningState` ресурс имеет значение `Succeeded` `properties.status` , а —, то это `Approved` означает, что общий ресурс частной связи работоспособен, а индексатор может быть настроен для обмена данными через частную конечную точку.

```json
{
      "name": "blob-pe",
      "properties": {
        "privateLinkResourceId": "/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/contoso/providers/Microsoft.Storage/storageAccounts/contoso-storage",
        "groupId": "blob",
        "requestMessage": "please approve",
        "status": "Approved",
        "resourceRegion": null,
        "provisioningState": "Succeeded"
      }
}

```

### <a name="step-3-configure-the-indexer-to-run-in-the-private-environment"></a>Шаг 3. Настройка индексатора для запуска в частной среде

> [!NOTE]
> Этот шаг можно выполнить до утверждения частного подключения конечной точки. Пока подключение к частной конечной точке не будет утверждено, любой индексатор, который пытается связаться с защищенным ресурсом (например, учетной записью хранения), будет находиться в состоянии временного сбоя. Новые индексаторы создаваться не будут. Как только подключение к частной конечной точке будет утверждено, индексаторы смогут получить доступ к частной учетной записи хранения.

1. [Создайте источник данных](/rest/api/searchservice/create-data-source) , указывающий на защищенную учетную запись хранения и соответствующий контейнер в учетной записи хранения. На следующем снимке экрана показан этот запрос в POST.

   ![Снимок экрана, показывающий создание источника данных в пользовательском интерфейсе POST.](media\search-indexer-howto-secure-access\create-ds.png )

1. Аналогичным образом [создайте индекс](/rest/api/searchservice/create-index) и при необходимости [Создайте набор навыков](/rest/api/searchservice/create-skillset) с помощью REST API.

1. [Создайте индексатор](/rest/api/searchservice/create-indexer) , указывающий на источник данных, индекс и набор навыков, созданный на предыдущем шаге. Кроме того, необходимо принудительно запустить индексатор в закрытой среде выполнения, задав `executionEnvironment` для свойства конфигурации индексатора значение `private` .

   ![Снимок экрана, показывающий создание индексатора в пользовательском интерфейсе POST.](media\search-indexer-howto-secure-access\create-idr.png)

   После успешного создания индексатора он должен начать индексирование содержимого из учетной записи хранения через подключение к частной конечной точке. Состояние индексатора можно отслеживать с помощью [API состояния индексатора](/rest/api/searchservice/get-indexer-status).

> [!NOTE]
> Если у вас уже есть индексаторы, их можно обновить через [API размещения](/rest/api/searchservice/create-indexer) , задав для свойства значение `executionEnvironment` `private` .

## <a name="troubleshooting"></a>Устранение неполадок

- Если создание индексатора завершается ошибкой с сообщением об ошибке, например "недопустимые учетные данные источника данных", это означает, что либо состояние подключения к частной конечной точке еще не *утверждено* , либо соединение не работает. Чтобы устранить проблему, выполните следующие действия. 
  * Получите состояние общего ресурса частной ссылки с помощью [API Get](/rest/api/searchmanagement/sharedprivatelinkresources/get). Если состояние *утверждено*, проверьте значение `properties.provisioningState` ресурса. Если это состояние имеет значение `Incomplete` , это означает, что не удалось настроить некоторые из базовых зависимостей для ресурса. `PUT`Повторный запрос на повторное создание общего ресурса частной ссылки должен устранить проблему. Может потребоваться повторное утверждение. Повторно проверьте состояние ресурса, чтобы убедиться, что проблема исправлена.

- Если вы создаете индексатор без задания его `executionEnvironment` свойства, создание может быть успешным, но в журнале выполнения будет показано, что работа индексатора завершается неудачно. Чтобы устранить проблему, выполните следующие действия.
   * [Обновите индексатор](/rest/api/searchservice/update-indexer) , чтобы указать среду выполнения.

- Если вы создали индексатор без задания `executionEnvironment` Свойства и он выполняется успешно, это означает, что когнитивный Поиск Azure решила, что среда выполнения является *частной* средой, относящейся к службе поиска. Это может измениться в зависимости от ресурсов, используемых индексатором, нагрузки на службу поиска и других факторов, и она может завершиться сбоем позже. Чтобы устранить проблему, выполните следующие действия.
  * Настоятельно рекомендуется присвоить `executionEnvironment` свойству значение, `private` чтобы убедиться в том, что в будущем оно не будет работать.

[Квоты и ограничения](search-limits-quotas-capacity.md) определяют, сколько общих ресурсов частной ссылки могут быть созданы и зависят от номера SKU службы поиска.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о частных конечных точках:

- [Что такое частные конечные точки?](../private-link/private-endpoint-overview.md)
- [Конфигурации DNS, необходимые для частных конечных точек](../private-link/private-endpoint-dns.md)
