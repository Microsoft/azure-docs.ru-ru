---
title: Оценка емкости для рабочих нагрузок запросов и индексов
titleSuffix: Azure Cognitive Search
description: Настройте ресурсы компьютера секционирования и реплики в Когнитивный поиск Azure, где цена за каждый ресурс оплачивается в оплачиваемых единицах поиска.
manager: nitinme
author: HeidiSteen
ms.author: heidist
ms.service: cognitive-search
ms.topic: conceptual
ms.date: 01/15/2021
ms.openlocfilehash: d848c1ed1ab9d4cb24dec9423d93ec62ab45633b
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "99537227"
---
# <a name="estimate-and-manage-capacity-of-an-azure-cognitive-search-service"></a>Оценка емкости службы Когнитивный поиск Azure и управление ею

Перед [подготовкой службы поиска](search-create-service-portal.md) и блокировки в определенной ценовой категории Потратьте несколько минут, чтобы понять, как работает емкость, а также как можно настроить реплики и секции, чтобы удовлетворить колебания рабочей нагрузки.

Емкость — это функция [уровня службы](search-sku-tier.md), которая устанавливает максимальный объем хранилища на службу, на секцию и максимальное количество объектов, которые можно создать. Уровень "базовый" предназначен для приложений с небольшими требованиями к хранению (только для одного раздела), но с возможностью запуска в конфигурации высокого уровня доступности (3 реплики). Другие уровни предназначены для конкретных рабочих нагрузок или шаблонов, например многоаренды. На внутреннем уровне службы, созданные на этих уровнях, получают преимущество от оборудования, помогающего в этих сценариях.

Архитектура масштабируемости в Azure Когнитивный поиск основана на гибких комбинациях реплик и секций, что позволяет изменять емкость в зависимости от того, требуется ли больше возможностей для запросов или индексирования. После создания службы можно одновременно увеличить или уменьшить количество реплик или секций. Стоимость будет взиматься с каждого дополнительного физического ресурса, но после завершения больших рабочих нагрузок можно уменьшить масштаб, чтобы снизить счет. В зависимости от уровня и размера корректировки, добавление или уменьшение емкости может занять от 15 минут до нескольких часов.

При изменении распределения реплик и секций рекомендуется использовать портал Azure. Портал применяет ограничения для допустимых сочетаний, которые остаются ниже максимальных пределов уровня. Однако если требуется подход к подготовке на основе сценариев или кода, [Azure PowerShell](search-manage-powershell.md) или [REST API управления](/rest/api/searchmanagement/services) являются альтернативными решениями.

## <a name="concepts-search-units-replicas-partitions-shards"></a>Основные понятия: единицы поиска, реплики, секции, сегменты

Емкость выражается в *единицах поиска* , которые можно выделить в комбинации *секций* и *реплик*, используя базовый механизм *сегментирования* для поддержки гибких конфигураций:

| Концепция  | Определение|
|----------|-----------|
|*Единица поиска* | Один инкремент общей доступной емкости (36 единиц). Это также единица выставления счетов для службы Когнитивный поиск Azure. Для запуска службы требуется минимум одна единица измерения.|
|*Реплика* | Экземпляры службы поиска, используемые главным образом для распределения операций запросов. Каждая реплика содержит одну копию индекса. При выделении трех реплик вы получите три копии индекса, доступные для обслуживания запросов запросов.|
|*Секция* | Физическое хранилище и операции ввода-вывода для операций чтения и записи (например, при перестроении или обновлении индекса). Каждая секция содержит срез общего индекса. При выделении трех секций индекс делится на сторонние. |
|*Сегмента* | Фрагмент индекса. Azure Когнитивный поиск делит каждый индекс на сегменты, чтобы ускорить процесс добавления секций (путем перемещения сегментов в новые единицы поиска).|

На следующей схеме показана связь между репликами, секциями, сегментами и единицами поиска. В нем показан пример того, как один индекс состоит из четырех единиц поиска в службе с двумя репликами и двумя секциями. Каждый из четырех единиц поиска хранит только половину сегментов индекса. Единицы поиска в левом столбце хранят первую половину сегментов, составляющих первую секцию, в то время как в правом столбце хранится вторая половина сегментов, состоящая из второй секции. Так как существует две реплики, существует две копии каждого сегмента индекса. В единицах поиска в верхней строке хранится одна копия, включающая в себя первую реплику, а в нижней строке — еще одна копия, состоящая из второй реплики.

:::image type="content" source="media/search-capacity-planning/shards.png" alt-text="Индексы поиска сегментированы между секциями.":::

На схеме выше показан только один пример. Поддерживается множество сочетаний секций и реплик, не более 36 всего единиц поиска.

В Когнитивный поиск управление сегментами является подробным описанием реализации и неизменяемым, но знание того, что индекс сегментирован, помогает понять случайные аномалии в поведении ранжирования и автозаполнения:

+ Аномалии по ранжированию. оценки поиска рассчитываются на уровне сегментов первыми, а затем объединяются в один результирующий набор. В зависимости от характеристик содержимого сегментов, совпадения из одного сегмента могут быть ранжированы выше, чем в другом. Если вы заметили интуитивно понятные ранжирования в результатах поиска, скорее всего, это обусловлено влиянием сегментирования, особенно если индексы небольшие. Вы можете избежать этих аномалий, выбрав [Вычисление оценок глобально по всему индексу](index-similarity-and-scoring.md#scoring-statistics-and-sticky-sessions), но это приведет к снижению производительности.

+ Аномалии автозаполнения: запросы автозаполнения, где совпадения выполняются на первых нескольких символах частично введенного термина, принимают нечеткий параметр, форгивес небольшие отклонения в написание. Для автозаполнения нечеткие совпадения ограничиваются терминами в пределах текущего сегмента. Например, если сегмент содержит "Microsoft" и указан частичный термин "МиКор", поисковая система будет сопоставлять "Майкрософт" в этом сегменте, но не в других сегментах, содержащих оставшиеся части индекса.

## <a name="how-to-evaluate-capacity-requirements"></a>Оценка требований к емкости

Емкость и стоимость работы службы. Уровни накладывают ограничения на два уровня: Хранение и содержимое (например, количество индексов службы). Важно учитывать оба способа, так как достигнуто максимально допустимое ограничение.

Количество индексов и других объектов обычно определяется требованиями бизнеса и проектирования. Например, у вас может быть несколько версий одного индекса для активной разработки, тестирования и рабочей среды.

Требования к хранилищу определяются размером индексов, которые предполагается построить. Нет ни одного надежного эвристика или общих методов, помогающих в оценке. Единственный способ определить размер индекса — [создать его](search-what-is-an-index.md). Его размер будет основан на импортированных данных, анализе текста и конфигурации индекса, например о включении предложений, фильтрации и сортировке.

Для полнотекстового поиска Первичная структура данных является [инвертированной](https://en.wikipedia.org/wiki/Inverted_index) структурой индекса, которая имеет различные характеристики, чем исходные данные. Для инвертированного индекса размер и сложность определяются по содержимому, а не к объему данных, которые вы передаете в него. Большой источник данных с высокой избыточностью может привести к тому, что индекс будет меньше, чем меньший набор данных, содержащий сильно изменяемое содержимое. Поэтому редко бывает возможно определить размер индекса на основе размера исходного набора данных.

> [!NOTE] 
> Несмотря на то, что оценка будущих потребностей для индексов и хранилища может показаться предоставляяй, она стоит делать. Если емкость уровня оказывается слишком низкой, необходимо создать новую службу на более высоком уровне, а затем [перезагрузить индексы](search-howto-reindex.md). Обновление службы на месте с одного уровня на другой не выполняется.
>

### <a name="estimate-with-the-free-tier"></a>Оценка на уровне Free

Один из способов оценки емкости — начать с бесплатного уровня. Помните, что бесплатная служба предлагает до трех индексов, 50 МБ хранилища и 2 минуты времени индексирования. Оценка предполагаемого размера индекса с этими ограничениями может быть непростой, но это шаги:

+ [Создайте бесплатную службу](search-create-service-portal.md).
+ Подготовьте небольшой репрезентативный набор данных.
+ Создание индекса и загрузка данных. Если набор данных может размещаться в источнике данных Azure, поддерживаемом индексаторами, можно использовать [Мастер импорта данных на портале](search-get-started-portal.md) для создания и загрузки индекса. В противном случае для создания индекса и отправки данных следует использовать процедуры RESTFUL и [POST](search-get-started-rest.md) или [Visual Studio Code](search-get-started-vs-code.md) . Модель принудительной отправки требует, чтобы данные были в виде документов JSON, где поля в документе соответствуют полям в индексе.
+ Собирайте сведения об индексе, например размер. Функции и атрибуты оказывают влияние на хранилище. Например, добавление предложений (Поиск по мере ввода) приведет к увеличению требований к хранилищу. 

  Используя тот же набор данных, вы можете попытаться создать несколько версий индекса с различными атрибутами для каждого поля, чтобы увидеть, как требования к хранилищу различны. Дополнительные сведения см. [в разделе "влияние на хранилище" раздела Создание базового индекса](search-what-is-an-index.md#index-size).

Выполнив приблизительную оценку, вы можете вдвое воздействовать на бюджет для двух индексов (разработки и рабочей среды), а затем выбрать свой уровень соответствующим образом.

### <a name="estimate-with-a-billable-tier"></a>Оценка с помощью оплачиваемого уровня

Выделенные ресурсы могут поддерживать большую выборку и время обработки для более реалистичных оценок объема индексов, размера и запросов во время разработки. Некоторые клиенты переходят вправо с помощью оплачиваемого уровня, а затем повторно вычисляют проект разработки.

1. [Просмотрите ограничения службы на каждом уровне](./search-limits-quotas-capacity.md#index-limits) , чтобы определить, могут ли более низкие уровни поддерживать необходимое количество индексов. Для уровней Basic, S1 и S2 ограничения индекса равны 15, 50 и 200 соответственно. Уровень, оптимизированный для хранилища, имеет ограничение в 10 индексов, поскольку оно предназначено для поддержки небольшого количества очень больших индексов.

1. [Создайте службу на платном уровне](search-create-service-portal.md):

    + Если вы не уверены в прогнозируемой нагрузке, начните с Low, Basic или S1.
    + Запуск высокого уровня (S2 или даже S3), если тестирование включает крупномасштабную индексирование и загрузку запросов.
    + Начните с оптимизированного хранилища на уровне L1 или L2, если вы индексируете большой объем данных, а загрузка запросов относительно низкая, как в случае внутреннего бизнес-приложения.

1. [Создайте начальный индекс](search-what-is-an-index.md), чтобы определить, как исходные данные преобразуются в индекс. Это единственный способ оценки размера индекса.

1. [Отслеживайте хранилище, ограничения служб, объем запросов и задержку](search-monitor-usage.md) в портале. На портале отображаются запросы в секунду, регулируемые запросы и задержки поиска. Все эти значения помогут решить, выбран ли подходящий уровень.

1. Добавляйте реплики, если требуется высокий уровень доступности или снижается производительность запросов.

   Не существует рекомендаций по количеству реплик, необходимых для загрузки запросов. Производительность запросов зависит от сложности запроса и конкурирующих рабочих нагрузок. Добавляя реплики, можно повысить производительность, но результат не обязательно будет линейным. Например, добавление трех реплик не гарантирует трехкратный рост пропускной способности. Рекомендации по оценке QPS для вашего решения см. в статье [масштабирование для производительности](search-performance-optimization.md)и [мониторинга запросов](search-monitor-queries.md).

> [!NOTE]
> Требования к хранилищу могут быть сведены при включении данных, которые никогда не будут искать. В идеале документы содержат только те данные, которые необходимы для поиска. Двоичные данные недоступны для поиска и должны храниться отдельно (возможно, в таблице Azure или хранилище BLOB-объектов). Поле должно быть добавлено в индекс для хранения URL-ссылки на внешние данные. Максимальный размер отдельного документа поиска составляет 16 МБ (или меньше, если несколько документов отправляются в один запрос). Дополнительные сведения см. [в статье ограничения службы в когнитивный Поиск Azure](search-limits-quotas-capacity.md).
>

**Рекомендации по объему запросов**

Количество запросов в секунду (QPS) является важной метрикой во время настройки производительности, но обычно это относится только к уровню, если предполагается, что вы планируете высокий объем запросов.

Уровни Standard могут обеспечивать баланс между репликами и секциями. Вы можете увеличить количество запросов, добавив реплики для балансировки нагрузки или добавив секции для параллельной обработки. Затем можно настроить производительность после подготовки службы.

Если вы предполагали, что самые высокие объемы запросов будут задерживаться с самого начала, следует рассмотреть более высокие уровни уровня Standard, которые поддерживаются более мощным оборудованием. После этого можно перевести секции и реплики в автономный режим или даже переключиться на службу более низкого уровня, если эти тома запросов не выполняются. Дополнительные сведения о том, как вычислить пропускную способность запросов, см. в статье [производительность и оптимизация когнитивный Поиск Azure](search-performance-optimization.md).

Уровни, оптимизированные для хранилища, полезны для рабочих нагрузок с большими данными и поддерживают более общее Доступное хранилище индексов, когда требования к задержке запросов менее важны. Вы по-прежнему должны использовать дополнительные реплики для балансировки нагрузки и дополнительные секции для параллельной обработки. Затем можно настроить производительность после подготовки службы.

**Соглашения об уровне обслуживания**

Бесплатные функции уровня и предварительной версии не обеспечивают [соглашения об уровне обслуживания (SLA)](https://azure.microsoft.com/support/legal/sla/search/v1_0/). Для всех оплачиваемых уровней соглашения об уровне обслуживания вступают в силу, если для службы обеспечена достаточная избыточность. Для запроса соглашения об уровне обслуживания (Read) необходимо иметь две или более реплики. Необходимо иметь три или более реплики для запросов SLA и индексирования (для чтения и записи). Количество секций не влияет на соглашения об уровне обслуживания.

## <a name="tips-for-capacity-planning"></a>Советы по планированию ресурсов

+ Разрешить метрикам создавать запросы и собирать данные по шаблонам использования (запросы в рабочее время, индексирование в часы наименьшей нагрузки). Используйте эти данные для информирования решений о подготовке службы. Хотя это непрактично для почасовой или ежедневной ритмичности, можно динамически корректировать секции и ресурсы, чтобы учесть запланированные изменения в томах запросов. Вы также можете обеспечить незапланированные, но устойчивые изменения, если уровни достаточно долго, чтобы гарантировать выполнение действий.

+ Помните, что единственным недостатком при подготовке является то, что вам может потребоваться разорвать службу, если фактические требования больше ваших прогнозов. Чтобы избежать прерывания работы служб, создайте новую службу на более высоком уровне и запустите ее параллельно, пока все приложения и запросы не будут нацелены на новую конечную точку.

## <a name="when-to-add-partitions-and-replicas"></a>Когда следует добавлять секции и реплики

Изначально служба выделяет минимальный уровень ресурсов, состоящий из одной секции и одной реплики.

Одна служба должна иметь достаточно ресурсов для обработки всех рабочих нагрузок (индексирования и запросов). Ни одна рабочая нагрузка не выполняется в фоновом режиме. Можно запланировать индексирование на время, когда запросы запросов естественным образом происходят реже, но служба не будет расставлять приоритеты для одной задачи поверх другой. Кроме того, определенный объем избыточности повышает производительность запросов при внутреннем обновлении служб или узлов.

Как правило, в приложениях поиска обычно требуется больше реплик, чем для секций, особенно когда операции службы перемещаются в рабочие нагрузки запросов. В разделе, посвященном [высокой доступности](#HA) , объясняется, почему так происходит.

Выбранный [уровень](search-sku-tier.md) определяет размер и скорость секции, и каждый уровень оптимизирован по набору характеристик, соответствующих различным сценариям. При выборе более высокого уровня может потребоваться меньше секций, чем при переходе на S1. Один из вопросов, на которые нужно ответить при самостоятельном тестировании, — это увеличение и повышение производительности секции, что повышает производительность, чем две более дешевые секции в службе, подготовленные на более низком уровне.

Приложениям поиска, которым требуется обновления данных в режиме, близком к реальному времени, понадобится пропорционально больше секций, чем реплик. При добавлении секций операции чтения-записи распределяются среди большего количества вычислительных ресурсов. Оно также обеспечивает больше дискового пространства для хранения дополнительных индексов и документов.

Запрос больших индексов выполняется дольше. Поэтому может оказаться, что каждое добавочное увеличение числа секций потребует меньшего, но пропорционального увеличения числа реплик. Сложность запросов и их объем обусловливают скорость выполнения запросов.

> [!NOTE]
> Добавление дополнительных реплик или секций увеличивает затраты на выполнение службы и может привести к незначительным вариациям в порядке упорядочивания результатов. Не забудьте проверить [Расчет цен](https://azure.microsoft.com/pricing/calculator/) , чтобы понять влияние добавления дополнительных узлов на выставление счетов. Приведенная [ниже диаграмма](#chart) поможет вам перекрестно ссылаться на количество единиц поиска, необходимых для конкретной конфигурации. Дополнительные сведения о том, как дополнительные реплики влияют на обработку запросов, см. в разделе [упорядочивание результатов](search-pagination-page-layout.md#ordering-results).

## <a name="how-to-allocate-replicas-and-partitions"></a>Как выделить реплики и секции

1. Войдите на [портал Azure](https://portal.azure.com/) и выберите службу поиска.

1. В разделе **Параметры** откройте страницу **масштаб** , чтобы изменить реплики и секции. 

   На следующем снимке экрана показан базовый стандарт, подготовленный с одной репликой и секцией. В формуле внизу показано, сколько единиц поиска используется (1). Если цена за единицу была $100 (не реальная цена), ежемесячная стоимость запуска этой службы будет $100 в среднем.

   :::image type="content" source="media/search-capacity-planning/1-initial-values.png" alt-text="Страница &quot;Масштаб&quot; с текущими значениями" border="true":::

1. Используйте ползунок, чтобы увеличить или уменьшить количество секций. В формуле внизу показано, сколько единиц поиска используется. Щелкните **Сохранить**.

   В этом примере добавляется вторая реплика и секция. Обратите внимание на число единиц поиска. Теперь это четыре, так как формула выставления счетов — это реплики, умноженные на секции (2 x 2). Удвоение емкости больше, чем удвоение стоимости запуска службы. Если цена за единицу поиска была $100, новый ежемесячный счет теперь будет $400.

   Текущие затраты на единицу каждого уровня см. на [странице цен](https://azure.microsoft.com/pricing/details/search/).

   :::image type="content" source="media/search-capacity-planning/2-add-2-each.png" alt-text="Добавление реплик и секций" border="true":::

1. После сохранения можно проверить уведомления, чтобы подтвердить, что действие было завершено.

   :::image type="content" source="media/search-capacity-planning/3-save-confirm.png" alt-text="Сохранить изменения" border="true":::

   Для завершения изменений в емкости может потребоваться до нескольких часов. Нельзя отменить после запуска процесса, и в режиме реального времени не будет выполняться мониторинг реплик и секций. Однако следующее сообщение остается видимым во время внесения изменений.

   :::image type="content" source="media/search-capacity-planning/4-updating.png" alt-text="Сообщение о состоянии на портале" border="true":::

> [!NOTE]
> После подготовки службы ее нельзя обновить до более высокого уровня. Вам нужно будет создать службу поиска на новом уровне и перезагрузить индексы. Дополнительные сведения о подготовке службы см. [в статье Создание службы когнитивный Поиск Azure на портале](search-create-service-portal.md) .
>
> Кроме того, разделы и реплики управляются исключительно и внутренне службой. Нет концепции сходства процессоров или назначения рабочей нагрузки конкретному узлу.
>

<a id="chart"></a>

## <a name="partition-and-replica-combinations"></a>сочетания разделов и реплик

На уровне "Базовый" служба может иметь только одну секцию и до трех реплик. Таким образом, максимальное количество единиц поиска составляет три. Единственным ресурсом, который можно изменять, являются реплики. Требуется не менее двух реплик, чтобы обеспечить высокий уровень доступности при обработке запросов.

Все стандартные и оптимизированные для хранилища службы поиска могут использовать следующие сочетания реплик и секций с ограничением в 36-SU, разрешенным для этих уровней. 

|   | **1 Секция** | **2 секции** | **3 секции** | **4 секции** | **6 секций** | **12 секций** |
| --- | --- | --- | --- | --- | --- | --- |
| **1 реплика** |1 ЕП |2 ЕП |3 ЕП |4 ЕП |6 ЕП |12 ЕП |
| **2 реплики** |2 ЕП |4 ЕП |6 ЕП |8 ЕП |12 ЕП |24 ЕП |
| **3 реплики** |3 ЕП |6 ЕП |9 ЕП |12 ЕП |18 ЕП |36 ЕП |
| **4 реплики** |4 ЕП |8 ЕП |12 ЕП |16 ЕП |24 ЕП |Н/Д |
| **5 реплик** |5 ЕП |10 ЕП |15 ЕП |20 ЕП |30 ЕП |Н/Д |
| **6 реплик** |6 ЕП |12 ЕП |18 ЕП |24 ЕП |36 ЕП |Н/Д |
| **12 реплик** |12 ЕП |24 ЕП |36 ЕП |Н/Д |Н/Д |Н/Д |

Подробные сведения о единицах поиска, ценах и объемах приведены на веб-сайте Azure. Дополнительные сведения см. в разделе [сведения о ценах](https://azure.microsoft.com/pricing/details/search/).

> [!NOTE]
> Количество реплик и секций должно быть делителем 12 (а именно 1, 2, 3, 4, 6, 12). Это связано с тем, что Azure Когнитивный поиск предварительно делит каждый индекс на 12 сегментов, чтобы его можно было распределять по всем секциям в равных частях. Например, если в вашей службе есть три секции и вы создаете индекс, то каждая секция будет содержать по четыре сегмента индекса. Как Azure Когнитивный поиск сегментирование индекса — это сведения о реализации, которые могут быть изменены в будущих выпусках. Несмотря на то, что сегодня это число 12, вам не следует полагаться на то, что в будущем оно не изменится.
>

<a id="HA"></a>

## <a name="high-availability"></a>Высокий уровень доступности

Поскольку задача масштабирования решается достаточно легко и быстро, на начальном этапе обычно рекомендуется использовать один раздел и одну или две реплики, увеличивая их количество по мере роста запросов. Рабочие нагрузки запросов в основном выполняются с репликами. Для повышения пропускной способности или обеспечения высокого уровня доступности вам, скорее всего, потребуется больше реплик.

Ниже приведены общие рекомендации для обеспечения высокой доступности.

+ Две реплики для обеспечения высокой доступности рабочих нагрузок для чтения (запросов).

+ Три или более реплик для обеспечения высокого уровня доступности рабочих нагрузок чтения и записи (запросов и индексирования по мере добавления, обновления или удаления отдельных документов).

Соглашения об уровне обслуживания (SLA) для Azure Когнитивный поиск предназначены для операций запросов и обновлений индекса, состоящих из добавления, обновления или удаления документов.

Категория "Базовый" ограничена одной секцией и тремя репликами. Если нужно оперативно реагировать на колебания требований к индексированию и пропускной способности запросов, рекомендуем использовать одну из категорий "Стандартный".  Если вы обнаружите, что требования к хранилищу увеличиваются гораздо быстрее, чем пропускная способность запроса, рассмотрите один из уровней, оптимизированных для хранилища.

## <a name="about-queries-per-second-qps"></a>О запросах в секунду (QPS)

Из-за большого количества факторов, которые переходят в производительность запросов, корпорация Майкрософт не публикует ожидаемые QPS числа. Оценки QPS должны разрабатываться независимо каждым клиентом с помощью конструкций уровня службы, конфигурации, индекса и запроса, которые являются допустимыми для вашего приложения. Основными определителями QPS являются размер и сложность индексов, размер и сложность запросов, а также объем трафика. Если такие факторы неизвестны, оценка не будет информативной.

Прогнозируемость показателей повышается, если оцениваются службы, работающие в выделенных ресурсах (категорий "Базовый" и "Стандартный"). Можно точнее оценить QPS, так как вы можете контролировать больше параметров. Рекомендации по оценке см. в статье [Производительность и оптимизация службы "Когнитивный поиск Azure"](search-performance-optimization.md).

Для уровней "Оптимизировано для хранилища" (L1 и L2) следует ожидать меньшую пропускную способность обработки запросов и более высокую задержку по сравнению с уровнями "Стандартный".

## <a name="next-steps"></a>Дальнейшие действия

> [!div class="nextstepaction"]
> [Оценка затрат и управление ими](search-sku-manage-costs.md)