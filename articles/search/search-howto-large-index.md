---
title: Индексирование большого набора данных с помощью встроенных индексаторов
titleSuffix: Azure Cognitive Search
description: Стратегии для обработки больших данных или индексирования с интенсивным использованием вычислений с помощью пакетного режима, перебора источников и приемов запланированных, параллельных и распределенных индексирований.
manager: liamca
author: dereklegenzoff
ms.author: delegenz
ms.service: cognitive-search
ms.topic: conceptual
ms.date: 09/25/2020
ms.openlocfilehash: b4f54aff78526ba52e56ed9f4cf1feddf40fa69b
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "94358398"
---
# <a name="how-to-index-large-data-sets-in-azure-cognitive-search"></a>Как индексировать большие наборы данных в Azure Когнитивный поиск

Когнитивный поиск Azure поддерживает [два основных подхода](search-what-is-data-import.md) к импорту данных в индекс поиска: *отправка данных* в индекс программными средствами и указание [индексатору Когнитивного поиска Azure](search-indexer-overview.md) на поддерживаемый источник данных для *извлечения* данных.

По мере изменения объема данных или обработки потребности в них может оказаться, что простые и используемые по умолчанию стратегии индексирования более непрактичны. Для Когнитивный поиск Azure существует несколько подходов к размещению больших наборов данных, от способа структурирования запроса на передачу данных до использования индексатора, зависящего от источника, для запланированных и распределенных рабочих нагрузок.

Те же методы применяются и к долго выполняющимся процессам. В частности, шаги, описанные в разделе [параллельное индексирование](#parallel-indexing) , полезны при индексировании с интенсивным использованием вычислений, например при анализе изображений или обработке на естественном языке в [конвейере обогащения искусственного интеллекта](cognitive-search-concept-intro.md).

В следующих разделах рассматриваются методы индексирования больших объемов данных с помощью API push-уведомлений и индексаторов.

## <a name="use-the-push-api"></a>Использование API push-уведомлений

При принудительной отправке данных в индекс с помощью метода [Add documents REST API](/rest/api/searchservice/addupdate-or-delete-documents) или [индексдокументс](/dotnet/api/azure.search.documents.searchclient.indexdocuments)существует несколько ключевых вопросов, влияющих на скорость индексирования. Эти факторы описаны в разделе ниже, а также в диапазоне от настройки емкости службы до оптимизации кода.

Дополнительные сведения и примеры кода, иллюстрирующие индексирование модели push-уведомлений, см. в разделе [учебник. Оптимизация скорости индексирования](tutorial-optimize-indexing-push-api.md).

### <a name="capacity-of-your-service"></a>Емкость службы

В качестве первого шага просмотрите характеристики и [ограничения](search-limits-quotas-capacity.md) уровня, на котором подготовлена служба. Одним из ключевых различий между ценовыми категориями является размер и скорость секций, что оказывает прямое влияние на скорость индексирования. При подготовке службы поиска на уровне, недостаточном для рабочей нагрузки, обновление до нового уровня может оказаться самым простым и эффективным решением для повышения пропускной способности индексирования.

После того, как уровень удовлетворен, на следующем этапе можно увеличить число секций. Выделение секций можно изменить вниз после первоначального выполнения индексирования, чтобы снизить общую стоимость запуска службы.

> [!NOTE]
> Добавление дополнительных реплик также может увеличить скорость индексирования, но не гарантируется. С другой стороны, дополнительные реплики увеличивают объем запросов, который может обрабатывать служба поиска. Реплики также являются ключевым компонентом для получения [соглашения об уровне обслуживания](https://azure.microsoft.com/support/legal/sla/search/v1_0/).
>
> Перед добавлением секций или реплик или обновления до более высокого уровня учитывайте стоимость денежной стоимости и время выделения. Добавление секций может значительно увеличить скорость индексирования, но их добавление или удаление может занять от 15 минут до нескольких часов. Дополнительные сведения см. в документации по [настройке емкости](search-capacity-planning.md).
>

### <a name="review-index-schema"></a>Проверка схемы индекса

Схема индекса играет важную роль в индексировании данных. Чем больше полей у вас *есть, тем* больше задаются свойства (например, возможность *поиска*, возможность их пометок или возможность *фильтрации*) для повышения времени индексирования. Как правило, следует создавать и указывать только те поля, которые действительно необходимы в индексе поиска.

> [!NOTE]
> Чтобы сократить размер документа, старайтесь не добавлять незапрашиваемые данные в индекс. Изображения и другие двоичные данные не поддерживают прямой поиск и не должны храниться в индексе. Чтобы добавить в результаты поиска недоступные для запроса данные, следует определить поле, недоступное для поиска, в котором хранится ссылка на URL-адрес ресурса.

### <a name="check-the-batch-size"></a>Проверка размера пакета

Простейшим механизмом индексирования большего набора данных является отправка нескольких документов или записей в одном запросе. Если размер всех полезных данных не превышает 16 МБ, запрос может обрабатывать до 1000 документов в рамках одной операции массовой отправки. Эти ограничения применяются независимо от того, используете ли вы [REST API "Добавление документов](/rest/api/searchservice/addupdate-or-delete-documents) " или [метод индексдокументс](/dotnet/api/azure.search.documents.searchclient.indexdocuments) в пакете SDK для .NET. Для любого из этих API необходимо упаковать 1000 документов в тексте каждого запроса.

Использование пакетов для индексирования документов значительно повысит производительность индексирования. Определение оптимального размера пакета для данных является ключевой задачей при оптимизации скорости индексирования. Существует два основных фактора, которые влияют на оптимальный размер пакета:

+ схема индекса;
+ размер данных.

Так как оптимальный размер пакета зависит от индекса и данных, лучшим подходом является тестирование разных размеров пакетов, чтобы определить, какие результаты в самых быстрых скоростях индексирования для вашего сценария. В этом [учебнике](tutorial-optimize-indexing-push-api.md) приведен пример кода для тестирования размеров пакетов с помощью пакета SDK для .NET. 

### <a name="number-of-threadsworkers"></a>Число потоков и рабочих ролей

Чтобы добиться максимально возможных скоростей индексирования в Когнитивном поиске Azure, скорее всего потребуется несколько параллельных потоков, чтобы одновременно отправлять запросы пакетной индексации в службу.  

Оптимальное число потоков определяется следующим образом:

+ Уровень службы поиска
+ Число секций
+ Размер пакетов
+ схема индекса;

Вы можете изменить этот пример так, чтобы проверить работу с разным количеством потоков и выбрать оптимальный вариант для вашего сценария. Но обычно любое количество параллельных потоков позволяет добиться значительного повышения эффективности. 

> [!NOTE]
> При увеличении уровня службы поиска или увеличении количества секций необходимо также увеличить количество параллельных потоков.

По мере повышения числа запросов, передаваемых в службу поиска, могут возвращаться [коды состояния HTTP](/rest/api/searchservice/http-status-codes) с ошибками, свидетельствующие о неудачном выполнении запроса. При индексировании часто используются следующие два кода состояния HTTP:

+ **503 Service Unavailable** (Служба недоступна). Эта ошибка означает, что система перегружена и запрос не может быть обработан сейчас.
+ **207 Multi-Status** (Множественное состояние). Эта ошибка означает, что некоторые документы обработаны успешно, но хотя бы один — со сбоем.

### <a name="retry-strategy"></a>Стратегия повторов

В случае сбоя следует повторить выполнение запроса, используя [стратегию повторов с экспоненциальной задержкой](/dotnet/architecture/microservices/implement-resilient-applications/implement-retries-exponential-backoff).

Пакет SDK .NET для Когнитивного поиска Azure реализует автоматический повтор попыток при получении ошибок 503 и других сбоев, но для повторной обработки ошибок 207 вам потребуется собственная логика повторов. Также для реализации стратегии повторных попыток можно использовать средства с открытым кодом, например [Polly](https://github.com/App-vNext/Polly).

### <a name="network-data-transfer-speeds"></a>Скорость передачи данных в сети

Скорость передачи данных в сети может быть ограничивающим фактором при индексировании данных. Индексирование данных в среде Azure — это простой способ ускорить индексирование.

## <a name="use-indexers-pull-api"></a>Использование индексаторов (API извлечения)

[Индексаторы](search-indexer-overview.md) используются для обхода поддерживаемых источников данных Azure для поиска содержимого. Несмотря на то что некоторые возможности индексаторов не предназначены специально для крупномасштабного индексирования, они особенно полезны для обработки крупных наборов данных.

+ Планировщики позволяют запускать индексирование через регулярные интервалы.
+ Запланированное индексирование можно возобновлять с последнего известного момента остановки. Если в течение 24 часов был выполнен лишь частичный обход источника данных, индексатор возобновит действие на второй день с места остановки.
+ При секционировании данных на небольшие отдельные источники данных можно применять параллельную обработку. Вы можете разбить исходные данные на более мелкие компоненты, например в несколько контейнеров в хранилище BLOB-объектов Azure, а затем создать соответствующие несколько [объектов источника данных](/rest/api/searchservice/create-data-source) в когнитивный Поиск Azure, которые можно индексировать параллельно.

> [!NOTE]
> Индексаторы относятся к источникам данных, поэтому использование индексатора допустимо только для выбранных источников данных в Azure: [база данных SQL](search-howto-connecting-azure-sql-database-to-azure-search-using-indexers.md), [хранилище BLOB-объектов](search-howto-indexing-azure-blob-storage.md), [хранилище таблиц](search-howto-indexing-azure-tables.md) [Cosmos DB](search-howto-index-cosmosdb.md).

### <a name="check-the-batchsize-argument-on-create-indexer"></a>Проверка аргумента batchSize при создании индексатора

Как и в случае с API push-уведомлений, индексаторы позволяют настраивать количество элементов в пакете. Для индексаторов на основе [REST API создания индексатора](/rest/api/searchservice/Create-Indexer) можно задать аргумент `batchSize`, позволяющий настроить этот параметр для более точного соответствия характеристикам данных. 

Размеры пакетов по умолчанию зависят от источника данных. База данных SQL Azure и Azure Cosmos DB имеют размер пакета по умолчанию 1000. В отличие от этого, индексация больших двоичных объектов Azure устанавливает размер пакета в 10 документов для распознавания большего среднего размера документа. 

### <a name="scheduled-indexing"></a>Запланированное индексирование

Планирование индексатора служит важным механизмом в обработке больших наборов данных и длительных процессов, таких как анализ изображений в конвейере когнитивного поиска. Индексатор выполняет обработку в пределах 24-часового периода. Если за это время ее завершить не удается, вы можете исправить ситуацию с помощью планирования индексаторов. 

Запланированные операции индексирования запускаются через определенные интервалы времени, и обычно работа очередного задания индексатора завершается до того, как наступит время запускать следующее. Но если обработка к этому моменту еще не завершена, индексатор останавливается (завершается отведенное ему время). При запуске следующего задания обработка начнется с места остановки, так как система отслеживает текущее состояние операций. 

На практике это означает, что для многодневных задач индексирования вам следует настроить для индексатора запуск через каждые 24 часа. Каждое следующее задание индексирования в начале 24-часового цикла начнет работу с последнего документа, который считается надежным. Такая схема работы позволяет индексатору перебирать очередь документа в течение нескольких дней, пока все они не будут обработаны. Дополнительные сведения о настройке расписания в целом см. в разделе [CREATE индексатор REST API](/rest/api/searchservice/Create-Indexer) или [в разделе Планирование индексаторов для когнитивный Поиск Azure](search-howto-schedule-indexers.md).

<a name="parallel-indexing"></a>

### <a name="parallel-indexing"></a>Параллельное индексирование

Стратегия параллельного индексирования основана на одновременном индексировании нескольких источников данных, где каждое определение источника данных задает подмножество данных. 

Для нетипичных заданий индексирования, требующих высокой вычислительной мощности, например для распознавания текста в отсканированных документах в конвейере когнитивного поиска, при анализе изображений или обработке естественного языка, правильным решением может оказаться стратегия параллельного индексирования. Если вы можете отказаться от запросов или сократить их количество, параллельное индексирование данных службы, которая не обрабатывает запросы одновременно, является оптимальным вариантом для быстрой переработки значительного объема содержимого, требующего длительной обработки. 

Параллельная обработка состоит из следующих этапов.

+ Разделите исходные данные на несколько контейнеров или несколько виртуальных папок в одном контейнере. 
+ Сопоставьте каждый мини-набор данных с собственным [источником данных](/rest/api/searchservice/create-data-source), связанным с собственным [индексатором](/rest/api/searchservice/create-indexer).
+ В службе когнитивного поиска настройте один и тот же [набор навыков](/rest/api/searchservice/create-skillset) для каждого из определений индексаторов.
+ В качестве целевого объекта записи назначьте им один и тот же индекс. 
+ Настройте для всех индексаторов запуск в одно и то же время.

> [!NOTE]
> В Когнитивный поиск Azure нельзя назначать отдельные реплики или секции для индексирования или обработки запросов. Система определяет, как используются ресурсы. Чтобы понять влияние на производительность запросов, можно попробовать параллельное индексирование в тестовой среде, прежде чем перебирать его в рабочую среду.  

### <a name="how-to-configure-parallel-indexing"></a>Настройка параллельного индексирования

Вычислительная мощность индексаторов слабо связана с одной подсистемой индексаторов, которую служба поиска использует для каждой единицы службы (SU). В Azure Когнитивный поиск Services, подготовленных на уровне Basic или Standard, имеется по крайней мере две реплики, возможны несколько одновременных индексаторов. 

1. На [портале Azure](https://portal.azure.com) откройте панель мониторинга для службы поиска, затем страницу **Обзор** и проверьте значение параметра **Ценовая категория**, чтобы убедиться в доступности параллельного индексирования. На уровнях "Базовый" и "Стандартный" поддерживается использование нескольких реплик.

2. Можно запускать столько индексаторов параллельно, сколько количество единиц поиска в службе. В разделе **Параметры**  >  **масштабирование** [увеличьте количество реплик](search-capacity-planning.md) или секций для параллельной обработки: одну дополнительную реплику или секцию для каждой рабочей нагрузки индексатора. Оставьте достаточное количество реплик для обработки фактического объема запросов. Не следует жертвовать рабочими нагрузками обработки запросов в пользу индексирования.

3. Распространение данных в несколько контейнеров на уровне, к которому могут обращаться индексаторы Когнитивный поиск Azure. Например, создайте несколько таблиц в базе данных SQL Azure, несколько контейнеров в хранилище BLOB-объектов Azure или несколько коллекций. Определите отдельный объект источника данных для каждой таблицы или контейнера.

4. Создайте несколько индексаторов и расписания для их параллельного выполнения.

   + В качестве примера давайте рассмотрим службу с шестью репликами. Настройте для нее шесть индексаторов, каждый из которых сопоставлен с источником данных, содержащим примерно шестую часть от общего объема набора данных. 

   + Настройте для каждого индексатора один и тот же индекс. Укажите один и тот же набор навыков для рабочих нагрузок когнитивного поиска.

   + В определении каждого индексатора запланируйте одинаковые графики выполнения. Например, `"schedule" : { "interval" : "PT8H", "startTime" : "2018-05-15T00:00:00Z" }` создает для всех индексаторов расписание, по которому они запускаются каждые 8 часов 15 мая 2018 г.

В запланированное время все индексаторы одновременно начнут загружать данные, применять к ним правила обогащения (если вы настроили для них конвейер когнитивного поиска) и сохранять результаты в индекс. Azure Когнитивный поиск не блокирует индекс для обновлений. Параллельные операции записи обрабатываются логикой повторных попыток, если при первой попытке не удалось записать данные.

> [!Note]
> Увеличивая количество реплик, попробуйте увеличить и количество разделы, если прогнозируется значительное увеличение размера индекса. Разделы хранят фрагменты индексированного содержимого. Чем больше разделов, тем меньше объем сохраненной в каждом из них информации.

## <a name="see-also"></a>См. также раздел

+ [Обзор индексатора](search-indexer-overview.md)
+ [Импорт данных в службу поиска Azure с помощью портала](search-import-data-portal.md)
+ [Индексатор Базы данных SQL Azure](search-howto-connecting-azure-sql-database-to-azure-search-using-indexers.md)
+ [Индексатор Azure Cosmos DB](search-howto-index-cosmosdb.md)
+ [Индексатор хранилища BLOB-объектов Azure](search-howto-indexing-azure-blob-storage.md)
+ [Индексатор хранилища таблиц Azure](search-howto-indexing-azure-tables.md)
+ [Безопасность в Azure Когнитивный поиск](search-security-overview.md)