---
title: Компоненты шлюза приложений
description: В этой статье содержатся сведения о различных компонентах шлюза приложений.
services: application-gateway
author: surajmb
ms.service: application-gateway
ms.topic: conceptual
ms.date: 08/21/2020
ms.author: surmb
ms.openlocfilehash: ebd06b0b78ee511dce535ff4220df03087fb6906
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "88723322"
---
# <a name="application-gateway-components"></a>Компоненты шлюза приложений

 Шлюз приложений выступает в качестве единой точки контакта для клиентов. Он распределяет входящий трафик приложений между несколькими внутренними пулами, включая виртуальные машины Azure, масштабируемые наборы виртуальных машин, службу приложений Azure, а также локальные и внешние серверы. Для распределения трафика шлюз приложений использует несколько компонентов, описанных в этой статье.

![Компоненты, используемые в шлюзе приложений](./media/application-gateway-components/application-gateway-components.png)

## <a name="frontend-ip-addresses"></a>IP-адреса внешнего интерфейса

Интерфейсный IP-адрес — это IP-адрес, связанный с шлюзом приложений. Для шлюза приложений можно настроить общедоступный IP-адрес, частный IP-адрес или и то, и другое. Шлюз приложений поддерживает один общедоступный или один частный IP-адрес. Виртуальная сеть и общедоступный IP-адрес должны находиться в том же расположении, что и шлюз приложений. После создания интерфейсный IP-адрес связывается с прослушивателем.

### <a name="static-versus-dynamic-public-ip-address"></a>Статические и динамические общедоступные IP-адреса

SKU шлюза приложений Azure версии 2 можно настроить для поддержки статических внутренних IP-адресов и статического общедоступного IP-адреса или только статического общедоступного IP-адреса. Его нельзя настроить для поддержки только статического внутреннего IP-адреса.

Номер SKU v1 можно настроить для поддержки статического или динамического внутреннего IP-адреса и динамического общедоступного IP-адреса. Динамический IP-адрес шлюза приложений не изменяется на работающем шлюзе. Он может измениться только при запуске или отключении шлюза. Он не меняется при сбоях системы, обновлениях, обновлениях узла Azure и т. д. 

DNS-имя, связанное с шлюзом приложений, не изменяется в течение жизненного цикла шлюза. В результате следует использовать псевдоним CNAME и указать его DNS-адрес шлюза приложений.

## <a name="listeners"></a>Прослушиватели

Прослушиватель — это логическая сущность, которая проверяет наличие входящих запросов на подключение. Прослушиватель принимает запрос, если протокол, порт, имя узла и IP-адрес, связанные с запросом, совпадают с теми же элементами, которые связаны с конфигурацией прослушивателя.

Перед использованием шлюза приложений необходимо добавить хотя бы один прослушиватель. К шлюзу приложений могут быть подключены несколько прослушивателей, которые можно использовать для одного протокола.

После того как прослушиватель обнаружит входящие запросы от клиентов, шлюз приложений направляет эти запросы членам во внутреннем пуле, настроенному в правиле.

Прослушиватели поддерживают следующие порты и протоколы.

### <a name="ports"></a>Порты

Порт — это место, в котором прослушиватель прослушивает запрос клиента. Можно настроить порты в диапазоне от 1 до 65502 для номера SKU v1 и от 1 до 65199 для номера SKU v2.

### <a name="protocols"></a>Протоколы

Шлюз приложений поддерживает четыре протокола: HTTP, HTTPS, HTTP/2 и WebSocket:
>[!NOTE]
>Поддержка протокола HTTP/2 доступна только для клиентов, подключающихся к прослушивателям шлюза приложений. Взаимодействие с пулами внутреннего сервера всегда осуществляется по протоколу HTTP/1.1. Поддержка HTTP/2 отключена по умолчанию. Его можно включить.

- Укажите между протоколами HTTP и HTTPS в конфигурации прослушивателя.
- Поддержка WebSockets [и протоколов HTTP/2](features.md#websocket-and-http2-traffic) предоставляется в собственном режиме, и по умолчанию включена [Поддержка сокетов](application-gateway-websocket.md) . Настраиваемый пользователем параметр для выборочного включения или отключения поддержки WebSocket отсутствует. Используйте WebSocket с прослушивателями HTTP и HTTPS.

Используйте прослушиватель HTTPS для завершения TLS. Прослушиватель HTTPS разгружает работу шифрования и расшифровки для шлюза приложений, поэтому веб-серверы не загружаются по расходам.

### <a name="custom-error-pages"></a>Пользовательские страницы ошибок

Шлюз приложений позволяет создавать пользовательские страницы ошибок вместо отображения страниц ошибок по умолчанию. На пользовательской странице ошибок вы можете использовать собственные символику и макет. Шлюз приложений отображает настраиваемую страницу ошибки, если запрос не может связаться с серверной частью.

Дополнительные сведения см. в статье [Настраиваемые страницы ошибок для шлюза приложений](custom-error.md).

### <a name="types-of-listeners"></a>Типы прослушивателей

Существует два типа прослушивателей:

- **Базовый**. Этот тип прослушивателя прослушивает один доменный сайт, где имеется одно сопоставление DNS с IP-адресом шлюза приложений. Эта конфигурация прослушивателя необходима при размещении одного сайта за шлюзом приложений.

- **Несколько сайтов**. Эта конфигурация прослушивателя необходима, если требуется настроить маршрутизацию на основе имени узла или имени домена для нескольких веб-приложений в одном шлюзе приложений. Так вы можете настроить более эффективную топологию для развернутых служб, добавляя более 100 веб-сайтов в один шлюз приложений. Каждый веб-сайт может быть направлен в свой собственный внутренний пул. Например, три домена (contoso.com, fabrikam.com и adatum.com) указывают на IP-адрес шлюза приложений. Создайте три [прослушивателя с несколькими сайтами](multiple-site-overview.md) и настройте каждый прослушиватель для соответствующего порта и параметра протокола. 

    Вы также можете определить имена узлов с подстановочными знаками в многосайтовом прослушивателе и до пяти имен узлов на каждый прослушиватель. Дополнительные сведения см. [в разделе имена узлов с подстановочными знаками в прослушивателе (Предварительная версия)](multiple-site-overview.md#wildcard-host-names-in-listener-preview).

    Дополнительные сведения о настройке прослушивателя с несколькими сайтами см. в статье [Размещение нескольких сайтов в шлюзе приложений с помощью портал Azure](create-multiple-sites-portal.md).

После создания прослушивателя необходимо связать с правилом маршрутизации запросов. Это правило определяет, как запрос, полученный на прослушивателе, должен маршрутизироваться в серверную часть. Правило маршрутизации запросов также содержит внутренний пул для маршрутизации и параметр HTTP, в котором упоминаются внутренний порт, протокол и т. д.

## <a name="request-routing-rules"></a>Правила маршрутизации запросов

Правило маршрутизации запросов — это ключевой компонент шлюза приложений, так как он определяет способ маршрутизации трафика в прослушивателе. Правило привязывает прослушиватель, пул внутренних серверов и параметры HTTP серверной части.

Когда прослушиватель принимает запрос, правило маршрутизации запросов перенаправляет запрос в серверную часть или перенаправляет его в другое место. Если запрос перенаправляется в серверную часть, правило маршрутизации запросов определяет, к какому внутреннему пулу серверов следует переадресовать. Правило маршрутизации запросов также определяет, следует ли перезаписывать заголовки в запросе. Один прослушиватель можно присоединить к одному правилу.

Существует два типа правил маршрутизации запросов:

- **Базовый**. Все запросы к связанному прослушивателю (например, blog.contoso.com/*) перенаправляются в связанный серверный пул с помощью соответствующего параметра HTTP.

- **На основе пути**. Это правило маршрутизации позволяет маршрутизировать запросы к связанному прослушивателю с конкретным внутренним пулом на основе URL-адреса в запросе. Если путь URL-адреса в запросе совпадает с шаблоном пути в правиле на основе пути, правило направляет запрос. Шаблон пути применяется только к URL-пути, а не к его параметрам запроса. Если URL-путь в запросе прослушивателя не соответствует ни одному из правил на основе пути, он направляет запрос в серверный пул по умолчанию и параметры HTTP.

Дополнительные сведения см. в разделе [Маршрутизация на основе URL-адресов](url-route-overview.md).

### <a name="redirection-support"></a>Поддержка перенаправления

Правило маршрутизации запросов также позволяет перенаправлять трафик на шлюз приложений. Это универсальный механизм перенаправления, позволяющий выполнять перенаправление в любой порт, который вы задаете с помощью правил.

Цель перенаправления можно выбрать в качестве другого прослушивателя (что может помочь включить автоматическое перенаправление HTTP в HTTPS) или на внешний сайт. Можно также указать, что перенаправление является временным или постоянным или добавить путь URI и строку запроса к перенаправленному URL-адресу.

Дополнительные сведения см. [в статье перенаправление трафика в шлюзе приложений](redirect-overview.md).

### <a name="rewrite-http-headers-and-url"></a>Перезапись заголовков HTTP и URL-адреса

С помощью правил перезаписи можно добавлять, удалять или обновлять заголовки запросов и ответов HTTP (S), а также URL-пути и параметры строки запроса, так как пакеты запросов и ответов перемещаются между клиентом и серверным пулом через шлюз приложений.

Для заголовков и параметров URL-адреса можно задать статические значения или другие заголовки и серверные переменные. Это позволяет использовать важные варианты использования, такие как извлечение IP-адресов клиентов, удаление конфиденциальных сведений о серверной части, добавление дополнительной защиты и т. д.

Дополнительные сведения см. [в статье перезапись HTTP-заголовков и URL-адреса в шлюзе приложений](rewrite-http-headers-url.md).

## <a name="http-settings"></a>Параметры HTTP

Шлюз приложений направляет трафик на внутренние серверы (указанные в правиле маршрутизации запросов, которые включают параметры HTTP), используя номер порта, протокол и другие параметры, описанные в этом компоненте.

Порт и протокол, используемые в параметрах HTTP, определяют, шифруется ли трафик между шлюзом приложений и внутренними серверами (обеспечивая сквозной TLS) или без шифрования.

Этот компонент также используется для:

- Определите, должен ли сеанс пользователя храниться на том же сервере с помощью [сходства сеансов на основе файлов cookie](features.md#session-affinity).

- Аккуратное удаление членов серверного пула с помощью функции [сток подключений](features.md#connection-draining).

- Свяжите пользовательскую пробу для отслеживания работоспособности серверной части, задайте интервал времени ожидания запроса, переопределите имя узла и путь в запросе, а также достаточно простого щелчка, чтобы указать параметры для серверной части службы приложений.

## <a name="backend-pools"></a>Серверные пулы

Внутренний пул направляет запрос на внутренние серверы, обслуживающие запрос. Серверные пулы могут содержать:

- Сетевые карты
- Масштабируемые наборы виртуальных машин
- Общедоступные IP-адреса
- Внутренние IP-адреса
- Полное доменное имя.
- Многоклиентские интерфейсы (например, служба приложений)

Элементы внутреннего пула шлюза приложений не привязаны к группе доступности. Шлюз приложений может взаимодействовать с экземплярами вне виртуальной сети, в которой он находится. В результате элементы серверных пулов могут быть распределены между кластерами, центрами обработки данных или за пределами Azure, если имеется IP-подключение.

При использовании внутренних IP-адресов в качестве членов серверного пула необходимо использовать [пиринг виртуальной сети](../virtual-network/virtual-network-peering-overview.md) или [шлюз VPN](../vpn-gateway/vpn-gateway-about-vpngateways.md). Пиринг виртуальных сетей поддерживается и полезен для балансировки нагрузки трафика в других виртуальных сетях.

Шлюз приложений также может взаимодействовать с локальными серверами, если они подключены с помощью Azure ExpressRoute или VPN-туннелей, если трафик разрешен.

Можно создать различные серверные пулы для запросов различных типов. Например, создайте один внутренний пул для общих запросов, а затем другой серверный пул для запросов к микрослужбам вашего приложения.

## <a name="health-probes"></a>Пробы работоспособности

По умолчанию шлюз приложений отслеживает работоспособность всех ресурсов во внутреннем пуле и автоматически удаляет неработоспособные. Затем он отслеживает неработоспособные экземпляры и добавляет их в работоспособный внутренний пул, когда они становятся доступными и отвечают на зонды работоспособности.

Помимо проверки работоспособности по умолчанию проверку также можно настроить в соответствии с требованиями приложения. Пользовательские зонды позволяют более детально контролировать мониторинг работоспособности. При использовании пользовательских зондов можно настроить пользовательское имя узла, путь URL-адреса, интервал пробы и количество откликов, которые не удалось принять, прежде чем пометить экземпляр серверного пула как неработоспособный, пользовательские коды состояния и соответствие текста ответа и т. д. Рекомендуется настроить пользовательские зонды для отслеживания работоспособности каждого внутреннего пула.

Дополнительные сведения см. [в статье мониторинг работоспособности шлюза приложений](../application-gateway/application-gateway-probe-overview.md).

## <a name="next-steps"></a>Дальнейшие действия

Создание шлюза приложений

* [На портале Azure:](quick-create-portal.md)
* [С помощью Azure PowerShell](quick-create-powershell.md)
* [С помощью Azure CLI](quick-create-cli.md)
