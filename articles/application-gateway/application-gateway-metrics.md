---
title: Метрики Azure Monitor для шлюза приложений
description: Узнайте, как использовать метрики для мониторинга производительности шлюза приложений.
services: application-gateway
author: surajmb
ms.service: application-gateway
ms.topic: article
ms.date: 06/06/2020
ms.author: surmb
ms.openlocfilehash: 9faa3a284aa7151880526c1ee70cfadc3dbf3089
ms.sourcegitcommit: e559daa1f7115d703bfa1b87da1cf267bf6ae9e8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/17/2021
ms.locfileid: "100576105"
---
# <a name="metrics-for-application-gateway"></a>Метрики для шлюза приложений

Шлюз приложений публикует точки данных, называемые метриками, для [Azure Monitor](../azure-monitor/overview.md) производительности шлюзов приложений и серверных экземпляров. Эти метрики представляют собой числовые значения в упорядоченном наборе данных временных рядов, которые описывают некоторые аспекты шлюза приложений в определенный момент времени. При наличии запросов, передаваемых через шлюз приложений, он измеряет и отправляет его метрики через 60-секундный интервал. Если нет запросов, передаваемых через шлюз приложений, или нет данных для метрики, метрика не сообщается. Дополнительные сведения см. в разделе [метрики Azure Monitor](../azure-monitor/essentials/data-platform-metrics.md).

## <a name="metrics-supported-by-application-gateway-v2-sku"></a>Метрики, поддерживаемые SKU шлюза приложений версии 2

### <a name="timing-metrics"></a>Метрики времени

Шлюз приложений предоставляет несколько встроенных метрик времени, связанных с запросом и ответом, которые измеряются в миллисекундах. 

![Схема метрик времени для шлюза приложений.](./media/application-gateway-metrics/application-gateway-metrics.png)

> [!NOTE]
>
> Если в шлюзе приложений имеется более одного прослушивателя, то всегда фильтруйте по измерению *прослушивателя* , сравнивая различные метрики задержки, чтобы получить осмысленное определение.

- **Время соединения серверной части**

  Время, затраченное на установление соединения с серверным приложением. 

  Сюда входит задержка сети, а также время, затраченное стеком TCP внутреннего сервера для установки новых соединений. При использовании протокола TLS сюда также входит время, затрачиваемое на подтверждение. 

- **Время ответа первого байта внутреннего сервера**

  Интервал времени между началом установления соединения с внутренним сервером и получения первого байта заголовка ответа. 

  Это приблизительное количество *времени соединения серверной* части, время, затраченное запросом на доступ к серверной части из шлюза приложений, время, затраченное серверным приложением для ответа (время, затраченное сервером на создание содержимого, потенциальное получение запросов к базе данных), и время, затрачиваемое первым байтом ответа на доступ к шлюзу приложений из серверной части.

- **Время последнего ответа серверной части**

  Интервал времени между началом установления соединения с внутренним сервером и получения последнего байта текста ответа. 

  Это значение примерно соответствует сумме значений *времени получения первого байта ответа от серверной части* и времени передачи данных (это значение может существенно варьировать в зависимости от размера запрошенных объектов и задержки сети сервера).

- **Общее время шлюза приложений**

  Среднее время, затрачиваемое на получение, обработку и отправку ответа на запрос. 

  Это интервал времени, в течение которого шлюз приложений получает первый байт HTTP-запроса к моменту, когда последний байт ответа был отправлен клиенту. Сюда входит время обработки, затраченное шлюзом приложений, *время последнего ответа сервера за последний байт*, время, затраченное шлюзом приложений на отправку всего ответа и *RTT клиента*.

- **Время кругового пути (RTT) клиента**

  Среднее время кругового пути между клиентами и шлюзом приложений.



Эти метрики можно использовать для определения того, является ли наблюдаемое снижение из-за сети клиента, производительности шлюза приложений, внутренней серверной сети и внутреннего сервера TCP-стека, производительности внутреннего приложения или большого размера файла.

Например, если имеется Пиковая тенденция *времени ответа в первую байту* , но тенденция *внутреннего времени соединения* является стабильной, то можно вывести, что шлюз приложений в серверную задержку и время, затраченное на установление соединения, стабильны, а пиковое время отклика серверного приложения. С другой стороны, если пиковое *время ответа в первый байт* связано с соответствующим пик во *время внутреннего соединения*, то можно вывести, что сеть между шлюзом приложений и внутренним сервером или стеком TCP внутреннего сервера перегружена. 

Если вы заметили пиковое *время последнего ответа в серверной части* , но *время ответа для первого байта серверной части* является стабильным, то это может быть вызвано тем, что из-за большого файла запрашивается большой размер.

Аналогичным образом, если *Общее время для шлюза приложений* имеет пиковое *время ответа последнего байта сервера* , это может быть признаком узких мест производительности в шлюзе приложений или узким местом в сети между клиентом и шлюзом приложений. Кроме того, если *RTT клиента* также имеет соответствующий пик, то это означает, что снижение производительности обусловлено сетью между клиентом и шлюзом приложений.

### <a name="application-gateway-metrics"></a>Метрики шлюза приложений

Для шлюза приложений доступны следующие метрики:

- **Получено байт**

   Число байтов, полученных шлюзом приложений от клиентов

- **Отправлено байт**

   Число байтов, отправленных шлюзом приложений клиентам

- **Клиентский протокол TLS**

   Число запросов TLS и не-TLS, инициированных клиентом, который установил подключение к шлюзу приложений. Чтобы просмотреть распределение протокола TLS, отфильтруйте его по протоколу измерения TLS.

- **Текущее число единиц емкости**

   Число единиц емкости, потребляемых для балансировки нагрузки трафика. Существует три определителями к единицам вычислений единицы измерения емкости, постоянным подключениям и пропускной способности. Каждая единица емкости включает не более 1 единицы вычислений, 2500 постоянных подключений или 2,22 Мбит/с пропускной способности.

- **Текущие единицы вычислений**

   Количество потребленных ресурсов процессора. Факторы, влияющие на этот показатель: число TLS-подключений в секунду, вычисление перезаписи URL-адресов и обработка правил WAF. 

- **Текущие подключения**

   Общее число активных одновременных подключений клиентов к шлюзу приложений
   
- **Расчетные оплачиваемые единицы емкости**

  При использовании SKU версии 2 модель ценообразования будет зависеть от потребления. Плата за единицы емкости начисляется на основе потребления в дополнение к фиксированным затратам. *Расчетные единицы пропускной способности* указывают количество единиц мощности, по которым оценивается счет. Это число рассчитывается как большее значение между *текущими единицами емкости* (единицами емкости для балансировки нагрузки трафика) и *фиксированными единицами пропускной способности* (минимальное число подготовленных единиц емкости).

- **Неудачные запросы**

  Количество запросов, обслуживаемых шлюзом приложений с кодами ошибок сервера 5xx. Сюда входят коды 5xx, созданные из шлюза приложений, а также коды 5xx, созданные из серверной части. Число запросов можно дополнительно отфильтровать, чтобы отобразить количество для каждого или конкретного внутреннего серверного пула — сочетание параметров HTTP.
   
- **Фиксированные оплачиваемые единицы емкости**

  Минимальное число единиц емкости, подготовленных в соответствии с параметром *Минимальная единица масштабирования*, (один экземпляр преобразуется в 10 единиц емкости) в конфигурации Шлюза приложений.
   
 - **Новых подключений в секунду**

   Среднее число новых TCP-подключений в секунду, установленных от клиентов к шлюзу приложений и от шлюза приложений к серверным элементам.


- **Состояние ответа.**

   Состояние ответа HTTP, возвращенное шлюзом приложений. Распределение кодов состояния ответа можно дополнительно сгруппировать, чтобы отобразить ответы по категориям 2xx, 3xx, 4xx и 5xx.

- **Пропускная способность**

   Количество байтов в секунду, обрабатываемых шлюзом приложений

- **Всего запросов**

   Число успешных запросов, обслуживаемых шлюзом приложений. Число запросов можно дополнительно отфильтровать, чтобы отобразить количество для каждого или конкретного внутреннего серверного пула — сочетание параметров HTTP.

### <a name="backend-metrics"></a>Серверные метрики

Для шлюза приложений доступны следующие метрики:

- **Состояние ответа серверной части**

  Число кодов состояния HTTP-ответа, возвращаемых на концах. Сюда не входят коды ответов, созданные шлюзом приложений. Распределение кодов состояния ответа можно дополнительно сгруппировать, чтобы отобразить ответы по категориям 2xx, 3xx, 4xx и 5xx.

- **Количество работоспособных узлов**

  Число конечных элементов, которые определены работоспособными для проверки работоспособности. Можно выполнить фильтрацию по каждому внутреннему пулу, чтобы отобразить Количество работоспособных узлов в определенном внутреннем пуле.

- **Число неработоспособных узлов**

  Число последовательностей, которые определяются неработоспособностью пробы работоспособности. Можно выполнить фильтрацию по каждому внутреннему пулу, чтобы отобразить количество неработоспособных узлов в определенном внутреннем пуле.
  
- **Количество запросов в минуту на исправный узел**

  Среднее число запросов, полученных каждым работоспособным участником в серверном пуле за минуту. Необходимо указать серверный пул с помощью измерения *неработоспособных неработоспособных* .  
  

## <a name="metrics-supported-by-application-gateway-v1-sku"></a>Метрики, поддерживаемые SKU шлюза приложений версии 1

### <a name="application-gateway-metrics"></a>Метрики шлюза приложений

Для шлюза приложений доступны следующие метрики:

- **Загрузка ЦП**

  Показывает использование ресурсов ЦП, выделенных для Шлюза приложений.  При нормальных условиях загрузка ЦП не должна регулярно превышать 90 %, так как это может привести к задержкам на веб-сайтах, размещенных за Шлюзом приложений, и дестабилизации работы клиента. Вы можете косвенно контролировать или повышать загрузку ЦП, изменив конфигурацию Шлюза приложений. Для этого увеличьте число экземпляров и (или) перейдите на больший размер SKU.

- **Текущие соединения**

  Число текущих установленных подключений к шлюзу приложений

- **Неудачные запросы**

  Количество запросов, завершившихся сбоем из-за проблем с подключением. Это число включает запросы, которые не удалось выполнить из-за превышения параметра HTTP "время ожидания запроса" и запросов, которые не удалось выполнить из-за проблем с подключением между шлюзом приложений и серверной частью. Это число не включает сбои из-за отсутствия работоспособной серверной части. ответы 4xx и 5xx из серверной части также не считаются частью этой метрики.

- **Состояние ответа.**

  Состояние ответа HTTP, возвращенное шлюзом приложений. Распределение кодов состояния ответа можно дополнительно сгруппировать, чтобы отобразить ответы по категориям 2xx, 3xx, 4xx и 5xx.

- **Пропускная способность**

  Количество байтов в секунду, обрабатываемых шлюзом приложений

- **Всего запросов**

  Число успешных запросов, обслуживаемых шлюзом приложений. Число запросов можно дополнительно отфильтровать, чтобы отобразить количество для каждого или конкретного внутреннего серверного пула — сочетание параметров HTTP.

- **Число заблокированных запросов к брандмауэру веб-приложения**
- **Распределение заблокированных запросов брандмауэра веб-приложения**
- **Общее распространение правил брандмауэра веб-приложения**

### <a name="backend-metrics"></a>Серверные метрики

Для шлюза приложений доступны следующие метрики:

- **Количество работоспособных узлов**

  Число конечных элементов, которые определены работоспособными для проверки работоспособности. Можно выполнить фильтрацию по каждому внутреннему пулу, чтобы отобразить Количество работоспособных узлов в определенном внутреннем пуле.

- **Число неработоспособных узлов**

  Число последовательностей, которые определяются неработоспособностью пробы работоспособности. Можно выполнить фильтрацию по каждому внутреннему пулу, чтобы отобразить количество неработоспособных узлов в определенном внутреннем пуле.

## <a name="metrics-visualization"></a>Визуализация метрик

Перейдите к шлюзу приложений, в разделе **мониторинг** выберите **метрики**. Чтобы просмотреть доступные значения, выберите раскрывающийся список **Метрика**.

На следующем изображении приведен пример с тремя метриками, отображаемыми в течение последних 30 минут:

:::image type="content" source="media/application-gateway-diagnostics/figure5.png" alt-text="Представление метрик." lightbox="media/application-gateway-diagnostics/figure5-lb.png":::

Текущий список метрик доступен на странице [Метрики, поддерживаемые Azure Monitor](../azure-monitor/essentials/metrics-supported.md).

### <a name="alert-rules-on-metrics"></a>Правила генерации оповещений для метрик

Вы можете запустить правила генерации оповещений на основе метрик для ресурса. Например, оповещение может вызвать веб-перехватчик или отправить электронное сообщение администратору, если пропускная способность шлюза приложений будет больше или меньше порогового значения в указанный период времени либо равной этому значению.

Приведенный ниже пример поможет вам создать правило генерации оповещений, согласно которому администратору отправляется электронное сообщение в случае нарушения порога пропускной способности.

1. Щелкните **Добавить оповещение метрики** , чтобы открыть страницу **Добавление правила** . Эту страницу можно также получить на странице метрики.

   ![Кнопка "Добавить оповещение метрики"][6]

2. На странице **Добавление правила** заполните разделы имя, условие и уведомление и нажмите кнопку **ОК**.

   * С помощью селектора **Условие** выберите одно из четырех значений: **Больше**, **Больше или равно**, **Меньше** или **Меньше или равно**.

   * С помощью селектора **Период** выберите интервал от 5 минут до 6 часов.

   * Если установить флажок **Участники, читатели и владельцы электронной почты**, можно будет отправлять электронные сообщения в динамическом режиме пользователям, у которых есть доступ к этому ресурсу. В противном случае можно указать список пользователей с разделителями-запятыми в текстовом поле **Дополнительные адреса электронной почты администратора**.

   ![Страница "Добавление правила"][7]

При нарушении порога вы получите примерно такое электронное сообщение:

![Сообщение электронной почты о нарушении порога][8]

После создания оповещения метрики появится список оповещений. В нем содержатся все правила генерации оповещений.

![Список оповещений и правил][9]

Дополнительные сведения об уведомлениях для оповещений см. в статье [Что такое оповещения в Microsoft Azure?](../azure-monitor/alerts/alerts-overview.md)

Чтобы лучше понять, как действуют веб-перехватчики и как их использовать с оповещениями, см. статью [Настройка веб-перехватчиков для оповещений на основе метрик Azure](../azure-monitor/alerts/alerts-webhooks.md).

## <a name="next-steps"></a>Дальнейшие шаги

* См. сведения о визуализации журналов счетчиков и событий с помощью [журналов Azure Monitor](../azure-monitor/insights/azure-networking-analytics.md).
* [Визуализируйте журнал действий Azure с помощью Power BI](https://powerbi.microsoft.com/blog/monitor-azure-audit-logs-with-power-bi/) записи блога.
* Прочтите запись блога [View and analyze Azure Audit Logs in Power BI and more](https://azure.microsoft.com/blog/analyze-azure-audit-logs-in-powerbi-more/) (Просмотр и анализ журналов аудита Azure с помощью Power BI и других средств).

[1]: ./media/application-gateway-diagnostics/figure1.png
[2]: ./media/application-gateway-diagnostics/figure2.png
[3]: ./media/application-gateway-diagnostics/figure3.png
[4]: ./media/application-gateway-diagnostics/figure4.png
[5]: ./media/application-gateway-diagnostics/figure5.png
[6]: ./media/application-gateway-diagnostics/figure6.png
[7]: ./media/application-gateway-diagnostics/figure7.png
[8]: ./media/application-gateway-diagnostics/figure8.png
[9]: ./media/application-gateway-diagnostics/figure9.png
[10]: ./media/application-gateway-diagnostics/figure10.png