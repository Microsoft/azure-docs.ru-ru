---
title: Руководство по размещению нескольких веб-сайтов с помощью портала Azure
titleSuffix: Azure Application Gateway
description: Узнайте, как создать шлюз приложений, на котором размещается несколько веб-сайтов, с помощью портала Azure.
services: application-gateway
author: vhorne
ms.service: application-gateway
ms.topic: tutorial
ms.date: 03/19/2021
ms.author: victorh
ms.openlocfilehash: cfbd5301bc2b24c4d5614e5f88c6ae18d4affc66
ms.sourcegitcommit: e6de1702d3958a3bea275645eb46e4f2e0f011af
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "104721636"
---
# <a name="tutorial-create-and-configure-an-application-gateway-to-host-multiple-web-sites-using-the-azure-portal"></a>Руководство по Создание и настройка шлюза приложения для размещения нескольких веб-сайтов с помощью портала Azure

Чтобы настроить [размещение нескольких веб-сайтов](multiple-site-overview.md) при создании [шлюза приложений](overview.md), можно использовать портал Azure. В этом руководстве описано, как определить внутренние пулы адресов с помощью виртуальных машин. Затем вы настроите прослушиватели и правила на основе двух доменов, чтобы обеспечить передачу веб-трафика на соответствующие серверы в пулах. Для примера в этом учебнике используются домены *www.contoso.com* и *www.fabrikam.com*.

В этом руководстве описано следующее:

> [!div class="checklist"]
> * Создание шлюза приложений
> * создание виртуальных машин для внутренних серверов;
> * создание серверных пулов с внутренними серверами;
> * Создание серверных прослушивателей
> * Создание правил маршрутизации
> * Изменение файла hosts для разрешения имен

:::image type="content" source="./media/create-multiple-sites-portal/scenario.png" alt-text="Многосайтовый шлюз приложений":::

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

## <a name="prerequisites"></a>Предварительные требования

Войдите на портал Azure по адресу [https://portal.azure.com](https://portal.azure.com).

## <a name="create-an-application-gateway"></a>Создание шлюза приложений

1. Выберите **Создать ресурс** в верхнем левом меню портала Azure. Появится окно **Создать**.

2. Выберите **Сети**, а затем в списке **Рекомендованные** выберите **Шлюз приложений**.

### <a name="basics-tab"></a>Вкладка "Основные сведения"

1. На вкладке **Основные сведения** введите значения для следующих параметров шлюза приложений.

   - **Группа ресурсов.** Выберите **myResourceGroupAG** для группы ресурсов. Выберите **Создать** для создания группы ресурсов, если она еще не существует.
   - **Имя шлюза приложений**. Введите *myAppGateway* для имени шлюза приложений.

     :::image type="content" source="./media/application-gateway-create-gateway-portal/application-gateway-create-basics.png" alt-text="Создание шлюза приложений":::

2.  В Azure для обмена между создаваемыми ресурсами необходима виртуальная сеть. Вы можете создать новую виртуальную сеть или использовать существующую. В этом примере вы можете создать виртуальную сеть одновременно со шлюзом приложений. Экземпляры Шлюза приложений создаются в отдельных подсетях. В этом примере создаются две подсети: одна — для шлюза приложений, а вторая — для внутренних серверов.

    В разделе **Настройка виртуальной сети** создайте новую виртуальную сеть, выбрав команду **Создать**. В открывшемся окне **Создание виртуальной сети** введите следующие значения, которые будут использоваться для создания виртуальной сети и двух подсетей.

    - **Name** (Имя). Введите *myVNet* для имени виртуальной сети.

    - **Имя подсети** (Подсеть шлюза приложений). В сетке **Подсети** будет показана подсеть с именем *По умолчанию*. Измените имя этой подсети на *myAGSubnet*.<br>Подсеть шлюза приложений может содержать только шлюзы приложений. Другие ресурсы запрещены.

    - **Имя подсети** (подсеть внутреннего сервера). Во второй строке таблицы **Подсети** введите *myBackendSubnet* в столбце **Имя подсети**.

    - **Диапазон адресов** (подсеть внутреннего сервера). Во второй строке таблицы **Подсети** введите диапазон адресов, которые не пересекаются с диапазоном адресов *myAGSubnet*. Например, если диапазон адресов *myAGSubnet* равен 10.0.0.0/24, введите *10.0.1.0/24* для диапазона адресов *myBackendSubnet*.

    Выберите **ОК**, чтобы закрыть окно **Создание виртуальной сети** и сохранить настройки виртуальной сети.

     :::image type="content" source="./media/application-gateway-create-gateway-portal/application-gateway-create-vnet.png" alt-text="Создание виртуальной сети":::
    
3. На вкладке **Основные сведения** примите значения по умолчанию для других параметров и выберите **Далее: интерфейсные серверы**.

### <a name="frontends-tab"></a>Вкладка "Интерфейсные серверы"

1. На вкладке **Интерфейсные серверы** убедитесь, что для параметра **Тип IP-адреса интерфейсных серверов** установлено значение **Общедоступный**. <br>Вы можете настроить общедоступный интерфейсный или частный IP-адрес, согласно вашему варианту использования. В этом примере мы будем использовать общедоступный интерфейсный IP-адрес.
   > [!NOTE]
   > Для этого номера SKU Шлюза приложений версии 2 можно выбрать только **общедоступную** интерфейсную IP-конфигурацию. Частная интерфейсная IP-конфигурация сейчас не поддерживается для номера SKU версии 2.

2. Выберите команду **Добавить новый** для параметра **Общедоступный IP-адрес** и введите *myAGPublicIPAddress* в качестве имени общедоступного IP-адреса. Затем нажмите кнопку **ОК**. 

     :::image type="content" source="./media/application-gateway-create-gateway-portal/application-gateway-create-frontends.png" alt-text="Создание другой виртуальной сети":::

3. По завершении выберите **Next: серверные компоненты**.

### <a name="backends-tab"></a>Вкладка "Серверные компоненты"

Серверный пул используется для перенаправления запросов на внутренние серверы, на которых обслуживается запрос. Серверные пулы могут содержать сетевые адаптеры, масштабируемые наборы виртуальных машин, общедоступные IP-адреса, внутренние IP-адреса, полные доменные имена и такие мультитенантные серверные части, как Служба приложений Azure. В этом примере вы создадите пустой серверный пул со своим шлюзом приложений, а затем добавите в этот серверный пул целевые объекты.

1. На вкладке **Серверные компоненты** выберите элемент **Добавление серверного пула**.

2. В открывшемся окне **Добавить внутренний пул** введите следующие значения для создания пустого внутреннего пула.

    - **Name** (Имя). Введите *contosoPool* в качестве имени внутреннего пула.
    - **Добавление внутреннего пула без целей**. Чтобы создать серверный пул без целевых объектов, выберите **Да**. После создания шлюза приложения вы добавите серверные целевые объекты.

3. В окне **Добавление внутреннего пула** выберите **Добавить**, чтобы сохранить конфигурацию внутреннего пула и вернуться на вкладку **Серверные компоненты**.
4. Теперь добавьте еще один внутренний пул с именем *fabrikamPool* так же, как и предыдущий.
1. Нажмите **Добавить**.

    :::image type="content" source="./media/create-multiple-sites-portal/backend-pools.png" alt-text="Создание серверных компонентов":::

4. На вкладке **Серверные компоненты** выберите **Далее: конфигурация**.

### <a name="configuration-tab"></a>Вкладка "Конфигурация"

На вкладке **Конфигурация** вы будете подключать созданный вами интерфейсный и внутренний пул с помощью правила маршрутизации.

1. Выберите элемент **Добавление правила маршрутизации** в столбце **Правила маршрутизации**.

2. В открывшемся окне **Добавление правила маршрутизации** введите *myRoutingRule* в поле **Имя правила**.

3. Для правила маршрутизации требуется прослушиватель. На вкладке **Прослушиватель** в окне **Добавление правила маршрутизации** введите следующие значения для прослушивателя.

    - **Имя правила**: *contosoRule*.
    - **Имя прослушивателя**: *contosoListener*.
    - **Интерфейсный IP-адрес**. Выберите **Общедоступные**, чтобы выбрать общедоступный IP-адрес, который вы создали для интерфейсных серверов.

   В разделе **Дополнительные параметры** укажите следующие значения.
   - **Тип прослушивателя**: несколько сайтов.
   - **Имя узла**: **www.contoso.com**.

   Примите значения по умолчанию для других параметров на вкладке **Прослушиватель**, а затем выберите вкладку **Серверные целевые объекты**, чтобы настроить остальную часть правила маршрутизации.

   :::image type="content" source="./media/create-multiple-sites-portal/routing-rule.png" alt-text="Создание правила маршрутизации":::

4. На вкладке **Серверные целевые объекты** выберите значение **contosoPool** для параметра **Серверный целевой объект**.

5. Для **Параметр HTTP** выберите **Добавить**, чтобы создать параметр HTTP. Параметр HTTP будет определять поведение правила маршрутизации. В открывшемся окне **Добавление параметра HTTP** введите *contosoHTTPSetting* в поле **Имя параметра HTTP**. Примите значения по умолчанию для других параметров в окне **Добавление параметра HTTP**, затем выберите **Добавить**, чтобы вернуться к окну **Добавление правила маршрутизации**. 

6. В окне **Добавление правила маршрутизации** выберите **Добавить**, чтобы сохранить правило маршрутизации и вернуться на вкладку **Конфигурация**.
7. Выберите **Добавление правила маршрутизации** и добавьте аналогичное правило, прослушиватель, целевой объект внутреннего сервера и параметр HTTP для Fabrikam.

     :::image type="content" source="./media/create-multiple-sites-portal/fabrikam-rule.png" alt-text="Правило Fabrikam":::

7. По завершении выберите **Next: Теги** , а затем **Далее: Отзыв и создание**.

### <a name="review--create-tab"></a>Вкладка "Просмотр и создание"

Просмотрите параметры на вкладке **Просмотр и создание**, а затем выберите **Создать**, чтобы создать виртуальную сеть, общедоступный IP-адрес и шлюз приложения. Создание шлюза приложений в Azure может занять несколько минут.

Дождитесь успешного завершения развертывания перед переходом к следующему разделу.

## <a name="add-backend-targets"></a>Добавление серверных целевых объектов

В этом примере мы будем использовать виртуальные машины в качестве целевых объектов серверной части. Вы можете использовать существующие виртуальные машины или создать новые. В этом примере вы создадите две виртуальные машины, которые будут использоваться в Azure как внутренние серверы для шлюза приложений.

Чтобы добавить серверные целевые объекты, сделайте следующее:

1. Создайте две новые виртуальные машины *contosoVM* и *fabrikamVM*, которые будут использоваться в качестве внутренних серверов.
2. Установить службы IIS на виртуальных машинах, чтобы убедиться, что шлюз приложений успешно создан.
3. Добавьте внутренние серверы к внутренним пулам.

### <a name="create-a-virtual-machine"></a>Создание виртуальной машины

1. На портале Azure выберите **Создать ресурс**. Появится окно **Создать**.
2. Выберите **Windows Server 2016 Datacenter** в списке **Популярные**. Появится страница **Создание виртуальной машины**.<br>Шлюз приложений может осуществлять маршрутизацию трафика для любого типа виртуальной машины, используемой в этом внутреннем пуле. В этом примере используется Windows Server 2016 Datacenter.
3. На вкладке **Основы** введите для следующих параметров виртуальной машины такие значения:

    - **Подписка**. Выберите свою подписку.
    - **Группа ресурсов.** Выберите **myResourceGroupAG** для имени группы ресурсов.
    - **Имя виртуальной машины**. Введите *contosoVM* в качестве имени виртуальной машины.
    - **Регион**. Выберите тот же регион, который вы указали ранее.
    - **Имя пользователя**. Введите имя пользователя для учетной записи администратора.
    - **Пароль**. Введите пароль администратора.
1. Примите остальные значения по умолчанию и щелкните **Далее: Диски**.  
2. Примите значения по умолчанию на вкладке **Диски**, а затем выберите **Далее: Сети**.
3. На вкладке **Сети** убедитесь, что для параметра **Виртуальная сеть** выбрано значение **myVNet**, а для параметра **Подсеть** — значение **myBackendSubnet**. Примите остальные значения по умолчанию и щелкните **Далее: управление**.<br>Шлюз приложений может взаимодействовать с экземплярами за пределами виртуальной сети, к которой он относится, при наличии подключения по IP-адресу.
4. На вкладке **Управление** для параметра **Диагностика загрузки** задайте значение **Отключить**. Примите другие значения по умолчанию и выберите **Review + create** (Просмотр и создание).
5. На вкладке **Review + create** (Просмотр и создание) проверьте параметры, устраните ошибки проверки, а затем выберите **Создать**.
6. Прежде чем продолжить, дождитесь завершения создания виртуальной машины.

### <a name="install-iis-for-testing"></a>Установка служб IIS для тестирования

В этом примере службы IIS устанавливаются на виртуальные машины, чтобы проверить, создан ли шлюз приложений в Azure.

1. Откройте [Azure PowerShell](../cloud-shell/quickstart-powershell.md). Для этого выберите **Cloud Shell** в верхней панели навигации портала Azure, а затем выберите **PowerShell** из раскрывающегося списка. 

    ![Установка пользовательского расширения](./media/application-gateway-create-gateway-portal/application-gateway-extension.png)

2. Выполните следующую команду, чтобы установить службы IIS на виртуальной машине, заменив <location\> регионом вашей группы ресурсов: 

    ```azurepowershell-interactive
    Set-AzVMExtension `
      -ResourceGroupName myResourceGroupAG `
      -ExtensionName IIS `
      -VMName contosoVM `
      -Publisher Microsoft.Compute `
      -ExtensionType CustomScriptExtension `
      -TypeHandlerVersion 1.4 `
      -SettingString '{"commandToExecute":"powershell Add-WindowsFeature Web-Server; powershell Add-Content -Path \"C:\\inetpub\\wwwroot\\Default.htm\" -Value $($env:computername)"}' `
      -Location <location>
    ```

3. Создайте вторую виртуальную машину и установите IIS, следуя только что выполненным инструкциям. Используйте *fabrikamVM* в качестве имени виртуальной машины и параметр **VMName** для командлета **Set-AzVMExtension**.

### <a name="add-backend-servers-to-backend-pools"></a>Добавление серверов в серверные пулы

1. Выберите **Все ресурсы**, а затем — **myAppGateway**.

2. Выберите **Серверные пулы** в меню слева.

3. Выберите **contosoPool**.

4. В разделе **Тип цели** выберите **Виртуальная машина** из раскрывающегося списка.

5. В разделе **Цель** выберите сетевой интерфейс виртуальной машины **contosoVM** из раскрывающегося списка.

    ![Добавление внутренних серверов](./media/create-multiple-sites-portal/edit-backend-pool.png)

6. Щелкните **Сохранить**.
7. Повторите, чтобы добавить *fabrikamVM* и интерфейс *в fabrikamPool*.

Прежде чем переходить к следующему шагу, дождитесь завершения развертывания.

## <a name="edit-your-hosts-file-for-name-resolution"></a>Изменение файла hosts для разрешения имен

Создав шлюз приложений с общедоступным IP-адресом, вы можете получить IP-адрес и использовать его для изменения файла hosts, чтобы разрешить `www.contoso.com` и `www.fabrikam.com`. В рабочей среде можно создать `CNAME` в DNS для разрешения имен.

1. Выберите **Все ресурсы** и щелкните **myAGPublicIPAddress**.

    ![Запись DNS-адреса шлюза приложений](./media/create-multiple-sites-portal/public-ip.png)

2. Скопируйте IP-адрес и используйте его в качестве значения для новых записей в файле `hosts`.
1. На локальном компьютере откройте командную строку администратора и перейдите по адресу `c:\Windows\System32\drivers\etc`.
1. Откройте файл `hosts` и добавьте следующие записи, где `x.x.x.x` — общедоступный IP-адрес шлюза приложений:
   ```dos
   # Copyright (c) 1993-2009 Microsoft Corp.
   #
   # This is a sample HOSTS file used by Microsoft TCP/IP for Windows.
   #
   # This file contains the mappings of IP addresses to host names. Each
   # entry should be kept on an individual line. The IP address should
   # be placed in the first column followed by the corresponding host name.
   # The IP address and the host name should be separated by at least one
   # space.
   #
   # Additionally, comments (such as these) may be inserted on individual
   # lines or following the machine name denoted by a '#' symbol.
   #
   # For example:
   #
   #      102.54.94.97     rhino.acme.com          # source server
   #       38.25.63.10     x.acme.com              # x client host
   
   # localhost name resolution is handled within DNS itself.
   #    127.0.0.1       localhost
   #    ::1             localhost
   x.x.x.x www.contoso.com
   x.x.x.x www.fabrikam.com

   ```
1. Сохраните файл.
1. Выполните следующие команды, чтобы загрузить и отобразить изменения в файле hosts:
   ```dos
    ipconfig/registerdns
    ipconfig/displaydns
   ```
   
## <a name="test-the-application-gateway"></a>Тестирование шлюза приложений

1. В адресной строке браузера введите имя домена. Например, `http://www.contoso.com`.

    ![Проверка сайта contoso в шлюзе приложений](./media/create-multiple-sites-portal/application-gateway-iistest.png)

2. Введите адрес другого домена. Результат должен быть примерно таким:

    ![Проверка сайта fabrikam в шлюзе приложений](./media/create-multiple-sites-portal/application-gateway-iistest2.png)

## <a name="clean-up-resources"></a>Очистка ресурсов

Если вам уже не нужны ресурсы, созданные с помощью шлюза приложений, удалите группу ресурсов. Удалив ее, вы также удалите шлюз приложений и все связанные с ним ресурсы.

Чтобы удалить группу ресурсов:

1. На портале Azure в меню слева выберите **Группы ресурсов**.
2. На странице **Группы ресурсов** выполните поиск группы **myResourceGroupAG** в списке и выберите ее.
3. На странице **группы ресурсов** выберите **Удалить группу ресурсов**.
4. Введите *myResourceGroupAG* в поле **Введите имя группы ресурсов**, а затем выберите **Удалить**.

Чтобы восстановить файл hosts, сделайте следующее:
1. Удалите строки `www.contoso.com` и `www.fabrikam.com` из файла hosts и запустите `ipconfig/registerdns` и `ipconfig/flushdns` из командной строки.

## <a name="next-steps"></a>Дальнейшие действия

> [!div class="nextstepaction"]
> [Дополнительные сведения о возможностях Шлюза приложений Azure](./overview.md)