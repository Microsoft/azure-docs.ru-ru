---
title: Перезапись HTTP-заголовков с помощью шлюза приложений Azure | Документация Майкрософт
description: В этой статье приведены общие сведения о перезаписи заголовков HTTP в шлюзе приложений Azure.
services: application-gateway
author: vhorne
ms.service: application-gateway
ms.topic: conceptual
ms.date: 04/27/2020
ms.author: absha
ms.openlocfilehash: 7c5b4f0d5d4b153684683963c56b7506e76d963e
ms.sourcegitcommit: 1f1d29378424057338b246af1975643c2875e64d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/05/2021
ms.locfileid: "99575659"
---
# <a name="rewrite-http-headers-with-application-gateway"></a>Перезапись HTTP-заголовков с помощью шлюза приложений

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

Заголовки HTTP позволяют клиенту и серверу передавать дополнительные сведения с помощью запроса или ответа. Переписав эти заголовки, вы можете выполнять важные задачи, такие как добавление полей заголовка, связанных с безопасностью, таких как HSTS/X-XSS-Protection, удаление полей заголовка ответа, которые могут раскрывать конфиденциальную информацию, и удаление сведений о портах из перенаправляемых по оси X для заголовков.

Шлюз приложений поддерживает возможность добавления, удаления и обновления заголовков запросов и ответов HTTP, пока пакеты запросов и ответов перемещаются между клиентским и внутренним пулами. Он также позволяет добавить условия, чтобы указанные заголовки перезаписывались только в том случае, если соблюдены определенные условия.

Шлюз приложений также поддерживает несколько [серверных переменных](#server-variables) , которые помогают хранить дополнительные сведения о запросах и ответах. Это упрощает создание эффективных правил перезаписи.

> [!NOTE]
>
> Поддержка переопределения HTTP-заголовков доступна только для [Standard_V2 и WAF_V2 SKU](application-gateway-autoscaling-zone-redundant.md).

![Перезапись заголовков](media/rewrite-http-headers/rewrite-headers.png)

## <a name="supported-headers"></a>Поддерживаемые заголовки

Вы можете переписать все заголовки в запросах и ответах, за исключением заголовков узла, соединения и обновления. Шлюз приложений также можно использовать для создания пользовательских заголовков и их добавления к запросам и ответам, направляемым через него.

## <a name="rewrite-conditions"></a>Условия перезаписи

Условия перезаписи можно использовать для вычисления содержимого запросов и ответов HTTP (S) и выполнения перезаписи заголовка только при соблюдении одного или нескольких условий. Шлюз приложений использует эти типы переменных для вычисления содержимого запросов и ответов HTTP (S).

- Заголовки HTTP в запросе.
- Заголовки HTTP в ответе.
- Переменные сервера шлюза приложений.

Можно использовать условие, чтобы определить, существует ли указанная переменная, соответствует ли указанная переменная конкретному значению, или же указанная переменная будет соответствовать определенному шаблону. Для настройки сопоставления шаблона регулярного выражения в условиях используется [Библиотека регулярных выражений с Perl (PCRE)](https://www.pcre.org/) . Дополнительные сведения о синтаксисе регулярных выражений см. на [странице Главная страница регулярных выражений Perl](https://perldoc.perl.org/perlre.html).

## <a name="rewrite-actions"></a>Действия перезаписи

Для указания заголовков запроса и ответа, которые требуется перезаписать, и новых значений для заголовков используются действия перезаписи. Можно либо создать новый заголовок, либо изменить значение существующего заголовка, либо удалить существующий заголовок. В качестве значения для нового заголовка или существующего заголовка можно задать следующие типы значений:

- Текст.
- Заголовок запроса. Чтобы указать заголовок запроса, необходимо использовать синтаксис {http_req_ *хеадернаме*}.
- Заголовок ответа. Чтобы указать заголовок ответа, необходимо использовать синтаксис {http_resp_ *хеадернаме*}.
- Переменная сервера. Чтобы указать переменную сервера, необходимо использовать синтаксис {var_ *сервервариабле*}.
- Сочетание текста, заголовка запроса, заголовка ответа и переменной сервера.

## <a name="server-variables"></a>Переменные сервера

Шлюз приложений использует переменные сервера для хранения полезной информации о сервере, подключении к клиенту и текущем запросе к соединению. Примеры хранимых сведений включают IP-адрес клиента и тип веб-браузера. Переменные сервера изменяются динамически, например при загрузке новой страницы или при публикации формы. Эти переменные можно использовать для вычисления условий перезаписи и перезаписи заголовков. Чтобы использовать значения переменных сервера для перезаписи заголовков, необходимо указать эти переменные в синтаксисе {var_ *сервервариабле*}.

Шлюз приложений поддерживает следующие серверные переменные:

| Имя переменной | Описание                                                  |
| -------------------------- | :----------------------------------------------------------- |
| add_x_forwarded_for_proxy  | Поле заголовка X-Forwarded — для запроса клиента с `client_ip` переменной (см. описание далее в этой таблице) добавляется к ней в формате IP1, IP2, IP3 и т. д. Если в заголовке запроса клиента нет поля X-Forwardd-for, `add_x_forwarded_for_proxy` переменная будет равна `$client_ip` переменной. Эта переменная особенно полезна при необходимости перезаписи заголовка X-Forwardd-for, установленного шлюзом приложений, чтобы заголовок содержал только IP-адрес без сведений о порте. |
| ciphers_supported          | Список шифров, поддерживаемых клиентом.          |
| ciphers_used               | Строка шифров, используемых для установленного подключения TLS. |
| client_ip                  | IP-адрес клиента, от которого шлюз приложений получил запрос. Если перед шлюзом приложений и исходным клиентом есть обратный прокси-сервер, *Client_IP* возвратит IP-адрес обратного прокси-сервера. |
| client_port                | Порт клиента.                                                  |
| client_tcp_rtt             | Сведения о TCP-подключении клиента. Доступно в системах, поддерживающих параметр сокета TCP_INFO. |
| client_user                | При использовании проверки подлинности HTTP имя пользователя, передаваемое для проверки подлинности. |
| узел                       | В порядке приоритета: имя узла из строки запроса, имя узла из поля заголовка запроса узла или имя сервера, соответствующее запросу. Пример. в запросе `http://contoso.com:8080/article.aspx?id=123&title=fabrikam` значение узла будет равно *contoso.com* . |
| *имя* cookie_              | *Имя* файла cookie.                                            |
| http_method                | Метод, используемый для выполнения запроса URL-адреса. Например, GET или POST. |
| http_status                | Состояние сеанса. Например, 200, 400 или 403.                       |
| http_version               | Протокол запроса. Обычно HTTP/1.0, HTTP/1.1 или HTTP/2.0. |
| query_string               | Список пар "переменная-значение", следующий за "?" в запрошенном URL-адресе. Пример. в запросе `http://contoso.com:8080/article.aspx?id=123&title=fabrikam` QUERY_STRING значение будет *ID = 123&Title = Fabrikam* . |
| received_bytes             | Длина запроса (включая строку запроса, заголовок и текст запроса). |
| request_query              | Аргументы в строке запроса.                                |
| request_scheme             | Схема запроса: HTTP или HTTPS.                            |
| request_uri                | Полный URI исходного запроса (с аргументами). Пример. в запросе `http://contoso.com:8080/article.aspx?id=123&title=fabrikam` REQUEST_URI значение будет */артикле.аспкс? ID = 123&Title = Fabrikam*   |
| sent_bytes                 | Число байтов, отправленных клиенту.                             |
| server_port                | Порт сервера, который принял запрос.                 |
| ssl_connection_protocol    | Протокол установленного подключения TLS.        |
| ssl_enabled                | "On", если соединение работает в режиме TLS. В противном случае — пустая строка. |
| uri_path                   | Определяет конкретный ресурс на узле, к которому требуется доступ веб-клиент. Это часть URI запроса без аргументов. Пример. в запросе `http://contoso.com:8080/article.aspx?id=123&title=fabrikam` uri_path значение будет равно */артикле.аспкс* .  |

## <a name="rewrite-configuration"></a>Перезапись конфигурации

Чтобы настроить перезапись HTTP-заголовка, необходимо выполнить следующие действия.

1. Создайте объекты, необходимые для перезаписи заголовка HTTP:

   - **Действие перезаписи**: используется для указания полей заголовка запроса и запроса, которые требуется перезаписать, и нового значения для заголовков. Можно связать одно или несколько условий перезаписи с действием перезаписи.

   - **Условие перезаписи**: Необязательная конфигурация. Условия перезаписи оценивают содержимое запросов и ответов HTTP (S). Действие перезаписи будет выполнено, если запрос HTTP (S) или ответ соответствует условию перезаписи.

     При связывании более одного условия с действием действие выполняется только при соблюдении всех условий. Иными словами, операция является логической операцией и.

   - **Правило перезаписи**: содержит несколько сочетаний "действие перезаписи" и "Перезапись".

   - **Последовательность правил**. помогает определить порядок выполнения правил перезаписи. Эта конфигурация полезна при наличии нескольких правил перезаписи в наборе перезаписи. Сначала выполняется правило перезаписи с более низким значением последовательности правил. При назначении одной и той же последовательности правил двум правилам перезаписи порядок выполнения не детерминирован.

   - **Набор перезаписи**: содержит несколько правил перезаписи, которые будут связаны с правилом маршрутизации запросов.

2. Присоедините набор перезаписи (*ревритерулесет*) к правилу маршрутизации. Конфигурация перезаписи прикрепляется к исходному прослушивателю с помощью правила маршрутизации. При использовании базового правила маршрутизации конфигурация перезаписи заголовка связана с прослушивателем источника и переписывается глобальным заголовком. При использовании правила маршрутизации на основе пути конфигурация перезаписи заголовка определяется на карте URL-пути. В этом случае он применяется только к определенной области пути сайта.
   > [!NOTE]
   > Перезапись URL-адреса изменение заголовков; Он не изменяет URL-адрес для пути.

Можно создать несколько наборов перезаписи заголовков HTTP и применить каждый набор перезаписи к нескольким прослушивателям. Но для конкретного прослушивателя можно применить только один набор перезаписи.

## <a name="common-scenarios"></a>Распространенные сценарии

Ниже приведены некоторые распространенные сценарии использования перезаписи заголовков.

### <a name="remove-port-information-from-the-x-forwarded-for-header"></a>Удаление сведений о портах из заголовка X-Forwardd-for

Шлюз приложений вставляет заголовок X-Forwardd-for во все запросы, прежде чем перенаправит запросы в серверную часть. Этот заголовок представляет собой разделенный запятыми список IP-портов. Могут существовать сценарии, в которых серверным серверам требуются только заголовки для хранения IP-адресов. Можно использовать перезапись заголовка для удаления сведений о портах из заголовка X-Forwardd-for. Один из способов сделать это — задать для заголовка add_x_forwarded_for_proxy серверную переменную:

![Удалить порт](media/rewrite-http-headers/remove-port.png)

### <a name="modify-a-redirection-url"></a>Изменение URL-адреса перенаправления

Когда серверное приложение отправляет ответ перенаправления, может потребоваться перенаправить клиента на URL-адрес, отличный от того, который указан в серверном приложении. Например, это может потребоваться, если служба приложений размещена за шлюзом приложений и требует от клиента перенаправления к относительному пути. (Например, перенаправление с contoso.azurewebsites.net/path1 на contoso.azurewebsites.net/path2.)

Так как служба приложений является многоклиентской службой, она использует заголовок узла в запросе для маршрутизации запроса в правильную конечную точку. Службы приложений имеют доменное имя по умолчанию *. azurewebsites.net (скажем, contoso.azurewebsites.net), которое отличается от доменного имени шлюза приложений (скажем, contoso.com). Поскольку исходный запрос клиента имеет доменное имя шлюза приложений (contoso.com) в качестве имени узла, шлюз приложений изменяет имя узла на contoso.azurewebsites.net. Он делает это изменение, чтобы служба приложений могла направить запрос в правильную конечную точку.

Когда служба приложений отправляет ответ перенаправления, она использует то же имя узла в заголовке Location своего ответа, что и в запросе, полученном от шлюза приложений. Поэтому клиент сделает запрос напрямую contoso.azurewebsites.net/path2, а не через шлюз приложений (contoso.com/path2). Обход шлюза приложений нежелательно.

Эту проблему можно устранить, задав имя узла в заголовке Location в качестве доменного имени шлюза приложений.

Ниже приведены действия по замене имени узла.

1. Создайте правило перезаписи с условием, которое оценивает, содержит ли заголовок Location в ответе azurewebsites.net. Введите шаблон `(https?):\/\/.*azurewebsites\.net(.*)$` .
1. Выполните действие, чтобы перезаписать заголовок Location так, чтобы в нем было указано имя узла шлюза приложений. Для этого введите в `{http_resp_Location_1}://contoso.com{http_resp_Location_2}` качестве значения заголовка.

![Изменить заголовок расположения](media/rewrite-http-headers/app-service-redirection.png)

### <a name="implement-security-http-headers-to-prevent-vulnerabilities"></a>Реализация заголовков HTTP безопасности для предотвращения уязвимостей

Можно устранить несколько уязвимостей системы безопасности, реализовав необходимые заголовки в ответе приложения. К этим заголовкам относятся: X-XSS-Protection, долгосрочный-Transport-Security и Content-Security-Policy. Вы можете использовать шлюз приложений, чтобы задать эти заголовки для всех ответов.

![Заголовок безопасности](media/rewrite-http-headers/security-header.png)

### <a name="delete-unwanted-headers"></a>Удалить ненужные заголовки

Может потребоваться удалить заголовки, которые раскрывают конфиденциальную информацию из HTTP-ответа. Например, может потребоваться удалить такие сведения, как имя сервера, сведения об операционной системе или библиотеке. Для удаления этих заголовков можно использовать шлюз приложений:

![Удаление заголовка](media/rewrite-http-headers/remove-headers.png)

### <a name="check-for-the-presence-of-a-header"></a>Проверка наличия заголовка

Можно оценить HTTP-запрос или заголовок ответа на наличие заголовка или серверной переменной. Эта оценка полезна, если требуется выполнить перезапись заголовка только при наличии определенного заголовка.

![Проверка наличия заголовка](media/rewrite-http-headers/check-presence.png)

## <a name="limitations"></a>Ограничения

- Если в ответе несколько заголовков с одним и тем же именем, то перезапись значения одного из этих заголовков приведет к удалению других заголовков в ответе. Обычно это происходит с заголовком Set-Cookie, так как в ответе может быть несколько заголовков Set-Cookie. Одним из таких сценариев является ситуация, когда вы используете службу приложений с шлюзом приложений и настроили сходство сеансов на основе файлов cookie в шлюзе приложений. В этом случае ответ будет содержать два заголовка Set-Cookie: один используется службой приложений, например: `Set-Cookie: ARRAffinity=ba127f1caf6ac822b2347cc18bba0364d699ca1ad44d20e0ec01ea80cda2a735;Path=/;HttpOnly;Domain=sitename.azurewebsites.net` и другой для сходства шлюза приложений, например `Set-Cookie: ApplicationGatewayAffinity=c1a2bd51lfd396387f96bl9cc3d2c516; Path=/` . Перезапись одного из заголовков Set-Cookie в этом сценарии может привести к удалению другого Set-Cookie из ответа.

- Перезапись не поддерживается, если шлюз приложений настроен для перенаправления запросов или для отображения настраиваемой страницы ошибок.

- Перезапись подключения, обновления и заголовков узлов в настоящее время не поддерживается.

- Имена заголовков могут содержать любые буквенно-цифровые символы и специальные символы, как определено в [RFC 7230](https://tools.ietf.org/html/rfc7230#page-27). В настоящее время не поддерживается специальный символ подчеркивания ( \_ ) в именах заголовков.

## <a name="next-steps"></a>Следующие шаги

Дополнительные сведения о перезаписи HTTP-заголовков см. в следующих статьях:

- [Переопределение HTTP-заголовков с помощью портала Azure](./rewrite-http-headers-portal.md)
- [Перезапись HTTP-заголовков с помощью Azure PowerShell](add-http-header-rewrite-rule-powershell.md)