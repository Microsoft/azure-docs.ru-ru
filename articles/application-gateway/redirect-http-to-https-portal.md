---
title: Перенаправление HTTP-HTTPS на портале — шлюз приложений Azure
description: Узнайте, как создать шлюз приложений с перенаправлением трафика HTTP в HTTPS с помощью портала Azure.
services: application-gateway
author: vhorne
ms.service: application-gateway
ms.topic: how-to
ms.date: 11/13/2019
ms.author: victorh
ms.openlocfilehash: 67153fa750fee765dcaa1072eec87a2f6169b918
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "93397286"
---
# <a name="create-an-application-gateway-with-http-to-https-redirection-using-the-azure-portal"></a>Создание шлюза приложений с перенаправлением трафика HTTP в HTTPS с помощью портала Azure

Вы можете использовать портал Azure для создания [шлюза приложений](overview.md) с сертификатом для завершения TLS. Правило маршрутизации используется для перенаправления трафика HTTP в HTTPS-порт в шлюзе приложений. В этом примере также создается [масштабируемый набор виртуальных машин](../virtual-machine-scale-sets/overview.md) с двумя экземплярами виртуальных машин, предназначенный для внутреннего пула шлюза приложений.

Вы узнаете, как выполнять следующие задачи:

* Создание самозаверяющего сертификата
* настройка сети;
* создание шлюза приложений с сертификатом;
* добавление прослушивателя и правила перенаправления;
* создание масштабируемого набора виртуальных машин с серверным пулом, используемым по умолчанию.

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

Для работы с этим руководством требуется модуль Azure PowerShell версии 1.0.0 или более поздней, чтобы создать сертификат и установить IIS. Чтобы узнать версию, выполните команду `Get-Module -ListAvailable Az`. Если вам необходимо выполнить обновление, ознакомьтесь со статьей, посвященной [установке модуля Azure PowerShell](/powershell/azure/install-az-ps). Для выполнения команд в этом руководстве необходимо также выполнить командлет `Login-AzAccount`, чтобы создать подключение к Azure.

## <a name="create-a-self-signed-certificate"></a>Создание самозаверяющего сертификата

Для использования в рабочей среде следует импортировать действительный сертификат, подписанный доверенным поставщиком. В этом руководстве мы создадим самозаверяющий сертификат с помощью [New-SelfSignedCertificate](/powershell/module/pkiclient/new-selfsignedcertificate). Вы можете использовать [Export-PfxCertificate](/powershell/module/pkiclient/export-pfxcertificate) с возвращенным отпечатком, чтобы экспортировать PFX-файл из сертификата.

```powershell
New-SelfSignedCertificate `
  -certstorelocation cert:\localmachine\my `
  -dnsname www.contoso.com
```

Отобразится примерно такой результат:

```
PSParentPath: Microsoft.PowerShell.Security\Certificate::LocalMachine\my

Thumbprint                                Subject
----------                                -------
E1E81C23B3AD33F9B4D1717B20AB65DBB91AC630  CN=www.contoso.com
```

Воспользуйтесь отпечатком, чтобы создать PFX-файл:

```powershell
$pwd = ConvertTo-SecureString -String "Azure123456!" -Force -AsPlainText
Export-PfxCertificate `
  -cert cert:\localMachine\my\E1E81C23B3AD33F9B4D1717B20AB65DBB91AC630 `
  -FilePath c:\appgwcert.pfx `
  -Password $pwd
```

## <a name="create-an-application-gateway"></a>Создание шлюза приложений

Виртуальная сеть необходима для обмена данными между создаваемыми ресурсами. В этом примере создаются две подсети: одна для шлюза приложений, а другая — для внутренних серверов. Вы можете создать виртуальную сеть во время создания шлюза приложений.

1. Войдите на портал Azure по адресу [https://portal.azure.com](https://portal.azure.com).
2. Выберите **Создать ресурс** в верхнем левом углу окна на портале Azure.
3. Выберите **Сети**, а затем в списке Рекомендованные выберите **Шлюз приложений**.
4. Введите следующие значения для шлюза приложений:

   - *myAppGateway* — для имени шлюза приложений.
   - *myResourceGroupAG* — для новой группы ресурсов.

     ![Создание шлюза приложений](./media/create-url-route-portal/application-gateway-create.png)

5. Оставьте значения по умолчанию для остальных параметров и нажмите кнопку **ОК**.
6. Щелкните **Выбрать виртуальную сеть**, выберите **Создать**, а затем введите следующие значения для виртуальной сети:

   - *myVNet* — имя виртуальной сети;
   - *10.0.0.0/16* — диапазон адресов виртуальной сети;
   - *myAGSubnet* — имя подсети;
   - *10.0.0.0/24* — диапазон адресов подсети.

     ![Создание виртуальной сети](./media/create-url-route-portal/application-gateway-vnet.png)

7. Нажмите кнопку **ОК**, чтобы создать виртуальную сеть и подсеть.
8. В разделе **Интерфейсная IP-конфигурация** убедитесь, что **тип IP-адреса** имеет значение **Общедоступный** и выбрано **Создать**. Введите имя *myAGPublicIPAddress*. Оставьте значения по умолчанию для остальных параметров и нажмите кнопку **ОК**.
9. В разделе **Конфигурация прослушивателя** выберите **HTTPS**, а затем щелкните **Выберите файл** и перейдите к файлу *c:\appgwcert.pfx*, а затем выберите **Открыть**.
10. Введите имя сертификата *appgwcert* и *Azure123456!* в качестве пароля.
11. Оставьте брандмауэр веб-приложения отключенным, а затем нажмите кнопку **ОК**.
12. Просмотрите параметры на странице сводки и выберите **ОК**, чтобы создать сетевые ресурсы и шлюз приложений. Процесс создания шлюза приложений может занять несколько минут. Дождитесь успешного завершения развертывания, прежде чем переходить к следующему разделу.

### <a name="add-a-subnet"></a>Добавление подсети

1. Выберите **Все ресурсы** в меню слева, а затем в списке ресурсов щелкните **myVNet**.
2. Выберите **Подсети**, а затем — **Подсеть**.

    ![Создание подсети](./media/create-url-route-portal/application-gateway-subnet.png)

3. Введите имя подсети *myBackendSubnet*.
4. Введите диапазон адресов *10.0.2.0/24*, а затем нажмите кнопку **ОК**.

## <a name="add-a-listener-and-redirection-rule"></a>добавление прослушивателя и правила перенаправления;

### <a name="add-the-listener"></a>Добавление прослушивателя

Во-первых, добавьте прослушиватель *myListener* для порта 80.

1. Откройте группу ресурсов **myResourceGroupAG** и выберите **myAppGateway**.
2. Выберите **Прослушиватели**, а затем — **+ Базовые**.
3. Введите имя *MyListener*.
4. В качестве имени нового интерфейсного порта введите *httpPort*, а для порт — *80*.
5. Убедитесь, что для протокола задано значение **HTTP**, а затем нажмите кнопку **ОК**.

### <a name="add-a-routing-rule-with-a-redirection-configuration"></a>Добавление правила маршрутизации с конфигурацией перенаправления

1. В **myAppGateway** выберите **правила** , а затем выберите **+ запрос правила маршрутизации**.
2. В поле **имя правила** введите *Rule2*.
3. Убедитесь, что в качестве прослушивателя выбран **MyListener**.
4. Щелкните вкладку **внутренние целевые объекты** и выберите **тип целевого объекта** в качестве *перенаправления*.
5. Для **типа перенаправления** выберите **Постоянный**.
6. Для **цели перенаправления** выберите **Прослушиватель**.
7. Убедитесь, что для параметра **Прослушиватель целевого объекта** установлено значение **appGatewayHttpListener**.
8. В поле **включить строку запроса** и **путь включения** выберите *Да*.
9. Выберите **Добавить**.

## <a name="create-a-virtual-machine-scale-set"></a>создавать масштабируемый набор виртуальных машин;

В этом примере создается масштабируемый набор виртуальных машин, чтобы предоставить серверы для серверного пула в шлюзе приложений.

1. На портале в верхнем левом углу выберите **+ Создать ресурс**.
2. Выберите **Вычисления**.
3. В поле поиска введите *масштабируемый набор* и нажмите клавишу ВВОД.
4. Выберите **Набор масштабирования виртуальной машины**, а затем — **Создать**.
5. В качестве **имени масштабируемого набора виртуальных машин** введите *myvmss*.
6. Убедитесь, что для образа диска операционной системы** выбран **Windows Server 2016 Datacenter**.
7. Для **группы ресурсов** выберите **myResourceGroupAG**.
8. Для **имя пользователя** введите *azureuser*.
9. Введите **пароль***Azure123456!* и подтвердите его.
10. Убедитесь, что для параметра **Число экземпляров** установлено значение **2**.
11. Выберите **размер экземпляра****D2s_v3**.
12. В разделе **Сети** убедитесь, что для параметра **Выбрать параметры балансировки нагрузки** установлено значение **Шлюз приложений**.
13. Убедитесь, что для **шлюза приложений** установлено значение **myAppGateway**.
14. Убедитесь, что для **подсети** установлено значение **myBackendSubnet**.
15. Нажмите кнопку **создания**.

### <a name="associate-the-scale-set-with-the-proper-backend-pool"></a>Связывание масштабируемого набора с правильным серверным пулом

Пользовательский интерфейс портала масштабируемого набора виртуальных машин создает новый серверный пул, однако его нужно связать с существующим appGatewayBackendPool.

1. Откройте группу ресурсов **myResourceGroupAg**.
2. Выберите **myAppGateway**.
3. Выберите **Серверные пулы**.
4. Выберите **myAppGatewaymyvmss**.
5. Выберите **Remove all targets from backend pool** (Удалить все цели из серверного пула).
6. Щелкните **Сохранить**.
7. После завершения этого процесса выберите серверный пул **myAppGatewaymyvmss**, щелкните **Удалить**, а затем нажмите кнопку **ОК** для подтверждения.
8. Выберите **appGatewayBackendPool**.
9. В разделе **целевых объектов** выберите **VMSS**.
10. В разделе **VMSS** выберите **myvmss**.
11. В разделе **Конфигурации сетевого интерфейса** выберите **myvmssNic**.
12. Щелкните **Сохранить**.

### <a name="upgrade-the-scale-set"></a>Обновление масштабируемого набора

Наконец, необходимо обновить масштабируемый набор с этими изменениями.

1. Выберите масштабируемый набор **myvmss**.
2. В разделе **Параметры** выберите **Экземпляры**.
3. Выберите оба экземпляра, а затем щелкните **Обновить**.
4. Выберите **Да** для подтверждения.
5. Когда операция будет завершена, вернитесь к **myAppGateway** и выберите **Серверные пулы**. Теперь вы увидите, что **appGatewayBackendPool** имеет два целевых объекта, а **myAppGatewaymyvmss** — ни одного.
6. Выберите **myAppGatewaymyvmss**, а затем — **Удалить**.
7. Для подтверждения нажмите кнопку **ОК**.

### <a name="install-iis"></a>Установка служб IIS

Простой способ установить службы IIS в масштабируемом наборе — использовать PowerShell. На портале щелкните значок Cloud Shell и убедитесь, что выбран **PowerShell**.

Вставьте следующий код в окно PowerShell и нажмите клавишу ВВОД.

```azurepowershell
$publicSettings = @{ "fileUris" = (,"https://raw.githubusercontent.com/Azure/azure-docs-powershell-samples/master/application-gateway/iis/appgatewayurl.ps1"); 
  "commandToExecute" = "powershell -ExecutionPolicy Unrestricted -File appgatewayurl.ps1" }
$vmss = Get-AzVmss -ResourceGroupName myResourceGroupAG -VMScaleSetName myvmss
Add-AzVmssExtension -VirtualMachineScaleSet $vmss `
  -Name "customScript" `
  -Publisher "Microsoft.Compute" `
  -Type "CustomScriptExtension" `
  -TypeHandlerVersion 1.8 `
  -Setting $publicSettings
Update-AzVmss `
  -ResourceGroupName myResourceGroupAG `
  -Name myvmss `
  -VirtualMachineScaleSet $vmss
```

### <a name="upgrade-the-scale-set"></a>Обновление масштабируемого набора

После установки служб IIS на экземпляры необходимо снова обновить масштабируемый набор с этим изменением.

1. Выберите масштабируемый набор **myvmss**.
2. В разделе **Параметры** выберите **Экземпляры**.
3. Выберите оба экземпляра, а затем щелкните **Обновить**.
4. Выберите **Да** для подтверждения.

## <a name="test-the-application-gateway"></a>Тестирование шлюза приложений

Общедоступный IP-адрес приложения можно получить на странице обзора шлюза приложения.

1. Выберите **myAppGateway**.
2. На странице **Обзор** запишите IP-адрес в разделе **Общедоступный интерфейсный IP-адрес**.

3. Скопируйте общедоступный IP-адрес и вставьте его в адресную строку браузера. Например: http://52.170.203.149

   ![Предупреждение системы безопасности](./media/redirect-http-to-https-powershell/application-gateway-secure.png)

4. Чтобы принять предупреждение безопасности, если вы использовали самозаверяющий сертификат, выберите **сведения** , а затем перейдите на **веб-страницу**. На экране отобразится защищенный веб-сайт IIS, как в показано следующем примере:

   ![Тестирование базового URL-адреса в шлюзе приложений](./media/redirect-http-to-https-powershell/application-gateway-iistest.png)

## <a name="next-steps"></a>Дальнейшие действия

Узнайте, как [создать шлюз приложения с внутренним перенаправлением](redirect-internal-site-powershell.md).