---
title: Поддержка больших объемов трафика Шлюза приложений
description: Эта статья содержит рекомендации по настройке Шлюза приложений Azure для сценариев, связанных с большим объемом трафика в сети.
services: application-gateway
author: caya
ms.service: application-gateway
ms.topic: conceptual
ms.date: 03/24/2020
ms.author: caya
ms.openlocfilehash: d8940d791920daca6ef0af186a4bb5e17009637b
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "100586109"
---
# <a name="application-gateway-high-traffic-support"></a>Поддержка больших объемов трафика Шлюза приложений

>[!NOTE]
> В этой статье описываются некоторые рекомендации по настройке шлюза приложений для поддержки дополнительного трафика для любого большого объема трафика, который может возникнуть. Пороговые значения оповещений являются исключительно предложениями и универсальными по своей природе. Пользователи могут определять пороговые значения оповещений на основе их рабочей нагрузки и ожидания использования.

Шлюз приложений можно использовать в сочетании с брандмауэром веб-приложения (WAF) для масштабируемой и надежной обработки трафика веб-приложений.

Важно масштабировать шлюз приложений в соответствии с трафиком и с помощью ряда буферов, чтобы подготовиться к ухудшению трафика или пиковому трафику и свести к минимуму влияние на качество обслуживания. Приведенные ниже советы и рекомендации помогут вам настроить Шлюз приложений и WAF для обработки возросшего трафика.

Полный список метрик, предлагаемых шлюзом приложений, см. в [документации по метрикам](./application-gateway-metrics.md) . Сведения о настройке оповещений для метрик см. в разделе [визуализация метрик](./application-gateway-metrics.md#metrics-visualization) в портал Azure и в [документации по Azure Monitor](../azure-monitor/alerts/alerts-metric.md) .

## <a name="scaling-for-application-gateway-v1-sku-standardwaf-sku"></a>Масштабирование SKU шлюза приложений версии 1 (SKU "Стандартный" или "WAF")

### <a name="set-your-instance-count-based-on-your-peak-cpu-usage"></a>Установка числа экземпляров на основе пиковой загрузки ЦП
При использовании шлюза SKU версии v1 вы сможете настроить шлюз приложений до 32 экземпляров для масштабирования. Проверьте использование ЦП шлюза приложений за последний месяц на наличие пиковых нагрузок выше 80%, которые доступны в качестве метрики для мониторинга. Рекомендуется задать число экземпляров в соответствии с пиковым использованием и с 10% до 20% дополнительного буфера для учета пиков трафика.

:::image type="content" source="./media/application-gateway-covid-guidelines/v1-cpu-utilization-inline.png" alt-text="Метрики использования ЦП v1" lightbox="./media/application-gateway-covid-guidelines/v1-cpu-utilization-exp.png":::

### <a name="use-the-v2-sku-over-v1-for-its-autoscaling-capabilities-and-performance-benefits"></a>Для доступа к функциям автоматического масштабирования и повышенной производительности используйте SKU версии 2, а не 1
SKU версии 2 поддерживает автомасштабирование, благодаря чему Шлюз приложений может справляться с увеличением трафика. В этой версии также существенно повышена производительность: в частности, впятеро увеличена эффективность разгрузки TLS, ускорены процессы развертывания и обновления, обеспечена избыточность зон и реализованы дополнительные улучшения в сравнении с версией 1. Дополнительные сведения см. в документации по [миграции](./migrate-v1-v2.md) с [версии](./application-gateway-autoscaling-zone-redundant.md) v1 на v2, чтобы узнать, как перенести существующие шлюзы SKU v1 в SKU v2. 

## <a name="autoscaling-for-application-gateway-v2-sku-standard_v2waf_v2-sku"></a>Автомасштабирование SKU версии 2 Шлюза приложений (Standard_v2 и WAF_v2 SKU)

### <a name="set-maximum-instance-count-to-the-maximum-possible-125"></a>Установите максимально возможное число экземпляров (125)
 
Для номера SKU шлюза приложений версии 2, установив максимальное возможное число экземпляров равным максимальному значению 125, можно масштабировать шлюз приложений по мере необходимости. Благодаря этому она сможет обрабатывать возросший трафик в ваших приложениях. Счет будет выставляться вам только за реально использованные единицы емкости (CU). 

Убедитесь, что вы проверите размер подсети и доступный счетчик IP-адресов в подсети и установите максимальное число экземпляров на основе этого. Если в подсети недостаточно места для размещения, вам потребуется повторно создать шлюз в той же или другой подсети с достаточной емкостью. 

:::image type="content" source="./media/application-gateway-covid-guidelines/v2-autoscaling-max-instances-inline.png" alt-text="Конфигурация автоматического масштабирования v2" lightbox="./media/application-gateway-covid-guidelines/v2-autoscaling-max-instances-exp.png":::

### <a name="set-your-minimum-instance-count-based-on-your-average-compute-unit-usage"></a>Установите минимальное число экземпляров на основе средней вычислительной единицы использования

Для SKU шлюза приложений версии 2 Автоматическое масштабирование занимает от шести до семи минут, чтобы масштабировать и подготавливать дополнительный набор экземпляров, готовых к получению трафика. До тех пор, если в трафике возникают короткие пики, существующие экземпляры шлюза могут оказаться под нагрузкой, а это может привести к непредвиденной задержке или потере трафика. 

Рекомендуется установить для минимального числа экземпляров оптимальный уровень. Например, если требуется, чтобы экземпляры 50 обрабатывали трафик при пиковой нагрузке, Установка минимума от 25 до 30 является хорошей идеей, а не <10, чтобы даже при наличии коротких пакетов трафика шлюз приложений сможет обработать его и предоставить достаточно времени для того, чтобы автоматическое масштабирование отвечало и вступило в силу.

Проверьте метрику единиц вычислений за последний месяц. Метрика единицы вычислений — это представление загрузки ЦП шлюза и в зависимости от пикового использования, деленного на 10, можно задать минимальное количество экземпляров. Обратите внимание, что 1 экземпляр шлюза приложений может обработано не менее 10 единиц вычислений.

:::image type="content" source="./media/application-gateway-covid-guidelines/compute-unit-metrics-inline.png" alt-text="Метрики единиц вычислений v2" lightbox="./media/application-gateway-covid-guidelines/compute-unit-metrics-exp.png":::

## <a name="manual-scaling-for-application-gateway-v2-sku-standard_v2waf_v2"></a>Ручное масштабирование для SKU шлюза приложений версии 2 (Standard_v2 и WAF_v2)

### <a name="set-your-instance-count-based-on-your-peak-compute-unit-usage"></a>Установка числа экземпляров на основе пикового использования единиц вычислений 

В отличие от автомасштабирования, при ручном масштабировании необходимо вручную задать количество экземпляров шлюза приложений на основе требований к трафику. Рекомендуется задать число экземпляров в соответствии с пиковым использованием и с 10% до 20% дополнительного буфера для учета пиков трафика. Например, если для трафика требуется 50 экземпляров в пиковое время, подготавливает 55 к 60 экземпляров, чтобы справиться с непредвиденными пиковыми нагрузками трафика.

Проверьте метрику единиц вычислений за последний месяц. Метрика единицы вычислений — это представление загрузки ЦП шлюза и в зависимости от пикового использования, деленного на 10, можно задать необходимое количество экземпляров, так как один экземпляр шлюза приложений может работать как минимум 10 единиц вычислений.

## <a name="monitoring-and-alerting"></a>Мониторинг и оповещения

Чтобы получать уведомления об аномалиях трафика или использования, можно настроить оповещения для определенных метрик. Полный список метрик, предлагаемых шлюзом приложений, см. в [документации по метрикам](./application-gateway-metrics.md) . Сведения о настройке оповещений для метрик см. в разделе [визуализация метрик](./application-gateway-metrics.md#metrics-visualization) в портал Azure и в [документации по Azure Monitor](../azure-monitor/alerts/alerts-metric.md) .

## <a name="alerts-for-application-gateway-v1-sku-standardwaf"></a>Оповещения для SKU шлюза приложений версии 1 (Standard/WAF)

### <a name="alert-if-average-cpu-utilization-crosses-80"></a>Оповещать, если средняя загрузка ЦП пересекаются 80%

При нормальных условиях загрузка ЦП не должна регулярно превышать 90 %, так как это может привести к задержкам на веб-сайтах, размещенных за Шлюзом приложений, и дестабилизации работы клиента. Можно косвенно управлять или повысить загрузку ЦП, изменив конфигурацию шлюза приложений, увеличив число экземпляров или переместив на больший размер SKU или выполнив оба этих действия. Настройте оповещение, если метрика использования ЦП превышает 80% в среднем.

### <a name="alert-if-unhealthy-host-count-crosses-threshold"></a>Оповещать при превышении порогового значения количества неработоспособных узлов

Эта метрика указывает количество внутренних серверов, которые шлюз приложений не может успешно протестировать. Это приведет к перехвату проблем, когда экземпляры шлюза приложений не могут подключиться к серверной части. Оповещать, если это число превышает 20% емкости серверной части. Пример: Если в настоящее время в серверном пуле имеется 30 внутренних серверов, настройте оповещение, если количество неработоспособных узлов превышает 6.

### <a name="alert-if-response-status-4xx-5xx-crosses-threshold"></a>Предупреждение, если состояние ответа (4xx, 5xx) пересекает порог 

Создавать оповещение, если состояние отклика шлюза приложения — 4xx или 5xx. В связи с временными проблемами может появиться случайный ответ 4xx или 5xx. Вы должны наблюдать за шлюзом в рабочей среде, чтобы определить статическое пороговое значение или использовать динамическое пороговое значение для предупреждения.

### <a name="alert-if-failed-requests-crosses-threshold"></a>Оповещать, если невыполненные запросы пересекаются пороговое значение 

Создать оповещение при превышении порогового значения метрики неудачных запросов. Вы должны наблюдать за шлюзом в рабочей среде, чтобы определить статическое пороговое значение или использовать динамическое пороговое значение для предупреждения.

### <a name="example-setting-up-an-alert-for-more-than-100-failed-requests-in-the-last-5-minutes"></a>Пример. Настройка оповещения для более чем 100 неудачных запросов за последние 5 минут

В этом примере показано, как использовать портал Azure, чтобы настроить оповещение, если количество неудачных запросов за последние 5 минут превышает 100.
1. Перейдите к **Шлюзу приложений**.
2. На левой панели на вкладке **Мониторинг** выберите **Метрики**. 
3. Добавьте метрику для **неудачных запросов**.
4. Щелкните **новое правило генерации оповещений** и определите условия и действия.
5. Щелкните **создать правило генерации оповещений** , чтобы создать и включить оповещение.

:::image type="content" source="./media/application-gateway-covid-guidelines/create-alerts-inline.png" alt-text="Создание оповещений v2" lightbox="./media/application-gateway-covid-guidelines/create-alerts-exp.png":::

## <a name="alerts-for-application-gateway-v2-sku-standard_v2waf_v2"></a>Оповещения для SKU шлюза приложений версии 2 (Standard_v2 и WAF_v2)

### <a name="alert-if-compute-unit-utilization-crosses-75-of-average-usage"></a>Оповещать, если использование единиц вычислений пересекается с 75% от среднего использования 

Единица вычислений — это мера использования вычислений шлюза приложений. Проверьте среднее использование единиц вычислений за последний месяц и настройте оповещение, если оно пересекается с 75%. Например, если среднее использование составляет 10 единиц вычислений, установите оповещение на 7,5 Cu. В результате оповещение сработает, если уровень вашего использования увеличится, и у вас будет время среагировать на изменение. Вы сможете увеличить минимальное число, если считаете, что возросший объем трафика сохранится, чтобы при дальнейшем увеличении получить новое оповещение. Следуйте приведенным выше рекомендациям по масштабированию, чтобы масштабировать их по мере необходимости.

### <a name="example-setting-up-an-alert-on-75-of-average-cu-usage"></a>Пример настройка оповещения на уровне 75 % от среднего показателя использования CU

В этом примере показано, как с помощью портала Azure настроить оповещение, которое сработает при достижении 75 % от среднего показателя использования CU. 
1. Перейдите к **Шлюзу приложений**.
2. На левой панели на вкладке **Мониторинг** выберите **Метрики**. 
3. Добавьте метрику **Среднее текущее число единиц вычислений**. 
4. Если вы установили минимальное число экземпляров на уровне среднего числа используемых CU, настройте оповещение, которое должно срабатывать при использовании 75 % от вашего минимального числа экземпляров. Например, если в среднем вы используете 10 CU, установите оповещение на уровне 7,5 CU. В результате оповещение сработает, если уровень вашего использования увеличится, и у вас будет время среагировать на изменение. Вы сможете увеличить минимальное число, если считаете, что возросший объем трафика сохранится, чтобы при дальнейшем увеличении получить новое оповещение. 

:::image type="content" source="./media/application-gateway-covid-guidelines/compute-unit-alert-inline.png" alt-text="Предупреждения единиц вычислений v2" lightbox="./media/application-gateway-covid-guidelines/compute-unit-alert-exp.png":::

> [!NOTE]
> Вы можете установить оповещение на более низком или высоком процентном уровне использования CU в зависимости от того, насколько чувствительна ваша система к пикам трафика.

### <a name="alert-if-capacity-unit-utilization-crosses-75-of-peak-usage"></a>Оповещать, если использование единицы мощности выходит за границы пикового использования (75%) 

Единицы мощности представляют общее использование шлюза с точки зрения пропускной способности, вычислений и числа подключений. Проверьте использование единицы максимальной емкости за последний месяц и настройте оповещение, если оно пересекается с 75%. Например, если максимальное использование составляет 100 единиц мощности, настройте оповещение на 75 cu. При необходимости выполните приведенные выше два предложения для масштабирования.

### <a name="alert-if-unhealthy-host-count-crosses-threshold"></a>Оповещать при превышении порогового значения количества неработоспособных узлов 

Эта метрика указывает количество внутренних серверов, которые шлюз приложений не может успешно протестировать. Это приведет к перехвату проблем, когда экземпляры шлюза приложений не могут подключиться к серверной части. Оповещать, если это число превышает 20% емкости серверной части. Пример: Если в настоящее время в серверном пуле имеется 30 внутренних серверов, настройте оповещение, если количество неработоспособных узлов превышает 6.

### <a name="alert-if-response-status-4xx-5xx-crosses-threshold"></a>Предупреждение, если состояние ответа (4xx, 5xx) пересекает порог 

Создавать оповещение, если состояние отклика шлюза приложения — 4xx или 5xx. В связи с временными проблемами может появиться случайный ответ 4xx или 5xx. Вы должны наблюдать за шлюзом в рабочей среде, чтобы определить статическое пороговое значение или использовать динамическое пороговое значение для предупреждения.

### <a name="alert-if-failed-requests-crosses-threshold"></a>Оповещать, если невыполненные запросы пересекаются пороговое значение 

Создать оповещение при превышении порогового значения метрики неудачных запросов. Вы должны наблюдать за шлюзом в рабочей среде, чтобы определить статическое пороговое значение или использовать динамическое пороговое значение для предупреждения.

### <a name="alert-if-backend-last-byte-response-time-crosses-threshold"></a>Оповещать, если время последнего ответа внутреннего байта серверной части превышает пороговое значение 

Эта метрика указывает интервал времени между началом установления соединения с внутренним сервером и получения последнего байта текста ответа. Создавать оповещение, если задержка ответа внутреннего сервера превышает определенный порог от обычного. Например, установите этот параметр, чтобы получать оповещения при увеличении задержки ответа внутреннего сервера более чем на 30% от обычного значения.

### <a name="alert-if-application-gateway-total-time-crosses-threshold"></a>Оповещать, если общее превышение порогового значения шлюза приложений

Это интервал времени, в течение которого шлюз приложений получает первый байт HTTP-запроса к моменту, когда последний байт ответа был отправлен клиенту. Следует создавать оповещение, если задержка ответа от внутреннего сервера больше, чем у обычного порогового значения. Например, они могут установить оповещение при увеличении общей задержки по времени более чем на 30% от обычного значения.

## <a name="set-up-waf-with-geo-filtering-and-bot-protection-to-stop-attacks"></a>Настройка WAF с географической фильтрацией и защитой Bot для отмены атак
Если вы хотите добавить дополнительный уровень защиты для своего приложения, воспользуйтесь соответствующими функциями WAF, реализованными в SKU версии 2 Шлюза приложений. SKU версии 2 можно настроить таким образом, чтобы доступ к вашим приложениям был разрешен только из определенных стран и регионов. Вы настраиваете пользовательское правило WAF, чтобы явно разрешать или блокировать трафик на основе географического расположения. Дополнительные сведения см. в статьях [пользовательские правила географической фильтрации](../web-application-firewall/ag/geomatch-custom-rules.md) и [Настройка настраиваемых правил на шлюзе приложений WAF_v2 SKU с помощью PowerShell](../web-application-firewall/ag/configure-waf-custom-rules.md).

Активируйте защиту от ботов, которая будет блокировать заведомо вредоносные боты. Это должно уменьшить трафик, поступающий в ваше приложение. Дополнительные сведения см. в [инструкциях по настройке защиты от ботов](../web-application-firewall/ag/configure-waf-custom-rules.md).

## <a name="turn-on-diagnostics-on-application-gateway-and-waf"></a>Включите диагностику Шлюза приложений и брандмауэра веб-приложения

Журналы диагностики включают журналы брандмауэра, производительности и доступа, которые можно просматривать. В Azure эти журналы можно использовать для управления шлюзами приложений и устранения возникающих в них неполадок. Дополнительные сведения см. в нашей [документации по диагностике](./application-gateway-diagnostics.md#diagnostic-logging). 

## <a name="set-up-an-tls-policy-for-extra-security"></a>Настройте политику TLS для дополнительной защиты
Используйте последнюю версию политики TLS ([AppGwSslPolicy20170401S](./application-gateway-ssl-policy-overview.md#appgwsslpolicy20170401s)). В ней реализована версия протокола TLS 1.2 и более надежные шифры. Дополнительные сведения см. в статье о [настройке версий политики TLS и комплектов шифров с помощью PowerShell](./application-gateway-configure-ssl-policy-powershell.md).