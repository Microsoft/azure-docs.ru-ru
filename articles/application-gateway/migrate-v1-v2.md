---
title: Переход с версии v1 на версию 2. шлюз приложений Azure
description: В этой статье показано, как перенести шлюз приложений Azure и брандмауэр веб-приложения с версии v1 на v2.
services: application-gateway
author: vhorne
ms.service: application-gateway
ms.topic: how-to
ms.date: 03/31/2020
ms.author: victorh
ms.openlocfilehash: 4757a8237aa6226b78e7c1e79ba50710e31d28e3
ms.sourcegitcommit: f377ba5ebd431e8c3579445ff588da664b00b36b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/05/2021
ms.locfileid: "99594271"
---
# <a name="migrate-azure-application-gateway-and-web-application-firewall-from-v1-to-v2"></a>Перенос шлюза приложений Azure и брандмауэра веб-приложения с версии v1 на v2

Теперь доступен [шлюз приложений Azure и брандмауэр веб-приложения (WAF) версии 2](application-gateway-autoscaling-zone-redundant.md) , предлагающий дополнительные функции, такие как Автомасштабирование и доступность — избыточность зоны. При этом существующие шлюзы версии 1 автоматически не обновляются до версии 2. Если вы хотите выполнить миграцию с версии v1 на версию 2, выполните действия, описанные в этой статье.

Миграция состоит из двух этапов:

1. Перенос конфигурации
2. Перенос клиентского трафика

В этой статье рассматривается миграция конфигурации. Миграция трафика клиента зависит от конкретной среды. Однако некоторые общие рекомендации [предоставляются](#migrate-client-traffic)на высоком уровне.

## <a name="migration-overview"></a>Общие сведения о переносе

Доступен сценарий Azure PowerShell, который выполняет следующие действия:

* Создает новый Standard_v2 или WAF_v2 шлюз в указанной подсети виртуальной сети.
* Без проблем копирует конфигурацию, связанную с WAF или шлюзом v1, на вновь созданный Standard_V2 или WAF_V2.

### <a name="caveatslimitations"></a>кавеатс\лимитатионс

* Новый шлюз v2 содержит новые общедоступные и частные IP-адреса. Невозможно легко переместить IP-адреса, связанные с существующим шлюзом v1, в версии 2. Однако можно выделить существующий (нераспределенный) общедоступный или частный IP-адрес для нового шлюза v2.
* Необходимо указать пространство IP-адресов для другой подсети в виртуальной сети, где находится шлюз v1. Скрипт не может создать шлюз v2 в существующих подсетях, где уже есть шлюз v1. Тем не менее, если у существующей подсети уже есть шлюз v2, это может работать при наличии достаточного пространства IP-адресов.
* Если у вас есть группа безопасности сети или определяемые пользователем маршруты, связанные с подсетью шлюза v2, убедитесь, что они соответствуют [требованиям NSG](../application-gateway/configuration-infrastructure.md#network-security-groups) и [требованиям UDR](../application-gateway/configuration-infrastructure.md#supported-user-defined-routes) для успешной миграции.
* [Политики конечных точек служб для виртуальной сети](../virtual-network/virtual-network-service-endpoint-policies-overview.md) в настоящее время не поддерживаются в подсети Шлюза приложений.
* Чтобы перенести конфигурацию TLS/SSL, необходимо указать все сертификаты TLS/SSL, используемые в шлюзе v1.
* Если для шлюза v1 включен режим FIPS, он не будет перенесен на новый шлюз v2. Режим FIPS не поддерживается в версии 2.
* Версия 2 не поддерживает IPv6, поэтому отключенные шлюзы IPv6 не переносятся. Если запустить сценарий, он может не завершиться.
* Если шлюз V1 имеет только частный IP-адрес, сценарий создает общедоступный IP-адрес и частный IP-адрес для нового шлюза v2. в настоящее время шлюзы v2 не поддерживают только частные IP-адреса.
* В приложение не передаются заголовки с именами, содержащими любые символы, кроме букв, цифр, дефисов и знаков подчеркивания. Это относится только к именам заголовков, но не к значениям заголовка. Это критическое изменение с версии v1.

## <a name="download-the-script"></a>Скачивание скрипта

Скачайте скрипт миграции из  [коллекция PowerShell](https://www.powershellgallery.com/packages/AzureAppGWMigration).

## <a name="use-the-script"></a>Использование скрипта

В зависимости от настроек и настроек локальной среды PowerShell существует два варианта.

* Если вы не установили модули Azure az или не хотите удалять модули Azure AZ, лучшим вариантом будет использование `Install-Script` параметра для запуска сценария.
* Если вам нужно разместить модули Azure AZ, лучше скачать сценарий и запустить его напрямую.

Чтобы определить, установлены ли модули Azure AZ, запустите `Get-InstalledModule -Name az` . Если вы не видите ни одного установленного модуля AZ, то можете использовать `Install-Script` метод.

### <a name="install-using-the-install-script-method"></a>Установка с помощью метода Install-Script

Чтобы использовать этот параметр, на компьютере не должны быть установлены модули Azure AZ. Если они установлены, следующая команда выводит сообщение об ошибке. Можно либо удалить модули Azure AZ, либо воспользоваться другим параметром, чтобы скачать скрипт вручную и запустить его.
  
Выполните сценарий с помощью следующей команды, чтобы получить последнюю версию:

`Install-Script -Name AzureAppGWMigration -Force`

Эта команда также устанавливает необходимые модули AZ.  

### <a name="install-using-the-script-directly"></a>Установка непосредственно с помощью скрипта

Если у вас установлены некоторые модули Azure AZ и их невозможно удалить (или не хотите удалять их), можно вручную скачать скрипт, используя вкладку **Загрузка вручную** в ссылке Загрузить скрипт. Скрипт загружается как необработанный файл nupkg. Сведения об установке скрипта из этого файла nupkg см. в разделе [Загрузка пакета вручную](/powershell/scripting/gallery/how-to/working-with-packages/manual-download).

Выполните следующее, чтобы запустить этот сценарий.

1. Используйте `Connect-AzAccount` для подключения к Azure.

1. Используйте `Import-Module Az` для импорта модулей AZ.

1. Выполните команду `Get-Help AzureAppGWMigration.ps1` , чтобы проверить необходимые параметры:

   ```
   AzureAppGwMigration.ps1
    -resourceId <v1 application gateway Resource ID>
    -subnetAddressRange <subnet space you want to use>
    -appgwName <string to use to append>
    -sslCertificates <comma-separated SSLCert objects as above>
    -trustedRootCertificates <comma-separated Trusted Root Cert objects as above>
    -privateIpAddress <private IP string>
    -publicIpResourceId <public IP name string>
    -validateMigration -enableAutoScale
   ```

   Параметры для скрипта:
   * **resourceId: [строка]: required** — это идентификатор ресурса Azure для существующего шлюза Standard v1 или WAF v1. Чтобы найти это строковое значение, перейдите к портал Azure, выберите свой шлюз приложений или ресурс WAF и щелкните ссылку **Свойства** для шлюза. Идентификатор ресурса находится на этой странице.

     Чтобы получить идентификатор ресурса, можно также выполнить следующие Azure PowerShell команды:

     ```azurepowershell
     $appgw = Get-AzApplicationGateway -Name <v1 gateway name> -ResourceGroupName <resource group Name> 
     $appgw.Id
     ```

   * **субнетаддрессранже: [строка]: обязательно** — это пространство IP-адресов, выделенное (или которое требуется выделить) для новой подсети, содержащей новый шлюз v2. Он должен быть указан в нотации CIDR. Например: 10.0.0.0/24. Вам не нужно создавать эту подсеть заранее. Скрипт создаст его, если он не существует.
   * **аппгвнаме: [строка]: необязательный**. Это строка, которую вы укажете для использования в качестве имени нового Standard_v2 или шлюза WAF_v2. Если этот параметр не указан, имя существующего шлюза v1 будет использоваться с суффиксом *_v2* добавлен.
   * **сслцертификатес: [псаппликатионгатевайсслцертификате]: необязательный**.  Разделенный запятыми список объектов Псаппликатионгатевайсслцертификате, которые создаются для представления сертификатов TLS/SSL из шлюза версии v1, должен быть передан в новый шлюз v2. Для каждого из сертификатов TLS/SSL, настроенных для шлюза Standard v1 или WAF v1, можно создать новый объект Псаппликатионгатевайсслцертификате с помощью команды, `New-AzApplicationGatewaySslCertificate` показанной здесь. Вам потребуется путь к файлу сертификата TLS/SSL и паролю.

     Этот параметр является обязательным только в том случае, если прослушиватели HTTPS не настроены для шлюза v1 или WAF. При наличии хотя бы одной установки прослушивателя HTTPS необходимо указать этот параметр.

      ```azurepowershell  
      $password = ConvertTo-SecureString <cert-password> -AsPlainText -Force
      $mySslCert1 = New-AzApplicationGatewaySslCertificate -Name "Cert01" `
        -CertificateFile <Cert-File-Path-1> `
        -Password $password 
      $mySslCert2 = New-AzApplicationGatewaySslCertificate -Name "Cert02" `
        -CertificateFile <Cert-File-Path-2> `
        -Password $password
      ```

     В `$mySslCert1, $mySslCert2` предыдущем примере в качестве значений для этого параметра в скрипте можно передать (с разделителями-запятыми).
   * **трустедрутцертификатес: [псаппликатионгатевайтрустедрутцертификате]: необязательный**. Разделенный запятыми список объектов Псаппликатионгатевайтрустедрутцертификате, которые создаются для представления [доверенных корневых сертификатов](ssl-overview.md) для проверки подлинности экземпляров серверной части из шлюза v2.
   
      ```azurepowershell
      $certFilePath = ".\rootCA.cer"
      $trustedCert = New-AzApplicationGatewayTrustedRootCertificate -Name "trustedCert1" -CertificateFile $certFilePath
      ```

      Чтобы создать список объектов Псаппликатионгатевайтрустедрутцертификате, см. раздел [New-азаппликатионгатевайтрустедрутцертификате](/powershell/module/Az.Network/New-AzApplicationGatewayTrustedRootCertificate).
   * **privateIpAddress: [строка]: необязательный**. Конкретный частный IP-адрес, который необходимо связать с новым шлюзом v2.  Это должно быть из той же виртуальной сети, которую вы выделили для нового шлюза v2. Если этот параметр не указан, сценарий выделяет частный IP-адрес для шлюза v2.
   * **публиЦипресаурцеид: [строка]: необязательный**. ResourceId существующего ресурса общедоступного IP-адреса (SKU "Стандартный") в подписке, которую нужно выделить новому шлюзу v2. Если этот параметр не указан, сценарий выделяет новый общедоступный IP-адрес в той же группе ресурсов. Имя — это имя шлюза v2 с добавленным параметром *-IP* .
   * **валидатемигратион: [Switch]: необязательный параметр**. Используйте этот параметр, если требуется, чтобы скрипт выполнял некоторые базовые проверки сравнения конфигураций после создания шлюза v2 и копии конфигурации. По умолчанию проверка не выполняется.
   * **enableAutoScale: [Switch]: необязательный параметр**. Используйте этот параметр, если вы хотите, чтобы сценарий включил автоматическое масштабирование в новом шлюзе v2 после его создания. По умолчанию автоматическое масштабирование отключено. Вы всегда можете вручную включить его позже на вновь созданном шлюзе v2.

1. Запустите скрипт, используя соответствующие параметры. Для завершения может потребоваться от 5 до семи минут.

    **Пример**

   ```azurepowershell
   AzureAppGWMigration.ps1 `
      -resourceId /subscriptions/8b1d0fea-8d57-4975-adfb-308f1f4d12aa/resourceGroups/MyResourceGroup/providers/Microsoft.Network/applicationGateways/myv1appgateway `
      -subnetAddressRange 10.0.0.0/24 `
      -appgwname "MynewV2gw" `
      -sslCertificates $mySslCert1,$mySslCert2 `
      -trustedRootCertificates $trustedCert `
      -privateIpAddress "10.0.0.1" `
      -publicIpResourceId "/subscriptions/8b1d0fea-8d57-4975-adfb-308f1f4d12aa/resourceGroups/MyResourceGroup/providers/Microsoft.Network/publicIPAddresses/MyPublicIP" `
      -validateMigration -enableAutoScale
   ```

## <a name="migrate-client-traffic"></a>Перенос клиентского трафика

Сначала убедитесь, что сценарий успешно создал новый шлюз v2 с точной конфигурацией, перенесенной из шлюза v1. Это можно проверить в портал Azure.

Кроме того, можно отправить небольшой объем трафика через шлюз v2 в качестве ручного теста.
  
Вот несколько сценариев, в которых текущий шлюз приложений (стандартный) может получать трафик клиента, и наши рекомендации по каждому из них:

* **Пользовательская зона DNS (например, contoso.com), указывающая на внешний IP-адрес (с помощью записи A), связанную со стандартным шлюзом v1 или WAF v1**.

    Вы можете обновить запись DNS, чтобы она указывала на интерфейсный IP-адрес или метку DNS, связанную с шлюзом приложений Standard_v2. В зависимости от срока жизни, настроенного для записи DNS, может потребоваться некоторое время для миграции клиентского трафика на новый шлюз v2.
* **Пользовательская зона DNS (например, contoso.com), указывающая на метку DNS (например, *myappgw.eastus.cloudapp.Azure.com* с помощью записи CNAME), связанную с шлюзом v1**.

   Есть два варианта:

  * При использовании общедоступных IP-адресов в шлюзе приложений можно выполнить контролируемую детальную миграцию с помощью профиля диспетчера трафика, чтобы постепенно маршрутизировать трафик (метод маршрутизации трафика с взвешенным трафиком) к новому шлюзу v2.

    Это можно сделать, добавив метки DNS для шлюзов приложений v1 и v2 в [профиль диспетчера трафика](../traffic-manager/traffic-manager-routing-methods.md#weighted-traffic-routing-method), а также запишите собственную запись DNS (например, `www.contoso.com` ) в домен диспетчера трафика (например, contoso.trafficmanager.NET).
  * Вы также можете обновить запись DNS личного домена, чтобы она указывала на DNS-метку нового шлюза приложений v2. В зависимости от срока жизни, настроенного для записи DNS, может потребоваться некоторое время для миграции клиентского трафика на новый шлюз v2.
* **Ваши клиенты подключаются к интерфейсному IP-адресу шлюза приложений**.

   Обновите клиенты, чтобы использовать IP-адреса, связанные с созданным шлюзом приложений v2. Рекомендуется не использовать IP-адреса напрямую. Рассмотрите возможность использования метки DNS-имени (например, yourgateway.eastus.cloudapp.azure.com), связанной с вашим шлюзом приложений, которые можно использовать для записи CNAME в собственную зону DNS (например, contoso.com).

## <a name="common-questions"></a>Часто задаваемые вопросы

### <a name="are-there-any-limitations-with-the-azure-powershell-script-to-migrate-the-configuration-from-v1-to-v2"></a>Существуют ли какие либо ограничения в сценарии Azure PowerShell для переноса конфигурации с версии v1 на версию 2?

Да. См. раздел [предостережения/ограничения](#caveatslimitations).

### <a name="is-this-article-and-the-azure-powershell-script-applicable-for-application-gateway-waf-product-as-well"></a>Является ли эта статья и Azure PowerShell сценарий, применимый к продукту WAF для шлюза приложений? 

Да.

### <a name="does-the-azure-powershell-script-also-switch-over-the-traffic-from-my-v1-gateway-to-the-newly-created-v2-gateway"></a>Также будет ли сценарий Azure PowerShell переключать трафик из шлюза v1 на только что созданный шлюз v2?

Нет. Сценарий Azure PowerShell только переносит конфигурацию. Фактический перенос трафика несет ответственность за ваш контроль.

### <a name="is-the-new-v2-gateway-created-by-the-azure-powershell-script-sized-appropriately-to-handle-all-of-the-traffic-that-is-currently-served-by-my-v1-gateway"></a>Был ли новый шлюз v2, созданный Azure PowerShellным сценарием, соответствующим образом обрабатывать весь трафик, обслуживаемый моим шлюзом v1?

Сценарий Azure PowerShell создает новый шлюз v2 с соответствующим размером для управления трафиком в существующем шлюзе v1. Автоматическое масштабирование отключено по умолчанию, но можно включить Автомасштабирование при запуске скрипта.

### <a name="i-configured-my-v1-gateway--to-send-logs-to-azure-storage-does-the-script-replicate-this-configuration-for-v2-as-well"></a>Я настроил мой шлюз v1 для отправки журналов в службу хранилища Azure. Также выполняет ли скрипт репликацию этой конфигурации для версии 2?

Нет. Скрипт не реплицирует эту конфигурацию для версии 2. Конфигурацию журнала необходимо добавить отдельно для перенесенного шлюза v2.

### <a name="does-this-script-support-certificates-uploaded-to-azure-keyvault-"></a>Этот сценарий поддерживает сертификаты, отправленные в Azure KeyVault?

Нет. В настоящее время скрипт не поддерживает сертификаты в KeyVault. Однако это относится к будущей версии.

### <a name="i-ran-into-some-issues-with-using-this-script-how-can-i-get-help"></a>При использовании этого сценария возникли проблемы. Как получить помощь?
  
Вы можете обратиться в службу поддержки Azure в разделе "Конфигурация и настройка/миграция на v2 SKU". Дополнительные сведения о [службе поддержки Azure](https://azure.microsoft.com/support/options/)см. здесь.

## <a name="next-steps"></a>Дальнейшие действия

[Дополнительные сведения о шлюзе приложений версии 2](application-gateway-autoscaling-zone-redundant.md)
