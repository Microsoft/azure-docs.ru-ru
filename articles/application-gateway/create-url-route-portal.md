---
title: Руководство по правилам маршрутизации на основе URL-пути с помощью портала — Шлюз приложений Azure
description: В этом руководстве вы узнаете, как создать правила маршрутизации на основе URL-пути для шлюза приложений и масштабируемый набор виртуальных машин с помощью портала Azure.
services: application-gateway
author: vhorne
ms.service: application-gateway
ms.topic: tutorial
ms.date: 02/23/2021
ms.author: victorh
ms.openlocfilehash: b0ab3cbd2891ef1677c0d4ba7a00821d67714b6d
ms.sourcegitcommit: f28ebb95ae9aaaff3f87d8388a09b41e0b3445b5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/29/2021
ms.locfileid: "101708957"
---
# <a name="tutorial-create-an-application-gateway-with-path-based-routing-rules-using-the-azure-portal"></a>Руководство по Создание шлюза приложений с правилами маршрутизации на основе URL-пути при помощи портала Azure | Документация Майкрософт

Для настройки [правил маршрутизации на основе URL-пути](./url-route-overview.md) при создании [шлюза приложений](./overview.md) можно использовать портал Azure. В этом руководстве мы создадим серверные пулы с использованием виртуальных машин. Затем мы создадим правила маршрутизации, которые обеспечивают поступление веб-трафика на соответствующие серверы в пуле.

Вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * Создание шлюза приложений
> * создание виртуальных машин для внутренних серверов;
> * создание серверных пулов с внутренними серверами;
> * Создание серверного прослушивателя
> * Создание правила маршрутизации на основе пути

![Пример маршрутизации для URL-адресов](./media/application-gateway-create-url-route-portal/scenario.png)


[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

## <a name="prerequisites"></a>Предварительные требования

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

## <a name="create-virtual-machines"></a>Создание виртуальных машин

В этом примере создаются три виртуальные машины, используемые в качестве внутренних серверов для шлюза приложений. Вы также установите службы IIS на виртуальных машинах, чтобы убедиться, что шлюз приложений работает должным образом.

1. Войдите на портал Azure по адресу [https://portal.azure.com](https://portal.azure.com).
1. На портале Azure выберите **Создать ресурс**.
2. Выберите **Windows Server 2016 Datacenter** в списке "Популярные".
3. Введите следующие значения для виртуальной машины:

    - **Подписка**: выберите свою подписку.
    - **Группа ресурсов**, выберите **Создать**, а затем введите *myResourceGroupAG*.
    - **Имя виртуальной машины**: *myVM1*
    - **Регион**. *Восточная часть США (США)*
    - **Имя пользователя**: введите имя пользователя.
    - **Пароль**: введите пароль.


4. Выберите **Next:Disks** (Далее: диски).
5. Выберите **Далее: сеть**
6. Для пункта **Виртуальная сеть** выберите **Создать**, а затем введите следующие значения для виртуальной сети:

   - *myVNet* — имя виртуальной сети;
   - *10.0.0.0/16* — диапазон адресов виртуальной сети;
   - *myBackendSubnet* для первого имени подсети
   - *10.0.1.0/24* — диапазон адресов подсети.
   - *myAGSubnet* для второго имени подсети.
   - *10.0.0.0/24* — диапазон адресов подсети.
7. Щелкните **ОК**.

8. Убедитесь, что в разделе **Подсеть** для подсети выбрано значение **myBackendSubnet**, а затем выберите **Далее: управление**.
9. Выберите **Отключить**, чтобы отключить диагностику загрузки.
10. Щелкните **Просмотр и создание**, проверьте параметры на странице сводной информации и нажмите кнопку **Создать**.
11. Создайте еще две виртуальные машины: *myVM2* и *myVM3* и поместите их в виртуальную сеть *MyVNet* и подсеть *myBackendSubnet*.

### <a name="install-iis"></a>Установка служб IIS

1. Откройте интерактивную оболочку и убедитесь, что для нее задано значение **PowerShell**.

    ![Установка пользовательского расширения](./media/application-gateway-create-url-route-portal/application-gateway-extension.png)

2. Чтобы установить службы IIS, выполните на виртуальной машине следующие команды: 

    ```azurepowershell
         $publicSettings = @{ "fileUris&quot; = (,&quot;https://raw.githubusercontent.com/Azure/azure-docs-powershell-samples/master/application-gateway/iis/appgatewayurl.ps1");  "commandToExecute" = "powershell -ExecutionPolicy Unrestricted -File appgatewayurl.ps1" }

        Set-AzVMExtension `
         -ResourceGroupName myResourceGroupAG `
         -Location eastus `
         -ExtensionName IIS `
         -VMName myVM1 `
         -Publisher Microsoft.Compute `
         -ExtensionType CustomScriptExtension `
         -TypeHandlerVersion 1.4 `
         -Settings $publicSettings
    ```

3. Установите службы IIS на других виртуальных машинах с помощью только что выполненных действий. В качестве значений VMName укажите *myVM2* и *myVM3* в Set-AzVMExtension.

## <a name="create-an-application-gateway"></a>Создание шлюза приложений

1. Выберите **Создать ресурс** в верхнем левом меню портала Azure. Появится окно **Создать**.

2. Выберите **Сети**, а затем в списке **Рекомендованные** выберите **Шлюз приложений**.

### <a name="basics-tab"></a>Вкладка "Основные сведения"

1. На вкладке **Основные сведения** введите значения для следующих параметров шлюза приложений.

   - **Подписка**. Выберите свою подписку.
   - **Группа ресурсов.** Выберите **myResourceGroupAG** для группы ресурсов.
   - **Имя шлюза приложений**. Введите *myAppGateway* для имени шлюза приложений.
   - **Регион** — выберите **Восточная часть США (США)** .

        ![Создание шлюза приложений: Основы](./media/application-gateway-create-gateway-portal/application-gateway-create-basics.png)

2.  В разделе **Настройка виртуальной сети** выберите **myVNet** в качестве имени виртуальной сети.
3. Выберите **myAGSubnet** для подсети.
3. Примите значения по умолчанию для других параметров и затем выберите  **Далее: интерфейсные серверы**.

### <a name="frontends-tab"></a>Вкладка "Интерфейсные серверы"

1. На вкладке **Интерфейсные серверы** убедитесь, что для параметра **Тип IP-адреса интерфейсных серверов** установлено значение **Общедоступный**.

   > [!NOTE]
   > Для этого номера SKU Шлюза приложений версии 2 можно выбрать только **общедоступную** интерфейсную IP-конфигурацию. Частная интерфейсная IP-конфигурация сейчас не поддерживается для номера SKU версии 2.

2. Выберите команду **Добавить новый** для параметра **Общедоступный IP-адрес** и введите *myAGPublicIPAddress* в качестве имени общедоступного IP-адреса. Затем нажмите кнопку **ОК**. 
3. По завершении выберите **Next: серверные компоненты**.

### <a name="backends-tab"></a>Вкладка "Серверные компоненты"

Серверный пул используется для перенаправления запросов на внутренние серверы, на которых обслуживается запрос. Внутренние пулы могут состоять из сетевых адаптеров, масштабируемых наборов виртуальных машин, общедоступных IP-адресов, внутренних IP-адресов, полных доменных имен и таких мультитенантых серверных частей, как служба приложений Azure.

1. На вкладке **Серверные компоненты** выберите элемент **Добавление серверного пула**.

2. В открывшемся окне **Добавить внутренний пул** введите следующие значения для создания пустого внутреннего пула.

    - **Name** (Имя). Введите *myBackendPool* в качестве имени внутреннего пула.
3. В разделе **Тип цели** выберите **Виртуальная машина** из раскрывающегося списка.

5. В разделе **Целевой объект** выберите сетевой интерфейс для **myVM1**.
6. Выберите **Добавить**.
7. Повторите процедуру для добавления внутреннего пула *Изображения* с *myVM2* в качестве целевого объекта и внутренний пул *Видео* с *myVM3* в качестве целевого объекта.
8. Выберите **Добавить**, чтобы сохранить конфигурацию внутреннего пула и вернуться на вкладку **Серверные компоненты**.

4. На вкладке **Серверные компоненты** выберите **Далее: конфигурация**.

### <a name="configuration-tab"></a>Вкладка "Конфигурация"

На вкладке **Конфигурация** созданный интерфейсный и внутренний пул подключается с помощью правила маршрутизации.

1. Выберите элемент **Добавление правила маршрутизации** в столбце **Правила маршрутизации**.

2. В открывшемся окне **Добавление правила маршрутизации** введите *myRoutingRule* в поле **Имя правила**.

3. Для правила маршрутизации требуется прослушиватель. На вкладке **Прослушиватель** в окне **Добавление правила маршрутизации** введите следующие значения для прослушивателя:

    - **Имя прослушивателя**. Введите *myListener* в качестве имени прослушивателя.
    - **Интерфейсный IP-адрес**. Выберите **Общедоступные**, чтобы выбрать общедоступный IP-адрес, который вы создали для интерфейсных серверов.
    - **Порт**: Тип *8080*
  
        Примите значения по умолчанию для других параметров на вкладке **Прослушиватель**, а затем выберите вкладку **Серверные целевые объекты**, чтобы настроить остальную часть правила маршрутизации.

4. На вкладке **Серверные целевые объекты** выберите значение **myBackendPool** для параметра **Серверный целевой объект**.

5. Для **Параметр HTTP** выберите **Добавить**, чтобы создать параметр HTTP. Параметр HTTP будет определять поведение правила маршрутизации. 

6. В открывшемся окне **Добавление параметра HTTP** введите *myHTTPSetting* в поле **Имя параметра HTTP**. Примите значения по умолчанию для других параметров в окне **Добавление параметра HTTP**, затем выберите **Добавить**, чтобы вернуться к окну **Добавление правила маршрутизации**.
7. В разделе **Маршрутизация на основе пути** выберите **Добавить несколько целевых объектов, чтобы создать правило на основе пути**.
8. Для пункта **Путь** введите */изображения/* \*.
9. Для пункта **Имя целевого объекта** введите *Изображения*.
10. Для пункта **Параметр HTTP** выберите **myHTTPSetting**
11. Для пункта **Серверный целевой объект**, выберите **Изображения**.
12. Выберите **Добавить**, чтобы сохранить правило пути и вернуться на вкладку **Добавление правила маршрутизации**.
13. Повторите, чтобы добавить еще одно правило для видео.
14. Выберите **Добавить**, чтобы добавить правило маршрутизации и вернитесь на вкладку **Конфигурация**.
15. По завершении выберите **Next: Теги** , а затем **Далее: Отзыв и создание**.

> [!NOTE]
> Вам не нужно добавлять настраиваемое правило пути */* * для обработки случаев по умолчанию. Оно автоматически обрабатывается внутренним пулом по умолчанию.

### <a name="review--create-tab"></a>Вкладка "Просмотр и создание"

Просмотрите параметры на вкладке **Просмотр и создание**, а затем выберите **Создать**, чтобы создать виртуальную сеть, общедоступный IP-адрес и шлюз приложения. Создание шлюза приложений в Azure может занять несколько минут. Дождитесь успешного завершения развертывания перед переходом к следующему разделу.


## <a name="test-the-application-gateway"></a>Тестирование шлюза приложений

1. Выберите **Все ресурсы**, а затем — **myAppGateway**.

    ![Запись общедоступного IP-адреса шлюза приложений](./media/application-gateway-create-url-route-portal/application-gateway-record-ag-address.png)

2. Скопируйте общедоступный IP-адрес и вставьте его в адресную строку браузера. Например, http:\//52.188.72.175:8080.

    ![Тестирование базового URL-адреса в шлюзе приложений](./media/application-gateway-create-url-route-portal/application-gateway-iistest.png)

   Прослушиватель на порте 8080 направляет этот запрос во внутренний пул по умолчанию.

3. Измените URL-адрес на *http://&lt;ip-address&gt;:8080/images/test.htm*, заменив &lt;ip-address&gt; вашим IP-адресом. Вы должны увидеть что-то вроде следующего примера:

    ![Тестирование URL-адреса изображений в шлюзе приложений](./media/application-gateway-create-url-route-portal/application-gateway-iistest-images.png)

   Прослушиватель на порте 8080 направляет этот запрос во внутренний пул *Изображения*.

4. Измените URL-адрес на *http://&lt;ip-address&gt;:8080/images/test.htm*, заменив &lt;ip-address&gt; вашим IP-адресом. Вы должны увидеть что-то вроде следующего примера:

    ![Тестирование URL-адреса видео в шлюзе приложений](./media/application-gateway-create-url-route-portal/application-gateway-iistest-video.png)

   Прослушиватель на порте 8080 направляет этот запрос во внутренний пул *Видео*.

## <a name="clean-up-resources"></a>Очистка ресурсов

Если группа ресурсов и связанные с ней ресурсы вам больше не нужны, их можно удалить. Для этого выберите группу ресурсов и щелкните **Удалить группу ресурсов**.

## <a name="next-steps"></a>Дальнейшие действия

> [!div class="nextstepaction"]
> [Завершение сеанса TLS и сквозное шифрование TLS в Шлюзе приложений Azure](./ssl-overview.md)