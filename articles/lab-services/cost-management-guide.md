---
title: Руководство по управлению затратами для служб лаборатории Azure
description: Изучите различные способы просмотра затрат для служб лаборатории.
author: rbest
ms.author: rbest
ms.date: 08/16/2020
ms.topic: article
ms.openlocfilehash: 29f6be5319c5a142ad3ea0d73deb2f95d8cb0d7a
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "94659732"
---
# <a name="cost-management-for-azure-lab-services"></a>Управление затратами для служб лаборатории Azure

Для служб лаборатории Azure управление затратами можно разделить на две разные области: Оценка затрат и анализ затрат. Оценка затрат происходит при настройке лаборатории, чтобы убедиться в том, что начальная структура лаборатории будет соответствовать ожидаемому бюджету. Анализ затрат обычно происходит в конце месяца, чтобы определить необходимые действия для следующего месяца.

## <a name="estimate-the-lab-costs"></a>Оценка затрат на лабораторию

Каждая панель мониторинга лаборатории содержит затраты & раздел, в котором **выставляется** приблизительная оценка того, что лаборатория будет стоить в течение месяца. Оценка затрат суммирует использование часов с максимальным числом пользователей по предполагаемым затратам в час. Чтобы получить наиболее точную оценку, настройте лабораторию, включая [Расписание](how-to-create-schedules.md). На панели мониторинга будут отражены оценочные затраты. 

Эта оценка может не показывать все возможные затраты. Не включается несколько ресурсов:

- Стоимость подготовки шаблона. Это может значительно варьироваться в течение времени, необходимого для создания шаблона. Стоимость запуска шаблона равна общей стоимости лаборатории в час. 
- Любые [Общие затраты на коллекцию образов](how-to-use-shared-image-gallery.md) , так как коллекция может совместно использоваться несколькими лабораториями. 
- Часы, когда создатель лаборатории запускает виртуальную машину.

> [!div class="mx-imgBorder"]
> ![Снимок экрана, на котором показана оценка затрат на панель мониторинга.](./media/cost-management-guide/dashboard-cost-estimation.png)

## <a name="analyze-the-previous-months-usage"></a>Анализ использования за предыдущий месяц

Анализ затрат предназначен для просмотра использования за предыдущий месяц, чтобы помочь вам определить любые корректировки для лаборатории. Вы можете найти декомпозицию прошлых затрат в [анализе стоимости подписки](../cost-management-billing/costs/quick-acm-cost-analysis.md). В портал Azure можно ввести **подписки** в поле поиска, а затем выбрать параметр **подписки** . 

> [!div class="mx-imgBorder"]
> ![Снимок экрана, на котором показаны поле поиска и параметр "подписки".](./media/cost-management-guide/subscription-search.png)

Выберите конкретную подписку, которую необходимо проверить.

> [!div class="mx-imgBorder"]
> ![Снимок экрана, на котором показан выбор подписки.](./media/cost-management-guide/subscription-select.png)

На левой панели в разделе " **Управление затратами**" выберите **анализ затрат** .

> [!div class="mx-imgBorder"]
> ![Снимок экрана, на котором показан анализ стоимости подписки на диаграмме.](./media/cost-management-guide/subscription-cost-analysis.png)

Эта панель мониторинга обеспечивает подробный анализ затрат, включая возможность экспорта в различные типы файлов по расписанию. Дополнительные сведения см. в разделе [Управление затратами и общие сведения о выставлении счетов](../cost-management-billing/cost-management-billing-overview.md).

Можно выполнить фильтрацию по типу ресурса. `microsoft.labservices/labaccounts`При использовании будут отображаться только затраты, связанные со службами лаборатории.

## <a name="understand-the-usage"></a>Сведения об использовании

На следующем снимке экрана показан пример анализа затрат.

> [!div class="mx-imgBorder"]
> ![Снимок экрана, на котором показан пример анализа затрат для подписки.](./media/cost-management-guide/cost-analysis.png)

По умолчанию существует шесть столбцов: **ресурс**, **тип ресурса**, **Расположение**, **имя группы ресурсов**, **теги** и **стоимость**. Столбец **ресурсов** содержит сведения об учетной записи лаборатории, имени лаборатории и виртуальной машине. Строки, отображающие учетную запись лаборатории, имя лаборатории и значения по умолчанию (вторая и третья строки), являются затратами на лабораторию. На используемых виртуальных машинах есть затраты на отображение строк, отображающих учетную запись лаборатории, имя лаборатории, значение по умолчанию и имя виртуальной машины. 

В этом примере при добавлении первой и второй строк (начинающихся с **ааалаб/доккерлаб**) будет предоставлена общая стоимость лаборатории "доккерлаб" в учетной записи лаборатории "ааалаб".

Чтобы получить общую стоимость коллекции образов, измените тип ресурса на `Microsoft.Compute/Galleries` . Коллекция общих образов может не отображаться в затратах в зависимости от места хранения коллекции.

> [!NOTE]
> Коллекция общих образов подключена к учетной записи лаборатории. Это означает, что несколько лабораторий могут использовать одно и то же изображение.

## <a name="separate-the-costs"></a>Разделите затраты

Некоторые университеты использовали учетную запись лаборатории и группу ресурсов в качестве способов разделения классов. Каждый класс имеет собственную учетную запись лаборатории и группу ресурсов. 

На панели анализ затрат добавьте фильтр на основе имени группы ресурсов с соответствующим именем группы ресурсов для класса. Затем будут видны только затраты для этого класса. Это позволяет более четко выровнять классы при просмотре затрат. Можно использовать функцию [запланированного экспорта](../cost-management-billing/costs/tutorial-export-acm-data.md) анализа затрат, чтобы загрузить затраты каждого класса в отдельные файлы.

## <a name="manage-costs"></a>Управление затратами

В зависимости от типа класса существуют способы управления затратами для сокращения количества экземпляров виртуальных машин, работающих без учащегося.

### <a name="automatic-shutdown-settings-for-cost-control"></a>Параметры автоматического завершения работы для управления затратами

Функции автоматического завершения работы позволяют предотвратить непотребленные часы использования виртуальных машин в лабораториях. Следующие параметры захватывают большую часть случаев, когда пользователи случайно оставляют свои виртуальные машины.

> [!div class="mx-imgBorder"]
> ![Снимок экрана, на котором показаны три параметра автоматического завершения работы.](./media/cost-management-guide/auto-shutdown-disconnect.png)

Эти параметры можно настроить как на уровне учетной записи лаборатории, так и на уровне лаборатории. Если включить их на уровне учетной записи лаборатории, они будут применены ко всем лабораториям в учетной записи лаборатории. Для всех новых учетных записей лаборатории эти параметры включены по умолчанию. 

#### <a name="automatically-disconnect-users-from-virtual-machines-that-the-os-deems-idle"></a>Автоматическое отключение пользователей от виртуальных машин, которые операционная система считает неактивными

> [!NOTE]
> Этот параметр доступен только для виртуальных машин Windows.

Если параметр " **Отключить пользователей при отключении виртуальных машин** " включен, то пользователь отключается от всех машин в лаборатории, когда операционная система Windows считает, что сеанс бездействует (включая шаблоны виртуальных машин). [Определение периода простоя ОС Windows](/windows/win32/taskschd/task-idle-conditions#detecting-the-idle-state) использует два критерия: 

* Отсутствие пользователя. ввод с клавиатуры или мыши не осуществляется.
* Недостаток использования ресурсов: все процессоры и все диски были неактивны в течение определенного процента времени.

Пользователи увидят примерно такое сообщение на виртуальной машине, прежде чем они будут отключены: 

> [!div class="mx-imgBorder"]
> ![Снимок экрана, на котором показано предупреждающее сообщение о том, что сеанс находится в состоянии простоя и будет отключен.](./media/cost-management-guide/idle-timer-expired.png)
 
Виртуальная машина все еще работает, когда пользователь отключен. Если пользователь подключится к виртуальной машине, войдя в систему, Windows или файлы, которые были открыты или работают, не сохраненные до отключения, будут по-прежнему существовать. В этом состоянии, так как виртуальная машина работает, она по-прежнему считается активной и начисляется стоимость. 
 
Чтобы автоматически завершить работу неактивных виртуальных машин Windows, которые отключены, используйте сочетание отключенных **пользователей, когда виртуальные машины бездействуют** и **завершают работу виртуальных машин при отключении параметров пользователей** .

Например, если настроить параметры следующим образом:
 
* **Отключать пользователей при бездействии виртуальных машин**: 15 минут после обнаружения состояния простоя.
* **Завершать работу виртуальных машин, когда пользователи отключаются**: 5 минут после отключения пользователя.
 
После того как пользователь прекратит их использовать, виртуальные машины Windows будут автоматически завершать работу через 20 минут. 
 
> [!div class="mx-imgBorder"]
> ![Схема, на которой показана комбинация параметров, приводящих к автоматическому завершению работы виртуальной машины.](./media/cost-management-guide/vm-idle-diagram.png)

#### <a name="automatically-shut-down-virtual-machines-when-users-disconnect"></a>Автоматически завершать работу виртуальных машин при отключении пользователей
 
При отключении параметров **пользователей виртуальные машины** поддерживают виртуальные машины Windows и Linux. Если этот параметр включен, автоматическое завершение работы будет происходить в следующих случаях:
 
* Для Windows подключение удаленный рабочий стол (RDP) отключено.
* Для Linux подключение SSH отключено.
 
> [!NOTE]
> Поддерживаются только [определенные дистрибутивы и версии Linux](../virtual-machines/extensions/diagnostics-linux.md#supported-linux-distributions) .
 
Вы можете указать, как долго виртуальные машины должны ожидать повторного подключения пользователя перед автоматическим завершением работы. 

#### <a name="automatically-shut-down-virtual-machines-that-are-started-but-users-dont-connect"></a>Автоматически завершать работу виртуальных машин, которые запущены, но не подключаются
 
В лаборатории пользователь может запустить виртуальную машину, но не подключаться к ней. Пример:
 
* Расписание в лаборатории запускает все виртуальные машины для сеанса класса, но некоторые учащиеся не отображаются и не подключаются к их компьютерам. 
* Пользователь запускает виртуальную машину, но забывает подключиться. 
 
**Если параметр завершить работу виртуальных машин, не подключенных пользователями** , будет перехватывать эти случаи и автоматически завершать работу виртуальных машин. 
 
Сведения о настройке и включении автоматического завершения работы виртуальных машин при отключении см. в следующих статьях:

* [Настройка автоматического завершения работы виртуальных машин для учетной записи лаборатории](how-to-configure-lab-accounts.md)
* [Настройка автоматического завершения работы виртуальных машин для лаборатории](how-to-enable-shutdown-disconnect.md)

### <a name="scheduled-time-vs-quota-time"></a>Запланированное время и квота

Понимание [запланированного времени](classroom-labs-concepts.md#schedules) и [квоты](classroom-labs-concepts.md#quota) поможет вам настроить лабораторию в соответствии с потребностями профессор и учащихся. 

Запланированное время — это время, когда все виртуальные машины учащихся запущены и доступны для подключения. Запланированное время обычно используется, когда у всех учащихся есть собственные виртуальные машины и они выполняются в течение определенного времени в течение дня (например, в часы класса). Недостаток состоит в том, что все виртуальные машины учащихся запущены и начисляются расходы, даже если учащийся не входит в виртуальную машину. 

Время квоты — это время, выделенное каждому студенту для использования по собственному усмотрению и часто используемое для независимого изучения. Виртуальные машины не запускаются, пока учащийся не запустит виртуальную машину. 

В лаборатории может использоваться либо время квоты, либо запланированное время, либо их сочетание. Если классу не требуется запланированное время, используйте только время квоты для наиболее эффективного использования виртуальных машин.

### <a name="scheduled-event-stop-only"></a>Запланированное событие: только с остановкой

В расписании можно добавить тип событий «только для отмены», который будет прекращать выполнение всех компьютеров в определенное время. Некоторые владельцы лаборатории настроили событие «только для остановки» для каждого дня в полночь, чтобы снизить затраты и использование квот, когда студент забыл завершить работу виртуальной машины, которую они используют. Недостаток этого типа событий заключается в том, что все виртуальные машины будут закрыты, даже если учащийся использует виртуальную машину.

### <a name="other-costs-related-to-labs"></a>Другие затраты, связанные с лабораториями 

Некоторые затраты не переводятся в службы лаборатории, но могут быть привязаны к службам лаборатории. Вы можете подключить общую галерею образов к лаборатории, но она не покажет затраты на службы лаборатории и не будет иметь затрат. Чтобы снизить общие затраты, следует удалить все неиспользуемые образы из коллекции, так как эти образы имеют стоимость хранения. 

Лаборатории могут иметь подключения к другим ресурсам Azure через виртуальную сеть. При удалении лаборатории необходимо удалить виртуальную сеть и другие ресурсы.

## <a name="conclusion"></a>Заключение

Надеюсь, информация в этой статье посвящена более глубокому пониманию средств, которые помогут сократить затраты на использование.