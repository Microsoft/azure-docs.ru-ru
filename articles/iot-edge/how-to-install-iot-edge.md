---
title: Установка Azure IoT Edge | Документация Майкрософт
description: Azure IoT Edge инструкции по установке на устройствах Windows или Linux
author: kgremban
manager: philmea
ms.reviewer: veyalla
ms.service: iot-edge
services: iot-edge
ms.topic: conceptual
ms.date: 01/20/2021
ms.author: kgremban
ms.openlocfilehash: ab783d6cb20f1c2fe31e8556dc57999df20d5637
ms.sourcegitcommit: 484f510bbb093e9cfca694b56622b5860ca317f7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/21/2021
ms.locfileid: "98629816"
---
# <a name="install-or-uninstall-azure-iot-edge-for-linux"></a>Установка или удаление Azure IoT Edge для Linux

Среда выполнения Azure IoT Edge превращает устройство в устройство IoT Edge. Среду выполнения можно развернуть на всех устройствах — от небольшого Raspberry Pi до технического сервера. После настройки устройства с помощью среды выполнения IoT Edge можно приступить к развертыванию в ней бизнес-логики из облака. Дополнительные сведения см. [в разделе Знакомство со средой выполнения Azure IOT EDGE и ее архитектурой](iot-edge-runtime.md).

В этой статье перечислены действия по установке среды выполнения Azure IoT Edge на устройствах Linux.

## <a name="prerequisites"></a>Предварительные требования

* [Зарегистрированный идентификатор устройства](how-to-register-device.md)

  Если вы зарегистрировали устройство с помощью проверки подлинности с симметричным ключом, строка подключения устройства будет готова.

  Если вы зарегистрировали устройство с помощью самозаверяющего сертификата X. 509, у вас должен быть по крайней мере один из сертификатов удостоверений, которые использовались для регистрации устройства, и соответствующий закрытый ключ, доступный на вашем устройстве.

* Устройство Linux

  Наличие устройства Linux x64, ARM32 или ARM64. Корпорация Майкрософт предоставляет установочные пакеты для Ubuntu Server 16,04, Ubuntu Server 18,04 и Raspberry Pi ОС растягивать операционные системы.

  Последние сведения о том, какие операционные системы в настоящее время поддерживаются в рабочих сценариях, см. в разделе [Azure IOT Edge Поддерживаемые системы](support.md#operating-systems) .

  >[!NOTE]
  >Поддержка устройств ARM64 доступна в [общедоступной предварительной версии](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).

* Подготовьте устройство для доступа к пакетам установки Майкрософт.

  Установите конфигурацию репозитория, соответствующую операционной системе устройства.

  * **Ubuntu Server 16.04**:

    ```bash
    curl https://packages.microsoft.com/config/ubuntu/16.04/multiarch/prod.list > ./microsoft-prod.list
    ```

  * **Ubuntu Server 18.04**:

    ```bash
    curl https://packages.microsoft.com/config/ubuntu/18.04/multiarch/prod.list > ./microsoft-prod.list
    ```

  * **Raspberry Pi OS Stretch**:

    ```bash
    curl https://packages.microsoft.com/config/debian/stretch/multiarch/prod.list > ./microsoft-prod.list
    ```

  Скопируйте созданный список в каталог sources.list.d.

  ```bash
  sudo cp ./microsoft-prod.list /etc/apt/sources.list.d/
  ```

  Установите открытый ключ Microsoft GPG.

  ```bash
  curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg
  sudo cp ./microsoft.gpg /etc/apt/trusted.gpg.d/
  ```

Azure IoT Edge пакеты программного обеспечения подчиняются условиям лицензии, расположенным в каждом пакете ( `usr/share/doc/{package-name}` или в `LICENSE` каталоге). Прочтите условия лицензионного соглашения перед использованием пакета. Установка и использование пакета является принятием этих условий. Если вы не согласны с условиями лицензии, не используйте этот пакет.

## <a name="install-a-container-engine"></a>Установка подсистемы контейнеров

Служба Azure IoT Edge использует среду выполнения контейнера, совместимую с OCI. Для рабочих сценариев рекомендуется использовать подсистему значок Кита. Подсистема значок Кита — это единственный механизм контейнеров, официально поддерживаемый Azure IoT Edge. Образы контейнеров Docker (Community Edition или Enterprise Edition) совместимы со средой выполнения Moby.

Обновите списки пакетов на устройстве.

   ```bash
   sudo apt-get update
   ```

Установите модуль Moby.

   ```bash
   sudo apt-get install moby-engine
   ```

Если при установке подсистемы контейнеров значок Кита возникают ошибки, проверьте совместимость ядра Linux с значок Кита. Некоторые производители встраиваемых устройств доставляют образы устройств, которые содержат пользовательские ядра Linux, без функций, необходимых для совместимости с модулем контейнеров. Выполните следующую команду, которая использует [Скрипт Check-config](https://github.com/moby/moby/blob/master/contrib/check-config.sh) , предоставленный значок Кита, для проверки конфигурации ядра:

   ```bash
   curl -sSL https://raw.githubusercontent.com/moby/moby/master/contrib/check-config.sh -o check-config.sh
   chmod +x check-config.sh
   ./check-config.sh
   ```

В выходных данных скрипта убедитесь, что все элементы в разделе `Generally Necessary` и `Network Drivers` включены. Если функции отсутствуют, включите их, перестройте ядро из источника и выберите связанные модули для включения в соответствующий файл kernel. config. Аналогичным образом, если вы используете генератор конфигурации ядра `defconfig` , например или `menuconfig` , найдите и включите соответствующие функции и перестройте ядро соответствующим образом. После развертывания недавно измененного ядра запустите сценарий Check-config еще раз, чтобы убедиться, что все необходимые компоненты были успешно включены.

## <a name="install-the-iot-edge-security-daemon"></a>Установка управляющей программы IoT Edge Security

Управляющая программа IoT Edge безопасности предоставляет и поддерживает стандарты безопасности на устройстве IoT Edge. Управляющая программа запускается при каждой загрузке устройства и перезагружает устройство, запуская остальные компоненты среды выполнения IoT Edge.

Действия, описанные в этом разделе, представляют типичный процесс установки последней версии на устройстве с подключением к Интернету. Если необходимо установить определенную версию, например предварительную версию или установить ее в автономном режиме, следуйте инструкциям по [установке автономной или конкретной версии](#offline-or-specific-version-installation-optional) в следующем разделе.

Обновите списки пакетов на устройстве.

   ```bash
   sudo apt-get update
   ```

Проверьте, какие версии IoT Edge доступны.

   ```bash
   apt list -a iotedge
   ```

Если вы хотите установить последнюю версию управляющей программы безопасности, используйте следующую команду, которая также устанавливает последнюю версию пакета **либиоссм-STD** :

   ```bash
   sudo apt-get install iotedge
   ```

Или, если требуется установить определенную версию управляющей программы безопасности, укажите версию из списка APT. Также укажите ту же версию для пакета **либиоссм-STD** , которая в противном случае установит последнюю версию. Например, следующая команда устанавливает последнюю версию выпуска 1.0.10:

   ```bash
   sudo apt-get install iotedge=1.0.10* libiothsm-std=1.0.10*
   ```

Если версия, которую требуется установить, отсутствует в списке, выполните действия по [установке автономной или конкретной версии](#offline-or-specific-version-installation-optional) далее в этой статье. В этом разделе показано, как ориентироваться на любую предыдущую версию управляющей программы IoT Edge или версии-кандидата.

## <a name="provision-the-device-with-its-cloud-identity"></a>Подготавливает устройство к облачному удостоверению

Теперь, когда модуль контейнера и среда выполнения IoT Edge установлены на устройстве, вы готовы к следующему этапу, который заключается в настройке устройства с удостоверением облака и сведениями о проверке подлинности.

Выберите следующий раздел в зависимости от типа проверки подлинности, который вы хотите использовать:

* [Вариант 1. Проверка подлинности с симметричными ключами](#option-1-authenticate-with-symmetric-keys)
* [Вариант 2. Проверка подлинности с помощью сертификатов X. 509](#option-2-authenticate-with-x509-certificates)

### <a name="option-1-authenticate-with-symmetric-keys"></a>Вариант 1. Проверка подлинности с симметричными ключами

На этом этапе среда выполнения IoT Edge установлена на устройстве Linux, и вам необходимо настроить устройство с удостоверением облака и сведениями о проверке подлинности.

В этом разделе рассматриваются шаги по подготовке устройства с проверкой подлинности с помощью симметричного ключа. Вы должны зарегистрировать устройство в центре Интернета вещей и получить строку подключения из сведений об устройстве. В противном случае выполните действия, описанные в разделе [Регистрация устройства IOT EDGE в центре Интернета вещей](how-to-register-device.md).

На IoT Edge устройстве откройте файл конфигурации.

   ```bash
   sudo nano /etc/iotedge/config.yaml
   ```

Найдите конфигурации подготовки файла и раскомментируйте раздел **Manual provisioning configuration using a connection string** (Настройка подготовки вручную с помощью строки подключения).

   ```yml
   # Manual provisioning configuration using a connection string
   provisioning:
     source: "manual"
     device_connection_string: "<ADD DEVICE CONNECTION STRING HERE>"
     dynamic_reprovisioning: false
   ```

Замените значение **device_connection_string** строкой подключения для устройства IoT Edge. Убедитесь, что все остальные разделы подготовки записываются в комментарий. Убедитесь, что **Подготовка:** строка не имеет предшествующих пробелов, а вложенные элементы имеют отступ в два пробела.

Чтобы вставить содержимое буфера обмена в Nano, нажмите клавиши `Shift+Right Click` или `Shift+Insert`.

Сохраните файл и закройте его.

   `CTRL + X`, `Y`, `Enter`

Когда введете сведения о подготовке в файл конфигурации, перезапустите управляющую программу:

   ```bash
   sudo systemctl restart iotedge
   ```

### <a name="option-2-authenticate-with-x509-certificates"></a>Вариант 2. Проверка подлинности с помощью сертификатов X. 509

На этом этапе среда выполнения IoT Edge установлена на устройстве Linux, и вам необходимо настроить устройство с удостоверением облака и сведениями о проверке подлинности.

В этом разделе рассматриваются шаги по подготовке устройства с проверкой подлинности на основе сертификата X. 509. Вы должны зарегистрировать устройство в центре Интернета вещей, предоставив отпечатки, соответствующие сертификату и закрытому ключу, расположенным на устройстве IoT Edge. В противном случае выполните действия, описанные в разделе [Регистрация устройства IOT EDGE в центре Интернета вещей](how-to-register-device.md).

На IoT Edge устройстве откройте файл конфигурации.

   ```bash
   sudo nano /etc/iotedge/config.yaml
   ```

Найдите раздел конфигурации подготовки файла и раскомментируйте **конфигурацию ручной подготовки с помощью раздела сертификат удостоверения X. 509** . Убедитесь, что все остальные разделы подготовки записываются в комментарий. Убедитесь, что **Подготовка:** строка не имеет предшествующих пробелов, а вложенные элементы имеют отступ в два пробела.

   ```yml
   # Manual provisioning configuration using a connection string
   provisioning:
     source: "manual"
     authentication:
       method: "x509"
       iothub_hostname: "<REQUIRED IOTHUB HOSTNAME>"
       device_id: "<REQUIRED DEVICE ID PROVISIONED IN IOTHUB>"
       identity_cert: "<REQUIRED URI TO DEVICE IDENTITY CERTIFICATE>"
       identity_pk: "<REQUIRED URI TO DEVICE IDENTITY PRIVATE KEY>"
     dynamic_reprovisioning: false
   ```

Обновите следующие поля:

* **iothub_hostname**: имя узла центра Интернета вещей, к которому будет подключено устройство. Например, `{IoT hub name}.azure-devices.net`.
* **DEVICE_ID**— идентификатор, указанный при регистрации устройства.
* **identity_cert**: универсальный код ресурса (URI) для сертификата удостоверения на устройстве. Например, `file:///path/identity_certificate.pem`.
* **identity_pk**: URI файла закрытого ключа для предоставленного сертификата удостоверения. Например, `file:///path/identity_key.pem`.

Сохраните файл и закройте его.

   `CTRL + X`, `Y`, `Enter`

Когда введете сведения о подготовке в файл конфигурации, перезапустите управляющую программу:

   ```bash
   sudo systemctl restart iotedge
   ```

## <a name="verify-successful-configuration"></a>Проверка успешной настройки

Убедитесь, что среда выполнения успешно установлена и настроена на устройстве IoT Edge.

1. Убедитесь, что управляющая программа безопасности IoT Edge выполняется как системная служба.

   ```bash
   sudo systemctl status iotedge
   ```

   >[!TIP]
   >Для запуска команд `iotedge` требуется более высокий уровень привилегий. После установки среды выполнения IoT Edge, выхода из компьютера и обратного входа ваши разрешения обновляются автоматически. До этого момента используйте перед командой префикс `sudo`.

2. Если нужно устранить неполадки со службой, извлеките журналы службы.

   ```bash
   journalctl -u iotedge
   ```

3. Используйте `check` средство для проверки конфигурации и состояния подключения устройства.

   ```bash
   sudo iotedge check
   ```

   >[!TIP]
   >Всегда используйте `sudo` для запуска средства проверки даже после обновления разрешений. Средство требует повышенных привилегий для доступа к файлу **config. YAML** для проверки состояния конфигурации.

4. Просмотрите данные обо всех модулях, запущенных на устройстве IoT Edge. Когда служба запускается впервые, вы должны увидеть только запущенный модуль **edgeAgent** . Модуль edgeAgent запускается по умолчанию и позволяет установить и запустить любые дополнительные модули, развертываемые на устройстве.

   ```bash
   sudo iotedge list
   ```

## <a name="offline-or-specific-version-installation-optional"></a>Установка в автономном режиме или с определенной версией (необязательно)

Действия, описанные в этом разделе, предназначены для сценариев, не охваченных стандартными шагами установки. Это может быть:

* Установка IoT Edge в автономном режиме
* Установка версии-кандидата

Если требуется установить определенную версию среды выполнения Azure IoT Edge, которая недоступна через, выполните действия, описанные в этом разделе `apt-get install` . Список пакетов Майкрософт содержит только ограниченный набор последних версий и их подверсий, поэтому эти действия предназначены для всех, кто хочет установить более старую версию или версию-кандидат.

С помощью фигурных команд можно ориентироваться на файлы компонентов непосредственно из репозитория IoT Edge GitHub.

1. Перейдите к [Azure IOT Edge выпускам](https://github.com/Azure/azure-iotedge/releases)и найдите целевую версию для выпуска.

2. Разверните раздел **активы** для этой версии.

3. Каждый выпуск должен иметь новые файлы для управляющей программы IoT Edge безопасности и хсмлиб. Используйте следующие команды для обновления этих компонентов.

   1. Найдите файл **либиоссм-STD** , соответствующий архитектуре устройства IOT Edge. Щелкните ссылку на файл правой кнопкой мыши и скопируйте адрес ссылки.

   2. Чтобы установить эту версию хсмлиб, используйте скопированную ссылку в следующей команде:

      ```bash
      curl -L <libiothsm-std link> -o libiothsm-std.deb && sudo dpkg -i ./libiothsm-std.deb
      ```

   3. Найдите файл **iotedge** , соответствующий архитектуре устройства IOT Edge. Щелкните ссылку на файл правой кнопкой мыши и скопируйте адрес ссылки.

   4. Используйте ссылку копировать в следующей команде, чтобы установить эту версию управляющей программы IoT Edge безопасности.

      ```bash
      curl -L <iotedge link> -o iotedge.deb && sudo dpkg -i ./iotedge.deb
      ```

Теперь, когда модуль контейнера и среда выполнения IoT Edge установлены на устройстве, можно перейти к следующему этапу, который предназначен для [подготовки устройства с удостоверением облака](#provision-the-device-with-its-cloud-identity).

## <a name="uninstall-iot-edge"></a>Удаление IoT Edge

Если вы хотите удалить IoT Edge установку с устройства, используйте следующие команды.

Удалите среду выполнения IoT Edge.

```bash
sudo apt-get remove --purge iotedge
```

При удалении среды выполнения IoT Edge все созданные контейнеры останавливаются, но остаются на устройстве. Просмотрите все контейнеры, чтобы увидеть, какие из них остаются.

```bash
sudo docker ps -a
```

Удалите контейнеры с устройства, включая два контейнера в среде выполнения.

```bash
sudo docker rm -f <container name>
```

Наконец, удалите среду выполнения контейнера с устройства.

```bash
sudo apt-get remove --purge moby-cli
sudo apt-get remove --purge moby-engine
```

## <a name="next-steps"></a>Дальнейшие действия

Продолжайте [развертывать модули IOT Edge](how-to-deploy-modules-portal.md) , чтобы узнать, как развернуть модули на устройстве.
