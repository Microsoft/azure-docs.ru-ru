---
title: Двойников модуля мониторинга — Azure IoT Edge
description: Как интерпретировать двойников устройства и двойников модуля для определения подключения и работоспособности.
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 05/29/2020
ms.topic: conceptual
ms.reviewer: veyalla
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: 0b7013979199eefa873a651d99e87dc8b2c47856
ms.sourcegitcommit: 5f32f03eeb892bf0d023b23bd709e642d1812696
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/12/2021
ms.locfileid: "103201595"
---
# <a name="monitor-module-twins"></a>Мониторинг двойников модулей

[!INCLUDE [iot-edge-version-all-supported](../../includes/iot-edge-version-all-supported.md)]

Модуль двойников в центре Интернета вещей Azure обеспечивает мониторинг подключения и работоспособности IoT Edge развертываний. Модуль двойников хранит полезную информацию о производительности работающих модулей в центре Интернета вещей. [Агент IOT Edge](iot-edge-runtime.md#iot-edge-agent) и модули среды выполнения [центра IOT Edge](iot-edge-runtime.md#iot-edge-hub) , каждый из которых поддерживает свой модуль `$edgeAgent` двойников `$edgeHub` и соответственно:

* `$edgeAgent` содержит данные о работоспособности и подключении для модулей среды выполнения агента IoT Edge и центра IoT Edge, а также пользовательских модулей. Агент IoT Edge отвечает за развертывание модулей, их мониторинг и отправку отчетов о состоянии подключения в центр Интернета вещей Azure.
* `$edgeHub` содержит данные о взаимодействии между центром IoT Edge, работающим на устройстве, и центром Интернета вещей Azure. Сюда входит обработка входящих сообщений от подчиненных устройств. Концентратор IoT Edge отвечает за обработку обмена данными между центром Интернета вещей Azure и устройствами IoT Edge и модулями.

Данные организованы в метаданные, теги, а также требуемые и сообщаемые наборы свойств в структурах JSON двойников модуля. Требуемые свойства, указанные в файле deployment.js, копируются в модуль двойников. Агент IoT Edge и центр IoT Edge каждый из них обновляет сообщаемые свойства для своих модулей.

Аналогичным образом, требуемые свойства, заданные для пользовательских модулей в deployment.jsв файле, копируются в свой модуль двойника, но решение несет ответственность за предоставление значений сообщаемых свойств.

В этой статье описывается, как проверить двойников модуля в портал Azure, Azure CLI и в Visual Studio Code. Сведения о наблюдении за развертыванием устройств см. в разделе [Monitor IOT Edge deployments](how-to-monitor-iot-edge-deployments.md). Общие сведения о концепции модуля двойников см. [в статье изучение и использование модуля двойников в центре Интернета вещей](../iot-hub/iot-hub-devguide-module-twins.md).

> [!TIP]
> Сообщаемые свойства модуля среды выполнения могут быть устаревшими, если устройство IoT Edge отключается от центра Интернета вещей. Вы можете [проверить связь](how-to-edgeagent-direct-method.md#ping) с `$edgeAgent` модулем, чтобы определить, было ли потеряно соединение.

## <a name="monitor-runtime-module-twins"></a>Мониторинг модуля среды выполнения двойников

Чтобы устранить проблемы с подключением к развертыванию, IoT Edge просмотрите двойников агент и модуль среды выполнения IoT Edge Hub, а затем выполните детализацию в другие модули.

### <a name="monitor-iot-edge-agent-module-twin"></a>Мониторинг модуля агента IoT Edge двойника

В следующем примере JSON показан `$edgeAgent` модуль двойника в Visual Studio Code с свернутой частью разделов JSON.

```json
{
  "deviceId": "Windows109",
  "moduleId": "$edgeAgent",
  "etag": "AAAAAAAAAAU=",
  "deviceEtag": "NzgwNjA1MDUz",
  "status": "enabled",
  "statusUpdateTime": "0001-01-01T00:00:00Z",
  "connectionState": "Disconnected",
  "lastActivityTime": "0001-01-01T00:00:00Z",
  "cloudToDeviceMessageCount": 0,
  "authenticationType": "sas",
  "x509Thumbprint": {
    "primaryThumbprint": null,
    "secondaryThumbprint": null
  },
  "version": 53,
  "properties": {
    "desired": { "···" },
    "reported": {
      "schemaVersion": "1.0",
      "version": { "···" },
      "lastDesiredStatus": { "···" },
      "runtime": { "···" },
      "systemModules": {
        "edgeAgent": { "···" },
        "edgeHub": { "···" }
      },
      "lastDesiredVersion": 5,
      "modules": {
        "SimulatedTemperatureSensor": { "···" }
      },
      "$metadata": { "···" },
      "$version": 48
    }
  }
}
```

JSON можно описать в следующих разделах, начиная с верхнего:

* Метаданные — содержит данные о подключении. Интересно, что состояние подключения для агента IoT Edge всегда находится в отключенном состоянии: `"connectionState": "Disconnected"` . Причина, по которой состояние подключения относится к сообщениям, отправляемым с устройства в облако (D2C), а агент IoT Edge не отправляет сообщения D2C.
* Свойства — содержит `desired` `reported` подразделы и.
* Свойства. требуемый (показан свернутый) значения свойств, заданные оператором в deployment.jsв файле.
* Properties. сообщаемо — последние значения свойств, сообщаемые агентом IoT Edge.

`properties.desired` `properties.reported` Разделы и имеют схожую структуру и содержат дополнительные метаданные для схемы, версии и сведений о среде выполнения. Кроме того, сюда входит `modules` раздел для любых пользовательских модулей (например `SimulatedTemperatureSensor` ,), а также `systemModules` разделов `$edgeAgent` и `$edgeHub` модулей среды выполнения.

Сравнивая значения сообщаемых свойств с нужными значениями, можно определить несоответствия и определить отсоединения, которые могут помочь в устранении неполадок. При выполнении этих сравнений проверьте `$lastUpdated` Сообщаемое значение в `metadata` разделе для интересующего вас свойства.

Следующие свойства важны для проверки на устранение неполадок:

* **ExitCode** — любое значение, отличное от нуля, указывает, что модуль остановлен с ошибкой. Однако если для модуля было намеренно задано состояние остановлено, используются коды ошибок 137 или 143.

* **ластстарттимеутк** — показывает **дату и время** последнего запуска контейнера. Это значение 0001-01-01T00:00:00Z, если контейнер не был запущен.

* **ластекситтимеутк** — показывает **дату и время** последнего завершения контейнера. Это значение 0001-01-01T00:00:00Z, если контейнер запущен и никогда не был остановлен.

* **рунтиместатус** — может принимать одно из следующих значений:

    | Значение | Описание |
    | --- | --- |
    | неизвестно | Состояние по умолчанию до создания развертывания. |
    | отход | Запуск модуля запланирован, но сейчас не выполняется. Это значение полезно для изменения состояния модуля при перезапуске. Когда сбой модуля ожидает перезапуска в течение периода отсрочки, модуль будет находиться в состоянии отхода. |
    | запуск | Указывает, что модуль в данный момент выполняется. |
    | неработоспособное | Указывает, что проверка работоспособности завершилась сбоем или истекло время ожидания. |
    | остановлена | Указывает, что модуль успешно завершил работу (с нулевым кодом выхода). |
    | сбой | Указывает, что модуль завершился с кодом выхода из строя (не нулем). Модуль может вернуться к переходу из этого состояния в зависимости от действующей политики перезапуска. Это состояние может означать, что в модуле возникла неустранимая ошибка. Сбой происходит, когда Microsoft Monitoring Agent (MMA) больше не может ресусЦитате модуль, что требует нового развертывания. |

Подробные сведения см. в разделе [сообщаемые свойства EdgeAgent](module-edgeagent-edgehub.md#edgeagent-reported-properties) .

### <a name="monitor-iot-edge-hub-module-twin"></a>Мониторинг модуля IoT Edge концентратора двойника

В следующем примере JSON показан `$edgeHub` модуль двойника в Visual Studio Code с свернутой частью разделов JSON.

```json
{
  "deviceId": "Windows109",
  "moduleId": "$edgeHub",
  "etag": "AAAAAAAAAAU=",
  "deviceEtag": "NzgwNjA1MDU2",
  "status": "enabled",
  "statusUpdateTime": "0001-01-01T00:00:00Z",
  "connectionState": "Connected",
  "lastActivityTime": "0001-01-01T00:00:00Z",
  "cloudToDeviceMessageCount": 0,
  "authenticationType": "sas",
  "x509Thumbprint": {
    "primaryThumbprint": null,
    "secondaryThumbprint": null
  },
  "version": 102,
    "properties": {
      "desired": { "···" },
      "reported": {
        "schemaVersion": "1.0",
        "version": { "···" },
      "lastDesiredVersion": 5,
      "lastDesiredStatus": { "···" },
      "clients": {
        "Windows109/SimulatedTemperatureSensor": {
          "status": "Disconnected",
          "lastConnectedTimeUtc": "2020-04-08T21:42:42.1743956Z",
          "lastDisconnectedTimeUtc": "2020-04-09T07:02:42.1398325Z"
        }
      },
      "$metadata": { "···" },
      "$version": 97
    }
  }
}

```

JSON можно описать в следующих разделах, начиная с верхнего:

* Метаданные — содержит данные о подключении.

* Свойства — содержит `desired` `reported` подразделы и.
* Свойства. требуемый (показан свернутый) значения свойств, заданные оператором в deployment.jsв файле.
* Properties. сообщаемо — последние значения свойств, сообщаемые центром IoT Edge.

Если у вас возникли проблемы с подчиненными устройствами, для начала рекомендуется изучить эти данные.

## <a name="monitor-custom-module-twins"></a>Мониторинг пользовательского модуля двойников

Сведения о подключении пользовательских модулей хранятся в модуле агента IoT Edge двойника. Модуль двойника для пользовательского модуля используется в основном для сохранения данных для решения. Требуемые свойства, определенные в deployment.jsдля файла, отражаются в модуле двойника, и модуль может обновлять значения сообщаемых свойств по мере необходимости.

Вы можете использовать предпочтительный язык программирования с пакетами [SDK для устройств центра Интернета вещей Azure](../iot-hub/iot-hub-devguide-sdks.md#azure-iot-hub-device-sdks) , чтобы обновить значения сообщаемых свойств в модуле двойника на основе кода приложения вашего модуля. Следующая процедура использует пакет Azure SDK для .NET для этого, используя код из модуля [симулатедтемпературесенсор](https://github.com/Azure/iotedge/blob/dd5be125df165783e4e1800f393be18e6a8275a3/edge-modules/SimulatedTemperatureSensor/src/Program.cs) :

1. Создайте экземпляр [модулеклиент](/dotnet/api/microsoft.azure.devices.client.moduleclient) с помощью метода [креатефроменвиронментайснк](/dotnet/api/microsoft.azure.devices.client.moduleclient.createfromenvironmentasync) .

1. Получите коллекцию свойств двойникаа модуля с помощью метода [жеттвинасинк](/dotnet/api/microsoft.azure.devices.client.moduleclient.gettwinasync) .

1. Создание прослушивателя (передача обратного вызова) для перехвата изменений требуемых свойств с помощью метода [сетдесиредпропертюпдатекаллбаккасинк](/dotnet/api/microsoft.azure.devices.client.deviceclient.setdesiredpropertyupdatecallbackasync) .

1. В методе обратного вызова обновите сообщаемые свойства в модуле двойника с помощью метода [упдатерепортедпропертиесасинк](/dotnet/api/microsoft.azure.devices.client.moduleclient) , передав [твинколлектион](/dotnet/api/microsoft.azure.devices.shared.twincollection) значений свойств, которые необходимо задать.

## <a name="access-the-module-twins"></a>Доступ к модулю двойников

Вы можете ознакомиться с JSON для модуля двойников в центре Интернета вещей Azure, в Visual Studio Code и с Azure CLI.

### <a name="monitor-in-azure-iot-hub"></a>Мониторинг в центре Интернета вещей Azure

Чтобы просмотреть JSON для модуля двойника, выполните следующие действия.

1. Войдите на [портал Azure](https://portal.azure.com) и перейдите к своему Центру Интернета вещей.
1. В меню слева выберите **IoT Edge**.
1. На вкладке **устройства IOT Edge** выберите **идентификатор устройства** с модулями, которые требуется отслеживать.
1. Выберите имя модуля на вкладке **модули** , а затем в верхней строке меню выберите **модуль Identity двойника (идентификация** модуля).

  ![Выберите модуль двойника для просмотра в портал Azure](./media/how-to-monitor-module-twins/select-module-twin.png)

Если отображается сообщение "удостоверение модуля не существует для этого модуля", эта ошибка означает, что серверное решение больше не доступно, изначально создавшее удостоверение.

### <a name="monitor-module-twins-in-visual-studio-code"></a>Мониторинг двойников модуля в Visual Studio Code

Чтобы проверить и изменить двойника модуля, выполните следующие действия.

1. Установите [расширение средств Azure IOT](https://marketplace.visualstudio.com/items?itemName=vsciot-vscode.azure-iot-tools) для Visual Studio Code, если оно еще не установлено.
1. В **обозревателе** разверните **центр Интернета вещей Azure**, а затем разверните устройство с модулем, который требуется отслеживать.
1. Щелкните модуль правой кнопкой мыши и выберите **изменить модуль двойника**. Временный файл модуля двойника загружается на компьютер и отображается в Visual Studio Code.

  ![Получение двойникаа модуля для редактирования в Visual Studio Code](./media/how-to-monitor-module-twins/edit-module-twin-vscode.png)

При внесении изменений выберите **обновить модуль двойника** над кодом в редакторе, чтобы сохранить изменения в центре Интернета вещей.

  ![Обновление двойникаа модуля в Visual Studio Code](./media/how-to-monitor-module-twins/update-module-twin-vscode.png)

### <a name="monitor-module-twins-in-azure-cli"></a>Мониторинг двойников модуля в Azure CLI

Чтобы узнать, работает ли IoT Edge, воспользуйтесь [методом AZ для центра Интернета вещей Invoke-Module-метод](how-to-edgeagent-direct-method.md#ping) , чтобы проверить связь с агентом IOT Edge.

Следующие команды представлены в структуре [AZ центра Интернета вещей двойника](/cli/azure/ext/azure-iot/iot/hub/module-twin) .

* **AZ двойника "модуль центра Интернета вещей" —** Отображение определения модуля двойника.
* **AZ двойника-модуль центра Интернета вещей —** обновление определения модуля двойника.
* **AZ двойника-модуль центра Интернета вещей —** Замена определения модуля двойника на целевой JSON.

## <a name="next-steps"></a>Дальнейшие действия

Узнайте, как [взаимодействовать с EdgeAgent с помощью встроенных прямых методов](how-to-edgeagent-direct-method.md).
