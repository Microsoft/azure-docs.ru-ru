---
title: Инициализация устройства с помощью виртуального доверенного платформенного модуля на виртуальной машине Linux — Azure IoT Edge
description: Использование имитированного доверенного платформенного модуля на виртуальной машине Linux для тестирования службы подготовки устройств для Azure IoT Edge
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 6/30/2020
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: 13f78691a3652cc82e261f807c690c04cebec3b4
ms.sourcegitcommit: 24a12d4692c4a4c97f6e31a5fbda971695c4cd68
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/05/2021
ms.locfileid: "102175522"
---
# <a name="create-and-provision-an-iot-edge-device-with-a-tpm-on-linux"></a>Создание и предоставление устройства IoT Edge с помощью доверенного платформенного модуля в Linux

В этой статье показано, как протестировать автоматическую подготовку на устройстве Linux IoT Edge с помощью доверенный платформенный модуль (TPM) (TPM). Вы можете автоматически подготовить Azure IoT Edge устройства с помощью [службы подготовки устройств](../iot-dps/index.yml). При необходимости ознакомьтесь с обзором [процесса подготовки](../iot-dps/about-iot-dps.md#provisioning-process), прежде чем продолжить.

Это следующие задачи:

1. Создание виртуальной машины Linux в Hyper-V с имитированным доверенным платформенным модулем (TPM) для обеспечения безопасности оборудования.
1. Создание экземпляра Службы подготовки устройств к добавлению в Центр Интернета вещей.
1. Создание отдельной регистрации устройства.
1. Установка среды выполнения IoT Edge и подключение устройства к Центру Интернета вещей.

> [!TIP]
> В этой статье описывается, как проверить подготовку службы DPS с помощью симулятора TPM, но многие из них применяются к физическому оборудованию доверенного платформенного модуля, например [ИНФИНЕОН оптига &trade; TPM](https://catalog.azureiotsolutions.com/details?title=OPTIGA-TPM-SLB-9670-Iridium-Board), сертифицированному в Azure для устройства IOT.
>
> Если вы используете физическое устройство, можно перейти к разделу [Получение сведений о подготовке из физического устройства](#retrieve-provisioning-information-from-a-physical-device) этой статьи.

## <a name="prerequisites"></a>Предварительные требования

* Компьютер для разработки с ОС Windows с [включенным Hyper-V](/virtualization/hyper-v-on-windows/quick-start/enable-hyper-v). В этой статье используется виртуальная машина Ubuntu Server, запущенная в Windows 10.
* Действующий Центр Интернета вещей.

> [!NOTE]
> TPM 2,0 необходим при использовании аттестации доверенного платформенного модуля с DPS и может использоваться только для создания отдельных, а не групп, регистраций.

## <a name="create-a-linux-virtual-machine-with-a-virtual-tpm"></a>Создание виртуальной машины Linux с помощью виртуального доверенного платформенного модуля (TPM)

В этом разделе вы создадите новую виртуальную машину Linux в Hyper-V. Эта виртуальная машина настраивается с помощью имитации доверенного платформенного модуля для тестирования работы автоматической подготовки с IoT Edge.

### <a name="create-a-virtual-switch"></a>Создание виртуального коммутатора

Виртуальный коммутатор позволяет виртуальной машине подключаться к физической сети.

1. Откройте диспетчер Hyper-V на компьютере Windows.

2. В меню **Действия** выберите **Диспетчер виртуальных коммутаторов**.

3. Выберите **Внешний** виртуальный коммутатор, а затем выберите **Создать виртуальный коммутатор**.

4. Назовите новый виртуальный коммутатор, например **EdgeSwitch**. Убедитесь, что выбранный тип соединения имеет значение **Внешняя сеть**, а затем выберите **OK**.

5. Всплывающее окно предупредит, что сетевое подключение может быть разорвано. Щелкните **Да**, чтобы продолжить.

В случае возникновения ошибок при создании нового виртуального коммутатора, убедитесь, что другие коммутаторы не используют адаптер Ethernet и что для других коммутаторов не используется то же самое имя.

### <a name="create-virtual-machine"></a>Создание виртуальной машины

1. Скачайте и сохраните локально файл образа диска для виртуальной машины. Например, [Ubuntu server 18,04](http://releases.ubuntu.com/18.04/). Сведения о поддерживаемых операционных системах для IoT Edge устройств см. в разделе [Azure IOT Edge Поддерживаемые системы](support.md).

2. В диспетчере Hyper-V выберите **действие**  >  **создать**  >  **Виртуальная машина** в меню **действия** .

3. В ходе работы **Мастера создания виртуальной машины** укажите следующие настройки.

   1. **Укажите поколение**. Выберите **Generation 2**. На виртуальных машинах поколения 2 включена вложенная виртуализация, необходимая для запуска IoT Edge на виртуальной машине.
   2. **Настройка сети**. В параметре **Подключение** укажите виртуальный коммутатор, созданный в предыдущем разделе.
   3. **Варианты установки**. Выберите **Установить операционную систему из файла загрузочного образа** и укажите путь к сохраненному файлу образа диска.

4. Нажмите кнопку **Готово** в мастере, чтобы создать виртуальную машину.

Создание виртуальной машины может занять несколько минут.

### <a name="enable-virtual-tpm"></a>Включение виртуального доверенного платформенного модуля

После создания виртуальной машины откройте ее параметры, чтобы включить модуль виртуальной доверенной платформы (TPM), позволяющий выполнять автоматическую инициализацию устройства.

1. В диспетчере Hyper-V щелкните виртуальную машину правой кнопкой мыши и выберите **Параметры**.

2. Перейдите в раздел **Безопасность**.

3. Снимите флажок **Включить безопасную загрузку**.

4. Поставьте флажок **Включить доверенный платформенный модуль**.

5. Нажмите кнопку **ОК**.  

### <a name="start-the-virtual-machine-and-collect-tpm-data"></a>Запуск виртуальной машины и сбор данных доверенного платформенного модуля

В виртуальной машине Создайте средство, которое можно использовать для получения **идентификатора регистрации** и **ключа подтверждения** устройства.

1. В диспетчере Hyper-V запустите виртуальную машину и подключитесь к ней.

1. Следуйте инструкциям в этой виртуальной машине, чтобы завершить процесс установки и перезагрузить компьютер.

1. Войдите на виртуальную машину, а затем выполните действия, описанные в разделе [Настройка среды разработки Linux](https://github.com/Azure/azure-iot-sdk-c/blob/master/doc/devbox_setup.md#linux) для установки и сборки пакета SDK для устройств Azure IOT для C.

   >[!TIP]
   >В рамках этой статьи вы скопируйте и вставьте на виртуальную машину, что непросто в приложении подключения диспетчера Hyper-V. Чтобы получить IP-адрес, может потребоваться подключиться к виртуальной машине через диспетчер Hyper-V. Первый запуск `sudo apt install net-tools` , а затем `hostname -I` . Затем можно использовать IP-адрес для подключения через SSH: `ssh <username>@<ipaddress>` .

1. Выполните следующие команды, чтобы создать средство SDK, которое извлекает сведения о подготовке устройства из доверенного платформенного модуля.

   ```bash
   cd azure-iot-sdk-c/cmake
   cmake -Duse_prov_client:BOOL=ON ..
   cd provisioning_client/tools/tpm_device_provision
   make
   sudo ./tpm_device_provision
   ```

1. В окне Вывод отображается **идентификатор регистрации** устройства и **ключ подтверждения**. Скопируйте эти значения для дальнейшего использования при создании отдельной регистрации для устройства.

После получения идентификатора регистрации и ключа подтверждения перейдите к разделу [Настройка службы подготовки устройств для центра Интернета вещей](#set-up-the-iot-hub-device-provisioning-service) .

## <a name="retrieve-provisioning-information-from-a-physical-device"></a>Получение сведений об инициализации с физического устройства

Если вместо виртуальной машины используется физическое IoT Edge устройство, создайте средство, которое можно использовать для получения сведений об инициализации устройства.

1. Выполните действия, описанные в разделе [Настройка среды разработки Linux](https://github.com/Azure/azure-iot-sdk-c/blob/master/doc/devbox_setup.md#linux) для установки и сборки пакета SDK для устройств Azure IOT для C.

1. Выполните следующие команды, чтобы создать средство SDK, которое извлекает сведения о подготовке устройства с устройства TPM.

   ```bash
   cd azure-iot-sdk-c/cmake
   cmake -Duse_prov_client:BOOL=ON ..
   cd provisioning_client/tools/tpm_device_provision
   make
   sudo ./tpm_device_provision
   ```

1. Скопируйте значения для **идентификатора регистрации** и **ключа подтверждения**. Эти значения могут быть использованы при создании отдельной регистрации устройства в Службы подготовки устройств к добавлению в Центр Интернета вещей.

## <a name="set-up-the-iot-hub-device-provisioning-service"></a>Настройка Службы подготовки устройств к добавлению в Центр Интернета вещей

Создайте экземпляр Службы подготовки устройств к добавлению в Центр Интернета вещей в Azure и свяжите его со своим Центром Интернета вещей. Следуйте инструкциям по [настройке Службы подготовки устройств к добавлению в Центр Интернета вещей на портале Azure](../iot-dps/quick-setup-auto-provision.md).

После запуска Службы подготовки устройств к добавлению в Центр Интернета вещей скопируйте значение **Область идентификатора** на странице обзора. Это значение используется при настройке среды выполнения IoT Edge.

## <a name="create-a-dps-enrollment"></a>Создание регистрации в Службе подготовки устройств к добавлению в Центр Интернета вещей

Получите сведения о подготовке из вашей виртуальной машины и используйте их, чтобы создать отдельную регистрацию в Службе подготовки устройств к добавлению в Центр Интернета вещей.

При регистрации в Службе подготовки устройств к добавлению в Центр Интернета вещей есть возможность объявить **Первоначальное состояние двойника устройства**. В двойнике устройства можно задать теги для группировки устройств по любой требуемой для решения метрике, например по региону, среде, расположению или типу устройства. Эти теги используются для создания [автоматических развертываний](how-to-deploy-at-scale.md).

> [!TIP]
> В Azure CLI можно создать [регистрацию](/cli/azure/ext/azure-iot/iot/dps/enrollment) и использовать флаг с **поддержкой ребра** , чтобы указать, что устройство является устройством IOT Edge.

1. В [портал Azure](https://portal.azure.com)перейдите к своему экземпляру службы подготовки устройств для центра Интернета вещей.

2. В разделе **Параметры** выберите **Управление регистрациями**.

3. Выберите **Добавить отдельную регистрацию** и выполните следующие действия для настройки регистрации.  

   1. Для параметра **Механизм** выберите **TPM**.

   2. Укажите **ключ подтверждения** и **идентификатор регистрации** , которые вы скопировали с виртуальной машины.

      > [!TIP]
      > При использовании физического устройства доверенного платформенного модуля необходимо определить **ключ подтверждения**, уникальный для каждого микросхемы TPM и полученный от изготовителя МИКРОсхемы TPM, связанного с ним. Можно создать уникальный **идентификатор регистрации** для устройства TPM, например, СОЗДАВ хэш SHA-256 для ключа подтверждения.

   3. Если необходимо, укажите идентификатор устройства. Если не указать идентификатор устройства, используется идентификатор регистрации.

   4. Выберите **значение true** , чтобы объявить, что эта виртуальная машина является IOT Edge устройством.

   5. Выберите связанный центр Интернета вещей, к которому нужно подключить устройство, или щелкните **ссылку на новый центр Интернета вещей**. Можно выбрать несколько концентраторов, и устройство будет назначено одному из них в соответствии с выбранной политикой назначения.

   6. При необходимости добавьте значение тега в **Первоначальное состояние двойника устройства**. Теги можно использовать для указания групп устройств для развертывания модуля. Дополнительные сведения см. [в разделе Deploy IOT Edge modules in Scale](how-to-deploy-at-scale.md).

   7. Щелкните **Сохранить**.

Теперь, когда для этого устройства существует регистрация, среда выполнения IoT Edge может автоматически подготавливать устройство во время установки.

## <a name="install-the-iot-edge-runtime"></a>Установка среды выполнения IoT Edge

Среда выполнения IoT Edge развертывается на всех устройствах IoT Edge. Ее компоненты выполняются в контейнерах и позволяют развертывать дополнительные контейнеры на устройстве, чтобы обеспечить возможность выполнения кода в граничной системе. Установите среду выполнения IoT Edge на вашей виртуальной машине.

Выполните действия, описанные в разделе [Установка среды выполнения Azure IOT Edge](how-to-install-iot-edge.md), а затем вернитесь к этой статье для инициализации устройства.

## <a name="configure-the-device-with-provisioning-information"></a>Настройка устройства с помощью сведений об инициализации

После установки среды выполнения на устройстве настройте на нем сведения, которые он использует для подключения к службе подготовки устройств и центру Интернета вещей.

1. Определите **область идентификатора** DPS и **идентификатор регистрации** устройства, собранные в предыдущих разделах.

1. Откройте файл конфигурации на устройстве IoT Edge.

   ```bash
   sudo nano /etc/iotedge/config.yaml
   ```

1. Найдите раздел конфигурации подготовки файла. Раскомментируйте строки для подготовки TPM и убедитесь, что все остальные строки подготовки включены в комментарий.

   `provisioning:`Строка не должна содержать предшествующих пробелов, а вложенные элементы должны иметь отступ в два пробела.

   ```yml
   # DPS TPM provisioning configuration
   provisioning:
     source: "dps"
     global_endpoint: "https://global.azure-devices-provisioning.net"
     scope_id: "<SCOPE_ID>"
     attestation:
       method: "tpm"
       registration_id: "<REGISTRATION_ID>"
   # always_reprovision_on_startup: true
   # dynamic_reprovisioning: false
   ```

   При необходимости используйте `always_reprovision_on_startup` `dynamic_reprovisioning` строки или для настройки поведения повторной подготовки устройства. Если устройство настроено для повторной подготовки при запуске, оно всегда будет пытаться подготовиться к службе DPS сначала, а затем вернуться к резервной копии при сбое. Если для устройства настроена динамическая повторная инициализация, IoT Edge будут перезапущены и повторно подготавливаются, если будет обнаружено событие повторной инициализации. Дополнительные сведения см. в разделе [Основные понятия повторной инициализации устройств центра Интернета вещей](../iot-dps/concepts-device-reprovision.md).

1. Обновите значения `scope_id` и `registration_id` со сведениями об DP и устройстве.

## <a name="give-iot-edge-access-to-the-tpm"></a>Предоставление доступа IoT Edge доверенному платформенному модулю

Среда выполнения IoT Edge должна получить доступ к доверенному платформенному модулю для автоматической подготовки устройства.

Вы можете предоставить доверенному платформенному модулю доступ к IoT Edge среде выполнения, переопределив параметры системы, чтобы `iotedge` Служба предустановила привилегии root. Если вы не хотите повышать привилегии, доступ можно предоставить вручную.

1. Найдите путь к аппаратному модулю доверенного платформенного модуля на устройстве и сохраните его в качестве локальной переменной.

   ```bash
   tpm=$(sudo find /sys -name dev -print | fgrep tpm | sed 's/.\{4\}$//')
   ```

2. Создайте новое правило, которое предоставит среде выполнения IoT Edge доступ к tpm0.

   ```bash
   sudo touch /etc/udev/rules.d/tpmaccess.rules
   ```

3. Откройте файл правил.

   ```bash
   sudo nano /etc/udev/rules.d/tpmaccess.rules
   ```

4. Скопируйте следующие сведения о доступе в файл правил.

   ```input
   # allow iotedge access to tpm0
   KERNEL=="tpm0", SUBSYSTEM=="tpm", OWNER="iotedge", MODE="0600"
   ```

5. Сохраните и закройте файл.

6. Запустите систему udev, чтобы оценить новое правило.

   ```bash
   /bin/udevadm trigger $tpm
   ```

7. Убедитесь, что правило было успешно применено.

   ```bash
   ls -l /dev/tpm0
   ```

   Успешный вывод выглядит следующим образом:

   ```output
   crw-rw---- 1 root iotedge 10, 224 Jul 20 16:27 /dev/tpm0
   ```

   В противном случае попробуйте перезагрузить компьютер, чтобы обновить Udev.

## <a name="restart-the-iot-edge-runtime"></a>Перезапуск среды выполнения IoT Edge

Перезапустите среду выполнения IoT Edge, чтобы активировать все изменения конфигурации, внесенные на устройстве.

   ```bash
   sudo systemctl restart iotedge
   ```

Убедитесь, что среда выполнения IoT Edge запущена.

   ```bash
   sudo systemctl status iotedge
   ```

Возникновение ошибки подготовки может означать, что изменения конфигурации еще не вступили в силу. Попробуйте перезапустить управляющую программу IoT Edge.

   ```bash
   sudo systemctl daemon-reload
   ```

Или попробуйте перезапустить виртуальную машину, чтобы проверить, вступят ли изменения в силу при новом запуске.

## <a name="verify-successful-installation"></a>Проверка установки

Если среда выполнения запущена, перейдите в Центр Интернета вещей и проверьте, что новое устройство автоматически подготовлено и готово для запуска модулей IoT Edge.

Проверьте состояние управляющей программы IoT Edge.

```cmd/sh
systemctl status iotedge
```

Изучите журналы управляющей программы.

```cmd/sh
journalctl -u iotedge --no-pager --no-full
```

Просмотрите список запущенных модулей.

```cmd/sh
iotedge list
```

Вы можете проверить, была ли использована отдельная регистрация, созданная в службе подготовки устройств. Перейдите к экземпляру службы подготовки устройств в портал Azure. Откройте сведения о регистрации для созданной индивидуальной регистрации. Обратите внимание, что для регистрации **назначено** состояние и указан идентификатор устройства.

## <a name="next-steps"></a>Дальнейшие действия

Процесс регистрации DPS позволяет одновременно задать идентификатор устройства и теги двойникаа устройства при подготовке нового устройства. Эти значения можно использовать для указания отдельных устройств или групп устройств с помощью автоматического управления устройствами. Узнайте, как [развертывать и отслеживать модули IOT EDGE в масштабе с помощью портал Azure](how-to-deploy-at-scale.md) или [с помощью Azure CLI](how-to-deploy-cli-at-scale.md).
