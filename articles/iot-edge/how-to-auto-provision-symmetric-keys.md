---
title: Инициализация устройства с помощью аттестации симметричных ключей — Azure IoT Edge
description: Использование аттестации симметричных ключей для тестирования автоматической подготовки устройств для Azure IoT Edge с помощью службы подготовки устройств
author: kgremban
manager: philmea
ms.author: kgremban
ms.reviewer: mrohera
ms.date: 4/3/2020
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: bfb61a5434089fffab9d8ceb9c7b0fbca528cac5
ms.sourcegitcommit: eb546f78c31dfa65937b3a1be134fb5f153447d6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/02/2021
ms.locfileid: "99430617"
---
# <a name="create-and-provision-an-iot-edge-device-using-symmetric-key-attestation"></a>Создание и инициализация устройства IoT Edge с помощью аттестации симметричных ключей

Устройства Azure IoT Edge можно подготовить автоматически с помощью [Службы подготовки устройств к добавлению в Центр Интернета вещей](../iot-dps/index.yml) точно так же, как и другие устройства. При необходимости ознакомьтесь с обзором [процесса подготовки](../iot-dps/about-iot-dps.md#provisioning-process), прежде чем продолжить.

В этой статье показано, как создать отдельную регистрацию службы подготовки устройств с помощью аттестации симметричных ключей на IoT Edge устройстве, выполнив следующие действия.

* Создание экземпляра Службы подготовки устройств к добавлению в Центр Интернета вещей.
* Создание отдельной регистрации устройства.
* Установите среду выполнения IoT Edge и подключитесь к центру Интернета вещей.

Аттестация симметричных ключей — это простой подход к аутентификации устройства в экземпляре Службы подготовки устройств. Этот метод аттестации представляет возможности программы Hello world для разработчиков, которые не имеют опыта подготовки устройств или строгих требований к безопасности. Аттестация устройств с помощью сертификатов [TPM](../iot-dps/concepts-tpm-attestation.md) или [X. 509](../iot-dps/concepts-x509-attestation.md) более безопасна и должна использоваться для более строгих требований к безопасности.

## <a name="prerequisites"></a>Обязательные условия

* Активный центр Интернета вещей
* Физическое или виртуальное устройство

## <a name="set-up-the-iot-hub-device-provisioning-service"></a>Настройка Службы подготовки устройств к добавлению в Центр Интернета вещей

Создайте экземпляр Службы подготовки устройств к добавлению в Центр Интернета вещей в Azure и свяжите его со своим Центром Интернета вещей. Следуйте инструкциям по [настройке Службы подготовки устройств к добавлению в Центр Интернета вещей на портале Azure](../iot-dps/quick-setup-auto-provision.md).

После запуска Службы подготовки устройств к добавлению в Центр Интернета вещей скопируйте значение **Область идентификатора** на странице обзора. Это значение используется при настройке среды выполнения IoT Edge.

## <a name="choose-a-unique-registration-id-for-the-device"></a>Выбор уникального идентификатора регистрации для устройства

Уникальный идентификатор регистрации должен быть определен для идентификации каждого устройства. Можно использовать MAC-адрес, серийный номер или любые уникальные сведения устройства.

В этом примере мы используем сочетание MAC-адреса и серийного номера, формирующего следующую строку для идентификатора регистрации: `sn-007-888-abc-mac-a1-b2-c3-d4-e5-f6` .

Создайте уникальный идентификатор регистрации для устройства. Допустимые знаки — буквы в нижнем регистре, цифры и дефис ("-").

## <a name="create-a-dps-enrollment"></a>Создание регистрации в Службе подготовки устройств к добавлению в Центр Интернета вещей

Используйте идентификатор регистрации устройства для создания отдельной регистрации в DPS.

При регистрации в Службе подготовки устройств к добавлению в Центр Интернета вещей есть возможность объявить **Первоначальное состояние двойника устройства**. В двойнике устройства можно задать теги для группировки устройств по любой требуемой для решения метрике, например по региону, среде, расположению или типу устройства. Эти теги используются для создания [автоматических развертываний](how-to-deploy-at-scale.md).

> [!TIP]
> Групповые регистрации также возможны при использовании аттестации симметричных ключей и принимают те же решения, что и индивидуальные регистрации.

1. В [портал Azure](https://portal.azure.com)перейдите к своему экземпляру службы подготовки устройств для центра Интернета вещей.

1. В разделе **Параметры** выберите **Управление регистрациями**.

1. Выберите **Добавить отдельную регистрацию** и выполните следующие действия для настройки регистрации.  

   1. Для параметра **механизм** выберите **симметричный ключ**.

   1. Установите флажок **Автоматическое создание ключей** .

   1. Укажите **идентификатор регистрации** , созданный для устройства.

   1. Укажите **идентификатор устройства центра Интернета вещей** для устройства, если хотите. Идентификаторы устройств можно использовать, чтобы указать отдельное устройство для развертывания модуля. Если не указать идентификатор устройства, используется идентификатор регистрации.

   1. Выберите **значение true** , чтобы объявить о регистрации для устройства IOT Edge. Для групповой регистрации все устройства должны быть IoT Edge устройствами или ни одно из них не может быть.

   > [!TIP]
   > В Azure CLI можно создать [регистрацию](/cli/azure/ext/azure-iot/iot/dps/enrollment) или [группу регистрации](/cli/azure/ext/azure-iot/iot/dps/enrollment-group) и использовать флаг с **поддержкой границ** , чтобы указать, что устройство или группа устройств является устройством IOT Edge.

   1. Примите значение по умолчанию в политике выделения службы подготовки устройств, **чтобы назначить устройства концентраторам** , или выберите другое значение, относящееся к этой регистрации.

   1. Выберите связанный **Центр Интернета вещей**, к которому планируется подключение устройства. Можно выбрать несколько концентраторов, и устройство будет назначено одному из них в соответствии с выбранной политикой распределения.

   1. Выберите **способ обработки данных устройства при повторной подготовке** , когда устройства запрашивают подготовку через первый раз.

   1. При необходимости добавьте значение тега в **Первоначальное состояние двойника устройства**. Теги можно использовать для указания групп устройств для развертывания модуля. Пример:

      ```json
      {
         "tags": {
            "environment": "test"
         },
         "properties": {
            "desired": {}
         }
      }
      ```

   1. Убедитесь, что для **параметра включить запись** задано значение **включено**.

   1. Щелкните **Сохранить**.

Теперь, когда для этого устройства существует регистрация, среда выполнения IoT Edge может автоматически подготавливать устройство во время установки. Не забудьте скопировать значение **первичного ключа** регистрации, которое будет использоваться при установке среды выполнения IOT EDGE, или если вы собираетесь создавать ключи устройств для использования с групповой регистрацией.

## <a name="derive-a-device-key"></a>Получение ключа устройства

> [!NOTE]
> Этот раздел необходим только при использовании групповой регистрации.

Каждое устройство использует свой производный ключ устройства с уникальным ИДЕНТИФИКАТОРом регистрации для выполнения аттестации симметричного ключа с регистрацией во время подготовки. Чтобы создать ключ устройства, используйте ключ, скопированный из регистрации DPS, чтобы вычислить код [HMAC-SHA256](https://wikipedia.org/wiki/HMAC) уникального идентификатора регистрации для устройства и преобразовать результат в формат Base64.

Не включайте первичный или вторичный ключ регистрации в код устройства.

### <a name="linux-workstations"></a>Рабочие станции Linux

Если вы используете рабочую станцию Linux, можно использовать OpenSSL для формирования производного ключа устройства, как показано в следующем примере.

Замените значение **KEY** значением **первичного ключа**, записанным ранее.

Замените значение **REG_ID** на идентификатор регистрации устройства.

```bash
KEY=8isrFI1sGsIlvvFSSFRiMfCNzv21fjbE/+ah/lSh3lF8e2YG1Te7w1KpZhJFFXJrqYKi9yegxkqIChbqOS9Egw==
REG_ID=sn-007-888-abc-mac-a1-b2-c3-d4-e5-f6

keybytes=$(echo $KEY | base64 --decode | xxd -p -u -c 1000)
echo -n $REG_ID | openssl sha256 -mac HMAC -macopt hexkey:$keybytes -binary | base64
```

```bash
Jsm0lyGpjaVYVP2g3FnmnmG9dI/9qU24wNoykUmermc=
```

### <a name="windows-based-workstations"></a>Рабочие станции для Windows

Если вы используете рабочую станцию для Windows, можно использовать PowerShell для формирования производного ключа устройства, как показано в следующем примере.

Замените значение **KEY** значением **первичного ключа**, записанным ранее.

Замените значение **REG_ID** на идентификатор регистрации устройства.

```powershell
$KEY='8isrFI1sGsIlvvFSSFRiMfCNzv21fjbE/+ah/lSh3lF8e2YG1Te7w1KpZhJFFXJrqYKi9yegxkqIChbqOS9Egw=='
$REG_ID='sn-007-888-abc-mac-a1-b2-c3-d4-e5-f6'

$hmacsha256 = New-Object System.Security.Cryptography.HMACSHA256
$hmacsha256.key = [Convert]::FromBase64String($KEY)
$sig = $hmacsha256.ComputeHash([Text.Encoding]::ASCII.GetBytes($REG_ID))
$derivedkey = [Convert]::ToBase64String($sig)
echo "`n$derivedkey`n"
```

```powershell
Jsm0lyGpjaVYVP2g3FnmnmG9dI/9qU24wNoykUmermc=
```

## <a name="install-the-iot-edge-runtime"></a>Установка среды выполнения IoT Edge

Среда выполнения IoT Edge развертывается на всех устройствах IoT Edge. Ее компоненты выполняются в контейнерах и позволяют развертывать дополнительные контейнеры на устройстве, чтобы обеспечить возможность выполнения кода в граничной системе.

Выполните действия, описанные в разделе [Установка среды выполнения Azure IOT Edge](how-to-install-iot-edge.md), а затем вернитесь к этой статье для инициализации устройства.

## <a name="configure-the-device-with-provisioning-information"></a>Настройка устройства с помощью сведений об инициализации

После установки среды выполнения на устройстве настройте на нем сведения, которые он использует для подключения к службе подготовки устройств и центру Интернета вещей.

Приготовьте следующие сведения:

* Значение **области идентификаторов** DPS
* Созданный **идентификатор регистрации** устройства
* **Первичный ключ** , скопированный из регистрации DPS

> [!TIP]
> Для групповых регистраций требуется [производный ключ](#derive-a-device-key) каждого устройства, а не ключ регистрации DPS.

### <a name="linux-device"></a>Устройство Linux

1. Откройте файл конфигурации на устройстве IoT Edge.

   ```bash
   sudo nano /etc/iotedge/config.yaml
   ```

1. Найдите раздел конфигурации подготовки файла. Раскомментируйте строки для подготовки симметричного ключа DP и убедитесь, что все остальные строки подготовки снабжены комментариями.

   `provisioning:`Строка не должна содержать предшествующих пробелов, а вложенные элементы должны иметь отступ в два пробела.

   ```yml
   # DPS TPM provisioning configuration
   provisioning:
     source: "dps"
     global_endpoint: "https://global.azure-devices-provisioning.net"
     scope_id: "<SCOPE_ID>"
     attestation:
       method: "symmetric_key"
       registration_id: "<REGISTRATION_ID>"
       symmetric_key: "<SYMMETRIC_KEY>"
   #  always_reprovision_on_startup: true
   #  dynamic_reprovisioning: false
   ```

   При необходимости используйте `always_reprovision_on_startup` `dynamic_reprovisioning` строки или для настройки поведения повторной подготовки устройства. Если устройство настроено для повторной подготовки при запуске, оно всегда будет пытаться подготовиться к службе DPS сначала, а затем вернуться к резервной копии при сбое. Если для устройства настроена динамическая повторная инициализация, IoT Edge будут перезапущены и повторно подготавливаются, если будет обнаружено событие повторной инициализации. Дополнительные сведения см. в разделе [Основные понятия повторной инициализации устройств центра Интернета вещей](../iot-dps/concepts-device-reprovision.md).

1. Обновите значения параметров `scope_id` , `registration_id` и `symmetric_key` с помощью сведений об DP и устройстве.

1. Перезапустите среду выполнения IoT Edge, чтобы активировать все изменения конфигурации, внесенные на устройстве.

   ```bash
   sudo systemctl restart iotedge
   ```

### <a name="windows-device"></a>устройство с Windows;

1. Откройте окно PowerShell с правами администратора. Не забудьте использовать сеанс AMD64 PowerShell при установке IoT Edge, а не PowerShell (x86).

1. Команда **Initialize-IoTEdge** настраивает среду выполнения IoT Edge на вашем компьютере. Команда по умолчанию используется для подготовки вручную с контейнерами Windows, поэтому используйте `-DpsSymmetricKey` флаг, чтобы использовать автоматическую подготовку с проверкой подлинности с симметричным ключом.

   Замените значения заполнителей для `{scope_id}` , `{registration_id}` и `{symmetric_key}` данными, собранными ранее.

   Добавьте `-ContainerOs Linux` параметр, если вы используете контейнеры Linux в Windows.

   ```powershell
   . {Invoke-WebRequest -useb https://aka.ms/iotedge-win} | Invoke-Expression; `
   Initialize-IoTEdge -DpsSymmetricKey -ScopeId {scope ID} -RegistrationId {registration ID} -SymmetricKey {symmetric key}
   ```

## <a name="verify-successful-installation"></a>Проверка установки

Если среда выполнения запущена успешно, можете перейти в Центр Интернета вещей и начать развертывание модулей IoT Edge на устройстве. Чтобы убедиться, что среда выполнения установлена и запущена успешно, используйте следующие команды на устройстве:

### <a name="linux-device"></a>Устройство Linux

Проверьте состояние службы IoT Edge.

```cmd/sh
systemctl status iotedge
```

Проверьте журналы службы.

```cmd/sh
journalctl -u iotedge --no-pager --no-full
```

Просмотрите список запущенных модулей.

```cmd/sh
iotedge list
```

### <a name="windows-device"></a>устройство с Windows;

Проверьте состояние службы IoT Edge.

```powershell
Get-Service iotedge
```

Проверьте журналы службы.

```powershell
. {Invoke-WebRequest -useb aka.ms/iotedge-win} | Invoke-Expression; Get-IoTEdgeLog
```

Просмотрите список запущенных модулей.

```powershell
iotedge list
```

Вы можете проверить, была ли использована отдельная регистрация, созданная в службе подготовки устройств. Перейдите к экземпляру службы подготовки устройств в портал Azure. Откройте сведения о регистрации для созданной индивидуальной регистрации. Обратите внимание, что для регистрации **назначено** состояние и указан идентификатор устройства.

## <a name="next-steps"></a>Дальнейшие действия

Процесс регистрации Службы подготовки устройств к добавлению в Центр Интернета вещей позволяет задать идентификатор устройства и теги двойников устройств параллельно с подготовкой нового устройства. Эти значения можно использовать для указания отдельных устройств или групп устройств с помощью автоматического управления устройствами. Узнайте, как [развертывать и отслеживать модули IOT EDGE в масштабе с помощью портал Azure](how-to-deploy-at-scale.md) или [с помощью Azure CLI](how-to-deploy-cli-at-scale.md).