---
title: Развертывание модулей в масштабе в портал Azure Azure IoT Edge
description: Создание задач автоматического развертывания для групп устройств IoT Edge с помощью портала Azure
keywords: ''
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 10/13/2020
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: db27a466ca5f1370e8b43ceb472f5deeaba509f1
ms.sourcegitcommit: 5f32f03eeb892bf0d023b23bd709e642d1812696
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/12/2021
ms.locfileid: "103200320"
---
# <a name="deploy-iot-edge-modules-at-scale-using-the-azure-portal"></a>Развертывание модулей IoT Edge в масштабе с помощью портал Azure

[!INCLUDE [iot-edge-version-all-supported](../../includes/iot-edge-version-all-supported.md)]

Создайте **IOT Edge автоматическое развертывание** в портал Azure, чтобы управлять текущими развертываниями для нескольких устройств одновременно. Автоматические развертывания для IoT Edge входят в состав функции [автоматического управления устройствами](../iot-hub/iot-hub-automatic-device-management.md) в Центре Интернета вещей. Развертывания — это динамические процессы, которые позволяют развертывать несколько модулей на нескольких устройствах, отслеживать состояние и работоспособность этих модулей и вносить изменения при необходимости.

Дополнительные сведения см. в статье [Общие сведения об автоматических развертываниях IoT Edge для отдельных устройств или в большом масштабе](module-deployment-monitoring.md).

## <a name="identify-devices-using-tags"></a>Определение устройств с помощью тегов

Перед созданием развертывания необходимо указать устройства, на которые вы хотите повлиять. Azure IoT Edge определяет устройства с помощью **тегов** в двойнике устройства. Каждое устройство может иметь несколько тегов, которые вы определяете по своему усмотрению с учетом особенностей решения.

Например, при управлении кампусом интеллектуальных зданий на устройство можно добавить расположение, тип комнаты и Теги среды:

```json
"tags":{
  "location":{
    "building": "20",
    "floor": "2"
  },
  "roomtype": "conference",
  "environment": "prod"
}
```

Дополнительные сведения о двойниках устройств и тегах см. в статье [Общие сведения о двойниках устройств и их использование в Центре Интернета вещей](../iot-hub/iot-hub-devguide-device-twins.md).

## <a name="create-a-deployment"></a>Создание развертывания

IoT Edge предоставляет два различных типа автоматических развертываний, которые можно использовать для настройки сценария. Можно создать стандартное *развертывание*, которое включает в себя модули среды выполнения системы и дополнительные модули и маршруты. Каждое устройство может применять только одно развертывание. Также можно создать *многослойное развертывание*, которое включает в себя только пользовательские модули и маршруты, а не системную среду выполнения. Многие многоуровневые развертывания можно объединять на устройстве на основе стандартного развертывания. Дополнительные сведения о совместной работе двух типов автоматических развертываний см. [в статье IOT Edge автоматическое развертывание для отдельных устройств или в масштабе](module-deployment-monitoring.md).

Шаги по созданию развертывания и многоуровневого развертывания очень похожи. Все различия вызываются в следующих шагах.

1. В [портал Azure](https://portal.azure.com)перейдите в центр Интернета вещей.
1. В меню в левой области выберите **IOT Edge** в разделе **Автоматическое управление устройствами**.
1. На верхней панели выберите **Создать развертывание** или **создать многоуровневую развертывание**.

Процедура создания развертывания состоит из пяти шагов. В следующих разделах описан каждый из этих шагов.

>[!NOTE]
>Действия, описанные в этой статье, соответствуют последней версии схемы агента и концентратора IoT Edge. Версия схемы 1,1 была выпущена вместе с IoT Edge версии 1.0.10 и включает порядок запуска модуля и возможности определения приоритетов маршрутов.
>
>При развертывании на устройстве под управлением версии 1.0.9 или более ранней измените **Параметры среды выполнения** **на шаге мастера, чтобы** использовать схему версии 1,0.

### <a name="step-1-name-and-label"></a>Шаг 1. имя и метка

1. Присвойте своему развертыванию уникальное имя, содержащее до 128 букв в нижнем регистре. Не используйте пробелы и следующие недопустимые символы: `& ^ [ ] { } \ | " < > /`.
1. Вы можете добавить метки в виде пар "ключ —значение" для отслеживания развертываний. Например, **HostPlatform** и **Linux** или **Версия** и **3.0.1**.
1. Нажмите кнопку **Далее: модули** , чтобы перейти к шагу 2.

### <a name="step-2-modules"></a>Шаг 2. модули

В развертывание можно добавить до 50 модулей. Если вы создаете развертывание без модулей, оно удаляет все текущие модули с целевых устройств.

В развернутых средах можно управлять параметрами агента IoT Edge и модулей IoT Edge концентратора. Выберите **Параметры среды выполнения** , чтобы настроить два модуля среды выполнения. В многоуровневом развертывании модули среды выполнения не включаются, поэтому их нельзя настроить.

Чтобы добавить пользовательский код в качестве модуля или вручную добавить модуль службы Azure, сделайте следующее:

1. В разделе **параметры реестра контейнеров** на странице Укажите учетные данные для доступа к любым частным реестрам контейнеров, содержащим образы модулей.
1. В разделе **IOT Edge модули** страницы щелкните **Добавить**.
1. В раскрывающемся меню выберите один из трех типов модулей:

   * **Модуль IOT Edge** . Вы предоставляете имя модуля и URI образа контейнера. Например, универсальный код ресурса (URI) образа для примера модуля Симулатедтемпературесенсор — `mcr.microsoft.com/azureiotedge-simulated-temperature-sensor:1.0` . Если образ модуля хранится в частном реестре контейнеров, добавьте учетные данные на этой странице для доступа к образу.
   * **Модуль Marketplace** — модули, размещенные в Azure Marketplace. Для некоторых модулей Marketplace требуется дополнительная настройка, поэтому ознакомьтесь со сведениями о модуле в списке [модулей IOT Edge Azure Marketplace](https://azuremarketplace.microsoft.com/marketplace/apps/category/internet-of-things?page=1&subcategories=iot-edge-modules) .
   * **Azure Stream Analytics модуля** — модули, созданные из рабочей нагрузки Azure Stream Analytics.

1. При необходимости повторите шаги 2 и 3, чтобы добавить дополнительные модули в развертывание.

После добавления модуля в развертывание можно выбрать его имя, чтобы открыть страницу **обновление IOT Edge модуля** . На этой странице можно изменить параметры модуля, переменные среды, параметры создания, порядок запуска и двойника модуля. Если вы добавили модуль из Marketplace, возможно, некоторые из этих параметров уже заполнены. Дополнительные сведения о доступных параметрах модуля см. в разделе [Настройка модуля и управление](module-composition.md#module-configuration-and-management).

При создании многоуровневого развертывания вы можете настроить модуль, который существует в других развертываниях, предназначенных для тех же устройств. Чтобы обновить модуль двойника без перезаписи других версий, откройте вкладку **Параметры двойника модуля** . Создайте новое **свойство двойника модуля** с уникальным именем для подраздела в нужных свойствах модуля двойника, например `properties.desired.settings` . Если свойства определяются только в `properties.desired` поле, то будут перезаписаны требуемые свойства для модуля, определенного при развертывании с более низким приоритетом.

![Задание свойства двойника модуля для многоуровневого развертывания](./media/how-to-deploy-monitor/module-twin-property.png)

Дополнительные сведения о конфигурации модуля двойника в многоуровневых развертываниях см. в разделе [Иерархическое развертывание](module-deployment-monitoring.md#layered-deployment).

После того как все модули для развертывания настроены, нажмите кнопку **Далее: Маршруты** , чтобы перейти к шагу 3.

### <a name="step-3-routes"></a>Шаг 3. маршруты

На вкладке **Маршруты** определите способ передачи сообщений между модулями и Центром Интернета вещей. Сообщения создаются с использованием пар "имя — значение".

Например, маршрут с именем **Route** и значение **из/мессажес/ \* в $upstream** будут принимать любые сообщения, выводимые любыми модулями, и передавать их в центр Интернета вещей.  

Параметры **Priority** и **time to Live** — необязательные параметры, которые можно включить в определение маршрута. Параметр Priority позволяет выбрать маршруты, которые должны обрабатываться в первую очередь, или маршруты, которые должны быть обработаны последними. Приоритет определяется установкой числа 0-9, где 0 — высший приоритет. Параметр срока жизни позволяет объявлять, как долго сообщения в этом маршруте должны удерживаться, пока они не будут обработаны или удалены из очереди.

Дополнительные сведения о создании маршрутов см. в разделе [объявление маршрутов](module-composition.md#declare-routes).

Выберите **Далее: метрики**.

### <a name="step-4-metrics"></a>Шаг 4. метрики

Метрики предоставляют общее количество различных состояний, которые устройство может передавать в результате применения содержимого конфигурации.

1. Введите имя для параметра **Имя метрики**.

1. Введите запрос для параметра **Metric Criteria** (Критерии метрики). Запрос основан на [переданных свойствах](module-edgeagent-edgehub.md#edgehub-reported-properties) двойников модуля центра IoT Edge. Метрика представляет количество строк, возвращаемых запросом.

   Пример:

   ```sql
   SELECT deviceId FROM devices
     WHERE properties.reported.lastDesiredStatus.code = 200
   ```

Выберите **Далее: целевые устройства**.

### <a name="step-5-target-devices"></a>Шаг 5. целевые устройства

С помощью свойств тегов ваших устройств можно назначить конкретные устройства, к которым будет применяться это развертывание.

Так как несколько развертываний могут предназначаться для одного устройства, каждому развертыванию необходимо присвоить номер приоритета. Если возникает конфликт, развертывание с наивысшим приоритетом (более крупные значения указывает более высокий приоритет) WINS. Когда оба развертывания имеют одинаковый номер приоритета, побеждает то, которое было создано недавно.

Если несколько развертываний нацелены на одно и то же устройство, применяется только одно из них с более высоким приоритетом. Если несколько многоуровневых развертываний нацелены на одно и то же устройство, все они применяются. Однако если какие бы то ни было свойства дублируются, например при наличии двух маршрутов с одним и тем же именем, то все остальное будет перезаписано одним из слоев с более высоким приоритетом.

Любое многоуровневое развертывание, предназначенное для устройства, должно иметь более высокий приоритет, чем базовое развертывание, чтобы оно было применено.

1. Введите положительное целое число для **приоритета** развертывания.
1. Введите **условие назначения**, чтобы определить, для каких устройств будет предназначено это развертывание.  Условие основано на тегах двойника устройства или его сообщаемых свойствах и должно соответствовать формату выражения. Например, `tags.environment='test'` или `properties.reported.devicemodel='4000x'`.

Нажмите кнопку **Далее: Проверка + создать** , чтобы перейти к последнему шагу.

### <a name="step-6-review-and-create"></a>Шаг 6. Проверка и создание

Просмотрите сведения о развертывании и нажмите кнопку **создать**.

Сведения о мониторинге развертывания см. в статье [monitoring IOT Edge deployments](how-to-monitor-iot-edge-deployments.md).

## <a name="modify-a-deployment"></a>Изменение развертывания

При изменении развертывания изменения немедленно реплицируются во все целевые устройства. Для существующего развертывания можно изменить следующие параметры и компоненты.

* Целевые условия
* Настраиваемые метрики
* Метки
* Теги
* Требуемые свойства

### <a name="modify-target-conditions-custom-metrics-and-labels"></a>Изменение целевых условий, пользовательских метрик и меток

1. В центре Интернета вещей выберите **IOT Edge** в меню слева.
1. Перейдите на вкладку **IOT Edge развертывания** , а затем выберите развертывание, которое требуется настроить.
1. Перейдите на вкладку **условие назначения** . Измените **целевое условие** , чтобы оно предназначалось для целевых устройств. Также можно изменить **приоритет**.  Щелкните **Сохранить**.

    Если обновить целевое условие, произойдут следующие обновления:

    * Если устройство не соответствует предыдущему условию назначения, однако соответствует новому и это развертывание имеет самый высокий приоритет для устройства, то оно будет применено к устройству.
    * Если устройство, на котором сейчас выполняется развертывание, больше не соответствует условию назначения, оно удаляет это развертывание и выполняет следующее развертывание с самым высоким приоритетом.
    * Если устройство, на котором сейчас выполняется развертывание, больше не соответствует условию назначения, а также условию назначения любого другого развертывания, в устройстве не происходит никаких изменений. Устройство продолжает выполнять текущие модули в их актуальном состоянии, однако больше не управляется как часть этого развертывания. Если устройство соответствует условию назначения любого другого развертывания, оно удаляет это развертывание и выполняет новое.

1. Перейдите на вкладку **метрики** и нажмите кнопку **Изменить метрики** . Добавьте или измените пользовательские метрики, используя пример синтаксиса в качестве инструкции. Щелкните **Сохранить**.

    ![Изменение пользовательских метрик в развертывании](./media/how-to-deploy-monitor/metric-list.png)

1. Перейдите на вкладку **метки** и внесите необходимые изменения и нажмите кнопку **сохранить**.

## <a name="delete-a-deployment"></a>Удаление развертывания

При удалении развертывания все развернутые устройства принимаются в следующем развертывании с наивысшим приоритетом. Если устройства не соответствуют условиям назначения любого другого развертывания, то модули не будут удалены при удалении развертывания.

1. Войдите на [портал Azure](https://portal.azure.com) и перейдите к своему Центру Интернета вещей.
1. Выберите **IoT Edge**.
1. Перейдите на вкладку **развертывания IOT Edge** .

   ![Просмотр развертываний IoT Edge](./media/how-to-deploy-monitor/iot-edge-deployments.png)

1. Установите флажок, чтобы выбрать развертывание, которое необходимо удалить.
1. Выберите **Удалить**.
1. Появится запрос с сообщением о том, что это действие удалит развертывание и будут возвращены предыдущие состояния всех устройств. Будет применено развертывание с более низким приоритетом. Если не указаны другие развертывания, модули не будут удалены. Чтобы удалить все модули из устройства, создайте развертывание без модулей и разверните его на этом устройстве. Щелкните **Да**, чтобы продолжить.

## <a name="next-steps"></a>Дальнейшие действия

Подробную информацию см. в статье [Общие сведения об автоматических развертываниях IoT Edge для отдельных устройств или в большом масштабе](module-deployment-monitoring.md).