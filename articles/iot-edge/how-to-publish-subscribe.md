---
title: Публикация и подписка с Azure IoT Edge | Документация Майкрософт
description: Публикация и подписка сообщений с помощью IoT Edge MQTT Broker
services: iot-edge
keywords: ''
author: kgremban
ms.author: kgremban
ms.reviewer: ebertra
ms.date: 11/09/2020
ms.topic: conceptual
ms.service: iot-edge
monikerRange: '>=iotedge-2020-11'
ms.openlocfilehash: 730680b0cb6e8a728ed3072419674346de649368
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "103200688"
---
# <a name="publish-and-subscribe-with-azure-iot-edge"></a>Публикация и подписка с Azure IoT Edge

[!INCLUDE [iot-edge-version-202011](../../includes/iot-edge-version-202011.md)]

Для публикации и подписки сообщений можно использовать Azure IoT Edge MQTT Broker. В этой статье показано, как подключиться к этому брокеру, опубликовать и подписываться на сообщения в разделах, определяемых пользователем, и использовать примитивы обмена сообщениями центра Интернета вещей. Компонент IoT Edge MQTT Broker встроен в центр IoT Edge. Дополнительные сведения см. [в статье возможности брокера центра IOT Edge](iot-edge-runtime.md).

> [!NOTE]
> IoT Edge MQTT Broker в настоящее время находится в общедоступной предварительной версии.

## <a name="pre-requisites"></a>Предварительные требования

- Учетная запись Azure с действительной подпиской
- [Azure CLI](/cli/azure/) с `azure-iot` установленным расширением CLI. Дополнительные сведения см. [в статье инструкции по установке расширения Azure IOT для Azure CLI Azure](/cli/azure/azure-cli-reference-for-iot).
- **Центр Интернета вещей** с номером SKU: F1, S1, S2 или S3.
- Наличие **IOT Edge устройства с версией 1,2 или более поздней**. Так как IoT Edge MQTT Broker в настоящее время находится в общедоступной предварительной версии, задайте для следующих переменных среды значение true в контейнере edgeHub, чтобы включить брокер MQTT:

   | Имя | Значение |
   | - | - |
   | `experimentalFeatures__enabled` | `true` |
   | `experimentalFeatures__mqttBrokerEnabled` | `true` |

- **Клиенты москуитто** , установленные на устройстве IOT Edge. В этой статье используются популярные клиенты Москуитто [MOSQUITTO_PUB](https://mosquitto.org/man/mosquitto_pub-1.html) и [MOSQUITTO_SUB](https://mosquitto.org/man/mosquitto_sub-1.html). Вместо этого можно использовать другие клиенты MQTT. Чтобы установить клиенты Москуитто на устройстве Ubuntu, выполните следующую команду:

    ```cmd
    sudo apt-get update && sudo apt-get install mosquitto-clients
    ```

    Не устанавливайте сервер Москуитто, так как он может привести к блокировке портов MQTT (8883 и 1883) и конфликтов с концентратором IoT Edge.

## <a name="connect-to-iot-edge-hub"></a>Подключение к концентратору IoT Edge

Подключение к IoT Edge концентратору выполняется так же, как описано в [статье подключение к центру Интернета вещей с помощью универсальной клиентской статьи MQTT](../iot-hub/iot-hub-mqtt-support.md) или в [концептуальном описании статьи о центре IOT Edge](iot-edge-runtime.md). Ниже приведены эти действия.

1. При необходимости клиент MQTT устанавливает *безопасное подключение* к концентратору IOT Edge с помощью протокола TLS.
2. Клиент MQTT *выполняет проверку подлинности* в центре IOT Edge
3. Центр IoT Edge *авторизует* клиента MQTT в соответствии с политикой авторизации.

### <a name="secure-connection-tls"></a>Безопасное соединение (TLS)

Протокол TLS используется для установления зашифрованного обмена данными между клиентом и концентратором IoT Edge.

Чтобы отключить TLS, используйте порт 1883 (MQTT) и свяжите контейнер edgeHub с портом 1883.

Чтобы включить TLS, если клиент подключается через порт 8883 (МКТТС) к брокеру MQTT, будет инициирован канал TLS. Брокер отправляет свою цепочку сертификатов, которую клиент должен проверить. Чтобы проверить цепочку сертификатов, корневой сертификат брокера MQTT должен быть установлен в качестве доверенного сертификата на клиенте. Если корневой сертификат не является доверенным, клиентская библиотека будет отклонена брокером MQTT с ошибкой проверки сертификата. Шаги по установке этого корневого сертификата брокера на клиенте аналогичны действиям в случае с [прозрачным шлюзом](how-to-create-transparent-gateway.md) и описаны в документации [Подготовка подчиненного устройства](how-to-connect-downstream-device.md#prepare-a-downstream-device) .

### <a name="authentication"></a>Аутентификация

Чтобы клиент MQTT сам пропускал проверку подлинности, ему сначала нужно отправить пакет CONNECT в брокер MQTT, чтобы инициировать подключение в его имени. Этот пакет предоставляет три части сведений для проверки подлинности: a `client identifier` , а `username` и a `password` :

- `client identifier`Поле представляет имя устройства или модуля в центре Интернета вещей. Для этого используется следующий синтаксис:

  - Для устройства: `<device_name>`

  - Для модуля: `<device_name>/<module_name>`

   Чтобы подключиться к брокеру MQTT, необходимо зарегистрировать устройство или модуль в центре Интернета вещей.

   Брокер не будет разрешать соединения от нескольких клиентов, используя одни и те же учетные данные. Брокер отключит уже подключенный клиент, если второй клиент подключается с использованием тех же учетных данных.

- `username`Поле является производным от имени устройства или модуля, а имя IoTHub, к которому принадлежит устройство, использует следующий синтаксис:

  - Для устройства: `<iot_hub_name>.azure-devices.net/<device_name>/?api-version=2018-06-30`

  - Для модуля: `<iot_hub_name>.azure-devices.net/<device_name>/<module_name>/?api-version=2018-06-30`

- `password`Поле пакета Connect зависит от режима проверки подлинности:

  - При использовании [проверки подлинности с симметричными ключами](how-to-authenticate-downstream-device.md#symmetric-key-authentication) `password` поле является маркером SAS.
  - При использовании [самоподписанной проверки подлинности X. 509](how-to-authenticate-downstream-device.md#x509-self-signed-authentication) `password` поле отсутствует. В этом режиме проверки подлинности требуется TLS-канал. Чтобы установить TLS-подключение, клиенту необходимо подключиться к порту 8883. Во время подтверждения TLS брокер MQTT запрашивает сертификат клиента. Этот сертификат используется для проверки подлинности клиента, поэтому `password` поле не требуется в дальнейшем при отправке пакета подключения. Отправка как сертификата клиента, так и поля пароля приведет к ошибке, и соединение будет закрыто. Библиотеки MQTT и клиентские библиотеки TLS обычно позволяют отправить сертификат клиента при инициализации подключения. Пошаговый пример см. в разделе [использование сертификата X509 для проверки подлинности клиента](how-to-authenticate-downstream-device.md#x509-self-signed-authentication).

Модули, развернутые IoT Edge, используют [проверку подлинности симметричных ключей](how-to-authenticate-downstream-device.md#symmetric-key-authentication) и могут вызывать [интерфейс API рабочей нагрузки локального IOT Edge](https://github.com/Azure/iotedge/blob/40f10950dc65dd955e20f51f35d69dd4882e1618/edgelet/workload/README.md) для программного получения маркера SAS даже в автономном режиме.

### <a name="authorization"></a>Авторизация

После проверки подлинности клиента MQTT в центр IoT Edge ему необходимо иметь разрешение на подключение. После подключения ему необходимо иметь права на публикацию или подписываться на определенные разделы. Эти авторизации предоставляются центром IoT Edge в соответствии с политикой авторизации. Политика авторизации — это набор инструкций, выраженный в виде структуры JSON, которая отправляется в центр IoT Edge через его двойника. Измените двойника центра IoT Edge, чтобы настроить его политику авторизации.

> [!NOTE]
> Для общедоступной предварительной версии изменение политик авторизации компонента MQTT Broker доступно только в Visual Studio, Visual Studio Code или Azure CLI. В настоящее время портал Azure не поддерживает изменение двойникаа центра IoT Edge и его политики авторизации.

Каждая инструкция политики авторизации состоит из сочетания `identities` `allow` эффектов, или, `deny` `operations` и `resources` :

- `identities` Опишите тему политики. Он должен сопоставляться с `client identifier` отправленными клиентами в пакете подключения.
- `allow` или `deny` эффекты определяют, следует ли разрешать или запрещать операции.
- `operations` Определите действия для авторизации. `mqtt:connect``mqtt:publish`и `mqtt:subscribe` сегодня являются тремя поддерживаемыми действиями.
- `resources` Определите объект политики. Это может быть раздел или шаблон раздела, определенный с помощью [подстановочных знаков MQTT](https://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html#_Toc398718107).

Ниже приведен пример политики авторизации, которая явно не разрешает подключение клиента "rogue_client", позволяет всем клиентам Azure IoT подключаться и позволяет "sensor_1" публиковать в разделе `events/alerts` .

```json
{
   "$edgeHub":{
      "properties.desired":{
         "schemaVersion":"1.2",
         "routes":{
            "Route1":"FROM /messages/* INTO $upstream"
         },
         "storeAndForwardConfiguration":{
            "timeToLiveSecs":7200
         },
         "mqttBroker":{
            "authorizations":[
               {
                  "identities":[
                     "rogue_client"
                  ],
                  "deny":[
                     {
                        "operations":[
                           "mqtt:connect"
                        ]
                     }
                  ]
               },
               {
                  "identities":[
                     "{{iot:identity}}"
                  ],
                  "allow":[
                     {
                        "operations":[
                           "mqtt:connect"
                        ]
                     }
                  ]
               },
               {
                  "identities":[
                     "sensor_1"
                  ],
                  "allow":[
                     {
                        "operations":[
                           "mqtt:publish"
                        ],
                        "resources":[
                           "events/alerts"
                        ]
                     }
                  ]
               }
            ]
         }
      }
   }
}
```

При написании политики авторизации следует учитывать ряд моментов.

- Для этого требуется `$edgeHub` схема двойника версии 1,2
- По умолчанию все операции запрещены.
- Инструкции авторизации оцениваются в том порядке, в котором они отображаются в определении JSON. Он начинается с просмотра `identities` , а затем выбора первой инструкции Allow или Deny, соответствующей запросу. В случае конфликтов между операторами allow и Deny инструкция DENY побеждает.
- В политике авторизации можно использовать несколько переменных (например, подстановки):
    - `{{iot:identity}}` представляет идентификатор подключенного в данный момент клиента. Например, удостоверение устройства, например, `myDevice` или удостоверение модуля, например `myEdgeDevice/SampleModule` .
    - `{{iot:device_id}}` представляет идентификатор подключенного в данный момент устройства. Например, удостоверение устройства, например `myDevice` или удостоверение устройства, в котором работает модуль `myEdgeDevice` .
    - `{{iot:module_id}}` представляет идентификатор подключенного в данный момент модуля. Эта переменная пуста для подключенных устройств или удостоверения модуля, например `SampleModule` .
    - `{{iot:this_device_id}}` представляет идентификатор устройства IoT Edge, на котором запущена политика авторизации. Например, `myIoTEdgeDevice`.

Разрешения для разделов центра Интернета вещей обрабатываются немного иначе, чем пользовательские разделы. Вот основные моменты, которые следует помнить:

- Устройствам или модулям Azure IoT требуется явное правило авторизации для подключения к IoT Edge Broker концентратора MQTT. Ниже приведена Политика авторизации подключений по умолчанию.
- Устройства или модули Azure IoT по умолчанию могут получать доступ к своим темам центра Интернета вещей без явного правила авторизации. Однако в этом случае авторизация обусловлена связями "родители-потомки", и эти связи должны быть установлены. IoT Edge модули автоматически устанавливаются как дочерние элементы своего IoT Edge устройства, но необходимо явно задать их как дочерние элементы шлюза IoT Edge.

Ниже приведена Политика авторизации по умолчанию, которую можно использовать, чтобы разрешить всем устройствам или модулям Azure IoT **подключаться** к брокеру:

```json
{
   "$edgeHub":{
      "properties.desired":{
         "schemaVersion":"1.2",
         "mqttBroker":{
            "authorizations":[
               {
                  "identities": [
                     "{{iot:identity}}"
                  ],
                  "allow":[
                     {
                        "operations":[
                           "mqtt:connect"
                        ]
                     }
                  ]
               }
            ]
         }
      }
   }
}
```

Теперь, когда вы понимаете, как подключиться к IoT Edge MQTT Broker, давайте посмотрим, как он может использоваться для публикации и подписки сообщений в пользовательских разделах, а затем — в разделах центра Интернета вещей и, наконец, в другой брокер MQTT.

## <a name="publish-and-subscribe-on-user-defined-topics"></a>Публикация и подписка на пользовательские разделы

В этой статье вы будете использовать один клиент с именем **sub_client** , который подписывается на раздел, и другой клиент с именем **pub_client** , который публикуется в разделе. Мы будем использовать [проверку подлинности с симметричным ключом](how-to-authenticate-downstream-device.md#symmetric-key-authentication) , но это можно сделать с помощью [самоподписанной аутентификации x. 509](how-to-authenticate-downstream-device.md#x509-self-signed-authentication) или [проверки подлинности, подписанной ЦС x. 509](./how-to-authenticate-downstream-device.md#x509-ca-signed-authentication).

### <a name="create-publisher-and-subscriber-clients"></a>Создание клиентов издателя и подписчика

Создание двух устройств IoT в центре Интернета вещей и получение их паролей. Использование Azure CLI из терминала для:

1. Создайте два устройства IoT в центре Интернета вещей, родительские на устройство IoT Edge:

    ```azurecli-interactive
    az iot hub device-identity create --device-id  sub_client --hub-name <iot_hub_name> --pd <edge_device_id>
    az iot hub device-identity create --device-id  pub_client --hub-name <iot_hub_name> --pd <edge_device_id>
    ```

2. Получите пароли, создав маркер SAS:

    - Для устройства:
    
       ```azurecli-interactive
       az iot hub generate-sas-token -n <iot_hub_name> -d <device_name> --key-type primary --du 3600
       ```
    
       где 3600 — длительность маркера SAS в секундах (например, 3600 = 1 час).
    
    - Для модуля:
    
       ```azurecli-interactive
       az iot hub generate-sas-token -n <iot_hub_name> -d <device_name> -m <module_name> --key-type primary --du 3600
       ```
    
       где 3600 — длительность маркера SAS в секундах (например, 3600 = 1 час).

3. Скопируйте маркер SAS, который является значением, соответствующим ключу "SAS", из выходных данных. Ниже приведен пример выходных данных команды Azure CLI.

    ```
    {
       "sas": "SharedAccessSignature sr=example.azure-devices.net%2Fdevices%2Fdevice_1%2Fmodules%2Fmodule_a&sig=H5iMq8ZPJBkH3aBWCs0khoTPdFytHXk8VAxrthqIQS0%3D&se=1596249190"
    }
    ```

### <a name="authorize-publisher-and-subscriber-clients"></a>Авторизация клиентов издателя и подписчика

Чтобы авторизовать издателя и подписчика, измените двойника центра IoT Edge, создав развертывание IoT Edge с помощью Azure CLI, Visual Studio или Visual Studio Code, чтобы включить следующую политику авторизации:

```json
{
   "$edgeHub":{
      "properties.desired":{
         "schemaVersion":"1.2",
         "mqttBroker":{
            "authorizations":[
               {
                  "identities": [
                     "{{iot:identity}}"
                  ],
                  "allow":[
                     {
                        "operations":[
                           "mqtt:connect"
                        ]
                     }
                  ]
               },
               {
                  "identities": [
                     "<iot_hub_name>.azure-devices.net/sub_client"
                  ],
                  "allow":[
                     {
                        "operations":[
                           "mqtt:subscribe"
                        ],
                        "resources":[
                           "test_topic"
                        ]
                     }
                  ],
               },
               {
                  "identities": [
                     "<iot_hub_name>.azure-devices.net/pub_client"
                  ],
                  "allow":[
                     {
                        "operations":[
                           "mqtt:publish"
                        ],
                        "resources":[
                           "test_topic"
                        ]
                     }
                  ]
               }
            ]
         }
      }
   }
}
```

### <a name="symmetric-keys-authentication-without-tls"></a>Проверка подлинности симметричных ключей без TLS

#### <a name="subscribe"></a>Подписка.

Подключите клиент **sub_client** MQTT к брокеру MQTT и подпишитесь на `test_topic` устройство, выполнив следующую команду на устройстве IOT Edge:

```bash
mosquitto_sub \
    -t "test_topic" \
    -i "sub_client" \
    -u "<iot_hub_name>.azure-devices.net/sub_client/?api-version=2018-06-30" \
    -P "<sas_token>" \
    -h "<edge_device_address>" \
    -V mqttv311 \
    -p 1883
```

`<edge_device_address>`  =  `localhost` в этом примере, так как клиент выполняется на том же устройстве, что и IOT Edge.

Обратите внимание, что в первом примере используется порт 1883 (MQTT) без протокола TLS. Еще один пример с портом 8883 (МКТТС) с включенным протоколом TLS показан в следующем разделе.

Теперь клиент **sub_client** MQTT запущен и ожидает входящих сообщений `test_topic` .

#### <a name="publish"></a>Публикация

Подключите клиент **pub_client** MQTT к брокеру MQTT и опубликуйте сообщение, `test_topic` как описано выше, выполнив следующую команду на устройстве IOT Edge с другого терминала:

```bash
mosquitto_pub \
    -t "test_topic" \
    -i "pub_client" \
    -u "<iot_hub_name>.azure-devices.net/pub_client/?api-version=2018-06-30" \
    -P "<sas_token>" \
    -h "<edge_device_address>" \
    -V mqttv311 \
    -p 1883 \
    -m "hello"
```

`<edge_device_address>`  =  `localhost` в этом примере, так как клиент выполняется на том же устройстве, что и IOT Edge.

Выполняя команду, **sub_client** клиент MQTT получает сообщение "Hello".

### <a name="symmetric-keys-authentication-with-tls"></a>Проверка подлинности симметричных ключей с помощью TLS

Чтобы включить TLS, необходимо изменить порт с 1883 (MQTT) на 8883 (МКТТС), и клиенты должны иметь корневой сертификат брокера MQTT, чтобы иметь возможность проверить цепочку сертификатов, отправленную брокером MQTT. Это можно сделать, выполнив действия, описанные в разделе [безопасное соединение (TLS)](#secure-connection-tls).

Так как клиенты работают на том же устройстве, что и брокер MQTT в приведенном выше примере, те же действия применяются для включения TLS, просто путем изменения номера порта с 1883 (MQTT) на 8883 (МКТТС).

## <a name="publish-and-subscribe-on-iot-hub-topics"></a>Статьи по публикации и подписываться на центр Интернета вещей

[Пакеты SDK для устройств Azure IOT](https://github.com/Azure/azure-iot-sdks) уже позволяют клиентам выполнять операции центра Интернета вещей, но они не допускают публикацию и подписку в пользовательских разделах. Операции центра Интернета вещей можно выполнять с помощью любых клиентов MQTT, использующих семантику публикации и подписки при условии, что учитываются протоколы примитивов центра Интернета вещей. Мы проверим особенности работы этих протоколов.

### <a name="send-telemetry-data-to-iot-hub"></a>Отправка данных телеметрии в Центр Интернета вещей

Отправка данных телеметрии в центр Интернета вещей аналогична публикации в разделе, определяемом пользователем, но с помощью определенного раздела центра Интернета вещей:

- Для устройства данные телеметрии отправляются в разделе: `devices/<device_name>/messages/events/`
- Для модуля данные телеметрии отправляются в разделе: `devices/<device_name>/<module_name>/messages/events/`

Кроме того, создайте маршрут, например, `FROM /messages/* INTO $upstream` для отправки данных телеметрии из брокера IOT Edge MQTT в центр Интернета вещей. Дополнительные сведения о маршрутизации см. в разделе [объявление маршрутов](module-composition.md#declare-routes).

### <a name="get-twin"></a>Получить двойника

Получение двойникаа устройства или модуля не является типичным шаблоном MQTT. Клиенту необходимо отправить запрос на двойника, который будет обслуживать центр Интернета вещей.

Чтобы получить двойников, клиенту необходимо подписываться на раздел, относящийся к центру Интернета вещей `$iothub/twin/res/#` . Это имя раздела наследуется из центра Интернета вещей, и все клиенты должны подписываться на один и тот же раздел. Это не означает, что устройства или модули получают двойника друг друга. Центр Интернета вещей и центр IoT Edge знают, какие двойника должны быть доставлены, даже если все устройства ожидают одно и то же имя раздела. 

После создания подписки клиент должен запросить двойника, опубликовав сообщение в конкретном разделе центра Интернета вещей, `$iothub/twin/GET/?rid=<request_id>/#` где  `<request_id>` — произвольный идентификатор. Затем центр Интернета вещей отправит ответ с запрошенными данными по разделу `$iothub/twin/res/200/?rid=<request_id>` , на который подписывается клиент. Таким способом клиент может связать свои запросы с ответами.

### <a name="receive-twin-patches"></a>Получение исправлений двойника

Чтобы получить исправления двойника, клиенту необходимо подписываться на специальный раздел IoTHub `$iothub/twin/PATCH/properties/desired/#` . После создания подписки клиент получает исправления двойника, отправленные центром Интернета вещей, в этом разделе. 

### <a name="receive-direct-methods"></a>Получить прямые методы

Получение прямого метода похоже на получение полных двойников с добавлением клиента, который должен подтвердить, что он получил вызов. Сначала клиент подписывается на специальный раздел центра Интернета вещей `$iothub/methods/POST/#` . После получения прямого метода в этом разделе клиенту необходимо извлечь идентификатор запроса `rid` из подраздела, в котором получен прямой метод, и, наконец, опубликовать сообщение с подтверждением в центре Интернета вещей в специальном разделе `$iothub/methods/res/200/<request_id>` .

### <a name="send-direct-methods"></a>Отправить прямые методы

Отправка прямого метода является вызовом HTTP и поэтому не проходит через брокер MQTT. Сведения о том, как отправить прямой метод в центр Интернета вещей, см. в разделе [изучение и вызов прямых методов](../iot-hub/iot-hub-devguide-direct-methods.md). Чтобы отправить прямой метод локально в другой модуль, см. [Пример вызова прямого метода для пакета SDK для C# для Azure IOT](https://github.com/Azure/azure-iot-sdk-csharp/blob/master/iothub/device/src/ModuleClient.cs#L597).

## <a name="publish-and-subscribe-between-mqtt-brokers"></a>Публикация и подписка между брокерами MQTT

Для подключения двух брокеров MQTT центр IoT Edge включает мост MQTT. Мост MQTT обычно используется для подключения брокера MQTT, работающего с другим брокером MQTT. Как правило, только подмножество локального трафика передается другому брокеру.

> [!NOTE]
> В настоящее время мост концентратора IoT Edge можно использовать только между вложенными устройствами IoT Edge. Его нельзя использовать для отправки данных в центр Интернета вещей, так как центр Интернета вещей не является полнофункциональным брокером MQTT. Дополнительные сведения о поддержке функций брокера MQTT центра Интернета вещей см. в статье [взаимодействие с центром Интернета вещей с помощью протокола MQTT](../iot-hub/iot-hub-mqtt-support.md). Дополнительные сведения о вложении IoT Edge устройств см. в статье [Подключение подчиненного устройства IOT Edge к шлюзу Azure IOT Edge](how-to-connect-downstream-iot-edge-device.md#configure-iot-edge-on-devices) 

Во вложенной конфигурации мост MQTT концентратора IoT Edge выступает в качестве клиента родительского брокера MQTT, поэтому необходимо установить правила авторизации в родительском EdgeHub, чтобы разрешить дочерним EdgeHub публиковать и подписываться на определенные пользователем разделы, для которых настроен мост.

Мост IoT Edge MQTT настраивается с помощью структуры JSON, которая отправляется в центр IoT Edge через его двойника. Измените двойника центра IoT Edge, чтобы настроить его мост MQTT.

> [!NOTE]
> Для общедоступной предварительной версии настройка моста MQTT доступна только в Visual Studio, Visual Studio Code или Azure CLI. В настоящее время портал Azure не поддерживает изменение конфигурации центра IoT Edge и его настройки моста MQTT.

Мост MQTT можно настроить для подключения брокера MQTT центра IoT Edge к нескольким внешним брокерам. Для каждого внешнего брокера требуются следующие параметры.

- `endpoint` адрес удаленного брокера MQTT, к которому необходимо подключиться. В настоящее время поддерживаются только родительские устройства IoT Edge и определены переменной `$upstream` .
- `settings` определяет разделы для моста для конечной точки. Для каждой конечной точки может быть несколько параметров, и для их настройки используются следующие значения:
    - `direction`: `in` для подписки на разделы удаленного брокера или `out` для публикации в темах удаленного брокера.
    - `topic`: основной шаблон разделов для сопоставления. Для определения этого шаблона можно использовать [подстановочные знаки MQTT](https://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html#_Toc398718107) . К этому шаблону раздела можно применить разные префиксы в локальном брокере и удаленном брокере.
    - `outPrefix`: Префикс, применяемый к `topic` шаблону в удаленном брокере.
    - `inPrefix`: Префикс, применяемый к `topic` шаблону в локальном брокере.

Ниже приведен пример конфигурации моста IoT Edge MQTT, которая повторно публикует все сообщения, полученные по темам `alerts/#` родительского IOT Edge устройства, на дочернее устройство IOT EDGE в тех же разделах и повторно публикует все сообщения, отправленные в разделах `/local/telemetry/#` дочернего устройства IOT EDGE, на родительское IOT Edgeое устройство в разделах `/remote/messages/#` .

```json
{
    "schemaVersion": "1.2",
    "mqttBroker": {
        "bridges": [{
            "endpoint": "$upstream",
            "settings": [{
                    "direction": "in",
                    "topic": "alerts/#"
                },
                {
                    "direction": "out",
                    "topic": "",
                    "inPrefix": "/local/telemetry",
                    "outPrefix": "/remote/messages"
                }
            ]
        }]
    }
}
```
Другие примечания к мосту MQTT концентратора IoT Edge:
- Протокол MQTT будет автоматически использоваться в качестве вышестоящего протокола при использовании брокера MQTT, а IoT Edge используется во вложенной конфигурации, например с `parent_hostname` указанным. Дополнительные сведения о вышестоящем протоколе см. в разделе [облачная связь](iot-edge-runtime.md#cloud-communication). Дополнительные сведения о вложенных конфигурациях см. в статье [Подключение подчиненного IOT Edge устройства к шлюзу Azure IOT Edge](how-to-connect-downstream-iot-edge-device.md#configure-iot-edge-on-devices).

## <a name="next-steps"></a>Дальнейшие действия

[Общие сведения о центре IoT Edge](iot-edge-runtime.md#iot-edge-hub)
