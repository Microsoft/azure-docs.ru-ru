---
title: Руководство по настройке устройства Azure IoT Edge — Машинное обучение в IoT Edge
description: Работая с этим учебником, вы настроите виртуальную машину Azure под управлением Linux как устройство Azure IoT Edge, которое выполняет функцию прозрачного шлюза.
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 2/5/2020
ms.topic: tutorial
ms.service: iot-edge
services: iot-edge
ms.custom: amqp
ms.openlocfilehash: 65fd6e5b4d494f8e8486d72079b9fa97a175894b
ms.sourcegitcommit: 2654d8d7490720a05e5304bc9a7c2b41eb4ae007
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/13/2021
ms.locfileid: "107376891"
---
# <a name="tutorial-configure-an-azure-iot-edge-device"></a>Руководство по настройке устройства Azure IoT Edge

[!INCLUDE [iot-edge-version-201806](../../includes/iot-edge-version-201806.md)]

В этой статье описано, как настроить виртуальную машину Azure под управлением Linux как устройство Azure IoT Edge, которое выполняет функцию прозрачного шлюза. Так устройства смогут подключаться к Центру Интернета вещей через прозрачный шлюз, ничего не зная о нем. Точно так же и пользователь, взаимодействующий с устройствами в Центре Интернета вещей, не будет знать о промежуточном устройстве шлюза. В итоге мы добавим в систему компонент для передачи аналитических сведений о пограничных устройствах, добавив к прозрачному шлюзу модули IoT Edge.

>[!NOTE]
>Понятия, описанные в этом учебнике, применяются ко всем версиям IoT Edge, но на примере устройства, созданного для пробного использования сценария, выполняется IoT Edge версии 1.1.

Описанные в этой статье действия обычно выполняются разработчиком облачной системы.

Из этого раздела учебника, вы узнаете, как:

> [!div class="checklist"]
>
> * создать сертификаты, позволяющие вашему устройству шлюзу безопасно подключаться к нижестоящим устройствам;
> * создать устройство IoT Edge;
> * создать виртуальную машину Azure для имитации устройства IoT Edge.

## <a name="prerequisites"></a>Предварительные требования

Эта статья входит в серию учебников по использованию Машинного обучения Azure в IoT Edge. Каждая статья в серии основана на инструкциях, выполненных при работе с предыдущей статьей. Если вы нашли сразу эту статью, прочтите [первую статью](tutorial-machine-learning-edge-01-intro.md) этой серии.

## <a name="create-certificates"></a>Создание сертификатов

Чтобы устройство могло функционировать в качестве шлюза, оно должно безопасно подключаться к подчиненным устройствам. Решение IoT Edge позволяет настраивать безопасные подключения между устройствами с использованием инфраструктуры открытых ключей (PKI). В этом случае мы разрешаем подчиненному устройству Интернета вещей подключаться к устройству IoT Edge, выполняющему роль прозрачного шлюза. Чтобы обеспечить достаточный уровень защиты, подчиненное устройство должно подтвердить удостоверение устройства IoT Edge. См. подробнее об [использовании сертификатов на устройствах IoT Edge](iot-edge-certs.md).

В этом разделе мы создадим самозаверяющие сертификаты с помощью образа Docker, который мы скомпилируем и запустим. Мы выбрали для этого действия именно образ Docker, так как он сокращает процедуру создания сертификатов на компьютере разработки Windows. Чтобы понять, что автоматизируется с помощью образа Docker, см. [Создание демонстрационных сертификатов для тестирования функций устройств IoT Edge](how-to-create-test-certificates.md).

1. Войдите на виртуальную машину разработки.
1. Создайте новую папку с путем и именем **c:\edgeCertificates**.

1. Запустите приложение **Docker для Windows** из меню "Пуск" в Windows, если еще не сделали это.

1. Откройте Visual Studio Code.

1. Выберите **Файл** > **Открыть папку** и укажите путь **C:\\source\\IoTEdgeAndMlSample\\CreateCertificates**.

1. В области **Explorer** щелкните правой кнопкой мыши **dockerfile** и выберите **Создать образ**.

1. В диалоговом окне сохраните значения по умолчанию для имени образа и тега (**createcertificates:latest**).

    ![Снимок экрана, на котором показано создание сертификатов в Visual Studio Code.](media/tutorial-machine-learning-edge-05-configure-edge-device/create-certificates.png)

1. Дождитесь завершения сборки.

    > [!NOTE]
    > Вы можете увидеть предупреждение об отсутствии открытого ключа. Эти предупреждения можно спокойно игнорировать. Вы также увидите предупреждение системы безопасности с предложением проверить или изменить разрешения в образе. Его тоже можно игнорировать.

1. В окне терминала Visual Studio Code запустите контейнер createcertificates.

    ```cmd
    docker run --name createcertificates --rm -v c:\edgeCertificates:/edgeCertificates createcertificates /edgeCertificates
    ```

1. Docker запросит доступ к диску **c:\\** . Выберите **Предоставить общий доступ**.

1. При появлении запроса предоставьте свои учетные данные.

1. Как только выполнение контейнера завершится, проверьте следующие файлы в каталоге **c:\\edgeCertificates**:

    * c:\\edgeCertificates\\certs\\azure-iot-test-only.root.ca.cert.pem
    * c:\\edgeCertificates\\certs\\new-edge-device-full-chain.cert.pem
    * c:\\edgeCertificates\\certs\\new-edge-device.cert.pem
    * c:\\edgeCertificates\\certs\\new-edge-device.cert.pfx
    * c:\\edgeCertificates\\private\\new-edge-device.key.pem

## <a name="upload-certificates-to-azure-key-vault"></a>Отправка сертификатов в Azure Key Vault

Чтобы безопасно хранить сертификаты, а также сделать их доступными с разных устройств, мы отправим эти сертификаты в Azure Key Vault. Как видно в приведенном выше списке, у нас есть два типа файлов сертификатов: PFX и PEM. Мы рассматриваем PFX-файлы в качестве сертификатов хранилища ключей, которые будут отправлены в Key Vault. PEM-файлы имеют обычный текстовый формат, и мы будем использовать их как секреты Key Vault. Мы выберем хранилище Key Vault, связанное с рабочей областью Машинного обучения Azure, которую мы создали с помощью [Jupyter Notebook](tutorial-machine-learning-edge-04-train-model.md#run-the-jupyter-notebooks).

1. На [портале Azure](https://portal.azure.com) перейдите к рабочей области Машинного обучения Azure.

1. На странице обзора для рабочей области Машинного обучения найдите имя хранилища **Key Vault**.

    ![Снимок экрана, на котором показано копирование имени хранилища ключей.](media/tutorial-machine-learning-edge-05-configure-edge-device/find-key-vault-name.png)

1. На компьютере для разработки передайте сертификаты в Key Vault. Замените **\<subscriptionId\>** и **\<keyvaultname\>** сведениями о ресурсах.

    ```powershell
    c:\source\IoTEdgeAndMlSample\CreateCertificates\upload-keyvaultcerts.ps1 -SubscriptionId <subscriptionId> -KeyVaultName <keyvaultname>
    ```

1. Войдите в Azure, когда появится соответствующий запрос.

1. Скрипт будет выполняться в течение нескольких минут, после чего вернет список новых записей в Key Vault.

    ![Снимок экрана, на котором показаны результаты работы скрипта Key Vault.](media/tutorial-machine-learning-edge-05-configure-edge-device/key-vault-entries-output.png)

## <a name="create-an-iot-edge-device"></a>Создание устройства IoT Edge

Чтобы подключить устройство Azure IoT Edge к Центру Интернета вещей, сначала следует создать в этом концентраторе удостоверение устройства. Мы извлечем строку подключения из удостоверения устройства в облаке и с ее помощью настроим среду выполнения на устройстве IoT Edge. Когда настроенное устройство подключится к центру, мы сможем развертывать модули и отправлять сообщения. Мы также можем изменить конфигурацию физического устройства IoT Edge, изменив удостоверение устройства в Центре Интернета вещей.

В этом руководстве описано, как создать новое удостоверение устройства с помощью Visual Studio Code. Эти действия также можно выполнить с помощью портала Azure или Azure CLI.

1. Откройте Visual Studio Code на компьютере для разработки.

1. В представлении Visual Studio Code **Explorer** разверните фрейм **Центр Интернета вещей Azure**.

1. Щелкните символ многоточия и выберите **Создать устройство IoT Edge**.

1. Присвойте имя этому устройству. Для удобства мы используем имя **aaTurbofanEdgeDevice**, чтобы оно оказалось первым в списке устройств.

1. Новое устройство появится в списке устройств.

    ![Снимок экрана, на котором показано представление устройства в Visual Studio Code Explorer.](media/tutorial-machine-learning-edge-05-configure-edge-device/iot-hub-devices-list.png)

## <a name="deploy-an-azure-virtual-machine"></a>Создание виртуальной машины Azure

В этом руководстве мы применим образ [Azure IoT Edge on Ubuntu](https://azuremarketplace.microsoft.com/marketplace/apps/microsoft_iot_edge.iot_edge_vm_ubuntu?tab=Overview) из Azure Marketplace, чтобы создать новое устройство IoT Edge. Образ Azure IoT Edge on Ubuntu устанавливает последнюю версию среды выполнения IoT Edge и ее зависимости при запуске. Для развертывания виртуальной машины используются нижеперечисленные ресурсы.

- Скрипт PowerShell, `Create-EdgeVM.ps1`.
- Шаблон Azure Resource Manager, `IoTEdgeVMTemplate.json`.
- Скрипт оболочки, `install packages.sh`.

### <a name="enable-programmatic-deployment"></a>Включение программного развертывания

Чтобы использовать в скрипте для развертывания образ из Azure Marketplace, нужно включить для него программное развертывание.

1. Войдите на портал Azure.

1. Выбор пункта **Все службы**.

1. В поле поиска введите и выберите **Marketplace**.

1. В поле поиска Marketplace введите и выберите **Azure IoT Edge on Ubuntu**.

1. Щелкните гиперссылку **Начало работы**, чтобы выполнить развертывание с помощью программных средств.

1. Нажмите кнопку **Включить**, а затем нажмите **Сохранить**.

    ![Снимок экрана, показывающий включение программного развертывания для виртуальной машины.](media/tutorial-machine-learning-edge-05-configure-edge-device/deploy-ubuntu-vm.png)

1. Вы получите уведомление об успешном выполнении.

### <a name="create-a-virtual-machine"></a>Создание виртуальной машины

Теперь запустите скрипт, который создаст виртуальную машину для устройства IoT Edge.

1. Откройте окно PowerShell и перейдите к папке **EdgeVM**.

    ```powershell
    cd c:\source\IoTEdgeAndMlSample\EdgeVM
    ```

1. Запустите скрипт, чтобы создать виртуальную машину.

    ```powershell
    .\Create-EdgeVm.ps1
    ```

1. Предоставьте значения для каждого параметра, когда появится соответствующий запрос. Мы рекомендуем использовать те же подписку, группу ресурсов и расположение, что и для всех остальных ресурсов в этом руководстве.

    * **Идентификатор подписки Azure** можно узнать на портале Azure.
    * **Имя группы ресурсов.** Удобное и запоминающееся имя для группировки всех ресурсов, используемых в этом руководстве.
    * **Расположение.** Расположение Azure, где будет создана виртуальная машина. Например, westus2 или northeurope. См. подробнее о [расположениях Azure](https://azure.microsoft.com/global-infrastructure/locations/).
    * **AdminUsername.** Имя учетной записи администратора, под которой вы будете входить на виртуальную машину.
    * **adminPassword.** Пароль для пользователя AdminUsername на виртуальной машине.

1. Чтобы скрипт мог настроить виртуальную машину, необходимо войти в Azure под учетными данными, связанными с используемой подпиской Azure.

1. Скрипт подтвердит сведения для создания виртуальной машины. Нажмите клавишу **y** или **ВВОД**, чтобы продолжить.

1. Скрипт будет выполнять следующие действия в течение нескольких минут:

    * создание группы ресурсов, если ее еще нет;
    * создание виртуальной машины;
    * добавление в группу безопасности сети исключений портов виртуальной машины 22 (SSH), 5671 (AMQP), 5672 (AMPQ) и 443 (TLS);
    * установка [Azure CLI](/cli/azure/install-azure-cli-apt).

1. Скрипт выведет строку SSH для подключения к виртуальной машине. Скопируйте ее для выполнения следующего шага.

    ![Снимок экрана, показывающий копирование строки подключения SSH для виртуальной машины.](media/tutorial-machine-learning-edge-05-configure-edge-device/vm-ssh-connection-string.png)

## <a name="connect-to-your-iot-edge-device"></a>Подключение к устройству IoT Edge

В следующих разделах описано, как настроить созданную виртуальную машину Azure. Сначала нужно подключиться к виртуальной машине.

1. Откройте командную строку и вставьте строку SSH-подключения, которую вы скопировали из выходных данных скрипта. Введите собственные значения имени пользователя, суффикса и региона, которые вы передали в скрипт PowerShell, как описано в предыдущем разделе.

    ```cmd
    ssh -l <username> iotedge-<suffix>.<region>.cloudapp.azure.com
    ```

1. Когда появится запрос на подтверждение подлинности узла, введите **yes** и нажмите клавишу **ВВОД**.

1. Введите свой пароль, когда поступит соответствующий запрос.

1. В Ubuntu отобразится приветственное сообщение, а затем появится строка в формате `<username>@<machinename>:~$`.

## <a name="download-key-vault-certificates"></a>Скачивание сертификатов Key Vault

Ранее в этой статье описывалось, как отправить в Key Vault сертификаты, чтобы сделать их доступными для устройства IoT Edge и конечного устройства. Конечным устройством называется подчиненное устройство, которое использует устройство IoT Edge в качестве шлюза для обмена данными с Центром Интернета вещей.

С этим устройством мы будем работать позже. Для выполнения операций, описанных в этом разделе, скачайте сертификаты на устройство IoT Edge.

1. В сеансе SSH-подключения к виртуальной машине Linux выполните вход в Azure с помощью Azure CLI.

    ```azurecli
    az login
    ```

1. Вам будет предложено открыть браузер на странице входа на [устройство Майкрософт](https://microsoft.com/devicelogin) и ввести уникальный код. Эти шаги вы можете выполнить на локальном компьютере. После завершения проверки подлинности закройте окно браузера.

1. Если проверка подлинности пройдет успешно, на виртуальной машине Linux будет выполнен вход, после чего отобразится список подписок Azure.

1. Укажите подписку Azure, которую вы хотите использовать для выполнения команд Azure CLI.

    ```azurecli
    az account set --subscription <subscriptionId>
    ```

1. Создайте на виртуальной машине каталог для сертификатов.

    ```bash
    sudo mkdir /edgeMlCertificates
    ```

1. Скачайте сертификаты, которые хранятся в хранилище ключей: new-edge-device-full-chain.cert.pem, new-edge-device.key.pem и azure-iot-test-only.root.ca.cert.pem.

    ```azurecli
    key_vault_name="<key vault name>"
    sudo az keyvault secret download --vault-name $key_vault_name --name new-edge-device-full-chain-cert-pem -f /edgeMlCertificates/new-edge-device-full-chain.cert.pem
    sudo az keyvault secret download --vault-name $key_vault_name --name new-edge-device-key-pem -f /edgeMlCertificates/new-edge-device.key.pem
    sudo az keyvault secret download --vault-name $key_vault_name --name azure-iot-test-only-root-ca-cert-pem -f /edgeMlCertificates/azure-iot-test-only.root.ca.cert.pem
    ```

## <a name="update-the-iot-edge-device-configuration"></a>Обновление конфигурации устройства IoT Edge.

Среда выполнения IoT Edge использует для хранения конфигурации файл /etc/iotedge/config.yaml. В этом файле нам нужно изменить три элемента:

* **Строка подключения устройства** — строка подключения из удостоверения устройства в Центре Интернета вещей.
* **Сертификаты** — сертификаты для подключения к подчиненным устройствам.
* **Имя узла** — полное доменное имя (FQDN) виртуальной машины, которая действует как устройство IoT Edge.

Образ Azure IoT Edge on Ubuntu, который мы использовали для создания виртуальной машины IoT Edge, содержит готовый скрипт оболочки, который включает в файл config.yaml строку подключения.

1. В Visual Studio Code щелкните устройство IoT Edge правой кнопкой мыши и выберите **Копировать строку подключения к устройству**.

    ![Снимок экрана, на котором показано копирование строки подключения из Visual Studio Code.](media/tutorial-machine-learning-edge-05-configure-edge-device/copy-device-connection-string-command.png)

1. В сеансе SSH-подключения выполните команду, которая включает строку подключения к устройству в файле config.yaml.

    ```bash
    sudo /etc/iotedge/configedge.sh "<your_iothub_edge_device_connection_string>"
    ```

Теперь мы обновим сертификаты и имя узла, вручную изменив содержимое файла config.yaml.

1. Откройте файл config.yaml.

    ```bash
    sudo nano /etc/iotedge/config.yaml
    ```

1. В разделе certificates файла config.yaml удалите первый элемент **#** и измените путь следующим образом:

    ```yaml
    certificates:
      device_ca_cert: "/edgeMlCertificates/new-edge-device-full-chain.cert.pem"
      device_ca_pk: "/edgeMlCertificates/new-edge-device.key.pem"
      trusted_ca_certs: "/edgeMlCertificates/azure-iot-test-only.root.ca.cert.pem"
    ```

    Убедитесь, что перед строкой **certificates:** нет пробелов, а перед каждым вложенным сертификатом есть по два пробела.

    В редакторе Nano щелкните правой кнопкой мыши, чтобы вставить содержимое буфера обмена в место, где находится курсор. Чтобы заменить строку, перейдите к ней с помощью клавиш со стрелками, удалите ее, а затем щелкните правой кнопкой мыши, чтобы вставить содержимое буфера обмена.

1. На портале Azure перейдите к виртуальной машине. Скопируйте DNS-имя (полное доменное имя компьютера) из раздела **Обзор**.

1. Вставьте полное доменное имя в раздел hostname файла config.yml. Все символы имени должны быть в нижнем регистре.

    ```yaml
    hostname: '<machinename>.<region>.cloudapp.azure.com'
    ```

1. Сохраните и закройте файл, нажав клавиши **CTRL+X**, **Y** и **ВВОД**.

1. Перезапустите управляющую программу IoT Edge.

    ```bash
    sudo systemctl restart iotedge
    ```

1. Проверьте состояние управляющей программы IoT Edge. После этой команды введите **:q**, чтобы выйти.

    ```bash
    systemctl status iotedge
    ```

1. Если вы увидите ошибки (выделенный цветом текст с префиксом \[ERROR\]), изучите подробные сведения о них в журналах управляющей программы.

    ```bash
    journalctl -u iotedge --no-pager --no-full
    ```
## <a name="clean-up-resources"></a>Очистка ресурсов

Этот учебник является частью серии статей, каждая из которых продолжает предыдущую. Не очищайте ресурсы, пока не завершите работу с последним учебником.

## <a name="next-steps"></a>Дальнейшие действия

Мы завершили настройку виртуальной машины Azure, которая будет выполнять роль прозрачного шлюза IoT Edge. Мы начали с создания тестовых сертификатов, которые затем отправили в Key Vault. После этого мы применили скрипт и шаблон Resource Manager для развертывания виртуальной машины из образа Ubuntu Server 16.04 LTS + Azure IoT Edge runtime из Azure Marketplace. Если виртуальная машина запущена и работает, к ней можно подключиться через SSH. Затем следует войти в Azure и загрузить сертификаты из Key Vault. Мы внесли несколько изменений в конфигурацию среды выполнения IoT Edge, обновив файл config.yaml.

Теперь вы можете перейти к следующей статье, чтобы создать модули IoT Edge.

> [!div class="nextstepaction"]
> [Создание и развертывание пользовательских модулей IoT Edge](tutorial-machine-learning-edge-06-custom-modules.md)
