---
title: Устранение неполадок в Azure IoT Edge | Документация Майкрософт
description: В этой статье вы узнаете о стандартных навыках диагностики для Azure IoT Edge, таких как получение состояния компонентов и журналов.
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 11/12/2020
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: c5f28e2c2d370329dbee0fb76284a4b76b2b945e
ms.sourcegitcommit: d4734bc680ea221ea80fdea67859d6d32241aefc
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/14/2021
ms.locfileid: "100376516"
---
# <a name="troubleshoot-your-iot-edge-device"></a>Устранение неполадок устройства с IoT Edge

При возникновении проблем, связанных с Azure IoT Edge в вашей среде, используйте эту статью в качестве рекомендации по устранению неполадок и диагностике.

## <a name="run-the-check-command"></a>Выполните команду "Check"

Первым шагом при устранении неполадок IoT Edge должно быть использование `check` команды, которая запускает набор тестов конфигурации и подключения для распространенных проблем. `check`Команда доступна в [выпуске Release 1.0.7](https://github.com/Azure/azure-iotedge/releases/tag/1.0.7) и более поздних версий.

>[!NOTE]
>Средство устранения неполадок не может выполнить проверку подключения, если устройство IoT Edge находится за прокси-сервером.

Вы можете выполнить `check` команду, как показано ниже, или включить `--help` флаг, чтобы просмотреть полный список параметров:

В Linux

```bash
sudo iotedge check
```

Windows:

```powershell
iotedge check
```

Средство устранения неполадок выполняет многие проверки, отсортированные по следующим трем категориям:

* *Проверки конфигурации* проверяют сведения, которые могут препятствовать подключению устройств IOT Edge к облаку, включая проблемы с *config. YAML* и подсистемой контейнеров.
* *Проверки подключения* проверяют, что среда выполнения IOT Edge может обращаться к портам на устройстве узла и что все компоненты IOT Edge могут подключаться к центру Интернета вещей. Этот набор проверок возвращает ошибки, если устройство IoT Edge находится за прокси-сервером.
* *Проверки готовности* к работе в рабочей среде ищите Рекомендуемые практические рекомендации, такие как состояние сертификатов центра сертификации устройств (ЦС) и конфигурация файла журнала модуля.

Средство проверки IoT Edge использует контейнер для выполнения диагностики. Образ контейнера доступен в `mcr.microsoft.com/azureiotedge-diagnostics:latest` [реестре контейнеров Microsoft](https://github.com/microsoft/containerregistry). Если необходимо выполнить проверку на устройстве без прямого доступа к Интернету, устройствам потребуется доступ к образу контейнера.

Сведения о каждой из проверок диагностики, выполняемых этим средством, включая действия, выполняемые при получении ошибки или предупреждения, см. в разделе [IOT Edge устранение неполадок проверки](https://github.com/Azure/iotedge/blob/master/doc/troubleshoot-checks.md).

## <a name="gather-debug-information-with-support-bundle-command"></a>Сбор отладочной информации с помощью команды "support-набор"

Если необходимо собрать журналы с IoT Edge устройства, наиболее удобным способом является использование `support-bundle` команды. По умолчанию эта команда собирает данные о модуле, IoT Edge диспетчере безопасности и подсистеме контейнеров, `iotedge check` выходные данные JSON и другие полезные сведения об отладке. Он сжимает их в единый файл для облегчения совместного использования. `support-bundle`Команда доступна в [выпуске Release 1.0.9](https://github.com/Azure/azure-iotedge/releases/tag/1.0.9) и более поздних версий.

Выполните `support-bundle` команду с `--since` флагом, чтобы указать, сколько времени в прошлом требуется получить журналы. Например, получит `6h` журналы за последние шесть часов, начиная с последних шести `6d` дней, `6m` с момента последнего шесть минут и т. д. Включите `--help` флаг, чтобы просмотреть полный список параметров.

В Linux

```bash
sudo iotedge support-bundle --since 6h
```

Windows:

```powershell
iotedge support-bundle --since 6h
```

Вы также можете использовать [прямой вызов метода](how-to-retrieve-iot-edge-logs.md#upload-support-bundle-diagnostics) на устройстве, чтобы передать выходные данные команды поддержки в хранилище BLOB-объектов Azure.

> [!WARNING]
> Выходные данные `support-bundle` команды могут содержать имена узла, устройства и модуля, сведения, регистрируемые модулями и т. д. Имейте в виду, что при совместном использовании выходных данных на общедоступном форуме.

## <a name="check-your-iot-edge-version"></a>Проверка версии IoT Edge

Если вы используете более раннюю версию IoT Edge, то проблему может устранить обновление. `iotedge check`Средство проверяет, является ли демон безопасности IOT Edge последней версией, но не проверяет версии модуля IOT EDGE и модулей агента. Чтобы проверить версию модулей среды выполнения на устройстве, используйте команды `iotedge logs edgeAgent` и `iotedge logs edgeHub` . При запуске модуля в журналах объявляется номер версии.

Инструкции по обновлению устройства см. в [статье обновление управляющей программы IOT Edge безопасности и среды выполнения](how-to-update-iot-edge.md).

## <a name="verify-the-installation-of-iot-edge-on-your-devices"></a>Проверка установки IoT Edge на устройствах

Вы можете проверить установку IoT Edge на устройствах, выполнив [мониторинг модуля edgeAgent двойника](./how-to-monitor-module-twins.md).

Чтобы получить последнюю версию модуля edgeAgent двойника, выполните следующую команду из [Azure Cloud Shell](https://shell.azure.com/):

   ```azurecli-interactive
   az iot hub module-twin show --device-id <edge_device_id> --module-id $edgeAgent --hub-name <iot_hub_name>
   ```

Эта команда выводит все [сообщаемые свойства](./module-edgeagent-edgehub.md)edgeAgent. Ниже приведены некоторые полезные рекомендации по мониторингу состояния устройства.

* состояние среды выполнения
* время запуска среды выполнения
* время последнего выхода из среды выполнения
* Счетчик перезапусков среды выполнения

## <a name="check-the-status-of-the-iot-edge-security-manager-and-its-logs"></a>Проверка состояния диспетчера безопасности IoT Edge и его журналов

[Диспетчер IOT Edge безопасности](iot-edge-security-manager.md) отвечает за такие операции, как инициализация IOT Edgeной системы при запуске и подготовке устройств. Если IoT Edge не запускается, журналы диспетчера безопасности могут предоставить полезную информацию.

В Linux

* Просмотр состояния диспетчера безопасности IoT Edge:

   ```bash
   sudo systemctl status iotedge
   ```

* Просмотрите журналы IoT Edge диспетчера безопасности:

    ```bash
    sudo journalctl -u iotedge -f
    ```

* Просмотрите более подробные журналы IoT Edge диспетчера безопасности:

  * Измените параметры управляющей программы IoT Edge.

      ```bash
      sudo systemctl edit iotedge.service
      ```

  * Обновите следующие строки:

      ```bash
      [Service]
      Environment=IOTEDGE_LOG=edgelet=debug
      ```

  * Перезапустите управляющую программу безопасности IoT Edge:

      ```bash
      sudo systemctl cat iotedge.service
      sudo systemctl daemon-reload
      sudo systemctl restart iotedge
      ```

Windows:

* Просмотр состояния диспетчера безопасности IoT Edge:

   ```powershell
   Get-Service iotedge
   ```

* Просмотрите журналы IoT Edge диспетчера безопасности:

   ```powershell
   . {Invoke-WebRequest -useb aka.ms/iotedge-win} | Invoke-Expression; Get-IoTEdgeLog
   ```

* Просмотреть только последние 5 минут журналов диспетчера безопасности IoT Edge:

   ```powershell
   . {Invoke-WebRequest -useb aka.ms/iotedge-win} | Invoke-Expression; Get-IoTEdgeLog -StartTime ([datetime]::Now.AddMinutes(-5))
   ```

* Просмотрите более подробные журналы IoT Edge диспетчера безопасности:

  * Добавьте переменную среды системного уровня:

      ```powershell
      [Environment]::SetEnvironmentVariable("IOTEDGE_LOG", "debug", [EnvironmentVariableTarget]::Machine)
      ```

  * Перезапустите управляющую программу безопасности IoT Edge:

      ```powershell
      Restart-Service iotedge
      ```

### <a name="if-the-iot-edge-security-manager-is-not-running-verify-your-yaml-configuration-file"></a>Если диспетчер IoT Edge безопасности не работает, проверьте файл конфигурации YAML.

> [!WARNING]
> Файлы YAML не могут содержать знаки табуляции в качестве отступа. Вместо этого используйте двойные пробелы. Элементы верхнего уровня должны не иметь начальных пробелов.

В Linux

   ```bash
   sudo nano /etc/iotedge/config.yaml
   ```

Windows:

   ```cmd
   notepad C:\ProgramData\iotedge\config.yaml
   ```

### <a name="restart-the-iot-edge-security-manager"></a>Перезапустите диспетчер безопасности IoT Edge:

Если проблема не исчезла, попытайтесь перезапустить диспетчер безопасности IoT Edge.

В Linux

   ```cmd
   sudo systemctl restart iotedge
   ```

Windows:

   ```powershell
   Stop-Service iotedge -NoWait
   sleep 5
   Start-Service iotedge
   ```

## <a name="check-container-logs-for-issues"></a>Проверка журналов контейнеров на наличие ошибок

Когда управляющая программа IoT Edge безопасности будет запущена, просмотрите журналы контейнеров, чтобы обнаружить проблемы. Начните с развернутых контейнеров, а затем просмотрите контейнеры, составляющие среду выполнения IoT Edge: edgeAgent и edgeHub. Журналы IoT Edge агентов обычно предоставляют сведения о жизненном цикле каждого контейнера. Журналы центра IoT Edge содержат сведения об обмене сообщениями и маршрутизации.

```cmd
iotedge logs <container name>
```

Вы также можете использовать [прямой вызов метода](how-to-retrieve-iot-edge-logs.md#upload-module-logs) в модуле на устройстве, чтобы передать журналы этого модуля в хранилище BLOB-объектов Azure.

## <a name="view-the-messages-going-through-the-iot-edge-hub"></a>Просмотр сообщений, идущих через центр IoT Edge

Вы можете просмотреть сообщения, проходящие через центр IoT Edge, и собрать аналитические сведения из подробных журналов из контейнеров среды выполнения. Чтобы включить ведение подробных журналов в этих контейнерах, задайте значение `RuntimeLogLevel` в файле конфигурации YAML. Чтобы открыть этот файл, выполните следующее.

В Linux

   ```bash
   sudo nano /etc/iotedge/config.yaml
   ```

Windows:

   ```cmd
   notepad C:\ProgramData\iotedge\config.yaml
   ```

По умолчанию элемент `agent` будет выглядеть, как показано в примере ниже:

   ```yaml
   agent:
     name: edgeAgent
     type: docker
     env: {}
     config:
       image: mcr.microsoft.com/azureiotedge-agent:1.1
       auth: {}
   ```

Вместо `env: {}` вставьте следующий фрагмент:

   ```yaml
   env:
     RuntimeLogLevel: debug
   ```

   > [!WARNING]
   > Файлы YAML не могут содержать знаки табуляции в качестве отступа. Вместо этого используйте двойные пробелы. Элементы верхнего уровня не могут иметь начальные пробелы.

Сохраните файл и перезапустите диспетчер безопасности IoT Edge.

Можно также проверить сообщения, отправленные между Центром Интернета вещей и устройствами IoT Edge. Просмотрите эти сообщения с помощью [расширения центра Интернета вещей Azure для Visual Studio Code](https://marketplace.visualstudio.com/items?itemName=vsciot-vscode.azure-iot-toolkit). Дополнительные сведения см. в записи блога об [удобном средстве при разработке с помощью Центра Интернета вещей Azure](https://blogs.msdn.microsoft.com/iotdev/2017/09/01/handy-tool-when-you-develop-with-azure-iot/).

## <a name="restart-containers"></a>Перезапуск контейнеров

После изучения журналов и сообщений можно попытаться перезапустить контейнеры:

```cmd
iotedge restart <container name>
```

Перезапустите контейнеры среды выполнения IoT Edge:

```cmd
iotedge restart edgeAgent && iotedge restart edgeHub
```

## <a name="check-your-firewall-and-port-configuration-rules"></a>Проверьте правила конфигурации брандмауэра и порта.

Azure IoT Edge допускает обмен данными между локальным сервером и облаком Azure с помощью поддерживаемых протоколов центра Интернета вещей, см. раздел [Выбор протокола связи](../iot-hub/iot-hub-devguide-protocols.md). В целях дополнительной безопасности коммуникационные каналы между Azure IoT Edge и Центром Интернета вещей всегда настроены как исходящие. Эта конфигурация основана на [модели связи с поддержкой служб](/archive/blogs/clemensv/service-assisted-communication-for-connected-devices), которая позволяет снизить контактную зону, изучаемую вредоносным объектом. Входящий трафик требуется только для конкретных сценариев, в которых Центр Интернета вещей отправляет сообщения на устройство Azure IoT Edge. Сообщения из облака на устройство защищаются с помощью безопасных каналов TLS и могут иметь дополнительную защиту при использовании сертификатов X.509 и модулей устройства TPM. Сведения об установке этой связи с помощью диспетчера безопасности Azure IoT Edge см. в [этой статье](../iot-edge/iot-edge-security-manager.md).

Хотя IoT Edge предоставляет улучшенную конфигурацию для обеспечения безопасности среды выполнения IoT Edge и развернутых модулей, при этом многое по-прежнему зависит от базовой конфигурации компьютера и сети. Следовательно, необходимо обеспечить правильную настройку правил сети и брандмауэра для обеспечения безопасной связи с облаком. Следующая таблица может использоваться в качестве рекомендации при настройке правил брандмауэра для базовых серверов, где размещена Azure IoT Edge среда выполнения:

|Протокол|Port|Входящий|Исходящий|Руководство|
|--|--|--|--|--|
|MQTT|8883|ЗАБЛОКИРОВАННЫЕ (по умолчанию)|ЗАБЛОКИРОВАННЫЕ (по умолчанию)|<ul> <li>Исходящие подключения должны быть открыты при использовании MQTT в качестве протокола связи.<li>IoT Edge не поддерживает порт 1883 для MQTT. <li>Входящие подключения должны быть заблокированы.</ul>|
|AMQP|5671|ЗАБЛОКИРОВАННЫЕ (по умолчанию)|ОТКРЫТЫЕ (по умолчанию)|<ul> <li>Протокол связи по умолчанию для IoT Edge. <li> Должен быть открыт, если Azure IoT Edge не настроен для других поддерживаемых протоколов или если AMQP является требуемым протоколом связи.<li>IoT Edge не поддерживает порт 5672 для AMQP.<li>Заблокируйте этот порт, если Azure IoT Edge использует другой протокол, поддерживаемый Центром Интернета вещей.<li>Входящие подключения должны быть заблокированы.</ul></ul>|
|HTTPS|443|ЗАБЛОКИРОВАННЫЕ (по умолчанию)|ОТКРЫТЫЕ (по умолчанию)|<ul> <li>Исходящие подключения должны быть открыты на порту 443 для подготовки IoT Edge. Эта конфигурация необходима при использовании созданных вручную сценариев или Службы подготовки устройств к добавлению в Центр Интернета вещей Azure. <li>Входящие подключения должны быть открытыми только для указанных сценариев: <ul> <li>  Если у вас есть прозрачный шлюз с конечными устройствами, которые могут отправлять запросы метода. В этом случае порт 443 не должен быть открыт во внешних сетях для подключения к Центру Интернета вещей или предоставления служб Центра Интернета вещей через Azure IoT Edge. Таким образом, правило для входящего трафика может разрешать открытие только входящего подключения из внутренней сети. <li> Для сценариев передачи данных из облака на устройство (C2D).</ul><li>IoT Edge не поддерживает порт 80 для HTTP.<li>Если на предприятии невозможно настроить протоколы, отличные от HTTP (например, AMQP или MQTT), сообщения могут отправляться через протоколы WebSocket. В этом случае для подключения по WebSocket будет использоваться порт 443.</ul>|

## <a name="next-steps"></a>Следующие шаги

Считаете, что обнаружили ошибку в платформе IoT Edge? [Отправьте запрос](https://github.com/Azure/iotedge/issues), чтобы мы как можно скорее устранили неисправность.

Если у вас есть другие вопросы, создайте [запрос в службу поддержки](https://portal.azure.com/#create/Microsoft.Support) для получения справки.