---
title: Сертификаты для безопасности устройств в Azure IoT Edge | Документация Майкрософт
description: Azure IoT Edge использует сертификаты для проверки устройств, модулей и конечных устройств, а также для создания безопасных соединений между ними.
author: stevebus
manager: philmea
ms.author: stevebus
ms.date: 08/12/2020
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.custom: mqtt
ms.openlocfilehash: ffe2f2b7f94d546cdfe393170da2fd2ca6ac0149
ms.sourcegitcommit: 4bda786435578ec7d6d94c72ca8642ce47ac628a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/16/2021
ms.locfileid: "103490999"
---
# <a name="understand-how-azure-iot-edge-uses-certificates"></a>Сведения о том, как Azure IoT Edge использует сертификаты

[!INCLUDE [iot-edge-version-all-supported](../../includes/iot-edge-version-all-supported.md)]

IoT Edge сертификаты используются модулями и подчиненными устройствами Интернета вещей для проверки личности и подлинности модуля среды выполнения [центра IOT Edge](iot-edge-runtime.md#iot-edge-hub) . Эта проверка позволяет устанавливать безопасные соединения TLS между средой выполнения, модулями и устройствами Интернета вещей. Так же как и сам центр Интернета вещей, служба IoT Edge требует безопасных и зашифрованных подключений со стороны нижестоящих (конечных) устройств Интернета вещей и модулей IoT Edge. Для установления безопасного TLS-подключения модуль центра IoT Edge представляет подключающимся клиентам цепочку сертификатов сервера, чтобы они могли проверить его удостоверение.

>[!NOTE]
>В этой статье рассказывается о сертификатах, которые используются для защиты подключений между различными компонентами на IoT Edge устройстве или между IoT Edge устройством и любыми конечными устройствами. Вы также можете использовать сертификаты для проверки подлинности устройства IoT Edge в центре Интернета вещей. Эти сертификаты проверки подлинности отличаются и не рассматриваются в этой статье. Дополнительные сведения о проверке подлинности устройства с помощью сертификатов см. в статье [Создание и инициализация устройства IOT Edge с помощью сертификатов X. 509](how-to-auto-provision-x509-certs.md).

В этой статье объясняется, как сертификаты IoT Edge могут работать в сценариях в рабочей среде, а также в сценариях разработки и тестирования. Хотя скрипты отличаются (PowerShell и bash), понятия одинаковы для Linux и Windows.

## <a name="iot-edge-certificates"></a>Сертификаты IoT Edge

Существует два распространенных сценария настройки сертификатов на IoT Edge устройстве. Иногда конечный пользователь или оператор устройства приобретает универсальное устройство, произведенное производителем, а затем самостоятельно управляет сертификатами. В других случаях изготовитель работает с контрактом, чтобы создать пользовательское устройство для оператора и выполнить начальную подпись сертификата перед передачей устройства. При проектировании сертификатов IoT Edge учитывались оба сценария.

На рисунке ниже иллюстрируется использование сертификатов в IoT Edge. Между сертификатом корневого ЦС и сертификатом ЦС устройства может быть ноль, один или несколько промежуточных сертификатов для подписи, в зависимости от количества связанных сущностей. Здесь мы покажем один вариант.

![Схема типичных связей между сертификатами](./media/iot-edge-certs/edgeCerts-general.png)

<!--1.1-->
:::moniker range="iotedge-2018-06"

> [!NOTE]
> В настоящее время ограничение в либиоссм предотвращает использование сертификатов, срок действия которых истекает 1 января 2038. Это ограничение распространяется на сертификат ЦС устройства, все сертификаты в пакете доверия и сертификаты ИДЕНТИФИКАТОРов устройств, используемые для методов подготовки X. 509.

:::moniker-end

### <a name="certificate-authority"></a>Центр сертификации

Центр сертификации (ЦС) — это организация, выдающая цифровые сертификаты. Центр сертификации выступает в качестве надежного стороннего производителя между владельцем и получателем сертификата. Цифровой сертификат удостоверяет принадлежность открытого ключа получателю сертификата. Цепочка доверия сертификатов начинается с первоначальной выдачи корневого сертификата, который является основой доверия ко всем сертификатам, выдаваемым центром. В дальнейшем владелец может использовать корневой сертификат для выдачи дополнительных промежуточных сертификатов.

### <a name="root-ca-certificate"></a>Корневой сертификат ЦС

Корневой сертификат ЦС является основой доверия в рамках всего процесса. В рабочих сценариях этот сертификат ЦС обычно приобретается в надежном коммерческом центре сертификации, например Baltimore, Verisign или DigiCert. Если вам нужен полный контроль над устройствами, подключающимися к вашим устройствам IoT Edge, можно использовать центр сертификации корпоративного уровня. В любом случае вся цепочка сертификатов из концентратора IoT Edge переводится в нее, поэтому конечные устройства IoT должны доверять корневому сертификату. Корневой сертификат ЦС можно либо хранить в надежном хранилище корневого центра сертификации, либо предоставлять сведения о нем в коде приложения.

### <a name="intermediate-certificates"></a>Промежуточные сертификаты

При изготовлении защищенных устройств корневые центры ЦС редко используются напрямую, в первую очередь из-за риска утечки или нарушения безопасности. Корневой сертификат ЦС создает и подписывает один или несколько промежуточных сертификатов ЦС. Может существовать только один или цепочка этих промежуточных сертификатов. Цепочка промежуточных сертификатов может потребоваться в следующих ситуациях:

* иерархия отделов в компании-производителе;

* в изготовлении устройства последовательно участвуют несколько компаний;

* клиент покупает корневой сертификат ЦС и получает на его основе сертификат для подписи, с помощью которого изготовитель подписывает устройства, создаваемые по заказу этого клиента.

В любом случае изготовитель использует промежуточный сертификат ЦС в конце этой цепочки для подписи сертификата ЦС устройства, размещаемого на конечном устройстве. Как правило, эти промежуточные сертификаты тщательно охраняются на заводе-изготовителе. Их использование строго контролируется с помощью физических и электронных процессов.

### <a name="device-ca-certificate"></a>Сертификат ЦС устройства

Сертификат ЦС устройства создается на основе последнего промежуточного сертификата ЦС в цепочке и подписывается с его помощью. Он устанавливается на самом устройстве IoT Edge, как правило, в безопасном хранилище, например в аппаратном модуле безопасности (HSM). Кроме того, сертификат ЦС устройства уникальным образом идентифицирует устройство IoT Edge. Сертификат ЦС устройства может подписывать другие сертификаты.

### <a name="iot-edge-workload-ca"></a>Сертификат ЦС рабочей нагрузки IoT Edge

[Диспетчер безопасности IoT Edge](iot-edge-security-manager.md) создает сертификат ЦС рабочей нагрузки, являющийся первым на стороне оператора при первом запуске IoT Edge. Этот сертификат создается и подписывается сертификатом ЦС устройства. Этот сертификат, являющийся одним из промежуточных сертификатов для подписи, служит для создания и подписи всех остальных сертификатов, используемых средой выполнения IoT Edge. На настоящий момент именно этому сертификату сервера центра IoT Edge посвящен следующий раздел, однако в будущем к нему могут добавиться другие сертификаты, служащие для проверки подлинности компонентов IoT Edge.

### <a name="iot-edge-hub-server-certificate"></a>Сертификат сервера центра IoT Edge

Сертификат сервера центра IoT Edge — это тот сертификат, который предоставляется конечным устройствам и модулям для проверки удостоверения во время установления TLS-подключения, которое требуется IoT Edge. В этом сертификате представлена полная цепочка сертификатов для подписи, с помощью которой он создается, вплоть до корневого сертификата ЦС, которому должны доверять конечные устройства Интернета вещей. При создании с IoT Edge общее имя (CN) этого сертификата центра IoT Edge устанавливается в качестве значения свойства HostName в файле конфигурации после преобразования в нижний регистр. Такая конфигурация является распространенным источником путаницы с IoT Edge.

## <a name="production-implications"></a>Применение в рабочей среде

Может возникнуть резонный вопрос: "Зачем в IoT Edge нужен дополнительный сертификат ЦС рабочей нагрузки? Разве нельзя использовать сертификат ЦС устройства, чтобы напрямую создать сертификат сервера центра IoT Edge?" С технической точки зрения можно. Однако назначение этого промежуточного сертификата рабочей нагрузки в том, чтобы разделить функции изготовителя и оператора устройства. Представьте себе ситуацию, когда устройство IoT Edge продается или передается одним клиентом другому. Скорее всего, нужно, чтобы сертификат ЦС устройства, предоставленный изготовителем, оставался неизменным. Однако сертификаты рабочей нагрузки, связанные с эксплуатацией устройства, должны быть очищены и созданы повторно для новой среды.

Так как процессы производства и работы разделены, рассмотрите следующие последствия при подготовке устройств для рабочей среды:

* Так же как и в рамках любого процесса на основе сертификатов, корневой сертификат ЦС и все промежуточные сертификаты ЦС должны защищаться и отслеживаться в течение всего процесса развертывания устройства IoT Edge. Изготовитель устройства IoT Edge должен реализовать надлежащие процессы для безопасного хранения и использования своих промежуточных сертификатов. Кроме того, сертификат ЦС устройства должен храниться в максимально безопасном хранилище на самом устройстве, желательно в аппаратном модуле безопасности.

* Сертификат сервера центра IoT Edge предоставляется центром IoT Edge подключающимся клиентским устройствам и модулям. Общее имя (CN) сертификата ЦС устройства **не должно** совпадать с именем узла, которое будет использоваться в файле конфигурации на устройстве IOT Edge. Имя, используемое клиентами для подключения к IoT Edge (например, с помощью параметра Гатевайхостнаме строки подключения или команды CONNECT в MQTT) **не может совпадать** с общим именем, используемым в сертификате ЦС устройства. Ограничение в том, что центр IoT Edge предоставляет всю цепочку сертификатов на проверку клиентам. Если сертификат сервера центра IoT Edge и сертификат ЦС устройства имеет одинаковое общее имя, проверка зацикливается и сертификат становится недействительным.

* Так как сертификат ЦС устройства используется управляющей программой безопасности IoT Edge для создания окончательных сертификатов IoT Edge, он сам должен являться сертификатом для подписи, то есть иметь возможность подписывать другие сертификаты. Примените параметр "V3 Basic constraints CA:True". В результате будут автоматически настроены необходимые основные свойства использования.

>[!Tip]
> Если вы уже выполнили настройку IoT Edge в качестве прозрачного шлюза в сценарии разработки и тестирования с помощью нашего "удобных сценариев" (см. следующий раздел) и использовали то же имя узла при создании сертификата ЦС устройства, как это было сделано для имени узла в файле конфигурации, возможно, вас интересует, почему он работал. Чтобы упростить работу разработчиков, вспомогательные скрипты добавляют ".ca" в конце передаваемого в них имени. Например, если вы использовали "мигатевай" как для имени устройства в скриптах, так и имени узла в файле конфигурации, первый из них будет включен в mygateway.ca перед использованием в качестве CN для сертификата ЦС устройства.

## <a name="devtest-implications"></a>Применение в среде разработки или тестирования

Чтобы упростить разработку и тестирование, корпорация Майкрософт предоставляет набор [вспомогательных скриптов](https://github.com/Azure/iotedge/tree/master/tools/CACertificates) для создания сертификатов, не предназначенных для рабочей среды. Они подходят для IoT Edge в сценарии прозрачного шлюза. Примеры работы сценариев см. [в разделе Создание демонстрационных сертификатов для тестирования IOT Edge функций устройства](how-to-create-test-certificates.md).

>[!Tip]
> Чтобы подключить конечные устройства и приложения Интернета вещей, использующие наш пакет SDK для устройств Интернета вещей, к IoT Edge, необходимо добавить дополнительный параметр GatewayHostName в конце строки подключения устройства. При создании сертификата сервера пограничных концентратора он основывается на версии имени узла с более ранней версией из файла конфигурации, поэтому для сопоставления имен и проверки сертификата TLS необходимо ввести параметр Гатевайхостнаме в нижнем регистре.

## <a name="example-of-iot-edge-certificate-hierarchy"></a>Пример иерархии сертификатов IoT Edge

Ниже представлен пример рабочего устройства IoT Edge, настроенного в качестве прозрачного шлюза, который иллюстрирует цепочку сертификатов. Для подключения к центру IoT Edge, проверки сертификатов и их выгрузки используется протокол OpenSSL.

![Снимок экрана иерархии сертификатов на каждом уровне](./media/iot-edge-certs/iotedge-cert-chain.png)

На этом снимке экрана представлена полная иерархия сертификатов:

| Корневой сертификат ЦС         | Сертификат ЦС центра Интернета вещей Azure только для тестирования                                                                           |
|-----------------------------|-----------------------------------------------------------------------------------------------------------|
| Промежуточный сертификат ЦС | Промежуточный сертификат центра Интернета вещей Azure только для тестирования                                                                 |
| Сертификат ЦС устройства       | iotgateway.ca (строка "iotgateway" была передана во вспомогательные скрипты в качестве имени узла шлюза)   |
| Сертификат ЦС рабочей нагрузки     | iotedge workload ca                                                                                       |
| Сертификат сервера центра IoT Edge | иотеджегв. local (сопоставление имени узла и файла конфигурации)                                            |

## <a name="next-steps"></a>Дальнейшие действия

[Общие сведения о модулях Azure IoT Edge](iot-edge-modules.md)

[Настройка устройства IoT Edge для использования в качестве прозрачного шлюза](how-to-create-transparent-gateway.md)
