---
title: Подключение подчиненных устройств IoT Edge — Azure IoT Edge | Документация Майкрософт
description: Настройка устройства IoT Edge для подключения к устройствам шлюза Azure IoT Edge.
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 03/01/2021
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.custom:
- amqp
- mqtt
monikerRange: '>=iotedge-2020-11'
ms.openlocfilehash: 382cdf87016044748685e5e64ff04ebac53f018d
ms.sourcegitcommit: f28ebb95ae9aaaff3f87d8388a09b41e0b3445b5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/30/2021
ms.locfileid: "103199150"
---
# <a name="connect-a-downstream-iot-edge-device-to-an-azure-iot-edge-gateway-preview"></a>Подключение подчиненного устройства к шлюзу Azure IoT Edge (предварительная версия)

[!INCLUDE [iot-edge-version-202011](../../includes/iot-edge-version-202011.md)]

В этой статье приводятся инструкции по установке доверительного соединения между шлюзом IoT Edge и подчиненным устройством IoT Edge.

>[!NOTE]
>Для этого компонента требуется служба IoT Edge 1.2, которая предоставляется в общедоступной предварительной версии, в которой выполняются контейнеры Linux.
>
>В этой статье используется последняя предварительная версия IoT Edge 1.2. Убедитесь, что на устройстве установлена версия [1.2.0-rc4](https://github.com/Azure/azure-iotedge/releases/tag/1.2.0-rc4) или более поздняя. Инструкции по получению последней предварительной версии на устройстве см. в статье [Установка Azure IOT Edge для Linux (версия 1.2)](how-to-install-iot-edge.md) или [Обновление IoT Edge до версии 1.2](how-to-update-iot-edge.md#special-case-update-from-10-or-11-to-12).

При использовании шлюза устройство IoT Edge может быть как шлюзом, так и подчиненным устройством. Несколько шлюзов IoT Edge можно расположить на нескольких уровнях, чтобы создать иерархию устройств. Подчиненные (или дочерние) устройства могут проходить проверку подлинности и отправлять и получать сообщения через свой родительский шлюз.

Существует две различные конфигурации для устройств IoT Edge в иерархии шлюза, и в этой статье рассматриваются обе. Первым расположено устройство IoT Edge **верхнего уровня**. Если несколько устройств IoT Edge подключаются друг к другу, любое устройство, которое не имеет родительского устройства, но подключается непосредственно к центру Интернета вещей, считается устройством верхнего уровня. Это устройство отвечает за обработку запросов со всех устройств, расположенных под ним. Вторая конфигурация применяется к любому устройству IoT Edge на **более низком уровне** иерархии. Эти устройства могут быть шлюзом для других подчиненных устройств Интернета вещей и IoT Edge, но также должны маршрутизировать обмен данными через собственные родительские устройства.

Для некоторых сетевых архитектур требуется, чтобы только верхнее устройство IoT Edge в иерархии могло подключаться к облаку. В этой конфигурации все устройства IoT Edge на более низких уровнях иерархии могут взаимодействовать только со своим шлюзом (или родительским устройством) и любыми подчиненными (или дочерними) устройствами.

Все действия, описанные в этой статье, основаны на разделе [Настройка устройства IOT Edge в качестве прозрачного шлюза](how-to-create-transparent-gateway.md), где необходимо настроить устройство IoT Edge в качестве шлюза для подчиненных устройств Интернета вещей. Те же основные шаги применяются ко всем сценариям использования шлюза:

* **Проверка подлинности**. Создайте удостоверения центра Интернета вещей для всех устройств в иерархии шлюзов.
* **Авторизация**. Настройте отношения "родители-потомки" в центре Интернета вещей, чтобы разрешить дочерним устройствам подключаться к своему родительскому устройству, например к центру Интернета вещей.
* **Обнаружение шлюза**. Убедитесь, что дочернее устройство может найти свое родительское устройство в локальной сети.
* **Безопасное подключение**. Установите безопасное соединение с доверенными сертификатами, которые являются частью одной цепочки.

## <a name="prerequisites"></a>Предварительные условия

* Центр Интернета вещей уровня "Бесплатный" или "Стандартный".
* По крайней мере два **устройства IoT Edge**, одно из которых будет устройством верхнего уровня, а остальные — более низкого уровня. Если у вас нет доступных устройств IoT Edge, вы можете [запустить Azure IoT Edge на виртуальных машинах Ubuntu](how-to-install-iot-edge-ubuntuvm.md).
* Если вы используете Azure CLI для создания устройств и управления ими, установите Azure CLI 2.3.1 с расширением Azure IoT 0.10.6 или более поздней версии.

Эта статья содержит подробные инструкции и параметры, помогающие создать иерархию шлюза, подходящую для вашего сценария. Пошаговые инструкции см. в статье [Создание иерархии устройств IoT Edge с помощью шлюзов](tutorial-nested-iot-edge.md).

## <a name="create-a-gateway-hierarchy"></a>Создание иерархии шлюзов

Иерархия шлюзов IoT Edge создается путем определения отношений "родитель-потомок" для устройств IoT Edge в сценарии. Вы можете задать родительское устройство при создании нового удостоверения устройства или управлять родительскими и дочерними устройствами существующего удостоверения устройства.

При настройке связей "родитель-потомок" дочерние устройства могут подключаться к родительскому устройству, например к центру Интернета вещей.

Только устройства IoT Edge могут быть родительскими устройствами, а дочерними могут быть устройства IoT Edge и Интернета вещей. У родителя может быть несколько дочерних устройств, но у дочернего устройства может быть только один родитель. Иерархия шлюзов создается путем объединения наборов родителей и потомков таким образом, что потомок одного устройства может быть родителем другого.

<!-- TODO: graphic of gateway hierarchy -->

# <a name="portal"></a>[Портал](#tab/azure-portal)

На портале Azure можно управлять связью "родители-потомки" при создании новых удостоверений устройств или при изменении существующих.

При создании нового устройства IoT Edge можно выбрать родительские и дочерние устройства из списка существующих устройств IoT Edge в этом центре.

1. Найдите нужный Центр Интернета вещей на [портале Azure](https://portal.azure.com).
1. Выберите **IoT Edge** в меню навигации.
1. Выберите **Добавить устройство IoT Edge**.
1. Помимо указания идентификатора устройства и параметров проверки подлинности можно **Задать родительское устройство** или **Выбрать дочерние устройства**.
1. Выберите устройство или устройства, которые должны быть родительскими или дочерними.

Вы также можете создавать и администрировать отношения "родители-потомки" для существующих устройств.

1. Найдите нужный Центр Интернета вещей на [портале Azure](https://portal.azure.com).
1. Выберите **IoT Edge** в меню навигации.
1. Выберите устройство, которым вы хотите управлять, из списка **Устройства IoT Edge**.
1. Выберите **Задать родительское устройство** или **Управлять дочерними устройствами**.
1. Добавьте или удалите все родительские или дочерние устройства.

# <a name="azure-cli"></a>[Azure CLI](#tab/azure-cli)

Расширение [azure-iot](/cli/azure/ext/azure-iot) для Azure CLI предоставляет команды для управления ресурсами Интернета вещей. Вы можете управлять связью "родители-потомки" для устройств Интернета вещей и IoT Edge при создании новых удостоверений устройств или изменении существующих.

Набор команд [az iot hub device-identity](/cli/azure/ext/azure-iot/iot/hub/device-identity) позволяет управлять связями "родители-потомки" для конкретного устройства.

Команда `create` включает параметры для добавления дочерних устройств и настройки родительского устройства во время создания устройства.

Дополнительные команды удостоверений устройства, включая `add-children`, `list-children` и `remove-children` или `get-parent` и `set-parent`, позволяют управлять связями "родители-потомки" для существующих устройств.

---

## <a name="prepare-certificates"></a>Подготовка сертификатов

Для установления безопасного взаимодействия между ними необходимо установить согласованную цепочку сертификатов на устройствах в одной иерархии шлюзов. Каждое устройство в иерархии, будь то устройство IoT Edge или конечное устройство Интернета вещей, должно иметь копию одного и того же корневого сертификата ЦС. Каждое устройство IoT Edge в иерархии использует этот корневой сертификат ЦС в качестве корневого для сертификата ЦС на устройстве.

При такой настройке каждое подчиненное устройство IoT Edge или конечное устройство IoT может проверить удостоверение своего родителя, убедившись, что edgeHub, к которому они подключаются, имеет сертификат сервера, подписанный общим корневым сертификатом ЦС.

<!-- TODO: certificate graphic -->

Создайте следующие сертификаты:

* **Корневой сертификат ЦС**, который является самым верхним общим сертификатом для всех устройств в данной иерархии шлюзов. Этот сертификат устанавливается на всех устройствах.
* Все **промежуточные сертификаты**, которые необходимо включить в цепочку корневых сертификатов.
* **Сертификат ЦС устройства** и его **закрытый ключ**, созданные корневым и промежуточным сертификатами. Для каждого устройства IoT Edge в иерархии шлюзов требуется один уникальный сертификат ЦС устройства.

Вы можете использовать самозаверяющий центр сертификации или приобрести один из доверенных коммерческих центров сертификации, таких как Baltimore, VeriSign, DigiCert или GlobalSign.

Если у вас нет собственных сертификатов для использования, можно [создать демонстрационные сертификаты для тестирования функций устройства IoT Edge](how-to-create-test-certificates.md). Выполните действия, описанные в этой статье, чтобы создать один набор корневых и промежуточных сертификатов, а затем создать сертификаты ЦС устройств IoT Edge для каждого устройства.

## <a name="configure-iot-edge-on-devices"></a>Настройка IoT Edge на устройствах

Действия по настройке IoT Edge в качестве шлюза очень похожи на шаги по настройке IoT Edge в качестве подчиненного устройства.

Чтобы включить обнаружение шлюза, каждое устройство шлюза IoT Edge должно быть настроено с **именем узла**, который его дочерние устройства будут использовать для его поиска в локальной сети. Каждое подчиненное устройство IoT Edge должно быть настроено с **parent_hostname** для подключения. Если одно устройство IoT Edge является и родительским, и дочерним, оно должно иметь оба параметра.

Чтобы включить безопасные подключения, каждое устройство IoT Edge в сценарии шлюза должно быть настроено с уникальным сертификатом ЦС устройства и копией сертификата корневого ЦС, общего для всех устройств в иерархии шлюзов.

На устройстве уже должен быть установлен IoT Edge. В противном случае выполните действия по [регистрации устройства IoT Edge в центре Интернета вещей](how-to-register-device.md), а затем [установите среду выполнения Azure IoT Edge](how-to-install-iot-edge.md).

Действия, описанные в этом разделе, ссылаются на **корневой сертификат ЦС** и **сертификат ЦС и закрытый ключ устройства**, которые были рассмотрены ранее в этой статье. Если вы создали эти сертификаты на другом устройстве, подготовьте их на этом устройстве. Вы можете перемещать файлы физически, например с помощью USB-накопителя, с помощью службы, например [Azure Key Vault](../key-vault/general/overview.md), или с помощью функции, такой как [безопасное копирование файлов](https://www.ssh.com/ssh/scp/).

Чтобы настроить IoT Edge на устройстве, выполните следующие действия.

Убедитесь, что у пользователя **iotedge** есть разрешения на чтение каталога, содержащего сертификаты и ключи.

1. Установите **корневой сертификат ЦС** на этом устройстве IoT Edge.

   ```bash
   sudo cp <path>/<root ca certificate>.pem /usr/local/share/ca-certificates/<root ca certificate>.pem
   ```

1. Обновите хранилище сертификатов.

   ```bash
   sudo update-ca-certificates
   ```

   Эта команда должна вывести данные о том, что один сертификат добавлен в каталог /etc/ssl/certs.

1. Откройте файл конфигурации IoT Edge.

   ```bash
   sudo nano /etc/aziot/config.toml
   ```

   >[!TIP]
   >Если файл конфигурации еще не существует на вашем устройстве, используйте `/etc/aziot/config.toml.edge.template` в качестве шаблона для его создания.

1. Найдите раздел **Hostname** в файле конфигурации. Раскомментируйте строку с параметром `hostname` и измените значение на полное доменное имя (FQDN) или IP-адрес устройства IoT Edge.

   Значение этого параметра будет использоваться подчиненными устройствами для подключения к этому шлюзу. Имя узла по умолчанию принимает значение имени компьютера, но для подключения подчиненных устройств требуется FQDN или IP-адрес.

   Используйте имя узла короче 64 символов — это лимит для общего имени сертификата сервера.

   Соблюдайте согласованность с шаблоном имени узла по всей иерархии шлюза. Используйте либо полные доменные имена, либо IP-адреса, но не оба варианта.

1. *Если это устройство является дочерним*, найдите раздел **Имя родительского узла**. Раскомментируйте и обновите параметр `parent_hostname`, чтобы он соответствовал полному доменному имени или IP-адресу родительского устройства, совпадающему с указанным именем узла в файле конфигурации родительского устройства.

1. Найдите раздел **Доверенный сертификат пакета**. Раскомментируйте и измените параметр `trust_bundle_cert` с URI файла на корневой сертификат ЦС на устройстве.

1. Хотя эта функция находится в общедоступной предварительной версии, необходимо настроить устройство IoT Edge, чтобы при запуске использовалась общедоступная предварительная версия агента IoT Edge.

   Найдите раздел **Агент Edge по умолчанию** и измените значение образа на образ общедоступной предварительной версии:

   ```toml
   [agent.config]
   image: "mcr.microsoft.com/azureiotedge-agent:1.2.0-rc4"
   ```

1. Найдите раздел **Сертификат ЦС Edge** в файле конфигурации. Раскомментируйте строки в этом разделе и укажите пути URI файлов для сертификата и файлов ключей на устройстве IoT Edge.

   ```toml
   [edge_ca]
   cert = "file:///<path>/<device CA cert>"
   pk = "file:///<path>/<device CA key>"
   ```

1. Сохраните (`Ctrl+O`) и закройте (`Ctrl+X`) файл конфигурации.

1. Если вы ранее использовали другие сертификаты для IoT Edge, удалите файлы в следующих двух каталогах, чтобы убедиться, что будут применяться новые сертификаты:

   * `/var/lib/aziot/certd/certs`
   * `/var/lib/aziot/keyd/keys`

1. Нажмите кнопку Применить, чтобы применить изменения.

   ```bash
   sudo iotedge config apply
   ```

1. Проверьте конфигурацию на наличие ошибок.

   ```bash
   sudo iotedge check --verbose
   ```

   >[!TIP]
   >Средство проверки IoT Edge использует контейнер для выполнения некоторых диагностических проверок. Если вы хотите использовать это средство на подчиненных устройствах IoT Edge, убедитесь, что у них есть доступ к `mcr.microsoft.com/azureiotedge-diagnostics:latest` или в частном реестре контейнеров есть образ контейнера.

## <a name="configure-runtime-modules-for-public-preview"></a>Настройка модулей среды выполнения для общедоступной предварительной версии

Хотя эта функция находится в общедоступной предварительной версии, необходимо настроить устройство IoT Edge, чтобы использовалась общедоступная предварительная версия модулей среды выполнения IoT Edge. В предыдущем разделе приведены шаги по настройке edgeAgent при запуске. Кроме того, необходимо настроить модули среды выполнения в развертываниях для устройства.

1. Настройте модуль edgeHub для использования образа общедоступной предварительной версии: `mcr.microsoft.com/azureiotedge-hub:1.2.0-rc4`.

1. Настройте следующие переменные среды для модуля edgeHub:

   | Имя | Значение |
   | - | - |
   | `experimentalFeatures__enabled` | `true` |
   | `experimentalFeatures__nestedEdgeEnabled` | `true` |

1. Настройте модуль edgeAgent для использования образа общедоступной предварительной версии: `mcr.microsoft.com/azureiotedge-hub:1.2.0-rc4`.

## <a name="network-isolate-downstream-devices"></a>Сетевая изоляция подчиненных устройств

С помощью действий, приведенных в этой статье, вы настроили устройства IoT Edge в качестве шлюза или подчиненного устройства и создали доверительное соединение между ними. Устройство шлюза обрабатывает взаимодействие между подчиненным устройством и центром Интернета вещей, включая проверку подлинности и маршрутизацию сообщений. Модули, развернутые на подчиненных устройствах IoT Edge, по-прежнему могут создавать собственные подключения к облачным службам.

Некоторые сетевые архитектуры, например те, которые соответствуют стандарту ISA-95, стараются максимально сократить число подключений к Интернету. В этих сценариях можно настроить подчиненные устройства IoT Edge без прямого подключения к Интернету. Помимо маршрутизации обмена данными с центром Интернета вещей через устройство шлюза, подчиненные устройства IoT Edge могут использовать устройство шлюза для всех облачных подключений.

Для этой конфигурации сети требуется, чтобы только устройство IoT Edge на верхнем уровне иерархии шлюзов имело прямое подключение к облаку. Устройства IoT Edge на нижних уровнях могут взаимодействовать только со своими родительскими или дочерними устройствами. Этот сценарий поддерживают специальные модули на устройствах шлюзов, в том числе:

* **Модуль прокси API** требуется для любого шлюза IoT Edge, под которым расположено другое устройство IoT Edge. Это означает, что он должен находиться на *каждом уровне* иерархии шлюзов, за исключением нижнего. Этот модуль использует обратный прокси-сервер [nginx](https://nginx.org) для маршрутизации данных HTTP через сетевые уровни с помощью одного порта. Модуль можно настроить с помощью двойника и переменных среды, чтобы он соответствовал конкретным требованиям вашего сценария.

* **Модуль реестра Docker** можно развернуть на шлюзе IoT Edge на *верхнем уровне* иерархии шлюзов. Этот модуль отвечает за извлечение и кэширование образов контейнеров от имени всех устройств IoT Edge на более низких уровнях. Альтернативой развертыванию этого модуля на верхнем уровне является использование локального реестра или ручная загрузка образов контейнеров на устройства и установка для политики извлечения модуля значения **never**.

* **Хранилище BLOB-объектов Azure на IoT Edge** можно развернуть на шлюзе IoT Edge на *верхнем уровне* иерархии шлюзов. Этот модуль отвечает за отправку больших двоичных объектов от имени всех устройств IoT Edge на более низких уровнях. Возможность отправки BLOB-объектов также позволяет использовать полезные функции устранения неполадок для устройств IoT Edge на более низких уровнях, например передача журнала модуля и отправка пакета поддержки.

### <a name="network-configuration"></a>Сетевая конфигурация

Для каждого устройства шлюза на верхнем уровне операторы сети должны:

* Предоставлять статический IP-адрес или полное доменное имя (FQDN).
* Авторизовать исходящие коммуникации с этого IP-адреса на имя узла центра Интернета вещей Azure через порты 443 (HTTPS) и 5671 (AMQP).
* Авторизовать исходящие коммуникации с этого IP-адреса на имя узла Реестра контейнеров Azure через порт 443 (HTTPS).

  Модуль прокси API может одновременно управлять подключениями только к одному реестру контейнеров. Мы рекомендуем использовать все образы контейнеров, включая общедоступные образы, предоставляемые Microsoft Container Registry (mcr.microsoft.com), которые хранятся в частном реестре контейнеров.

Для каждого устройства шлюза на нижнем уровне операторы сети должны:

* Предоставлять статический IP-адрес.
* Авторизовать исходящие подключения с этого IP-адреса к IP-адресу родительского шлюза через порты 443 (HTTPS) и 5671 (AMQP).

### <a name="deploy-modules-to-top-layer-devices"></a>Развертывание модулей на устройствах верхнего уровня

На устройстве IoT Edge на верхнем уровне иерархии шлюзов должны быть развернуты обязательные модули, а также любые модули рабочей нагрузки, которая может выполняться на устройстве.

Модуль прокси API можно настраивать, чтобы адаптировать к большинству распространенных сценариев использования шлюзов. В этой статье приведены примеры настройки модулей в базовой конфигурации. Более подробные сведения и примеры см. в разделе [Настройка модуля прокси API для иерархии шлюзов](how-to-configure-api-proxy-module.md).

1. Найдите нужный Центр Интернета вещей на [портале Azure](https://portal.azure.com).
1. Выберите **IoT Edge** в меню навигации.
1. Выберите устройство верхнего уровня для настройки в списке **Устройства IoT Edge**.
1. Щелкните **Set modules** (Настроить модули).
1. В разделе **Модули IoT Edge** выберите **Добавить**, а затем — **Модуль Marketplace**.
1. Найдите и выберите модуль **Прокси API IoT Edge**.
1. Выберите имя модуля прокси API из списка развернутых модулей и обновите следующие параметры модуля:
   1. На вкладке **Переменные среды** измените значение **NGINX_DEFAULT_PORT** на `443`.
   1. На вкладке **Параметры создания контейнера** обновите привязки портов, чтобы они ссылались на порт 443.

      ```json
      {
        "HostConfig": {
          "PortBindings": {
            "443/tcp": [
              {
                "HostPort": "443"
              }
            ]
          }
        }
      }
      ```

   Эти изменения настраивают модуль прокси API для прослушивания порта 443. Чтобы предотвратить конфликты привязки портов, необходимо настроить модуль edgeHub так, чтобы он не прослушивал порт 443. Вместо этого модуль прокси API будет маршрутизировать любой трафик edgeHub через порт 443.

1. Выберите **Параметры среды выполнения** и найдите параметры создания модуля edgeHub. Удалите привязку портов для порта 443, оставив привязки для портов 5671 и 8883.

   ```json
   {
     "HostConfig": {
       "PortBindings": {
         "5671/tcp": [
           {
             "HostPort": "5671"
           }
         ],
         "8883/tcp": [
           {
             "HostPort": "8883"
           }
         ]
       }
     }
   }
   ```

1. Нажмите кнопку **Сохранить**, чтобы сохранить изменения в параметрах среды выполнения.
1. Нажмите кнопку **Добавить** еще раз, а затем выберите **Модуль IoT Edge**.
1. Укажите следующие значения, чтобы добавить модуль реестра Docker в развертывание:
   1. **Имя модуля IoT Edge**: `registry`
   1. На вкладке **Параметры модуля** **URI изображения**: `registry:latest`
   1. На вкладке **Переменные среды** добавьте следующие переменные среды:

      * **Имя**: **Значение** `REGISTRY_PROXY_REMOTEURL`: URL-адрес реестра контейнеров, с которым должен сопоставляться этот модуль реестра. Например, `https://myregistry.azurecr`.

        Модуль реестра может сопоставляться только с одним реестром контейнеров, поэтому мы рекомендуем использовать все образы контейнеров в одном частном реестре контейнеров.

      * **Имя**: **значение** `REGISTRY_PROXY_USERNAME`: имя пользователя для проверки подлинности в реестре контейнеров.

      * **Имя**: **значение** `REGISTRY_PROXY_PASSWORD`: пароль для проверки подлинности в реестре контейнеров.

   1. На вкладке **Параметры создания контейнера** вставьте:

      ```json
      {
          "HostConfig": {
              "PortBindings": {
                  "5000/tcp": [
                      {
                          "HostPort": "5000"
                      }
                  ]
              }
          }
      }
      ```

1. Нажмите кнопку **Добавить**, чтобы добавить модуль в развертывание.
1. Нажмите **Далее: маршруты**, чтобы перейти к следующему шагу.
1. Чтобы разрешить отправку сообщений с устройства в облако, то есть с подчиненных устройств в центр Интернета вещей, включите маршрут, передающий все сообщения в центр Интернета вещей. Пример:
    1. **Имя**: `Route`
    1. **Значение**: `FROM /messages/* INTO $upstream`
1. Нажмите **Проверка и создание**, чтобы перейти к последнему шагу.
1. Нажмите **Создать** для развертывания на устройстве.

### <a name="deploy-modules-to-lower-layer-devices"></a>Развертывание модулей на устройствах нижнего уровня

На устройствах IoT Edge на более низких уровнях иерархии шлюзов необходимо развернуть только один обязательный модуль в дополнение к любым модулям рабочих нагрузок, которые могут быть запущены на устройстве.

#### <a name="route-container-image-pulls"></a>Извлечение образа контейнера для маршрутизации

Прежде чем обсудить необходимый модуль прокси для устройств IoT Edge в иерархиях шлюзов, важно понять, как устройства IoT Edge на более низких уровнях получают образы модулей.

Если устройства низкого уровня не могут подключиться к облаку, но вы хотите, чтобы они запрашивали образы модулей, как обычно, то устройство верхнего уровня в иерархии шлюзов должно быть настроено для обработки этих запросов. Устройство верхнего уровня должно запустить модуль **реестра** Docker, сопоставленный с реестром контейнеров. Затем настройте модуль прокси API для маршрутизации запросов к контейнеру. Эти сведения обсуждаются в предыдущих разделах этой статьи. В этой конфигурации устройства нижнего уровня должны указывать не на регистры облачных контейнеров, а на реестр, работающий на верхнем уровне.

Например, вместо вызова `mcr.microsoft.com/azureiotedge-api-proxy:latest` устройства более низкого уровня должны вызывать `$upstream:443/azureiotedge-api-proxy:latest`.

Параметр **$upstream** указывает на родителя устройства более низкого уровня, поэтому запрос будет проходить по всем уровням до тех пор, пока не достигнет верхнего уровня, у которого есть среда прокси, перенаправляющая запросы контейнера в модуль реестра. Порт `:443` в этом примере следует заменить на порт, прослушиваемый модулем прокси API на родительском устройстве.

Модуль прокси API может перенаправлять запросы только к одному модулю реестра, и каждый модуль реестра может сопоставляться только с одним реестром контейнеров. Таким образом, все образы, для которых требуется извлечь устройства более низкого уровня, должны храниться в одном реестре контейнеров.

Если вы не хотите, чтобы устройства более низкого уровня делали запросы на вытягивание модулей через иерархию шлюза, можно также управлять локальным решением реестра. Либо перед созданием развертываний отправьте образы модулей на устройства, а затем установите для параметра **imagePullPolicy** значение **never**.

#### <a name="bootstrap-the-iot-edge-agent"></a>Начальная загрузка агента IoT Edge

Агент IoT Edge — это первый компонент среды выполнения, который можно запустить на любом устройстве IoT Edge. Необходимо убедиться, что все подчиненные устройства IoT Edge могут получить доступ к образу модуля edgeAgent при запуске, чтобы затем получить доступ к развертываниям и запустить остальные образы модулей.

При переходе в файл конфигурации на устройстве IoT Edge для предоставления сведений о проверке подлинности, сертификатов и имени родительского узла также следует обновить образ контейнера edgeAgent.

Если устройство шлюза верхнего уровня настроено для обработки запросов образа контейнера, замените `mcr.microsoft.com` на имя родительского узла и порт прослушивания прокси API. В манифесте развертывания можно использовать `$upstream` в качестве ярлыка, но для этого необходимо, чтобы модуль edgeHub обрабатывал маршрутизацию и не запускался на этом этапе. Пример:

```toml
[agent]
name = "edgeAgent"
type = "docker"

[agent.config]
image: "{Parent FQDN or IP}:443/azureiotedge-agent:1.2.0-rc4"
```

Если вы используете локальный реестр контейнеров или предоставляете образы контейнеров вручную на устройстве, обновите файл конфигурации соответствующим образом.

#### <a name="configure-runtime-and-deploy-proxy-module"></a>Настройка среды выполнения и развертывание модуля прокси

**Прокси API** необходим для маршрутизации всех взаимодействий между облаком и любыми подчиненными устройствами IoT Edge. Для устройства IoT Edge на нижнем уровне иерархии без подчиненных устройств IoT Edge этот модуль не требуется.

Модуль прокси API можно настраивать, чтобы адаптировать к большинству распространенных сценариев использования шлюзов. В этой статье кратко рассматриваются действия по настройке модулей в базовой конфигурации. Более подробные сведения и примеры см. в разделе [Настройка модуля прокси API для иерархии шлюзов](how-to-configure-api-proxy-module.md).

1. Найдите нужный Центр Интернета вещей на [портале Azure](https://portal.azure.com).
1. Выберите **IoT Edge** в меню навигации.
1. Выберите устройство нижнего уровня для настройки в списке **Устройства IoT Edge**.
1. Щелкните **Set modules** (Настроить модули).
1. В разделе **Модули IoT Edge** выберите **Добавить**, а затем — **Модуль Marketplace**.
1. Найдите и выберите модуль **Прокси API IoT Edge**.
1. Выберите имя модуля прокси API из списка развернутых модулей и обновите следующие параметры модуля:
   1. На вкладке **Параметры модуля** обновите значение **URI изображения**. Замените `mcr.microsoft.com` на `$upstream:443`.
   1. На вкладке **Переменные среды** измените значение **NGINX_DEFAULT_PORT** на `443`.
   1. На вкладке **Параметры создания контейнера** обновите привязки портов, чтобы они ссылались на порт 443.

      ```json
      {
        "HostConfig": {
          "PortBindings": {
            "443/tcp": [
              {
                "HostPort": "443"
              }
            ]
          }
        }
      }
      ```

   Эти изменения настраивают модуль прокси API для прослушивания порта 443. Чтобы предотвратить конфликты привязки портов, необходимо настроить модуль edgeHub так, чтобы он не прослушивал порт 443. Вместо этого модуль прокси API будет маршрутизировать любой трафик edgeHub через порт 443.

1. Выберите **Параметры среды выполнения**.
1. Обновите параметры модуля edgeHub:

   1. В поле **Образ** замените `mcr.microsoft.com` на `$upstream:443`.
   1. В поле **Создание параметров** удалите привязку для порта 443, оставив привязки для портов 5671 и 8883.

   ```json
   {
     "HostConfig": {
       "PortBindings": {
         "5671/tcp": [
           {
             "HostPort": "5671"
           }
         ],
         "8883/tcp": [
           {
             "HostPort": "8883"
           }
         ]
       }
     }
   }
   ```

1. Обновите параметры модуля edgeAgent:
   1. В поле **Образ** замените `mcr.microsoft.com` на `$upstream:443`.

1. Нажмите кнопку **Сохранить**, чтобы сохранить изменения в параметрах среды выполнения.
1. Нажмите **Далее: маршруты**, чтобы перейти к следующему шагу.
1. Чтобы разрешить отправку сообщений с устройства в облако, то есть с подчиненных устройств в центр Интернета вещей, включите маршрут, передающий все сообщения в `$upstream`. Параметр вышестоящего устройства указывает на родительское устройство в случае более низкоуровневых устройств. Пример:
    1. **Имя**: `Route`
    1. **Значение**: `FROM /messages/* INTO $upstream`
1. Нажмите **Проверка и создание**, чтобы перейти к последнему шагу.
1. Нажмите **Создать** для развертывания на устройстве.

## <a name="next-steps"></a>Дальнейшие действия

[Использование устройства IoT Edge в качестве шлюза](iot-edge-as-gateway.md)

[Настройка модуля прокси API для иерархии шлюзов](how-to-configure-api-proxy-module.md)