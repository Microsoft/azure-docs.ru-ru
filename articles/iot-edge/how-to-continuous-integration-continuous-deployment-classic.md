---
title: Непрерывная интеграция и непрерывное развертывание на Azure IoT Edge устройствах (классический редактор) — Azure IoT Edge
description: Настройка непрерывной интеграции и непрерывного развертывания с помощью классического редактора — Azure IoT Edge с Azure DevOps, Azure Pipelines
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 08/26/2020
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: e38b3c617ded9c0001b01e481d4d3c1120be62ef
ms.sourcegitcommit: 58ff80474cd8b3b30b0e29be78b8bf559ab0caa1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/17/2021
ms.locfileid: "100634759"
---
# <a name="continuous-integration-and-continuous-deployment-to-azure-iot-edge-devices-classic-editor"></a>Непрерывная интеграция и непрерывное развертывание на Azure IoT Edge устройствах (классический редактор)

Вы можете легко внедрить DevOps для приложений Azure IoT Edge, используя встроенные задания Azure IoT Edge в Azure Pipelines. В этой статье показано, как можно использовать функции непрерывной интеграции и непрерывного развертывания Azure Pipelines для быстрого и эффективного создания, тестирования и развертывания приложений в Azure IoT Edge с помощью классического редактора. Кроме того, можно [использовать YAML](how-to-continuous-integration-continuous-deployment.md).

![Схема ветвей CI и CD для разработки и эксплуатации](./media/how-to-continuous-integration-continuous-deployment-classic/model.png)

Из этой статьи вы узнаете, как использовать встроенные [Azure IOT Edge задачи](/azure/devops/pipelines/tasks/build/azure-iot-edge) для Azure pipelines создания конвейеров сборки и выпуска для решения IOT Edge. Каждая задача Azure IoT Edge, добавленная в конвейер, реализует одно из следующих четырех действий.

 | Действие | Описание |
 | --- | --- |
 | Сборка образов модулей | Принимает код решения IoT Edge и создает образы контейнеров.|
 | Отправка образов модулей | Отправляет образы модулей в указанный реестр контейнеров. |
 | Создать манифест развертывания | Принимает deployment.template.jsв файле и переменных, а затем создает окончательный файл манифеста развертывания IoT Edge. |
 | Развертывание на устройствах IoT Edge | Создает IoT Edge развертывания на одном или нескольких устройствах IoT Edge. |

Если не указано иное, процедуры, описанные в этой статье, не анализируют все функциональные возможности, доступные через параметры задачи. Дополнительные сведения см. в следующих разделах:

* [Версия задачи](/azure/devops/pipelines/process/tasks?tabs=classic#task-versions)
* **Дополнительно** — если применимо, укажите модули, которые не должны создаваться.
* [Параметры управления](/azure/devops/pipelines/process/tasks?tabs=classic#task-control-options)
* [Переменные среды](/azure/devops/pipelines/process/variables?tabs=classic#environment-variables)
* [Выходные переменные](/azure/devops/pipelines/process/variables?tabs=classic#use-output-variables-from-tasks)

## <a name="prerequisites"></a>Предварительные требования

* Репозиторий Azure Repos. Если у вас его нет, вы можете [создать репозиторий Git в проекте](/azure/devops/repos/git/create-new-repo). В этой статье мы создали репозиторий, который называется **IoTEdgeRepo**.
* Решение IoT Edge, зафиксированное и отправленное в репозиторий. Если вы хотите создать пример решения для тестирования инструкций в этой статье, следуйте шагам, изложенным в статье [Использование Visual Studio Code для разработки и отладки модулей для Azure IoT Edge](how-to-vs-code-develop-module.md) или [Сведения об использовании Visual Studio 2017 для разработки и отладки модулей C# для Azure IoT Edge (предварительная версия)](./how-to-visual-studio-develop-module.md). В этой статье мы создали решение в нашем репозитории с именем **иотеджесолутион**, которое содержит код для модуля с именем **filtermodule**.

   Все, что требуется в этой статье, — это папка решения, созданная по шаблону IoT Edge в Visual Studio Code или Visual Studio. Вам не требуется создавать, отправлять, развертывать или отлаживать этот код, чтобы продолжить. Эти процессы настраиваются в Azure Pipelines.

   Если вы создаете решение, сначала клонируйте репозиторий локально. Затем вы сможете создать решение непосредственно в папке репозитория. Кроме того, вы можете легко фиксировать и отправлять файлы из нее.

* Реестр контейнеров, в который можно отправлять образы модулей. Вы можете использовать [Реестр контейнеров Azure](../container-registry/index.yml) или сторонний реестр.
* Активный [центр Интернета вещей](../iot-hub/iot-hub-create-through-portal.md) Azure по крайней мере с двумя IOT Edge устройствами для тестирования отдельных этапов тестового и рабочего развертывания. Следуйте кратким руководствам, чтобы создать устройство IoT Edge в [Linux](quickstart-linux.md) или [Windows](quickstart.md).

## <a name="create-a-build-pipeline-for-continuous-integration"></a>Создание конвейера сборки для непрерывной интеграции

В этом разделе показано, как создать конвейер сборки. Вы настраиваете автоматический запуск конвейера при внесении изменений в образец IoT Edge решение и публикацию журналов сборки.

1. Войдите в свою организацию Azure DevOps ( `https://dev.azure.com/{your organization}` ) и откройте проект, содержащий репозиторий решения для IOT Edge.

    ![Открытие своего проекта DevOps](./media/how-to-continuous-integration-continuous-deployment-classic/initial-project.png)

2. В левой части меню проекта выберите **конвейеры**. Выберите **создать конвейер** в центре страницы. Если у вас уже есть конвейеры сборки, нажмите кнопку **создать конвейер** в правом верхнем углу.

    ![Создание конвейера сборки](./media/how-to-continuous-integration-continuous-deployment-classic/add-new-pipeline.png)

3. В нижней части страницы " **где находится код?** " выберите **использовать классический редактор**. Если вы хотите использовать YAML для создания конвейеров сборки проекта, ознакомьтесь с [руководством по YAML](how-to-continuous-integration-continuous-deployment.md).

    ![Выберите использовать классический редактор](./media/how-to-continuous-integration-continuous-deployment-classic/create-without-yaml.png)

4. Следуйте инструкциям на экране для создания конвейера.

   1. Укажите сведения об источнике для нового конвейера сборки. Выберите **Azure Repos Git** в качестве источника, а затем выберите проект, репозиторий и ветвь, в которой расположен код решения IoT Edge. Затем выберите **продолжить**.

      ![Выбор источника конвейера](./media/how-to-continuous-integration-continuous-deployment-classic/pipeline-source.png)

   2. Выберите **Пустое задание** вместо шаблона.

      ![Начните с пустого задания для конвейера сборки](./media/how-to-continuous-integration-continuous-deployment-classic/start-with-empty-build-job.png)

5. После создания конвейера вы перейдете в редактор конвейера. Здесь можно изменить имя конвейера, пул агентов и спецификацию агента.

   Вы можете выбрать пул, размещенный на сервере Майкрософт, или собственный пул, который вы управляете.

   В поле Описание конвейера выберите правильную спецификацию агента на основе целевой платформы:

   * Если вы хотите создать модули на платформе amd64 для контейнеров Linux, выберите **Ubuntu-16,04** .

   * Если вы хотите создавать модули на платформе amd64 для контейнеров Windows 1809, вам необходимо [настроить агента в Windows в локальной среде](/azure/devops/pipelines/agents/v2-windows).

   * Если вы хотите создать модули на платформе platform arm32v7 или arm64 для контейнеров Linux, необходимо [настроить самостоятельный агент в Linux](https://devblogs.microsoft.com/iotdev/setup-azure-iot-edge-ci-cd-pipeline-with-arm-agent).

    ![Настройка спецификации агента сборки](./media/how-to-continuous-integration-continuous-deployment-classic/configure-env.png)

6. Конвейер предварительно настроен с заданием **Agent job 1** (Задание агента 1). Щелкните знак "плюс" ( **+** ), чтобы добавить в задание четыре задачи: **Azure IOT Edge** дважды, **скопируйте файлы** один раз и **опубликуйте артефакты сборки** один раз. Выполните поиск каждой задачи и наведите указатель мыши на имя задачи, чтобы увидеть кнопку **Добавить** .

   ![Добавление задачи Azure IoT Edge](./media/how-to-continuous-integration-continuous-deployment-classic/add-iot-edge-task.png)

   Когда все четыре задачи будут добавлены, задание агента будет выглядеть, как в следующем примере:

   ![Четыре задачи в конвейере сборки](./media/how-to-continuous-integration-continuous-deployment-classic/add-tasks.png)

7. Выберите первую задачу **Azure IoT Edge**, чтобы изменить ее. Эта задача создает все модули в решении с указанной целевой платформой. Измените задачу со следующими значениями:

    | Параметр | Описание |
    | --- | --- |
    | Отображаемое имя | Отображаемое имя автоматически обновляется при изменении поля действия. |
    | Действие | Выберите **Сборка образы модулей**. |
    | .template.jsв файле | Нажмите кнопку с многоточием (**...**) и перейдите к файлу **deployment.template.json** в репозитории, где содержится решение IoT Edge. |
    | Платформа по умолчанию | Выберите соответствующую операционную систему для модулей на основе целевого устройства IoT Edge. |
    | Выходные переменные | Укажите ссылочное имя, связываемое с путем к файлу, в котором создается deployment.jsфайла, например, **ребро**. |

   В этих конфигурациях используется репозиторий образов и тег, который определен в `module.json` файле для имени и тега образа модуля. **Образы модулей сборки** также помогают заменить переменные на точные значения, определенные в `module.json` файле. В Visual Studio или Visual Studio Code Вы указываете фактическое значение в `.env` файле. В Azure Pipelines значение задается на вкладке « **переменные конвейера** ». Выберите вкладку **переменные** в меню редактор конвейера и настройте имя и значение следующим образом:

    * **ACR_ADDRESS**: значение **сервера входа** в реестр контейнеров Azure. Вы можете узнать сервер входа на странице "Обзор" реестра контейнеров на портале Azure.

    Если в проекте имеются другие переменные, можно указать имя и значение на этой вкладке. **образы модулей сборки** распознают только те переменные, которые имеют `${VARIABLE}` Формат. Убедитесь, что в файлах используется этот формат `**/module.json` .

8. Выберите вторую задачу **Azure IoT Edge**, чтобы изменить ее. Эта задача передает все образы модулей в выбранный реестр контейнеров.

    | Параметр | Описание |
    | --- | --- |
    | Отображаемое имя | Отображаемое имя автоматически обновляется при изменении поля действия. |
    | Действие | Выбор **образов модуля push-уведомлений**. |
    | Тип реестра контейнеров | Используйте тип по умолчанию: `Azure Container Registry` . |
    | Подписка Azure. | Выберите свою подписку. |
    | Реестр контейнеров Azure | Выберите тип реестра контейнеров, используемый для хранения образов модулей. Форма меняется в зависимости от выбранного типа реестра. Если вы выберете **Реестр контейнеров Azure**, используйте раскрывающиеся списки, чтобы выбрать подписку Azure и имя реестра контейнеров. При выборе **универсального реестра контейнеров** щелкните **Создать**, чтобы создать подключение к службе реестра. |
    | .template.jsв файле | Нажмите кнопку с многоточием (**...**) и перейдите к файлу **deployment.template.json** в репозитории, где содержится решение IoT Edge. |
    | Платформа по умолчанию | Выберите соответствующую операционную систему для модулей на основе целевого устройства IoT Edge. |
    | Добавление учетных данных реестра в манифест развертывания | Укажите значение true, чтобы добавить учетные данные реестра для принудительной отправки образов DOCKER в манифест развертывания. |

   При наличии нескольких реестров контейнеров для размещения образов модулей необходимо дублировать эту задачу, выбрать другой реестр контейнеров и использовать **модули обхода** в **дополнительных** параметрах для обхода образов, которые не относятся к конкретному реестру.

9. Выберите задачу **копирование файлов** , чтобы изменить ее. Эта задача предназначена для копирования файлов в промежуточный каталог артефактов.

    | Параметр | Описание |
    | --- | --- |
    | Отображаемое имя | Используйте имя по умолчанию или настройте |
    | Исходная папка | Папка с копируемыми файлами. |
    | Содержимое | Добавьте две строки: `deployment.template.json` и `**/module.json` . Эти два файла служат входными данными для создания манифеста развертывания IoT Edge. |
    | Целевая папка | Укажите переменную `$(Build.ArtifactStagingDirectory)` . Дополнительные сведения о описании см. в разделе [переменные сборки](/azure/devops/pipelines/build/variables#build-variables) . |

10. Выберите задачу **Publish Build Artifacts** (Публикация артефактов сборки), чтобы изменить его. Укажите путь к промежуточному каталогу артефакта для задачи, чтобы путь можно было опубликовать в конвейере выпуска.

    | Параметр | Описание |
    | --- | --- |
    | Отображаемое имя | Используйте имя по умолчанию или настройте. |
    | Путь для публикации | Укажите переменную `$(Build.ArtifactStagingDirectory)` . Дополнительные сведения см. в разделе [переменные сборки](/azure/devops/pipelines/build/variables#build-variables) . |
    | Имя артефакта | Использовать имя по умолчанию: **Drop** |
    | Расположение публикации артефакта | Использовать расположение по умолчанию: **Azure pipelines** |

11. Откройте вкладку **Триггеры** и установите флажок **Enable continuous integration** (Включить непрерывную интеграцию). Убедитесь, что включена ветвь, содержащая ваш код.

    ![Включение триггера непрерывной интеграции](./media/how-to-continuous-integration-continuous-deployment-classic/configure-trigger.png)

12. Выберите **сохранить** в раскрывающемся списке **сохранить & очередь** .

Этот конвейер настроен на автоматический запуск при отправке нового кода в репозиторий. Последняя задача, публикация артефактов конвейера, активирует конвейер выпуска. Перейдите к следующему разделу для создания конвейера выпуска.

[!INCLUDE [iot-edge-create-release-pipeline-for-continuous-deployment](../../includes/iot-edge-create-release-pipeline-for-continuous-deployment.md)]

>[!NOTE]
>Если вы хотите использовать **многоуровневые развертывания** в конвейере, то многоуровневые развертывания еще не поддерживаются в задачах Azure IOT EDGE в Azure DevOps.
>
>Однако вы можете использовать [задачу Azure CLI в Azure DevOps](/azure/devops/pipelines/tasks/deploy/azure-cli) , чтобы создать развертывание в качестве многоуровневого развертывания. Чтобы получить значение **встроенного скрипта** , можно использовать [команду AZ IOT ребр развертывания CREATE](/cli/azure/ext/azure-iot/iot/edge/deployment):
>
>   ```azurecli-interactive
>   az iot edge deployment create -d {deployment_name} -n {hub_name} --content modules_content.json --layered true
>   ```

[!INCLUDE [iot-edge-verify-iot-edge-continuous-integration-continuous-deployment](../../includes/iot-edge-verify-iot-edge-continuous-integration-continuous-deployment.md)]

## <a name="next-steps"></a>Дальнейшие действия

* IoT Edge DevOps рекомендации в [Azure DevOps Starter для IOT Edge](how-to-devops-starter.md)
* Основные сведения о развертывании IoT Edge см. в статье [Understand IoT Edge deployments for single devices or at scale](module-deployment-monitoring.md) (Основные сведения о развертываниях IoT Edge для отдельных устройств или в требуемом масштабе).
* Ознакомьтесь со статьей [Развертывание и мониторинг модулей IoT Edge в нужном масштабе (предварительная версия)](how-to-deploy-at-scale.md), чтобы узнать, как создавать, обновлять или удалять развертывание.