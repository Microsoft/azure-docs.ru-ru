---
title: Хранение блочных BLOB-объектов на устройствах — Azure IoT Edge | Документация Майкрософт
description: Общие сведения о распределении по уровням и срокам жизни см. в статье поддерживаемые операции с хранилищем BLOB-объектов и подключение к учетной записи хранилища BLOB-объектов.
author: kgremban
ms.author: kgremban
ms.reviewer: arduppal
ms.date: 12/13/2019
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: e1031df9f305015048de7f708123a51875776e1b
ms.sourcegitcommit: 6cca6698e98e61c1eea2afea681442bd306487a4
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/24/2020
ms.locfileid: "97760594"
---
# <a name="store-data-at-the-edge-with-azure-blob-storage-on-iot-edge"></a>Хранение данных на пограничных устройствах с использованием хранилища BLOB-объектов Azure в IoT Edge

Хранилище BLOB-объектов Azure на IoT Edge предоставляет хранилище [блочного BLOB](/rest/api/storageservices/understanding-block-blobs--append-blobs--and-page-blobs#about-block-blobs) и [Добавление хранилища больших двоичных объектов](/rest/api/storageservices/understanding-block-blobs--append-blobs--and-page-blobs#about-append-blobs) на границе. Модуль хранилища BLOB-объектов на устройстве IoT Edge ведет себя как служба BLOB-объектов Azure, за исключением того, что большие двоичные объекты хранятся локально на устройстве IoT Edge. Вы можете получить доступ к BLOB-объектам, используя те же методы пакета SDK службы хранилища Azure или вызовы API BLOB-объектов, которые вы уже используете. В этой статье объясняются основные понятия, связанные с хранилищем BLOB-объектов Azure, в контейнере IoT Edge, где выполняется служба больших двоичных объектов на устройстве IoT Edge.

Этот модуль полезен в сценариях:

* где данные должны храниться локально, пока их не удается обработать или передать в облако. Это могут быть видео, изображения, финансовые данные, сведения о больницы или любые другие неструктурированные данные.
* Если устройства расположены в месте с ограниченным подключением.
* Если вы хотите эффективно обрабатывать данные локально, чтобы получить доступ к данным с низкой задержкой, чтобы можно было как можно быстрее реагировать на экстренные действия.
* Если вы хотите снизить затраты на пропускную способность и избежать переноса терабайтов данных в облако. Вы можете обрабатывать данные локально и передавать только обработанные данные в облако.

Просмотрите видео, чтобы ознакомиться с краткими сведениями
> [!VIDEO https://www.youtube.com/embed/xbwgMNGB_3Y]

Этот модуль поставляется с функциями **девицетоклаудуплоад** и **девицеаутоделете** .

**девицетоклаудуплоад** — это настраиваемая функциональность. Эта функция автоматически отправляет данные из локального хранилища BLOB-объектов в Azure с периодической поддержкой подключения к Интернету. Оно предоставляет следующие возможности.

* Включите или ВЫКЛЮЧИТе функцию Девицетоклаудуплоад.
* Выберите порядок, в котором данные копируются в Azure, например Невестфирст или OldestFirst.
* Укажите учетную запись хранения Azure, в которую будут передаваться ваши данные.
* Укажите контейнеры, которые необходимо передать в Azure. Этот модуль позволяет указать имена исходного и целевого контейнеров.
* Выберите возможность немедленного удаления больших двоичных объектов после отправки в облачное хранилище
* Выполнение полной передачи большого двоичного объекта (с помощью `Put Blob` операции) и передачи на уровне блока (с помощью `Put Block` `Put Block List` `Append Block` операций и).

Этот модуль использует передачу на уровне блоков, если большой двоичный объект состоит из блоков. Ниже приведены некоторые распространенные сценарии.

* Приложение обновляет некоторые блоки ранее отправленного блочного BLOB-объекта или добавляет новые блоки в добавочный большой двоичный объект. Этот модуль отправляет только обновленные блоки, а не весь большой двоичный объект.
* Модуль отправляет большой двоичный объект и подключение к Интернету исчезает. при повторном подключении происходит загрузка только оставшихся блоков, а не всего большого двоичного объекта.

Если при отправке большого двоичного объекта происходит непредвиденное завершение процесса (например, сбой питания), все блоки, которые были выполнены для отправки, будут переданы снова после того, как модуль снова станет доступен.

**девицеаутоделете** — это настраиваемая функциональность. Эта функция автоматически удаляет BLOB-объекты из локального хранилища по истечении заданного времени (измеряется в минутах). Оно предоставляет следующие возможности.

* Включите или ВЫКЛЮЧИТе функцию Девицеаутоделете.
* Укажите время в минутах (Делетеафтерминутес), по истечении которого большие двоичные объекты будут автоматически удалены.
* Выберите возможность хранения большого двоичного объекта при его отправке, если срок действия Делетеафтерминутес истечет.

## <a name="prerequisites"></a>Предварительные требования

Устройство Azure IoT Edge.

* Вы можете использовать компьютер разработки или виртуальную машину в качестве IoT Edge устройства, выполнив действия, описанные в кратком руководстве для устройств [Linux](quickstart-linux.md) или [Windows](quickstart.md).

* Список поддерживаемых операционных систем и архитектур см. в [Azure IOT Edge поддерживаемых системах](support.md#operating-systems) . Хранилище BLOB-объектов Azure в модуле IoT Edge поддерживает следующие архитектуры:
  * Windows AMD64
  * Linux AMD64
  * Linux ARM32
  * ARM64 Linux (Предварительная версия)

Облачные ресурсы.

[Центр Интернета вещей](../iot-hub/iot-hub-create-through-portal.md) цен. категории "Стандартный" в Azure.

## <a name="devicetocloudupload-and-deviceautodelete-properties"></a>свойства Девицетоклаудуплоад и Девицеаутоделете

Используйте требуемые свойства модуля, чтобы задать **девицетоклаудуплоадпропертиес** и **девицеаутоделетепропертиес**. Требуемые свойства можно задать во время развертывания или изменить позже, изменив модуль двойника без необходимости повторного развертывания. Рекомендуется проверить "двойника модуля" для `reported configuration` и убедиться, `configurationValidation` что значения правильно распространены.

### <a name="devicetoclouduploadproperties"></a>девицетоклаудуплоадпропертиес

Имя этого параметра — `deviceToCloudUploadProperties` . Если вы используете симулятор IoT Edge, присвойте значения соответствующим переменным среды для этих свойств, которые можно найти в разделе пояснения.

| Свойство | Возможные значения | Объяснение |
| ----- | ----- | ---- |
| уплоадон | true, false | По умолчанию задано значение `false` . Если вы хотите включить эту функцию, присвойте этому полю значение `true` . <br><br> Переменная среды: `deviceToCloudUploadProperties__uploadOn={false,true}` |
| уплоадордер | Невестфирст, OldestFirst | Позволяет выбрать порядок, в котором данные копируются в Azure. По умолчанию задано значение `OldestFirst` . Порядок определяется временем последнего изменения большого двоичного объекта. <br><br> Переменная среды: `deviceToCloudUploadProperties__uploadOrder={NewestFirst,OldestFirst}` |
| клаудсторажеконнектионстринг |  | `"DefaultEndpointsProtocol=https;AccountName=<your Azure Storage Account Name>;AccountKey=<your Azure Storage Account Key>;EndpointSuffix=<your end point suffix>"` — Это строка подключения, которая позволяет указать учетную запись хранения, в которую будут передаваться данные. Укажите `Azure Storage Account Name` , `Azure Storage Account Key` , `End point suffix` . Добавьте соответствующие EndpointSuffix в Azure, куда будут отправляться данные. это зависит от глобальных Azure, государственных учреждений Azure и Microsoft Azure Stack. <br><br> Здесь можно указать строку подключения SAS службы хранилища Azure. Но это свойство необходимо обновлять по истечении срока его действия. Разрешения SAS могут включать создание доступа для контейнеров, а также создание, запись и Добавление доступа для больших двоичных объектов.  <br><br> Переменная среды: `deviceToCloudUploadProperties__cloudStorageConnectionString=<connection string>` |
| сторажеконтаинерсфоруплоад | `"<source container name1>": {"target": "<target container name>"}`,<br><br> `"<source container name1>": {"target": "%h-%d-%m-%c"}`, <br><br> `"<source container name1>": {"target": "%d-%c"}` | Позволяет указать имена контейнеров, которые нужно передать в Azure. Этот модуль позволяет указать имена исходного и целевого контейнеров. Если не указать имя целевого контейнера, оно будет автоматически назначено имени контейнера `<IoTHubName>-<IotEdgeDeviceID>-<ModuleName>-<SourceContainerName>` . Вы можете создать строки шаблона для имени целевого контейнера, извлеките столбец возможные значения. <br>*% h — > имя центра Интернета вещей (3-50 символов). <br>*% d — > IoT Edge идентификатор устройства (от 1 до 129 символов). <br>*% m — > имя модуля (от 1 до 64 символов). <br>*% c-> имя исходного контейнера (от 3 до 63 символов). <br><br>Максимальный размер имени контейнера составляет 63 символов, при этом автоматически назначается имя целевого контейнера, если размер контейнера превышает 63 символов. Каждый раздел (IoTHubName, Иотеджедевицеид, ModuleName, Саурцеконтаинернаме) будет обрезан до 15 символов. <br><br> Переменная среды: `deviceToCloudUploadProperties__storageContainersForUpload__<sourceName>__target=<targetName>` |
| делетеафтеруплоад | true, false | По умолчанию задано значение `false` . Если задано значение `true` , данные будут автоматически удалены при отправке в облачное хранилище. <br><br> **Внимание!** при использовании добавочных больших двоичных объектов этот параметр приведет к удалению дополнительных больших двоичных объектов из локального хранилища после успешной отправки, и все последующие операции с блоком добавления к этим BLOB-объектам завершатся ошибкой. Используйте этот параметр с осторожностью, не включайте его, если приложение выполняет частые операции добавления или не поддерживает непрерывные операции добавления.<br><br> Переменная среды: `deviceToCloudUploadProperties__deleteAfterUpload={false,true}` . |

### <a name="deviceautodeleteproperties"></a>девицеаутоделетепропертиес

Имя этого параметра — `deviceAutoDeleteProperties` . Если вы используете симулятор IoT Edge, присвойте значения соответствующим переменным среды для этих свойств, которые можно найти в разделе пояснения.

| Свойство | Возможные значения | Объяснение |
| ----- | ----- | ---- |
| делетеон | true, false | По умолчанию задано значение `false` . Если вы хотите включить эту функцию, присвойте этому полю значение `true` . <br><br> Переменная среды: `deviceAutoDeleteProperties__deleteOn={false,true}` |
| делетеафтерминутес | `<minutes>` | Укажите время в минутах. Модуль автоматически удалит BLOB-объекты из локального хранилища, когда это значение истечет. Текущая максимальная допустимая минута — 35791. <br><br> Переменная среды: `deviceAutoDeleteProperties__ deleteAfterMinutes=<minutes>` |
| ретаинвхилеуплоадинг | true, false | По умолчанию он имеет значение `true` , и он будет хранить большой двоичный объект при отправке в облачное хранилище, если делетеафтерминутес истекает. Вы можете задать для него значение `false` , и данные будут удалены сразу после истечения срока действия делетеафтерминутес. Примечание. чтобы это свойство работало Уплоадон, должно быть установлено значение true.  <br><br> **Внимание!** при использовании добавочных больших двоичных объектов этот параметр приведет к удалению дополнительных больших двоичных объектов из локального хранилища, когда срок действия значения истечет, и все последующие операции блокировки на добавление в эти большие двоичные объекты завершатся ошибкой. Может потребоваться, чтобы значение срока действия было достаточно большим для ожидаемой частоты операций добавления, выполняемых приложением.<br><br> Переменная среды: `deviceAutoDeleteProperties__retainWhileUploading={false,true}`|

## <a name="using-smb-share-as-your-local-storage"></a>Использование общего ресурса SMB в качестве локального хранилища

Вы можете указать общий ресурс SMB в качестве пути к локальному хранилищу при развертывании контейнера Windows для этого модуля на узле Windows.

Убедитесь, что общий ресурс SMB и устройство IoT находятся в доменах с взаимным доверием.

Вы можете выполнить `New-SmbGlobalMapping` команду PowerShell, чтобы локально подключить общую папку SMB на устройстве IOT под управлением Windows.

Ниже приведены этапы настройки.

```PowerShell
$creds = Get-Credential
New-SmbGlobalMapping -RemotePath <remote SMB path> -Credential $creds -LocalPath <Any available drive letter>
```

Пример:

```powershell
$creds = Get-Credential
New-SmbGlobalMapping -RemotePath \\contosofileserver\share1 -Credential $creds -LocalPath G:
```

Эта команда будет использовать учетные данные для проверки подлинности на удаленном сервере SMB. Затем сопоставьте путь к удаленной общей папке с буквой диска G: (или любой другой доступной буквой диска). Теперь устройство IoT имеет том данных, сопоставленный с путем на диске G:.

Убедитесь, что пользователь на устройстве IoT может выполнять чтение и запись в удаленную общую папку SMB.

Для развертывания значением `<storage mount>` может быть **G:/Контаинердата: C:/блобрут**.

## <a name="granting-directory-access-to-container-user-on-linux"></a>Предоставление доступа к каталогу пользователю контейнера в Linux

Если вы использовали [Подключение тома](https://docs.docker.com/storage/volumes/) для хранилища в параметрах создания для контейнеров Linux, вам не нужно выполнять никаких дополнительных действий, но если вы использовали [привязку BIND](https://docs.docker.com/storage/bind-mounts/) , то эти действия необходимы для правильной работы службы.

Следуя принципу минимальных привилегий, чтобы ограничить права доступа для пользователей минимальными разрешениями, необходимыми для выполнения их работы, этот модуль включает пользователя (имя: абсие, идентификатор: 11000) и группу пользователей (имя: абсие, идентификатор: 11000). Если контейнер запускается в качестве **корневого** (пользователь по умолчанию является **корневым**), наша служба будет запущена как пользователь **абсие** с низким уровнем прав.

Это поведение делает настройку разрешений на путь к узлу привязывать важные данные для правильной работы службы, в противном случае произойдет сбой службы с ошибками отказа в доступе. Путь, используемый в привязке каталогов, должен быть доступен для пользователя контейнера (например, абсие 11000). Вы можете предоставить контейнеру доступ пользователя к каталогу, выполнив приведенные ниже команды на узле.

```terminal
sudo chown -R 11000:11000 <blob-dir>
sudo chmod -R 700 <blob-dir>
```

Пример:

```terminal
sudo chown -R 11000:11000 /srv/containerdata
sudo chmod -R 700 /srv/containerdata
```

Если необходимо запустить службу от имени пользователя, отличного от **абсие**, можно указать идентификатор настраиваемого пользователя в креатеоптионс в свойстве "пользователь" в манифесте развертывания. В этом случае необходимо использовать идентификатор по умолчанию или корень группы `0` .

```json
"createOptions": {
  "User": "<custom user ID>:0"
}
```

Теперь предоставьте контейнеру доступ пользователя к каталогу.

```terminal
sudo chown -R <user ID>:<group ID> <blob-dir>
sudo chmod -R 700 <blob-dir>
```

## <a name="configure-log-files"></a>Настройка файлов журналов

Дополнительные сведения о настройке файлов журналов для модуля [см. в этих рекомендациях](./production-checklist.md#set-up-logs-and-diagnostics).

## <a name="connect-to-your-blob-storage-module"></a>Подключение к модулю хранилища BLOB-объектов

Вы можете использовать имя учетной записи и ключ учетной записи, настроенные для вашего модуля, для доступа к хранилищу BLOB-объектов на устройстве IoT Edge.

Укажите устройство IoT Edge в качестве конечной точки большого двоичного объекта для любых запросов к хранилищу. Вы можете [создать строку подключения для явной конечной точки хранилища](../storage/common/storage-configure-connection-string.md#create-a-connection-string-for-an-explicit-storage-endpoint) с помощью сведений об устройстве IoT Edge и имени учетной записи.

* Для модулей, развернутых на том же устройстве, что и хранилище BLOB-объектов Azure в модуле IoT Edge, конечная точка большого двоичного объекта имеет следующее значение: `http://<module name>:11002/<account name>` .
* Для модулей или приложений, выполняющихся на другом устройстве, необходимо выбрать правильную конечную точку для сети. В зависимости от настройки сети выберите формат конечной точки, чтобы трафик данных из внешнего модуля или приложения мог связаться с устройством, на котором работает хранилище BLOB-объектов Azure, в IoT Edgeном модуле. Конечная точка большого двоичного объекта для этого сценария является одной из следующих:
  * `http://<device IP >:11002/<account name>`
  * `http://<IoT Edge device hostname>:11002/<account name>`
  * `http://<fully qualified domain name>:11002/<account name>`
 
 > [!IMPORTANT]
 > Azure IoT Edge учитывает регистр при вызове модулей, а пакет SDK хранилища также по умолчанию имеет нижний регистр. Хотя имя модуля в [Azure Marketplace](how-to-deploy-modules-portal.md#deploy-modules-from-azure-marketplace) — **азуреблобсторажеониотедже**, изменение имени на строчное помогает гарантировать, что подключения к хранилищу BLOB-объектов Azure в модуле IOT EDGE не прерываются.
 
## <a name="azure-blob-storage-quickstart-samples"></a>Примеры использования хранилища BLOB-объектов Azure

Документация по хранилищу BLOB-объектов Azure содержит примеры кода на нескольких языках. Эти примеры можно выполнить для проверки хранилища BLOB-объектов Azure на IoT Edge, изменив конечную точку большого двоичного объекта, чтобы подключиться к локальному модулю хранилища BLOB-объектов.

В следующих примерах краткого руководства используются языки, которые также поддерживаются IoT Edge, поэтому их можно развернуть как IoT Edge модулей вместе с модулем хранилища BLOB-объектов:

* [.NET](../storage/blobs/storage-quickstart-blobs-dotnet.md)
* [Python](../storage/blobs/storage-quickstart-blobs-python.md)
  * В версиях, предшествующих версии 2.1 пакета SDK для Python, есть известная ошибка, при которой модуль не возвращает время создания большого двоичного объекта. Из-за этой проблемы некоторые методы, такие как List Blobs, не работают. В качестве обходного решения явно задайте версию API в клиенте BLOB-объекта равным "2017-04-17". Пример: `block_blob_service._X_MS_VERSION = '2017-04-17'`
  * [Пример добавления большого двоичного объекта](https://github.com/Azure/azure-storage-python/blob/master/samples/blob/append_blob_usage.py)
* [Node.js](../storage/blobs/storage-quickstart-blobs-nodejs-legacy.md)
* [JS/HTML](../storage/blobs/storage-quickstart-blobs-javascript-client-libraries-legacy.md)
* [Ruby](../storage/blobs/storage-quickstart-blobs-ruby.md)
* [GO](../storage/blobs/storage-quickstart-blobs-go.md)
* [PHP](../storage/blobs/storage-quickstart-blobs-php.md)

## <a name="connect-to-your-local-storage-with-azure-storage-explorer"></a>Подключение к локальному хранилищу с помощью Обозреватель службы хранилища Azure

Для подключения к локальной учетной записи хранения можно использовать [Обозреватель службы хранилища Azure](https://github.com/microsoft/AzureStorageExplorer/releases/tag/v1.14.2) .

1. Загрузка и установка Обозревателя службы хранилища Azure

1. Подключение к службе хранилища Azure с помощью строки подключения

1. Укажите строку подключения: `DefaultEndpointsProtocol=http;BlobEndpoint=http://<host device name>:11002/<your local account name>;AccountName=<your local account name>;AccountKey=<your local account key>;`

1. Выполните действия по подключению.

1. Создание контейнера в локальной учетной записи хранения

1. Запуск отправки файлов в виде блочных BLOB-объектов или добавочных BLOB-объектов.
   > [!NOTE]
   > Этот модуль не поддерживает страничные BLOB-объекты.

1. Вы также можете подключить учетные записи хранения Azure в Обозреватель службы хранилища. Эта конфигурация предоставляет единое представление для локальной учетной записи хранения и учетной записи хранения Azure.

## <a name="supported-storage-operations"></a>Поддерживаемые операции в хранилище

Модули хранилища BLOB-объектов на IoT Edge используют пакеты SDK службы хранилища Azure и соответствуют версии 2017-04-17 API службы хранилища Azure для конечных точек блочных BLOB-объектов.

Так как хранилище BLOB-объектов Azure поддерживает не все операции хранилища BLOB-объектов Azure на IoT Edge, в этом разделе перечислены состояния каждого из них.

### <a name="account"></a>Учетная запись

Поддерживается:

* Перечисление контейнеров

Не поддерживается:

* Получение и задание свойств службы BLOB-объектов
* Предварительный запрос к BLOB-объектам
* Получение статистики службы BLOB-объектов
* Получение данных об учетной записи

### <a name="containers"></a>Контейнеры

Поддерживается:

* Создание и удаление контейнера
* Получение свойств и метаданных контейнера
* Отображение списка больших двоичных объектов
* Получение и задание списка управления доступом для контейнера
* Определение метаданных контейнера

Не поддерживается:

* Аренда контейнера

### <a name="blobs"></a>BLOB-объекты

Поддерживается:

* Помещение, получение и удаление BLOB-объекта
* Получение и задание свойств BLOB-объекта
* Получение и задание метаданных BLOB-объекта

Не поддерживается:

* Аренда BLOB-объекта
* Создание моментального снимка BLOB-объекта
* Копирование и прерывание копирования BLOB-объекта
* Отмена удаления BLOB-объекта
* Установка уровня BLOB-объекта

### <a name="block-blobs"></a>Blob-блоки

Поддерживается:

* Вставка блока
* Вставка и получение списка блоков

Не поддерживается:

* Вставка блока по URL-адресу

### <a name="append-blobs"></a>Добавочные BLOB-объекты

Поддерживается:

* Добавить блок

Не поддерживается:

* Добавить блок из URL-адреса

## <a name="event-grid-on-iot-edge-integration"></a>Сетка событий при интеграции IoT Edge

> [!CAUTION]
> Интеграция со службой "Сетка событий" на IoT Edge доступна в предварительной версии

Это хранилище BLOB-объектов Azure в модуле IoT Edge теперь обеспечивает интеграцию со службой "Сетка событий" на IoT Edge. Подробные сведения об этой интеграции см. в [руководстве по развертыванию модулей, публикации событий и проверке доставки событий](../event-grid/edge/react-blob-storage-events-locally.md).

## <a name="release-notes"></a>Заметки о выпуске

[Заметки о выпуске в центре DOCKER](https://hub.docker.com/_/microsoft-azure-blob-storage) для этого модуля

## <a name="suggestions"></a>Предложения

Ваши отзывы важны для нас, чтобы сделать этот модуль и его компоненты полезными и простыми в использовании. Поделитесь своим мнением и сообщите нам, как можно улучшить.

Вы можете связаться с нами по адресу absiotfeedback@microsoft.com

## <a name="next-steps"></a>Дальнейшие действия

Узнайте, как [развертывать хранилище BLOB-объектов Azure на IOT Edge](how-to-deploy-blob.md)

Оставайтесь в курсе последних обновлений и объявлений в [хранилище BLOB-объектов Azure в IOT Edge блоге](https://aka.ms/abs-iot-blogpost)
