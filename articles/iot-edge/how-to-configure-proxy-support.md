---
title: Настройка устройства для прокси-серверов сети — Azure IoT Edge | Документация Майкрософт
description: Сведения о настройке среды выполнения Azure IoT Edge и модулей IoT Edge с подключением к Интернету для обмена данными через прокси-сервер.
author: kgremban
ms.author: kgremban
ms.date: 09/03/2020
ms.topic: how-to
ms.service: iot-edge
services: iot-edge
ms.custom:
- amqp
- contperf-fy21q1
ms.openlocfilehash: 9f2ca089a6d885227bd61940d71ec7bb7960fbd6
ms.sourcegitcommit: ed7376d919a66edcba3566efdee4bc3351c57eda
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/24/2021
ms.locfileid: "105043161"
---
# <a name="configure-an-iot-edge-device-to-communicate-through-a-proxy-server"></a>Настройка устройства IoT Edge для обмена данными через прокси-сервер

[!INCLUDE [iot-edge-version-201806-or-202011](../../includes/iot-edge-version-201806-or-202011.md)]

Устройства IoT Edge отправляют HTTPS-запросы для обмена данными с центром IoT. Если устройство подключено к сети, которая использует прокси-сервер, необходимо настроить среду выполнения IoT Edge для обмена данными через сервер. Прокси-серверы могут также влиять на отдельные модули IoT Edge, если они отправляют HTTP- или HTTPS-запросы, которые невозможно направить через центр IoT Edge.

В этой статье рассматриваются следующие четыре шага по настройке и управлению IoT Edge устройством за прокси-сервером.

1. [**Установка среды выполнения IoT Edge на устройстве**](#install-iot-edge-through-a-proxy)

   IoT Edge сценарии установки запрашивают пакеты и файлы из Интернета, поэтому устройство должно взаимодействовать через прокси-сервер для выполнения этих запросов. Для устройств Windows сценарий установки также предоставляет возможность автономной установки.

   Этот шаг является одноразовым процессом настройки устройства IoT Edge при его первой настройке. При обновлении среды выполнения IoT Edge также требуются те же подключения.

2. [**Настройка IoT Edge и среды выполнения контейнеров на устройстве**](#configure-iot-edge-and-moby)

   IoT Edge отвечает за взаимодействие с центром Интернета вещей. Среда выполнения контейнера отвечает за управление контейнерами, поэтому обменивается данными с реестрами контейнеров. Оба этих компонента должны выполнять веб-запросы через прокси-сервер.

   Этот шаг является одноразовым процессом настройки устройства IoT Edge при его первой настройке.

3. [**Настройка свойств агента IoT Edge в файле конфигурации на устройстве**](#configure-the-iot-edge-agent)

   Управляющая программа IoT Edge изначально запускает модуль edgeAgent. Затем модуль edgeAgent извлекает манифест развертывания из центра Интернета вещей и запускает все остальные модули. Чтобы IoT Edge агент, чтобы установить первоначальное подключение к центру Интернета вещей, настройте переменные среды модуля edgeAgent вручную на самом устройстве. После первоначального подключения можно настроить модуль edgeAgent удаленно.

   Этот шаг является одноразовым процессом настройки устройства IoT Edge при его первой настройке.

4. [**Для всех будущих развертываний модулей задайте переменные среды для любого модуля, который обменивается данными через прокси-сервер.**](#configure-deployment-manifests)

   После настройки и подключения устройства IoT Edge к центру Интернета вещей через прокси-сервер необходимо поддерживать подключение во всех будущих развертываниях модулей.

   Этот шаг выполняется удаленно, поэтому каждый новый модуль или обновление развертывания поддерживает способность устройства взаимодействовать через прокси-сервер.

## <a name="know-your-proxy-url"></a>Узнайте URL-адрес своего прокси-сервера

Прежде чем приступать к выполнению действий, описанных в этой статье, необходимо знать URL-адрес прокси-сервера.

URL-адрес прокси-сервера имеет такой формат: **протокол**://**узел прокси-сервера**:**порт прокси-сервера**.

* Используется **протокол** HTTP или HTTPS. Управляющая программа DOCKER может использовать любой протокол в зависимости от параметров реестра контейнеров, но управляющая программа IoT Edge и контейнеры среды выполнения всегда должны использовать HTTP для подключения к прокси-серверу.

* **Узел прокси-сервера** — это адрес прокси-сервера. Если для прокси-сервера требуется проверка подлинности, учетные данные можно указать как часть прокси-узла со следующим форматом: **User**:**пароль** \@ **proxy_host**.

* **Порт прокси-сервера** — это сетевой порт, по которому прокси-сервер отвечает на сетевой трафик.

## <a name="install-iot-edge-through-a-proxy"></a>Установка IoT Edge через прокси-сервер

Независимо от того, работает ли устройство IoT Edge в Windows или Linux, необходимо получить доступ к пакетам установки через прокси-сервер. В зависимости от операционной системы выполните действия по установке среды выполнения IoT Edge через прокси-сервер.

### <a name="linux-devices"></a>Устройства Linux

При установке среды выполнения IoT Edge на устройстве Linux настройте в диспетчере пакетов прохождение через прокси-сервер для доступа к пакету установки. Например, [настройте apt-get для использования прокси-сервера HTTP](https://help.ubuntu.com/community/AptGet/Howto/#Setting_up_apt-get_to_use_a_http-proxy). После настройки диспетчера пакетов следуйте инструкциям в разделе [Установка среды выполнения Azure IOT Edge](how-to-install-iot-edge.md) как обычно.

### <a name="windows-devices-using-iot-edge-for-linux-on-windows"></a>Устройства Windows, использующие IoT Edge для Linux в Windows

Если вы устанавливаете среду выполнения IoT Edge с помощью IoT Edge для Linux в Windows, IoT Edge по умолчанию устанавливается на виртуальной машине Linux. Дополнительные шаги по установке и обновлению не требуются.

### <a name="windows-devices-using-windows-containers"></a>Устройства Windows, использующие контейнеры Windows

Если вы устанавливаете среду выполнения IoT Edge на устройстве Windows, необходимо дважды пройти прокси-сервер. Первое подключение загружает файл сценария установщика, а второе — во время установки для загрузки необходимых компонентов. Вы можете настроить сведения о прокси-сервере в параметрах Windows или включить сведения о прокси-сервере непосредственно в команды PowerShell.

Ниже приведен пример установки Windows с использованием `-proxy` аргумента.

1. Команде Invoke-WebRequest требуются сведения о прокси-сервере для доступа к сценарию установщика. Затем команде Deploy-IoTEdge требуются сведения о прокси-сервере для загрузки файлов установки.

   ```powershell
   . {Invoke-WebRequest -proxy <proxy URL> -useb aka.ms/iotedge-win} | Invoke-Expression; Deploy-IoTEdge -proxy <proxy URL>
   ```

2. Команде Initialize-IoTEdge не нужно проходить через прокси-сервер, поэтому на втором шаге требуются только сведения о прокси-сервере для вызова командлета Invoke — WebRequest.

   ```powershell
   . {Invoke-WebRequest -proxy <proxy URL> -useb aka.ms/iotedge-win} | Invoke-Expression; Initialize-IoTEdge
   ```

Если для прокси-сервера применяются сложные учетные данные, которые невозможно добавить в URL-адрес, используйте параметр `-ProxyCredential` в `-InvokeWebRequestParameters`. Например,

```powershell
$proxyCredential = (Get-Credential).GetNetworkCredential()
. {Invoke-WebRequest -proxy <proxy URL> -ProxyCredential $proxyCredential -useb aka.ms/iotedge-win} | Invoke-Expression; `
Deploy-IoTEdge -InvokeWebRequestParameters @{ '-Proxy' = '<proxy URL>'; '-ProxyCredential' = $proxyCredential }
```

Дополнительные сведения о параметрах прокси-сервера см. в статье [Invoke-WebRequest](/powershell/module/microsoft.powershell.utility/invoke-webrequest). Дополнительные сведения о параметрах установки Windows см. [в статье сценарии PowerShell для IOT EDGE в Windows](reference-windows-scripts.md).

## <a name="configure-iot-edge-and-moby"></a>Настройка IoT Edge и значок Кита

IoT Edge полагается на две управляющие программы, выполняющиеся на IoT Edge устройстве. Управляющая программа значок Кита делает веб-запросы для извлечения образов контейнеров из реестров контейнеров. Управляющая программа IoT Edge отправляет HTTPS-запросы для обмена данными с центром IoT.

Управляющие программы значок Кита и IoT Edge должны быть настроены на использование прокси-сервера для текущих функций устройства. Этот шаг выполняется на IoT Edge устройстве во время первоначальной настройки устройства.

### <a name="moby-daemon"></a>Управляющая программа значок Кита

Так как значок Кита построен на DOCKER, обратитесь к документации по DOCKER, чтобы настроить управляющую программу значок Кита с переменными среды. Большинство реестров контейнеров (включая DockerHub и реестры контейнеров Azure) поддерживают HTTPS-запросы, поэтому необходимо задать параметр **HTTPS_PROXY**. Если вы извлекаете образы из реестра, который не поддерживает протокол TLS, необходимо задать параметр **HTTP_PROXY**.

Выберите статью, которая относится к операционной системе устройства IoT Edge.

* [Настройка управляющей программы DOCKER в Linux](https://docs.docker.com/config/daemon/systemd/#httphttps-proxy) Управляющая программа значок Кита на устройствах Linux сохраняет имя DOCKER.
* [Настройка управляющей программы DOCKER в Windows](/virtualization/windowscontainers/manage-docker/configure-docker-daemon#proxy-configuration) Управляющая программа значок Кита на устройствах Windows называется iotedge-значок Кита. Имена различаются, так как на устройстве Windows можно параллельно запускать приложения DOCKER Desktop и значок Кита.

### <a name="iot-edge-daemon"></a>Управляющая программа IoT Edge

Управляющая программа IoT Edge настраивается аналогично управляющей программе значок Кита. Создайте переменную среды для службы, выполнив указанные ниже действия с учетом своей операционной системы.

Управляющая программа IoT Edge всегда использует протокол HTTPS для отправки запросов в центр Интернета вещей.

#### <a name="linux"></a>Linux

<!-- 1.1 -->
:::moniker range="iotedge-2018-06"

Откройте редактор в терминале, чтобы настроить управляющую программу IoT Edge.

```bash
sudo systemctl edit iotedge
```

Введите следующий текст, заменив **\<proxy URL>** адрес прокси-сервера и порт. Сохранитесь и закройте редактор.

```ini
[Service]
Environment="https_proxy=<proxy URL>"
```

Обновите диспетчер служб, чтобы получить новую конфигурацию для IoT Edge.

```bash
sudo systemctl daemon-reload
```

Перезапустите IoT Edge, чтобы изменения вступили в силу.

```bash
sudo systemctl restart iotedge
```

Убедитесь, что переменная среды была создана, а новая конфигурация загружена.

```bash
systemctl show --property=Environment iotedge
```
:::moniker-end
<!--end 1.1-->

<!-- 1.2 -->
:::moniker range=">=iotedge-2020-11"

Откройте редактор в терминале, чтобы настроить управляющую программу IoT Edge.

```bash
sudo systemctl edit aziot-edged
```

Введите следующий текст, заменив **\<proxy URL>** адрес прокси-сервера и порт. Сохранитесь и закройте редактор.

```ini
[Service]
Environment="https_proxy=<proxy URL>"
```

Начиная с версии 1,2, IoT Edge использует службу удостоверений IoT для управления подготовкой устройств с помощью центра Интернета вещей или службы подготовки устройств центра Интернета вещей. Откройте редактор в терминале, чтобы настроить управляющую программу службы удостоверений IoT.

```bash
sudo systemctl edit aziot-identityd
```

Введите следующий текст, заменив **\<proxy URL>** адрес прокси-сервера и порт. Сохранитесь и закройте редактор.

```ini
[Service]
Environment="https_proxy=<proxy URL>"
```

Обновите Service Manager, чтобы выбрать новые конфигурации.

```bash
sudo systemctl daemon-reload
```

Перезапустите системные службы IoT Edge, чтобы изменения обеих управляющих программ вступили в силу.

```bash
sudo iotedge system restart
```

Убедитесь, что переменные среды созданы и была загружена новая конфигурация.

```bash
systemctl show --property=Environment aziot-edged
systemctl show --property=Environment aziot-identityd
```
:::moniker-end
<!--end 1.2-->

#### <a name="windows-using-iot-edge-for-linux-on-windows"></a>Windows, использующий IoT Edge для Linux в Windows

Войдите в IoT Edge для Linux на виртуальной машине Windows:

```azurepowershell-interactive
Ssh-EflowVm
```

Выполните те же действия, что и в разделе Linux выше, чтобы настроить управляющую программу IoT Edge.

#### <a name="windows-using-windows-containers"></a>Windows, использующих контейнеры Windows

Откройте окно PowerShell от имени администратора и выполните следующую команду, чтобы внести изменения в реестр с помощью новой переменной среды. Замените на **\<proxy url>** адрес и порт прокси-сервера.

```powershell
reg add HKLM\SYSTEM\CurrentControlSet\Services\iotedge /v Environment /t REG_MULTI_SZ /d https_proxy=<proxy URL>
```

Перезапустите IoT Edge, чтобы изменения вступили в силу.

```powershell
Restart-Service iotedge
```

## <a name="configure-the-iot-edge-agent"></a>Настройка агента IoT Edge

Агент IoT Edge — это первый модуль, который нужно запустить на любом устройстве IoT Edge. Он запускается в первый раз на основе сведений в файле конфигурации IoT Edge. Затем агент Edge подключается к Центру Интернета вещей для получения манифестов развертывания и таким образом сообщает, что на устройстве можно развертывать и другие модули.

Этот шаг выполняется один раз на устройстве IoT Edge во время первоначальной настройки устройства.

<!-- 1.1 -->
:::moniker range="iotedge-2018-06"

1. Откройте файл config.yaml на устройстве IoT Edge. В системах Linux он находится в папке **/etc/iotedge/config.yaml**. В системах Windows он находится в папке **C:\ProgramData\iotedge\config.yaml**. Файл конфигурации защищен, поэтому для доступа к этому файлу требуются права администратора. В системах Linux используйте `sudo` команду перед открытием файла в предпочтительном текстовом редакторе. В Windows откройте текстовый редактор, например Блокнот с правами администратора, и откройте файл.

2. В файле config.yaml найдите раздел **Edge Agent module spec**. Определение агента IoT Edge включает параметр **env**, в который можно добавить переменные среды.

3. Удалите фигурные скобки, которые служат заменителями для параметра env, и добавьте новую переменную в новой строке. Помните, что отступы в YAML составляют два пробела.

   ```yaml
   https_proxy: "<proxy URL>"
   ```

4. По умолчанию среда выполнения IoT Edge использует AMQP для обмена данными с центром IoT. Некоторые прокси-серверы блокируют порты AMQP. Если это так, настройте edgeAgent на использование протокола AMQP через WebSocket. Добавьте вторую переменную среды.

   ```yaml
   UpstreamProtocol: "AmqpWs"
   ```

   ![Определение edgeAgent с переменными среды](./media/how-to-configure-proxy-support/edgeagent-edited.png)

5. Сохраните изменения в файле config.yaml и закройте редактор. Перезапустите IoT Edge, чтобы изменения вступили в силу.

   * Linux и IoT Edge для Linux в Windows:

      ```bash
      sudo systemctl restart iotedge
      ```

   * Windows с контейнерами Windows:

      ```powershell
      Restart-Service iotedge
      ```

:::moniker-end
<!-- end 1.1 -->

<!-- 1.2 -->
:::moniker range=">=iotedge-2020-11"

1. Откройте файл конфигурации на устройстве IoT Edge: `/etc/aziot/config.toml` . Файл конфигурации защищен, поэтому для доступа к этому файлу требуются права администратора. В системах Linux используйте `sudo` команду перед открытием файла в предпочтительном текстовом редакторе.

2. В файле конфигурации найдите `[agent]` раздел, содержащий все сведения о конфигурации для модуля edgeAgent, который будет использоваться при запуске. Определение агента IoT Edge включает подраздел, в `[agent.env]` котором можно добавить переменные среды.

3. Добавьте параметр **https_proxy** в раздел переменных среды и задайте для URL-адреса прокси-сервера значение.

   ```toml
   [agent.env]
   # "RuntimeLogLevel" = "debug"
   # "UpstreamProtocol" = "AmqpWs"
   "https_proxy" = "<proxy URL>"
   ```

4. По умолчанию среда выполнения IoT Edge использует AMQP для обмена данными с центром IoT. Некоторые прокси-серверы блокируют порты AMQP. Если это так, настройте edgeAgent на использование протокола AMQP через WebSocket. Раскомментируйте `UpstreamProtocol` параметр.

   ```toml
   [agent.env]
   # "RuntimeLogLevel" = "debug"
   "UpstreamProtocol" = "AmqpWs"
   "https_proxy" = "<proxy URL>"
   ```

5. Сохраните изменения и закройте редактор. Примените последние изменения.

   ```bash
   sudo iotedge config apply
   ```

:::moniker-end
<!-- end 1.2 -->

## <a name="configure-deployment-manifests"></a>Настройка манифестов развертывания  

После настройки устройства IoT Edge для работы с прокси-сервером необходимо продолжить объявлять переменную среды HTTPS_PROXY в будущих манифестах развертывания. Манифесты развертывания можно изменять либо с помощью мастера портал Azure, либо путем изменения JSON-файла манифеста развертывания.

Всегда настраивайте два модуля среды выполнения, edgeAgent и edgeHub, для связи через прокси-сервер, чтобы они могли поддерживать соединение с Центром Интернета вещей. Если удалить сведения о прокси-сервере из модуля edgeAgent, то единственный способ восстановить подключение — это изменить файл конфигурации на устройстве, как описано в предыдущем разделе.

Помимо модулей edgeAgent и edgeHub, для других модулей может потребоваться настройка прокси-сервера. Модули, которым необходим доступ к ресурсам Azure, кроме центра Интернета вещей, например хранилища BLOB-объектов, должны иметь переменную HTTPS_PROXY, указанную в файле манифеста развертывания.

Следующая процедура применима в течение всего жизненного цикла устройства IoT Edge.

### <a name="azure-portal"></a>Портал Azure

При использовании мастера **установки модулей** для создания развертываний для IOT Edge устройств в каждом модуле есть раздел **переменных среды** , где можно настроить соединения прокси-сервера.

Чтобы настроить IoT Edge агент и модули концентратора IoT Edge, на первом шаге мастера выберите **Параметры среды выполнения** .

![Настройка дополнительных параметров среды выполнения Edge](./media/how-to-configure-proxy-support/configure-runtime.png)

Добавьте переменную среды **https_proxy** и в агент IoT Edge, и в определения модуля центра IoT Edge. Если вы включили переменную среды **упстреампротокол** в файл конфигурации на устройстве IOT EDGE, добавьте его в определение модуля агента IOT Edge.

![Задание переменной среды https_proxy](./media/how-to-configure-proxy-support/edgehub-environmentvar.png)

Все остальные модули, добавляемые в манифест развертывания, должны соответствовать той же схеме.

### <a name="json-deployment-manifest-files"></a>Файлы манифеста развертывания JSON

Если вы создаете развертывания для устройств IoT Edge с помощью шаблонов в Visual Studio Code или путем создания JSON-файлов вручную, вы можете добавить переменные среды в определение каждого модуля напрямую.

Используйте следующий формат JSON:

```json
"env": {
    "https_proxy": {
        "value": "<proxy URL>"
    }
}
```

С переменными среды определение модуля должно выглядеть как в следующем примере центра Edge:

```json
"edgeHub": {
    "type": "docker",
    "settings": {
        "image": "mcr.microsoft.com/azureiotedge-hub:1.1",
        "createOptions": ""
    },
    "env": {
        "https_proxy": {
            "value": "http://proxy.example.com:3128"
        }
    },
    "status": "running",
    "restartPolicy": "always"
}
```

Если вы добавили переменную среды **UpstreamProtocol** в файл config.yaml на устройстве IoT Edge, добавьте ее также в определение модуля агента IoT Edge.

```json
"env": {
    "https_proxy": {
        "value": "<proxy URL>"
    },
    "UpstreamProtocol": {
        "value": "AmqpWs"
    }
}
```

## <a name="working-with-traffic-inspecting-proxies"></a>Работа с проверками прокси-серверов

Если прокси-сервер, который вы пытаетесь использовать, выполняет проверку трафика для подключений, защищенных с помощью TLS, важно отметить, что проверка подлинности с помощью сертификатов X. 509 не работает. IoT Edge устанавливает TLS-канал, который шифруется в конце с помощью предоставленного сертификата и ключа. Если этот канал будет недоступен для проверки трафика, прокси-сервер не сможет восстановить канал с соответствующими учетными данными, а центр Интернета вещей и служба подготовки устройств центра Интернета вещей возвращают `Unauthorized` ошибку.

Чтобы использовать прокси-сервер, выполняющий проверку трафика, необходимо использовать проверку подлинности с помощью подписанного URL-доступа или службу подготовки устройств центра Интернета вещей, добавленную в список разрешений, чтобы избежать проверки.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о ролях см. в статье о [среде выполнения IoT Edge](iot-edge-runtime.md).

Информацию об устранении ошибок при установке и настройке см. в статье [Распространенные проблемы и их решения для Azure IoT Edge](troubleshoot.md).
