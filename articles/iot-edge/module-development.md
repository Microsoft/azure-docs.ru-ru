---
title: Разработка модулей для Azure IoT Edge | Документация Майкрософт
description: Разработка пользовательских модулей для Azure IoT Edge, способных взаимодействовать со средой выполнения и Центром Интернета вещей
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 11/10/2020
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: a30b4b056d56e096f80b9494ab80a585fff76e66
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "103489939"
---
# <a name="develop-your-own-iot-edge-modules"></a>Разработка собственных модулей IoT Edge

[!INCLUDE [iot-edge-version-201806-or-202011](../../includes/iot-edge-version-201806-or-202011.md)]

Модули Azure IoT Edge можно подключить к другим службам Azure, чтобы расширить свой облачный конвейер данных. В этой статье описывается, как можно разрабатывать модули для взаимодействия со средой выполнения IoT Edge и Центром Интернета вещей, то есть с остальной частью облака Azure.

## <a name="iot-edge-runtime-environment"></a>Среда выполнения IoT Edge

Среда выполнения IoT Edge предоставляет инфраструктуру для интеграции функциональных возможностей нескольких модулей IoT Edge и их развертывания на пограничных устройствах Интернета вещей. Любую программу можно упаковать как модуль IoT Edge. Чтобы воспользоваться всеми преимуществами функций связи и управления IoT Edge, программа, выполняемая в модуле, может использовать пакет SDK для устройств Azure IoT для подключения к локальному концентратору IoT Edge.
::: moniker range=">=iotedge-2020-11"
Модули также могут использовать любой клиент MQTT для подключения к локальному брокеру MQTT центра IoT Edge.
::: moniker-end

### <a name="packaging-your-program-as-an-iot-edge-module"></a>Упаковка программы в качестве IoT Edgeного модуля

Чтобы развернуть программу на IoT Edge устройстве, ее сначала необходимо контейнерировать и запустить с помощью подсистемы, совместимой с DOCKER. IoT Edge использует [значок Кита](https://github.com/moby/moby), проект с открытым исходным кодом для DOCKER в качестве подсистемы, совместимой с DOCKER. Те же параметры, которые вы используете с DOCKER, можно передать в модули IoT Edge. Дополнительные сведения см. [в разделе Настройка параметров создания контейнера для модулей IOT Edge](how-to-use-create-options.md).

## <a name="using-the-iot-edge-hub"></a>Использование концентратора IoT Edge

Концентратор IoT Edge предоставляет две основные функции: прокси-сервер для Центра Интернета вещей и локальные подключения.

### <a name="connecting-to-iot-edge-hub-from-a-module"></a>Подключение к концентратору IoT Edge из модуля

Подключение к локальному концентратору IoT Edge из модуля включает те же действия подключения, что и для всех клиентов. Дополнительные сведения см. в разделе [Подключение к концентратору IOT Edge](iot-edge-runtime.md#connecting-to-the-iot-edge-hub).

Чтобы использовать IoT Edge маршрутизацию по AMQP или MQTT, можно использовать Модулеклиент из пакета SDK для IoT Azure. Создайте экземпляр ModuleClient для подключения модуля к центру IoT Edge, запущенному на устройстве, аналогично тому, как экземпляры DeviceClient подключают устройства Интернета вещей к Центру Интернета вещей. Дополнительные сведения о классе модулеклиент и его методах связи см. в справочнике по API для вашего предпочтительного языка SDK: [C#](/dotnet/api/microsoft.azure.devices.client.moduleclient), [C](/azure/iot-hub/iot-c-sdk-ref/iothub-module-client-h), [Python](/python/api/azure-iot-device/azure.iot.device.iothubmoduleclient), [Java](/java/api/com.microsoft.azure.sdk.iot.device.moduleclient)или [Node.js](/javascript/api/azure-iot-device/moduleclient).

<!-- <1.2> -->
::: moniker range=">=iotedge-2020-11"

Чтобы использовать IoT Edge MQTT Broker, необходимо подключить собственный клиент MQTT и инициировать подключение самостоятельно, используя сведения, получаемые IoT Edge из API рабочей нагрузки управляющей программы. <!--Need to add details here-->

Дополнительные сведения о выборе между маршрутизацией, публикацией и подпиской с помощью брокера MQTT см. в разделе [локальная связь](iot-edge-runtime.md#local-communication).

### <a name="mqtt-broker-primitives"></a>Примитивы брокера MQTT

#### <a name="send-a-message-on-a-user-defined-topic"></a>Отправка сообщения в определенный пользователем раздел

С помощью IoT Edge MQTT Broker можно публиковать сообщения в любых пользовательских разделах. Для этого следует авторизовать модуль для публикации в конкретных разделах, а затем получить маркер из API рабочей нагрузки для использования в качестве пароля при подключении к брокеру MQTT и, наконец, опубликовать сообщения в авторизованных разделах с помощью клиента MQTT.

#### <a name="receive-messages-on-a-user-defined-topic"></a>Получение сообщений в определяемом пользователем разделе

При использовании компонента IoT Edge MQTT Broker получение сообщений аналогично. Сначала убедитесь, что модуль имеет право подписываться на конкретные разделы, а затем получит маркер из API рабочей нагрузки, чтобы использовать его в качестве пароля при подключении к брокеру MQTT, и, наконец, подпишитесь на сообщения в соответствующих разделах с помощью клиента MQTT.

::: moniker-end

### <a name="iot-hub-primitives"></a>Основные сведения о Центре Интернета вещей

Центр Интернета вещей рассматривает экземпляр модуля как устройство, в том смысле, что он:

* может отправлять [сообщения с устройства в облако](../iot-hub/iot-hub-devguide-messaging.md);
* может получать [прямые методы](../iot-hub/iot-hub-devguide-direct-methods.md), специально предназначенные для него.
* Он имеет двойника модуля, который отличается от [двойникаа устройства](../iot-hub/iot-hub-devguide-device-twins.md) и другого двойников модуля этого устройства;

В настоящее время модули не могут принимать сообщения из облака на устройство или использовать функцию отправки файлов.

При написании модуля можно подключиться к концентратору IoT Edge и использовать примитивы центра Интернета вещей, как при использовании центра Интернета вещей с приложением устройства. Единственное различие между модулями IoT Edge и приложениями для устройств IoT заключается в том, что вместо удостоверения устройства необходимо ссылаться на удостоверение модуля.

#### <a name="device-to-cloud-messages"></a>Отправка сообщений с устройства в облако

Модуль IoT Edge может отправить сообщения в облако через центр IoT Edge, который выступает в качестве локального брокера и распространяет сообщения в облако. Чтобы обеспечить сложную обработку сообщений, отправляемых с устройства в облако, модуль IoT Edge может также перехватывать и обрабатывать сообщения, отправленные другими модулями или устройствами, в свой локальный центр IoT Edge и отправлять новые сообщения с обработанными данными. Таким же путем можно создать цепочки модулей IoT Edge для создания конвейеров локальной обработки.

Чтобы отправить сообщения телеметрии с устройства в облако с помощью маршрутизации, используйте Модулеклиент пакета SDK для Azure IoT. С помощью пакета SDK для Azure IoT каждый модуль имеет концепцию *входных* и *выходных* конечных точек модуля, которые соответствуют специальным темам MQTT. Используйте `ModuleClient.sendMessageAsync` метод, и он будет отсылать сообщения в выходной конечной точке модуля. Затем настройте маршрут в edgeHub, чтобы отправить эту выходную конечную точку в центр Интернета вещей.

<!-- <1.2> -->
::: moniker range=">=iotedge-2020-11"

Отправка сообщений телеметрии, отправляемых с устройства в облако, с помощью брокера MQTT аналогична публикации сообщений в определяемых пользователем разделах, но для вашего модуля используется следующий специальный раздел центра Интернета вещей: `devices/<device_name>/<module_name>/messages/events` . Авторизация должна быть настроена соответствующим образом. Кроме того, мост MQTT должен быть настроен для пересылки сообщений из этого раздела в облако.

::: moniker-end

Чтобы обрабатывать сообщения с помощью маршрутизации, сначала настройте маршрут для отправки сообщений, поступающих от другой конечной точки (модуля или устройства), во входную конечную точку модуля, а затем прослушивать сообщения во входной конечной точке модуля. При каждом возвращении нового сообщения функция обратного вызова активируется с помощью пакета SDK для Azure IoT. Обработайте сообщение с помощью этой функции обратного вызова и при необходимости отправляйте новые сообщения в очередь конечной точки модуля.

<!-- <1.2> -->
::: moniker range=">=iotedge-2020-11"

Обработка сообщений с помощью брокера MQTT аналогична подписке на сообщения в пользовательских разделах, но с помощью IoT Edge специальных разделов очереди вывода модуля: `devices/<device_name>/<module_name>/messages/events` . Авторизация должна быть настроена соответствующим образом. При необходимости можно отправить новые сообщения по выбранным темам.

::: moniker-end

#### <a name="twins"></a>Двойники

Двойников являются одним из примитивов, предоставляемых Центром Интернета вещей. Существуют документы JSON, в которых хранятся сведения о состоянии, включая метаданные, конфигурации и условия. Каждый модуль или устройство имеет собственный двойника.

Чтобы получить двойника модуля с помощью пакета SDK для IoT Azure, вызовите `ModuleClient.getTwin` метод.

<!-- <1.2> -->
::: moniker range=">=iotedge-2020-11"

Чтобы получить модуль двойника с любым клиентом MQTT, достаточно немного больше работы, так как получение двойника не является типичным шаблоном MQTT. Модуль должен сначала подписываться на специальный раздел центра Интернета вещей `$iothub/twin/res/#` . Это имя раздела наследуется из центра Интернета вещей, и все устройства и модули должны подписываться на один и тот же раздел. Это не означает, что устройства получают двойника друг друга. Центр Интернета вещей и edgeHub знают, какие двойника должны быть доставлены, даже если все устройства ожидают одно и то же имя раздела. После создания подписки модуль должен запросить двойника, опубликовав сообщение в следующем специальном разделе центра Интернета вещей с ИДЕНТИФИКАТОРом запроса `$iothub/twin/GET/?$rid=1234` . Этот идентификатор запроса является произвольным ИДЕНТИФИКАТОРом (т. е. GUID), который будет отправлен обратно центром Интернета вещей вместе с запрошенными данными. Таким способом клиент может связать свои запросы с ответами. Код результата — это код состояния, похожий на HTTP, где успешно кодируется как 200.

::: moniker-end

Чтобы получить исправление двойникаа модуля с помощью пакета SDK для IoT Azure, реализуйте функцию обратного вызова и зарегистрируйте ее с помощью `ModuleClient.moduleTwinCallback` метода из пакета SDK для Azure IOT, чтобы функция обратного вызова вызывалась каждый раз, когда происходит исправление двойника.

<!-- <1.2> -->
::: moniker range=">=iotedge-2020-11"

Чтобы получить исправление двойника для модуля с любым клиентом MQTT, этот процесс очень похож на получение полного двойников: клиенту необходимо подписываться на специальный центр Интернета вещей `$iothub/twin/PATCH/properties/desired/#` . После создания подписки, когда центр Интернета вещей отправляет изменение нужного раздела двойника, клиент получает его.

::: moniker-end

#### <a name="receive-direct-methods"></a>Получить прямые методы

Чтобы получить прямой метод с помощью пакета SDK для IoT Azure, реализуйте функцию обратного вызова и зарегистрируйте ее с помощью `ModuleClient.methodCallback` метода из пакета SDK для Azure IOT, чтобы функция обратного вызова вызывалась каждый раз, когда поступает прямой метод.

<!-- <1.2> -->
::: moniker range=">=iotedge-2020-11"

Для получения прямого метода с любым клиентом MQTT этот процесс очень похож на получение исправлений двойника. Клиент должен подтвердить, что он получил вызов, и может отправить некоторую информацию одновременно. Специальный раздел центра Интернета вещей для подписки — `$iothub/methods/POST/#` .

::: moniker-end

## <a name="language-and-architecture-support"></a>Поддержка языков и архитектур

IoT Edge поддерживает несколько операционных систем, архитектур устройств и языки разработки, чтобы вы могли создать сценарий, соответствующий вашим потребностям. В этом разделе вы ознакомитесь с вариантами разработки пользовательских модулей IoT Edge. Дополнительные сведения о поддержке средств и требованиях для каждого языка можно узнать в статье [Подготовка среды разработки и тестирования для IOT Edge](development-environment.md).

### <a name="linux"></a>Linux

Для всех языков, перечисленных в следующей таблице, IoT Edge поддерживает разработку для устройств с поддержкой AMD64 и ARM32 Linux.

| Язык разработки | Инструменты разработки |
| -------------------- | ----------------- |
| C | Visual Studio Code<br>Visual Studio 2017 или 2019 |
| C# | Visual Studio Code<br>Visual Studio 2017 или 2019 |
| Java | Visual Studio Code |
| Node.js | Visual Studio Code |
| Python | Visual Studio Code |

>[!NOTE]
>Поддержка разработки и отладки для устройств ARM64 Linux доступна в [общедоступной предварительной версии](https://azure.microsoft.com/support/legal/preview-supplemental-terms/). Подробные сведения см. в статье [Develop and debug ARM64 IoT Edge modules in Visual Studio Code (preview)](https://devblogs.microsoft.com/iotdev/develop-and-debug-arm64-iot-edge-modules-in-visual-studio-code-preview) (Разработка и отладка модулей IoT Edge для устройств ARM64 в Visual Studio Code (предварительная версия)).

### <a name="windows"></a>Windows

Для всех языков, перечисленных в следующей таблице, IoT Edge поддерживает разработку для устройств Windows AMD64.

| Язык разработки | Инструменты разработки |
| -------------------- | ----------------- |
| C | Visual Studio 2017 или 2019 |
| C# | Visual Studio Code (без возможностей отладки)<br>Visual Studio 2017 или 2019 |

## <a name="next-steps"></a>Следующие шаги

[Подготовка среды разработки и тестирования для IoT Edge](development-environment.md)

[Разработка модулей C# для IoT Edge с помощью Visual Studio](how-to-visual-studio-develop-module.md)

[Использование Visual Studio Code для разработки модулей для IoT Edge](how-to-vs-code-develop-module.md)

[Понимание и использование пакетов SDK для Центра Интернета вещей Azure](../iot-hub/iot-hub-devguide-sdks.md)
