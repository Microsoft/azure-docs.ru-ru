---
title: Проверка подлинности для подчиненных устройств — Azure IoT Edge | Документация Майкрософт
description: Проверка подлинности подчиненных устройств или конечных устройств в центре Интернета вещей и маршрутизация их подключения с помощью шлюзов Azure IoT Edge.
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 10/15/2020
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: d9e3e0f96d235829928c1f7c79864b1dc732f9e4
ms.sourcegitcommit: f3ec73fb5f8de72fe483995bd4bbad9b74a9cc9f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/04/2021
ms.locfileid: "102046352"
---
# <a name="authenticate-a-downstream-device-to-azure-iot-hub"></a>Аутентификация подчиненного устройства в Центре Интернета вещей

В сценарии с прозрачным шлюзом подчиненные устройства (иногда называемые конечными или дочерними устройствами) должны иметь удостоверения в центре Интернета вещей, как и все остальные устройства. В этой статье рассматриваются варианты проверки подлинности подчиненного устройства в центре Интернета вещей, а также показано, как объявляется подключение к шлюзу.

Для настройки успешного подключения к прозрачному шлюзу необходимо выполнить три шага. Эта статья посвящена второму шагу.

1. Настройте устройство шлюза в качестве сервера, чтобы подчиненные устройства могли безопасно подключаться к нему. Настройте шлюз для приема сообщений от подчиненных устройств и направьте их в нужное место назначения. Инструкции см. в разделе [Настройка устройства IOT Edge для работы в качестве прозрачного шлюза](how-to-create-transparent-gateway.md).
2. **Создайте удостоверение устройства для подчиненного устройства, чтобы оно может проходить проверку подлинности в центре Интернета вещей. Настройте подчиненное устройство для отправки сообщений через устройство шлюза.**
3. Подключите подчиненное устройство к устройству шлюза и начните отправлять сообщения. Эти действия см. в разделе [Подключение подчиненного устройства к шлюзу Azure IOT Edge](how-to-connect-downstream-device.md).

Подчиненные устройства могут проходить проверку подлинности в центре Интернета вещей одним из трех способов: ключи содержимого (иногда называемые общими ключами доступа), самозаверяющие сертификаты X.509 или сертификаты X.509 (CA), подписанные центром сертификации. Шаги проверки подлинности аналогичны шагам, используемым для настройки любого устройства не из IoT Edge с помощью центра Интернета вещей, с единственным исключением: требуется объявление отношения шлюза.

Автоматическая подготовка подчиненных устройств с помощью службы подготовки устройств к добавлению в центр Интернета вещей Azure (DPS) не поддерживается.

## <a name="prerequisites"></a>Предварительные требования

Выполните шаги, описанные в разделе [Настройка устройства IoT Edge для использования в качестве прозрачного шлюза](how-to-create-transparent-gateway.md).

Если вы используете проверку подлинности X. 509, вы создадите сертификаты для подчиненного устройства. Получите один и тот же корневой сертификат ЦС и скрипт создания сертификата, который использовался для повторного использования доступной для этого прозрачной статьи шлюза.

В этой статье *имя узла шлюза* упоминается в нескольких контекстах. Имя узла шлюза объявляется в параметре **HostName** файла конфигурации на устройстве шлюза IOT Edge. Он также упоминается в строке подключения подчиненного устройства. Имя узла шлюза необходимо разрешить в IP-адрес, используя DNS или запись файла узла на подчиненном устройстве.

## <a name="register-device-with-iot-hub"></a>Регистрация устройства в центре Интернета вещей

Выберите способ проверки подлинности подчиненного устройства в центре Интернета вещей:

* [Проверка подлинности с симметричным ключом](#symmetric-key-authentication). центр Интернета вещей создает ключ, который вы поместили на подчиненном устройстве. При проверке подлинности устройства центр Интернета вещей проверяет совпадение двух ключей. Для использования проверки подлинности с симметричным ключом не нужно создавать дополнительные сертификаты.

  Этот метод быстрее приступит к работе, если вы тестируете шлюзы в сценарии разработки или тестирования.

* [X. 509 с собственной проверкой подлинности](#x509-self-signed-authentication): иногда называется аутентификацией отпечатков, так как вы предоставляете общий доступ к отпечатку из сертификата X. 509 на устройстве с помощью центра Интернета вещей.

  Для устройств в рабочих сценариях рекомендуется использовать проверку подлинности с помощью сертификата.

* [Проверка подлинности, подписанная ЦС X. 509](#x509-ca-signed-authentication). Отправьте сертификат корневого ЦС в центр Интернета вещей. Когда устройства представляют сертификат X. 509 для проверки подлинности, центр Интернета вещей проверяет, относится ли он к цепочке доверия, подписанной одним и тем же корневым сертификатом ЦС.

  Для устройств в рабочих сценариях рекомендуется использовать проверку подлинности с помощью сертификата.

### <a name="symmetric-key-authentication"></a>Проверка подлинности с использованием симметричного ключа

Проверка подлинности с использованием ключа содержимого или ключа общего доступа является самым простым способом проверки подлинности в центре Интернета вещей. Если используется проверка подлинности с использованием ключа содержимого, ключ Base64 связывается с идентификатором устройства IoT в центре Интернета вещей. Этот ключ необходимо добавить в приложения IoT, чтобы устройство указывало его при подключении к центру Интернета вещей.

Добавьте новое устройство IoT в центр Интернета вещей, используя портал Azure, Azure CLI или расширение IoT для Visual Studio Code. Помните, что подчиненные устройства должны идентифицироваться в центре Интернета вещей как обычные устройства IoT, а не устройства IoT Edge.

При создании нового удостоверения устройства укажите следующие сведения.

* Создайте идентификатор для устройства.

* В качестве типа проверки подлинности выберите **Ключ содержимого**.

* Выберите **задать родительское устройство** и выберите устройство шлюза IOT EDGE, с помощью которого будет подключаться это подчиненное устройство. Вы всегда можете изменить родительский элемент позже.

   ![Создание идентификатора устройства с проверкой подлинности на основе ключа содержимого на портале](./media/how-to-authenticate-downstream-device/symmetric-key-portal.png)

   >[!NOTE]
   >Настройка родительского устройства в качестве дополнительного шага для подчиненных устройств, использующих проверку подлинности с симметричным ключом. Однако начиная с версии IoT Edge 1.1.0, каждое подчиненное устройство должно быть назначено родительскому устройству.
   >
   >Можно настроить центр IoT Edge для возврата к предыдущему поведению, задав для переменной среды **AuthenticationMode** значение **клаудандскопе**.

Для выполнения той же операции можно также использовать [расширение IOT для Azure CLI](https://github.com/Azure/azure-iot-cli-extension) . В следующем примере для создания нового устройства IoT с проверкой подлинности симметричного ключа и назначения родительского устройства используется команда [AZ IOT Hub Device-Identity](/cli/azure/ext/azure-iot/iot/hub/device-identity) :

```azurecli
az iot hub device-identity create -n {iothub name} -d {new device ID} --pd {existing gateway device ID}
```

Затем [получите и измените строку подключения](#retrieve-and-modify-connection-string), чтобы сообщить устройству о необходимости подключаться через этот шлюз.

### <a name="x509-self-signed-authentication"></a>Самоподписанная проверка подлинности X. 509

Для самостоятельно подписанной аутентификации X. 509, которая иногда называется проверкой подлинности отпечатков, необходимо создать сертификаты для размещения на подчиненном устройстве. Эти сертификаты имеют отпечаток, который указывается в центре Интернета вещей для проверки подлинности.

1. Используя сертификат ЦС, создайте два сертификата устройства (основной и дополнительный) для подчиненного устройства.

   Если у вас нет центра сертификации для создания сертификатов X. 509, можно использовать сценарии демонстрационных сертификатов IoT Edge для [создания подчиненных сертификатов устройств](how-to-create-test-certificates.md#create-downstream-device-certificates). Выполните действия по созданию самозаверяющих сертификатов. Используйте тот же корневой сертификат ЦС, который создал сертификаты для устройства шлюза.

   При создании собственных сертификатов убедитесь, что в качестве имени субъекта сертификата устройства задан идентификатор устройства, который вы используете при регистрации устройства IoT в центре Интернета вещей Azure. Этот параметр требуется для проверки подлинности.

2. Получите отпечаток SHA1 (т. н. отпечаток в интерфейсе центра Интернета вещей) из каждого сертификата, который является строкой шестнадцатеричного символа 40. Используйте следующую команду OpenSSL для просмотра сертификата и поиска отпечатка:

   * Windows:

     ```PowerShell
     openssl x509 -in <path to primary device certificate>.cert.pem -text -fingerprint
     ```

   * Linux:

     ```Bash
     openssl x509 -in <path to primary device certificate>.cert.pem -text -fingerprint | sed 's/[:]//g'
     ```

   Выполните эту команду дважды, один раз для основного и один раз для дополнительного сертификата. Отпечатки для обоих сертификатов предоставляются при регистрации нового устройства IoT с помощью самозаверяющих сертификатов X.509.

3. Перейдите в центр Интернета вещей на портале Azure и создайте новое удостоверение устройства IoT со следующими значениями:

   * Укажите **идентификатор устройства**, соответствующий имени субъекта для сертификатов устройств.
   * В качестве типа проверки подлинности выберите **самозаверяющий сертификат X.509**.
   * Вставьте шестнадцатеричные строки, скопированные из основного и дополнительного сертификатов устройства.
   * Выберите **Задать родительское устройство** и выберите шлюз IoT Edge, посредством которого будет подключаться это подчиненное устройство. Вы всегда можете изменить родительский элемент позже.

   ![Создание идентификатора устройства с проверкой подлинности на основе самозаверяющего сертификата X.509 на портале](./media/how-to-authenticate-downstream-device/x509-self-signed-portal.png)

4. Скопируйте первичные и вторичные сертификаты устройств и их ключи в любое расположение на подчиненном устройстве. Переместите копию общего сертификата корневого ЦС, который создал сертификат устройства шлюза и подчиненные сертификаты устройства.

   Вы будете ссылаться на эти файлы сертификатов в любом приложении на подчиненном устройстве, которое подключается к центру Интернета вещей. Для перемещения файлов сертификатов можно использовать службу, например [хранилище ключей Azure](../key-vault/index.yml), или функцию, такую как [протокол защищенного копирования](https://www.ssh.com/ssh/scp/).

5. Ознакомьтесь с примерами ссылок на сертификаты X.509 в приложениях IoT в различных языках программирования.

   * C#: [Set up X.509 security in your Azure IoT hub](../iot-hub/iot-hub-security-x509-get-started.md#authenticate-your-x509-device-with-the-x509-certificates) (Настройка сертификата безопасности X.509 в Центре Интернета вещей Azure)
   * C: [iotedge_downstream_device_sample.c](https://github.com/Azure/azure-iot-sdk-c/tree/master/iothub_client/samples/iotedge_downstream_device_sample)
   * Node.js: [simple_sample_device_x509.js](https://github.com/Azure/azure-iot-sdk-node/blob/master/device/samples/simple_sample_device_x509.js)
   * Java: [SendEventX509.java](https://github.com/Azure/azure-iot-sdk-java/tree/master/device/iot-device-samples/send-event-x509)
   * Python: [send_message_x509.py](https://github.com/Azure/azure-iot-sdk-python/blob/master/azure-iot-device/samples/async-hub-scenarios/send_message_x509.py)

Вы также можете использовать [расширение Интернета вещей для Azure CLI](https://github.com/Azure/azure-iot-cli-extension) для выполнения той же операции создания устройства. В следующем примере для создания нового устройства Интернета вещей с помощью самоподписанной проверки подлинности X. 509 и назначения родительского устройства используется команда [AZ IOT Hub Device-Identity](/cli/azure/ext/azure-iot/iot/hub/device-identity) .

```azurecli
az iot hub device-identity create -n {iothub name} -d {device ID} --pd {gateway device ID} --am x509_thumbprint --ptp {primary thumbprint} --stp {secondary thumbprint}
```

Затем [получите и измените строку подключения](#retrieve-and-modify-connection-string), чтобы сообщить устройству о необходимости подключаться через этот шлюз.

### <a name="x509-ca-signed-authentication"></a>Проверка подлинности, подписанная ЦС X. 509

Для проверки подлинности, подписанной центром сертификации X. 509, необходим сертификат корневого ЦС, зарегистрированный в центре Интернета вещей, который используется для подписи сертификатов для подчиненного устройства. Проверка подлинности разрешена для любого устройства, использующего сертификат, который был выдан сертификатом корневого ЦС или любым из его промежуточных сертификатов.

В этом разделе приведены инструкции, описанные в статье о центре Интернета вещей [Настройка безопасности с использованием сертификата X.509 в центре Интернета вещей Azure](../iot-hub/iot-hub-security-x509-get-started.md).

1. Используя сертификат ЦС, создайте два сертификата устройства (основной и дополнительный) для подчиненного устройства.

   Если у вас нет центра сертификации для создания сертификатов X. 509, можно использовать сценарии демонстрационных сертификатов IoT Edge для [создания подчиненных сертификатов устройств](how-to-create-test-certificates.md#create-downstream-device-certificates). Выполните действия по созданию сертификатов, подписанных ЦС. Используйте тот же корневой сертификат ЦС, который создал сертификаты для устройства шлюза.

2. Следуйте инструкциям в разделе [Регистрация сертификатов ЦС X.509 в центре Интернета вещей](../iot-hub/iot-hub-security-x509-get-started.md#register-x509-ca-certificates-to-your-iot-hub) в статье *Настройка безопасности с использованием сертификата X.509 в центре Интернета вещей Azure*. В этом разделе описывается выполнение следующих шагов.

   1. Передача сертификата корневого ЦС. Если вы используете демонстрационные сертификаты, корневой ЦС является **\<path> /цертс/Азуре-ИОТ-тест-Онли.Рут.ка.церт.пем**.

   2. Убедитесь, что вы владеете сертификатом корневого ЦС.

3. Следуйте инструкциям в разделе [Создание устройства X.509 в центре Интернета вещей](../iot-hub/iot-hub-security-x509-get-started.md#create-an-x509-device-for-your-iot-hub) в статье *Настройка безопасности с использованием сертификата X.509 в центре Интернета вещей Azure*. В этом разделе описывается выполнение следующих шагов.

   1. Добавление нового устройства. Введите имя **идентификатора устройства** в нижнем регистре и выберите тип проверки подлинности **сертификат X.509, подписанный ЦС**.

   2. Указание родительского устройства. Выберите **задать родительское устройство** и выберите устройство шлюза IOT EDGE, которое будет предоставлять подключение к центру Интернета вещей.

4. Создайте цепочку сертификатов для подчиненного устройства. Используйте тот же сертификат корневого ЦС, который вы передали в центр Интернета вещей для создания этой цепочки. Используйте тот идентификатор устройства в нижнем регистре, который вы присвоили удостоверению устройства на портале.

5. Скопируйте сертификат и ключи устройства в любое расположение на подчиненном устройстве. Переместите копию общего сертификата корневого ЦС, который создал сертификат устройства шлюза и подчиненные сертификаты устройства.

   Вы будете ссылаться на эти файлы в любых приложениях на подчиненном устройстве, которое подключается к центру Интернета вещей. Для перемещения файлов сертификатов можно использовать службу, например [хранилище ключей Azure](../key-vault/index.yml), или функцию, такую как [протокол защищенного копирования](https://www.ssh.com/ssh/scp/).

6. Ознакомьтесь с примерами ссылок на сертификаты X.509 в приложениях IoT в различных языках программирования.

   * C#: [Set up X.509 security in your Azure IoT hub](../iot-hub/iot-hub-security-x509-get-started.md#authenticate-your-x509-device-with-the-x509-certificates) (Настройка сертификата безопасности X.509 в Центре Интернета вещей Azure)
   * C: [iotedge_downstream_device_sample.c](https://github.com/Azure/azure-iot-sdk-c/tree/master/iothub_client/samples/iotedge_downstream_device_sample)
   * Node.js: [simple_sample_device_x509.js](https://github.com/Azure/azure-iot-sdk-node/blob/master/device/samples/simple_sample_device_x509.js)
   * Java: [SendEventX509.java](https://github.com/Azure/azure-iot-sdk-java/tree/master/device/iot-device-samples/send-event-x509)
   * Python: [send_message_x509.py](https://github.com/Azure/azure-iot-sdk-python/blob/master/azure-iot-device/samples/async-hub-scenarios/send_message_x509.py)

Вы также можете использовать [расширение Интернета вещей для Azure CLI](https://github.com/Azure/azure-iot-cli-extension) для выполнения той же операции создания устройства. В следующем примере для создания нового устройства IoT с подписанным центром сертификации X. 509 и назначения родительского устройства используется команда [AZ IOT Hub Device-Identity](/cli/azure/ext/azure-iot/iot/hub/device-identity) .

```azurecli
az iot hub device-identity create -n {iothub name} -d {device ID} --pd {gateway device ID} --am x509_ca
```

Затем [получите и измените строку подключения](#retrieve-and-modify-connection-string), чтобы сообщить устройству о необходимости подключаться через этот шлюз.

## <a name="retrieve-and-modify-connection-string"></a>Получение и изменение строки подключения

После создания удостоверения устройства IoT на портале можно получить основные или дополнительные ключи. Один из этих ключей необходимо добавить в строку подключения, которую приложения используют для взаимодействия с центром Интернета вещей. Для проверки подлинности на основе ключа содержимого центр Интернета вещей предоставляет полностью сформированную строку подключения в разделе сведений об устройстве. Необходимо добавить в строку подключения дополнительные сведения о шлюзе.

Для строк подключения для подчиненных устройств требуются следующие компоненты:

* Центр Интернета вещей, к которому подключается устройство: `Hostname={iothub name}.azure-devices.net`
* Идентификатор устройства, зарегистрированный в Центре Интернета вещей: `DeviceID={device ID}`
* Метод проверки подлинности, симметричный ключ или сертификаты X. 509
  * Если используется проверка подлинности с симметричным ключом, укажите первичный или вторичный ключ: `SharedAccessKey={key}`
  * Если используется проверка подлинности на основе сертификата X. 509, укажите флаг: `x509=true`
* Шлюз, через который подключается устройство. Укажите значение **имени узла** из файла конфигурации IOT Edge устройства шлюза: `GatewayHostName={gateway hostname}`

Таким образом, полная строка подключения выглядит следующим образом:

```console
HostName=myiothub.azure-devices.net;DeviceId=myDownstreamDevice;SharedAccessKey=xxxyyyzzz;GatewayHostName=myGatewayDevice
```

Или сделайте так:

```console
HostName=myiothub.azure-devices.net;DeviceId=myDownstreamDevice;x509=true;GatewayHostName=myGatewayDevice
```

Благодаря связи "родители-потомки" можно упростить строку подключения, вызвав шлюз непосредственно в качестве узла подключения. Пример.

```console
HostName=myGatewayDevice;DeviceId=myDownstreamDevice;SharedAccessKey=xxxyyyzzz
```

Эта измененная строка подключения будет использоваться в следующей статье из серии прозрачных шлюзов.

## <a name="next-steps"></a>Дальнейшие действия

На этом этапе у вас есть устройство IoT Edge, зарегистрированное в центре Интернета вещей и настроенное в качестве прозрачного шлюза. У вас также есть подчиненное устройство, зарегистрированное в центре Интернета вещей и указывающее на его устройство шлюза.

Далее необходимо настроить подчиненное устройство, чтобы оно доверяло устройству шлюза и безопасно подключаться к нему. Перейдите к следующей статье в серии прозрачных шлюзов, [Подключите подчиненное устройство к шлюзу Azure IOT Edge](how-to-connect-downstream-device.md).