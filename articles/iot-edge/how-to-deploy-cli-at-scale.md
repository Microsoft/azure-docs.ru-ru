---
title: Развертывание модулей в большом масштабе с помощью Azure CLI — Azure IoT Edge
description: Создание задач автоматического развертывания для групп устройств IoT Edge с помощью расширения IoT для Azure CLI
keywords: ''
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 10/13/2020
ms.topic: conceptual
ms.service: iot-edge
ms.custom: devx-track-azurecli
services: iot-edge
ms.openlocfilehash: 4ecb1c3dc0e72523b19e3183e17306774b3ce164
ms.sourcegitcommit: d4734bc680ea221ea80fdea67859d6d32241aefc
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/14/2021
ms.locfileid: "100370382"
---
# <a name="deploy-and-monitor-iot-edge-modules-at-scale-using-the-azure-cli"></a>Развертывание и мониторинг большого числа модулей IoT Edge с помощью Azure CLI

Создайте **автоматическое развертывание IoT Edge** с помощью интерфейса командной строки Azure, чтобы управлять текущими развертываниями одновременно для большого числа устройств. Автоматические развертывания для IoT Edge входят в состав функции [автоматического управления устройствами](../iot-hub/iot-hub-automatic-device-management.md) в Центре Интернета вещей. Развертывания — это динамические процессы, которые позволяют развертывать несколько модулей на нескольких устройствах, отслеживать состояние и работоспособность этих модулей и вносить изменения при необходимости.

Дополнительные сведения см. в статье [Общие сведения об автоматических развертываниях IoT Edge для отдельных устройств или в большом масштабе](module-deployment-monitoring.md).

С помощью этого руководства вы настроите Azure CLI и расширение Интернета вещей. Вы также узнаете, как развернуть модули на наборе устройств IoT Edge и отслеживать ход выполнения с помощью доступных команд интерфейса командной строки.

## <a name="prerequisites"></a>Предварительные требования

* [Центр Интернета вещей](../iot-hub/iot-hub-create-using-cli.md) в подписке Azure.
* Одно или несколько устройств IoT Edge.

  Если устройство IoT Edge не настроено, вы можете создать его на виртуальной машине Azure. Выполните действия, описанные в одной из кратких руководств, чтобы [создать виртуальное устройство Linux](quickstart-linux.md) или [создать виртуальное устройство Windows](quickstart.md).

* [Интерфейс командной строки Azure](/cli/azure/install-azure-cli) в вашей среде. Вам понадобится как минимум Azure CLI версии 2.0.70 или более поздней. Для проверки используйте `az --version`. Эта версия поддерживает команды расширения az и представляет собой платформу команд Knack.
* [Расширение Интернета вещей для Azure CLI](https://github.com/Azure/azure-iot-cli-extension).

## <a name="configure-a-deployment-manifest"></a>Настройка манифеста развертывания

Манифест развертывания — это документ JSON, в котором определены развертываемые модули, способ передачи данных между этими модулями и требуемые свойства для двойников модулей. Подробную информацию см. в статье [Сведения о развертывании модулей и настройке маршрутов в IoT Edge](module-composition.md).

Чтобы развернуть модули с помощью Azure CLI, сохраните манифест развертывания на локальный компьютер в формате TXT. В следующем разделе вы примените путь к файлу для выполнения команды, применяющей конкретную конфигурацию к устройству.

Вот пример простого манифеста развертывания с одним модулем.

>[!NOTE]
>Этот пример манифеста развертывания использует схему версии 1,1 для агента IoT Edge и концентратора. Версия схемы 1,1 была выпущена вместе с IoT Edge версии 1.0.10 и включает такие функции, как порядок запуска модуля и определение приоритетов маршрутов.

```json
{
  "content": {
    "modulesContent": {
      "$edgeAgent": {
        "properties.desired": {
          "schemaVersion": "1.1",
          "runtime": {
            "type": "docker",
            "settings": {
              "minDockerVersion": "v1.25",
              "loggingOptions": "",
              "registryCredentials": {}
            }
          },
          "systemModules": {
            "edgeAgent": {
              "type": "docker",
              "settings": {
                "image": "mcr.microsoft.com/azureiotedge-agent:1.1",
                "createOptions": "{}"
              }
            },
            "edgeHub": {
              "type": "docker",
              "status": "running",
              "restartPolicy": "always",
              "settings": {
                "image": "mcr.microsoft.com/azureiotedge-hub:1.1",
                "createOptions": "{\"HostConfig\":{\"PortBindings\":{\"5671/tcp\":[{\"HostPort\":\"5671\"}],\"8883/tcp\":[{\"HostPort\":\"8883\"}],\"443/tcp\":[{\"HostPort\":\"443\"}]}}}"
              }
            }
          },
          "modules": {
            "SimulatedTemperatureSensor": {
              "version": "1.1",
              "type": "docker",
              "status": "running",
              "restartPolicy": "always",
              "settings": {
                "image": "mcr.microsoft.com/azureiotedge-simulated-temperature-sensor:1.0",
                "createOptions": "{}"
              }
            }
          }
        }
      },
      "$edgeHub": {
        "properties.desired": {
          "schemaVersion": "1.0",
          "routes": {
            "upstream": "FROM /messages/* INTO $upstream"
          },
          "storeAndForwardConfiguration": {
            "timeToLiveSecs": 7200
          }
        }
      },
      "SimulatedTemperatureSensor": {
        "properties.desired": {
          "SendData": true,
          "SendInterval": 5
        }
      }
    }
  }
}
```

## <a name="layered-deployment"></a>Многоуровневое развертывание

Многоуровневые развертывания — это автоматические развертывания, которые можно размещать друг поверх друга. Дополнительную информацию о многоуровневых развертываниях см. в статье [Общие сведения об автоматических развертываниях IoT Edge для отдельных устройств или в большом масштабе](module-deployment-monitoring.md).

Многоуровневые развертывания можно создавать и администрировать с помощью Azure CLI, как и любое другое автоматическое развертывание. Есть лишь несколько несущественных отличий. После создания многоуровневого развертывания все операции Azure CLI применимы для многоуровневых развертываний, так же как для любого другого развертывания. Чтобы создать многоуровневое развертывание, добавьте флаг `--layered` в команду создания.

Второе отличие заключается в структуре манифеста развертывания. Стандартное автоматическое развертывание должно содержать системные модули среды выполнения в дополнение к пользовательским модулям, а многоуровневые развертывания состоят только из пользовательских модулей. Но зато для многоуровневых развертываний требуется наличие на том же устройстве стандартного автоматического развертывания, которое и предоставит необходимые компоненты для каждого устройства IoT Edge, такого как системные модули среды выполнения.

Вот пример простого манифеста для многоуровневого развертывания с одним модулем.

```json
{
  "content": {
    "modulesContent": {
      "$edgeAgent": {
        "properties.desired.modules.SimulatedTemperatureSensor": {
          "settings": {
            "image": "mcr.microsoft.com/azureiotedge-simulated-temperature-sensor:1.0",
              "createOptions": ""
          },
          "type": "docker",
          "status": "running",
          "restartPolicy": "always",
          "version": "1.0"
        }
      },
      "$edgeHub": {
        "properties.desired.routes.upstream": "FROM /messages/* INTO $upstream"
      },
      "SimulatedTemperatureSensor": {
        "properties.desired": {
          "SendData": true,
          "SendInterval": 5
        }
      }
    }
  }
}
```

В предыдущем примере показана настройка многоуровневого развертывания `properties.desired` для одного модуля. Если это многоуровневое развертывание предназначено для устройства, на котором уже был применен этот модуль, все существующие требуемые свойства будут перезаписаны. Чтобы обновить, а не перезаписать требуемые свойства, определите новый подраздел. Пример:

```json
"SimulatedTEmperatureSensor": {
  "properties.desired.layeredProperties": {
    "SendData": true,
    "SendInterval": 5
  }
}
```

Более подробные сведения о настройке двойников модулей в многоуровневых развертываниях можно найти в разделе [Многоуровневое развертывание](module-deployment-monitoring.md#layered-deployment)

## <a name="identify-devices-using-tags"></a>Определение устройств с помощью тегов

Перед созданием развертывания необходимо указать устройства, на которые вы хотите повлиять. Azure IoT Edge определяет устройства с помощью **тегов** в двойнике устройства. Каждое устройство может иметь несколько тегов, которые вы определяете по своему усмотрению с учетом особенностей решения. Например, при управлении кампусом интеллектуальных зданий можно добавлять к устройству следующие теги.

```json
"tags":{
  "location":{
    "building": "20",
    "floor": "2"
  },
  "roomtype": "conference",
  "environment": "prod"
}
```

Дополнительные сведения о двойниках устройств и тегах см. в статье [Общие сведения о двойниках устройств и их использование в Центре Интернета вещей](../iot-hub/iot-hub-devguide-device-twins.md).

## <a name="create-a-deployment"></a>Создание развертывания

Развертывание модулей для целевых устройств происходит при помощи создания развертывания, которое состоит из манифеста развертывания, а также других параметров.

Чтобы создать развертывание, используйте команду [az iot edge deployment create](/cli/azure/ext/azure-iot/iot/edge/deployment#ext-azure-iot-az-iot-edge-deployment-create).

```azurecli
az iot edge deployment create --deployment-id [deployment id] --hub-name [hub name] --content [file path] --labels "[labels]" --target-condition "[target query]" --priority [int]
```

Чтобы создать многоуровневое развертывание, выполните ту же команду с флагом `--layered`.

Команда создания развертывания принимает следующие параметры:

* **--layered** — необязательный флаг, который позволяет указать, что это многоуровневое развертывание.
* **--deployment-id** — имя развертывания, которое будет создано в центре IoT. Присвойте своему развертыванию уникальное имя, содержащее до 128 букв в нижнем регистре. Не используйте пробелы и следующие недопустимые символы: `& ^ [ ] { } \ | " < > /`. Обязательный параметр.
* **--content** — путь к файлу манифеста развертывания JSON. Обязательный параметр.
* **--hub-name** — имя центра IoT, в котором будет создано развертывание. Центр должен быть в текущей подписке. Измените текущую подписку с помощью команды `az account set -s [subscription name]`.
* **--labels** — добавление меток для отслеживания развертываний. Метка представляет собой пару имя и значение, которые описывают развертывание. Метки имеют формат JSON для имен и значений. Например `{"HostPlatform":"Linux", "Version:"3.0.1"}`.
* **--target-condition** — введите целевое условие, чтобы определить, для каких устройств будет предназначено это развертывание.  Условие основано на тегах двойника устройства или его сообщаемых свойствах и должно соответствовать формату выражения.  Например, `tags.environment='test' and properties.reported.devicemodel='4000x'`.
* **--priority** — положительные целые числа. Если одному устройству назначены два или более развертывания, будет применяться развертывание с самым высоким числовым значением параметра Priority.
* **--metrics** — создание метрик, которые запрашивают сообщаемые свойства edgeHub для отслеживания состояния развертывания. Метрики принимают входные данные в формате JSON или путь к файлу. Например, `'{"queries": {"mymetric": "SELECT deviceId FROM devices WHERE properties.reported.lastDesiredStatus.code = 200"}}'`.

Подробные сведения см. в разделе [Мониторинг развертывания с помощью Azure CLI](how-to-monitor-iot-edge-deployments.md#monitor-a-deployment-with-azure-cli).

## <a name="modify-a-deployment"></a>Изменение развертывания

При изменении развертывания изменения немедленно реплицируются во все целевые устройства.

Если обновить целевое условие, произойдут следующие обновления:

* Если устройство не соответствует предыдущему условию назначения, однако соответствует новому и это развертывание имеет самый высокий приоритет для устройства, то оно будет применено к устройству.
* Если устройство, на котором сейчас выполняется развертывание, больше не соответствует условию назначения, оно удаляет это развертывание и выполняет следующее развертывание с самым высоким приоритетом.
* Если устройство, на котором сейчас выполняется развертывание, больше не соответствует условию назначения, а также условию назначения любого другого развертывания, в устройстве не происходит никаких изменений. Устройство продолжает выполнять текущие модули в их актуальном состоянии, однако больше не управляется как часть этого развертывания. Если устройство соответствует условию назначения любого другого развертывания, оно удаляет это развертывание и выполняет новое.

Вы не можете обновить содержимое развертывания, в том числе определенные в манифесте развертывания модули и маршруты. Если вы хотите обновить содержимое развертывания, создайте новое развертывание с более высоким приоритетом, нацеленное на те же устройства. Вы можете изменить некоторые свойства существующего модуля, например целевое условие, метки, метрики и приоритет.

Чтобы обновить развертывание, используйте команду [az iot edge deployment update](/cli/azure/ext/azure-iot/iot/edge/deployment#ext-azure-iot-az-iot-edge-deployment-update).

```azurecli
az iot edge deployment update --deployment-id [deployment id] --hub-name [hub name] --set [property1.property2='value']
```

Команда обновления развертывания принимает следующие параметры:

* **--deployment-id** — имя существующего развертывания в центре IoT.
* **--hub-name** — имя концентратора IoT, в котором существует развертывание. Центр должен быть в текущей подписке. Переключитесь на нужную подписку с помощью команды `az account set -s [subscription name]`
* **--set** — обновление свойства в развертывании. Можно обновлять следующие свойства.
  * targetCondition — например `targetCondition=tags.location.state='Oregon'`
  * метки;
  * priority
* **--add** — добавление новых свойств в развертывание, в том числе целевых условий или меток.
* **--remove** — удаление существующих свойств, в том числе целевых условий или меток.

## <a name="delete-a-deployment"></a>Удаление развертывания

При удалении развертывания все устройства выполняют следующее развертывание, которое имеет наивысший приоритет. Если устройства не соответствуют условиям назначения любого другого развертывания, то модули не будут удалены при удалении развертывания.

Чтобы удалить развертывание, используйте команду [az iot edge deployment delete](/cli/azure/ext/azure-iot/iot/edge/deployment#ext-azure-iot-az-iot-edge-deployment-delete).

```azurecli
az iot edge deployment delete --deployment-id [deployment id] --hub-name [hub name]
```

Команда удаления развертывания принимает следующие параметры:

* **--deployment-id** — имя существующего развертывания в центре IoT.
* **--hub-name** — имя концентратора IoT, в котором существует развертывание. Центр должен быть в текущей подписке. Переключитесь на нужную подписку с помощью команды `az account set -s [subscription name]`

## <a name="next-steps"></a>Дальнейшие действия

Подробную информацию см. в статье [Общие сведения об автоматических развертываниях IoT Edge для отдельных устройств или в большом масштабе](module-deployment-monitoring.md).