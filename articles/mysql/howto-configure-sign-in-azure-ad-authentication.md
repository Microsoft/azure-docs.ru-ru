---
title: 'База данных Azure для MySQL: использование Azure Active Directory'
description: Узнайте, как настроить аутентификацию Azure Active Directory с помощью Базы данных Azure для MySQL.
author: lfittl-msft
ms.author: lufittl
ms.service: mysql
ms.topic: how-to
ms.date: 07/23/2020
ms.openlocfilehash: f5890ddb2a4b1599dbcfd1e624c9fbe71a564de7
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "102442763"
---
# <a name="use-azure-active-directory-for-authentication-with-mysql"></a>Использование Azure Active Directory для проверки подлинности с помощью MySQL

Эта статья поможет вам настроить доступ Azure Active Directory к Базе данных Azure для MySQL и выполнить подключение с помощью маркера Azure AD.

> [!IMPORTANT]
> Azure Active Directoryная проверка подлинности доступна только для MySQL 5,7 и более новых версий.

## <a name="setting-the-azure-ad-admin-user"></a>Настройка администратора Azure AD

Только администратор Azure AD может создавать или включать пользователей для аутентификации на основе Azure AD. Чтобы создать пользователя с правами администратора Azure AD, выполните следующие действия.

1. На портале Azure выберите экземпляр Базы данных Azure для MySQL, который необходимо включить для Azure AD.
2. В разделе "Параметры" выберите "Администратор Active Directory".

![установите параметр "Администратор Azure AD".][2]

3. Выберите действительного пользователя Azure AD в арендаторе клиента, который будет администратором Azure AD.

> [!IMPORTANT]
> При настройке администратора в Базу данных Azure для сервера MySQL добавляется новый пользователь со всеми разрешениями администратора.

Для каждого сервера MySQL может быть создан только один администратор Azure AD. Выбор другого администратора приведет к перезаписи имеющегося администратора Azure AD, настроенного для сервера.

После настройки администратора вы можете войти в систему:

## <a name="connecting-to-azure-database-for-mysql-using-azure-ad"></a>Подключение к Базе данных Azure для MySQL с помощью Azure AD

На следующей общей схеме представлен рабочий процесс использования аутентификации Azure AD с Базой данных Azure для MySQL.

![Поток аутентификации][1]

Мы разработали интеграцию Azure AD для работы с распространенными инструментами MySQL (например, CLI mysql), которые не поддерживают Azure AD и поддерживают указание имени пользователя и пароля только при подключении к MySQL. Мы передаем маркер Azure AD в качестве пароля, как показано на приведенном выше рисунке.

В настоящее время мы протестировали следующие клиенты:

- MySQLWorkbench 
- Mysql CLI

Мы также протестировали наиболее распространенные драйверы приложений. Подробные сведения можно просмотреть в конце этой страницы.

Ниже приведены шаги, которые пользователь или приложение должны будут выполнить для аутентификации в Azure AD.

### <a name="prerequisites"></a>Предварительные условия

Вы можете следовать указаниям в Azure Cloud Shell, виртуальной машине Azure или на локальном компьютере. Убедитесь, что у вас [установлен Azure CLI](/cli/azure/install-azure-cli).

### <a name="step-1-authenticate-with-azure-ad"></a>Шаг 1. Аутентификация с помощью Azure AD

Начните с проверки подлинности в Azure AD с помощью средства Azure CLI. Этот шаг не требуется в Azure Cloud Shell.

```
az login
```

Команда запустит окно браузера на странице аутентификации Azure AD. Для этого нужно указать ИД пользователя Azure AD и пароль.

### <a name="step-2-retrieve-azure-ad-access-token"></a>Шаг 2. Получение маркера доступа Azure AD

Вызовите инструмент Azure CLI, чтобы получить маркер доступа для пользователя Azure AD, прошедшего аутентификацию, из шага 1, необходимый для доступа к Базе данных Azure для MySQL.

Пример (для общедоступного облака):

```azurecli-interactive
az account get-access-token --resource https://ossrdbms-aad.database.windows.net
```

Приведенное выше значение ресурса должно быть указано точно так, как показано. Для других облаков значение ресурса можно найти с помощью следующего.

```azurecli-interactive
az cloud show
```

Для Azure CLI 2.0.71 и более поздних версий команду можно указать в следующей более удобной версии для всех облаков.

```azurecli-interactive
az account get-access-token --resource-type oss-rdbms
```

После успешной аутентификации Azure AD вернет маркер доступа:

```json
{
  "accessToken": "TOKEN",
  "expiresOn": "...",
  "subscription": "...",
  "tenant": "...",
  "tokenType": "Bearer"
}
```

Маркер представляет собой строку в кодировке Base 64, которая кодирует все сведения о пользователе, прошедшем аутентификацию, и которая предназначена для службы "База данных Azure для MySQL".

> [!NOTE]
> Срок действия маркера доступа составляет от 5 до 60 минут. Мы рекомендуем получить маркер доступа непосредственно перед началом входа в Базу данных Azure для MySQL.

### <a name="step-3-use-token-as-password-for-logging-in-with-mysql"></a>Шаг 3. Использование маркера в качестве пароля для входа с помощью MySQL

При подключении в качестве пароля пользователя MySQL необходимо использовать маркер доступа. При использовании клиентов GUI (например, MySQLWorkbench) для получения маркера можно применять описанный выше метод. 

При использовании CLI для подключения вы можете использовать это сокращение: 

**Пример (Linux/macOS):**
```
mysql -h mydb.mysql.database.azure.com \ 
  --user user@tenant.onmicrosoft.com@mydb \ 
  --enable-cleartext-plugin \ 
  --password=`az account get-access-token --resource-type oss-rdbms --output tsv --query accessToken`
```

Важные моменты при подключении:

* `user@tenant.onmicrosoft.com` — имя пользователя или группы Azure AD, которую вы пытаетесь подключить.
* Всегда добавлять имя сервера после имени пользователя или группы Azure AD (например, `@mydb` )
* Убедитесь, что используется точный способ написания имени пользователя или группы Azure AD.
* Имена пользователей и групп Azure AD чувствительны к регистру
* При подключении в качестве группы используйте только имя группы (например,). `GroupName@mydb`
* Если имя содержит пробелы, используйте `\` перед каждым пробелом, чтобы экранировать его.

Обратите внимание на параметр enable-cleartext-plugin — вам нужно использовать аналогичную конфигурацию с другими клиентами, чтобы маркер отправлялся на сервер без хеширования.

Теперь вы прошли аутентификацию на сервере MySQL с использованием аутентификации Azure AD.

## <a name="creating-azure-ad-users-in-azure-database-for-mysql"></a>Создание пользователей Azure AD в Базе данных Azure для MySQL

Чтобы добавить пользователя Azure AD в Базу данных Azure для MySQL, после подключения выполните приведенные ниже действия (сведения о подключении см. в разделе ниже).

1. Сначала убедитесь, что пользователь Azure AD `<user>@yourtenant.onmicrosoft.com` является действительным пользователем в клиенте Azure AD.
2. Войдите в свой экземпляр Базы данных Azure для MySQL в качестве администратора Azure AD.
3. Создайте пользователя `<user>@yourtenant.onmicrosoft.com` в Базе данных Azure для MySQL.

**Пример**.

```sql
CREATE AADUSER 'user1@yourtenant.onmicrosoft.com';
```

Для имен пользователей длиннее 32 символов рекомендуется использовать псевдоним, который будет применяться при подключении: 

Пример

```sql
CREATE AADUSER 'userWithLongName@yourtenant.onmicrosoft.com' as 'userDefinedShortName'; 
```

> [!NOTE]
> Аутентификация пользователя через Azure AD не дает пользователю никаких разрешений для доступа к объектам в Базе данных Azure для MySQL. Вы должны предоставить пользователю необходимые разрешения вручную.

## <a name="creating-azure-ad-groups-in-azure-database-for-mysql"></a>Создание групп Azure AD в Базе данных Azure для MySQL

Чтобы включить группу Azure AD для доступа к базе данных, используйте тот же механизм, что и для пользователей, но вместо имени пользователя укажите имя группы:

**Пример**.

```sql
CREATE AADUSER 'Prod_DB_Readonly';
```

При входе в систему участники группы будут использовать свои персональные маркеры доступа, но будут подписаны с именем группы, указанным в качестве имени пользователя.

## <a name="token-validation"></a>Проверка маркеров

Аутентификация Azure AD в Базе данных Azure для MySQL гарантирует, что пользователь существует на сервере MySQL. Она выполняет проверку действительности маркера путем проверки его содержимого. Для проверки маркера выполняются приведенные ниже шаги.

-   Маркер подписан с помощью Azure AD и не был подделан.
-   Azure AD выдал маркер для клиента, связанного с сервером.
-   Срок действия маркера не истек.
-   Маркер предназначен для ресурса Базы данных Azure для MySQL (а не другого ресурса Azure).

## <a name="compatibility-with-application-drivers"></a>Совместимость с драйверами приложений

Поддерживается большинство драйверов, однако необходимо обязательно использовать параметры для отправки пароля в виде открытого текста, чтобы маркер отправлялся без изменений.

* C/C++
  * libmysqlclient: Поддерживается
  * mysql-connector-c++: Поддерживается
* Java
  * Connector/J (mysql-connector-java): поддерживается, должен использовать параметр `useSSL`
* Python
  * Connector/Python: Поддерживается
* Ruby
  * mysql2: Поддерживается
* .NET
  * mysql-connector-net: поддерживается, необходимо добавить подключаемый модуль для mysql_clear_password
  * mysql-net/MySqlConnector: Поддерживается
* Node.js
  * mysqljs: не поддерживается (не отправляет маркер в виде открытого текста без исправления)
  * node-mysql2: Поддерживается
* Perl;
  * DBD::mysql: Поддерживается
  * Net::MySQL: Не поддерживается
* Go
  * go-sql-driver: поддерживается, необходимо добавить `?tls=true&allowCleartextPasswords=true` в строку подключения

## <a name="next-steps"></a>Дальнейшие действия

* Ознакомление с общими концепциями [проверки подлинности Azure Active Directory с помощью базы данных Azure для MySQL.](concepts-azure-ad-authentication.md)

<!--Image references-->

[1]: ./media/concepts-azure-ad-authentication/authentication-flow.png
[2]: ./media/concepts-azure-ad-authentication/set-azure-ad-admin.png
