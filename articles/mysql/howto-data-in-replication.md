---
title: Настройка репликации данных в службе "база данных Azure для MySQL"
description: В этой статье объясняется, как настроить репликацию входных данных для Базы данных Azure для MySQL.
author: savjani
ms.author: pariks
ms.service: mysql
ms.topic: how-to
ms.date: 01/13/2021
ms.openlocfilehash: 22974a47a6b1e9d49e5055a85f46286497cfe149
ms.sourcegitcommit: 25d1d5eb0329c14367621924e1da19af0a99acf1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/16/2021
ms.locfileid: "98250538"
---
# <a name="how-to-configure-azure-database-for-mysql-data-in-replication"></a>Настройка Базы данных Azure для MySQL для репликации входных данных

В этой статье описывается, как настроить [репликация входных данных](concepts-data-in-replication.md) в базе данных Azure для MySQL, настроив серверы источника и реплики. В этой статье предполагается, что у вас есть опыт работы с серверами и базами данных MySQL.

> [!NOTE]
> Эта статья содержит ссылки на термин « _Ведомый_» термин, который корпорация Майкрософт больше не использует. Когда этот термин будет удален из программного обеспечения, мы удалим его из статьи.
>

Чтобы создать реплику в службе "база данных Azure для MySQL", [репликация входных данных](concepts-data-in-replication.md)  синхронизирует данные с исходного сервера MySQL в локальной среде, на виртуальных машинах или в облачных службах баз данных. Репликация входных данных основана на функции собственной репликации в MySQL на основе позиции файла двоичного журнала (binlog). Дополнительные сведения о репликации binlog MySQL см. в [этой статье](https://dev.mysql.com/doc/refman/5.7/en/binlog-replication-configuration-overview.html).

Перед выполнением действий, описанных в этой статье, ознакомьтесь с [ограничениями и требованиями к](concepts-data-in-replication.md#limitations-and-considerations) репликации данных.

## <a name="create-a-mysql-server-to-be-used-as-replica"></a>Создание сервера MySQL для использования в качестве реплики

1. Создайте новый сервер Базы данных Azure для MySQL.

   Создайте новый сервер MySQL (например, replica.mysql.database.azure.com). Дополнительные сведения см. в статье о [создании сервера Базы данных Azure для MySQL с помощью портала Azure](quickstart-create-mysql-server-database-using-azure-portal.md). Этот сервер будет сервером-репликой в процессе репликации входных данных.

   > [!IMPORTANT]
   > Сервер Базы данных Azure для MySQL необходимо создать в ценовой категории "Общего назначения" или "Оптимизировано для памяти".
   >

2. Создайте одинаковые учетные записи пользователей и соответствующие привилегии.

   Учетные записи пользователей не реплицируются с исходного сервера на сервер реплики. Если вы планируете предоставлять пользователям доступ к серверу реплики, необходимо вручную создать все учетные записи и соответствующие привилегии на новом созданном сервере базы данных Azure для MySQL.

3. Добавьте IP-адрес исходного сервера в правила брандмауэра для реплики.

   Измените правила брандмауэра на [портале Azure](howto-manage-firewall-using-portal.md) или с помощью [Azure CLI](howto-manage-firewall-using-cli.md).

## <a name="configure-the-source-server"></a>Настройка исходного сервера

Ниже приведены действия для подготовки и настройки сервера MySQL, размещенного в локальной среде или на виртуальной машине, либо службы базы данных, размещенной у другого поставщика облака облачных служб, для репликации входных данных. Этот сервер является источником в репликации данных.

1. Прежде чем продолжать, ознакомьтесь с [требованиями к исходному серверу](concepts-data-in-replication.md#requirements) .

2. Убедитесь, что исходный сервер допускает входящий и исходящий трафик через порт 3306 и имеет общедоступный **IP-адрес**, DNS является общедоступным или имеет полное доменное имя (FQDN).

   Проверьте подключение к исходному серверу, попытайтесь подключиться из такого средства, как Командная строка MySQL, размещенная на другом компьютере, или из [Azure Cloud Shell](../cloud-shell/overview.md) , доступных в портал Azure.

   Если ваша организация имеет ограниченные политики безопасности и не позволяет всем IP-адресам на исходном сервере разрешить обмен данными из Azure с исходным сервером, можно использовать приведенную ниже команду, чтобы определить IP-адрес сервера MySQL.

   1. Войдите в базу данных Azure для MySQL с помощью такого средства, как Командная строка MySQL.

   2. Выполните приведенный ниже запрос.

      ```bash
      mysql> SELECT @@global.redirect_server_host;
      ```

      Ниже приведен пример выходных данных:

      ```bash
      +-----------------------------------------------------------+
      | @@global.redirect_server_host                             |
      +-----------------------------------------------------------+
      | e299ae56f000.tr1830.westus1-a.worker.database.windows.net |
       +-----------------------------------------------------------+
      ```

   3. Выйдите из командной строки MySQL.
   4. Чтобы получить IP-адрес, выполните следующую команду в служебной программе Ping.

      ```bash
      ping <output of step 2b>
      ```

      Пример:

      ```bash
      C:\Users\testuser> ping e299ae56f000.tr1830.westus1-a.worker.database.windows.net
      Pinging tr1830.westus1-a.worker.database.windows.net (**11.11.111.111**) 56(84) bytes of data.
      ```

   5. Настройте правила брандмауэра исходного сервера, чтобы включить выведенный на предыдущий шаг IP-адрес на порт 3306.

   > [!NOTE]
   > Этот IP-адрес может измениться из-за операций обслуживания и развертывания. Этот метод подключения предназначен только для клиентов, которые не могут позволить себе разрешить все IP-адреса на порту 3306.
  
3. Включите ведение двоичного журнала.

   Проверьте, включено ли в источнике двоичное ведение журнала, выполнив следующую команду: 

   ```sql
   SHOW VARIABLES LIKE 'log_bin';
   ```

   Если переменная [`log_bin`](https://dev.mysql.com/doc/refman/8.0/en/replication-options-binary-log.html#sysvar_log_bin) возвращается со значением "on", ведение двоичного журнала включено на сервере.

   Если `log_bin` возвращается значение "OFF", включите ведение двоичного журнала, отредактировав файл My. cnf `log_bin=ON` и перезапустите сервер, чтобы изменения вступили в силу.

4. Параметры исходного сервера

   Для Репликация входных данных требуется `lower_case_table_names` согласованность параметров между сервером источника и реплики. По умолчанию этот параметр в Базе данных Azure для MySQL равен 1.

   ```sql
   SET GLOBAL lower_case_table_names = 1;
   ```

5. Создайте новую роль репликации и настройте разрешения.

   Создайте учетную запись пользователя на исходном сервере, для которой настроены права репликации. Это можно сделать с помощью команд SQL или такого средства, как MySQL Workbench. Определите, планируется ли репликация с использованием SSL, так как это будет необходимо указать при создании пользователя. Сведения о [добавлении учетных записей пользователей](https://dev.mysql.com/doc/refman/5.7/en/user-names.html) на исходном сервере см. в документации по MySQL.

   В следующих командах новая созданная роль репликации может обращаться к источнику с любого компьютера, а не только с компьютера, на котором размещен сам источник. Для этого следует указать "syncuser@'%'" в команде создания пользователя. Дополнительные сведения об [указании имен учетных записей](https://dev.mysql.com/doc/refman/5.7/en/account-names.html) см. в документации по MySQL.

   **Команда SQL**

   *Репликация с использованием SSL*

   Чтобы настроить обязательное использование SSL для всех подключений пользователей, примените следующую команду для создания пользователя:

   ```sql
   CREATE USER 'syncuser'@'%' IDENTIFIED BY 'yourpassword';
   GRANT REPLICATION SLAVE ON *.* TO ' syncuser'@'%' REQUIRE SSL;
   ```

   *Репликация без SSL*

   Если SSL не требуется для всех подключений, создайте пользователя с помощью следующей команды:

   ```sql
   CREATE USER 'syncuser'@'%' IDENTIFIED BY 'yourpassword';
   GRANT REPLICATION SLAVE ON *.* TO ' syncuser'@'%';
   ```

   **MySQL Workbench**

   Чтобы создать роль репликации в MySQL Workbench, откройте панель " **Пользователи и привилегии** " на панели **управления** , а затем выберите **Добавить учетную запись**.

   :::image type="content" source="./media/howto-data-in-replication/users_privileges.png" alt-text="Пользователи и привилегии":::

   Введите имя пользователя в поле **Login Name** (Имя входа).

   :::image type="content" source="./media/howto-data-in-replication/syncuser.png" alt-text="Синхронизация пользователя":::

   Выберите панель " **административные роли** ", а затем в списке **глобальных привилегий** выберите **репликация Slave** . Затем нажмите кнопку **Применить** , чтобы создать роль репликации.

   :::image type="content" source="./media/howto-data-in-replication/replicationslave.png" alt-text="Ведомая роль репликации":::

6. Установка исходного сервера в режиме только для чтения

   Перед началом выгрузки базы данных сервер необходимо перевести в режим только для чтения. В режиме только для чтения источник не сможет обрабатывать транзакции записи. Оцените, как это повлияет на ваш бизнес, и при необходимости запланируйте окно режима только для чтения на непиковое время.

   ```sql
   FLUSH TABLES WITH READ LOCK;
   SET GLOBAL read_only = ON;
   ```

7. Узнайте имя файла двоичного журнала и смещение.

   Выполните [`show master status`](https://dev.mysql.com/doc/refman/5.7/en/show-master-status.html) команду, чтобы определить текущее имя двоичного файла журнала и смещение.

   ```sql
    show master status;
   ```

   Результаты должны выглядеть следующим образом. Обязательно запишите имя двоичного файла, так как оно будет использоваться на последующих шагах.

   :::image type="content" source="./media/howto-data-in-replication/masterstatus.png" alt-text="Результаты состояния основного сервера":::

## <a name="dump-and-restore-source-server"></a>Дамп и восстановление исходного сервера

1. Определите, какие базы данных и таблицы необходимо реплицировать в базу данных Azure для MySQL, и выполните дамп с исходного сервера.

    Для выгрузки баз данных с главного сервера можно использовать mysqldump. Подробные сведения см. в статье о [дампе и восстановлении](concepts-migrate-dump-restore.md). Дамп библиотеки MySQL и библиотеки тестирования не требуется.

2. Задайте для параметра исходный сервер значение режим чтения/записи.

   После создания дампа базы данных измените исходный сервер MySQL обратно на режим чтения и записи.

   ```sql
   SET GLOBAL read_only = OFF;
   UNLOCK TABLES;
   ```

3. Восстановление файла дампа на новый сервер.

   Восстановите файл дампа на сервере, созданном в Базе данных Azure для MySQL. Чтобы узнать, как восстановить файл дампа на сервере MySQL, см. статью о [дампе и восстановлении](concepts-migrate-dump-restore.md). Если файл дампа имеет большой размер, отправьте его на виртуальную машину в Azure в том же регионе, где располагается сервер-реплика. Восстановите его на сервере Базы данных Azure для MySQL с виртуальной машины.

## <a name="link-source-and-replica-servers-to-start-data-in-replication"></a>Связывание исходного и сервера реплики для запуска Репликация входных данных

1. Задайте исходный сервер.

   Все функции репликации входных данных выполняются хранимыми процедурами. Все процедуры можно найти в статье о [хранимых процедурах репликации входных данных](./reference-stored-procedures.md). Хранимые процедуры можно выполнять в оболочке MySQL или MySQL Workbench.

   Чтобы связать два сервера и запустить репликацию, войдите на целевой сервер реплики в службе базы данных Azure для MySQL и установите внешний экземпляр в качестве исходного сервера. Это делается с помощью хранимой процедуры `mysql.az_replication_change_master` на сервере Базы данных Azure для MySQL.

   ```sql
   CALL mysql.az_replication_change_master('<master_host>', '<master_user>', '<master_password>', 3306, '<master_log_file>', <master_log_pos>, '<master_ssl_ca>');
   ```

   - master_host: имя узла исходного сервера
   - master_user: имя пользователя исходного сервера
   - master_password: пароль для исходного сервера
   - master_log_file: имя файла двоичного журнала из выполняемой команды `show master status`.
   - master_log_pos: позиция в двоичном журнале из выполняемой команды `show master status`.
   - master_ssl_ca: контекст сертификата ЦС. Если протокол SSL не используется, передайте пустую строку.

     Рекомендуется передавать этот параметр в виде переменной. Дополнительные сведения см. в следующих примерах.

   > [!NOTE]
   > Если исходный сервер размещен на виртуальной машине Azure, установите для параметра "разрешить доступ к службам Azure" значение "вкл.", чтобы разрешить серверу-источникам и репликам взаимодействовать друг с другом. Этот параметр можно изменить в параметрах **Безопасность подключения**. Дополнительные сведения см. [в статье Управление правилами брандмауэра с помощью портала](howto-manage-firewall-using-portal.md) .

   **Примеры**

   *Репликация с использованием SSL*

   Переменная `@cert` создается путем выполнения следующих команд MySQL:

      ```sql
      SET @cert = '-----BEGIN CERTIFICATE-----
      PLACE YOUR PUBLIC KEY CERTIFICATE'`S CONTEXT HERE
      -----END CERTIFICATE-----'
      ```

   Репликация с SSL настраивается между исходным сервером, размещенным в домене "companya.com", и сервером реплики, размещенным в базе данных Azure для MySQL. Эта хранимая процедура выполняется на реплике.

      ```sql
      CALL mysql.az_replication_change_master('master.companya.com', 'syncuser', 'P@ssword!', 3306, 'mysql-bin.000002', 120, @cert);
      ```

   *Репликация без SSL*

   Репликация без SSL настраивается между исходным сервером, размещенным в домене "companya.com", и сервером реплики, размещенным в базе данных Azure для MySQL. Эта хранимая процедура выполняется на реплике.

      ```sql
      CALL mysql.az_replication_change_master('master.companya.com', 'syncuser', 'P@ssword!', 3306, 'mysql-bin.000002', 120, '');
      ```

2. Записей.

   Если вы хотите пропустить репликацию некоторых таблиц из главной таблицы, обновите `replicate_wild_ignore_table` параметр сервера на сервере реплики. Можно указать несколько шаблонов таблиц, используя список с разделителями-запятыми.

   Чтобы узнать больше об этом параметре, ознакомьтесь с документацией по [MySQL](https://dev.mysql.com/doc/refman/8.0/en/replication-options-replica.html#option_mysqld_replicate-wild-ignore-table).

   Чтобы обновить параметр, можно использовать [портал Azure](howto-server-parameters.md) или [Azure CLI](howto-configure-server-parameters-using-cli.md).

3. Запустите репликацию.

   Вызовите `mysql.az_replication_start` хранимую процедуру, чтобы запустить репликацию.

   ```sql
   CALL mysql.az_replication_start;
   ```

4. Проверьте состояние репликации.

   Вызовите [`show slave status`](https://dev.mysql.com/doc/refman/5.7/en/show-slave-status.html) команду на сервере реплики, чтобы просмотреть состояние репликации.

   ```sql
   show slave status;
   ```

   Если для параметра и задано `Slave_IO_Running` `Slave_SQL_Running` значение "Yes", а для параметра `Seconds_Behind_Master` равно "0", репликация работает правильно. `Seconds_Behind_Master` указывает величину задержки на реплике. Если значение не равно "0", это означает, что реплика обрабатывает обновления.

## <a name="other-stored-procedures"></a>Другие хранимые процедуры

### <a name="stop-replication"></a>Остановка репликации

Чтобы отключить репликацию между сервером источника и реплики, используйте следующую хранимую процедуру:

```sql
CALL mysql.az_replication_stop;
```

### <a name="remove-replication-relationship"></a>Удаление связи репликации

Чтобы удалить связь между сервером источника и реплики, используйте следующую хранимую процедуру:

```sql
CALL mysql.az_replication_remove_master;
```

### <a name="skip-replication-error"></a>Пропуск ошибки репликации

Чтобы пропустить ошибку репликации и разрешить продолжение репликации, используйте следующую хранимую процедуру:

```sql
CALL mysql.az_replication_skip_counter;
```

## <a name="next-steps"></a>Дальнейшие действия

- См. дополнительные сведения о [репликации входных данных](concepts-data-in-replication.md) в Базе данных Azure для MySQL.
