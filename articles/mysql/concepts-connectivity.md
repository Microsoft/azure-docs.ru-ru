---
title: Временные ошибки подключения — база данных Azure для MySQL
description: Узнайте, как управлять временными ошибками подключения и эффективно подключаться к базе данных Azure для MySQL.
keywords: подключение к MySQL, строка подключения, проблемы с подключением, временная ошибка, ошибка подключения, эффективная связь
author: savjani
ms.author: pariks
ms.service: mysql
ms.topic: conceptual
ms.date: 3/18/2020
ms.openlocfilehash: 89673c14c38947dc5aeb91cacde1eb2755e84138
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "94542615"
---
# <a name="handle-transient-errors-and-connect-efficiently-to-azure-database-for-mysql"></a>Обрабатывайте временные ошибки и эффективно Подключайтесь к базе данных Azure для MySQL

В этой статье описывается, как управлять временными ошибками и эффективно подключаться к базе данных Azure для MySQL.

## <a name="transient-errors"></a>Временные ошибки

Временная ошибка, также известная как временный сбой, является ошибкой, которая устраняется автоматически. Чаще всего эти ошибки проявляются в виде сброса соединения с сервером базы данных. При этом невозможно установить новые подключения к серверу. Временные ошибки могут возникать, например, при сбое оборудования или сети. Другая причина может быть новой версией службы PaaS, для которой выполняется развертывание. Большинство этих событий автоматически устраняются системой менее чем за 60 секунд. При проектировании и разработке приложений в облаке рекомендуется учитывать возможность временных ошибок. Нужно учитывать, что они могут произойти в любом компоненте в любое время, и предусмотреть соответствующую логику для таких ситуаций.

## <a name="handling-transient-errors"></a>Обработка временных ошибок

Временные ошибки следует обрабатывать с использованием логики повторных подключений. Нужно учитывать следующие ситуации.

* При попытке открыть соединение возникает ошибка.
* Неактивное подключение сбрасывается на стороне сервера. Попытка выполнить команду завершается сбоем.
* Активное подключение, по которому в настоящее время выполняется команда, сбрасывается.

Ошибки первого и второго типа достаточно просто устранить. Попробуйте открыть подключение еще раз. Когда вам это удастся, система устранит временную ошибку. Базу данных Azure для MySQL можно использовать снова. Мы рекомендуем подождать перед повторной попыткой подключения. Отключитесь, если исходные повторные попытки не дают результата. Таким образом, система может использовать все доступные ресурсы для устранения ошибки. Ниже приведен шаблон для выполнения.

* Подождите 5 секунд перед первой повторной попыткой.
* Для каждой следующей попытки увеличивайте время ожидания экспоненциально до 60 секунд.
* Задайте максимальное число повторных попыток, после чего приложение подтвердит сбой операции.

Когда происходит сбой подключения с активной транзакцией, управлять процессом восстановления становится сложнее. Существует два варианта: если транзакция была доступна только для чтения, вы можете безопасно повторно открыть подключение и повторить транзакцию. Если транзакция также была записана в базу данных, необходимо определить, был ли выполнен откат транзакции, или если она была выполнена до возникновения временной ошибки. В этом случае вы, возможно, не получили подтверждение фиксации от сервера базы данных.

Один из способов сделать это — создать уникальный идентификатор на клиенте, который используется для всех повторных попыток. Вы передаете этот уникальный идентификатор как часть транзакции на сервер и сохраняете его в столбце с уникальным ограничением. Таким образом можно безопасно повторить транзакцию. Он будет выполнен успешно, если была выполнена откат предыдущей транзакции, а созданный клиентом уникальный идентификатор еще не существует в системе. Произойдет сбой с оповещением о дубликате ключа, если уникальный идентификатор был сохранен ранее в результате успешной транзакции.

Если программа взаимодействует с Базой данных Azure для MySQL через стороннее программное обеспечение промежуточного слоя, спросите поставщика, предусмотрена ли в этом программном обеспечении логика повторных попыток в случае временных ошибок.

Не забудьте проверить логику повторных попыток. Например, попробуйте выполнить код, увеличив или выполняя масштабирование ресурсов для сервера базы данных Azure для MySQL. Ваше приложение должно без каких-либо проблем справиться с небольшим простоем во время этой операции.

## <a name="connect-efficiently-to-azure-database-for-mysql"></a>Эффективное подключение к базе данных Azure для MySQL

Подключения к базе данных — это ограниченный ресурс, поэтому эффективное использование пулов соединений для доступа к базе данных Azure для MySQL оптимизирует производительность. В следующем разделе объясняется, как использовать пулы подключений или постоянные подключения для более эффективного доступа к базе данных Azure для MySQL.

## <a name="access-databases-by-using-connection-pooling-recommended"></a>Доступ к базам данных с помощью пула подключений (рекомендуется)

Управление подключениями к базе данных может оказать значительное влияние на производительность приложения в целом. Чтобы оптимизировать производительность приложения, необходимо уменьшить число установленных соединений и время установления соединений в путях кода ключей. Мы настоятельно рекомендуем использовать пулы подключений к базам данных или постоянные подключения для подключения к базе данных Azure для MySQL. Пул подключений к базе данных управляет созданием, управлением и выделением подключений к базам данных. Когда программа запрашивает подключение к базе данных, она определяет приоритет выделения существующих бездействующих подключений к базе данных, а не создание нового соединения. После того как программа завершит использование подключения к базе данных, подключение будет восстановлено в процессе подготовки к дальнейшему использованию, а не просто закрыться.

Для лучшего примера в этой статье представлен [фрагмент кода](./sample-scripts-java-connection-pooling.md) , в котором используется Java. Дополнительные сведения см. в разделе [Apache Common ДБКП](https://commons.apache.org/proper/commons-dbcp/).

> [!NOTE]
> Сервер настраивает механизм времени ожидания, чтобы закрыть подключение, которое было в состоянии простоя, в течение некоторого времени, чтобы освободить ресурсы. Обязательно настройте систему проверки, чтобы обеспечить эффективность постоянных подключений при их использовании. Дополнительные сведения см. в разделе [Настройка систем проверки на стороне клиента для обеспечения эффективности постоянных подключений](concepts-connectivity.md#configure-verification-mechanisms-in-clients-to-confirm-the-effectiveness-of-persistent-connections).

## <a name="access-databases-by-using-persistent-connections-recommended"></a>Доступ к базам данных с помощью постоянных подключений (рекомендуется)

Концепция постоянных подключений аналогична принципу объединения соединений. Замена коротких соединений на постоянные подключения требует лишь незначительных изменений в коде, но оказывает значительное влияние на повышение производительности во многих типичных сценариях приложений.

## <a name="access-databases-by-using-wait-and-retry-mechanism-with-short-connections"></a>Доступ к базам данных с помощью механизма Wait и Retry с короткими подключениями

При наличии ограничений ресурсов настоятельно рекомендуется использовать пулы баз данных или постоянные подключения к базам данных. Если в приложении используются короткие подключения и возникают сбои подключения, если достигнут верхний предел числа одновременных подключений, можно попробовать использовать механизм ожидания и повторные попытки. Вы можете задать соответствующее время ожидания с более коротким временем ожидания после первой попытки. После этого можно попытаться подождать события несколько раз.

## <a name="configure-verification-mechanisms-in-clients-to-confirm-the-effectiveness-of-persistent-connections"></a>Настройка механизмов проверки в клиентах для подтверждения эффективности постоянных подключений

Сервер настраивает механизм времени ожидания, чтобы закрыть подключение, которое находится в состоянии простоя, в течение некоторого времени, чтобы освободить ресурсы. Когда клиент снова получает доступ к базе данных, он эквивалентен созданию нового запроса соединения между клиентом и сервером. Чтобы обеспечить эффективность подключений в процессе их использования, настройте механизм проверки на клиенте. Как показано в следующем примере, для настройки этого механизма проверки можно использовать пулы подключений Tomcat JDBC.

Если задать параметр Тестонборров, то при наличии нового запроса пул соединений автоматически проверяет эффективность всех доступных простаивающих подключений. Если такое соединение вступает в силу, его непосредственно возвращается, иначе пул соединений снимает соединение. Затем пул соединений создает новое действующее подключение и возвращает его. Этот процесс обеспечивает эффективное обращение к базе данных. 

Сведения о конкретных параметрах см. в [официальном документе Введение пула подключений JDBC](https://tomcat.apache.org/tomcat-7.0-doc/jdbc-pool.html#Common_Attributes). В основном необходимо задать следующие три параметра: Тестонборров (значение true), Валидатионкуери (установите для SELECT 1) и Валидатионкуеритимеаут (значение 1). Ниже приведен конкретный пример кода.

```java
public class SimpleTestOnBorrowExample {
      public static void main(String[] args) throws Exception {
          PoolProperties p = new PoolProperties();
          p.setUrl("jdbc:mysql://localhost:3306/mysql");
          p.setDriverClassName("com.mysql.jdbc.Driver");
          p.setUsername("root");
          p.setPassword("password");
            // The indication of whether objects will be validated by the idle object evictor (if any). 
            // If an object fails to validate, it will be dropped from the pool. 
            // NOTE - for a true value to have any effect, the validationQuery or validatorClassName parameter must be set to a non-null string. 
          p.setTestOnBorrow(true); 

            // The SQL query that will be used to validate connections from this pool before returning them to the caller.
            // If specified, this query does not have to return any data, it just can't throw a SQLException.
          p.setValidationQuery("SELECT 1");

            // The timeout in seconds before a connection validation queries fail. 
            // This works by calling java.sql.Statement.setQueryTimeout(seconds) on the statement that executes the validationQuery. 
            // The pool itself doesn't timeout the query, it is still up to the JDBC driver to enforce query timeouts. 
            // A value less than or equal to zero will disable this feature.
          p.setValidationQueryTimeout(1);
            // set other useful pool properties.
          DataSource datasource = new DataSource();
          datasource.setPoolProperties(p);

          Connection con = null;
          try {
            con = datasource.getConnection();
            // execute your query here
          } finally {
            if (con!=null) try {con.close();}catch (Exception ignore) {}
          }
      }
  }
```

## <a name="next-steps"></a>Дальнейшие действия

* [Узнайте, как устранить проблемы с подключением к Базе данных Azure для MySQL](howto-troubleshoot-common-connection-issues.md)
