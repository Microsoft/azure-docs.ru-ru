---
title: Чтение реплик в базе данных Azure для MySQL
description: 'Сведения о репликах чтения в Базе данных Azure для MySQL: выбор регионов, создание реплик, подключение к репликам, мониторинг репликации и остановка репликации.'
author: savjani
ms.author: pariks
ms.service: mysql
ms.topic: conceptual
ms.date: 01/13/2021
ms.custom: references_regions
ms.openlocfilehash: c380a3edb556adb72d067cb2910c8afbf66b99a0
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "98250270"
---
# <a name="read-replicas-in-azure-database-for-mysql"></a>Реплики чтения в базе данных Azure для MySQL

Компонент "Реплика чтения" позволяет реплицировать данные с сервера службы "База данных Azure для MySQL" на сервер только для чтения. Вы можете реплицировать данные с исходного сервера на несколько реплик (до пяти). Реплики чтения асинхронно обновляются с помощью технологии репликации на основе позиции файла собственного двоичного журнала (binlog) ядра MySQL. Дополнительные сведения о репликации binlog MySQL см. в [этой статье](https://dev.mysql.com/doc/refman/5.7/en/binlog-replication-configuration-overview.html).

Реплики — это новые серверы, которыми вы управляете как обычными серверами службы "База данных Azure для MySQL". За каждую реплику чтения выставляется счет с учетом подготовленных вычислительных ресурсов (количество виртуальных ядер) и хранилища (ГБ/месяц).

Дополнительные сведения о функциях и проблемах репликации MySQL см. в [документации по репликации MySQL](https://dev.mysql.com/doc/refman/5.7/en/replication-features.html).

> [!NOTE]
> Эта статья содержит ссылки на термин « _Ведомый_» термин, который корпорация Майкрософт больше не использует. Когда этот термин будет удален из программного обеспечения, мы удалим его из статьи.
>

## <a name="when-to-use-a-read-replica"></a>Использование реплик чтения

Компонент "Реплика чтения" помогает повысить производительность и масштабируемость рабочих нагрузок с высокой интенсивностью чтения. Рабочие нагрузки чтения могут быть изолированы от реплик, тогда как рабочие нагрузки записи могут направляться в источник.

К типичным сценариям относится ситуация, когда рабочие нагрузки бизнес-аналитики и анализа используют реплику чтения в качестве источника данных для отчетов.

Так как реплики доступны только для чтения, они не снижают нагрузку на ресурсы напрямую. Этот компонент не предназначен для рабочих нагрузок с интенсивной записью.

В реплике чтения используется асинхронная репликация MySQL. Этот компонент также не предназначен для сценариев синхронной репликации. Между источником и репликой возникает измеряемая задержка. Данные в реплике в конечном итоге согласовываются с данными в источнике. Используйте этот компонент только для таких рабочих нагрузок, которым не страшна такая задержка.

## <a name="cross-region-replication"></a>Репликация между регионами

Вы можете создать реплику чтения в другом регионе на исходном сервере. Репликация между регионами полезна для таких сценариев, как планирование аварийного восстановления или перенос данных ближе к пользователям.

У вас может быть исходный сервер в любой [области базы данных Azure для MySQL](https://azure.microsoft.com/global-infrastructure/services/?products=mysql).  Исходный сервер может иметь реплику в связанном регионе или в регионах универсальной реплики. На следующем рисунке показано, какие регионы реплик доступны в зависимости от исходного региона.

[:::image type="content" source="media/concepts-read-replica/read-replica-regions.png" alt-text="Чтение регионов реплики":::](media/concepts-read-replica/read-replica-regions.png#lightbox)

### <a name="universal-replica-regions"></a>Универсальные регионы реплики

Реплику чтения можно создать в любом из следующих регионов, независимо от расположения исходного сервера. Поддерживаются следующие универсальные регионы реплики:

Восточная Австралия, Юго-Восточная Австралия, Южная Бразилия, Центральная Канада, Восточная Канада, Центральная часть США, наВосточная Азия, восток США, Восточная часть US 2, Юго-Восточная Япония, Западная Япония, Центральная Корея, Южная Европа, Юго-Центральный западная часть Соединенного Королевства южная часть Соединенного Королевства регион США, северо-центральная часть США, Юго-Запад США, "Западная часть США"

### <a name="paired-regions"></a>Пары регионов

В дополнение к регионам универсальной реплики можно создать реплику чтения в парном регионе Azure исходного сервера. Если вы не знаете, какой регион является парным, изучите [эту статью](../best-practices-availability-paired-regions.md).

Если вы используете реплики между регионами для планирования аварийного восстановления, рекомендуется создать реплику в парном регионе, а не в одном из других регионов. Для парных регионов не допускаются одновременные обновления, отслеживаются приоритеты по физической изоляции и месту расположения данных.  

Но есть и некоторые ограничения: 

* Доступность по регионам. база данных Azure для MySQL доступна в центральном центре Франции, Северной и Германии. Однако их парные регионы недоступны.

* Однонаправленные пары. Некоторые регионы Azure считаются парными только в одном направлении. К ним относятся: "Западная Индия", "Южная Бразилия" и US Gov (Вирджиния).
   Это означает, что исходный сервер в Западной Индии может создать реплику в Южной Индии. Однако исходный сервер в Южной Индии не может создать реплику в Западной Индии. Это связано с тем, что вторичный регион Западной Индии — Южно-Индия, но дополнительный регион Южной Индии — не Западная Индия.

## <a name="create-a-replica"></a>Создание реплики

> [!IMPORTANT]
> Функция создания реплики чтения доступна только для серверов базы данных Azure для MySQL в ценовой категории "Общее назначение" или "Оптимизированная для операций в памяти". Убедитесь, что исходный сервер находится в одной из этих ценовых категорий.

Если на исходном сервере нет серверов реплики, источник сначала перезапускается для подготовки к репликации.

При запуске рабочего процесса создания реплики создается пустой сервер службы "База данных Azure для MySQL". Новый сервер заполняется данными, которые были на исходном сервере. Время создания зависит от объема данных в источнике и времени, прошедших с момента создания последней еженедельной полной архивации. Время может варьироваться от нескольких минут до нескольких часов. Сервер реплики всегда создается в той же группе ресурсов и в той же подписке, что и исходный сервер. Если вы хотите создать сервер реплики в другой группе ресурсов или другой подписке, можно [переместить сервер реплики](../azure-resource-manager/management/move-resource-group-and-subscription.md) после его создания.

Для каждой реплики включается [автоматическое увеличение](concepts-pricing-tiers.md#storage-auto-grow) хранилища. Возможность автоматического увеличения позволяет реплике без сбоев обрабатывать реплицируемые данные и не прерывать репликацию даже в тех случаях, когда не хватает объема хранилища.

Дополнительные сведения о создании реплики чтения на портале Azure см. [здесь](howto-read-replicas-portal.md).

## <a name="connect-to-a-replica"></a>Подключение к реплике

При создании реплика наследует правила брандмауэра исходного сервера. Затем эти правила независимы от исходного сервера.

Реплика наследует учетную запись администратора от исходного сервера. Все учетные записи пользователей на исходном сервере реплицируются на реплики чтения. Подключиться к реплике чтения можно только с помощью учетных записей пользователей, доступных на исходном сервере.

Вы можете подключиться к реплике, используя имя узла и действительную учетную запись, как к обычному серверу службы "База данных Azure для MySQL". Например, для сервера с именем **myreplica** и именем пользователя с правами администратора **myadmin** подключение будет выполняться с помощью CLI mysql:

```bash
mysql -h myreplica.mysql.database.azure.com -u myadmin@myreplica -p
```

При появлении запроса введите пароль для учетной записи пользователя.

## <a name="monitor-replication"></a>Мониторинг репликации

Служба "База данных Azure для MySQL" также предоставляет для Azure Monitor метрику **Replication lag in seconds** (Задержка репликации в секундах). Эта метрика доступна только для реплик. Эта метрика вычисляется на основе метрики `seconds_behind_master`, которую можно получить с помощью команды MySQL `SHOW SLAVE STATUS`. Настройте оповещение, чтобы сообщить вам, когда задержка репликации достигнет значения, неприемлемого для вашей рабочей нагрузки.

Если вы видите увеличенную задержку репликации, см. статью [Устранение неполадок репликации](howto-troubleshoot-replication-latency.md) для устранения неполадок и выявления возможных причин.

## <a name="stop-replication"></a>Остановка репликации

Можно отключить репликацию между источником и репликой. После остановки репликации между исходным сервером и репликой чтения реплика становится автономным сервером. На отдельном сервере сохраняются все данные, которые существовали на нем на момент запуска команды "Остановить репликацию". Изолированный сервер не перехватывается с исходным сервером.

Если вы решили отключить репликацию в реплике, она теряет все ссылки на предыдущие исходные и другие реплики. Автоматическая отработка отказа между источником и его репликой отсутствует.

> [!IMPORTANT]
> Это сервер нельзя снова преобразовать в реплику.
> Прежде, чем останавливать репликацию в реплике чтения убедитесь, что реплика содержит все необходимые данные.

Процесс остановки репликации описан в [этой статье](howto-read-replicas-portal.md).

## <a name="failover"></a>Отработка отказа

Автоматическая отработка отказа между серверами источника и реплики отсутствует.

Так как репликация является асинхронной, между источником и репликой возникает задержка. На задержку может влиять множество факторов, таких как интенсивность выполнения рабочей нагрузки на исходном сервере и задержка между центрами обработки данных. В большинстве случаев задержка реплики составляет от нескольких секунд до пары минут. Вы можете отвести фактическую задержку репликации с помощью *задержки реплики* метрики, доступной для каждой реплики. Эта метрика показывает время, прошедшее с момента последнего воспроизведения транзакции. Рекомендуется определить среднюю задержку, просматривая запаздывание реплики в течение определенного периода времени. Вы можете настроить оповещение о задержке реплики, чтобы, если она выходит за пределы ожидаемого диапазона, можно предпринять действия.

> [!Tip]
> Если выполняется отработка отказа в реплике, задержка во время десвязи реплики с источником будет указывать на количество потерянных данных.

После того как вы решили выполнить отработку отказа в реплику, выполните следующие действия.

1. Останавливает репликацию в реплику<br/>
   Этот шаг необходим для того, чтобы сервер реплики мог принимать операции записи. В рамках этого процесса сервер реплики будет десвязываться с источником. После запуска процесса «останавливает репликацию» серверный процесс обычно занимает около 2 минут. Сведения о влиянии этого действия см. в разделе " [Завершение репликации](#stop-replication) " этой статьи.

2. Наведите приложение на реплику (бывшая)<br/>
   Каждый сервер имеет уникальную строку подключения. Обновите приложение так, чтобы оно указывало на (бывшая) реплику, а не на источник.

После успешной обработки операций чтения и записи в приложении вы завершили отработку отказа. Время простоя, которое будет зависеть от работы приложения, зависело при обнаружении проблемы и выполнении шагов 1 и 2, перечисленных выше.

## <a name="global-transaction-identifier-gtid"></a>Идентификатор глобальной транзакции (ГТИД)

Глобальный идентификатор транзакции (ГТИД) — это уникальный идентификатор, созданный с каждой зафиксированной транзакцией на исходном сервере и ОТКЛЮЧЕНный по умолчанию в базе данных Azure для MySQL. ГТИД поддерживается в версиях 5,7 и 8,0 и только на серверах, поддерживающих хранилище объемом до 16 ТБ. Дополнительные сведения о ГТИД и его использовании в репликации см. в статье [репликация MySQL с](https://dev.mysql.com/doc/refman/5.7/en/replication-gtids.html) документацией по гтид.

MySQL поддерживает два типа транзакций: ГТИД транзакции (идентифицированные с помощью ГТИД) и анонимные транзакции (не назначено ГТИД)

Для настройки ГТИД доступны следующие параметры сервера: 

|**Параметр сервера**|**Описание**|**Значение по умолчанию**|**Значения**|
|--|--|--|--|
|`gtid_mode`|Указывает, используются ли Гтидс для обнаружения транзакций. Изменения между режимами можно выполнять только один шаг в возрастающем порядке (например, `OFF` -> `OFF_PERMISSIVE` -> `ON_PERMISSIVE` -> `ON`)|`OFF`|`OFF`: Новые и транзакции репликации должны быть анонимными <br> `OFF_PERMISSIVE`: Новые транзакции являются анонимными. Реплицированные транзакции могут быть либо анонимными, либо ГТИД транзакциями. <br> `ON_PERMISSIVE`: Новые транзакции являются ГТИД транзакциями. Реплицированные транзакции могут быть либо анонимными, либо ГТИД транзакциями. <br> `ON`: Новые и реплицированные транзакции должны быть ГТИД транзакциями.|
|`enforce_gtid_consistency`|Обеспечивает согласованность ГТИД, разрешая выполнение только тех инструкций, которые могут быть зарегистрированы в транзакционно безопасном порядке. Перед включением репликации ГТИД это значение должно быть установлено в `ON` . |`OFF`|`OFF`: Всем транзакциям разрешено нарушать согласованность ГТИД.  <br> `ON`: Ни одна транзакция не может нарушать согласованность ГТИД. <br> `WARN`: Всем транзакциям разрешено нарушать согласованность ГТИД, но создается предупреждение. | 

> [!NOTE]
> После включения ГТИД его нельзя отключить. Если вам нужно отключить ГТИД, обратитесь в службу поддержки. 

Чтобы включить ГТИД и настроить поведение согласованности, обновите `gtid_mode` `enforce_gtid_consistency` Параметры сервера и с помощью [портал Azure](howto-server-parameters.md), [Azure CLI](howto-configure-server-parameters-using-cli.md)или [PowerShell](howto-configure-server-parameters-using-powershell.md).

Если ГТИД включен на исходном сервере ( `gtid_mode` = On), только что созданные реплики также будут ВКЛЮЧАТЬ гтид и использовать репликацию гтид. Для синхронизации репликации невозможно выполнить обновление `gtid_mode` на исходном или сервере-реплике.

## <a name="considerations-and-limitations"></a>Рекомендации и ограничения

### <a name="pricing-tiers"></a>Ценовые категории

Реплики чтения сейчас доступны только в ценовых категориях "Общее назначение" и "Оптимизировано для памяти".

> [!NOTE]
> Стоимость работы сервера реплики зависит от региона, в котором работает сервер реплики.

### <a name="source-server-restart"></a>Исходный сервер перезапуска

При создании реплики для источника, не имеющего существующих реплик, источник сначала перезапускается для подготовки к репликации. Это необходимо учесть, то есть выполнять такие операции в период низкой нагрузки.

### <a name="new-replicas"></a>Новые реплики

Реплики чтения создаются как новые серверы службы "База данных Azure для MySQL". Существующий сервер нельзя снова преобразовать в реплику. Невозможно создать реплику другой реплики чтения.

### <a name="replica-configuration"></a>Конфигурация реплики

Реплика создается с использованием той же конфигурации сервера, что и источник. После создания реплики некоторые параметры могут быть изменены независимо от исходного сервера: поколение вычислений, виртуальных ядер, хранилище и срок хранения резервных копий. Изменить также можно ценовую категорию (за исключением уровня "Базовый").

> [!IMPORTANT]
> Прежде чем изменить параметры конфигурации на исходном сервере, установите на каждой реплике такие же или более высокие значения. Это позволит реплике справляться с нагрузкой, соответствующей новым параметрам исходного сервера.

Правила брандмауэра и параметры параметров наследуются от исходного сервера реплике при создании реплики. После этого правила реплики будут независимыми.

### <a name="stopped-replicas"></a>Остановленные реплики

Если остановить репликацию между исходным сервером и репликой чтения, то остановленная реплика станет автономным сервером, принимающим операции чтения и записи. Это сервер нельзя снова преобразовать в реплику.

### <a name="deleted-source-and-standalone-servers"></a>Удаленные исходные и автономные серверы

При удалении исходного сервера репликация будет остановлена для всех реплик чтения. Реплики чтения автоматически становятся автономными серверами и могут выполнять операции чтения и записи. Сам исходный сервер удаляется.

### <a name="user-accounts"></a>Учетные записи пользователей

Пользователи на исходном сервере реплицируются на реплики чтения. Подключиться к реплике чтения можно только с помощью учетных записей пользователей, доступных на исходном сервере.

### <a name="server-parameters"></a>Параметры сервера

Чтобы предотвратить синхронизацию данных и избежать их возможной потери, при использовании реплики чтения некоторые параметры сервера блокируются.

Следующие параметры сервера заблокированы на серверах источника и реплики:

* [`innodb_file_per_table`](https://dev.mysql.com/doc/refman/8.0/en/innodb-file-per-table-tablespaces.html) 
* [`log_bin_trust_function_creators`](https://dev.mysql.com/doc/refman/5.7/en/replication-options-binary-log.html#sysvar_log_bin_trust_function_creators)

Параметр [`event_scheduler`](https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_event_scheduler) заблокирован на серверах реплик.

Чтобы обновить один из указанных выше параметров на исходном сервере, удалите серверы реплик, обновите значение параметра в источнике и повторно создайте реплики.

### <a name="gtid"></a>гтид

ГТИД поддерживается в:

* MySQL версии 5,7 и 8,0.
* Серверы, поддерживающие хранилище объемом до 16 ТБ. Полный список регионов, поддерживающих хранилище объемом 16 ТБ, см. в статье [ценовая](concepts-pricing-tiers.md#storage) Категория.

По умолчанию ГТИД отключен. После включения ГТИД его нельзя отключить. Если вам нужно отключить ГТИД, обратитесь в службу поддержки.

Если ГТИД включен на исходном сервере, то вновь созданные реплики также будут включать ГТИД и использовать репликацию ГТИД. Для синхронизации репликации невозможно выполнить обновление `gtid_mode` на исходном или сервере-реплике.

### <a name="other"></a>Другое

* Создание реплики реплики не поддерживается.
* Таблицы в памяти могут вызывать рассинхронизацию реплик. Это ограничение технологии репликации MySQL. Дополнительные сведения см. в [справочной документации по MySQL](https://dev.mysql.com/doc/refman/5.7/en/replication-features-memory.html).
* Убедитесь, что таблицы исходного сервера имеют первичные ключи. Отсутствие первичных ключей может привести к задержке репликации между источником и репликами.
* Полный список ограничений репликации MySQL см. в [документации по MySQL](https://dev.mysql.com/doc/refman/5.7/en/replication-features.html).

## <a name="next-steps"></a>Дальнейшие действия

* Узнайте, как [создавать реплики чтения и управлять ими с помощью портала Azure](howto-read-replicas-portal.md).
* Узнайте, как [создавать реплики чтения и управлять ими с помощью Azure CLI и REST API](howto-read-replicas-cli.md).