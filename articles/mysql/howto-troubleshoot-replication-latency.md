---
title: Устранение задержки репликации — база данных Azure для MySQL
description: Узнайте, как устранить задержку репликации с помощью базы данных Azure для считывания реплики MySQL.
keywords: MySQL, устранение неполадок, задержка репликации в секундах
author: savjani
ms.author: pariks
ms.service: mysql
ms.topic: troubleshooting
ms.date: 01/13/2021
ms.openlocfilehash: 92513a8c24b5106e3a59c8cfa4d743e900b957bf
ms.sourcegitcommit: 25d1d5eb0329c14367621924e1da19af0a99acf1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/16/2021
ms.locfileid: "98249777"
---
# <a name="troubleshoot-replication-latency-in-azure-database-for-mysql"></a>Устранение задержки репликации в Базе данных Azure для MySQL

[!INCLUDE[applies-to-single-flexible-server](./includes/applies-to-single-flexible-server.md)]

Функция [чтения реплики](concepts-read-replicas.md) позволяет реплицировать данные с сервера базы данных Azure для MySQL на сервер реплики только для чтения. Можно масштабировать рабочие нагрузки, переправляя запросы на чтение и отчетность из приложения на серверы реплики. Эта установка снижает нагрузку на исходный сервер. Он также повышает общую производительность и задержку приложения по мере его масштабирования.

Реплики обновляются асинхронно с помощью технологии репликации на основе расположения файлов двоичного журнала ядра MySQL (бинлог). Дополнительные сведения см. в статье [о конфигурации репликации на основе расположения файлов MySQL бинлог](https://dev.mysql.com/doc/refman/5.7/en/binlog-replication-configuration-overview.html).

Запаздывание репликации на вторичных репликах чтения зависит от нескольких факторов. К таким факторам относятся:

- Задержка в сети.
- Объем транзакций на исходном сервере.
- Уровень вычислений исходного сервера и сервера вторичной реплики чтения.
- Запросы, выполняющиеся на исходном и сервере-получателе.

В этой статье вы узнаете, как устранить задержку репликации в базе данных Azure для MySQL. Вы также узнаете о некоторых распространенных причинах повышения задержки репликации на серверах реплик.

> [!NOTE]
> Эта статья содержит ссылки на термин « _Ведомый_» термин, который корпорация Майкрософт больше не использует. Когда этот термин будет удален из программного обеспечения, мы удалим его из статьи.
>

## <a name="replication-concepts"></a>Основные понятия репликации

Если двоичный журнал включен, сервер-источник записывает зафиксированные транзакции в двоичный журнал. Для репликации используется двоичный журнал. Он включен по умолчанию для всех новых подготовленных серверов, поддерживающих хранилище объемом до 16 ТБ. На серверах реплики два потока выполняются на каждом сервере реплики. Один поток — это *поток операций ввода-вывода*, а другой — *поток SQL*:

- Поток ввода-вывода подключается к исходному серверу и запрашивает обновленные двоичные журналы. Этот поток получает обновления двоичного журнала. Эти обновления сохраняются на сервере-реплике в локальном журнале, который называется *журналом ретрансляции*.
- Поток SQL считывает журнал ретрансляции, а затем применяет изменения данных на серверах реплик.

## <a name="monitoring-replication-latency"></a>Мониторинг задержки репликации

База данных Azure для MySQL предоставляет метрику задержки репликации в секундах в [Azure Monitor](concepts-monitoring.md). Эта метрика доступна только на серверах реплики чтения. Он вычисляется по метрике seconds_behind_master, доступной в MySQL. 

Чтобы понять причину повышенной задержки репликации, подключитесь к серверу реплики с помощью [MySQL Workbench](connect-workbench.md) или [Azure Cloud Shell](https://shell.azure.com). Затем выполните следующую команду.

>[!NOTE]
> В коде замените значения в примерах на имя сервера реплики и имя пользователя администратора. Имя администратора требуется `@\<servername>` для базы данных Azure для MySQL.

```azurecli-interactive
mysql --host=myreplicademoserver.mysql.database.azure.com --user=myadmin@mydemoserver -p 
```

Ниже показано, как выглядит этот процесс в терминале Cloud Shell.

```
Requesting a Cloud Shell.Succeeded.
Connecting terminal...

Welcome to Azure Cloud Shell

Type "az" to use Azure CLI
Type "help" to learn about Cloud Shell

user@Azure:~$mysql -h myreplicademoserver.mysql.database.azure.com -u myadmin@mydemoserver -p
Enter password:
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 64796
Server version: 5.6.42.0 Source distribution

Copyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.
mysql>
```

В том же терминале Cloud Shell выполните следующую команду:

```
mysql> SHOW SLAVE STATUS;
```

Ниже приведен типичный результат.
  
>[!div class="mx-imgBorder"]
> :::image type="content" source="./media/howto-troubleshoot-replication-latency/show-status.png" alt-text="Мониторинг задержки репликации":::

Выходные данные содержат много информации. Как правило, необходимо сосредоточиться только на строках, описанных в следующей таблице.

|Метрика|Описание|
|---|---|
|Slave_IO_State| Представляет текущее состояние потока ввода-вывода. Как правило, состояние "Ожидание отправки события главной роли" при синхронизации исходного сервера (Master). Состояние, например "подключение к главному серверу", указывает на то, что реплика потеряла соединение с исходным сервером. Убедитесь, что исходный сервер работает, или проверьте, блокирует ли брандмауэр подключение.|
|Master_Log_File| Представляет двоичный файл журнала, в который записывается исходный сервер.|
|Read_Master_Log_Pos| Указывает, где исходный сервер записывает данные в двоичный файл журнала.|
|Relay_Master_Log_File| Представляет двоичный файл журнала, который считывается сервером-репликой с исходного сервера.|
|Slave_IO_Running| Указывает, запущен ли поток ввода-вывода. Значение должно быть `Yes` . Если значение равно `NO` , то репликация, скорее всего, нарушена.|
|Slave_SQL_Running| Указывает, работает ли поток SQL. Значение должно быть `Yes` . Если значение равно `NO` , то репликация, скорее всего, нарушена.|
|Exec_Master_Log_Pos| Указывает расположение Relay_Master_Log_File, к которой применяется реплика. При наличии задержки эта последовательность должно быть меньше Read_Master_Log_Pos.|
|Relay_Log_Space|Указывает верхний предел размера журнала ретрансляции. Размер можно проверить, выполнив запрос, `SHOW GLOBAL VARIABLES` например `relay_log_space_limit` .|
|Seconds_Behind_Master| Отображает задержку репликации в секундах.|
|Last_IO_Errno|Отображает код ошибки потока ввода-вывода, если таковой имеется. Дополнительные сведения об этих кодах см. в [справочнике по сообщениям об ошибках сервера MySQL](https://dev.mysql.com/doc/mysql-errors/5.7/en/server-error-reference.html).|
|Last_IO_Error| Отображает сообщение об ошибке потока ввода-вывода, если оно есть.|
|Last_SQL_Errno|Отображает код ошибки потока SQL, если таковой имеется. Дополнительные сведения об этих кодах см. в [справочнике по сообщениям об ошибках сервера MySQL](https://dev.mysql.com/doc/mysql-errors/5.7/en/server-error-reference.html).|
|Last_SQL_Error|Отображает сообщение об ошибке потока SQL, если оно есть.|
|Slave_SQL_Running_State| Указывает текущее состояние потока SQL. В этом состоянии `System lock` является нормальным. Это также нормально для просмотра состояния `Waiting for dependent transaction to commit` . Это состояние указывает, что реплика ожидает, пока исходный сервер не обновит зафиксированные транзакции.|

Если Slave_IO_Running имеет значение `Yes` и Slave_SQL_Running имеет значение `Yes` , то репликация работает нормально. 

Затем проверьте Last_IO_Errno, Last_IO_Error, Last_SQL_Errno и Last_SQL_Error.  В этих полях отображается номер ошибки и сообщение об ошибке самой последней ошибки, вызвавшей зависание потока SQL. Номер ошибки `0` и пустое сообщение означают отсутствие ошибки. Изучите любое ненулевое значение ошибки, проверив код ошибки в [справочнике по сообщению об ошибке сервера MySQL](https://dev.mysql.com/doc/mysql-errors/5.7/en/server-error-reference.html).

## <a name="common-scenarios-for-high-replication-latency"></a>Распространенные сценарии для высокой задержки репликации

В следующих разделах рассматриваются ситуации, в которых часто встречается высокая задержка репликации.

### <a name="network-latency-or-high-cpu-consumption-on-the-source-server"></a>Задержка в сети или высокая загрузка ЦП на исходном сервере

Если вы видите следующие значения, то, скорее всего, задержка репликации вызвана высокой задержкой в сети или высокой загрузкой ЦП на исходном сервере.

```
Slave_IO_State: Waiting for master to send event
Master_Log_File: the binary file sequence is larger then Relay_Master_Log_File, e.g. mysql-bin.00020
Relay_Master_Log_File: the file sequence is smaller than Master_Log_File, e.g. mysql-bin.00010
```

В этом случае поток ввода-вывода выполняется и ожидает на исходном сервере. Исходный сервер уже записался в двоичный файл журнала с номером 20. Реплика получила только до номера файла 10. Основными факторами для высокой задержки репликации в этом сценарии являются скорость сети или высокая загрузка ЦП на исходном сервере.  

В Azure задержка сети в регионе обычно измеряется в миллисекундах. Между регионами, задержка в диапазоне от миллисекунд до секунд.

В большинстве случаев задержка соединения между потоками ввода-вывода и исходным сервером вызвана высокой загрузкой ЦП на исходном сервере. Потоки ввода-вывода обрабатываются медленно. Эту проблему можно обнаружить с помощью Azure Monitor для проверки использования ЦП и количества одновременных подключений на исходном сервере.

Если на исходном сервере не отображается высокая загрузка ЦП, проблема может быть связана с задержкой в сети. Если задержка в сети неожиданно высока, проверьте на [странице состояния Azure](https://status.azure.com/status) на наличие известных проблем или простоев. 

### <a name="heavy-bursts-of-transactions-on-the-source-server"></a>Интенсивные нагрузки транзакций на исходном сервере

Если вы видите следующие значения, большой объем транзакций на исходном сервере, вероятно, приведет к задержке репликации. 

```
Slave_IO_State: Waiting for the slave SQL thread to free enough relay log space
Master_Log_File: the binary file sequence is larger then Relay_Master_Log_File, e.g. mysql-bin.00020
Relay_Master_Log_File: the file sequence is smaller then Master_Log_File, e.g. mysql-bin.00010
```

Выходные данные показывают, что реплика может получить двоичный журнал, лежащий в основе исходного сервера. Но поток операций ввода-вывода реплики указывает на то, что место в журнале ретрансляции уже заполнено.

Скорость сети не вызывает задержки. Реплика пытается выполнить отследку. Но обновленный размер двоичного журнала превышает верхний предел пространства журнала ретрансляции.

Чтобы устранить эту проблему, включите [журнал запросов с задержкой](concepts-server-logs.md) на исходном сервере. Используйте журналы медленного запроса для обнаружения долго выполняющихся транзакций на исходном сервере. Затем настройте идентифицированные запросы, чтобы уменьшить задержку на сервере. 

Задержка репликации этой сортировки обычно вызвана загрузкой данных на исходном сервере. Если исходные серверы имеют еженедельную или ежемесячную загрузку данных, задержка репликации, увы, неизбежна. Серверы реплики в конечном итоге перехватываются после завершения загрузки данных на исходном сервере.

### <a name="slowness-on-the-replica-server"></a>Медленная работа на сервере реплики

Если вы видите приведенные ниже значения, проблема может быть на сервере реплики.

```
Slave_IO_State: Waiting for master to send event
Master_Log_File: The binary log file sequence equals to Relay_Master_Log_File, e.g. mysql-bin.000191
Read_Master_Log_Pos: The position of master server written to the above file is larger than Relay_Log_Pos, e.g. 103978138
Relay_Master_Log_File: mysql-bin.000191
Slave_IO_Running: Yes
Slave_SQL_Running: Yes
Exec_Master_Log_Pos: The position of slave reads from master binary log file is smaller than Read_Master_Log_Pos, e.g. 13468882
Seconds_Behind_Master: There is latency and the value here is greater than 0
```

В этом сценарии выходные данные показывают, что поток ввода-вывода и поток SQL работают нормально. Реплика считывает тот же двоичный файл журнала, который выполняет запись на исходном сервере. Однако задержка на сервере реплики отражает ту же транзакцию, что и исходный сервер.

В следующих разделах описываются распространенные причины такой задержки.

#### <a name="no-primary-key-or-unique-key-on-a-table"></a>Нет первичного ключа или уникального ключа в таблице

База данных Azure для MySQL использует репликацию на основе строк. Сервер исходного кода записывает события в двоичный журнал, записывая изменения в отдельные строки таблицы. Затем поток SQL реплицирует эти изменения в соответствующие строки таблицы на сервере реплики. Если в таблице отсутствует первичный ключ или уникальный ключ, то поток SQL просматривает все строки в целевой таблице, чтобы применить изменения. Эта проверка может вызвать задержку репликации.

В MySQL первичный ключ — это связанный индекс, который обеспечивает высокую производительность запросов, поскольку не может включать значения NULL. При использовании подсистемы хранилища InnoDB данные таблицы физически упорядочены для быстрого поиска и сортировки на основе первичного ключа.

Перед созданием сервера реплики рекомендуется добавить первичный ключ в таблицы на исходном сервере. Добавьте первичные ключи на исходном сервере, а затем повторно создайте реплики чтения, чтобы повысить задержку репликации.

Используйте следующий запрос, чтобы узнать, в каких таблицах отсутствует первичный ключ на исходном сервере:

```sql
select tab.table_schema as database_name, tab.table_name 
from information_schema.tables tab left join 
information_schema.table_constraints tco 
on tab.table_schema = tco.table_schema 
and tab.table_name = tco.table_name 
and tco.constraint_type = 'PRIMARY KEY' 
where tco.constraint_type is null 
and tab.table_schema not in('mysql', 'information_schema', 'performance_schema', 'sys') 
and tab.table_type = 'BASE TABLE' 
order by tab.table_schema, tab.table_name;

```

#### <a name="long-running-queries-on-the-replica-server"></a>Длительные запросы на сервере реплики

Рабочая нагрузка на сервере реплики может привести к задержке потока SQL за потоком ввода-вывода. Долго выполняющиеся запросы на сервере реплики являются одной из распространенных причин высокой задержки репликации. Чтобы устранить эту проблему, включите [журнал запросов с задержкой](concepts-server-logs.md) на сервере реплики.

Медленные запросы могут увеличить потребление ресурсов или замедлить работу сервера, чтобы реплика не могла обнаружить исходный сервер. В этом сценарии настройте запросы на снижение производительности. Более быстрые запросы предотвращают блокирование потока SQL и значительно увеличивают задержку репликации.

#### <a name="ddl-queries-on-the-source-server"></a>Запросы DDL на исходном сервере

На исходном сервере команда языка описания данных DDL, например, [`ALTER TABLE`](https://dev.mysql.com/doc/refman/5.7/en/alter-table.html) может занять много времени. Во время выполнения команды DDL тысячи других запросов могут выполняться параллельно на исходном сервере. 

При репликации DDL для обеспечения согласованности базы данных ядро MySQL выполняет DDL в одном потоке репликации. Во время выполнения этой задачи все остальные реплицированные запросы блокируются и должны дожидаться завершения операции DDL на сервере реплики. Эта задержка вызывается даже в оперативных операциях DDL. Операции DDL увеличивают задержку репликации.

Если вы включили [журнал запросов с низкой](concepts-server-logs.md) задержкой на исходном сервере, можно обнаружить эту проблему задержки, проверив команду DDL, которая выполнялась на исходном сервере. Путем удаления, переименования и создания индекса можно использовать алгоритм для изменения таблицы. Возможно, потребуется скопировать данные таблицы и перестроить таблицу.

Как правило, для алгоритма размещения поддерживается параллельная поддержка DML. Но при подготовке и выполнении операции можно временно получить монопольную блокировку метаданных таблицы. Таким образом, для инструкции CREATE INDEX можно использовать алгоритм и БЛОКИРОВКУ, чтобы повлиять на метод копирования таблицы и уровень параллелизма для чтения и записи. Вы по-прежнему можете предотвращать операции DML, добавляя ПОЛНОТЕКСТОВЫЙ индекс или ПРОСТРАНСТВЕННЫЙ индекс.

В следующем примере создается индекс с помощью операторов ALGORITHM и LOCK.

```sql
ALTER TABLE table_name ADD INDEX index_name (column), ALGORITHM=INPLACE, LOCK=NONE;
```

К сожалению, для инструкции DDL, требующей блокировки, невозможно избежать задержки репликации. Чтобы уменьшить потенциальные последствия, выполните эти типы операций DDL в часы наименьшей нагрузки, например, в ночное время.

#### <a name="downgraded-replica-server"></a>Пониженный сервер реплики

В базе данных Azure для MySQL реплики чтения используют ту же конфигурацию сервера, что и исходный сервер. Конфигурацию сервера реплики можно изменить после ее создания.

Если сервер реплики понижен, Рабочая нагрузка может потреблять больше ресурсов, что, в свою очередь, может привести к задержке репликации. Чтобы обнаружить эту проблему, используйте Azure Monitor, чтобы проверить потребление ресурсов ЦП и памяти сервером реплики.

В этом случае рекомендуется, чтобы конфигурация сервера реплики оставалась в значениях, равных или превышающих значения исходного сервера. Эта конфигурация позволяет реплике синхронизироваться с исходным сервером.

#### <a name="improving-replication-latency-by-tuning-the-source-server-parameters"></a>Повышение задержки репликации путем настройки параметров исходного сервера

По умолчанию в базе данных Azure для MySQL репликация оптимизирована для работы с параллельными потоками в репликах. Когда рабочие нагрузки с высокой степенью параллелизма на исходном сервере приводят к появлению сервера реплики, можно повысить задержку репликации, настроив параметр binlog_group_commit_sync_delay на исходном сервере.

Параметр binlog_group_commit_sync_delay определяет, сколько микросекунд ждет фиксации двоичного журнала перед синхронизацией двоичного файла журнала. Преимущество этого параметра заключается в том, что вместо немедленного применения каждой зафиксированной транзакции сервер-источник отправляет обновления двоичного журнала в виде пакета. Эта задержка сокращает количество операций ввода-вывода в реплике и помогает повысить производительность.

Может быть полезно установить для параметра binlog_group_commit_sync_delay значение 1000 или т. д. Затем отслеживайте задержку репликации. Задайте этот параметр с осторожностью и используйте его только для рабочих нагрузок с высоким уровнем параллелизма.

> [!IMPORTANT]
> В параметре сервер реплики binlog_group_commit_sync_delay рекомендуется указать значение 0. Это рекомендуется, так как в отличие от исходного сервера сервер реплики не имеет высокого параллелизма и увеличение значения binlog_group_commit_sync_delay на сервере реплики может случайно привести к увеличению задержки репликации.

Для рабочих нагрузок с низким уровнем параллелизма, включающих множество одноэлементных транзакций, параметр binlog_group_commit_sync_delay может увеличить задержку. Задержка может увеличиться, так как поток ввода-вывода ожидает обновления больших двоичных файлов журнала, даже если зафиксировано всего несколько транзакций.

## <a name="next-steps"></a>Дальнейшие действия

Ознакомьтесь с [обзором репликации Бинлог MySQL](https://dev.mysql.com/doc/refman/5.7/en/binlog-replication-configuration-overview.html).
