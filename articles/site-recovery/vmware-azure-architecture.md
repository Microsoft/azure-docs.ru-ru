---
title: Архитектура аварийного восстановления виртуальных машин VMware в Azure Site Recovery
description: В этой статье представлен обзор компонентов и архитектуры, используемых при настройке аварийного восстановления виртуальных машин VMware из локальной среды в Azure с помощью Azure Site Recovery.
author: rayne-wiselman
ms.service: site-recovery
services: site-recovery
ms.topic: conceptual
ms.date: 11/06/2019
ms.author: raynew
ms.openlocfilehash: 5cf4dc5123040fd2af8efe54153867a8709fe1ef
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "97652234"
---
# <a name="vmware-to-azure-disaster-recovery-architecture"></a>Архитектура аварийного восстановления из VMware в Azure

В этой статье описаны архитектура и процессы, используемые при развертывании репликации для аварийного восстановления, отработки отказов и восстановления виртуальных машин VMware между локальным сайтом VMware и Azure с помощью службы [Azure Site Recovery](site-recovery-overview.md).


## <a name="architectural-components"></a>Компоненты архитектуры

Приведенные ниже таблица и рисунки позволяют получить общее представление о компонентах, используемых для аварийного восстановления VMware в Azure.

**Компонент** | **Требование** | **Сведения**
--- | --- | ---
**Azure** | Подписка Azure, учетная запись хранения Azure для кэша, управляемого диска и сети Azure. | Реплицированные данные из локальных виртуальных машин хранятся в службе хранилища Azure. Виртуальные машины Azure создаются с использованием реплицированных данных при запуске отработки отказа из локальной среды в Azure. При создании виртуальные машины Azure подключаются к виртуальной сети Azure.
**Компьютер сервера конфигурации** | Отдельный локальный компьютер. Мы рекомендуем использовать виртуальную машину VMware, которую можно развернуть с помощью скачанного шаблона в формате OVF.<br/><br/> На этой машине выполняются все локальные компоненты Site Recovery, включая сервер конфигурации, сервер обработки и главный целевой сервер. | **Сервер конфигурации** используется для управления обменом данными между локальной средой и Azure, а также репликацией данных.<br/><br/> **Сервер обработки** по умолчанию устанавливается на сервере конфигурации. Он получает данные репликации, оптимизирует их путем кэширования, сжатия и шифрования и отправляет эти данные в службу хранилища Azure. Сервер обработки также устанавливает службу Mobility Service Azure Site Recovery на виртуальные машины, которые требуется реплицировать, и выполняет автоматическое обнаружение локальных компьютеров. По мере увеличения масштаба развертывания вы можете добавлять дополнительные отдельные серверы для обработки растущего объема данных репликации.<br/><br/> **Главный целевой сервер** по умолчанию устанавливается на сервере конфигурации. Он обрабатывает данные репликации при восстановлении размещения из Azure. Для крупных развертываний вы можете добавить отдельный главный целевой сервер для восстановления размещения.
**Серверы VMware** | Виртуальные машины VMware размещаются на локальных серверах vSphere ESXi. Мы рекомендуем управлять узлами с помощью сервера vCenter. | При развертывании Site Recovery добавьте серверы VMware в хранилище служб восстановления.
**Реплицируемые компьютеры** | Служба Mobility Service устанавливается на каждой реплицируемой виртуальной машине VMware. | Рекомендуем разрешить автоматическую установку с сервера обработки. Кроме того, службу можно установить вручную или воспользоваться методом автоматического развертывания, например Configuration Manager.

![Схема, демонстрирующая связи между VMware и архитектурой репликации Azure.](./media/vmware-azure-architecture/arch-enhanced.png)

## <a name="set-up-outbound-network-connectivity"></a>Настройка исходящего сетевого подключения

Чтобы Site Recovery правильно работать, необходимо изменить исходящее сетевое подключение, чтобы разрешить репликацию среды.

> [!NOTE]
> Site Recovery не поддерживает использование прокси-сервер проверки подлинности для управления сетевым подключением.

### <a name="outbound-connectivity-for-urls"></a>Исходящие подключения для URL-адресов

При использовании прокси-сервера или брандмауэра на основе URL-адресов для управления исходящими подключениями разрешите использование этих URL-адресов:

| **имя**;                  | **Коммерческие организации**                               | **Государственные организации**                                 | **Описание** |
| ------------------------- | -------------------------------------------- | ---------------------------------------------- | ----------- |
| Память                   | `*.blob.core.windows.net`                  | `*.blob.core.usgovcloudapi.net` | Позволяет записывать данные из виртуальной машины в учетную запись хранения кэша в исходном регионе. |
| Azure Active Directory    | `login.microsoftonline.com`                | `login.microsoftonline.us`                   | Обеспечивает авторизацию и проверку подлинности URL-адресов службы Site Recovery. |
| Репликация               | `*.hypervrecoverymanager.windowsazure.com` | `*.hypervrecoverymanager.windowsazure.com`   | Позволяет виртуальной машине взаимодействовать со службой Site Recovery. |
| Служебная шина               | `*.servicebus.windows.net`                 | `*.servicebus.usgovcloudapi.net`             | Позволяет виртуальной машине записывать данные мониторинга и диагностики службы Site Recovery. |

Полный список URL-адресов, которые должны быть отфильтрованы для обмена данными между локальной инфраструктурой Azure Site Recovery и службами Azure, см. в [разделе Требования к сети статьи предварительные требования](vmware-azure-deploy-configuration-server.md#prerequisites).

## <a name="replication-process"></a>Процесс репликации

1. При включении репликации для виртуальной машины начинается начальная репликация в службу хранилища Azure с помощью указанной политики репликации. Следует отметить следующее.
    - Для виртуальных машин VMware репликации осуществляются на уровне блока почти непрерывно с помощью агента Mobility Service на виртуальной машине.
    - Параметры политики репликации применяются к следующим элементам:
        - **Пороговое значение RPO**. Этот параметр не влияет на репликацию. Он помогает с мониторингом. Будет создано событие, возможно, с отправкой сообщения электронной почты, если текущее значение RPO превышает заданное вами пороговое значение.
        - **Хранение точки восстановления**. Этот параметр указывает, на какой период в прошлом вы хотите вернуться в случае нарушения работы. Максимальный срок хранения в хранилище класса "Премиум" — 24 часа. В хранилище категории "Стандартный" — 72 часа. 
        - **Согласованные с приложением моментальные снимки**. Моментальный снимок с единообразием приложений может выполняться каждые 1 – 12 часов в зависимости от потребностей приложения. Это стандартные моментальные снимки BLOB-объектов Azure. Агент службы Mobility, запущенный на виртуальной машине, запрашивает моментальный снимок VSS в соответствии с этим параметром и отмечает этот момент времени как точку согласованности приложения в потоке репликации.

2. Трафик реплицируется в общедоступные конечные точки службы хранилища Azure через Интернет. Кроме того, можно использовать Azure ExpressRoute с [пиринг Майкрософт](../expressroute/expressroute-circuit-peerings.md#microsoftpeering). Репликация трафика через VPN типа "сеть — сеть" с локального сайта в Azure не поддерживается.
3. Начальная репликация гарантирует, что все данные на компьютере во время включения репликации отправляются в Azure. После завершения начальной репликации начинается репликация разностных изменений в Azure. Отслеживаемые изменения для машины отправляются на сервер обработки.
4. Обмен данными происходит следующим образом.

    - Виртуальные машины обмениваются данными с локальным сервером конфигурации через HTTPS-порт 443 для входящих подключений, чтобы управлять репликацией.
    - Сервер конфигурации выполняет оркестрацию репликации в Azure через HTTPS-порт 443 для исходящих подключений.
    - Виртуальные машины отправляют данные репликации на сервер обработки (запущенный на компьютере сервера конфигурации) через HTTPS-порт 9443 для входящих подключений. Этот порт можно изменить.
    - Сервер обработки получает данные репликации, оптимизирует и шифрует их и отправляет в службу хранилища Azure по исходящему порту 443.
5. Сначала журналы данных репликации помещаются в учетную запись хранения кэша в Azure. Эти журналы обрабатываются, и данные хранятся на управляемом диске Azure (называемом начальным диском ASR). На этом диске создаются точки восстановления.

![Схема, демонстрирующая процесс репликации из VMware в Azure.](./media/vmware-azure-architecture/v2a-architecture-henry.png)

## <a name="resynchronization-process"></a>Процедура повторной синхронизации

1. Иногда во время начальной репликации или при передаче разностных изменений могут возникнуть проблемы с сетевым подключением между исходным компьютером и сервером обработки или между сервером обработки в Azure. Любой из них может привести к сбоям при переносе данных в Azure мгновенно.
2. Чтобы избежать проблем с целостностью данных и снизить затраты на передачу данных, Site Recovery помечает компьютер для повторной синхронизации.
3. Кроме того, компьютер можно пометить для повторной синхронизации в следующих ситуациях, чтобы обеспечить согласованность между исходным компьютером и данными, хранящимися в Azure.
    - Если компьютер принудительно завершает работу
    - Если компьютер направляет изменения в конфигурации, например изменение размера диска (размер диска составляет от 2 ТБ до 4 ТБ);
4. Повторная синхронизация отправляет в Azure только разностные данные. Обмен данными между локальной средой и Azure путем сворачивания контрольных сумм данных между исходным компьютером и данными, хранящимися в Azure.
5. По умолчанию повторная синхронизация автоматически выполняется в нерабочее время. Если вы не хотите ждать времени повторной синхронизации по умолчанию, то можете повторно синхронизировать виртуальную машину вручную. Для этого перейдите в портал Azure, выберите виртуальную машину > **повторной синхронизации**.
6. Если повторная синхронизация по умолчанию завершается неудачей за пределами Office Hours и требуется вмешательство вручную, то на конкретном компьютере в портал Azure возникает ошибка. Вы можете устранить эту ошибку и запустить повторную синхронизацию вручную.
7. После завершения повторной синхронизации будет возобновлена репликация разностных изменений.

## <a name="replication-policy"></a>Политика репликации 

По умолчанию при включении репликации виртуальной машины Azure Site Recovery создает политику репликации, стандартные параметры которой представлены в следующей таблице.

**Параметр политики** | **Сведения** | **По умолчанию**
--- | --- | ---
**Хранение точки восстановления** | Указывает, как долго в Site Recovery хранятся точки восстановления. | 24 часа
**Периодичность создания моментальных снимков с согласованием приложений** | Определяет, как часто Site Recovery создает моментальные снимки с согласованностью на уровне приложений. | Каждые четыре часа

### <a name="managing-replication-policies"></a>Управление политиками репликации

Вы можете выполнять следующие действия для изменения заданных по умолчанию параметров политик репликации и управления ими.
- Можно изменять параметры при включении репликации.
- Можно в любой момент создать политику репликации и применить ее при включении репликации.

### <a name="multi-vm-consistency"></a>Согласованность нескольких виртуальных машин

Если вы хотите, чтобы несколько виртуальных машин реплицировались вместе и для них создавались отказоустойчивые и согласованные на уровне приложений точки восстановления для отработки отказа, объедините такие машины в группу репликации. Согласованность нескольких виртуальных машин влияет на производительность рабочей нагрузки, и ее следует применять только для виртуальных машин, на которых требуется согласованность рабочих нагрузок между всеми компьютерами. 



## <a name="snapshots-and-recovery-points"></a>Моментальные снимки и точки восстановления

Точки восстановления создаются на основе моментальных снимков дисков виртуальной машины, сделанных в определенный момент времени. При отработке отказа виртуальной машины эти точки восстановления используются для восстановления виртуальной машины в целевом расположении.

Обычно при отработке отказа важно, чтобы виртуальная машина запускалась без повреждения или потери данных и чтобы данные на этой виртуальной машине сохраняли согласованность на уровне операционной системы и выполняемых приложений. Это зависит от типа создаваемых моментальных снимков.

Site Recovery создает моментальные снимки следующим образом.

1. Site Recovery по умолчанию создает моментальные снимки данных без учета состояния приложений, а также моментальные снимки, согласованные на уровне приложений, если вы укажете для них частоту создания.
2. Точки восстановления создаются на основе моментальных снимков и сохраняются в соответствии с параметрами хранения, указанными в политике репликации.

### <a name="consistency"></a>Согласованность

В следующей таблице описываются различные виды согласованности.

### <a name="crash-consistent"></a>Без учета состояния приложений

**Описание** | **Сведения** | **Рекомендация**
--- | --- | ---
Моментальный снимок без учета состояния приложения содержит все данные, которые были записаны на диск в момент создания этого моментального снимка. Он не содержит никакой информации из памяти компьютера.<br/><br/> Он сохраняет данные точно так же, как если бы в момент создания моментального снимка произошел сбой виртуальной машины или отключение питания сервера.<br/><br/> Моментальный снимок без учета состояния не гарантирует согласованность данных для операционной системы или приложений этой виртуальной машины. | По умолчанию Site Recovery создает точки восстановления без учета состояния приложений каждые пять минут. Этот параметр нельзя изменить.<br/><br/>  | Сейчас большинство приложений успешно восстанавливаются по точкам восстановления без учета состояния.<br/><br/> Точек восстановления без учета состояния приложений обычно вполне достаточно для репликации операционных систем и приложений, таких как DHCP-серверы и серверы печати.

### <a name="app-consistent"></a>Согласованность на уровне приложений

**Описание** | **Сведения** | **Рекомендация**
--- | --- | ---
Точки восстановления с согласованностью на уровне приложений создаются на основе моментальных снимков с согласованностью на уровне приложений.<br/><br/> Моментальные снимки с согласованностью на уровне приложений содержат все сведения, включаемые в моментальный снимок без учета состояния приложений, а также все данные в памяти и незаконченные транзакции. | Моментальные снимки с согласованностью на уровне приложений создаются с помощью службы теневого копирования томов (VSS).<br/><br/>   1) Azure Site Recovery использует метод резервного копирования только для копирования (VSS_BT_COPY), который не изменяет время и порядковый номер резервной копии журнала транзакций Microsoft SQL. </br></br> 2) при инициации создания моментального снимка VSS выполняет операцию копирования на томе (COW).<br/><br/>   3) перед выполнением COW служба VSS информирует каждое приложение на компьютере о том, что ему требуется очистить его резидентные данные на диск.<br/><br/>   4) VSS позволяет приложению резервного копирования и аварийного восстановления (в данном случае Site Recovery) считывать данные моментального снимка и продолжать работу. | Вы можете указать частоту создания моментальных снимков с согласованностью на уровне приложений. Эта частота должна быть меньше, чем период хранения точек восстановления. Например, если для хранения точек восстановления используется значение по умолчанию 24 часа, настройте частоту создания с интервалом менее 24 часов.<br/><br/>Такие моментальные снимки более сложны и требуют больше времени на создание, чем моментальные снимки без учета состояния приложений.<br/><br/> Они снижают производительность приложений, которые выполняются на реплицируемой виртуальной машине. 

## <a name="failover-and-failback-process"></a>Процесс отработки отказа и восстановления размещения

Настроив репликацию и выполнив отработку аварийного восстановления (тестовую отработку отказа), чтобы проверить правильность работы всех компонентов, вы можете запускать отработку отказа и восстановление размещения по мере необходимости.

1. Можно выполнять отработку отказа отдельных компьютеров или создать планы восстановления, чтобы выполнять отработку отказа сразу нескольких виртуальных машин. План восстановления имеет следующие преимущества перед отработкой отказа отельных компьютеров:
    - Можно моделировать зависимости приложений, включив все виртуальные машины для приложения в один план восстановления.
    - Можно добавить сценарии, модули runbook Azure и паузу для действий, выполняемых вручную.
2. После активации начальной отработки отказа выполняется ее фиксация для получения доступа к рабочей нагрузке из виртуальной машины Azure.
3. Когда основной локальный сайт снова станет доступным, можно будет подготовить среду к восстановлению размещения. Для восстановления размещения следует настроить инфраструктуру восстановления размещения, включая следующее:

    * **Временный сервер обработки в Azure**. чтобы выполнить откат из Azure, необходимо настроить виртуальную машину Azure для работы в качестве сервера обработки для обработки репликации из Azure. После восстановления размещения эту виртуальную машину можно удалить.
    * **VPN-подключение.** Для восстановления размещения нужно настроить VPN-подключение (или ExpressRoute) между сетью Azure и локальным сайтом.
    * **Отдельный главный целевой сервер**. по умолчанию главный целевой сервер, который был установлен с сервером конфигурации на локальной виртуальной машине VMware, обрабатывает восстановление размещения. Чтобы восстановить размещение больших объемов трафика,отдельно настройте локальный главный целевой сервер.
    * **Политика восстановления размещения.** Для репликации обратно на локальный сайт необходима политика восстановления размещения. Эта политика создается автоматически при создании политики репликации из локальной среды в Azure.
4. После готовности всех компонентов восстановление размещения выполняется в три этапа:

    - Этап 1. Повторно включите защиту виртуальных машин Azure, чтобы обеспечить их репликацию из Azure в локальные виртуальные машины VMware.
    -  Этап 2. Запустите отработку отказа на локальном сайте.
    - Этап 3. После восстановления размещения рабочих нагрузок повторно включите репликацию для локальных виртуальных машин.
    
 

![Схема, демонстрирующая восстановление размещения VMware из Azure.](./media/vmware-azure-architecture/enhanced-failback.png)


## <a name="next-steps"></a>Дальнейшие действия

Ознакомьтесь с [этим учебником](vmware-azure-tutorial.md), чтобы включить репликацию из VMware в Azure.
