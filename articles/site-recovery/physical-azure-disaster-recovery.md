---
title: Настройка аварийного восстановления физических локальных серверов с помощью Azure Site Recovery
description: Узнайте, как настраивать аварийное восстановление в Azure для локальных серверов Windows и Linux с помощью службы Azure Site Recovery.
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
ms.topic: article
ms.date: 11/12/2019
ms.author: raynew
ms.openlocfilehash: 9b05d9952628e550beae5cedc49e051936a9d633
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "87927289"
---
# <a name="set-up-disaster-recovery-to-azure-for-on-premises-physical-servers"></a>Настройка аварийного восстановления в Azure для локальных физических серверов

Служба [Azure Site Recovery](site-recovery-overview.md) помогает реализовать стратегию аварийного восстановления за счет управления процессами репликации, отработки отказа и восстановления локальных компьютеров и виртуальных машин Azure.

В этом руководстве показано, как выполнять настройку аварийного восстановления локальных физических серверов Windows и Linux в Azure. В этом руководстве описано следующее:

> [!div class="checklist"]
> * Настройка Azure и предварительных требований для локальной среды.
> * Создание хранилища служб восстановления для Site Recovery. 
> * Настройка исходной и целевой сред для репликации.
> * Создание политики репликации
> * Включение репликации для сервера.

## <a name="prerequisites"></a>Предварительные требования

Для работы с этим руководством сделайте следующее:

- Рассмотрите [архитектуру и компоненты этого сценария](physical-azure-architecture.md).
- [Ознакомьтесь](vmware-physical-secondary-support-matrix.md) с требованиями поддержки для всех компонентов.
- Убедитесь, что серверы, которые необходимо реплицировать, соответствуют требованиям [виртуальных машин Azure](vmware-physical-secondary-support-matrix.md#replicated-vm-support).
- Подготовьте Azure. Требуется подписка Azure, виртуальная сеть Azure и учетная запись хранения.
- Подготовьте учетную запись для автоматической установки службы Mobility Service на каждом сервере, который требуется реплицировать.

Перед началом работы обратите внимание на следующее:

- После отработки отказа в Azure физические серверы невозможно восстановить на локальных физических компьютерах. Их можно восстановить только на виртуальных машинах VMware. 
- В этом руководстве рассматривается настройка аварийного восстановления физического сервера в Azure с использованием наиболее простых параметров. Сведения о других операциях см. в практических руководствах, посвященных таким вопросам:
    - настройка [источника репликации](physical-azure-set-up-source.md), в том числе сервер конфигурации Site Recovery;
    - Настройка [целевого объекта репликации](physical-azure-set-up-target.md).
    - настройка [политики репликации](vmware-azure-set-up-replication.md) и [включение репликации](vmware-azure-enable-replication.md).


### <a name="set-up-an-azure-account"></a>Настройка учетной записи Azure

Получите [учетную запись Microsoft Azure](https://azure.microsoft.com/).

- Начните с [бесплатной пробной версии](https://azure.microsoft.com/pricing/free-trial/).
- Ознакомьтесь с расходами [при использования Site Recovery](site-recovery-faq.md#pricing) и [сведениями о ценах](https://azure.microsoft.com/pricing/details/site-recovery/).
- Узнайте, [какие регионы поддерживаются для Site Recovery](https://azure.microsoft.com/pricing/details/site-recovery/).

### <a name="verify-azure-account-permissions"></a>Проверка разрешений учетной записи Azure

Убедитесь, что учетная запись Azure имеет разрешения для репликации виртуальных машин в Azure.

- Проверьте [разрешения](site-recovery-role-based-linked-access-control.md#permissions-required-to-enable-replication-for-new-virtual-machines), которые необходимы для репликации компьютеров в Azure.
- Проверьте и измените разрешения [управления доступом Azure на основе ролей (Azure RBAC)](../role-based-access-control/role-assignments-portal.md). 



### <a name="set-up-an-azure-network"></a>Настроить сеть

Настройте [сеть Azure](../virtual-network/quick-create-portal.md).

- Виртуальные машины Azure будут размещаться в этой сети при создании после отработки отказа.
- Сеть должна располагаться в том же регионе, что и хранилище служб восстановления.


## <a name="set-up-an-azure-storage-account"></a>Настроить учетную запись хранения Azure

Настройте [учетную запись хранения Azure](../storage/common/storage-account-create.md).

- Служба Site Recovery реплицирует локальные машины в службе хранилища Azure. Виртуальные машины Azure создаются из хранилища после отработки отказа.
- Учетная запись хранения должна быть создана в том же регионе, что и хранилище служб восстановления.


### <a name="prepare-an-account-for-mobility-service-installation"></a>Подготовка учетной записи к установке службы Mobility Service

Служба Mobility Service должна быть установлена на каждом сервере, который нужно реплицировать. Site Recovery устанавливает эту службу автоматически при включении репликации для сервера. Для автоматической установки необходимо подготовить учетную запись, которую Site Recovery будет использовать для доступа к серверу.

- Можно использовать доменную или локальную учетную запись.
- Для виртуальных машин Windows, если учетная запись домена не используется, отключите контроль удаленного доступа пользователей на локальном компьютере. Для этого в разделе реестра **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System** добавьте запись **LocalAccountTokenFilterPolicy** DWORD и задайте для нее значение 1.
- Чтобы добавить запись реестра для отключения параметра из CLI, введите следующую команду: ``REG ADD HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1.``
- Для Linux учетная запись должна принадлежать привилегированному пользователю на исходном сервере Linux.


## <a name="create-a-vault"></a>Создание хранилища

[!INCLUDE [site-recovery-create-vault](../../includes/site-recovery-create-vault.md)]

## <a name="select-a-protection-goal"></a>Выбор целевого объекта защиты

Выберите реплицируемые компоненты и место назначения.

1. Щелкните **Хранилища служб восстановления** > хранилище.
2. В меню ресурсов щелкните **Site Recovery** > **Подготовка инфраструктуры** > **Цель защиты**.
3. На странице **Цель защиты** выберите **To Azure** (В Azure) > **Без виртуализации или иное**.

## <a name="set-up-the-source-environment"></a>Настройка исходной среды

Настройте сервер конфигурации, зарегистрируйте его в хранилище и найдите виртуальные машины.

1. Щелкните **Site Recovery** > **Подготовка инфраструктуры** > **Источник**.
2. Если у вас нет сервера конфигурации, щелкните **+Configuration server** (+ Сервер конфигурации).
3. В колонке **Добавление сервера** в поле **Тип сервера** должно быть указано **Сервер конфигурации**.
4. Скачайте файл единой установки Site Recovery.
5. Скачайте ключ регистрации хранилища. Он потребуется при запуске единой установки. Ключ действителен в течение пяти дней после создания.

   ![Снимок экрана с параметрами для загрузки файла установки и ключа регистрации.](./media/physical-azure-disaster-recovery/source-environment.png)


### <a name="register-the-configuration-server-in-the-vault"></a>Регистрация сервера конфигурации в хранилище

Прежде чем начать, обратите внимание на следующее: 

#### <a name="verify-time-accuracy"></a>Проверка точности времени
Убедитесь, что на компьютере сервера конфигурации системные часы синхронизированы с [сервером времени](/windows-server/networking/windows-time-service/windows-time-service-top). Значения времени должны совпадать. Если системные часы отстают или спешат в пределах 15 минут, установка может завершиться ошибкой.

#### <a name="verify-connectivity"></a>Проверка подключения
Убедитесь, что компьютер может получить доступ к этим URL-адресам на основе среды: 

[!INCLUDE [site-recovery-URLS](../../includes/site-recovery-URLS.md)]  

Правила брандмауэра на основе IP-адресов должны разрешать взаимодействие со всеми URL-адресами Azure, перечисленными выше, через порт HTTPS (443). Чтобы упростить и ограничить диапазоны IP-адресов, рекомендуется выполнить фильтрацию URL-адресов.

- **Коммерческие IP-адреса**. Кроме того, необходимо разрешить [диапазоны IP-адресов центра обработки данных Azure](https://www.microsoft.com/download/confirmation.aspx?id=41653) и порт HTTPS (443). Разрешите диапазоны IP-адресов для региона Azure вашей подписки для поддержки URL-адресов AAD, резервного копирования, репликации и хранения.  
- **Правительственные IP-адреса**. Разрешите [диапазоны IP-адресов центра обработки данных Azure для государственных организаций](https://www.microsoft.com/en-us/download/details.aspx?id=57063) и порт HTTPS (443) для всех регионов USGov (Вирджиния, Техас, Аризона и Айова) для поддержки URL-адресов AAD, резервного копирования, репликации и хранения.  

#### <a name="run-setup"></a>Запуск программы установки
Запустите программу установки сервера конфигурации от имени локального администратора. Сервер обработки и главный целевой сервер также устанавливаются по умолчанию на сервер конфигурации.

[!INCLUDE [site-recovery-add-configuration-server](../../includes/site-recovery-add-configuration-server.md)]


## <a name="set-up-the-target-environment"></a>Настройка целевой среды

Выберите и проверьте целевые ресурсы.

1. Щелкните **Подготовка инфраструктуры** > **Цель** и выберите требуемую подписку Azure.
2. Укажите целевую модель развертывания.
3. Site Recovery проверяет наличие одной или нескольких совместимых учетных записей хранения и сетей Azure.

   ![Снимок экрана с параметрами настройки целевой среды.](./media/physical-azure-disaster-recovery/network-storage.png)


## <a name="create-a-replication-policy"></a>Создание политики репликации

1. Чтобы создать новую политику репликации, щелкните **Инфраструктура Site Recovery** > **Политики репликации** >  **+Политика репликации**.
2. На странице **Создать политику репликации** укажите имя политики.
3. В разделе **Пороговое значение RPO** укажите ограничение целевой точки восстановления (RPO). Это значение указывает, как часто создаются точки восстановления данных. Если непрерывная репликация превышает это значение, выдаются оповещения.
4. В поле **Хранение точки восстановления** укажите продолжительность периода хранения для каждой точки восстановления (в часах). Реплицированные виртуальные машины можно восстановить до любой точки в рамках этого периода. Для компьютеров, реплицируемых в хранилище класса Premium, поддерживается период удержания до 24 часов, а для хранилище класса Standard — до 72 часов.
5. В поле **Периодичность создания моментальных снимков с согласованием приложений** укажите, с какой периодичностью (в минутах) будут создаваться точки восстановления, содержащие моментальные снимки, согласованные на уровне приложений. Нажмите кнопку **ОК** , чтобы создать политику.

    ![Снимок экрана с параметрами создания политики репликации.](./media/physical-azure-disaster-recovery/replication-policy.png)


Политика автоматически сопоставляется с сервером конфигурации. Для восстановления размещения по умолчанию автоматически создается соответствующая политика. Например, если политика репликации называется **rep-policy**, то будет создана политика восстановления размещения **rep-policy-failback**. Эта политика не используется, пока не будет запущено восстановление размещения из Azure.

## <a name="enable-replication"></a>Включение репликации

Включите репликацию для каждого сервера.

- Site Recovery установит службу Mobility Service, если репликация включена.
- При включении репликации для сервера может пройти более 15 минут, прежде чем изменения вступят в силу и появятся на портале.

1. Выберите **Репликация приложения** > **Источник**.
2. В колонке **Источник** выберите нужный сервер конфигурации.
3. В поле **Тип компьютера** выберите параметр **Физические компьютеры**.
4. Выберите сервер обработки (сервер конфигурации). Нажмите кнопку **ОК**.
5. В поле **Цель** выберите подписку и группу ресурсов, в которых вы хотите создавать виртуальные машины Azure после отработки отказа. Выберите модель развертывания, которая будет использоваться в Azure (классическая или Resource Manager).
6. Выберите учетную запись хранения Azure, которую вы хотите использовать для репликации данных. 
7. Выберите сеть и подсеть Azure, к которой будут подключаться виртуальные машины Azure, созданные после отработки отказа.
8. Выберите **Настроить сейчас для всех выбранных компьютеров**, чтобы применить параметр сети ко всем защищаемым машинам. Выберите **Отложить настройку**, чтобы выбрать сеть Azure для каждого компьютера. 
9. В разделе **Физические компьютеры** щелкните **+Physical machine** (+Физический компьютер). Укажите имя и IP-адрес. Выберите операционную систему компьютера, который нужно реплицировать. Обнаружение серверов и включение их в список занимает несколько минут. 
10. В поле **Свойства** > **Настройка свойств** выберите учетную запись, которая будет использоваться сервером обработки для автоматической установки службы Mobility Service на компьютер.
11. Выберите **Параметры репликации** > **Configure replication settings** (Настройка параметров репликации) и убедитесь, что выбрана правильная политика репликации. 
12. Щелкните **Включить репликацию**. Ход выполнения задания **включения защиты** можно отслеживать, выбрав **Параметры** > **Задания** > **Задания Site Recovery**. После выполнения задания **Завершить подготовку защиты** виртуальная машина будет готова к отработке отказа.


Для мониторинга добавляемых серверов можно проверить последнее время обнаружения, выбрав **Серверы конфигурации** > **Последний контакт в**. Чтобы добавить компьютеры, не дожидаясь запланированного времени обнаружения, выделите сервер конфигурации (не щелкая его) и щелкните **Обновить**.

## <a name="next-steps"></a>Дальнейшие действия

[Выполните детализацию аварийного восстановления](tutorial-dr-drill-azure.md).
