---
title: Настройка аварийного восстановления Hyper-V (с VMM) с помощью Azure Site Recovery
description: Узнайте, как настроить аварийное восстановление в Azure для локальных виртуальных машин Hyper-V в облаках System Center VMM с помощью Site Recovery.
ms.topic: tutorial
ms.date: 03/19/2020
ms.custom: MVC
ms.openlocfilehash: c806f968bc6530879f64ddbf6fd4c7d45aa7a8d3
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "89442826"
---
# <a name="set-up-disaster-recovery-of-on-premises-hyper-v-vms-in-vmm-clouds-to-azure"></a>Настройка аварийного восстановления в Azure для локальных виртуальных машин Hyper-V в облаках VMM

В этом учебнике описано, как включить репликацию для локальных виртуальных машин (VM) Hyper-V под управлением System Center Virtual Machine Manager (VMM, диспетчера виртуальных машин System Center) в Azure с помощью [Azure Site Recovery](site-recovery-overview.md) Если вы не используете VMM, [выполните инструкции из этого учебника](hyper-v-azure-tutorial.md).

В этом руководстве описано следующее:

> [!div class="checklist"]
> * Выбор источника и целевого объекта репликации.
> * Настройка среды исходной репликации, включая локальные компоненты Site Recovery и целевую среду репликации.
> * Настройка сетевого сопоставления между сетями виртуальных машин VMM и виртуальными сетями Azure.
> * Создание политики репликации.
> * Включение репликации для виртуальных машин.

> [!NOTE]
> В учебниках описан самый простой способ развертывания для определенного сценария. В них везде, где возможно, используются значения по умолчанию, и описаны не все возможные параметры и пути. Подробные инструкции см. в разделе **Практические руководства** в [документации по Site Recovery](./index.yml).

## <a name="prerequisites"></a>Предварительные требования

В этом учебнике также предполагается, что вы уже ознакомились со следующими учебниками:

1. [Подготовка Azure](tutorial-prepare-azure.md)
1. [Подготовка локальных серверов Hyper-V](hyper-v-prepare-on-premises-tutorial.md)

## <a name="select-a-replication-goal"></a>Выбор цели репликации

1. На портале Azure перейдите в раздел **Хранилища служб восстановления** и выберите хранилище **ContosoVMVault**, созданное в учебнике [Подготовка Azure](tutorial-prepare-azure.md#create-a-recovery-services-vault).
1. В разделе **Приступая к работе** выберите элементы **Site Recovery** > **Подготовка инфраструктуры** и настройте следующие параметры:
    1. **Цель защиты** > **Где расположены компьютеры?**  — установите значение **Локально**.
    1. **Куда следует реплицировать компьютеры?**  — выберите значение **To Azure** (В Azure).
    1. **Ваши компьютеры виртуализированы?**  — выберите значение **Да, с Hyper-V**.
    1. В поле **Are you using System Center VMM to manage your Hyper-V hosts?** (Используете ли вы System Center VMM для управления узлами Hyper-V?) выберите значение **Да**.
1. Щелкните **ОК**.

   ![Цель репликации](./media/hyper-v-vmm-azure-tutorial/replication-goal.png)

## <a name="confirm-deployment-planning"></a>Подтверждение планирования развертывания

1. Если вы планируете выполнить крупномасштабное развертывание, скачайте Планировщик развертывания для Hyper-V, перейдя по ссылке, указанной на странице **Планирование развертывания**. [Ознакомьтесь с дополнительными сведениями](hyper-v-deployment-planner-overview.md) о планировании развертывания Hyper-V.
1. В рамках этого учебника мы не будем использовать Планировщик развертывания. В разделе **Вы выполнили планирование развертывания?** выберите **Выполню позже** и нажмите кнопку **ОК**.

## <a name="set-up-the-source-environment"></a>Настройка исходной среды

При установке исходной среды вы устанавливаете поставщик Azure Site Recovery на сервере VMM и регистрируете сервер в хранилище. Вы устанавливаете агент Служб восстановления Azure на всех узлах Hyper-V.

1. **Подготовка инфраструктуры**: выберите значение **Источник**.
1. **Подготовка источника**. Выберите **+ VMM**, чтобы добавить сервер VMM. В колонке **Добавление сервера** в поле **Тип сервера** должно быть указано **System Center VMM server** (Сервер System Center VMM).
1. Скачайте программу установки поставщика Microsoft Azure Site Recovery.
1. Скачайте ключ регистрации хранилища. Вам понадобится этот ключ при запуске программы установки поставщика. Ключ действителен в течение пяти дней после создания.
1. Скачайте установщик агента Cлужб восстановления Microsoft Azure.

   ![Скачивание поставщика, ключа регистрации и агента](./media/hyper-v-vmm-azure-tutorial/download-vmm.png)

### <a name="install-the-provider-on-the-vmm-server"></a>Установка поставщика на сервер VMM

1. В мастере установки поставщика Azure Site Recovery щелкните **Центр обновления Майкрософт**. Согласитесь использовать Центр обновления Microsoft для проверки обновлений поставщика.
1. **Установка**: примите расположение установки по умолчанию для поставщика и щелкните **Установить**.
1. После установки в мастере регистрации Microsoft Azure Site Recovery выберите элементы **Параметры хранилища**, **Обзор** и в поле **Файл ключа** выберите скачанный файл ключа хранилища.
1. Укажите подписку Azure Site Recovery и имя хранилища (**ContosoVMVault**). Укажите понятное имя для сервера VMM, позволяющее идентифицировать его в хранилище.
1. **Параметры прокси-сервера**: щелкните **Connect directly to Azure Site Recovery without a proxy** (Подключиться к Azure Site Recovery напрямую без прокси-сервера).
1. Примите расположение по умолчанию для сертификата, который используется для шифрования данных. После отработки отказа зашифрованные данные будут расшифрованы.
1. **Синхронизация метаданных в облаке**: щелкните **Sync cloud meta data to Site Recovery portal** (Синхронизировать метаданные облака с порталом восстановления сайтов). На каждом сервере это действие требуется выполнять один раз. Затем щелкните **Регистрация**.
1. После регистрации сервера в хранилище щелкните **Готово**.

Когда регистрация завершится, Azure Site Recovery извлечет метаданные с сервера, а сервер VMM отобразится в разделе **Инфраструктура Site Recovery**.

### <a name="install-the-recovery-services-agent-on-hyper-v-hosts"></a>Установка агента Служб восстановления на узлах Hyper-V

Установите агент на каждом узле Hyper-V, содержащем виртуальные машины, которые требуется реплицировать.

В мастере настройки агента служб восстановления Microsoft Azure настройте эти параметры:

1. **Проверка необходимых компонентов**. Выберите **Далее**. Все отсутствующие необходимые компоненты будут установлены автоматически.
1. **Параметры установки**: примите значение расположения установки. Щелкните **Установить**.

    >[!NOTE]
    >Для Azure Site Recovery не требуется указывать значение в поле **Расположение кэша**.

1. **Установка**: по завершении установки нажмите кнопку **Закрыть**, чтобы завершить работу мастера.

   ![Установка агента](./media/hyper-v-vmm-azure-tutorial/mars-install.png)

## <a name="set-up-the-target-environment"></a>Настройка целевой среды

1. Выберите **Подготовка инфраструктуры** > **Целевой объект**.
1. Выберите подписку и группу ресурсов (**ContosoRG**), в которых будут создаваться виртуальные машины Azure после отработки отказа.
1. Выберите модель развертывания **Resource Manager**.

Site Recovery проверяет наличие одной или нескольких совместимых учетных записей хранения и сетей Azure.

## <a name="configure-network-mapping"></a>Настройка сетевого сопоставления

1. Выберите элементы **Инфраструктура Site Recovery** > **Сетевые сопоставления** > **Сетевое сопоставление**. Выберите значок **+Network Mapping** (+Сетевое сопоставление).
1. **Добавление сетевого сопоставления**: выберите значение в поле **Source System Center VMM** (Исходный сервер System Center VMM). В поле **Target** (Цель) выберите Azure.
1. Проверьте подписку и модель развертывания после отработки отказа.
1. **Исходная сеть**: выберите исходную локальную сеть виртуальной машины.
1. **Целевая сеть**: выберите сеть Azure, в которой будут размещены реплицированные виртуальные машины Azure. Нажмите кнопку **ОК**.

   ![Сетевое сопоставление](./media/hyper-v-vmm-azure-tutorial/network-mapping-vmm.png)

## <a name="set-up-a-replication-policy"></a>Настройка политики репликации

1. Выберите **Подготовка инфраструктуры** > **Параметры репликации** >  **+ Create and associate** (+ Создание и связывание).
1. На странице **Создать и связать политику** укажите имя политики. Мы используем **ContosoReplicationPolicy**.
1. Примите параметры по умолчанию и нажмите кнопку **ОК**:
   - В поле **Периодичность копирования** указывается, что разностные данные после начальной репликации будут реплицироваться каждые пять минут.
   - В поле **Хранение точки восстановления** указывается, что каждая точка восстановления будет храниться на протяжении двух часов.
   - В поле **Периодичность создания моментальных снимков с согласованием приложений** указывается, что точки восстановления, содержащие моментальные снимки, согласованные на уровне приложений, будут создаваться ежечасно.
   - В поле **Время начала первичной репликации** указывается, что начальная репликация начнется немедленно.
   - В поле **Encrypt data stored on Azure** (Шифрование данных, хранящихся в Azure) значение по умолчанию **Off** (Выкл.) указывает, что статические данные в Azure не шифруются.
1. После создания политики нажмите кнопку **OК**. При создании политики она автоматически связывается с облаком VMM.

## <a name="enable-replication"></a>Включение репликации

1. **Replicate application** (Репликация приложения): выберите значение **Источник**.
1. **Источник**. Выберите облако VMM. Нажмите кнопку **ОК**.
1. **Цель**: проверьте цель (Azure), подписку хранилища и выберите модель **Resource Manager**.
1. Выберите учетную запись хранения **contosovmsacct1910171607** и сеть Azure **ContosoASRnet**.
1. **Виртуальные машины** > **Выбрать**: выберите виртуальную машину, которую необходимо реплицировать. Нажмите кнопку **ОК**.

   Ход выполнения действия **включения защиты** можно отслеживать, выбрав **Задания** > **Задания Azure Site Recovery**. После выполнения задания **Завершить подготовку защиты** начальная репликация завершается, а виртуальная машина готова к отработке отказа.

## <a name="next-steps"></a>Дальнейшие действия

> [!div class="nextstepaction"]
> [Выполнение отработки аварийного восстановления](tutorial-dr-drill-azure.md)
