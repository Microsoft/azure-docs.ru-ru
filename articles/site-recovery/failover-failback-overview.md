---
title: Сведения о отработке отказа и восстановлении размещения в Azure Site Recovery
description: Сведения об отработке отказа и сбое в Azure Site Recovery.
ms.topic: conceptual
ms.date: 12/24/2019
ms.openlocfilehash: b900655d6fdf1143d430ac842bfd84eb1dfdf34c
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "98070750"
---
# <a name="about-on-premises-disaster-recovery-failoverfailback"></a>Об отработке отказа локального аварийного восстановления и восстановлении размещения

В этой статье представлен обзор отработки отказа и восстановления размещения во время аварийного восстановления локальных компьютеров в Azure с [Azure Site Recovery](site-recovery-overview.md).

## <a name="recovery-stages"></a>Этапы восстановления

Отработка отказа и восстановление размещения в Site Recovery состоит из четырех этапов:

- **Этап 1. отработка отказа из локальной** среды. После настройки репликации в Azure для локальных компьютеров при отключении локального сайта происходит сбой этих компьютеров в Azure. После выполнения отработки отказа из реплицированных данных создаются виртуальные машины Azure.
- **Этап 2. Повторная защита виртуальных машин Azure**. в Azure повторно включите защиту виртуальных машин Azure, чтобы они начали реплицироваться на локальный сайт. Локальная виртуальная машина (если она доступна) отключается во время повторного включения защиты для обеспечения согласованности данных.
- **Этап 3. отработка отказа из Azure**. Если локальный сайт снова работает в нормальном режиме, вы запускаете другой переход, чтобы восстановить размещение виртуальных машин Azure на локальном сайте. Можно восстановить размещение в исходном расположении, из которого выполняется отработка отказа, или в альтернативное расположение.
- **Этап 4. Повторное включение защиты локальных компьютеров**. после сбоя резервного копирования снова включите репликацию локальных компьютеров в Azure.

## <a name="failover"></a>Отработка отказа

Отработка отказа выполняется в рамках стратегии непрерывности бизнес-процессов и аварийного восстановления (BCDR).

- В качестве первого шага в стратегии BCDR вы реплицируете локальные компьютеры в Azure на постоянной основе. Пользователи получают доступ к рабочим нагрузкам и приложениям, работающим на локальных исходных компьютерах.
- Если возникает потребность в том, например, если происходит сбой в локальной среде, репликация компьютеров в Azure завершается сбоем. Виртуальные машины Azure создаются с помощью реплицированных данных.
- Для обеспечения непрерывности бизнес-процессов пользователи могут продолжать получать доступ к приложениям на виртуальных машинах Azure.

Отработка отказа состоит из двух этапов:

- **Отработка отказа**— отработка отказа, которая создает виртуальную машину Azure и открывает ее с помощью выбранной точки восстановления.
- **Фиксация**. После отработки отказа вы проверите виртуальную машину в Azure:
    - Затем можно зафиксировать отработку отказа в выбранной точке восстановления или выбрать другую точку для фиксации.
    - После фиксации отработки отказа невозможно изменить точку восстановления.


## <a name="connect-to-azure-after-failover"></a>Подключение к Azure после отработки отказа

Для подключения к виртуальным машинам Azure, созданным после отработки отказа с помощью RDP или SSH, необходимо выполнить ряд требований.

**Тип отработки отказа** | **Расположение** | **Действия**
--- | --- | ---
**Виртуальная машина Azure под управлением Windows** | На локальном компьютере перед отработкой отказа | **Доступ через Интернет**: включение RDP. Убедитесь, что правила TCP и UDP добавлены для **общедоступных** и что протокол RDP разрешен для всех профилей в   >  **разрешенных приложениях** брандмауэра Windows.<br/><br/> **Доступ через VPN типа "сеть — сеть**". Включите RDP на компьютере. Убедитесь, что протокол RDP разрешен в окне **Брандмауэр Windows**  ->  **Разрешенные приложения и компоненты** для **доменных и частных** сетей.<br/><br/>  Задайте для политики сети SAN операционной системы значение **OnlineAll**. [Подробнее](https://support.microsoft.com/kb/3031135).<br/><br/> Прежде чем активировать отработку отказа, убедитесь, что на виртуальной машине нет ожидающих установки обновлений Windows. Центр обновления Windows может запускаться при отработки отказа, и вы не сможете войти на виртуальную машину до завершения обновления.
**Виртуальная машина Azure под управлением Windows** | На виртуальной машине Azure после отработки отказа |  [Добавьте общедоступный IP-адрес](/archive/blogs/srinathv/how-to-add-a-public-ip-address-to-azure-vm-for-vm-failed-over-using-asr) для виртуальной машины.<br/><br/> Правила группы безопасности сети для виртуальной машины, для которой выполнена отработка отказа (и подсеть Azure, к которой он подключен), должны разрешать входящие подключения к порту RDP.<br/><br/> Чтобы просмотреть снимок виртуальной машины, можно проверить **диагностику загрузки**. Если вы не можете подключиться, проверьте, запущена ли виртуальная машина, и просмотрите [Советы по устранению неполадок](https://social.technet.microsoft.com/wiki/contents/articles/31666.troubleshooting-remote-desktop-connection-after-failover-using-asr.aspx).
**Виртуальная машина Azure под управлением Linux** | На локальном компьютере перед отработкой отказа | Настройте автоматический запуск службы SSH на виртуальной машине при загрузке системы (если он еще не настроен).<br/><br/> Убедитесь, что правила брандмауэра разрешают SSH-подключение к виртуальной машине.
**Виртуальная машина Azure под управлением Linux** | На виртуальной машине Azure после отработки отказа | Правила группы безопасности сети на виртуальной машине, для которой выполнена отработка отказа, и подсети Azure, к которой она подключена, должны разрешать входящие подключения к порту SSH.<br/><br/> [Добавьте общедоступный IP-адрес](/archive/blogs/srinathv/how-to-add-a-public-ip-address-to-azure-vm-for-vm-failed-over-using-asr) для виртуальной машины.<br/><br/> Чтобы просмотреть снимок виртуальной машины, можно проверить **диагностику загрузки**.<br/><br/>

## <a name="types-of-failover"></a>Типы отработки отказа

Site Recovery предоставляет различные варианты отработки отказа.

**Тип отработки отказа** | **Сведения** | **Восстановление** | **Рабочий процесс**
--- | --- | --- | ---
**Тестовая отработка отказа** | Используется для выполнения детализации, которая проверяет стратегию BCDR без потери данных или простоя.| Создает копию виртуальной машины в Azure, не влияя на текущую репликацию или в рабочую среду. | 1. Запустите тестовую отработку отказа на одной виртуальной машине или на нескольких виртуальных машинах в плане восстановления.<br/><br/> 2. Выберите точку восстановления, которая будет использоваться для тестовой отработки отказа.<br/><br/> 3. Выберите сеть Azure, в которой будет размещена виртуальная машина Azure после отработки отказа. Сеть используется только для тестовой отработки отказа.<br/><br/> 4. Убедитесь, что детализация работала правильно. Site Recovery автоматически очищает виртуальные машины, созданные в Azure, во время детализации.
**Плановая отработка отказа — Hyper-V**  | Обычно используется для запланированного простоя.<br/><br/> Работа исходных виртуальных машин завершается. Прежде чем инициировать отработку отказа, синхронизируются последние данные. | Нулевая потери данных для запланированного рабочего процесса. | 1. Планирование периода обслуживания после простоя и уведомление пользователей.<br/><br/> 2. Переведите приложения, работающие с пользователем, в автономном режиме.<br/><br/> 3. Запустите плановую отработку отказа с последней точкой восстановления. Отработка отказа не выполняется, если компьютер не выключен или обнаружены ошибки.<br/><br/> 4. После отработки отказа убедитесь, что виртуальная машина Azure реплики активна в Azure.<br/><br/> 5. Зафиксируйте отработку отказа для завершения. Действие фиксации удаляет все точки восстановления.
**Отработка отказа Hyper-V** | Обычно запускается в случае незапланированного сбоя или первичного сайта недоступен.<br/><br/> При необходимости завершите работу виртуальной машины и синхронизируйте окончательные изменения перед началом отработки отказа.  | Минимальная потери данных для приложений. | 1. Запустите план BCDR. <br/><br/> 2. Инициация отработки отказа. Укажите, следует ли Site Recovery завершить работу виртуальной машины и синхронизировать или реплицировать последние изменения перед активацией отработки отказа.<br/><br/> 3. можно выполнить отработку отказа на несколько вариантов точек восстановления, приведенных в таблице ниже.<br/><br/> Если вы не включите параметр завершения работы виртуальной машины или если Site Recovery не сможет завершить ее работу, используется последняя точка восстановления.<br/>Отработка отказа выполняется, даже если не удается завершить работу компьютера.<br/><br/> 4. После отработки отказа вы убедитесь, что виртуальная машина Azure реплики активна в Azure.<br/> При необходимости можно выбрать другую точку восстановления из окна хранения в 24 часа.<br/><br/> 5. Зафиксируйте отработку отказа для завершения. Действие фиксации удаляет все доступные точки восстановления.
**Отработка отказа VMware** | Обычно запускается в случае незапланированного сбоя или первичного сайта недоступен.<br/><br/> При необходимости укажите, что Site Recovery должен попытаться запустить завершение работы виртуальной машины, а также синхронизировать и реплицировать последние изменения перед началом отработки отказа.  | Минимальная потери данных для приложений. | 1. Запустите план BCDR. <br/><br/> 2. Запустите отработку отказа из Site Recovery. Укажите, следует ли Site Recovery попытаться активировать завершение работы виртуальной машины и выполнить синхронизацию перед выполнением отработки отказа.<br/> Отработка отказа выполняется, даже если не удается завершить работу компьютеров.<br/><br/> 3. После отработки отказа убедитесь, что виртуальная машина Azure реплики активна в Azure. <br/>При необходимости можно выбрать другую точку восстановления из окна хранения в 72 ч.<br/><br/> 5. Зафиксируйте отработку отказа для завершения. Действие фиксации удаляет все точки восстановления.<br/> При использовании виртуальных машин Windows Site Recovery отключает инструменты VMware во время отработки отказа.

## <a name="failover-processing"></a>Обработка отработки отказа

В некоторых сценариях требуется дополнительная обработка отработки отказа, которая длится около 8–10 минут. Тестовая отработка отказа может занимать больше времени для следующих систем:

* виртуальные машины VMware, использующие Службу мобильности версии ниже 9.8;
* физические серверы;
* виртуальные машины Linux VMware;
* виртуальные машины Hyper-V, защищенные как физические серверы;
* виртуальные машины VMware без включенной службы DHCP;
* виртуальные машины VMware без загрузочных драйверов storvsc, vmbus, storflt, intelide, atapi.

## <a name="recovery-point-options"></a>Параметры точки восстановления

Во время отработки отказа можно выбрать несколько вариантов точек восстановления.

**Параметр** | **Сведения**
--- | ---
**Последняя (наименьшая RPO)** | Этот параметр обеспечивает наименьшую целевую точку восстановления (RPO). Сначала обрабатываются все данные, отправленные в службу Site Recovery, чтобы создать точку восстановления для каждой виртуальной машины, прежде чем выполнять в нее отработку отказа. Эта точка восстановления имеет все реплицированные в Site Recovery данные на момент запуска отработки отказа.
**Последняя обработанная**  | Этот параметр приводит к отработку отказа виртуальных машин до последней точки восстановления, обработанной Site Recovery. Для просмотра последней точки восстановления конкретной виртуальной машины ознакомьтесь с разделом **Последние точки восстановления** в параметрах виртуальной машины. Этот вариант обеспечивает низкий показатель целевого времени восстановления, так как не требует времени на обработку данных.
**Последняя совместимость с приложениями** |  Этот параметр приводит к отработку отказа виртуальных машин до последней точки восстановления с постоянной совместимостью приложений, обработанной Site Recovery, если включены точки восстановления, совместимые с приложениями. Проверьте последнюю точку восстановления в параметрах виртуальной машины.
**Последние обработанные несколько виртуальных машин** | Этот параметр доступен для планов восстановления, которые содержат одну или больше виртуальных машин с согласованностью состояний. Виртуальные машины с этим параметром выполняют отработку отказа до последней согласованной точки восстановления, общей для нескольких виртуальных машин. Все остальные виртуальные машины в плане отправляются на последнюю обработанную точку восстановления.
**Последняя версия с несколькими ВМ, согласованная с приложениями** |  Этот параметр доступен для планов восстановления, которые содержат одну или больше виртуальных машин с согласованностью состояний. Виртуальные машины, которые являются частью группы репликации, выполняют отработку отказа до последней согласованной с приложением точки восстановления, общей для нескольких виртуальных машин. Остальные виртуальные машины выполняют отработку отказа до последней точки восстановления, согласованной с приложением.
**Пользовательский** | Используйте этот параметр, чтобы выполнить отработку отказа определенной виртуальной машины на определенную точку восстановления во времени. Этот параметр недоступен для планов восстановления.

> [!NOTE]
> Точки восстановления нельзя перенести в другое хранилище служб восстановления.

## <a name="reprotectionfailback"></a>Повторное защита или восстановление размещения

После отработки отказа в Azure реплицированные виртуальные машины Azure находятся в незащищенном состоянии.

- В качестве первого шага при восстановлении подключения к локальному сайту необходимо запустить виртуальные машины Azure, реплицируемые в локальную среду. Процесс повторной защиты зависит от типа компьютеров, для которых выполняется отработка отказа.
- После репликации виртуальных машин из Azure в локальную среду можно выполнить отработку отказа из Azure на локальный сайт.
- После повторного запуска виртуальных машин можно включить репликацию, чтобы они реплицировались в Azure для аварийного восстановления.

Восстановление размещения выполняется следующим образом.

- Для восстановления после сбоя виртуальной машине требуется по крайней мере одна точка, чтобы восстановить ее. В плане восстановления всем виртуальным машинам в плане требуется по крайней мере одна точка восстановления.
- Рекомендуется использовать **последнюю** точку восстановления для возврата к отказу (это точка с точки зрения аварийного завершения).
    - Существует параметр точки восстановления, совместимый с приложениями. В этом случае одна виртуальная машина восстанавливается до последней доступной точки восстановления, соответствующей приложению. Для плана восстановления с группой репликации каждая группа репликации восстанавливает общую доступную точку восстановления.
    - Точки восстановления, совместимые с приложениями, могут относиться к моменту времени, а данные могут быть утеряны.
- Во время отработки отказа из Azure на локальный сайт Site Recovery завершает работу виртуальных машин Azure. При фиксации отработки отказа Site Recovery удаляет невыполненные виртуальные машины Azure в Azure.


## <a name="vmwarephysical-reprotectionfailback"></a>VMware/физическая защита или восстановление размещения

Для повторного включения защиты и восстановления размещения виртуальных машин VMware и физических серверов из Azure в локальную среду необходимо выполнить предварительную репликацию и выполнить ряд требований.

- **Временный сервер обработки в Azure**. чтобы выполнить откат из Azure, необходимо настроить виртуальную машину Azure для работы в качестве сервера обработки для обработки репликации из Azure. После восстановления размещения эту виртуальную машину можно удалить.
- **VPN-подключение.** Для восстановления размещения нужно настроить VPN-подключение (или ExpressRoute) между сетью Azure и локальным сайтом.
- **Отдельный главный целевой сервер**. по умолчанию главный целевой сервер, который был установлен с сервером конфигурации на локальной виртуальной машине VMware, обрабатывает восстановление размещения. Чтобы восстановить размещение больших объемов трафика,отдельно настройте локальный главный целевой сервер.
- **Политика восстановления размещения.** Для репликации обратно на локальный сайт необходима политика восстановления размещения. Эта политика создается автоматически при создании политики репликации из локальной среды в Azure.
    - Эта политика автоматически связывается с сервером конфигурации.
    - Вы не можете изменить эту политику.
    - Значения политики: пороговое значение RPO — 15 минут; Хранение точки восстановления — 24 часа; Периодичность моментальных снимков с постоянными приложениями — 60 минут.

Дополнительные сведения об VMware/физической повторной защите и восстановлении размещения:
- [Ознакомьтесь](vmware-azure-reprotect.md#before-you-begin) с дополнительными требованиями к повторной защите и восстановлению размещения.
- [Развертывание](vmware-azure-prepare-failback.md#deploy-a-process-server-in-azure) сервера обработки в Azure.
- [Разверните](vmware-azure-prepare-failback.md#deploy-a-separate-master-target-server) отдельный главный целевой сервер.

При повторном включении защиты виртуальных машин Azure в локальной среде можно указать, что вы хотите восстановить размещение в исходном расположении или в альтернативное расположение.

- **Восстановление в исходном расположении**. Эта ошибка возвращается из Azure к тому же исходному локальному компьютеру, если он существует. В этом случае только изменения реплицируются обратно в локальную среду.
- **Восстановление в альтернативное расположение**. Если локальный компьютер не существует, вы можете выполнить восстановление размещения из Azure в альтернативное расположение. При повторной защите виртуальной машины Azure в локальной среде создается локальный компьютер. Полная репликация данных выполняется из Azure в локальную среду. — [Проверьте](concepts-types-of-failback.md) требования и ограничения для восстановления размещения.



## <a name="hyper-v-reprotectionfailback"></a>Повторное защита и восстановление размещения Hyper-V

Чтобы повторно включить защиту и восстановить работоспособность виртуальных машин Hyper-V из Azure в локальную среду, выполните следующие действия.

- Восстановить работоспособность виртуальных машин Hyper-V можно только с помощью учетной записи хранения. Восстановление размещения виртуальных машин Hyper-V, которые реплицируются с помощью управляемых дисков, не поддерживается.
- Локальные узлы Hyper-V (или System Center VMM, если они используются) должны быть подключены к Azure.
- Вы запускаете запланированное восстановление размещения из Azure в локальную среду.
- Для восстановления размещения виртуальной машины Hyper-V не нужно настраивать специальные компоненты.
- Во время плановой отработки отказа можно выбрать параметры синхронизации данных перед восстановлением размещения.
    - **Синхронизировать данные перед отработкой отказа**. Этот параметр сокращает время простоя виртуальных машин, так как синхронизирует компьютеры без выключения.
        - Этап 1. создает моментальный снимок виртуальной машины Azure и копирует его на локальный узел Hyper-V. Машина продолжит работать в Azure.
        - Этап 2. завершает работу виртуальной машины Azure, чтобы в ней не происходили новые изменения. Окончательный набор разностных изменений передается на локальный сервер, а локальная виртуальная машина запускается.
    - **Синхронизировать данные только во время отработки отказа**. Этот параметр работает быстрее, так как предполагается, что большая часть диска изменилась и, таким образом, не выполняется вычисление контрольных сумм. Выполняется скачивание диска. Рекомендуется использовать этот параметр, если виртуальная машина была запущена в Azure в течение определенного числа (месяц или более) или если локальная виртуальная машина удалена.

Дополнительные [сведения](hyper-v-azure-failback.md) о повторной защите и восстановлении размещения Hyper-V.

При повторном включении защиты виртуальных машин Azure в локальной среде можно указать, что вы хотите восстановить размещение в исходном расположении или в альтернативное расположение.

- **Восстановление в исходном расположении**. Эта ошибка возвращается из Azure к тому же исходному локальному компьютеру, если он существует. В этом сценарии вы выбрали один из параметров синхронизации, описанный в предыдущей процедуре.
- **Восстановление в альтернативное расположение**. Если локальный компьютер не существует, вы можете выполнить восстановление размещения из Azure в альтернативное расположение. При повторной защите виртуальной машины Azure в локальной среде создается локальный компьютер. В этом случае рекомендуется выбрать вариант синхронизации данных перед отработкой отказа.
- [Ознакомьтесь](hyper-v-azure-failback.md) с требованиями и ограничениями для восстановления размещения.


После восстановления подключения к локальному сайту включите **обратную репликацию** , чтобы начать РЕПЛИКАЦИЮ виртуальной машины в Azure, выполнив цикл.




## <a name="next-steps"></a>Дальнейшие действия
- Отработка отказа [конкретных виртуальных машин VMware](vmware-azure-tutorial-failover-failback.md)
- Отработка отказа [конкретных виртуальных машин Hyper-V](hyper-v-azure-failover-failback-tutorial.md).
- [Создайте](site-recovery-create-recovery-plans.md) план восстановления.
- Отработка отказа [виртуальных машин в плане восстановления](site-recovery-failover.md).
- [Подготовка к](vmware-azure-failback.md) Повторное защита и восстановление размещения VMware.
- Восстановить при сбое [виртуальные машины Hyper-V](hyper-v-azure-failback.md).
