---
title: Руководство по настройке аварийного восстановления виртуальной машины Azure с помощью Azure Site Recovery
description: Из этого руководства вы узнаете, как настроить аварийное восстановление виртуальных машин Azure в другой регион Azure с использованием службы Azure Site Recovery.
ms.topic: tutorial
ms.date: 11/03/2020
ms.custom: mvc
ms.openlocfilehash: 473a264ef497cab4bd4f88372600161b33178099
ms.sourcegitcommit: f28ebb95ae9aaaff3f87d8388a09b41e0b3445b5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/29/2021
ms.locfileid: "97656875"
---
# <a name="tutorial-set-up-disaster-recovery-for-azure-vms"></a>Руководство по Настройка аварийного восстановления для виртуальных машин Azure

В этом руководстве показано, как настроить аварийное восстановление для виртуальных машин Azure с помощью [Azure Site Recovery](site-recovery-overview.md). Вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * проверка параметров и разрешений Azure;
> * подготовка виртуальных машин для репликации;
> * Создание хранилища служб восстановления
> * включение репликации виртуальных машин.

Когда вы включаете репликацию для настройки аварийного восстановления виртуальной машины, расширение службы "Мобильность" Site Recovery устанавливается на этой виртуальной машине и регистрирует ее в Azure Site Recovery. В процессе репликации сведения об операциях записи на диск виртуальной машины отправляются в учетную запись хранения кэша в исходном регионе. Данные отправляются из этого расположения в целевой регион, и на их основе создаются точки восстановления. При выполнении отработки отказа виртуальной машины во время аварийного восстановления для восстановления виртуальной машины в целевом регионе используется точка восстановления.

> [!NOTE]
> Руководства содержат инструкции с простейшими параметрами по умолчанию. Если вы хотите настроить для виртуальной машины Azure аварийное восстановление с собственными параметрами, см. [эту статью](azure-to-azure-how-to-enable-replication.md).

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

## <a name="prerequisites"></a>Предварительные требования

Перед началом работы с этим руководством сделайте следующее:

- [Изучите поддерживаемые регионы.](azure-to-azure-support-matrix.md#region-support) Вы можете настроить для виртуальных машин Azure аварийное восстановление между любыми двумя регионами в пределах одной географической территории.
- Вам потребуется одна или несколько виртуальных машин Azure. Убедитесь, что поддерживаются виртуальные машины [Windows](azure-to-azure-support-matrix.md#windows) или [Linux](azure-to-azure-support-matrix.md#replicated-machines---linux-file-systemguest-storage).
- Изучите требования к [вычислительным ресурсам](azure-to-azure-support-matrix.md#replicated-machines---compute-settings), [хранилищу ](azure-to-azure-support-matrix.md#replicated-machines---storage) и [сети](azure-to-azure-support-matrix.md#replicated-machines---networking) для виртуальных машин.
- В этом руководстве предполагается, что виртуальные машины не шифруются. Если вы хотите настроить аварийное восстановление для зашифрованных виртуальных машин, [воспользуйтесь этой статьей](azure-to-azure-how-to-enable-replication-ade-vms.md).

## <a name="check-azure-settings"></a>Проверка параметров Azure

Проверьте разрешения и параметры в целевом регионе.

### <a name="check-permissions"></a>Проверьте разрешения.

Учетной записи Azure требуются разрешения на создание хранилища Служб восстановления и виртуальных машин в целевом регионе.

- Если вы только что создали бесплатную подписку Azure, вы уже являетесь администратором учетной записи и никаких дополнительных действий не требуется.
- Если вы не администратор подписки, свяжитесь с администратором, чтобы получить необходимые разрешения.
    - **Создание хранилища:** права администратора или владельца для подписки. 
    - **Управление операциями Site Recovery в хранилище:** встроенная роль Azure *участника Site Recovery*.
    - **Создание виртуальных машин Azure в целевом регионе:** встроенная роль *Участник виртуальных машин* или следующие конкретные разрешения:
        - разрешение на создание виртуальной машины в выбранной виртуальной сети;
        - разрешение на запись в учетную запись хранения Azure;
        - разрешение на запись на управляемый диск Azure.

### <a name="verify-target-settings"></a>Проверка параметров в целевой среде

Во время аварийного восстановления при отработке отказа из исходного региона создаются виртуальные машины в целевом регионе. 

Убедитесь, что в вашей подписке есть достаточно ресурсов в целевом регионе. Вам нужна возможность создавать виртуальные машины с размерами, которые соответствуют виртуальным машинам в исходном регионе. При настройке аварийного восстановления служба Site Recovery выбирает для целевой виртуальной машины такой же или наиболее близкий размер.


## <a name="prepare-vms"></a>Подготовка виртуальных машин

Убедитесь, что виртуальные машины имеют возможность исходящего подключения и последние корневые сертификаты. 


### <a name="set-up-vm-connectivity"></a>Настройка подключений виртуальной машины

Виртуальные машины, для которых требуется репликация, должны иметь возможность исходящего сетевого подключения.

> [!NOTE]
> Site Recovery не поддерживает использование прокси-сервер проверки подлинности для управления сетевым подключением.

#### <a name="outbound-connectivity-for-urls"></a>Исходящие подключения для URL-адресов

При использовании прокси-сервера или брандмауэра на основе URL-адресов для управления исходящими подключениями разрешите использование этих URL-адресов:

| **имя**;                  | **Коммерческие организации**                               | **Государственные организации**                                 | **Описание** |
| ------------------------- | -------------------------------------------- | ---------------------------------------------- | ----------- |
| Память                   | `*.blob.core.windows.net`                  | `*.blob.core.usgovcloudapi.net` | Позволяет записывать данные из виртуальной машины в учетную запись хранения кэша в исходном регионе. |
| Azure Active Directory    | `login.microsoftonline.com`                | `login.microsoftonline.us`                   | Обеспечивает авторизацию и проверку подлинности URL-адресов службы Site Recovery. |
| Репликация               | `*.hypervrecoverymanager.windowsazure.com` | `*.hypervrecoverymanager.windowsazure.com`   | Позволяет виртуальной машине взаимодействовать со службой Site Recovery. |
| Служебная шина               | `*.servicebus.windows.net`                 | `*.servicebus.usgovcloudapi.net`             | Позволяет виртуальной машине записывать данные мониторинга и диагностики службы Site Recovery. |

#### <a name="outbound-connectivity-for-ip-address-ranges"></a>Исходящие подключения для диапазонов IP-адресов

Если для управления подключением вы используете группы безопасности сети (NGS), создайте правила NSG на основе тегов службы, которые разрешают исходящий трафик HTTPS на порт 443 для следующих [тегов службы](../virtual-network/service-tags-overview.md#available-service-tags) (которые определяют группы IP-адресов):

**Тег** | **Разрешить** 
--- | ---
Тег Storage  |Позволяет записывать данные с виртуальной машины в учетную запись хранения кэша.   
Тег Azure AD | Разрешает доступ ко всем IP-адресам, которые соответствуют Azure AD.   
Тег EventsHub | Разрешает доступ к мониторингу Site Recovery.  
Тег AzureSiteRecovery | Разрешает доступ к службе Site Recovery в любом регионе.   
Тег GuestAndHybridManagement | Используется для автоматического обновления агента службы "Мобильность" Site Recovery, работающего на виртуальных машинах, включенных для репликации.

Дополнительные сведения о необходимых тегах и примеры тегов см. [здесь](azure-to-azure-about-networking.md#outbound-connectivity-using-service-tags).

### <a name="verify-vm-certificates"></a>Проверка сертификатов виртуальных машин

Убедитесь, что виртуальные машины имеют последние корневые сертификаты. В противном случае виртуальную машину не удастся зарегистрировать в Site Recovery из-за ограничений безопасности.

- **Для виртуальных машин Windows**: Установите на виртуальной машине все последние обновления Windows, чтобы гарантировать присутствие всех доверенных корневых сертификатов. При работе в отключенной среде следуйте стандартным процедурам обновления Windows и сертификатов.
- **Для виртуальных машин Linux**: Выполните инструкции распространителя Linux, чтобы установить все последние доверенные корневые сертификаты и список отзыва сертификатов.

## <a name="create-a-recovery-services-vault"></a>Создание хранилища служб восстановления

Создайте хранилище служб восстановления в любом регионе, за исключением исходного региона, из которого вы будете реплицировать виртуальные машины.

1. Войдите на [портале Azure](https://portal.azure.com).
2. В поле поиска введите *восстановление*. В разделе **Службы** щелкните **Хранилища Служб восстановления**.

    ![Поиск хранилищ Служб восстановления](./media/azure-to-azure-tutorial-enable-replication/search.png)

3. В колонке **Хранилища Служб восстановления** выберите **Добавить**.
4. В разделе **Создание хранилища Служб восстановления** > **Основные данные** выберите подписку, в которой нужно создать хранилище.
5. В области **Группа ресурсов** выберите существующую группу ресурсов для хранилища или создайте новую.
6. В поле **Имя хранилища** укажите понятное имя для идентификации хранилища.
7. В области **Регион** выберите регион Azure, в котором будет размещено хранилище. [Проверьте поддерживаемые регионы.](https://azure.microsoft.com/pricing/details/site-recovery/)
8. Выберите **Проверить и создать**.

   ![Параметры хранилища на странице создания нового хранилища](./media/azure-to-azure-tutorial-enable-replication/vault-basics.png)

9. В разделе **Просмотр и создание** щелкните **Создать**.

10. Начнется развертывание хранилища. Следите за ходом выполнения в области уведомлений.
11. Когда развертывание хранилища завершится, щелкните **Закрепить на панели мониторинга**, чтобы сохранить ссылку для быстрого доступа. Щелкните **Перейти к ресурсу**, чтобы открыть новое хранилище. 
    
    ![Кнопки для открытия хранилища после развертывания и закрепления на панели мониторинга](./media/azure-to-azure-tutorial-enable-replication/vault-deploy.png)

### <a name="enable-site-recovery"></a>Включение Site Recovery

В параметрах хранилища выберите **Включить Site Recovery**.

![Настройки для включения Site Recovery в хранилище](./media/azure-to-azure-tutorial-enable-replication/enable-site-recovery.png)

## <a name="enable-replication"></a>Включение репликации

Выберите параметры источника и включите репликацию виртуальной машины. 

### <a name="select-source-settings"></a>Выбор параметров источника

1. На странице **Site Recovery** для хранилища установите в разделе **Виртуальные машины Azure** флажок **Включить репликацию**.

    ![Настройка включения репликации для виртуальных машин Azure](./media/azure-to-azure-tutorial-enable-replication/enable-replication.png)

2. В разделе **Источник**> **Исходное расположение** выберите исходный регион Azure, в котором сейчас работают виртуальные машины.
3. В разделе **Модель развертывания виртуальных машин Azure** сохраните значение по умолчанию **Диспетчер ресурсов**.
4. В разделе **Исходная подписка** выберите подписку, в которой сейчас работают виртуальные машины. Здесь можно выбрать любую подписку из того же клиента Azure Active Directory (AD), где расположено хранилище.
5. В поле **Исходная группа ресурсов** выберите группу ресурсов, которая содержит виртуальные машины.
6. В поле **Аварийное восстановление между зонами доступности** сохраните значение по умолчанию **Нет**.

     ![Настройка источника](./media/azure-to-azure-tutorial-enable-replication/source.png)

7. Выберите **Далее**.

### <a name="select-the-vms"></a>Выбор виртуальных машин

Служба Site Recovery получит список виртуальных машин, связанных с выбранными подпиской и группой ресурсов.

1. В разделе **Виртуальные машины** выберите виртуальные машины, для которых вы намерены включить аварийное восстановление.

     ![Страница выбора виртуальных машин для репликации](./media/azure-to-azure-tutorial-enable-replication/select-vm.png)

2. Выберите **Далее**.

### <a name="review-replication-settings"></a>Проверка параметров репликации

1. В разделе **Параметры репликации** проверьте введенные значения. Site Recovery создает стандартные параметры и политику для целевого региона. Для целей этого руководства мы сохраним эти значения по умолчанию.
2. Выберите **Включить репликацию**.

    ![Страница для настройки параметров и включения репликации](./media/azure-to-azure-tutorial-enable-replication/enable-vm-replication.png)   

3. Отслеживать ход репликации можно в разделе уведомлений.

     ![Отслеживание выполнения в разделе уведомлений](./media/azure-to-azure-tutorial-enable-replication/notification.png) ![Отслеживание уведомлений об успешном выполнении репликации](./media/azure-to-azure-tutorial-enable-replication/notification-success.png)

4. Включенные виртуальные машины отображаются на странице **Реплицированные элементы** для хранилища.

    ![Виртуальная машина на странице "Реплицированные элементы"](./media/azure-to-azure-tutorial-enable-replication/replicated-items.png)


## <a name="next-steps"></a>Дальнейшие действия

В рамках этого руководства вы включили аварийное восстановление для виртуальной машины Azure. Теперь выполните тест и убедитесь, что отработка отказа работает должным образом.

> [!div class="nextstepaction"]
> [Выполнение отработки аварийного восстановления](azure-to-azure-tutorial-dr-drill.md)
