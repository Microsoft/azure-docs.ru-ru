---
title: Интеграция аварийного восстановления виртуальной машины Azure ExpressRoute с Azure Site Recovery
description: Описывается, как настроить аварийное восстановление виртуальных машин Azure с помощью Azure Site Recovery и Azure ExpressRoute.
services: site-recovery
author: mayurigupta13
manager: rochakm
ms.service: site-recovery
ms.topic: conceptual
ms.date: 04/08/2019
ms.author: mayg
ms.openlocfilehash: 0e1f670f2ba5ad31f29d56b2de40acd6e2bf18a9
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "88654384"
---
# <a name="integrate-expressroute-with-disaster-recovery-for-azure-vms"></a>Интеграция ExpressRoute с аварийным восстановлением для виртуальных машин Azure


В этой статье описывается, как интегрировать Azure ExpressRoute с [Azure Site Recovery](site-recovery-overview.md) при настройке аварийного восстановления виртуальных машин Azure в дополнительный регион Azure.

Site Recovery позволяет выполнять аварийное восстановление виртуальных машин Azure с помощью репликации данных виртуальных машин Azure в Azure.

- Если виртуальные машины Azure используют [управляемые диски Azure](../virtual-machines/managed-disks-overview.md), то данные виртуальных машин реплицируются на реплицированные управляемые диски в дополнительном регионе.
- Если виртуальные машины Azure не используют управляемые диски, то данные виртуальных машин реплицируются в учетную запись хранения Azure.
- Конечные точки репликации являются общедоступными, но трафик репликации виртуальных машин Azure не проходит через Интернет.

ExpressRoute позволяет перенести локальные сети в облако Microsoft Azure по частному подключению, которое обеспечивается поставщиком услуг подключения. Если у вас настроен канал ExpressRoute, он интегрируется с Site Recovery следующим образом.

- **Во время репликации между регионами Azure**. Трафик репликации для аварийного восстановления виртуальных машин Azure передается в пределах Azure, и подключение ExpressRoute не требуется или не используется для репликации. Тем не менее, если выполняется подключение с локального сайта к виртуальным машинам Azure на основном сайте Azure, существует ряд проблем, которые следует учитывать при настройке аварийного восстановления этих виртуальных машин Azure.
- **Отработка отказа между регионами Azure**. При возникновении сбоев выполняется отработка отказа виртуальных машин Azure из основного региона в дополнительный регион Azure. После отработки отказа в дополнительный регион следует выполнить ряд действий, чтобы получить доступ к виртуальным машинам Azure в дополнительном регионе с помощью ExpressRoute.


## <a name="before-you-begin"></a>Перед началом

Прежде чем начать, ознакомьтесь со следующими понятиями:

- [Каналы](../expressroute/expressroute-circuit-peerings.md) ExpressRoute
- [Домены маршрутизации](../expressroute/expressroute-circuit-peerings.md#routingdomains) ExpressRoute
- [Расположения](../expressroute/expressroute-locations.md)ExpressRoute.
- [архитектура репликации](azure-to-azure-architecture.md) виртуальных машин Azure;
- [настройка репликации](azure-to-azure-tutorial-enable-replication.md) для виртуальных машин Azure;
- [отработка отказа](azure-to-azure-tutorial-failover-failback.md) виртуальных машин Azure.


## <a name="general-recommendations"></a>Основные рекомендации

Чтобы обеспечить эффективное целевое время восстановления (RTO) для аварийного восстановления при настройке Site Recovery для интеграции с ExpressRoute, рекомендуется сделать следующее.

- Подготовьте сетевые компоненты до отработки отказа в дополнительный регион.
    - При включении репликации для виртуальных машин Azure служба Site Recovery может автоматически развертывать сетевые ресурсы, например сети, подсети и шлюзы, в целевом регионе Azure на основе параметров исходной сети.
    - Site Recovery не может автоматически настраивать сетевые ресурсы, например шлюзы виртуальной сети.
    - Мы рекомендуем подготовить эти дополнительные сетевые ресурсы перед выполнением отработки отказа. Это развертывание может вызвать небольшой простой, что может повлиять на общее время восстановления, если вы не учли его при планировании развертывания.
- Регулярная отработка аварийного восстановления.
    - Проверка отработки позволяет проверить стратегию репликации без потери данных и простоя и не влияет на рабочую среду. Это позволяет избежать проблем конфигурации, возникающих в последнюю минуту, которые могут отрицательно отразиться на значении RTO.
    - При выполнении тестовой отработки отказа мы рекомендуем использовать отдельную сеть виртуальных машин Azure, а не сеть по умолчанию, настроенную для репликации.
- Используйте разные диапазоны IP-адресов, если используется отдельный канал ExpressRoute.
    - Мы рекомендуем использовать разные диапазоны IP-адресов для целевой виртуальной сети. Это позволяет избежать проблем при установлении подключений во время региональных сбоев.
    - Если нет возможности использовать отдельный диапазон адресов, обязательно используйте для тестовой отработки отказа для аварийного восстановления отдельную тестовую сеть с другими IP-адресами. Невозможно подключить две виртуальные сети с перекрывающимися диапазона IP-адресов к одному каналу ExpressRoute.

## <a name="replicate-azure-vms-when-using-expressroute"></a>Репликация виртуальных машин в Azure с помощью ExpressRoute


Если вы хотите настроить репликацию виртуальных машин Azure на основном сайте и для подключения к этим виртуальным машинам с локального сайта используется ExpressRoute, необходимо сделать следующее.

1. [Включите репликацию](azure-to-azure-tutorial-enable-replication.md) для каждой виртуальной машины Azure.
2. При необходимости разрешите Site Recovery настроить сетевые подключения.
    - При настройке и включении репликации Site Recovery настраивает, подсети и подсети шлюза в целевом регионе Azure в соответствии с инфраструктурой в исходном регионе. Site Recovery также сопоставляет исходную и целевую виртуальные сети.
    - Если вы не хотите, чтобы служба Site Recovery выполняла это автоматически, создайте сетевые ресурсы на целевой стороне перед включением репликации.
3. Создайте другие сетевые элементы.
    - Site Recovery не создает таблицы маршрутов, шлюзы виртуальной сети, подключения шлюза виртуальной сети, пиринг виртуальных сетей или другие сетевые ресурсы и подключения в дополнительном регионе.
    - Вам нужно создать эти дополнительные сетевые элементы в дополнительном регионе в любое время до запуска отработки отказа из основного региона.
    - Чтобы настроить и подключить эти сетевые ресурсы, можно использовать [планы восстановления](site-recovery-create-recovery-plans.md) и сценарии автоматизации.
1. Если используется виртуальный сетевой модуль (NVA), развернутый для управления потоком сетевого трафика, обратите внимание на следующее.
    - Для репликации виртуальных машин Azure платформа Azure по умолчанию использует системный маршрут 0.0.0.0/0.
    - В развертывании с виртуальным сетевым модулем обычно определяется маршрут по умолчанию (0.0.0.0/0), который передает на виртуальный сетевой модуль весь направленный в Интернет исходящий трафик. Маршрут по умолчанию используется в том случае, если не удалось найти иную конфигурацию маршрута.
    - В этом случае NVA может быть перегружен, если весь трафик репликации проходит через него.
    - Это ограничение действует и для маршрутов по умолчанию, которые направляют весь трафик виртуальных машин Azure к локальным развертываниям.
    - В этом случае рекомендуется [создать конечную точку сетевой службы](azure-to-azure-about-networking.md#create-network-service-endpoint-for-storage) в виртуальной сети службы Microsoft.Storage, чтобы трафик репликации не покидал границ Azure.

## <a name="replication-example"></a>Пример репликации

В типичных корпоративных развертываниях рабочие нагрузки распределяются по нескольким виртуальным сетям Azure, а центральный концентратор поддерживает все внешние подключения к Интернету и локальным сайтам. Топология типа "звезда" обычно используется с каналами ExpressRoute.

![Подключение ExpressRoute между локальной средой и Azure до отработки отказа](./media/azure-vm-disaster-recovery-with-expressroute/site-recovery-with-expressroute-before-failover.png)

- **Регион**. Приложения развертываются в регионе Azure "Восточная Азия".
- **Лучевой виртуальных сетей**. Приложения развертываются в двух периферийных виртуальных сетях:
    - **исходная сеть vNet1**: 10.1.0.0/24;
    - **исходная сеть vNet2**: 10.2.0.0/24.
    - Каждая периферийная виртуальная сеть подключена к **центральной виртуальной сети**.
- **Виртуальная сеть концентратора**. **Исходная центральная виртуальная сеть**: 10.10.10.0/24.
  - Эта центральная виртуальная сеть выступает в роли привратника.
  - Весь обмен данными между подсетями происходит через нее.
    - **Подсети VNet концентратора**. Центральная виртуальная сеть содержит две подсети:
    - **подсеть NVA**: 10.10.10.0/25. Эта подсеть содержит виртуальный сетевой модуль (10.10.10.10).
    - **Подсеть шлюза**: 10.10.10.128/25. Эта подсеть содержит шлюз ExpressRoute, подключенный к каналу ExpressRoute, по которому данные передаются на локальный сайт через домен маршрутизации с частным пирингом.
- В локальном центре обработки данных создается подключение ExpressRoute через партнерский пограничный сервер в Гонконге.
- Управление всей маршрутизацией осуществляется с помощью таблиц маршрутов Azure (UDR).
- Весь исходящий трафик, передаваемый между виртуальными сетями или в локальный центр обработки данных, направляется через виртуальный сетевой модуль.

### <a name="hub-and-spoke-peering-settings"></a>Параметры пиринга между центральной и периферийными сетями

#### <a name="spoke-to-hub"></a>Из периферийной сети в центральную

**Направление** | **Параметр** | **Состояние**
--- | --- | ---
Из периферийной сети в центральную | Allow virtual network address (Разрешить адрес виртуальной сети) | Активировано
Из периферийной сети в центральную | Разрешить перенаправленный трафик | Активировано
Из периферийной сети в центральную | Разрешить транзит шлюзов | Выключено
Из периферийной сети в центральную | Использовать удаленные шлюзы | Активировано

 ![Конфигурация пиринга от периферийной сети к концентратору](./media/azure-vm-disaster-recovery-with-expressroute/spoke-to-hub-peering-configuration.png)

#### <a name="hub-to-spoke"></a>Из центральной сети в периферийную

**Направление** | **Параметр** | **Состояние**
--- | --- | ---
Из центральной сети в периферийную | Allow virtual network address (Разрешить адрес виртуальной сети) | Активировано
Из центральной сети в периферийную | Разрешить перенаправленный трафик | Активировано
Из центральной сети в периферийную | Разрешить транзит шлюзов | Активировано
Из центральной сети в периферийную | Использовать удаленные шлюзы | Выключено

 ![Конфигурация пиринга от концентратора к периферийной сети](./media/azure-vm-disaster-recovery-with-expressroute/hub-to-spoke-peering-configuration.png)

### <a name="example-steps"></a>Примеры действий

В нашем примере при включении репликации для виртуальных машин Azure в исходной сети должно произойти следующее.

1. Вы [включаете репликацию](azure-to-azure-tutorial-enable-replication.md) для виртуальной машины.
2. Site Recovery создаст реплики виртуальных сетей, подсетей и подсетей шлюза в целевом регионе.
3. Служба Site Recovery сопоставит исходные сети и реплицируемые целевые сети, которые она создает.
4. Вы вручную создаете таблицы маршрутов, шлюзы виртуальной сети, подключения через шлюз виртуальной сети, пиринг виртуальной сети и любые другие сетевые ресурсы или подключения.


## <a name="fail-over-azure-vms-when-using-expressroute"></a>Отработка отказа виртуальных машин в Azure с помощью ExpressRoute

После отработки отказа виртуальных машин Azure в целевой регион Azure с помощью Site Recovery они будут доступны с помощью [частного пиринга](../expressroute/expressroute-circuit-peerings.md#privatepeering) ExpressRoute.

- Требуется подключить ExpressRoute к целевой виртуальной сети с помощью нового подключения. Существующее подключение ExpressRoute не перенастраивается автоматически.
- Способ настройки подключения ExpressRoute к целевой виртуальной сети зависит от топологии ExpressRoute.


### <a name="access-with-two-circuits"></a>Доступ по двум каналам

#### <a name="two-circuits-with-two-peering-locations"></a>Два канала с двумя расположениями пиринга

Эта конфигурация помогает защитить каналы ExpressRoute от региональных аварий. Если произойдет авария в основном расположении пиринга, подключения смогут функционировать из другого расположения.

- Канал, подключенный к рабочей среде, обычно является основным. Дополнительный канал обычно имеет меньшую пропускную способность, которую можно увеличить в случае аварии.
- После отработки отказа можно установить подключения из дополнительного канала ExpressRoute к целевой виртуальной сети. Кроме того, можно заранее настроить и подготовить подключения на случай аварии, чтобы уменьшить общее время восстановления.
- Если подключения к основной и целевой виртуальным сетям существуют одновременно, обязательно настройте локальную маршрутизацию таким образом, чтобы дополнительный канал и подключение использовались только после отработки отказа.
- После отработки отказа исходная и целевая виртуальные сети могут получить новые IP-адреса или использовать прежние. В обоих вариантах есть возможность установить дополнительные подключения до отработки отказа.


#### <a name="two-circuits-with-single-peering-location"></a>Два канала с одним расположением пиринга

Эта конфигурация помогает защититься от сбоя основного канала ExpressRoute, но не в случае аварии единственного расположения пиринга ExpressRoute, которая влияет на оба канала.

- Вы можете использовать несколько одновременных подключений из локального центра обработки данных: основной канал для связи с исходной виртуальной сетью и дополнительный канал для связи с целевой виртуальной сетью.
- Если подключения к основной и целевой виртуальным сетям существуют одновременно, обязательно настройте локальную маршрутизацию таким образом, чтобы дополнительный канал и подключение использовались только после отработки отказа.
-   Невозможно подключить оба канала к одной виртуальной сети, если они созданы в одном расположении пиринга.

### <a name="access-with-a-single-circuit"></a>Доступ с помощью одного канала

В этой конфигурации имеется только один канал ExpressRoute. Несмотря на то, что у канала имеется избыточное подключение на случай аварии, канал с одним маршрутом не обеспечивает устойчивость при аварии региона пиринга. Обратите внимание на следующее.

- Виртуальные машины Azure можно реплицировать в любой регион Azure, расположенный в [том же географическом расположении](azure-to-azure-support-matrix.md#region-support). Если целевой регион Azure не находится в том же расположении, что и исходный регион, необходимо включить ExpressRoute Premium, если вы используете один канал ExpressRoute. Узнайте больше о [расположениях ExpressRoute](../expressroute/expressroute-locations.md) и [ценах на ExpressRoute](https://azure.microsoft.com/pricing/details/expressroute/).
- Невозможно одновременно подключить к каналу исходную и целевую виртуальные сети, если в целевом регионе используется такой же диапазон IP-адресов. В этом сценарии:    
    -  Разорвите подключение на стороне источника, а затем создайте подключение на стороне цели. Такую логику переключения можно реализовать в сценариях плана восстановления Site Recovery. Обратите внимание на следующее.
        - Если региональный сбой приведет к недоступности основного региона, операция отключения завершится неудачей. Это может повлиять на создание подключения к целевому региону.
        - Если подключение к целевому региону будет создано, а после этого восстановится подключение к основному региону, попытка одновременного подключения к двум одинаковым диапазонами адресов может привести к потере пакетов.
        - Чтобы избежать этого, немедленно завершите основное подключение.
        - Когда для виртуальных машин будет восстановлено размещение в основной регион, можно будет возобновить основное подключение, но только после отключения дополнительного подключения.
-   Если в целевой виртуальной сети используется другой диапазон адресов, можно подключить один канал ExpressRoute одновременно к исходной и целевой виртуальным сетям.


## <a name="failover-example"></a>Пример отработки отказа

В примере мы используем следующую топологию.

- Два канала ExpressRoute в двух разных расположениях пиринга.
- Сохранение частных IP-адресов для виртуальных машин Azure после отработки отказа.
- Целевой регион Azure для восстановления — "Юго-Восточная Азия".
- Дополнительный канал ExpressRoute подключается через партнерский пограничный сервер в Сингапуре.

Простая топология, которая использует один канал ExpressRoute и сохраняет IP-адрес после отработки отказа, [описана в этой статье](site-recovery-retain-ip-azure-vm-failover.md#hybrid-resources-full-failover).

### <a name="example-steps"></a>Примеры действий
Чтобы автоматизировать восстановление в этом примере, нужно сделать следующее.

1. Следуйте инструкциям по настройке репликации.
2. Осуществите [отработку отказа виртуальных машин Azure](azure-to-azure-tutorial-failover-failback.md), выполнив описанные ниже дополнительные действия во время или после отработки отказа.

    а. Создайте шлюз Azure ExpressRoute в центральной виртуальной сети в целевом регионе. Он необходим для подключения центральной виртуальной сети в целевом регионе к каналу ExpressRoute.

    b. Создайте подключение центральной виртуальной сети в целевом регионе к целевому каналу ExpressRoute.

    c. Настройте пиринг виртуальных сетей между виртуальной сетью концентратора и периферийными виртуальными сетями в целевом регионе. Для пиринга в целевом регионе укажите такие же параметры, как и в исходном регионе.

    d. Настройте определяемые пользователем маршруты в виртуальной сети концентратора и в обоих периферийных виртуальных сетях.

    - Если используются те же IP-адреса, то для определяемых пользователем маршрутов в целевом регионе укажите такие же параметры, как и в исходном регионе.
    - Если в целевом регионе IP-адреса отличаются, необходимо соответствующим образом скорректировать определяемые пользователем маршруты.


Описанные выше шаги можно реализовать в скриптах [плана восстановления](site-recovery-create-recovery-plans.md). Если ваше приложение имеет высокие требования к наличию подключений и времени восстановления, указанные выше шаги можно выполнять перед началом отработки отказа.

#### <a name="after-recovery"></a>После восстановления

После восстановления виртуальных машин и подключений среда восстановления выглядит следующим образом.

![Подключение ExpressRoute между локальной средой и Azure после отработки отказа](./media/azure-vm-disaster-recovery-with-expressroute/site-recovery-with-expressroute-after-failover.png)



## <a name="next-steps"></a>Дальнейшие действия

Узнайте больше об использовании [планов восстановления](site-recovery-create-recovery-plans.md) для автоматизации отработки отказа.
