---
title: Настройка IP-адресов после отработки отказа на дополнительный сайт с Azure Site Recovery
description: Сведения о том, как настроить IP-адреса для подключения к виртуальным машинам на второй локальной площадке после аварийного восстановления и отработки отказа с помощью Azure Site Recovery.
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
ms.topic: conceptual
ms.date: 11/12/2019
ms.author: raynew
ms.openlocfilehash: 43942c20a353ff69383f3e721679e4c95ab9d230
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "87495949"
---
# <a name="set-up-ip-addressing-to-connect-to-a-secondary-on-premises-site-after-failover"></a>Настройка назначения IP-адресов для подключения к локальному веб-сайту после отработки отказа

После отработки отказа виртуальных машин Hyper-V в облаках System Center Virtual Machine Manager на дополнительном веб-сайте необходимо подключиться к реплике виртуальных машин. Эта статья поможет вам сделать это. 

## <a name="connection-options"></a>Параметры подключения

Есть несколько способов назначения IP-адресов для реплики виртуальных машин после отработки отказа: 

- **Сохранение того же IP-адреса после отработки отказа**. В этом сценарии реплицированные виртуальные машины имеют тот же IP-адрес, что и основная виртуальная машина. Это упрощает связанные с сетью проблемы после отработки отказа, но требует некоторой работы с инфраструктурой.
- **Использование другого IP-адреса после отработки отказа**. В этом сценарии после отработки отказа виртуальная машина получает новый IP-адрес. 
 

## <a name="retain-the-ip-address"></a>Сохранение IP-адреса

Если вы хотите сохранить IP-адреса с основного сайта, после перехода на другой ресурс можно:

- развернуть растянутую подсеть между основным и вторичным сайтом;
- выполнить полную отработку отказа подсети с основного на дополнительный сайт. Необходимо обновить маршруты, чтобы указать новое расположение IP-адресов.


### <a name="deploy-a-stretched-subnet"></a>Развертывание растянутой подсети

Растянутая конфигурация доступна одновременно для основного и дополнительного сайта. В растянутой подсети при перемещении компьютера и конфигурации его IP-адреса (уровень 3) на дополнительный веб-сайт сеть автоматически направит трафик в новое расположение. 

- С точки зрения уровня 2 (уровень связи данных) требуется сетевое оборудование, с помощью которого можно управлять растянутой виртуальной локальной сетью.
- Растягивая виртуальную локальную сеть, потенциальный домен сбоя расширяется на оба сайта. Это становится единой точкой отказа. Хотя это маловероятно, в таком сценарии вы не сможете изолировать такой инцидент, как сетевая буря. 


### <a name="fail-over-a-subnet"></a>Отработка отказа подсети

Вы можете выполнить отработку отказа в целой подсети, чтобы воспользоваться преимуществами растянутой подсети без фактического растягивания. В этом решении подсеть будет доступна на исходном или целевом сайте, но не на обоих одновременно.

- Чтобы сохранить пространство IP-адресов в случае отработки отказа, программными средствами можно сделать так, чтобы инфраструктура маршрутизаторов перемещала подсети с одного сайта на другой.
- После отработки отказа подсети переместятся в связанные виртуальные машины.
- Основным недостатком этого подхода является то, что в случае сбоя необходимо переместить всю подсеть.

#### <a name="example"></a>Пример

Ниже приведен пример полной отработки отказа подсети. 

- Перед отработкой отказа на основном объекте приложения работают в подсети 192.168.1.0/24.
- Во время отработки отказа все виртуальные машины в этой подсети переносятся на дополнительный сайт с сохранением IP-адресов. 
- Маршруты между всеми веб-сайтами необходимо изменить, чтобы указать, что все виртуальные машины в подсети 192.168.1.0/24 теперь перемещены на дополнительный сайт.

На следующем рисунке показаны подсети до и после отработки отказа:


**До отработки отказа**

![Схема, показывающая подсети перед отработкой отказа.](./media/hyper-v-vmm-networking/network-design2.png)

**После отработки отказа**

![Схема, показывающая подсети после отработки отказа.](./media/hyper-v-vmm-networking/network-design3.png)

После отработки отказа Site Recovery выделяет IP-адреса для каждого сетевого интерфейса виртуальной машины. Адрес назначается из пула статических IP-адресов в соответствующей сети для каждого экземпляра виртуальной машины.

- Если пул IP-адресов на дополнительном сайте совпадает с пулом на исходном, Site Recovery выделяет виртуальной машине реплики одинаковые IP-адреса (исходной виртуальной машины). IP-адрес резервируется в VMM, но он не задан как IP-адрес для отработки отказа на узле Hyper-V. IP-адрес отработки отказа задается на узле Hyper-V непосредственно перед отработкой отказа.
- Если же IP-адрес недоступен, Site Recovery выделяет другой доступный адрес из пула.
- Если виртуальные машины используют DHCP, Site Recovery не управляет IP-адресами. Убедитесь, что DHCP-сервер на дополнительном сайте может выделить адрес из того же диапазона, как и на исходном сайте.

### <a name="validate-the-ip-address"></a>Проверка IP-адреса

После включения защиты для виртуальной машины воспользуйтесь следующим примером сценария, чтобы проверить назначенный ей адрес. Этот IP-адрес будет задан в качестве IP-адреса отработки отказа и назначен виртуальной машине во время отработки отказа:

```powershell
$vm = Get-SCVirtualMachine -Name <VM_NAME>
$na = $vm[0].VirtualNetworkAdapters>
$ip = Get-SCIPAddress -GrantToObjectID $na[0].id
$ip.address
```

## <a name="use-a-different-ip-address"></a>Использование другого IP-адреса

В этом сценарии IP-адреса виртуальных машин, для которых выполняется отработка отказа, изменяются. Недостаток этого решения — необходимость в обслуживании.  Вам может потребоваться обновить записи DNS и кэша. Это может привести к простою, который можно устранить следующим образом:

- Используйте низкие значения срока жизни для приложений интрасети.
- Используйте следующий сценарий в плане восстановления Site Recovery, чтобы своевременно обновить DNS-сервер. Сценарий не требуется, если используется динамическая регистрация DNS.

    ```powershell
    param(
    string]$Zone,
    [string]$name,
    [string]$IP
    )
    $Record = Get-DnsServerResourceRecord -ZoneName $zone -Name $name
    $newrecord = $record.clone()
    $newrecord.RecordData[0].IPv4Address  =  $IP
    Set-DnsServerResourceRecord -zonename $zone -OldInputObject $record -NewInputObject $Newrecord
    ```
    
### <a name="example"></a>Пример 

В этом примере у нас есть разные IP-адреса на основных и дополнительных сайтах, а также имеется третий сайт, с которого можно получить доступ к приложениям, размещенным на основном сайте или сайте восстановления.

- Перед отработкой отказа приложения размещаются в подсети 192.168.1.0/24 на главном сайте.
- После отработки отказа приложения будут настроены в подсети 172.16.1.0/24 на дополнительном сайте.
- Все три веб-сайта могут обращаться друг к другу.
- После отработки отказа приложения будут восстановлены в подсети восстановления.
- В этом сценарии не нужно выполнять отработку отказа всей подсети, а также вносить изменения для перенастройки VPN или сетевых маршрутов. Отработка отказа и некоторые обновления DNS обеспечивают доступность приложений.
- Если DNS настроен для разрешения динамических обновлений, после запуска по завершении отработки отказа виртуальные машины зарегистрируются, используя новый IP-адрес.

**До отработки отказа**

![Схема, показывающая различные IP-адреса перед отработкой отказа.](./media/hyper-v-vmm-networking/network-design10.png)

**После отработки отказа**

![Диаграмма, показывающая различные IP-адреса после отработки отказа.](./media/hyper-v-vmm-networking/network-design11.png)


## <a name="next-steps"></a>Дальнейшие действия

[Запуск отработки отказа](hyper-v-vmm-failover-failback.md)

