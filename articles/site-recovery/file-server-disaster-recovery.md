---
title: Защита файлового сервера с помощью Azure Site Recovery
description: В этой статье описывается защита файлового сервера с помощью Azure Site Recovery.
author: Sharmistha-Rai
manager: rochakm
ms.service: site-recovery
ms.topic: conceptual
ms.date: 07/31/2019
ms.author: sharrai
ms.custom: mvc
ms.openlocfilehash: 9cef163c1b53360222ca32a827552fa361e9dd40
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "98874253"
---
# <a name="protect-a-file-server-by-using-azure-site-recovery"></a>Защита файлового сервера с помощью Azure Site Recovery 

Служба [Azure Site Recovery](site-recovery-overview.md) помогает реализовать стратегию непрерывности бизнес-процессов и аварийного восстановления (BCDR), обеспечивая работоспособность бизнес-приложений во время запланированных и незапланированных простоев. Site Recovery управляет аварийным восстановлением локальных компьютеров и виртуальных машин Azure. Аварийное восстановление включает операции репликации, отработки отказа и восстановления различных рабочих нагрузок.

Эта статья содержит сведения о защите файлового сервера с помощью Site Recovery, а также другие рекомендации в соответствии с различными средами. 

- [Рекомендации по аварийному восстановлению для виртуальных машин IaaS Azure](#disaster-recovery-recommendation-for-azure-iaas-virtual-machines)
- [Репликация локального файлового сервера с помощью Site Recovery](#replicate-an-on-premises-file-server-by-using-site-recovery)

## <a name="file-server-architecture"></a>Архитектура файлового сервера
Открытая распределенная система для совместной работы с файлами предоставляет среду, в которой группа географически распределенных пользователей может взаимодействовать для эффективной работы с файлами, а также обеспечивает целостность этих данных. Стандартная локальная экосистема файлового сервера, которая поддерживает большое число одновременных пользователей и элементов содержимого, использует репликацию распределенной файловой системы (DFSR) для планирования репликации и регулирования пропускной способности. 

DFSR применяет алгоритм сжатия (известный как удаленное разностное сжатие (RDC)), с помощью которого можно эффективно обновлять файлы в сети с ограниченной пропускной способностью. Он обнаруживает операции вставки, удаления и перераспределения данных в файлах. DFSR может реплицировать только измененные блоки файлов при обновлении файлов. Существуют также среды файловых серверов, где ежедневные резервные копии создаются в периоды низкой нагрузки и используются для аварийных потребностей. Реализация DFSR отсутствует.

На следующей схеме показана среда файлового сервера с реализованным DFSR.
        
![Архитектура DFSR](media/site-recovery-file-server/dfsr-architecture.JPG)

На приведенной выше схеме несколько файловых серверов, называемых участниками, активно участвуют в репликации файлов в группе репликации. Содержимое в реплицированной папке доступно всем клиентам, отправляющим запросы любому участнику, даже если он находится вне сети.

## <a name="disaster-recovery-recommendations-for-file-servers"></a>Рекомендации по аварийному восстановлению для файловых серверов

* **Реплицируйте файловый сервер с помощью Site Recovery**. Файловый сервер можно реплицировать в Azure с помощью Site Recovery. Если один или несколько локальных файловых серверов недоступны, в Azure можно запустить виртуальные машины восстановления. Они могут локально обрабатывать запросы от клиентов при условии, что имеется VPN-подключение "сеть — сеть" и в Azure настроена служба Active Directory. Этот метод можно использовать при наличии настроенной среды DFSR или простой среды файлового сервера без DFSR. 

* **Распространите DFSR на виртуальных машинах IaaS Azure**. В кластеризованной среде файлового сервера с реализованной репликацией DFSR можно распространить локальную DFSR в Azure. Затем виртуальная машина Azure может выполнять роль файлового сервера. 

    * Если зависимости VPN-подключения "сеть — сеть" и Active Directory настроены, а репликация DFSR реализована, то когда один или несколько локальных файловых серверов недоступны, клиенты могут подключаться к виртуальной машине Azure, которая будет обрабатывать запросы.

    * Вы можете использовать этот подход, если на виртуальных машинах настроены конфигурации, которые Site Recovery не поддерживает. Например, общий диск кластера, который часто используется в средах файловых серверов. DFSR также хорошо работает в средах с низкой пропускной способностью и средней скоростью изменения данных. Необходимо учитывать дополнительные затраты на виртуальную машину Azure, которая будет работать все время. 

* **Используйте синхронизация файлов Azure для репликации файлов**. Если вы планируете использовать облако или уже используете виртуальную машину Azure, можно использовать Синхронизация файлов Azure. Синхронизация файлов Azure предлагает синхронизацию полностью управляемых файловых ресурсов в облаке, которые доступны [через стандартный промышленный протокол SMB.](/windows/win32/fileio/microsoft-smb-protocol-and-cifs-protocol-overview) Файловые ресурсы Azure можно затем одновременно подключить к облачным или локальным развертываниям Windows, Linux и macOS. 

Ниже представлена схема, которая помогает определить стратегию для использования в среде файлового сервера.

![Дерево решений](media/site-recovery-file-server/decisiontree.png)


### <a name="factors-to-consider-in-your-decisions-about-disaster-recovery-to-azure"></a>Факторы, на которые стоит обратить внимание при выборе решения для аварийного восстановления в Azure

|Среда  |Рекомендация  |Что необходимо учесть |
|---------|---------|---------|
|Среда файлового сервера с или без DFSR|   [Для репликации используйте Site Recovery](#replicate-an-on-premises-file-server-by-using-site-recovery)   |    Site Recovery не поддерживает кластеры общих дисков или запоминающее устройство, подключаемое к сети (NAS). Если в вашей среде используются эти конфигурации, при необходимости используйте любой из других подходов. <br> Site Recovery не поддерживает SMB 3.0. Реплицируемая виртуальная машина внедряет изменения, только когда внесенные в файлы изменения обновлены в исходном расположении файлов.<br>  Site Recovery предлагает синхронный процесс репликации данных и, следовательно, в случае незапланированной отработки отказа может привести к потере данных и может привести к проблемам несоответствия USN.
|Среда файлового сервера с DFSR     |  [Распространение DFSR на виртуальную машину IaaS Azure](#extend-dfsr-to-an-azure-iaas-virtual-machine)  |    DFSR хорошо работает в средах с очень сжатой пропускной способностью. Этот подход требует наличия виртуальной машины Azure, которая все время запущена. Необходимо учитывать стоимость виртуальной машины при планировании.         |
|Виртуальная машина IaaS Azure     |     Синхронизация файлов Azure    |     В сценарии аварийного восстановления при использовании службы синхронизации файлов во время отработки отказа необходимо выполнить действия вручную, чтобы убедиться, что общие файловые ресурсы доступны на клиентском компьютере прозрачным образом. Для службы синхронизации файлов необходимо открыть порт 445 с клиентского компьютера.     |


### <a name="site-recovery-support"></a>Поддержка Site Recovery
Так как репликация Site Recovery не зависит от приложения, эти рекомендации подходят для сценариев, представленных ниже.

| Источник  |На дополнительный сайт  |В Azure
|---------|---------|---------|
|Azure|  -|Да|
|Hyper-V|  Да  |Да
|VMware  |Да|  Да
|Физический сервер|  Да  |Да
 

> [!IMPORTANT]
> Прежде чем продолжить работу с одним из указанных ниже подходов, убедитесь, что выполнены следующие зависимости.



**Подключение "сеть — сеть".** Необходимо установить прямое соединение между локальным сайтом и сетью Azure, чтобы разрешить обмен данными между серверами. Используйте защищенное подключение VPN "сеть — сеть" к виртуальной сети Azure, которая выступает в качестве сайта аварийного восстановления. Дополнительные сведения см. в статье [Создание подключения типа "сеть — сеть" на портале Azure](../vpn-gateway/tutorial-site-to-site-portal.md).

**Active Directory.** DFSR зависит от Active Directory. Это означает, что лес Active Directory с локальными контроллерами домена распространяется на сайт аварийного восстановления в Azure. Даже если вы не используете DFSR, а предполагаемым пользователям нужно предоставить доступ, необходимо выполнить эти действия. Дополнительные сведения см. в статье [Защита Active Directory и DNS с помощью Azure Site Recovery](./site-recovery-active-directory.md).

## <a name="disaster-recovery-recommendation-for-azure-iaas-virtual-machines"></a>Рекомендации по аварийному восстановлению для виртуальных машин IaaS Azure

Если вы настраиваете аварийное восстановление файловых серверов, размещенных на виртуальных машинах IaaS Azure, и управляете им, можно выбрать один из двух вариантов, в зависимости от того, хотите ли вы использовать [службу файлов Azure](../storage/files/storage-files-introduction.md).

* [Использование службы синхронизации файлов](#use-file-sync-to-replicate-files-hosted-on-an-iaas-virtual-machine)
* [Использование Site Recovery](#replicate-an-iaas-file-server-virtual-machine-by-using-site-recovery)

## <a name="use-file-sync-to-replicate-files-hosted-on-an-iaas-virtual-machine"></a>Использование службы синхронизации файлов для репликации файлов, размещенных на виртуальной машине IaaS

Службу файлов Azure можно использовать для полной замены или дополнения традиционных локальных файловых серверов или устройств NAS. Общие ресурсы службы файлов Azure также можно реплицировать с помощью службы синхронизации файлов на локальные или облачные серверы Windows Server для высокопроизводительного и распределенного кэширования данных в месте их использования. В указанных ниже действиях подробно описаны рекомендации по аварийному восстановлению для виртуальных машин Azure, которые позволяют реализовать те же возможности, что и обычные файловые серверы.
* Включите защиту компьютеров с помощью Site Recovery. Выполните действия, указанные в статье [Репликация виртуальной машины Azure в другой регион Azure (предварительная версия)](azure-to-azure-quickstart.md).
* Используйте службу синхронизации файлов для репликации файлов из виртуальной машины, выполняющей функции файлового сервера, в облако.
* Используйте функцию [плана восстановления](site-recovery-create-recovery-plans.md) Site Recovery, чтобы добавить скрипты для [подключения общей папки Azure](../storage/files/storage-how-to-use-files-windows.md) и получить доступ к этой папке на виртуальной машине.

Указанные ниже действия содержат краткие сведения об использовании службы синхронизации файлов.

1. [Создайте учетную запись хранения в Azure](../storage/common/storage-account-create.md?toc=/azure/storage/files/toc.json). Если вы выбрали геоизбыточное хранилище с доступом на чтение для учетных записей хранения, то в случае сбоя у вас будет доступ только на чтение к своим данным из дополнительного региона. Дополнительные сведения см. в статье [Аварийное восстановление и отработка отказа учетной записи хранения](../storage/common/storage-disaster-recovery-guidance.md?toc=%2fazure%2fstorage%2ffiless%2ftoc.json).
2. [Создайте общую папку](../storage/files/storage-how-to-create-file-share.md).
3. [Запустите службу синхронизации файлов](../storage/files/storage-sync-files-deployment-guide.md) на файловом сервере Azure.
4. Создайте группу синхронизации. Конечные точки в группе синхронизации синхронизируются. Группа синхронизации должна содержать по крайней мере одну облачную конечную точку, которая представляет собой общий файловый ресурс Azure. Кроме того, она должна содержать одну серверную конечную точку, которая представляет собой путь в Windows Server.
5. Теперь ваши файлы синхронизируются между общими файловыми ресурсами Azure и локальным сервером.
6. В случае аварии в локальной среде выполните отработку отказа, используя [план восстановления](site-recovery-create-recovery-plans.md). Добавьте скрипт, чтобы [подключить общий файловый ресурс Azure](../storage/files/storage-how-to-use-files-windows.md) и получить доступ к нему на виртуальной машине.

### <a name="replicate-an-iaas-file-server-virtual-machine-by-using-site-recovery"></a>Репликация виртуальной машины файлового сервера IaaS с помощью Site Recovery

При наличии локальных клиентов, обращающихся к виртуальным машинам файлового сервера IaaS, выполните все следующие действия. В противном случае перейдите к шагу 3.

1. Установите VPN-подключение "сеть — сеть" между локальным сайтом и сетью Azure.
2. Распространите локальную службу Active Directory.
3. [Настройте аварийное восстановление](azure-to-azure-tutorial-enable-replication.md) компьютера файлового сервера IaaS в дополнительный регион.


Дополнительные сведения об аварийном восстановлении в дополнительном регионе см. в статье [Архитектура репликации из Azure в Azure](./azure-to-azure-architecture.md).


## <a name="replicate-an-on-premises-file-server-by-using-site-recovery"></a>Репликация локального файлового сервера с помощью Site Recovery

В следующих действиях описано, как выполнить репликацию виртуальной машины VMware. Пошаговые инструкции по репликации виртуальной машины Hyper-V см. в статье [Настройка аварийного восстановления локальных виртуальных машин Hyper-V в Azure](./hyper-v-azure-tutorial.md).

1. [Подготовка ресурсов Azure](tutorial-prepare-azure.md) для репликации локальных компьютеров.
2. Установите VPN-подключение "сеть — сеть" между локальным сайтом и сетью Azure. 
3. Распространите локальную службу Active Directory.
4. [Подготовка локальных серверов VMware](./vmware-azure-tutorial-prepare-on-premises.md).
5. [Настройте аварийное восстановление](./vmware-azure-tutorial.md) в Azure для локальных виртуальных машин.

## <a name="extend-dfsr-to-an-azure-iaas-virtual-machine"></a>Распространение DFSR на виртуальную машину IaaS Azure

1. Установите VPN-подключение "сеть — сеть" между локальным сайтом и сетью Azure. 
2. Распространите локальную службу Active Directory.
3. [Создайте и подготовьте виртуальную машину файлового севера](../virtual-machines/windows/quick-create-portal.md?toc=%2Fazure%2Fvirtual-machines%2Fwindows%2Ftoc.json) в виртуальной сети Azure.
Убедитесь, что виртуальная машина добавлена в ту же виртуальную сеть Azure, которая имеет перекрестное соединение с локальной средой. 
4. Установите и [настройте DFSR](https://techcommunity.microsoft.com/t5/storage-at-microsoft/dfs-replication-initial-sync-in-windows-server-2012-r2-attack-of/ba-p/424877) в Windows Server.
5. [Реализуйте пространство имен DFS](/windows-server/storage/dfs-namespaces/deploying-dfs-namespaces).
6. Если реализовано пространство имен DFS, отработку отказа общих папок из рабочей среды на сайты аварийного восстановления можно выполнить, обновив целевые объекты папки пространства имен DFS. После репликации изменений пространства имен DFS через Active Directory пользователи будут прозрачно подключены к соответствующим целевым объектам папки.

## <a name="use-file-sync-to-replicate-your-on-premises-files"></a>Использование службы синхронизации файлов для репликации локальных файлов
С помощью службы синхронизации файлов Azure можно реплицировать файлы в облако. В случае сбоя и недоступности локального файлового сервера вы можете подключить нужное расположение файлов из облака и продолжить обрабатывать запросы с клиентских компьютеров.
Для интеграции службы синхронизации файлов с Site Recovery сделайте следующее.

* Включите защиту компьютеров файлового сервера с помощью Site Recovery. Следуйте инструкциям в статье [Настройка аварийного восстановления в Azure для локальных виртуальных машин VMware](./vmware-azure-tutorial.md).
* Используйте службу синхронизации файлов для репликации файлов с компьютеров, выполняющих функции файлового сервера, в облако.
* Используйте функцию плана восстановления в Site Recovery, чтобы добавить скрипты для подключения общей папки Azure на виртуальной машине файлового сервера, для которой выполнена отработка отказа, в Azure.

Ниже приведены указания по использованию службы синхронизации файлов.

1. [Создайте учетную запись хранения в Azure](../storage/common/storage-account-create.md?toc=/azure/storage/files/toc.json). Если вы выбрали геоизбыточное хранилище с доступом на чтение (рекомендуется) для учетных записей хранения, то у вас будет доступ только на чтение к своим данным из дополнительного региона в случае сбоя. Дополнительные сведения см. в статье [Аварийное восстановление и отработка отказа учетной записи хранения](../storage/common/storage-disaster-recovery-guidance.md?toc=%2fazure%2fstorage%2ffiless%2ftoc.json).
2. [Создайте общую папку](../storage/files/storage-how-to-create-file-share.md).
3. [Разверните службу синхронизации файлов](../storage/files/storage-sync-files-deployment-guide.md) на локальном файловом сервере.
4. Создайте группу синхронизации. Конечные точки в группе синхронизации синхронизируются. Группа синхронизации должна содержать по крайней мере одну облачную конечную точку, которая представляет собой общий файловый ресурс Azure. Кроме того, она должна содержать одну серверную конечную точку, которая представляет собой путь в Windows Server в локальной среде.
5. Теперь ваши файлы синхронизируются между общими файловыми ресурсами Azure и локальным сервером.
6. В случае аварии в локальной среде выполните отработку отказа, используя [план восстановления](site-recovery-create-recovery-plans.md). Добавьте скрипт, чтобы подключить общий файловый ресурс Azure и получить доступ к нему на виртуальной машине.

> [!NOTE]
> Откройте порт 445. Служба файлов Azure использует протокол SMB. Взаимодействие SMB выполняется через TCP-порт 445. Проверьте, чтобы брандмауэр не блокировал TCP-порт 445 с клиентского компьютера.


## <a name="do-a-test-failover"></a>Выполнение тестовой отработки отказа

1. Перейдите на портал Azure и выберите хранилище служб восстановления.
2. Выберите план восстановления, созданный для среды файлового сервера.
3. Выберите **Тестовая отработка отказа**.
4. Выберите точку восстановления и виртуальную сеть Azure, чтобы запустить тестовую отработку отказа.
5. Как только будет запущена вторичная среда, выполните проверку.
6. После завершения проверки нажмите кнопку **Очистить тестовую отработку отказа** в плане восстановления. Среда тестовой отработки отказа будет очищена.

Дополнительные сведения о выполнении тестовой отработки отказа см. в статье [Тестовая отработка отказа в Azure с помощью Site Recovery](site-recovery-test-failover-to-azure.md).

Инструкции по выполнению тестовой отработки отказа для Active Directory и DNS см. в статье [Защита Active Directory и DNS с помощью Azure Site Recovery](site-recovery-active-directory.md).

## <a name="do-a-failover"></a>Выполнение отработки отказа

1. Перейдите на портал Azure и выберите хранилище служб восстановления.
2. Выберите план восстановления, созданный для среды файлового сервера.
3. Выберите **Отработка отказа**.
4. Выберите точку восстановления, чтобы запустить отработку отказа.

Дополнительные сведения о выполнении отработки отказа см. в статье [Отработка отказа в Site Recovery](site-recovery-failover.md).