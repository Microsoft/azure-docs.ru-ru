---
title: Устранение неполадок с сервером конфигурации при аварийном восстановлении виртуальных машин VMware и физических серверов в Azure с помощью Azure Site Recovery | Документация Майкрософт
description: В этой статье описано, как устранять неполадки при развертывании сервера конфигурации при аварийном восстановлении физических серверов и виртуальных машин VMware в Azure с помощью Azure Site Recovery.
author: Rajeswari-Mamilla
manager: rochakm
ms.service: site-recovery
ms.topic: article
ms.date: 02/13/2019
ms.author: ramamill
ms.openlocfilehash: b5fd014732fd4cdfaa52f971b5e4d2c74db580d2
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "92371959"
---
# <a name="troubleshoot-configuration-server-issues"></a>Устранение неполадок, связанных с сервером конфигурации

Эта статья поможет устранить неполадки при развертывании сервера конфигурации [Azure Site Recovery](site-recovery-overview.md) и управлении им. Сервер конфигурации выступает в роли сервера управления. Сервер конфигурации используется для настройки аварийного восстановления локальных виртуальных машин VMware и физических серверов в Azure с помощью Azure Site Recovery. В следующих разделах рассматриваются наиболее распространенные сбои, которые могут произойти при добавлении нового сервера конфигурации или при управлении сервером конфигурации.

## <a name="registration-failures"></a>Ошибки регистрации

Исходный компьютер регистрируется на сервере конфигурации во время установки агента мобильности. На этом этапе можно выполнить отладку ошибок, следуя приведенным ниже инструкциям.

1. Откройте файл C:\ProgramData\ASR\home\svsystems\var\configurator_register_host_static_info.log. (Папка ProgramData может быть скрытой. Если папка папка ProgramData не отображается, в проводнике на вкладке « **вид** » в разделе « **Показать/скрыть** » установите флажок **скрытые элементы** .) Сбои могут быть вызваны несколькими проблемами.

2. Найдите строку **No Valid IP Address found** (Не найден допустимый IP-адрес). Если вы ее нашли, сделайте следующее.
   1. Убедитесь, что запрошенный идентификатор узла совпадает с идентификатором узла исходного компьютера.
   2. Убедитесь, что физическому сетевому адаптеру на исходном компьютере назначен по крайней мере один IP-адрес. Для успешной регистрации агента на сервере конфигурации физическому сетевому адаптеру на исходном компьютере должен быть назначен по крайней мере один действительный IPv4-адрес.
   3. Выполните одну из следующих команд на исходном компьютере, чтобы получить все его IP-адреса.
      - Для Windows: `> ipconfig /all`
      - Для Linux: `# ifconfig -a`

3. Если строка **No Valid IP Address found** не найдена, выполните поиск строки **Reason=>NULL**. Эта ошибка возникает, если исходный компьютер использует пустой узел для регистрации на сервере конфигурации. Если вы ее нашли, сделайте следующее.
    - После устранения проблем следуйте инструкциям в разделе [Регистрация исходного компьютера на сервере конфигурации](vmware-azure-troubleshoot-configuration-server.md#register-source-machine-with-configuration-server), чтобы вручную повторить попытку регистрации.

4. Если строка **Reason=>NULL** не найдена, на исходном компьютере откройте файл C:\ProgramData\ASRSetupLogs\UploadedLogs\ASRUnifiedAgentInstaller.log. (Папка ProgramData может быть скрытой. Если папка папка ProgramData не отображается, в проводнике на вкладке « **вид** » в разделе « **Показать/скрыть** » установите флажок **скрытые элементы** .) Сбои могут быть вызваны несколькими проблемами. 

5. Поиск строки **запроса POST: (7) — не удалось подключиться к серверу**. Если вы ее нашли, сделайте следующее.
    1. Устраните ошибки сети между исходным компьютером и сервером конфигурации. Убедитесь, что сервер конфигурации доступен с исходного компьютера, с помощью сетевых инструментов, например ping, traceroute или веб-браузера. Убедитесь, что исходный компьютер подключиться к серверу конфигурации через порт 443.
    2. Проверьте на исходном компьютере наличие правил брандмауэра, которые блокируют подключение между исходным компьютером и сервером конфигурации. Обратитесь к администраторам сети, чтобы устранить проблемы с подключением.
    3. Убедитесь, что папки, перечисленные в разделе [Исключение папок Azure Site Recovery из антивирусной программы](vmware-azure-set-up-source.md#azure-site-recovery-folder-exclusions-from-antivirus-program), исключены из области действия антивирусного программного обеспечения.
    4. После устранения проблем с сетью следуйте инструкциям в разделе [Регистрация исходного компьютера на сервере конфигурации](vmware-azure-troubleshoot-configuration-server.md#register-source-machine-with-configuration-server), чтобы повторить попытку регистрации.

6. Если запрос строки **POST: (7) — не удалось найти соединение с сервером** , в том же файле журнала найдите строковый **запрос: (60) — не удается проверить подлинность однорангового сертификата с помощью указанных сертификатов ЦС**. Эта ошибка может возникать из-за истечения срока действия сертификата сервера конфигурации, или если исходный компьютер не поддерживает протоколы TLS 1,0 или более поздней версии. Это также может произойти, если брандмауэр блокирует обмен данными TLS между исходным компьютером и сервером конфигурации. Если вы ее нашли, сделайте следующее. 
    1. Чтобы устранить проблему, подключитесь к IP-адресу сервера конфигурации через веб-браузер на исходном компьютере. Используйте универсальный код ресурса (URI) https:\/\/<IP-адрес сервера конфигурации\>:443/. Убедитесь, что исходный компьютер подключиться к серверу конфигурации через порт 443.
    2. На исходном компьютере проверьте, не нужно ли добавить или удалить правила брандмауэра, чтобы обеспечить взаимодействие между исходным компьютером и сервером конфигурации. Из-за разнообразия программного обеспечения брандмауэров, которое может использоваться, невозможно привести все необходимые настройки брандмауэра. Обратитесь к администраторам сети, чтобы устранить проблемы с подключением.
    3. Убедитесь, что папки, перечисленные в разделе [Исключение папок Azure Site Recovery из антивирусной программы](vmware-azure-set-up-source.md#azure-site-recovery-folder-exclusions-from-antivirus-program), исключены из области действия антивирусного программного обеспечения.  
    4. После устранения проблем следуйте инструкциям в разделе [Регистрация исходного компьютера на сервере конфигурации](vmware-azure-troubleshoot-configuration-server.md#register-source-machine-with-configuration-server), чтобы повторить попытку регистрации.

7. В среде Linux, если значение платформы в <INSTALLATION_DIR\>/etc/drscout.conf повреждено, регистрация завершается сбоем. Чтобы определить эту проблему, откройте файл /var/log/ua_install.log. Выполните поиск строки **Aborting configuration as VM_PLATFORM value is either null or it is not VmWare/Azure** (Прерывание конфигурации, так как значением VM_PLATFORM является NULL, не VmWare или не Azure). Платформа должна иметь значение **VmWare** или **Azure**. Если поврежден файл drscout.conf, мы рекомендуем [удалить агент мобильности](vmware-physical-manage-mobility-service.md#uninstall-mobility-service), а затем установить его заново. Если удаление не удается, выполните следующие действия: a. Откройте файл Installation_Directory/uninstall.sh и закомментируйте вызов функции **StopServices**.
    b. Откройте файл Installation_Directory/Vx/bin/uninstall.sh и закомментируйте вызов функции **stop_services**.
    c. Откройте файл Installation_Directory/Fx/uninstall и закомментируйте весь раздел, который пытается остановить службу Fx.
    d. [Удалите](vmware-physical-manage-mobility-service.md#uninstall-mobility-service) агент Mobility Service. После успешного удаления перезагрузите систему и попробуйте установить агент мобильности.

8. Убедитесь, что многофакторная проверка подлинности не включена для учетной записи пользователя. В данный момент Azure Site Recovery не поддерживает многофакторную проверку подлинности для учетной записи пользователя. Зарегистрируйте сервер конфигурации без учетной записи пользователя с включенной поддержкой многофакторной проверки подлинности.  

## <a name="installation-failure-failed-to-load-accounts"></a>Сбой установки: не удалось загрузить учетные записи

Эта ошибка возникает, если службе не удается прочитать данные из транспортного подключения во время установки агента мобильности и регистрации на сервере конфигурации. Чтобы устранить эту проблему, убедитесь, что на исходном компьютере включен протокол TLS 1.0.

## <a name="vcenter-discovery-failures"></a>Сбои обнаружения vCenter

Чтобы устранить ошибки обнаружения vCenter, добавьте сервер vCenter в список byPass в параметрах прокси-сервера. 

- загрузите средство PsExec из [этой статьи](/sysinternals/downloads/psexec) для доступа к содержимому пользователя системы.
- Откройте Internet Explorer в системном пользовательском контенте, выполнив следующую командную строку psexec -s -i "% programfiles%\Internet Explorer\iexplore.exe"
- Добавьте настройки прокси в Internet Explorer и перезапустите сервис tmanssvc.
- Чтобы настроить параметры прокси-сервера DRA, запустите C:\Program Files\Microsoft Azure Site Recovery Provider.
- Затем выполните DRCONFIGURATOR.EXE/configure/AddBypassUrls [добавить IP-адрес или полное доменное имя vCenter Server, предоставленное на шаге **Настройка сервера vCenter Server или vSphere ESXi** раздела [Настройка параметров](vmware-azure-deploy-configuration-server.md#configure-settings)]

## <a name="change-the-ip-address-of-the-configuration-server"></a>Изменение IP-адреса сервера конфигурации

Изменять IP-адрес сервера конфигурации настоятельно не рекомендуется. Убедитесь, что все IP-адреса, назначенные серверу конфигурации, являются статическими. Не используйте IP-адреса DHCP.

## <a name="acs50008-saml-token-is-invalid"></a>"ACS50008: токен SAML недопустим

Чтобы эта ошибка не возникала, системные часы не должны опережать местное время или отставать от него более чем на 15 минут. Для завершения регистрации перезапустите установщик.

## <a name="failed-to-create-a-certificate"></a>Не удалось создать сертификат

Не удалось создать сертификат, необходимый для аутентификации Site Recovery. Программу установки следует повторно запустить от имени локального администратора.

## <a name="failure-to-activate-windows-license-from-server-standard-evaluation-to-server-standard"></a>Не удалось активировать лицензию Windows с ПРОБной версии сервера Standard до Server Standard

1. В рамках развертывания сервера конфигурации с помощью OVF используется лицензия на пробную версию, которая действительна в течение 180 дней. Необходимо активировать эту лицензию до истечения ее срока действия. В противном случае это может привести к частому завершению работы сервера конфигурации и, следовательно, препятствиемию действий репликации.
2. Если не удается активировать лицензию Windows, обратитесь к [группе поддержки Windows](https://aka.ms/Windows_Support), чтобы решить эту проблему.

## <a name="register-source-machine-with-configuration-server"></a>Регистрация исходного компьютера на сервере конфигурации

### <a name="if-the-source-machine-runs-windows"></a>Если исходный компьютер работает на платформе Windows

Выполните следующую команду на исходном компьютере.

```
  cd C:\Program Files (x86)\Microsoft Azure Site Recovery\agent
  UnifiedAgentConfigurator.exe  /CSEndPoint <configuration server IP address> /PassphraseFilePath <passphrase file path>
```

Параметр | Сведения
--- | ---
Использование | UnifiedAgentConfigurator.exe /CSEndPoint <IP-адрес сервера конфигурации\> /PassphraseFilePath <путь к файлу парольной фразы\>
Журналы конфигурации агента | Находятся в файле %ProgramData%\ASRSetupLogs\ASRUnifiedAgentConfigurator.log.
/CSEndPoint | Обязательный параметр. Указывает IP-адрес сервера конфигурации. Используйте любой допустимый IP-адрес.
/PassphraseFilePath |  Mandatory. Расположение с парольной фразы. Используйте любой допустимый локальный путь к файлу или UNC.

### <a name="if-the-source-machine-runs-linux"></a>Если исходный компьютер работает на платформе Linux

Выполните следующую команду на исходном компьютере.

```
  /usr/local/ASR/Vx/bin/UnifiedAgentConfigurator.sh -i <configuration server IP address> -P /var/passphrase.txt
  ```

Параметр | Сведения
--- | ---
Использование | cd /usr/local/ASR/Vx/bin<br /><br /> UnifiedAgentConfigurator.sh -i < IP-адрес сервера конфигурации\> -P <путь к файлу парольной фразы\>
-i | Обязательный параметр. Указывает IP-адрес сервера конфигурации. Используйте любой допустимый IP-адрес.
-P |  Mandatory. Полный путь к файлу, в котором хранится парольная фраза. Используйте любую допустимую папку.

## <a name="unable-to-configure-the-configuration-server"></a>Ошибка настройки сервера конфигурации

Если вы установите на виртуальную машину приложения, отличные от сервера конфигурации, настройка главного целевого объекта может оказаться невозможной. 

Сервер конфигурации должен быть выделенным сервером, и его использование в качестве общего сервера не поддерживается. 

Дополнительные сведения о конфигурации см. в разделе часто задаваемых вопросов в статье [Развертывание сервера конфигурации.](vmware-azure-deploy-configuration-server.md#faqs) 

## <a name="remove-the-stale-entries-for-protected-items-from-the-configuration-server-database"></a>Удаление устаревших записей для защищенных элементов из базы данных сервера конфигурации 

Чтобы удалить устаревший защищенный компьютер из сервера конфигурации, выполните следующие шаги. 
 
1. Чтобы определить исходный компьютер и IP-адрес устаревшей записи: 

    1. откройте командную строку MySQL в режиме администратора; 
    2. выполните следующие команды. 
   
        ```
        mysql> use svsdb1;
        mysql> select id as hostid, name, ipaddress, ostype as operatingsystem, from_unixtime(lasthostupdatetime) as heartbeat from hosts where name!='InMageProfiler'\G;
        ```

        Это возвратит список зарегистрированных компьютеров вместе с их IP-адресами и последним пакетом пульса. Найдите узел с устаревшими парами репликации.

2. Откройте командную строку с повышенными привилегиями и перейдите в расположение C:\ProgramData\ASR\home\svsystems\bin. 
4. Чтобы удалить сведения о зарегистрированных узлах и информацию об устаревших записях с сервера конфигурации, выполните следующую команду, используя исходный компьютер и IP-адрес устаревшей записи. 
   
    `Syntax: Unregister-ASRComponent.pl -IPAddress <IP_ADDRESS_OF_MACHINE_TO_UNREGISTER> -Component <Source/ PS / MT>`
 
    Если у вас есть запись исходного сервера с IP-адресом 10.0.0.4, используйте следующую команду.
 
    `perl Unregister-ASRComponent.pl -IPAddress 10.0.0.4 -Component Source`
 
5. Чтобы повторно зарегистрироваться на сервере конфигурации, перезапустите на исходном компьютере следующие службы: 
 
    - служба приложений InMage Scout;
    - InMage Scout VX Agent — Sentinel/Outpost.

## <a name="upgrade-fails-when-the-services-fail-to-stop"></a>Ошибка обновления при сбое прекращения работы служб

Обновление сервера конфигурации завершается ошибкой, если определенные службы не прекращают работу. 

Чтобы определить проблему, перейдите к каталогу C:\ProgramData\ASRSetupLogs\CX_TP_InstallLogFile на сервере конфигурации. Выполните приведенные ниже шаги для решения проблемы, если вы обнаружили следующие ошибки. 

```output
2018-06-28 14:28:12.943   Successfully copied php.ini to C:\Temp from C:\thirdparty\php5nts
2018-06-28 14:28:12.943   svagents service status - SERVICE_RUNNING
2018-06-28 14:28:12.944   Stopping svagents service.
2018-06-28 14:31:32.949   Unable to stop svagents service.
2018-06-28 14:31:32.949   Stopping svagents service.
2018-06-28 14:34:52.960   Unable to stop svagents service.
2018-06-28 14:34:52.960   Stopping svagents service.
2018-06-28 14:38:12.971   Unable to stop svagents service.
2018-06-28 14:38:12.971   Rolling back the install changes.
2018-06-28 14:38:12.971   Upgrade has failed.
```

Чтобы решить эту проблему, выполните указанные ниже действия.

вручную остановите следующие службы:

- cxprocessserver;
- InMage Scout VX Agent — Sentinel/Outpost; 
- агент Служб восстановления Microsoft Azure; 
- служба Microsoft Azure Site Recovery; 
- tmansvc.
  
Чтобы обновить сервер конфигурации, снова выполните [единую установку](service-updates-how-to.md#links-to-currently-supported-update-rollups).

## <a name="azure-active-directory-application-creation-failure"></a>Ошибка создания приложения Azure Active Directory

У вас недостаточно разрешений для создания приложения в Azure Active Directory (AAD) с помощью шаблона [Open Virtualization Application (OVA)](vmware-azure-deploy-configuration-server.md#deploy-a-configuration-server-through-an-ova-template
).

Чтобы устранить эту проблему, войдите на портал Azure и выполните одно из следующих действий.

- Запросите роль разработчика приложения в AAD. Дополнительные сведения о роли разработчика приложения см. в статье [Разрешения роли администратора в Azure Active Directory](../active-directory/roles/permissions-reference.md).
- Убедитесь, что в AAD параметр **User can create application** (Пользователь может создавать приложение) имеет значение *true*. Дополнительные сведения см. в разделе [как использовать портал для создания приложения Azure AD и субъекта-службы, которые могут получать доступ к ресурсам](../active-directory/develop/howto-create-service-principal-portal.md#permissions-required-for-registering-an-app).

## <a name="process-servermaster-target-are-unable-to-communicate-with-the-configuration-server"></a>Сервер обработки и главный целевой объект не могут обмениваться данными с сервером конфигурации 

Модули сервера обработки (СО) и главного целевого объекта (ГЦО) не могут обмениваться данными с сервером конфигурации (СК), и их состояние показывает, что они не подключены к порталу Azure.

Как правило, это из-за ошибки с портом 443. Следуйте инструкциям ниже, чтобы разблокировать порт и повторно установить связь с СК.

**Убедитесь, что агент MARS вызывается агентом главного целевого объекта**

Чтобы убедиться, что агент главного целевого объекта может создать сеанс TCP для IP-адреса сервера конфигурации, найдите в журналах агента главного целевого объекта трассировку, аналогичную следующей:

TCP \<Replace IP with CS IP here>:52739 \<Replace IP with CS IP here>:443 SYN_SENT 

TCP    192.168.1.40:52739     192.168.1.40:443      SYN_SENT  // В этой трассировке IP-адрес замените IP-адресом СК

Если в журналах агента ГЦО обнаружены трассировки, похожие на приведенные ниже, агент ГЦО сообщает об ошибках с портом 443:

```output
#~> (11-20-2018 20:31:51):   ERROR  2508 8408 313 FAILED : PostToSVServer with error [at curlwrapper.cpp:CurlWrapper::processCurlResponse:212]   failed to post request: (7) - Couldn't connect to server
#~> (11-20-2018 20:31:54):   ERROR  2508 8408 314 FAILED : PostToSVServer with error [at curlwrapper.cpp:CurlWrapper::processCurlResponse:212]   failed to post request: (7) - Couldn't connect to server
```
 
Эта ошибка может возникать, если другие приложения также используют порт 443 или из-за настроек брандмауэра, блокирующих порт.

Чтобы решить эту проблему, выполните указанные ниже действия.

- Убедитесь, что порт 443 не блокируется брандмауэром.
- Если порт недоступен из-за другого приложения, использующего его, остановите и удалите это приложение.
  - Если остановка приложения нецелесообразна, установите новый сервер конфигурации.
- Перезапустите сервер конфигурации.
- Перезапустите службу IIS.

### <a name="configuration-server-is-not-connected-due-to-incorrect-uuid-entries"></a>Сервер конфигурации не подключен из-за неправильных значений UUID

Эта ошибка может возникать, если в базе данных есть несколько записей UUID экземпляра сервера конфигурации (СК). Эта проблема часто возникает при клонировании виртуальной машины сервера конфигурации.

Чтобы решить эту проблему, выполните указанные ниже действия.

1. Удалите устаревшую виртуальную машину СК из vCenter (дополнительные сведения см. в статье [Удаление серверов и отключение защиты](site-recovery-manage-registration-and-protection.md)).
2. Войдите на виртуальную машину сервера конфигурации и подключитесь к базе данных MySQL svsdb1. 
3. Выполните следующий запрос:

    > [!IMPORTANT]
    >
    > Введите сведения об UUID клонированного сервера конфигурации или устаревшей записи сервера конфигурации, который больше не будет использоваться для защиты виртуальных машин. Ввод неправильного значения UUID приведет к потере информации для всех существующих защищенных элементов.
   
    ```
        MySQL> use svsdb1;
        MySQL> delete from infrastructurevms where infrastructurevmid='<Stale CS VM UUID>';
        MySQL> commit; 
    ```
4. Обновите страницу портала.

## <a name="an-infinite-sign-in-loop-occurs-when-entering-your-credentials"></a>При вводе учетных данных происходит бесконечный цикл входа

После ввода правильного имени пользователя и пароля в шаблоне OVF сервера конфигурации вход в Azure все еще продолжает запрашивать ввести правильные учетные данные.

Эта проблема может возникать, если в системе установлено неправильное время.

Чтобы решить эту проблему, выполните указанные ниже действия.

установите на компьютере правильное время и повторите попытку входа. 
