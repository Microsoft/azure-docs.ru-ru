---
title: Включение репликации зашифрованных виртуальных машин Azure в Azure Site Recovery
description: В этой статье описывается, как настроить репликацию для виртуальных машин с дисковыми ключами с управляемым клиентом ключом (CMK) из одного региона Azure в другой с помощью Site Recovery.
author: mayurigupta13
manager: rochakm
ms.service: site-recovery
ms.topic: article
ms.date: 07/10/2020
ms.author: mayg
ms.openlocfilehash: 9f9052f51c5bab0ea738e9fd15d8f62f45ff0c9b
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "93146541"
---
# <a name="replicate-machines-with-customer-managed-keys-cmk-enabled-disks"></a>Репликация компьютеров, использующих диски с ключами, управляемыми клиентом (CMK)

В этой статье описывается репликация виртуальных машин Azure с управляемыми дисками с поддержкой ключей Customer-Managed (CMK) из одного региона Azure в другой.

## <a name="prerequisite"></a>Предварительное требование
Перед включением репликации для виртуальных машин с управляемыми дисками с поддержкой CMK необходимо создать наборы шифрования дисков в целевом регионе для целевой подписки.

## <a name="enable-replication"></a>Включение репликации

В этом примере первичный регион Azure Восточная Азия, а дополнительный регион — Южный Восточная Азия.

1. В хранилище выберите **+ реплицировать**.
2. Обратите внимание на следующие поля.
    - **Источник** — источник происхождения виртуальных машин, в этом случае это **Azure**.
    - **Исходное расположение**: регион Azure, в котором вы хотите защитить виртуальные машины. В этом примере исходное расположение — "Восточная Азия".
    - **Модель развертывания**: модель развертывания Azure на исходных компьютерах.
    - **Исходная подписка**: подписка, к которой принадлежат исходные виртуальные машины. Это может быть любая подписка, которая находится в том же Azure Active Directory клиенте, что и хранилище служб восстановления.
    - **Группа ресурсов** — группа ресурсов, к которой принадлежат исходные виртуальные машины. Все виртуальные машины в выбранной группе ресурсов перечисляются для защиты на следующем шаге.

3. В окне **виртуальные машины**  >  **выберите виртуальные** машины, а затем выберите каждую виртуальную машину, которую требуется реплицировать. Можно выбрать только те компьютеры, для которых можно включить репликацию. Нажмите кнопку **ОК**.

4. В окне **Параметры** можно настроить следующие параметры целевого сайта.

    - **Целевое расположение**: расположение, в котором будут реплицироваться данные исходной виртуальной машины. Site Recovery предоставляет список подходящих целевых регионов на основе расположения выбранного компьютера. Рекомендуется использовать то же расположение, что и для хранилища служб восстановления.
    - **Целевая подписка**: Целевая подписка, используемая для аварийного восстановления. По умолчанию целевая подписка совпадает с исходной подпиской.
    - **Целевая группа ресурсов**. Группа ресурсов, в которой будут находиться все реплицированные виртуальные машины. По умолчанию Site Recovery создает новую группу ресурсов в целевом регионе. Имя получает `asr` суффикс. Если группа ресурсов, созданная Azure Site Recovery, уже существует, она используется повторно. Вы также можете настроить его, как показано в следующем разделе. Расположение целевой группы ресурсов может быть любым регионом Azure, кроме региона, в котором размещаются исходные виртуальные машины.
    - **Целевая виртуальная сеть**: по умолчанию Site Recovery создает новую виртуальную сеть в целевом регионе. Имя получает `asr` суффикс. Он сопоставлен с вашей исходной сетью и используется для защиты в будущем. [Узнайте больше](./azure-to-azure-network-mapping.md) о сетевом сопоставлении.
    - **Целевые учетные записи хранения (если на исходной виртуальной машине не используются управляемые диски)**: по умолчанию Site Recovery создает новую целевую учетную запись хранения, копируя конфигурацию хранилища исходной виртуальной машины. Если учетная запись хранения уже существует, она используется повторно.
    - **Управляемые диски реплики (если исходная виртуальная машина использует управляемые диски)**: Site Recovery создает новые управляемые диски реплики в целевом регионе, чтобы отобразить управляемые диски исходной виртуальной машины того же типа (Standard или Premium), что и управляемые диски исходной виртуальной машины.
    - **Учетные записи хранения кэша**: Site Recovery требуется Вспомогательная учетная запись хранения, называемая *хранилищем кэша* в исходном регионе. Все изменения на исходных виртуальных машинах будут записываться и отправляться в учетную запись хранения кэша. Затем они реплицируются в целевое расположение.
    - **Группа доступности**. по умолчанию Site Recovery создает новую группу доступности в целевом регионе. Имя имеет `asr` суффикс. Если группа доступности, созданная с помощью Site Recovery, уже существует, она используется повторно.
    - **Наборы шифрования дисков (DES)**: Site Recovery требуется использовать наборы шифрования дисков для реплики и целевых управляемых дисков. Перед включением репликации необходимо предварительно создать DES в целевой подписке и целевом регионе. По умолчанию параметр DES не выбран. Необходимо щелкнуть "настроить", чтобы выбрать DES для каждого исходного диска.
    - **Политика репликации**: определяет параметры для журнала хранения точек восстановления и частоты создания моментальных снимков с постоянными приложениями. По умолчанию Site Recovery создает новую политику репликации с параметрами по умолчанию *24 часа* для хранения точек восстановления и *60 минут* для периодичности создания моментальных снимков с учетом приложений.

    ![Включение репликации для компьютера с дисков с поддержкой CMK](./media/azure-to-azure-how-to-enable-replication-cmk-disks/cmk-enable-dr.png)

## <a name="customize-target-resources"></a>Настройка целевых ресурсов

Выполните следующие действия, чтобы изменить целевые параметры Site Recovery умолчанию.

1. Нажмите кнопку **настроить** рядом с пунктом "Целевая подписка", чтобы изменить целевую подписку по умолчанию. Выберите подписку из списка подписок, доступных в клиенте Azure AD.

2. Нажмите кнопку **настроить** рядом с пунктом группа ресурсов, сеть, хранилище и группы доступности, чтобы изменить следующие параметры по умолчанию.
    - В поле **Целевая группа ресурсов** выберите группу ресурсов из списка групп ресурсов в целевом расположении подписки.
    - В поле **Целевая виртуальная сеть** выберите сеть из списка виртуальных сетей в целевом расположении.
    - Для **группы доступности** можно добавить параметры группы доступности в виртуальную машину, если они входят в группу доступности в исходном регионе.
    - В поле **целевые учетные записи хранения** выберите учетную запись для использования.

3. Нажмите кнопку **настроить** рядом с пунктом "параметры шифрования хранилища", чтобы выбрать целевой алгоритм DES для каждого управляемого диска источника, управляемого клиентом (CMK). На момент выбора вы также сможете увидеть, с каким целевым хранилищем ключей связано DES.

4. Выберите **создать целевой ресурс**  >  **включить репликацию**.
5. После включения репликации для виртуальных машин можно проверить состояние работоспособности виртуальных машин в разделе **реплицированные элементы**.

![Снимок экрана, на котором показано, где можно проверить состояние работоспособности виртуальных машин.](./media/azure-to-azure-how-to-enable-replication-cmk-disks/cmk-customize-target-disk-properties.png)

>[!NOTE]
>Во время начальной репликации состояние обновления может занять некоторое время, без видимого хода выполнения. Нажмите кнопку **Обновить**  , чтобы получить Последнее состояние.

## <a name="faqs"></a>Часто задаваемые вопросы

* Я включил CMK для существующего реплицированного элемента, как можно гарантировать, что CMK применяется в целевом регионе.

    Вы можете узнать имя управляемого диска реплики (созданного Azure Site Recovery в целевом регионе) и присоединить DES к этому диску реплики. Однако вы не сможете увидеть сведения о DES в колонке диски после ее подключения. Кроме того, можно отключить репликацию виртуальной машины и включить ее снова. В колонке диски для реплицированного элемента будут отображены сведения о DES и хранилище ключей.

* Я добавил к реплицированному элементу новый диск с поддержкой CMK. Как можно реплицировать этот диск с помощью Azure Site Recovery?

    Добавление нового диска с поддержкой CMK к существующему реплицированному элементу не поддерживается. Отключите репликацию и снова включите репликацию для виртуальной машины.

* Я включил управляемые ключи для платформы и клиента, как защитить мои диски?

    Включение двойного шифрования с управляемыми ключами платформы и клиентами супппртедся с Site Recovery. Чтобы защитить компьютер, следуйте инструкциям в этой статье. Необходимо заранее создать двойное шифрование DES в целевом регионе. Во время включения репликации для такой виртуальной машины можно указать этот алгоритм DES для Site Recovery.

