---
title: Подключение к локальной отработке отказа виртуальных машин Azure с помощью Azure Site Recovery
description: В этой статье описывается, как подключиться к виртуальным машинам Azure после отработки отказа из локальной среды в Azure с помощью Azure Site Recovery
author: Harsha-CS
manager: rochakm
ms.service: site-recovery
ms.topic: conceptual
ms.date: 10/13/2019
ms.author: harshacs
ms.openlocfilehash: 123a68885346062b9e8a53b8d5066204b6b20f5e
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "89568784"
---
# <a name="connect-to-azure-vms-after-failover-from-on-premises"></a>Подключение к виртуальным машинам Azure после отработки отказа из локальной среды 


В этой статье описывается, как настроить подключение, чтобы можно было успешно подключиться к виртуальным машинам Azure после отработки отказа.

При настройке аварийного восстановления локальных виртуальных машин и физических серверов в Azure [Azure Site Recovery](site-recovery-overview.md) начинает репликацию компьютеров в Azure. Затем при возникновении сбоев можно выполнить отработку отказа в Azure с локального сайта. В случае отработки отказа Site Recovery создает виртуальные машины Azure, используя реплицированные локальные данные. В рамках планирования аварийного восстановления необходимо выяснить, как подключиться к приложениям, работающим на этих виртуальных машинах Azure, после отработки отказа.

В этой статье раскрываются следующие темы:

> [!div class="checklist"]
> * Подготовка локальных компьютеров перед отработкой отказа.
> * Подготовка виртуальных машин Azure после отработки отказа. 
> * Сохраняйте IP-адреса на виртуальных машинах Azure после отработки отказа.
> * Назначение новых IP-адресов виртуальным машинам Azure после отработки отказа.

## <a name="prepare-on-premises-machines"></a>Подготовка локальных компьютеров

Чтобы обеспечить подключение к виртуальным машинам Azure, перед отработкой отказа Подготовьте локальные компьютеры.

### <a name="prepare-windows-machines"></a>Подготовка компьютеров с Windows

На локальных компьютерах с Windows выполните следующие действия:

1. Настройте параметры Windows. К ним относятся удаление статических постоянных маршрутов или прокси-серверов WinHTTP, а также установка для политики SAN диска значения **OnlineAll**. [Выполните](../virtual-machines/windows/prepare-for-upload-vhd-image.md#set-windows-configurations-for-azure) эти инструкции.

2. Убедитесь, что [эти службы](../virtual-machines/windows/prepare-for-upload-vhd-image.md#check-the-windows-services) работают.

3. Включите удаленный рабочий стол (RDP), чтобы разрешить установку удаленных подключений к локальному компьютеру. Сведения о включении RDP с помощью PowerShell см. в [этой статье](../virtual-machines/windows/prepare-for-upload-vhd-image.md#update-remote-desktop-registry-settings).

4. Чтобы получить доступ к виртуальной машине Azure через Интернет после отработки отказа, в брандмауэре Windows на локальном компьютере разрешите протоколы TCP и UDP в общедоступном профиле и настройте RDP как разрешенное приложение для всех профилей.

5. Если вы хотите получить доступ к виртуальной машине Azure через VPN-подключение типа "сеть — сеть" после отработки отказа, в брандмауэре Windows на локальном компьютере разрешите RDP для домена и частных профилей. [Узнайте](../virtual-machines/windows/prepare-for-upload-vhd-image.md#configure-windows-firewall-rules) , как разрешить трафик RDP.
6. Убедитесь, что на локальной виртуальной машине нет ожидающих обновлений Windows при активации отработки отказа. Если это так, обновления могут начать установку на виртуальной машине Azure после отработки отказа, и вы не сможете войти на виртуальную машину до завершения обновления.

### <a name="prepare-linux-machines"></a>Подготовка компьютеров с Linux

На локальных компьютерах с Linux выполните следующие действия:

1. Настройте автоматический запуск службы SSH при загрузке системы (если он еще не настроен).
2. Убедитесь, что правила брандмауэра разрешают SSH-подключение.


## <a name="configure-azure-vms-after-failover"></a>Настройка виртуальных машин Azure после отработки отказа

После отработки отказа выполните следующие действия на создаваемых виртуальных машинах Azure.

1. Чтобы подключиться к виртуальной машине через Интернет, назначьте ей общедоступный IP-адрес. Для виртуальной машины Azure нельзя указывать общедоступный IP-адрес, ранее используемый для локального компьютера. [Дополнительные сведения](../virtual-network/virtual-network-public-ip-address.md)
2. Убедитесь, что правила группы безопасности сети (NSG) на виртуальной машине разрешают входящие подключения к порту RDP или SSH.
3. Проверьте [диагностику загрузки](../virtual-machines/troubleshooting/boot-diagnostics.md#enable-boot-diagnostics-on-existing-virtual-machine) , чтобы просмотреть виртуальную машину.


> [!NOTE]
> Служба "Бастион Azure" предоставляет закрытый доступ по RDP и SSH к виртуальным машинам Azure. [Ознакомьтесь с дополнительными сведениями](../bastion/bastion-overview.md) об этой службе.

## <a name="set-a-public-ip-address"></a>Установка общедоступного IP-адреса

В качестве альтернативы назначению общедоступного IP-адреса виртуальной машине Azure вручную можно назначить адрес во время отработки отказа с помощью скрипта или модуля Runbook службы автоматизации Azure в Site Recovery [плане восстановления](site-recovery-create-recovery-plans.md)или настроить маршрутизацию на уровне DNS с помощью диспетчера трафика Azure. Дополнительные [сведения](concepts-public-ip-address-with-site-recovery.md) о настройке общедоступного адреса.


## <a name="assign-an-internal-address"></a>Назначение внутреннего адреса

Чтобы задать внутренний IP-адрес виртуальной машины Azure после отработки отказа, можно использовать несколько вариантов:

- **Хранить один и тот же IP-адрес**. на виртуальной машине Azure можно использовать тот же IP-адрес, который был выделен для локального компьютера.
- **Использовать другой IP-адрес**. Вы можете использовать другой IP-адрес для виртуальной машины Azure.


## <a name="retain-ip-addresses"></a>Использование тех же IP-адресов

Site Recovery позволяет хранить одни и те же IP-адреса при отработки отказа в Azure. При хранении одного и того же IP-адреса можно избежать возможных проблем с сетью после отработки отказа, но при этом возникают сложности.

- Если целевая виртуальная машина Azure использует тот же IP-адрес или подсеть, что и ваш локальный сайт, вы не сможете подключиться между ними, используя VPN-подключение типа "сеть — сеть" или ExpressRoute, из-за перекрытия адреса. Подсети должны быть уникальными.
- После отработки отказа вам потребуется подключение из локальной среды в Azure, чтобы приложения были доступны на виртуальных машинах Azure. Azure не поддерживает растянутые виртуальные ЛС, поэтому, если вы хотите хранить IP-адреса, необходимо перевести IP-пространство в Azure путем отработки отказа всей подсети в дополнение к локальному компьютеру.
- Отработка отказа подсети гарантирует, что конкретная подсеть недоступна одновременно в локальной среде и в Azure.

Для удержания IP-адресов необходимо выполнить следующие действия.

- В окне & "Вычисление сети" для реплицированного элемента задайте для параметра сеть и IP-адресация целевой виртуальной машины Azure зеркальное отображение параметров локального компьютера.
- Подсети должны управляться как часть процесса аварийного восстановления. Виртуальная сеть Azure должна соответствовать локальной сети, и после этого необходимо изменить сетевые маршруты отработки отказа, чтобы они отражали, что подсеть перемещена в Azure, и новые расположения IP-адресов.  

### <a name="failover-example"></a>Пример отработки отказа

Давайте рассмотрим пример.

- Вымышленная организация Woodgrove Bank размещает свои бизнес-приложения в локальной среде, где они размещаются в Azure.
- Они подключаются из локальной среды в Azure через VPN типа "сеть — сеть". 
- Woodgrove использует Site Recovery для репликации локальных компьютеров в Azure.
- Локальные приложения используют жестко запрограммированные IP-адреса, поэтому им нужно хранить одни и те же IP-адреса в Azure.
- Локальные компьютеры, на которых работают приложения, работают в трех подсетях:
    - 192.168.1.0/24
    - 192.168.2.0/24
    - 192.168.3.0/24
- Приложения, работающие в Azure, находятся в **сети** Azure VNet в двух подсетях:
    - 172.16.1.0/24
    - 172.16.2.0/24

Для того, чтобы хранить адреса, выполните следующие действия.

1. При включении репликации они указывают, что компьютеры должны реплицироваться в **сеть Azure**.
2. Они создают **сеть восстановления** в Azure. Эта виртуальная сеть дублирует подсеть 192.168.1.0/24 в своей локальной сети.
3. Компания Woodgrove настраивает [Подключение](../vpn-gateway/vpn-gateway-howto-vnet-vnet-resource-manager-portal.md) между виртуальными сетями между ними. 

    > [!NOTE]
    > В зависимости от требований приложения, подключение между виртуальными сетями можно настроить до отработки отказа, как выполняемый вручную шаг/сценарий или модуль Runbook службы автоматизации Azure в Site Recovery [плане восстановления](site-recovery-create-recovery-plans.md)или после завершения отработки отказа.

4. Перед отработкой отказа в свойствах компьютера в Site Recovery они задают целевому IP-адресу адрес локального компьютера, как описано в следующей процедуре.
5. После отработки отказа создаются виртуальные машины Azure с одним и тем же IP-адресом. Woodgrove подключается из **сети Azure** к сетевой виртуальной сети восстановления с помощью пиринга виртуальных **сетей** (с включенным транзитным подключением).
6. В локальной среде Woodgrove необходимо вносить изменения в сеть, включая изменение маршрутов для отражения того, что 192.168.1.0/24 был перемещен в Azure.  

**Инфраструктура до отработки отказа**

![Перед выполнением отработки отказа подсети](./media/site-recovery-network-design/network-design7.png)


**Инфраструктура после отработки отказа**

![После выполнения отработки отказа подсети](./media/site-recovery-network-design/network-design9.png)


### <a name="set-target-network-settings"></a>Задать параметры целевой сети

Перед отработкой отказа укажите параметры сети и IP-адрес целевой виртуальной машины Azure.

1.  В хранилище служб восстановления — > **реплицированные элементы**, выберите локальный компьютер.
2. На странице " **Вычисление и сеть** " для компьютера нажмите кнопку " **изменить**", чтобы настроить параметры сети и адаптера для целевой виртуальной машины Azure.
3. В окне **Свойства сети** выберите целевую сеть, в которой будет РАЗМЕЩЕНа виртуальная машина Azure при ее создании после отработки отказа.
4. В окне **Сетевые интерфейсы** настройте сетевые адаптеры в целевой сети. По умолчанию Site Recovery отображает все обнаруженные сетевые карты на локальном компьютере.
    - В поле **целевой тип сетевого интерфейса** для каждого сетевого адаптера можно задать значение **первичная**, **вторичная** или **не создавать** , если в целевой сети не нужна конкретная сетевая карта. Один сетевой адаптер должен быть установлен в качестве основного для отработки отказа. Обратите внимание, что изменение целевой сети влияет на все сетевые карты для виртуальной машины Azure.
    - Щелкните имя сетевой карты, чтобы указать подсеть, в которой будет развернута виртуальная машина Azure.
    - Перепишите **dynamic** с частным IP-адресом, который вы хотите назначить целевой виртуальной машине Azure. Если IP-адрес не указан, Site Recovery присвоит сетевому адаптеру при отработке отказа следующий доступный IP-адрес в подсети.
    - [Узнайте больше](site-recovery-manage-network-interfaces-on-premises-to-azure.md) об управлении сетевыми картами для локальной отработки отказа в Azure.


## <a name="get-new-ip-addresses"></a>Получить новые IP-адреса

В этом сценарии виртуальная машина Azure получает новый IP-адрес после отработки отказа. Чтобы настроить новый IP-адрес для виртуальной машины, созданной после отработки отказа, можно использовать следующие действия.

1. Перейдите к разделу **реплицированные элементы**.
2. Выберите нужную виртуальную машину Azure.
3. Выберите среда **вычислений и сеть** и нажмите кнопку **изменить**.

     ![Настройка конфигураций сети отработки отказа](media/azure-to-azure-customize-networking/edit-networking-properties.png)

4. Чтобы изменить параметры сети отработки отказа, выберите **изменить** для сетевой карты, которую требуется настроить. На следующей открывшейся странице укажите соответствующий предварительно созданный IP-адрес в области тестовая отработка отказа и расположение отработки отказа.

    ![Изменение конфигурации сетевого адаптера](media/azure-to-azure-customize-networking/nic-drilldown.png)

5. Щелкните **ОК**.

Site Recovery теперь соберет эти параметры и убедитесь, что виртуальная машина при отработке отказа подключена к выбранному ресурсу через соответствующий IP-адрес, если он доступен в диапазоне целевых IP-адресов. В этом случае нет необходимости выполнять отработку отказа для всей подсети. Для обновления записей на компьютере, для которого выполнена отработка отказа, требуется обновление DNS, чтобы оно указывало на новый IP-адрес виртуальной машины.

## <a name="next-steps"></a>Дальнейшие действия
[Узнайте, как](site-recovery-active-directory.md) выполнять репликацию локальных Active Directory и DNS в Azure.
