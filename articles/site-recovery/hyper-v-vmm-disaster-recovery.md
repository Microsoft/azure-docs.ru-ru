---
title: Настройка аварийного восстановления Hyper-V на дополнительный сайт с помощью Azure Site Recovery
description: Сведения о настройке аварийного восстановления для виртуальных машин Hyper-V между локальными сайтами с помощью службы Azure Site Recovery.
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
ms.topic: how-to
ms.date: 11/14/2019
ms.author: raynew
ms.openlocfilehash: b2164f8927e5c3224f8b07c30d057f48fb7bbc32
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "87495983"
---
# <a name="set-up-disaster-recovery-for-hyper-v-vms-to-a-secondary-on-premises-site"></a>Настройка аварийного восстановления для виртуальных машин Hyper-V на дополнительный локальный сайт

Служба [Azure Site Recovery](site-recovery-overview.md) помогает реализовать стратегию аварийного восстановления за счет управления процессами репликации, отработки отказа и восстановления локальных компьютеров и виртуальных машин Azure.

В этой статье содержатся сведения о настройке аварийного восстановления локальных виртуальных машин Hyper-V, управляемых в облаках System Center Virtual Machine Manager (VMM), на вторичный сайт. Вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * Подготовка локальных серверов VMM и узлов Hyper-V
> * Создание хранилища служб восстановления для Site Recovery. 
> * Настройка исходной и целевой сред для репликации 
> * Настройка сетевого сопоставления 
> * Создание политики репликации
> * Включение репликации для виртуальных машин


## <a name="prerequisites"></a>Предварительные требования

Для работы с этим сценарием:

- Ознакомьтесь с [архитектурой и компонентами сценария](hyper-v-vmm-architecture.md).
- Убедитесь, что серверы VMM и узлы Hyper-V соответствуют [требованиям поддержки](hyper-v-vmm-secondary-support-matrix.md).
- Убедитесь, что виртуальные машины, которые следует реплицировать, соответствуют [требованиям поддержки реплицируемых машин](hyper-v-vmm-secondary-support-matrix.md#replicated-vm-support).
- Подготовьте серверы VMM к сопоставлению сетей.

### <a name="prepare-for-network-mapping"></a>Подготовка к сопоставлению сетей

[Сопоставление сетей](hyper-v-vmm-network-mapping.md) происходит между локальными сетями виртуальных машин VMM в исходном и целевом облаках. Это предоставляет следующие возможности:

- Подключение виртуальных машин к соответствующим целевым сетям виртуальных машин после отработки отказа. 
- Оптимальное размещение виртуальных машин реплик на целевых серверах узлов Hyper-V. 
- Если не настроить сетевое сопоставление, виртуальные машины реплик не будут подключены к каким-либо сетям виртуальных машин после отработки отказа.

Подготовьте VMM следующим образом.

1. Убедитесь, что на исходном и целевом серверах VMM имеются [логические сети VMM](/system-center/vmm/network-logical).
    - Логическая сеть на исходном сервере должна быть связана с исходным облаком, в котором находятся узлы Hyper-V.
    - Логическая сеть на целевом сервере должна быть связана с целевым облаком.
1. Убедитесь, что на исходном и целевом серверах VMM имеются [виртуальные сети VMM](/system-center/vmm/network-virtual). Сети виртуальных машин должны быть связаны с логической сетью в каждом расположении.
2. Подключите виртуальные машины на исходных узлах Hyper-V к исходной сети виртуальных машин. 


## <a name="create-a-recovery-services-vault"></a>Создание хранилища Служб восстановления

[!INCLUDE [site-recovery-create-vault](../../includes/site-recovery-create-vault.md)]


## <a name="choose-a-protection-goal"></a>Выбор цели защиты

Выберите целевые объекты и место для репликации.

1. Щелкните **Site Recovery** > **Шаг 1. Подготовка инфраструктуры** > **Цель защиты**.
2. Выберите **Для сайта восстановления** и **Yes, with Hyper-V** (Да, с использованием Hyper-V).
3. Выберите **Да**, чтобы указать управление узлами Hyper-V с помощью VMM.
4. Выберите **Да**, если используется дополнительный сервер VMM. Если вы развертываете репликацию между облаками, развернутыми на одном сервере VMM, щелкните **Нет**. Нажмите кнопку **ОК**.


## <a name="set-up-the-source-environment"></a>Настройка исходной среды

Установите поставщик Azure Site Recovery на серверах VMM, выполните для серверов обнаружение и регистрацию в хранилище.

1. Выберите **Подготовка инфраструктуры** > **Источник**.
2. В поле **Подготовка источника** щелкните **+ VMM**, чтобы добавить сервер VMM.
3. В колонке **Добавление сервера** в поле **Тип сервера** должно быть указано **System Center VMM server** (Сервер System Center VMM).
4. Скачайте файл установки поставщика Azure Site Recovery.
5. Скачайте ключ регистрации. Он понадобится при установке поставщика. Ключ действителен в течение пяти дней после создания.

    ![Снимок экрана с параметрами загрузки поставщика и ключа регистрации.](./media/hyper-v-vmm-disaster-recovery/source-settings.png)

6. Установка поставщика на каждом сервере VMM. Не нужно ничего явно устанавливать на узлах Hyper-V.

### <a name="install-the-azure-site-recovery-provider"></a>Установка поставщика Azure Site Recovery

1. Запустите файл установки поставщика на каждом сервере VMM. Если VMM развертывается в кластере, при первой установке выполните приведенные далее действия.
    -  Установите поставщик на активном узле и завершите установку, чтобы зарегистрировать этот сервер VMM в хранилище.
    - Затем установите поставщик на других узлах. Узлы кластера должны использовать одинаковую версию поставщика.
2. Программа установки выполняет несколько проверок соответствия предварительным требованиям и запрашивает разрешение на остановку службы VMM. Служба VMM автоматически перезапустится после завершения установки. Если установка выполняется в кластере VMM, вы увидите запрос на остановку роли Cluster.
3. Если вы подтвердите согласие на странице **Центра обновления Майкрософт**, будут устанавливаться обновления поставщика в соответствии с политикой, настроенной для Центра обновления Майкрософт.
4. На странице **Установка** примите или измените расположение установки по умолчанию и нажмите кнопку **Установить**.
5. После завершения установки нажмите кнопку **Зарегистрировать**, чтобы зарегистрировать сервер в хранилище.

    ![Снимок экрана с экраном установки поставщика, включая расположение установки.](./media/hyper-v-vmm-disaster-recovery/provider-register.png)
6. В поле **Имя хранилища** проверьте имя хранилища, в котором будет зарегистрирован сервер. Щелкните **Далее**.
7. На странице **Прокси-подключение** укажите, как поставщик, запущенный на сервере VMM, подключается к Azure.
   - Можно выбрать подключение к Интернету напрямую или через прокси-сервер. При необходимости задайте параметры прокси-сервера.
   - Если вы используете прокси-сервер, на сервере VMM автоматически создается учетная запись запуска от имени (DRAProxyAccount) с учетными данными, указанными для прокси-сервера. Настройте прокси-сервер так, чтобы эта учетная запись могла успешно проходить проверку подлинности. Параметры учетной записи запуска от имени можно изменить в консоли VMM (**Параметры** > **Безопасность** > **Учетные записи запуска от имени**).
   - Перезапустите службу VMM, чтобы изменения вступили в силу.
8. В поле **Регистрационный ключ** выберите ключ, который вы скачали и скопировали на сервер VMM.
9. Параметр шифрования не подходит для данного сценария. 
10. В поле **Имя сервера** укажите понятное имя, описывающее сервер VMM в хранилище. В кластере укажите имя роли кластера VMM.
11. В поле **Синхронизация метаданных в облаке** укажите, нужно ли синхронизировать метаданные для всех облаков на сервере VMM. На каждом сервере это действие требуется выполнять только один раз. Если вы не хотите синхронизировать все облака, не устанавливайте флажок. Можно синхронизировать каждое облако по отдельности. Эта задача выполняется в окне свойств облака в консоли VMM.
12. Для завершения процесса нажмите кнопку **Далее** . После регистрации служба Site Recovery извлекает метаданные с сервера VMM. Чтобы просмотреть этот сервер в хранилище, выберите **Серверы** > **Серверы VMM**.
13. После появления сервера в хранилище на странице **Источник** > **Подготовка источника** выберите сервер VMM, а затем выберите облако, в котором расположен узел Hyper-V. Нажмите кнопку **ОК**.


## <a name="set-up-the-target-environment"></a>Настройка целевой среды

Выберите целевой сервер VMM и облако:

1. Щелкните **Подготовка инфраструктуры** > **Цель** и выберите целевой сервер VMM.
2. Отобразятся облака VMM, которые синхронизируются с использованием Site Recovery. Выберите целевое облако.

   ![Снимок экрана целевого сервера VMM и выбора облака.](./media/hyper-v-vmm-disaster-recovery/target-vmm.png)


## <a name="set-up-a-replication-policy"></a>Настройка политики репликации

Прежде чем начать, убедитесь, что все узлы, использующие политику, работают под управлением одной той же операционной системы. Если узлы работают под управлением разных версий Windows Server, требуется несколько политик репликации.

1. Чтобы создать политику репликации, выберите **Подготовка инфраструктуры** > **Параметры репликации** > **Создание и связывание**.
2. На странице **Создать и связать политику** укажите имя политики. Исходным и целевым типами должен быть **Hyper-V**.
3. В раскрывающемся списке **Версия узла Hyper-V** выберите, какая операционная система выполняется на узле.
4. В раскрывающихся списках **Тип проверки подлинности** и **Порт для проверки подлинности** укажите, как выполняется проверка подлинности для трафика между первичными узлами и узлами восстановления Hyper-V.
    - Выберите **Сертификат** , если только не используете рабочую среду Kerberos. Azure Site Recovery автоматически настроит сертификаты для аутентификации HTTPS. Не нужно ничего делать вручную.
    - По умолчанию порт 8083 и 8084 (для сертификатов) будет открыт в брандмауэре Windows на серверах узлов Hyper-V.
    - В случае выбора **Kerberos** для взаимной аутентификации серверов узлов будет использоваться билет Kerberos. Kerberos используется только при запуске серверов узлов Hyper-V в Windows Server 2012 R2 или более поздней версии.
1. В раскрывающемся списке **Частота копирования** выберите периодичность репликации изменений данных после начальной репликации (каждые 30 секунд, 5 или 15 минут).
2. В поле **Хранение точки восстановления** укажите продолжительность периода хранения для каждой точки восстановления (в часах). Реплицированные компьютеры будут восстанавливаться до любой точки в пределах этого периода.
3. В поле **Периодичность создания моментальных снимков с согласованием приложений** укажите, как часто (от 1-12 до часов) нужно создавать точки восстановления, содержащие согласованные на уровне приложений моментальные снимки. Hyper-V использует два типа моментальных снимков:
    - **Стандартный моментальный снимок**. Создание добавочного моментального снимка всей виртуальной машины.
    - **Моментальный снимок с согласованием приложений**. Создание снимка данных приложения в виртуальной машине на определенный момент времени. Служба теневого копирования томов (VSS) обеспечивает согласованное состояние приложений при создании моментального снимка. Включение моментальных снимков с согласованием приложений влияет на производительность приложений на исходных виртуальных машинах. Задаваемое значение должно быть меньше количества дополнительных точек восстановления, которое было настроено.
4. В поле **Сжатие данных при передаче** укажите, требуется ли сжимать передаваемые реплицированные данные.
5. Если выбрать параметр **Удалить виртуальную машину реплики** то виртуальная машина реплики будет удалена при отключении защиты для исходной виртуальной машины. Если включить этот параметр, то при отключении защиты для исходной виртуальной машины она удаляется из консоли Site Recovery, параметры Site Recovery для VMM удаляются из консоли VMM, также удаляется реплика.
6. Если репликация выполняется по сети, то в параметре **Метод начальной репликации**, укажите, следует ли запустить начальную репликацию сразу или запланировать ее на более позднее время. Чтобы снизить нагрузку на сеть, вы можете запланировать репликацию вне периодов максимальной нагрузки. Нажмите кнопку **ОК**.

     ![Снимок экрана параметров политики репликации.](./media/hyper-v-vmm-disaster-recovery/replication-policy.png)
     
7. Новая политика автоматически связывается с облаком VMM. В поле **Политика репликации** щелкните **ОК**. 


## <a name="enable-replication"></a>Включение репликации

1. Выберите **Репликация приложения** > **Источник**. 
2. В колонке **Источник** выберите сервер VMM и облако, в котором размещены узлы Hyper-V, которые вы хотите реплицировать. Нажмите кнопку **ОК**.
3. В колонке **Цель** проверьте сервер-получатель VMM и вторичное облако.
4. На странице **Виртуальные машины** из списка выберите виртуальные машины, которые необходимо защитить.


Ход выполнения действия **включения защиты** можно отслеживать, выбрав **Задания** > **Задания Azure Site Recovery**. После завершения задания **Завершение подготовки защиты** начальная репликация завершается, а виртуальная машина готова к отработке отказа.

## <a name="next-steps"></a>Дальнейшие действия

[Выполнение отработки аварийного восстановления](hyper-v-vmm-test-failover.md)
