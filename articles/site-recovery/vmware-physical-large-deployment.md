---
title: Масштабирование VMware/физическое аварийное восстановление с помощью Azure Site Recovery
description: Узнайте, как настроить аварийное восстановление в Azure для большого количества локальных виртуальных машин VMware или физических серверов с Azure Site Recovery.
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
ms.topic: conceptual
ms.date: 11/14/2019
ms.author: raynew
ms.openlocfilehash: cc87429f269fba5083b87e2c328f0e21de9707ff
ms.sourcegitcommit: 6386854467e74d0745c281cc53621af3bb201920
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/08/2021
ms.locfileid: "102454353"
---
# <a name="set-up-disaster-recovery-at-scale-for-vmware-vmsphysical-servers"></a>Настройка аварийного восстановления в масштабе для виртуальных машин VMware или физических серверов

В этой статье описывается, как настроить аварийное восстановление в Azure для больших чисел (> 1000) локальных виртуальных машин VMware или физических серверов в рабочей среде с помощью службы [Azure Site Recovery](site-recovery-overview.md) .


## <a name="define-your-bcdr-strategy"></a>Определение стратегии BCDR

В рамках стратегии непрерывности бизнес-процессов и аварийного восстановления (BCDR) вы определяете цели точки восстановления (RPO) и целевые показатели времени восстановления (RTO) для бизнес-приложений и рабочих нагрузок. RTO измеряет длительность времени и уровня обслуживания, в рамках которого бизнес-приложение или процесс должны быть восстановлены и доступны, чтобы избежать проблем непрерывности.
- Site Recovery обеспечивает непрерывную репликацию для виртуальных машин VMware и физических серверов, а также [соглашение об уровне обслуживания](https://azure.microsoft.com/support/legal/sla/site-recovery/v1_2/) для RTO.
- Планируя крупномасштабное аварийное восстановление виртуальных машин VMware и вычисляя необходимые ресурсы Azure, можно указать значение RTO, которое будет использоваться для вычислений емкости.


## <a name="best-practices"></a>Рекомендации

Некоторые общие рекомендации по крупномасштабному аварийному восстановлению. Эти рекомендации рассматриваются более подробно в следующих разделах документа.

- **Определение требований к цели**: оценка емкости и потребностей ресурсов в Azure перед настройкой аварийного восстановления.
- **Спланируйте компоненты Site Recovery**: Определите, какие Site Recovery компоненты (сервер конфигурации, серверы обработки) должны соответствовать предполагаемой емкости.
- **Настройка одного или нескольких серверов обработки масштабирования**. не используйте сервер обработки, который выполняется по умолчанию на сервере конфигурации. 
- **Запуск последних обновлений**: Site Recovery команда выпускает новые версии Site Recovery компонентов на регулярной основе, и следует убедиться, что вы используете последние версии. Для этого следите за [новыми](site-recovery-whats-new.md) обновлениями, а также [включите и установите обновления](service-updates-how-to.md) по мере их выпуска.
- **Заблаговременное отслеживание**. при восстановлении и запуске аварийного восстановления необходимо заранее отслеживать состояние и работоспособность реплицированных компьютеров, а также ресурсы инфраструктуры.
- Отработка **аварийного восстановления**. на регулярной основе следует выполнять отработку аварийного восстановления. Они не влияют на рабочую среду, но позволяют гарантировать, что при необходимости отработка отказа в Azure будет работать надлежащим образом.



## <a name="gather-capacity-planning-information"></a>Сбор сведений о планировании емкости

Соберите сведения о локальной среде, чтобы помочь оценить и оценить потребности целевой емкости (Azure).
- Для этого в VMware выполните Планировщик развертывания для виртуальных машин VMware.
- Для физических серверов Соберите сведения вручную.

### <a name="run-the-deployment-planner-for-vmware-vms"></a>Запуск Планировщик развертывания для виртуальных машин VMware

Планировщик развертывания помогает собирать сведения о локальной среде VMware.

- Запустите Планировщик развертывания в течение периода, который представляет типичное обновление для виртуальных машин. При этом будут сформированы более точные оценки и рекомендации.
- Рекомендуется запускать Планировщик развертывания на компьютере сервера конфигурации, так как планировщик вычисляет пропускную способность от сервера, на котором она работает. Дополнительные [сведения](site-recovery-vmware-deployment-planner-run.md#get-throughput) об измерении пропускной способности.
- Если сервер конфигурации еще не настроен:
    - [Ознакомьтесь с обзором](vmware-physical-azure-config-process-server-overview.md) компонентов Site Recovery.
    - [Настройте сервер конфигурации](vmware-azure-deploy-configuration-server.md), чтобы запустить на нем планировщик развертывания.

Затем запустите планировщик, как показано ниже.

1. [Дополнительные сведения о](site-recovery-deployment-planner.md) планировщик развертывания. Вы можете скачать последнюю версию с портала или [скачать ее напрямую](https://aka.ms/asr-deployment-planner).
2. Ознакомьтесь с [предварительными требованиями](site-recovery-deployment-planner.md#prerequisites) и [последними обновлениями](site-recovery-deployment-planner-history.md) для планировщик развертывания, [скачайте и извлеките](site-recovery-deployment-planner.md#download-and-extract-the-deployment-planner-tool) средство.
3. [Запустите планировщик развертывания](site-recovery-vmware-deployment-planner-run.md) на сервере конфигурации.
4. [Создание отчета](site-recovery-vmware-deployment-planner-run.md#generate-report) для суммирования оценок и рекомендаций.
5. Анализ [рекомендаций по отчетам](site-recovery-vmware-deployment-planner-analyze-report.md) и [оценок затрат](site-recovery-vmware-deployment-planner-cost-estimation.md).

>[!NOTE]
> По умолчанию средство настроено на профилирование и создание отчета для 1000 виртуальных машин. Это ограничение можно изменить, увеличив значение ключа MaxVMsSupported в файле ASRDeploymentPlanner.exe.config.

## <a name="plan-target-azure-requirements-and-capacity"></a>Требования и емкость целевого объекта плана (Azure)

Используя собранные оценки и рекомендации, вы можете спланировать целевые ресурсы и емкость. При запуске Планировщик развертывания для виртуальных машин VMware можно использовать ряд [рекомендаций по отчетам](site-recovery-vmware-deployment-planner-analyze-report.md#recommendations) .

- **Совместимые виртуальные машины**: Используйте это число для задания количества виртуальных машин, готовых к аварийному восстановлению в Azure. Рекомендации по пропускной способности сети и ядрам Azure основаны на этом числе.
- **Необходимая пропускная способность сети**. Обратите внимание на пропускную способность, необходимую для разностной репликации совместимых виртуальных машин. 
    - При запуске планировщика вы указываете требуемую RPO в минутах. В рекомендациях показана пропускная способность, необходимая для удовлетворения этой RPO 100% и 90% времени. 
    - В рекомендациях по пропускной способности сети учитывается пропускная способность, необходимая для общего числа серверов конфигурации и серверов обработки, рекомендуемых в планировщике.
- **Требуемые ядра Azure**. Обратите внимание на количество ядер в целевом регионе Azure в зависимости от числа совместимых виртуальных машин. Если у вас недостаточно ядер, при отработке отказа Site Recovery не сможет создать необходимые виртуальные машины Azure.
- **Рекомендуемый размер пакета виртуальной машины**. Рекомендуемый размер пакета зависит от возможности завершения начальной репликации для пакета в течение 72 часов по умолчанию, при этом устанавливается значение RPO, равное 100%. Значение часа можно изменить.

Эти рекомендации можно использовать для планирования ресурсов Azure, пропускной способности сети и пакетной обработки виртуальных машин.

## <a name="plan-azure-subscriptions-and-quotas"></a>Планирование подписок и квот Azure

Мы хотим убедиться, что для обработки отработки отказа достаточно доступных квот в целевой подписке.

**Задача** | **Сведения** | **Действие**
--- | --- | ---
**Проверка ядер** | Если количество ядер в доступной квоте не равно общему количеству целевых объектов во время отработки отказа или превышает его, произойдет сбой отработки отказа. | Для виртуальных машин VMware убедитесь в наличии достаточного количества ядер в целевой подписке, чтобы соответствовать рекомендациям Планировщик развертывания Core.<br/><br/> Для физических серверов проверьте, соответствуют ли ядра Azure вашим оценкам вручную.<br/><br/> Чтобы проверить квоты, в **подписке** портал Azure > щелкните **использование и квоты**.<br/><br/> Дополнительные [сведения](../azure-portal/supportability/resource-manager-core-quotas-request.md) об увеличении квот.
**Проверка ограничений отработки отказа** | Число отработок отказа не должны превышает лимит отработки отказа Site Recovery. |  Если отработка отказа превышает пределы, можно добавить подписки и выполнить отработку отказа на несколько подписок или увеличить квоту для подписки. 


### <a name="failover-limits"></a>Ограничения отработки отказа

Ограничения указывают количество отработок отказа, которые поддерживаются Site Recovery в течение одного часа, при этом предполагается три диска на компьютер.

Что означает? Для запуска виртуальной машины Azure требуется, чтобы некоторые драйверы были в состоянии запуска загрузки, а службы, например DHCP, были настроены для автоматического запуска.
- Компьютеры, которые соответствуют этим параметрам, уже будут иметь эти параметры.
- Для компьютеров под Windows можно заранее проверить соответствие требованиям и при необходимости сделать их совместимыми. [Подробнее.](site-recovery-failover-to-azure-troubleshoot.md#failover-failed-with-error-id-170010)
- Компьютеры Linux приводятся в соответствие только во время отработки отказа.

**Компьютер соответствует Azure?** | **Ограничения виртуальных машин Azure (отработка отказа управляемого диска)**
--- | --- 
Да | 2000
Нет | 1000

- Ограничения предполагают, что в целевом регионе для подписки выполняются минимальные другие задания.
- Некоторые регионы Azure меньше и могут иметь немного более низкие ограничения.

## <a name="plan-infrastructure-and-vm-connectivity"></a>Планирование инфраструктуры и подключения к виртуальной машине

После отработки отказа в Azure необходимо, чтобы рабочие нагрузки работали так же, как и локальные, и предоставить пользователям доступ к рабочим нагрузкам, работающим на виртуальных машинах Azure.

- [Дополнительные сведения](site-recovery-active-directory.md#test-failover-considerations) об отработки отказа Active Directory или локальной инфраструктуры DNS в Azure.
- Дополнительные [сведения](site-recovery-test-failover-to-azure.md#prepare-to-connect-to-azure-vms-after-failover) о подготовке к подключению к виртуальным машинам Azure после отработки отказа.



## <a name="plan-for-source-capacity-and-requirements"></a>Планирование исходных ресурсов и требований

Важно иметь достаточные серверы конфигурации и масштабируемые серверы обработки для удовлетворения требований к емкости. По мере того как вы начинаете крупномасштабное развертывание, начните с одного сервера конфигурации и одного сервера обработки масштабирования. По мере достижения предписанных ограничений добавьте дополнительные серверы.

>[!NOTE]
> Для виртуальных машин VMware Планировщик развертывания предоставляет некоторые рекомендации по настройке и серверам обработки. Мы рекомендуем использовать таблицы, входящие в следующие процедуры, а не следуя рекомендациям по Планировщик развертывания. 


## <a name="set-up-a-configuration-server"></a>Настройка сервера конфигурации
 
На производительность сервера конфигурации влияет количество компьютеров, на которых выполняется репликация, а не скорость обработки данных. Чтобы выяснить, требуются ли дополнительные серверы конфигурации, используйте указанные ограничения для виртуальных машин.

**ЦП** | **Память** | **Диск кэша** | **Ограничение реплицированных компьютеров**
 --- | --- | --- | ---
8 виртуальных ЦП<br> 2 сокета * 4 ядра с частотой 2,5 ГГц | 16 Гб | 600 ГБ | До 550 компьютеров<br> Предполагается, что каждый компьютер имеет три диска размером 100 ГБ.

- Эти ограничения основаны на сервере конфигурации, настроенном с помощью шаблона OVF.
- Ограничения предполагают, что сервер обработки, выполняемый по умолчанию на сервере конфигурации, не используется.

Если необходимо добавить новый сервер конфигурации, выполните следующие инструкции:

- [Настройте сервер конфигурации](vmware-azure-deploy-configuration-server.md) для аварийного восстановления виртуальной машины VMware с помощью шаблона ovf.
- [Настройте сервер конфигурации](physical-azure-set-up-source.md) вручную для физических серверов или для развертываний VMware, которые не могут использовать шаблон OVF.

При настройке сервера конфигурации обратите внимание на следующее.

- При настройке сервера конфигурации важно учитывать подписку и хранилище, в котором он находится, так как они не должны изменяться после установки. Если вам нужно изменить хранилище, необходимо отменить связь сервера конфигурации с хранилищем и повторно зарегистрировать его. Это приведет к остановке репликации виртуальных машин в хранилище.
- Если вы хотите настроить сервер конфигурации с несколькими сетевыми адаптерами, это необходимо сделать во время настройки. Это невозможно сделать после регистрации сервера конфигурации в хранилище.

## <a name="set-up-a-process-server"></a>Настройка сервера обработки

Производительность сервера обработки зависит от частоты обновления данных, а не от количества компьютеров, включенных для репликации.

- Для крупных развертываний всегда должен существовать хотя бы один сервер обработки масштабирования.
- Чтобы выяснить, требуются ли дополнительные серверы, используйте следующую таблицу.
- Рекомендуется добавить сервер с наивысшей спецификацией. 


**ЦП** | **Память** | **Диск кэша** | **Частота обновлений**
 --- | --- | --- | --- 
12 виртуальных ЦП<br> 2 сокета * 6 ядер с частотой 2,5 ГГц | 24 ГБ | 1 ГБ | До 2 ТБ в день

Настройте сервер обработки следующим образом.

1. Проверьте [Предварительные требования](vmware-azure-set-up-process-server-scale.md#prerequisites).
2. Установите сервер на [портале](vmware-azure-set-up-process-server-scale.md#install-from-the-ui)или из [командной строки](vmware-azure-set-up-process-server-scale.md#install-from-the-command-line).
3. Настройте реплицированные компьютеры для использования нового сервера. Если компьютеры уже реплицируются, выполните следующие действия.
    - На новый сервер обработки можно [переместить](vmware-azure-manage-process-server.md#switch-an-entire-workload-to-another-process-server) всю рабочую нагрузку сервера обработки.
    - Кроме того, можно [переместить](vmware-azure-manage-process-server.md#move-vms-to-balance-the-process-server-load) определенные виртуальные машины на новый сервер обработки.



## <a name="enable-large-scale-replication"></a>Включить крупномасштабную репликацию

После планирования емкости и развертывания необходимых компонентов и инфраструктуры включите репликацию для большого количества виртуальных машин.

1. Сортировка компьютеров по пакетам. Вы включаете репликацию для виртуальных машин в пакете, а затем переходите к следующему пакету.

    - Для виртуальных машин VMware можно использовать [рекомендуемый размер пакета виртуальной машины](site-recovery-vmware-deployment-planner-analyze-report.md#recommended-vm-batch-size-for-initial-replication) в отчете планировщик развертывания.
    - Для физических компьютеров рекомендуется указывать пакеты на основе компьютеров с одинаковым размером и объемом данных, а также с доступной пропускной способностью сети. Целью является компьютер пакетной службы, который, скорее всего, завершит свою начальную репликацию в течение того же времени.
    
2. Если интенсивное обновление диска для компьютера превышает предел в Сепланнер развертывания, можно переместить некритические файлы, которые не нужно реплицировать (например, дампы журналов или временные файлы), на компьютере. Для виртуальных машин VMware можно переместить эти файлы на отдельный диск, а затем [исключить этот диск](vmware-azure-exclude-disk.md) из репликации.
3. Перед включением репликации убедитесь, что компьютеры соответствуют [требованиям репликации](vmware-physical-azure-support-matrix.md#replicated-machines).
4. Настройте политику репликации для [виртуальных машин VMware](vmware-azure-set-up-replication.md#create-a-policy) или [физических серверов](physical-azure-disaster-recovery.md#create-a-replication-policy).
5. Включите репликацию для [виртуальных машин VMware](vmware-azure-enable-replication.md) или [физических серверов](physical-azure-disaster-recovery.md#enable-replication). Это запускает начальную репликацию для выбранных компьютеров.

## <a name="monitor-your-deployment"></a>Мониторинг развертывания

После запуска репликации для первого пакета виртуальных машин запустите Мониторинг развертывания следующим образом:  

1. Назначьте администратора аварийного восстановления для наблюдения за состоянием работоспособности реплицированных компьютеров.
2. [Мониторинг событий](site-recovery-monitor-and-troubleshoot.md) для реплицированных элементов и инфраструктуры.
3. [Отслеживайте работоспособность](vmware-physical-azure-monitor-process-server.md) серверов обработки масштабирования.
4. Зарегистрируйтесь для получения [уведомлений по электронной почте](./site-recovery-monitor-and-troubleshoot.md#subscribe-to-email-notifications) о событиях, чтобы упростить мониторинг.
5. Выполните регулярные отработки [аварийного восстановления](site-recovery-test-failover-to-azure.md), чтобы убедиться, что все работает правильно.


## <a name="plan-for-large-scale-failovers"></a>Планирование крупномасштабных отработок отказа

В случае аварии может потребоваться выполнить отработку отказа большого количества компьютеров или рабочих нагрузок в Azure. Подготовьтесь к этому типу события, как показано ниже.

Вы можете заранее подготовиться к отработке отказа следующим образом:

- [Подготовьте инфраструктуру и виртуальные машины](#plan-infrastructure-and-vm-connectivity) , чтобы рабочие нагрузки были доступны после отработки отказа, чтобы пользователи могли получить доступ к виртуальным машинам Azure.
- Обратите внимание на [ограничения отработки отказа](#failover-limits) ранее в этом документе. Убедитесь, что отработка отказа будет находиться в пределах этих ограничений.
- Выполнение регулярных [переходов на аварийное восстановление](site-recovery-test-failover-to-azure.md). Детализация справки в:
    - Поиск пробелов в развертывании перед отработкой отказа.
    - Оцените сквозное RTO для ваших приложений.
    - Оцените сквозную целевую точку восстановления для рабочих нагрузок.
    - Выявление конфликтов диапазона IP-адресов.
    - При выполнении детализации рекомендуется не использовать рабочие сети для детализации и очистки тестовой отработки отказа после каждого детализации.

Для выполнения крупномасштабной отработки отказа рекомендуется следующее:

1. Создание планов восстановления для отработки отказа рабочей нагрузки.
    - Каждый план восстановления может активировать отработку отказа до 100 компьютеров.
    - [Узнайте подробнее](recovery-plan-overview.md) о планах восстановления.
2. Добавьте скрипты Runbook службы автоматизации Azure в планы восстановления, чтобы автоматизировать задачи, выполняемые вручную в Azure. Типичные задачи включают настройку подсистем балансировки нагрузки, обновление DNS и т. д. [Дополнительные сведения](site-recovery-runbook-automation.md)
2. Перед отработкой отказа Подготовьте компьютеры Windows, чтобы они соответствовали среде Azure. [Ограничения на отработку отказа](#plan-azure-subscriptions-and-quotas) для компьютеров, соответствующих требованиям, выше. Дополнительные [сведения](site-recovery-failover-to-azure-troubleshoot.md#failover-failed-with-error-id-170010) о модулях Runbook.
4.  Активируйте отработку отказа с помощью командлета PowerShell [Start-азрековерисервицесасрпланнедфаиловержоб](/powershell/module/az.recoveryservices/start-azrecoveryservicesasrplannedfailoverjob) вместе с планом восстановления.



## <a name="next-steps"></a>Дальнейшие действия

> [!div class="nextstepaction"]
> [Мониторинг Site Recovery](site-recovery-monitor-and-troubleshoot.md)
