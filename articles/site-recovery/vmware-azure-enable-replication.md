---
title: Включите виртуальные машины VMware для аварийного восстановления с помощью Azure Site Recovery
description: В этой статье описывается, как включить репликацию виртуальной машины VMware для аварийного восстановления с помощью службы Azure Site Recovery.
author: Rajeswari-Mamilla
ms.service: site-recovery
ms.date: 12/07/2020
ms.topic: conceptual
ms.author: ramamill
ms.openlocfilehash: 19a98b5786f35839d84e1e969c29e45e2b5e8dea
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "98573400"
---
# <a name="enable-replication-to-azure-for-vmware-vms"></a>Включение репликации в Azure для виртуальных машин VMware

В этой статье описывается, как включить репликацию локальных виртуальных машин VMware (VM) в Azure.

## <a name="prerequisites"></a>Предварительные условия

В этой статье предполагается, что система соответствует следующим критериям.

- [Настройте локальную исходную среду](vmware-azure-set-up-source.md).
- [Настройте целевую среду в Azure](vmware-azure-set-up-target.md).
- Прежде чем начать, [Проверьте требования и предварительные](vmware-physical-azure-support-matrix.md) требования. Важно отметить следующее:
  - [Поддерживаемые операционные системы](vmware-physical-azure-support-matrix.md#replicated-machines) для реплицированных компьютеров.
  - Поддержка [хранилища и диска](vmware-physical-azure-support-matrix.md#storage) .
  - [Требования Azure](vmware-physical-azure-support-matrix.md#azure-vm-requirements) , с которыми должны соответствовать локальные компьютеры.

### <a name="resolve-common-issues"></a>Устранение распространенных проблем

- Размер каждого диска не должен превышать 4 ТБ.
- Диск операционной системы должен быть базовым, а не динамическим диском.
- Для виртуальных машин версии 2 с поддержкой UEFI семейство операционных систем должно быть Windows, а загрузочный диск должен быть меньше 300 ГБ.

## <a name="before-you-start"></a>Перед началом работы

При репликации виртуальных машин VMware следует учитывать следующие сведения:

- Учетная запись пользователя Azure должна содержать определенные [разрешения](site-recovery-role-based-linked-access-control.md#permissions-required-to-enable-replication-for-new-virtual-machines) для включения репликации новой виртуальной машины в Azure.
- Виртуальные машины VMware обнаруживаются каждые 15 минут. Для отображения виртуальных машин в портал Azure после обнаружения может потребоваться 15 минут или более. При добавлении нового сервера vCenter или узла vSphere обнаружение может занять не более 15 минут.
- Для изменения среды на виртуальной машине на портале может потребоваться 15 минут или более. Например, установка средств VMware.
- Вы можете проверить время последнего обнаружения виртуальных машин VMware: см. Последнее поле **контакта** в на странице " **серверы конфигурации** " для узла vCenter Server/vSphere.
- Чтобы добавить виртуальные машины для репликации, не дожидаясь запланированного обнаружения, выделите сервер конфигурации (но не щелкайте его) и выберите **Обновить**.
- Если при включении репликации виртуальная машина подготовлена, сервер обработки автоматически устанавливает Azure Site Recovery Mobility Service на виртуальной машине.

## <a name="enable-replication"></a>Включение репликации

Перед выполнением действий, описанных в этом разделе, ознакомьтесь со следующими сведениями.

- Azure Site Recovery теперь реплицируется непосредственно на управляемые диски для всех новых репликаций. Сервер обработки записывает журналы репликации в учетную запись хранения кэша в целевом регионе. Эти журналы используются для создания точек восстановления в управляемых дисках реплики с соглашением об именовании `asrseeddisk` .
- Поддержка PowerShell для репликации на управляемые диски доступна начиная с команды [AZ. RecoveryServices Module версии 2.0.0](https://www.powershellgallery.com/packages/Az.RecoveryServices/2.0.0-preview)
- Во время отработки отказа Выбранная точка восстановления используется для создания диска, управляемого целевым объектом.
- Виртуальные машины, которые ранее были настроены для репликации в целевые учетные записи хранения, не затрагиваются.
- Репликация в учетные записи хранения для новой виртуальной машины доступна только через API-интерфейсы передачи данных о состоянии (RESTFUL) и PowerShell. Используйте Azure REST API версии 2016-08-10 или 2018-01-10 для репликации в учетные записи хранения.

Чтобы включить репликацию, выполните следующие действия.

1. Перейдите к разделу **Шаг 2. репликация**  >  **источника** приложения. Включив репликацию в первый раз, выберите **+ реплицировать** в хранилище, чтобы включить репликацию для дополнительных виртуальных машин.
1. На странице **Источник** щелкните **Источник** и выберите нужный сервер конфигурации.
1. В качестве **типа компьютера** выберите **виртуальные машины** или **физические компьютеры**.
1. В поле **vCenter/vSphere Hypervisor** (Гипервизор vCenter или vSphere) выберите сервер vCenter, который управляет узлом vSphere, или сам узел. Этот параметр не имеет значения, если выполняется репликация физических компьютеров.
1. Выберите сервер обработки. Если дополнительные серверы обработки не созданы, в раскрывающемся меню будет доступен встроенный сервер обработки сервера конфигурации. Состояние работоспособности каждого сервера обработки указывается в соответствии с рекомендуемыми ограничениями и другими параметрами. Выберите работоспособный сервер обработки. Не удается выбрать [важный](vmware-physical-azure-monitor-process-server.md#process-server-alerts) сервер обработки. Вы можете [устранить неполадки и ошибки](vmware-physical-azure-troubleshoot-process-server.md)**или**[настроить сервер обработки масштабирования](vmware-azure-set-up-process-server-scale.md).

   :::image type="content" source="./media/vmware-azure-enable-replication/ps-selection.png" alt-text="Включить окно &quot;Источник репликации&quot;":::

   > [!NOTE]
   > Начиная с [версии 9,24](site-recovery-whats-new.md)для повышения работоспособности сервера обработки появляются дополнительные оповещения. Обновите компоненты Site Recovery до версии 9,24 или более поздней для всех предупреждений, которые будут созданы.

1. В поле **целевой объект** выберите подписку и группу ресурсов, в которых вы хотите создать виртуальные машины, для которых выполнена отработка отказа. Выберите модель развертывания, которая будет использоваться в Azure для виртуальных машин, для которых выполнена отработка отказа.
1. Выберите сеть и подсеть Azure, к которым будут подключаться виртуальные машины Azure после отработки отказа. Сеть должна находиться в том же регионе, что и Site Recovery хранилище служб.

   Выберите **настроить сейчас для выбранных компьютеров** , чтобы применить параметр сети ко всем виртуальным машинам, выбранным для защиты. Щелкните **настроить позже** , чтобы выбрать сеть Azure для каждой виртуальной машины. Если у вас нет сети, ее необходимо создать. Чтобы создать сеть с помощью Azure Resource Manager, выберите **создать**. Выберите подсеть, если это применимо, а затем нажмите кнопку **ОК**.

   :::image type="content" source="./media/vmware-azure-enable-replication/enable-rep3.png" alt-text="Включить целевое окно репликации":::

1. Для **виртуальных машин**  >  **выберите виртуальные** машины, а затем выберите каждую виртуальную машину, которую необходимо реплицировать. Можно выбрать только виртуальные машины, для которых можно включить репликацию. Нажмите кнопку **ОК**. Если вы не видите или не можете выбрать какую бы то ни было конкретную виртуальную машину, см. раздел [Исходный компьютер не указан в портал Azure](vmware-azure-troubleshoot-replication.md#step-3-troubleshoot-source-machines-that-arent-available-for-replication) для решения проблемы.

   :::image type="content" source="./media/vmware-azure-enable-replication/enable-replication5.png" alt-text="Включение репликации — окно &quot;выбор виртуальных машин&quot;":::

1. Для **свойств**  >  **Настройка свойств** выберите учетную запись, которую сервер обработки использует для автоматической установки Site Recovery службы Mobility Service на виртуальной машине. Кроме того, выберите тип целевого управляемого диска, который будет использоваться для репликации на основе шаблонов обработки данных.
1. По умолчанию реплицируются все диски исходной виртуальной машины. Чтобы исключить диски из репликации, снимите флажок **включить** для всех дисков, которые не нужно реплицировать. Нажмите кнопку **ОК**. Позже можно задать дополнительные свойства. Дополнительные сведения об исключении дисков см.в [этой статье](vmware-azure-exclude-disk.md).

   :::image type="content" source="./media/vmware-azure-enable-replication/enable-replication6.png" alt-text="Включить настройку окна &quot;свойства репликации&quot;":::

1. На странице **Параметры репликации**  >  **Настройка параметров репликации** убедитесь, что выбрана правильная политика репликации. Параметры политики репликации можно изменить на странице **Параметры** политики  >  **репликации**  >  _имя политики_  >  **изменить параметры**. Изменения, примененные к политике, также применяются к репликации и новым виртуальным машинам.
1. Если требуется собрать виртуальные машины в группу репликации, включите **согласованность нескольких виртуальных машин**. Укажите имя группы и нажмите кнопку **ОК**.

   > [!NOTE]
   > - Виртуальные машины в группе репликации реплицируются вместе и имеют общую отказоустойчивость и точки восстановления, совместимые с приложениями, при отработки отказа.
   > - Объедините виртуальные машины и физические сервера, чтобы они могли зеркалировать рабочие нагрузки. Включение согласованности нескольких виртуальных машин может повлиять на производительность рабочей нагрузки, Сделайте это только в том случае, если на виртуальных машинах выполняется одна и та же Рабочая нагрузка и требуется согласованность.

   :::image type="content" source="./media/vmware-azure-enable-replication/enable-replication7.png" alt-text="Включить окно репликации":::

1. Выберите **Включить репликацию**. Ход выполнения задания **включить защиту** можно отслеживать с помощью заданий **Параметры**  >    >  **Site Recovery задания**. После выполнения задания **завершить задание защиты** виртуальная машина готова к отработке отказа.

## <a name="monitor-initial-replication"></a>Мониторинг начальной репликации

После завершения действия "включить репликацию" защищенного элемента Azure Site Recovery инициирует репликацию (синоним для синхронизации) данных с исходного компьютера в целевой регион. В течение этого периода создаются реплики исходных дисков. Разностные изменения копируются в целевой регион только после завершения копирования исходных дисков. Время, затрачиваемое на копирование исходных дисков, зависит от нескольких параметров, таких как:

- Размер дисков исходного компьютера
- пропускная способность, доступная для передачи данных в Azure (вы можете использовать планировщик развертывания, чтобы указать оптимальную пропускную способность).
- такие ресурсы сервера обработки, как память, свободное место на диске, ЦП, доступные для кэширования & обрабатывать данные, полученные от защищенных элементов (убедитесь, что сервер обработки [работоспособен](vmware-physical-azure-monitor-process-server.md#monitor-proactively)).

Чтобы отслеживать ход выполнения начальной репликации, перейдите к хранилищу служб восстановления в портал Azure-> реплицированные элементы — значение столбца "состояние" > монитора "реплицируемый элемент". Состояние показывает процент завершения начальной репликации. При наведении указателя мыши на состояние будет доступно "всего передано данных". При нажатии кнопки состояние открывается контекстная страница со следующими параметрами:

- Последнее обновление в — указывает на последнее время, когда служба обновляет сведения о репликации всей машины.
- Завершено в процентах — указывает процент завершения начальной репликации для виртуальной машины.
- Всего передано данных — объем данных, передаваемых из виртуальной машины в Azure

    :::image type="content" source="media/vmware-azure-enable-replication/initial-replication-state.png" alt-text="состояние репликации" lightbox="media/vmware-azure-enable-replication/initial-replication-state.png":::

- Ход выполнения синхронизации (для отслеживания сведений на уровне диска)
    - Состояние репликации
      - Если репликация еще не запущена, состояние изменится на "в очереди". Во время начальной репликации одновременно реплицируются только 3 диска. Этот механизм следует за тем, чтобы избежать регулирования на сервере обработки.
      - После запуска репликации состояние изменится на "выполняется".
      - После завершения начальной репликации состояние помечается как "завершено".        
   - Site Recovery считывает данные с исходного диска, передает их в Azure и фиксирует ход выполнения на уровне диска. Обратите внимание, что Site Recovery пропускает репликацию незанятого размера диска и добавляет его к завершенным данным. Таким образом, сумма данных, передаваемых по всем дискам, не может быть добавлена к общему количеству передаваемых данных на уровне виртуальной машины.
   - При щелчке всплывающей информации на диске можно получить сведения о том, когда для диска была активирована репликация (синоним для синхронизации), данные передаются в Azure за последние 15 минут, за которыми следует последняя обновленная отметка времени. Эта метка времени указывает на последнее время, когда служба Azure получала сведения с исходного компьютера :::image type="content" source="media/vmware-azure-enable-replication/initial-replication-info-balloon.png" alt-text="начальная репликация-сведения-всплывающее сообщение" lightbox="media/vmware-azure-enable-replication/initial-replication-info-balloon.png":::
   - Отображается работоспособность каждого диска
      - Если репликация выполняется медленнее, чем ожидалось, состояние диска превращается в предупреждение.
      - Если репликация не выполняется, состояние диска становится критическим

Если состояние работоспособности — критическое или предупреждение, убедитесь, что работоспособность репликации компьютера и [сервера обработки](vmware-physical-azure-monitor-process-server.md) работоспособна. 

Как только будет выполнено задание по включению репликации, процесс репликации будет иметь значение 0%, а все передаваемые данные будут иметь значение НД. При щелчке данные для каждого определенного диска будут иметь вид «НД». Это означает, что репликация еще не запущена и Azure Site Recovery еще не получала последнюю статистику. Ход выполнения обновляется с интервалом в 30 минут.

> [!NOTE]
> Не забудьте обновить серверы конфигурации, серверы обработки масштабирования и агенты мобильности до версии 9,36 или выше, чтобы обеспечить точный ход выполнения и отправлять их в Site Recovery Services.


## <a name="view-and-manage-vm-properties"></a>Просмотр свойств виртуальной машины и управление ими

Затем проверьте свойства исходной виртуальной машины. Помните, что имя виртуальной машины Azure должно соответствовать [требованиям к виртуальным машинам Azure после отработки отказа](vmware-physical-azure-support-matrix.md#replicated-machines).

1. Перейдите в раздел **Параметры**  >  **реплицированные элементы**, а затем выберите виртуальную машину. На странице **основные компоненты** отображаются сведения о параметрах и состоянии виртуальной машины.
1. На разделе **Свойства** можно просмотреть сведения о репликации и отработке отказа для виртуальной машины.
1. В окне **Вычисление и сетевое**  >  **вычисление свойства** можно изменить несколько свойств виртуальной машины.

   :::image type="content" source="./media/vmware-azure-enable-replication/vmproperties.png" alt-text="Окно &quot;Свойства вычислений и сети&quot;":::

   - **Имя виртуальной машины Azure**. при необходимости измените имя, чтобы оно соответствовало требованиям Azure.
   - **Размер целевой виртуальной машины или тип виртуальной машины**. размер виртуальной машины по умолчанию выбирается на основе параметров, включающих число дисков, число сетевых адаптеров, число ядер ЦП, память и доступные размеры виртуальных машин в целевом регионе Azure. Azure Site Recovery выбирает первый доступный размер виртуальной машины, удовлетворяющий всем критериям. Вы можете выбрать другой размер виртуальной машины в зависимости от ваших потребностей в любое время перед отработкой отказа. Размер диска виртуальной машины также зависит от размера исходного диска и может быть изменен только после отработки отказа. Дополнительные сведения о размерах дисков и скорости операций ввода-вывода см. в статье [целевые показатели масштабируемости и производительности для дисков виртуальных машин](../virtual-machines/disks-scalability-targets.md).
   - **Группа ресурсов**. Вы можете выбрать [группу ресурсов](../azure-resource-manager/management/overview.md#resource-groups), из которой виртуальная машина станет частью процедуры после отработки отказа. Этот параметр можно изменить в любое время перед отработкой отказа. Если после отработки отказа виртуальная машина переносится в другую группу ресурсов, параметры защиты этой виртуальной машины будут нарушены.
   - **Группа доступности**. Вы можете выбрать группу [доступности](../virtual-machines/windows/tutorial-availability-sets.md) , если ваша виртуальная машина должна входить в состав после отработки отказа. При выборе группы доступности учитывайте следующие сведения:
     - Отображаются только группы доступности, принадлежащие к указанной группе ресурсов.
     - Виртуальные машины, наявляющиеся в разных виртуальных сетях, не могут входить в одну группу доступности.
     - В одну группу доступности могут входить только виртуальные машины одинакового размера.

1. Вы также можете добавить сведения о целевой сети, подсети и IP-адресе, назначенном виртуальной машине Azure.
1. В разделе **диски** можно увидеть операционную систему и диски данных на виртуальной машине, которая будет реплицирована.

### <a name="configure-networks-and-ip-addresses"></a>Настройка сетей и IP-адресов

Вы можете задать целевой IP-адрес:

- Если адрес не предоставлен, виртуальная машина для отработки отказа использует DHCP.
- Если задать адрес, недоступный при отработке отказа, произойдет сбой.
- Если адрес доступен в сети тестовой отработки отказа, можно использовать тот же целевой IP-адрес для тестовой отработки отказа.

Число сетевых адаптеров зависит от размера, указанного для целевой виртуальной машины следующим образом.

- Если количество сетевых адаптеров на исходной виртуальной машине меньше или равно числу адаптеров, разрешенных для размера целевой виртуальной машины, то количество адаптеров в целевом объекте совпадает с числом источников.
- Если число адаптеров для исходной виртуальной машины превышает число, допустимое для размера целевой виртуальной машины, используется максимальный размер целевого объекта. Например, если исходная виртуальная машина имеет два сетевых адаптера и размер целевой виртуальной машины поддерживает четыре, Целевая виртуальная машина имеет два адаптера. Если исходная виртуальная машина имеет два адаптера, но целевой размер поддерживает только один, Целевая виртуальная машина имеет только один адаптер.
- Если для виртуальной машины настроено несколько сетевых адаптеров, все они будут подключены к одной сети. Кроме того, первый адаптер, показанный в списке, станет сетевым адаптером по умолчанию на виртуальной машине Azure.

### <a name="azure-hybrid-benefit"></a>Преимущество гибридного использования Azure

Клиенты Microsoft Software Assurance могут использовать Преимущество гибридного использования Azure, чтобы сэкономить на стоимости лицензирования для компьютеров Windows Server, перенесенных в Azure. Преимущество также относится к аварийному восстановлению Azure. Если вы имеете право, вы можете назначить преимущество виртуальной машине, которую Site Recovery создает при отработке отказа.

1. Перейдите к **свойствам компьютер и сеть** реплицированной виртуальной машины.
1. Ответьте на вопрос, если у вас есть лицензия Windows Server, которая дает вам право на Преимущество гибридного использования Azure.
1. Убедитесь, что у вас есть соответствующая лицензия Windows Server с Software Assurance, которую можно использовать для применения преимуществ к виртуальной машине, которая будет создана при отработке отказа.
1. Сохраните параметры для реплицированной виртуальной машины.

Дополнительные [сведения](https://azure.microsoft.com/pricing/hybrid-benefit/) о преимущество гибридного использования Azure.

## <a name="next-steps"></a>Дальнейшие действия

После того как виртуальная машина достигнет защищенного состояния, попробуйте [отработку отказа](site-recovery-failover.md) , чтобы проверить, отображается ли ваше приложение в Azure.

- Дополнительные [сведения](site-recovery-manage-registration-and-protection.md) об очистке параметров регистрации и защиты для отключения репликации.
- [Узнайте больше](vmware-azure-disaster-recovery-powershell.md) о том, как автоматизировать репликацию виртуальных машин с помощью PowerShell.
