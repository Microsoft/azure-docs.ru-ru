---
title: Установка главного целевого сервера для восстановления размещения виртуальной машины Linux с помощью Azure Site Recovery
description: Сведения о том, как установить главный целевой сервер Linux для восстановления размещения на локальный сайт во время аварийного восстановления виртуальных машин VMware в Azure с помощью Azure Site Recovery.
author: mayurigupta13
services: site-recovery
manager: rochakm
ms.service: site-recovery
ms.topic: conceptual
ms.date: 09/15/2020
ms.author: mayg
ms.openlocfilehash: 9e1008f7acbfe0685b7a171176c7dc54592d1491
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "96019248"
---
# <a name="install-a-linux-master-target-server-for-failback"></a>Установка главного целевого сервера Linux для восстановления размещения
После отработки отказа виртуальных машин в Azure для них можно восстановить размещение на локальном сайте. Для восстановления размещения из Azure на локальном сайте необходимо повторно включить защиту виртуальной машины. Для этого понадобится локальный главный целевой сервер, который будет получать трафик. 

Если защита включается для виртуальной машины Windows, вам потребуется главный целевой сервер Windows. Для виртуальной машины Linux необходим главный целевой сервер Linux. В следующих разделах этой статьи описано, как создать и установить главный целевой сервер Linux.

> [!IMPORTANT]
> Начиная с выпуска 9.10.0, главный целевой сервер может устанавливаться только на сервер Ubuntu 16.04. Новые экземпляры невозможно устанавливать на серверы CentOS6.6. Однако можно будет обновлять устаревшие главные целевые серверы версии 9.10.0.
> Главный целевой сервер на диспетчере логических томов не поддерживается.

## <a name="overview"></a>Обзор
Эта статья содержит инструкции по установке главного целевого сервера Linux.

Оставить комментарий или задать вопрос можно с помощью формы в конце этой статьи или на [странице вопросов и ответов о Службах восстановления Azure на сайте Майкрософт](/answers/topics/azure-site-recovery.html).

## <a name="prerequisites"></a>Предварительные требования

* Чтобы выбрать узел для развертывания главного целевого сервера, определите метод восстановления размещения: на существующую локальную виртуальную машину или на новую виртуальную машину. 
    * Если выбрана существующая виртуальная машина, узел главного целевого сервера должен иметь доступ к ее хранилищам данных.
    * Если локальная виртуальная машина не существует (в случае восстановления в другом расположении), на том же узле, где размещен главный целевой сервер, создается восстанавливаемая виртуальная машина. Для установки главного целевого сервера можно выбрать любой узел ESXi.
* Главный целевой сервер должен находиться в сети, позволяющей ему взаимодействовать с сервером обработки и сервером конфигурации.
* Версия главного целевого сервера должна соответствовать версии сервера обработки и сервера конфигурации или быть более ранней. Например, если версия сервера конфигурации — 9.4, версия главного целевого сервера может быть 9.4 или 9.3, но не 9.5.
* Главным целевым сервером может быть только виртуальная машина VMware, а не физический сервер.

> [!NOTE]
> Убедитесь, что Storage vMotion не используется для компонентов системы управления, например для главного целевого сервера. Если переместить главный целевой сервер после успешного повторного включения защиты, то диски виртуальной машины (VMDK) не удастся отключить. В этом случае восстановление размещения завершится ошибкой.

## <a name="sizing-guidelines-for-creating-master-target-server"></a>Рекомендации по выбору размера создаваемого главного целевого сервера

Создайте главный целевой сервер в соответствии со следующими рекомендациями по размеру.
- **ОЗУ**: 6 ГБ или больше.
- **Размер диска ОС**: 100 ГБ или больше (для установки ОС).
- **Дополнительное пространство для диска хранения**: 1 TБ
- **Ядра ЦП**: 4 ядра или больше.
- **Ядро**: 4,16. *

## <a name="deploy-the-master-target-server"></a>Развертывание главного целевого сервера

### <a name="install-ubuntu-16042-minimal"></a>Минимальная установка Ubuntu 16.04.2

Выполните следующие инструкции, чтобы установить 64-разрядную версию операционной системы Ubuntu 16.04.2.

1.   Перейдите к [ссылке для скачивания](http://old-releases.ubuntu.com/releases/16.04.2/ubuntu-16.04.2-server-amd64.iso), выберите ближайшее к вам зеркало и скачайте ISO-файл 64-разрядной версии Ubuntu 16.04.2 с минимальным набором возможностей.
Оставьте диск с ISO-файлом 64-разрядной версии Ubuntu 16.04.2 с минимальным набором возможностей в DVD-дисководе и запустите систему.

1.  Выберите **Русский** в качестве предпочтительного языка и нажмите клавишу **ВВОД**.
    
    ![Выбор языка](./media/vmware-azure-install-linux-master-target/image1.png)
1. Выберите **Install Ubuntu Server** (Установить сервер Ubuntu) и нажмите клавишу **ВВОД**.

    ![Выбор установки сервера Ubuntu](./media/vmware-azure-install-linux-master-target/image2.png)

1.  Выберите **Русский** в качестве предпочтительного языка и нажмите клавишу **ВВОД**.

    ![Выбор русского в качестве предпочтительного языка](./media/vmware-azure-install-linux-master-target/image3.png)

1. Выберите соответствующий **часовой пояс** из списка и нажмите клавишу **ВВОД**.

    ![Выбор правильного часового пояса](./media/vmware-azure-install-linux-master-target/image4.png)

1. Выберите **Нет** (параметр по умолчанию) и нажмите клавишу **ВВОД**.

     ![Настройки клавиатуры](./media/vmware-azure-install-linux-master-target/image5.png)
1. Выберите **Русская** в качестве страны или региона происхождения клавиатуры и нажмите клавишу **ВВОД**.

1. Выберите **Русский (Россия)** в качестве раскладки клавиатуры и нажмите клавишу **ВВОД**.

1. Введите имя узла для сервера в текстовом поле **Имя узла** и выберите **Продолжить**.

1. Чтобы создать учетную запись пользователя, введите имя пользователя и выберите **Продолжить**.

      ![Создание учетной записи пользователя](./media/vmware-azure-install-linux-master-target/image9.png)

1. Введите пароль для новой учетной записи пользователя, а затем выберите **Продолжить**.

1.  Подтвердите пароль для нового пользователя, а затем выберите **Продолжить**.

    ![Подтверждение пароля](./media/vmware-azure-install-linux-master-target/image11.png)

1.  В следующем окне выбора шифрования домашнего каталога выберите **Нет** (параметр по умолчанию), а затем нажмите клавишу **ВВОД**.

1. Если отображается правильный часовой пояс, выберите **Да** (параметр по умолчанию), а затем нажмите клавишу **ВВОД**. Чтобы изменить часовой пояс, щелкните **Нет**.

1. Выберите параметр **Guided — use entire disk** (Управляемое, использовать весь диск) из списка методов разбиения на разделы и нажмите клавишу **ВВОД**.

     ![Выбор метода разбиения на разделы](./media/vmware-azure-install-linux-master-target/image14.png)

1.  Выберите соответствующий диск из списка **Select disk to partition** (Выберите диск для разбиения на разделы) и нажмите клавишу **ВВОД**.

    ![Выбор диска](./media/vmware-azure-install-linux-master-target/image15.png)

1.  Выберите **Да** для записи изменений на диск, а затем нажмите клавишу **ВВОД**.

    ![Выбор параметра по умолчанию](./media/vmware-azure-install-linux-master-target/image16-ubuntu.png)

1.  В окне выбора настроек прокси выберите параметр по умолчанию, выберите **Продолжить**, а затем нажмите клавишу **ВВОД**.
     
     ![Снимок экрана, на котором показано, где выбрать продолжение, а затем нажмите клавишу ВВОД.](./media/vmware-azure-install-linux-master-target/image17-ubuntu.png)

1.  В окне выбора выберите параметр **No automatic updates** (Без автоматического обновления) для управления обновлениями в системе, а затем нажмите клавишу **ВВОД**.

     ![Выбор способа управления обновлениями](./media/vmware-azure-install-linux-master-target/image18-ubuntu.png)

    > [!WARNING]
    > Так как для главного целевого сервера Azure Site Recovery требуется специальная версия Ubuntu, необходимо убедиться, что на виртуальной машине отключено обновление ядра. Если оно включено, то какое-либо регулярное обновление приведет к неисправности главного целевого сервера. Убедитесь, что выбран параметр **No automatic updates** (Без автоматического обновления).

1.  Выберите параметры по умолчанию. Если требуется использовать openSSH для SSH-подключения, выберите параметр **OpenSSH server** (Сервер OpenSSH) и нажмите кнопку **Продолжить**.

    ![Выбор программного обеспечения](./media/vmware-azure-install-linux-master-target/image19-ubuntu.png)

1. В окне выбора установки загрузчика GRUB выберите **Да**, а затем нажмите клавишу **ВВОД**.
     
    ![Установщик загрузки GRUB](./media/vmware-azure-install-linux-master-target/image20.png)


1. Выберите соответствующее устройство для установки загрузчика (предпочтительно **/dev/sda**) и нажмите клавишу **ВВОД**.
     
    ![Выбор подходящего устройства](./media/vmware-azure-install-linux-master-target/image21.png)

1. Выберите **Продолжить** и нажмите клавишу **ВВОД**, чтобы завершить установку.

    ![Завершение установки](./media/vmware-azure-install-linux-master-target/image22.png)

1. После завершения установки войдите на виртуальную машину с новыми учетными данными пользователя. (Дополнительные сведения приведены на **шаге 10**.)

1. Выполните действия, показанные на следующем снимке экрана, чтобы задать пароль привилегированного пользователя. Затем войдите как привилегированный пользователь.

    ![Настройка пароля привилегированного пользователя](./media/vmware-azure-install-linux-master-target/image23.png)


### <a name="configure-the-machine-as-a-master-target-server"></a>Настройка компьютера как главного целевого сервера

Чтобы получить идентификатор для каждого жесткого диска SCSI в виртуальной машине Linux, необходимо включить параметр **disk.EnableUUID — TRUE**. Для этого сделайте следующее.

1. Завершите работу виртуальной машины.

2. Щелкните правой кнопкой мыши запись виртуальной машины в левой области, а затем выберите **Изменить параметры**.

3. Откройте вкладку **Параметры**.

4. В левой области выберите **Дополнительно** > **Общие**, а затем нажмите кнопку **Configuration Parameters** (Параметры конфигурации) в правой нижней части экрана.

    ![Открытие параметра конфигурации](./media/vmware-azure-install-linux-master-target/image24-ubuntu.png) 

    Когда виртуальная машина работает, кнопка **Параметры конфигурации** неактивна. Чтобы она стала активной, завершите работу виртуальной машины.

5. Посмотрите, есть ли строка с параметром **disk.EnableUUID**.

   - Если такое значение и равно **False**, измените его на **True**. (Значения True и False можно вводить в любом регистре.)

   - Если значение существует и равно **True**, нажмите кнопку **Отмена**.

   - Если такого значения нет, нажмите кнопку **Добавить строку**.

   - В столбце имени добавьте **disk.EnableUUID** и выберите значение **TRUE**.

     ![Проверка наличия параметра disk.EnableUUID](./media/vmware-azure-install-linux-master-target/image25.png)

#### <a name="disable-kernel-upgrades"></a>Отключение обновления ядра

Для главного целевого сервера Azure Site Recovery требуется специальная версия Ubuntu. Убедитесь, что на виртуальной машине отключено обновление ядра. Включенное обновление может привести к неисправности главного целевого сервера.

#### <a name="download-and-install-additional-packages"></a>Скачивание и установка дополнительных пакетов

> [!NOTE]
> Убедитесь, что система подключена к Интернету, чтобы скачать и установить дополнительные пакеты. Без подключения к Интернету вам придется вручную найти и установить эти пакеты Deb.

 `apt-get install -y multipath-tools lsscsi python-pyasn1 lvm2 kpartx`

### <a name="get-the-installer-for-setup"></a>Получение установщика для установки

Если на главном целевом сервере есть доступ к Интернету, вы можете скачать установщик, как описано ниже. В противном случае скопируйте установщик с сервера обработки и установите его.

#### <a name="download-the-master-target-installation-packages"></a>Скачивание пакетов установки главного целевого сервера

[Скачайте последние установочные файлы главного целевого сервера Linux](https://aka.ms/latestlinuxmobsvc).

Чтобы скачать их из Linux, введите следующую команду:

`wget https://aka.ms/latestlinuxmobsvc -O latestlinuxmobsvc.tar.gz`

> [!WARNING]
> Обязательно скачайте и распакуйте установщик в свой домашний каталог. Если распаковать его в **/usr/local**, то установка завершится ошибкой.


#### <a name="access-the-installer-from-the-process-server"></a>Доступ к программе установки с сервера обработки

1. На сервере обработки перейдите в каталог **C:\Program Files (x86)\Microsoft Azure Site Recovery\home\svsystems\pushinstallsvc\repository**.

2. Скопируйте нужный файл установщика с сервера обработки и сохраните его с именем **latestlinuxmobsvc.tar.gz** в домашнем каталоге.


### <a name="apply-custom-configuration-changes"></a>Применение изменений настраиваемой конфигурации

Чтобы применить изменения настраиваемой конфигурации, сделайте следующее (необходимы права привилегированного пользователя):

1. Выполните следующую команду, чтобы распаковать двоичный файл.

    `tar -xvf latestlinuxmobsvc.tar.gz`

    ![Снимок экрана выполняемой команды](./media/vmware-azure-install-linux-master-target/image16.png)

2. Выполните следующую команду, чтобы предоставить необходимое разрешение.

    `chmod 755 ./ApplyCustomChanges.sh`


3. Выполните следующую команду, чтобы запустить скрипт.
    
    `./ApplyCustomChanges.sh`

> [!NOTE]
> Этот сценарий необходимо выполнить на сервере только один раз. Затем завершите работу сервера. Добавьте на сервер диск, как описано в разделе ниже, а после этого перезагрузите его.

### <a name="add-a-retention-disk-to-the-linux-master-target-virtual-machine"></a>Добавление диска хранения на виртуальную машину главного целевого сервера Linux

Чтобы создать диск хранения, сделайте следующее:

1. Подключите новый диск объемом 1 ТБ к виртуальной машине главного целевого сервера Linux и запустите виртуальную машину.

2. Выполните команду **multipath -ll**, чтобы узнать идентификатор Multipath диска хранения: **multipath -ll**

    ![Идентификатор Multipath](./media/vmware-azure-install-linux-master-target/image27.png)

3. Отформатируйте диск, а затем создайте файловую систему на новом диске: **mkfs. ext4/Дев/маппер/ \<Retention disk's multipath id>**.
    
    ![Файловая система](./media/vmware-azure-install-linux-master-target/image23-centos.png)

4. После создания файловой системы подключите диск хранения.

    ```
    mkdir /mnt/retention
    mount /dev/mapper/<Retention disk's multipath id> /mnt/retention
    ```

5. Создайте запись **fstab**, чтобы диск хранения автоматически подключался при каждом запуске системы.
    
    `vi /etc/fstab`
    
    Нажмите клавишу **INSERT**, чтобы изменить содержимое файла. Создайте строку и вставьте приведенный ниже текст. Замените идентификатор многопутевого диска тем идентификатором, который выделен в предыдущей команде.

    **/dev/mapper/\<Retention disks multipath id> /mnt/retention ext4 rw 0 0**

    Нажмите клавишу **ESC** и введите **:wq**, чтобы сохранить файл и закрыть окно редактора.

### <a name="install-the-master-target"></a>Установка главного целевого сервера

> [!IMPORTANT]
> Версия главного целевого сервера должна соответствовать версии сервера обработки и сервера конфигурации или быть более ранней. Если это условие не соблюдено, то включить защиту удастся, однако репликация завершится ошибкой.


> [!NOTE]
> Перед установкой главного целевого сервера убедитесь, что файл **/etc/hosts** на виртуальной машине содержит записи, которые сопоставляют локальное имя узла с IP-адресами, связанными со всеми сетевыми адаптерами.

1. Выполните следующую команду для установки главного целевого сервера.

    ```
    ./install -q -d /usr/local/ASR -r MT -v VmWare
    ```

2. Скопируйте парольную фразу из файла **C:\ProgramData\Microsoft Azure Site Recovery\private\connection.passphrase** на сервере конфигурации. Затем сохраните ее в файле **passphrase.txt** в том же локальном каталоге, выполнив следующую команду.

    `echo <passphrase> >passphrase.txt`

    Пример 

    `echo itUx70I47uxDuUVY >passphrase.txt`
    

3. Запишите IP-адрес сервера конфигурации. Выполните следующую команду, чтобы зарегистрировать сервер на сервере конфигурации.

    ```
    /usr/local/ASR/Vx/bin/UnifiedAgentConfigurator.sh -i <ConfigurationServer IP Address> -P passphrase.txt
    ```

    Пример 
    
    ```
    /usr/local/ASR/Vx/bin/UnifiedAgentConfigurator.sh -i 104.40.75.37 -P passphrase.txt
    ```

Дождитесь завершения скрипта. Если регистрация главного целевого сервера пройдет успешно, вы увидите его на портале на странице **Инфраструктура Site Recovery**.


#### <a name="install-the-master-target-by-using-interactive-installation"></a>Установка главного целевого сервера с помощью интерактивного процесса

1. Выполните следующую команду для установки главного целевого сервера. Выберите роль агента **Главный целевой сервер**.

    ```
    ./install
    ```

2. Подтвердите расположение по умолчанию для установки, затем нажмите клавишу **ВВОД**, чтобы продолжить.

    ![Выбор расположения по умолчанию для установки главного целевого сервера](./media/vmware-azure-install-linux-master-target/image17.png)

После завершения установки зарегистрируйте сервер конфигурации с помощью командной строки.

1. Запишите IP-адрес сервера конфигурации. Он понадобится нам на следующем шаге.

2. Выполните следующую команду, чтобы зарегистрировать сервер на сервере конфигурации.

    ```
    /usr/local/ASR/Vx/bin/UnifiedAgentConfigurator.sh
    ```

     Дождитесь завершения скрипта. Если регистрация главного целевого сервера пройдет успешно, вы увидите его на портале на странице **Site Recovery Infrastructure** (Инфраструктура Site Recovery).


### <a name="install-vmware-tools--open-vm-tools-on-the-master-target-server"></a>Установка инструментов VMware и open-vm-tools на главном целевом сервере

На главном целевом сервере нужно установить инструменты VMware или open-vm-tools, чтобы он мог обнаруживать хранилища данных. Если они не установлены, то на экране повторного включения защиты не будут отображены хранилища данных. После установки инструментов VMware необходимо выполнить перезагрузку.

### <a name="upgrade-the-master-target-server"></a>Обновление главного целевого сервера

Запустите установщик. Он автоматически обнаружит, что на главном целевом сервере установлен агент. Выберите **Y** (Да), чтобы выполнить обновление.  После завершения установки можно проверить установленную версию главного целевого сервера, выполнив приведенную ниже команду.

`cat /usr/local/.vx_version`


Вы увидите, что поле **Version** (Версия) содержит номер версии главного целевого сервера.

## <a name="common-issues"></a>Распространенные проблемы

* Убедитесь, что Storage vMotion не используется для компонентов системы управления, например для главного целевого сервера. Если переместить главный целевой сервер после успешного повторного включения защиты, то диски виртуальной машины (VMDK) не удастся отключить. В этом случае восстановление размещения завершится ошибкой.

* На главном целевом сервере нельзя использовать моментальные снимки для виртуальной машины. Если существуют моментальные снимки, восстановление размещения завершится ошибкой.

* В некоторых пользовательских конфигурациях сетевые интерфейсы отключаются на время запуска. В такой ситуации агент главного целевого сервера не сможет выполнить инициализацию. Убедитесь, что правильно заданы следующие свойства. Проверьте эти свойства в/ЕТК/Нетворк/интерфацес. файла карты Ethernet.
    * auto eth0;
    * iface eth0 inet dhcp. <br>

    Перезапустите сетевую службу с помощью следующей команды: <br>

`sudo systemctl restart networking`


## <a name="next-steps"></a>Дальнейшие действия
Установленный и зарегистрированный главный целевой сервер появится в разделе **Главный целевой сервер** на странице **Инфраструктура Site Recovery** — там же, где представлены сведения о сервере конфигурации.

Теперь можно настроить [повторную защиту](vmware-azure-reprotect.md) и выполнить восстановление размещения.

