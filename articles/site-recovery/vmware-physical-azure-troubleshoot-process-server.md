---
title: Устранение неполадок с сервером обработки Azure Site Recovery
description: В этой статье описывается, как устранять неполадки с сервером обработки Azure Site Recovery.
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
ms.topic: troubleshooting
ms.date: 09/09/2019
ms.author: raynew
ms.openlocfilehash: ad1bec66edaa3fcc6049f4911684f6e6d6c3e366
ms.sourcegitcommit: f28ebb95ae9aaaff3f87d8388a09b41e0b3445b5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/29/2021
ms.locfileid: "95999198"
---
# <a name="troubleshoot-the-process-server"></a>Устранение неполадок с сервером обработки

Сервер обработки [Site Recovery](site-recovery-overview.md) используется при настройке аварийного восстановления в Azure для локальных виртуальных машин VMware и физических серверов. В этой статье описывается, как устранять неполадки с сервером обработки, в том числе с репликацией и подключением.

Дополнительные сведения о сервере обработки см. [здесь](vmware-physical-azure-config-process-server-overview.md).

## <a name="before-you-start"></a>Перед началом работы

Прежде, чем приступить к устранению неполадок, сделайте следующее:

1. Убедитесь, что вы понимаете принципы [мониторинга серверов обработки](vmware-physical-azure-monitor-process-server.md).
2. Изучите предложенные ниже рекомендации.
3. Убедитесь, что вы соблюдаете [рекомендации по производительности](site-recovery-plan-capacity-vmware.md#capacity-considerations), а также рекомендации из руководства по выбору размеров для [сервера конфигурации](site-recovery-plan-capacity-vmware.md#size-recommendations-for-the-configuration-server-and-inbuilt-process-server) и [изолированных серверов обработки](site-recovery-plan-capacity-vmware.md#size-recommendations-for-the-process-server).

## <a name="best-practices-for-process-server-deployment"></a>Рекомендации по развертыванию сервера обработки

Мы собрали здесь некоторые рекомендации, позволяющие достичь оптимальной производительности серверов обработки.

**Рекомендация** | **Сведения**
--- |---
**Использование** | Убедитесь, что сервер конфигурации или изолированный сервер обработки используются строго по назначению. Не выполняйте на них никаких других задач.
**IP-адрес** | Убедитесь, что сервер обработки имеет статический IPv4-адрес и не использует NAT.
**Контроль использования памяти и ЦП** |Следите за тем, чтобы уровень потребления ЦП и памяти не превышал 70 %.
**Обеспечение свободного места** | Свободным местом здесь называется дисковое пространство кэша на сервере обработки. Данные репликации сохраняются в кэше перед отправкой в Azure.<br/><br/> Следите за тем, чтобы свободными оставались не менее 25 % емкости. Если этот показатель падает ниже 20 %, применятся регулирование к реплицируемым компьютерам, связанным с сервером обработки.

## <a name="check-process-server-health"></a>Проверка работоспособности серверов обработки

Первым шагом при устранении неполадок будет проверка работоспособности и состояния сервера обработки. Просмотрите все оповещения, проверьте работу необходимых служб и наличие пакетов пульса от сервера обработки. Эти действия собраны на следующем рисунке, под которым вы найдете процедуры, помогающие выполнить эти шаги.

![Устранение неполадок с работоспособностью сервера обработки](./media/vmware-physical-azure-troubleshoot-process-server/troubleshoot-process-server-health.png)

## <a name="step-1-troubleshoot-process-server-health-alerts"></a>Шаг 1. Устранение неполадок по оповещениям о состоянии работоспособности сервера обработки

Сервер обработки создает ряд оповещений о состоянии работоспособности. Эти оповещения и рекомендуемые действия приведены в следующей таблице.

**Тип оповещения** | **Error** | **Устранение неполадок**
--- | --- | --- 
![Healthy][green] | None  | Сервер обработки подключен и является работоспособным.
![Предупреждение][yellow] | Указанные службы не работают. | 1. Убедитесь, что все службы запущены.<br/> 2. Если службы работают нормально, переходите к инструкциям по [проверке проблем с подключением и репликацией](#check-connectivity-and-replication).
![Предупреждение][yellow]  | Загрузка ЦП превышает 80 % в течение последних 15 минут. | 1. Не добавляйте новые компьютеры.<br/>2. Убедитесь, что количество виртуальных машин, использующих этот сервер обработки, соответствует [определенным ограничениям](site-recovery-plan-capacity-vmware.md#capacity-considerations), и обдумайте возможность настроить [еще один сервер обработки](vmware-azure-set-up-process-server-scale.md).<br/>3. Переходите к инструкциям по [устранению неполадок с подключением и репликацией](#check-connectivity-and-replication).
![Critical][red] |  Загрузка ЦП превышает 95 % в течение последних 15 минут. | 1. Не добавляйте новые компьютеры.<br/>2. Убедитесь, что количество виртуальных машин, использующих этот сервер обработки, соответствует [определенным ограничениям](site-recovery-plan-capacity-vmware.md#capacity-considerations), и обдумайте возможность настроить [еще один сервер обработки](vmware-azure-set-up-process-server-scale.md).<br/>3. Переходите к инструкциям по [устранению неполадок с подключением и репликацией](#check-connectivity-and-replication).<br/> 4. Если проблема сохранится, запустите [Планировщик развертывания](./site-recovery-deployment-planner.md) для репликации VMware или физического сервера.
![Предупреждение][yellow] | Потребление памяти превышает 80 % в течение последних 15 минут. |  1. Не добавляйте новые компьютеры.<br/>2. Убедитесь, что количество виртуальных машин, использующих этот сервер обработки, соответствует [определенным ограничениям](site-recovery-plan-capacity-vmware.md#capacity-considerations), и обдумайте возможность настроить [еще один сервер обработки](vmware-azure-set-up-process-server-scale.md).<br/>3. Выполните все инструкции, указанные для этого предупреждения.<br/> 4. Если проблема сохранится, переходите к инструкциям по [устранению неполадок с подключением и репликацией](#check-connectivity-and-replication).
![Critical][red] | Потребление памяти превышает 95 % в течение последних 15 минут. | 1. Не добавляйте новые компьютеры и обдумайте возможность настроить [еще один сервер обработки](vmware-azure-set-up-process-server-scale.md).<br/> 2. Выполните все инструкции, указанные для этого предупреждения.<br/> 3. 4. Если проблема сохранится, переходите к инструкциям по [устранению неполадок с подключением и репликацией](#check-connectivity-and-replication).<br/> 4. Если проблема сохранится, запустите [Планировщик развертывания](./site-recovery-deployment-planner.md) для проблем с репликацией VMware или физического сервера.
![Предупреждение][yellow] | Свободное место в папке кэша меньше 30 % в течение последних 15 минут. | 1. Не добавляйте новые компьютеры и обдумайте возможность настроить [еще один сервер обработки](vmware-azure-set-up-process-server-scale.md).<br/>2. Убедитесь, что число виртуальных машин, использующих этот сервер обработки, соответствует [рекомендациям](site-recovery-plan-capacity-vmware.md#capacity-considerations).<br/> 3. Переходите к инструкциям по [устранению неполадок с подключением и репликацией](#check-connectivity-and-replication).
![Critical][red] |  Свободное место меньше 25 % в течение последних 15 минут. | 1. Следуйте инструкциям, указанным для предупреждения об этой проблеме.<br/> 2. 3. Переходите к инструкциям по [устранению неполадок с подключением и репликацией](#check-connectivity-and-replication).<br/> 3. Если проблема сохранится, запустите [Планировщик развертывания](./site-recovery-deployment-planner.md) для репликации VMware или физического сервера.
![Critical][red] | Нет пульса от сервера обработки в течение 15 минут или более. Служба tmansvs не может связаться с сервером конфигурации. | 1) Убедитесь, что сервер обработки включен и работает.<br/> 2. Убедитесь, что на сервере обработки работает tmassvc.<br/> 3. Переходите к инструкциям по [устранению неполадок с подключением и репликацией](#check-connectivity-and-replication).


![Ключ к таблице](./media/vmware-physical-azure-troubleshoot-process-server/table-key.png)


## <a name="step-2-check-process-server-services"></a>Шаг 2. Проверка служб на сервере обработки

В следующей таблице перечислены службы, которые должны выполняться на сервере обработки. Службы могут немного отличаться в зависимости от способа развертывания сервера обработки. 

Для всех служб, кроме агента Служб восстановления Microsoft Azure (obengine), тип запуска должен иметь значение **Автоматически** или **Автоматически (отложенный запуск)** .
 
**Deployment** | **Запущенные службы**
--- | ---
**Сервер обработки на сервере конфигурации** | ProcessServer, ProcessServerMonitor, cxprocessserver, InMage PushInstall, служба отправки журналов (LogUpload), служба приложения InMage Scout, агент Служб восстановления Microsoft Azure (obengine), InMage Scout VX Agent-Sentinel/Outpost (svagents), tmansvc, служба веб-публикаций (W3SVC), MySQL, служба Microsoft Azure Site Recovery (dra).
**Сервер обработки как автономный сервер** | ProcessServer, ProcessServerMonitor, cxprocessserver, InMage PushInstall, служба отправки журналов (LogUpload), служба приложения InMage Scout, агент Служб восстановления Microsoft Azure (obengine), InMage Scout VX Agent-Sentinel/Outpost (svagents), tmansvc.
**Сервер обработки, развернутый в Azure для восстановления размещения** | ProcessServer, ProcessServerMonitor, cxprocessserver, InMage PushInstall, служба отправки журналов (LogUpload).


## <a name="step-3-check-the-process-server-heartbeat"></a>Шаг 3. Проверка пакетов пульса от сервера обработки

Если от сервера обработки не поступают пакеты пульса (код ошибки 806), выполните следующие действия:

1. Убедитесь, что виртуальная машина сервера обработки включена и работает.
2. Проверьте отсутствие ошибок в следующих журналах.

    C:\ProgramData\ASR\home\svsystems\eventmanager *.log C\ProgramData\ASR\home\svsystems\monitor_protection*.log

## <a name="check-connectivity-and-replication"></a>Проверка возможности подключения и репликации

 Ошибки начальной и последующей репликации часто вызваны проблемами с подключением между исходным компьютером и сервером обработки или между сервером обработки и Azure. Эти действия собраны на следующем рисунке, под которым вы найдете процедуры, помогающие выполнить эти шаги.

![Блок-схема, демонстрирующая шаги для устранения неполадок подключения и репликации.](./media/vmware-physical-azure-troubleshoot-process-server/troubleshoot-connectivity-replication.png)


## <a name="step-4-verify-time-sync-on-source-machine"></a>Шаг 4. Проверка синхронизации времени на исходном компьютере

Убедитесь, что на реплицируемом компьютере синхронизированы значения системной даты и времени. [Дополнительные сведения](/windows-server/networking/windows-time-service/accurate-time)

## <a name="step-5-check-anti-virus-software-on-source-machine"></a>Шаг 5. Проверка антивирусного ПО на исходном компьютере

Убедитесь, что антивирусное ПО на реплицируемом компьютере не мешает работе Site Recovery. Если вам потребуется внести Site Recovery в списки исключений антивирусных программ, воспользуйтесь [этой статьей](vmware-azure-set-up-source.md#azure-site-recovery-folder-exclusions-from-antivirus-program).

## <a name="step-6-check-connectivity-from-source-machine"></a>Шаг 6. Проверка возможности подключения с исходного компьютера


1. Установите [клиент Telnet](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc771275(v=ws.10)) на исходный компьютер, если его там нет. Не используйте проверку связи командой Ping.
2. С исходного компьютера с помощью Telnet выполните проверку связи с сервером обработки по порту HTTPS. По умолчанию для трафика репликации используется порт HTTP 9443.

    `telnet <process server IP address> <port>`

3. Убедитесь, что подключение выполняется успешно.


**Соединение** | **Сведения** | **Действие**
--- | --- | ---
**Успешно** | Telnet отображает пустой экран и сервер процессов доступен. | Никаких дополнительных действий не требуется.
**Неудачно** | Не удается подключиться. | Проверьте, что для сервера обработки открыт входящий порт 9443. Возможно, у вас присутствует сеть периметра или промежуточная подсеть. Снова проверьте возможность подключения.
**Частично успешно** | Удается подключиться, но исходный компьютер сообщает о невозможности связаться с сервером обработки. | Переходите к следующей процедуре устранения неполадок.

## <a name="step-7-troubleshoot-an-unreachable-process-server"></a>Шаг 7. Устранение неполадок, связанных с не отвечающим сервером процессов

Если с сервером процессов не удается связаться с исходного компьютера, отобразится ошибка с кодом 78186. Если не устранить эту проблему, она приведет к невозможности создать нормальные точки восстановления с согласованностью приложений и отказоустойчивостью.

Для устранения неполадок проверьте, может ли исходный компьютер подключиться к IP-адресу сервера обработки, а затем выполните на исходном компьютере средство cxpsclient, чтобы полностью проверить возможность подключения.


### <a name="check-the-ip-connection-on-the-process-server"></a>Проверка подключения к IP-адресу сервера обработки

Если telnet подключается нормально, но исходный компьютер сообщает о недоступности сервера процессов, проверьте возможность подключения к IP-адресу сервера обработки.

1. Перейдите в веб-браузере по такому адресу: https://<IP_сервера_обработки>:<Порт_на_сервере_обработки>/.
2. Если при этой проверке отображается ошибка сертификата HTTPS, это считается нормальным. Пропустив эту ошибку, вы увидите страницу с кодом 400 Bad Request (Неверный запрос). Это означает, что сервер не может обработать запрос от браузера, а стандартные механизмы подключения по протоколу HTTPS работают нормально.
3. Если не удается выполнить такую проверку, обратите внимание на код ошибки, возвращаемый в браузере. Например, ошибка 407 означает проблему с проверкой подлинности на прокси-сервере.

### <a name="check-the-connection-with-cxpsclient"></a>Проверка подключения с помощью cxpsclient

Кроме того, вы можете запустить средство cxpsclient для полной проверки подключения.

1. Запустите средство следующим образом.

    ```
    <install folder>\cxpsclient.exe -i <PS_IP> -l <PS_Data_Port> -y <timeout_in_secs:recommended 300>
    ```

2. На сервере процессов проверьте полученные журналы в следующих папках:

    C:\ProgramData\ASR\home\svsystems\transport\log\cxps.err C:\ProgramData\ASR\home\svsystems\transport\log\cxps.xfer



### <a name="check-source-vm-logs-for-upload-failures-error-78028"></a>Проверка журналов на исходной виртуальной машине на предмет сбоев отправки данных (ошибка 78028)

Проблемы с блокировкой отправки данных с исходного компьютера на сервер обработки могут привести к невозможности создать нормальные точки восстановления с согласованностью приложений и отказоустойчивостью. 

1. Чтобы устранить неполадки, связанные со сбоем отправки данных по сети, проверьте наличие ошибок в следующем журнале:

    C:\Program Files (x86)\Microsoft Azure Site Recovery\agent\svagents*.log 

2. Примените остальные процедуры из этой статьи, которые помогут вам устранить неполадки, связанные с отправкой данных.



## <a name="step-8-check-whether-the-process-server-is-pushing-data"></a>Шаг 8. Проверка отправки данных с сервера обработки

Проверьте, отправляет ли сервер обработки данные в Azure.

  1. Откройте диспетчер задач на сервере обработки (нажмите клавиши CTRL+SHIFT+ESC).
  2. На вкладке **Производительность** щелкните **Открыть монитор ресурсов**.
  3. На странице **Монитор ресурсов** выберите вкладку **Сеть**. На вкладке **Процессы с сетевой активностью** проверьте, передает ли cbengine.exe большие объемы данных.

       ![Снимок экрана, показывающий большое количество томов в процессах с сетевой активностью.](./media/vmware-physical-azure-troubleshoot-process-server/cbengine.png)

  Если файл cbengine.exe не отправляет большие объемы данных, выполните действия, указанные в следующих разделах.

## <a name="step-9-check-the-process-server-connection-to-azure-blob-storage"></a>Шаг 9. Проверка подключения сервера обработки к хранилищу BLOB-объектов Azure

1. В мониторе ресурсов выберите **cbengine.exe**.
2. В разделе **TCP-подключения** проверьте, подключен ли сервер обработки к хранилищу Azure.

  ![Снимок экрана, показывающий подключение cbengine.exe по URL-адресу хранилища BLOB-объектов Azure.](./media/vmware-physical-azure-troubleshoot-process-server/rmonitor.png)

### <a name="check-services"></a>Проверка служб

Если сервер обработки не подключен к URL-адресу хранилища BLOB-объектов Azure, проверьте выполнение служб.

1. На панели управления выберите **Службы**.
2. Проверьте, работают ли следующие службы:

    - cxprocessserver;
    - InMage Scout VX Agent – Sentinel/Outpost;
    - агент служб восстановления Microsoft Azure.
    - служба Microsoft Azure Site Recovery;
    - tmansvc.

3. Запустите или перезапустите службы, которые не запущены.
4. Убедитесь, что сервер процессов подключен к сети и отвечает на запросы. 

## <a name="step-10-check-the-process-server-connection-to-azure-public-ip-address"></a>Шаг 10. Проверка подключения сервера обработки к общедоступному IP-адресу Azure

1. На сервере обработки перейдите в папку **%programfiles%\Microsoft Azure Recovery Services Agent\Temp** и откройте файл CBEngineCurr.errlog с последней датой.
2. В этом файле найдите строку **443** или строку **connection attempt failed** (не удалось подключиться).

  ![Журналы ошибок в папке Temp](./media/vmware-physical-azure-troubleshoot-process-server/logdetails1.png)

3. Если здесь вы увидите ошибки, найдите значение общедоступного IP-адреса Azure в файле CBEngineCurr.currLog, используя поиск по порту 443.

  `telnet <your Azure Public IP address as seen in CBEngineCurr.errlog>  443`

5. В командной строке на сервере обработки вызовите Telnet для проверки связи с общедоступным IP-адресом Azure.
6. Если подключиться не удается, выполните следующую процедуру.

## <a name="step-11-check-process-server-firewall-settings"></a>Шаг 11. Проверьте параметры брандмауэра на сервере обработки. 

Проверьте, блокирует ли доступ правило брандмауэра на основе IP-адресов на сервере обработки.

1. Для правил брандмауэра на основе IP-адресов сделайте следующее:

    1\) Скачайте полный список на странице [Диапазоны IP-адресов центра обработки данных Microsoft Azure](https://www.microsoft.com/download/details.aspx?id=41653).

    2\) Добавьте эти диапазоны IP-адресов в конфигурацию брандмауэра, чтобы он разрешал обмен данными с Azure (и на порт HTTPS, по умолчанию это 443).

    3\) Разрешите доступ для диапазонов IP-адресов региона Azure, в котором располагается ваша подписка, и региона Azure "Западная часть США" (используется для контроля доступа и управления удостоверениями).

2. В конфигурации брандмауэра на основе URL-адресов разрешите URL-адреса, перечисленные в следующей таблице.

    [!INCLUDE [site-recovery-URLS](../../includes/site-recovery-URLS.md)]  


## <a name="step-12-verify-process-server-proxy-settings"></a>Шаг 12. Проверка параметров прокси-сервера на сервере обработки 

1. Если вы используете прокси-сервер, убедитесь, что его имя разрешается DNS-сервером. Проверьте значение, которое вы указали при настройке сервера конфигурации в разделе реестра **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Azure Site Recovery\ProxySettings**.
2. Теперь убедитесь, что те же параметры используются агентом Azure Site Recovery для отправки данных.

    1\) Найдите службу **Microsoft Azure Backup**.

    2\) Откройте **Microsoft Azure Backup**, а затем выберите **Действие** > **Изменить свойства**.

    3\) Адрес, указанный на вкладке **Конфигурация прокси**, должен совпадать с адресом прокси-сервера, который отображается в параметрах реестра. В противном случае измените его на тот адрес.

## <a name="step-13-check-bandwidth"></a>Шаг 13. Проверка пропускной способности

Увеличьте пропускную способность сети между сервером обработки и Azure и проверьте, возникают ли проблемы.


## <a name="next-steps"></a>Дальнейшие действия

Если вам потребуется дополнительная помощь, опубликуйте свой вопрос на [странице вопросов и ответов по Azure Site Recovery на сайте Майкрософт](/answers/topics/azure-site-recovery.html). 

[green]: ./media/vmware-physical-azure-troubleshoot-process-server/green.png
[yellow]: ./media/vmware-physical-azure-troubleshoot-process-server/yellow.png
[red]: ./media/vmware-physical-azure-troubleshoot-process-server/red.png