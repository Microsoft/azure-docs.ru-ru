---
title: Устранение неполадок репликации виртуальных машин Azure в Azure Site Recovery
description: Устранение ошибок при репликации виртуальных машин Azure для аварийного восстановления.
author: rochakm
manager: rochakm
ms.service: site-recovery
ms.topic: article
ms.date: 04/07/2020
ms.author: rochakm
ms.openlocfilehash: 6d61a44e671c43754fa7cccbe8ea8fe54eeba387
ms.sourcegitcommit: 5e762a9d26e179d14eb19a28872fb673bf306fa7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/05/2021
ms.locfileid: "97900422"
---
# <a name="troubleshoot-azure-to-azure-vm-replication-errors"></a>Устранение ошибок репликации виртуальных машин из Azure в Azure

В этой статье описывается, как устранять распространенные ошибки в Azure Site Recovery во время репликации и восстановления виртуальных машин Azure из одного региона в другой. Дополнительные сведения о поддерживаемых конфигурациях см. в статье [Azure Site Recovery support matrix for replicating from Azure to Azure](azure-to-azure-support-matrix.md) (Матрица поддержки Azure Site Recovery для репликации виртуальных машин из Azure в Azure).

## <a name="azure-resource-quota-issues-error-code-150097"></a>Проблемы с квотами ресурсов Azure (код ошибки 150097)

Убедитесь, что ваша подписка включена для создания виртуальных машин Azure в целевом регионе, который планируется использовать в качестве региона аварийного восстановления (DR). Вашей подписке требуется достаточная квота для создания виртуальных машин требуемых размеров. По умолчанию Site Recovery выбирает размер целевой виртуальной машины, который совпадает с размером исходной виртуальной машины. Если соответствующий размер недоступен, Site Recovery автоматически выбирает ближайший доступный размер.

Если размер, который поддерживает конфигурацию исходной виртуальной машины, отсутствует, отображается следующее сообщение:

```Output
Replication couldn't be enabled for the virtual machine <VmName>.
```

### <a name="possible-causes"></a>Возможные причины

- Идентификатор подписки не включен для создания виртуальных машин в расположении целевого региона.
- Идентификатор подписки не включен или не имеет достаточной квоты для создания конкретных размеров виртуальных машин в расположении целевого региона.
- Не удалось найти подходящий размер целевой виртуальной машины для сопоставления с количеством сетевых адаптеров (NIC) исходной виртуальной машины (2) для идентификатора подписки в расположении целевого региона.

### <a name="fix-the-problem"></a>Устранение проблемы

Обратитесь в [службу поддержки выставления счетов Azure](../azure-portal/supportability/resource-manager-core-quotas-request.md) , чтобы позволить вашей подписке создавать виртуальные машины требуемых размеров в целевом расположении. Затем повторите невыполненную операцию.

Если целевое расположение имеет ограничение емкости, отключите репликацию в этом расположении. Затем включите репликацию в другое расположение, в котором ваша подписка имеет достаточную квоту для создания виртуальных машин требуемого размера.

## <a name="trusted-root-certificates-error-code-151066"></a>Доверенные корневые сертификаты (код ошибки 151066)

Если на виртуальной машине имеются не все последние Доверенные корневые сертификаты, задание включения репликации для Site Recovery может завершиться ошибкой. Проверка подлинности и авторизация Site Recovery вызовов службы с виртуальной машины завершается сбоем без этих сертификатов.

Если задание включить репликацию завершается сбоем, отображается следующее сообщение:

```Output
Site Recovery configuration failed.
```

### <a name="possible-cause"></a>Возможные причины

Доверенные корневые сертификаты, необходимые для авторизации и проверки подлинности, отсутствуют на виртуальной машине.

### <a name="fix-the-problem"></a>Устранение проблемы

#### <a name="windows"></a>Windows

Для виртуальной машины, работающей под управлением операционной системы Windows, установите последние обновления Windows, чтобы все доверенные корневые сертификаты присутствовали на виртуальной машине. Чтобы получить последние корневые сертификаты и обновленный список отзыва сертификатов на виртуальных машинах, выполните стандартные процедуры управления обновлениями Windows или обновления сертификатов в вашей организации.

- При работе в отключенной среде следуйте стандартной процедуре обновления Windows в вашей организации, чтобы получить сертификаты.
- Если необходимые сертификаты отсутствуют на виртуальной машине, вызовы к службе Site Recovery завершатся ошибкой по соображениям безопасности.

Чтобы проверить, решена ли проблема, перейдите к `login.microsoftonline.com` браузеру на виртуальной машине.

Дополнительные сведения см. в разделе [Настройка доверенных корней и запрещенных сертификатов](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn265983(v=ws.11)).

#### <a name="linux"></a>Linux

Следуйте инструкциям, предоставленным распространителем версии операционной системы Linux, чтобы получить последние Доверенные корневые сертификаты и последний список отзыва сертификатов на виртуальной машине.

Так как SUSE Linux использует символьные ссылки или символических ссылок для ведения списка сертификатов, выполните следующие действия.

1. Войдите в качестве **привилегированного** пользователя. Хэш-символ ( `#` ) — это Командная строка по умолчанию.

1. Чтобы изменить каталог, выполните следующую команду:

   `cd /etc/ssl/certs`

1. Проверьте наличие сертификата корневого ЦС Symantec:

   `ls VeriSign_Class_3_Public_Primary_Certification_Authority_G5.pem`

   - Если сертификат корневого ЦС Symantec не найден, выполните следующую команду, чтобы скачать файл. Проверьте наличие ошибок и следуйте рекомендуемым действиям для сетевых сбоев.

     `wget https://docs.broadcom.com/docs-and-downloads/content/dam/symantec/docs/other-resources/verisign-class-3-public-primary-certification-authority-g5-en.pem -O VeriSign_Class_3_Public_Primary_Certification_Authority_G5.pem`

1. Проверьте, имеется ли сертификат корневого ЦС Baltimore:

   `ls Baltimore_CyberTrust_Root.pem`

   - Если сертификат корневого ЦС Baltimore не найден, выполните следующую команду, чтобы скачать сертификат:

     `wget https://www.digicert.com/CACerts/BaltimoreCyberTrustRoot.crt.pem -O Baltimore_CyberTrust_Root.pem`

1. Проверьте, имеется ли сертификат DigiCert_Global_Root_CA:

   `ls DigiCert_Global_Root_CA.pem`

    - Если DigiCert_Global_Root_CA не найден, выполните следующие команды, чтобы скачать сертификат:

      ```shell
      wget http://www.digicert.com/CACerts/DigiCertGlobalRootCA.crt

      openssl x509 -in DigiCertGlobalRootCA.crt -inform der -outform pem -out DigiCert_Global_Root_CA.pem
      ```

1. Чтобы обновить хэши субъектов сертификата для вновь загруженных сертификатов, выполните скрипт rehash:

   `c_rehash`

1. Чтобы проверить, были ли созданы хэш-значения символических ссылок для сертификатов, выполните следующие команды:

   ```shell
   ls -l | grep Baltimore
   ```

   ```Output
   lrwxrwxrwx 1 root root   29 Jan  8 09:48 3ad48a91.0 -> Baltimore_CyberTrust_Root.pem

   -rw-r--r-- 1 root root 1303 Jun  5  2014 Baltimore_CyberTrust_Root.pem
   ```

   ```shell
   ls -l | grep VeriSign_Class_3_Public_Primary_Certification_Authority_G5
   ```

   ```Output
   -rw-r--r-- 1 root root 1774 Jun  5  2014 VeriSign_Class_3_Public_Primary_Certification_Authority_G5.pem

   lrwxrwxrwx 1 root root   62 Jan  8 09:48 facacbc6.0 -> VeriSign_Class_3_Public_Primary_Certification_Authority_G5.pem
   ```

   ```shell
   ls -l | grep DigiCert_Global_Root
   ```

   ```Output
   lrwxrwxrwx 1 root root   27 Jan  8 09:48 399e7759.0 -> DigiCert_Global_Root_CA.pem

   -rw-r--r-- 1 root root 1380 Jun  5  2014 DigiCert_Global_Root_CA.pem
   ```

1. Создайте копию файла _VeriSign_Class_3_Public_Primary_Certification_Authority_G5. pem_ с именем файла _b204d74a. 0_:

   `cp VeriSign_Class_3_Public_Primary_Certification_Authority_G5.pem b204d74a.0`

1. Создайте копию файла _Baltimore_CyberTrust_Root. pem_ с именем файла _653b494a. 0_:

   `cp Baltimore_CyberTrust_Root.pem 653b494a.0`

1. Создайте копию файла _DigiCert_Global_Root_CA. pem_ с именем файла _3513523f. 0_:

   `cp DigiCert_Global_Root_CA.pem 3513523f.0`

1. Проверьте наличие файлов:

   ```shell
   ls -l 653b494a.0 b204d74a.0 3513523f.0
   ```

   ```Output
   -rw-r--r-- 1 root root 1774 Jan  8 09:52 3513523f.0

   -rw-r--r-- 1 root root 1303 Jan  8 09:52 653b494a.0

   -rw-r--r-- 1 root root 1774 Jan  8 09:52 b204d74a.0
   ```

## <a name="outbound-urls-or-ip-ranges-error-code-151037-or-151072"></a>Исходящие URL-адреса или диапазоны IP-адресов (код ошибки 151037 или 151072)

Чтобы Site Recovery репликация работала, на виртуальной машине требуется исходящее подключение к конкретным URL-адресам. Если виртуальная машина находится за брандмауэром или использует правила группы безопасности сети (NSG) для управления исходящими подключениями, могут возникнуть следующие проблемы. Хотя мы продолжаем поддерживать исходящий доступ через URL-адреса, использование списка разрешенных диапазонов IP-адресов больше не поддерживается.

#### <a name="possible-causes"></a>Возможные причины

- Невозможно установить подключение к Site Recovery конечным точкам из-за сбоя разрешения системы доменных имен (DNS).
- Эта проблема наиболее распространена при повторном включении защиты виртуальной машины, но DNS-сервер недоступен из региона аварийного восстановления (DR).

#### <a name="fix-the-problem"></a>Устранение проблемы

Если вы используете настраиваемую службу DNS, убедитесь, что DNS-сервер доступен из региона аварийного восстановления.

Чтобы проверить, использует ли виртуальная машина настраиваемый параметр DNS, выполните следующие действия.

1. Откройте **виртуальные машины** и выберите виртуальную машину.
1. Перейдите к **параметрам** виртуальных машин и выберите **сети**.
1. В области **Виртуальная сеть или подсеть** щелкните ссылку, чтобы открыть страницу ресурсов виртуальной сети.
1. Перейдите в раздел **Параметры** и выберите **DNS-серверы**.

Попытайтесь получить доступ к DNS-серверу с виртуальной машины. Если DNS-сервер недоступен, сделайте его доступным, выполнив отработку отказа DNS-сервера или создав линию сайта между сетью аварийного восстановления и DNS.

> [!NOTE]
> При использовании частных конечных точек убедитесь, что виртуальные машины могут разрешать частные записи DNS.

:::image type="content" source="./media/azure-to-azure-troubleshoot-errors/custom_dns.png" alt-text="com — ошибка.":::

### <a name="issue-2-site-recovery-configuration-failed-151196"></a>Проблема 2. Сбой при выполнении настройки Site Recovery (151196)

#### <a name="possible-cause"></a>Возможные причины

Не удается установить подключение для Microsoft 365 конечных точек проверки подлинности и IP4-удостоверений.

#### <a name="fix-the-problem"></a>Устранение проблемы

Azure Site Recovery требуется доступ к Microsoft 365 диапазонам IP-адресов для проверки подлинности.
Если вы используете правила и прокси-сервер брандмауэра Azure Network Security Group (NSG) для управления исходящими сетевыми подключениями на виртуальной машине, убедитесь, что вы используете правило NSG на основе [тегов службы Azure Active Directory (AAD)](../virtual-network/network-security-groups-overview.md#service-tags) для разрешения доступа к AAD. Мы больше не поддерживаем правила NSG на основе IP-адресов.

### <a name="issue-3-site-recovery-configuration-failed-151197"></a>Проблема 3. Сбой при выполнении настройки Site Recovery (151197)

#### <a name="possible-cause"></a>Возможные причины

Не удается установить подключение для Azure Site Recovery конечных точек службы.

#### <a name="fix-the-problem"></a>Устранение проблемы

Если вы используете правила и прокси-сервер брандмауэра Azure Network Security Group (NSG) для управления исходящими сетевыми подключениями на виртуальной машине, убедитесь, что используются теги службы. Мы больше не поддерживаем использование списка разрешенных IP-адресов через группы безопасности сети для Azure Site Recovery.

### <a name="issue-4-replication-fails-when-network-traffic-uses-on-premises-proxy-server-151072"></a>Причина 4. сбой репликации при использовании сетевого трафика локальным прокси-сервером (151072)

#### <a name="possible-cause"></a>Возможные причины

Параметры настраиваемого прокси-сервера недопустимы, и агент службы Mobility Service не определил параметры прокси-сервера автоматически из Internet Explorer (IE).

#### <a name="fix-the-problem"></a>Устранение проблемы

1. Агент службы Mobility Service обнаруживает параметры прокси-сервера из IE в Windows и `/etc/environment` Linux.
1. Если вы предпочитаете настроить прокси-сервер только для службы Mobility Service, то вы можете указать сведения о прокси-сервере в файле _проксинфо. conf_ , расположенном по адресу:

   - **Linux**: `/usr/local/InMage/config/`
   - **Windows**: `C:\ProgramData\Microsoft Azure Site Recovery\Config`

1. _Проксинфо. conf_ должен иметь параметры прокси-сервера в следующем формате _ini_ .

   ```plaintext
   [proxy]
   Address=http://1.2.3.4
   Port=567
   ```

> [!NOTE]
> Агент службы Mobility Service поддерживает только **прокси-серверы без проверки подлинности**.

### <a name="more-information"></a>Дополнительные сведения

Чтобы указать [необходимые URL-адреса](azure-to-azure-about-networking.md#outbound-connectivity-for-urls) или [диапазоны IP-](azure-to-azure-about-networking.md#outbound-connectivity-using-service-tags)адресов, следуйте указаниям в статье [о сетях в службе репликации](azure-to-azure-about-networking.md)Azure в Azure.

## <a name="disk-not-found-in-vm-error-code-150039"></a>Диск не найден в виртуальной машине (код ошибки 150039)

Необходимо инициализировать новый диск, подключенный к виртуальной машине. Если диск не найден, отображается следующее сообщение:

```Output
Azure data disk <DiskName> <DiskURI> with logical unit number <LUN> <LUNValue> was not mapped to a corresponding disk being reported from within the VM that has the same LUN value.
```

### <a name="possible-causes"></a>Возможные причины

- Новый диск данных был подключен к виртуальной машине, но не был инициализирован.
- Диск данных в виртуальной машине неправильно сообщает значение LUN, с которого диск был подключен к виртуальной машине.

### <a name="fix-the-problem"></a>Устранение проблемы

Убедитесь, что диски данных инициализированы, и повторите операцию.

- **Windows**: [Присоединение и инициализация нового диска](../virtual-machines/windows/attach-managed-disk-portal.md).
- **Linux**: [Инициализируйте новый диск данных в Linux](../virtual-machines/linux/add-disk.md).

Если проблема не исчезнет, обратитесь в службу поддержки.

## <a name="multiple-disks-available-for-protection-error-code-153039"></a>Несколько дисков, доступных для защиты (код ошибки 153039)

### <a name="possible-causes"></a>Возможные причины

- Один или несколько дисков недавно были добавлены в виртуальную машину после защиты.
- Один или несколько дисков были инициализированы после защиты виртуальной машины.

### <a name="fix-the-problem"></a>Устранение проблемы

Чтобы снова сделать состояние репликации виртуальной машины работоспособным, можно выбрать защиту дисков или закрыть предупреждение.

#### <a name="to-protect-the-disks"></a>Защита дисков

1. Перейдите к разделу **реплицированные элементы**  >  _диски имен виртуальных машин_  >  .
1. Выберите незащищенный диск, а затем щелкните **включить репликацию**.

   :::image type="content" source="./media/azure-to-azure-troubleshoot-errors/add-disk.png" alt-text="Включите репликацию на дисках виртуальных машин.":::

#### <a name="to-dismiss-the-warning"></a>Чтобы закрыть предупреждение

1. Перейдите в раздел " **реплицированные элементы**"  >  _имя виртуальной машины_.
1. Выберите предупреждение в разделе **Обзор** и нажмите кнопку **ОК**.

   :::image type="content" source="./media/azure-to-azure-troubleshoot-errors/dismiss-warning.png" alt-text="Отклонить предупреждение о новом диске.":::

## <a name="vm-removed-from-vault-completed-with-information-error-code-150225"></a>Виртуальная машина, удаленная из хранилища, завершилась с информацией (код ошибки 150225)

Когда Site Recovery защищает виртуальную машину, она создает ссылки на исходной виртуальной машине. При удалении защиты или отключении репликации Site Recovery удаляет эти ссылки в рамках задания очистки. Если виртуальная машина имеет блокировку ресурсов, задание очистки завершается с помощью этих сведений. Эта информация говорит о том, что виртуальная машина была удалена из хранилища служб восстановления, но на исходном компьютере не удалось очистить некоторые устаревшие ссылки.

Это предупреждение можно проигнорировать, если вы никогда не планируете защищать эту виртуальную машину еще раз. Но если вы хотите защитить эту виртуальную машину позже, выполните действия, описанные в этом разделе, чтобы очистить ссылки.

> [!WARNING]
> Если вы не выполняете очистку, сделайте следующее:
>
> - При включении репликации с помощью хранилища служб восстановления виртуальная машина не будет отображаться в списке.
> - Если вы попытаетесь защитить виртуальную машину с помощью параметров **виртуальной машины**  >    >  **аварийного восстановления**, операция завершится ошибкой, и **репликация сообщений не будет включена из-за имеющихся устаревших ссылок на виртуальные машины**.

### <a name="fix-the-problem"></a>Устранение проблемы

> [!NOTE]
> Во время выполнения этих действий Site Recovery не удаляет исходную виртуальную машину или не влияет на нее каким бы то ни было.

1. Удалите блокировку виртуальной машины или группы ресурсов виртуальной машины. Например, на следующем рисунке блокировка ресурса на виртуальной машине `MoveDemo` должна быть удалена:

   :::image type="content" source="./media/site-recovery-azure-to-azure-troubleshoot/vm-locks.png" alt-text="Снятие блокировки с виртуальной машины.":::

1. Скачайте скрипт, чтобы [Удалить устаревшую конфигурацию Site Recovery](https://github.com/AsrOneSdk/published-scripts/blob/master/Cleanup-Stale-ASR-Config-Azure-VM.ps1).
1. Запустите скрипт _Cleanup-stale-asr-config-Azure-VM.ps1_. Укажите **идентификатор подписки**, **группу ресурсов виртуальной машины** и **имя виртуальной машины** в качестве параметров.
1. Если появится запрос на ввод учетных данных Azure, укажите их. Затем убедитесь, что сценарий выполняется без сбоев.

## <a name="replication-not-enabled-on-vm-with-stale-resources-error-code-150226"></a>Репликация не включена на виртуальной машине с устаревшими ресурсами (код ошибки 150226)

### <a name="possible-causes"></a>Возможные причины

Виртуальная машина имеет устаревшую конфигурацию от предыдущей защиты Site Recovery.

Устаревшая конфигурация может возникать на виртуальной машине Azure, если вы включили репликацию для виртуальной машины Azure с помощью Site Recovery, а затем:

- Репликация отключена, но исходная виртуальная машина была заблокирована ресурсом.
- Вы удалили хранилище Site Recovery без явного отключения репликации на виртуальной машине.
- Вы удалили группу ресурсов, содержащую хранилище Site Recovery, без явного отключения репликации на виртуальной машине.

### <a name="fix-the-problem"></a>Устранение проблемы

> [!NOTE]
> Во время выполнения этих действий Site Recovery не удаляет исходную виртуальную машину или не влияет на нее каким бы то ни было.

1. Удалите блокировку виртуальной машины или группы ресурсов виртуальной машины. Например, на следующем рисунке блокировка ресурса на виртуальной машине `MoveDemo` должна быть удалена:

   :::image type="content" source="./media/site-recovery-azure-to-azure-troubleshoot/vm-locks.png" alt-text="Снятие блокировки с виртуальной машины.":::

1. Скачайте скрипт, чтобы [Удалить устаревшую конфигурацию Site Recovery](https://github.com/AsrOneSdk/published-scripts/blob/master/Cleanup-Stale-ASR-Config-Azure-VM.ps1).
1. Запустите скрипт _Cleanup-stale-asr-config-Azure-VM.ps1_. Укажите **идентификатор подписки**, **группу ресурсов виртуальной машины** и **имя виртуальной машины** в качестве параметров.
1. Если появится запрос на ввод учетных данных Azure, укажите их. Затем убедитесь, что сценарий выполняется без сбоев.

## <a name="cant-select-vm-or-resource-group-in-enable-replication-job"></a>Не удается выбрать виртуальную машину или группу ресурсов в "включить задание репликации"

### <a name="issue-1-the-resource-group-and-source-vm-are-in-different-locations"></a>Причина 1. Группа ресурсов и исходная виртуальная машина находятся в разных расположениях

Site Recovery в настоящее время требуется, чтобы группа ресурсов исходного региона и виртуальные машины находящегося в одном расположении. Если это не так, вы не сможете найти виртуальную машину или группу ресурсов при попытке применения защиты.

В качестве обходного решения можно включить репликацию из виртуальной машины, а не из хранилища служб восстановления. Перейдите в раздел свойства **исходной виртуальной машины**  >    >  **Аварийное восстановление** и включите репликацию.

### <a name="issue-2-the-resource-group-isnt-part-of-the-selected-subscription"></a>Причина 2. Группа ресурсов не входит в выбранную подписку.

Возможно, вы не сможете найти группу ресурсов во время защиты, если группа ресурсов не входит в выбранную подписку. Убедитесь, что группа ресурсов принадлежит подписке, которую вы используете.

### <a name="issue-3-stale-configuration"></a>Причина 3. устаревшая конфигурация

Если на виртуальной машине Azure существует устаревшая конфигурация Site Recovery, вы можете не увидеть виртуальную машину, которую вы хотите включить для репликации. Это состояние может произойти, если вы включили репликацию для виртуальной машины Azure с помощью Site Recovery, а затем:

- Вы удалили хранилище Site Recovery без явного отключения репликации на виртуальной машине.
- Вы удалили группу ресурсов, содержащую хранилище Site Recovery, без явного отключения репликации на виртуальной машине.
- Репликация отключена, но исходная виртуальная машина была заблокирована ресурсом.

### <a name="fix-the-problem"></a>Устранение проблемы

> [!NOTE]
> Обязательно обновите `AzureRM.Resources` модуль перед тем, как использовать сценарий, упомянутый в этом разделе. Во время выполнения этих действий Site Recovery не удаляет исходную виртуальную машину или не влияет на нее каким бы то ни было.

1. Удалите блокировку, если она есть, из виртуальной машины или группы ресурсов виртуальной машины. Например, на следующем рисунке блокировка ресурса на виртуальной машине `MoveDemo` должна быть удалена:

   :::image type="content" source="./media/site-recovery-azure-to-azure-troubleshoot/vm-locks.png" alt-text="Снятие блокировки с виртуальной машины.":::

1. Скачайте скрипт, чтобы [Удалить устаревшую конфигурацию Site Recovery](https://github.com/AsrOneSdk/published-scripts/blob/master/Cleanup-Stale-ASR-Config-Azure-VM.ps1).
1. Запустите скрипт _Cleanup-stale-asr-config-Azure-VM.ps1_. Укажите **идентификатор подписки**, **группу ресурсов виртуальной машины** и **имя виртуальной машины** в качестве параметров.
1. Если появится запрос на ввод учетных данных Azure, укажите их. Затем убедитесь, что сценарий выполняется без сбоев.

## <a name="unable-to-select-a-vm-for-protection"></a>Не удалось выбрать виртуальную машину для защиты

### <a name="possible-cause"></a>Возможные причины

Расширение виртуальной машины установлено в состоянии сбоя или без реагирования

### <a name="fix-the-problem"></a>Устранение проблемы

Перейдите в раздел Параметры **виртуальной машины**  >    >  **расширения** и проверьте наличие расширений в состоянии сбоя. Удалите все неудачные расширения и повторите попытку, чтобы защитить виртуальную машину.

## <a name="vm-provisioning-state-isnt-valid-error-code-150019"></a>Состояние подготовки виртуальной машины недопустимо (код ошибки 150019)

Чтобы включить репликацию на виртуальной машине, ее состояние подготовки должно быть **установлено**. Выполните следующие действия, чтобы проверить состояние подготовки.

1. В портал Azure выберите **Обозреватель ресурсов** из **всех служб**.
1. Разверните список **Подписки** и выберите нужную подписку.
1. Разверните список **ResourceGroups** и выберите группу ресурсов, к которой относится виртуальная машина.
1. Разверните список **ресурсы** и выберите свою виртуальную машину.
1. Проверьте поле **provisioningState** в представлении экземпляров с правой стороны.

### <a name="fix-the-problem"></a>Устранение проблемы

- Если **ProvisioningState** **не удалось**, обратитесь в службу поддержки со сведениями для устранения неполадок.
- Если **provisioningState** **обновляется, может** быть развернуто другое расширение. Проверьте, нет ли текущих операций на виртуальной машине, дождитесь их завершения и повторите задание Site Recovery сбоя, чтобы включить репликацию.

## <a name="unable-to-select-target-vm"></a>Не удалось выбрать целевую виртуальную машину

### <a name="issue-1-vm-is-attached-to-a-network-thats-already-mapped-to-a-target-network"></a>Причина 1. Виртуальная машина подключена к сети, которая уже сопоставлена с целевой сетью

Если в конфигурации аварийного восстановления исходная виртуальная машина является частью виртуальной сети, а другая виртуальная машина из той же виртуальной сети уже сопоставлена с сетью в Целевой группе ресурсов, раскрывающийся список "Выбор сети" недоступен (отображается серым цветом) по умолчанию.

:::image type="content" source="./media/site-recovery-azure-to-azure-troubleshoot/unabletoselectnw.png" alt-text="Список выбора сети недоступен.":::

### <a name="issue-2-you-previously-protected-the-vm-and-then-you-disabled-the-replication"></a>Вопрос 2. Вы ранее защитили виртуальную машину, а затем отключили репликацию

Отключение репликации виртуальной машины не приводит к удалению сетевого сопоставления. Сопоставление должно быть удалено из хранилища служб восстановления, в котором была защищена виртуальная машина. Выберите **хранилище служб восстановления** и перейдите к разделу **Управление**  >  **инфраструктурой Site Recovery**  >  **для**  >  **сетевого сопоставления** виртуальных машин Azure.

:::image type="content" source="./media/site-recovery-azure-to-azure-troubleshoot/delete_nw_mapping.png" alt-text="Удаление сетевого сопоставления.":::

Целевая сеть, настроенная во время настройки аварийного восстановления, может быть изменена после начальной установки и после защиты виртуальной машины. Чтобы **изменить сетевое сопоставление** , выберите имя сети:

:::image type="content" source="./media/site-recovery-azure-to-azure-troubleshoot/modify_nw_mapping.png" alt-text="Измените Сетевое сопоставление.":::


## <a name="com-or-vss-error-code-151025"></a>COM+ или VSS (код ошибки 151025)

При возникновении ошибки COM+ или служба теневого копирования томов (VSS) отображается следующее сообщение:

```Output
Site Recovery extension failed to install.
```

### <a name="possible-causes"></a>Возможные причины

- Служба приложений системы COM+ отключена.
- Служба теневого копирования томов отключена.

### <a name="fix-the-problem"></a>Устранение проблемы

Задайте Системное приложение COM+ и служба теневого копирования томов в автоматическом или ручном режиме запуска.

1. Откройте консоль службы в Windows.
1. Убедитесь, что в качестве **типа запуска** для системного приложения COM+ и служба теневого копирования томов не задано значение **отключено** .

   :::image type="content" source="./media/azure-to-azure-troubleshoot-errors/com-error.png" alt-text="Проверьте тип запуска COM и системного приложения и служба теневого копирования томов.":::

## <a name="unsupported-managed-disk-size-error-code-150172"></a>Неподдерживаемый размер управляемого диска (код ошибки 150172)

При возникновении этой ошибки отображается следующее сообщение:

```Output
Protection couldn't be enabled for the virtual machine as it has <DiskName> with size <DiskSize> that is lesser than the minimum supported size 1024 MB.
```

### <a name="possible-cause"></a>Возможные причины

Размер диска меньше поддерживаемого размера в 1024 МБ.

### <a name="fix-the-problem"></a>Устранение проблемы

Убедитесь, что размер диска находится в пределах поддерживаемого диапазона размеров, и повторите операцию.

## <a name="protection-not-enabled-when-grub-uses-device-name-error-code-151126"></a>Защита не включена, если в GRUB используется имя устройства (код ошибки 151126)

### <a name="possible-causes"></a>Возможные причины

Файлы конфигурации общего унифицированного загрузчика (GRUB) Linux (_/Boot/GRUB/menu.lst_, _/Бут/груб/груб.КФГ_, _/Boot/grub2/GRUB.cfg_ или _/etc/default/grub_) могут указывать фактические имена устройств вместо универсальных уникальных идентификаторов (UUID) для `root` `resume` параметров и. Site Recovery требуются UUID, так как имена устройств могут изменяться. После перезагрузки виртуальная машина может не иметь такого же имени при отработке отказа, что приведет к проблемам.

Ниже приведены примеры строк из файлов GRUB, в которых вместо требуемых UUID отображаются имена устройств.

- _/Boot/grub2/GRUB.cfg_ файла:

  `linux /boot/vmlinuz-3.12.49-11-default root=/dev/sda2  ${extra_cmdline} resume=/dev/sda1 splash=silent quiet showopts`

- Файл: _/Boot/GRUB/menu.lst_

  `kernel /boot/vmlinuz-3.0.101-63-default root=/dev/sda2 resume=/dev/sda1 splash=silent crashkernel=256M-:128M showopts vga=0x314`

### <a name="fix-the-problem"></a>Устранение проблемы

Замените имя каждого устройства соответствующим UUID:

1. Найдите UUID устройства, выполнив команду `blkid <device name>` . Пример:

   ```shell
   blkid /dev/sda1
   /dev/sda1: UUID="6f614b44-433b-431b-9ca1-4dd2f6f74f6b" TYPE="swap"
   blkid /dev/sda2
   /dev/sda2: UUID="62927e85-f7ba-40bc-9993-cc1feeb191e4" TYPE="ext3"
   ```

1. Замените имя устройства UUID в форматах `root=UUID=<UUID>` и `resume=UUID=<UUID>` . Например, после замены строка из _/Boot/GRUB/menu.lst_ будет выглядеть, как в следующей строке:

   `kernel /boot/vmlinuz-3.0.101-63-default root=UUID=62927e85-f7ba-40bc-9993-cc1feeb191e4 resume=UUID=6f614b44-433b-431b-9ca1-4dd2f6f74f6b splash=silent crashkernel=256M-:128M showopts vga=0x314`

1. Повторите защиту.

## <a name="protection-failed-because-grub-device-doesnt-exist-error-code-151124"></a>Сбой защиты, так как устройство GRUB не существует (код ошибки 151124)

### <a name="possible-cause"></a>Возможные причины

Файлы конфигурации GRUB (_/Boot/GRUB/menu.lst_, _/Бут/груб/груб.КФГ_, _/Boot/grub2/GRUB.cfg_ или _/etc/default/grub_) могут содержать параметры `rd.lvm.lv` или `rd_LVM_LV` . Эти параметры определяют устройства диспетчера логических томов (LVM), которые должны быть обнаружены во время загрузки. Если эти устройства LVM не существуют, защищенная система не загрузится и будет зависнуть в процессе загрузки. Эта же проблема также будет отображаться на виртуальной машине отработки отказа. Рассмотрим несколько примеров.

- Файл: _/Boot/grub2/GRUB.cfg_ на RHEL7:

  `linux16 /vmlinuz-3.10.0-957.el7.x86_64 root=/dev/mapper/rhel_mup--rhel7u6-root ro crashkernel=128M\@64M rd.lvm.lv=rootvg/root rd.lvm.lv=rootvg/swap rhgb quiet LANG=en_US.UTF-8`

- Файл: _/etc/default/grub_ на RHEL7:

  `GRUB_CMDLINE_LINUX="crashkernel=auto rd.lvm.lv=rootvg/root rd.lvm.lv=rootvg/swap rhgb quiet`

- Файл: _/Boot/GRUB/menu.lst_ на RHEL6:

  `kernel /vmlinuz-2.6.32-754.el6.x86_64 ro root=UUID=36dd8b45-e90d-40d6-81ac-ad0d0725d69e rd_NO_LUKS LANG=en_US.UTF-8 rd_NO_MD SYSFONT=latarcyrheb-sun16 crashkernel=auto rd_LVM_LV=rootvg/lv_root  KEYBOARDTYPE=pc KEYTABLE=us rd_LVM_LV=rootvg/lv_swap rd_NO_DM rhgb quiet`

В каждом примере GRUB должен обнаруживать два LVM устройства с именами `root` и `swap` из группы томов `rootvg` .

### <a name="fix-the-problem"></a>Устранение проблемы

Если устройство LVM не существует, создайте его или удалите соответствующие параметры из файлов конфигурации GRUB. Затем повторите попытку, чтобы включить защиту.

## <a name="mobility-service-update-finished-with-warnings-error-code-151083"></a>Обновление службы Mobility Service завершено с предупреждениями (код ошибки 151083)

Служба Site Recovery Mobility Service имеет много компонентов, одна из которых называется драйвером фильтра. Драйвер фильтра загружается в системную память только во время перезапуска системы. Всякий раз, когда обновление службы Mobility включает изменения драйвера фильтра, компьютер обновляется, но по-прежнему отображается предупреждение о том, что некоторые исправления нуждаются в перезагрузке. Предупреждение появляется, потому что исправления драйвера фильтра могут вступить в силу только после загрузки нового драйвера фильтра, который происходит только при перезапуске.

> [!NOTE]
> Это всего лишь предупреждение. Существующая репликация продолжит работать даже после нового обновления агента. Вы можете перезапускать каждый раз, когда вы хотите воспользоваться преимуществами нового драйвера фильтра, но старый драйвер фильтра продолжает работать, если не перезапускается.
>
> Помимо драйвера фильтра, преимущества любых других усовершенствований и исправлений в обновлении службы Mobility вступят в силу без перезагрузки.

## <a name="protection-not-enabled-if-replica-managed-disk-exists"></a>Защита не включена, если существует управляемый диск реплики

Эта ошибка возникает, если управляемый диск реплики уже существует, без ожидаемых тегов в Целевой группе ресурсов.

### <a name="possible-cause"></a>Возможные причины

Эта проблема может возникать, если ранее была защищена виртуальная машина, и когда репликация была отключена, диск реплики не был удален.

### <a name="fix-the-problem"></a>Устранение проблемы

Удалите диск реплики, указанный в сообщении об ошибке, и повторите задание защиты, завершившееся сбоем.

## <a name="enable-protection-failed-as-the-installer-is-unable-to-find-the-root-disk-error-code-151137"></a>Не удалось включить защиту, так как установщик не может найти корневой диск (код ошибки 151137).

Эта ошибка возникает для компьютеров Linux, на которых диск ОС шифруется с помощью шифрования дисков Azure (ADE). Это допустимая проблема только в агенте версии 9,35.

### <a name="possible-causes"></a>Возможные причины

Установщику не удалось найти корневой диск, на котором размещена корневая файловая система.

### <a name="fix-the-problem"></a>Устранение проблемы

Чтобы устранить эту проблему, выполните действия, описанные ниже.

1. Найдите биты агента в каталоге _/var/lib/waagent_ на компьютерах RHEL и CentOS с помощью следующей команды: <br>

    `# find /var/lib/ -name Micro\*.gz`

   Ожидаемые выходные данные:

    `/var/lib/waagent/Microsoft.Azure.RecoveryServices.SiteRecovery.LinuxRHEL7-1.0.0.9139/UnifiedAgent/Microsoft-ASR_UA_9.35.0.0_RHEL7-64_GA_30Jun2020_release.tar.gz`

2. Создайте новый каталог и измените каталог на этот новый каталог.
3. Извлеките файл агента, который находится на первом шаге, с помощью следующей команды:

    `tar -xf <Tar Ball File>`

4. Откройте файл _prereq_check_installer.js_ и удалите следующие строки. Сохраните файл после этого.

    ```
       {
          "CheckName": "SystemDiskAvailable",
          "CheckType": "MobilityService"
       },
    ```
5. Запустите установщик с помощью команды: <br>

    `./install -d /usr/local/ASR -r MS -q -v Azure`
6. Если установщик будет выполнен, повторите задание включить репликацию.

## <a name="next-steps"></a>Дальнейшие действия

[Репликация виртуальных машин Azure в другой регион Azure](azure-to-azure-how-to-enable-replication.md)