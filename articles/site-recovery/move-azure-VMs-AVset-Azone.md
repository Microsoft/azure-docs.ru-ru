---
title: Перемещение виртуальных машин в регион Azure с зонами доступности с помощью Azure Site Recovery
description: Узнайте, как переместить виртуальные машины в зону доступности в другом регионе с помощью Site Recovery
services: site-recovery
author: sideeksh
ms.service: site-recovery
ms.topic: tutorial
ms.date: 01/28/2019
ms.author: sideeksh
ms.custom: MVC
ms.openlocfilehash: 8224ae4a48bb4915492240c414b90edb86a4c258
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "93393138"
---
# <a name="move-azure-vms-into-availability-zones"></a>Перенос виртуальных машин Azure в Зоны доступности

В этой статье описывается, как переместить виртуальные машины Azure в зону доступности в другом регионе. Если вы хотите выполнить перемещение в другую зону в том же регионе, [ознакомьтесь с этой статьей](./azure-to-azure-how-to-enable-zone-to-zone-disaster-recovery.md).


Зоны доступности в Azure помогают защитить приложения и данные от сбоев центра обработки данных. Каждая зона доступности состоит из одного или нескольких центров обработки данных, оснащенных независимыми системами электроснабжения, охлаждения и сетевого взаимодействия. Чтобы обеспечить отказоустойчивость, во всех включенных регионах используются минимум три отдельные зоны. Физическое разделение Зон доступности в пределах региона помогает защитить приложения и данные от сбоев центра обработки данных. С помощью Зон доступности Azure предлагает Соглашение об уровне обслуживания, гарантирующее доступность виртуальных машин на уровне 99,99 %. Как упоминалось в статье [Регионы с поддержкой Зон доступности](../availability-zones/az-region.md), Зоны доступности поддерживаются не во всех регионах.

В сценарии, где вы развернули виртуальные машины в качестве *единственного экземпляра* в конкретный регион и желаете повысить доступность, переместив их в Зону доступности, можете использовать Azure Site Recovery. Процесс можно разделить на подпроцессы:

- перенос одноэкземплярных виртуальных машин в Зоны доступности в целевом регионе;
- перенос виртуальных машин в группе доступности в Зоны доступности в целевом регионе.

> [!IMPORTANT]
> Чтобы переместить виртуальные машины Azure в зону доступности в другом регионе, мы рекомендуем использовать [Azure Resource Mover](../resource-mover/move-region-availability-zone.md). Resource Mover поддерживается в общедоступной предварительной версии и обеспечивает следующее.
> - Один центр для перемещения ресурсов между регионами.
> - Сокращение времени и упрощение при перемещении. Все, что вам нужно, находится в одном расположении.
> - Простой и согласованный процесс перемещения различных типов ресурсов Azure.
> - Простой способ обнаружения зависимостей между ресурсами, которые необходимо переместить. Это помогает перемещать связанные ресурсы вместе, чтобы после перемещения в целевом регионе все правильно работало.
> - Автоматическая очистка ресурсов в исходном регионе, если их нужно удалить после перемещения.
> - Тестирование. Вы можете попробовать выполнить перемещение, а затем отменить его, если не хотите выполнять полный переход.



## <a name="check-prerequisites"></a>Проверка предварительных требований

- Проверьте, имеет ли целевой регион [поддержку Зон доступности](../availability-zones/az-region.md). Убедитесь, что ваш выбор [сочетания исходного и целевого региона поддерживается](./azure-to-azure-support-matrix.md#region-support). Примите обоснованное решение относительно целевого региона.
- Вам должны быть понятны [архитектура и компоненты сценария](azure-to-azure-architecture.md).
- Просмотрите [ограничения и требования для поддержки](azure-to-azure-support-matrix.md).
- Проверьте разрешения учетной записи. Если вы создали бесплатную учетную запись Azure, вы являетесь администратором подписки. Если вы не администратор подписки, свяжитесь с администратором, чтобы получить необходимые разрешения. Чтобы включить репликацию для виртуальной машины и в конечном итоге скопировать данные в целевой объект с помощью Azure Site Recovery, необходимо следующее.

    1. Разрешение на создание виртуальной машины в ресурсах Azure. Встроенная роль *Участник виртуальных машин* обладает следующими разрешениями:
        - разрешение на создание виртуальной машины в выбранной группе ресурсов;
        - разрешение на создание виртуальной машины в выбранной виртуальной сети;
        - разрешение на запись в выбранной учетной записи хранения.

    2. Разрешение на управление задачами Azure Site Recovery. Роль *Участник Site Recovery* имеет все разрешения, необходимые для управления операциями Azure Site Recovery в хранилище Служб восстановления.

## <a name="prepare-the-source-vms"></a>Подготовка исходных виртуальных машин.

1. Если вы хотите переместить виртуальные машины в Зону доступности с помощью Site Recovery, они должны использовать управляемые диски. Вы можете преобразовать существующие виртуальные машины Windows, использующие неуправляемые диски, для использования управляемых дисков. Для этого следуйте инструкциям из статьи [Переключение виртуальной машины Windows с неуправляемых дисков на управляемые диски](../virtual-machines/windows/convert-unmanaged-to-managed-disks.md). Убедитесь, что группа доступности настроена как *управляемая*.
2. Убедитесь, что на виртуальных машинах Azure, которые следует перенести, установлены все новейшие корневые сертификаты. Если такие сертификаты отсутствуют, копирование данных в целевой регион невозможно включить из-за ограничений по соображениям безопасности.

3. При использовании виртуальных машин Windows установите на виртуальной машине все последние обновления Windows, чтобы гарантировать наличие всех доверенных корневых сертификатов. При работе в отключенной среде следуйте стандартным процедурам обновления Windows и сертификата в вашей организации.

4. На виртуальных машинах Linux выполните инструкции, предоставленные распространителем Linux, чтобы установить все свежие доверенные корневые сертификаты и список отзыва сертификатов.
5. Убедитесь, что для переносимых виртуальных машин не используется прокси-сервер аутентификации для управления подключением к сети.

6. Проверьте [требования к исходящим подключениям для виртуальных машин](azure-to-azure-tutorial-enable-replication.md#set-up-vm-connectivity).

7. Определите исходный сетевой макет и все ресурсы, которые вы сейчас используете для проверки, включая подсистемы балансировки нагрузки, группы безопасности сети (NSG) и общедоступные IP-адреса.

## <a name="prepare-the-target-region"></a>Подготовка целевого региона

1. Проверьте, позволяет ли ваша подписка Azure создавать виртуальные машины в целевом регионе, используемом для аварийного восстановления. При необходимости свяжитесь со службой поддержки, чтобы включить требуемые квоты.

2. Убедитесь, что подписка располагает достаточными ресурсами для поддержки виртуальных машин таких же размеров, которые установлены для исходных виртуальных машин. Если для копирования данных в целевой объект используется Site Recovery, эта служба выбирает для целевой виртуальной машины такой же или наиболее близкий к данному размер.

3. Создайте целевой ресурс для каждого компонента, указанного в исходном сетевом макете. Это действие позволяет виртуальным машинам иметь все функции и возможности исходных виртуальных машин после перехода в целевой регион.

    > [!NOTE]
    > При включении репликации для исходной виртуальной машины служба Azure Site Recovery автоматически обнаруживает и создает виртуальную сеть и учетную запись хранения. Вы также можете предварительно создать эти ресурсы и присвоить их виртуальной машине как часть этапа включения репликации. Любые другие ресурсы, как будет описано далее, необходимо создавать вручную в целевом регионе.

     Сведения о создании наиболее часто используемых сетевых ресурсов на основе конфигурации исходной виртуальной машины см. в следующих документах.

    - [Группы безопасности сети](../virtual-network/manage-network-security-group.md)
    - [Подсистемы балансировки нагрузки](../load-balancer/index.yml)
    - [Общедоступный IP-адрес](../virtual-network/virtual-network-public-ip-address.md)
    
   Сведения о других сетевых компонентах см. в [документации](../index.yml?pivot=products&panel=network) по сетям.

    > [!IMPORTANT]
    > Убедитесь, что в целевом объекте используется подсистема балансировки нагрузки, избыточная между зонами. Дополнительные сведения см. в статье [Azure Load Balancer уровня "Стандартный" и зоны доступности](../load-balancer/load-balancer-standard-availability-zones.md).

4. Вручную [создайте непроизводственную сеть](../virtual-network/quick-create-portal.md) в целевом регионе, если хотите проверить конфигурацию перед выполнением перехода в целевой регион. Мы рекомендуем этот подход, так как благодаря ему происходят минимальные помехи в рабочей среде.

## <a name="enable-replication"></a>Включение репликации
Шаги по включению репликации данных в целевой регион с помощью Azure Site Recovery перед их последующим перенесением в Зоны доступности указаны ниже.

> [!NOTE]
> Эти действия предназначены для одной виртуальной машины. Такие же действия могут применяться к нескольким виртуальным машинам. Перейдите в хранилище Служб восстановления, щелкните **+ Реплицировать** и выберите соответствующие виртуальные машины.

1. На портале Azure щелкните **Виртуальные машины** и выберите виртуальную машину, которую требуется перенести в Зоны доступности.
2. В разделе **Операции** щелкните **Аварийное восстановление**.
3. В разделе **Настройка аварийного восстановления** > **Целевой регион** выберите целевой регион, в который будет выполняться репликация. Убедитесь, что этот регион [поддерживает](../availability-zones/az-region.md) Зоны доступности.
4. По завершении выберите **Next: Расширенные параметры**.
5. Выберите соответствующие значения для целевой подписки, целевой группы ресурсов виртуальной машины и виртуальной сети.
6. В разделе **Доступность** выберите Зону доступности, в которую требуется перенести виртуальную машину. 
   > [!NOTE]
   > Если параметр выбора группы доступности или Зоны доступности не отображается, убедитесь, что [предварительные требования](#prepare-the-source-vms) выполнены, а [подготовка](#prepare-the-source-vms) исходных виртуальных машин завершена.
  

7. Выберите **Включить репликацию**. Это действие запускает задание для включения репликации виртуальной машины.

## <a name="check-settings"></a>Проверка параметров

После завершения задания репликации можно проверить состояние репликации, изменить параметры настройки репликации и протестировать развертывание.

1. В меню виртуальной машины щелкните **Аварийное восстановление**.
2. Вы можете проверить работоспособность репликации, созданные точки восстановления и источник, а также целевые регионы на карте.


## <a name="test-the-configuration"></a>Тестирование конфигурации

1. В меню виртуальной машины выберите **Аварийное восстановление**.
2. Щелкните значок **Тестовая отработка отказа**.
3. На странице **Тестовая отработка отказа** выберите точку восстановления.

   - **Последняя обработанная**. Отработка отказа выполняется до последней точки восстановления виртуальной машины, которая была обработана службой Site Recovery. Для нее отображается метка времени. Этот вариант не требует времени на обработку данных, обеспечивая низкий показатель целевого времени восстановления.
   - **Последняя с согласованием приложений**. Отработка отказа всех виртуальных машин выполняется до последней точки восстановления с согласованным состоянием приложений. Для нее отображается метка времени.
   - **Пользовательский**. Вы можете выбрать любую точку восстановления.

3. Чтобы проверить конфигурацию, выберите целевую тестовую виртуальную сеть Azure, в которую вы хотите переместить виртуальные машины Azure. 

    > [!IMPORTANT]
    > Для отработки отказа мы рекомендуем использовать отдельную сеть виртуальных машин Azure, а не рабочую сеть в целевом регионе, в который вы планируете перенести свои виртуальные машины.

4. Чтобы начать тестирование переноса, щелкните **ОК**. Чтобы следить за ходом выполнения, выберите виртуальную машину и откройте ее свойства. Вы также можете щелкнуть задание **Тестовая отработка отказа** в имени хранилища > **Параметры** > **Задания** > **Задания Site Recovery**.
5. Когда отработка отказа завершится, на вкладке **Виртуальные машины** портала Azure появится реплика виртуальной машины. Убедитесь, что виртуальная машина работает, имеет соответствующий размер и подключена к соответствующей сети.
6. Если вы хотите удалить виртуальную машину, созданную в ходе тестирования переноса, выберите **Очистить тестовую отработку отказа** для реплицированного элемента. При необходимости в разделе **Примечания** можно записать и сохранить сведения о тестировании.

## <a name="move-to-the-target-region-and-confirm"></a>Выполнение и подтверждение переноса в целевой регион

1.  В меню виртуальной машины выберите **Аварийное восстановление**.
2. Выберите значок **Тестовая отработка отказа**.
3. В области **Отработка отказа** выберите **Последнее**. 
4. Выберите **Завершение работы виртуальной машины перед началом отработки отказа**. Site Recovery попытается выключить исходную виртуальную машину перед запуском отработки отказа. Отработка отказа продолжится, даже если их не удастся отключить. На странице **Задания** можно следить за ходом выполнения отработки отказа. 
5. Когда задание будет завершено, проверьте, отображается ли виртуальная машина в целевом регионе Azure, как и ожидалось.
6. В разделе **Реплицированные элементы** нажмите правой кнопкой мыши пункт "Виртуальная машина" и выберите **Зафиксировать**. Перенос в целевой регион будет завершен. Дождитесь завершения задания.

## <a name="discard-the-resource-in-the-source-region"></a>Отмена ресурса в исходном регионе

Перейдите к виртуальной машине. Щелкните **Отключить репликацию**. Это действие останавливает процесс копирования данных для виртуальной машины.  

> [!IMPORTANT]
> Выполните предыдущий шаг, чтобы не платить за репликацию Azure Site Recovery после перемещения. Параметры репликации в источнике автоматически очищаются. Обратите внимание, что расширение Site Recovery, устанавливаемое в рамках репликации, автоматически не удаляется. Его необходимо удалить вручную.

## <a name="next-steps"></a>Дальнейшие действия

В этом руководстве вы узнали, как повысить доступность виртуальной машины Azure, перенеся ее в группу доступности или Зону доступности. Теперь для перенесенной виртуальной машины вы можете настроить аварийное восстановление.

> [!div class="nextstepaction"]
> [Настройка аварийного восстановления после миграции](azure-to-azure-quickstart.md)
