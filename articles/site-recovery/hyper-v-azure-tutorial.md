---
title: Настройка аварийного восстановления Hyper-V с помощью Azure Site Recovery
description: Узнайте, как настроить аварийное восстановление локальных виртуальных машин Hyper-V (без VMM) в Azure с помощью Site Recovery.
ms.service: site-recovery
ms.topic: tutorial
ms.date: 11/12/2019
ms.custom: MVC
ms.openlocfilehash: 0c98728b0da92e198e158cef29e69b2f60818770
ms.sourcegitcommit: d63f15674f74d908f4017176f8eddf0283f3fac8
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/07/2021
ms.locfileid: "106580866"
---
# <a name="set-up-disaster-recovery-of-on-premises-hyper-v-vms-to-azure"></a>Настройка аварийного восстановления локальных виртуальных машин Hyper-V в Azure

Служба [Azure Site Recovery](site-recovery-overview.md) помогает реализовать стратегию аварийного восстановления за счет управления процессами репликации, отработки отказа и восстановления локальных компьютеров и виртуальных машин Azure.

Это третье руководство в серии. В нем показано, как настроить аварийное восстановление локальных виртуальных машин Hyper-V в Azure. Этот учебник предназначен для виртуальных машин Hyper-V, управление которыми осуществляется не в System Center Virtual Machine Manager (VMM).

В этом руководстве описано следующее:

> [!div class="checklist"]
> * Выбор источника и целевого объекта репликации.
> * Настройка среды исходной репликации, включая локальные компоненты Site Recovery и целевую среду репликации.
> * Создание политики репликации.
> * Включение репликации для виртуальных машин.

> [!NOTE]
> В учебниках описан самый простой способ развертывания для определенного сценария. В них везде, где возможно, используются значения по умолчанию, и описаны не все возможные параметры и пути. Подробные инструкции см. в разделе **Практические руководства** в [документации по Site Recovery](./index.yml).



## <a name="before-you-begin"></a>Перед началом

Это третье руководство в серии. В нем предполагается, что вы уже выполнили задачи из предыдущих учебников.

1. [Подготовка Azure](tutorial-prepare-azure.md)
2. [Подготовка локальных серверов Hyper-V](./hyper-v-prepare-on-premises-tutorial.md)

## <a name="select-a-replication-goal"></a>Выбор цели репликации

1. На портале Azure откройте **хранилища служб восстановления** и выберите хранилище. Мы подготовили хранилище **ContosoVMVault** в предыдущем учебнике.
2. В разделе **Приступая к работе** выберите **Site Recovery**, а затем — **Подготовка инфраструктуры**.
3. Выберите **Цель защиты** > **Где расположены компьютеры?** , а затем — **Локально**.
4. В разделе **Куда следует реплицировать компьютеры?** выберите **To Azure** (В Azure).
5. В разделе **Ваши компьютеры виртуализированы?** выберите **Да, с Hyper-V**.
6. В поле **Are you using System Center VMM to manage your Hyper-V hosts?** (Используете ли вы System Center VMM для управления узлами Hyper-V?) выберите **Нет**.
7. Щелкните **ОК**.

    ![Снимок экрана с параметрами цели защиты при подготовке инфраструктуры.](./media/hyper-v-azure-tutorial/replication-goal.png)

## <a name="confirm-deployment-planning"></a>Подтверждение планирования развертывания

1. Если вы планируете выполнить крупномасштабное развертывание, скачайте Планировщик развертывания для Hyper-V, перейдя по ссылке, указанной на странице **Планирование развертывания**. [Ознакомьтесь с дополнительными сведениями](hyper-v-deployment-planner-overview.md) о планировании развертывания Hyper-V.
2. В рамках этого учебника мы не будем использовать Планировщик развертывания. В разделе **Вы выполнили планирование развертывания?** выберите **Выполню позже** и нажмите кнопку **ОК**.

    ![Снимок экрана с параметрами планирования развертывания при подготовке инфраструктуры.](./media/hyper-v-azure-tutorial/deployment-planning.png)

## <a name="set-up-the-source-environment"></a>Настройка исходной среды

Чтобы настроить исходную среду, создайте сайт Hyper-V и добавьте ему узлы Hyper-V, содержащие виртуальные машины, которые необходимо реплицировать. Затем скачайте и установите поставщик Azure Site Recovery и агент Служб восстановления Azure для каждого узла, а затем в хранилище зарегистрируйте сайт Hyper-V.

1. В разделе **Подготовка инфраструктуры** выберите **Источник**.
2. В разделе **Подготовка источника** выберите **+ Hyper-V Site** (+ Сайт Hyper-V).
3. В разделе **Создание сайта Hyper-V** укажите имя сайта. Мы используем **ContosoHyperVSite**.

    ![Снимок экрана с выбором сайта Hyper-V при подготовке инфраструктуры.](./media/hyper-v-azure-tutorial/hyperv-site.png)

4. После создания сайта выберите **Подготовка источника** > **Step 1: Select Hyper-V site** (Шаг 1. Выбор сайта Hyper-V), а затем выберите созданный сайт.
5. Выберите **+ Hyper-V Server** (+ Сервер Hyper-V).

    ![Снимок экрана с выбором сервера Hyper-V при подготовке инфраструктуры.](./media/hyper-v-azure-tutorial/hyperv-server.png)

6. Скачайте программу установки поставщика Microsoft Azure Site Recovery.
7. Скачайте ключ регистрации хранилища. Он понадобится для установки поставщика. Ключ действителен в течение пяти дней после создания.

    ![Снимок экрана с параметрами для скачивания поставщика и ключа регистрации.](./media/hyper-v-azure-tutorial/download.png)
    

### <a name="install-the-provider"></a>Установка поставщика

Установите скачанный файл установки (AzureSiteRecoveryProvider.exe) на каждом узле Hyper-V, добавленном на сайт Hyper-V. При этом на каждом компьютере Hyper-V будет установлен поставщик Azure Site Recovery и агент Служб восстановления.

1. Запустите файл установки.
2. В мастере установки поставщика Azure Site Recovery в разделе **Центр обновления Майкрософт** согласитесь на использование Центра обновления Майкрософт для проверки наличия обновлений поставщика.
3. На странице **Установка** примите расположение установки по умолчанию для поставщика и агента и выберите **Установить**.
4. После установки в мастере регистрации Microsoft Azure Site Recovery в разделе **Параметры хранилища** выберите **Обзор**, а в поле **Файл ключа** выберите скачанный файл ключа хранилища.
5. Укажите подписку Azure Site Recovery, имя хранилища (**ContosoVMVault**) и сайта Hyper-V (**ContosoHyperVSite**), к которому относится сервер Hyper-V.
6. В разделе **Параметры прокси** выберите **Подключиться к Azure Site Recovery напрямую без прокси-сервера**.
7. После регистрации сервера в хранилище в разделе **Регистрация** выберите **Готово**.

Azure Site Recovery извлечет метаданные с сервера Hyper-V, а сам сервер отобразится в колонке **Site Recovery Infrastructure** (Инфраструктура Site Recovery) > **Hyper-V Hosts** (Узлы Hyper-V). Этот процесс может занять до 30 минут.

#### <a name="install-the-provider-on-a-hyper-v-core-server"></a>Установка поставщика на основном сервере Hyper-V

Если вы используете основной сервер Hyper-V, скачайте файл установки и сделайте следующее:

1. Извлеките файлы из AzureSiteRecoveryProvider.exe в локальный каталог, выполнив следующую команду:

    `AzureSiteRecoveryProvider.exe /x:. /q`
 
2. Выполните `.\setupdr.exe /i`. Результаты будут записаны в журнал %Programdata%\ASRLogs\DRASetupWizard.log.

3. Зарегистрируйте сервер с помощью следующей команды:

    ```
    cd  "C:\Program Files\Microsoft Azure Site Recovery Provider\DRConfigurator.exe" /r /Friendlyname "FriendlyName of the Server" /Credentials "path to where the credential file is saved"
    ```

## <a name="set-up-the-target-environment"></a>Настройка целевой среды

Выберите и проверьте целевые ресурсы:

1. Выберите **Подготовка инфраструктуры** > **Целевой объект**.
2. Выберите подписку и группу ресурсов **ContosoRG**, в которых будут создаваться виртуальные машины Azure после отработки отказа.
3. Выберите модель развертывания **Resource Manager**.

Site Recovery проверяет наличие одной или нескольких совместимых учетных записей хранения и сетей Azure.

## <a name="set-up-a-replication-policy"></a>Настройка политики репликации

1. Выберите **Подготовка инфраструктуры** > **Параметры репликации** >  **+ Create and associate** (+ Создание и связывание).
2. На странице **Создать и связать политику** укажите имя политики. Мы используем **ContosoReplicationPolicy**.
3. В рамках этого учебника мы оставим значения по умолчанию.
    - В поле **Периодичность копирования** указывается, как часто реплицируются разностные данные (после начальной репликации). Частота по умолчанию — каждые пять минут.
    - В поле **Хранение точки восстановления** указывается, что точки восстановления будут хранится на протяжении двух часов. Максимально допустимое значение срока хранения при защите виртуальных машин, размещенных на узлах Hyper-V, составляет 24 часа.
    - В поле **Периодичность создания моментальных снимков с согласованием приложений** указывается, что точки восстановления, содержащие моментальные снимки, согласованные на уровне приложений, будут создаваться ежечасно.
    - В поле **Время начала первичной репликации** указывается, что начальная репликация начнется немедленно.
4. После создания политики нажмите кнопку **OК**. При создании политики она автоматически сопоставляется с указанным сайтом Hyper-V. В нашем учебнике это **ContosoHyperVSite**.

    ![Политика репликации](./media/hyper-v-azure-tutorial/replication-policy.png)

## <a name="enable-replication"></a>Включение репликации

1. В разделе **Репликация приложения** выберите **Источник**.
2. В разделе **Источник** выберите сайт **ContosoHyperVSite**. Нажмите кнопку **ОК**.
3. В разделе **Цель** проверьте целевой объект (Azure), а также подписку хранилища и убедитесь, что выбрана модель развертывания **Resource Manager**.
4. Если вы используете параметры, указанные в этом учебнике, выберите учетную запись хранения **contosovmsacct1910171607**, созданную в рамках предыдущего учебника, для реплицируемых данных. Выберите также сеть **ContosoASRnet**, в которой будут располагаться виртуальные машины Azure после отработки отказа.
5. Щелкните **Виртуальные машины** > **Выбрать** и выберите виртуальную машину, которую необходимо реплицировать. Нажмите кнопку **ОК**.

   Ход выполнения действия **включения защиты** можно отслеживать, выбрав **Задания** > **Задания Azure Site Recovery**. После выполнения задания **Завершить подготовку защиты** начальная репликация завершается, а виртуальная машина готова к отработке отказа.

## <a name="next-steps"></a>Дальнейшие действия
> [!div class="nextstepaction"]
> [Выполнение отработки аварийного восстановления](tutorial-dr-drill-azure.md)
