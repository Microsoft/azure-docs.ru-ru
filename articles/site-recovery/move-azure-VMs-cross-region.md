---
title: Перемещение виртуальных машин Azure в другой регион с помощью Azure Site Recovery
description: Используйте службу Azure Site Recovery для переноса виртуальных машин IaaS Azure из одного региона Azure в другой.
services: site-recovery
author: sideeksh
ms.service: site-recovery
ms.topic: tutorial
ms.date: 01/28/2019
ms.author: sideeksh
ms.custom: MVC
ms.openlocfilehash: 5ae930240872c00c8dbb45857e4e77d82766eadf
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "93398068"
---
# <a name="move-azure-vms-to-another-azure-region"></a>Перемещение виртуальных машин Azure в другой регион Azure

Чтобы повысить надежность, доступность, управление или систему управления, вам также потребуется переместить виртуальные машины Azure инфраструктуры как услуги (IaaS) из одного региона в другой. В этом руководстве показано, как выполнить перенос виртуальных машин в другой регион с помощью Azure Site Recovery. Вы узнаете, как:

> [!div class="checklist"]
> * проверка предварительных требований;
> * Подготовка исходных виртуальных машин.
> * Подготовка целевого региона
> * Копирование данных в целевой регион
> * Тестирование конфигурации
> * Выполнение перемещения.
> * Отмена ресурсов из исходного региона


> [!IMPORTANT]
> В этой статье описывается, как перемещать виртуальные машины Azure между регионами *без изменений*. Сведения об улучшении инфраструктуры путем перемещения виртуальных машин в зоны доступности см. в статье [Перенос виртуальных машин Azure в Зоны доступности](move-azure-vms-avset-azone.md).

## <a name="prerequisites"></a>Предварительные требования

- Убедитесь, что виртуальные машины Azure находятся в исходном регионе Azure, из *которого* необходимо выполнить перенос.
- Убедитесь, что выбранная вами [комбинация исходного и целевого региона](./azure-to-azure-support-matrix.md#region-support) поддерживается и тщательно выберите целевой регион.
- Вам должны быть понятны [архитектура и компоненты сценария](azure-to-azure-architecture.md).
- Просмотрите [ограничения и требования для поддержки](azure-to-azure-support-matrix.md).
- Проверьте разрешения для учетной записи. Если вы создали бесплатную учетную запись Azure, *вы* являетесь администратором подписки. Если вы не администратор, свяжитесь с администратором, чтобы получить необходимые разрешения.
  -  Чтобы включить репликацию для виртуальной машины и с помощью Site Recovery скопировать данные в целевую машину необходимо обладать разрешениями на создание виртуальной машины в ресурсах Azure. Встроенная роль "Участник виртуальных машин" обладает такими разрешениями. При наличии разрешений вы можете создавать:
        - разрешение на создание виртуальной машины в выбранной группе ресурсов;
        - разрешение на создание виртуальной машины в выбранной виртуальной сети;
        - разрешение на запись в выбранной учетной записи хранения.

  - Кроме того, требуется разрешения на управление операциями Site Recovery. Роль "Участник Site Recovery" имеет все разрешения, необходимые для управления операциями Site Recovery в хранилище Служб восстановления Azure.

## <a name="prepare-the-source-vms"></a>Подготовка исходных виртуальных машин.

1. Проверьте виртуальные машины Azure, которые планируете переместить, на наличие корневых сертификатов последних версий. Если они отсутствуют, станет невозможно включить копирование данных в целевой регион (из-за ограничений безопасности).

    - При использовании виртуальных машин Windows установите последние обновления Windows, чтобы гарантировать присутствие всех доверенных корневых сертификатов на компьютере. При работе в отключенной среде следуйте стандартным процедурам обновления Windows и сертификата в вашей организации.
    - Чтобы получить все доверенные корневые сертификаты и список отзыва сертификатов последней версии на виртуальных машинах Linux, следует воспользоваться инструкциями поставщика ОС Linux.
2. Убедитесь, что для управления подключением к сети для виртуальных машин, которые планируете перенести, вы не будете использовать прокси-сервер аутентификации.
3. Если виртуальная машина, которую вы хотите переместить, не имеет доступ к Интернету и использует прокси-сервер брандмауэра для управления исходящим доступом, проверьте [соответствующие требования](azure-to-azure-tutorial-enable-replication.md#set-up-vm-connectivity).
4. В рамках проверки следует задокументировать исходный сетевой макет и все используемые ресурсы, включая (но не ограничиваясь ими) подсистемы балансировки нагрузки, группы безопасности сети и общедоступные IP-адреса.

## <a name="prepare-the-target-region"></a>Подготовка целевого региона

1. Убедитесь, что в подписке Azure можно создавать виртуальные машины в целевом регионе, используемом для аварийного восстановления. При необходимости свяжитесь со службой поддержки, чтобы включить требуемые квоты.

2. Убедитесь, что подписка располагает достаточными ресурсами, чтобы обеспечить исходные виртуальные машины. Если для копирования данных в целевой объект вы используете Site Recovery, эта служба выберет для целевой виртуальной машины такой же или другой наиболее доступный размер.

3. Убедитесь, что вы создали целевой ресурс для каждого компонента, который был указан в исходном сетевом макете. Это гарантирует, что виртуальные машины в целевом регионе будут обладать теми же компонентами и функциональностью, что и в исходном регионе.

   При включении репликации для исходной виртуальной машины служба Azure Site Recovery автоматически обнаруживает и создает виртуальную сеть и учетную запись хранения. Вы также можете предварительно создать эти ресурсы и присвоить их виртуальной машине как часть шага при включении репликации. Тем не менее, другие ресурсы в целевом регионе придется создать вручную. Сведения о создании часто используемых сетевых ресурсов на основе конфигурации исходной виртуальной машины см. в следующих статьях:

   - [Группы безопасности сети](../virtual-network/manage-network-security-group.md)
   - [Подсистемы балансировки нагрузки](../load-balancer/index.yml)
   - [Общедоступный IP-адрес](../virtual-network/virtual-network-public-ip-address.md)
    
   Сведения о других сетевых компонентах см. в [документации по сетям Azure](../index.yml?pivot=products&panel=network). 

4. Чтобы проверить конфигурацию перед выполнением перехода, в целевом регионе [создайте непроизводственную сеть](../virtual-network/quick-create-portal.md) вручную. Для процесса тестирования и настройки в рабочей среде будут созданы минимальные помехи (мы рекомендуем выполнить этот шаг).
    
## <a name="copy-data-to-the-target-region"></a>Копирование данных в целевой регион
Использование Azure Site Recovery для копирования данных в целевой регион, описано в действиях, приведенных далее.

### <a name="create-the-vault-in-any-region-except-the-source"></a>Создайте хранилище в любом регионе (кроме исходного).

1. Войдите на [портал Azure](https://portal.azure.com) > **Службы восстановления**.
2. Выберите **Создать ресурс** > **Средства управления** > **Backup and Site Recovery**.
3. В поле **Имя** укажите понятное имя **ContosoVMVault**. Если у вас есть несколько подписок, выберите нужную.
4. Создайте группу ресурсов **ContosoRG**.
5. Укажите регион Azure. Список поддерживаемых регионов указан на странице [цен на службу Azure Site Recovery](https://azure.microsoft.com/pricing/details/site-recovery/).
6. Для хранилища Служб восстановления выберите **Обзор** > **ConsotoVMVault** >  **+Реплицировать**.
7. В поле **Источник** выберите **Azure**.
8. В поле **Исходное расположение** выберите исходный регион Azure, в котором сейчас запущены виртуальные машины.
9. Выберите модель развертывания с помощью Azure Resource Manager. Затем выберите настройку **Исходная подписка** и **Исходная группа ресурсов**.
10. Нажмите кнопку **ОК**, чтобы сохранить настройки.

### <a name="enable-replication-for-azure-vms-and-start-copying-the-data"></a>Включение репликации для виртуальных машин Azure и начало копирования данных

Site Recovery получает список виртуальных машин, связанных с подпиской и группой ресурсов.

1. Выберите виртуальную машину, которую необходимо переместить, а затем нажмите кнопку **OK**.
2. В разделе **Параметры** выберите **Аварийное восстановление**.
3. В разделе **Настройка аварийного восстановления** > **Целевой регион** выберите целевой регион, в который будет выполняться репликация.
4. Выберите использовать ли целевые ресурсы по умолчанию или предварительно созданные ресурсы.
5. Чтобы начать задание выберите **Включить репликацию**.


 

## <a name="test-the-configuration"></a>Тестирование конфигурации


1. Перейдите в хранилище. В разделе **Параметры** > **Реплицированные элементы** выберите виртуальную машину, которую необходимо переместить в целевой регион. Затем выберите **Тестовая отработка отказа**.
2. На странице **Тестовая отработка отказа** выберите точку восстановления.

   - **Последняя обработанная**. Отработка отказа выполняется до последней точки восстановления виртуальной машины, которая была обработана службой Site Recovery. Для нее отображается метка времени. Времени на обработку данных здесь не требуется, тем самым этот параметр обеспечивает низкий показатель целевого времени восстановления.
   - **Последняя с согласованием приложений**. Отработка отказа всех виртуальных машин выполняется до последней точки восстановления с согласованным состоянием приложений. Для нее отображается метка времени.
   - **Пользовательская**. Вы можете выбрать любую точку восстановления.

3. Чтобы проверить конфигурацию, выберите целевую виртуальную сеть Azure, в которую вы хотите переместить виртуальные машины Azure.

   > [!IMPORTANT]
   > Для отработки отказа мы рекомендуем использовать отдельную сеть виртуальных машин Azure, а не рабочую сеть в целевом регионе.

4. Чтобы начать тестирование переноса, щелкните **ОК**. Чтобы следить за ходом выполнения, выберите виртуальную машину и откройте ее **Свойства**. или выберите задание **Тестовая отработка отказа** в хранилище. Затем выберите **Параметры** > **Задания** > **Задания Site Recovery**.
5. Когда отработка отказа завершится, на вкладке **Виртуальные машины** портала Azure появится реплика виртуальной машины. Убедитесь, что виртуальная машина работает, имеет соответствующий размер и подключена к соответствующей сети.
6. Чтобы удалить виртуальную машину, созданную для тестирования, в качестве реплицированного элемента выберите **Очистить тестовую отработку отказа**. В разделе **Примечания** запишите и сохраните любые наблюдения, связанные с тестом.

## <a name="perform-the-move-and-confirm"></a>Выполнение перемещения и подтверждение

1. Перейдите в хранилище, в разделе **Параметры** > **Реплицированные элементы** последовательно выберите виртуальную машину и **Отработка отказа**.
1. В области **Отработка отказа** выберите **Последнее**. 
2. Выберите **Завершение работы виртуальной машины перед началом отработки отказа**. Site Recovery попытается завершить работу исходной виртуальной машины перед запуском отработки отказа. Но отработка отказа продолжится даже если их не удастся отключить. На странице **Задания** можно следить за ходом выполнения отработки отказа.
3. После завершения задания проверьте, отображается ли виртуальная машина в целевом регионе Azure, как и ожидалось.
4. В разделе **Реплицированные элементы** щелкните правой кнопкой виртуальную машину и выберите **Зафиксировать**. Данное действие является финальным. Дождитесь, пока завершится задание фиксации.

## <a name="discard-the-resources-from-the-source-region"></a>Отмена ресурсов из исходного региона

- Перейдите к виртуальной машине и выберите **Отключить репликацию**. Это остановит процесс копирования данных для виртуальной машины.

  > [!IMPORTANT]
  > Чтобы не платить за репликацию Site Recovery после перемещения, выполните этот шаг.

Если вы не планируете повторно использовать исходные ресурсы, выполните следующие шаги:

1. Удалите все соответствующие сетевые ресурсы исходного региона, перечисленные на шаге 4 раздела [Подготовка исходных виртуальных машин](#prepare-the-source-vms).
2. Удалите соответствующую учетную запись хранения в исходном регионе.

## <a name="next-steps"></a>Дальнейшие действия

Из этого руководства вы узнали, как перенести виртуальные машины Azure в другой регион Azure. Теперь для этих виртуальных машин вы можете настроить аварийное восстановление.

> [!div class="nextstepaction"]
> [Настройка аварийного восстановления после миграции](azure-to-azure-quickstart.md)
