---
title: Планирование емкости для аварийного восстановления VMware с помощью Azure Site Recovery
description: Эта статья поможет запланировать емкость и масштабирование при аварийном восстановлении виртуальных машин VMware в Azure с помощью Azure Site Recovery.
author: nsoneji
manager: garavd
ms.service: site-recovery
ms.date: 4/9/2019
ms.topic: conceptual
ms.author: ramamill
ms.openlocfilehash: 4b86d0c189bcf0687a703f2338188df2090feaf0
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "92368032"
---
# <a name="plan-capacity-and-scaling-for-vmware-disaster-recovery-to-azure"></a>Планирование ресурсов и масштабирования для аварийного восстановления из VMware в Azure

Используйте данную статью, чтобы выяснить, как планировать емкость и масштабирование при репликации локальных физических серверов и виртуальных машин VMware в Azure с помощью [Azure Site Recovery](site-recovery-overview.md).

## <a name="how-do-i-start-capacity-planning"></a>С чего начать планирование загрузки?

Чтобы получить представление о требованиях инфраструктуры Azure Site Recovery, соберите сведения о среде репликации, запустив [Планировщик развертывания Azure Site Recovery](./site-recovery-deployment-planner.md) для репликации VMware. Дополнительные сведения см. в статье [О Планировщике развертывания Azure Site Recovery для восстановления виртуальных машин VMware в Azure](site-recovery-deployment-planner.md). 

Планировщик развертывания Site Recovery создает отчет с полными сведениями о виртуальных машинах (совместимых и несовместимых), дисках на каждой виртуальной машине и обновлениях данных на каждом диске. Средство также собирает данные о требованиях к пропускной способности сети для соответствия целевым значениям RPO и инфраструктуре Azure для успешной репликации и тестовой отработки отказа.

## <a name="capacity-considerations"></a>Рекомендации по емкости

Компонент | Сведения
--- | ---
**Репликация** | **Максимальный объем ежедневных изменений.** Защищенный компьютер может использовать только один сервер обработки. Один сервер обработки может поддерживать скорость ежедневного изменения до 2 ТБ. Таким образом, 2 ТБ — это максимально допустимый объем ежедневных изменений данных на защищенном компьютере.<br /><br /> **Максимальная пропускная способность.** Реплицированный компьютер может принадлежать только к одной учетной записи хранения Azure. Стандартная учетная запись хранения Azure может обрабатывать не более 20 000 запросов в секунду. Мы рекомендуем не превышать количество в 20 000 операций ввода-вывода в секунду на исходном компьютере. Например, если исходный компьютер содержит 5 дисков, на каждом из которых выполняется по 120 операций ввода-вывода в секунду (размером в 8 КБ), то этот компьютер не будет превышать ограничение в 500 операций ввода-вывода в секунду на диск в Azure. (Число необходимых учетных записей хранения определяется путем деления общего числа операций ввода-вывода для исходного компьютера на 20 000).
**Сервер конфигурации** | Сервер конфигурации должен поддерживать суммарный объем ежедневно изменяемых данных для всех рабочих нагрузок, которые выполняются на защищенных компьютерах. Компьютер конфигурации должен обладать достаточной пропускной способностью для непрерывной репликации данных в службу хранилища Azure.<br /><br /> Мы рекомендуем разместить сервер конфигурации в той же сети и в том же сегменте локальной сети, что и компьютеры, которые необходимо защитить. Его можно разместить и в другой сети при наличии у компьютеров, которые нужно защитить, видимости сети третьего уровня.<br /><br /> В следующем разделе в таблице приведены рекомендации по размерам для сервера конфигурации.
**Сервер обработки** | Первый сервер обработки по умолчанию устанавливается на сервере конфигурации. Для масштабирования среды можно развернуть дополнительные серверы обработки. <br /><br /> Сервер обработки получает данные репликации от защищенных компьютеров. Сервер обработки оптимизирует данные репликации с помощью кэширования, сжатия и шифрования. Затем сервер обработки отправляет данные в Azure. Сервер обработки должен располагать достаточными ресурсами для выполнения этих задач.<br /><br /> Сервер обработки использует дисковый кэш. Чтобы обеспечить обработку хранящихся изменений данных в случае возникновения узкого места в сети или сбоя, установите отдельный диск кэша объемом 600 ГБ или более.

## <a name="size-recommendations-for-the-configuration-server-and-inbuilt-process-server"></a>Рекомендации по выбору размера сервера конфигурации и встроенного сервера обработки

Сервер конфигурации, в котором сервер обработки используется для защиты рабочей нагрузки, может обрабатывать до 200 виртуальных машин на основе следующих конфигураций.

ЦП | Память | Размер диска кэша | Частота изменения данных | Защищаемые компьютеры
--- | --- | --- | --- | ---
8 виртуальных ЦП (2 сокета по 4 ядра с частотой \@ 2,5 ГГц) | 16 Гб | 300 ГБ | 500 ГБ или менее | Репликация не более 100 компьютеров.
12 виртуальных ЦП (2 сокета по 6 ядер с частотой \@ 2,5 ГГц) | 18 ГБ | 600 ГБ | От 501 ГБ до 1 ТБ | Репликация 100–150 компьютеров.
16 виртуальных ЦП (2 сокета по 8 ядер с частотой \@ 2,5 ГГц) | 32 Гб | 1 TБ | От 1 ТБ до 2 ТБ | Репликация 151–200 компьютеров.
Развертывание дополнительного сервера конфигурации с помощью [шаблона OVF](vmware-azure-deploy-configuration-server.md#deploy-a-configuration-server-through-an-ova-template). | | | | Если вы выполняете репликацию более 200 компьютеров, разверните новый сервер конфигурации.
Развертывание дополнительного [сервера обработки](vmware-azure-set-up-process-server-scale.md#download-installation-file). | | | > 2 ТБ| Если общий объем ежедневно изменяемых данных превышает 2 ТБ, разверните новый сервер обработки масштабирования.

В этих конфигурациях:

* каждый исходный компьютер содержит три диска объемом 100 ГБ каждый;
* чтобы измерить показатели диска кэша, мы использовали хранилище для тестирования производительности восьми дисков SAS с частотой вращения шпинделя 10 000 об/мин в конфигурации RAID 10.

## <a name="size-recommendations-for-the-process-server"></a>Рекомендации по размеру сервера обработки

Сервер обработки — это компонент, который обрабатывает данные репликации в Azure Site Recovery. Если объем ежедневно изменяемых данных составляет более 2 ТБ, для обработки такой нагрузки репликации нужно добавить серверы обработки масштабирования. Для развертывания можно выполнить следующее.

* Увеличить число серверов конфигурации, выполнив развертывание с помощью [шаблона OVF](vmware-azure-deploy-configuration-server.md#deploy-a-configuration-server-through-an-ova-template). Например, с помощью двух серверов конфигурации можно защитить до 400 компьютеров.
* Добавить [серверы обработки масштабирования](vmware-azure-set-up-process-server-scale.md#download-installation-file). Использовать их для обработки трафика репликации вместо сервера конфигурации (или вместе с ним).

В следующей таблице описан этот сценарий.

* Вы настроили сервер обработки масштабирования.
* Вы настроили защищенные виртуальные машины для использования сервера обработки масштабирования.
* Каждый защищенный исходный компьютер содержит три диска объемом 100 ГБ каждый.

Дополнительный сервер обработки | Размер диска кэша | Частота изменения данных | Защищаемые компьютеры
--- | --- | --- | ---
4 виртуальных ЦП (2 сокета по 2 ядра \@ 2,5 ГГц), 8 ГБ памяти | 300 ГБ | 250 ГБ или менее | Репликация не более 85 компьютеров.
8 виртуальных ЦП (2 сокета по 4 ядра \@ 2,5 ГГц), 12 ГБ памяти | 600 ГБ | От 251 ГБ до 1 ТБ | Репликация 86–150 компьютеров.
12 виртуальных ЦП (2 сокета по 6 ядер \@ 2,5 ГГц), 24 ГБ памяти | 1 TБ | От 1 ТБ до 2 ТБ | Репликация 151–225 компьютеров.

Способ масштабирования серверов зависит от выбранной модели масштабирования — вертикальной или горизонтальной. Чтобы увеличить масштаб, разверните несколько высокопроизводительных серверов конфигурации и серверов обработки. Для масштабирования разверните больше серверов, у которых меньше ресурсов. Например, чтобы защитить 200 машин с общим объемом ежедневно изменяемых данных 1,5 ТБ, вы можете выполнить одно из следующих действий:

* настройте один сервер обработки (16 виртуальных ЦП и 24 ГБ ОЗУ);
* настройте два сервера обработки (2 x 8 виртуальных ЦП, 2 по 12 ГБ ОЗУ).

## <a name="control-network-bandwidth"></a>Управление пропускной способностью сети

После того как [Планировщик развертывания Site Recovery](site-recovery-deployment-planner.md) рассчитает пропускную способность, необходимую для репликации (начальной и разностной), вы можете управлять объемом пропускной способности, используемой для репликации, с помощью нескольких способов.

* **Регулирование пропускной способности**. Трафик VMware, который реплицируется в Azure, проходит через определенный сервер обработки. Пропускную способность можно регулировать на компьютерах, которые служат серверами обработки.
* **Влияние на пропускную способность**. Вы можете повлиять на пропускную способность, используемую для репликации, с помощью нескольких разделов реестра:
  * Значение реестра **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Azure Backup\Replication\UploadThreadsPerVM** задает количество потоков, используемых для передачи данных диска (для начальной или разностной репликации данных). Если задать высокое значение, пропускная способность сети, используемая для репликации, увеличивается.
  * Значение реестра **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Azure Backup\Replication\DownloadThreadsPerVM** задает количество потоков, используемых для передачи данных при восстановлении размещения.

### <a name="throttle-bandwidth"></a>Регулирование пропускной способности

1. Откройте оснастку MMC в службе Azure Backup на компьютере, который выступает в качестве сервера обработки. По умолчанию ярлык для резервного копирования доступен на рабочем столе или в следующей папке: C:\Program Files\Microsoft Azure Recovery Services Ажент\бин.
2. В оснастке выберите **Change Properties** (Изменить свойства).

    ![Снимок экрана с параметром оснастки MMC в службе Azure Backup для изменения свойств](./media/site-recovery-vmware-to-azure/throttle1.png)
3. На вкладке **регулирование** выберите **включить регулирование использования полосы пропускания Интернета для операций резервного копирования**. Задайте ограничения для рабочего и нерабочего времени. Допустимы значения в диапазоне от 512 Кбит/с до 1,023 Мбит/с.

    ![Снимок экрана с диалоговым окном свойств службы Azure Backup](./media/site-recovery-vmware-to-azure/throttle2.png)

Чтобы настроить регулирование, можно также использовать командлет [Set-OBMachineSetting](/previous-versions/windows/powershell-scripting/hh770409(v=wps.640)) . Приведем пример:

```azurepowershell-interactive
$mon = [System.DayOfWeek]::Monday
$tue = [System.DayOfWeek]::Tuesday
Set-OBMachineSetting -WorkDay $mon, $tue -StartWorkHour "9:00:00" -EndWorkHour "18:00:00" -WorkHourBandwidth  (512*1024) -NonWorkHourBandwidth (2048*1024)
```

**Set-OBMachineSetting -NoThrottle** указывает, что регулирование не требуется.

### <a name="alter-the-network-bandwidth-for-a-vm"></a>Изменение пропускной способности сети для виртуальной машины

1. В реестре виртуальной машины перейдите в раздел **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Azure Backup\Replication**.
   * Чтобы изменить скорость передачи данных при репликации диска, измените значение **UploadThreadsPerVM**. Если ключ еще не существует, создайте его.
   * Чтобы изменить скорость передачи данных при восстановлении размещения из Azure, измените значение **DownloadThreadsPerVM**.
2. Значение по умолчанию для каждого ключа — **4**. В сети со значительным избыточным резервом для этих разделов реестра необходимо изменить значения по умолчанию. Максимальное значение, которое можно использовать — **32**. Следите за трафиком для оптимизации значения.

## <a name="set-up-the-site-recovery-infrastructure-to-protect-more-than-500-vms"></a>Настройка инфраструктуры Site Recovery для защиты более 500 виртуальных машин

Перед настройкой инфраструктуры Azure Site Recovery получите доступ к среде для измерения следующих факторов: количество совместимых виртуальных машин, объем ежедневно изменяемых данных, требуемая пропускная способность сети для нужного значения RPO, количество необходимых компонентов Site Recovery, время, необходимое для завершения начальной репликации. Выполните следующие действия, чтобы собрать необходимые сведения.

1. Чтобы измерить эти параметры, запустите Планировщик развертывания Site Recovery в своей среде. Полезные рекомендации см. в разделе [О Планировщике развертывания Azure Site Recovery для восстановления виртуальных машин VMware в Azure](site-recovery-deployment-planner.md).
2. Разверните сервер конфигурации, который соответствует [рекомендациям по размеру сервера конфигурации](site-recovery-plan-capacity-vmware.md#size-recommendations-for-the-configuration-server-and-inbuilt-process-server). Если рабочая нагрузка превышает 650 виртуальных машин, разверните дополнительный сервер конфигурации.
3. Исходя из измеренного объема ежедневно изменяемых данных, выполните развертывание [серверов обработки масштабирования](vmware-azure-set-up-process-server-scale.md#download-installation-file) с помощью [рекомендаций по размеру сервера обработки](site-recovery-plan-capacity-vmware.md#size-recommendations-for-the-process-server).
4. Если предполагается, что скорость изменения данных для дисковой виртуальной машины превышает 2 Мбит/с, убедитесь, что используются управляемые диски уровня "Премиум". Планировщик развертывания Site Recovery запускается в течение определенного периода времени. Пики скорости изменения данных в другое время могут не отражаться в отчете.
5. [Задайте пропускную способность сети](site-recovery-plan-capacity-vmware.md#control-network-bandwidth) в зависимости от нужного значения RPO.
6. После настройки инфраструктуры включите аварийное восстановление для рабочей нагрузки. Чтобы узнать, как это сделать, см. статью [Настройка исходного окружения для репликации из VMware в Azure](vmware-azure-set-up-source.md).

## <a name="deploy-additional-process-servers"></a>Развертывание дополнительных серверов обработки

Если вы увеличите развертывание так, что количество исходных компьютеров превысит 200 или объем ежедневно изменяемых данных превысит 2 ТБ, для обработки такой нагрузки потребуется добавить серверы обработки. Мы улучшили продукт в версии 9,24, чтобы предоставить [предупреждения сервера обработки](vmware-physical-azure-monitor-process-server.md#process-server-alerts) о том, когда следует настроить сервер обработки масштабирования. [Настройте сервер обработки](vmware-azure-set-up-process-server-scale.md) для защиты новых исходных компьютеров или [балансировки нагрузки](vmware-azure-manage-process-server.md#move-vms-to-balance-the-process-server-load).

### <a name="migrate-machines-to-use-the-new-process-server"></a>Перенос компьютеров для использования нового сервера обработки

1. Выберите **Параметры**  >  **Site Recovery серверы**. Выберите сервер конфигурации и разверните список **Серверы обработки**.

    ![Снимок экрана с диалоговым окном "Сервер обработки"](./media/site-recovery-vmware-to-azure/migrate-ps2.png)
2. Щелкните используемый сервер обработки правой кнопкой мыши и выберите **Switch** (Переключить).

    ![Снимок экрана с диалоговым окном "Сервер конфигурации"](./media/site-recovery-vmware-to-azure/migrate-ps3.png)
3. В поле **Выбор целевого сервера обработки** выберите новый сервер обработки, который нужно использовать. Затем укажите виртуальные машины, с которыми он будет работать. Щелкните значок сведений, чтобы получить сведения о сервере. Чтобы помочь принять решение о скачивании, отображается средний объем свободного места, требуемый для репликации каждой выбранной виртуальной машины на новом сервере обработки. Установите флажок, чтобы начать репликацию на новом сервере обработки.

## <a name="deploy-additional-master-target-servers"></a>Развертывание дополнительных главных целевых серверов

В следующих сценариях требуется более одного главного целевого сервера.

*   Вы хотите защитить виртуальную машину под управлением Linux.
*   Главный целевой сервер, доступный на сервере конфигурации, не имеет доступа к хранилищу данных виртуальной машины.
*   Общее количество дисков на главном целевом сервере (количество локальных дисков на сервере + количество защищаемых дисков) превышает 60.

Чтобы узнать, как добавить главный целевой сервер для виртуальной машины под управлением Linux, см. статью [Установка главного целевого сервера Linux для восстановления размещения](vmware-azure-install-linux-master-target.md).

Чтобы добавить новый главный целевой сервер для виртуальной машины под управлением Windows, выполните следующие действия.

1. Перейдите в **хранилище служб восстановления**  >  **Site Recovery**  >  **серверы конфигурации** инфраструктуры.
2. Выберите нужный сервер конфигурации, а затем выберите **Главный целевой сервер**.

    ![Снимок экрана, на котором показана кнопка "Добавить главный целевой сервер"](media/site-recovery-plan-capacity-vmware/add-master-target-server.png)
3. Загрузите унифицированный файл установки и запустите его на виртуальной машине, чтобы настроить главный целевой сервер.
4. Нажмите кнопку **установить главный целевой** сервер  >  **Далее**.

    ![Снимок экрана, показывающий выбор опции "Установка главного целевого сервера"](media/site-recovery-plan-capacity-vmware/choose-MT.PNG)
5. Выберите место установки по умолчанию, а затем выберите **Install** (Установить).

     ![Снимок экрана, показывающий расположение установки по умолчанию](media/site-recovery-plan-capacity-vmware/MT-installation.PNG)
6. Для регистрации главного целевого сервера на сервере конфигурации выберите **Proceed To Configuration** (Перейти к конфигурации).

    ![Снимок экрана, на котором показана кнопка "Перейти к конфигурации"](media/site-recovery-plan-capacity-vmware/MT-proceed-configuration.PNG)
7. Введите IP-адрес сервера конфигурации, а затем введите парольную фразу. Чтобы узнать, как создать парольную фразу, см. раздел [Создание парольной фразы сервера конфигурации](vmware-azure-manage-configuration-server.md#generate-configuration-server-passphrase). 

    ![Снимок экрана, показывающий, где вводить IP-адрес и парольную фразу для сервера конфигурации](media/site-recovery-plan-capacity-vmware/cs-ip-passphrase.PNG)
8. Выберите **Зарегистрировать**. По завершении регистрации выберите **Готово**.

После успешного завершения регистрации сервер будет указан в портал Azure в **хранилище служб восстановления**  >  **Site Recovery**  >  **серверы конфигурации** инфраструктуры на главных целевых серверах сервера конфигурации.

 > [!NOTE]
 > Загрузите последнюю версию [унифицированной программы установки главного целевого сервера для Windows](https://aka.ms/latestmobsvc).

## <a name="next-steps"></a>Дальнейшие действия

Скачайте и запустите [Планировщик ресурсов Site Recovery](https://aka.ms/asr-deployment-planner).