---
title: Настройка аварийного восстановления Active Directory и DNS с помощью Azure Site Recovery
description: В этой статье описывается, как реализовать решение аварийного восстановления для Active Directory и DNS с помощью Azure Site Recovery.
author: mayurigupta13
manager: rochakm
ms.service: site-recovery
ms.topic: conceptual
ms.date: 04/01/2020
ms.author: mayg
ms.openlocfilehash: 528a24bb64aa8d323b5d63a27af0a52ccdf1abb6
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "86132323"
---
# <a name="set-up-disaster-recovery-for-active-directory-and-dns"></a>Настройка аварийного восстановления для Active Directory и DNS

Правильная работа корпоративных приложений, таких как SharePoint, Dynamics AX и SAP, зависит от Active Directory и инфраструктуры DNS. При настройке аварийного восстановления для приложений часто требуется восстановить Active Directory и службу доменных имен (DNS) перед восстановлением других компонентов приложения, чтобы обеспечить правильную работу приложения.

С помощью [Site Recovery](site-recovery-overview.md) можно создать план аварийного восстановления для Active Directory. В случае нарушения работы вы можете инициировать отработку отказа. Active Directory можно настроить и подготовить к работе за несколько минут. Если вы развернули Active Directory для нескольких приложений на основном сайте, например для SharePoint и SAP, может потребоваться выполнить отработку отказа для всего сайта. Сначала можно выполнить отработку отказа Active Directory с помощью Site Recovery. Затем выполните отработку отказа других приложений с помощью планов восстановления для конкретных приложений.

Из этой статьи вы узнаете, как создать решение аварийного восстановления для Active Directory. Здесь указаны предварительные требования и инструкции по отработке отказа. Перед началом работы необходимо ознакомиться с Active Directory и Site Recovery.

## <a name="prerequisites"></a>Предварительные требования

- Если выполняется репликация в Azure, [подготовьте ресурсы Azure](tutorial-prepare-azure.md), включая подписку, виртуальную сеть Azure, учетную запись хранения и хранилище служб восстановления.
- [Ознакомьтесь](./vmware-physical-azure-support-matrix.md) с требованиями поддержки для всех компонентов.

## <a name="replicate-the-domain-controller"></a>Репликация контроллера домена

- Необходимо настроить репликацию Site Recovery по крайней мере на одной виртуальной машине, где размещен контроллер домена или DNS.
- Если в вашей среде несколько контроллеров домена, на целевом сайте также необходимо настроить дополнительный контроллер домена. Он может находиться в Azure или в дополнительном локальном центре обработки данных.
- При наличии небольшого количества приложений и одного контроллера домена может потребоваться выполнить отработку отказа всего сайта. В этом случае рекомендуется использовать Site Recovery для репликации контроллера домена на целевой сайт в Azure или во вторичном локальном центре обработки данных. Этот же реплицированный контроллер домена или виртуальную машину с DNS можно использовать для [тестовой отработки отказа](#test-failover-considerations).
- Если в вашей среде много приложений и несколько контроллеров доменов и при этом вы планируете выполнять отработку отказа для нескольких приложений одновременно, мы рекомендуем в дополнение к репликации виртуальной машины с контроллером домена с помощью Site Recovery также настроить дополнительный контроллер домена на целевом сайте (сайте Azure или в дополнительном локальном центре обработки данных). Для [тестовой отработки отказа](#test-failover-considerations)можно использовать контроллер домена, реплицированный с помощью Site Recovery. Для отработки отказа можно использовать дополнительный контроллер домена на целевом сайте.

## <a name="enable-protection-with-site-recovery"></a>Включение защиты с помощью Site Recovery

Site Recovery можно использовать для защиты виртуальной машины, на которой размещен контроллер домена или DNS.

### <a name="protect-the-vm"></a>Защита виртуальной машины

Контроллер домена, реплицированный с помощью Site Recovery, используется для [тестовой отработки отказа](#test-failover-considerations). Убедитесь, что он соответствует следующим требованиям.

1. Контроллер домена должен быть сервером глобального каталога.
1. Контроллер домена должен быть владельцем роли FSMO для ролей, которые необходимы во время тестовой отработки отказа. В противном случае эти роли должны быть [заняты](https://support.microsoft.com/help/255504/using-ntdsutil-exe-to-transfer-or-seize-fsmo-roles-to-a-domain-control) после отработки отказа.

### <a name="configure-vm-network-settings"></a>Настройка параметров сети виртуальной машины

Для виртуальной машины, на которой размещен контроллер домена или DNS, в Site Recovery настройте параметры сети в разделе параметров **Вычисления и сеть** реплицированной виртуальной машины. Это гарантирует, что виртуальная машина будет подключена к правильной сети после отработки отказа.

## <a name="protect-active-directory"></a>Защита Active Directory

### <a name="site-to-site-protection"></a>Защита "сайт-сайт"

Создайте контроллер домена на дополнительном сайте. При повышении уровня сервера до роли контроллера домена укажите имя того же домена, который используется на первичном сайте. Чтобы настроить параметры объекта связывания сайтов, в который добавляются сайты, можно использовать оснастку **Active Directory — сайты и службы**. Настраивая параметры связи между сайтами, можно указать время и периодичность репликации между двумя или несколькими сайтами. Дополнительные сведения см. в разделе [планирование репликации между сайтами](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc731862(v=ws.11)).

### <a name="site-to-azure-protection"></a>Защита "сайт-Azure"

Сначала создайте контроллер домена в виртуальной сети Azure. При повышении роли сервера до роли контроллера домена укажите имя домена, которое используется на основном сайте.

Затем измените конфигурацию DNS-сервера для виртуальной сети так, чтобы использовался DNS-сервер в Azure.

:::image type="content" source="./media/site-recovery-active-directory/azure-network.png" alt-text="Сеть Azure":::

### <a name="azure-to-azure-protection"></a>Защита "Azure — Azure"

Сначала создайте контроллер домена в виртуальной сети Azure. При повышении роли сервера до роли контроллера домена укажите имя домена, которое используется на основном сайте.

Затем измените конфигурацию DNS-сервера для виртуальной сети так, чтобы использовался DNS-сервер в Azure.

## <a name="test-failover-considerations"></a>Рекомендации по тестированию отработки отказа

Чтобы избежать влияния на рабочие нагрузки, тестовая отработка отказа происходит в сети, изолированной от рабочей сети.

Для работы большинства приложений требуется контроллер домена и DNS-сервер. Таким образом, прежде чем выполнять отработку отказа для приложения, необходимо создать в изолированной сети контроллер домена, который будет использоваться при отработке отказа. Это проще всего сделать, реплицировав с помощью Site Recovery виртуальную машину с контроллером домена или DNS. Запустите тестовую отработку отказа виртуальной машины с контроллером домена, прежде чем запускать тестовую отработку отказа плана восстановления для приложения.

1. Site Recovery можно использовать для [репликации](vmware-azure-tutorial.md) виртуальной машины, на которой размещен контроллер домена или DNS.
1. Создайте изолированную сеть. Любая виртуальная сеть, созданная в Azure, по умолчанию изолируется от другой сети. Рекомендуем использовать для этой сети такой же диапазон IP-адресов, как у вашей рабочей сети. Не включайте для этой сети подключение между сайтами.
1. Укажите IP-адрес DNS в изолированной сети. Используйте IP-адрес, который должна получить виртуальная машина DNS. При репликации в Azure укажите IP-адрес для виртуальной машины, используемой при отработке отказа. Чтобы ввести IP-адрес, в реплицированной виртуальной машине в разделе параметров **Вычисления и сеть** выберите параметры **Целевой IP-адрес**.

   :::image type="content" source="./media/site-recovery-active-directory/azure-test-network.png" alt-text="Тестовая сеть Azure":::

   > [!TIP]
   > Служба Site Recovery попытается создать тестовые виртуальные машины в подсети с таким же именем, используя тот же IP-адрес, который был указан в разделе параметров **Вычисления и сеть** виртуальной машины. Если подсеть с таким же именем недоступна в виртуальной сети Azure, предоставленной для тестовой отработки отказа, тестовая виртуальная машина создается в первой по алфавиту подсети.
   >
   > Если целевой IP-адрес является частью выбранной подсети, Site Recovery попытается создать виртуальную машину для тестовой обработки отказа с его использованием. Если целевой IP-адрес не является частью выбранной подсети, виртуальная машина для тестовой отработки отказа создается с использованием следующего доступного IP-адреса в выбранной подсети.

### <a name="test-failover-to-a-secondary-site"></a>Тестовая отработка отказа на дополнительный сайт

1. Если выполняется репликация на другой локальный сайт и вы используете DHCP, [настройте DNS и DHCP для тестовой отработки отказа](hyper-v-vmm-test-failover.md#prepare-dhcp).
1. Выполняйте тестовую отработку отказа на виртуальной машине с контроллером домена в изолированной сети. Для выполнения тестовой отработки отказа используйте последнюю точку восстановления виртуальной машины контроллера домена, _согласованную с приложениями_.
1. Запустите тестовую отработку отказа для плана восстановления, который содержит виртуальные машины приложения.
1. После завершения тестирования _очистите тестовую отработку отказа_ на виртуальной машине с контроллером домена. Этот шаг удаляет контроллер домена, который был создан для тестовой отработки отказа.

### <a name="remove-references-to-other-domain-controllers"></a>Удаление ссылок на другие контроллеры домена

При запуске тестовой отработки отказа не нужно переносить все контроллеры домена в тестовую сеть. Чтобы удалить ссылки на другие контроллеры домена, которые существуют в рабочей среде, необходимо [занять роли FSMO Active Directory](https://support.microsoft.com/help/255504/using-ntdsutil-exe-to-transfer-or-seize-fsmo-roles-to-a-domain-control) и [очистить метаданные](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc816907(v=ws.10)) для отсутствующих контроллеров домена.

### <a name="issues-caused-by-virtualization-safeguards"></a>Вопросы, связанные с мерами по обеспечению безопасности виртуализации

> [!IMPORTANT]
> Некоторые конфигурации, описанные в следующем разделе, не являются стандартными для контроллера домена. Если вы не хотите вносить эти изменения в рабочий контроллер домена, вы можете создать отдельный контроллер домена для тестовой отработки отказа Site Recovery. Внесите эти изменения только в этот контроллер домена.

Начиная с Windows Server 2012 в [Active Directory Domain Services (AD DS) предусмотрены дополнительные меры безопасности](/windows-server/identity/ad-ds/introduction-to-active-directory-domain-services-ad-ds-virtualization-level-100). Эти меры безопасности помогают защитить виртуализированные контроллеры домена от отката к последовательному номеру обновления (USN), если базовая платформа гипервизора поддерживает **VM-GenerationID**. Azure поддерживает **VM-GenerationID**. А это значит, что контроллеры доменов, которые работают под управлением Windows Server 2012 или более поздних версий на виртуальных машинах Azure, будут защищены дополнительными мерами безопасности.

Когда выполняется сброс **VM-GenerationID**, значение **InvocationID** базы данных AD DS также сбрасывается. Кроме того, пул относительных ИДЕНТИФИКАТОРов (RID) удаляется, а `SYSVOL` папка помечается как неполномочное. Дополнительные сведения см. в статьях [Введение в виртуализацию домен Active Directory Services](/windows-server/identity/ad-ds/introduction-to-active-directory-domain-services-ad-ds-virtualization-level-100) и [безопасное виртуализация распределенная ФАЙЛОВАЯ система Replication (DFSR)](https://techcommunity.microsoft.com/t5/storage-at-microsoft/safely-virtualizing-dfsr/ba-p/424671).

Отработка отказа в Azure может привести к сбросу **VM-GenerationID**. Сброс **VM-GenerationID** запускает дополнительные меры безопасности при запуске виртуальной машины с контроллером домена в Azure. Это может привести к значительной задержке при входе на виртуальную машину контроллера домена.

Так как этот контроллер домена будет использоваться только для тестовой отработки отказа, меры безопасности виртуализации не обязательны. Чтобы гарантировать, что значение **VM-GenerationID** для виртуальной машины контроллера домена не изменится, можно изменить значение следующего `DWORD` на **4** на локальном контроллере домена:

`HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\gencounter\Start`

#### <a name="symptoms-of-virtualization-safeguards"></a>Признаки применения мер по обеспечению безопасности виртуализации

Если меры безопасности виртуализации активированы после тестовой отработки отказа, вы увидите один или несколько следующих признаков.

- Значение **GenerationID** изменяется:

  :::image type="content" source="./media/site-recovery-active-directory/Event2170.png" alt-text="Изменение идентификатора создания":::

- Значение **invocationID** изменяется:

  :::image type="content" source="./media/site-recovery-active-directory/Event1109.png" alt-text="Изменение идентификатора вызова":::

- `SYSVOL` Папка и `NETLOGON` Общие папки недоступны.

  :::image type="content" source="./media/site-recovery-active-directory/sysvolshare.png" alt-text="Общая папка SYSVOL":::

  :::image type="content" source="./media/site-recovery-active-directory/Event13565.png" alt-text="Папка NtFrs SYSVOL":::

- Базы данных DFSR удалены.

  :::image type="content" source="./media/site-recovery-active-directory/Event2208.png" alt-text="Базы данных DFSR удалены":::

### <a name="troubleshoot-domain-controller-issues-during-test-failover"></a>Устранение неполадок контроллера домена при тестовой отработке отказа

> [!IMPORTANT]
> Некоторые конфигурации, описанные в следующем разделе, не являются стандартными для контроллера домена. Если вы не хотите вносить эти изменения в рабочий контроллер домена, вы можете создать отдельный контроллер домена для тестовой отработки отказа Site Recovery. Внесите эти изменения только в этот выделенный контроллер домена.

1. В командной строке выполните следующую команду, чтобы проверить `SYSVOL` `NETLOGON` , являются ли общие папки и папки общими:

    `NET SHARE`

1. В командной строке выполните следующую команду, чтобы убедиться, что контроллер домена работает правильно:

    `dcdiag /v > dcdiag.txt`

1. В журнале выходных данных найдите следующий текст. Текст подтверждает, что контроллер домена работает правильно.

    - `passed test Connectivity`
    - `passed test Advertising`
    - `passed test MachineAccount`

Если эти условия выполняются, скорее всего контроллер домена будет работать правильно. Если нет, сделайте следующее:

1. Выполните заслуживающее доверия восстановление контроллера домена. Примите во внимание указанные ниже сведения.

    - Хотя мы не советуем использовать репликацию с помощью [службы репликации файлов (FRS)](https://techcommunity.microsoft.com/t5/storage-at-microsoft/the-end-is-nigh-for-frs-8211-updated-for-ws2016/ba-p/425379), если вы используете репликацию FRS, выполните действия для полномочного восстановления. Процесс описан в статье об [использовании раздела реестра BurFlags для повторной инициализации службы репликации файлов](https://support.microsoft.com/kb/290762).

      Дополнительные сведения о BurFlags см. в этой [записи блога](/archive/blogs/janelewis/d2-and-d4-what-is-it-for).

    - Если используется репликация DFSR, выполните действия для заслуживающего доверия восстановления. Процесс описан в разделе [Принудительная и неофициальная синхронизация для реплицированной папки SYSVOL (например, D4/D2 для FRS)](https://support.microsoft.com/kb/2218556).

      Вы можете также использовать функции PowerShell. Дополнительные сведения см. в статье [DFSR-SYSVOL Authoritative / Non-Authoritative Restore Powershell Functions](/archive/blogs/thbouche/dfsr-sysvol-authoritative-non-authoritative-restore-powershell-functions) (Функции PowerShell заслуживающие и не заслуживающего доверия восстановления DFSR SYSVOL).

1. Пропустите требование начальной синхронизации, задав следующему разделу реестра значение **0** на локальном контроллере домена. Если объект `DWORD` не существует, его можно создать в узле **Параметры** .

   `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\NTDS\Parameters\Repl Perform Initial Synchronizations`

   Дополнительные сведения см. в статье [Troubleshoot DNS Event ID 4013: The DNS server was unable to load AD integrated DNS zones](https://support.microsoft.com/kb/2001093) (Устранение события DNS с идентификатором 4013: DNS-серверу не удалось загрузить зоны DNS, интегрированные с AD).

1. Отключите требование, чтобы сервер глобального каталога был доступен для проверки входа пользователя. Для этого в локальном контроллере домена присвойте следующему разделу реестра значение **1**. Если объект `DWORD` не существует, его можно создать в узле **LSA** .

   `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa\IgnoreGCFailures`

   Дополнительные сведения см. [в статье как работает Глобальный каталог](/previous-versions/windows/it-pro/windows-server-2003/cc737410(v=ws.10)).

### <a name="dns-and-domain-controller-on-different-machines"></a>Контроллер домена и DNS на разных компьютерах

Если вы запускаете контроллер домена и DNS на одной виртуальной машине, вы можете пропустить эту процедуру.

Если DNS находится не на той же виртуальной машине, что и контроллер домена, необходимо создать виртуальную машину DNS для тестовой отработки отказа. Вы можете использовать новый DNS-сервер и создать все необходимые зоны. Например, если домен Active Directory — `contoso.com` , можно создать зону DNS с именем `contoso.com` . Записи DNS, соответствующие Active Directory, необходимо обновить следующим образом:

1. До включения любой другой виртуальной машины в план восстановления убедитесь, что настроены указанные ниже параметры:

   - Необходимо назвать зону именем корня леса.
   - Зона должна предусматривать файловую поддержку.
   - Для зоны должна быть включена возможность установки безопасных и небезопасных обновлений.
   - Сопоставитель виртуальной машины, на которой размещен контроллер домена, должен указывать на IP-адрес виртуальной машины DNS.

1. Выполните в виртуальной машине с контроллером домена следующую команду:

   `nltest /dsregdns`

1. Выполните следующие команды, чтобы добавить зону на DNS-сервер, разрешите небезопасные обновления и добавьте запись для зоны в DNS.

   ```cmd
   dnscmd /zoneadd contoso.com  /Primary

   dnscmd /recordadd contoso.com  contoso.com. SOA %computername%.contoso.com. hostmaster. 1 15 10 1 1

   dnscmd /recordadd contoso.com %computername%  A <IP_OF_DNS_VM>

   dnscmd /config contoso.com /allowupdate 1
   ```

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные [сведения](site-recovery-workload.md) о защите рабочих нагрузок предприятия с помощью Azure Site Recovery.
