---
title: Включение репликации для частных конечных точек в Azure Site Recovery
description: В этой статье описывается, как настроить репликацию виртуальных машин с частными конечными точками между регионами Azure с помощью Site Recovery.
author: Harsha-CS
ms.author: harshacs
ms.service: site-recovery
ms.topic: article
ms.date: 07/14/2020
ms.custom: references_regions
ms.openlocfilehash: 86f18be73966cb07489630191420b846622e45b8
ms.sourcegitcommit: f28ebb95ae9aaaff3f87d8388a09b41e0b3445b5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/29/2021
ms.locfileid: "98629833"
---
# <a name="replicate-machines-with-private-endpoints"></a>Репликация компьютеров с частными конечными точками

Azure Site Recovery позволяет использовать частные конечные точки [Приватного канала Azure](../private-link/private-endpoint-overview.md) для репликации компьютеров из изолированной виртуальной сети. Доступ к хранилищу восстановления в частной конечной точке поддерживается во всех регионах Azure для коммерческих и государственных организаций.

В этой статье приводятся инструкции по выполнению следующих действий.

- Создание хранилища Служб восстановления Azure Backup для защиты компьютеров.
- Активация управляемого удостоверения для хранилища и предоставление необходимых разрешений для доступа к учетным записям хранения клиента, чтобы реплицировать трафик из источника в целевые расположения. Доступ к управляемым удостоверениям для хранилища необходим при настройке доступа к хранилищу с помощью Приватного канала.
- Внесение в DNS изменений, необходимых для частных конечных точек
- Создание и утверждение частных конечных точек для хранилища в виртуальной сети
- Создание частных конечных точек для учетных записей хранения. При необходимости можно разрешить общий доступ к хранилищу или доступ через брандмауэр. Для Azure Site Recovery не обязательно создавать частную конечную точку для доступа к хранилищу.
  
Ниже приведена эталонная архитектура, показывающая, как изменится рабочий процесс репликации при использовании частных конечных точек.

:::image type="content" source="./media/azure-to-azure-how-to-enable-replication-private-endpoints/architecture.png" alt-text="Эталонная архитектура для Site Recovery с частными конечными точками.":::

## <a name="prerequisites-and-caveats"></a>Предварительные требования и пояснения

- Частные конечные точки можно создавать только для новых хранилищ Служб восстановления, в которых нет элементов, зарегистрированных в хранилище. То есть частные конечные точки **необходимо создать раньше, чем в хранилище будет добавлен хотя бы один элемент**. Ознакомьтесь со структурой ценообразования для [частных конечных точек](https://azure.microsoft.com/pricing/details/private-link/).
- Хранилище, для которого создана частная конечная точка, блокируется и **становится недоступным для любых сетей, кроме сетей с частными конечными точками**.
- Azure Active Directory в настоящее время не поддерживает частные конечные точки. Таким образом, IP-адресам и полным доменным именам, необходимым для работы Azure Active Directory в регионе, необходимо разрешить исходящий доступ из защищенной сети. Вы также можете использовать тег группы безопасности сети "Azure Active Directory" и теги Брандмауэра Azure, чтобы разрешить доступ к Azure Active Directory, если это применимо.
- **Необходимо не менее семи IP-адресов** в подсетях как на исходных компьютерах, так и на компьютерах восстановления. При создании частной конечной точки для хранилища Site Recovery создает пять приватных каналов для доступа к своим микрослужбам. Кроме того, при включении репликации добавляются два дополнительных приватных канала для связывания исходного и целевого регионов.
- **Требуется один дополнительный IP-адрес** в исходной подсети и в подсети восстановления. Этот IP-адрес нужен только в том случае, если необходимо использовать частные конечные точки, подключающиеся к учетным записям хранения кэша.
  Частные конечные точки для хранилища можно создать только для общего назначения версии 2. Ознакомьтесь со структурой ценообразования для [передачи данных в рамках GPv2](https://azure.microsoft.com/pricing/details/storage/page-blobs/).

 ## <a name="creating-and-using-private-endpoints-for-site-recovery"></a>Создание и использование частных конечных точек для Site Recovery

 В этом разделе описываются действия по созданию и использованию частных конечных точек для Azure Site Recovery в виртуальных сетях.

> [!NOTE]
> Настоятельно рекомендуется выполнять эти действия в указанной последовательности. В противном случае хранилище не сможет использовать частные конечные точки и вам придется начать процесс заново с новым хранилищем.

## <a name="create-a-recovery-services-vault"></a>Создание хранилища Служб восстановления

Хранилище Служб восстановления — это объект, который содержит сведения о репликации компьютеров и используется для активации операций Site Recovery. Подробнее см. в статье [Создание хранилища Служб восстановления](./azure-to-azure-tutorial-enable-replication.md#create-a-recovery-services-vault).

## <a name="enable-the-managed-identity-for-the-vault"></a>Включите управляемое удостоверение для хранилища.

[Управляемое удостоверение](../active-directory/managed-identities-azure-resources/overview.md) позволяет хранилищу получать доступ к учетным записям хранения клиента. Site Recovery нужен доступ к исходному и целевому хранилищу, а также к учетным записям хранения кэша и(или) журнала в зависимости от требований сценария.
Доступ к управляемым удостоверениям важен при использовании службы приватных каналов для хранилища.

1. Перейдите в хранилище Служб восстановления. Выберите пункт **Удостоверение** в разделе _Параметры_.

   :::image type="content" source="./media/azure-to-azure-how-to-enable-replication-private-endpoints/enable-managed-identity-in-vault.png" alt-text="Портал Azure и страница Служб восстановления.":::

1. Измените **Состояние** на _Вкл_ и нажмите кнопку **Сохранить**.

1. Будет создан **ИД объекта**, указывающий, что хранилище теперь зарегистрировано в Azure Active Directory.

## <a name="create-private-endpoints-for-the-recovery-services-vault"></a>Создание частных конечных точек для хранилища Служб восстановления

Чтобы включить отработку отказа и восстановление размещения для виртуальных машин Azure, понадобятся две частные конечные точки для хранилища. Одна частная конечная точка нужна для защиты компьютеров в исходной сети, а другая — для повторной защиты компьютеров, для которых выполнена отработка отказа, в сети восстановления.

Убедитесь, что во время этого процесса установки в целевом регионе создается виртуальная сеть восстановления.

Создайте первую частную конечную точку для хранилища в исходной виртуальной сети, используя Центр Приватного канала на портале или [Azure PowerShell](../private-link/create-private-endpoint-powershell.md). Создайте вторую частную конечную точку для хранилища в сети восстановления. Ниже приведены действия по созданию частной конечной точки в исходной сети. Повторите те же рекомендации, чтобы создать вторую частную конечную точку.

1. На панели поиска портала Azure найдите и выберите “Приватный канал”. Вы попадете в Центр Приватного канала.

   :::image type="content" source="./media/azure-to-azure-how-to-enable-replication-private-endpoints/search-private-links.png" alt-text="Поиск Центра Приватного канала на портале Azure.":::

1. На панели навигации слева выберите **Частные конечные точки**. На странице “Частные конечные точки” нажмите кнопку **\+ Добавить**, чтобы начать создание частной конечной точки для хранилища.

   :::image type="content" source="./media/azure-to-azure-how-to-enable-replication-private-endpoints/create-private-endpoints.png" alt-text="Создание частной конечной точки в Центре Приватного канала.":::

1. На странице "Создание частной конечной точки" необходимо ввести сведения для создания подключения к частной конечной точке.

   1. **Основные** сведения. Укажите основные данные для частных конечных точек. Регион должен совпадать с регионом исходных компьютерах.

      :::image type="content" source="./media/azure-to-azure-how-to-enable-replication-private-endpoints/create-private-endpoints-basic-tab.png" alt-text="Вкладка &quot;Основные&quot; с разделами “Сведения о проекте”, “Подписка” и другими связанными полями для создания частной конечной точки на портале Azure.":::

   1. **Ресурс.** На этой вкладке необходимо указать ресурс "платформа как услуга", для которого создается подключение. Выберите _Microsoft.RecoveryServices/vaults_ в списке **Тип ресурса** для выбранной подписки. Затем выберите имя хранилища Служб восстановления для **Ресурса** и задайте _Azure Site Recovery_ в качестве **Целевого подресурса**.

      :::image type="content" source="./media/azure-to-azure-how-to-enable-replication-private-endpoints/create-private-endpoints-resource-tab.png" alt-text="Вкладка &quot;Ресурс&quot; и поля &quot;Тип ресурса&quot;, &quot;Ресурс&quot; и &quot;Целевой подресурс&quot; для связывания с частной конечной точкой на портале Azure.":::

   1. **Конфигурация.** В разделе конфигурации укажите виртуальную сеть и подсеть, в которых необходимо создать частную конечную точку. Именно в этой сети находится виртуальная машина. Включите интеграцию с частной зоной DNS, выбрав **Да**. Выберите уже созданную зону DNS или создайте новую. Если выбрать **Да**, зона будет автоматически связана с исходной виртуальной сетью и будут добавлены записи DNS, необходимые для DNS-разрешения новых IP-адресов и полных доменных имен, созданных для частной конечной точки.

      Убедитесь, что выбрано создание новой зоны DNS для каждой новой частной конечной точки, подключенной к тому же хранилищу. При выборе существующей частной зоны DNS предыдущие записи CNAME будут переопределены. Прежде чем продолжить, ознакомьтесь с [руководством по частной конечной точке](../private-link/private-endpoint-overview.md#private-endpoint-properties).

      Если сети в вашей среде используют звездообразную топологию, вам потребуется только одна частная конечная точка и только одна частная зона DNS для всей структуры, так как между всеми виртуальными сетями уже включен пиринг. Подробнее см. в статье [Интеграция DNS с частной конечной точкой](../private-link/private-endpoint-dns.md#virtual-network-workloads-without-custom-dns-server).

      Чтобы вручную создать частную зону DNS, выполните действия, описанные в статье [Создание частных зон DNS и добавление записей DNS вручную](#create-private-dns-zones-and-add-dns-records-manually).

      :::image type="content" source="./media/azure-to-azure-how-to-enable-replication-private-endpoints/create-private-endpoints-configuration-tab.png" alt-text="Вкладка “Конфигурация” с полями “Сеть” и “Интеграция с DNS” для настройки частной конечной точки на портале Azure.":::

   1. **Теги.** При необходимости для частной конечной точки можно добавить теги.

   1. **Проверить и создать.** По завершении проверки выберите **Создать**, чтобы создать частную конечную точку.

К созданной частной конечной точке добавляются пять полных доменных имен. Эти каналы позволяют компьютерам в виртуальной сети получить доступ ко всем необходимым микрослужбам Site Recovery в контексте хранилища. Позднее при включении репликации к той же частной конечной точке добавляются два дополнительных полных доменных имени.

Для форматирования пяти доменных имен используется следующий шаблон:

`{Vault-ID}-asr-pod01-{type}-.{target-geo-code}.siterecovery.windowsazure.com`

## <a name="approve-private-endpoints-for-site-recovery"></a>Утверждение частных конечных точек для Site Recovery

Если пользователь, создающий частную конечную точку, является еще и владельцем хранилища Служб восстановления, созданная по описанной выше схеме частная конечная точка будет утверждена автоматически в течение нескольких минут. В противном случае владелец хранилища должен утвердить частную конечную точку, прежде чем ей можно будет пользоваться. Чтобы утвердить или отклонить запрошенное подключение к частной конечной точке, откройте **Подключения к частной конечной точке** в разделе "Параметры" на странице хранилища восстановления.

Прежде чем продолжить, можно открыть ресурс частной конечной точки и проверить состояние подключения.

:::image type="content" source="./media/azure-to-azure-how-to-enable-replication-private-endpoints/vault-private-endpoint-connections.png" alt-text="Страница подключений к частной конечной точке хранилища и список подключений на портале Azure.":::

## <a name="optional-create-private-endpoints-for-the-cache-storage-account"></a><a name="create-private-endpoints-for-the-cache-storage-account"></a>(Дополнительно) Создание частных конечных точек для учетной записи хранения кэша

Можно использовать частную конечную точку в службе хранилища Azure. Для репликации Azure Site Recovery _не обязательно_ создавать частные конечные точки для доступа к хранилищу. При создании частной конечной точки для хранилища применяются следующие требования.

- Вам потребуется частная конечная точка для учетной записи хранения кэша или журнала в исходной виртуальной сети.
- Вторая частная конечная точка потребуется во время повторной защиты виртуальных машин с отработкой отказа в сети восстановления. Эта частная конечная точка предназначена для новой учетной записи хранения, созданной в целевом регионе.

> [!NOTE]
> Даже если в учетной записи хранения не активированы частные конечные точки, защита все равно успешной. Однако трафик репликации будет передаваться в общедоступные конечные точки Azure Site Recovery. Чтобы обеспечить передачу трафика репликации по приватным каналам, необходимо включить частные конечные точки в учетной записи хранения.

> [!NOTE]
> Частную конечную точку для хранилища можно создать только в учетных записях хранения **общего назначения версии 2**. Сведения о ценах см. в разделе [Цены на страничные BLOB-объекты категории “Стандартный”](https://azure.microsoft.com/pricing/details/storage/page-blobs/).

Следуйте [указаниям по созданию частного хранилища](../private-link/tutorial-private-endpoint-storage-portal.md#create-storage-account-with-a-private-endpoint), чтобы создать учетную запись хранения с частной конечной точкой. Выберите **Да** для интеграции с частной зоной DNS. Выберите уже созданную зону DNS или создайте новую.

## <a name="grant-required-permissions-to-the-vault"></a>Предоставление требуемых разрешений хранилищу

Если виртуальные машины используют управляемые диски, необходимо предоставить разрешения управляемого удостоверения только учетным записям хранения кэша. Если виртуальные машины используют неуправляемые диски, необходимо предоставить разрешения управляемого удостоверения исходной и целевой учетным записям хранения, а также учетной записи хранения кэша. В этом случае целевую учетную запись хранения необходимо создать заранее.

Перед включением репликации виртуальных машин управляемое удостоверение хранилища должно иметь следующие разрешения роли в зависимости от типа учетной записи хранения.

- Учетные записи хранения на основе Resource Manager (категория “Стандартный”):
  - [Участник](../role-based-access-control/built-in-roles.md#contributor)
  - [участник данных BLOB-объектов хранилища](../role-based-access-control/built-in-roles.md#storage-blob-data-contributor);
- Учетные записи хранения на основе Resource Manager (категория “Премиум”):
  - [Участник](../role-based-access-control/built-in-roles.md#contributor)
  - [владелец данных BLOB-объектов хранилища](../role-based-access-control/built-in-roles.md#storage-blob-data-owner);
- Классические учетные записи хранения:
  - [Участник классической учетной записи хранения](../role-based-access-control/built-in-roles.md#classic-storage-account-contributor)
  - [Роль службы оператора ключей классических учетных записей хранения](../role-based-access-control/built-in-roles.md#classic-storage-account-key-operator-service-role)

Следующие шаги описывают, как по одному добавлять назначение ролей в учетные записи хранения:

1. Откройте учетную запись хранения и выберите **Управление доступом (IAM)** в левой части страницы.

1. В разделе **Управление доступом (IAM)** в поле "Добавить назначение ролей" выберите **Добавить**.

   :::image type="content" source="./media/azure-to-azure-how-to-enable-replication-private-endpoints/storage-role-assignment.png" alt-text="Страница управления доступом (IAM) для учетной записи хранения и кнопка &quot;Добавить назначение ролей&quot; на портале Azure.":::

1. На боковой странице "Добавление назначения ролей" выберите роль в раскрывающемся списке **Роль**. Введите **имя** хранилища и нажмите кнопку **Сохранить**.

   :::image type="content" source="./media/azure-to-azure-how-to-enable-replication-private-endpoints/storage-role-assignment-select-role.png" alt-text="Страница управления доступом (IAM) для учетной записи хранения и варианты выбора роли и участника, которому она предоставляется, на портале Azure.":::

Помимо этих разрешений, необходимо также предоставить доступ доверенным службам Майкрософт. Откройте "Брандмауэры и виртуальные сети" и установите флажок "Разрешить доступ к учетной записи хранения доверенным службам Майкрософт" в окне **Исключения**.

## <a name="protect-your-virtual-machines"></a>Защита виртуальных машин

Завершив все указанные выше конфигурации, продолжите процесс включения репликации для виртуальных машин. Если при создании частных конечных точек в хранилище использовалась интеграция с DNS, то все операции Site Recovery будут работать без дополнительных действий. Но если зоны DNS создаются и настраиваются вручную, после включения репликации потребуется внести конкретные записи DNS в исходную и целевую зоны DNS. Дополнительные сведения и инструкции см. в статье [Создание частных зон DNS и добавление записей DNS вручную](#create-private-dns-zones-and-add-dns-records-manually).

## <a name="create-private-dns-zones-and-add-dns-records-manually"></a>Создание частных зон DNS и добавление записей DNS вручную

Если при создании частной конечной точки для хранилища вы не выбрали параметр для интеграции с частной зоной DNS, выполните действия, описанные в этом разделе.

Создайте одну частную зону DNS, чтобы агент мобильности мог разрешать полные доменные имена приватных каналов в частные IP-адреса.

1. Создание частной зоны DNS

   1. Выполните поиск по фразе "Частная зона DNS" на панели поиска **Все службы** и выберите в раскрывающемся списке "Частные зоны DNS".

      :::image type="content" source="./media/azure-to-azure-how-to-enable-replication-private-endpoints/search-private-dns-zone.png" alt-text="Поиск частной зоны DNS на странице создания ресурсов на портале Azure.":::

   1. На странице "Частные зоны DNS" нажмите кнопку **\+Добавить**, чтобы начать создание новой зоны.

   1. На странице "Создание частной зоны DNS" введите необходимые сведения. Укажите `privatelink.siterecovery.windowsazure.com` в качестве имени частной зоны DNS. Для ее создания можно выбрать любую группу ресурсов и любую подписку.

      :::image type="content" source="./media/azure-to-azure-how-to-enable-replication-private-endpoints/create-private-dns-zone.png" alt-text="Вкладка основных сведений страницы “Создание частной зоны DNS” и данные связанного проекта на портале Azure.":::

   1. Откройте вкладку **Проверить и создать**, чтобы проверить и создать зону DNS.

1. Связывание частной зоны DNS с виртуальной сетью

   Теперь созданные выше частные зоны DNS необходимо связать с виртуальной сетью, в которой находятся серверы. Кроме того, частную зону DNS нужно заранее связать с целевой виртуальной сетью.

   1. Откройте частную зону DNS, созданную на предыдущем этапе, и выберите раздел **Ссылки на виртуальные сети** в левой части страницы. После этого нажмите кнопку **\+Добавить**.

   1. Укажите необходимые сведения. В поля **Подписка** и **Виртуальная сеть** внесите соответствующую информацию о виртуальной сети, в которой находятся серверы. Остальные поля необходимо оставить как есть.

      :::image type="content" source="./media/azure-to-azure-how-to-enable-replication-private-endpoints/add-virtual-network-link.png" alt-text="Страница для добавления ссылки на виртуальную сеть и поля для указания имени ссылки, подписки и связанной виртуальной сети на портале Azure.":::

1. Добавление записей DNS

   Когда необходимые частные зоны DNS и частные конечные точки будут созданы, потребуется добавить записи DNS в зоны DNS.

   > [!NOTE]
   > Если вы используете пользовательскую частную зону DNS, убедитесь, что выполняются схожие записи, как описано ниже.

   На этом этапе для каждого полного доменного имени в частной конечной точке необходимо внести записи в частную зону DNS.

   1. Откройте частную зону DNS и выберите раздел **Обзор** в левой части страницы. Затем выберите **\+Набор записей**, чтобы начать добавление записей.

   1. На открывшейся странице "Добавление набора записей" добавьте запись для каждого полного доменного имени и частного IP-адреса в виде записи типа _A_. Список полных доменных имен и IP-адресов находится на странице "Частная конечная точка" в разделе **Обзор**. Как показано в приведенном ниже примере, первое полное доменное имя из частной конечной точки добавляется в набор записей в частной зоне DNS.

      Эти полные доменные имена соответствуют шаблону: `{Vault-ID}-asr-pod01-{type}-.{target-geo-code}.siterecovery.windowsazure.com`

      :::image type="content" source="./media/azure-to-azure-how-to-enable-replication-private-endpoints/add-record-set.png" alt-text="Страница для добавления записи DNS типа A для полного доменного имени в частной конечной точке на портале Azure.":::

   > [!NOTE]
   > После включения репликации в частных конечных точках обоих регионов создаются еще два полных доменных имени. Убедитесь, что для вновь созданных полных доменных имен тоже добавлены записи DNS.

## <a name="next-steps"></a>Дальнейшие действия

Теперь, когда вы активировали частные конечные точки для репликации виртуальных машин, ознакомьтесь с другими страницами, чтобы получить дополнительные и связанные сведения.

- [Репликация виртуальных машин Azure в другой регион Azure](./azure-to-azure-how-to-enable-replication.md)
- [Руководство по Настройка аварийного восстановления для виртуальных машин Azure](./azure-to-azure-tutorial-enable-replication.md)