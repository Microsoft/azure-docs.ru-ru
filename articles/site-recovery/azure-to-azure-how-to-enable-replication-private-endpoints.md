---
title: Включение репликации для частных конечных точек в Azure Site Recovery
description: В этой статье описывается настройка репликации для виртуальных машин с частными конечными точками из одного региона Azure в другой с помощью Site Recovery.
author: Harsha-CS
ms.author: harshacs
ms.service: site-recovery
ms.topic: article
ms.date: 07/14/2020
ms.custom: references_regions
ms.openlocfilehash: 86f18be73966cb07489630191420b846622e45b8
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "98629833"
---
# <a name="replicate-machines-with-private-endpoints"></a>Репликация компьютеров с частными конечными точками

Azure Site Recovery позволяет использовать частные конечные точки [частной связи Azure](../private-link/private-endpoint-overview.md) для репликации компьютеров из изолированной виртуальной сети. Доступ к хранилищу восстановления в частной конечной точке поддерживается во всех регионах коммерческих & правительственных учреждений Azure.

В этой статье приводятся инструкции по выполнению следующих действий.

- Создайте хранилище служб восстановления Azure Backup для защиты компьютеров.
- Включите управляемое удостоверение для хранилища и предоставьте необходимые разрешения для доступа к учетным записям хранения клиента, чтобы реплицировать трафик из источника в целевое расположение. Доступ к управляемым удостоверениям для хранилища необходим при настройке доступа к хранилищу в частной связи.
- Внесение изменений DNS, необходимых для частных конечных точек
- Создание и утверждение частных конечных точек для хранилища в виртуальной сети
- Создайте частные конечные точки для учетных записей хранения. Вы можете по мере необходимости разрешить общий доступ или брандмауэр для хранилища. Создание частной конечной точки для доступа к хранилищу не является обязательным для Azure Site Recovery.
  
Ниже приведена Эталонная архитектура для изменения рабочего процесса репликации с частными конечными точками.

:::image type="content" source="./media/azure-to-azure-how-to-enable-replication-private-endpoints/architecture.png" alt-text="Эталонная архитектура для Site Recovery с частными конечными точками.":::

## <a name="prerequisites-and-caveats"></a>Предварительные требования и предостережения

- Частные конечные точки можно создавать только для новых хранилищ служб восстановления, в которых нет элементов, зарегистрированных в хранилище. Таким образом, **перед добавлением элементов в хранилище необходимо создать** частные конечные точки. Проверьте структуру ценообразования для [частных конечных точек](https://azure.microsoft.com/pricing/details/private-link/).
- Если для хранилища создана частная конечная точка, хранилище блокируется и **недоступно для сетей, отличных от сетей с частными конечными точками**.
- Azure Active Directory в настоящее время не поддерживает частные конечные точки. Таким образом, IP-адресам и полным доменным именам, необходимым для работы Azure Active Directory в регионе, необходимо разрешить исходящий доступ из защищенной сети. Вы также можете использовать тег группы безопасности сети "Azure Active Directory" и теги брандмауэра Azure, чтобы разрешить доступ к Azure Active Directory, как применимо.
- Как **минимум семь IP-адресов необходимы** в подсетях как на исходных компьютерах, так и на компьютерах восстановления. При создании частной конечной точки для хранилища Site Recovery создает пять частных ссылок для доступа к ее микрослужбам. Кроме того, при включении репликации добавляются две дополнительные частные ссылки для связывания исходного и целевого регионов.
- В исходной подсети и в подсетях восстановления **требуется один дополнительный IP-адрес** . Этот IP-адрес необходим только в том случае, если необходимо использовать частные конечные точки, подключающиеся к учетным записям хранения кэша.
  Частные конечные точки для хранилища можно создать только для типа общего назначения v2. Ознакомьтесь со структурой ценообразования для [обмена данными в GPv2](https://azure.microsoft.com/pricing/details/storage/page-blobs/).

 ## <a name="creating-and-using-private-endpoints-for-site-recovery"></a>Создание и использование частных конечных точек для Site Recovery

 В этом разделе рассказывается о шагах, связанных с созданием и использованием частных конечных точек для Azure Site Recovery в виртуальных сетях.

> [!NOTE]
> Настоятельно рекомендуется выполнять эти действия в той же последовательности, которая указана в. Невозможность сделать это может привести к тому, что отображаемое хранилище не сможет использовать частные конечные точки и потребует перезапуска процесса с новым хранилищем.

## <a name="create-a-recovery-services-vault"></a>Создание хранилища Служб восстановления

Хранилище служб восстановления — это сущность, которая содержит сведения о репликации компьютеров и используется для активации Site Recoveryных операций. Дополнительные сведения см. [в статье Создание хранилища служб восстановления](./azure-to-azure-tutorial-enable-replication.md#create-a-recovery-services-vault).

## <a name="enable-the-managed-identity-for-the-vault"></a>Включите управляемое удостоверение для хранилища.

[Управляемое удостоверение](../active-directory/managed-identities-azure-resources/overview.md) позволяет хранилищу получать доступ к учетным записям хранения клиента. Site Recovery требуется доступ к исходному хранилищу, целевому хранилищу и учетным записям хранения кэша и журнала в зависимости от требований сценария.
Доступ к управляемым удостоверениям важен при использовании службы частных ссылок для хранилища.

1. Перейдите к хранилищу служб восстановления. В разделе _Параметры_ выберите **удостоверение** .

   :::image type="content" source="./media/azure-to-azure-how-to-enable-replication-private-endpoints/enable-managed-identity-in-vault.png" alt-text="Отображает портал Azure и страницу служб восстановления.":::

1. Измените **состояние** на _вкл_ и нажмите кнопку **сохранить**.

1. Создается **идентификатор объекта** , указывающий, что хранилище теперь зарегистрировано в Azure Active Directory.

## <a name="create-private-endpoints-for-the-recovery-services-vault"></a>Создание частных конечных точек для хранилища служб восстановления

Чтобы включить отработку отказа и восстановление размещения для виртуальных машин Azure, вам понадобятся две частные конечные точки для хранилища. Одна частная конечная точка для защиты компьютеров в исходной сети и другая для повторной защиты компьютеров, для которых выполнена отработка отказа, в сети восстановления.

Убедитесь, что вы создаете виртуальную сеть восстановления в целевом регионе, а также в процессе установки.

Создайте первую частную конечную точку для хранилища в исходной виртуальной сети с помощью частного центра ссылок на портале или с помощью [Azure PowerShell](../private-link/create-private-endpoint-powershell.md). Создайте вторую частную конечную точку для хранилища в сети восстановления. Ниже приведены действия по созданию частной конечной точки в исходной сети. Повторите те же рекомендации, чтобы создать вторую частную конечную точку.

1. В строке поиска портал Azure найдите и выберите "Частная ссылка". Это действие переведет вас в частный центр ссылок.

   :::image type="content" source="./media/azure-to-azure-how-to-enable-replication-private-endpoints/search-private-links.png" alt-text="Показывает Поиск в портал Azure для частного центра ссылок.":::

1. На панели навигации слева выберите **частные конечные точки**. На странице частные конечные точки нажмите кнопку **\+ Добавить** , чтобы начать создание частной конечной точки для хранилища.

   :::image type="content" source="./media/azure-to-azure-how-to-enable-replication-private-endpoints/create-private-endpoints.png" alt-text="Показывает создание частной конечной точки в частном центре ссылок.":::

1. В интерфейсе "Создание частной конечной точки" необходимо указать сведения для создания подключения к частной конечной точке.

   1. **Основные** сведения. заполните основные данные для частных конечных точек. Регион должен быть таким же, как и на исходных компьютерах.

      :::image type="content" source="./media/azure-to-azure-how-to-enable-replication-private-endpoints/create-private-endpoints-basic-tab.png" alt-text="Содержит вкладки &quot;основные&quot;, &quot;сведения о проекте&quot;, &quot;Подписка&quot; и другие связанные поля для создания частной конечной точки в портал Azure.":::

   1. **Ресурс**. на этой вкладке необходимо указать ресурс "платформа как услуга", для которого нужно создать подключение. Выберите _Microsoft. RecoveryServices/хранилища_ из **типа ресурса** для выбранной подписки. Затем выберите имя хранилища служб восстановления для **ресурса** и задайте _Azure Site Recovery_ в качестве **целевого подресурса**.

      :::image type="content" source="./media/azure-to-azure-how-to-enable-replication-private-endpoints/create-private-endpoints-resource-tab.png" alt-text="Отображение полей &quot;ресурс&quot;, &quot;тип ресурса&quot;, &quot;ресурс&quot; и &quot;целевое подресурс&quot; для связывания с частной конечной точкой в портал Azure.":::

   1. **Конфигурация**: в поле Конфигурация укажите виртуальную сеть и подсеть, в которых необходимо создать частную конечную точку. Эта виртуальная сеть является сетью, в которой находится виртуальная машина. Включите интеграцию с частной зоной DNS, выбрав **Да**. Выберите уже созданную зону DNS или создайте новую. При выборе пункта **Да** автоматически связывается зона с исходной виртуальной сетью и добавляются записи DNS, необходимые для разрешения DNS новых IP-адресов и полных доменных имен, созданных для частной конечной точки.

      Убедитесь, что вы решили создать новую зону DNS для каждой новой частной конечной точки, подключенной к тому же хранилищу. При выборе существующей частной зоны DNS предыдущие записи CNAME перезаписываются. Прежде чем продолжить, ознакомьтесь с [руководством по закрытой конечной точке](../private-link/private-endpoint-overview.md#private-endpoint-properties) .

      Если в вашей среде используется модель "звезда", вам потребуется только одна частная конечная точка и только одна частная зона DNS для всей установки, так как между всеми виртуальными сетями уже включено пиринг. Дополнительные сведения см. в разделе [Интеграция DNS с частной конечной точкой](../private-link/private-endpoint-dns.md#virtual-network-workloads-without-custom-dns-server).

      Чтобы вручную создать зону частной зоны DNS, выполните действия, описанные в статье [создание частных зон DNS и добавление записей DNS вручную](#create-private-dns-zones-and-add-dns-records-manually).

      :::image type="content" source="./media/azure-to-azure-how-to-enable-replication-private-endpoints/create-private-endpoints-configuration-tab.png" alt-text="Отображает вкладку Конфигурация с полями интеграция с сетью и DNS для настройки частной конечной точки в портал Azure.":::

   1. **Теги**. при необходимости можно добавить теги для частной конечной точки.

   1. **Проверка \+ создания**. по завершении проверки выберите **создать** , чтобы создать частную конечную точку.

После создания частной конечной точки в частную конечную точку добавляются пять полных доменных имен. Эти ссылки позволяют компьютерам в виртуальной сети получить доступ ко всем необходимым Site Recovery микрослужбам в контексте хранилища. Позднее при включении репликации в ту же частную конечную точку добавляются два дополнительных полных доменных имени.

Пять доменных имен форматируются со следующим шаблоном:

`{Vault-ID}-asr-pod01-{type}-.{target-geo-code}.siterecovery.windowsazure.com`

## <a name="approve-private-endpoints-for-site-recovery"></a>Утверждение частных конечных точек для Site Recovery

Если пользователь, создающий частную конечную точку, также является владельцем хранилища служб восстановления, в течение нескольких минут частная конечная точка, созданная ранее, будет утверждена в автоматическом режиме. В противном случае владелец хранилища должен утвердить закрытую конечную точку, прежде чем использовать ее. Чтобы утвердить или отклонить запрошенное подключение частной конечной точки, перейдите на страницу **подключения к частной конечной точке** в разделе "Параметры" на странице "хранилище восстановления".

Прежде чем продолжить, можно перейти к ресурсу частной конечной точки, чтобы проверить состояние подключения.

:::image type="content" source="./media/azure-to-azure-how-to-enable-replication-private-endpoints/vault-private-endpoint-connections.png" alt-text="Отображает страницу подключения к частным конечным точкам хранилища и список соединений в портал Azure.":::

## <a name="optional-create-private-endpoints-for-the-cache-storage-account"></a><a name="create-private-endpoints-for-the-cache-storage-account"></a>Используемых Создание частных конечных точек для учетной записи хранения кэша

Можно использовать частную конечную точку в службе хранилища Azure. Создание частных конечных точек для доступа к хранилищу _необязательно_ для Azure Site Recovery репликации. При создании частной конечной точки для хранилища применяются следующие требования.

- Вам потребуется частная конечная точка для учетной записи хранения кэша или журнала в исходной виртуальной сети.
- Во время повторной защиты виртуальных машин с отработкой отказа в сети восстановления требуется вторая частная конечная точка. Эта частная конечная точка предназначена для новой учетной записи хранения, созданной в целевом регионе.

> [!NOTE]
> Если в учетной записи хранения не включены частные конечные точки, защита будет по-прежнему успешной. Однако трафик репликации передается в Azure Site Recovery общедоступные конечные точки. Чтобы обеспечить передачу трафика репликации через частные соединения, учетная запись хранения должна быть включена с частными конечными точками.

> [!NOTE]
> Частную конечную точку для хранилища можно создать только в учетных записях хранения **общего назначения v2** . Сведения о ценах см. на [странице цены на большой двоичный объект](https://azure.microsoft.com/pricing/details/storage/page-blobs/)уровня "Стандартный".

Следуйте указаниям по [созданию частного хранилища](../private-link/tutorial-private-endpoint-storage-portal.md#create-storage-account-with-a-private-endpoint) , чтобы создать учетную запись хранения с частной конечной точкой. Выберите **Да** для интеграции с частной зоной DNS. Выберите уже созданную зону DNS или создайте новую.

## <a name="grant-required-permissions-to-the-vault"></a>Предоставление требуемых разрешений для хранилища

Если виртуальные машины используют управляемые диски, необходимо предоставить разрешения управляемого удостоверения только учетным записям хранения кэша. Если виртуальные машины используют неуправляемые диски, необходимо предоставить разрешения управляемого удостоверения для исходных, кэша и целевых учетных записей хранения. В этом случае необходимо создать целевую учетную запись хранения заранее.

Перед включением репликации виртуальных машин управляемое удостоверение хранилища должно иметь следующие разрешения роли в зависимости от типа учетной записи хранения.

- Учетные записи хранения на основе диспетчер ресурсов (стандартный тип):
  - [Участник](../role-based-access-control/built-in-roles.md#contributor)
  - [участник данных BLOB-объектов хранилища](../role-based-access-control/built-in-roles.md#storage-blob-data-contributor);
- Учетные записи хранения на основе диспетчер ресурсов (тип "Премиум"):
  - [Участник](../role-based-access-control/built-in-roles.md#contributor)
  - [владелец данных BLOB-объектов хранилища](../role-based-access-control/built-in-roles.md#storage-blob-data-owner);
- Классические учетные записи хранения:
  - [Участник классической учетной записи хранения](../role-based-access-control/built-in-roles.md#classic-storage-account-contributor)
  - [Роль службы оператора ключей классических учетных записей хранения](../role-based-access-control/built-in-roles.md#classic-storage-account-key-operator-service-role)

Следующие шаги описывают, как добавить назначение роли в учетные записи хранения по одной за раз:

1. Перейдите к учетной записи хранения и выберите **Управление доступом (IAM)** в левой части страницы.

1. В **элементе управления доступом (IAM)** в поле "добавить назначение ролей" выберите **Добавить**.

   :::image type="content" source="./media/azure-to-azure-how-to-enable-replication-private-endpoints/storage-role-assignment.png" alt-text="Отображает страницу управления доступом (IAM) в учетной записи хранения и кнопку &quot;добавить назначение роли&quot; в портал Azure.":::

1. На боковой странице "Добавление назначения ролей" выберите роль из списка выше в раскрывающемся списке **роль** . Введите **имя** хранилища и нажмите кнопку **сохранить**.

   :::image type="content" source="./media/azure-to-azure-how-to-enable-replication-private-endpoints/storage-role-assignment-select-role.png" alt-text="Отображает страницу управления доступом (IAM) в учетной записи хранения и варианты выбора роли и участника, которому следует предоставить эту роль в портал Azure.":::

Помимо этих разрешений, службе MS Trusted Services также необходимо разрешить доступ. Перейдите в раздел "брандмауэры и виртуальные сети" и установите флажок "разрешить доступ к учетной записи хранения доверенным службам Майкрософт" в окне " **исключения**".

## <a name="protect-your-virtual-machines"></a>Защитите свои виртуальные машины

После завершения всех указанных выше конфигураций продолжите включение репликации для виртуальных машин. Все операции Site Recovery работают без дополнительных действий, если при создании частных конечных точек в хранилище использовалась интеграция с DNS. Однако если зоны DNS создаются и настраиваются вручную, вам потребуются дополнительные действия по добавлению конкретных записей DNS в исходную и целевую зоны DNS после включения репликации. Дополнительные сведения и инструкции см. в статьях [создание частных зон DNS и добавление записей DNS вручную](#create-private-dns-zones-and-add-dns-records-manually).

## <a name="create-private-dns-zones-and-add-dns-records-manually"></a>Создание частных зон DNS и добавление записей DNS вручную

Если вы не выбрали параметр для интеграции с частной зоной DNS во время создания частной конечной точки для хранилища, выполните действия, описанные в этом разделе.

Создайте одну закрытую зону DNS, чтобы позволить агенту мобильности разрешать полные доменные имена частных ссылок в частные IP-адреса.

1. Создание частной зоны DNS

   1. Выполните поиск по фразе "Частная зона DNSная зона" на панели поиска **все службы** и выберите в раскрывающемся списке "зоны частная зона DNS".

      :::image type="content" source="./media/azure-to-azure-how-to-enable-replication-private-endpoints/search-private-dns-zone.png" alt-text="Показывает Поиск &quot;частной зоны DNS&quot; на странице &quot;Создание ресурсов&quot; в портал Azure.":::

   1. На странице "Частная зона DNS зоны" нажмите кнопку **\+ Добавить** , чтобы начать создание новой зоны.

   1. На странице "Создание частной зоны DNS" введите необходимые сведения. Введите имя частной зоны DNS в качестве `privatelink.siterecovery.windowsazure.com` . Для ее создания можно выбрать любую группу ресурсов и любую подписку.

      :::image type="content" source="./media/azure-to-azure-how-to-enable-replication-private-endpoints/create-private-dns-zone.png" alt-text="На странице Создание Частная зона DNS зоны и сведения о связанном проекте в портал Azure отображается вкладка основы.":::

   1. Перейдите на вкладку **Проверка \+ создания** , чтобы проверить и создать зону DNS.

1. Связывание частной зоны DNS с виртуальной сетью

   Частные зоны DNS, созданные выше, должны быть связаны с виртуальной сетью, в которой находятся серверы. Кроме того, необходимо заранее связать частную зону DNS с целевой виртуальной сетью.

   1. Перейдите к частной зоне DNS, созданной на предыдущем шаге, и перейдите к разделу **ссылки виртуальной сети** в левой части страницы. После этого нажмите кнопку **\+ Добавить** .

   1. Введите необходимые сведения. Поля **Подписка** и **Виртуальная сеть** должны быть заполнены соответствующими сведениями о виртуальной сети, в которой находятся серверы. Остальные поля должны быть оставлены как есть.

      :::image type="content" source="./media/azure-to-azure-how-to-enable-replication-private-endpoints/add-virtual-network-link.png" alt-text="Отображается страница для добавления ссылки на виртуальную сеть с именем ссылки, подпиской и связанной виртуальной сетью в портал Azure.":::

1. Добавление записей DNS

   Создав необходимые частные зоны DNS и частные конечные точки, необходимо добавить записи DNS в зоны DNS.

   > [!NOTE]
   > Если вы используете пользовательскую частную зону DNS, убедитесь, что аналогичные записи выполняются, как описано ниже.

   На этом шаге необходимо сделать записи для каждого полного доменного имени в частной конечной точке в частной зоне DNS.

   1. Перейдите к частной зоне DNS и перейдите к разделу **Обзор** в левой части страницы. После этого выберите **\+ набор записей** , чтобы начать добавление записей.

   1. На открывшейся странице "Добавление набора записей" добавьте запись для каждого полного доменного имени и частного IP- _адреса в качестве записи типа._ Список полных доменных имен и IP-адресов можно получить на странице "Частная конечная точка" в разделе **Общие сведения**. Как показано в приведенном ниже примере, первое полное доменное имя из частной конечной точки добавляется в набор записей в частной зоне DNS.

      Полные доменные имена соответствуют шаблону: `{Vault-ID}-asr-pod01-{type}-.{target-geo-code}.siterecovery.windowsazure.com`

      :::image type="content" source="./media/azure-to-azure-how-to-enable-replication-private-endpoints/add-record-set.png" alt-text="Показывает страницу для добавления записи типа DNS A для полного доменного имени в частную конечную точку в портал Azure.":::

   > [!NOTE]
   > После включения репликации в частных конечных точках создаются два полных доменных имени в обоих регионах. Убедитесь, что вы также добавили записи DNS для вновь созданных полных доменных имен.

## <a name="next-steps"></a>Дальнейшие действия

Теперь, когда вы включили частные конечные точки для репликации виртуальных машин, ознакомьтесь с другими страницами, чтобы получить дополнительные и связанные сведения.

- [Репликация виртуальных машин Azure в другой регион Azure](./azure-to-azure-how-to-enable-replication.md)
- [Руководство по Настройка аварийного восстановления для виртуальных машин Azure](./azure-to-azure-tutorial-enable-replication.md)