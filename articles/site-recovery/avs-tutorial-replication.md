---
title: Настройка Azure Site Recovery для виртуальных машин Решения Azure VMware
description: Сведения о настройке аварийного восстановления виртуальных машин Решения Azure VMware в Azure с помощью Azure Site Recovery.
author: Harsha-CS
manager: rochakm
ms.service: site-recovery
ms.topic: tutorial
ms.date: 09/29/2020
ms.author: harshacs
ms.custom: MVC
ms.openlocfilehash: 3ac1f5bd3d44b7f98284cead60b34689f3d7be30
ms.sourcegitcommit: f28ebb95ae9aaaff3f87d8388a09b41e0b3445b5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/29/2021
ms.locfileid: "93395501"
---
# <a name="setup-azure-site-recovery-for-azure-vmware-solution-vms"></a>Настройка Azure Site Recovery для виртуальных машин Решения Azure VMware

В этой статье объясняется, как включить репликацию виртуальных машин Решения Azure VMware для аварийного восстановления в Azure с помощью службы [Azure Site Recovery](site-recovery-overview.md).

Это третье руководство в серии, в котором показано, как настроить аварийное восстановление для виртуальных машин Решения Azure VMware в Azure. В предыдущем руководстве мы [подготовили среду Решения VMware Azure](avs-tutorial-prepare-avs.md) для аварийного восстановления в Azure.


В этом руководстве описано следующее:

> [!div class="checklist"]
>
> * Настройка параметров репликации источника и настройка сервера конфигурации Site Recovery в частном облаке Решения Azure VMware.
> * Настройте параметры целевого объекта репликации.
> * Создание политики репликации.
> * Включите репликацию для виртуальных машин VMware.

> [!NOTE]
> В учебниках описан самый простой способ развертывания для определенного сценария. В них везде, где возможно, используются значения по умолчанию, и описаны не все возможные параметры и пути. Подробные инструкции см. в разделе с инструкциями в материалах по Site Recovery.

## <a name="before-you-start"></a>Перед началом работы

Выполните инструкции, приведенные в предыдущих учебниках:

1. Убедитесь, что вы [настроили Azure](avs-tutorial-prepare-azure.md) для аварийного восстановления в Azure.
2. Выполните [эти шаги](avs-tutorial-prepare-avs.md), чтобы подготовить развертывание Решения Azure VMware к аварийному восстановлению в Azure.
3. В этом руководстве описано, как выполнить репликацию одной виртуальной машины. Если вы развертываете несколько виртуальных машин, воспользуйтесь [Планировщиком развертывания](https://aka.ms/asr-deployment-planner). См. [дополнительные сведения](site-recovery-deployment-planner.md) об этом средстве.
4. В этом руководстве используется несколько методов, которые вы, возможно, захотите реализовать иначе:
    - В этом руководстве для создания сервера конфигурации виртуальной машины VMware используется шаблон OVA. Если по какой-либо причине это невозможно, выполните [эти инструкции](physical-manage-configuration-server.md) для настройки сервера конфигурации вручную.
    - В этом руководстве предусмотрено, что Site Recovery автоматически скачает и установит MySQL на сервере конфигурации. При желании вы можете установить его вручную. [Подробнее](vmware-azure-deploy-configuration-server.md#configure-settings).




## <a name="select-a-protection-goal"></a>Выбор целевого объекта защиты

1. В колонке **Хранилища служб восстановления** выберите имя хранилища. В этом сценарии мы используем имя **ContosoVMVault**.
2. В разделе **Приступая к работе** выберите Site Recovery. Затем выберите **Подготовка инфраструктуры**.
3. Выберите **Protection goal** (Цель защиты)  > **Where are your machines located** (Где находятся компьютеры?), а затем — **On-premises** (Локально).
4. В разделе **Куда следует реплицировать компьютеры?** выберите **To Azure** (В Azure).
5. В разделе **Are your machines virtualized** (Ваши компьютеры виртуализированы?) выберите **Yes, with VMware vSphere Hypervisor** (Да, с помощью гипервизора VMware vSphere). Нажмите кнопку **ОК**.



## <a name="set-up-the-source-environment"></a>Настройка исходной среды

В исходной среде вам понадобится один высокодоступный локальный компьютер для размещения таких локальных компонентов Site Recovery:

- **Сервер конфигурации**: Сервер конфигурации используется для управления обменом данными между частным облаком Решения Azure VMware и Azure, а также репликацией данных.
- **Сервер обработки** Сервер обработки выступает в качестве шлюза репликации. Он получает данные репликации, оптимизирует их путем кэширования, сжатия и шифрования и отправляет их в учетную запись хранения кэша Azure. Сервер обработки также устанавливает агенты службы Mobility Service на виртуальную машину, которую требуется реплицировать, и выполняет автоматическое обнаружение виртуальных машин Решения Azure VMware.
- **Главный целевой сервер** Главный целевой сервер обрабатывает данные репликации при восстановлении размещения с переносом из Azure.


Все эти компоненты устанавливаются вместе на один компьютер Решения Azure VMware, который называется *сервером конфигурации*. По умолчанию для аварийного восстановления Решения Azure VMware мы настроили сервер конфигурации в качестве высокодоступной виртуальной машины VMware. Чтобы сделать это, скачайте подготовленный шаблон Open Virtualization Application (OVA) и импортируйте его в VMware для создания виртуальной машины.

- Последняя версия сервера конфигурации доступна на портале. Ее также можно скачать непосредственно из [Центра загрузки Майкрософт](https://aka.ms/asrconfigurationserver).
- Если по какой-либо причине вы не можете воспользоваться шаблоном OVA для настройки виртуальной машины, выполните [эти инструкции](physical-manage-configuration-server.md) для настройки сервера конфигурации вручную.
- Вместе с шаблоном OVF предоставляется оценочная лицензия сроком на 180 дней. Система Windows, работающая на виртуальной машине, должна быть активирована с помощью необходимой лицензии.


### <a name="download-the-vm-template"></a>Скачивание шаблона виртуальной машины

1. В хранилище выберите **Prepare Infrastructure** (Подготовка инфраструктуры)  > **Source** (Источник).
2. В колонке **Подготовка источника** выберите **+ Сервер конфигурации**.
3. В колонке **Add Server** (Добавление сервера) в поле **Server type** (Тип сервера) должно быть указано **Configuration server for VMware** (Сервер конфигурации для VMware).
4. Скачайте шаблон OVA для сервера конфигурации.



## <a name="import-the-template-in-vmware"></a>Импорт шаблона в VMware


1. Войдите на сервер VMware vCenter или узел vSphere ESXi с помощью клиента VMware vSphere.
2. В меню **File** (Файл) выберите **Deploy OVF Template** (Развернуть шаблон OVF), чтобы запустить **мастер развертывания шаблона OVF**.

     ![Снимок экрана с командой шаблона развертывания OVF в клиенте VMWare vSphere.](./media/vmware-azure-tutorial/vcenter-wizard.png)

3. Укажите расположение скачанного шаблона OVF в разделе **Выбрать источник**.
4. В разделе **Просмотр сведений** выберите **Далее**.
5. Примите значения параметров по умолчанию в разделах **Select name and folder** (Выбор имени и папки) и **Select configuration** (Выбор конфигурации).
6. В разделе **Select storage** (Выбор хранилища), чтобы улучшить производительность, выберите **Thick Provision Eager Zeroed** (Быстрое обнуление плотной подготовки) в области **Select virtual disk format** (Выбор формата виртуального диска).
7. На остальных страницах мастера примите значение параметров по умолчанию.
8. Чтобы настроить виртуальную машину с параметрами по умолчанию, на странице **Ready to complete** (Готово к завершению) выберите **Power on after deployment** > **Finish** (Включение после развертывания > Готово).

   > [!TIP]
   > Если вам нужен дополнительный сетевой интерфейс, снимите флажок **Power on after deployment** > **Finish** (Включение после развертывания > Готово). По умолчанию шаблон содержит один сетевой интерфейс. Вы можете добавить дополнительные сетевые адаптеры после развертывания.

## <a name="add-an-additional-adapter"></a>Добавление дополнительного адаптера

Если вы хотите добавить дополнительный сетевой адаптер к серверу конфигурации, добавьте его до регистрации сервера в хранилище. Возможность добавления дополнительных адаптеров не поддерживается после регистрации.

1. В списке клиента vSphere щелкните виртуальную машину правой кнопкой мыши и выберите **Edit Settings** (Изменить параметры).
2. В разделе **Hardware** (Оборудование) выберите **Add** > **Ethernet Adapter** (Добавить > Адаптер Ethernet). Выберите **Далее**.
3. Выберите тип адаптера и сеть.
4. Чтобы подключить виртуальный сетевой адаптер на включенной виртуальной машине, выберите **Connect at power on** (Подключиться, когда включено). Выберите **Далее** > **Готово**. Нажмите кнопку **ОК**.


## <a name="register-the-configuration-server"></a>Регистрация сервера конфигурации

После настройки сервера конфигурации зарегистрируйте его в хранилище.

1. Из консоли клиента VMware vSphere включите виртуальную машину.
2. Виртуальная машина загружается в среду установки Windows Server 2016. Примите лицензионное соглашение и введите пароль администратора.
3. После установки войдите в виртуальную машину от имени администратора.
4. При первом входе в систему через несколько секунд будет запущено средство конфигурации Azure Site Recovery.
5. Введите имя, которое использовалось для регистрации сервера конфигурации в службе Site Recovery. Выберите **Далее**.
6. Средство проверяет, может ли виртуальная машина подключиться к Azure. После установки подключения выберите **Sign in** (Вход), чтобы войти в подписку Azure. Учетные данные должны иметь доступ к хранилищу, в котором вы хотите зарегистрировать сервер конфигурации. Убедитесь, что этому пользователю назначены необходимые [роли](vmware-azure-deploy-configuration-server.md#azure-active-directory-permission-requirements).
7. Средство выполняет некоторые задачи конфигурации, а затем перезагружается.
8. Снова войдите в систему. Через несколько секунд мастер управления сервером конфигурации запустится автоматически.


### <a name="configure-settings-and-add-the-vmware-server"></a>Настройка параметров и добавление сервера VMware

Завершите настройку и регистрацию сервера конфигурации. Прежде чем продолжить, убедитесь, что соблюдены все [предварительные требования](vmware-azure-deploy-configuration-server.md#prerequisites) для успешной настройки сервера конфигурации.


1. В мастере управления сервером конфигурации выберите **Setup connectivity** (Настройка подключения). Из раскрывающихся списков сначала выберите сетевую карту, которую встроенный сервер процессов использует для обнаружения и принудительной установки службы мобильности на исходных компьютерах, а затем выберите сетевую карту, которую сервер конфигурации использует для подключения к Azure. Затем нажмите кнопку **Save** (Сохранить). После настройки этот параметр уже нельзя изменить.
2. В разделе **Select Recovery Services vault** (Выбор хранилища служб восстановления) выберите подписку Azure и соответствующие группу и хранилище ресурсов.
3. В разделе **Install third-party software** (Установка стороннего программного обеспечения) примите лицензионное соглашение. Выберите **Download and Install** (Скачать и установить), чтобы установить сервер MySQL. Если папка установки MySQL указана в системном пути, этот шаг можно пропустить. [Подробнее](vmware-azure-deploy-configuration-server.md#configure-settings).
4. Прежде чем вы продолжите, будут проверены предварительные требования в разделе **Validate appliance configuration** (Проверка конфигурации модуля).
5. В разделе **Configure vCenter Server/vSphere ESXi server** (Настройка сервера vCenter Server или vSphere ESXi) введите полное доменное имя или IP-адрес сервера vCenter или узла vSphere, на которых расположены виртуальные машины для репликации. Введите порт, от которого ожидается передача данных на сервер. Введите понятное имя для сервера VMware в хранилище.
6. Введите учетные данные пользователя, которые будут использоваться сервером конфигурации для подключения к серверу VMware. Убедитесь, что имя пользователя и пароль указаны правильно и что пользователь входить в группу администраторов виртуальной машины, которую нужно защитить. Site Recovery использует эти учетные данные для автоматического обнаружения виртуальных машин VMware, доступных для репликации. Выберите **Add** (Добавить), а затем нажмите кнопку **Continue** (Продолжить).
7. В разделе **Configure virtual machine credentials** (Настройка учетных данных виртуальной машины) введите имя пользователя и пароль, которые будут использоваться для автоматической установки службы Mobility Service на виртуальных машинах с включенной репликацией.
    - Для компьютеров Windows учетной записи должны быть предоставлены права локального администратора на компьютерах, которые требуется реплицировать.
    - Для Linux предоставьте сведения для учетной записи root.
8. Выберите **Finalize configuration** (Завершение конфигурации) для завершения регистрации.
9. После завершения регистрации откройте портал Azure и убедитесь, что сервер конфигурации и сервер VMware указаны на странице **Хранилище служб восстановления** > **Управление** > **Инфраструктура Site Recovery** > **Серверы конфигурации**.


После регистрации сервера конфигурации Site Recovery подключается к серверам VMware, используя указанные параметры, и обнаруживает виртуальные машины.

> [!NOTE]
> Имя учетной записи появится на портале через 15 (или больше) минут. Чтобы выполнить обновление немедленно, выберите **Серверы конфигурации** > **_имя сервера_ *_ > _* Обновить сервер**.

## <a name="set-up-the-target-environment"></a>Настройка целевой среды

Выберите и проверьте целевые ресурсы.

1. Выберите **Подготовка инфраструктуры** > **Целевой объект**. Выберите подписку Azure, которую нужно использовать. Мы используем модель Resource Manager.
2. Site Recovery проверяет, есть ли у вас одна или несколько виртуальных сетей. Вы должны были их создать при настройке компонентов Azure, описанной в [первом руководстве](tutorial-prepare-azure.md) из этой серии.

   ![Снимок экрана с параметрами "Подготовка инфраструктуры" > "Целевой объект".](./media/vmware-azure-tutorial/storage-network.png)

## <a name="create-a-replication-policy"></a>Создание политики репликации

1. Откройте [портал Azure](https://portal.azure.com). Выполните поиск по строке **Хранилища служб восстановления** и выберите соответствующий элемент.
2. Выберите хранилище служб восстановления (в нашем примере это **ContosoVMVault**).
3. Чтобы создать политику репликации, выберите **Site Recovery infrastructure** (Инфраструктура Site Recovery) > **Политики репликации** >  **+Replication Policy** (+Политика репликации).
4. На странице **Создать политику репликации** введите имя политики. Мы используем имя **VMwareRepPolicy**.
5. На странице **Пороговое значение RPO** используйте значение по умолчанию (60 минут). Это значение определяет, как часто создаются точки восстановления. Если непрерывная репликация превышает это значение, выдаются оповещения.
6. В поле **Хранение точки восстановления** укажите, сколько времени нужно хранить каждую точку восстановления. В этом руководстве мы используем значение 72 часа. Реплицированные виртуальные машины можно восстановить до любой точки в рамках периода хранения.
7. В поле **Периодичность создания моментальных снимков с согласованием приложений** укажите, с какой периодичностью будут создаваться моментальные снимки, согласованные на уровне приложений. Мы используем значение 60 минут, устанавливаемое по умолчанию. Нажмите кнопку **OK**, чтобы создать политику.

   ![Снимок экрана с параметрами создания политики репликации.](./media/vmware-azure-tutorial/replication-policy.png)

- Политика автоматически сопоставляется с сервером конфигурации.
- Для восстановления размещения по умолчанию автоматически создается соответствующая политика. Например, если политика репликации называется **rep-policy**, то политика восстановления размещения будет называться **rep-policy-failback**. Эта политика не используется, пока не будет запущено восстановление размещения из Azure.

Примечание. В сценарии переноса из VMware в Azure отказоустойчивый моментальный снимок создается каждые 5 минут.

## <a name="enable-replication"></a>Включение репликации

Включите репликацию для виртуальных машин, сделав следующее.

1. Выберите **Репликация приложения** > **Источник**.
2. В поле **Источник** выберите **Локальный** и выберите сервер конфигурации в списке **Исходное расположение**.
3. В поле **Тип компьютера** выберите параметр **Виртуальные машины**.
4. В поле **Гипервизор vCenter или vSphere** выберите сервер vCenter, который управляет узлом vSphere, или сам этот узел.
5. Выберите сервер обработки (по умолчанию устанавливается на виртуальной машине сервера конфигурации). Нажмите кнопку **ОК**. Состояние работоспособности каждого сервера обработки указывается с учетом рекомендуемых ограничений и других параметров. Выберите работоспособный сервер обработки. Объект сервер обработки [критически важных операций](vmware-physical-azure-monitor-process-server.md#process-server-alerts) выбрать нельзя. Вы можете [устранить неполадки и ошибки](vmware-physical-azure-troubleshoot-process-server.md)**или**[настроить сервер обработки масштабирования](vmware-azure-set-up-process-server-scale.md).
6. В разделе **Целевой объект** выберите подписку и группу ресурсов, в которых нужно создавать виртуальные машины при отработке отказа. Мы используем модель развертывания Resource Manager.
7. Выберите сеть и подсеть Azure для подключения виртуальных машин Azure, созданных после отработки отказа.
8. Выберите **Настроить сейчас для всех выбранных компьютеров**, чтобы применить настройки сети ко всем защищаемым виртуальным машинам. Выберите **Отложить настройку**, чтобы выбрать сеть Azure для каждого компьютера.
9. В разделе **Виртуальные машины** > **Выбор виртуальных машин**, выберите каждую машину, которую нужно реплицировать. Можно выбрать только те компьютеры, для которых можно включить репликацию. Нажмите кнопку **ОК**. Если определенная виртуальная машина не отображается или ее нельзя выбрать, подробнее о решении этой проблемы можно узнать [здесь](./vmware-azure-troubleshoot-replication.md).
10. В разделе **Свойства** > **Configure properties** (Настройка свойств) выберите учетную запись, которая будет использоваться сервером обработки для автоматической установки службы Mobility Service на компьютере.
11. Выберите **Параметры репликации** > **Configure replication settings** (Настройка параметров репликации) и убедитесь, что выбрана правильная политика репликации.
12. Выберите **Включить репликацию**. Site Recovery установит службу Mobility Service, если репликация включена для виртуальной машины.
13. Ход выполнения задания **включения защиты** можно отслеживать, выбрав **Параметры** > **Задания** > **Задания Site Recovery**. После выполнения задания **Завершить подготовку защиты** и создания точки восстановления виртуальная машина будет готова к отработке отказа.
14. Может пройти более 15 минут, прежде чем изменения вступят в силу и появятся на портале.
15. Для мониторинга добавляемых виртуальных машин укажите последнее время обнаружения, выбрав **Серверы конфигурации** > **Последний контакт в**. Чтобы добавить виртуальные машины, не дожидаясь запланированного обнаружения, выделите сервер конфигурации (не выбирая его) и нажмите кнопку **Обновить**.

## <a name="next-steps"></a>Дальнейшие действия
После включения репликации запустите тестирование, чтобы убедиться, что все работает как положено.
> [!div class="nextstepaction"]
> [Выполнение отработки аварийного восстановления](avs-tutorial-dr-drill-azure.md)
