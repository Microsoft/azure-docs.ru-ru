---
title: Перенос виртуальных машин Azure между общедоступными регионами и регионами Azure для государственных организаций с помощью Azure Site Recovery
description: Переносите виртуальные машины между регионами для государственных организаций и общедоступными регионами Azure с помощью Azure Site Recovery.
author: sideeksh
ms.service: site-recovery
ms.topic: tutorial
ms.date: 04/16/2019
ms.author: sideeksh
ms.custom: MVC
ms.openlocfilehash: a76ebf95b92b6e1251a04daa9ffb48a9abe15b50
ms.sourcegitcommit: f28ebb95ae9aaaff3f87d8388a09b41e0b3445b5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/29/2021
ms.locfileid: "89425353"
---
# <a name="move-azure-vms-between-azure-government-and-public-regions"></a>Перенос виртуальных машин Azure между общедоступными регионами и регионами Azure для государственных организаций 

Может потребоваться переместить виртуальные машины IaaS между регионами Azure для государственных организаций и общедоступными регионами Azure, чтобы увеличить доступность существующих виртуальных машин, улучшить управляемость или соблюсти требования к системе управления, как описано [здесь](azure-to-azure-move-overview.md).

Службу [Azure Site Recovery](site-recovery-overview.md) можно использовать не только для управления и координации аварийного восстановления локальных компьютеров и виртуальных машин Azure в целях обеспечения непрерывности бизнеса и аварийного восстановления (BCDR), но и для управления миграцией виртуальных машин Azure в дополнительный регион.       

В этом руководстве показано, как перемещать виртуальные машины Azure между регионами Azure для государственных организаций и общедоступными регионами с помощью Azure Site Recovery. Приведенные указания можно также применять для перемещения виртуальных машин между парами регионов, которые находятся в разных географических кластерах. В этом руководстве описано следующее.

> [!div class="checklist"]
> * проверка предварительных требований;
> * Подготовка исходных виртуальных машин.
> * Подготовка целевого региона
> * Копирование данных в целевой регион
> * Тестирование конфигурации
> * Выполнение перемещения.
> * Отмена ресурсов в исходном регионе.

> [!IMPORTANT]
> В этом руководстве показано, как перемещать виртуальные машины Azure между регионами Azure для государственных организаций и общедоступными регионами или между парами регионов, которые не поддерживаются обычным решением для аварийного восстановления для виртуальных машин Azure. В случае, если ваши исходный и целевой регионы [поддерживаются](./azure-to-azure-support-matrix.md#region-support), обратитесь к соответствующей [документации](azure-to-azure-tutorial-migrate.md) по перемещению. Если вам необходимо повысить уровень доступности, переместив виртуальные машины в группе доступности в виртуальные машины, прикрепленные к зонам, в другом регионе, ознакомьтесь с этим [руководством](move-azure-VMs-AVset-Azone.md).

> [!IMPORTANT]
> Не рекомендуется использовать этот метод для настройки аварийного восстановления между парами неподдерживаемых регионов, так как пары определяются с учетом задержки при передаче данных, что очень важно для сценария аварийного восстановления.

## <a name="verify-prerequisites"></a>проверка предварительных требований;

> [!NOTE]
> Рассмотрите [архитектуру и компоненты этого сценария](physical-azure-architecture.md). Эта архитектура будет использоваться для перемещения виртуальных машин Azure. В ней **виртуальные машины рассматриваются как физические серверы**.

- [Ознакомьтесь](vmware-physical-secondary-support-matrix.md) с требованиями поддержки для всех компонентов.
- Убедитесь, что серверы, которые необходимо реплицировать, соответствуют требованиям [виртуальных машин Azure](vmware-physical-secondary-support-matrix.md#replicated-vm-support).
- Подготовьте учетную запись для автоматической установки службы Mobility Service на каждом сервере, который требуется реплицировать.

- Обратите внимание на то, что после выполнения отработки отказа в целевом регионе Azure невозможно выполнить восстановление размещения непосредственно в исходном регионе. Необходимо будет повторно настроить репликацию в целевой регион.

### <a name="verify-azure-account-permissions"></a>Проверка разрешений учетной записи Azure

Убедитесь, что учетная запись Azure имеет разрешения для репликации виртуальных машин в Azure.

- Проверьте [разрешения](site-recovery-role-based-linked-access-control.md#permissions-required-to-enable-replication-for-new-virtual-machines), которые необходимы для репликации компьютеров в Azure.
- Проверьте и измените разрешения [управления доступом Azure на основе ролей (Azure RBAC)](../role-based-access-control/role-assignments-portal.md). 

### <a name="set-up-an-azure-network"></a>Настроить сеть

Настройте целевую [сеть Azure](../virtual-network/quick-create-portal.md).

- Виртуальные машины Azure будут размещаться в этой сети при создании после отработки отказа.
- Сеть должна располагаться в том же регионе, что и хранилище служб восстановления.


### <a name="set-up-an-azure-storage-account"></a>Настроить учетную запись хранения Azure

Настройте [учетную запись хранения Azure](../storage/common/storage-account-create.md).

- Служба Site Recovery реплицирует локальные машины в службе хранилища Azure. Виртуальные машины Azure создаются из хранилища после отработки отказа.
- Учетная запись хранения должна быть создана в том же регионе, что и хранилище служб восстановления.


## <a name="prepare-the-source-vms"></a>Подготовка исходных виртуальных машин.

### <a name="prepare-an-account-for-mobility-service-installation"></a>Подготовка учетной записи к установке службы Mobility Service

Служба Mobility Service должна быть установлена на каждом сервере, который нужно реплицировать. Site Recovery устанавливает эту службу автоматически при включении репликации для сервера. Для автоматической установки необходимо подготовить учетную запись, которую Site Recovery будет использовать для доступа к серверу.

- Можно использовать доменную или локальную учетную запись.
- Для виртуальных машин Windows, если учетная запись домена не используется, отключите контроль удаленного доступа пользователей на локальном компьютере. Для этого в разделе реестра **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System** добавьте запись **LocalAccountTokenFilterPolicy** DWORD и задайте для нее значение 1.
- Чтобы добавить запись реестра для отключения параметра из CLI, введите следующую команду: ``REG ADD HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1.``
- Для Linux учетная запись должна принадлежать привилегированному пользователю на исходном сервере Linux.


## <a name="prepare-the-target-region"></a>Подготовка целевого региона

1. Убедитесь, что подписка Azure позволяет создавать виртуальные машины в целевом регионе, используемом для аварийного восстановления. Свяжитесь со службой поддержки, чтобы включить необходимые квоты.

2. Убедитесь, что подписка располагает достаточными ресурсами для поддержки виртуальных машин таких же размеров, которые установлены для исходных виртуальных машин. Если для копирования данных в целевой объект вы используете Site Recovery, эта служба выберет для целевой виртуальной машины такой же или другой наиболее подходящий размер.

3. Убедитесь, что вы создали целевой ресурс для каждого компонента, указанного в исходном сетевом макете. Это важно для того, чтобы после перемещения в целевой регион ваши виртуальные машины сохранили все функции и возможности исходных виртуальных машин.

    > [!NOTE]
    > Azure Site Recovery автоматически обнаруживает и создает виртуальную сеть, когда вы включаете репликацию для исходной виртуальной машины. Вы также можете предварительно создать сеть и назначить ее виртуальной машине в потоке пользователя для включения репликации. Любые другие ресурсы, как это описано далее, необходимо создавать вручную в целевом регионе.

     Чтобы создать нужные вам наиболее часто используемые сетевые ресурсы, в зависимости от конфигурации исходной виртуальной машины, перейдите по следующим ссылкам.

    - [Группы безопасности сети](../virtual-network/manage-network-security-group.md)
    - [Подсистемы балансировки нагрузки](../load-balancer/index.yml)
    - [Общедоступный IP-адрес](../virtual-network/virtual-network-public-ip-address.md)
    
    Сведения о других сетевых компонентах см. в [документации](../index.yml?pivot=products&panel=network) по сетям.

4. Вручную [создайте непроизводственную сеть](../virtual-network/quick-create-portal.md) в целевом регионе, если вы хотите проверить конфигурацию перед выполнением окончательного перехода в целевой регион. При этом помехи в рабочей среде будут минимальными (рекомендуется выполнить этот шаг).

## <a name="copy-data-to-the-target-region"></a>Копирование данных в целевой регион
Ниже приведены шаги по копированию данных в целевой регион с помощью Azure Site Recovery.

### <a name="create-the-vault-in-any-region-except-the-source-region"></a>Создайте хранилище в любом регионе, за исключением исходного.

1. Войдите на [портал Azure](https://portal.azure.com) > **Службы восстановления**.
2. Щелкните **Создать ресурс** > **Средства управления** > **Backup and Site Recovery**.
3. В поле **Имя** укажите понятное имя **ContosoVMVault**. Выберите соответствующую подписку, если их у вас несколько.
4. Создайте группу ресурсов **ContosoRG**.
5. Укажите регион Azure. Сведения о поддерживаемых регионах см. в разделе "Географическая доступность" на странице [цен на службу Azure Site Recovery](https://azure.microsoft.com/pricing/details/site-recovery/).
6. В хранилище Служб восстановления щелкните **Обзор** > **ConsotoVMVault** >  **+Реплицировать**.
7. Выберите **В Azure** > **Без виртуализации или иное**.

### <a name="set-up-the-configuration-server-to-discover-vms"></a>Настройте сервер конфигурации для обнаружения виртуальных машин.


Настройте сервер конфигурации, зарегистрируйте его в хранилище и найдите виртуальные машины.

1. Щелкните **Site Recovery** > **Подготовка инфраструктуры** > **Источник**.
2. Если у вас нет сервера конфигурации, щелкните **+Configuration server** (+ Сервер конфигурации).
3. В колонке **Добавление сервера** в поле **Тип сервера** должно быть указано **Сервер конфигурации**.
4. Скачайте файл единой установки Site Recovery.
5. Скачайте ключ регистрации хранилища. Он потребуется при запуске единой установки. Ключ действителен в течение пяти дней после создания.

   ![Настройка источника](./media/physical-azure-disaster-recovery/source-environment.png)


### <a name="register-the-configuration-server-in-the-vault"></a>Регистрация сервера конфигурации в хранилище

Прежде чем начать, обратите внимание на следующее: 

#### <a name="verify-time-accuracy"></a>Проверка точности времени
Убедитесь, что на компьютере сервера конфигурации системные часы синхронизированы с [сервером времени](/windows-server/networking/windows-time-service/windows-time-service-top). Значения времени должны совпадать. Если системные часы отстают или спешат в пределах 15 минут, установка может завершиться ошибкой.

#### <a name="verify-connectivity"></a>Проверка подключения
Убедитесь, что компьютер может получить доступ к этим URL-адресам на основе среды: 

[!INCLUDE [site-recovery-URLS](../../includes/site-recovery-URLS.md)]  

Правила брандмауэра на основе IP-адресов должны разрешать взаимодействие со всеми URL-адресами Azure, перечисленными выше, через порт HTTPS (443). Чтобы упростить и ограничить диапазоны IP-адресов, рекомендуется выполнить фильтрацию URL-адресов.

- **Коммерческие IP-адреса**. Кроме того, необходимо разрешить [диапазоны IP-адресов центра обработки данных Azure](https://www.microsoft.com/download/confirmation.aspx?id=41653) и порт HTTPS (443). Разрешите диапазоны IP-адресов для региона Azure вашей подписки для поддержки URL-адресов AAD, резервного копирования, репликации и хранения.  
- **Правительственные IP-адреса**. Разрешите [диапазоны IP-адресов центра обработки данных Azure для государственных организаций](https://www.microsoft.com/en-us/download/details.aspx?id=57063) и порт HTTPS (443) для всех регионов USGov (Вирджиния, Техас, Аризона и Айова) для поддержки URL-адресов AAD, резервного копирования, репликации и хранения.  

#### <a name="run-setup"></a>Запуск программы установки
Запустите программу установки сервера конфигурации от имени локального администратора. Сервер обработки и главный целевой сервер также устанавливаются по умолчанию на сервер конфигурации.

[!INCLUDE [site-recovery-add-configuration-server](../../includes/site-recovery-add-configuration-server.md)]

После завершения регистрации сервер конфигурации появится на странице **Параметры** > **Серверы** в хранилище.

### <a name="configure-target-settings-for-replication"></a>Настройка параметров цели для репликации

Выберите и проверьте целевые ресурсы.

1. Щелкните **Подготовка инфраструктуры** > **Цель** и выберите требуемую подписку Azure.
2. Укажите целевую модель развертывания.
3. Site Recovery проверяет наличие одной или нескольких совместимых учетных записей хранения и сетей Azure.

   ![Назначение](./media/physical-azure-disaster-recovery/network-storage.png)


### <a name="create-a-replication-policy"></a>Создание политики репликации

1. Чтобы создать новую политику репликации, щелкните **Инфраструктура Site Recovery** > **Политики репликации** >  **+Политика репликации**.
2. На странице **Создать политику репликации** укажите имя политики.
3. В разделе **Пороговое значение RPO** укажите ограничение целевой точки восстановления (RPO). Это значение указывает, как часто создаются точки восстановления данных. Если непрерывная репликация превышает это значение, выдаются оповещения.
4. В поле **Хранение точки восстановления** укажите продолжительность периода хранения для каждой точки восстановления (в часах). Реплицированные виртуальные машины можно восстановить до любой точки в рамках этого периода. Для компьютеров, реплицируемых в хранилище класса Premium, поддерживается период удержания до 24 часов, а для хранилище класса Standard — до 72 часов.
5. В поле **Периодичность создания моментальных снимков с согласованием приложений** укажите, с какой периодичностью (в минутах) будут создаваться точки восстановления, содержащие моментальные снимки, согласованные на уровне приложений. Нажмите кнопку **ОК** , чтобы создать политику.

    ![Политика репликации](./media/physical-azure-disaster-recovery/replication-policy.png)


Политика автоматически сопоставляется с сервером конфигурации. Для восстановления размещения по умолчанию автоматически создается соответствующая политика. Например, если политика репликации называется **rep-policy**, то будет создана политика восстановления размещения **rep-policy-failback**. Эта политика не используется, пока не будет запущено восстановление размещения из Azure.

### <a name="enable-replication"></a>Включение репликации

- Site Recovery установит службу Mobility Service, если репликация включена.
- При включении репликации для сервера может пройти более 15 минут, прежде чем изменения вступят в силу и появятся на портале.

1. Выберите **Репликация приложения** > **Источник**.
2. В колонке **Источник** выберите нужный сервер конфигурации.
3. В поле **Тип компьютера** выберите параметр **Физические компьютеры**.
4. Выберите сервер обработки (сервер конфигурации). Нажмите кнопку **ОК**.
5. В поле **Цель** выберите подписку и группу ресурсов, в которых вы хотите создавать виртуальные машины Azure после отработки отказа. Выберите модель развертывания, которая будет использоваться в Azure (классическая или Resource Manager).
6. Выберите учетную запись хранения Azure, которую вы хотите использовать для репликации данных. 
7. Выберите сеть и подсеть Azure, к которой будут подключаться виртуальные машины Azure, созданные после отработки отказа.
8. Выберите **Настроить сейчас для всех выбранных компьютеров**, чтобы применить параметр сети ко всем защищаемым машинам. Выберите **Отложить настройку**, чтобы выбрать сеть Azure для каждого компьютера. 
9. В разделе **Физические компьютеры** щелкните **+Physical machine** (+Физический компьютер). Укажите имя и IP-адрес. Выберите операционную систему компьютера, который нужно реплицировать. Обнаружение серверов и включение их в список занимает несколько минут. 

   > [!WARNING]
   > Необходимо ввести IP-адрес виртуальной машины Azure, которую вы намерены перенести.

10. В поле **Свойства** > **Настройка свойств** выберите учетную запись, которая будет использоваться сервером обработки для автоматической установки службы Mobility Service на компьютер.
11. Выберите **Параметры репликации** > **Configure replication settings** (Настройка параметров репликации) и убедитесь, что выбрана правильная политика репликации. 
12. Щелкните **Включить репликацию**. Ход выполнения задания **включения защиты** можно отслеживать, выбрав **Параметры** > **Задания** > **Задания Site Recovery**. После выполнения задания **Завершить подготовку защиты** виртуальная машина будет готова к отработке отказа.


Для мониторинга добавляемых серверов можно проверить последнее время обнаружения, выбрав **Серверы конфигурации** > **Последний контакт в**. Чтобы добавить компьютеры, не дожидаясь запланированного времени обнаружения, выделите сервер конфигурации (не щелкая его) и щелкните **Обновить**.

## <a name="test-the-configuration"></a>Тестирование конфигурации


1. Перейдите в хранилище, в разделе **Параметры** > **Реплицированные элементы** выберите виртуальную машину, которую вы планируете переместить в целевой регион, и щелкните значок **+Тестовая отработка отказа**.
2. На странице **Тестовая отработка отказа** выберите точку восстановления:

   - **Последняя обработанная**. Отработка отказа выполняется до последней точки восстановления виртуальной машины, которая была обработана службой Site Recovery. Для нее отображается метка времени. Этот вариант не требует времени на обработку данных, обеспечивая низкий показатель целевого времени восстановления.
   - **Последняя точка во времени согласованности приложений**. Отработка отказа всех виртуальных машин выполняется до последней точки восстановления с согласованным состоянием приложений. Для нее отображается метка времени.
   - **Пользовательская**. Вы можете выбрать любую точку восстановления.

3. Чтобы проверить конфигурацию, выберите целевую виртуальную сеть Azure, в которую вы хотите переместить виртуальные машины Azure. 

   > [!IMPORTANT]
   > Для отработки отказа мы рекомендуем использовать отдельную сеть виртуальных машин Azure, а не рабочую сеть, в которую вы планируете в итоге перенести виртуальные машины и которая была настроена при включении репликации.

4. Чтобы начать тестирование, щелкните **ОК**. За ходом выполнения можно следить в окне свойств, которое можно открыть, щелкнув виртуальную машину. Также можно щелкнуть задание **Тестовая отработка отказа** в разделе "Имя хранилища" > **Параметры** > **Задания** > **Задания Site Recovery**.
5. Когда отработка отказа завершится, на вкладке **Виртуальные машины** портала Azure появится реплика виртуальной машины. Убедитесь, что виртуальная машина работает, имеет соответствующий размер и подключена к соответствующей сети.
6. Если вы хотите удалить виртуальную машину, созданную в ходе тестирования переноса, щелкните **Очистить тестовую отработку отказа** для реплицированного элемента. При необходимости в разделе **Примечания** можно записать и сохранить сведения о тестировании.

## <a name="perform-the-move-to-the-target-region-and-confirm"></a>Выполните и подтвердите перенос в целевой регион.

1. Перейдите в хранилище, в разделе **Параметры** > **Реплицированные элементы** выберите виртуальную машину и щелкните **Отработка отказа**.
2. В области **Отработка отказа** выберите **Последнее**. 
3. Выберите **Завершение работы виртуальной машины перед началом отработки отказа**. Site Recovery попытается выключить исходную виртуальную машину перед запуском отработки отказа. Отработка отказа продолжится, даже если их не удастся отключить. На странице **Задания** можно следить за ходом выполнения отработки отказа. 
4. Когда задание будет завершено, проверьте, отображается ли виртуальная машина в целевом регионе Azure, как и ожидалось.
5. В разделе **Реплицированные элементы** нажмите правой кнопкой мыши пункт "Виртуальная машина" и выберите **Зафиксировать**. Перенос в целевой регион будет завершен. Дождитесь завершения фиксации задания.

## <a name="discard-the-resource-in-the-source-region"></a>Отмена ресурса в исходном регионе 

- Перейдите к виртуальной машине.  Щелкните **Отключить репликацию**.  Это остановит процесс копирования данных для виртуальной машины.  

   > [!IMPORTANT]
   > Очень важно выполнить этот шаг, чтобы не платить за репликацию Azure Site Recovery.

Если вы не планируете повторно использовать исходные ресурсы, выполните следующие шаги:

1. Удалите все соответствующие сетевые ресурсы в исходном регионе, перечисленные на шаге 4 в разделе [Подготовка исходных виртуальных машин](#prepare-the-source-vms). 
2. Удалите соответствующую учетную запись хранения в исходном регионе.



## <a name="next-steps"></a>Дальнейшие действия

В этом руководстве вы перенесли виртуальную машину Azure в другой регион Azure. Теперь можно настроить аварийное восстановление для перенесенной виртуальной машины.

> [!div class="nextstepaction"]
> [Настройка аварийного восстановления после миграции](azure-to-azure-quickstart.md)
