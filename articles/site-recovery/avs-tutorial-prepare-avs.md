---
title: Подготовка Решения Azure VMware для аварийного восстановления в Azure Site Recovery
description: Узнайте, как подготовить серверы Решения Azure VMware для аварийного восстановления в Azure с помощью службы Azure Site Recovery.
author: Harsha-CS
manager: rochakm
ms.service: site-recovery
ms.topic: tutorial
ms.date: 09/29/2020
ms.author: harshacs
ms.custom: MVC
ms.openlocfilehash: 8e77ede7b04c95bfd6b6b8f660c8d811e7434c0f
ms.sourcegitcommit: f28ebb95ae9aaaff3f87d8388a09b41e0b3445b5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/29/2021
ms.locfileid: "93395450"
---
# <a name="prepare-azure-vmware-solution-for-disaster-recovery-to-azure-site-recovery"></a>Подготовка Решения Azure VMware для аварийного восстановления в Azure Site Recovery

В этой статье описано, как подготовить серверы Решения Azure VMware для аварийного восстановления в Azure с помощью служб [Azure Site Recovery](site-recovery-overview.md). 

Это второе руководство в серии, в котором показано, как настроить аварийное восстановление виртуальных машин Решения Azure VMware в Azure. В первом руководстве рассматривалась [настройка компонентов Azure](avs-tutorial-prepare-azure.md), необходимых для аварийного восстановления Решения Azure VMware.


Вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * Подготовить учетную запись сервера vCenter или узла vSphere ESXi, чтобы автоматизировать виртуальную машину.
> * Подготовка учетной записи для автоматической установки службы Mobility Service на виртуальные машины VMware.
> * Проверка сервера VMware, требований виртуальной машины и поддержки.
> * Подготовка к подключению виртуальных машин Azure после отработки отказа.

> [!NOTE]
> В учебниках описан самый простой способ развертывания для определенного сценария. В них везде, где возможно, используются значения по умолчанию, и описаны не все возможные параметры и пути. Подробные инструкции см. в разделе с инструкциями в материалах по Site Recovery.

## <a name="before-you-start"></a>Перед началом работы

Убедитесь, что среда Azure подготовлена, как описано в [первом учебнике этой серии](avs-tutorial-prepare-azure.md).

## <a name="prepare-an-account-for-automatic-discovery"></a>Подготовка учетной записи для автоматического обнаружения

Site Recovery требуется доступ к серверам Решения Azure VMware, чтобы:

- Автоматически обнаруживать виртуальные машины. Требуется по крайней мере учетная запись только для чтения.
- Управлять репликацией, отработкой отказа и восстановлением размещения. Необходима учетная запись, которая позволяет выполнять операции, такие как создание и удаление дисков и включение виртуальных машин.

Создайте учетную запись следующим образом:

1. Чтобы использовать выделенную учетную запись, создайте роль на уровне vCenter. Присвойте роли имя, например **Azure_Site_Recovery**.
2. Назначьте роли разрешения, представленные в следующей таблице.
3. Создайте пользователя на сервере vCenter или узле vSphere. Назначьте роль для пользователя.

### <a name="vmware-account-permissions"></a>Разрешения учетной записи VMware

**Задача** | **Роль/Разрешения** | **Сведения**
--- | --- | ---
**Обнаружение виртуальных машин** | Пользователь только для чтения (минимум).<br/><br/> Объект центра обработки данных –> Распространение на дочерний объект, роль Read-only | Пользователь назначается на уровне центра обработки данных и поэтому имеет доступ ко всем объектам в центре обработки данных.<br/><br/> Если нужно ограничить доступ, назначьте дочерним объектам (узлы vSphere, хранилища данных, виртуальные машины и сети) роль **Без доступа** с параметром **Propagate to child** (Распространить на дочерний объект).
**Полная репликация, отработка отказа, восстановление размещения** |  Создайте роль VMware (Azure_Site_Recovery) с необходимыми разрешениями и назначьте эту роль пользователю или группе VMware.<br/><br/> Объект центра обработки данных –> распространение на дочерний объект, роль Azure_Site_Recovery<br/><br/> Хранилище данных -> выделение места, обзор хранилища данных, низкоуровневые операции с файлами, удаление файлов, обновление файлов виртуальной машины<br/><br/> Сеть -> Назначение сети<br/><br/> Ресурс -> назначение виртуальной машины в пул ресурсов, миграция отключенной виртуальной машины, миграция включенной виртуальной машины<br/><br/> Задачи -> Создание задач, Обновление задач<br/><br/> Виртуальная машина -> конфигурация<br/><br/> Виртуальная машина -> взаимодействие -> ответ на вопрос, подключение устройства, настройка компакт-диска носителя, настройка дискеты носителя, отключение, включение, установка средств VMware<br/><br/> Виртуальная машина -> инвентаризация -> создание, регистрация, отмена регистрации<br/><br/> Виртуальная машина -> подготовка -> разрешение загрузки виртуальной машины, разрешение отправки файлов виртуальной машины<br/><br/> виртуальная машина -> моментальные снимки -> удаление моментальных снимков. | Пользователь назначается на уровне центра обработки данных и поэтому имеет доступ ко всем объектам в центре обработки данных.<br/><br/> Если нужно ограничить доступ, назначьте дочерним объектам (узлы vSphere, хранилища данных, виртуальные машины и сети) роль **Без доступа** с параметром **Propagate to child** (Распространить на дочерний объект).

## <a name="prepare-an-account-for-mobility-service-installation"></a>Подготовка учетной записи к установке службы Mobility Service

На компьютерах, которые нужно реплицировать, должна быть установлена служба Mobility Service. Site Recovery может выполнить принудительную установку этой службы, если будет включена репликация для этого компьютера, или ее можно установить вручную или с помощью инструментов установки.

- В этом руководстве рассматривается принудительная установка службы Mobility Service.
- Для принудительной установки необходимо подготовить учетную запись, которую Site Recovery сможет использовать для доступа к виртуальной машине. Укажите эту учетную запись при настройке аварийного восстановления в консоли Azure.

Подготовьте учетную запись описанным ниже способом.

Подготовьте домен или локальную учетную запись с этими разрешениями для установки на виртуальной машине.

- **Виртуальные машины Windows**. Если при установке Windows на виртуальные машины не используется учетная запись домена, отключите контроль удаленного доступа пользователей на локальном компьютере. Для этого в разделе реестра > **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System** добавьте запись DWORD **LocalAccountTokenFilterPolicy** и задайте для нее значение 1.
- **Виртуальные машины Linux**. Для установки Linux на виртуальные машины необходимо подготовить учетную запись суперпользователя на исходном сервере Linux.


## <a name="check-vmware-requirements"></a>Проверка соответствия требованиям к VMware

Убедитесь, что серверы и виртуальные машины VMware соответствуют требованиям.

1. Проверьте [версии программного обеспечения](../azure-vmware/concepts-private-clouds-clusters.md#vmware-software-versions) Решения Azure VMware.
2. Проверьте [соответствие требованиям сервера VMware](vmware-physical-azure-support-matrix.md#on-premises-virtualization-servers).
3. Если вы используете виртуальные машины Linux, [проверьте](vmware-physical-azure-support-matrix.md#linux-file-systemsguest-storage) соответствие требованиям к файловой системе и хранилищу. 
4. Проверьте поддержку [сетей](vmware-physical-azure-support-matrix.md#network) и [хранилищ](vmware-physical-azure-support-matrix.md#storage). 
5. Проверьте поддерживаемые возможности для [сети Azure](vmware-physical-azure-support-matrix.md#azure-vm-network-after-failover), [хранилища](vmware-physical-azure-support-matrix.md#azure-storage) и [вычислительных ресурсов](vmware-physical-azure-support-matrix.md#azure-compute) после отработки отказа.
6. Виртуальные машины Решения Azure VMware, которые реплицируются в Azure, должны соответствовать [требованиям к виртуальным машинам Azure](vmware-physical-azure-support-matrix.md#azure-vm-requirements).
7. На виртуальная машинах Linux имя устройства или точки подключения должно быть уникальным. Имена устройств или точек подключения не должны совпадать. Обратите внимание, что в написании имен регистр не учитывается. Например, двум устройствам на одной виртуальной машине нельзя задать имена _device1_ и _Device1_.


## <a name="prepare-to-connect-to-azure-vms-after-failover"></a>Подготовка к подключению виртуальных машин Azure после отработки отказа

После отработки отказа может потребоваться подключение к виртуальным машинам Azure из сети Решения Azure VMware.

Чтобы подключиться к виртуальным машинам Windows с помощью RDP после отработки отказа, сделайте следующее:

- **Доступ к Интернету**. Перед отработкой отказа включите RDP на виртуальных машинах Решения Azure VMware. Убедитесь в том, что правила для протоколов TCP и UDP для **общедоступного** профиля добавлены, а протокол RDP разрешен в разделе **Брандмауэр Windows** > **Разрешенные программы** для всех профилей.
- **VPN-подключение типа "сеть — сеть"**:
    - Перед отработкой отказа включите RDP на виртуальных машинах Решения Azure VMware.
    - Протокол удаленного рабочего стола должен быть разрешен в разделе **Брандмауэр Windows** -> **Allowed apps and features** (Разрешенные приложения и компоненты) для сетей **домена и частных сетей**.
    - Убедитесь, что для политики сети SAN операционной системы задано значение **OnlineAll**. [Подробнее](https://support.microsoft.com/kb/3031135).
- Убедитесь, что на виртуальной машине нет ожидающих установки обновлений Windows, прежде чем активировать отработку отказа. Если они есть, вы не сможете войти в виртуальную машину до завершения обновления.
- После отработки отказа на виртуальной машине Windows Azure проверьте **диагностику загрузки**, чтобы просмотреть снимок экрана виртуальной машины. Если вы не можете подключиться к виртуальной машине, убедитесь, что она запущена, и ознакомьтесь с [рекомендациями по устранению неполадок](https://social.technet.microsoft.com/wiki/contents/articles/31666.troubleshooting-remote-desktop-connection-after-failover-using-asr.aspx).

Чтобы подключиться к виртуальной машине Linux с помощью SSH после отработки отказа, сделайте следующее:

- В Решении Azure VMware перед отработкой отказа убедитесь, что для службы Secure Shell настроен автоматический запуск при загрузке системы.
- Убедитесь, что правила брандмауэра разрешают SSH-подключение.
- Правила группы безопасности сети на виртуальной машине Azure, для которой выполнена отработка отказа, и подсети Azure, к которой она подключена, должны разрешать входящие подключения к порту SSH.
- [Добавьте общедоступный IP-адрес](./site-recovery-monitor-and-troubleshoot.md) для виртуальной машины.
- Чтобы просмотреть снимок виртуальной машины, можно проверить **диагностику загрузки**.


## <a name="failback-requirements"></a>Требования к восстановлению размещения
Если вы планируете выполнить восстановление размещения в облако Решения Azure VMware, существует ряд [предварительных требований](avs-tutorial-reprotect.md#before-you-begin). Подготовку можно выполнить сейчас, но это необязательно. Ее можно выполнить после отработки отказа в Azure.




## <a name="next-steps"></a>Дальнейшие действия
> [!div class="nextstepaction"]
> [Настройка аварийного восстановления](avs-tutorial-replication.md)
- Если вы реплицируете несколько виртуальных машин, [спланируйте ресурсы](site-recovery-deployment-planner.md).
