---
title: Создание леса ресурсов доменных служб Azure AD с помощью Azure PowerShell | Документация Майкрософт
description: Из этой статьи вы узнаете, как создать и настроить лес ресурсов доменных служб Azure Active Directory и исходящий лес в локальной среде служб домен Active Directory, используя Azure PowerShell.
author: justinha
manager: daveba
ms.service: active-directory
ms.subservice: domain-services
ms.workload: identity
ms.topic: conceptual
ms.date: 07/27/2020
ms.author: justinha
ms.openlocfilehash: ebfc2476b7955b926f86094de03973155386eb8f
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "96619973"
---
# <a name="create-an-azure-active-directory-domain-services-resource-forest-and-outbound-forest-trust-to-an-on-premises-domain-using-azure-powershell"></a>Создание Azure Active Directory леса ресурсов доменных служб и исходящего доверия лесов в локальном домене с помощью Azure PowerShell

В средах, где нельзя синхронизировать хэши паролей или где пользователи используют только смарт-карты для входа в систему, так как они не знают своего пароля, вы можете использовать лес ресурсов в доменных службах Azure Active Directory (Azure AD DS). Лес ресурсов использует одностороннее исходящее отношение доверия между Azure AD DS и одной или несколькими локальными средами AD DS. Это отношение доверия позволяет пользователям, приложениям и компьютерам проходить проверку подлинности в локальном домене из управляемого домена Azure AD DS. В лесе ресурсов локальные хэши паролей не синхронизируются.

![Схема доверия леса между Azure AD DS и локальными AD DS](./media/concepts-resource-forest/resource-forest-trust-relationship.png)

Вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * Создание леса ресурсов Azure AD DS с помощью Azure PowerShell
> * Создание одностороннего исходящего доверия леса в управляемом домене с помощью Azure PowerShell
> * Настройка DNS в локальной среде AD DS для поддержки управляемого подключения к домену
> * создание одностороннего входящего доверия леса в локальной среде AD DS;
> * тестирование и проверка отношения доверия для проверки подлинности и доступа к ресурсам.

Если у вас еще нет подписки Azure, [создайте учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

> [!IMPORTANT]
> В настоящее время леса управляемых ресурсов домена не поддерживают файлы Azure HDInsight или Azure. Управляемые по умолчанию леса пользователей домена поддерживают обе эти дополнительные службы.

## <a name="prerequisites"></a>Предварительные условия

Для работы с этой статьей требуются следующие ресурсы и разрешения:

* Активная подписка Azure.
    * Если у вас еще нет подписки Azure, [создайте учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F).
* Связанный с вашей подпиской клиент Azure Active Directory, синхронизированный с локальным или облачным каталогом.
    * Если потребуется, [создайте клиент Azure Active Directory][create-azure-ad-tenant] или [свяжите подписку Azure со своей учетной записью][associate-azure-ad-tenant].

* Установите и настройте Azure PowerShell.
    * При необходимости выполните инструкции по [установке модуля Azure PowerShell и его подключению к подписке Azure](/powershell/azure/install-az-ps).
    * Войдите в подписку Azure с помощью командлета [Connect-AzAccount][Connect-AzAccount].
* Установите и настройте Azure AD PowerShell.
    * При необходимости выполните инструкции по [установке модуля Azure AD PowerShell и подключению к Azure AD](/powershell/azure/active-directory/install-adv2).
    * Войдите в клиент Azure AD с помощью командлета [Connect-AzureAD][Connect-AzureAD].
* Привилегии *глобального администратора* для клиента Azure AD, чтобы включить доменные службы Azure AD.
* Для создания нужных ресурсов Azure AD DS требуются привилегии *участника* в подписке Azure.

## <a name="sign-in-to-the-azure-portal"></a>Вход на портал Azure

В этой статье вы создадите и настроите исходящее доверие лесов из управляемого домена с помощью портал Azure. Чтобы начать работу, войдите на [портал Azure](https://portal.azure.com).

## <a name="deployment-process"></a>Процесс развертывания

Это процесс с несколькими частями для создания управляемого леса ресурсов домена и отношения доверия с локальной AD DS. Следующие высокоуровневые шаги создают надежную гибридную среду.

1. Создание управляемого субъекта-службы домена.
1. Создайте управляемый лес ресурсов домена.
1. Создайте гибридные сетевые подключения с помощью VPN типа "сеть — сеть" или Express Route.
1. Создайте управляемую сторону домена отношения доверия.
1. Создайте локальную AD DSную сторону отношения доверия.

Прежде чем начать, убедитесь, что вы понимаете [требования к сети, именованию лесов и требованиям DNS](tutorial-create-forest-trust.md#networking-considerations). Невозможно изменить имя управляемого леса домена после его развертывания.

## <a name="create-the-azure-ad-service-principal"></a>Создание субъекта-службы Azure AD

Для AD DS Azure требуется, чтобы субъект-служба синхронизирует данные из Azure AD. Этот участник должен быть создан в клиенте Azure AD до создания леса ресурсов управляемого домена.

Создание субъекта-службы Azure AD для AD DS Azure для взаимодействия и проверки подлинности. Используется определенный идентификатор приложения с названием *Domain Controller Services*(Службы контроллера домена) и номером идентификатора *6ba9a5d4-8456-4118-b521-9c5ca10cdf84*. Не изменяйте этот идентификатор приложения.

Создайте субъект-службу Azure AD с помощью командлета [New-AzureADServicePrincipal][New-AzureADServicePrincipal]:

```powershell
New-AzureADServicePrincipal -AppId "6ba9a5d4-8456-4118-b521-9c5ca10cdf84"
```

## <a name="create-a-managed-domain-resource-forest"></a>Создание леса ресурсов управляемого домена

Чтобы создать лес ресурсов управляемого домена, используйте `New-AzureAaddsForest` скрипт. Этот сценарий является частью более широкого набора команд, поддерживающих создание и управление лесами ресурсов управляемого домена, включая создание одностороннего леса в следующем разделе. Эти сценарии доступны в [коллекция PowerShell](https://www.powershellgallery.com/) и имеют цифровую подпись группы инженеров Azure AD.

1. Сначала создайте группу ресурсов с помощью командлета [New-азресаурцеграуп][New-AzResourceGroup] . В следующем примере создается группа ресурсов с именем *myResourceGroup* в регионе *westus*. Используйте желаемое имя и регион:

    ```azurepowershell
    New-AzResourceGroup `
      -Name "myResourceGroup" `
      -Location "WestUS"
    ```

1. Установите `New-AaddsResourceForestTrust` скрипт из [коллекция PowerShell][powershell-gallery] с помощью командлета [Install-Script][Install-Script] :

    ```powershell
    Install-Script -Name New-AaddsResourceForestTrust
    ```

1. Проверьте следующие параметры, необходимые для `New-AzureAaddsForest` скрипта. Убедитесь, что у вас также есть необходимые компоненты **Azure PowerShell** и модули **Azure AD PowerShell** . Убедитесь, что вы запланировали требования к виртуальной сети для обеспечения подключения между приложениями и локальными сетями.

    | Имя                         | Параметр скрипта          | Описание |
    |:-----------------------------|---------------------------|:------------|
    | Подписка                 | *-azureSubscriptionId*    | Идентификатор подписки, используемый для выставления счетов за AD DS Azure. Список подписок можно получить с помощью командлета [Get-AzureRMSubscription][Get-AzureRMSubscription] . |
    | Группа ресурсов               | *-Ааддсресаурцеграупнаме* | Имя группы ресурсов для управляемого домена и связанных ресурсов. |
    | Расположение                     | *-Ааддслокатион*          | Регион Azure для размещения управляемого домена. Сведения о доступных регионах см [. в статье Поддерживаемые регионы для Azure AD DS.](https://azure.microsoft.com/global-infrastructure/services/?products=active-directory-ds&regions=all) |
    | Администратор AD DS Azure    | *-Ааддсадминусер*         | Имя участника-пользователя первого управляемого администратора домена. Эта учетная запись должна быть существующей облачной учетной записью пользователя в Azure Active Directory. Пользователь и пользователь, запускающий сценарий, добавляются в группу *администраторов контроллера домена AAD* . |
    | Доменное имя Azure AD DS      | *-Ааддсдомаиннаме*        | Полное доменное имя управляемого домена на основе предыдущего руководства по выбору имени леса. |

    `New-AzureAaddsForest`Скрипт может создать виртуальную сеть Azure и подсеть AD DS Azure, если эти ресурсы еще не существуют. При необходимости скрипт может создать подсети рабочей нагрузки, если они указаны:

    | Имя                              | Параметр скрипта                  | Описание |
    |:----------------------------------|:----------------------------------|:------------|
    | Имя виртуальной сети              | *-Ааддсвнетнаме*                  | Имя виртуальной сети для управляемого домена.|
    | Пространство адресов                     | *-АаддсвнетЦидраддрессспаце*      | Диапазон адресов виртуальной сети в нотации CIDR (при создании виртуальной сети).|
    | Имя подсети Azure AD DS           | *-Ааддссубнетнаме*                | Имя подсети виртуальной сети *ааддсвнетнаме* , в которой размещается управляемый домен. Не развертывайте собственные виртуальные машины и рабочие нагрузки в этой подсети. |
    | Диапазон адресов AD DS Azure         | *-АаддссубнетЦидраддрессранже*    | Диапазон адресов подсети в нотации CIDR для экземпляра DS AAD, например *192.168.1.0/24*. Диапазон адресов должен содержаться в диапазоне адресов виртуальной сети и отличаться от других подсетей. |
    | Имя подсети рабочей нагрузки (необязательно)   | *-Ворклоадсубнетнаме*             | Необязательное имя подсети в виртуальной сети *ааддсвнетнаме* для создания собственных рабочих нагрузок приложений. Вместо этого виртуальные машины и приложения также должны быть подключены к одноранговой виртуальной сети Azure. |
    | Диапазон адресов рабочей нагрузки (необязательно) | *-ВорклоадсубнетЦидраддрессранже* | Дополнительный диапазон адресов подсети в нотации CIDR для рабочей нагрузки приложения, например *192.168.2.0/24*. Диапазон адресов должен содержаться в диапазоне адресов виртуальной сети и отличаться от других подсетей.|

1. Теперь создайте управляемый лес ресурсов домена с помощью `New-AzureAaaddsForest` скрипта. В следующем примере создается лес с именем *addscontoso.com* и подсеть рабочей нагрузки. Укажите собственные имена параметров и диапазоны IP-адресов или существующие виртуальные сети.

    ```azurepowershell
    New-AzureAaddsForest `
        -azureSubscriptionId <subscriptionId> `
        -aaddsResourceGroupName "myResourceGroup" `
        -aaddsLocation "WestUS" `
        -aaddsAdminUser "contosoadmin@contoso.com" `
        -aaddsDomainName "aaddscontoso.com" `
        -aaddsVnetName "myVnet" `
        -aaddsVnetCIDRAddressSpace "192.168.0.0/16" `
        -aaddsSubnetName "AzureADDS" `
        -aaddsSubnetCIDRAddressRange "192.168.1.0/24" `
        -workloadSubnetName "myWorkloads" `
        -workloadSubnetCIDRAddressRange "192.168.2.0/24"
    ```

    Создание леса ресурсов управляемого домена и вспомогательных ресурсов занимает довольно много времени. Разрешить завершение скрипта. Перейдите к следующему разделу, чтобы настроить локальное сетевое подключение, а в качестве леса ресурсов Azure AD — в фоновом режиме.

## <a name="configure-and-validate-network-settings"></a>Настройка и проверка параметров сети

Так как управляемый домен продолжит развертывание, настройте и проверьте подключение гибридной сети к локальному центру обработки данных. Также требуется виртуальная машина управления для использования с управляемым доменом для регулярного обслуживания. Некоторые из гибридных подключений могут уже существовать в вашей среде, или для настройки подключений может потребоваться работа с другими пользователями в группе.

Прежде чем начать, убедитесь в том, что вы понимаете рекомендации по [использованию сети и рекомендациям](tutorial-create-forest-trust.md#networking-considerations).

1. Создайте гибридное подключение к локальной сети в Azure с помощью VPN-подключения Azure или Azure ExpressRoute. Конфигурация гибридной сети выходит за рамки этой документации и может уже существовать в вашей среде. Дополнительные сведения о конкретных сценариях см. в следующих статьях:

    * [VPN-подключение типа "сеть — сеть" Azure](../vpn-gateway/vpn-gateway-about-vpngateways.md).
    * [Обзор Azure ExpressRoute](../expressroute/expressroute-introduction.md).

    > [!IMPORTANT]
    > Если вы создаете подключение непосредственно к виртуальной сети управляемого домена, используйте отдельную подсеть шлюза. Не создавайте шлюз в подсети управляемого домена.

1. Для администрирования управляемого домена необходимо создать виртуальную машину управления, присоединить ее к управляемому домену и установить необходимые средства управления AD DS.

    Во время развертывания леса ресурсов управляемого домена [Создайте виртуальную машину Windows Server](./join-windows-vm.md) , а затем [установите основные средства управления AD DS](./tutorial-create-management-vm.md) , чтобы установить необходимые средства управления. Дождитесь присоединить виртуальную машину управления к управляемому домену, выполнив одно из следующих действий после успешного развертывания домена.

1. Проверьте сетевое подключение между локальной сетью и виртуальной сетью Azure.

    * Убедитесь, что локальный контроллер домена может подключаться к управляемой виртуальной машине с помощью `ping` или удаленного рабочего стола, например.
    * Убедитесь, что виртуальная машина управления может подключаться к локальным контроллерам домена, опять же с помощью служебной программы, такой как `ping` .

1. На портале Azure найдите и выберите **Доменные службы Azure AD**. Выберите управляемый домен, например *aaddscontoso.com* , и дождитесь, пока состояние не будет отчитываться как **выполняемое**.

    При запуске [Обновите параметры DNS для виртуальной сети Azure](tutorial-create-instance.md#update-dns-settings-for-the-azure-virtual-network) , а затем [включите учетные записи пользователей для Azure AD DS](tutorial-create-instance.md#enable-user-accounts-for-azure-ad-ds) , чтобы завершить настройку леса ресурсов управляемого домена.

1. Запишите DNS-адреса, показанные на странице Обзор. Эти адреса понадобятся при настройке локальной Active Directory отношения доверия в следующем разделе.
1. Перезапустите виртуальную машину управления для получения новых параметров DNS, а затем [присоедините виртуальную машину к управляемому домену](join-windows-vm.md#join-the-vm-to-the-managed-domain).
1. После того как виртуальная машина управления будет присоединена к управляемому домену, снова подключитесь к ней с помощью удаленного рабочего стола.

    В командной строке используйте `nslookup` и имя леса ресурсов управляемого домена, чтобы проверить разрешение имен для леса ресурсов.

    ```console
    nslookup aaddscontoso.com
    ```

    Команда должна вернуть два IP-адреса для леса ресурсов.

## <a name="create-the-forest-trust"></a>Создание доверия леса

Доверие лесов состоит из двух частей: одностороннее исходящее доверие леса в лесу ресурсов управляемого домена и одностороннее входящее доверие леса в локальном AD DS лесу. Обе стороны этого отношения доверия создаются вручную. При создании обеих сторон пользователи и ресурсы могут пройти проверку подлинности с помощью доверия лесов. Управляемый лес ресурсов домена поддерживает до 5 1. отношения доверия между исходящими лесами и локальными лесами.

### <a name="create-the-managed-domain-side-of-the-trust-relationship"></a>Создание управляемой стороны домена отношения доверия

Используйте `Add-AaddsResourceForestTrust` скрипт для создания управляемой стороны домена отношения доверия. Сначала установите `Add-AaddsResourceForestTrust` скрипт из [коллекция PowerShell][powershell-gallery] с помощью командлета [Install-Script][Install-Script] :

```powershell
Install-Script -Name Add-AaddsResourceForestTrust
```

Теперь предоставьте скрипту следующие сведения:

| Имя                               | Параметр скрипта     | Описание |
|:-----------------------------------|:---------------------|:------------|
| Доменное имя Azure AD DS            | *-Манажеддомаинфкдн* | Полное доменное имя управляемого домена, например *aaddscontoso.com* |
| Локальное AD DS доменное имя      | *-Трустфкдн*         | Полное доменное имя доверенного леса, например *onprem.contoso.com* |
| Понятное имя отношения доверия                | *-Трустфриендлинаме* | Понятное имя отношения доверия. |
| Локальные AD DS IP-адреса DNS | *-Трустднсипс*       | Разделенный запятыми список адресов IPv4 DNS-серверов для доверенного домена в списке. |
| Пароль доверия                     | *-Трустпассворд*     | Сложный пароль для отношения доверия. Этот пароль также указывается при создании одностороннего входящего доверия в локальной AD DS. |
| Учетные данные                        | *Учетные данные*       | Учетные данные, используемые для проверки подлинности в Azure. Пользователь должен входить в *группу администраторов контроллера домена AAD*. Если этот параметр не указан, сценарий запрашивает проверку подлинности. |

В следующем примере создается отношение доверия с именем *мязуреаддструст* к *onprem.contoso.com*. Используйте собственные имена параметров и пароли:.

```azurepowershell
Add-AaddsResourceForestTrust `
    -ManagedDomainFqdn "aaddscontoso.com" `
    -TrustFqdn "onprem.contoso.com" `
    -TrustFriendlyName "myAzureADDSTrust" `
    -TrustDnsIPs "10.0.1.10,10.0.1.11" `
    -TrustPassword <complexPassword>
```

> [!IMPORTANT]
> Запомните пароль доверия. При создании локальной стороны отношения доверия необходимо использовать тот же пароль.

## <a name="configure-dns-in-the-on-premises-domain"></a>Настройка DNS в локальном домене

Чтобы правильно разрешить управляемый домен из локальной среды, может потребоваться добавить серверы пересылки к существующим DNS-серверам. Если в локальной среде не настроено взаимодействие с управляемым доменом, выполните следующие действия на рабочей станции управления для локального домена AD DS.

1. Выберите элементы **Пуск | Администрирование | DNS**.
1. Щелкните правой кнопкой мыши DNS-сервер, например *myAD01*, и выберите пункт **Свойства**.
1. Выберите **Серверы пересылки**, а затем — **Изменить**, чтобы добавить дополнительные серверы пересылки.
1. Добавьте IP-адреса управляемого домена, например *10.0.1.4* и *10.0.1.5*.
1. В локальной командной строке проверьте разрешение имен с помощью команды **nslookup** доменного имени леса ресурсов управляемого домена. Например, `Nslookup aaddscontoso.com` должен вернуть два IP-адреса для леса управляемого домена ресурсов.

## <a name="create-inbound-forest-trust-in-the-on-premises-domain"></a>Создание входящего доверия леса в локальном домене

Для локального домена AD DS требуется входящее доверие леса для управляемого домена. Это доверие необходимо настроить вручную в локальном домене AD DS. Его нельзя создать на портале Azure.

Чтобы настроить входящее доверие в локальном домене AD DS, выполните на рабочей станции управления следующие действия с локальным доменом AD DS:

1. Выберите элементы **Пуск | Администрирование | Active Directory — домены и доверие**.
1. Щелкните правой кнопкой мыши домен, например *onprem.contoso.com*, и выберите пункт **Свойства**.
1. Выберите вкладку **Отношения доверия**, а затем — **New Trust** (Создать доверие).
1. Введите имя управляемого домена, например *aaddscontoso.com*, а затем нажмите кнопку **Далее** .
1. Выберите параметр для создания **доверия леса**, а затем — доверие **One way: incoming** (Одностороннее: входящее).
1. Выберите параметр для создания доверия для **This domain only** (Только для этого домена). На следующем шаге вы создадите доверие на портале Azure для управляемого домена.
1. Выберите параметр для использования **Forest-wide authentication** (Проверка подлинности в лесу), а затем введите и подтвердите пароль отношения доверия. Этот пароль также вводится на портале Azure в следующем разделе.
1. В следующих нескольких окнах примите параметры по умолчанию, а затем выберите параметр **Нет, не подтверждаю это исходящее доверие**. Невозможно проверить отношение доверия, так как учетная запись делегированного администратора в лесу ресурсов управляемого домена не имеет необходимых разрешений. В этом весь замысел.
1. Нажмите кнопку **Готово**.

## <a name="validate-resource-authentication"></a>Проверка подлинности ресурсов

Следующие распространенные сценарии позволяют убедиться, что доверие леса правильно проверяет подлинность пользователей и доступ к ресурсам:

* [Локальная проверка подлинности пользователя в лесу ресурсов Azure AD DS](#on-premises-user-authentication-from-the-azure-ad-ds-resource-forest)
* [Доступ локального пользователя к ресурсам в лесу ресурсов Azure AD DS](#access-resources-in-the-azure-ad-ds-resource-forest-using-on-premises-user)
    * [Предоставление совместного доступа к файлам и принтерам](#enable-file-and-printer-sharing)
    * [Создание группы безопасности и добавление участников](#create-a-security-group-and-add-members)
    * [Создание общей папки для доступа между лесами](#create-a-file-share-for-cross-forest-access)
    * [Проверка аутентификации между лесами для ресурса](#validate-cross-forest-authentication-to-a-resource)

### <a name="on-premises-user-authentication-from-the-azure-ad-ds-resource-forest"></a>Локальная проверка подлинности пользователя в лесу ресурсов Azure AD DS

У вас должна быть виртуальная машина Windows Server, присоединенная к домену ресурсов управляемого домена. Используйте эту виртуальную машину для тестирования того, что локальный пользователь может пройти проверку подлинности на виртуальной машине.

1. Подключитесь к виртуальной машине Windows Server, присоединенной к лесу ресурсов управляемого домена, с помощью удаленный рабочий стол и учетных данных администратора управляемого домена. Если вы получаете ошибку проверка подлинности на уровне сети (NLA), проверьте, что используемая учетная запись пользователя не является учетной записью пользователя домена.

    > [!TIP]
    > Для безопасного подключения к виртуальным машинам, присоединенным к доменным службам Azure AD, можно использовать [службу узла Azure бастиона](../bastion/bastion-overview.md) в поддерживаемых регионах Azure.

1. Откройте командную строку и выполните команду `whoami`, чтобы просмотреть различающееся имя пользователя, проходящего проверку подлинности:

    ```console
    whoami /fqdn
    ```

1. Используйте команду `runas` для проверки подлинности в качестве пользователя из локального домена. В следующей команде замените `userUpn@trusteddomain.com` именем участника-пользователя из доверенного локального домена: Команда запрашивает пароль пользователя:

    ```console
    Runas /u:userUpn@trusteddomain.com cmd.exe
    ```

1. Если проверка подлинности выполнена успешно, откроется новая командная строка. Заголовок новой командной строки будет содержать `running as userUpn@trusteddomain.com`.
1. Используйте `whoami /fqdn` в новой командной строке, чтобы просмотреть различающееся имя пользователя, прошедшего проверку подлинности из локальной службы Active Directory.

### <a name="access-resources-in-the-azure-ad-ds-resource-forest-using-on-premises-user"></a>Доступ локального пользователя к ресурсам в лесу ресурсов Azure AD DS

Используя виртуальную машину Windows Server, присоединенную к лесу ресурсов управляемого домена, можно протестировать сценарий, в котором пользователи могут получить доступ к ресурсам, размещенным в лесу ресурсов, при проверке подлинности с компьютеров в локальном домене с пользователями из локального домена. В следующих примерах показано, как создавать и тестировать различные распространенные сценарии.

#### <a name="enable-file-and-printer-sharing"></a>Предоставление совместного доступа к файлам и принтерам

1. Подключитесь к виртуальной машине Windows Server, присоединенной к лесу ресурсов управляемого домена, с помощью удаленный рабочий стол и учетных данных администратора управляемого домена. Если вы получаете ошибку проверка подлинности на уровне сети (NLA), проверьте, что используемая учетная запись пользователя не является учетной записью пользователя домена.

    > [!TIP]
    > Для безопасного подключения к виртуальным машинам, присоединенным к доменным службам Azure AD, можно использовать [службу узла Azure бастиона](../bastion/bastion-overview.md) в поддерживаемых регионах Azure.

1. Откройте **Параметры Windows**, затем найдите и откройте страницу **Центр управления сетями и общим доступом**.
1. Щелкните **Изменить дополнительные параметры общего доступа**.
1. В разделе **Профиль домена** установите параметр **Включить общий доступ к файлам и принтерам**, а затем нажмите кнопку **Сохранение изменений**.
1. Закройте **Центр управления сетями и общим доступом**.

#### <a name="create-a-security-group-and-add-members"></a>Создание группы безопасности и добавление участников

1. Откройте оснастку **Пользователи и компьютеры Active Directory**.
1. Щелкните правой кнопкой мыши имя домена, выберите команду **Создать**, а затем — пункт **Organizational Unit** (Подразделение).
1. В поле имени введите *LocalObjects*, а затем нажмите кнопку **ОК**.
1. Выберите и щелкните правой кнопкой мыши **LocalObjects** в области навигации. Выберите команду **Создать**, а затем — пункт **Группа**.
1. Введите *FileServerAccess* в поле **Имя группы**. Для параметра **Области действия группы** выберите значение **Локальная в домене**, а затем нажмите кнопку **ОК**.
1. В области содержимого дважды щелкните **FileServerAccess**. Выберите **Члены**, **Добавить**, а затем — **Расположения**.
1. Выберите локальные доменные службы Active Directory в представлении **Расположение**, а затем нажмите кнопку **ОК**.
1. Введите *Пользователи домена* в поле **Enter the object names to select** (Введите имена объектов для выбора). Щелкните **Проверить имена**, укажите учетные данные для локальных пользователей Active Directory, а затем нажмите кнопку **ОК**.

    > [!NOTE]
    > Необходимо указать учетные данные, так как отношение доверия является только односторонним. Это означает, что пользователи из управляемого домена не могут получить доступ к ресурсам или искать пользователей или группы в доверенном (локальном) домене.

1. Группа **Пользователи домена** из локальной среды Active Directory должна быть членом группы **FileServerAccess**. Нажмите кнопку **ОК**, чтобы сохранить группу и закрыть окно.

#### <a name="create-a-file-share-for-cross-forest-access"></a>Создание общей папки для доступа между лесами

1. На виртуальной машине Windows Server, присоединенной к лесу ресурсов управляемого домена, создайте папку и укажите имя, например *кроссфорестшаре*.
1. Правой кнопкой мыши щелкните папку и выберите пункт **Свойства**.
1. Перейдите на вкладку **Безопасность**, а затем нажмите кнопку **Изменить**.
1. В диалоговом окне *Разрешения для CrossForestShare* щелкните **Добавить**.
1. Введите *FileServerAccess* в поле **Enter the object names to select** (Введите имена объектов для выбора), а затем нажмите кнопку **ОК**.
1. Выберите *FileServerAccess* из списка **Groups or user names** (Имена групп или пользователей). В списке **Permissions for FileServerAccess** (Разрешения для FileServerAccess) щелкните *Разрешить* для разрешений **Изменить** и **Запись**, а затем нажмите кнопку **ОК**.
1. Выберите вкладку **Общий доступ**, а затем — **Расширенная настройка…**
1. Установите флажок **Открыть общий доступ к этой папке**, а затем введите запоминающееся имя для общей папки в поле **Имя общего ресурса**, например *CrossForestShare*.
1. Нажмите кнопку **Разрешения**. В списке **Permissions for Everyone** (Разрешения для всех) щелкните **Разрешить** для разрешения **Изменить**.
1. Нажмите кнопку **ОК** дважды, а затем щелкните **Закрыть**.

#### <a name="validate-cross-forest-authentication-to-a-resource"></a>Проверка аутентификации между лесами для ресурса

1. Войдите в систему на компьютере Windows, присоединенном к локальному домену Active Directory, используя учетную запись пользователя из локальной среды Active Directory.
1. С помощью **проводника** подключитесь к созданной общей папке, используя полное имя узла и общую папку, например `\\fs1.aaddscontoso.com\CrossforestShare`.
1. Чтобы проверить разрешение на запись, щелкните правой кнопкой мыши в папке, выберите команду **Создать**, а затем — пункт **Текстовый документ**. Используйте имя по умолчанию **Новый текстовый документ**.

    Если разрешения на запись заданы правильно, будет создан текстовый документ. Следующие шаги открывают, изменяют и удаляют файл соответствующим образом.
1. Чтобы проверить разрешение на чтение, откройте **Новый текстовый документ**.
1. Чтобы проверить разрешение на изменение, добавьте текст в файл и закройте **Блокнот**. При появлении запроса на сохранение изменений нажмите кнопку **Сохранить**.
1. Чтобы проверить разрешение на удаление, щелкните правой кнопкой мыши **Новый текстовый документ** и выберите команду **Удалить**. Нажмите кнопку **Да** для подтверждения удаления файла.

## <a name="update-or-remove-outbound-forest-trust"></a>Обновление или удаление доверия исходящего леса

Если необходимо обновить существующий односторонний лес исходящего трафика из управляемого домена, можно использовать `Get-AaddsResourceForestTrusts` `Set-AaddsResourceForestTrust` скрипты и. Эти сценарии помогают в сценариях, где необходимо обновить понятное имя доверия леса или пароль доверия. Чтобы удалить одностороннее исходящее доверие из управляемого домена, можно использовать `Remove-AaddsResourceForestTrust` скрипт. Необходимо вручную удалить одностороннее входящее доверие лесов в связанном локальном лесу AD DS.

### <a name="update-a-forest-trust"></a>Обновление доверия леса

При нормальной работе Управляемый лес домена и локальный лес согласовывают обычный процесс обновления пароля между собой. Это часть стандартного процесса безопасности отношений доверия AD DS. Вам не нужно вручную менять пароль доверия, если в отношениях доверия возникла ошибка и вы хотите вручную сбросить его до известного пароля. Дополнительные сведения см. в разделе [изменение пароля объекта доверенного домена](concepts-forest-trust.md#tdo-password-changes).

В следующих примерах шагов показано, как обновить существующее отношение доверия, если необходимо вручную сбросить исходящий пароль доверия.

1. Установите `Get-AaddsResourceForestTrusts` `Set-AaddsResourceForestTrust` скрипты и из [коллекция PowerShell][powershell-gallery] с помощью командлета [Install-Script][Install-Script] :

    ```powershell
    Install-Script -Name Get-AaddsResourceForestTrusts,Set-AaddsResourceForestTrust
    ```

1. Прежде чем можно будет обновить существующее отношение доверия, сначала получите ресурс доверия с помощью `Get-AaddsResourceForestTrusts` скрипта. В следующем примере существующее доверие назначается объекту с именем *ексистингтруст*. Укажите имя управляемого леса домена и имя локального леса для обновления:

    ```powershell
    $existingTrust = Get-AaddsResourceForestTrust `
        -ManagedDomainFqdn "aaddscontoso.com" `
        -TrustFqdn "onprem.contoso.com" `
        -TrustFriendlyName "myAzureADDSTrust"
    ```

1. Чтобы обновить существующий пароль доверия, используйте `Set-AaddsResourceForestTrust` скрипт. Укажите существующий объект доверия, созданный на предыдущем шаге, а затем новый пароль отношения доверия. PowerShell не требует повышения сложности пароля, поэтому необходимо создать и использовать безопасный пароль для вашей среды.

    ```powershell
    Set-AaddsResourceForestTrust `
        -Trust $existingTrust `
        -TrustPassword <newComplexPassword>
    ```

### <a name="delete-a-forest-trust"></a>Удаление доверия леса

Если одностороннее исходящее доверие лесов от управляемого домена к локальному AD DS лесу больше не требуется, его можно удалить. Прежде чем удалять доверие, убедитесь, что никакие приложения и службы не требуют проверки подлинности в локальном лесу AD DS. Также необходимо вручную удалить одностороннее входящее доверие в локальном AD DS лесу.

1. Установите `Remove-AaddsResourceForestTrust` скрипт из [коллекция PowerShell][powershell-gallery] с помощью командлета [Install-Script][Install-Script] :

    ```powershell
    Install-Script -Name Remove-AaddsResourceForestTrust
    ```

1. Теперь удалите доверие леса с помощью `Remove-AaddsResourceForestTrust` скрипта. В следующем примере удаляется отношение доверия с именем *мязуреаддструст* между управляемым лесом домена с именем *aaddscontoso.com* и локальным лесом *onprem.contoso.com* . Укажите имя управляемого леса домена и имя локального леса для удаления:

    ```powershell
    Remove-AaddsResourceForestTrust `
        -ManagedDomainFqdn "aaddscontoso.com" `
        -TrustFqdn "onprem.contoso.com" `
        -TrustFriendlyName "myAzureADDSTrust"
    ```

Чтобы удалить одностороннее входящее доверие из локального AD DS леса, подключитесь к компьютеру управления с доступом к локальному AD DS лесу и выполните следующие действия.

1. Выберите элементы **Пуск | Администрирование | Active Directory — домены и доверие**.
1. Щелкните правой кнопкой мыши домен, например *onprem.contoso.com*, и выберите пункт **Свойства**.
1. Выберите вкладку **доверия** , а затем выберите существующее входящее доверие из управляемого леса домена.
1. Выберите **Удалить**, а затем подтвердите, что вы хотите удалить входящее доверие.

## <a name="next-steps"></a>Дальнейшие действия

Из этой статьи вы узнали, как выполнять следующие задачи:

> [!div class="checklist"]
> * Создание управляемого леса ресурсов домена с помощью Azure PowerShell
> * Создание одностороннего исходящего доверия леса в управляемом домене с помощью Azure PowerShell
> * Настройка DNS в локальной среде AD DS для поддержки управляемого подключения к домену
> * создание одностороннего входящего доверия леса в локальной среде AD DS;
> * тестирование и проверка отношения доверия для проверки подлинности и доступа к ресурсам.

Дополнительные сведения о типах лесов в Azure AD DS см. в статьях о [лесах ресурсов][concepts-forest] и о том, [как работают доверия леса в Azure AD DS][concepts-trust].

<!-- INTERNAL LINKS -->
[concepts-forest]: concepts-resource-forest.md
[concepts-trust]: concepts-forest-trust.md
[create-azure-ad-tenant]: ../active-directory/fundamentals/sign-up-organization.md
[associate-azure-ad-tenant]: ../active-directory/fundamentals/active-directory-how-subscriptions-associated-directory.md
[create-azure-ad-ds-instance-advanced]: tutorial-create-instance-advanced.md
[Connect-AzAccount]: /powershell/module/Az.Accounts/Connect-AzAccount
[Connect-AzureAD]: /powershell/module/AzureAD/Connect-AzureAD
[New-AzResourceGroup]: /powershell/module/Az.Resources/New-AzResourceGroup
[network-peering]: ../virtual-network/virtual-network-peering-overview.md
[New-AzureADServicePrincipal]: /powershell/module/AzureAD/New-AzureADServicePrincipal
[Get-AzureRMSubscription]: /powershell/module/AzureRM.Profile/Get-AzureRmSubscription
[Install-Script]: /powershell/module/powershellget/install-script

<!-- EXTERNAL LINKS -->
[powershell-gallery]: https://www.powershellgallery.com/