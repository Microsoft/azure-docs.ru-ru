---
title: Учебник по созданию доверия леса в доменных службах Azure AD | Документация Майкрософт
description: Узнайте, как создать односторонний исходящий лес для локального домена AD DS на портале Azure для доменных служб Azure AD.
services: active-directory-ds
author: justinha
manager: daveba
ms.service: active-directory
ms.subservice: domain-services
ms.workload: identity
ms.topic: tutorial
ms.date: 01/21/2021
ms.author: justinha
ms.openlocfilehash: e381c80dddc4484d541f5f81de6b5df712cff69b
ms.sourcegitcommit: b39cf769ce8e2eb7ea74cfdac6759a17a048b331
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/22/2021
ms.locfileid: "98673473"
---
# <a name="tutorial-create-an-outbound-forest-trust-to-an-on-premises-domain-in-azure-active-directory-domain-services"></a>Руководство по Создание исходящего доверия леса для локального домена в доменных службах Azure Active Directory

В средах, где нельзя синхронизировать хэши паролей или где пользователи используют только смарт-карты для входа в систему, поскольку они не знают своего пароля, в доменных службах Azure Active Directory (Azure AD DS) можно использовать лес ресурсов. Лес ресурсов использует одностороннее исходящее отношение доверия между Azure AD DS и одной или несколькими локальными средами AD DS. Это отношение доверия позволяет пользователям, приложениям и компьютерам проходить проверку подлинности в локальном домене из управляемого домена Azure AD DS. В лесе ресурсов локальные хэши паролей не синхронизируются.

![Схема доверия леса между Azure AD DS и локальными AD DS](./media/concepts-resource-forest/resource-forest-trust-relationship.png)

В этом руководстве описано следующее:

> [!div class="checklist"]
> * настройка DNS в локальной среде AD DS для поддержки возможности подключения Azure AD DS;
> * создание одностороннего входящего доверия леса в локальной среде AD DS;
> * создание одностороннего исходящего доверия леса в Azure AD DS;
> * тестирование и проверка отношения доверия для проверки подлинности и доступа к ресурсам.

Если у вас еще нет подписки Azure, [создайте учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

## <a name="prerequisites"></a>Предварительные требования

Для работы с этим учебником требуются следующие ресурсы и разрешения:

* Активная подписка Azure.
    * Если у вас еще нет подписки Azure, [создайте учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F).
* Связанный с вашей подпиской клиент Azure Active Directory, синхронизированный с локальным или облачным каталогом.
    * Если потребуется, [создайте клиент Azure Active Directory][create-azure-ad-tenant] или [свяжите подписку Azure со своей учетной записью][associate-azure-ad-tenant].
* Управляемый домен Azure AD DS, созданный с использованием леса ресурсов и настроенный в клиенте Azure AD.
    * При необходимости [создайте и настройте управляемый домен доменных служб Azure Active Directory][create-azure-ad-ds-instance-advanced].
    
    > [!IMPORTANT]
    > Управляемый домен нужно обязательно создавать с использованием леса *ресурсов*. Параметр по умолчанию создает лес *пользователя*. Только леса ресурсов могут создавать отношения доверия к локальным средам AD DS.
    >
    > Для управляемого домена также необходимо использовать как минимум SKU уровня *Корпоративный*. При необходимости [измените номер SKU для управляемого домена][howto-change-sku].

## <a name="sign-in-to-the-azure-portal"></a>Вход на портал Azure

В этом учебнике вы создадите и настроите исходящее доверие леса из Azure AD DS с помощью портала Azure. Чтобы начать работу, войдите на [портал Azure](https://portal.azure.com).

## <a name="networking-considerations"></a>Рекомендации по работе с сетями

Для виртуальной сети, в которой размещен лес ресурсов Azure AD DS, требуется сетевое подключение к локальным доменным службам Active Directory. Для приложений и служб также требуется подключение к виртуальной сети, в которой размещается лес ресурсов Azure AD DS. Сетевое подключение к лесу ресурсов Azure AD DS должно быть непрерывным и работать стабильно. В противном случае пользователи могут не пройти проверку подлинности или не получить доступ к ресурсам.

Перед настройкой доверия леса в Azure AD DS убедитесь, что сеть между Azure и локальной средой соответствует следующим требованиям:

* Используйте частные IP-адреса. Не полагайтесь на DHCP с динамическим назначением IP-адресов.
* Избегайте перекрытия диапазонов IP-адресов, чтобы обеспечить возможность пиринга между виртуальными сетями, а также маршрутизации для связи между Azure и локальной средой.
* Для виртуальной сети Azure требуется подсеть шлюза, чтобы настроить подключение Azure [VPN типа "сеть — сеть"][vpn-gateway] или [ExpressRoute][expressroute].
* Создайте подсети с достаточным количеством IP-адресов для поддержки вашего сценария.
* Убедитесь, что Azure AD DS имеет собственную подсеть. Не предоставляйте общий доступ к этой подсети виртуальной сети виртуальным машинам и службам приложений.
* Одноранговые виртуальные сети НЕ являются транзитивными.
    * Пиринг между виртуальными сетями Azure должен быть создан между всеми виртуальными сетями, которые должны использовать доверие леса ресурсов Azure AD DS к локальной среде AD DS.
* Обеспечьте непрерывное сетевое подключение к локальному лесу Active Directory. Не используйте подключения по запросу.
* Убедитесь в наличии непрерывного разрешения имен (DNS) между именем леса ресурсов Azure AD DS и локальным именем леса Active Directory.

## <a name="configure-dns-in-the-on-premises-domain"></a>Настройка DNS в локальном домене

Чтобы правильно разрешить управляемый домен из локальной среды, может потребоваться добавить серверы пересылки к существующим DNS-серверам. Если в локальной среде не настроено взаимодействие с управляемым доменом, выполните следующие действия на рабочей станции управления для локального домена AD DS.

1. Выберите **Пуск** > **Администрирование** > **DNS**.
1. Щелкните правой кнопкой мыши DNS-сервер, например *myAD01*, и выберите **Свойства**.
1. Выберите **Серверы пересылки**, а затем — **Изменить**, чтобы добавить дополнительные серверы пересылки.
1. Добавьте IP-адреса управляемого домена, например *10.0.2.4* и *10.0.2.5*.

## <a name="create-inbound-forest-trust-in-the-on-premises-domain"></a>Создание входящего доверия леса в локальном домене

Для локального домена AD DS требуется входящее доверие леса для управляемого домена. Это доверие необходимо настроить вручную в локальном домене AD DS. Его нельзя создать на портале Azure.

Чтобы настроить входящее доверие в локальном домене AD DS, выполните на рабочей станции управления следующие действия с локальным доменом AD DS:

1. Выберите **Пуск** > **Средства администрирования** > **Active Directory — домены и доверие**.
1. Нажмите правой кнопкой мыши домен, например *onprem.contoso.com*, и выберите **Свойства**.
1. Выберите вкладку **Отношения доверия**, а затем — **New Trust** (Создать доверие).
1. Введите доменное имя Azure AD DS, например *aaddscontoso.com*, и выберите **Далее**.
1. Выберите параметр для создания **доверия леса**, а затем — доверие **One way: incoming** (Одностороннее: входящее).
1. Выберите параметр для создания доверия для **This domain only** (Только для этого домена). На следующем шаге вы создадите доверие на портале Azure для управляемого домена.
1. Выберите параметр для использования **Forest-wide authentication** (Проверка подлинности в лесу), а затем введите и подтвердите пароль отношения доверия. Этот пароль также вводится на портале Azure в следующем разделе.
1. В следующих нескольких окнах примите параметры по умолчанию, а затем выберите параметр **Нет, не подтверждаю это исходящее доверие**.
1. Нажмите кнопку **Готово**.

Если доверие леса больше не требуется для среды, выполните следующие действия, чтобы удалить его из локального домена.

1. Выберите **Пуск** > **Средства администрирования** > **Active Directory — домены и доверие**.
1. Нажмите правой кнопкой мыши домен, например *onprem.contoso.com*, и выберите **Свойства**.
1. Выберите вкладку **Доверия**, затем **Domains that trust this domain (incoming trusts)** (Домены, которые доверяют этому домену (входящие отношения доверия)), щелкните доверие, которое нужно удалить, а затем нажмите **Удалить**.
1. На вкладке "Доверия" в разделе **Domains trusted by this domain (outgoing trusts)** (Домены, которым доверяет этот домен (исходящие отношения доверия)) щелкните доверие, которое нужно удалить, а затем нажмите "Удалить".
1. Щелкните **Нет, удалить отношение доверия только в локальном домене**.

## <a name="create-outbound-forest-trust-in-azure-ad-ds"></a>Создание исходящего доверия леса в Azure AD DS

Теперь, когда в локальном домене AD DS настроено разрешение управляемого домена и создано входящее доверие леса, создайте исходящее доверие леса. Это последний шаг для создания отношения доверия между локальным доменом AD DS и управляемым доменом.

Чтобы создать исходящее доверие для управляемого домена на портале Azure, выполните следующие действия.

1. На портале Azure найдите и выберите **Доменные службы Azure AD**, а затем выберите управляемый домен, например *aaddscontoso.com*.
1. В меню в левой части управляемого домена выберите **Отношения доверия**, а затем нажмите кнопку **+ Добавить**, чтобы добавить доверие.

   > [!NOTE]
   > Если пункт меню **Отношения доверия** не отображается, найдите в разделе **Свойства** элемент *Тип леса*. Создавать доверия можно только для *лесов ресурсов*. Если тип леса — *Пользователь*, создание доверий невозможно. Сейчас нет возможности изменять тип леса управляемого домена. Необходимо удалить и повторно создать управляемый домен в качестве леса ресурсов.

1. Введите отображаемое имя, идентифицирующее доверие, а затем локальное DNS-имя доверенного леса, например *onprem.contoso.com*.
1. Укажите тот же пароль отношения доверия, который использовался для настройки входящего доверия леса для локального домена AD DS в предыдущем разделе.
1. Укажите по крайней мере два DNS-сервера для локального домена AD DS, например *10.1.1.4* и *10.1.1.5*.
1. Сохраните исходящее доверие леса, когда оно будет готово, нажав кнопку **Сохранить**.

    ![Создание исходящего доверия леса на портале Azure](./media/tutorial-create-forest-trust/portal-create-outbound-trust.png)

Если доверие леса больше не требуется для среды, выполните следующие действия, чтобы удалить его из Azure AD DS.

1. На портале Azure найдите и выберите **Доменные службы Azure AD**, а затем выберите управляемый домен, например *aaddscontoso.com*.
1. В левой части меню управляемого домена выберите **Доверия**, затем выберите доверие и нажмите кнопку **Удалить**.
1. Введите тот же пароль доверия, который использовался для настройки доверия леса, и нажмите **ОК**.

## <a name="validate-resource-authentication"></a>Проверка подлинности ресурсов

Следующие распространенные сценарии позволяют убедиться, что доверие леса правильно проверяет подлинность пользователей и доступ к ресурсам:

* [Локальная проверка подлинности пользователя в лесу ресурсов Azure AD DS](#on-premises-user-authentication-from-the-azure-ad-ds-resource-forest)
* [Доступ локального пользователя к ресурсам в лесу ресурсов Azure AD DS](#access-resources-in-the-azure-ad-ds-resource-forest-using-on-premises-user)
    * [Предоставление совместного доступа к файлам и принтерам](#enable-file-and-printer-sharing)
    * [Создание группы безопасности и добавление участников](#create-a-security-group-and-add-members)
    * [Создание общей папки для доступа между лесами](#create-a-file-share-for-cross-forest-access)
    * [Проверка аутентификации между лесами для ресурса](#validate-cross-forest-authentication-to-a-resource)

### <a name="on-premises-user-authentication-from-the-azure-ad-ds-resource-forest"></a>Локальная проверка подлинности пользователя в лесу ресурсов Azure AD DS

У вас должна быть виртуальная машина Windows Server, присоединенная к управляемому домену. Используйте эту виртуальную машину для тестирования того, что локальный пользователь может пройти проверку подлинности на виртуальной машине. При необходимости [создайте виртуальную машину Windows и присоедините ее к управляемому домену][join-windows-vm].

1. Подключитесь к виртуальной машине Windows Server, присоединенной к лесу ресурсов Azure AD DS, используя [Бастион Azure](../bastion/bastion-overview.md) и учетные данные администратора Azure AD DS.
1. Откройте командную строку и выполните команду `whoami`, чтобы просмотреть различающееся имя пользователя, проходящего проверку подлинности:

    ```console
    whoami /fqdn
    ```

1. Используйте команду `runas` для проверки подлинности в качестве пользователя из локального домена. В следующей команде замените `userUpn@trusteddomain.com` именем участника-пользователя из доверенного локального домена: Команда запрашивает пароль пользователя:

    ```console
    Runas /u:userUpn@trusteddomain.com cmd.exe
    ```

1. Если проверка подлинности выполнена успешно, откроется новая командная строка. Заголовок новой командной строки будет содержать `running as userUpn@trusteddomain.com`.
1. Используйте `whoami /fqdn` в новой командной строке, чтобы просмотреть различающееся имя пользователя, прошедшего проверку подлинности из локальной службы Active Directory.

### <a name="access-resources-in-the-azure-ad-ds-resource-forest-using-on-premises-user"></a>Доступ локального пользователя к ресурсам в лесу ресурсов Azure AD DS

Используя виртуальную машину Windows Server, присоединенную к лесу ресурсов Azure AD DS, можно протестировать сценарий, в котором пользователи могут получать доступ к ресурсам, размещенным в лесу ресурсов, при проверке подлинности на компьютерах в локальном домене с использованием данных пользователей из локального домена. В следующих примерах показано, как создавать и тестировать различные распространенные сценарии.

#### <a name="enable-file-and-printer-sharing"></a>Предоставление совместного доступа к файлам и принтерам

1. Подключитесь к виртуальной машине Windows Server, присоединенной к лесу ресурсов Azure AD DS, используя [Бастион Azure](../bastion/bastion-overview.md) и учетные данные администратора Azure AD DS.

1. Откройте **Параметры Windows**, затем найдите и откройте страницу **Центр управления сетями и общим доступом**.
1. Щелкните **Изменить дополнительные параметры общего доступа**.
1. В разделе **Профиль домена** установите параметр **Включить общий доступ к файлам и принтерам**, а затем нажмите кнопку **Сохранение изменений**.
1. Закройте **Центр управления сетями и общим доступом**.

#### <a name="create-a-security-group-and-add-members"></a>Создание группы безопасности и добавление участников

1. Откройте оснастку **Пользователи и компьютеры Active Directory**.
1. Щелкните правой кнопкой мыши имя домена, выберите команду **Создать**, а затем — пункт **Organizational Unit** (Подразделение).
1. В поле имени введите *LocalObjects*, а затем нажмите кнопку **ОК**.
1. Выберите и щелкните правой кнопкой мыши **LocalObjects** в области навигации. Выберите команду **Создать**, а затем — пункт **Группа**.
1. Введите *FileServerAccess* в поле **Имя группы**. Для параметра **Области действия группы** выберите значение **Локальная в домене**, а затем нажмите кнопку **ОК**.
1. В области содержимого дважды щелкните **FileServerAccess**. Выберите **Члены**, **Добавить**, а затем — **Расположения**.
1. Выберите локальные доменные службы Active Directory в представлении **Расположение**, а затем нажмите кнопку **ОК**.
1. Введите *Пользователи домена* в поле **Enter the object names to select** (Введите имена объектов для выбора). Щелкните **Проверить имена**, укажите учетные данные для локальных пользователей Active Directory, а затем нажмите кнопку **ОК**.

    > [!NOTE]
    > Необходимо указать учетные данные, так как отношение доверия является только односторонним. Это означает, что пользователи из управляемого домена AD DS не могут обращаться к ресурсам либо искать пользователей или группы в доверенном (локальном) домене.

1. Группа **Пользователи домена** из локальной среды Active Directory должна быть членом группы **FileServerAccess**. Нажмите кнопку **ОК**, чтобы сохранить группу и закрыть окно.

#### <a name="create-a-file-share-for-cross-forest-access"></a>Создание общей папки для доступа между лесами

1. На виртуальной машине Windows Server, присоединенной к лесу ресурсов Azure AD DS, создайте папку и укажите ее имя, например *CrossForestShare*.
1. Правой кнопкой мыши щелкните папку и выберите пункт **Свойства**.
1. Перейдите на вкладку **Безопасность**, а затем нажмите кнопку **Изменить**.
1. В диалоговом окне *Разрешения для CrossForestShare* щелкните **Добавить**.
1. Введите *FileServerAccess* в поле **Enter the object names to select** (Введите имена объектов для выбора), а затем нажмите кнопку **ОК**.
1. Выберите *FileServerAccess* из списка **Groups or user names** (Имена групп или пользователей). В списке **Permissions for FileServerAccess** (Разрешения для FileServerAccess) щелкните *Разрешить* для разрешений **Изменить** и **Запись**, а затем нажмите кнопку **ОК**.
1. Выберите вкладку **Общий доступ**, а затем — **Расширенная настройка общего доступа…**
1. Установите флажок **Открыть общий доступ к этой папке**, а затем введите запоминающееся имя для общей папки в поле **Имя общего ресурса**, например *CrossForestShare*.
1. Нажмите кнопку **Разрешения**. В списке **Permissions for Everyone** (Разрешения для всех) щелкните **Разрешить** для разрешения **Изменить**.
1. Нажмите кнопку **ОК** дважды, а затем щелкните **Закрыть**.

#### <a name="validate-cross-forest-authentication-to-a-resource"></a>Проверка аутентификации между лесами для ресурса

1. Войдите в систему на компьютере Windows, присоединенном к локальному домену Active Directory, используя учетную запись пользователя из локальной среды Active Directory.
1. С помощью **проводника** подключитесь к созданной общей папке, используя полное имя узла и общую папку, например `\\fs1.aaddscontoso.com\CrossforestShare`.
1. Чтобы проверить разрешение на запись, щелкните правой кнопкой мыши в папке, выберите команду **Создать**, а затем — пункт **Текстовый документ**. Используйте имя по умолчанию **Новый текстовый документ**.

    Если разрешения на запись заданы правильно, будет создан текстовый документ. Следующие шаги открывают, изменяют и удаляют файл соответствующим образом.
1. Чтобы проверить разрешение на чтение, откройте **Новый текстовый документ**.
1. Чтобы проверить разрешение на изменение, добавьте текст в файл и закройте **Блокнот**. При появлении запроса на сохранение изменений нажмите кнопку **Сохранить**.
1. Чтобы проверить разрешение на удаление, щелкните правой кнопкой мыши **Новый текстовый документ** и выберите команду **Удалить**. Нажмите кнопку **Да** для подтверждения удаления файла.

## <a name="next-steps"></a>Дальнейшие действия

В этом руководстве вы узнали, как выполнять следующие задачи:

> [!div class="checklist"]
> * настройка DNS в локальной среде AD DS для поддержки возможности подключения Azure AD DS;
> * создание одностороннего входящего доверия леса в локальной среде AD DS;
> * создание одностороннего исходящего доверия леса в Azure AD DS;
> * тестирование и проверка отношения доверия для проверки подлинности и доступа к ресурсам.

Дополнительные сведения о типах лесов в Azure AD DS см. в статьях о [лесах ресурсов][concepts-forest] и о том, [как работают доверия леса в Azure AD DS][concepts-trust].

<!-- INTERNAL LINKS -->
[concepts-forest]: concepts-resource-forest.md
[concepts-trust]: concepts-forest-trust.md
[create-azure-ad-tenant]: ../active-directory/fundamentals/sign-up-organization.md
[associate-azure-ad-tenant]: ../active-directory/fundamentals/active-directory-how-subscriptions-associated-directory.md
[create-azure-ad-ds-instance-advanced]: tutorial-create-instance-advanced.md
[howto-change-sku]: change-sku.md
[vpn-gateway]: ../vpn-gateway/vpn-gateway-about-vpngateways.md
[expressroute]: ../expressroute/expressroute-introduction.md
[join-windows-vm]: join-windows-vm.md