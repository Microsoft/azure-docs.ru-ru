---
title: Устранение неполадок доменных служб Azure Active Directory | Документация Майкрософт "
description: Узнайте, как устранять распространенные ошибки при создании доменных служб Azure Active Directory или управлении ими
services: active-directory-ds
author: justinha
manager: daveba
ms.assetid: 4bc8c604-f57c-4f28-9dac-8b9164a0cf0b
ms.service: active-directory
ms.subservice: domain-services
ms.workload: identity
ms.topic: troubleshooting
ms.date: 07/06/2020
ms.author: justinha
ms.openlocfilehash: 89b04f86d41f8e4828580f70a9aec8acea3e0053
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "96618456"
---
# <a name="common-errors-and-troubleshooting-steps-for-azure-active-directory-domain-services"></a>Распространенные ошибки и действия по устранению неполадок для Azure Active Directory доменных служб

В качестве центральной части идентификации и проверки подлинности для приложений Azure Active Directory в доменных службах (Azure AD DS) иногда возникают проблемы. При возникновении проблем возникают некоторые распространенные сообщения об ошибках и связанные действия по устранению неполадок, которые помогут вам снова запустить систему. В любое время можно также [открыть запрос в службу поддержки Azure][azure-support] для получения дополнительных сведений об устранении неполадок.

В этой статье приведены действия по устранению распространенных проблем в Azure AD DS.

## <a name="you-cannot-enable-azure-ad-domain-services-for-your-azure-ad-directory"></a>Не удается включить доменные службы Azure AD для каталога Azure AD

Если у вас возникли проблемы с включением Azure AD DS, ознакомьтесь со следующими распространенными ошибками и действиями по их устранению:

| **Пример сообщения об ошибке** | **Решение** |
| --- |:--- |
| *Имя aaddscontoso.com уже используется в этой сети. Укажите неиспользуемое имя.* |[Конфликт доменных имен в виртуальной сети](troubleshoot.md#domain-name-conflict) |
| *Не удалось включить доменные службы в этом клиенте Azure AD. Служба не имеет достаточных разрешений для приложения с именем "Синхронизация доменных служб Azure AD". Удалите приложение с именем "Синхронизация доменных служб Azure AD" и попытайтесь включить доменные службы для вашего клиента Azure AD.* |[Доменные службы не имеют достаточных разрешений для приложения синхронизации доменных служб Azure AD.](troubleshoot.md#inadequate-permissions) |
| *Не удалось включить доменные службы в этом клиенте Azure AD. Приложение доменных служб в вашем клиенте Azure AD не имеет необходимых разрешений для включения доменных служб. Удалите приложение с идентификатором приложения d87dcbc6-a371-462e-88e3-28ad15ec4e64, а затем попытайтесь включить доменные службы для вашего клиента Azure AD.* |[Приложение доменных служб не настроено должным образом в клиенте Azure AD](troubleshoot.md#invalid-configuration) |
| *Не удалось включить доменные службы в этом клиенте Azure AD. Microsoft Azure ADное приложение отключено в клиенте Azure AD. Включите приложение с идентификатором 00000002-0000-0000-C000-000000000000, а затем попробуйте включить доменные службы для вашего клиента Azure AD.* |[Приложение Microsoft Graph отключено в клиенте Azure AD](troubleshoot.md#microsoft-graph-disabled) |

### <a name="domain-name-conflict"></a>Конфликт доменных имен

**Сообщение об ошибке**

*Имя aaddscontoso.com уже используется в этой сети. Укажите неиспользуемое имя.*

**Решение**

Убедитесь, что у вас нет существующей среды AD DS с тем же доменным именем в том же или в одноранговой виртуальной сети. Например, у вас может быть домен AD DS с именем *aaddscontoso.com* , работающий на виртуальных машинах Azure. При попытке включить управляемый домен AD DS Azure с тем же доменным именем *aaddscontoso.com* в виртуальной сети запрошенная операция завершается ошибкой.

Эта ошибка вызвана конфликтом имен в имени домена в виртуальной сети. Поиск DNS проверяет, отвечает ли существующая среда AD DS на запрошенное доменное имя. Чтобы устранить эту ошибку, используйте другое имя для настройки управляемого домена или отмените наполнение имеющегося домена AD DS и повторите попытку, чтобы включить AD DS Azure.

### <a name="inadequate-permissions"></a>Недостаточно разрешений

**Сообщение об ошибке**

*Не удалось включить доменные службы в этом клиенте Azure AD. Служба не имеет достаточных разрешений для приложения с именем "Синхронизация доменных служб Azure AD". Удалите приложение с именем "Синхронизация доменных служб Azure AD" и попытайтесь включить доменные службы для вашего клиента Azure AD.*

**Решение**

Проверьте, есть ли в каталоге Azure AD приложение с именем " *доменные службы Azure AD* ". Если это приложение существует, удалите его, а затем повторите попытку, чтобы включить AD DS Azure. Чтобы проверить наличие существующего приложения и при необходимости удалить его, выполните следующие действия.

1. На портале Azure в области навигации слева выберите **Azure Active Directory**.
1. Выберите **Корпоративные приложения**. Выберите *Все приложения* в раскрывающемся меню **Тип приложения** и щелкните **Применить**.
1. В поле поиска введите *Sync доменные службы Azure AD*. Если приложение существует, выберите его и нажмите кнопку **Удалить**.
1. После удаления приложения попробуйте снова включить Azure AD DS.

### <a name="invalid-configuration"></a>Недопустимая конфигурация

**Сообщение об ошибке**

*Не удалось включить доменные службы в этом клиенте Azure AD. Приложение доменных служб в вашем клиенте Azure AD не имеет необходимых разрешений для включения доменных служб. Удалите приложение с идентификатором приложения d87dcbc6-a371-462e-88e3-28ad15ec4e64, а затем попытайтесь включить доменные службы для вашего клиента Azure AD.*

**Решение**

Проверьте, есть ли у вас приложение с именем *азуреактиведиректоридомаинконтроллерсервицес* с идентификатором приложения *D87dcbc6-a371-462e-88e3-28ad15ec4e64* в каталоге Azure AD. Если это приложение существует, удалите его и повторите попытку, чтобы включить Azure AD DS.

Используйте следующий сценарий PowerShell для поиска существующего экземпляра приложения и при необходимости удалите его:

```powershell
$InformationPreference = "Continue"
$WarningPreference = "Continue"

$aadDsSp = Get-AzureADServicePrincipal -Filter "AppId eq 'd87dcbc6-a371-462e-88e3-28ad15ec4e64'" -ErrorAction Ignore
if ($aadDsSp -ne $null)
{
    Write-Information "Found Azure AD Domain Services application. Deleting it ..."
    Remove-AzureADServicePrincipal -ObjectId $aadDsSp.ObjectId
    Write-Information "Deleted the Azure AD Domain Services application."
}

$identifierUri = "https://sync.aaddc.activedirectory.windowsazure.com"
$appFilter = "IdentifierUris eq '" + $identifierUri + "'"
$app = Get-AzureADApplication -Filter $appFilter
if ($app -ne $null)
{
    Write-Information "Found Azure AD Domain Services Sync application. Deleting it ..."
    Remove-AzureADApplication -ObjectId $app.ObjectId
    Write-Information "Deleted the Azure AD Domain Services Sync application."
}

$spFilter = "ServicePrincipalNames eq '" + $identifierUri + "'"
$sp = Get-AzureADServicePrincipal -Filter $spFilter
if ($sp -ne $null)
{
    Write-Information "Found Azure AD Domain Services Sync service principal. Deleting it ..."
    Remove-AzureADServicePrincipal -ObjectId $sp.ObjectId
    Write-Information "Deleted the Azure AD Domain Services Sync service principal."
}
```

### <a name="microsoft-graph-disabled"></a>Интерфейс Microsoft Graph отключен

**Сообщение об ошибке**

*Не удалось включить доменные службы в этом клиенте Azure AD. Microsoft Azure ADное приложение отключено в клиенте Azure AD. Включите приложение с идентификатором 00000002-0000-0000-C000-000000000000, а затем попробуйте включить доменные службы для вашего клиента Azure AD.*

**Решение**

Проверьте, отключено ли приложение с идентификатором *00000002-0000-0000-C000-000000000000*. Это приложение Microsoft Azure AD, которое предоставляет доступ к API Graph вашему клиенту Azure AD. Чтобы синхронизировать клиент Azure AD, необходимо включить это приложение.

Чтобы проверить состояние этого приложения и включить его при необходимости, выполните следующие действия.

1. На портале Azure в области навигации слева выберите **Azure Active Directory**.
1. Выберите **Корпоративные приложения**. Выберите *Все приложения* в раскрывающемся меню **Тип приложения** и щелкните **Применить**.
1. В поле поиска введите *00000002-0000-0000-C000-00000000000*. Выберите приложение, а затем щелкните **Свойства**.
1. Если параметр **включен для пользователей при входе** в систему установлен в значение *нет*, задайте для параметра *Да*, а затем нажмите кнопку **сохранить**.
1. После включения приложения попробуйте снова включить Azure AD DS.

## <a name="users-are-unable-to-sign-in-to-the-azure-ad-domain-services-managed-domain"></a>Пользователи не могут войти в домен, находящийся под управлением доменных служб Azure AD

Если один или несколько пользователей в клиенте Azure AD не могут войти в управляемый домен, выполните следующие действия по устранению неполадок:

* **Формат учетных данных** — попробуйте использовать формат имени участника-пользователя, чтобы указать учетные данные, например `dee@aaddscontoso.onmicrosoft.com` . Формат UPN — это рекомендуемый способ указания учетных данных в AD DS Azure. Убедитесь, что имя участника-пользователя правильно настроено в Azure AD.

    *SamAccountName* для вашей учетной записи, например *ааддсконтосо\дрилэй* , может быть автоматически создан, если в клиенте есть несколько пользователей с одним префиксом имени участника-пользователя или если префикс UPN слишком длинный. Поэтому формат *SamAccountName* для вашей учетной записи может отличаться от предполагаемого или используемого в локальном домене.

* **Синхронизация паролей** . Убедитесь, что вы включили синхронизацию паролей [только для облачных пользователей][cloud-only-passwords] или [гибридных сред, использующих Azure AD Connect][hybrid-phs].
    * **Гибридные синхронизированные учетные записи:** Если затронутые учетные записи пользователей синхронизируются из локального каталога, проверьте следующие области.
    
      * Вы развернули или обновили [последнюю рекомендуемую версию Azure AD Connect](https://www.microsoft.com/download/details.aspx?id=47594).
      * Вы настроили Azure AD Connect для [выполнения полной синхронизации][hybrid-phs].
      * В зависимости от размера каталога может потребоваться некоторое время, чтобы учетные записи пользователей и хэши учетных данных были доступны в управляемом домене. Прежде чем пытаться пройти проверку подлинности в управляемом домене, убедитесь в наличии достаточного времени.
      * Если проблема сохраняется после проверки предыдущих шагов, попробуйте перезапустить *службу синхронизации Microsoft Azure AD*. На сервере Azure AD Connect откройте командную строку и выполните следующие команды:
    
        ```console
        net stop 'Microsoft Azure AD Sync'
        net start 'Microsoft Azure AD Sync'
        ```

    * **Учетные записи только для облака**. Если затронутая учетная запись пользователя является облачной учетной записью пользователя, убедитесь, что [пользователь изменил пароль после включения Azure AD DS][cloud-only-passwords]. Этот сброс пароля вызывает создание необходимых хэшей учетных данных для управляемого домена.

* **Убедитесь, что учетная запись пользователя активна**: по умолчанию пять недопустимых попыток ввода пароля в течение 2 минут в управляемом домене приводят к блокировке учетной записи пользователя в течение 30 минут. Пользователь не может войти в систему, пока учетная запись заблокирована. Через 30 минут учетная запись пользователя автоматически разблокируется.
  * Недопустимые попытки ввода пароля в управляемом домене не блокируют учетную запись пользователя в Azure AD. Учетная запись пользователя заблокирована только в управляемом домене. Проверьте состояние учетной записи пользователя в *консоли администрирования Active Directory (ADAC)* с помощью [виртуальной машины управления][management-vm], а не в Azure AD.
  * Можно также [настроить точные политики паролей][password-policy] , чтобы изменить порог и длительность блокировки по умолчанию.

* **Внешние учетные записи** . Убедитесь, что затронутая учетная запись пользователя не является внешней учетной записью в клиенте Azure AD. Примеры внешних учетных записей включают учетные записи Майкрософт, такие как `dee@live.com` или учетные записи пользователей из внешнего каталога Azure AD. AD DS Azure не сохраняет учетные данные для внешних учетных записей пользователей, поэтому они не могут войти в управляемый домен.

## <a name="there-are-one-or-more-alerts-on-your-managed-domain"></a>Имеется одно или несколько оповещений для управляемого домена

Если в управляемом домене есть активные предупреждения, это может препятствовать правильной работе процесса проверки подлинности.

Чтобы узнать, есть ли активные предупреждения, [Проверьте состояние работоспособности управляемого домена][check-health]. Если отображаются предупреждения, [устраните неполадки и устраните их][troubleshoot-alerts].

## <a name="users-removed-from-your-azure-ad-tenant-are-not-removed-from-your-managed-domain"></a>Пользователи, удаленные из вашего клиента Azure AD, не удаляются из управляемого домена

Azure AD защищает от случайного удаления объектов пользователей. При удалении учетной записи пользователя из клиента Azure AD соответствующий объект пользователя перемещается в корзину. При синхронизации этой операции удаления с управляемым доменом соответствующая учетная запись пользователя помечается как отключенная. Эта функция помогает восстановить или отменить удаление учетной записи пользователя.

Учетная запись пользователя остается в отключенном состоянии в управляемом домене, даже если вы повторно создаете учетную запись пользователя с тем же именем участника-пользователя в каталоге Azure AD. Чтобы удалить учетную запись пользователя из управляемого домена, необходимо принудительно удалить ее из клиента Azure AD.

Чтобы полностью удалить учетную запись пользователя из управляемого домена, удалите пользователя из клиента Azure AD с помощью командлета PowerShell [Remove-MsolUser][Remove-MsolUser] с `-RemoveFromRecycleBin` параметром.

## <a name="next-steps"></a>Дальнейшие действия

Если проблемы продолжают возникать, отправьте [запрос в службу поддержки Azure][azure-support] для получения дополнительных сведений об устранении неполадок.

<!-- INTERNAL LINKS -->
[cloud-only-passwords]: tutorial-create-instance.md#enable-user-accounts-for-azure-ad-ds
[hybrid-phs]: tutorial-configure-password-hash-sync.md
[management-vm]: tutorial-create-management-vm.md
[password-policy]: password-policy.md
[check-health]: check-health.md
[troubleshoot-alerts]: troubleshoot-alerts.md
[Remove-MsolUser]: /powershell/module/MSOnline/Remove-MsolUser
[azure-support]: ../active-directory/fundamentals/active-directory-troubleshooting-support-howto.md
