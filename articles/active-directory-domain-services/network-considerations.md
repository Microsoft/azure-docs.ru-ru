---
title: Планирование сети и подключения для доменных служб Azure AD | Документация Майкрософт
description: Сведения о некоторых аспектах проектирования виртуальной сети и ресурсы, используемые для подключения при запуске Azure Active Directory доменных служб.
services: active-directory-ds
author: justinha
manager: daveba
ms.service: active-directory
ms.subservice: domain-services
ms.workload: identity
ms.topic: conceptual
ms.date: 12/16/2020
ms.author: justinha
ms.openlocfilehash: d1a3ab5face03754bf84f442ac0fa73768b0fc80
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "97615824"
---
# <a name="virtual-network-design-considerations-and-configuration-options-for-azure-active-directory-domain-services"></a>Рекомендации по проектированию виртуальной сети и параметры конфигурации для доменных служб Azure Active Directory

Azure Active Directory доменных служб (Azure AD DS) предоставляет службы проверки подлинности и управления для других приложений и рабочих нагрузок. Сетевое подключение является ключевым компонентом. Без правильно настроенных ресурсов виртуальной сети приложения и рабочие нагрузки не могут взаимодействовать с функциями, предоставляемыми AD DS Azure, и использовать их. Спланируйте требования к виртуальной сети, чтобы служба Azure AD DS могла обслуживать ваши приложения и рабочие нагрузки по мере необходимости.

В этой статье описываются рекомендации по проектированию и требования к виртуальной сети Azure для поддержки AD DS Azure.

## <a name="azure-virtual-network-design"></a>Структура виртуальной сети Azure

Чтобы обеспечить сетевое подключение и разрешить приложениям и службам проходить проверку подлинности в управляемом домене Azure AD DS, вы используете виртуальную сеть и подсеть Azure. В идеале управляемый домен следует развертывать в собственной виртуальной сети.

Вы можете включить отдельную подсеть приложения в ту же виртуальную сеть для размещения рабочих нагрузок управления или узлов с небольшими приложениями. Отдельная виртуальная сеть для больших или сложных рабочих нагрузок приложений, которая является одноранговой для виртуальной сети Azure AD DS, обычно является наиболее подходящей.

Другие варианты разработки являются допустимыми, при условии соблюдения требований, описанных в следующих разделах для виртуальной сети и подсети.

При проектировании виртуальной сети для AD DS Azure необходимо учитывать следующие моменты.

* AD DS Azure необходимо развернуть в том же регионе Azure, что и виртуальная сеть.
    * В настоящее время можно развернуть только один управляемый домен для каждого клиента Azure AD. Управляемый домен развертывается в одном регионе. Убедитесь, что вы создали или выбрали виртуальную сеть в [регионе, который поддерживает Azure AD DS](https://azure.microsoft.com/global-infrastructure/services/?products=active-directory-ds&regions=all).
* Рассмотрите сходство с другими регионами Azure и виртуальными сетями, в которых размещаются рабочие нагрузки приложений.
    * Чтобы свести к сведению задержку, не закрывайте основные приложения или в том же регионе, что и подсеть виртуальной сети для управляемого домена. Вы можете использовать пиринг виртуальных сетей или виртуальные частные сети (VPN) между виртуальными сетями Azure. Эти параметры подключения обсуждаются в следующем разделе.
* Виртуальная сеть не может полагаться на службы DNS, отличные от служб, предоставляемых управляемым доменом.
    * Azure AD DS предоставляет собственную службу DNS. Виртуальная сеть должна быть настроена для использования этих адресов службы DNS. Разрешение имен для дополнительных пространств имен можно выполнить с помощью условных серверов пересылки.
    * Нельзя использовать настраиваемые параметры DNS-сервера для направления запросов с других DNS-серверов, включая виртуальные машины. Ресурсы в виртуальной сети должны использовать службу DNS, предоставляемую управляемым доменом.

> [!IMPORTANT]
> После включения службы вы не сможете переместить AD DS Azure в другую виртуальную сеть.

Управляемый домен подключается к подсети в виртуальной сети Azure. Разработайте эту подсеть для Azure AD DS со следующими соображениями:

* Управляемый домен должен быть развернут в своей подсети. Не используйте существующую подсеть или подсеть шлюза.
* Группа безопасности сети создается во время развертывания управляемого домена. Эта группа безопасности сети содержит необходимые правила для правильного взаимодействия служб.
    * Не создавайте и не используйте существующую группу безопасности сети с собственными настраиваемыми правилами.
* Для управляемого домена требуется 3-5 IP-адресов. Убедитесь, что диапазон IP-адресов подсети может предоставлять такое количество адресов.
    * Запрет доступных IP-адресов может помешать управляемому домену поддерживать два контроллера домена.

На следующем примере диаграммы показана допустимая структура, в которой управляемый домен имеет собственную подсеть, есть подсеть шлюза для внешнего подключения, а рабочие нагрузки приложения находятся в подключенной подсети в виртуальной сети.

![Рекомендуемая конфигурация подсетей](./media/active-directory-domain-services-design-guide/vnet-subnet-design.png)

## <a name="connections-to-the-azure-ad-ds-virtual-network"></a>Подключения к виртуальной сети Azure AD DS

Как отмечалось в предыдущем разделе, можно создать только управляемый домен в одной виртуальной сети в Azure, а для каждого клиента Azure AD можно создать только один управляемый домен. На основе этой архитектуры может потребоваться подключить одну или несколько виртуальных сетей, в которых размещаются рабочие нагрузки приложений, в виртуальную сеть управляемого домена.

Вы можете подключить рабочие нагрузки приложений, размещенные в других виртуальных сетях Azure, с помощью одного из следующих методов:

* Пиринг между виртуальными сетями
* Виртуальная частная сеть (VPN)

### <a name="virtual-network-peering"></a>Пиринг между виртуальными сетями

Пиринговая связь между виртуальными сетями — это механизм подключения между двумя виртуальными сетями, находящимися в одном регионе, через магистральную сеть Azure. Глобальный пиринг виртуальных сетей может подключать виртуальную сеть между регионами Azure. После пиринга эти две виртуальные сети позволяют ресурсам, таким как виртуальные машины, взаимодействовать друг с другом напрямую, используя частные IP-адреса. Использование пиринга виртуальных сетей позволяет развертывать управляемый домен с рабочими нагрузками приложений, развернутыми в других виртуальных сетях.

![Подключение к виртуальной сети с помощью пиринга](./media/active-directory-domain-services-design-guide/vnet-peering.png)

Дополнительные сведения см. в статье [Общие сведения об пиринга в виртуальной сети Azure](../virtual-network/virtual-network-peering-overview.md).

### <a name="virtual-private-networking-vpn"></a>Виртуальная частная сеть (VPN)

Виртуальную сеть можно подключить к другой виртуальной сети (VNet-to-VNet) точно так же, как можно настроить виртуальную сеть на расположение локального сайта. Оба подключения используют VPN-шлюз для создания защищенного туннеля с помощью IPsec/IKE. Эта модель подключения позволяет развернуть управляемый домен в виртуальной сети Azure, а затем подключить локальные расположения или другие облака.

![Подключение к виртуальной сети с помощью VPN-шлюза](./media/active-directory-domain-services-design-guide/vnet-connection-vpn-gateway.jpg)

Дополнительные сведения об использовании виртуальных частных сетей см. [в статье Настройка подключения VPN-шлюза](../vpn-gateway/vpn-gateway-howto-vnet-vnet-resource-manager-portal.md)между виртуальными сетями с помощью портал Azure.

## <a name="name-resolution-when-connecting-virtual-networks"></a>Разрешение имен при подключении виртуальных сетей

Виртуальные сети, подключенные к виртуальной сети управляемого домена, обычно имеют собственные параметры DNS. При подключении виртуальных сетей автоматически не настраивается разрешение имен для подключения виртуальной сети для разрешения служб, предоставляемых управляемым доменом. Разрешение имен в подключенных виртуальных сетях должно быть настроено, чтобы рабочие нагрузки приложений настроили управляемый домен.

Разрешение имен можно включить с помощью условных серверов пересылки DNS на DNS-сервере, поддерживающем подключение виртуальных сетей, или с помощью тех же IP-адресов DNS из виртуальной сети управляемого домена.

## <a name="network-resources-used-by-azure-ad-ds"></a>Сетевые ресурсы, используемые AD DS Azure

Управляемый домен создает некоторые сетевые ресурсы во время развертывания. Эти ресурсы необходимы для успешной работы и управления управляемым доменом и не должны настраиваться вручную.

| Ресурс Azure                          | Описание |
|:----------------------------------------|:---|
| Сетевая карта                  | Azure AD DS размещает управляемый домен на двух контроллерах домена (DCs), работающих на Windows Server, как виртуальные машины Azure. У каждой виртуальной машины есть виртуальный сетевой интерфейс, который подключается к подсети виртуальной сети. |
| Динамический Стандартный общедоступный IP-адрес      | Azure AD DS взаимодействует со службой синхронизации и управления, используя общедоступный IP-адрес стандартного SKU. Дополнительные сведения об общедоступных IP- [адресах см. в статье типы IP-адресов и методы распределения в Azure](../virtual-network/public-ip-addresses.md). |
| Балансировщик нагрузки Azure уровня "Стандартный"            | AD DS Azure использует балансировщик нагрузки стандартного SKU для преобразования сетевых адресов (NAT) и балансировки нагрузки (при использовании с защищенным протоколом LDAP). Дополнительные сведения о подсистемах балансировки нагрузки Azure см. в разделе [что такое Azure Load Balancer?](../load-balancer/load-balancer-overview.md) |
| Правила преобразования сетевых адресов (NAT) | Azure AD DS создает и использует три правила NAT в подсистеме балансировки нагрузки — одно правило для безопасного трафика HTTP и два правила защиты удаленного взаимодействия PowerShell. |
| Правила балансировщика нагрузки                     | Если управляемый домен настроен для защищенного протокола LDAP через TCP-порт 636, то для распределения трафика создаются и используются три правила подсистемы балансировки нагрузки. |

> [!WARNING]
> Не удаляйте или не изменяйте сетевой ресурс, созданный AD DS Azure, например вручную настроив подсистему балансировки нагрузки или правила. При удалении или изменении любых сетевых ресурсов может произойти сбой службы AD DS Azure.

## <a name="network-security-groups-and-required-ports"></a>Группы безопасности сети и требуемые порты

[Группа безопасности сети](../virtual-network/network-security-groups-overview.md) содержит перечень правил, которые разрешают или запрещают передачу трафика в виртуальную сеть Azure. Группа безопасности сети создается при развертывании управляемого домена, содержащего набор правил, которые позволяют службе использовать функции проверки подлинности и управления. Эта группа безопасности сети по умолчанию связана с подсетью виртуальной сети, в которой развернут управляемый домен.

Для обеспечения проверки подлинности и управления в управляемом домене требуются следующие правила группы безопасности сети. Не изменяйте и не удаляйте эти правила группы безопасности сети для подсети виртуальной сети, в которой развернут управляемый домен.

| Номер порта | Протокол | Источник                             | Назначение | Действие | Обязательно | Назначение |
|:-----------:|:--------:|:----------------------------------:|:-----------:|:------:|:--------:|:--------|
| 5986        | TCP      | AzureActiveDirectoryDomainServices | Любой         | Allow  | Да      | Управление доменом. |
| 3389        | TCP      | CorpNetSaw                         | Любой         | Allow  | Необязательно      | Отладка для поддержки. |

Будет создана стандартная подсистема балансировки нагрузки Azure, для работы которой должны действовать эти правила. Эта группа безопасности сети защищает Azure AD DS и требуется для правильной работы управляемого домена. Не удаляйте эту группу безопасности сети. Балансировщик нагрузки не будет правильно работать без него.

При необходимости можно [создать необходимую группу безопасности сети и правила с помощью Azure PowerShell](powershell-create-instance.md#create-a-network-security-group).

> [!WARNING]
> Не изменяйте эти сетевые ресурсы и конфигурации вручную. При связывании неправильно настроенной группы безопасности сети или определяемой пользователем таблицы маршрутов с подсетью, в которой развернут управляемый домен, может нарушиться способность корпорации Майкрософт обслуживать домен и управлять им. Синхронизация между клиентом Azure AD и управляемым доменом также нарушена.
>
> При использовании защищенного протокола LDAP можно добавить необходимое правило TCP-порта 636, чтобы разрешить внешний трафик при необходимости. Добавление этого правила не помещает правила группы безопасности сети в неподдерживаемое состояние. Дополнительные сведения см. [в разделе Блокировка защищенного доступа LDAP через Интернет](tutorial-configure-ldaps.md#lock-down-secure-ldap-access-over-the-internet) .
>
> Для группы безопасности сети также существуют правила по умолчанию для *алловвнетинбаунд*, *алловазурелоадбаланцеринбаунд*, *деняллинбаунд*, *алловвнетаутбаунд*, *AllowInternetOutBound* и *DenyAllOutBound* . Не изменяйте или не удаляйте эти правила по умолчанию.
>
> Соглашение об уровне обслуживания Azure не применяется к развертываниям, в которых были применены неправильно настроенные группы безопасности сети и/или определяемые пользователем таблицы маршрутов, которые блокируют AD DS Azure для обновления домена и управления им.

### <a name="port-5986---management-using-powershell-remoting"></a>Порт 5986 — управление с помощью удаленного взаимодействия PowerShell

* Используется для выполнения задач управления с помощью удаленного взаимодействия PowerShell в управляемом домене.
* Без доступа к этому порту управляемый домен нельзя обновлять, настраивать, архивировать или отслеживать.
* Для управляемых доменов, использующих виртуальную сеть на основе диспетчер ресурсов, можно ограничить входящий доступ к этому порту с помощью тега службы *азуреактиведиректоридомаинсервицес* .
    * Для управляемых доменов прежних версий с использованием классической виртуальной сети можно ограничить входящий доступ к этому порту по следующим исходным IP-адресам: *52.180.183.8*, *23.101.0.70*, *52.225.184.198*, *52.179.126.223*, *13.74.249.156*, *52.187.117.83*, *52.161.13.95*, *104.40.156.18* и *104.40.87.209*.

    > [!NOTE]
    > В 2017 доменные службы Azure AD стали доступны для размещения в Azure Resource Manager сети. С тех пор мы смогли создать более безопасную службу с помощью современных возможностей Azure Resource Manager. Поскольку Azure Resource Manager развертывания полностью заменяют классические развертывания, развертывание классической виртуальной сети Azure AD DS будет прекращено 1 марта 2023 г.
    >
    > Дополнительные сведения см. в [официальном](https://azure.microsoft.com/updates/we-are-retiring-azure-ad-domain-services-classic-vnet-support-on-march-1-2023/) объявлении об устаревании.

### <a name="port-3389---management-using-remote-desktop"></a>Порт 3389 — управление с помощью удаленного рабочего стола

* Используется для подключений удаленного рабочего стола к контроллерам домена в управляемом домене.
* Правило группы безопасности сети по умолчанию использует тег службы *корпнетсав* для дальнейшего ограничения трафика.
    * Этот тег службы позволяет использовать удаленный рабочий стол только на рабочих станциях с защищенным доступом к управляемому домену в корпоративной сети корпорации Майкрософт.
    * Доступ разрешен только с бизнес-обоснованием, например для сценариев управления или устранения неполадок.
* Этому правилу можно присвоить значение *Deny* и *задать значение только при необходимости* . Большинство задач по управлению и мониторингу выполняются с помощью удаленного взаимодействия PowerShell. Протокол RDP используется только в редких случаях, когда корпорации Майкрософт требуется удаленное подключение к управляемому домену для расширенного устранения неполадок.

> [!NOTE]
> Вы не можете вручную выбрать тег службы *корпнетсав* на портале, если попытаться изменить это правило группы безопасности сети. Для ручной настройки правила, использующего тег службы *корпнетсав* , необходимо использовать Azure PowerShell или Azure CLI.
>
> Например, с помощью следующего скрипта можно создать правило, разрешающее RDP: 
>
> `Get-AzureRmNetworkSecurityGroup -Name "nsg-name" -ResourceGroupName "resource-group-name" | Add-AzureRmNetworkSecurityRuleConfig -Name "new-rule-name" -Access "Allow" -Protocol "TCP" -Direction "Inbound" -Priority "priority-number" -SourceAddressPrefix "CorpNetSaw" -SourcePortRange "" -DestinationPortRange "3389" -DestinationAddressPrefix "" | Set-AzureRmNetworkSecurityGroup`

## <a name="user-defined-routes"></a>Определяемые пользователем маршруты

Определяемые пользователем маршруты не создаются по умолчанию и не нужны для правильной работы Azure AD DS. Если требуется использовать таблицы маршрутов, не следует вносить никаких изменений в маршрут *0.0.0.0* . Изменения в этом маршруте принарушат работу Azure AD DS и переводит управляемый домен в неподдерживаемое состояние.

Кроме того, необходимо направить входящий трафик с IP-адресов, входящих в соответствующие теги службы Azure, в подсеть управляемого домена. Дополнительные сведения о тегах служб и связанных с ними IP-адресах см. в разделе [диапазоны IP-адресов Azure и теги службы — общедоступное облако](https://www.microsoft.com/en-us/download/details.aspx?id=56519).

> [!CAUTION]
> Эти диапазоны IP-адресов центра обработки данных Azure могут измениться без предварительного уведомления. Убедитесь, что у вас есть процессы для проверки наличия последних IP-адресов.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о некоторых сетевых ресурсах и вариантах подключения, используемых AD DS Azure, см. в следующих статьях:

* [Пиринг виртуальных сетей Azure](../virtual-network/virtual-network-peering-overview.md)
* [VPN-шлюзы Azure](../vpn-gateway/vpn-gateway-about-vpn-gateway-settings.md)
* [Группы безопасности сети Azure](../virtual-network/network-security-groups-overview.md)