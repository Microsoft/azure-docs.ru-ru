---
title: Ограниченное делегирование Kerberos для доменных служб Azure AD | Документация Майкрософт
description: Узнайте, как включить ограниченное делегирование Kerberos на основе ресурсов (KCD) в управляемом домене доменных служб Azure Active Directory.
services: active-directory-ds
author: justinha
manager: daveba
ms.assetid: 938a5fbc-2dd1-4759-bcce-628a6e19ab9d
ms.service: active-directory
ms.subservice: domain-services
ms.workload: identity
ms.topic: how-to
ms.date: 07/06/2020
ms.author: justinha
ms.openlocfilehash: 138b90a33ff1dbc4b014f17fa0098112e1da66e4
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "96619782"
---
# <a name="configure-kerberos-constrained-delegation-kcd-in-azure-active-directory-domain-services"></a>Настройка ограниченного делегирования Kerberos (KCD) в доменных службах Azure Active Directory

При запуске приложений может потребоваться, чтобы эти приложения могли обращаться к ресурсам в контексте другого пользователя. Домен Active Directory Services (AD DS) поддерживает механизм, именуемый *делегированием Kerberos* , который позволяет использовать этот вариант. Затем *ограниченное* делегирование Kerberos (KCD) создает этот механизм для определения определенных ресурсов, к которым можно получить доступ в контексте пользователя.

Azure Active Directory управляемые домены доменных служб (Azure AD DS) более безопасно заблокированы, чем традиционные локальные среды AD DS, поэтому используйте более безопасные KCD *на основе ресурсов* .

В этой статье показано, как настроить ограниченное делегирование Kerberos на основе ресурсов в управляемом домене Azure AD DS.

## <a name="prerequisites"></a>Предварительные требования

Для работы с этой статьей требуются следующие ресурсы:

* Активная подписка Azure.
    * Если у вас еще нет подписки Azure, [создайте учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F).
* Связанный с вашей подпиской клиент Azure Active Directory, синхронизированный с локальным или облачным каталогом.
    * Если потребуется, [создайте клиент Azure Active Directory][create-azure-ad-tenant] или [свяжите подписку Azure со своей учетной записью][associate-azure-ad-tenant].
* Управляемый домен доменных служб Azure Active Directory, включенный и настроенный в клиенте Azure AD.
    * При необходимости [создайте и настройте управляемый домен доменных служб Azure Active Directory][create-azure-ad-ds-instance].
* Виртуальная машина управления Windows Server, присоединенная к управляемому домену AD DS Azure.
    * При необходимости выполните инструкции из руководства по [созданию виртуальной машины Windows Server и ее присоединению к управляемому домену][create-join-windows-vm] , а затем [установите средства управления AD DS][tutorial-create-management-vm].
* Учетная запись пользователя, входящая в группу *администраторов Azure AD DC* в клиенте Azure AD.

## <a name="kerberos-constrained-delegation-overview"></a>Общие сведения о ограниченном делегировании Kerberos

Делегирование Kerberos позволяет одной учетной записи олицетворять другую учетную запись для доступа к ресурсам. Например, веб-приложение, которое обращается к внутреннему веб-компоненту, может олицетворять себя как учетную запись другого пользователя, когда она делает внутренним подключением. Делегирование Kerberos является небезопасным, так как не ограничивает ресурсы, к которым может получить доступ олицетворенная учетная запись.

*Ограниченное* делегирование Kerberos (KCD) ограничивает службы или ресурсы, к которым может подключаться указанный сервер или приложение при олицетворении другого удостоверения. Традиционные KCD требуются права администратора домена для настройки учетной записи домена для службы и ограничивают учетную запись для запуска в одном домене.

В традиционных KCD также есть несколько проблем. Например, в более ранних операционных системах администратор служб не имел удобного способа выяснить, какие из интерфейсных служб делегируются службам ресурсов, которыми они владеют. Любая интерфейсная служба, которая может делегировать службу ресурсов, является потенциальной точкой атаки. Если сервер, на котором размещена интерфейсная служба, настроенная для делегирования служб ресурсов, был скомпрометирован, то службы ресурсов также могут быть скомпрометированы.

В управляемом домене отсутствуют права администратора домена. В результате традиционная KCD на основе учетных записей не может быть настроена в управляемом домене. Вместо этого можно использовать KCD на основе ресурсов, что также является более безопасным.

### <a name="resource-based-kcd"></a>Ограниченное делегирование Kerberos на основе ресурсов

Windows Server 2012 и более поздних версий дает администраторам служб возможность настроить ограниченное делегирование для своей службы. Такая модель называется ограниченным делегированием Kerberos на основе ресурсов. При таком подходе администратор серверной службы может разрешить или запретить определенным интерфейсным службам использовать KCD.

KCD на основе ресурсов настраивается с помощью PowerShell. Используйте командлеты [Set-ADComputer][Set-ADComputer] или [Set-ADUser][Set-ADUser] в зависимости от того, является ли учетная запись олицетворения учетной записью компьютера или учетной записью пользователя или службы.

## <a name="configure-resource-based-kcd-for-a-computer-account"></a>Настройка KCD на основе ресурсов для учетной записи компьютера

В этом сценарии предположим, что у вас есть веб-приложение, которое выполняется на компьютере с именем *contoso-webapp.aaddscontoso.com*.

Веб-приложению необходимо получить доступ к веб-API, который выполняется на компьютере с именем *contoso-API.aaddscontoso.com* в контексте пользователей домена.

Чтобы настроить этот сценарий, выполните следующие действия.

1. [Создайте настраиваемое подразделение](create-ou.md). Вы можете делегировать разрешения, чтобы управлять настраиваемым подразделением пользователей в управляемом домене.
1. Присоедините к управляемому домену [виртуальные машины][create-join-windows-vm], которые запускают веб-приложение, и те, которые запускают веб-API. Создайте учетные записи этих компьютеров в пользовательском подразделении из предыдущего шага.

    > [!NOTE]
    > Учетные записи компьютеров для веб-приложения и веб-API должны находиться в настраиваемом подразделении, где имеются разрешения на настройку KCD на основе ресурсов. Невозможно настроить KCD на основе ресурсов для учетной записи компьютера во встроенном контейнере " *Компьютеры AAD DC* ".

1. Наконец, настройте KCD на основе ресурсов с помощью командлета PowerShell [Set-ADComputer][Set-ADComputer] .

    На виртуальной машине управления, присоединенной к домену, и войдите в систему под учетной записью пользователя, которая является членом группы *администраторов контроллера домена Azure AD* , выполните следующие командлеты. При необходимости укажите собственные имена компьютеров:
    
    ```powershell
    $ImpersonatingAccount = Get-ADComputer -Identity contoso-webapp.aaddscontoso.com
    Set-ADComputer contoso-api.aaddscontoso.com -PrincipalsAllowedToDelegateToAccount $ImpersonatingAccount
    ```

## <a name="configure-resource-based-kcd-for-a-user-account"></a>Настройка KCD на основе ресурсов для учетной записи пользователя

В этом сценарии предположим, что у вас есть веб-приложение, запускаемое как учетная запись службы с именем *appsvc*. Веб-приложению необходимо получить доступ к веб-API, который выполняется как учетная запись службы с именем *баккендсвк* в контексте пользователей домена. Чтобы настроить этот сценарий, выполните следующие действия.

1. [Создайте настраиваемое подразделение](create-ou.md). Вы можете делегировать разрешения, чтобы управлять настраиваемым подразделением пользователей в управляемом домене.
1. [Присоединение к домену виртуальных машин][create-join-windows-vm] , на которых выполняется серверный веб-API или ресурс, в управляемый домен. Создайте учетную запись компьютера в настраиваемом подразделении.
1. Создайте учетную запись службы (например, *appsvc*), используемую для запуска веб-приложения в настраиваемом подразделении.

    > [!NOTE]
    > Опять же, учетная запись компьютера для виртуальной машины веб-API и учетная запись службы для веб-приложения должны быть в настраиваемом подразделении, где у вас есть разрешения на настройку KCD на основе ресурсов. Нельзя настроить KCD на основе ресурсов для учетных записей во встроенных *доменах AAD DC* или в контейнерах *пользователей AAD DC* . Это также означает, что вы не можете использовать учетные записи пользователей, синхронизированные из Azure AD, чтобы настроить KCD на основе ресурсов. Необходимо создать и использовать учетные записи служб, созданные специально в Azure AD DS.

1. Наконец, настройте KCD на основе ресурсов с помощью командлета PowerShell [Set-ADUser][Set-ADUser] .

    На виртуальной машине управления, присоединенной к домену, и войдите в систему под учетной записью пользователя, которая является членом группы *администраторов контроллера домена Azure AD* , выполните следующие командлеты. При необходимости укажите собственные имена служб:

    ```powershell
    $ImpersonatingAccount = Get-ADUser -Identity appsvc
    Set-ADUser backendsvc -PrincipalsAllowedToDelegateToAccount $ImpersonatingAccount
    ```

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о работе делегирования в домен Active Directory Services см. в разделе [Общие сведения о ограниченном делегировании Kerberos][kcd-technet].

<!-- INTERNAL LINKS -->
[create-azure-ad-tenant]: ../active-directory/fundamentals/sign-up-organization.md
[associate-azure-ad-tenant]: ../active-directory/fundamentals/active-directory-how-subscriptions-associated-directory.md
[create-azure-ad-ds-instance]: tutorial-create-instance.md
[create-join-windows-vm]: join-windows-vm.md
[tutorial-create-management-vm]: tutorial-create-management-vm.md
[Set-ADComputer]: /powershell/module/addsadministration/set-adcomputer
[Set-ADUser]: /powershell/module/addsadministration/set-aduser

<!-- EXTERNAL LINKS -->
[kcd-technet]: /previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj553400(v=ws.11)