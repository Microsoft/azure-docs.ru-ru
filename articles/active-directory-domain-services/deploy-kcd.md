---
title: Ограниченное делегирование Kerberos для доменных служб Azure AD | Документация Майкрософт
description: Узнайте, как включить ограниченное делегирование Kerberos (KCD) на основе ресурсов в управляемом домене доменных служб Azure Active Directory.
services: active-directory-ds
author: justinha
manager: daveba
ms.assetid: 938a5fbc-2dd1-4759-bcce-628a6e19ab9d
ms.service: active-directory
ms.subservice: domain-services
ms.workload: identity
ms.topic: how-to
ms.date: 07/06/2020
ms.author: justinha
ms.openlocfilehash: 138b90a33ff1dbc4b014f17fa0098112e1da66e4
ms.sourcegitcommit: f28ebb95ae9aaaff3f87d8388a09b41e0b3445b5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/29/2021
ms.locfileid: "96619782"
---
# <a name="configure-kerberos-constrained-delegation-kcd-in-azure-active-directory-domain-services"></a>Настройка ограниченного делегирования Kerberos (KCD) в доменных службах Azure Active Directory

Запускаемым приложениям иногда требуется доступ к ресурсам в контексте другого пользователя. Доменные службы Active Directory (AD DS) поддерживают механизм под названием *делегирование Kerberos*, который позволяет удовлетворить эту потребность. *Ограниченное* делегирование Kerberos (KCD) использует этот механизм, чтобы задать конкретные ресурсы, к которым можно получить доступ в контексте пользователя.

Управляемые домены доменных служб Azure Active Directory (Azure AD DS) изолированы более надежно, чем традиционные локальные среды AD DS, поэтому используйте более безопасное ограниченное делегирование Kerberos *на основе ресурсов*.

В этой статье показано, как настроить ограниченное делегирование Kerberos на основе ресурсов в управляемом домене Azure AD DS.

## <a name="prerequisites"></a>Предварительные требования

Для работы с этой статьей требуются следующие ресурсы:

* Активная подписка Azure.
    * Если у вас еще нет подписки Azure, [создайте учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F).
* Связанный с вашей подпиской клиент Azure Active Directory, синхронизированный с локальным или облачным каталогом.
    * Если потребуется, [создайте клиент Azure Active Directory][create-azure-ad-tenant] или [свяжите подписку Azure со своей учетной записью][associate-azure-ad-tenant].
* Управляемый домен доменных служб Azure Active Directory, включенный и настроенный в клиенте Azure AD.
    * При необходимости [создайте и настройте управляемый домен доменных служб Azure Active Directory][create-azure-ad-ds-instance].
* Виртуальная машина управления на базе Windows Server, присоединенная к управляемому домену Azure AD DS.
    * При необходимости выполните инструкции из руководства по [созданию виртуальной машины Windows Server и ее присоединению к управляемому домену][create-join-windows-vm], а затем [установите средства управления AD DS][tutorial-create-management-vm].
* Учетная запись пользователя, входящая в группу *администраторов Azure AD DC* в клиенте Azure AD.

## <a name="kerberos-constrained-delegation-overview"></a>Обзор ограниченного делегирования Kerberos

С помощью делегирования Kerberos одна учетная запись может выдать себя за другую для доступа к ресурсам. Например, веб-приложение, которое обращается к серверному веб-компоненту, может выдать себя за учетную запись другого пользователя при подключении к серверу. Делегирование Kerberos небезопасно, так как не ограничивает ресурсы, к которым может получить доступ учетная запись, олицетворяющая другую.

*Ограниченное* делегирование Kerberos (KCD) сокращает набор служб или ресурсов, к которым может подключаться конкретный сервер или приложение при олицетворении другого удостоверения. Традиционному KCD требуются привилегии администратора домена, чтобы настроить для службы учетную запись домена. Возможности применения этой учетной записи ограничены одним доменом.

У традиционных KCD есть еще несколько проблем. Например, в более ранних версиях операционных систем у администратора служб не было возможности узнать, какие интерфейсные службы делегируются службам ресурсов, владельцем которых он является. Любая интерфейсная служба, которую можно было делегировать службе ресурса, являлась потенциальной точкой атаки. Если сервер, на котором размещалась интерфейсная служба, настроенная для делегирования службам ресурсов, подвергался компрометации, службы ресурсов также могли быть скомпрометированы.

В управляемом домене у вас нет привилегий администратора домена. Поэтому в нем нельзя настроить традиционное ограниченное делегирование Kerberos на основе учетной записи. Вместо этого можно использовать KCD на основе ресурсов, что более безопасно.

### <a name="resource-based-kcd"></a>Ограниченное делегирование Kerberos на основе ресурсов

Windows Server 2012 и более поздние версии позволяют администраторам служб настраивать ограниченное делегирование для своей службы. Такая модель называется ограниченным делегированием Kerberos на основе ресурсов. В этой модели администратор служб сервера может разрешить или запретить конкретным интерфейсным службам использовать ограниченное делегирование Kerberos.

KCD на основе ресурсов настраивается с помощью PowerShell. Используйте командлеты [Set-ADComputer][Set-ADComputer] или [Set-ADUser][Set-ADUser] в зависимости от того, является ли учетная запись олицетворения учетной записью компьютера или учетной записью пользователя или службы.

## <a name="configure-resource-based-kcd-for-a-computer-account"></a>Настройка ограниченного делегирования Kerberos на основе ресурсов для учетной записи компьютера

Возьмем следующий сценарий: у вас есть веб-приложение, которое выполняется на компьютере *contoso-webapp.aaddscontoso.com*.

Веб-приложению необходим доступ к веб-API, который выполняется на компьютере *contoso-api.aaddscontoso.com* в контексте пользователей домена.

Выполните указанные далее действия, чтобы настроить этот сценарий.

1. [Создайте настраиваемое подразделение](create-ou.md). Вы можете делегировать разрешения, чтобы управлять настраиваемым подразделением пользователей в управляемом домене.
1. Присоедините к управляемому домену [виртуальные машины][create-join-windows-vm]: на одной из них будет выполняться веб-приложение, а на другой будет работать веб-API в управляемом домене. Создайте учетные записи этих компьютеров в настраиваемом подразделении из предыдущего шага.

    > [!NOTE]
    > Учетные записи компьютеров для веб-приложения и веб-API должны находиться в настраиваемом подразделении, для которого у вас есть разрешения на настройку KCD на основе ресурсов. KCD на основе ресурсов нельзя настроить во встроенном контейнере *Компьютеры AAD DC*.

1. Наконец, настройте ограниченное делегирование Kerberos на основе ресурсов с помощью командлета PowerShell [Set-ADComputer][Set-ADComputer].

    На присоединенной к домену виртуальной машине управления войдите в учетную запись пользователя, принадлежащего к группе *Администраторы Azure AD DC*, и запустите следующие командлеты. При необходимости укажите собственные имена компьютеров.
    
    ```powershell
    $ImpersonatingAccount = Get-ADComputer -Identity contoso-webapp.aaddscontoso.com
    Set-ADComputer contoso-api.aaddscontoso.com -PrincipalsAllowedToDelegateToAccount $ImpersonatingAccount
    ```

## <a name="configure-resource-based-kcd-for-a-user-account"></a>Настройка ограниченного делегирования Kerberos на основе ресурсов для учетной записи пользователя

Возьмем следующий сценарий: у вас есть веб-приложение, запускаемое под учетной записью службы с именем *appsvc*. Веб-приложению необходимо получить доступ к веб-API, который выполняется под учетной записью службы с именем *backendsvc* в контексте пользователей домена. Выполните указанные далее действия, чтобы настроить этот сценарий.

1. [Создайте настраиваемое подразделение](create-ou.md). Вы можете делегировать разрешения, чтобы управлять настраиваемым подразделением пользователей в управляемом домене.
1. [Присоедините виртуальную машину,][create-join-windows-vm] на которой выполняется серверный веб-API или ресурс, к управляемому домену. Создайте учетную запись компьютера в настраиваемом подразделении.
1. Создайте учетную запись службы (например, *appsvc*), используемую для запуска веб-приложения в настраиваемом подразделении.

    > [!NOTE]
    > Напомним, что учетная запись компьютера для виртуальной машины с веб-API и учетная запись службы для веб-приложения должны находиться в настраиваемом подразделении, для которого у вас есть разрешения на настройку KCD на основе ресурсов. KCD на основе ресурсов нельзя настроить во встроенных контейнерах *Компьютеры AAD DC* и *Пользователи AAD DC*. Это также значит, что вы не сможете настроить KCD на основе ресурсов с помощью учетных записей пользователей, синхронизированных из Azure AD. Вы должны создать и использовать учетные записи служб, созданные специально в Azure AD DS.

1. Наконец, настройте ограниченное делегирование Kerberos на основе ресурсов с помощью командлета PowerShell [Set-ADUser][Set-ADUser].

    На присоединенной к домену виртуальной машине управления войдите в учетную запись пользователя, принадлежащего к группе *Администраторы Azure AD DC*, и запустите следующие командлеты. При необходимости укажите собственные имена служб.

    ```powershell
    $ImpersonatingAccount = Get-ADUser -Identity appsvc
    Set-ADUser backendsvc -PrincipalsAllowedToDelegateToAccount $ImpersonatingAccount
    ```

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о работе делегирования в доменных службах Active Directory см. в разделе [Обзор ограниченного делегирования Kerberos][kcd-technet].

<!-- INTERNAL LINKS -->
[create-azure-ad-tenant]: ../active-directory/fundamentals/sign-up-organization.md
[associate-azure-ad-tenant]: ../active-directory/fundamentals/active-directory-how-subscriptions-associated-directory.md
[create-azure-ad-ds-instance]: tutorial-create-instance.md
[create-join-windows-vm]: join-windows-vm.md
[tutorial-create-management-vm]: tutorial-create-management-vm.md
[Set-ADComputer]: /powershell/module/addsadministration/set-adcomputer
[Set-ADUser]: /powershell/module/addsadministration/set-aduser

<!-- EXTERNAL LINKS -->
[kcd-technet]: /previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj553400(v=ws.11)