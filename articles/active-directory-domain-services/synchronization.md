---
title: Как работает синхронизация в доменных службах Azure AD | Документация Майкрософт
description: Узнайте, как работает процесс синхронизации для объектов и учетных данных из клиента Azure AD или локальной среды служб домен Active Directory Services в домен Azure Active Directory, управляемый службами домена.
services: active-directory-ds
author: justinha
manager: daveba
ms.assetid: 57cbf436-fc1d-4bab-b991-7d25b6e987ef
ms.service: active-directory
ms.subservice: domain-services
ms.workload: identity
ms.topic: conceptual
ms.date: 07/06/2020
ms.author: justinha
ms.openlocfilehash: 41ba337765b4a0a93be52f08ae6656707cf7aa73
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "96618813"
---
# <a name="how-objects-and-credentials-are-synchronized-in-an-azure-active-directory-domain-services-managed-domain"></a>Синхронизация объектов и учетных данных в управляемом домене доменных служб Azure Active Directory

Объекты и учетные данные в управляемом домене доменных служб Azure Active Directory (Azure AD DS) могут быть созданы локально в домене или синхронизированы из клиента Azure Active Directory (Azure AD). При первом развертывании AD DS Azure автоматическая односторонняя синхронизация настраивается и запускается для репликации объектов из Azure AD. Эта односторонняя синхронизация продолжает выполняться в фоновом режиме, чтобы поддерживать управляемый домен Azure AD DS в актуальном состоянии с изменениями из Azure AD. Из Azure AD DS не выполняется синхронизация с Azure AD.

В гибридной среде объекты и учетные данные из локального домена AD DS можно синхронизировать с Azure AD с помощью Azure AD Connect. После успешной синхронизации этих объектов в Azure AD автоматическая фоновая синхронизация делает эти объекты и учетные данные доступными для приложений, использующих управляемый домен.

Если локальные службы AD DS и Azure AD настроены для федеративной аутентификации с помощью ADFS, значит в Azure DS будет отсутствовать доступный (текущий/допустимый) хэш паролей. Учетные записи пользователей Azure AD, созданные до реализации федеративной аутентификации, который с большой вероятностью не будет соответствовать хэшу их локального пароля. Поэтому AD DS Azure не сможет проверить учетные данные пользователей.

На следующей схеме показано, как работает синхронизация между Azure AD DS, Azure AD и дополнительной локальной AD DSной средой.

![Общие сведения о синхронизации для управляемого домена доменных служб Azure AD](./media/active-directory-domain-services-design-guide/sync-topology.png)

## <a name="synchronization-from-azure-ad-to-azure-ad-ds"></a>Синхронизация из Azure AD в Azure AD DS

Учетные записи пользователей, членства в группах и хэши учетных данных синхронизируются одним способом из Azure AD в Azure AD DS. Этот процесс синхронизации выполняется автоматически. Вам не нужно настраивать и отслеживать этот процесс синхронизации, а также управлять им. Начальная синхронизация может занять несколько часов в течение нескольких дней в зависимости от числа объектов в каталоге Azure AD. После завершения начальной синхронизации изменения, внесенные в Azure AD, такие как изменения паролей или атрибутов, автоматически синхронизируются с AD DS Azure.

Когда пользователь создается в Azure AD, он не синхронизируется с AD DS Azure, пока не изменит свой пароль в Azure AD. При смене пароля хэши паролей автоматически создаются и сохраняются в Azure AD для аутентификации Kerberos и NTLM. Хэши паролей необходимы для успешной проверки подлинности пользователя в Azure AD DS.

Процесс синхронизации является одним способом или однонаправленным. Обратная синхронизация изменений из Azure AD DS обратно в Azure AD не выполняется. Управляемый домен в основном доступен только для чтения, за исключением пользовательских подразделений, которые можно создать. Нельзя вносить изменения в атрибуты пользователей, пароли пользователей или членство в группах в пределах управляемого домена.

## <a name="attribute-synchronization-and-mapping-to-azure-ad-ds"></a>Синхронизация атрибутов и сопоставление с Azure AD DS

В следующей таблице перечислены некоторые общие атрибуты и их синхронизация с Azure AD DS.

| Атрибут в AD DS Azure | Источник | Примечания |
|:--- |:--- |:--- |
| UPN | Атрибут *имени участника* -пользователя в клиенте Azure AD | Атрибут UPN из клиента Azure AD синхронизирован как есть в Azure AD DS. Самым надежным способом входа в управляемый домен является использование имени участника-пользователя. |
| SAMAccountName | Атрибут *mailNickname* пользователя в клиенте Azure AD или автоматически сформированный | Источником атрибута *SamAccountName* является атрибут *mailNickname* в клиенте Azure AD. Если несколько учетных записей пользователей имеют одинаковый атрибут *mailNickname* , то *SamAccountName* создается автоматически. Если длина префикса *mailNickname* или *имени участника* -пользователя превышает 20 символов, *SamAccountName* создается автоматически в соответствии с ограничением в 20 символов для атрибутов *SamAccountName* . |
| Пароли | Пароль пользователя из клиента Azure AD | Устаревшие хэши паролей, необходимые для проверки подлинности NTLM или Kerberos, синхронизируются с клиентом Azure AD. Если клиент Azure AD настроен для гибридной синхронизации с помощью Azure AD Connect, эти хэши паролей помещаются из локальной среды AD DS. |
| Основной идентификатор безопасности (SID) пользователя или группы | Автоматически сформированный | Основной идентификатор безопасности учетных записей пользователей или групп создается автоматически в AD DS Azure. Этот атрибут не соответствует идентификатору безопасности основного пользователя или группы объекта в локальной среде AD DS. Это несоответствие связано с тем, что управляемый домен имеет другое пространство имен SID, чем локальный домен AD DS. |
| Журнал идентификаторов безопасности для пользователей и групп | Локальный основной идентификатор безопасности пользователя и группы | Атрибут *SIDHistory* для пользователей и групп в Azure AD DS настроен в соответствии с соответствующим идентификатором безопасности основного пользователя или группы в локальной среде AD DS. Эта функция позволяет выполнять перенос локальных приложений в Azure AD DS проще, так как не требуется повторно использовать ресурсы ACL. |

> [!TIP]
> **Войдите в управляемый домен, используя формат имени участника-пользователя** Атрибут *SamAccountName* , например `AADDSCONTOSO\driley` , может быть автоматически создан для некоторых учетных записей пользователей в управляемом домене. Автоматически созданный пользователь *SamAccountName* может отличаться от префикса имени участника-пользователя, поэтому не всегда надежный способ входа в систему.
>
> Например, если несколько пользователей имеют одинаковый атрибут *mailNickname* или пользователи имеют более длинные префиксы имени участника-пользователя, *SamAccountName* для этих пользователей может быть создан автоматически. Используйте формат имени участника-пользователя, например `driley@aaddscontoso.com` , для надежного входа в управляемый домен.

### <a name="attribute-mapping-for-user-accounts"></a>Сопоставление атрибутов для учетных записей пользователей

В следующей таблице показано, как определенные атрибуты для пользовательских объектов в Azure AD синхронизируются с соответствующими атрибутами в AD DS Azure.

| Атрибут пользователя в Azure AD | Атрибут пользователя в Azure AD DS |
|:--- |:--- |
| AccountEnabled |userAccountControl (задает или удаляет значение ACCOUNT_DISABLED) |
| city |l |
| country |co |
| department |department |
| displayName |displayName |
| емплойидид |employeeId |
| facsimileTelephoneNumber |facsimileTelephoneNumber |
| givenName |givenName |
| jobTitle |title |
| mail |почта |
| mailNickname |msDS-AzureADMailNickname |
| mailNickname |SAMAccountName (иногда может быть автоматически создан) |
| manager |manager |
| mobile |mobile |
| objectid |msDS-AzureADObjectId |
| onPremiseSecurityIdentifier |sidHistory |
| passwordPolicies |userAccountControl (задает или удаляет значение DONT_EXPIRE_PASSWORD) |
| physicalDeliveryOfficeName |physicalDeliveryOfficeName |
| postalCode |postalCode |
| preferredLanguage |preferredLanguage |
| proxyAddresses | proxyAddresses |
| Состояние |st |
| streetAddress |streetAddress |
| surname |sn |
| TelephoneNumber |TelephoneNumber |
| userPrincipalName |userPrincipalName |

### <a name="attribute-mapping-for-groups"></a>Сопоставление атрибутов для групп

В следующей таблице показано, как определенные атрибуты для групповых объектов в Azure AD синхронизируются с соответствующими атрибутами в AD DS Azure.

| Атрибут Group в Azure AD | Атрибут Group в AD DS Azure |
|:--- |:--- |
| displayName |displayName |
| displayName |SAMAccountName (иногда может быть автоматически создан) |
| mail |почта |
| mailNickname |msDS-AzureADMailNickname |
| objectid |msDS-AzureADObjectId |
| onPremiseSecurityIdentifier |sidHistory |
| proxyAddresses | proxyAddresses |
| securityEnabled |groupType |

## <a name="synchronization-from-on-premises-ad-ds-to-azure-ad-and-azure-ad-ds"></a>Синхронизация из локальной AD DS в Azure AD и Azure AD DS

Azure AD Connect используется для синхронизации учетных записей пользователей, членства в группах и хэшей учетных данных из локальной AD DS среды в Azure AD. Атрибуты учетных записей пользователей, таких как UPN и локальный идентификатор безопасности (SID), синхронизируются. Для входа с помощью AD DS Azure хэши паролей, необходимые для проверки подлинности NTLM и Kerberos, также синхронизируются с Azure AD.

> [!IMPORTANT]
> Azure AD Connect следует устанавливать и настраивать только для синхронизации с локальными средами AD DS. Установка Azure AD Connect в управляемом домене для синхронизации объектов обратно в Azure AD не поддерживается.

При настройке обратной записи изменения из Azure AD синхронизируются с локальной AD DSой средой. Например, если пользователь изменяет пароль с помощью функции самостоятельного управления паролями Azure AD, пароль обновляется в локальной среде AD DS.

> [!NOTE]
> Всегда используйте последнюю версию Azure AD Connect. В этом случае у вас точно будут исправления для всех известных ошибок.

### <a name="synchronization-from-a-multi-forest-on-premises-environment"></a>Синхронизация из локальной среды с несколькими лесами

Многие организации имеют довольно сложную локальную среду AD DS, включающую несколько лесов. Azure AD Connect поддерживает синхронизацию пользователей, групп и хэшей учетных данных из сред с несколькими лесами в Azure AD.

Azure AD имеет гораздо более простое и неструктурированное пространство имен. Чтобы предоставить пользователям надежный доступ к приложениям, защищенным с помощью Azure AD, устраните конфликты имен участников-пользователей между учетными записями пользователей в разных лесах. Управляемые домены используют плоскую структуру подразделений, аналогичную Azure AD. Все учетные записи пользователей и группы хранятся в контейнере *AADDC Users* , несмотря на синхронизацию из разных локальных доменов или лесов, даже если иерархическая структура подразделений настроена локально. Управляемый домен выполняет сведение всех иерархических структур подразделений.

Как уже было описано выше, синхронизация из Azure AD DS обратно в Azure AD не выполняется. Вы можете [создать пользовательское подразделение (OU)](create-ou.md) в Azure AD DS а затем — пользователей, группы или учетные записи служб в этих пользовательских подразделениях. Ни один из объектов, созданных в пользовательских подразделениях, не синхронизирован обратно в Azure AD. Эти объекты доступны только в управляемом домене и не отображаются с помощью командлетов Azure AD PowerShell, Microsoft Graph API или пользовательского интерфейса управления Azure AD.

## <a name="what-isnt-synchronized-to-azure-ad-ds"></a>Что не синхронизировано с Azure AD DS

Следующие объекты или атрибуты не синхронизируются из локальной AD DS среды в Azure AD или Azure AD DS.

* **Исключенные атрибуты:** Вы можете исключить определенные атрибуты из синхронизации с Azure AD из локальной AD DS среды с помощью Azure AD Connect. Эти исключенные атрибуты в Azure AD DS недоступны.
* **Групповые политики:** Групповые политики, настроенные в локальной среде AD DS, не синхронизируются с Azure AD DS.
* **Папка SYSVOL:** Содержимое папки *SYSVOL* в локальной среде AD DS не синхронизируется с Azure AD DS.
* **Объекты компьютеров:** Объекты-компьютеры для компьютеров, присоединенных к локальной среде AD DS, не синхронизируются с Azure AD DS. Эти компьютеры не имеют отношения доверия с управляемым доменом и принадлежат к локальной среде AD DS. В AD DS Azure отображаются только объекты компьютеров, присоединенные к управляемому домену, которые явно присоединены к домену.
* **Атрибуты SIDHistory для пользователей и групп:** Идентификаторы безопасности основного пользователя и основной группы из локальной AD DS среды синхронизируются с AD DS Azure. Однако существующие атрибуты *SIDHistory* для пользователей и групп не синхронизируются из локальной AD DS среды в Azure AD DS.
* Структуры подразделений **(OU):** Подразделения, определенные в локальной среде AD DS, не синхронизируются с AD DS Azure. В Azure AD DS два встроенных подразделения — один для пользователей и один для компьютеров. Управляемый домен имеет плоскую структуру подразделений. Вы можете [создать пользовательское подразделение в управляемом домене](create-ou.md).

## <a name="password-hash-synchronization-and-security-considerations"></a>Вопросы по синхронизации и безопасности хэша паролей

При включении AD DS Azure необходимо использовать устаревшие хэши паролей для проверки подлинности NTLM + Kerberos. Azure AD не хранит пароли в виде открытого текста, поэтому эти хэши не могут быть автоматически созданы для существующих учетных записей пользователей. После создания и сохранения хэшей паролей, совместимых с NTLM и Kerberos, всегда хранятся в Azure AD в зашифрованном виде.

Ключи шифрования уникальны для каждого клиента Azure AD. Эти хэши шифруются так, что только AD DS Azure имеет доступ к ключам дешифрования. Другие службы или компоненты в Azure AD не имеют доступа к этим ключам.

Затем старые хэши паролей синхронизируются из Azure AD в контроллеры домена для управляемого домена. Диски для этих управляемых контроллеров домена в Azure AD DS шифруются неактивных данных. Эти хэши паролей хранятся и защищаются на этих контроллерах домена аналогично хранению и защите паролей в локальной среде AD DS.

Для облачных сред Azure AD [Пользователи должны сбросить или изменить свой пароль](tutorial-create-instance.md#enable-user-accounts-for-azure-ad-ds) , чтобы создать и сохранить в Azure AD необходимые хэши паролей. Для любой облачной учетной записи пользователя в Azure AD хэши паролей сохраняются и создаются в совместимых форматах NTLM и Kerberos после включения доменных служб Azure AD. Все учетные записи пользователей облака должны изменить свой пароль, прежде чем они будут синхронизированы с Azure AD DS.

Для гибридных учетных записей пользователей, синхронизированных из локальной среды AD DS с помощью Azure AD Connect, необходимо [настроить Azure AD Connect для синхронизации хэшей паролей в форматах, совместимых с NTLM и Kerberos](tutorial-configure-password-hash-sync.md).

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения об особенностях синхронизации паролей см. в статье [как работает синхронизация хэшей паролей с Azure AD Connect](../active-directory/hybrid/how-to-connect-password-hash-synchronization.md?context=/azure/active-directory-domain-services/context/azure-ad-ds-context).

Чтобы начать работу с Azure AD DS, [создайте управляемый домен](tutorial-create-instance.md).
