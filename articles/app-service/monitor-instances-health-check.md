---
title: Мониторинг работоспособности экземпляров службы приложений
description: Узнайте, как отслеживать работоспособность экземпляров службы приложений с помощью проверки работоспособности.
keywords: служба приложений Azure, веб-приложение, проверка работоспособности, маршрутизация трафика, работоспособные экземпляры, путь, мониторинг,
author: msangapu-msft
ms.topic: article
ms.date: 12/03/2020
ms.author: msangapu
ms.openlocfilehash: 60a210c6c336c1b820015304e8ab53bc894c17bf
ms.sourcegitcommit: a055089dd6195fde2555b27a84ae052b668a18c7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/26/2021
ms.locfileid: "98792508"
---
# <a name="monitor-app-service-instances-using-health-check"></a>Мониторинг экземпляров службы приложений с помощью проверки работоспособности

![Сбой проверки работоспособности][2]

В этой статье для мониторинга экземпляров службы приложений используется проверка работоспособности портал Azure. Проверка работоспособности увеличивает доступность приложения, удаляя неработоспособные экземпляры. Чтобы использовать проверку работоспособности, необходимо масштабировать [план службы приложений](/overview-hosting-plans) до двух или более экземпляров. Путь проверки работоспособности должен проверять критические компоненты приложения. Например, если приложение зависит от базы данных и системы обмена сообщениями, конечная точка проверки работоспособности должна подключаться к этим компонентам. Если приложение не может подключиться к критическому компоненту, то путь должен вернуть код ответа уровня 500, чтобы указать, что приложение является неработоспособным.

## <a name="what-app-service-does-with-health-checks"></a>Что делает служба приложений с проверками работоспособности

- По указанному пути в приложении проверка работоспособности проверяет связь по этому пути ко всем экземплярам приложения службы приложений с интервалом в 1 минуту.
- Если экземпляр не отвечает с кодом состояния от 200-299 (включительно) после двух или более запросов или не отвечает на запрос проверки связи, система определит неработоспособность и удалит ее.
- После удаления проверка работоспособности продолжит проверку связи с неработоспособным экземпляром. Если она не будет отвечать на запросы, служба приложений перезапускает базовую виртуальную машину, чтобы вернуть экземпляр в работоспособное состояние.
- Если экземпляр остается неработоспособным в течение одного часа, он будет заменен новым экземпляром.
- Кроме того, при увеличении или уменьшении масштаба служба приложений проверяет путь проверки работоспособности, чтобы убедиться, что новые экземпляры готовы.

> [!NOTE]
> Проверка работоспособности не соответствует 302 перенаправлений. В час будет заменено не более одного экземпляра, а для каждого плана службы приложений — не более трех экземпляров в день.
>

## <a name="enable-health-check"></a>Включить проверку работоспособности

![Навигация по проверке работоспособности на портале Azure][3]

- Чтобы включить проверку работоспособности, перейдите к портал Azure и выберите приложение службы приложений.
- В разделе **мониторинг** выберите **Проверка работоспособности**.
- Выберите **включить** и укажите допустимый путь URL-адреса в приложении, например `/health` или `/api/health` .
- Выберите команду **Сохранить**.

> [!CAUTION]
> Изменения в конфигурации проверки работоспособности перезапускают приложение. Чтобы снизить влияние на рабочие приложения, рекомендуется [настроить промежуточные слоты](deploy-staging-slots.md) и поменять местами в рабочей среде.
>

### <a name="configuration"></a>Конфигурация

Кроме настройки параметров проверки работоспособности, можно также настроить следующие [Параметры приложения](configure-common.md):

| Имя параметра приложения | Допустимые значения | Описание |
|-|-|-|
|`WEBSITE_HEALTHCHECK_MAXPINGFAILURES` | 2 - 10 | Максимальное число ошибок проверки связи. Например, если задано значение `2` , экземпляры будут удалены после `2` неудачных проверок связи. Кроме того, при увеличении или уменьшении масштаба служба приложений проверяет путь проверки работоспособности, чтобы убедиться, что новые экземпляры готовы. |
|`WEBSITE_HEALTHCHECK_MAXUNHEALTYWORKERPERCENT` | 0–100 | Во избежание перегрузки работоспособных экземпляров не будут исключены более половины экземпляров. Например, если план службы приложений масштабируется до четырех экземпляров, а три — неработоспособны, будет исключено не более двух. Два других экземпляра (один работоспособный и один неработоспособный) продолжат принимать запросы. В наихудшем сценарии, в котором все экземпляры находятся в неработоспособном состоянии, ни одно из них не будет исключено. Чтобы переопределить это поведение, задайте для параметра приложения значение от `0` до `100` . Более высокое значение означает, что будут удалены более неработоспособные экземпляры (по умолчанию — 50). |

#### <a name="authentication-and-security"></a>Проверка подлинности и безопасность

Проверка работоспособности интегрируется с функциями проверки подлинности и авторизации службы приложений. Если эти функции безопасности включены, дополнительные параметры не требуются. Однако если вы используете собственную систему проверки подлинности, путь проверки работоспособности должен разрешить анонимный доступ. Если сайт включен только в HTTP **s**, запрос проверки работоспособности будет отправлен через HTTP **s**.

Крупным группам разработки предприятия часто приходится соблюдать требования к безопасности для предоставляемых API. Чтобы защитить конечную точку проверки работоспособности, сначала следует использовать такие функции, как [ограничения IP-адресов](app-service-ip-restrictions.md#set-an-ip-address-based-rule), [сертификаты клиентов](app-service-ip-restrictions.md#set-an-ip-address-based-rule)или виртуальная сеть, чтобы ограничить доступ к приложениям. Вы можете защитить конечную точку проверки работоспособности, запросив `User-Agent` соответствующий входящий запрос `ReadyForRequest/1.0` . Невозможно подменить User-Agent, так как запрос уже был защищен с помощью предыдущих функций безопасности.

## <a name="monitoring"></a>Наблюдение

После предоставления пути к проверке работоспособности приложения можно отслеживать работоспособность сайта с помощью Azure Monitor. В колонке **Проверка работоспособности** на портале щелкните **метрики** на верхней панели инструментов. Откроется новая колонка, в которой можно просмотреть историю состояния работоспособности сайта и создать новое правило генерации оповещений. Дополнительные сведения о мониторинге сайтов см. [в разделе Azure Monitor](web-sites-monitor.md).

## <a name="next-steps"></a>Дальнейшие действия
- [Создайте оповещение журнала действий, чтобы отслеживать все операции системы автомасштабирования в подписке](https://github.com/Azure/azure-quickstart-templates/tree/master/monitor-autoscale-alert).
- [Создайте оповещение журнала действий, чтобы отслеживать все сбои автомасштабирования в подписке](https://github.com/Azure/azure-quickstart-templates/tree/master/monitor-autoscale-failed-alert).

[1]: ./media/app-service-monitor-instances-health-check/health-check-success-diagram.png
[2]: ./media/app-service-monitor-instances-health-check/health-check-failure-diagram.png
[3]: ./media/app-service-monitor-instances-health-check/azure-portal-navigation-health-check.png
