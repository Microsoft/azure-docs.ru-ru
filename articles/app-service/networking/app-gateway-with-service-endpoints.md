---
title: Интеграция шлюза приложений с конечными точками службы в службе приложений Azure | Документация Майкрософт
description: Описывает, как шлюз приложений интегрируется со службой приложений Azure, защищенной с помощью конечных точек служб.
services: app-service
documentationcenter: ''
author: madsd
manager: ccompy
editor: ''
ms.assetid: 073eb49c-efa1-4760-9f0c-1fecd5c251cc
ms.service: app-service
ms.workload: web
ms.tgt_pltfrm: na
ms.topic: article
ms.date: 12/09/2019
ms.author: madsd
ms.custom: seodec18, devx-track-azurecli
ms.openlocfilehash: 58886a8f7dc505a7e68d69eb00b4a2ebd776dd5a
ms.sourcegitcommit: f5b8410738bee1381407786fcb9d3d3ab838d813
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/14/2021
ms.locfileid: "98209873"
---
# <a name="application-gateway-integration-with-service-endpoints"></a>Интеграция шлюза приложений с конечными точками службы
Существует три варианта службы приложений, требующие немного иной настройки интеграции с шлюзом приложений Azure. Варианты включают в себя обычную службу приложений, которая также называется многоклиентской, внутренней Load Balancer (ILB) Среда службы приложений (ASE) и External ASE. В этой статье описано, как настроить службу приложений (с несколькими клиентами) и обсудить ILB и внешние ASE.

## <a name="integration-with-app-service-multi-tenant"></a>Интеграция со службой приложений (несколько клиентов)
Служба приложений (с несколькими клиентами) имеет общедоступную конечную точку для выхода в Интернет. С помощью [конечных точек службы](../../virtual-network/virtual-network-service-endpoints-overview.md) трафик можно разрешать только из определенной подсети в виртуальной сети Azure и блокировать все остальное. В следующем сценарии мы будем использовать эту функцию, чтобы убедиться, что экземпляр службы приложений может принимать трафик только от определенного экземпляра шлюза приложений.

:::image type="content" source="./media/app-gateway-with-service-endpoints/service-endpoints-appgw.png" alt-text="На схеме показано, что Интернет переводится в шлюз приложений в виртуальной сети Azure и перебирается через значок брандмауэра для экземпляров приложений в службе приложений.":::

Эта конфигурация состоит из двух частей, помимо создания службы приложений и шлюза приложений. Первая часть включает конечные точки службы в подсети виртуальной сети, в которой развернут шлюз приложений. Конечные точки службы гарантируют, что весь сетевой трафик, поступающий в подсеть к службе приложений, будет помечен конкретным ИДЕНТИФИКАТОРом подсети. Вторая часть — установить ограничение доступа конкретного веб-приложения, чтобы убедиться, что разрешен только трафик, помеченный этим ИДЕНТИФИКАТОРом подсети. Его можно настроить с помощью различных средств в зависимости от предпочтений.

## <a name="using-azure-portal"></a>Использование портала Azure
С помощью портал Azure вы выполните четыре шага для инициализации и настройки программы установки. При наличии существующих ресурсов можно пропустить первые шаги.
1. Создайте службу приложений с помощью одного из кратких руководств в документации по службе приложений, например [краткого руководства по .NET Core](../quickstart-dotnetcore.md) .
2. Создайте шлюз приложений с помощью [краткого руководства по порталу](../../application-gateway/quick-create-portal.md), но пропустите раздел Add серверные целевые объекты.
3. Настройте [службу приложений в качестве серверной части в шлюзе приложений](../../application-gateway/configure-web-app-portal.md), но перейдите к разделу ограничение доступа.
4. Наконец, создайте [ограничение доступа с помощью конечных точек службы](../../app-service/app-service-ip-restrictions.md#set-a-service-endpoint-based-rule).

Теперь вы можете получить доступ к службе приложений через шлюз приложений, но при попытке напрямую обратиться к службе приложений вы получите ошибку HTTP 403, указывающую на остановку веб-сайта.

![На снимке экрана показан текст ошибки 403-запрещено.](./media/app-gateway-with-service-endpoints/website-403-forbidden.png)

## <a name="using-azure-resource-manager-template"></a>Использование шаблона Azure Resource Manager
[Шаблон развертывания Диспетчер ресурсов][template-app-gateway-app-service-complete] будет подготавливать полный сценарий. Сценарий состоит из экземпляра службы приложений, заблокированного с помощью конечных точек службы и ограничений доступа, чтобы получать трафик только от шлюза приложений. Шаблон включает многие интеллектуальные значения по умолчанию и уникальные добавления в имена ресурсов, чтобы они были простыми. Чтобы переопределить их, необходимо клонировать репозиторий или загрузить шаблон и изменить его. 

Чтобы применить шаблон, можно воспользоваться кнопкой развернуть в Azure, расположенной в описании шаблона, или использовать соответствующую PowerShell или CLI.

## <a name="using-azure-command-line-interface"></a>Использование интерфейса командной строки Azure
В [Azure CLI примере](../../app-service/scripts/cli-integrate-app-service-with-application-gateway.md) будет обеспечена блокировка службы приложений с конечными точками службы и ограничением доступа, чтобы получать трафик только от шлюза приложений. Если необходимо изолировать трафик к существующей службе приложений из существующего шлюза приложений, достаточно выполнить следующую команду.

```azurecli-interactive
az webapp config access-restriction add --resource-group myRG --name myWebApp --rule-name AppGwSubnet --priority 200 --subnet mySubNetName --vnet-name myVnetName
```

В конфигурации по умолчанию команда обеспечит настройку конечной точки службы в подсети и ограничение доступа в службе приложений.

## <a name="considerations-for-ilb-ase"></a>Рекомендации по ILB ASE
ILB ASE не предоставляется через Интернет, и трафик между экземпляром и шлюзом приложений, таким образом, уже изолирован от виртуальной сети. В следующем [пошаговом руководство](../environment/integrate-with-application-gateway.md) настраивается ilB ASE и интегрируется с шлюзом приложений с помощью портал Azure. 

Если вы хотите убедиться, что только трафик из подсети шлюза приложений приближается к ASE, можно настроить группу безопасности сети (NSG), которая влияет на все веб-приложения в ASE. Для NSG можно указать диапазон IP-адресов подсети и (необязательно) порты (80/443). Убедитесь, что вы не переопределяете [необходимые правила NSG](../environment/network-info.md#network-security-groups) для правильной работы ASE.

Чтобы изолировать трафик к отдельному веб-приложению, необходимо использовать ограничения доступа на основе IP-адресов, так как конечные точки службы не будут работать для ASE. В качестве IP-адреса следует использовать частный IP-адрес экземпляра шлюза приложений.

## <a name="considerations-for-external-ase"></a>Рекомендации для внешних ASE
Внешний ASE имеет общедоступную подсистему балансировки нагрузки, например многоклиентскую службу приложений. Конечные точки службы не работают для ASE, поэтому необходимо использовать ограничения доступа на основе IP-адресов, используя общедоступный IP-адрес экземпляра шлюза приложений. Чтобы создать внешний ASE с помощью портал Azure, можно воспользоваться этим [кратким](../environment/create-external-ase.md) руководством

[template-app-gateway-app-service-complete]: https://github.com/Azure/azure-quickstart-templates/tree/master/201-web-app-with-app-gateway-v2/ "Шаблон Azure Resource Manager для полного сценария"

## <a name="considerations-for-kuduscm-site"></a>Рекомендации для сайта KUDU/SCM
Сайт SCM, также известный как KUDU, является сайтом администрирования, который существует для каждого веб-приложения. Нельзя выполнить обратный прокси-сервер для сайта SCM и, скорее всего, заблокировать его для отдельных IP-адресов или конкретной подсети.

Если вы хотите использовать те же ограничения доступа, что и для основного сайта, можно наследовать параметры с помощью следующей команды.

```azurecli-interactive
az webapp config access-restriction set --resource-group myRG --name myWebApp --use-same-restrictions-for-scm-site
```

Если необходимо задать индивидуальные ограничения доступа к сайту SCM, можно добавить ограничения доступа с помощью флага--SCM-site, как показано ниже.

```azurecli-interactive
az webapp config access-restriction add --resource-group myRG --name myWebApp --scm-site --rule-name KudoAccess --priority 200 --ip-address 208.130.0.0/16
```

## <a name="next-steps"></a>Дальнейшие действия
Дополнительные сведения о Среда службы приложений см. в [документации по среда службы приложений](/azure/app-service/environment).

Для дальнейшей защиты веб-приложения сведения о брандмауэре веб-приложения в шлюзе приложений можно найти в [документации по брандмауэру веб-приложения Azure](../../web-application-firewall/ag/ag-overview.md).
