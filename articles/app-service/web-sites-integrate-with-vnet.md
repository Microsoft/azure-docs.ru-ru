---
title: Интеграция приложения с виртуальной сетью Azure
description: Интеграция приложения со Службой приложений Azure с помощью виртуальных сетей Azure.
author: ccompy
ms.assetid: 90bc6ec6-133d-4d87-a867-fcf77da75f5a
ms.topic: article
ms.date: 08/05/2020
ms.author: ccompy
ms.custom: seodec18
ms.openlocfilehash: 077d200dcaf957f636acecebb441ff99a68eb96f
ms.sourcegitcommit: f6f928180504444470af713c32e7df667c17ac20
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2021
ms.locfileid: "97963593"
---
# <a name="integrate-your-app-with-an-azure-virtual-network"></a>Интеграция приложения с виртуальной сетью Azure

В этой статье описана функция службы приложений Azure — интеграция с виртуальной сетью (VNet). Кроме того, приведены инструкции по ее настройке для приложений в [Службе приложений Azure](./overview.md). [Виртуальные сети Azure][VNETOverview] позволяют размещать многие ресурсы Azure в сети, недоступной из Интернета. Функция интеграции с виртуальной сетью позволяет приложениям получать доступ к ресурсам в виртуальной сети или через нее. Интеграция с виртуальной сетью не обеспечивает частный доступ к приложениям.

Служба приложений Azure имеет две разновидности функции интеграции с виртуальной сетью:

[!INCLUDE [app-service-web-vnet-types](../../includes/app-service-web-vnet-types.md)]

## <a name="enable-vnet-integration"></a>Активация интеграции виртуальной сети

1. Откройте раздел интерфейса **Сеть** на портале Службы приложений. В разделе **Интеграция виртуальной сети** выберите **Щелкните здесь для настройки**.

1. Выберите **Добавить виртуальную сеть**.

   ![Выберите "Интеграция виртуальной сети"][1]

1. Раскрывающийся список содержит все виртуальные сети Azure Resource Manager в рамках вашей подписки для данного региона. Под ним расположен список виртуальных сетей Resource Manager для всех прочих регионов. Выберите виртуальную сеть, интеграцию с которой вы хотите выполнить.

   ![Выберите виртуальную сеть][2]

   * Если виртуальная сеть находится в том же регионе, создайте новую или выберите пустую существующую подсеть.
   * Чтобы выбрать виртуальную сеть в другом регионе, у вас должен быть подготовлен к работе шлюз виртуальных сетей с активированной функцией "точка — сеть".
   * Чтобы выполнить интеграцию с классической виртуальной сетью, вместо раскрывающегося списка **Виртуальная сеть** выберите **Щелкните здесь, чтобы подключиться к классической виртуальной сети**. Выберите классическую виртуальную сеть. У целевой виртуальной сети уже должен быть подготовлен к работе шлюз виртуальных сетей с активированной функцией "точка — сеть".

    ![Выберите классическую виртуальную сеть][3]

Во время интеграции приложение перезапускается. После завершения интеграции вы увидите данные соответствующей виртуальной сети.

## <a name="regional-vnet-integration"></a>Интеграция с региональной виртуальной сетью

[!INCLUDE [app-service-web-vnet-types](../../includes/app-service-web-vnet-regional.md)]

### <a name="how-regional-vnet-integration-works"></a>Принципы работы региональной виртуальной сети

Приложения размещаются в Службе приложений с рабочими ролями. План размещения "Базовый" и планы более высокой ценовой категории представляют собой выделенные планы, в рамках которых те же рабочие роли не выполняют рабочую нагрузку других клиентов. В рамках интеграции с региональной виртуальной сетью выполняется подключение виртуальных интерфейсов с адресами в делегированной подсети. Поскольку исходящий адрес находится в вашей виртуальной сети, он имеет доступ к большинству ресурсов в ней или через нее аналогично виртуальной машине в этой виртуальной сети. Реализация сетевого подключения не такая, как у виртуальной машины в виртуальной сети. В связи с этим для него недоступны некоторые сетевые возможности.

![Принципы работы региональной виртуальной сети][5]

Когда включена интеграция с региональной виртуальной сетью, ваше приложение совершает исходящие вызовы в Интернет по тем же каналам, что и обычно. Внешние адреса, указанные на портале свойств приложений, как и прежде, представляют собой адреса, которые использует ваше приложение. Изменение заключается в том, что вызовы, которые ваше приложение совершает к защищенным ресурсам конечной точки службы (адреса RFC 1918), поступают в вашу виртуальную сеть. Если для параметра WEBSITE_VNET_ROUTE_ALL установлено значение 1, весь исходящий трафик может направляться в вашу виртуальную сеть.

> [!NOTE]
> `WEBSITE_VNET_ROUTE_ALL` в настоящее время не поддерживается в контейнерах Windows.
> 

Для этой функции поддерживается по одному виртуальному интерфейсу на рабочую роль. Один виртуальный интерфейс на рабочую роль означает по одной интеграции с региональной виртуальной сетью на план службы приложений. Все приложения в рамках плана службы приложений используют одну интеграцию с виртуальной сетью. Если вы хотите, чтобы ваше приложение подключалось еще к одной виртуальной сети, вам потребуется создать еще один план службы приложений. Виртуальный интерфейс — это ресурс, к которому у клиентов нет прямого доступа.

В связи с особенностями работы данной технологии трафик, используемый в рамках интеграции с виртуальной сетью, не отображается в Наблюдателе за сетями Azure или в журналах потоков NSG.

## <a name="gateway-required-vnet-integration"></a>Интеграция с виртуальной сетью на базе шлюза

В рамках интеграции с виртуальной сетью на базе шлюза можно подключаться к виртуальной сети в другом регионе или к классической виртуальной сети. Интеграция с виртуальной сетью на базе шлюза:

* позволяет приложению в один момент времени подключаться только к одной виртуальной сети;
* позволяет интегрировать до пяти виртуальных сетей в рамках плана службы приложений;
* позволяет нескольким приложениям использовать одну виртуальную сеть в рамках плана службы приложений, не влияя на общее количество, доступное плану службы приложений (если у вас шесть приложений используют одну виртуальную сеть в рамках одного плана службы приложений, считается, что вы используете одну виртуальную сеть);
* гарантирует практически постоянную доступность ресурсов (99,9 % по соглашению об уровне обслуживания) благодаря использованию шлюза;
* позволяет вашим приложениям использовать параметры DNS, настроенные для виртуальной сети;
* требует настройки сети VPN "точка — сеть" на базе SSTP для шлюза на основе маршрутов перед подключением к приложению.

Интеграция с виртуальной сетью на базе шлюза недоступна:

* для виртуальных сетей с подключением на базе Microsoft Azure ExpressRoute;
* Из приложения Linux.
* Из [контейнера Windows](quickstart-custom-container.md).
* для доступа к защищенным ресурсам конечной точки службы.
* в режиме сосуществования со шлюзом, который поддерживает как ExpressRoute, так и VPN типа "точка — сеть" или "сеть — сеть".

### <a name="set-up-a-gateway-in-your-azure-virtual-network"></a>Настройка шлюза в виртуальной сети Azure ###

Создание шлюза:

1. [Создайте подсеть шлюза][creategatewaysubnet] в виртуальной сети.

1. [Создайте VPN-шлюз][creategateway]. Выберите тип сети VPN на основе маршрутов.

1. [Задайте адреса для подключения "точка — сеть"][setp2saddresses]. Если шлюз не входит в базовый SKU, то в конфигурации подключения "точка — сеть" необходимо отключить IKEV2 и выбрать SSTP. Диапазон адресов подключения "точка — сеть" должен находиться в блоках адресов RFC 1918 10.0.0.0/8, 172.16.0.0/12 и 192.168.0.0/16.

Если вы создаете шлюз, чтобы использовать его для интеграции службы приложений с виртуальной сетью, то отправлять сертификат не требуется. Создание шлюза может занять 30 минут. Пока шлюз не будет подготовлен, интегрировать приложение с виртуальной сетью будет невозможно.

### <a name="how-gateway-required-vnet-integration-works"></a>Принципы интеграции с виртуальной сетью на базе шлюза

Интеграция с виртуальной сетью на базе шлюза основана на технологии сетей VPN типа "точка — сеть". Для VPN типа "точка — сеть" сетевой доступ ограничен виртуальной машиной, на которой размещено приложение. Приложениям разрешается отправлять трафик в Интернет только через гибридные подключения или путем интеграции с виртуальной сетью. Когда вы настраиваете для приложения на портале интеграцию с виртуальной сетью на базе шлюза, от вашего имени производится сложная процедура согласования для создания и назначения сертификатов на стороне шлюза и приложения. В результате рабочие роли, которые используются для размещения ваших приложений, получают возможность напрямую подключаться к шлюзу виртуальной сети в выбранной виртуальной сети.

![Принципы интеграции с виртуальной сетью на базе шлюза][6]

### <a name="access-on-premises-resources"></a>Доступ к локальным ресурсам

Приложения могут получать доступ к локальным ресурсам путем интеграции с виртуальными сетями, содержащими подключения типа "сеть — сеть". Если вы используете интеграцию с виртуальной сетью с обязательным использование шлюза, обновите локальные маршруты VPN-шлюзов, добавив блоки адресов "точка — сеть". При первой настройке VPN-подключения "сеть-сеть" скрипты, используемые для его настройки, должны настроить маршруты надлежащим образом. Если адреса "точка — сеть" добавлены после создания VPN-подключения типа "сеть — сеть", то маршруты нужно обновить вручную. Эта процедура отличается для разных типов шлюзов, поэтому здесь мы ее не рассматриваем. Протокол BGP невозможно настроить с VPN-подключением типа "сеть-сеть".

Дополнительная настройка для доступа к локальным ресурсам через виртуальную сеть в рамках интеграции с региональной виртуальной сетью не требуется. Достаточно подключить виртуальную сеть к локальным ресурсам с помощью ExpressRoute или VPN типа "сеть — сеть".

> [!NOTE]
> Функция интеграции c виртуальной сетью на базе шлюза не предусматривает интеграции приложения с виртуальной сетью, в которой установлен шлюз ExpressRoute. Даже если шлюз ExpressRoute настроен в [режиме сосуществования][VPNERCoex], функция интеграции c виртуальной сетью работать не будет. Если требуется получить доступ к ресурсам через соединение ExpressRoute, используйте интеграцию с региональной виртуальной сетью или [Среду службы приложений][ASE], которая работает в виртуальной сети.
>
>

### <a name="peering"></a>Пиринг

Для установки пиринга в рамках интеграции с региональной виртуальной сетью дополнительные настройки не требуются.

Для установки пиринга в рамках интеграции с виртуальной сетью на базе шлюза требуется настроить ряд дополнительных параметров. Настройка пиринга для работы с приложением:

1. Добавьте пиринговое подключение в виртуальную сеть, к которой подключается приложение. Добавляя пиринговое подключение, включите параметр **Разрешить доступ к виртуальным сетям**, а также установите флажки **Разрешить перенаправленный трафик** и **Разрешить транзит шлюзов**.
1. Добавьте пиринговое подключение в виртуальной сети, соединенной с той виртуальной сетью, к которой вы подключены. Добавляя пиринговое подключение к целевой виртуальной сети, включите параметр **Разрешить доступ к виртуальным сетям**, а также установите флажки **Разрешить перенаправленный трафик** и **Разрешить удаленные шлюзы**.
1. Перейдите в раздел **План службы приложений** > **Сеть** > **Интеграция виртуальной сети** на портале. Выберите виртуальную сеть, к которой подключается приложение. В разделе маршрутизации добавьте диапазон адресов виртуальной сети, для которой установлен пиринг с виртуальной сетью, к которой подключается ваше приложение.

## <a name="manage-vnet-integration"></a>Управление интеграцией виртуальной сети

Подключение к виртуальной сети и отключение от нее совершается на уровне приложений. Операции, которые могут повлиять на интеграцию нескольких приложений с виртуальной сетью, выполняются на уровне плана службы приложений. Открыв в приложении раздел **Сеть** > **Интеграция виртуальной сети**, вы можете просмотреть подробные сведения о своей виртуальной сети. Аналогичную информацию можно увидеть на уровне плана службы приложений в разделе **План службы приложений** > **Сеть** > **Интеграция виртуальной сети**.

В экземпляре интеграции с виртуальной сетью на уровне приложения можно выполнить только одну операцию — отключить приложение от той виртуальной сети, к которой оно сейчас подключено. Чтобы отключить приложение от виртуальной сети, нажмите **Отключить**. При отключении от виртуальной сети приложение перезапускается. Виртуальная сеть не меняется при отключении. Подсеть и шлюз не удаляются. Если вы затем захотите удалить виртуальную сеть, сначала отключите от нее приложение и удалите содержащиеся в ней ресурсы, например шлюзы.

В разделе "Интеграция виртуальной сети" плана службы приложений показаны все интеграции с виртуальными сетями, которые ваши приложения используют в рамках вашего плана службы приложений. Чтобы просмотреть сведения о той или иной виртуальной сети, выберите ее. Для интеграции с виртуальной сетью на базе шлюза в этом интерфейсе можно выполнить две операции.

* **Синхронизировать сеть.** Операция синхронизации сети используется только при интеграции с виртуальной сетью на базе шлюза. Эта операция гарантирует, что сертификаты и сведения о сети будут синхронизированы. Если вы добавите или измените DNS виртуальной сети, необходимо выполнить операцию "Синхронизировать сеть". При ее выполнении перезапускаются все приложения, которые используют данную виртуальную сеть. Эта операция не работает для приложения и виртуальной сети, которые относятся к разным подпискам.
* **Добавить маршруты.** При добавлении маршрутов исходящий трафик направляется в вашу виртуальную сеть.

Частный IP-адрес, назначенный экземпляру, предоставляется через переменную среды **WEBSITE_PRIVATE_IP**. В пользовательском интерфейсе консоли KUDU также отображается список переменных среды, доступных для веб-приложения. Этот IP-адрес назначается из диапазона адресов интегрированной подсети. Для интеграции региональной виртуальной сети значение WEBSITE_PRIVATE_IP является IP-адресом из диапазона адресов делегированной подсети, а для интеграции виртуальной сети, необходимой для шлюза, это значение представляет собой IP-адрес из диапазона адресов пула адресации "точка — сеть", настроенного в шлюзе виртуальной сети. Это IP-адрес, который будет использоваться веб-приложением для подключения к ресурсам через виртуальную сеть. 

> [!NOTE]
> Значение WEBSITE_PRIVATE_IP привязано к изменению. Однако это будет IP-адрес в диапазоне адресов подсети интеграции или диапазона адресов "точка — сеть", поэтому необходимо разрешить доступ из всего диапазона адресов.
>

### <a name="gateway-required-vnet-integration-routing"></a>Маршрутизация при интеграции с виртуальной сетью на базе шлюза
Маршруты, определенные в виртуальной сети, используются для направления трафика в виртуальную сеть из вашего приложения. Если вам нужно отправлять в виртуальную сеть дополнительный исходящий трафик, добавьте здесь соответствующие блоки адресов. Эта функция поддерживается только при интеграции с виртуальной сетью на базе шлюза. При интеграции с виртуальной сетью на базе шлюза таблицы маршрутизации не влияют на трафик приложений так же, как при интеграции с региональной виртуальной сетью.

### <a name="gateway-required-vnet-integration-certificates"></a>Сертификаты при интеграции с виртуальной сетью на базе шлюза
После включения интеграции с виртуальной сетью на базе шлюза необходимо произвести обмен сертификатами, который позволяет обеспечить безопасность соединения. Одновременно с сертификатами передаются конфигурация DNS, маршруты и другая полезная информация о сети.

Если сертификаты или сведения о сети изменились, нажмите **Синхронизировать сеть**. **Синхронизация с сетью** сопровождается кратковременной потерей подключения между приложением и виртуальной сетью. Хотя приложение не перезапускается, потеря подключения может привести к нарушению его работоспособности.

## <a name="pricing-details"></a>Сведения о тарифах
Дополнительная плата за интеграцию с региональной виртуальной сетью (помимо стоимость плана службы приложений соответствующей ценовой категории) не взимается.

С интеграцией с виртуальной сетью на базе шлюза связано три вида дополнительных расходов.

* **Ценовая категория плана службы приложений — плата** за использование. приложения должны быть в плане службы приложений уровня "Стандартный", "Премиум", "категории премиум v2" или "PremiumV3". Дополнительные сведения об этих ценах см. в разделе [Цены для Службы приложений][ASPricing].
* **Расходы, связанные с передачей данных.** За исходящий трафик взимается плата, даже если виртуальная сеть находится в том же центре обработки данных. Эти тарифы описаны в [сведениях о ценах за передачу данных][DataPricing].
* **Расходы, связанные с использованием VPN-шлюза.** Взимается плата за шлюз виртуальной сети, необходимый для сети VPN типа "точка — сеть". Дополнительные сведения см. на странице [цен на VPN-шлюз][VNETPricing].

## <a name="troubleshooting"></a>Устранение неполадок

> [!NOTE]
> Интеграция с ВИРТУАЛЬНОЙ сетью не поддерживается для сценариев Docker Compose в службе приложений.
> Ограничения доступа к функциям Azure игнорируются, если присутствует частная конечная точка.
>

[!INCLUDE [app-service-web-vnet-troubleshooting](../../includes/app-service-web-vnet-troubleshooting.md)]

## <a name="automation"></a>Служба автоматизации

Для интеграции с региональной виртуальной сетью поддерживается интерфейс командной строки (CLI). Для доступа к указанным ниже командам [установите Azure CLI][installCLI].

```azurecli
az webapp vnet-integration --help

Group
    az webapp vnet-integration : Methods that list, add, and remove virtual network
    integrations from a webapp.
        This command group is in preview. It may be changed/removed in a future release.
Commands:
    add    : Add a regional virtual network integration to a webapp.
    list   : List the virtual network integrations on a webapp.
    remove : Remove a regional virtual network integration from webapp.

az appservice vnet-integration --help

Group
    az appservice vnet-integration : A method that lists the virtual network
    integrations used in an appservice plan.
        This command group is in preview. It may be changed/removed in a future release.
Commands:
    list : List the virtual network integrations used in an appservice plan.
```

Поддержка PowerShell для региональной интеграции виртуальной сети также доступна, но необходимо создать универсальный ресурс с массивом свойств resourceID подсети.

```azurepowershell
# Parameters
$sitename = 'myWebApp'
$resourcegroupname = 'myRG'
$VNetname = 'myVNet'
$location = 'myRegion'
$integrationsubnetname = 'myIntegrationSubnet'
$subscriptionID = 'aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee'

#Property array with the SubnetID
$properties = @{
  subnetResourceId = "/subscriptions/$subscriptionID/resourceGroups/$resourcegroupname/providers/Microsoft.Network/virtualNetworks/$VNetname/subnets/$integrationsubnetname"
}

#Creation of the VNet integration
$vNetParams = @{
  ResourceName = "$sitename/VirtualNetwork"
  Location = $location
  ResourceGroupName = $resourcegroupname
  ResourceType = 'Microsoft.Web/sites/networkConfig'
  PropertyObject = $properties
}
New-AzResource @vNetParams
```


При интеграции с виртуальной сетью на базе шлюза службу приложений можно интегрировать с виртуальной сетью Azure с помощью PowerShell. Готовый к использованию скрипт см. в статье о [подключении приложения в службе приложений Azure к виртуальной сети Azure](https://gallery.technet.microsoft.com/scriptcenter/Connect-an-app-in-Azure-ab7527e3).


<!--Image references-->
[1]: ./media/web-sites-integrate-with-vnet/vnetint-app.png
[2]: ./media/web-sites-integrate-with-vnet/vnetint-addvnet.png
[3]: ./media/web-sites-integrate-with-vnet/vnetint-classic.png
[5]: ./media/web-sites-integrate-with-vnet/vnetint-regionalworks.png
[6]: ./media/web-sites-integrate-with-vnet/vnetint-gwworks.png


<!--Links-->
[VNETOverview]: ../virtual-network/virtual-networks-overview.md
[AzurePortal]: https://portal.azure.com/
[ASPricing]: https://azure.microsoft.com/pricing/details/app-service/
[VNETPricing]: https://azure.microsoft.com/pricing/details/vpn-gateway/
[DataPricing]: https://azure.microsoft.com/pricing/details/data-transfers/
[V2VNETP2S]: ../vpn-gateway/vpn-gateway-howto-point-to-site-rm-ps.md
[ILBASE]: environment/create-ilb-ase.md
[V2VNETPortal]: ../vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal.md
[VPNERCoex]: ../expressroute/expressroute-howto-coexist-resource-manager.md
[ASE]: environment/intro.md
[creategatewaysubnet]: ../vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal.md#creategw
[creategateway]: ../vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal.md#creategw
[setp2saddresses]: ../vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal.md#addresspool
[VNETRouteTables]: ../virtual-network/manage-route-table.md
[installCLI]: /cli/azure/install-azure-cli?view=azure-cli-latest%2f
[privateendpoints]: networking/private-endpoint.md
