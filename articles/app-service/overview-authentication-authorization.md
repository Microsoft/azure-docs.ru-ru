---
title: Аутентификация и авторизация
description: Узнайте о встроенной поддержке проверки подлинности и авторизации в службе приложений Azure и функциях Azure, а также о том, как она помогает защитить приложение от несанкционированного доступа.
ms.assetid: b7151b57-09e5-4c77-a10c-375a262f17e5
ms.topic: article
ms.date: 07/08/2020
ms.reviewer: mahender
ms.custom: seodec18, fasttrack-edit, has-adal-ref
ms.openlocfilehash: 35513abdfb61d889abdbd4af7125b1fbb556d7b8
ms.sourcegitcommit: c94e282a08fcaa36c4e498771b6004f0bfe8fb70
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/26/2021
ms.locfileid: "105612761"
---
# <a name="authentication-and-authorization-in-azure-app-service-and-azure-functions"></a>Проверка подлинности и авторизация в службе приложений Azure и функциях Azure

Служба приложений Azure предоставляет встроенные возможности проверки подлинности и авторизации (иногда называется "простой проверкой подлинности"), поэтому вы можете входить в систему пользователей и получать доступ к данным, записывая в веб-приложение, API RESTful и серверной части мобильных приложений минимальный код или нет, а также [функции Azure](../azure-functions/functions-overview.md). В этой статье описывается, как служба приложений помогает упростить проверку подлинности и авторизацию для вашего приложения.

## <a name="why-use-the-built-in-authentication"></a>Зачем использовать встроенную проверку подлинности?

Для проверки подлинности и авторизации не требуется использовать эту функцию. Вы можете использовать объединенные функции безопасности в вашей веб-среде или написать собственные служебные программы. Однако необходимо обеспечить актуальность вашего решения с помощью последних обновлений безопасности, протокола и браузера.

Реализация безопасного решения для проверки подлинности (пользователей входа) и авторизации (предоставление доступа к защищенным данным) может потребовать значительных усилий. Необходимо следовать рекомендациям и стандартам отрасли и обеспечить актуальность вашей реализации. Встроенная функция проверки подлинности для службы приложений и функций Azure позволяет экономить время и усилия, предоставляя встроенную проверку подлинности с помощью федеративных поставщиков удостоверений, что позволяет сосредоточиться на остальной части вашего приложения.

- Служба приложений Azure позволяет интегрировать различные возможности проверки подлинности в веб-приложение или API, не реализуя их самостоятельно.
- Она встроена непосредственно в платформу и не требует какого бы то ни было конкретного языка, пакета SDK, знаний по безопасности или даже любого кода для использования.
- Можно выполнить интеграцию с несколькими поставщиками входа в систему. Например, Azure AD, Facebook, Google, Twitter.

## <a name="identity-providers"></a>Поставщики удостоверений

Служба приложений использует [федеративную идентификацию](https://en.wikipedia.org/wiki/Federated_identity), при которой сторонний поставщик управляет удостоверениями пользователей и потоком проверки подлинности. По умолчанию доступны следующие поставщики удостоверений.

| Поставщик | Конечная точка входа | Руководство по How-To |
| - | - | - |
| [Azure Active Directory](../active-directory/fundamentals/active-directory-whatis.md) | `/.auth/login/aad` | [Имя входа в службу приложений Azure AD](configure-authentication-provider-aad.md) |
| [Учетная запись Майкрософт](../active-directory/develop/v2-overview.md) | `/.auth/login/microsoftaccount` | [Вход в учетную запись Майкрософт для службы приложений](configure-authentication-provider-microsoft.md) |
| [Facebook](https://developers.facebook.com/docs/facebook-login) | `/.auth/login/facebook` | [Имя входа в Facebook службы приложений](configure-authentication-provider-facebook.md) |
| [Google](https://developers.google.com/identity/choose-auth) | `/.auth/login/google` | [Имя входа Google службы приложений](configure-authentication-provider-google.md) |
| [Twitter](https://developer.twitter.com/en/docs/basics/authentication) | `/.auth/login/twitter` | [Имя входа в Twitter службы приложений](configure-authentication-provider-twitter.md) |
| Любой поставщик [OpenID Connect Connect](https://openid.net/connect/) (Предварительная версия) | `/.auth/login/<providerName>` | [Имя входа для подключения к службе приложений OpenID Connect](configure-authentication-provider-openid-connect.md) |

При включении проверки подлинности и авторизации с помощью одного из этих поставщиков конечная точка входа станет доступной для проверки подлинности пользователя и для проверки токенов проверки подлинности от поставщика. Вы можете предоставить пользователям любое количество параметров входа.

## <a name="considerations-for-using-built-in-authentication"></a>Рекомендации по использованию встроенной проверки подлинности

Включение этой функции приведет к автоматическому перенаправлению всех запросов к приложению по протоколу HTTPS независимо от параметра конфигурации службы приложений для принудительного применения HTTPS. Это можно отключить с помощью  `requireHttps` параметра в конфигурации v2. Однако мы рекомендуем придерживаться протокола HTTPS, и вы должны убедиться, что маркеры безопасности не передаются через небезопасные подключения HTTP.

Службу приложений можно использовать для проверки подлинности с помощью или без ограничения доступа к содержимому и API сайта. Чтобы ограничить доступ приложений только для пользователей, прошедших проверку подлинности, задайте **действие, которое будет выполняться, если запрос не прошел проверку подлинности** для входа с помощью одного из настроенных поставщиков удостоверений. Чтобы выполнить проверку подлинности, но не ограничивать доступ, задайте **действие, которое будет выполняться, если запрос не прошел проверку подлинности** в "разрешить анонимные запросы (без действий)".

> [!NOTE]
> Каждому приложению следует присвоить свое разрешение и согласие. Создайте отдельные регистрации приложений для отдельных слотов развертывания, чтобы не предоставлять общий доступ к разрешениям в средах. Это поможет предотвратить проблемы с рабочим приложением при тестировании нового кода.

## <a name="how-it-works"></a>Принцип работы

[Архитектура функций в Windows (без развертывания контейнера)](#feature-architecture-on-windows-non-container-deployment))

[Архитектура функций в Linux и контейнерах](#feature-architecture-on-linux-and-containers)

[Поток проверки подлинности](#authentication-flow)

[Поведение авторизации](#authorization-behavior)

[Утверждения пользователей и приложений](#user-and-application-claims)

[Хранилище токенов](#token-store)

[Ведение журнала и трассировка](#logging-and-tracing)

#### <a name="feature-architecture-on-windows-non-container-deployment"></a>Архитектура функций в Windows (без развертывания контейнера)

Модуль проверки подлинности и авторизации выполняется в той же песочнице, что и код приложения. Если он включен, каждый входящий HTTP-запрос проходит через него перед обработкой кодом вашего приложения.

:::image type="content" source="media/app-service-authentication-overview/architecture.png" alt-text="Схема архитектуры, показывающая запросы, перехваченные процессом в песочнице сайта, который взаимодействует с поставщиками удостоверений до разрешения трафика на развернутый сайт." lightbox="media/app-service-authentication-overview/architecture.png":::

Этот модуль выполняет следующие операции для вашего приложения:

- проверку подлинности пользователей с указанным поставщиком;
- проверку, хранение и обновление токенов;
- управление сеансом с проверкой подлинности;
- вставка сведений об удостоверении в заголовки запросов.

Модуль работает отдельно от кода приложения и настраивается с помощью параметров приложения. Для кода приложения не нужны пакеты SDK, определенные языки или изменения. 

#### <a name="feature-architecture-on-linux-and-containers"></a>Архитектура функций в Linux и контейнерах

Модуль проверки подлинности и авторизации выполняется в отдельном контейнере, изолированном от кода приложения. Используя то, что известно как [шаблон посредник](/azure/architecture/patterns/ambassador), он взаимодействует с входящим трафиком для выполнения аналогичных функций в Windows. Поскольку она не выполняется в процессе, прямая интеграция с конкретными языковыми платформами невозможна; Однако соответствующие сведения, необходимые вашему приложению, передаются с помощью заголовков запросов, как описано ниже.

#### <a name="authentication-flow"></a>Поток проверки подлинности

Поток проверки подлинности одинаков для всех поставщиков, но будет различным для разных способов входа в систему: с использованием пакета SDK поставщика или без.

- Без использования пакета SDK поставщика. Приложение делегирует федеративный вход в службу приложений. Обычно это относится к приложениям браузера, которые могут предоставить пользователю страницу входа поставщика. Код сервера управляет процессом входа, поэтому он также называется _управляемым сервером потоком_ или _потоком сервера_. Этот вариант применяется к браузерным приложениям. Он также относится к собственным приложениям, в которых вход пользователей в систему выполняется с помощью пакета SDK для клиента мобильных приложений. Пакет SDK открывает веб-представление, в котором пользователи выполняют вход с помощью проверки подлинности службы приложений.
- С использованием пакета SDK поставщика. Вход пользователей в приложение на странице поставщика выполняется вручную, а затем приложение отправляет маркер проверки подлинности в Службу приложений Azure для проверки. Обычно это относится к внебраузерным приложениям, которые не могут предоставить пользователю страницу входа в систему. Код приложения управляет процессом входа, поэтому его также называют _управляемым клиентом потоком_ или _потоком клиента_. Этот вариант применяется к REST API, [Функциям Azure](../azure-functions/functions-overview.md) и клиентам браузера JavaScript, а также к браузерным приложениям, которым требуется больше гибкости при входе в систему. Это также относится к собственным мобильным приложениям, в которых вход пользователей в систему выполняется с помощью пакета SDK поставщика.

Вызовы из доверенного приложения браузера в службе приложений на другой REST API в службе приложений или в [функции Azure](../azure-functions/functions-overview.md) могут проходить проверку подлинности с помощью управляемого сервером потока. Дополнительные сведения см. в статье [Настройка проверки подлинности и авторизации в Службе приложений Azure](app-service-authentication-how-to.md).

В приведенной ниже таблице показаны шаги выполнения потока проверки подлинности.

| Шаг | Без использования пакета SDK поставщика | С использованием пакета SDK поставщика |
| - | - | - |
| 1. вход пользователя | Перенаправляет клиента к `/.auth/login/<provider>`. | Код клиента выполняет вход пользователя непосредственно через пакет SDK поставщика и получает токен проверки подлинности. Дополнительные сведения см. в документации поставщика. |
| 2. После проверки подлинности | Поставщик перенаправляет клиент к `/.auth/login/<provider>/callback`. | Клиентский код [отправляет токен из поставщика](app-service-authentication-how-to.md#validate-tokens-from-providers) в `/.auth/login/<provider>` для проверки. |
| 3. Установите сеанс с проверкой подлинности | Служба приложений добавляет файлы cookie, прошедшие проверку подлинности, в ответ. | Служба приложений возвращает собственный токен проверки подлинности в код клиента. |
| 4. предоставление содержимого, прошедшего проверку подлинности | Клиент включает файлы cookie, прошедшие проверку подлинности, в последующие запросы (автоматически обрабатываются браузером). | Код клиента предоставляет токен проверки подлинности в заголовке `X-ZUMO-AUTH` (автоматически обрабатывается пакетами SDK для клиента мобильных приложений). |

Для клиентских браузеров служба приложений может автоматически перенаправлять всех не прошедших проверку пользователей к `/.auth/login/<provider>`. Вы также можете отправить пользователям одну или несколько ссылок `/.auth/login/<provider>`, чтобы они вошли в ваше приложение с использованием поставщика по выбору.

<a name="authorization"></a>

#### <a name="authorization-behavior"></a>Поведение авторизации

В [портал Azure](https://portal.azure.com)можно настроить авторизацию службы приложений с помощью ряда поведений, если входящий запрос не прошел проверку подлинности.

![Снимок экрана, показывающий раскрывающееся меню "действие, которое необходимо выполнить, если запрос не прошел проверку подлинности"](media/app-service-authentication-overview/authorization-flow.png)

Ниже описаны возможные варианты.

**Разрешить анонимные запросы (без действий)**

Этот параметр откладывает авторизацию трафика, не прошедшего проверку подлинности, в код приложения. Для запросов, прошедших проверку подлинности, служба приложений также передает сведения о проверке подлинности в заголовках HTTP.

Такой вариант обеспечивает большую гибкость в обработке анонимных запросов. Например, он позволяет [предоставлять пользователям несколько поставщиков входа](app-service-authentication-how-to.md#use-multiple-sign-in-providers). Тем не менее необходимо написать код.

**Разрешить только запросы, прошедшие проверку подлинности**

Параметр используется **для \<provider> входа в систему**. Служба приложений перенаправляет все анонимные запросы к `/.auth/login/<provider>` для выбранного вами поставщика. Если анонимный запрос поступает из собственного мобильного приложения, возвращаемый ответ `HTTP 401 Unauthorized`.

В этом случае в клиентском приложении не нужен код для проверки подлинности. Более точная авторизация, например авторизация для конкретной роли, может выполняться путем проверки утверждений пользователя (см. раздел [Access user claims](app-service-authentication-how-to.md#access-user-claims) (Доступ к утверждениям пользователя)).

> [!CAUTION]
> Таким образом, ограниченный доступ применяется ко всем вызовам приложения, что может быть нежелательно для приложений, которым требуется общедоступная Домашняя страница, как во многих одностраничных приложениях.

> [!NOTE]
> По умолчанию любой пользователь в клиенте Azure AD может запросить маркер для вашего приложения из Azure AD. Вы можете [настроить приложение в Azure AD](../active-directory/develop/howto-restrict-your-app-to-a-set-of-users.md) , если вы хотите ограничить доступ к приложению определенным набором пользователей.


#### <a name="user-and-application-claims"></a>Утверждения пользователей и приложений

Для всех языковых платформ служба приложений делает утверждения в входящем токене (от пользователя, прошедшего проверку подлинности или клиентское приложение) доступным для кода путем их вставки в заголовки запроса. Для приложений ASP.NET 4.6 служба приложений заполняет свойство [ClaimsPrincipal.Current](/dotnet/api/system.security.claims.claimsprincipal.current) утверждениями пользователя, прошедшими проверку подлинности, поэтому вы можете следовать стандартным шаблонам кода .NET, включая атрибут `[Authorize]`. Аналогичным образом для приложений PHP служба приложений заполняет переменную `_SERVER['REMOTE_USER']`. Для приложений Java утверждения доступны в [Tomcat сервлета](configure-language-java.md#authenticate-users-easy-auth).

Для [функций Azure](../azure-functions/functions-overview.md) `ClaimsPrincipal.Current` не заполняется для кода .NET, но вы по-прежнему можете найти утверждения пользователя в заголовках запроса или получить `ClaimsPrincipal` объект из контекста запроса или даже через параметр привязки. Дополнительные сведения см. [в разделе Работа с удостоверениями клиентов](../azure-functions/functions-bindings-http-webhook-trigger.md#working-with-client-identities) .

Дополнительные сведения см. в разделе [Access user claims](app-service-authentication-how-to.md#access-user-claims) (Доступ к утверждениям пользователя).

В настоящее время ASP.NET Core не поддерживает заполнение текущего пользователя с помощью функции проверки подлинности и авторизации. Однако для заполнения этого зазора существуют некоторые [сторонние компоненты по промежуточного слоя с открытым кодом](https://github.com/MaximRouiller/MaximeRouiller.Azure.AppService.EasyAuth) .

#### <a name="token-store"></a>Хранилище токенов

Служба приложений предоставляет встроенное хранилище токенов, которое представляет собой репозиторий токенов, связанных с пользователями ваших веб-приложений, API или собственных мобильных приложений. При включении проверки подлинности с помощью любого поставщика это хранилище токенов немедленно становится доступным для вашего приложения. Если для кода вашего приложения требуется доступ к данным из этих поставщиков от имени пользователя, чтобы:

- опубликовать запись в ленте Facebook прошедшего проверку подлинности пользователя;
- чтение корпоративных данных пользователя с помощью API Microsoft Graph

Как правило, вам необходимо писать код для сбора, хранения и обновления этих токенов в своем приложении. В хранилище токенов при необходимости вы просто [извлекаете токены](app-service-authentication-how-to.md#retrieve-tokens-in-app-code) и [указываете службе приложений обновить их](app-service-authentication-how-to.md#refresh-identity-provider-tokens), если они становятся недопустимыми. 

Маркеры ID, маркеры доступа и маркеры обновления кэшируются для сеанса с проверкой подлинности и доступны только связанному пользователю.  

Если вам не нужно работать с токенами в приложении, хранилище токенов можно отключить на странице **аутентификации и авторизации** приложения.

#### <a name="logging-and-tracing"></a>Ведение журнала и трассировка

Если вы [включите ведение журнала приложений](troubleshoot-diagnostic-logs.md), вы увидите трассировку проверки подлинности и авторизации непосредственно в файлах журналов. Если отображается сообщение об ошибке проверки подлинности, которое не ожидалось, вы можете найти все детали, просмотрев существующие журналы приложений. Если вы включили [трассировку неудачно завершенных запросов](troubleshoot-diagnostic-logs.md), вы можете точно определить, какую роль мог выполнять модуль проверки подлинности и авторизации в неудавшемся запросе. Найдите ссылки на модуль с именем `EasyAuthModule_32/64` в журналах трассировки.

## <a name="more-resources"></a>Дополнительные ресурсы

- [Пошаговое руководство. Настройка службы приложений или приложения функций Azure для использования имени входа Azure AD](configure-authentication-provider-aad.md)
- [Дополнительные возможности использования проверки подлинности и авторизации в Службе приложений Azure](app-service-authentication-how-to.md)

Примеры:
- [Руководство по добавлению проверки подлинности в веб-приложение, работающее в Службе приложений Azure](scenario-secure-app-authentication-app-service.md)
- [Руководство. сквозная проверка подлинности и авторизация пользователей в службе приложений Azure (Windows или Linux)](tutorial-auth-aad.md)
- [Интеграция .NET Core с Azure AppService Еасяус (третья сторона)](https://github.com/MaximRouiller/MaximeRouiller.Azure.AppService.EasyAuth)
- [Получение проверки подлинности службы приложений Azure с помощью .NET Core (третья сторона)](https://github.com/kirkone/KK.AspNetCore.EasyAuthAuthentication)
