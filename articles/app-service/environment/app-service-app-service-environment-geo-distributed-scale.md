---
title: Географически распределенное масштабирование
description: Узнайте, как горизонтально масштабировать приложения на основе географического распределения с помощью диспетчера трафика и сред службы приложения.
author: stefsch
ms.assetid: c1b05ca8-3703-4d87-a9ae-819d741787fb
ms.topic: article
ms.date: 09/07/2016
ms.author: stefsch
ms.custom: seodec18, references_regions
ms.openlocfilehash: 004b32118521f72c5b59ad7bab2d4e41244b85c4
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "85833610"
---
# <a name="geo-distributed-scale-with-app-service-environments"></a>Географически распределенное масштабирование с использованием Среды службы приложений
## <a name="overview"></a>Обзор

[!INCLUDE [updated-for-az](../../../includes/updated-for-az.md)]

Сценарии приложений, требующие очень высокого масштаба, могут превышать емкость ресурсов вычислений, доступную для одного развертывания приложения.  К примерам таких сценариев относятся проведение голосования, организация спортивных событий и телевизионных трансляций. Высокомасштабируемые требования могут быть выполнены с помощью горизонтального масштабирования приложений. Для удовлетворения требований к экстремальной нагрузке многие развертывания приложений могут выполняться в одном регионе и в разных регионах.

Среды службы приложений — это идеальная платформа для горизонтального масштабирования. После выбора конфигурации Среда службы приложений, которая поддерживает известную частоту запросов, разработчики могут развернуть дополнительные среды службы приложений в "резчике файлов cookie", чтобы достичь желаемой емкости пиковой нагрузки.

Например, предположим, что приложение, запущенное в конфигурации Среда службы приложений, было протестировано на обработку запросов 20 000 в секунду (RPS).  Если желаемая емкость пиковой нагрузки составляет 100 КБ, можно создать и настроить пять сред службы приложений, чтобы приложение могла обрабатывать максимальную проектируемую нагрузку.

Поскольку клиенты обычно обращаются к приложениям, используя именной (личный) домен, разработчикам необходим способ распределения запросов к приложению между всеми экземплярами среды службы приложений.  Отличный способ добиться этой цели — разрешить личный домен с помощью [профиля диспетчера трафика Azure][AzureTrafficManagerProfile].  Можно настроить профиль диспетчера трафика таким образом, чтобы он указывал на все отдельные среды службы приложений.  Диспетчер трафика будет автоматически распределять клиентов по всем средам службы приложений на основе параметров балансировки нагрузки в профиле диспетчера трафика.  Этот подход работает независимо от того, развернуты среды службы приложений в одном регионе Azure или в нескольких.

Кроме того, поскольку клиенты обращаются к приложениям через именной домен, они не знают, в скольких средах службы приложений выполняется приложение.  Поэтому разработчики могут быстро добавлять и удалять среды службы приложений в зависимости от ожидаемого трафика.

На следующей схеме представлено приложение, выполняющееся в трех средах службы приложений в одном регионе.

![Концепция архитектуры][ConceptualArchitecture] 

Далее мы рассмотрим действия, связанные с настройкой распределенной топологии приложения. В нашем примере оно будет развернуто в нескольких средах службы приложений.

## <a name="planning-the-topology"></a>Планирование топологии
Прежде чем построить распределенную топологию приложения, необходимо собрать некоторые сведения.

* **Личный домен приложения.**  Какое имя домена клиенты будут использовать для доступа к приложению?  Для примера приложения имя пользовательского домена — `www.scalableasedemo.com` .
* **Домен диспетчера трафика:** При создании [профиля диспетчера трафика Azure][AzureTrafficManagerProfile]выберите имя домена.  При регистрации записи домена, используемой диспетчером трафика, к этому имени будет добавлен суффикс *trafficmanager.net*.  В нашем примере приложения используется имя *scalable-ase-demo*,  поэтому полное имя домена, управляемое диспетчером трафика, — *scalable-ase-demo.trafficmanager.net*.
* **Стратегия масштабирования приложения.**  Как будет распределяться нагрузка между несколькими средами службы приложений? Они будут размещаться в одном регионе,  в нескольких регионах,  или вы будете применять гибридный подход?  Следует основываться на ожиданиях, в которых будет исходить трафик клиента, а также о том, насколько хорошо вся остальная Серверная инфраструктура поддерживает масштабирование.  Например, при использовании приложения без отслеживания состояния 100% приложение можно масштабировать с помощью сочетания нескольких сред службы приложений в каждом регионе Azure, умноженное на среды службы приложений, развернутые в нескольких регионах Azure.  Сейчас доступно более 15 глобальных регионов Azure. Поэтому клиенты могут создать по-настоящему глобальное гипермасштабируемое приложение.  Для примера приложения, которое используется в этой статье, в одном регионе Azure были созданы три среды службы приложений (Юго-Центральный регион США).
* **Соглашение об именовании для Сред службы приложений.**  Имя каждой Среды службы приложений должно быть уникальным.  Если используется больше двух сред Службы приложений, для их идентификации желательно использовать определенное соглашение об именовании.  Для примера приложения использовалось простое соглашение об именовании.  Среды службы приложений называются *fe1ase*, *fe2ase* и *fe3ase*.
* **Соглашение об именовании приложений.**  Так как предполагается развертывание нескольких экземпляров приложения, каждому из них необходимо присвоить уникальное имя.  Одной из самых маленьких, но удобных функций сред службы приложений является то, что одно и то же имя приложения можно использовать в нескольких средах службы приложений.  Так как у каждой среды Службы приложений есть уникальный доменный суффикс, разработчики могут использовать одно и то же имя приложения во всех средах.  Например, разработчик может иметь приложения, названные следующим образом:  *MyApp.Foo1.p.azurewebsites.NET*, *MyApp.Foo2.p.azurewebsites.NET*, *MyApp.foo3.p.azurewebsites.NET* и т. д.  Однако для примера приложения каждый экземпляр приложения также имеет уникальное имя.  *webfrontend1*, *webfrontend2* и *webfrontend3*.

## <a name="setting-up-the-traffic-manager-profile"></a>Настройка профиля диспетчера трафика
После развертывания нескольких экземпляров приложения в нескольких средах службы приложений отдельные экземпляры приложения можно зарегистрировать в диспетчере трафика.  Для примера приложения необходим профиль диспетчера трафика для *Scalable-ASE-Demo.trafficmanager.NET* , который может маршрутизировать клиентов к любому из следующих развернутых экземпляров приложения:

* **webfrontend1.fe1ase.p.azurewebsites.net:**  экземпляр примера приложения, развернутый в первой Среде службы приложений;
* **webfrontend2.fe2ase.p.azurewebsites.net:**  экземпляр примера приложения, развернутый во второй Среде службы приложений;
* **webfrontend3.fe3ase.p.azurewebsites.net:**  экземпляр примера приложения, развернутый в третей Среде службы приложений.

Самый простой способ регистрации нескольких конечных точек службы приложений Azure, работающих в **одном** регионе Azure, — это [Поддержка диспетчера трафика PowerShell Azure Resource Manager][ARMTrafficManager].  

Прежде всего необходимо создать профиль диспетчера трафика Azure.  Ниже приведен код, создающий профиль для нашего примера приложения.

```azurepowershell-interactive
$profile = New-AzureTrafficManagerProfile –Name scalableasedemo -ResourceGroupName yourRGNameHere -TrafficRoutingMethod Weighted -RelativeDnsName scalable-ase-demo -Ttl 30 -MonitorProtocol HTTP -MonitorPort 80 -MonitorPath "/"
```

Обратите внимание, что для параметра *relativeDnsName* задано значение *scalable-ase-demo*.  Этот параметр приводит к тому, что доменное имя *Scalable-ASE-Demo.trafficmanager.NET* создается и связывается с профилем диспетчера трафика.

Параметр *TrafficRoutingMethod* определяет, как диспетчер трафика политики балансировки нагрузки будет использоваться для определения способа распределения нагрузки клиента по всем доступным конечным точкам.  В этом примере был выбран *взвешенный* метод.  По этой причине запросы клиентов будут распределяться по всем зарегистрированным конечным точкам приложений на основе относительных весов, связанных с каждой конечной точкой. 

После создания профиля каждый экземпляр приложения добавляется в профиль как собственная конечная точка Azure.  Следующий код извлекает ссылку на каждое веб-приложение внешнего интерфейса. Затем каждое приложение добавляется в качестве конечной точки диспетчера трафика с помощью параметра *TargetResourceId* .

```azurepowershell-interactive
$webapp1 = Get-AzWebApp -Name webfrontend1
Add-AzureTrafficManagerEndpointConfig –EndpointName webfrontend1 –TrafficManagerProfile $profile –Type AzureEndpoints -TargetResourceId $webapp1.Id –EndpointStatus Enabled –Weight 10

$webapp2 = Get-AzWebApp -Name webfrontend2
Add-AzureTrafficManagerEndpointConfig –EndpointName webfrontend2 –TrafficManagerProfile $profile –Type AzureEndpoints -TargetResourceId $webapp2.Id –EndpointStatus Enabled –Weight 10

$webapp3 = Get-AzWebApp -Name webfrontend3
Add-AzureTrafficManagerEndpointConfig –EndpointName webfrontend3 –TrafficManagerProfile $profile –Type AzureEndpoints -TargetResourceId $webapp3.Id –EndpointStatus Enabled –Weight 10

Set-AzureTrafficManagerProfile –TrafficManagerProfile $profile
```

Обратите внимание, что для каждого экземпляра приложения используется один вызов *Add-AzureTrafficManagerEndpointConfig* .  Параметр *TargetResourceId* в каждой команде PowerShell ссылается на один из трех развернутых экземпляров приложения.  Профиль диспетчера трафика будет распределять нагрузку на все три конечные точки, зарегистрированные в профиле.

Для всех трех конечных точек используется одно и то же значение параметра *Weight* (10),  В этом случае диспетчер трафика распределяет запросы клиентов по всем трем экземплярам приложений относительно равномерно. 

## <a name="pointing-the-apps-custom-domain-at-the-traffic-manager-domain"></a>Перенаправление трафика с именного домена приложения на домен диспетчера трафика
В заключение необходимо настроить разрешение именного домена приложения в домен диспетчера трафика.  Для примера приложения наведите указатель `www.scalableasedemo.com` на `scalable-ase-demo.trafficmanager.net` .  Выполните этот шаг с регистратором домена, который управляет пользовательским доменом.  

Используя средства управления доменом, предоставленными регистратором, необходимо создать записи CNAME, которые будут разрешать именной домен в домен диспетчера трафика.  На рисунке ниже показан пример конфигурации CNAME:

![CNAME для именного домена][CNAMEforCustomDomain] 

Хотя в этой статье мы не рассматриваем регистрацию доменов, помните, что для каждого отдельного экземпляра приложения необходимо также зарегистрировать именной домен.  В противном случае, если запрос делает его экземпляром приложения и приложение не зарегистрировало личный домен с приложением, запрос завершится ошибкой.

В этом примере личный домен имеет значение `www.scalableasedemo.com` , и каждый экземпляр приложения имеет связанный с ним личный домен.

![Личный домен][CustomDomain] 

Сведения о регистрации личного домена в приложениях службы приложений Azure см. в статье [Регистрация пользовательских доменов][RegisterCustomDomain].

## <a name="trying-out-the-distributed-topology"></a>Тестирование распределенной топологии
Целью настройки Диспетчера трафика и DNS является перенаправление запросов, отправленных на `www.scalableasedemo.com`, по следующему маршруту:

1. Браузер или устройство выполняет поиск DNS по `www.scalableasedemo.com`.
2. Запись CNAME у регистратора домена перенаправляет запрос на диспетчер трафика Azure.
3. Поиск *scalable-ase-demo.trafficmanager.net* выполняется на одном из DNS-серверов диспетчера трафика Azure.
4. В зависимости от политики балансировки нагрузки, указанной ранее в параметре *TrafficRoutingMethod* , диспетчер трафика выбирает одну из настроенных конечных точек. Затем он возвращает полное доменное имя этой конечной точки браузеру или устройству.
5. Так как полное доменное имя конечной точки является URL-адресом экземпляра приложения, который выполняется на Среда службы приложений, браузер или устройство запросит Microsoft Azure DNS-сервер, чтобы разрешить полное доменное имя в IP-адрес. 
6. Браузер или устройство отправляет HTTP- или HTTPS-запрос на этот IP-адрес.  
7. Запрос поступает на один из экземпляров приложения, выполняющийся в одной из сред службы приложений.

На изображении консоли ниже показан поиск в DNS для пользовательского домена примера приложения. Он успешно разрешается в экземпляр приложения, работающий в одной из трех примеров среды службы приложений (в данном случае это вторая из трех сред службы приложений):

![Поиск в DNS][DNSLookup] 

## <a name="additional-links-and-information"></a>Дополнительные ссылки и сведения
Документация по PowerShell [Azure Resource Manager поддержки диспетчера трафика][ARMTrafficManager].  

[!INCLUDE [app-service-web-try-app-service](../../../includes/app-service-web-try-app-service.md)]

<!-- LINKS -->
[AzureTrafficManagerProfile]: ../../traffic-manager/traffic-manager-manage-profiles.md
[ARMTrafficManager]: ../../traffic-manager/traffic-manager-powershell-arm.md
[RegisterCustomDomain]: ../app-service-web-tutorial-custom-domain.md


<!-- IMAGES -->
[ConceptualArchitecture]: ./media/app-service-app-service-environment-geo-distributed-scale/ConceptualArchitecture-1.png
[CNAMEforCustomDomain]:  ./media/app-service-app-service-environment-geo-distributed-scale/CNAMECustomDomain-1.png
[DNSLookup]:  ./media/app-service-app-service-environment-geo-distributed-scale/DNSLookup-1.png
[CustomDomain]:  ./media/app-service-app-service-environment-geo-distributed-scale/CustomDomain-1.png 
