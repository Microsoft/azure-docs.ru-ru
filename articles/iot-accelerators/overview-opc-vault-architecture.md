---
title: Архитектура хранилища OPC (Azure) | Документация Майкрософт
description: Архитектура службы управления сертификатами для хранилища OPC
author: mregen
ms.author: mregen
ms.date: 08/16/2019
ms.topic: overview
ms.service: industrial-iot
services: iot-industrialiot
manager: philmea
ms.openlocfilehash: eb558d967ad657d14158684fba92b13979ea5fe2
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "91281594"
---
# <a name="opc-vault-architecture"></a>Архитектура хранилища OPC

> [!IMPORTANT]
> Актуальную информацию по этой теме см. в статье [Промышленный Интернет вещей в Azure](https://azure.github.io/Industrial-IoT/).

В этой статье приводятся общие сведения о микрослужбе хранилища OPC и модуле IoT Edge хранилища OPC.

Приложения OPC UA используют сертификаты экземпляра приложения для обеспечения безопасности на уровне приложения. Безопасное соединение устанавливается с помощью асимметричной криптографии, для которой сертификаты приложений предоставляют пару из открытого и закрытого ключей. Сертификаты могут быть самозаверяющими или выданными центром сертификации (ЦС).

Приложение OPC UA содержит список доверенных сертификатов для приложений, которым оно доверяет. Эти сертификаты могут быть самозаверяющими или выданными центром сертификации (ЦС), а также корневым ЦС или дополнительным ЦС. Если доверенный сертификат является частью более крупной цепочки сертификатов, приложение доверяет всем сертификатам в этой цепочке вплоть до сертификата, включенного в список доверия. Это справедливо до тех пор, пока есть возможность проверить всю цепочку сертификатов.

Основное различие между доверием к самозаверяющим сертификатам и к сертификату ЦС заключается в том, что для первого потребуются дополнительные усилия на установку и поддержание доверия. Также необходимы дополнительные трудозатраты для размещения центра сертификации конкретной компании. 

Чтобы распространить доверие на самозаверяющие сертификаты для нескольких серверов с одним клиентским приложением, необходимо установить все сертификаты серверных приложений в списке доверия клиентского приложения. Кроме того, необходимо установить сертификат клиентского приложения в списках доверия для всех серверных приложений. Это административное усилие является довольно обременительным и даже увеличивается, когда необходимо учитывать срок действия сертификатов и обновлять сертификаты.

Использование центра сертификации конкретной компании может значительно упростить управление доверием при нескольких серверах и клиентах. В этом случае администратор создает сертификат экземпляра приложения, подписанный центром сертификации, только один раз для каждого используемого клиента и сервера. Кроме того, сертификат ЦС устанавливается в каждом списке доверия приложений на всех серверах и клиентах. При таком подходе нужно обновлять только сертификаты с истекшим сроком действия, заменяя их в затронутых приложениях.

Служба управления сертификатами Azure Industrial IoT OPC UA помогает управлять ЦС для конкретной компании для приложений OPC UA. Эта служба основана на микрослужбе хранилища OPC. Хранилище OPC предоставляет микрослужбу для размещения центра сертификации конкретной компании в безопасном облаке. Это решение обеспечивается службами, защищенными Azure Active Directory (Azure AD), Azure Key Vault с помощью аппаратных модулей безопасности (HSM), Azure Cosmos DB, и, при необходимости, центром Интернета вещей в качестве магазина приложений.

Микрослужба хранилища OPC предназначена для поддержки рабочего процесса на основе ролей, где администраторы по безопасности и утверждающие лица с правами подписи в Azure Key Vault одобряют или отклоняют запросы.

Для обеспечения совместимости с существующими решениями OPC UA, службы включают поддержку модуля Edge микрослужбы хранилища OPC. Это реализует интерфейс **Сервер глобального обнаружения OPC UA и управления сертификатами**, чтобы распространять сертификаты и списки доверия в соответствии с частью 12 спецификации. 


## <a name="architecture"></a>Architecture

Архитектура основана на микрослужбе хранилища OPC с модулем IoT Edge хранилища OPC для сети фабрики и примером веб-интерфейса для управления рабочим процессом:

![Схема архитектуры хранилища OPC](media/overview-opc-vault-architecture/opc-vault.png)

## <a name="opc-vault-microservice"></a>Микрослужба хранилища OPC

Микрослужба хранилища OPC состоит из следующих интерфейсов, которые позволяют реализовать рабочий процесс для распространения ЦС конкретной компании и управления им для приложений OPC UA.

### <a name="application"></a>Приложение 
- Приложение OPC UA может выполнять роль сервера, клиента или обоих одновременно. В этом случае хранилище OPC выступает в качестве центра регистрации приложений. 
- В дополнение к основным операциям по регистрации, обновлению и отмене регистрации приложений, предоставляются интерфейсы для поиска приложений и запросов к ним с использованием выражений поиска. 
- Запрос сертификата должен ссылаться на допустимое приложение, чтобы обрабатывать запрос и возвращать подписанный сертификат со всеми расширениями для OPC UA. 
- Служба приложения поддерживается базой данных в Azure Cosmos DB.

### <a name="certificate-group"></a>Группа сертификатов
- Группа сертификатов — это сущность, в которой хранится сертификат корневого или второстепенного ЦС, включая закрытый ключ для подписывания сертификатов. 
- Длина ключа RSA, длина хэша SHA-2 и время существования настраиваются отдельно для сертификатов ЦС издателя и подписанных сертификатов приложений. 
- Сертификаты ЦС хранятся в Azure Key Vault с использованием HSM FIPS 140-2 уровня 2. Закрытый ключ никогда не покидает безопасное хранилище, так как подписывание выполняется через операцию Key Vault, защищенную через Azure AD. 
- Со временем вы можете обновить сертификаты CA и оставить их в надежном хранилище благодаря журналу Key Vault. 
- Список отзыва для каждого сертификата ЦС также хранится в Key Vault в качестве секрета. Если приложение незарегистрировано, сертификат приложения также отзывается через администратора в списке отзыва сертификатов (CRL).
- Вы можете отозвать отдельные сертификаты, а также пакетные сертификаты.

### <a name="certificate-request"></a>Запрос сертификата
Запрос сертификата реализует рабочий процесс для создания новой пары ключей или подписанного сертификата через запрос подписи сертификата (CSR) для приложения OPC UA. 
- Этот запрос сохраняется в базе данных вместе с дополнительной информацией (тема или CSR) и ссылкой на приложение OPC UA. 
- Бизнес-логика в службе проверяет запрос на соответствие информации, хранящейся в базе данных приложения. Например, URI приложения в базе данных должен совпадать с URI приложения в CSR.
- Администратор безопасности с правами на подписывание (то есть, роль утверждающего) утверждает или отклоняет запрос. Если запрос утвержден, создается новая пара ключей или подписанный сертификат (или и то, и другое). Новый закрытый ключ безопасно сохраняется в Key Vault, а новый подписанный открытый сертификат сохраняется в базе данных запроса на сертификат.
- Запросивший может узнать состояние запроса, пока он не будет утвержден или отозван. Если запрос утвержден, закрытый ключ и сертификат можно скачать и установить их в хранилище сертификатов приложения OPC UA.
- Теперь запрашивающий может подтвердить запрос на удаление ненужных сведений из базы данных запросов. 

В течение времени существования подписанного сертификата приложение может быть удалено или ключ может быть скомпрометирован. В таком случае диспетчер ЦС может сделать следующее:
- Удалить приложение, в результате чего также удаляются все ожидающие и утвержденные запросы сертификатов приложения. 
- Удалить только один запрос сертификата, если возобновляется или скомпрометирован только ключ.

После этого утвержденные и принятые запросы на скомпрометированный сертификаты помечаются как удаленные.

Менеджер может регулярно обновлять список отзыва сертификатов издателя ЦС. Во время обновления отзываются все удаленные запросы на сертификат, а серийные номера сертификатов добавляются в список отзыва сертификатов. Отозванные запросы сертификатов помечаются как отозванные. В срочных случаях можно отзывать даже отдельные запросы на сертификат.

Наконец, обновленные списки отзыва сертификатов предоставляются для распространения участвующим клиентам и серверам OPC UA.

## <a name="opc-vault-iot-edge-module"></a>Модуль IoT Edge хранилища OPC
Для поддержки сервера глобального обнаружения сети производства можно развернуть модуль Edge хранилища OPC. Запустите его как локальное приложение .NET Core или в контейнере Docker. Обратите внимание, что из-за отсутствия поддержки аутентификации Auth2 в текущем стеке .NET Standard OPC UA, функциональность модуля Edge хранилища OPC ограничиваются ролью читателя. Пользователь не может быть олицетворен из модуля Edge в микрослужбу с помощью стандартного интерфейса общего потока данных OPC UA.

## <a name="next-steps"></a>Дальнейшие действия

Теперь, когда вы узнали об архитектуре хранилища OPC, вы можете выполнить:

> [!div class="nextstepaction"]
> [Создание и развертывание хранилища OPC](howto-opc-vault-deploy.md)
