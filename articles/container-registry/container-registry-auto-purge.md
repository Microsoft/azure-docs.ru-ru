---
title: Очистка тегов и манифестов
description: Используйте команду очистки, чтобы удалить несколько тегов и манифестов из реестра контейнеров Azure на основе времени существования и фильтра тегов, а также при необходимости запланировать операции очистки.
ms.topic: article
ms.date: 02/19/2021
ms.openlocfilehash: 2dedfdd6eba73b7573743eba60294ac2231ffc56
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "101722234"
---
# <a name="automatically-purge-images-from-an-azure-container-registry"></a>Автоматическая очистка образов из реестра контейнеров Azure

При использовании реестра контейнеров Azure в рамках рабочего процесса разработки реестр может быстро заполняться образами или другими артефактами, которые скоро становятся ненужными. Возможно, следует удалять все теги старше определенного периода или соответствующие указанному фильтру имен. Чтобы быстро удалить несколько артефактов, используйте команду `acr purge`, которую можно запустить как задачу ACR по требованию или [по расписанию](container-registry-tasks-scheduled.md). 

В настоящее время команда `acr purge` распространяется в общедоступном образе контейнера (`mcr.microsoft.com/acr/acr-cli:0.4`), созданном на основе исходного кода в репозитории [acr-cli](https://github.com/Azure/acr-cli) на GitHub.

Для выполнения примеров задач ACR в этой статье можно использовать Azure Cloud Shell или локальный экземпляр Azure CLI. Если вы хотите использовать его локально, требуется версия 2.0.76 или более поздняя. Чтобы узнать версию, выполните команду `az --version`. Если вам необходимо выполнить установку или обновление, см. статью [Установка Azure CLI 2.0][azure-cli-install]. 

> [!IMPORTANT]
> Эта функция в настоящее время находится на стадии предварительной версии. Предварительные версии предоставляются при условии, что вы принимаете [дополнительные условия использования][terms-of-use]. Некоторые аспекты этой функции могут быть изменены до выхода общедоступной версии.

> [!WARNING]
> С осторожностью используйте команду `acr purge` — данные удаленных образов восстановлению не подлежат. Если у вас есть системы, которые получают образы с помощью дайджеста манифеста (а не по имени образа), не следует очищать образы без тегов. Удаление образов без тегов не позволит этим системам получать образы из реестра. Вместо получения с помощью манифеста попробуйте внедрить схему *уникальных тегов*, которая [рекомендуется в качестве лучшей методики](container-registry-image-tag-version.md).

Если вы хотите удалить манифесты или теги одного образа с помощью команд Azure CLI, см. раздел [Удаление образов контейнеров в реестре контейнеров Azure](container-registry-delete.md).

## <a name="use-the-purge-command"></a>Использование команды очистки

Команда контейнера `acr purge` удаляет образы по тегу в репозитории, если они соответствует фильтру имен и существуют дольше указанного периода. По умолчанию удаляются только ссылки на теги, а не базовые [манифесты](container-registry-concepts.md#manifest) и данные слоев. Команда также может удалять манифесты. 

> [!NOTE]
> `acr purge` не удаляет репозиторий или тег образа, если атрибут `write-enabled` имеет значение `false`. Дополнительные сведения см. в разделе [Блокировка образа контейнера в реестре контейнеров Azure](container-registry-image-lock.md).

`acr purge` предназначен для запуска в качестве команды контейнера в [задаче ACR](container-registry-tasks-overview.md), чтобы она автоматически выполняла проверку подлинности с реестром, в котором запущена задача, и могла выполнять там действия. В примерах задач в этой статье используется команда `acr purge` [псевдоним](container-registry-tasks-reference-yaml.md#aliases) вместо полной команды образа контейнера.

Как минимум при запуске `acr purge` необходимо указать следующее:

* `--filter` — репозиторий и *регулярное выражение* для фильтрации тегов в репозитории. Примеры: `--filter "hello-world:.*"` соответствует всем тегам в репозитории `hello-world`, а `--filter "hello-world:^1.*"` соответствует тегам, начинающимся с `1`. Передайте несколько параметров `--filter` для очистки нескольких репозиториев.
* `--ago` — [строка длительности](https://golang.org/pkg/time/) в стиле Go для обозначения длительности, после которой образы удаляются. Длительность состоит из последовательности из одного или нескольких десятичных чисел, каждое из которых имеет суффикс единицы. Допустимые единицы времени: "d" (дни), "h" (часы) и "m" (минуты). Например, `--ago 2d3h6m` выбирает все отфильтрованные образы, измененные в последний раз более 2 дней, 3 часов и 6 минут назад, а `--ago 1.5h` выбирает образы, которые были изменены в последний раз более 1,5 часов назад.

`acr purge` поддерживает несколько необязательных параметров. Следующие два используются в примерах в этой статье.

* `--untagged` — указывает, что манифесты, не имеющие связанных тегов (*манифесты без тегов*), удаляются.
* `--dry-run` — указывает, что никакие данные не удаляются, а выходные данные одинаковы, как если бы команда выполнялась без этого флага. Этот параметр полезен для тестирования команды очистки, чтобы убедиться, что она не удаляет непреднамеренно данные, которые нужно сохранить.
* `--keep` — Указывает, что все последние x-удаляемые теги сохраняются.
* `--concurrency` — Указывает количество задач очистки для одновременной обработки. Если этот параметр не указан, используется значение по умолчанию.

Для дополнительных параметров запустите `acr purge --help`. 

`acr purge` поддерживает другие функции команд задач ACR, включая [переменные запуска](container-registry-tasks-reference-yaml.md#run-variables) и [журналы выполнения задач](container-registry-tasks-logs.md), которые передаются в потоке и также сохраняются для последующего извлечения.

### <a name="run-in-an-on-demand-task"></a>Выполнение в задаче по требованию

В следующем примере с помощью команды [az acr run][az-acr-run] выполняется команда `acr purge` по требованию. В этом примере удаляются все теги и манифесты изображений в репозитории `hello-world` в *myregistry*, которые были изменены более 1 дня назад. Команда контейнера передается с помощью переменной среды. Задача выполняется без исходного контекста.

```azurecli
# Environment variable for container command line
PURGE_CMD="acr purge --filter 'hello-world:.*' \
  --untagged --ago 1d"

az acr run \
  --cmd "$PURGE_CMD" \
  --registry myregistry \
  /dev/null
```

### <a name="run-in-a-scheduled-task"></a>Выполнение с помощью запланированной задачи

В следующем примере используется команда [az acr task create][az-acr-task-create] для создания ежедневной [запланированной задачи ACR](container-registry-tasks-scheduled.md). Задача очищает теги, измененные более 7 дней назад, в репозитории `hello-world`. Команда контейнера передается с помощью переменной среды. Задача выполняется без исходного контекста.

```azurecli
# Environment variable for container command line
PURGE_CMD="acr purge --filter 'hello-world:.*' \
  --ago 7d"

az acr task create --name purgeTask \
  --cmd "$PURGE_CMD" \
  --schedule "0 0 * * *" \
  --registry myregistry \
  --context /dev/null
```

Выполните команду [az acr task show][az-acr-task-show], чтобы убедиться, что триггер таймера настроен.

### <a name="purge-large-numbers-of-tags-and-manifests"></a>Очистка большого количества тегов и манифестов

Очистка большого количества тегов и манифестов может занять несколько минут или больше. Чтобы очистить тысячи тегов и манифестов, команде может потребоваться больше времени, чем время ожидания по умолчанию — 600 секунд для задачи по требованию или 3600 секунд для запланированной задачи. В случае превышения времени ожидания удаляется только часть тегов и манифестов. Чтобы обеспечить выполнение крупномасштабной очистки, передайте параметр `--timeout`, чтобы увеличить значение. 

Например, следующая задача по требованию задает время ожидания 3600 секунд (1 час):

```azurecli
# Environment variable for container command line
PURGE_CMD="acr purge --filter 'hello-world:.*' \
  --ago 1d --untagged"

az acr run \
  --cmd "$PURGE_CMD" \
  --registry myregistry \
  --timeout 3600 \
  /dev/null
```

## <a name="example-scheduled-purge-of-multiple-repositories-in-a-registry"></a>Пример Запланированная очистка нескольких репозиториев в реестре

В этом примере рассматривается использование `acr purge` для периодической очистки нескольких репозиториев в реестре. Например, у вас может быть конвейер разработки, который передает образы в репозитории `samples/devimage1` и `samples/devimage2`. Вы периодически импортируете образы разработки в рабочий репозиторий для развертываний, поэтому вам больше не нужны образы разработки. Еженедельно вы очищаете репозитории `samples/devimage1` и `samples/devimage2` в процессе подготовки к работе на следующей неделе.

### <a name="preview-the-purge"></a>Предварительный просмотр очистки

Перед удалением данных рекомендуется выполнить задачу очистки по требованию с помощью параметра `--dry-run`. Этот параметр позволяет просматривать теги и манифесты, которые команда будет очищать, без удаления данных. 

В следующем примере фильтр в каждом репозитории выбирает все теги. Параметр `--ago 0d` соответствует образам с любым периодом существования в репозиториях, соответствующих фильтрам. Измените критерии, если это необходимо для вашего сценария. Параметр `--untagged` указывает на удаление манифестов в дополнение к тегам. Команда контейнера передается команде [az acr run][az-acr-run] с помощью переменной среды.

```azurecli
# Environment variable for container command line
PURGE_CMD="acr purge \
  --filter 'samples/devimage1:.*' --filter 'samples/devimage2:.*' \
  --ago 0d --untagged --dry-run"

az acr run \
  --cmd "$PURGE_CMD" \
  --registry myregistry \
  /dev/null
```

Просмотрите выходные данные команды, чтобы увидеть теги и манифесты, соответствующие параметрам выбора. Поскольку команда выполняется с `--dry-run`, данные не удаляются.

Образец вывода:

```console
[...]
Deleting tags for repository: samples/devimage1
myregistry.azurecr.io/samples/devimage1:232889b
myregistry.azurecr.io/samples/devimage1:a21776a
Deleting manifests for repository: samples/devimage1
myregistry.azurecr.io/samples/devimage1@sha256:81b6f9c92844bbbb5d0a101b22f7c2a7949e40f8ea90c8b3bc396879d95e788b
myregistry.azurecr.io/samples/devimage1@sha256:3ded859790e68bd02791a972ab0bae727231dc8746f233a7949e40f8ea90c8b3
Deleting tags for repository: samples/devimage2
myregistry.azurecr.io/samples/devimage2:5e788ba
myregistry.azurecr.io/samples/devimage2:f336b7c
Deleting manifests for repository: samples/devimage2
myregistry.azurecr.io/samples/devimage2@sha256:8d2527cde610e1715ad095cb12bc7ed169b60c495e5428eefdf336b7cb7c0371
myregistry.azurecr.io/samples/devimage2@sha256:ca86b078f89607bc03ded859790e68bd02791a972ab0bae727231dc8746f233a

Number of deleted tags: 4
Number of deleted manifests: 4
[...]
```

### <a name="schedule-the-purge"></a>Планирование очистки

Проверив пробный запуск, создайте запланированную задачу для автоматизации очистки. В следующем примере еженедельная задача планируется на воскресенье в 1:00 UTC и выполняется предыдущая команда очистки:

```azurecli
# Environment variable for container command line
PURGE_CMD="acr purge \
  --filter 'samples/devimage1:.*' --filter 'samples/devimage2:.*' \
  --ago 0d --untagged"

az acr task create --name weeklyPurgeTask \
  --cmd "$PURGE_CMD" \
  --schedule "0 1 * * Sun" \
  --registry myregistry \
  --context /dev/null
```

Выполните команду [az acr task show][az-acr-task-show], чтобы убедиться, что триггер таймера настроен.

## <a name="next-steps"></a>Дальнейшие действия

Узнайте о других вариантах [удаления данных образа](container-registry-delete.md) в реестре контейнеров Azure.

Дополнительные сведения о хранилище образов см. в статье [Хранение образа контейнера в реестре контейнеров Azure](container-registry-storage.md).

<!-- LINKS - External -->

[terms-of-use]: https://azure.microsoft.com/support/legal/preview-supplemental-terms/

<!-- LINKS - Internal -->
[azure-cli-install]: /cli/azure/install-azure-cli
[az-acr-run]: /cli/azure/acr#az-acr-run
[az-acr-task-create]: /cli/azure/acr/task#az-acr-task-create
[az-acr-task-show]: /cli/azure/acr/task#az-acr-task-show

