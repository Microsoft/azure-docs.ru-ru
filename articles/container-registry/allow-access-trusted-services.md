---
title: Доступ к реестру с ограниченным доступом в сети с помощью доверенной службы Azure
description: Предоставление доверенному экземпляру службы Azure безопасного доступа к реестру контейнеров, ограниченному сетью, для извлечения или отправки образов
ms.topic: article
ms.date: 01/29/2021
ms.openlocfilehash: 2e6b6ee3736f98f53ebb0aa43d707d42ba4cc058
ms.sourcegitcommit: ea822acf5b7141d26a3776d7ed59630bf7ac9532
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/03/2021
ms.locfileid: "99527904"
---
# <a name="allow-trusted-services-to-securely-access-a-network-restricted-container-registry-preview"></a>Предоставление доверенным службам безопасного доступа к реестру контейнеров, ограниченному сетью (Предварительная версия)

Реестр контейнеров Azure позволяет выбрать Доверенные службы Azure для доступа к реестру, для которого настроены правила доступа к сети. Если Доверенные службы разрешены, экземпляр доверенной службы может безопасно обходить сетевые правила реестра и выполнять такие операции, как изображения по запросу или Push-уведомления. Управляемое удостоверение экземпляра службы используется для доступа, и ему должна быть назначена роль Azure и выполнена проверка подлинности в реестре.

Используйте Azure Cloud Shell или локальную установку Azure CLI, чтобы выполнить примеры команд в этой статье. Если вы хотите использовать его локально, требуется версия 2,18 или более поздняя. Чтобы узнать версию, выполните команду `az --version`. Если вам необходимо выполнить установку или обновление, см. статью [Установка Azure CLI 2.0](/cli/azure/install-azure-cli).

Разрешение доступа к реестру доверенными службами Azure является функцией **предварительной версии** .

## <a name="limitations"></a>Ограничения

* Необходимо использовать управляемое системой удостоверение, которое включено в [доверенной службе](#trusted-services) для доступа к реестру контейнеров, ограниченным сетевым доступом. Назначенные пользователем управляемые удостоверения сейчас не поддерживаются.
* Разрешение доверенных служб не применяется к реестру контейнеров, настроенному с [конечной точкой службы](container-registry-vnet.md). Эта функция влияет только на реестры, которые ограничены [частной конечной точкой](container-registry-private-link.md) или имеют примененные [правила доступа к ОБЩЕДОСТУПНОМУ IP-адресу](container-registry-access-selected-networks.md) . 

## <a name="about-trusted-services"></a>О доверенных службах

Реестр контейнеров Azure имеет многоуровневую модель безопасности, поддерживающую несколько конфигураций сети, которые ограничивают доступ к реестру, в том числе:

* [Частная конечная точка с частной ссылкой Azure](container-registry-private-link.md). При настройке закрытая конечная точка реестра доступна только для ресурсов в пределах виртуальной сети с использованием частных IP-адресов.  
* [Правила брандмауэра реестра](container-registry-access-selected-networks.md), которые разрешают доступ к общедоступной конечной точке реестра только из конкретных общедоступных IP-адресов или диапазонов адресов. Вы также можете настроить брандмауэр так, чтобы он блокировал доступ к общедоступной конечной точке при использовании частных конечных точек.

При развертывании в виртуальной сети или при настройке с помощью правил брандмауэра реестр по умолчанию запрещает доступ пользователям или службам извне этих источников. 

Несколько служб Azure с несколькими клиентами работают с сетями, которые не могут быть добавлены в эти сетевые параметры реестра, что предотвращает их получение или передачу образов в реестр. Определив определенные экземпляры службы как "доверенные", владелец реестра может разрешить выбор ресурсов Azure для безопасного обхода сетевых параметров реестра для извлечения или отправки образов. 

### <a name="trusted-services"></a>Доверенные службы

Экземпляры следующих служб могут получить доступ к реестру контейнеров с ограниченным доступом в сети, если включен параметр реестра **Allow Trusted Services** (по умолчанию). С течением времени будут добавляться дополнительные службы.

|Доверенная служба  |Поддерживаемые сценарии использования  |
|---------|---------|
|Задачи ACR     | [Доступ к другому реестру из задачи записи контроля доступа](container-registry-tasks-cross-registry-authentication.md)       |
|Машинное обучение | [Развертывание](../machine-learning/how-to-deploy-custom-docker-image.md) или [обучение](../machine-learning/how-to-train-with-custom-image.md) модели в машинное обучение рабочей области с помощью пользовательского образа контейнера DOCKER |
|Реестр контейнеров Azure | [Импорт изображений из другого реестра контейнеров Azure](container-registry-import-images.md#import-from-an-azure-container-registry-in-the-same-ad-tenant) | 

> [!NOTE]
> Неудачно. Включение параметра Разрешить доверенные службы не позволяет экземплярам других управляемых служб Azure, включая службу приложений, экземпляры контейнеров Azure и центр безопасности Azure, получать доступ к реестру контейнеров, ограниченным сетью.

## <a name="allow-trusted-services---cli"></a>Разрешить доверенные службы — CLI

По умолчанию параметр Allow Trusted Services (Разрешить доверенные службы) включен в новом реестре контейнеров Azure. Отключите или включите параметр, выполнив команду [AZ контроля доступа Update](/cli/azure/acr#az-acr-update) .

Для отключения:

```azurecli
az acr update --name myregistry --allow-trusted-services false
```

Включение параметра в существующем реестре или в реестре, когда он уже отключен:

```azurecli
az acr update --name myregistry --allow-trusted-services true
```

## <a name="allow-trusted-services---portal"></a>Разрешить доверенные службы — портал

По умолчанию параметр Allow Trusted Services (Разрешить доверенные службы) включен в новом реестре контейнеров Azure. 

Чтобы отключить или повторно включить параметр на портале, выполните следующие действия.

1. На портале перейдите к нужному реестру контейнеров.
1. В разделе **Параметры** выберите **Сеть**. 
1. В окне **Разрешить доступ к общедоступной сети** выберите **Выбранные сети** или **отключено**.
1. Выполните одно из следующих действий.
    * Чтобы отключить доступ доверенных служб, в разделе **исключение брандмауэра** снимите флажок **разрешить доверенным службам Майкрософт доступ к этому реестру контейнеров**. 
    * Чтобы разрешить Доверенные службы, в разделе **исключение брандмауэра** установите флажок **разрешить доверенным службам Майкрософт доступ к этому реестру контейнеров**.
1. Щелкните **Сохранить**.

## <a name="trusted-services-workflow"></a>Рабочий процесс доверенных служб

Ниже приведен типичный рабочий процесс, позволяющий экземпляру доверенной службы получить доступ к реестру контейнеров, ограниченному сетью.

1. Включите [управляемое системой удостоверение для ресурсов Azure](../active-directory/managed-identities-azure-resources/overview.md) в экземпляре одного из [доверенных служб](#trusted-services) для реестра контейнеров Azure.
1. Назначьте удостоверение [роли Azure](container-registry-roles.md) для реестра. Например, назначьте роль Акрпулл для извлечения образов контейнеров.
1. В реестре, ограниченном сетью, настройте параметр, разрешающий доступ доверенным службам.
1. Используйте учетные данные удостоверения для проверки подлинности в реестре, ограниченном сетевым доступом. 
1. Извлечение изображений из реестра или выполнение других операций, разрешенных этой ролью.

### <a name="example-acr-tasks"></a>Пример: задачи записи контроля доступа

В следующем примере показано использование задач контроля доступа в качестве доверенной службы. Сведения о задачах см. [в разделе Перекрестная проверка подлинности в задаче записи контроля доступа с помощью удостоверения, управляемого Azure](container-registry-tasks-cross-registry-authentication.md) .

1. Создайте или обновите реестр контейнеров Azure и [отправьте пример базового образа](container-registry-tasks-cross-registry-authentication.md#prepare-base-registry) в реестр. Этот реестр является *основным* для сценария.
1. Во втором реестре контейнеров Azure [Определите](container-registry-tasks-cross-registry-authentication.md#define-task-steps-in-yaml-file) и [Создайте](container-registry-tasks-cross-registry-authentication.md#option-2-create-task-with-system-assigned-identity) задачу контроля доступа для извлечения образа из базового реестра. Включение назначенного системой управляемого удостоверения при создании задачи.
1. Назначьте удостоверению задачи [роль Azure для доступа к основному реестру](container-registry-tasks-authentication-managed-identity.md#3-grant-the-identity-permissions-to-access-other-azure-resources). Например, назначьте роль Акрпулл, которая имеет разрешения на извлечение изображений.
1. [Добавьте в задачу учетные данные управляемого удостоверения](container-registry-tasks-authentication-managed-identity.md#4-optional-add-credentials-to-the-task) .
1. Чтобы убедиться, что задача обходит ограничения сети, [Отключите открытый доступ](container-registry-access-selected-networks.md#disable-public-network-access) в основном реестре.
1. Запустите задачу. Если основной реестр и задача настроены должным образом, задача выполняется успешно, так как базовый реестр разрешает доступ.

Чтобы проверить отключение доступа доверенных служб, выполните следующие действия.

1. В основном реестре отключите этот параметр, чтобы разрешить доступ доверенным службам.
1. Запустите задачу еще раз. В этом случае выполнение задачи завершается ошибкой, так как базовый реестр больше не разрешает доступ задаче.

## <a name="next-steps"></a>Дальнейшие действия

* Чтобы ограничить доступ к реестру, используя частную конечную точку в виртуальной сети, см. статью [Настройка Приватного канала Azure для реестра контейнеров Azure](container-registry-private-link.md).
* Сведения о настройке правил брандмауэра для реестра см. в разделе [Настройка правил общедоступной IP-сети](container-registry-access-selected-networks.md).
