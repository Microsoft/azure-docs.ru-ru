---
title: Георепликация реестра
description: Сведения о создании и администрировании реестра контейнеров Azure с георепликацией, которая позволяет реестру обслуживать несколько регионов с несколькими региональными репликами. Георепликация — это функция уровня служб Premium.
author: stevelas
ms.topic: article
ms.date: 07/21/2020
ms.author: stevelas
ms.openlocfilehash: e5f0fe76b599874afe8d64c293f3d914da5dd243
ms.sourcegitcommit: e7152996ee917505c7aba707d214b2b520348302
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/20/2020
ms.locfileid: "97705172"
---
# <a name="geo-replication-in-azure-container-registry"></a>Георепликация в реестре контейнеров Azure

Компании, которым необходимо местное присутствие или выполнять оперативное резервное копирование, запускают службы из нескольких регионов Azure. Мы советуем разместить реестр контейнеров в каждом регионе, в котором запускаются образы, чтобы выполнять операции, аналогичные сетевым, для быстрой и надежной передачи слоев образа. Георепликация позволяет реестру контейнеров Azure работать в качестве отдельного реестра и обслуживать несколько регионов с несколькими региональными реестрами. 

Геореплицированный реестр предоставляет следующие преимущества:

* Отдельные имена реестра, изображения и тегов можно использовать в нескольких регионах.
* Повышение производительности и надежности региональных развертываний с помощью доступа к реестру для закрытия сети
* Уменьшение затрат на передачу данных за счет извлечения слоев изображения из локального и реплицированного реестра в том же или соседнем регионе, что и узел контейнера.
* единое управление реестром в нескольких регионах.

> [!NOTE]
> Если вам нужно хранить копии образов контейнеров в нескольких реестрах контейнеров Azure, Реестр контейнеров Azure также поддерживает [импорт образа](container-registry-import-images.md). Например, в рабочем процессе DevOps вы можете импортировать образы из реестра разработки в рабочий реестр без необходимости использовать команды Docker.
>

## <a name="example-use-case"></a>Примеры использования
Contoso запускает общедоступный веб-сайт, расположенный в США, Канаде и Европе. Чтобы предоставить этим рынкам локальное и аналогичное сетевому содержимое, Contoso запускает [Службу Azure Kubernetes](../aks/index.yml) (AKS) в западной части США, восточной части США, Центральной Канаде и Западной Европе. Веб-приложение, развернутое в качестве образа Docker, использует тот же код и образ во всех регионах. Содержимое, локальное для этого региона, извлекается из базы данных, которая уникально подготавливается в каждом регионе. Каждое региональное развертывание имеет свою уникальную конфигурацию для ресурсов, например, для локальной базы данных.

Команда разработчиков находится в Сиэтле, штат Вашингтон, и использует центр обработки данных в западной части США.

![Отправка в несколько реестров](media/container-registry-geo-replication/before-geo-replicate.png)<br />*Отправка в несколько реестров*

Перед использованием функций георепликации Contoso использовал в западной части США реестр, который размещается в США, а также дополнительный реестр в Западной Европе. Для обслуживания этих разных регионов команда разработчиков отправила образы в два разных реестра.

```bash
docker push contoso.azurecr.io/public/products/web:1.2
docker push contosowesteu.azurecr.io/public/products/web:1.2
```
![Извлечение из нескольких реестров](media/container-registry-geo-replication/before-geo-replicate-pull.png)<br />*Извлечение из нескольких реестров*

К типичным сложностям нескольких реестров относятся:

* Все кластеры восточной части США, западной части США и Центральной Канады извлекаются из реестра в западной части США. При этом взимается дополнительная исходящая плата, так как каждый из этих удаленных узлов контейнера извлекает образ из центров обработки данных в западной части США.
* Команда разработчиков должна отправлять образы в реестры в западной части США и Западной Европе.
* Команде разработчиков необходимо настроить и поддерживать каждое региональное развертывание с именами образов, ссылающихся на локальный реестр.
* Для каждого региона, необходимо настроить доступ к реестру.

## <a name="benefits-of-geo-replication"></a>Преимущества георепликации

![Извлечение из геореплицированного реестра](media/container-registry-geo-replication/after-geo-replicate-pull.png)

С помощью функции георепликации реестра контейнеров Azure можно реализовать следующие преимущества:

* Управление одним реестром во всех регионах: `contoso.azurecr.io`.
* Управление единственной конфигурацией развертываний образов, так как все регионы используют один и тот же URL-адрес образа: `contoso.azurecr.io/public/products/web:1.2`
* Отправляйте данные в отдельный реестр, а ACR будет управлять георепликацией. Запись контроля доступа реплицирует только уникальные уровни, уменьшая объем данных, передаваемых между регионами. 
* Настройка региональных [веб-перехватчиков](container-registry-webhook.md) для уведомления о событиях в конкретных репликах.

Реестр контейнеров Azure также поддерживает [зоны доступности](zone-redundancy.md) для создания отказоустойчивого и высокого уровня доступности реестра контейнеров Azure в регионе Azure. Сочетание зон доступности для обеспечения избыточности в пределах региона и георепликации в нескольких регионах повышает надежность и производительность реестра.

## <a name="configure-geo-replication"></a>Настройка георепликации

Настроить георепликацию так же просто, как и выбрать регионы на карте. Вы можете управлять георепликацией, используя команды [az acr replication](/cli/azure/acr/replication) в Azure CLI и другие инструменты, а также развернуть реестр с поддержкой георепликации с помощью [шаблона Azure Resource Manager](https://github.com/Azure/azure-quickstart-templates/tree/master/101-container-registry-geo-replication).

Функция георепликации доступна для [реестров уровня "Премиум"](container-registry-skus.md). Вы можете изменить уровень "Базовый" или "Стандартный" на "Премиум" (если у вас его еще нет) на [портале Azure](https://portal.azure.com).

![Изменение уровней служб с помощью портала Azure](media/container-registry-skus/update-registry-sku.png)

Чтобы настроить георепликацию для реестра уровня "Премиум", войдите на портал Azure по адресу https://portal.azure.com.

Перейдите к реестру контейнеров Azure и выберите **Replications** (Репликации).

![Репликации в реестре контейнера пользовательского интерфейса на портале Azure](media/container-registry-geo-replication/registry-services.png)

Отобразится карта со всеми текущими регионами Azure:

 ![Карта регионов на портале Azure](media/container-registry-geo-replication/registry-geo-map.png)

* синие шестиугольники отображают текущие реплики;
* зеленые шестиугольники отображают возможные регионы реплик;
* серые шестиугольники отображают регионы Azure, которые еще недоступны для репликации.

Чтобы настроить реплику, выберите зеленый шестиугольник, а затем нажмите кнопку **Создать**.

 ![Создание пользовательского интерфейса репликации на портале Azure](media/container-registry-geo-replication/create-replication.png)

Чтобы настроить дополнительные реплики, выберите зеленые шестиугольники для других регионов, а затем нажмите кнопку **Создать**.

ACR начинает синхронизацию образов между настроенными репликами. После завершения на портале отобразится состояние *Готово*. Состояние реплики на портале не обновляется автоматически. Нажмите кнопку "Обновить", чтобы просмотреть обновленное состояние.

## <a name="considerations-for-using-a-geo-replicated-registry"></a>Рекомендации по использованию геореплицированного реестра

* Каждый регион в геореплицированном реестре является независимым после настройки. Соглашения об уровне обслуживания Реестра контейнеров Azure применяются к каждому геореплицированному региону.
* При отправке образов в геореплицированный реестр или извлечении их из него Диспетчер трафика Azure в фоновом режиме отправляет запрос в реестр, расположенный в ближайшем к вам регионе по характеристикам сетевой задержки.
* После отправки образа или тега обновления в ближайший регион потребуется некоторое время, чтобы Реестр контейнеров Azure реплицировал манифесты и слои в остальные регионы, которые вы выбрали. Чем больше образ, тем дольше он реплицируется. Образы и теги синхронизируются во всех регионах репликации в соответствии с моделью итоговой согласованности.
* Для управления рабочими процессами, зависящими от отправки обновлений в геореплицированный реестр, мы рекомендуем настроить [веб-перехватчики](container-registry-webhook.md). Это позволит реагировать на события отправки. Можно настроить региональные веб-перехватчики в геореплицированном реестре, чтобы отслеживать выполнение событий отправки во всех геореплицированных регионах.
* Для обслуживания больших двоичных объектов, представляющих уровни содержимого, реестр контейнеров Azure использует конечные точки данных. Вы можете включить [выделенные конечные точки данных](container-registry-firewall-access-rules.md#enable-dedicated-data-endpoints) для реестра в каждом регионе, в который геореплицируется этот реестр. Эти конечные точки позволяют настроить правила доступа брандмауэра со строго ограниченными областями. В целях устранения неполадок при необходимости можно [отключить маршрутизацию к репликации](#temporarily-disable-routing-to-replication) , сохраняя реплицированные данные.
* Если настроить для реестра [приватный канал](container-registry-private-link.md) с частными конечными точками в виртуальной сети, то по умолчанию будут включены выделенные конечные точки данных в каждом регионе для георепликации. 

## <a name="delete-a-replica"></a>Удаление реплики

Настроив реплику для реестра, вы сможете удалить ее в любое время, когда надобность в ней отпадет. Реплику можно удалить на портале Azure или с помощью других средств, например команды [az acr replication delete](/cli/azure/acr/replication#az-acr-replication-delete) в Azure CLI.

Чтобы удалить реплику на портале Azure, сделайте следующее:

1. Перейдите к службе "Реестр контейнеров Azure" и выберите **Репликации**.
1. Выберите имя реплики и щелкните **Удалить**. Подтвердите удаление реплики.

Чтобы с помощью Azure CLI удалить реплику реестра *myregistry* в регионе "Восточная часть США", сделайте следующее:

```azurecli
az acr replication delete --name eastus --registry myregistry
```

## <a name="geo-replication-pricing"></a>Расходы, связанные с георепликацией

Георепликация — это функция [уровня служб "Премиум"](container-registry-skus.md) в службе "Реестр контейнеров Azure". При репликации реестра в необходимые регионы с вас взимается плата за реестры уровня "Премиум" для каждого региона.

В предыдущем примере Contoso объединил два реестра в один, добавив реплики в восточную часть США, Центральную Канаду и Западную Европу. Contoso будет платить за уровень "Премиум" четыре раза в месяц. Для этого не нужна дополнительная настройка и управление. Теперь каждый регион извлекает свои образы локально, повышая производительность и надежность, без дополнительной исходящей платы за сеть начиная от западной части США и заканчивая Канадой и восточной частью США.

## <a name="troubleshoot-push-operations-with-geo-replicated-registries"></a>Устранение неполадок с операциями отправки с использованием геореплицированных реестров
 
Клиент DOCKER, который передает образ в геореплицированный реестр, может отправить все слои образа и его манифест не в один реплицированный регион. Это может произойти из-за того, что диспетчер трафика Azure направляет запросы к реестру в ближайший к сети реплицированный реестр. Если *вблизи* реестра находятся два региона репликации, то слои образа и манифест могут быть распределены между ними, а операция отправки завершится ошибкой при проверке манифеста. Эта проблема возникает из-за того, что DNS-имя реестра разрешается на некоторых узлах Linux. Эта проблема не возникает в Windows, где предоставляется кэш DNS на стороне клиента.
 
В случае возникновения этой проблемы одним из решений является применение кэша DNS на стороне клиента, например `dnsmasq` на узле Linux. Это гарантирует согласованное разрешение имени реестра. Если вы используете виртуальную машину Linux в Azure для отправки в реестр, ознакомьтесь со статьей [Параметры разрешения DNS-имен для виртуальных машин Linux в Azure](../virtual-machines/linux/azure-dns.md).

Чтобы для разрешения DNS-имен при передаче образов использовалась ближайшая реплика, настройте геореплицированный реестр в том же регионе Azure, где находится источник операций отправки, или в ближайшем регионе при работе вне Azure.

### <a name="temporarily-disable-routing-to-replication"></a>Временное отключение маршрутизации к репликации

Для устранения неполадок с географически реплицируемыми реестрами может потребоваться временно отключить маршрутизацию диспетчера трафика к одной или нескольким репликациям. Начиная с версии Azure CLI 2,8 можно настроить `--region-endpoint-enabled` параметр (Предварительная версия) при создании или обновлении реплицированной области. Если для параметра репликации задано значение `--region-endpoint-enabled` `false` , диспетчер трафика больше не перенаправляет запросы на принудительную отправку или запрос на вытягивание в этот регион. По умолчанию маршрутизация для всех репликаций включена, и синхронизация данных по всем репликациям выполняется независимо от того, включена или отключена маршрутизация.

Чтобы отключить маршрутизацию к существующей репликации, сначала выполните команду [AZ записи контроля][az-acr-replication-list] доступа, чтобы вывести список репликаций в реестре. Затем выполните команду [AZ запись контроля доступа Update][az-acr-replication-update] и задайте `--region-endpoint-enabled false` для конкретной репликации. Например, чтобы настроить параметр для репликации *westus* в *myregistry*, сделайте следующее:

```azurecli
# Show names of existing replications
az acr replication list --registry --output table

# Disable routing to replication
az acr replication update --name westus \
  --registry myregistry --resource-group MyResourceGroup \
  --region-endpoint-enabled false
```

Чтобы восстановить маршрутизацию в репликацию, выполните следующие действия.

```azurecli
az acr replication update --name westus \
  --registry myregistry --resource-group MyResourceGroup \
  --region-endpoint-enabled true
```

## <a name="next-steps"></a>Дальнейшие действия

Просмотрите руководство, состоящее из трех частей, [Подготовка геореплицированного реестра контейнеров Azure](container-registry-tutorial-prepare-registry.md). Рассмотрите создание геореплицированного реестра, создание контейнера, а затем его развертывание в несколько региональных экземпляров веб-приложений для контейнеров, выполнив единую команду `docker push`.

> [!div class="nextstepaction"]
> [Подготовка геореплицированного реестра контейнеров Azure](container-registry-tutorial-prepare-registry.md)

[az-acr-replication-list]: /cli/azure/acr/replication#az-acr-replication-list
[az-acr-replication-update]: /cli/azure/acr/replication#az-acr-replication-update
