---
title: Устранение проблем с сетью с помощью реестра
description: Симптомы, причины и способы устранения распространенных проблем при доступе к реестру контейнеров Azure в виртуальной сети или за брандмауэром
ms.topic: article
ms.date: 10/01/2020
ms.openlocfilehash: cf2f308f782ac7d6011c98afd181b194f2b3e09f
ms.sourcegitcommit: ea822acf5b7141d26a3776d7ed59630bf7ac9532
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/03/2021
ms.locfileid: "99525082"
---
# <a name="troubleshoot-network-issues-with-registry"></a>Устранение проблем с сетью с помощью реестра

Эта статья поможет вам устранить неполадки, которые могут возникнуть при доступе к реестру контейнеров Azure в виртуальной сети или за брандмауэром. 

## <a name="symptoms"></a>Симптомы

Может включать один или несколько из следующих элементов:

* Не удается отправить или извлечь образы; вы получаете ошибку `dial tcp: lookup myregistry.azurecr.io`
* Не удается отправить или извлечь образы, Azure CLI ошибку `Could not connect to the registry login server`
* Не удалось извлечь образы из реестра в службу Kubernetes Azure или другую службу Azure
* Не удается получить доступ к реестру для прокси-сервера HTTPS и появляется ошибка `Error response from daemon: login attempt failed with status: 403 Forbidden`
* Не удалось настроить параметры виртуальной сети; вы получаете сообщение об ошибке `Failed to save firewall and virtual network settings for container registry`
* Не удается получить доступ или просмотреть параметры реестра в портал Azure или управлять реестром с помощью Azure CLI
* Не удается добавить или изменить параметры виртуальной сети или общие правила доступа
* Задачам записи контроля доступа не удается отправить или извлечь изображения
* Центр безопасности Azure не может сканировать образы в реестре, или результаты проверки не отображаются в центре безопасности Azure.

## <a name="causes"></a>Причины

* Клиентский брандмауэр или прокси-сервер предотвращают доступ к [решению](#configure-client-firewall-access)
* Правила доступа к общедоступным сетям в реестре предотвращают доступ к [решению](#configure-public-access-to-registry)
* Конфигурация виртуальной сети предотвращает доступ к [решению](#configure-vnet-access)
* Вы пытаетесь интегрировать центр безопасности Azure или некоторые другие службы Azure с реестром, имеющим закрытую конечную точку, конечную точку службы или правила доступа общедоступного IP-адреса для [решения](#configure-service-access)

## <a name="further-diagnosis"></a>Дальнейшая диагностика 

Выполните команду [AZ контроля доступа проверки на работоспособность](/cli/azure/acr#az-acr-check-health) , чтобы получить дополнительные сведения о работоспособности среды реестра и при необходимости доступ к целевому реестру. Например, следует диагностировать определенные проблемы с подключением к сети или конфигурацией. 

Примеры команд см. [в статье Проверка работоспособности реестра контейнеров Azure](container-registry-check-health.md) . Если выводятся сообщения об ошибках, см. рекомендации по [ссылке на ошибку](container-registry-health-error-reference.md) и следующим разделам.

Если при работе с реестром вих Azure Kubernetes возникли проблемы, выполните команду [AZ AKS Check-контроля](/cli/azure/aks#az_aks_check_acr) доступа, чтобы убедиться, что реестр доступен из кластера AKS.

> [!NOTE]
> Некоторые проблемы с подключением к сети также могут возникнуть при возникновении проблем с проверкой подлинности или авторизацией в реестре. См. [раздел Устранение неполадок при входе в реестр](container-registry-troubleshoot-login.md).

## <a name="potential-solutions"></a>Возможные решения

### <a name="configure-client-firewall-access"></a>Настройка доступа к брандмауэру клиента

Чтобы получить доступ к реестру, защищенному брандмауэром клиента или прокси-сервером, настройте правила брандмауэра для доступа к общедоступным конечным точкам и данным в реестре. Если [выделенные конечные точки данных](container-registry-firewall-access-rules.md#enable-dedicated-data-endpoints) включены, необходимы правила для доступа:

* Конечная точка RESTFUL: `<registryname>.azurecr.io`
* Конечные точки данных: `<registry-name>.<region>.data.azurecr.io`

Для геореплицированного реестра настройте доступ к конечной точке данных для каждой региональной реплики.

На основе прокси-сервера HTTPS убедитесь, что для клиента DOCKER и управляющей программы DOCKER настроено поведение прокси-сервера.

Журналы ресурсов реестра в таблице Контаинеррегистрилогиневентс могут помочь в диагностике попытки подключения, которое заблокировано.

Связанные ссылки

* [Настройка правил для доступа к реестру контейнеров Azure за брандмауэром](container-registry-firewall-access-rules.md)
* [Конфигурация прокси-сервера HTTP/HTTPS](https://docs.docker.com/config/daemon/systemd/#httphttps-proxy)
* [Георепликация в реестре контейнеров Azure](container-registry-geo-replication.md)
* [Журналы реестра контейнеров Azure для диагностической оценки и аудита](container-registry-diagnostics-audit-logs.md)

### <a name="configure-public-access-to-registry"></a>Настройка общего доступа к реестру

При доступе к реестру через Интернет убедитесь, что реестр разрешает доступ к общедоступной сети из клиента. По умолчанию реестр контейнеров Azure предоставляет доступ к конечным точкам общедоступного реестра из всех сетей. Реестр может ограничивать доступ к выбранным сетям или к выбранным IP-адресам. 

Если реестр настроен для виртуальной сети с конечной точкой службы, отключение доступа к общедоступной сети также отключает доступ через конечную точку службы. Если реестр настроен для виртуальной сети с частной ссылкой, правила IP-сети не применяются к частным конечным точкам реестра. 

Связанные ссылки

* [Настройка правил общедоступной IP-сети](container-registry-access-selected-networks.md)
* [Подключение в частном порядке к реестру контейнеров Azure с помощью частной ссылки Azure](container-registry-private-link.md)
* [Ограничение доступа к реестру контейнеров с использованием конечной точки службы в виртуальной сети Azure](container-registry-vnet.md)


### <a name="configure-vnet-access"></a>Настройка доступа к виртуальной сети

Убедитесь, что в виртуальной сети настроена частная конечная точка для частной ссылки или конечная точка службы (Предварительная версия). Сейчас конечная точка бастиона для Azure не поддерживается.

Проверьте правила NSG и теги служб, используемые для ограничения трафика от других ресурсов в сети к реестру. 

Если настроена конечная точка службы для реестра, убедитесь, что в реестр Добавлено сетевое правило, разрешающее доступ из этой сетевой подсети. Конечная точка службы поддерживает доступ только из виртуальных машин и кластеров AKS в сети.

Если вы хотите ограничить доступ к реестру с помощью виртуальной сети в другой подписке Azure, убедитесь, что `Microsoft.ContainerRegistry` поставщик ресурсов зарегистрирован в этой подписке. [Зарегистрируйте поставщик ресурсов](../azure-resource-manager/management/resource-providers-and-types.md) для реестра контейнеров Azure с помощью портал Azure, Azure CLI или других средств Azure.

Если в сети настроен брандмауэр Azure или аналогичное решение, убедитесь, что трафик исходящего трафика из других ресурсов, таких как кластер AKS, включен для доступа к конечным точкам реестра.

Если настроена частная конечная точка, убедитесь, что DNS разрешает общедоступное полное доменное имя реестра, например *myregistry.azurecr.IO* , к ЧАСТНОМУ IP-адресу реестра. Используйте сетевую программу, например `dig` или `nslookup` для поиска в DNS.

Связанные ссылки

* [Подключение в частном порядке к реестру контейнеров Azure с помощью частной ссылки Azure](container-registry-private-link.md)
* [Ограничение доступа к реестру контейнеров с использованием конечной точки службы в виртуальной сети Azure](container-registry-vnet.md)
* [Необходимые правила исходящей сети и FQDN для кластеров AKS](../aks/limit-egress-traffic.md#required-outbound-network-rules-and-fqdns-for-aks-clusters)
* [Kubernetes: Отладка разрешения DNS](https://kubernetes.io/docs/tasks/administer-cluster/dns-debugging-resolution/)
* [Теги службы виртуальной сети](../virtual-network/service-tags-overview.md)

### <a name="configure-service-access"></a>Настройка доступа к службе

В настоящее время доступ к реестру контейнеров с ограничениями сети не разрешен из нескольких служб Azure:

* Центр безопасности Azure не может выполнить [сканирование уязвимостей образов](../security-center/defender-for-container-registries-introduction.md?bc=%2fazure%2fcontainer-registry%2fbreadcrumb%2ftoc.json&toc=%2fazure%2fcontainer-registry%2ftoc.json) в реестре, который разрешает доступ к частным конечным точкам, выбранным подсетям или IP-адресам. 
* Ресурсы некоторых служб Azure не имеют доступа к реестру контейнеров с ограничениями сети, включая службу приложений Azure и экземпляры контейнеров Azure.

Если требуется доступ или интеграция этих служб Azure с реестром контейнеров, удалите ограничение сети. Например, удалите частные конечные точки реестра или удалите или измените правила общего доступа к реестру.

Начиная с 2021 января можно настроить реестр, ограниченный сетью, чтобы [Разрешить доступ](allow-access-trusted-services.md) из выбора доверенных служб.

Связанные ссылки

* [Сканирование образа реестра контейнеров Azure по центру безопасности](../security-center/defender-for-container-registries-introduction.md)
* Отправить [отзыв](https://feedback.azure.com/forums/347535-azure-security-center/suggestions/41091577-enable-vulnerability-scanning-for-images-that-are)
* [Предоставление доверенным службам безопасного доступа к реестру контейнеров, ограниченному сетью](allow-access-trusted-services.md)


## <a name="advanced-troubleshooting"></a>Расширенный поиск проблем

Если в реестре включен [Сбор журналов ресурсов](container-registry-diagnostics-audit-logs.md) , проверьте журнал контаинтеррегистрилогиневентс. В этом журнале хранятся события и состояние проверки подлинности, включая входящий идентификатор и IP-адрес. Запросите журнал о [сбоях проверки подлинности в реестре](container-registry-diagnostics-audit-logs.md#registry-authentication-failures). 

Связанные ссылки

* [Журналы для диагностической оценки и аудита](container-registry-diagnostics-audit-logs.md)
* [Реестр контейнеров: вопросы и ответы](container-registry-faq.md)
* [Базовый план безопасности Azure для реестра контейнеров Azure](security-baseline.md)
* [Рекомендации по использованию реестра контейнеров Azure](container-registry-best-practices.md)

## <a name="next-steps"></a>Следующие шаги

Если вы не решите проблему здесь, см. следующие параметры.

* Другие разделы по устранению неполадок в реестре:
  * [Устранение неполадок при входе в реестр](container-registry-troubleshoot-login.md) 
  * [Устранение неполадок с производительностью реестра](container-registry-troubleshoot-performance.md)
* Варианты [поддержки сообщества](https://azure.microsoft.com/support/community/)
* [Майкрософт: вопросы и ответы](https://docs.microsoft.com/answers/products/)
* [Открытие запроса в службу поддержки](https://azure.microsoft.com/support/create-ticket/)
