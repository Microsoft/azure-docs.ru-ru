---
title: Управляемое удостоверение в задаче контроля доступа
description: Включите управляемое удостоверение для ресурсов Azure в задаче реестра контейнеров Azure, чтобы разрешить этой задаче доступ к другим ресурсам Azure, включая другие закрытые реестры контейнеров.
services: container-registry
author: dlepow
manager: gwallace
ms.service: container-registry
ms.topic: article
ms.date: 01/14/2020
ms.author: danlep
ms.openlocfilehash: 8f2749a18a5ac6aed0822553d59beaacc9060228
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "98915953"
---
# <a name="use-an-azure-managed-identity-in-acr-tasks"></a>Использование удостоверения, управляемого Azure, в задачах контроля доступа 

Включите [управляемое удостоверение для ресурсов Azure](../active-directory/managed-identities-azure-resources/overview.md) в [задаче записи контроля](container-registry-tasks-overview.md)доступа, чтобы задача могла получить доступ к другим ресурсам Azure без необходимости предоставлять учетные данные или управлять ими. Например, можно использовать управляемое удостоверение, чтобы сделать шаг задачи запрашивать или отправлять образы контейнеров в другой реестр.

Из этой статьи вы узнаете, как использовать Azure CLI для включения управляемого удостоверения, назначенного пользователем или системой, в задаче записи контроля доступа. Можно использовать Azure Cloud Shell или локальную установку Azure CLI. Если вы хотите использовать его локально, требуется версия 2.0.68 или более поздняя. Чтобы узнать версию, выполните команду `az --version`. Если вам необходимо выполнить установку или обновление, см. статью [Установка Azure CLI 2.0][azure-cli-install].

В приведенных ниже примерах команд в этой статье используется команда [AZ запись контроля][az-acr-task-create] доступа для создания базовой задачи построения образа, которая включает управляемое удостоверение. Примеры сценариев для доступа к защищенным ресурсам из задачи контроля учетных записей с помощью управляемого удостоверения см. в следующих статьях:

* [Аутентификация в разных реестрах](container-registry-tasks-cross-registry-authentication.md)
* [Доступ к внешним ресурсам с помощью секретов, хранящихся в Azure Key Vault](container-registry-tasks-authentication-key-vault.md)

## <a name="why-use-a-managed-identity"></a>Для чего нужны управляемые удостоверения?

Управляемое удостоверение для ресурсов Azure предоставляет выбранные службы Azure с автоматически управляемым удостоверением в Azure Active Directory. Вы можете настроить задачу контроля учетных записей с помощью управляемого удостоверения, чтобы задача могла получать доступ к другим защищенным ресурсам Azure без передачи учетных данных в шагах задач.

Управляемые удостоверения бывают двух типов:

* *Назначенные пользователю удостоверения*, которые можно назначить нескольким ресурсам и сохранять в течение всего времени. Назначаемые пользователем удостоверения сейчас доступны в предварительной версии.

* *Назначенное системой удостоверение*, которое является уникальным для конкретного ресурса, например задачи записи контроля доступа и продолжается в течение времени существования этого ресурса.

В задаче контроля доступа можно включить один или оба типа удостоверений. Предоставьте удостоверению доступ к другому ресурсу, как и любому субъекту безопасности. При выполнении задачи она использует удостоверение для доступа к ресурсу во всех шагах задач, требующих доступа.

## <a name="steps-to-use-a-managed-identity"></a>Действия по использованию управляемого удостоверения

Выполните эти высокоуровневые действия, чтобы использовать управляемое удостоверение с задачей контроля доступа.

### <a name="1-optional-create-a-user-assigned-identity"></a>1. Создание назначенного пользователем удостоверения (необязательно)

Если вы планируете использовать назначенное пользователем удостоверение, используйте существующее удостоверение или создайте удостоверение с помощью Azure CLI или других средств Azure. Например, используйте команду [AZ Identity Create][az-identity-create] . 

Если вы планируете использовать только назначенное системой удостоверение, пропустите этот шаг. При создании задачи контроля учетных записей вы создаете назначенное системой удостоверение.

### <a name="2-enable-identity-on-an-acr-task"></a>2. Включение удостоверения для задачи записи контроля доступа

При создании задачи записи контроля доступа при необходимости можно включить пользовательское удостоверение, назначенное системой удостоверение или и то, и другое. Например, передайте `--assign-identity` параметр при выполнении команды [AZ контроля][az-acr-task-create] доступа на создание в Azure CLI.

Чтобы включить назначенное системой удостоверение, передайте без `--assign-identity` значения или `assign-identity [system]` . В следующем примере команда создает задачу Linux из общедоступного репозитория GitHub, который создает `hello-world` образ и позволяет назначить управляемое системой удостоверение.

```azurecli
az acr task create \
    --image hello-world:{{.Run.ID}} \
    --name hello-world --registry MyRegistry \
    --context https://github.com/Azure-Samples/acr-build-helloworld-node.git#main \
    --file Dockerfile \
    --commit-trigger-enabled false \
    --assign-identity
```

Чтобы включить назначенное пользователем удостоверение, передайте `--assign-identity` значение *идентификатора ресурса* удостоверения. В следующем примере команда создает задачу Linux из общедоступного репозитория GitHub, который создает `hello-world` образ и позволяет назначить управляемое пользователем удостоверение:

```azurecli
az acr task create \
    --image hello-world:{{.Run.ID}} \
    --name hello-world --registry MyRegistry \
    --context https://github.com/Azure-Samples/acr-build-helloworld-node.git#main \
    --file Dockerfile \
    --commit-trigger-enabled false
    --assign-identity <resourceID>
```

Идентификатор ресурса для удостоверения можно получить, выполнив команду [AZ Identity показывать][az-identity-show] . Идентификатор ресурса для идентификатора *мюсерассигнедидентити* в группе ресурсов *myResourceGroup* имеет вид: 

```
"/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourcegroups/myResourceGroup/providers/Microsoft.ManagedIdentity/userAssignedIdentities/myUserAssignedIdentity"
```

### <a name="3-grant-the-identity-permissions-to-access-other-azure-resources"></a>3. Предоставьте разрешения удостоверениям для доступа к другим ресурсам Azure.

В зависимости от требований задачи предоставьте удостоверениям разрешения на доступ к другим ресурсам Azure. Примеры приведены ниже.

* Назначьте управляемому удостоверению роль с запросом на включение внесенных изменений, принудительную отправку и извлечение или другие разрешения для целевого реестра контейнеров в Azure. Полный список ролей реестра см. в статье [роли и разрешения реестра контейнеров Azure](container-registry-roles.md). 
* Назначьте управляемому удостоверению роль для чтения секретов в хранилище ключей Azure.

Используйте [Azure CLI](../role-based-access-control/role-assignments-cli.md) или другие инструменты Azure для управления доступом на основе ролей к ресурсам. Например, выполните команду [AZ Role назначение Create][az-role-assignment-create] , чтобы назначить удостоверение роли ресурсу. 

В следующем примере управляемому удостоверению присваивается разрешение на извлечение из реестра контейнеров. Команда задает *идентификатор субъекта* для удостоверения задачи и *идентификатор ресурса* целевого реестра.


```azurecli
az role assignment create \
  --assignee <principalID> \
  --scope <registryID> \
  --role acrpull
```

### <a name="4-optional-add-credentials-to-the-task"></a>4. Добавление учетных данных в задачу (необязательно)

Если задаче требуются учетные данные для извлечения или отправки изображений в другой пользовательский реестр или для доступа к другим ресурсам, добавьте учетные данные для задачи. Выполните команду [AZ запись контроля учетных данных Add][az-acr-task-credential-add] записи, чтобы добавить учетные данные, и передайте `--use-identity` параметр, чтобы указать, что удостоверение может получить доступ к учетным данным. 

Например, чтобы добавить учетные данные для назначенного системой удостоверения для проверки подлинности в реестре контейнеров Azure *таржетрегистри*, передайте `use-identity [system]` :

```azurecli
az acr task credential add \
    --name helloworld \
    --registry myregistry \
    --login-server targetregistry.azurecr.io \
    --use-identity [system]
```

Чтобы добавить учетные данные для назначенного пользователем удостоверения для проверки подлинности в реестре *таржетрегистри*, передайте `use-identity` значение *идентификатора клиента* удостоверения. Пример:

```azurecli
az acr task credential add \
    --name helloworld \
    --registry myregistry \
    --login-server targetregistry.azurecr.io \
    --use-identity <clientID>
```

Идентификатор клиента для удостоверения можно получить, выполнив команду [AZ Identity показывать][az-identity-show] . Идентификатор клиента является идентификатором GUID формы `xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx` .

### <a name="5-run-the-task"></a>5. Запуск задачи

После настройки задачи с управляемым удостоверением запустите задачу. Например, чтобы проверить одну из задач, созданных в этой статье, запустите ее вручную с помощью команды [AZ запись контроля][az-acr-task-run] доступа. Если настроены дополнительные триггеры автоматической задачи, задача запускается при автоматическом запуске.

## <a name="next-steps"></a>Дальнейшие действия

В этой статье вы узнали, как включить и использовать назначенное пользователем или управляемое системой удостоверение для задачи контроля учетных записей. Сценарии для доступа к защищенным ресурсам из задачи контроля доступа с помощью управляемого удостоверения см. в следующих статьях:

* [Аутентификация в разных реестрах](container-registry-tasks-cross-registry-authentication.md)
* [Доступ к внешним ресурсам с помощью секретов, хранящихся в Azure Key Vault](container-registry-tasks-authentication-key-vault.md)


<!-- LINKS - Internal -->
[az-role-assignment-create]: /cli/azure/role/assignment#az-role-assignment-create
[az-identity-create]: /cli/azure/identity#az-identity-create
[az-identity-show]: /cli/azure/identity#az-identity-show
[az-acr-task-create]: /cli/azure/acr/task#az-acr-task-create
[az-acr-task-run]: /cli/azure/acr/task#az-acr-task-run
[az-acr-task-credential-add]: /cli/azure/acr/task/credential#az-acr-task-credential-add
[azure-cli-install]: /cli/azure/install-azure-cli
