---
title: Аутентификация с помощью субъекта-службы
description: Предоставление доступа к образам, размещенным в закрытом реестре контейнеров, с помощью субъекта-службы Azure Active Directory.
ms.topic: article
ms.date: 10/04/2019
ms.openlocfilehash: 8d49628576a1c337efaea3e5286fef00e39def17
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "86259153"
---
# <a name="azure-container-registry-authentication-with-service-principals"></a>Аутентификация в реестре контейнеров Azure с помощью субъектов-служб

С помощью субъекта-службы Azure Active Directory (Azure AD) вы можете предоставить образу контейнера доступ `docker push` и `pull` к реестру контейнеров. Субъект-служба позволяет предоставлять автоматический доступ к службам и приложениям.

## <a name="what-is-a-service-principal"></a>Что такое субъект-служба?

*Субъекты-службы* в Azure AD используются для доступа к ресурсам Azure в подписке. Субъект-служба можно считать удостоверением пользователя для службы, где "служба" — это любое приложение, служба или платформа, которым требуется доступ к ресурсам. Субъекту-службе можно присвоить права доступа, ограниченные конкретными ресурсами. После этого вам останется лишь настроить применение этого субъекта-службы для доступа к ресурсам из приложения или службы.

В контексте реестра контейнеров Azure субъект-служба Azure AD может получать разрешения на получение, на передачу и получение или другие права для частного реестра в Azure. Полный список см. в статье, посвященной [ролям и разрешениям реестра контейнеров Azure](container-registry-roles.md).

## <a name="why-use-a-service-principal"></a>Почему именно субъект-служба?

Субъект-служба Azure AD позволяет предоставить ограниченный доступ к закрытому реестру контейнеров. Создайте разные субъекты-службы для каждого приложения или службы, каждый из которых имеет собственные права доступа к реестру. Кроме того, вы сможете в любой момент легко изменить реквизиты или отменить доступ для каждого конкретного субъекта-службы, поскольку его учетные данные применяются только в одном приложении или службе.

Например, настройте в веб-приложении использование субъекта службы, предоставляющего `pull` доступ только к изображениям, в то время как система сборки использует субъект-службу, который предоставляет ее как для, так `push` и для `pull` доступа. Если разработка приложения изменит руки, можно сменить учетные данные субъекта-службы, не влияя на систему сборки.

## <a name="when-to-use-a-service-principal"></a>Когда следует использовать субъект-службу

Субъект-службы следует очень удобны для предоставления доступа к реестру при работе со **сценариями с автоматическим доступом**. Это позволяет приложениям, службам и (или) скриптам передавать или получать образы контейнеров в полностью автоматическом режиме или без участия оператора. Пример:

  * *Pull*: развертывание контейнеров из реестра в системы оркестрации, включая KUBERNETES, DC/OS и DOCKER Swarm. Вы также можете извлечь из реестра контейнеров в связанные службы Azure, такие как [Служба Kubernetes Azure (AKS)](../aks/cluster-container-registry-integration.md), службы " [экземпляры контейнеров Azure](container-registry-auth-aci.md)", " [служба приложений](../app-service/index.yml)", " [пакет](../batch/index.yml)", " [Service Fabric](../service-fabric/index.yml)" и другие.

  * *Push*: создание образов контейнеров и их отправка в реестр с помощью решений непрерывной интеграции и развертывания, таких как Azure pipelines или Jenkins.

Для отдельного доступа к реестру, например, если вы вручную запрашиваете образ контейнера на рабочей станции разработки, мы рекомендуем использовать собственное [удостоверение Azure AD](container-registry-authentication.md#individual-login-with-azure-ad) вместо доступа к реестру (например, с помощью команды [AZ контроля учетных записей][az-acr-login]).

[!INCLUDE [container-registry-service-principal](../../includes/container-registry-service-principal.md)]

### <a name="sample-scripts"></a>Примеры сценариев

Приведенные выше примеры сценариев можно найти в Azure CLI на GitHub, а также в версиях для Azure PowerShell.

* [Azure CLI][acr-scripts-cli]
* [Azure PowerShell][acr-scripts-psh]

## <a name="authenticate-with-the-service-principal"></a>Проверка подлинности с помощью субъекта-службы

Если у вас есть субъект-служба, которому предоставлен доступ к реестру контейнеров, можно настроить его учетные данные для доступа к службам и приложениям без монитора или ввести их с помощью `docker login` команды. Используйте следующие значения.

* **Имя пользователя** — идентификатор приложения субъекта-службы (также НАЗЫВАЕМый *идентификатором клиента*)
* **Пароль — пароль** субъекта-службы (также называемый *секретом клиента*)

Каждое значение является идентификатором GUID формы `xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx` . 

> [!TIP]
> Можно создать пароль субъекта-службы повторно, выполнив команду [az ad sp reset-credentials](/cli/azure/ad/sp/credential#az-ad-sp-credential-reset).
>

### <a name="use-credentials-with-azure-services"></a>Использование учетных данных со службами Azure

Учетные данные субъекта-службы можно использовать из любой службы Azure, которая выполняет проверку подлинности в реестре контейнеров Azure.  Используйте учетные данные субъекта-службы вместо учетных данных администратора реестра для различных сценариев.

Например, используйте учетные данные для извлечения образа из реестра контейнеров Azure в службу " [экземпляры контейнеров Azure](container-registry-auth-aci.md)".

### <a name="use-with-docker-login"></a>Использование с именем входа DOCKER

Можно запустить `docker login` с помощью субъекта-службы. В следующем примере идентификатор приложения субъекта-службы передается в переменную среды `$SP_APP_ID` и пароль в переменной `$SP_PASSWD` . Рекомендации по управлению учетными данными DOCKER см. в справочнике по командам [DOCKER login](https://docs.docker.com/engine/reference/commandline/login/) .

```bash
# Log in to Docker with service principal credentials
docker login myregistry.azurecr.io --username $SP_APP_ID --password $SP_PASSWD
```

После входа в систему DOCKER кэширует учетные данные.

### <a name="use-with-certificate"></a>Использовать с сертификатом

Если вы добавили сертификат к субъекту-службе, вы можете войти в Azure CLI с проверкой подлинности на основе сертификата, а затем воспользоваться командой [AZ запись контроля][az-acr-login] доступа, чтобы получить доступ к реестру. Использование сертификата в качестве секрета вместо пароля обеспечивает дополнительную защиту при использовании интерфейса командной строки. 

Самозаверяющий сертификат можно создать при [создании субъекта-службы](/cli/azure/create-an-azure-service-principal-azure-cli). Или добавьте один или несколько сертификатов к существующему субъекту-службе. Например, если вы используете один из сценариев, описанных в этой статье, чтобы создать или обновить субъект-службу с правами на извлечение или передачу образов из реестра, добавьте сертификат с помощью команды [AZ AD SP Credential Reset][az-ad-sp-credential-reset] .

Чтобы использовать субъект-службу с сертификатом для [входа в Azure CLI](/cli/azure/authenticate-azure-cli#sign-in-with-a-service-principal), сертификат должен быть в формате PEM и содержать закрытый ключ. Если ваш сертификат не находится в нужном формате, используйте средство, например, `openssl` для его преобразования. При выполнении команды [AZ login][az-login] для входа в CLI с помощью субъекта-службы также укажите идентификатор приложения субъекта-службы и идентификатор клиента Active Directory. В следующем примере эти значения показаны как переменные среды:

```azurecli
az login --service-principal --username $SP_APP_ID --tenant $SP_TENANT_ID  --password /path/to/cert/pem/file
```

Затем выполните команду [AZ контроля учетных записей][az-acr-login] для проверки подлинности в реестре:

```azurecli
az acr login --name myregistry
```

CLI использует маркер, созданный при выполнении `az login` проверки подлинности сеанса в реестре.

## <a name="next-steps"></a>Дальнейшие действия

* См. [Общие сведения о проверке подлинности](container-registry-authentication.md) для других сценариев проверки подлинности в реестре контейнеров Azure.

* Пример использования хранилища ключей Azure для хранения и получения учетных данных субъекта-службы для реестра контейнеров см. в руководстве по [созданию и развертыванию образа контейнера с помощью задач контроля](container-registry-tutorial-quick-task.md)учетных записей.

<!-- LINKS - External -->
[acr-scripts-cli]: https://github.com/Azure/azure-docs-cli-python-samples/tree/master/container-registry
[acr-scripts-psh]: https://github.com/Azure/azure-docs-powershell-samples/tree/master/container-registry

<!-- LINKS - Internal -->
[az-acr-login]: /cli/azure/acr#az-acr-login
[az-login]: /cli/azure/reference-index#az-login
[az-ad-sp-credential-reset]: /cli/azure/ad/sp/credential#az-ad-sp-credential-reset
