---
title: Развертывание и настройка брандмауэра Azure Premium Preview
description: Узнайте, как развернуть и настроить брандмауэр Azure Premium.
author: vhorne
ms.service: firewall
services: firewall
ms.topic: how-to
ms.date: 02/16/2021
ms.author: victorh
ms.openlocfilehash: fa106fac683619706f4be330ad1c4bff7b56f2dd
ms.sourcegitcommit: c27a20b278f2ac758447418ea4c8c61e27927d6a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/03/2021
ms.locfileid: "101721792"
---
# <a name="deploy-and-configure-azure-firewall-premium-preview"></a>Развертывание и настройка брандмауэра Azure Premium Preview

> [!IMPORTANT]
> Брандмауэр Azure уровня "Премиум" сейчас находится в общедоступной предварительной версии.
> Эта предварительная версия предоставляется без соглашения об уровне обслуживания и не рекомендована для использования рабочей среде. Некоторые функции могут не поддерживаться или их возможности могут быть ограничены. Дополнительные сведения см. в статье [Дополнительные условия использования предварительных выпусков Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).

 Брандмауэр Azure уровня "Премиум" (предварительная версия) — это брандмауэр следующего поколения с возможностями, требуемыми для работы в строго конфиденциальных и регулируемых средах. Он включает следующие компоненты.

- **Проверка TLS** — расшифровывает исходящий трафик, обрабатывает данные, затем шифрует данные и отправляет их в место назначения.
- **Поставщиков удостоверений** — система обнаружения и предотвращения вторжения в сеть (поставщиков удостоверений) позволяет отслеживать сетевые действия для вредоносных действий, записывать в журнал сведения об этом действии, сообщать о нем и при необходимости пытаться заблокировать его.
- **Фильтрация URL-адресов** . расширяет возможности фильтрации полного доменного имени в брандмауэре Azure, чтобы учесть весь URL-адрес. Например, `www.contoso.com/a/c` вместо `www.contoso.com` .
- **Веб-категории** . Администраторы могут разрешать или запрещать доступ пользователей к категориям веб-сайтов, таким как веб-сайты азартных игр, веб-сайты социальных сетей и др.

Дополнительные сведения см. в статье [Azure Firewall Premium Features](premium-features.md).

Вы будете использовать шаблон для развертывания тестовой среды, которая имеет центральную виртуальную сеть (10.0.0.0/16) с тремя подсетями:
- Рабочая подсеть (10.0.10.0/24)
- подсеть бастиона для Azure (10.0.20.0/24);
- подсеть брандмауэра (10.0.100.0/24)

В этой тестовой среде для простоты используется одна центральная виртуальная сеть. В производственных целях наиболее распространена [топология HUB и звезды](/azure/architecture/reference-architectures/hybrid-networking/hub-spoke) с одноранговым виртуальных сетей.

:::image type="content" source="media/premium-deploy/premium-topology.png" alt-text="Топология Центральной виртуальной сети":::

Рабочая виртуальная машина — это клиент, отправляющий запросы HTTP/S через брандмауэр.

## <a name="prerequisites"></a>Предварительные требования

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

## <a name="deploy-the-infrastructure"></a>Развертывание инфраструктуры

Шаблон развертывает полную среду тестирования для брандмауэра Azure Premium с поставщиков удостоверений, проверкой TLS, фильтрацией URL и веб-категориями.

- Новый брандмауэр Azure уровня "Премиум" и "Политика брандмауэра" с предварительно определенными параметрами для упрощения проверки основных возможностей (поставщиков удостоверений, проверка TLS, Фильтрация URL-адресов и категории "веб")
- развертывает все зависимости, включая Key Vault и управляемое удостоверение. В рабочей среде эти ресурсы могут быть уже созданы и не нужны в одном шаблоне.
- создает самозаверяющий корневой ЦС и развертывает его на созданном Key Vault
-  создает производный промежуточный ЦС и развертывает его на тестовой виртуальной машине Windows (Воркервм)
- Узел бастиона (Бастионхост) также развертывается и может использоваться для подключения к тестовой машине Windows (Воркервм).



[![Развертывание в Azure](../media/template-deployments/deploy-to-azure.svg)](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure%2Fazure-quickstart-templates%2Fmaster%2F101-azurefirewall-premium%2Fazuredeploy.json)

## <a name="test-the-firewall"></a>тестирование брандмауэра.

Теперь вы можете протестировать поставщиков удостоверений, проверку TLS, веб-фильтрацию и веб-категории.

### <a name="add-firewall-diagnostics-settings"></a>Добавление параметров диагностики брандмауэра

Чтобы собираются журналы брандмауэра, необходимо добавить параметры диагностики для получения журналов брандмауэра.

1. Выберите **демофиревалл** и в разделе **мониторинг** выберите **параметры диагностики**.
2. Выберите **Добавить параметр диагностики**.
3. В качестве **имени параметра диагностики** введите *FW-DIAG*.
4. В разделе **Журнал** выберите **азурефиреваллаппликатионруле** и **азурефиреваллнетворкруле**.
5. В разделе **сведения о назначении** выберите **отправить в log Analytics рабочую область**.
6. Щелкните **Сохранить**.

### <a name="idps-tests"></a>Тесты поставщиков удостоверений

Чтобы протестировать поставщиков удостоверений, вам потребуется развернуть собственный внутренний веб-сервер с соответствующим сертификатом сервера. Дополнительные сведения о требованиях к сертификатам Azure Premium Preview предварительной версии см. в статье [Предварительная версия Azure Firewall Premium](premium-certificates.md).

Можно использовать `curl` для управления различными заголовками HTTP и моделирования вредоносного трафика.

#### <a name="to-test-idps-for-http-traffic"></a>Чтобы проверить поставщиков удостоверений для трафика HTTP:

1. На виртуальной машине Воркервм откройте окно командной строки администратора.
2. В командной строке введите следующую команду:

   `curl -A "BlackSun" <your web server address>`
3. Вы увидите ответ веб-сервера.
4. Перейдите в журнал сетевого правила брандмауэра на портал Azure, чтобы найти предупреждение, похожее на следующее сообщение:

   :::image type="content" source="media/premium-deploy/alert-message.png" alt-text="Предупреждающее сообщение":::

   > [!NOTE]
   > Начало отображения данных в журналах может занять некоторое время. Дайте журналу не менее 20 минут, чтобы позволить журналам начать отображение данных.
5. Добавьте правило подписи для подписи 2008983:

   1. Выберите **демофиреваллполици** и в разделе **Параметры** выберите **поставщиков удостоверений (Предварительная версия)**.
   1. Перейдите на вкладку **правила подписи** .
   1. В разделе **Идентификатор подписи** в текстовом поле открыть введите *2008983*.
   1. В разделе **режим** выберите **запретить**.
   1. Щелкните **Сохранить**.
   1. Дождитесь завершения развертывания, прежде чем продолжать работу.



6. В Воркервм выполните `curl` команду еще раз:

   `curl -A "BlackSun" <your web server address>`

   Так как HTTP-запрос теперь блокируется брандмауэром, вы увидите следующие выходные данные после истечения времени ожидания подключения:

   `read tcp 10.0.100.5:55734->10.0.20.10:80: read: connection reset by peer`

7. Перейдите к журналам мониторинга в портал Azure и найдите сообщение для заблокированного запроса.
<!---8. Now you can bypass the IDPS function using the **Bypass list**.

   1. On the **IDPS (preview)** page, select the **Bypass list** tab.
   2. Edit **MyRule** and set **Destination** to *10.0.20.10, which is the ServerVM private IP address.
   3. Select **Save**.
1. Run the test again: `curl -A "BlackSun" http://server.2020-private-preview.com` and now you should get the `Hello World` response and no log alert. --->

#### <a name="to-test-idps-for-https-traffic"></a>Тестирование поставщиков удостоверений для трафика HTTPS

Повторите эти фигурные тесты, используя протокол HTTPS вместо HTTP. Пример.

`curl --ssl-no-revoke -A "BlackSun" <your web server address>`

Вы должны увидеть те же результаты, что и в тестах HTTP.

### <a name="tls-inspection-with-url-filtering"></a>Проверка TLS с фильтрацией URL-адресов

Выполните следующие действия, чтобы проверить проверку TLS с помощью фильтрации URL-адресов.

1. Измените правила применения политики брандмауэра и добавьте новое правило, вызванное `AllowURL` в `AllowWeb` коллекцию правил. Настройте целевой URL-адрес `www.nytimes.com/section/world` , исходный IP-адрес **\* *_, тип назначения _* URL (Предварительная версия)**, выберите **Проверка TLS (Предварительная версия)** и протоколы **http, HTTPS**.

3. После завершения развертывания откройте браузер на Воркервм и перейдите по адресу `https://www.nytimes.com/section/world` и проверьте, что ответ HTML отображается в браузере ожидаемым образом.
4. В портал Azure можно просмотреть весь URL-адрес в журналах мониторинга правила приложений:

      :::image type="content" source="media/premium-deploy/alert-message-url.png" alt-text="Предупреждение с указанием URL-адреса":::

Некоторые HTML-страницы могут выглядеть неполными, так как они ссылаются на другие URL-адреса, которые запрещены. Чтобы решить эту проблему, можно использовать следующий подход:

- Если страница HTML содержит ссылки на другие домены, эти домены можно добавить в новое правило приложения, разрешающее доступ к этим полным доменным именам.
- Если HTML-страница содержит ссылки на подurl-адреса, можно изменить правило и добавить в URL-адрес звездочку. Например: `targetURLs=www.nytimes.com/section/world*`

   Кроме того, можно добавить в правило новый URL-адрес. Пример. 

   `www.nytimes.com/section/world, www.nytimes.com/section/world/*`

### <a name="web-categories-testing"></a>Тестирование веб-категорий

Давайте создадим правило приложения, разрешающее доступ к спортивным веб-сайтам.
1. На портале откройте группу ресурсов и выберите **демофиреваллполици**.
2. Выберите **правила приложения**, а затем **добавьте коллекцию правил**.
3. В качестве **имени** введите *женералвеб*, **Priority** *103*, **Группа коллекции правил** SELECT **дефаултаппликатионрулеколлектионграуп**.
4. В разделе **правила** для **имени** типа *алловспортс*, **Source** *\** , **протокол** *http, HTTPS*, выберите **Проверка TLS**, **тип назначения** выберите *веб-категории (Предварительная версия)*, **назначение** выберите *Спорт*.
5. Нажмите **Добавить**.

      :::image type="content" source="media/premium-deploy/web-categories.png" alt-text="Категория спортивных веб-страниц":::
6. После завершения развертывания перейдите по адресу  **воркервм** и откройте веб-браузер и перейдите к `https://www.nfl.com` .

   Вы должны увидеть веб-страницу ФУТБОЛЬНОЙ, а в журнале правил приложений будет указано, что **веб-Категория: «Спорт** », и запрос был разрешен.

## <a name="next-steps"></a>Дальнейшие действия

- [Предварительная версия Azure Firewall Premium Preview на портал Azure](premium-portal.md)