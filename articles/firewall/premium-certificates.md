---
title: Сертификаты брандмауэра Azure Premium Preview
description: Чтобы правильно настроить проверку TLS в предварительной версии Azure Firewall Premium, необходимо настроить и установить промежуточные сертификаты ЦС.
author: vhorne
ms.service: firewall
services: firewall
ms.topic: conceptual
ms.date: 02/16/2021
ms.author: victorh
ms.openlocfilehash: 3914a82903c293cf1a8306b5ecc1f542fef83e72
ms.sourcegitcommit: 5a999764e98bd71653ad12918c09def7ecd92cf6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/16/2021
ms.locfileid: "100549911"
---
# <a name="azure-firewall-premium-preview-certificates"></a>Сертификаты брандмауэра Azure Premium Preview 

> [!IMPORTANT]
> Брандмауэр Azure уровня "Премиум" сейчас находится в общедоступной предварительной версии.
> Эта предварительная версия предоставляется без соглашения об уровне обслуживания и не рекомендована для использования рабочей среде. Некоторые функции могут не поддерживаться или их возможности могут быть ограничены. Дополнительные сведения см. в статье [Дополнительные условия использования предварительных выпусков Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).

 Чтобы правильно настроить проверку TLS брандмауэра Azure Premium Preview, необходимо предоставить действительный сертификат промежуточного ЦС и поместить его в хранилище ключей Azure.

## <a name="certificates-used-by-azure-firewall-premium-preview"></a>Сертификаты, используемые в предварительной версии Azure Firewall Premium

Существует три типа сертификатов, используемых в типичном развертывании:

- **Промежуточный сертификат ЦС (сертификат ЦС)**

   Центр сертификации (CA) — это организация, которая является доверенной для подписания цифровых сертификатов. Центр сертификации проверяет удостоверение и Закон подлинности компании или отдельного запроса сертификата. Если проверка прошла успешно, ЦС выдает подписанный сертификат. Когда сервер предоставляет сертификат клиенту (например, веб-браузеру) во время подтверждения SSL/TLS, клиент пытается проверить подпись по списку *известных хороших* подписывающих. В веб-браузерах обычно используются списки центров сертификации, которые неявно доверяются на обнаружение узлов. Если в списке нет центра, как и для некоторых сайтов, которые подписывают свои собственные сертификаты, браузер предупреждает пользователя о том, что сертификат не подписан доверенным центром сертификации, и запрашивает у пользователя возможность продолжить обмен данными с непроверенным сайтом.

- **Сертификат сервера (сертификат веб-сайта)**

   Сертификат, связанный с конкретным доменным именем. Если у веб-сайта есть действительный сертификат, то это означает, что центр сертификации выполнил действия по проверке факта принадлежности веб-адреса к этой Организации. При вводе URL-адреса или ссылки на защищенный веб-сайт браузер проверяет сертификат на наличие следующих характеристик:
   - Адрес веб-сайта соответствует адресу сертификата.
   - Сертификат подписывается центром сертификации, который браузер распознает как *доверенный* центр.
   
   Иногда пользователи могут подключаться к серверу с недоверенным сертификатом. Брандмауэр Azure удалит подключение, как если бы сервер прервал подключение.

- **Сертификат корневого ЦС (корневой сертификат)**

   Центр сертификации может выдавать несколько сертификатов в виде древовидной структуры. Корневой сертификат — это самый верхний сертификат дерева.

Предварительная версия Azure Firewall Premium позволяет перехватывать исходящий трафик HTTP/S и автоматически создавать сертификат сервера для `www.website.com` . Этот сертификат создается с помощью предоставленного промежуточного сертификата ЦС. Чтобы эта процедура работала, браузер и клиентские приложения для конечных пользователей должны доверять сертификату корневого ЦС организации или сертификату промежуточного ЦС. 

:::image type="content" source="media/premium-certificates/certificate-process.png" alt-text="Процесс сертификата":::

## <a name="intermediate-ca-certificate-requirements"></a>Требования к сертификатам промежуточного ЦС

Убедитесь, что сертификат ЦС соответствует следующим требованиям.

- При развертывании в качестве Key Vault секрета необходимо использовать PFX-файл без пароля (PKCS12) с сертификатом и закрытым ключом.

- Он должен быть одним сертификатом и не должен включать всю цепочку сертификатов.  

- Она должна быть действительна в течение одного года вперед.  

- Это должен быть закрытый ключ RSA с минимальным размером в 4096 байт.  

- Оно должно иметь `KeyUsage` расширение, помеченное как критическое, с `KeyCertSign` флагом (RFC 5280; использование ключа 4.2.1.3).

- Оно должно иметь `BasicContraints` расширение, помеченное как критическое (RFC 5280; базовые ограничения 4.2.1.9).  

- `CA`Флаг должен иметь значение true.

- Длина пути должна быть больше или равна единице.

## <a name="azure-key-vault"></a>Azure Key Vault

Управляемое платформой хранилище секретов [Azure Key Vault](../key-vault/general/overview.md) можно применять для защиты секретов, ключей и сертификатов TLS/SSL. Брандмауэр Azure Premium поддерживает интеграцию с Key Vault для сертификатов сервера, подключенных к политике брандмауэра.
 
Чтобы настроить хранилище ключей, сделайте следующее:

- Необходимо импортировать существующий сертификат со своей парой ключей в хранилище ключей. 
- Кроме того, можно использовать секрет хранилища ключей, который хранится в виде PFX-файла в формате "без пароля", с основанием 64.  PFX-файл — это цифровой сертификат, содержащий закрытый ключ и открытый ключ.
- Рекомендуется использовать импорт сертификатов ЦС, так как он позволяет настроить оповещение на основе даты истечения срока действия сертификата.
- После импорта сертификата или секрета необходимо определить политики доступа в хранилище ключей, чтобы предоставить удостоверению доступ для получения доступа к сертификату или секрету.
- Указанный сертификат ЦС должен быть доверенным для рабочей нагрузки Azure. Убедитесь, что они развернуты правильно.

Вы можете создать или повторно использовать существующее управляемое удостоверение, назначенное пользователем, которое используется брандмауэром Azure для получения сертификатов от Key Vault от вашего имени. Дополнительные сведения см. в статье [что такое управляемые удостоверения для ресурсов Azure?](../active-directory/managed-identities-azure-resources/overview.md) 

## <a name="configure-a-certificate-in-your-policy"></a>Настройка сертификата в политике

Чтобы настроить сертификат ЦС в политике Premium брандмауэра, выберите свою политику и щелкните **Проверка TLS (Предварительная версия)**. Выберите **включено** на странице **Проверка TLS** . Затем выберите сертификат ЦС в Azure Key Vault, как показано на следующем рисунке.

:::image type="content" source="media/premium-certificates/tls-inspection.png" alt-text="Обзорная схема брандмауэра Azure Premium":::
 
> [!IMPORTANT]
> Чтобы просмотреть и настроить сертификат из портал Azure, необходимо добавить учетную запись пользователя Azure в политику доступа к Key Vault. Предоставьте учетной записи пользователя и **получите** **список** в разделе " **секретные разрешения**".
   :::image type="content" source="media/premium-certificates/secret-permissions.png" alt-text="Политика доступа Azure Key Vault":::


## <a name="troubleshooting"></a>Диагностика

Если сертификат ЦС действителен, но вы не можете получить доступ к полным доменным именам или URL-адресам при проверке TLS, проверьте следующие пункты:

- Убедитесь, что сертификат веб-сервера действителен.  

- Убедитесь, что сертификат корневого ЦС установлен в клиентской операционной системе.  

- Убедитесь, что браузер или HTTPS-клиент содержит допустимый корневой сертификат. Firefox и другие браузеры могут иметь особые политики сертификации.  

- Убедитесь, что тип назначения URL в правиле приложения охватывает правильный путь и все другие гиперссылки, внедренные на HTML-страницу назначения. Можно использовать подстановочные знаки для простого покрытия всего требуемого URL-пути.  


## <a name="next-steps"></a>Дальнейшие шаги

- [Дополнительные сведения о расширенных возможностях брандмауэра Azure](premium-features.md)
