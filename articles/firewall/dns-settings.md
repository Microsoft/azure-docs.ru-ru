---
title: Параметры DNS брандмауэра Azure
description: Вы можете настроить брандмауэр Azure с помощью DNS-сервера и параметров прокси-сервера DNS.
services: firewall
author: vhorne
ms.service: firewall
ms.topic: how-to
ms.date: 02/16/2021
ms.author: victorh
ms.openlocfilehash: d6a79e87e9999dd520358e0722011cf4e54d8c63
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "100546250"
---
# <a name="azure-firewall-dns-settings"></a>Параметры DNS брандмауэра Azure

Вы можете настроить пользовательский DNS-сервер и включить DNS-прокси для брандмауэра Azure. Настройте эти параметры при развертывании брандмауэра или настройте их позже на странице **параметров DNS** .

## <a name="dns-servers"></a>"Серверы DNS"

DNS-сервер поддерживает и разрешает доменные имена IP-адресам. По умолчанию брандмауэр Azure использует Azure DNS для разрешения имен. Параметр **DNS-сервера** позволяет настроить собственные DNS-серверы для разрешения имен брандмауэра Azure. Можно настроить один сервер или несколько серверов.

> [!NOTE]
> Для экземпляров брандмауэра Azure, управляемых с помощью диспетчера брандмауэра Azure, параметры DNS настраиваются в соответствующей политике брандмауэра Azure.

### <a name="configure-custom-dns-servers---azure-portal"></a>Настройка пользовательских DNS-серверов — портал Azure

1. В разделе **Параметры** брандмауэра Azure выберите **параметры DNS**.
2. В разделе **DNS-серверы** можно ввести или добавить существующие DNS-серверы, которые ранее были указаны в виртуальной сети.
3. Щелкните **Сохранить**.

Теперь брандмауэр направляет трафик DNS на указанные DNS-серверы для разрешения имен.

:::image type="content" source="media/dns-settings/dns-servers.png" alt-text="Снимок экрана, показывающий параметры для серверов D N S.":::

### <a name="configure-custom-dns-servers---azure-cli"></a>Настройка пользовательских DNS-серверов — Azure CLI

В следующем примере брандмауэр Azure обновляется с пользовательскими DNS-серверами с помощью Azure CLI.

```azurecli-interactive
az network firewall update \
    --name fwName \ 
    --resource-group fwRG \
    --dns-servers 10.1.0.4 10.1.0.5
```

> [!IMPORTANT]
> Для команды `az network firewall` требуется установить расширение Azure CLI `azure-firewall` . Его можно установить с помощью команды `az extension add --name azure-firewall` . 

### <a name="configure-custom-dns-servers---azure-powershell"></a>Настройка пользовательских DNS-серверов — Azure PowerShell

В следующем примере брандмауэр Azure обновляется с пользовательскими DNS-серверами с помощью Azure PowerShell.

```azurepowershell
$dnsServers = @("10.1.0.4", "10.1.0.5")
$azFw = Get-AzFirewall -Name "fwName" -ResourceGroupName "fwRG"
$azFw.DNSServer = $dnsServers

$azFw | Set-AzFirewall
```

## <a name="dns-proxy"></a>DNS-прокси

Вы можете настроить брандмауэр Azure так, чтобы он действовал в качестве DNS-прокси. DNS-прокси — это посредник для запросов DNS от клиентских виртуальных машин к DNS-серверу. При настройке пользовательского DNS-сервера включите DNS-прокси, чтобы избежать несоответствия разрешений DNS, и включите фильтрацию FQDN (полное доменное имя) в правилах сети.

:::image type="content" source="media/dns-settings/dns-proxy-2.png" alt-text="Настройка прокси-сервера d N S с помощью пользовательских серверов D.":::


Если не включить DNS-прокси, запросы DNS от клиента могут передаваться на DNS-сервер в другое время или возвращать другой ответ, по сравнению с брандмауэром. DNS-прокси помещает брандмауэр Azure в путь клиентских запросов, чтобы избежать несогласованности.

Если брандмауэр Azure является DNS-прокси, возможны два типа функций кэширования:

- **Положительный кэш**: разрешение DNS успешно выполнено. Брандмауэр использует TTL (срок жизни) пакета или объекта. 

- **Отрицательный кэш**: результаты разрешения DNS не отклика или разрешения отсутствуют. Брандмауэр кэширует эти сведения в течение одного часа.

DNS-прокси сохраняет все разрешенные IP-адреса по полным доменным именам в правилах сети. Рекомендуется использовать полные доменные имена, которые разрешаются в один IP-адрес.  

### <a name="dns-proxy-configuration"></a>Конфигурация прокси-сервера DNS

Конфигурация прокси-сервера DNS требует трех шагов:
1. Включите DNS-прокси в параметрах DNS брандмауэра Azure.
2. При необходимости настройте пользовательский DNS-сервер или используйте предоставленное значение по умолчанию.
3. Настройте частный IP-адрес брандмауэра Azure в качестве пользовательского DNS-адреса в параметрах DNS-сервера виртуальной сети. Этот параметр гарантирует, что трафик DNS будет перенаправлен в брандмауэр Azure.

#### <a name="configure-dns-proxy---azure-portal"></a>Настройка прокси-сервера DNS — портал Azure

Чтобы настроить DNS-прокси, необходимо настроить параметр DNS-серверов виртуальной сети для использования частного IP-адреса брандмауэра. Затем включите DNS-прокси в **параметрах DNS** брандмауэра Azure.

##### <a name="configure-virtual-network-dns-servers"></a>Настройка DNS-серверов виртуальной сети 

1. Выберите виртуальную сеть, в которой трафик DNS будет маршрутизироваться через экземпляр брандмауэра Azure.
2. В разделе **Параметры** выберите **DNS-серверы**.
3. Для параметра **DNS-серверы** выберите значение **Пользовательский**.
4. Введите частный IP-адрес брандмауэра.
5. Щелкните **Сохранить**.
6. Перезапустите виртуальные машины, подключенные к виртуальной сети, чтобы им были назначены новые параметры DNS-сервера. Виртуальные машины продолжают использовать текущие параметры DNS, пока они не будут перезапущены.

##### <a name="enable-dns-proxy"></a>Включение DNS-прокси

1. Выберите экземпляр брандмауэра Azure.
2. В разделе **Параметры** выберите **параметры DNS**.
3. По умолчанию **DNS-прокси** отключен. Если этот параметр включен, брандмауэр прослушивает порт 53 и перенаправляет запросы DNS на настроенные DNS-серверы.
4. Проверьте конфигурацию **DNS-серверов** и убедитесь, что параметры соответствуют вашей среде.
5. Щелкните **Сохранить**.

:::image type="content" source="media/dns-settings/dns-proxy.png" alt-text="Снимок экрана, показывающий параметры прокси-сервера D S.":::

#### <a name="configure-dns-proxy---azure-cli"></a>Настройка прокси-сервера DNS — Azure CLI

Для настройки параметров прокси-сервера DNS в брандмауэре Azure можно использовать Azure CLI. Его также можно использовать для обновления виртуальных сетей, чтобы использовать брандмауэр Azure в качестве DNS-сервера.

##### <a name="configure-virtual-network-dns-servers"></a>Настройка DNS-серверов виртуальной сети

В следующем примере виртуальная сеть настраивается на использование брандмауэра Azure в качестве DNS-сервера.
 
```azurecli-interactive
az network vnet update \
    --name VNetName \ 
    --resource-group VNetRG \
    --dns-servers <firewall-private-IP>
```

##### <a name="enable-dns-proxy"></a>Включение DNS-прокси

В следующем примере включается функция прокси-сервера DNS в брандмауэре Azure.

```azurecli-interactive
az network firewall update \
    --name fwName \ 
    --resource-group fwRG \
    --enable-dns-proxy true
```

#### <a name="configure-dns-proxy---azure-powershell"></a>Настройка прокси-сервера DNS — Azure PowerShell

Для настройки параметров прокси-сервера DNS в брандмауэре Azure можно использовать Azure PowerShell. Его также можно использовать для обновления виртуальных сетей, чтобы использовать брандмауэр Azure в качестве DNS-сервера.

##### <a name="configure-virtual-network-dns-servers"></a>Настройка DNS-серверов виртуальной сети

В следующем примере виртуальная сеть настраивается для использования брандмауэра Azure в качестве DNS-сервера.

```azurepowershell
$dnsServers = @("<firewall-private-IP>")
$VNet = Get-AzVirtualNetwork -Name "VNetName" -ResourceGroupName "VNetRG"
$VNet.DhcpOptions.DnsServers = $dnsServers

$VNet | Set-AzVirtualNetwork
```

##### <a name="enable-dns-proxy"></a>Включение DNS-прокси

В следующем примере включается функция прокси-сервера DNS в брандмауэре Azure.

```azurepowershell
$azFw = Get-AzFirewall -Name "fwName" -ResourceGroupName "fwRG"
$azFw.DNSEnableProxy = $true

$azFw | Set-AzFirewall
```

## <a name="next-steps"></a>Дальнейшие действия

[Фильтрация FQDN в правилах сети](fqdn-filtering-network-rules.md)
