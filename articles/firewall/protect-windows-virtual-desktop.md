---
title: Использование брандмауэра Azure для защиты виртуального рабочего стола Windows
description: Узнайте, как использовать брандмауэр Azure для защиты развертываний виртуальных рабочих столов Windows
author: vhorne
ms.service: firewall
services: firewall
ms.topic: how-to
ms.date: 05/06/2020
ms.author: victorh
ms.openlocfilehash: d5320f44aa5d922cea852ab09e5141fad277e2b0
ms.sourcegitcommit: f0a3ee8ff77ee89f83b69bc30cb87caa80f1e724
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/26/2021
ms.locfileid: "105566032"
---
# <a name="use-azure-firewall-to-protect-window-virtual-desktop-deployments"></a>Защита развертывания виртуальных рабочих столов в Windows с помощью Брандмауэра Azure

Виртуальный рабочий стол Windows — это служба виртуализации для настольных систем и приложений, которая работает в Azure. Когда конечный пользователь подключается к среде виртуальных рабочих столов Windows, его сеанс выполняется пулом узлов. Пул узлов — это коллекция виртуальных машин Azure, которые регистрируются в виртуальном рабочем столе Windows в качестве узлов сеансов. Эти виртуальные машины работают в виртуальной сети и подчиняются элементам управления безопасности виртуальной сети. Им требуется исходящий доступ в Интернет к службе виртуальных рабочих столов Windows для правильной работы, а также для конечных пользователей требуется исходящий доступ в Интернет. Брандмауэр Azure помогает заблокировать среду и отфильтровать исходящий трафик.

[![Архитектура ](media/protect-windows-virtual-desktop/windows-virtual-desktop-architecture-diagram.png) виртуальных рабочих столов Windows](media/protect-windows-virtual-desktop/windows-virtual-desktop-architecture-diagram.png#lightbox)

Следуйте указаниям в этой статье, чтобы обеспечить дополнительную защиту пула узлов виртуальных рабочих столов Windows с помощью брандмауэра Azure.

## <a name="prerequisites"></a>Предварительные условия


 - Развернутая среда виртуальных рабочих столов Windows и пул узлов.

   Дополнительные сведения см. в разделе [учебник. Создание пула узлов с помощью Azure Marketplace](../virtual-desktop/create-host-pools-azure-marketplace.md) и [Создание пула узлов с шаблоном Azure Resource Manager](../virtual-desktop/virtual-desktop-fall-2019/create-host-pools-arm-template.md).

Дополнительные сведения о средах виртуальных рабочих столов Windows см. в разделе [Среда виртуальных рабочих столов Windows](../virtual-desktop/environment-setup.md).

## <a name="host-pool-outbound-access-to-windows-virtual-desktop"></a>Исходящий доступ пула узлов к виртуальному рабочему столу Windows

Виртуальные машины Azure, созданные для виртуальных рабочих столов Windows, должны иметь доступ к нескольким полным доменным именам (FQDN) для правильной работы. Брандмауэр Azure предоставляет тег полного доменного имени виртуальной среды Windows для упрощения этой настройки. Чтобы разрешить исходящий трафик виртуальных рабочих столов Windows, выполните следующие действия.

- Разверните брандмауэр Azure и настройте для подсети пула узлов виртуальных рабочих столов Windows определяемый пользователем маршрут (UDR), чтобы направить весь трафик через брандмауэр Azure. Теперь ваш маршрут по умолчанию указывает на брандмауэр.
- Создайте коллекцию правил приложений и добавьте правило, чтобы включить тег полного доменного имени *виндовсвиртуалдесктоп* . Диапазон исходных IP-адресов — это виртуальная сеть пула узлов, протокол **HTTPS**, а целевой объект — **виндовсвиртуалдесктоп**.

- Набор необходимых учетных записей хранилища и служебной шины для пула узлов виртуальных рабочих столов Windows зависит от развертывания, поэтому он еще не захватывается в теге полного доменного имени Виндовсвиртуалдесктоп. Это можно решить одним из следующих способов.

   - Разрешите доступ по протоколу HTTPS из подсети пула узлов в * xt.blob.core.windows.net, * eh.servicebus.windows.net и * xt.table.core.windows.net. Эти полные доменные имена обеспечивают необходимый доступ, но менее строгие.
   - Используйте следующий запрос log Analytics для вывода точных полных доменных имен, а затем разрешите их явно в правилах приложения брандмауэра.
   ```
   AzureDiagnostics
   | where Category == "AzureFirewallApplicationRule"
   | search "Deny"
   | search "gsm*eh.servicebus.windows.net" or "gsm*xt.blob.core.windows.net" or "gsm*xt.table.core.windows.net"
   | parse msg_s with Protocol " request from " SourceIP ":" SourcePort:int " to " FQDN ":" *
   | project TimeGenerated,Protocol,FQDN
   ```

- Создайте коллекцию сетевых правил, добавив следующие правила.

   - Разрешить DNS — разрешить передачу трафика из частного IP-адреса в * для TCP-и UDP-портов 53.
   - Разрешить KMS — разрешить передачу трафика от виртуальных машин Windows виртуальных рабочих столов в службу активации Windows через TCP-порт 1688. Дополнительные сведения о IP-адресах назначения см. [в статье сбой активации Windows в сценарии принудительного туннелирования](/troubleshoot/azure/virtual-machines/custom-routes-enable-kms-activation#solution).

> [!NOTE]
> В некоторых развертываниях могут не требоваться правила DNS, например Azure Active Directory контроллеры домена перенаправлять запросы DNS на Azure DNS по адресу 168.63.129.16.

## <a name="host-pool-outbound-access-to-the-internet"></a>Исходящий доступ к Интернету для пула узлов

В зависимости от потребностей Организации может потребоваться включить безопасный исходящий доступ в Интернет для конечных пользователей. В случаях, когда список разрешенных целевых объектов определен правильно (например, [Microsoft 365 Access](/microsoft-365/enterprise/microsoft-365-ip-web-service)), можно использовать правила приложения и сети брандмауэра Azure для настройки требуемого доступа. Этот параметр направляет трафик конечных пользователей непосредственно в Интернет для лучшей производительности.

Чтобы отфильтровать исходящий Интернет-трафик пользователей с помощью существующего локального безопасного веб-шлюза, можно настроить браузер или другие приложения, работающие в пуле узлов виртуальных рабочих столов Windows, с явной конфигурацией прокси-сервера. Например, см. статью [Использование параметров командной строки Microsoft ребра для настройки параметров прокси-сервера](/deployedge/edge-learnmore-cmdline-options-proxy-settings). Эти параметры прокси влияют только на доступ к Интернету для конечных пользователей, что позволяет исходящий трафик платформы виртуальных рабочих столов Windows напрямую через брандмауэр Azure.

## <a name="additional-considerations"></a>Дополнительные сведения

В зависимости от требований может потребоваться настроить дополнительные правила брандмауэра.

- Доступ к NTP-серверу

   По умолчанию виртуальные машины под управлением Windows подключаются к time.windows.com через UDP-порт 123 для синхронизации времени. Создайте Сетевое правило, разрешающее этот доступ, или для сервера времени, который используется в вашей среде.


## <a name="next-steps"></a>Дальнейшие действия

- Дополнительные сведения о виртуальном рабочем столе Windows: [что такое виртуальный рабочий стол Windows?](../virtual-desktop/overview.md)