---
title: Руководство по настройке Azure Active Directory B2C с удостоверением проверки связи
titleSuffix: Azure AD B2C
description: Узнайте, как интегрировать проверку подлинности Azure AD B2C с удостоверением проверки связи
services: active-directory-b2c
author: gargi-sinha
manager: martinco
ms.service: active-directory
ms.workload: identity
ms.topic: how-to
ms.date: 01/20/2021
ms.author: gasinh
ms.subservice: B2C
ms.openlocfilehash: 430629f94695f0689422434c8d80fe4e1876e5dd
ms.sourcegitcommit: 100390fefd8f1c48173c51b71650c8ca1b26f711
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/27/2021
ms.locfileid: "98900270"
---
# <a name="tutorial-configure-ping-identity-with-azure-active-directory-b2c-for-secure-hybrid-access"></a>Руководство. Настройка проверки подлинности с помощью Azure Active Directory B2C для безопасного гибридного доступа

В этом примере руководства вы узнаете, как расширить Azure Active Directory (AD) B2C с помощью  [PingAccess](https://www.pingidentity.com/en/software/pingaccess.html#:~:text=%20Modern%20Access%20Managementfor%20the%20Digital%20Enterprise%20,consistent%20enforcement%20of%20security%20policies%20by...%20More) и [PingFederate](https://www.pingidentity.com/en/software/pingfederate.html) , чтобы обеспечить безопасный гибридный доступ.

Многие существующие веб-свойства, такие как сайты электронной коммерции и веб-приложения, предоставляемые в Интернете, развертываются за системой прокси-сервера, которая иногда называется системой обратных прокси-серверов. Эти системы прокси предоставляют различные функции, включая предварительную проверку подлинности, применение политик и маршрутизацию трафика. Примеры вариантов использования включают защиту веб-приложения от входящего веб-трафика и предоставление единого управления сеансами при развертывании распределенных серверов.

В большинстве случаев такая конфигурация включает слой преобразования проверки подлинности, sanctioned проверку подлинности из веб-приложения. Обратные прокси в свою очередь предоставляют веб-приложениям контекст пользователей, прошедших проверку подлинности, в более простой форме, такой как значение заголовка в форме Clear или Digest. В такой конфигурации приложения не используют такие стандартные токены отрасли, как язык разметки зявлений системы безопасности (SAML) (SAML), OAuth или Open ID Connect (OIDC), а не зависят от прокси-сервера для предоставления контекста проверки подлинности и поддержания сеанса с агентом конечного пользователя, таким как браузер или собственное приложение. В качестве службы, работающей в "злоумышленнике в середине", прокси-серверы могут предоставлять конечный контроль над сеансом. Это также означает, что прокси-служба должна быть высокоэффективной и масштабируемой, не стать узким местом или единой точкой отказа для приложений, исходящим от службы прокси-сервера. Схема представляет собой типичную реализацию обратных прокси-серверов и поток обмена данными.

![на рисунке показана реализация обратных прокси-серверов](./media/partner-ping/reverse-proxy.png)

В ситуации, когда вы хотите модернизировать платформу идентификации в таких конфигурациях, возникают следующие проблемы.

- Как можно отложить усилия на модернизации приложений от платформы удостоверений модернизации?

- Как можно установить среду сосуществования с современной и устаревшей аутентификацией, используя от современных поставщиков службы удостоверений?

  а. Как обеспечить согласованность взаимодействия конечных пользователей?

  b. Как обеспечить единый вход для существующих приложений?

Мы обсудим подход к решению таких проблем путем интеграции Azure AD B2C с технологиями [PingAccess](https://www.pingidentity.com/en/software/pingaccess.html#:~:text=%20Modern%20Access%20Managementfor%20the%20Digital%20Enterprise%20,consistent%20enforcement%20of%20security%20policies%20by...%20More) и [PingFederate](https://www.pingidentity.com/en/software/pingfederate.html) .

## <a name="coexistence-environment"></a>Среда сосуществования

Технически приемлемым простым решением, которое также является экономичным, является настройка системы обратных прокси-серверов для использования современной системы идентификации, делегирования проверки подлинности.  
В этом случае учетные записи-посредники будут поддерживать современные протоколы проверки подлинности и использовать проверку подлинности на основе пассивного доступа, которая будет передавать пользователя новому поставщику удостоверений (IdP).

### <a name="azure-ad-b2c-as-an-identity-provider"></a>Azure AD B2C в качестве поставщика удостоверений

Azure AD B2C имеет возможность определять **политики** , которые направляют различные пользовательские интерфейсы и поведения **, называемые** взаимодействием с сервером. Каждая такая политика предоставляет конечную точку протокола, которая может выполнять проверку подлинности, как если бы это был IdP. Для конкретных политик не требуется специальная обработка на стороне приложения. Приложение просто превращает стандартный запрос на проверку подлинности в конечную точку проверки подлинности конкретного протокола, предоставляемую интересующей вас политикой.  
Azure AD B2C можно настроить для совместного использования одного и того же поставщика в нескольких политиках или уникальном поставщике для каждой политики. Каждое приложение может указывать на одну или несколько из этих политик, выполнив собственный запрос проверки подлинности протокола и обеспечивая необходимые поведения пользователей, такие как вход, регистрация и изменение профиля. На схеме показаны OIDC и рабочие процессы приложения SAML.

![на рисунке показана реализация OIDC и SAML](./media/partner-ping/azure-ad-identity-provider.png)

Хотя упомянутый сценарий хорошо подходит для современных приложений, для устаревших приложений может быть непросто перенаправлять пользователя, так как запрос доступа к приложениям может не включать контекст для взаимодействия с пользователем. В большинстве случаев уровень прокси или встроенный агент в веб-приложении перехватывает запрос на доступ.

### <a name="pingaccess-as-a-reverse-proxy"></a>PingAccess в качестве обратных прокси-серверов

Многие клиенты развернули PingAccess в качестве обратного прокси-сервера для воспроизведения одной или нескольких ролей, как отмечалось ранее в этой статье. PingAccess может перехватывать прямой запрос, перехватывая его в середину или как перенаправление, которое поступает от агента, работающего на сервере веб-приложений.

PingAccess можно настроить с помощью OIDC, OAuth2 или SAML для выполнения проверки подлинности для вышестоящего поставщика проверки подлинности. Для этой цели на сервере PingAccess можно настроить один вышестоящий IdP. На схеме ниже показана эта конфигурация.

![на рисунке показано использование PingAccess с реализацией OIDC](./media/partner-ping/authorization-flow.png)

В типичном развертывании Azure AD B2C, где несколько политик предоставляют несколько **поставщиков удостоверений**, это является проблемой. Так как PingAccess можно настроить только с одним вышестоящим IdP.  

### <a name="pingfederate-as-a-federation-proxy"></a>PingFederate как прокси-сервер федерации

PingFederate — это корпоративный мост, который можно полностью настроить в качестве поставщика проверки подлинности или прокси для других потоков поставщиков удостоверений, если это необходимо. Эта возможность показана на следующей схеме.

![на рисунке показана реализация PingFederate](./media/partner-ping/pingfederate.png)

Эта возможность может использоваться для контекстно-или динамической или декларативного переключения входящего запроса на определенную политику Azure AD B2C. Ниже приведено описание потока последовательности протоколов для этой конфигурации.

![на рисунке показан рабочий процесс PingAccess и PingFederate](./media/partner-ping/pingaccess-pingfederate-workflow.png)

## <a name="prerequisites"></a>Предварительные требования

Чтобы приступить к работе, вам потребуется:

- Подписка Azure. Если у вас ее нет, получите [бесплатную учетную запись](https://azure.microsoft.com/free/).

- [Клиент Azure AD B2C](https://docs.microsoft.com/azure/active-directory-b2c/tutorial-create-tenant) , связанный с вашей подпиской Azure.

- PingAccess и PingFederate разворачиваются в контейнерах DOCKER или непосредственно на виртуальных машинах Azure.

## <a name="connectivity"></a>Соединение

Убедитесь, что подключено следующее.

- **PingAccess Server** — может обмениваться данными с сервером PingFederate, браузером клиента, OIDC, известным и обнаружением ключей OAuth, опубликованным службой Azure AD B2C и PingFederate Server.

- **PingFederate Server** — может обмениваться данными с сервером PingAccess, клиентским браузером, OIDC, известным и обнаружением ключей OAuth, опубликованным службой Azure AD B2C.

- **Устаревшее или заданное на основе заголовков приложение AuthN** — может взаимодействовать с сервером PingAccess и с него.

- **Приложение проверяющей стороны SAML** — может получать доступ к трафику браузера от клиента. Возможность доступа к метаданным федерации SAML, опубликованным службой Azure AD B2C.

- **Современное приложение** — может получить доступ к трафику браузера от клиента. Возможность доступа к OIDC, известным операциям OAuth и обнаружению ключей, опубликованным службой Azure AD B2C.

- **REST API** — может достичь трафика от собственного или веб-клиента. Возможность доступа к OIDC, известным операциям OAuth и обнаружению ключей, опубликованным службой Azure AD B2C.

## <a name="configure-azure-ad-b2c"></a>Настройка Azure AD B2C

Для этой цели можно использовать базовые политики "пользовательские потоки" или "Расширенная идентификация Enterprise Framework (инфраструктура процедур идентификации)". PingAccess создает конечную точку метаданных на основе значения **издателя** , используя соглашение об обнаружении на основе [webfinger](https://tools.ietf.org/html/rfc7033) .
Чтобы следовать этому соглашению, обновите обновление поставщика Azure AD B2C, используя свойства политики в потоках пользователей.

![на рисунке показаны параметры токена](./media/partner-ping/token-setting.png)

В расширенных политиках этот параметр можно настроить с помощью элемента метаданных **иссуанцеклаимпаттерн** , чтобы **аусоритивистфп** значение в [техническом профиле издателя маркера JWT](https://docs.microsoft.com/azure/active-directory-b2c/jwt-issuer-technical-profile).

## <a name="configure-pingaccesspingfederate"></a>Настройка PingAccess и PingFederate

В следующем разделе описывается необходимая конфигурация.
На схеме показан общий поток пользователя для интеграции.

![на рисунке показана интеграция PingAccess и PingFederate](./media/partner-ping/pingaccess.png)

### <a name="configure-pingfederate-as-the-token-provider"></a>Настройка PingFederate в качестве поставщика маркеров

Чтобы настроить PingFederate в качестве поставщика маркеров для PingAccess, убедитесь, что установлено подключение между PingFederate и PingAccess, а затем подключение из PingAccess к PingFederate.  
Инструкции по настройке см. в [этой статье](https://docs.pingidentity.com/bundle/pingaccess-61/page/zgh1581446287067.html) .

### <a name="configure-a-pingaccess-application-for-header-based-authentication"></a>Настройка приложения PingAccess для проверки подлинности на основе заголовков

Для целевого веб-приложения для проверки подлинности на основе заголовков необходимо создать приложение PingAccess. Выполните следующие действия.

#### <a name="step-1--create-a-virtual-host"></a>Шаг 1. Создание виртуального узла

>[!IMPORTANT]
>Чтобы настроить это решение, необходимо создать виртуальный узел для каждого приложения. Дополнительные сведения о вопросах конфигурации и их влиянии см. в разделе [Ключевые моменты](https://docs.pingidentity.com/bundle/pingaccess-43/page/reference/pa_c_KeyConsiderations.html).

Чтобы создать виртуальный узел, выполните следующие действия.

1. Выберите **Параметры**  >  **доступ к**  >  **виртуальным узлам** .

2. Выберите **Добавить виртуальный узел** .

3. В поле узел введите часть полного доменного имени URL-адреса приложения.

4. В поле Порт введите **443** .

5. Нажмите кнопку **Сохранить**.

#### <a name="step-2--create-a-web-session"></a>Шаг 2. Создание веб-сеанса

Чтобы создать веб-сеанс, выполните следующие действия.

1. Выберите **Параметры**  >  **доступ**  >  **веб-сеансы** .

2. Выберите " **Добавить веб-сеанс** "

3. Укажите **имя** для веб-сеанса.

4. Выберите **Тип файла cookie**: " **подписанный JWT** или **зашифрованный JWT** "

5. Укажите уникальное значение для **аудитории**

6. В поле **Client ID (идентификатор клиента** ) введите **идентификатор приложения Azure AD** .

7. В поле **секрет клиента** введите **ключ** , созданный для приложения в Azure AD.

8. Необязательно. Вы можете создавать и использовать пользовательские утверждения с помощью Microsoft Graph API. Если вы решили сделать это, выберите **Дополнительно** и отмените выбор параметров **профиль запроса** и **обновить атрибуты пользователя** . Дополнительные сведения об использовании настраиваемых утверждений см. в статье [Использование настраиваемого утверждения](https://docs.microsoft.com/azure/active-directory/application-proxy-ping-access#optional---use-a-custom-claim).

9. Нажмите кнопку **Сохранить**.

#### <a name="step-3--create-identity-mapping"></a>Шаг 3. Создание сопоставления удостоверений

>[!NOTE]
>Сопоставление удостоверений может использоваться с несколькими приложениями, если в заголовке предполагается несколько приложений, ожидающих одни и те же данные.

Чтобы создать сопоставление удостоверений, выполните следующие действия.

1. Последовательно выберите **Параметры**  >    >  **сопоставления удостоверений** доступа.

2. Выберите **Добавить сопоставление удостоверений** .

3. Укажите **имя**

4. Выберите тип сопоставления идентификаторов **для сопоставления идентификаторов заголовков**

5. В таблице **сопоставления атрибутов** укажите необходимые сопоставления. Например, примененная к объекту директива

   Имя атрибута | Имя заголовка |
   |-------|--------|
   |upn | x — усерпринЦипленаме |
   |email   |    x-адрес электронной почты  |
   |oid   | OID x  |
   |scp   |     область x |
   |amr    |    x-AMR    |

6. Нажмите кнопку **Сохранить**.

#### <a name="step-4--create-a-site"></a>Шаг 4. Создание сайта

>[!NOTE]
>В некоторых конфигурациях сайт может содержать более одного приложения. Сайт можно использовать с несколькими приложениями, если это уместно.

Чтобы создать сайт, выполните следующие действия.

1. Переход к **основным**  >  **сайтам**

2. Выберите **Добавить сайт**

3. Укажите **имя** сайта

4. Введите **целевой объект** сайта. Целевым объектом является пара "имя узла: порт" для сервера, на котором размещено приложение. Не вводите путь для приложения в этом поле. Например, приложение в https://mysite:9999/AppName будет иметь целевое значение личного сайта: 9999

5. Укажите, ожидает ли целевой объект безопасные соединения.

6. Если целевой объект ожидает безопасных подключений, задайте для доверенной группы сертификатов значение **доверять любым**.

7. Нажмите кнопку **Сохранить**.

#### <a name="step-5--create-an-application"></a>Шаг 5. Создание приложения

Выполните следующие действия, чтобы создать приложение в PingAccess для каждого приложения в Azure, которое необходимо защитить.

1. Переход к **основным**  >  **приложениям**

2. Выберите **Добавить приложение** .

3. Укажите **имя** приложения

4. При необходимости введите **Описание** приложения.

5. Укажите **корневой контекст контекста** для приложения. Например, приложение в https://mysite:9999/AppName будет иметь корень контекста/аппнаме. Корень контекста должен начинаться с косой черты (/), не должен заканчиваться косой чертой (/) и может быть более одного слоя, например/АППС/мяпп.

6. Выберите созданный **виртуальный узел** .

   >[!NOTE]
   >Сочетание виртуального узла и корня контекста должны быть уникальными в PingAccess.

7. Выберите созданный **веб-сеанс**

8. Выберите созданный **сайт** , содержащий приложение.

9. Выберите созданное **Сопоставление удостоверений** .

10. Выберите **включено** , чтобы включить сайт при сохранении

11. Нажмите кнопку **Сохранить**.

### <a name="configure-the-pingfederate-authentication-policy"></a>Настройка политики проверки подлинности PingFederate

Настройка политики проверки подлинности PingFederate в Федерацию с несколькими поставщиков удостоверений, предоставленными клиентами Azure AD B2C

1. Создайте контракт для моста атрибутов между поставщиков удостоверений и SP. Дополнительные сведения см. в разделе [контракты центра Федерации и политики проверки подлинности](https://docs.pingidentity.com/bundle/pingfederate-101/page/ope1564002971971.html). Вам, скорее всего, потребуется только один контракт, если только пакету обновления не требуется другой набор атрибутов из каждого IdP.

2. Для каждого IdP создайте подключение IdP между IdP и PingFederate, центром Федерации как SP.

3. В окне **сопоставление целевых сеансов** добавьте применимые контракты политики проверки подлинности в подключение IDP.

4. **В окне** селекторы настройте селектор проверки подлинности. Например, ознакомьтесь с экземпляром **первого адаптера идентификатора** , чтобы связать каждый IDP с соответствующим соединением IDP в политике проверки подлинности.

5. Создайте подключение SP между PingFederate, центром Федерации в качестве IdP и пакетом обновления.

6. Добавьте соответствующий контракт политики проверки подлинности в соединение SP в окне **Сопоставление источника проверки подлинности** .

7. Работа с каждым IdP для подключения к PingFederate, концентратору Федерации в качестве SP.

8. Работа с пакетом обновления для подключения к PingFederate, концентратору Федерации в качестве IdP.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения см. в следующих статьях.

- [Пользовательские политики в Azure AD B2C](https://docs.microsoft.com/azure/active-directory-b2c/custom-policy-overview)

- [Приступая к работе с пользовательскими политиками в Azure AD B2C](https://docs.microsoft.com/azure/active-directory-b2c/custom-policy-get-started?tabs=applications)
