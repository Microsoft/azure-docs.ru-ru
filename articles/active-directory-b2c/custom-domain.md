---
title: Включение Azure AD B2C пользовательских доменов
titleSuffix: Azure AD B2C
description: Узнайте, как включить личные домены в URL-адресах перенаправления для Azure Active Directory B2C.
services: active-directory-b2c
author: msmimart
manager: celestedg
ms.service: active-directory
ms.workload: identity
ms.topic: how-to
ms.date: 03/15/2021
ms.author: mimart
ms.subservice: B2C
zone_pivot_groups: b2c-policy-type
ms.openlocfilehash: 869bd7b02186873f490d324cec863c7f26ee8469
ms.sourcegitcommit: 4bda786435578ec7d6d94c72ca8642ce47ac628a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/16/2021
ms.locfileid: "103555448"
---
# <a name="enable-custom-domains-for-azure-active-directory-b2c"></a>Включение пользовательских доменов для Azure Active Directory B2C

[!INCLUDE [active-directory-b2c-choose-user-flow-or-custom-policy](../../includes/active-directory-b2c-choose-user-flow-or-custom-policy.md)]

В этой статье описывается, как включить пользовательские домены в URL-адресах перенаправления для Azure Active Directory B2C (Azure AD B2C). Использование пользовательского домена с приложением обеспечивает более эффективное взаимодействие с пользователем. С точки зрения пользователя они остаются в вашем домене во время входа в систему, а не перенаправляются в домен Azure AD B2C по умолчанию *<имя клиента>. b2clogin.com*.

![Пользовательский интерфейс пользовательского домена](./media/custom-domain/custom-domain-user-experience.png)

## <a name="custom-domain-overview"></a>Общие сведения о пользовательском домене

Вы можете включить пользовательские домены для Azure AD B2C с помощью [передней дверцы Azure](https://azure.microsoft.com/services/frontdoor/). Передняя дверца Azure — это глобальная, масштабируемая точка входа, которая использует сеть Microsoft Global ребра для создания быстрых, безопасных и масштабируемых веб-приложений. Вы можете подготовить Azure AD B2C содержимое за пределы передней дверцы Azure, а затем настроить параметр на передней дверце Azure для доставки содержимого через личный домен в URL-адресе вашего приложения.

На следующей схеме показана интеграция передней дверцы Azure.

1. В приложении пользователь нажимает кнопку входа, которая переводит их на страницу входа Azure AD B2C. На этой странице указывается пользовательское доменное имя.
1. Веб-браузер разрешает пользовательское доменное имя в IP-адрес внешней дверцы Azure. Во время разрешения DNS запись канонического имени (CNAME) с пользовательским именем домена указывает на клиентский узел по умолчанию переднего плана (например, `contoso.azurefd.net` ). 
1. Трафик, адресованный в личный домен (например, `login.contoso.com` ), направляется на указанный интерфейсный узел по умолчанию переднего плана ( `contoso.azurefd.net` ).
1. Передняя дверца Azure вызывает Azure AD B2C содержимое, используя `<tenant-name>.b2clogin.com` домен по умолчанию Azure AD B2C. Запрос к конечной точке Azure AD B2C включает пользовательский заголовок HTTP, который содержит исходное имя личного домена.
1. Azure AD B2C отвечает на запрос, отображая соответствующее содержимое и исходный личный домен.

![Схема сети пользовательского домена](./media/custom-domain/custom-domain-network-flow.png)

> [!IMPORTANT]
> Подключение из браузера к передней дверце Azure всегда должно использовать IPv4 вместо IPv6.

При использовании личных доменов учитывайте следующее.

- Можно настроить несколько пользовательских доменов. Максимальное число поддерживаемых пользовательских доменов см. в статье [ограничения и ограничения службы Azure AD](../active-directory/enterprise-users/directory-service-limits-restrictions.md) для Azure AD B2C и [подписки Azure, а также ограничения службы, квоты и ограничения](../azure-resource-manager/management/azure-subscription-service-limits.md#azure-front-door-service-limits) для передней дверцы Azure.
- Передняя дверца Azure — это отдельная служба Azure, поэтому будет взиматься дополнительная плата. Дополнительные сведения см. в статье [цены на переднюю дверь](https://azure.microsoft.com/pricing/details/frontdoor).
- В настоящее время функция [брандмауэра веб-приложения](../web-application-firewall/afds/afds-overview.md) для передней дверцы Azure не поддерживается.
- После настройки личных доменов пользователи по-прежнему смогут получить доступ к Azure AD B2C доменному имени по умолчанию *<имя клиента>. b2clogin.com* (если вы не используете пользовательскую политику и не [блокируете доступ](#block-access-to-the-default-domain-name).
- Если у вас несколько приложений, перенесите их в личный домен, так как браузер сохраняет сеанс Azure AD B2C в используемом в данный момент доменном имени.

## <a name="prerequisites"></a>Предварительные требования

[!INCLUDE [active-directory-b2c-customization-prerequisites](../../includes/active-directory-b2c-customization-prerequisites.md)]


## <a name="add-a-custom-domain-name-to-your-tenant"></a>Добавление пользовательского доменного имени в клиент

Следуйте указаниям, чтобы [Добавить и проверить личный домен в Azure AD](../active-directory/fundamentals/add-custom-domain.md). После проверки домена Удалите созданную запись типа TXT DNS.

> [!IMPORTANT]
> Для выполнения этих действий обязательно войдите в клиент **Azure AD B2C** и выберите службу **Azure Active Directory** .

Проверьте каждый поддомен, который планируется использовать. Проверка недостаточности всего домена верхнего уровня. Например, чтобы иметь возможность войти в систему с помощью *Login.contoso.com* и *Account.contoso.com*, необходимо проверить оба поддомена, а не только домен *contoso.com* верхнего уровня.  

## <a name="create-a-new-azure-front-door-instance"></a>Создание нового экземпляра передней дверцы Azure

Выполните действия по [созданию передней дверцы приложения](../frontdoor/quickstart-create-front-door.md#create-a-front-door-for-your-application) , используя параметры по умолчанию для внешнего узла и правила маршрутизации. 

> [!IMPORTANT]
> Для выполнения этих действий после входа в портал Azure на шаге 1 выберите **Каталог + подписка** и выберите каталог, содержащий подписку Azure, которую вы хотите использовать для работы с передней дверцей Azure. Это *не* должен быть каталог, содержащий клиент Azure AD B2C. 

На шаге **Добавление серверной части** используйте следующие параметры.

* В качестве **типа узла внутреннего** сервера выберите **Пользовательский узел**.  
* В поле **имя узла внутреннего сервера** выберите имя узла для конечной точки Azure AD B2C, <имя клиента>. b2clogin.com. Например, contoso.b2clogin.com. 
* В поле **заголовок узла внутреннего** сервера выберите то же значение, которое вы выбрали для **имени внутреннего узла**.

![Добавление серверной части](./media/custom-domain/add-a-backend.png)

После добавления **серверной части** в **внутренний пул** отключите **зонды работоспособности**.

![Добавление внутреннего пула.](./media/custom-domain/add-a-backend-pool.png)

## <a name="set-up-your-custom-domain-on-azure-front-door"></a>Настройка пользовательского домена на передней дверце Azure

Выполните действия, чтобы [Добавить личный домен в переднюю дверцу](../frontdoor/front-door-custom-domain.md). При создании `CNAME` записи для личного домена используйте имя личного домена, проверенное ранее в шаге [Добавление имени личного домена в Azure AD](#add-a-custom-domain-name-to-your-tenant) . 

После проверки имени пользовательского домена выберите **имя пользовательского домена HTTPS**. Затем в разделе **тип управления сертификатами** выберите [Управление передней дверцей](../frontdoor/front-door-custom-domain-https.md#option-1-default-use-a-certificate-managed-by-front-door)или [Используйте собственный сертификат](../frontdoor/front-door-custom-domain-https.md#option-2-use-your-own-certificate). 

На следующем снимке экрана показано, как добавить личный домен и включить HTTPS с помощью сертификата внешней дверцы Azure.

![Настройка пользовательского домена передней дверцы Azure](./media/custom-domain/azure-front-door-add-custom-domain.png) 

## <a name="configure-cors"></a>Настройка CORS

При [настройке пользовательского интерфейса Azure AD B2C](customize-ui-with-html.md) с помощью HTML-шаблона необходимо [настроить CORS](customize-ui-with-html.md?pivots=b2c-user-flow.md#3-configure-cors) с помощью личного домена.

Настройте хранилище BLOB-объектов Azure для совместного использования ресурсов в разных источниках, выполнив следующие действия.

1. Войдите в свою учетную запись хранения на [портале Azure](https://portal.azure.com).
1. В меню выберите **CORS**.
1. В поле **Допустимые источники** введите `https://your-domain-name`. Замените `your-domain-name` именем своего домена. Например, `https://login.contoso.com`. При вводе имени клиента используйте все строчные буквы.
1. В поле **Допустимые методы** выберите `GET` и `OPTIONS`.
1. В поле **Допустимые заголовки** введите звездочку (*).
1. В поле **Доступные заголовки** введите звездочку (*).
1. В поле **Максимальный возраст** введите 200.
1. Щелкните **Сохранить**.

## <a name="configure-your-identity-provider"></a>Настройка поставщика удостоверений

Когда пользователь выбирает вход с помощью поставщика удостоверений в социальных сетях, Azure AD B2C инициирует запрос на авторизацию и осуществляет вход пользователя в выбранный поставщик удостоверений для завершения процесса входа. Запрос авторизации указывает на `redirect_uri` Azure AD B2C доменное имя по умолчанию: 

```http
https://<tenant-name>.b2clogin.com/<tenant-name>/oauth2/authresp
```

Если вы настроили политику, разрешающую вход с помощью внешнего поставщика удостоверений, обновите URI перенаправления OAuth с помощью пользовательского домена. Большинство поставщиков удостоверений позволяют регистрировать несколько URI перенаправления. Рекомендуется добавлять URI перенаправления вместо того, чтобы заменять их, чтобы можно было протестировать пользовательскую политику, не влияя на приложения, использующие Azure AD B2C доменное имя по умолчанию. 

В следующем URI перенаправления:

```http
https://<custom-domain-name>/<tenant-name>/oauth2/authresp
``` 

- Замените **<имя пользовательского домена>** именем личного домена.
- Замените **<имя клиента>** именем своего клиента или идентификатором клиента.

В следующем примере показан допустимый URI перенаправления OAuth.

```http
https://login.contoso.com/contoso.onmicrosoft.com/oauth2/authresp
```

Если вы решили использовать [идентификатор клиента](#optional-use-tenant-id), ДОПУСТИМЫй URI перенаправления OAuth будет выглядеть следующим образом:

```http
https://login.contoso.com/11111111-1111-1111-1111-111111111111/oauth2/authresp
```

Метаданные [поставщиков удостоверений SAML](saml-identity-provider-technical-profile.md) будут выглядеть следующим образом:

```http
https://<custom-domain-name>.b2clogin.com/<tenant-name>/<your-policy>/samlp/metadata?idptp=<your-technical-profile>
```

## <a name="test-your-custom-domain"></a>Проверка личного домена

1. Войдите на [портал Azure](https://portal.azure.com).
1. Выберите фильтр **Каталог и подписка** в верхнем меню, а затем выберите каталог, содержащий клиент Azure AD B2C.
1. На портале Azure найдите и выберите **Azure AD B2C**.
1. В разделе **Политики** выберите **Пользовательские потоки (политики)** .
1. Выберите поток пользователя, а затем выберите **выполнить поток пользователя**.
1. В разделе **Приложение** выберите зарегистрированное ранее веб-приложение с именем *webapp1*. В поле **URL-адрес ответа** должно содержаться значение `https://jwt.ms`.
1. Щелкните **Копировать в буфер обмена**.

    ![Копирование URI запроса авторизации](./media/custom-domain/user-flow-run-now.png)

1. В URL-адресе **конечной точки потока выполнения пользователя** замените домен Azure AD B2C (<имя клиента>. b2clogin.com) на личный домен.  
    Например, вместо:

    ```http
    https://contoso.b2clogin.com/contoso.onmicrosoft.com/oauth2/v2.0/authorize?p=B2C_1_susi&client_id=63ba0d17-c4ba-47fd-89e9-31b3c2734339&nonce=defaultNonce&redirect_uri=https%3A%2F%2Fjwt.ms&scope=openid&response_type=id_token&prompt=login
    ```

    использует

    ```http
    https://login.contoso.com/contoso.onmicrosoft.com/oauth2/v2.0/authorize?p=B2C_1_susi&client_id=63ba0d17-c4ba-47fd-89e9-31b3c2734339&nonce=defaultNonce&redirect_uri=https%3A%2F%2Fjwt.ms&scope=openid&response_type=id_token&prompt=login    
    ```
1. Выберите **Выполнить поток пользователя**. Необходимо загрузить политику Azure AD B2C.
1. Выполните вход с учетными записями Local и социальных сетей.
1. Повторите тест с остальными политиками.

## <a name="configure-your-application"></a>Настройка приложения 

После настройки и тестирования личного домена можно обновить приложения, чтобы загрузить URL-адрес, указывающий личный домен в качестве имени узла, а не домен Azure AD B2C. 

Интеграция пользовательского домена применяется к конечным точкам проверки подлинности, которые используют политики Azure AD B2C (потоки пользователей или пользовательские политики) для проверки подлинности пользователей. Эти конечные точки могут выглядеть следующим образом:

- <code>https://\<custom-domain\>/\<tenant-name\>/<b>\<policy-name\></b>/v2.0/.well-known/openid-configuration</code>

- <code>https://\<custom-domain\>/\<tenant-name\>/<b>\<policy-name\></b>/oauth2/v2.0/authorize</code>

- <code>https://\<custom-domain\>/<tenant-name\>/<b>\<policy-name\></b>/oauth2/v2.0/token</code>

Замените
- **Пользовательский** домен с пользовательским доменом
- **имя клиента** с именем клиента или идентификатором клиента
- **Политика — имя** с именем политики. Дополнительные [сведения о политиках Azure AD B2C](technical-overview.md#identity-experiences-user-flows-or-custom-policies). 


Метаданные [поставщика службы SAML](connect-with-saml-service-providers.md) могут выглядеть следующим образом: 

```html
https://custom-domain-name/tenant-name/policy-name/Samlp/metadata
```

### <a name="optional-use-tenant-id"></a>Используемых Использовать идентификатор клиента

Вы можете заменить имя клиента B2C в URL-адресе идентификатором GUID идентификатора клиента, чтобы удалить все ссылки на "B2C" в URL-адресе. GUID идентификатора клиента можно найти на странице обзора B2C в портал Azure.
Например, измените `https://account.contosobank.co.uk/contosobank.onmicrosoft.com/` на `https://account.contosobank.co.uk/<tenant ID GUID>/`.

Если вы решили использовать идентификатор клиента вместо имени клиента, обязательно обновите **URI перенаправления OAuth** поставщика удостоверений. Дополнительные сведения см. в статье [Настройка поставщика удостоверений](#configure-your-identity-provider).

### <a name="token-issuance"></a>Выдача маркера

Утверждение имени поставщика токена (ISS) изменяется в зависимости от используемого личного домена. Пример:

```http
https://<domain-name>/11111111-1111-1111-1111-111111111111/v2.0/
```

::: zone pivot="b2c-custom-policy"

## <a name="block-access-to-the-default-domain-name"></a>Блокировать доступ к доменному имени по умолчанию

После добавления личного домена и настройки приложения пользователи по-прежнему смогут получить доступ к домену <имя клиента>. b2clogin.com. Чтобы предотвратить доступ, можно настроить политику для проверки запроса авторизации "имя узла" в списке разрешенных доменов. Имя узла — это имя домена, которое отображается в URL-адресе. Имя узла доступно через `{Context:HostName}` [арбитры утверждений](claim-resolver-overview.md). Затем можно будет предоставить пользовательское сообщение об ошибке. 

1. Получите пример политики условного доступа, которая проверяет имя узла из [GitHub](https://github.com/azure-ad-b2c/samples/blob/master/policies/check-host-name).
1. Замените строку `yourtenant` именем вашего клиента Azure AD B2C в каждом файле. Например, если имя вашего клиента B2C — *contosob2c*, все экземпляры `yourtenant.onmicrosoft.com` должны иметь вид `contosob2c.onmicrosoft.com`.
1. Отправьте файлы политики в следующем порядке: `B2C_1A_TrustFrameworkExtensions_HostName.xml` , а затем `B2C_1A_signup_signin_HostName.xml` .

::: zone-end

## <a name="troubleshooting"></a>Устранение неполадок

### <a name="azure-ad-b2c-returns-a-page-not-found-error"></a>Azure AD B2C возвращает ошибку "страница не найдена"

- **Симптом** . После настройки пользовательского домена при попытке входа с помощью личного домена появляется сообщение об ошибке HTTP 404.
- **Возможные причины** : Эта проблема может быть связана с конфигурацией DNS или серверной конфигурацией передней дверцы Azure. 
- **Решение**.  
    1. Убедитесь, что личный домен [зарегистрирован и успешно проверен](#add-a-custom-domain-name-to-your-tenant) в клиенте Azure AD B2C.
    1. Убедитесь, что [личный домен](../frontdoor/front-door-custom-domain.md) настроен правильно. `CNAME`Запись для личного домена должна указывать на интерфейсный узел по умолчанию для передней дверцы Azure (например, contoso.azurefd.NET).
    1. Убедитесь, что [Конфигурация серверного пула переднего плана Azure](#set-up-your-custom-domain-on-azure-front-door) указывает клиенту, где вы настроили пользовательское имя домена и где хранятся пользовательские политики.

### <a name="identify-provider-returns-an-error"></a>Выявление поставщика возвращает ошибку

- **Симптом** . После настройки пользовательского домена можно выполнить вход с использованием локальных учетных записей. Но при входе с использованием учетных данных внешних [социальных сетей или поставщиков удостоверений предприятия](add-identity-provider.md)поставщики удостоверений выводят сообщение об ошибке.
- **Возможные причины** : когда Azure AD B2C принимает пользователя для входа с помощью федеративного поставщика удостоверений, он указывает URI перенаправления. URI перенаправления — это конечная точка, в которой поставщик удостоверений возвращает маркер. URI перенаправления — это тот же домен, который приложение использует для запроса авторизации. Если URI перенаправления еще не зарегистрирован в поставщике удостоверений, он может не доверять новому URI перенаправления, что приводит к появление сообщения об ошибке. 
- **Решение** . выполните действия, описанные в разделе [Настройка поставщика удостоверений](#configure-your-identity-provider) , чтобы добавить новый URI перенаправления. 


## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы

### <a name="can-i-use-azure-front-door-advanced-configuration-such-as-web-application-firewall-rules"></a>Можно ли использовать расширенную конфигурацию передней дверцы Azure, например *правила брандмауэра веб-приложения*? 
  
Хотя дополнительные параметры конфигурации передней дверцы Azure официально не поддерживаются, их можно использовать на свой риск. 

### <a name="when-i-use-run-now-to-try-to-run-my-policy-why-i-cant-see-the-custom-domain"></a>Когда я использую "запустить сейчас", чтобы попытаться запустить политику, почему я не вижу личный домен?

Скопируйте URL-адрес, измените доменное имя вручную и вставьте его обратно в браузер.

### <a name="which-ip-address-is-presented-to-azure-ad-b2c-the-users-ip-address-or-the-azure-front-door-ip-address"></a>Какой IP-адрес будет Azure AD B2C? IP-адрес пользователя или IP-адрес внешней дверцы Azure?

Передняя дверца Azure передает исходный IP-адрес пользователя. Это IP-адрес, который вы увидите в отчетах аудита или пользовательской политике.

### <a name="can-i-use-a-third-party-wab-application-firewall-waf-with-b2c"></a>Можно ли использовать сторонний брандмауэр приложения WAB (WAF) с B2C?

В настоящее время Azure AD B2C поддерживает пользовательский домен только с помощью передней дверцы Azure. Не добавляйте еще одну WAF перед передней дверцей Azure.


## <a name="next-steps"></a>Дальнейшие действия

Сведения о [запросах авторизации OAuth](protocols-overview.md).

