---
title: Мониторинг Azure AD B2C с помощью Azure Monitor
titleSuffix: Azure AD B2C
description: Узнайте, как вести журнал Azure AD B2C событий с Azure Monitor с помощью управления делегированными ресурсами.
services: active-directory-b2c
author: msmimart
manager: celestedg
ms.service: active-directory
ms.workload: identity
ms.topic: how-to
ms.author: mimart
ms.subservice: B2C
ms.date: 01/29/2021
ms.openlocfilehash: bc1dea8121d7986b8394adf6545a0b2c30afb133
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "104580187"
---
# <a name="monitor-azure-ad-b2c-with-azure-monitor"></a>Мониторинг Azure AD B2C с помощью Azure Monitor

Используйте Azure Monitor для маршрутизации Azure Active Directory B2C (Azure AD B2C) для входа и [аудита](view-audit-logs.md) в различные решения мониторинга. Эти журналы можно сохранить для долговременного использования или интегрировать со сторонними средствами для управления сведениями и событиями безопасности (SIEM), чтобы получать аналитические сведения о своей среде.

События журнала можно направить в:

* [Учетная запись хранения](../storage/blobs/storage-blobs-introduction.md)Azure.
* [Рабочая область log Analytics](../azure-monitor/essentials/resource-logs.md#send-to-log-analytics-workspace) (для анализа данных, создания панелей мониторинга и оповещения о конкретных событиях).
* [Концентратор событий](../event-hubs/event-hubs-about.md) Azure (и интегрируется с экземплярами логики Splunk и Sumo).

![Azure Monitor](./media/azure-monitor/azure-monitor-flow.png)

Из этой статьи вы узнаете, как передавать журналы в рабочую область Azure Log Analytics. Затем можно создать панель мониторинга или создать оповещения, основанные на действиях пользователей Azure AD B2C.

> [!IMPORTANT]
> При планировании перемещения журналов Azure AD B2C в различные решения мониторинга или репозиторий учитывайте следующее. Журналы Azure AD B2C содержат персональные данные. Такие данные должны обрабатываться таким образом, чтобы обеспечить соответствующую безопасность персональных данных, включая защиту от несанкционированных или незаконные обработки, используя соответствующие технические или организационные меры.


## <a name="deployment-overview"></a>Общие сведения о развертывании

Azure AD B2C использует [мониторинг Azure Active Directory](../active-directory/reports-monitoring/overview-monitoring.md). Чтобы включить *параметры диагностики* в Azure Active Directory в клиенте Azure AD B2C, используйте [Azure лигхсаусе](../lighthouse/concepts/azure-delegated-resource-management.md) для [делегирования ресурса](../lighthouse/concepts/azure-delegated-resource-management.md), который позволяет Azure AD B2C ( **поставщику услуг**) управлять ресурсом Azure AD ( **клиент**). После выполнения действий, описанных в этой статье, вы получите доступ к группе ресурсов *Azure-AD-B2C-Monitor* , содержащей [рабочую область log Analytics](../azure-monitor/logs/quick-create-workspace.md) на портале **Azure AD B2C** . Вы также сможете передавать журналы из Azure AD B2C в рабочую область Log Analytics.

Во время этого развертывания вы можете авторизовать пользователя или группу в каталоге Azure AD B2C, чтобы настроить экземпляр рабочей области Log Analytics в клиенте, который содержит подписку Azure. Чтобы создать авторизацию, необходимо развернуть шаблон [Azure Resource Manager](../azure-resource-manager/index.yml) в клиенте Azure AD, который содержит подписку.

На следующей схеме показаны компоненты, которые вы настраиваете в клиентах Azure AD и Azure AD B2C.

![Проекция группы ресурсов](./media/azure-monitor/resource-group-projection.png)

Во время этого развертывания вы настроите клиент Azure AD B2C и клиент Azure AD, где будет размещена Log Analytics Рабочая область. Учетной записи Azure AD B2C должна быть назначена роль [глобального администратора](../active-directory/roles/permissions-reference.md#limit-use-of-global-administrator) в клиенте Azure AD B2C. Учетной записи Azure AD, используемой для запуска развертывания, должна быть назначена роль [владельца](../role-based-access-control/built-in-roles.md#owner) в подписке Azure AD. Также важно убедиться, что вы вошли в правильный каталог по мере выполнения каждого шага, как описано выше.

## <a name="1-create-or-choose-resource-group"></a>1. Создайте или выберите группу ресурсов.

Сначала создайте или выберите группу ресурсов, содержащую целевую рабочую область Log Analytics, которая будет принимать данные от Azure AD B2C. Имя группы ресурсов указывается при развертывании шаблона Azure Resource Manager.

1. Войдите на [портал Azure](https://portal.azure.com).
1. На панели инструментов портала щелкните значок **Каталог + подписка** , а затем выберите каталог, содержащий ваш **клиент Azure AD**.
1. [Создайте группу ресурсов](../azure-resource-manager/management/manage-resource-groups-portal.md#create-resource-groups) или выберите существующую. В этом примере используется группа ресурсов с именем *Azure-AD-B2C-Monitor*.

## <a name="2-create-a-log-analytics-workspace"></a>2. Создание рабочей области Log Analytics

**Log Analytics Рабочая область** — это уникальная среда для Azure Monitor данных журнала. Эта Рабочая область Log Analytics используется для получения данных из [журналов аудита](view-audit-logs.md)Azure AD B2C, а затем для их визуализации с помощью запросов и книг, а также для создания оповещений.

1. Войдите на [портал Azure](https://portal.azure.com).
1. На панели инструментов портала щелкните значок **Каталог + подписка** , а затем выберите каталог, содержащий ваш **клиент Azure AD**.
1. [Создайте рабочую область log Analytics](../azure-monitor/logs/quick-create-workspace.md). В этом примере используется рабочая область Log Analytics с именем *AzureAdB2C* в группе ресурсов с именем *Azure-AD-B2C-Monitor*.

## <a name="3-delegate-resource-management"></a>3. Делегирование управления ресурсами

На этом шаге вы выбираете Azure AD B2C клиента в качестве **поставщика услуг**. Вы также определяете разрешения, необходимые для назначения соответствующих встроенных ролей Azure группам в клиенте Azure AD.

### <a name="31-get-your-azure-ad-b2c-tenant-id"></a>3,1. Получение идентификатора клиента Azure AD B2C

Сначала получите **идентификатор клиента** Azure AD B2C каталога (также известного как идентификатор каталога).

1. Войдите на [портал Azure](https://portal.azure.com/).
1. Щелкните значок **Каталог + подписка** на панели инструментов портала, а затем выберите каталог, содержащий клиент **Azure AD B2C** .
1. Выберите **Azure Active Directory**, а затем — **Обзор**.
1. Запишите **идентификатор клиента**.

### <a name="32-select-a-security-group"></a>3,2 выберите группу безопасности

Теперь выберите группу Azure AD B2C или пользователя, которой необходимо предоставить разрешение для группы ресурсов, созданной ранее в каталоге, содержащем подписку.  

Чтобы упростить управление, мы рекомендуем использовать *группы* пользователей Azure AD для каждой роли, позволяя добавлять или удалять отдельных пользователей в группе, а не назначать разрешения непосредственно этому пользователю. В этом пошаговом руководстве мы добавим группу безопасности.

> [!IMPORTANT]
> Чтобы добавить разрешения для группы Azure AD, **Тип группы** должен быть установлен в значение **Безопасность**. Этот вариант автоматически выбирается при создании группы. Дополнительные сведения см. в статье [Создание простой группы и добавление в нее участников с помощью Azure Active Directory](../active-directory/fundamentals/active-directory-groups-create-azure-portal.md).

1. Выбрав **Azure Active Directory** все еще выбрано в каталоге **Azure AD B2C** , выберите **группы**, а затем выберите группу. Если у вас нет существующей группы, создайте группу **безопасности** , а затем добавьте члены. Для получения дополнительных сведений следуйте процедуре [Создание базовой группы и добавление членов с помощью Azure Active Directory](../active-directory/fundamentals/active-directory-groups-create-azure-portal.md). 
1. Выберите **Обзор** и запишите **идентификатор объекта** группы.

### <a name="33-create-an-azure-resource-manager-template"></a>3,3. Создание шаблона Azure Resource Manager

Далее вы создадите шаблон Azure Resource Manager, который предоставляет Azure AD B2C доступ к созданной ранее группе ресурсов Azure AD (например, *Azure-AD-B2C-Monitor*). Разверните шаблон из примера GitHub с помощью кнопки **развернуть в Azure** , которая открывает портал Azure и позволяет настроить и развернуть шаблон непосредственно на портале. Для выполнения этих действий убедитесь, что вы вошли в клиент Azure AD (а не на Azure AD B2C клиент).

1. Войдите на [портал Azure](https://portal.azure.com).
2. На панели инструментов портала щелкните значок **Каталог + подписка** , а затем выберите каталог, содержащий ваш клиент **Azure AD** .
3. Используйте кнопку **развертывание в Azure** , чтобы открыть портал Azure и развернуть шаблон непосредственно на портале. Дополнительные сведения см. в разделе [Создание шаблона Azure Resource Manager](../lighthouse/how-to/onboard-customer.md#create-an-azure-resource-manager-template).

   [![Развертывание в Azure](https://aka.ms/deploytoazurebutton)](   https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fazure-ad-b2c%2Fsiem%2Fmaster%2Ftemplates%2FrgDelegatedResourceManagement.json)

5. На странице **Настраиваемое развертывание** введите следующие сведения.

   | Поле   | Определение |
   |---------|------------|
   | Подписка |  Выберите каталог, содержащий подписку Azure, в которой была создана группа ресурсов *Azure-AD-B2C-Monitor* . |
   | Регион| Выберите регион, в котором будет развернут ресурс.  | 
   | Имя предложения MSP| Имя, описывающее это определение. Например, *Azure AD B2C мониторинг*.  |
   | Описание предложения MSP| Краткое описание предложения. Например, *включает Azure Monitor в Azure AD B2C*.|
   | Управляется по идентификатору клиента| **Идентификатор клиента** Azure AD B2C клиента (также известный как идентификатор каталога). |
   |Authorizations|Укажите массив JSON объектов, включающий Azure AD `principalId` , `principalIdDisplayName` и Azure `roleDefinitionId` . `principalId`— **Идентификатор объекта** группы B2C или пользователя, который будет иметь доступ к ресурсам в этой подписке Azure. В этом пошаговом руководстве укажите идентификатор объекта группы, записанный ранее. Для `roleDefinitionId` Используйте [встроенное значение роли](../role-based-access-control/built-in-roles.md) для *роли участника* `b24988ac-6180-42a0-ab88-20f7382dd24c` .|
   | Имя группы ресурсов | Имя группы ресурсов, созданной ранее в клиенте Azure AD. Например, *Azure-AD-B2C-Monitor*. |

   В следующем примере показан массив авторизаций с одной группой безопасности.

   ```json
   [
       {
           "principalId": "<Replace with group's OBJECT ID>",
           "principalIdDisplayName": "Azure AD B2C tenant administrators",
           "roleDefinitionId": "b24988ac-6180-42a0-ab88-20f7382dd24c"
       }
   ]
   ```

После развертывания шаблона для завершения проекции ресурсов может потребоваться несколько минут (обычно не более пяти). Вы можете проверить развертывание в клиенте Azure AD и получить сведения о проекции ресурсов. Дополнительные сведения см. в статье [Просмотр поставщиков услуг и управление ими](../lighthouse/how-to/view-manage-service-providers.md).

## <a name="4-select-your-subscription"></a>4. Выберите подписку.

После развертывания шаблона и ожидания завершения проекции ресурсов через несколько минут выполните следующие действия, чтобы связать подписку с каталогом Azure AD B2C.

1. Выйдите из портал Azure, если вы вошли в систему (это позволяет обновлять учетные данные сеанса на следующем шаге).
2. Войдите в [портал Azure](https://portal.azure.com) с помощью учетной записи администратора **Azure AD B2C** . Эта учетная запись должна быть членом группы безопасности, указанной на шаге [делегирования управления ресурсами](#3-delegate-resource-management) .
3. На панели инструментов портала выберите значок **Каталог + подписка**.
4. Выберите каталог Azure AD, который содержит подписку Azure и созданную группу ресурсов *Azure-AD-B2C-Monitor* .

    ![Переключить каталог](./media/azure-monitor/azure-monitor-portal-03-select-subscription.png)

1. Убедитесь, что выбран правильный каталог и подписка. В этом примере выбираются все каталоги и все подписки.

    ![Все каталоги, выбранные в & фильтра подписки на каталог](./media/azure-monitor/azure-monitor-portal-04-subscriptions-selected.png)

## <a name="5-configure-diagnostic-settings"></a>5. Настройка параметров диагностики

Параметры диагностики определяют, где должны отправляться журналы и метрики для ресурса. Возможные места назначения

- [Учетная запись хранения Azure](../azure-monitor/essentials/resource-logs.md#send-to-azure-storage)
- Решения [концентраторов событий](../azure-monitor/essentials/resource-logs.md#send-to-azure-event-hubs)
- [Рабочая область Log Analytics](../azure-monitor/essentials/resource-logs.md#send-to-log-analytics-workspace)

В этом примере мы используем рабочую область Log Analytics для создания панели мониторинга.

### <a name="51-create-diagnostic-settings"></a>5,1. Создание параметров диагностики

Вы можете [создавать параметры диагностики](../active-directory/reports-monitoring/overview-monitoring.md) в портал Azure.

Чтобы настроить параметры мониторинга для журналов действий Azure AD B2C:

1. Войдите в [портал Azure](https://portal.azure.com/) с помощью учетной записи администратора Azure AD B2C. Эта учетная запись должна быть членом группы безопасности, указанной на шаге [выберите группу безопасности](#32-select-a-security-group) .
1. Выберите значок **Каталог и подписка** в верхней панели инструментов портала, а затем выберите каталог, содержащий клиент Azure AD B2C.
1. Выберите **Azure Active Directory**
1. В разделе **Мониторинг** выберите **Параметры диагностики**.
1. Если для ресурса существуют параметры, вы увидите список уже настроенных параметров. Выберите **Добавить параметр диагностики** , чтобы добавить новый параметр, или нажмите кнопку **изменить** , чтобы изменить существующий параметр. Каждый параметр может иметь не более одного из целевых типов.

    ![Панель "параметры диагностики" в портал Azure](./media/azure-monitor/azure-monitor-portal-05-diagnostic-settings-pane-enabled.png)

1. Присвойте параметру имя, если его еще нет.
1. Установите флажок для каждого назначения, чтобы отправить журналы. Выберите **настроить** , чтобы указать их параметры **, как описано в следующей таблице**.
1. Выберите **отправить log Analytics**, а затем выберите имя созданной ранее **рабочей области** ( `AzureAdB2C` ).
1. Выберите **AuditLogs** и **сигнинлогс**.
1. Щелкните **Сохранить**.

> [!NOTE]
> После выпуска события для [отображения в log Analytics рабочей области](../azure-monitor/logs/data-ingestion-time.md)может пройти до 15 минут. Кроме того, Узнайте больше о [Active Directoryх задержки отчетов](../active-directory/reports-monitoring/reference-reports-latencies.md), которые могут повлиять на устаревшие данные и играют важную роль в отчетности.

Если отображается сообщение об ошибке "Установка параметров диагностики для использования Azure Monitor для каталога Azure AD B2C, необходимо настроить управление делегированными ресурсами". Убедитесь, что вы входите в систему с помощью пользователя, который является членом [группы безопасности](#32-select-a-security-group) , и [выберите свою подписку](#4-select-your-subscription).

## <a name="6-visualize-your-data"></a>6. Визуализация данных

Теперь можно настроить рабочую область Log Analytics для визуализации данных и настройки оповещений. Эти конфигурации можно установить как в клиенте Azure AD, так и в клиенте Azure AD B2C.

### <a name="61-create-a-query"></a>6,1. Создание запроса

Запросы по журналам позволяют с пользой применить все данные, собранные в журналах Azure Monitor. Мощный язык запросов позволяет объединять данные из нескольких таблиц, объединять большие наборы данных и выполнять сложные операции с минимальным кодом. Практически любой вопрос можно ответить и выполнить анализ до тех пор, пока собираются вспомогательные данные, и вы понимаете, как создать правильный запрос. Дополнительные сведения см. [в разделе Приступая к работе с запросами журналов в Azure Monitor](../azure-monitor/logs/get-started-queries.md).

1. В **log Analytics рабочей области** выберите **журналы** .
1. В редакторе запросов вставьте следующий запрос [языка запросов Kusto](/azure/data-explorer/kusto/query/) . Этот запрос показывает использование политики по операциям за последние x дней. Длительность по умолчанию — 90 дней (90d). Обратите внимание, что запрос связан только с операцией, в которой маркер или код выдается политикой.

    ```kusto
    AuditLogs
    | where TimeGenerated  > ago(90d)
    | where OperationName contains "issue"
    | extend  UserId=extractjson("$.[0].id",tostring(TargetResources))
    | extend Policy=extractjson("$.[1].value",tostring(AdditionalDetails))
    | summarize SignInCount = count() by Policy, OperationName
    | order by SignInCount desc  nulls last
    ```

1. Выберите **Запуск**. Результаты запроса отображаются в нижней части экрана.
1. Чтобы сохранить запрос для последующего использования, нажмите кнопку **сохранить**.

   ![Редактор журналов Log Analytics](./media/azure-monitor/query-policy-usage.png)

1. Введите следующие сведения:

    - **Имя** — введите имя запроса.
    - **Сохранить как** -выбрать `query` .
    - **Категория** — выберите `Log` .

1. Щелкните **Сохранить**.

Можно также изменить запрос для визуализации данных с помощью оператора [Render](/azure/data-explorer/kusto/query/renderoperator?pivots=azuremonitor) .

```kusto
AuditLogs
| where TimeGenerated  > ago(90d)
| where OperationName contains "issue"
| extend  UserId=extractjson("$.[0].id",tostring(TargetResources))
| extend Policy=extractjson("$.[1].value",tostring(AdditionalDetails))
| summarize SignInCount = count() by Policy
| order by SignInCount desc  nulls last
| render  piechart
```

![Круговая диаграмма Log Analyticsного редактора журналов](./media/azure-monitor/query-policy-usage-pie.png)

Дополнительные примеры см. в Azure AD B2C [репозитории GitHub SIEM](https://aka.ms/b2csiem).

### <a name="62-create-a-workbook"></a>6,2. Создание книги

Книги предоставляют гибкий холст для анализа данных и создания полнофункциональных визуальных отчетов на портале Azure. Они позволяют подключаться к нескольким источникам данных из Azure и объединять их через единый интерактивный интерфейс. Дополнительные сведения см. в статье [Azure Monitor книги](../azure-monitor/visualize/workbooks-overview.md).

Следуйте приведенным ниже инструкциям, чтобы создать новую книгу с помощью шаблона коллекции JSON. Эта книга предоставляет панель мониторинга **User Insights** и **authentication** для Azure AD B2C клиента.

1. В **log Analytics рабочей области** выберите **книги**.
1. На панели инструментов выберите **+ создать** , чтобы создать новую книгу.
1. На странице **Новая книга** выберите **Расширенный редактор** с помощью **</>** параметра на панели инструментов.

     ![Шаблон коллекции](./media/azure-monitor/wrkb-adv-editor.png)

1. Выберите **шаблон коллекции**.
1. Замените JSON в **шаблоне коллекции**  содержимым из [книги Azure AD B2C Basic](https://raw.githubusercontent.com/azure-ad-b2c/siem/master/workbooks/dashboard.json):
1. Примените шаблон с помощью кнопки **Применить** .
1. Нажмите кнопку **done Edit (готово к редактированию** ) на панели инструментов, чтобы завершить редактирование книги.
1. Наконец, сохраните книгу с помощью кнопки **сохранить** на панели инструментов.
1. Укажите **заголовок**, например *панель мониторинга Azure AD B2C*.
1. Щелкните **Сохранить**.

    ![Сохранение книги](./media/azure-monitor/wrkb-title.png)

В книге будут отображаться отчеты в виде панели мониторинга.

![Первая панель мониторинга книги](./media/azure-monitor/wkrb-dashboard-1.png)

![Вторая панель мониторинга книги](./media/azure-monitor/wrkb-dashboard-2.png)

![Третья панель мониторинга книги](./media/azure-monitor/wrkb-dashboard-3.png)


## <a name="create-alerts"></a>Создание оповещений

Оповещения создаются в Azure Monitor с помощью правил генерации оповещений и позволяют автоматически через регулярные интервалы выполнять сохраненные запросы или настраиваемые поиски по журналам. Можно создать оповещения, основанные на конкретных метках производительности, создании конкретных событий, отсутствии события или создании ряда событий за определенный период. Например, оповещения могут использоваться для уведомления о том, что среднее число входов в систему превышает определенное пороговое значение. Дополнительные сведения см. в статье [Создание оповещений для базы данных SQL Azure и хранилища данных с помощью портала Azure](../azure-monitor/alerts/tutorial-response.md).


Используйте приведенные ниже инструкции, чтобы создать новое оповещение Azure, которое будет отправлять [уведомление по электронной почте](../azure-monitor/alerts/action-groups.md#configure-notifications) каждый раз, когда в **общем количестве запросов** сравнивается с предыдущим периодом. Оповещение будет выполняться каждые 5 минут и искать удаление в течение последних 24 часов. Оповещения создаются с помощью языка запросов Kusto.


1. В **log Analytics рабочей области** выберите **журналы**. 
1. Создайте новый **запрос Kusto** с помощью приведенного ниже запроса.

    ```kusto
    let start = ago(24h);
    let end = now();
    let threshold = -25; //25% decrease in total requests.
    AuditLogs
    | serialize TimeGenerated, CorrelationId, Result
    | make-series TotalRequests=dcount(CorrelationId) on TimeGenerated in range(start, end, 1h)
    | mvexpand TimeGenerated, TotalRequests
    | where TotalRequests > 0
    | serialize TotalRequests, TimeGenerated, TimeGeneratedFormatted=format_datetime(todatetime(TimeGenerated), 'yyyy-M-dd [hh:mm:ss tt]')
    | project   TimeGeneratedFormatted, TotalRequests, PercentageChange= ((toreal(TotalRequests) - toreal(prev(TotalRequests,1)))/toreal(prev(TotalRequests,1)))*100
    | order by TimeGeneratedFormatted
    | where PercentageChange <= threshold   //Trigger's alert rule if matched.
    ```

1. Выберите **выполнить**, чтобы проверить запрос. Результаты должны отобразиться, если в общем количестве запросов за последние 24 часа имеется меньше 25% или более.
1. Чтобы создать правило генерации оповещений на основе приведенного выше запроса, используйте параметр **+ новое правило генерации оповещений** , доступный на панели инструментов.
1. На странице **Создание правила оповещения** выберите **имя условия** . 
1. На странице **Настройка логики сигнала** задайте следующие значения, а затем нажмите кнопку **Готово** , чтобы сохранить изменения.
    * Логика оповещения: задайте **число результатов** **больше** **0**.
    * Оценка на основе: SELECT **1440** за период (в минутах) и **5** для частоты (в минутах) 

    ![Создание условия для правила оповещения](./media/azure-monitor/alert-create-rule-condition.png)

После создания оповещения перейдите в **log Analytics рабочую область** и выберите **оповещения**. На этой странице отображаются все оповещения, которые были активированы в параметре длительность, заданная в **диапазоне времени** .  

### <a name="configure-action-groups"></a>Настройка групп действий

Оповещения служб Azure Monitor и "Работоспособность служб" используют группы действий для уведомления пользователей о том, что оповещение активировано. Можно включить отправку голоса, SMS, электронной почты; или запуска различных типов автоматических действий. Следуйте указаниям по [созданию групп действий и управлению ими в портал Azure](../azure-monitor/alerts/action-groups.md)

Ниже приведен пример сообщения электронной почты с уведомлением. 

   ![Уведомление по электронной почте](./media/azure-monitor/alert-email-notification.png)

## <a name="multiple-tenants"></a>Несколько клиентов

Чтобы подключить несколько Azure AD B2C журналов клиентов к одной и той же Log Analytics рабочей области (или к учетной записи хранения Azure или концентратору событий), вам потребуется отдельное развертывание с различными значениями **имени, предлагаемого MSP** . Убедитесь, что Рабочая область Log Analytics находится в той же группе ресурсов, что и та, что была настроена в области [Создание или выбор группы ресурсов](#1-create-or-choose-resource-group).

При работе с несколькими рабочими областями Log Analytics используйте [запрос между рабочими областями](../azure-monitor/logs/cross-workspace-query.md) , чтобы создавать запросы, работающие в нескольких рабочих областях. Например, следующий запрос выполняет соединение двух журналов аудита из разных клиентов на основе одной категории (например, проверка подлинности):

```kusto
workspace("AD-B2C-TENANT1").AuditLogs
| join  workspace("AD-B2C-TENANT2").AuditLogs
  on $left.Category== $right.Category
```

## <a name="change-the-data-retention-period"></a>Изменение срока хранения данных

Журналы Azure Monitor предназначены для масштабирования и поддержки сбора, индексирования и хранения больших объемов данных в день из любого источника в вашей организации или развертывания в Azure. По умолчанию журналы хранятся в течение 30 дней, но длительность хранения может быть увеличена до двух лет. Узнайте, как [управлять использованием и затратами с помощью журналов Azure Monitor](../azure-monitor/logs/manage-cost-storage.md). После выбора ценовой категории можно [изменить срок хранения данных](../azure-monitor/logs/manage-cost-storage.md#change-the-data-retention-period).

## <a name="next-steps"></a>Дальнейшие действия

* Дополнительные примеры находятся в коллекции Azure AD B2C [SIEM](https://aka.ms/b2csiem). 

* Дополнительные сведения о добавлении и настройке параметров диагностики в Azure Monitor см. в разделе [учебник. сбор и анализ журналов ресурсов из ресурса Azure](../azure-monitor/essentials/monitor-azure-resource.md).

* Сведения о потоковой передаче журналов Azure AD в концентратор событий см. в статье [учебник. потоковая Azure Active Directory журналов в концентратор событий Azure](../active-directory/reports-monitoring/tutorial-azure-monitor-stream-logs-to-event-hub.md).
