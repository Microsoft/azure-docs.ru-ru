---
title: Настройка потока сброса пароля в Azure AD B2C
titleSuffix: Azure AD B2C
description: Узнайте, как настроить поток сброса пароля в Azure Active Directory B2C.
services: active-directory-b2c
author: msmimart
manager: celestedg
ms.service: active-directory
ms.workload: identity
ms.topic: how-to
ms.date: 03/08/2021
ms.author: mimart
ms.subservice: B2C
zone_pivot_groups: b2c-policy-type
ms.openlocfilehash: fa34e8ea71c307b75a3f345861f8ed99d131b3fd
ms.sourcegitcommit: f6193c2c6ce3b4db379c3f474fdbb40c6585553b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/08/2021
ms.locfileid: "102447934"
---
# <a name="set-up-a-password-reset-flow-in-azure-active-directory-b2c"></a>Настройка потока сброса пароля в Azure Active Directory B2C

[!INCLUDE [active-directory-b2c-choose-user-flow-or-custom-policy](../../includes/active-directory-b2c-choose-user-flow-or-custom-policy.md)]

## <a name="password-reset-flow"></a>Поток сброса пароля

Функция [регистрации и входа](add-sign-up-and-sign-in-policy.md) позволяет пользователям сбрасывать свой пароль, используя ссылку **забыли пароль?** . Поток сброса пароля включает следующие шаги.

1. На странице регистрации и входа пользователь щелкает ссылку **забыли пароль?** . Azure AD B2C инициирует поток сброса пароля. 
2. Пользователь предоставляет и проверяет свой адрес электронной почты с помощью секретного кода времени одного раза.
3. Затем пользователь может ввести новый пароль.

![Поток сброса пароля](./media/add-password-reset-policy/password-reset-flow.png)

Поток сброса пароля применяется к локальным учетным записям в Azure AD B2C, которые используют [адрес электронной почты](identity-provider-local.md#email-sign-in) или [имя пользователя](identity-provider-local.md#username-sign-in) с паролем для входа.

Распространенная практика после миграции пользователей на Azure AD B2C с случайными паролями заключается в том, чтобы пользователи проверяли свои адреса электронной почты и сбрасывать пароли при первом входе в систему. Также распространена возможность принудительного сброса пароля пользователем после смены пароля администратором. чтобы включить эту функцию, см. раздел [принудительный сброс пароля](force-password-reset.md) .

## <a name="prerequisites"></a>Предварительные требования

[!INCLUDE [active-directory-b2c-customization-prerequisites](../../includes/active-directory-b2c-customization-prerequisites.md)]

## <a name="self-service-password-reset-recommended"></a>Самостоятельный сброс пароля (рекомендуется)

Новый интерфейс сброса пароля теперь является частью политики регистрации или входа. Когда пользователь выбирает " **забыли пароль?** ", он немедленно отправляется в процедуру забытого пароля. Приложению больше не требуется выполнять обработку [кода ошибки AADB2C90118](#password-reset-policy-legacy), и для сброса пароля не требуется отдельная политика.

::: zone pivot="b2c-user-flow"

Процедуру самостоятельного сброса пароля можно настроить для **входа (рекомендуется)** или для входа **и входа (рекомендуется)** для пользователей. Если у вас нет такого потока пользователей, создайте [Вход и зарегистрируйтесь в](add-sign-up-and-sign-in-policy.md) пользовательском потоке. 

Чтобы включить самостоятельный сброс пароля для потока пользователей регистрации или входа, выполните следующие действия.

1. Войдите на [портал Azure](https://portal.azure.com).
1. Выберите значок **Каталог и подписка** в верхней панели инструментов портала, а затем выберите каталог, содержащий клиент Azure AD B2C.
1. На портале Azure найдите и выберите **Azure AD B2C**.
1. Выберите **Потоки пользователей**.
1. Выберите пользовательский поток регистрации или входа ( **рекомендуемый** тип), который требуется настроить.
1. В разделе **Параметры** в меню слева выберите **свойства**.
1. В разделе **сложность пароля** выберите **самостоятельный сброс пароля**.
1. Щелкните **Сохранить**.
1. В разделе **Настройка** в меню слева выберите **макеты страниц**.
1. В поле **версия макета страницы** выберите **2.1.2-CURRENT** или выше.
1. Щелкните **Сохранить**.

::: zone-end

::: zone pivot="b2c-custom-policy"

В следующих разделах описано, как добавить пользовательский интерфейс самостоятельного ввода пароля в настраиваемую политику. Пример основан на файлах политики, включенных в [начальный пакет пользовательской политики](./custom-policy-get-started.md). 

> [!TIP]
> Полный пример политики регистрации или входа с сбросом пароля можно найти на сайте [GitHub](https://github.com/azure-ad-b2c/samples/tree/master/policies/embedded-password-reset).

### <a name="indicate-a-user-selected-the-forgot-your-password-link"></a>Укажите пользователя, который выбрал забытый пароль? ссылку

Чтобы указать политике, что пользователь выбрал ссылку " **забыли пароль?** ", определите логическое утверждение. Это утверждение будет использоваться для направления пути взаимодействия пользователя в технический профиль забытого пароля. Это утверждение также может быть выдано маркеру, чтобы приложение было осведомлено о том, что пользователь вошел с помощью команды забыли пароль.

Утверждения объявляются в [схеме утверждений](claimsschema.md). Откройте файл расширения для политики, например <em>`SocialAndLocalAccounts/`**`TrustFrameworkExtensions.xml`**</em>.

1. Найдите элемент [BuildingBlocks](buildingblocks.md). Если такой элемент не существует, добавьте его.
1. Найдите элемент [ClaimsSchema](claimsschema.md). Если такой элемент не существует, добавьте его.
1. Добавьте следующее утверждение в элемент **ClaimsSchema** . 

```XML
<!-- 
<BuildingBlocks>
  <ClaimsSchema> -->
    <ClaimType Id="isForgotPassword">
      <DisplayName>isForgotPassword</DisplayName>
      <DataType>boolean</DataType>
      <AdminHelpText>Whether the user has selected Forgot your Password</AdminHelpText>
    </ClaimType>
  <!--
  </ClaimsSchema>
</BuildingBlocks> -->
```

### <a name="upgrade-the-page-layout-version"></a>Обновление версии макета страницы

[Версия](contentdefinitions.md#migrating-to-page-layout) `2.1.2` макета страницы требуется для включения процесса самостоятельного сброса пароля в процессе регистрации или входа.

1. Найдите элемент [BuildingBlocks](buildingblocks.md). Если такой элемент не существует, добавьте его.
1. Нахождение элемента [ContentDefinitions](contentdefinitions.md) . Если такой элемент не существует, добавьте его.
1. Измените элемент **DataURI** в элементе **Контентдефинитион** с помощью ID **API. signuporsignin** , как показано ниже.

```xml
<!-- 
<BuildingBlocks>
  <ContentDefinitions> -->
    <ContentDefinition Id="api.signuporsignin">
      <DataUri>urn:com:microsoft:aad:b2c:elements:contract:unifiedssp:2.1.2</DataUri>
    </ContentDefinition>
  <!-- 
  </ContentDefinitions>
</BuildingBlocks> -->
```

Чтобы инициировать `isForgotPassword` утверждение, используется технический профиль преобразования утверждений. Этот технический профиль будет указан позже. При вызове будет задано значение `isForgotPassword` для утверждения `true` . Найдите элемент `ClaimsProviders` . Если такой элемент не существует, добавьте его. Затем добавьте следующий поставщик утверждений:  

```xml
<!-- 
<ClaimsProviders> -->
  <ClaimsProvider>
    <DisplayName>Local Account</DisplayName>
    <TechnicalProfiles>
      <TechnicalProfile Id="ForgotPassword">
        <DisplayName>Forgot your password?</DisplayName>
        <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.ClaimsTransformationProtocolProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null"/>
        <OutputClaims>
          <OutputClaim ClaimTypeReferenceId="isForgotPassword" DefaultValue="true" AlwaysUseDefaultValue="true"/>
        </OutputClaims>
      </TechnicalProfile>
      <TechnicalProfile Id="SelfAsserted-LocalAccountSignin-Email">
        <Metadata>
          <Item Key="setting.forgotPasswordLinkOverride">ForgotPasswordExchange</Item>
        </Metadata>
      </TechnicalProfile>
    </TechnicalProfiles>
  </ClaimsProvider>
<!-- 
</ClaimsProviders> -->
```

`SelfAsserted-LocalAccountSignin-Email`Технический профиль `setting.forgotPasswordLinkOverride` позволяет выполнять обмен утверждениями сброса пароля в пути взаимодействия пользователя. 

### <a name="add-the-password-reset-sub-journey"></a>Добавление подузла сброса пароля

Ваш путешествие теперь будет включать в себя возможность входа, регистрации и сброса пароля пользователем. Для лучшего упорядочения [пути взаимодействия пользователя можно использовать](subjourneys.md) подложку для обработки потока сброса пароля.

Вспомогательное путешествие будет вызвано из пути взаимодействия пользователя и будет выполнять определенные действия для предоставления пользователю возможности сброса пароля. Используйте `Call` подпрограмму типа, чтобы после завершения подветви элемент управления возвращался на этап оркестрации, инициирующий подпрограмму.

Найдите элемент `SubJourneys` . Если элемент не существует, добавьте его после `User Journeys` элемента. Затем добавьте следующий подкаталог:

```xml
<!--
<SubJourneys>-->
  <SubJourney Id="PasswordReset" Type="Call">
    <OrchestrationSteps>
      <!-- Validate user's email address. -->
      <OrchestrationStep Order="1" Type="ClaimsExchange">
        <ClaimsExchanges>
          <ClaimsExchange Id="PasswordResetUsingEmailAddressExchange" TechnicalProfileReferenceId="LocalAccountDiscoveryUsingEmailAddress" />
        </ClaimsExchanges>
      </OrchestrationStep>

      <!-- Collect and persist a new password. -->
      <OrchestrationStep Order="2" Type="ClaimsExchange">
        <ClaimsExchanges>
          <ClaimsExchange Id="NewCredentials" TechnicalProfileReferenceId="LocalAccountWritePasswordUsingObjectId" />
        </ClaimsExchanges>
      </OrchestrationStep>
    </OrchestrationSteps>
  </SubJourney>
<!--
</SubJourneys>-->
```

### <a name="prepare-your-user-journey"></a>Подготовка пути взаимодействия пользователя

Вам потребуется подключиться к **забытому паролю?** перейдите к подпути забытого пароля. Для этого сослаться на идентификатор вложенного пути "Забыли пароль" в элементе **клаимспровидерселектион** шага **комбинедсигнинандсигнуп** .

Если у вас нет настраиваемого пути взаимодействия пользователя с **комбинедсигнинандсигнуп** шагом, используйте следующую процедуру для дублирования существующего пути взаимодействия пользователя для регистрации или входа. В противном случае перейдите к следующему разделу.

1. Откройте файл *TrustFrameworkBase.xml* из начального пакета.
2. Найдите и скопируйте все содержимое элемента **UserJourney**, в котором присутствует запись `Id="SignUpOrSignIn"`.
3. Откройте файл *TrustFrameworkExtensions.xml* и найдите элемент **UserJourneys**. Если элемент не существует, добавьте его.
4. Создайте дочерний элемент элемента **усержаурнэйс** , вставляя все содержимое элемента **UserJourney** , скопированного на шаге 2.
5. Переименуйте идентификатор пути взаимодействия пользователя. Например, `Id="CustomSignUpSignIn"`.

### <a name="connect-the-forgot-password-link-to-the-forgot-password-sub-journey"></a>Подключите ссылку "Забыли пароль" к подпути забытого пароля 

В пути взаимодействия пользователя вы можете представить подкаталог «забыл пароль» как **клаимспровидерселектион**. Добавление этого элемента подключает **пароль для забытого** подключения. обратитесь к вложенному пути "Забыли пароль".

1. В пути взаимодействия пользователя найдите элемент Step оркестрации, включающий `Type="CombinedSignInAndSignUp"` или `Type="ClaimsProviderSelection"` . Обычно это первый этап оркестрации. Элемент **клаимспровидерселектионс** содержит список поставщиков удостоверений, которые пользователь может использовать для входа. Добавьте в него следующую строку.
    
    ```xml
    <ClaimsProviderSelection TargetClaimsExchangeId="ForgotPasswordExchange" />
    ```

1. На следующем шаге оркестрации добавьте элемент **ClaimsExchange** . Добавьте в него следующую строку.

    ```xml
    <ClaimsExchange Id="ForgotPasswordExchange" TechnicalProfileReferenceId="ForgotPassword" />
    ```
    
1. Добавьте следующий шаг оркестрации между текущим шагом и следующим шагом. Новый добавляемый шаг оркестрации проверяет, `isForgotPassword` существует ли утверждение. Если утверждение существует, вызывается [подпапка сброса пароля](#add-the-password-reset-sub-journey). 

    ```xml
    <OrchestrationStep Order="3" Type="InvokeSubJourney">
      <Preconditions>
        <Precondition Type="ClaimsExist" ExecuteActionsIf="false">
          <Value>isForgotPassword</Value>
          <Action>SkipThisOrchestrationStep</Action>
        </Precondition>
      </Preconditions>
      <JourneyList>
        <Candidate SubJourneyReferenceId="PasswordReset" />
      </JourneyList>
    </OrchestrationStep>
    ```
    
1. После добавления нового шага оркестрации перенумеровать шаги последовательно без пропуска целых чисел от 1 до N.

### <a name="set-the-user-journey-to-be-executed"></a>Настройка пути взаимодействия пользователя

После изменения или создания пути взаимодействия пользователя в разделе **проверяющей стороны** укажите путь, который Azure AD B2C будет выполняться для этой пользовательской политики. В элементе [релингпарти](relyingparty.md) найдите элемент **дефаултусержаурнэй** . Обновите  **ReferenceId дефаултусержаурнэй** в соответствии с идентификатором пути взаимодействия пользователя, в который вы добавили **клаимспровидерселектионс**.

```xml
<RelyingParty>
  <DefaultUserJourney ReferenceId="CustomSignUpSignIn" />
  ...
</RelyingParty>
```

### <a name="indicate-the-forgot-password-flow-to-your-app"></a>Указание потока забытых паролей в приложении

Приложению может потребоваться определить, вошел ли пользователь в поток пользователя забыл пароль. Утверждение **исфорготпассворд** содержит логическое значение, указывающее на это, которое может быть выдано в токене, отправляемом в приложение. При необходимости добавьте `isForgotPassword` к выходным утверждениям в разделе **проверяющей стороны** . Приложение может проверить утверждение, `isForgotPassword` чтобы определить, сбрасывает ли пользователь пароль.

```xml
<RelyingParty>
  <OutputClaims>
    ...
    <OutputClaim ClaimTypeReferenceId="isForgotPassword" DefaultValue="false" />
  </OutputClaims>
</RelyingParty>
```


### <a name="upload-the-custom-policy"></a>Передача настраиваемой политики

1. Войдите на [портал Azure](https://portal.azure.com).
1. Выберите значок **Каталог и подписка** в верхней панели инструментов портала, а затем выберите каталог, содержащий клиент Azure AD B2C.
1. На портале Azure найдите и выберите **Azure AD B2C**.
1. В разделе **Политики** выберите **Identity Experience Framework**.
1. Выберите **Отправить пользовательскую политику**, а затем отправьте два измененных файла политики в следующем порядке:
   1. Например, политика расширения `TrustFrameworkExtensions.xml` .
   2. Например, политика проверяющей стороны `SignUpSignIn.xml` .

::: zone-end

### <a name="test-the-password-reset-flow"></a>Проверка потока сброса пароля

1. Выберите пользовательский поток регистрации или входа (рекомендуемый тип), который необходимо протестировать.
1. Выберите **Выполнить поток пользователя**.
1. В разделе **Приложение** выберите зарегистрированное ранее веб-приложение с именем *webapp1*. В поле **URL-адрес ответа** должно содержаться значение `https://jwt.ms`.
1. Выберите **Выполнить поток пользователя**.
1. На странице регистрации или входа выберите " **забыли пароль?**".
1. Проверьте адрес электронной почты созданной ранее учетной записи и нажмите кнопку **продолжить**.
1. Теперь вы как пользователь сможете изменять пароль. Измените пароль и щелкните **Продолжить**. Токен должен вернуться по адресу `https://jwt.ms` и отобразиться пользователю.
1. Проверьте значение утверждения для токена возврата `isForgotPassword` . Если параметр существует и имеет значение true, это означает, что пользователь сбрасывает пароль.

## <a name="password-reset-policy-legacy"></a>Политика сброса пароля (устаревшая)

Если [самостоятельный сброс пароля](#self-service-password-reset-recommended) не включен, при нажатии этой ссылки автоматически не запускается поток пользователя для сброса пароля. Вместо этого в приложение возвращается код ошибки `AADB2C90118`. Приложению необходимо выполнить обработку этого кода ошибки путем повторной инициализации библиотеки проверки подлинности для проверки подлинности Azure AD B2C пользователя сброса пароля.

На следующей схеме:

1. В приложении пользователь нажимает кнопку Вход. Приложение инициирует запрос авторизации и переводит пользователя в Azure AD B2C завершить вход. В запросе авторизации указывается имя политики регистрации или входа, например **B2C_1_signup_signin**.
1. Пользователь выбирает ссылку **забыли пароль?** . Azure AD B2C возвращает код ошибки AADB2C90118 для приложения.
1. Приложение обрабатывает код ошибки и инициирует новый запрос авторизации. В запросе авторизации указывается имя политики сброса пароля, например **B2C_1_pwd_reset**.

![Поток пользователя для сброса устаревшего пароля](./media/add-password-reset-policy/password-reset-flow-legacy.png)

Чтобы увидеть пример, рассмотрим [простой пример ASP.NET](https://github.com/AzureADQuickStarts/B2C-WebApp-OpenIDConnect-DotNet-SUSI), демонстрирующий Связывание пользовательских потоков.

::: zone pivot="b2c-user-flow"

### <a name="create-a-password-reset-user-flow"></a>Создание потока пользователя сброса пароля

Чтобы пользователи приложения могли сбрасывать свой пароль, вы создаете пользовательский поток сброса пароля.

1. В меню страницы обзора для арендатора Azure AD B2C выберите **Потоки пользователей** и щелкните **Создать поток пользователя**.
1. На странице **Создание потока пользователя** выберите поток пользователя **Сброс пароля**. 
1. В разделе **Выбор версии**, выберите элемент **Рекомендуемая** и нажмите кнопку **Создать**.
1. Введите **имя** потока пользователя. Например, *passwordreset1*.
1. В разделе **Поставщики удостоверений** включите **Reset password using email address** (Сброс пароля с использованием адреса электронной почты).
1. В разделе **утверждения приложения** выберите пункт **показывать больше** и выберите утверждения, которые должны возвращаться в маркерах авторизации, отправляемых в приложение. Например, выберите **ИД объекта пользователя**.
1. Щелкните **ОК**.
1. Для добавления потока пользователя выберите команду **Создать**. Префикс *B2C_1* автоматически добавляется к имени.

### <a name="test-the-user-flow"></a>Тестирование потока пользователя

1. Выберите созданный поток пользователя, чтобы открыть его страницу обзора, а затем выберите пункт **запустить поток пользователя**.
1. В разделе **Приложение** выберите зарегистрированное ранее веб-приложение с именем *webapp1*. В поле **URL-адрес ответа** должно содержаться значение `https://jwt.ms`.
1. Щелкните **выполнить поток пользователя**, проверьте адрес электронной почты созданной ранее учетной записи и нажмите кнопку **продолжить**.
1. Теперь можно изменить пароль для пользователя. Измените пароль и щелкните **Продолжить**. Токен должен вернуться по адресу `https://jwt.ms` и отобразиться пользователю.

::: zone-end

::: zone pivot="b2c-custom-policy"

### <a name="create-a-password-reset-policy"></a>Создание политики сброса паролей

Пользовательские политики — это набор XML-файлов, отправляемых в клиент Azure AD B2C для определения путей взаимодействия пользователя. Мы предоставляем начальные пакеты с несколькими предварительно созданными политиками, в том числе: регистрация и вход, сброс пароля и политика редактирования профиля. Дополнительные сведения см. [в разделе Приступая к работе с пользовательскими политиками в Azure AD B2C](custom-policy-get-started.md).

::: zone-end

## <a name="next-steps"></a>Дальнейшие действия

Настройка [принудительного сброса пароля](force-password-reset.md).
