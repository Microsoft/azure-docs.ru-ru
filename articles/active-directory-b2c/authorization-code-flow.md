---
title: Поток кода авторизации — Azure Active Directory B2C | Документация Майкрософт
description: Узнайте, как создавать веб-приложения с использованием протокола аутентификации Azure AD B2C и OpenID Connect.
services: active-directory-b2c
author: msmimart
manager: celestedg
ms.service: active-directory
ms.workload: identity
ms.topic: conceptual
ms.date: 03/10/2021
ms.author: mimart
ms.subservice: B2C
ms.custom: fasttrack-edit
ms.openlocfilehash: a6a993fdf4fd266afb9459fedd13412d8796e0a5
ms.sourcegitcommit: e6de1702d3958a3bea275645eb46e4f2e0f011af
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "102611510"
---
# <a name="oauth-20-authorization-code-flow-in-azure-active-directory-b2c"></a>Поток кода авторизации OAuth 2.0 в Azure Active Directory B2C

Код авторизации OAuth 2.0 может использоваться в приложениях, установленных на устройстве, для получения доступа к защищенным ресурсам, таким как веб-API. Используя реализацию Azure Active Directory B2C (Azure AD B2C) OAuth 2,0, вы можете добавлять функции регистрации, входа и другие задачи управления удостоверениями в приложения с одной страницей, мобильными и настольными приложениями. Эта статья не зависит от языка. В ней описывается, как отправлять и получать сообщения HTTP, не используя ни одну из библиотек с открытым исходным кодом. По возможности рекомендуется использовать поддерживаемые библиотеки проверки подлинности Майкрософт (MSAL). Ознакомьтесь с [примерами приложений, которые используют MSAL](code-samples.md).

Описание потока кода авторизации OAuth 2.0 см. в [разделе 4.1 спецификации OAuth 2.0](https://tools.ietf.org/html/rfc6749). Его можно использовать для проверки подлинности и авторизации в большинстве [типов приложений](application-types.md), включая веб-приложения, одностраничные приложения и приложения, установленные в собственном режиме. Вы можете использовать поток кода авторизации OAuth 2.0, чтобы безопасно получать маркеры доступа и маркеры обновления для приложений, с помощью которых можно получить доступ к ресурсам, защищенным [сервером авторизации](protocols-overview.md).  Маркер обновления позволяет клиенту получать новые маркеры доступа (и обновления) после истечения их срока действия (как правило, через час).

В этой статье мы сосредоточимся на потоке кода авторизации OAuth 2.0 для **открытых клиентов**. Открытый клиент — это любое клиентское приложение, которому нельзя доверять в безопасном сохранении целостности секретного пароля. Сюда входят одностраничные приложения, мобильные приложения, классические приложения и, по сути, любое приложение, которое не выполняется на сервере.

> [!NOTE]
> Чтобы добавить управление идентификацией в веб-приложение с помощью Azure AD B2C, используйте [OpenID Connect](openid-connect.md), а не OAuth 2.0.

В Azure AD B2C стандартные потоки OAuth 2.0 выходят за рамки простой проверки подлинности и авторизации. Он представляет собой [поток пользователя](user-flow-overview.md). Потоки пользователей дают возможность использовать OAuth 2.0 для добавления в приложение различных действий пользователя, таких как регистрация, вход и управление профилями. Поставщики удостоверений, которые используют протокол OAuth 2.0: [Amazon](identity-provider-amazon.md), [Azure Active Directory](identity-provider-azure-ad-single-tenant.md), [Facebook](identity-provider-facebook.md), [GitHub](identity-provider-github.md), [Google](identity-provider-google.md) и [LinkedIn](identity-provider-linkedin.md).

Чтобы проверить HTTP-запросы, описанные в этой статье:

1. Замените `{tenant}` именем вашего клиента Azure AD B2C.
1. Замените `90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6` идентификатором приложения, зарегистрированного ранее в клиенте Azure AD B2C.
1. Замените на `{policy}` имя политики, созданной в клиенте, например `b2c_1_sign_in` .

## <a name="redirect-uri-setup-required-for-single-page-apps"></a>Для одностраничных приложений требуется настройка URI перенаправления

Поток кода авторизации для одностраничных приложений требует некоторой дополнительной настройки.  Следуйте инструкциям по [созданию одностраничного приложения](tutorial-register-spa.md) , чтобы правильно ПОметить URI перенаправления как включенный для CORS. Чтобы обновить существующий URI перенаправления для включения CORS, можно щелкнуть запрос миграции в разделе "веб" на вкладке " **Проверка подлинности** **регистрации приложения**". Кроме того, можно открыть **редактор манифеста регистрация приложений** и задать `type` поле для URI перенаправления `spa` в `replyUrlsWithType` разделе.

`spa`Тип перенаправления обратно совместим с неявным потоком. Приложения, в настоящее время использующие неявный поток для получения токенов, могут переноситься в `spa` тип URI перенаправления без проблем и продолжать использовать неявный поток.

## <a name="1-get-an-authorization-code"></a>1. получение кода авторизации
Поток кода авторизации начинается с того, что клиент направляет пользователя к конечной точке `/authorize` . Это интерактивная часть потока, в которой пользователь выполняет действие. В этом запросе клиент указывает в параметре `scope` разрешения, которые ему требуется получить от пользователя. Ниже приведены три примера (переносы строк добавлены для удобства чтения), в которых используются разные потоки пользователя.


```http
GET https://{tenant}.b2clogin.com/{tenant}.onmicrosoft.com/{policy}/oauth2/v2.0/authorize?
client_id=90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6
&response_type=code
&redirect_uri=urn%3Aietf%3Awg%3Aoauth%3A2.0%3Aoob
&response_mode=query
&scope=90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6%20offline_access
&state=arbitrary_data_you_can_receive_in_the_response
&code_challenge=YTFjNjI1OWYzMzA3MTI4ZDY2Njg5M2RkNmVjNDE5YmEyZGRhOGYyM2IzNjdmZWFhMTQ1ODg3NDcxY2Nl
&code_challenge_method=S256
```

| Параметр | Необходим? | Описание |
| --- | --- | --- |
|клиентом| Обязательно | Имя клиента Azure AD B2C|
| политик | Обязательно | Выполняемый пользователем поток. Укажите имя потока пользователей, созданного в Azure AD B2C клиенте. Например, `b2c_1_sign_in`, `b2c_1_sign_up`или `b2c_1_edit_profile`. |
| client_id |Обязательно |Идентификатор приложения, назначенный вашему приложению на [портале Azure](https://portal.azure.com). |
| response_type |Обязательно |Тип ответа, который должен содержать `code` для потока кода авторизации. |
| redirect_uri |Обязательно |URI перенаправления приложения, на который можно отправлять ответы проверки подлинности для их получения приложением. Он должен в точности соответствовать одному из URI перенаправления, зарегистрированных на портале, но иметь форму закодированного URL-адреса. |
| область |Обязательно |Список областей с разделителями-пробелами. При указании одной области в Azure Active Directory (Azure AD) также обозначаются запрашиваемые разрешения. Использование идентификатора клиента в качестве области указывает на то, что приложению нужен маркер доступа, который может использоваться в вашей службе или веб-API, представленных таким же идентификатором клиента.  Область `offline_access` означает, что вашему приложению потребуется маркер обновления для продолжительного доступа к ресурсам. Вы также можете использовать область `openid` для запроса идентификатора маркера из Azure AD B2C. |
| response_mode |Рекомендуемая |Метод, используемый для отправки полученного кода авторизации приложению. Он может иметь значение `query`, `form_post` или `fragment`. |
| Состояние |Рекомендуемая |Значение, включенное в запрос, может содержать строку или любое содержимое на ваше усмотрение. Как правило, с целью предотвращения подделки межсайтовых запросов используется генерируемое случайным образом уникальное значение. Этот параметр также включает информацию о состоянии пользователя в приложении перед созданием запроса на проверку подлинности. Например, об открытой пользователем в тот момент странице или выполняемом потоке пользователя. |
| prompt |Необязательно |Требуемый тип взаимодействия с пользователем. Сейчас единственное допустимое значение — это `login`, при котором пользователю приходится вводить учетные данные по запросу. Единый вход не сработает. |
| code_challenge  | рекомендованный/обязательный | Используется, чтобы защитить разрешения кода авторизации с помощью ключа проверки для обмена кодом (PKCE). Является обязательным, если указан параметр `code_challenge_method`. Дополнительные сведения см. в описании [PKCE RFC](https://tools.ietf.org/html/rfc7636). Теперь это рекомендуется для всех типов приложений — собственных приложений, одностраничных приложений и конфиденциальных клиентов, таких как веб-приложения. | 
| `code_challenge_method` | рекомендованный/обязательный | Метод, используемый для кодирования `code_verifier` в параметре `code_challenge`. Это *должно* быть `S256` , но спецификация позволяет использовать, `plain` Если по какой бы причине клиент не поддерживает SHA256. <br/><br/>Если этот параметр не указан, для `code_challenge` принимается формат открытого текста, если задано значение `code_challenge`. Платформа удостоверений Майкрософт поддерживает как `plain`, так и `S256`. Дополнительные сведения см. в описании [PKCE RFC](https://tools.ietf.org/html/rfc7636). Это необходимо для [одностраничных приложений, использующих поток кода авторизации](tutorial-register-spa.md).|
| login_hint | Нет| Можно использовать для предварительной заливки поля имя входа на странице входа. Дополнительные сведения см. [в разделе предварительное заполнение имени для входа](direct-signin.md#prepopulate-the-sign-in-name).  |
| domain_hint | Нет| Предоставляет подсказку для Azure AD B2C о поставщике удостоверений в социальных сетях, который должен использоваться для входа в систему. Если включено допустимое значение, пользователь переходит непосредственно на страницу входа поставщика удостоверений.  Дополнительные сведения см. в статье [Перенаправление входа в поставщик социальных сетей](direct-signin.md#redirect-sign-in-to-a-social-provider). |
| Настраиваемые параметры | Нет| Пользовательские параметры, которые можно использовать с [пользовательскими политиками](custom-policy-overview.md). Например, [URL-адрес динамического содержимого пользовательской страницы](customize-ui-with-html.md?pivots=b2c-custom-policy#configure-dynamic-custom-page-content-uri)или [арбитр утверждений "ключ — значение"](claim-resolver-overview.md#oauth2-key-value-parameters). |

На этом этапе пользователю предлагается выполнить рабочий процесс потока пользователя. Для этого могут потребоваться ввод имени пользователя и пароля, вход с помощью удостоверения социальной сети, регистрация в каталоге или любые другие шаги. Действия пользователя зависят от того, как определен его поток.

Когда пользователь завершит свой поток, служба Azure AD отправит в приложение ответ, используя указанное для `redirect_uri` значение. Она использует метод, указанный в параметре `response_mode`. Какие бы действия пользователь ни выполнял и каким бы ни был его поток, ответ всегда будет одинаковым.

Успешный ответ с использованием метода `response_mode=query` выглядит следующим образом:

```http
GET urn:ietf:wg:oauth:2.0:oob?
code=AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq...        // the authorization_code, truncated
&state=arbitrary_data_you_can_receive_in_the_response                // the value provided in the request
```

| Параметр | Описание |
| --- | --- |
| code |Запрашиваемый приложением код авторизации. Приложение может использовать код авторизации для запроса маркера доступа для целевого ресурса. Срок действия кодов авторизации крайне мал. и обычно истекает по прошествии порядка 10 минут. |
| Состояние |Полное описание см. в таблице выше. Если в запрос включен параметр `state`, идентичное значение должно содержаться и в ответе на этот запрос. Приложение должно проверить, совпадают ли значения параметра `state` в запросе и ответе. |

Сообщения об ошибках также можно отправлять на универсальный код ресурса (URI) перенаправления, чтобы приложение могло их правильно обработать:

```http
GET urn:ietf:wg:oauth:2.0:oob?
error=access_denied
&error_description=The+user+has+cancelled+entering+self-asserted+information
&state=arbitrary_data_you_can_receive_in_the_response
```

| Параметр | Описание |
| --- | --- |
| Ошибка |Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| error_description |Конкретное сообщение об ошибке, с помощью которого можно определить первопричину возникновения ошибки аутентификации. |
| Состояние |См. полное описание в предыдущей таблице. Если в запрос включен параметр `state`, идентичное значение должно содержаться и в ответе на этот запрос. Приложение должно проверить, совпадают ли значения параметра `state` в запросе и ответе. |

## <a name="2-get-an-access-token"></a>2. получение маркера доступа
После получения кода авторизации можно использовать `code`, чтобы получить маркер для целевого ресурса путем отправки запроса POST на конечную точку `/token`. В Azure AD B2C можно [запросить маркеры доступа для других API](access-tokens.md#request-a-token) как обычно, указав их области (в запросе).

Вы также можете запросить маркер доступа для собственного серверного веб-API в соответствии с соглашением об использовании идентификатора клиента приложения в качестве запрошенной области (что приведет к маркеру доступа с таким ИДЕНТИФИКАТОРом клиента, как "аудитория"):

```http
POST https://{tenant}.b2clogin.com/{tenant}.onmicrosoft.com/{policy}/oauth2/v2.0/token HTTP/1.1

Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code&client_id=90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6&scope=90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6 offline_access&code=AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq...&redirect_uri=urn:ietf:wg:oauth:2.0:oob&code_verifier=ThisIsntRandomButItNeedsToBe43CharactersLong 
```

| Параметр | Необходим? | Описание |
| --- | --- | --- |
|клиентом| Обязательно | Имя клиента Azure AD B2C|
|политик| Обязательно| Поток пользователя, который использовался для получения кода авторизации. Другой поток пользователя в этом запросе использовать нельзя. |
| client_id |Обязательно |Идентификатор приложения, назначенный вашему приложению на [портале Azure](https://portal.azure.com).|
| client_secret | Да, в веб-приложениях | Секрет приложения, созданный в [портал Azure](https://portal.azure.com/). Секреты клиента используются в этом потоке для сценариев веб-приложений, где клиент может безопасно хранить секрет клиента. Для сценариев собственного приложения (общедоступного клиента) секретность клиента не может быть безопасно сохранена и, следовательно, не используется в этом вызове. Если вы используете секрет клиента, измените его на периодической основе. |
| grant_type |Обязательно |Тип предоставления. Для потока кода авторизации это должен быть тип `authorization_code`. |
| область |Рекомендуемая |Список областей с разделителями-пробелами. При указании одной области также обозначаются запрашиваемые разрешения. Использование идентификатора клиента в качестве области указывает на то, что приложению нужен маркер доступа, который может использоваться в вашей службе или веб-API, представленных таким же идентификатором клиента.  Область `offline_access` означает, что вашему приложению потребуется маркер обновления для продолжительного доступа к ресурсам.  Вы также можете использовать область `openid` для запроса идентификатора маркера из Azure AD B2C. |
| code |Обязательно |Код авторизации, полученный на первом участке потока. |
| redirect_uri |Обязательно |URI перенаправления приложения, в котором вы получили код авторизации. |
| code_verifier | рекомендуется | Это тот же параметр code_verifier, который использовался для получения кода авторизации (authorization_code). Является обязательным, если в запросе на код авторизации использовался PKCE. Дополнительные сведения см. в описании [PKCE RFC](https://tools.ietf.org/html/rfc7636). |

Успешный ответ маркера выглядит следующим образом:

```json
{
    "not_before": "1442340812",
    "token_type": "Bearer",
    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...",
    "scope": "90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6 offline_access",
    "expires_in": "3600",
    "refresh_token": "AAQfQmvuDy8WtUv-sd0TBwWVQs1rC-Lfxa_NDkLqpg50Cxp5Dxj0VPF1mx2Z...",
}
```
| Параметр | Описание |
| --- | --- |
| not_before |Момент времени, в который маркер начинает считаться действительным (с начала эпохи). |
| token_type |Значение типа маркера. Единственный тип, поддерживаемый Azure AD — носитель. |
| access_token |Подписанный маркер JSON Web Token (JWT), который вы запрашивали. |
| область |Области, для которых действителен маркер. Области также можно использовать, чтобы кэшировать маркеры для последующего использования. |
| expires_in |Срок действия маркера (в секундах). |
| refresh_token |Маркер обновления OAuth 2.0. Приложение может использовать этот маркер для получения дополнительных маркеров по истечении срока действия текущего маркера. Маркеры обновления имеют большой срок действия. Их можно использовать для длительного сохранения доступа к ресурсам. Дополнительные сведения см. в статье [Azure AD B2C: справочник по маркерам](tokens-overview.md). |

Сообщения об ошибках выглядят следующим образом:

```json
{
    "error": "access_denied",
    "error_description": "The user revoked access to the app.",
}
```

| Параметр | Описание |
| --- | --- |
| Ошибка |Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| error_description |Конкретное сообщение об ошибке, с помощью которого можно определить первопричину возникновения ошибки аутентификации. |

## <a name="3-use-the-token"></a>3. Использование токена
После успешного получения маркера доступа маркер можно использовать в запросах к веб-API серверной части приложения путем включения маркера в заголовок `Authorization`:

```http
GET /tasks
Host: mytaskwebapi.com
Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...
```

## <a name="4-refresh-the-token"></a>4. Обновите токен
Срок действия маркеров доступа и маркеров идентификации крайне мал. Для сохранения доступа к ресурсам маркеры с истекшим сроком действия необходимо обновлять. Для этого нужно отправить еще один запрос POST в конечную точку `/token`, указав `refresh_token` вместо `code`:

```http
POST https://{tenant}.b2clogin.com/{tenant}.onmicrosoft.com/{policy}/oauth2/v2.0/token HTTP/1.1

Content-Type: application/x-www-form-urlencoded

grant_type=refresh_token&client_id=90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6&scope=90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6 offline_access&refresh_token=AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq...&redirect_uri=urn:ietf:wg:oauth:2.0:oob
```

| Параметр | Необходим? | Описание |
| --- | --- | --- |
|клиентом| Обязательно | Имя клиента Azure AD B2C|
|политик |Обязательно |Поток пользователя, который использовался для получения исходного маркера обновления. Другой поток пользователя в этом запросе использовать нельзя. |
| client_id |Обязательно |Идентификатор приложения, назначенный вашему приложению на [портале Azure](https://portal.azure.com). |
| client_secret | Да, в веб-приложениях | Секрет приложения, созданный в [портал Azure](https://portal.azure.com/). Секреты клиента используются в этом потоке для сценариев веб-приложений, где клиент может безопасно хранить секрет клиента. Для сценариев собственного приложения (общедоступного клиента) секретность клиента не может быть безопасно сохранена и, следовательно, не используется в этом вызове. Если вы используете секрет клиента, измените его на периодической основе. |
| grant_type |Обязательно |Тип предоставления. Для этого участка потока кода авторизации это должен быть тип `refresh_token`. |
| область |Рекомендуемая |Список областей с разделителями-пробелами. При указании одной области также обозначаются запрашиваемые разрешения. Использование идентификатора клиента в качестве области указывает на то, что приложению нужен маркер доступа, который может использоваться в вашей службе или веб-API, представленных таким же идентификатором клиента.  Область `offline_access` означает, что вашему приложению потребуется маркер обновления для продолжительного доступа к ресурсам.  Вы также можете использовать область `openid` для запроса идентификатора маркера из Azure AD B2C. |
| redirect_uri |Необязательно |URI перенаправления приложения, в котором вы получили код авторизации. |
| refresh_token |Обязательно |Исходный маркер обновления, полученный на втором участке потока. |

Успешный ответ маркера выглядит следующим образом:

```json
{
    "not_before": "1442340812",
    "token_type": "Bearer",
    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...",
    "scope": "90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6 offline_access",
    "expires_in": "3600",
    "refresh_token": "AAQfQmvuDy8WtUv-sd0TBwWVQs1rC-Lfxa_NDkLqpg50Cxp5Dxj0VPF1mx2Z...",
}
```
| Параметр | Описание |
| --- | --- |
| not_before |Момент времени, в который маркер начинает считаться действительным (с начала эпохи). |
| token_type |Значение типа маркера. Единственный тип, поддерживаемый Azure AD — носитель. |
| access_token |Подписанный маркер JWT, который вы запрашивали. |
| область |Области, для которых действителен маркер. Области также можно использовать, чтобы кэшировать маркеры для последующего использования. |
| expires_in |Срок действия маркера (в секундах). |
| refresh_token |Маркер обновления OAuth 2.0. Приложение может использовать этот маркер для получения дополнительных маркеров по истечении срока действия текущего маркера. У маркеров обновления длительный срок действия. Их можно использовать, чтобы надолго сохранять доступ к ресурсам. Дополнительные сведения см. в статье [Azure AD B2C: справочник по маркерам](tokens-overview.md). |

Сообщения об ошибках выглядят следующим образом:

```json
{
    "error": "access_denied",
    "error_description": "The user revoked access to the app.",
}
```

| Параметр | Описание |
| --- | --- |
| Ошибка |Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| error_description |Конкретное сообщение об ошибке, с помощью которого можно определить первопричину возникновения ошибки аутентификации. |

## <a name="use-your-own-azure-ad-b2c-directory"></a>Использование собственного каталога Azure AD B2C
Чтобы отправить эти запросы самостоятельно, выполните следующие действия. Замените значения, приведенные в этой статье в качестве примера, собственными.

1. [Создайте каталог Azure AD B2C](tutorial-create-tenant.md). Используйте имя своего каталога в запросах.
2. [Создайте приложение](tutorial-register-applications.md) для получения идентификатора приложения и URI перенаправления. Включите собственный клиент в приложение.
3. [Создайте собственные потоки пользователя](user-flow-overview.md) и получите их имена.
