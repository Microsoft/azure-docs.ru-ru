---
title: Общие сведения о настраиваемой политике Azure AD B2C | Документация Майкрософт
description: В этой статье рассматриваются пользовательские политики Azure Active Directory B2C и инфраструктура процедур идентификации.
services: active-directory-b2c
author: msmimart
manager: celestedg
ms.service: active-directory
ms.workload: identity
ms.topic: reference
ms.date: 12/14/2020
ms.author: mimart
ms.subservice: B2C
ms.openlocfilehash: cb33e11af26d5f5a2676f5b236ac142179bdb550
ms.sourcegitcommit: f377ba5ebd431e8c3579445ff588da664b00b36b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/05/2021
ms.locfileid: "99592846"
---
# <a name="azure-ad-b2c-custom-policy-overview"></a>Общие сведения о настраиваемой политике Azure AD B2C

Настраиваемые политики — это файлы конфигурации, определяющие поведение вашего клиента Azure Active Directory B2C (Azure AD B2C). Хотя [потоки пользователей](user-flow-overview.md) предопределены на портале Azure AD B2C для наиболее распространенных задач идентификации, пользовательские политики могут полностью редактироваться разработчиком удостоверений для выполнения различных задач.

Настраиваемая политика полностью настраивается и управляется политиками. Настраиваемая политика управляет отношениями доверия между сущностями в стандартных форматах протокола, таких как OpenID Connect Connect, OAuth, SAML и несколько нестандартных, например, для обмена утверждениями типа "система-система" на основе REST API. Платформа создает удобные для пользователя возможности работы с пробелом.

Пользовательские политики представлены одним или несколькими XML-файлами, которые ссылаются друг на друга в иерархической цепочке. XML-элементы определяют стандартные блоки, взаимодействие с пользователем и другие стороны, а также бизнес-логику. 

## <a name="custom-policy-starter-pack"></a>Начальный пакет настраиваемых политик

Azure AD B2C [начальный пакет](custom-policy-get-started.md#get-the-starter-pack) настраиваемой политики поставляется с несколькими предварительно созданными политиками, чтобы быстро приступить к работе. Каждый начальный пакет содержит минимальное количество технических профилей и путей взаимодействия пользователей, необходимых для достижения описанных сценариев:

- **LocalAccounts** позволяет использовать только локальные учетные записи.
- **SocialAccounts** позволяет использовать только учетные записи социальных сетей (или федеративные).
- **SocialAndLocalAccounts** позволяет использовать и локальные учетные записи, и учетные записи социальных сетей. Большинство наших примеров относится к этой политике.
- **SocialAndLocalAccountsWithMFA** позволяет использовать локальные учетные записи и учетные записи социальных сетей с многофакторной проверкой подлинности.

## <a name="understanding-the-basics"></a>Основные сведения 

### <a name="claims"></a>Утверждения

Утверждение предоставляет временное хранилище данных на время выполнения политики Azure AD B2C. Он может хранить сведения о пользователе, такие как имя, фамилия или любое другое утверждение, полученное от пользователя или других систем (обмен утверждениями). [Схема утверждений](claimsschema.md) — это место, где вы объявляете свои утверждения. 

При запуске политики Azure AD B2C отправляет и получает утверждения для внутренних и внешних сторон, а затем отправляет подмножество этих утверждений в приложение проверяющей стороны как часть токена. Утверждения используются в следующих случаях: 

- Утверждение сохраняется, считывается или обновляется по отношению к объекту пользователя каталога.
- Утверждение получено от внешнего поставщика удостоверений.
- Утверждения отправляются или принимаются с помощью пользовательской службы REST API.
- Данные собираются как утверждения от пользователя во время регистрации или редактирования профилей.

### <a name="manipulating-your-claims"></a>Управление утверждениями

Преобразования [утверждений](claimstransformations.md) — это стандартные функции, которые можно использовать для преобразования данного утверждения в другое, для вычисления утверждения или для задания значения утверждения. Например, можно добавить элемент в коллекцию строк, изменить регистр строки или вычислить утверждение даты и времени. Преобразование «утверждения» указывает метод преобразования. 

### <a name="customize-and-localize-your-ui"></a>Настройка и локализация пользовательского интерфейса

Если вы хотите получать информацию от пользователей, выполнив страницу в своем веб-браузере, используйте [самостоятельно утвержденный технический профиль](self-asserted-technical-profile.md). Вы можете изменить самостоятельно утвержденный технический профиль, чтобы [Добавить заявки и настроить ввод пользователя](./configure-user-input.md).

Чтобы [настроить пользовательский интерфейс](customize-ui-with-html.md) для самостоятельно утвержденного технического профиля, укажите URL-адрес в элементе [определения содержимого](contentdefinitions.md) с настраиваемым содержимым HTML. В самостоятельно утвержденном техническом профиле вы указываете на этот идентификатор определения содержимого.

Чтобы настроить строки, зависящие от языка, используйте элемент [Localization](localization.md) . Определение содержимого может содержать ссылку на [локализацию](localization.md) , указывающую список локализованных ресурсов для загрузки. Azure AD B2C объединяет элементы пользовательского интерфейса с содержимым HTML, загруженным по указанному URL-адресу, и отображает страницу для пользователя. 

## <a name="relying-party-policy-overview"></a>Общие сведения о политике проверяющей стороны

Приложение проверяющей стороны, которое в протоколе SAML называется поставщиком услуг, вызывает [политику проверяющей стороны](relyingparty.md) для выполнения определенного пути взаимодействия пользователя. Политика проверяющей стороны указывает путь взаимодействия пользователя для выполнения и список утверждений, которые включает маркер. 

![Схема, показывающая поток выполнения политики](./media/custom-policy-trust-frameworks/custom-policy-execution.png)

Все приложения проверяющей стороны, использующие одну и ту же политику, получат те же утверждения токенов, и пользователь проходит по одному пути взаимодействия пользователя.

### <a name="user-journeys"></a>Пути взаимодействия пользователя

Пути взаимодействия [пользователя](userjourneys.md) позволяют определить бизнес-логику путем указания способа, по которому пользователь будет получать доступ к вашему приложению. Пользователь проходит по пути взаимодействия пользователя, чтобы получить утверждения, которые должны быть представлены вашему приложению. Путь взаимодействия пользователя создается на основе последовательности [этапов оркестрации](userjourneys.md#orchestrationsteps). Пользователь должен обратиться к последнему шагу, чтобы получить маркер. 

Приведенные ниже инструкции описывают, как можно добавить шаги оркестрации в политику [начального пакета для социальных сетей и локальной учетной записи](https://github.com/Azure-Samples/active-directory-b2c-custom-policy-starterpack/tree/master/SocialAndLocalAccounts) . Ниже приведен пример добавленного вызова REST API.

![настраиваемое пути взаимодействия пользователя](media/custom-policy-trust-frameworks/user-journey-flow.png)


### <a name="orchestration-steps"></a>Этапы оркестрации

Шаг оркестрации ссылается на метод, реализующий его предполагаемое назначение или функциональность. Этот метод называется [техническим профилем](technicalprofiles.md). Когда [взаимодействие с пользователем](subjourneys.md)требует ветвления для лучшего представления бизнес-логики, этап оркестрации ссылается на подразделение. Вложенное путешествие содержит собственный набор этапов оркестрации.

Чтобы получить маркер, пользователь должен обратиться к последнему этапу оркестрации в пути взаимодействия пользователя. Но пользователям может не потребоваться пройти все этапы оркестрации. Шаги оркестрации можно условно выполнять на основе [предусловий](userjourneys.md#preconditions) , определенных на этапе оркестрации. 

После завершения действия оркестрации Azure AD B2C сохраняет выводимые утверждения в **контейнере утверждений**. Утверждения в контейнере утверждений могут быть использованы любыми дальнейшими действиями оркестрации в пути взаимодействия пользователя.

На следующей схеме показано, как шаги оркестрации пути взаимодействия пользователя могут получить доступ к контейнеру утверждений.

![Azure AD B2C пути взаимодействия пользователя](media/custom-policy-trust-frameworks/user-journey-diagram.png)

### <a name="technical-profile"></a>Технический профиль

Технический профиль предоставляет интерфейс для взаимодействия с разными типами сторон. Путь взаимодействия пользователя сочетает в себе вызов технических профилей с помощью действий оркестрации, чтобы определить бизнес-логику.

Все типы технических профилей созданы в рамках одной концепции. Вы отправляете входящие утверждения, запускаете преобразование утверждений и взаимодействуете с настроенной стороной. После завершения процесса технический профиль возвращает выходные утверждения в контейнер утверждений. Дополнительные сведения см. в статье [Обзор технических профилей](technicalprofiles.md).

### <a name="validation-technical-profile"></a>Технический профиль проверки

Когда пользователь взаимодействует с пользовательским интерфейсом, может потребоваться проверить собранные данные. Для взаимодействия с пользователем необходимо использовать [самостоятельно утвержденный технический профиль](self-asserted-technical-profile.md) .

Чтобы проверить введенные пользователем данные, в самостоятельно утвержденном техническом профиле вызывается [технический профиль проверки](validation-technical-profile.md) . Технический профиль проверки — это метод вызова любого неинтерактивного технического профиля. В этом случае технический профиль может возвращать выходные утверждения или сообщение об ошибке. Сообщение об ошибке отображается для пользователя на экране, что позволяет пользователю повторить попытку.

На следующей схеме показано, как Azure AD B2C использует технический профиль проверки для проверки учетных данных пользователя.

![Схема технического профиля проверки](media/custom-policy-trust-frameworks/validation-technical-profile.png)

## <a name="inheritance-model"></a>Модель наследования

Каждый начальный пакет содержит следующие файлы:

- **Базовый** файл, содержащий большую часть определений. Чтобы помочь в устранении неполадок и долгосрочном обслуживании политик, попробуйте уменьшить число изменений, внесенных в этот файл.
- Файл **расширений**, содержащий уникальные изменения конфигурации для арендатора. Этот файл политики является производным от базового файла. Он используется для добавления новых функциональных возможностей или переопределения существующих. Например, с его помощью можно реализовать федерацию с новыми поставщиками удостоверений.
- Файл **проверяющей стороны (RP)** — файл с одной задачей, который вызывается непосредственно приложением проверяющей стороны, например веб-приложениями, мобильными или классическими приложениями. Для каждой уникальной задачи, такой как регистрация, вход, сброс пароля или изменение профиля, требуется собственный файл политики проверяющей стороны. Этот файл политики является производным от файла расширений.

Модель наследования выглядит следующим образом:

- Дочерняя политика на любом уровне может наследоваться от родительской и расширять ее, добавляя новые элементы.
- Для более сложных сценариев можно добавить дополнительные уровни наследования (всего до 10).
- Можно добавить дополнительные политики проверяющей стороны. Например, удалите учетную запись, измените номер телефона, политику проверяющей стороны SAML и многое другое.

На следующей схеме показана связь между файлами политики и приложениями проверяющей стороны.

![Схема, демонстрирующая модель наследования политики инфраструктуры доверия](media/custom-policy-trust-frameworks/policies.png)


## <a name="guidance-and-best-practices"></a>Руководство и рекомендации

### <a name="best-practices"></a>Рекомендации

В Azure AD B2C настраиваемой политике можно интегрировать собственную бизнес-логику для создания пользовательских интерфейсов, которые необходимы и расширяют функциональные возможности службы. У нас есть набор рекомендаций и рекомендаций, которые помогут приступить к работе.

- Создайте логику в **политике расширения** или **политике проверяющей стороны**. Можно добавить новые элементы, которые будут переопределять базовую политику, ссылаясь на тот же идентификатор. Это позволит вам масштабировать проект, одновременно упрощая обновление базовой политики, если корпорация Майкрософт выпустит новые начальные пакеты.
- В **базовой политике** настоятельно рекомендуется избегать внесения каких либо изменений. При необходимости запишите комментарии, в которых вносятся изменения.
- При переопределении элемента, например метаданных технического профиля, Избегайте копирования всего технического профиля из базовой политики. Вместо этого скопируйте только обязательный раздел элемента. Пример внесения изменений см. в разделе [Отключение проверки электронной почты](./disable-email-verification.md) .
- Чтобы сократить дублирование технических профилей, где основные функции являются общими, используйте [техническое включение профиля](technicalprofiles.md#include-technical-profile).
- Избегайте записи в каталог Azure AD во время входа, что может привести к проблемам регулирования.
- Если у вашей политики есть внешние зависимости, например интерфейсы API-интерфейсов, то гарантирует высокую доступность.
- Для повышения удобства работы пользователей убедитесь, что пользовательские HTML-шаблоны глобально развернуты с помощью [доставки содержимого в сети](../cdn/index.yml). Сеть доставки содержимого (CDN) Azure позволяет сократить время загрузки, сэкономить пропускную способность и повысить скорость ответа.
- Если вы хотите внести изменения в путь взаимодействия пользователя, скопируйте весь путь взаимодействия пользователя из базовой политики в политику расширения. Укажите уникальный идентификатор пути взаимодействия пользователя для скопированного пути взаимодействия пользователя. Затем в [политике проверяющей стороны](relyingparty.md)измените элемент [пути пользователя по умолчанию](relyingparty.md#defaultuserjourney) , чтобы он указывал на новый путь взаимодействия пользователя.

## <a name="troubleshooting"></a>Устранение неполадок

При разработке с помощью политик Azure AD B2C вы можете столкнуться с ошибками или исключениями при выполнении пути взаимодействия пользователя. Можно исследовать с помощью Application Insights.

- Интеграция Application Insights с Azure AD B2C для [диагностики исключений](troubleshoot-with-application-insights.md).
- [Расширение Azure AD B2C для Visual Studio Code](https://marketplace.visualstudio.com/items?itemName=AzureADB2CTools.aadb2c) может помочь в доступе и [визуализации журналов](https://github.com/azure-ad-b2c/vscode-extension/blob/master/src/help/app-insights.md) на основе имени политики и времени.
- Самой распространенной ошибкой при настройке пользовательских политик является неправильный формат XML. Используйте [проверку схемы XML](troubleshoot-custom-policies.md) для обнаружения ошибок перед отправкой XML-файла.

## <a name="continuous-integration"></a>Непрерывная интеграция

С помощью конвейера непрерывной интеграции и доставки (CI/CD), настроенного в Azure Pipelines, можно [включать Azure AD B2C настраиваемые политики в вашу доставку программного обеспечения](deploy-custom-policies-devops.md) и автоматизацию управления кодом. При развертывании в разных средах Azure AD B2C, например для разработки, тестирования и производства, рекомендуется удалить ручные процессы и выполнить автоматическое тестирование с помощью Azure Pipelines.

## <a name="prepare-your-environment"></a>Подготовка среды

Вы приступите к работе с Azure AD B2C настраиваемой политикой:

1. [Создание клиента Azure AD B2C](tutorial-create-tenant.md)
1. [Зарегистрируйте веб-приложение](tutorial-register-applications.md) с помощью портал Azure, чтобы вы могли протестировать политику.
1. Добавьте необходимые [ключи политики](custom-policy-get-started.md#add-signing-and-encryption-keys) и [зарегистрируйте приложения инфраструктуры процедур идентификации](custom-policy-get-started.md#register-identity-experience-framework-applications).
1. [Получите начальный пакет политики Azure AD B2C](custom-policy-get-started.md#get-the-starter-pack) и отправьте его в клиент. 
1. После отправки начального пакета [протестируйте политику регистрации или входа](custom-policy-get-started.md#test-the-custom-policy).
1. Рекомендуется скачать и установить [Visual Studio Code](https://code.visualstudio.com/) (VS Code). Visual Studio Code — это упрощенный, но мощный редактор исходного кода, который работает на рабочем столе и доступен для Windows, macOS и Linux. С помощью VS Code можно быстро перемещаться по XML-файлам настраиваемой политики Azure AD B2C и изменять их, устанавливая [расширение Azure AD B2C для VS Code](https://marketplace.visualstudio.com/items?itemName=AzureADB2CTools.aadb2c)
 
## <a name="next-steps"></a>Дальнейшие действия

После настройки и тестирования политики Azure AD B2C можно приступить к настройке политики. Ознакомьтесь со следующими статьями, чтобы узнать, как это делать:

- [Добавление утверждений и настройка пользовательского ввода](./configure-user-input.md) с помощью пользовательских политик. Узнайте, как определить утверждение и добавить утверждение в пользовательский интерфейс, настроив некоторые технические профили начального пакета.
- [Настройка пользовательского интерфейса](customize-ui-with-html.md) приложения с помощью настраиваемой политики. Узнайте, как создать собственное содержимое HTML и настроить определение содержимого.
- [Локализация пользовательского интерфейса](./language-customization.md) приложения с помощью настраиваемой политики. Узнайте, как настроить список поддерживаемых языков и указать метки для конкретного языка, добавив элемент локализованных ресурсов.
- Во время разработки и тестирования политики можно [отключить проверку электронной почты](./disable-email-verification.md). Узнайте, как перезаписать метаданные технического профиля.
- [Настройка входа с использованием учетной записи Google](./identity-provider-google.md) с помощью пользовательских политик. Узнайте, как создать новый поставщик утверждений с помощью технического профиля OAuth2. Затем настройте путь взаимодействия пользователя, включив в него параметр входа Google.
- Чтобы диагностировать проблемы с пользовательскими политиками, можно [получать журналы Azure Active Directory B2C с помощью Application Insights](troubleshoot-with-application-insights.md). Узнайте, как добавить новые технические профили и настроить политику проверяющей стороны.
