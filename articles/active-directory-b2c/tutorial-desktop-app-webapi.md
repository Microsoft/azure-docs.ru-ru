---
title: Руководство по Предоставление доступа к веб-API Node.js из классического приложения
description: Руководство. Использование Active Directory B2C для защиты веб-API Node.js и его вызова из классического приложения NET.
services: active-directory-b2c
author: msmimart
manager: celestedg
ms.author: mimart
ms.date: 10/12/2019
ms.custom: mvc
ms.topic: tutorial
ms.service: active-directory
ms.subservice: B2C
ms.openlocfilehash: 12951f25feb6f3710b8d35fbc682caeeb480e788
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "100555608"
---
# <a name="tutorial-grant-access-to-a-nodejs-web-api-from-a-desktop-app-using-azure-active-directory-b2c"></a>Руководство по Предоставление доступа к веб-API Node.js из классического приложения с помощью Azure Active Directory B2C

В этом учебнике показано, как вызывать веб-API Node.js, защищенный с помощью Azure Active Directory (Azure AD) B2C, из классического приложения Windows Presentation Foundation (WPF), также защищенного с помощью Azure AD B2C.

В этом руководстве описано следующее:

> [!div class="checklist"]
> * Добавление приложения веб-API
> * Настройка областей для веб-API.
> * Предоставление разрешения на использование веб-API.
> * Обновление примера для использования приложения.

## <a name="prerequisites"></a>Предварительные требования

Выполните действия и необходимые условия в статье [Руководство. Включение проверки подлинности в собственном клиентском приложении с помощью Azure Active Directory B2C](tutorial-desktop-app.md).

## <a name="add-a-web-api-application"></a>Добавление приложения веб-API

[!INCLUDE [active-directory-b2c-appreg-webapi](../../includes/active-directory-b2c-appreg-webapi.md)]

## <a name="configure-scopes"></a>Настройка областей

Области предоставляют способ контроля доступа к защищенным ресурсам. Области используются веб-API для реализации управления доступом на уровне области. Например, некоторые пользователи могут иметь доступ на чтение и запись, тогда как другие пользователи могут иметь разрешения только на чтение. В этом руководстве вы определяете разрешения на чтение и запись для веб-API.

[!INCLUDE [active-directory-b2c-scopes](../../includes/active-directory-b2c-scopes.md)]

Запишите значение в разделе **Области**, которое будет использоваться в области `demo.read` на следующих шагах при настройке классического приложения. Значение полной области аналогично `https://contosob2c.onmicrosoft.com/api/demo.read`.

## <a name="grant-permissions"></a>Предоставить разрешения

Чтобы вызвать защищенный веб-API из собственного клиентского приложения, необходимо предоставить зарегистрированному клиентскому приложению разрешения на доступ к веб-API, зарегистрированному в Azure AD B2C.

Выполняя предварительные требования, вы зарегистрировали собственное клиентское приложение с именем *nativeapp1*. Ниже приведены шаги по настройке регистрации собственного приложения с областями API, предоставленными для *webapi1* в предыдущем разделе. Это позволит классическому приложению получить маркер доступа от Azure AD B2C, на основе которого веб-API будет выполнять проверку и предоставлять доступ к своим ресурсам в заданной области. Далее в этом учебнике вы настроите и запустите примеры кода классического приложения и веб-API.

Чтобы зарегистрировать приложение в клиенте Azure AD B2C, можно использовать новый унифицированный интерфейс **Регистрации приложений** или устаревший интерфейс **Приложения (прежние версии)** . [См. дополнительные сведения о новом интерфейсе](./app-registrations-training-guide.md).

#### <a name="app-registrations"></a>[Регистрация приложений](#tab/app-reg-ga/)

1. Выберите **Регистрация приложений**, а затем — собственное клиентское приложение, которое должно иметь доступ к API. Например, *nativeapp1*.
1. В разделе **Управление** выберите **Разрешения API**.
1. В разделе **Настроенные разрешения** выберите **Добавить разрешение**.
1. Выберите вкладку **Мои API**.
1. Выберите API, к которому должен быть предоставлен доступ собственному клиентскому приложению. Например, *webapi1*.
1. В разделе **Разрешение** разверните узел **Демонстрация**, а затем выберите определенные ранее области. Например, *demo.read* и *demo.write*.
1. Выберите **Добавить разрешения**. В соответствии с инструкциями подождите несколько минут, прежде чем перейти к следующему шагу.
1. Выберите **Предоставить согласие администратора для (имя арендатора)** .
1. Выберите учетную запись администратора, с которой выполнен вход, или выполните вход с учетной записью в арендаторе Azure AD B2C, которой назначена по крайней мере роль *Администратор облачных приложений*.
1. Нажмите кнопку **Принять**.
1. Нажмите **Обновить** и убедитесь, что надпись "Предоставлено для..." отображается в разделе **Состояние** для обеих областей. Распространение разрешений может занять несколько минут.

#### <a name="applications-legacy"></a>[Приложения (прежние версии)](#tab/applications-legacy/)

1. Щелкните **Applications (Legacy)** (Приложения (прежние версии)), а затем выберите *nativeapp1*.
1. Щелкните **Доступ через API**, а затем выберите **Добавить**.
1. В раскрывающемся списке **Выбрать API** выберите *webapi1*.
1. В раскрывающемся списке **Выбрать области** выберите области, определенные ранее. Например, *demo.read* и *demo.write*.
1. Щелкните **ОК**.

* * *

Пользователь выполняет проверку подлинности с помощью Azure AD B2C для использования классического приложения WPF. Классическое приложение получает предоставление авторизации из Azure AD B2C для доступа к защищенному веб-API.

## <a name="configure-the-samples"></a>Настройка примеров

Теперь, когда веб-API зарегистрирован, а области и разрешения настроены, необходимо настроить примеры классического приложения и веб-API, чтобы использовать арендатор Azure AD B2C.

### <a name="update-the-desktop-application"></a>Обновление настольного приложения

Выполняя предварительные требования, вы изменили [классическое приложение WPF](https://github.com/Azure-Samples/active-directory-b2c-dotnet-desktop), чтобы включить вход с использованием потока пользователя в арендаторе Azure AD B2C. В этом разделе вы обновите это же приложение для ссылки на ранее зарегистрированный веб-API *webapi1*.

1. Откройте решение **active-directory-b2c-wpf** (`active-directory-b2c-wpf.sln`) в Visual Studio.
1. В проекте **active-directory-b2c-wpf** откройте файл *App.xaml.cs* и найдите следующие определения переменных.
    1. Замените значение переменной `ApiScopes` значением, записанным ранее при определении области **demo.read**.
    1. Замените значение переменной `ApiEndpoint` на **URI перенаправления**, записанный ранее при регистрации веб-API (например, *webapi1*) в арендаторе.

    Ниже приведен пример:

    ```csharp
    public static string[] ApiScopes = { "https://contosob2c.onmicrosoft.com/api/demo.read" };
    public static string ApiEndpoint = "http://localhost:5000";
    ```

### <a name="get-and-update-the-nodejs-api-sample"></a>Получение и обновление примера API Node.js

Затем получите пример кода веб-API для Node.js на сайте GitHub и настройте его для использования веб-API, зарегистрированного в арендаторе Azure AD B2C.

[Загрузите ZIP-файл](https://github.com/Azure-Samples/active-directory-b2c-javascript-nodejs-webapi/archive/master.zip) или клонируйте пример приложения с GitHub.

```console
git clone https://github.com/Azure-Samples/active-directory-b2c-javascript-nodejs-webapi.git
```

Пример веб-API Node.js с помощью библиотеки Passport.js активирует Azure AD B2C для защиты вызовов API.

1. Откройте файл `index.js` .
1. Обновите эти определения переменных с использованием следующих значений. Измените `<web-API-application-ID>` на **идентификатор приложения (клиента)** веб-API (*webapi1*), зарегистрированного ранее. Замените `<your-b2c-tenant>` на имя вашего арендатора Azure Active Directory B2C.

    ```nodejs
    var clientID = "<web-API-application-ID>";
    var b2cDomainHost = "<your-b2c-tenant>.b2clogin.com";
    var tenantIdGuid = "<your-b2c-tenant>.onmicrosoft.com";
    var policyName = "B2C_1_signupsignin1";
    ```
1. Так как вы используете API в локальной среде, обновите путь в маршруте для метода GET на `/` вместо расположения демонстрационного приложения `/hello`:

    ```nodejs
    app.get("/",
    ```

## <a name="run-the-samples"></a>Запуск шаблонов

### <a name="run-the-nodejs-web-api"></a>Запуск веб-API для Node.js

1. Откройте командную строку Node.js.
2. Перейдите в каталог, содержащий пример приложения Node.js. Например `cd c:\active-directory-b2c-javascript-nodejs-webapi`
3. Выполните следующие команды:
    ```console
    npm install && npm update
    ```
    ```console
    node index.js
    ```

### <a name="run-the-desktop-application"></a>Запуск классического приложения

1. Откройте решение **active-directory-b2c-wpf** в Visual Studio.
2. Нажмите клавишу **F5**, чтобы запустить классическое приложение.
3. Войдите с помощью адреса электронной почты и пароля, которые использовались при работе с [руководством по проверке подлинности пользователей с помощью Azure Active Directory B2C в классическом приложении](tutorial-desktop-app.md).
4. Нажмите кнопку **вызова API**.

Классическое приложение выполняет запрос к локально запущенному веб-API, а после проверки допустимого маркера доступа выводит отображаемое имя пользователя, выполнившего вход.

![Имя, отображаемое в верхней области классического приложения WPF](./media/tutorial-desktop-app-webapi/desktop-app-01-post-api-call.png)

Классическое приложение, защищенное с помощью Azure AD B2C, вызывает запущенный в локальной среде веб-API, который также защищен с помощью Azure AD B2C.

## <a name="next-steps"></a>Дальнейшие действия

В этом руководстве вы узнали, как выполнять следующие задачи:

> [!div class="checklist"]
> * Добавление приложения веб-API
> * Настройка областей для веб-API.
> * Предоставление разрешения на использование веб-API.
> * Обновление примера для использования приложения.

> [!div class="nextstepaction"]
> [Добавление поставщиков удостоверений приложениям в Azure Active Directory B2C](add-identity-provider.md)