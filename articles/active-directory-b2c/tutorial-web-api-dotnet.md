---
title: Руководство по предоставлению доступа к веб-API ASP.NET
titleSuffix: Azure AD B2C
description: Руководство по использованию Active Directory B2C для защиты веб-API ASP.NET и его вызова из веб-приложения ASP.NET.
services: active-directory-b2c
author: msmimart
manager: celestedg
ms.author: mimart
ms.date: 10/14/2019
ms.custom: devx-track-csharp, mvc
ms.topic: tutorial
ms.service: active-directory
ms.subservice: B2C
ms.openlocfilehash: 84bf0ddd194cd59a7e728c0c50dbe3cbad2afa4a
ms.sourcegitcommit: a67b972d655a5a2d5e909faa2ea0911912f6a828
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/23/2021
ms.locfileid: "100555653"
---
# <a name="tutorial-grant-access-to-an-aspnet-web-api-using-azure-active-directory-b2c"></a>Руководство по Предоставление доступа к веб-API ASP.NET с помощью Azure Active Directory B2C

В этом руководстве показано, как вызывать защищенный ресурс веб-API в Azure Active Directory B2C (Azure AD B2C) из веб-приложения ASP.NET.

В этом руководстве описано следующее:

> [!div class="checklist"]
> * Добавление приложения веб-API
> * Настройка областей для веб-API.
> * Предоставление разрешения на использование веб-API.
> * настройка примера для использования приложения;

[!INCLUDE [quickstarts-free-trial-note](../../includes/quickstarts-free-trial-note.md)]

## <a name="prerequisites"></a>Предварительные требования

Выполните действия и необходимые условия в статье [Руководство. Включение в веб-приложении аутентификации на основе учетных записей с помощью Azure Active Directory B2C](tutorial-web-app-dotnet.md).

## <a name="add-a-web-api-application"></a>Добавление приложения веб-API

Ресурсы веб-API необходимо зарегистрировать в клиенте, чтобы они могли принимать запросы защищенных ресурсов от клиентских приложений, которые представляют маркер доступа, и отвечать на них.

Чтобы зарегистрировать приложение в клиенте Azure AD B2C, можно использовать новый унифицированный интерфейс **регистрации приложений** или устаревший интерфейс **приложений (прежняя версия)** . [См. дополнительные сведения о новом интерфейсе](./app-registrations-training-guide.md).

#### <a name="app-registrations"></a>[Регистрация приложений](#tab/app-reg-ga/)

1. Войдите на [портал Azure](https://portal.azure.com).
1. Выберите фильтр **Каталог и подписка** в верхнем меню, а затем выберите каталог, содержащий клиент Azure AD B2C.
1. В меню слева выберите **Azure AD B2C**. Либо щелкните **Все службы**, а затем найдите и выберите **Azure AD B2C**
1. Щелкните **Регистрация приложений** и выберите **Новая регистрация**.
1. Введите **имя** приложения. Например, *webapi1*.
1. В разделе **URL-перенаправления** выберите **Интернет**, а затем введите конечную точку, куда Azure AD B2C будет возвращать все маркеры, запрашиваемые вашим приложением. В этом руководстве пример выполняется локально и ожидает передачи данных по адресу `https://localhost:44332`.
1. Выберите **Зарегистрировать**.
1. Запишите значение параметра **Идентификатор приложения (клиент)** . Оно вам потребуется в дальнейшем.

#### <a name="applications-legacy"></a>[Приложения (прежние версии)](#tab/applications-legacy/)

1. Войдите на [портал Azure](https://portal.azure.com).
2. Убедитесь, что используете каталог с клиентом Azure AD B2C, выбрав фильтр **Каталог и подписка** в меню вверху и каталог с вашим клиентом.
3. Выберите **Все службы** в левом верхнем углу окна портала Azure, а затем найдите и выберите **Azure AD B2C**.
4. Щелкните **Applications (Legacy)** (Приложения (Прежние версии)), а затем выберите **Добавить**.
5. Введите имя приложения. Например, *webapi1*.
6. Для поля **Включить веб-приложение или веб-интерфейс API** выберите **Да**.
7. Для **URL-адреса ответа** введите конечные точки, куда Azure AD B2C возвращает все маркеры, запрашиваемые вашим приложением. В этом руководстве пример выполняется локально и ожидает передачи данных по адресу `https://localhost:44332`.
8. Для поля **URI идентификатора приложения** выберите идентификатор, используемый для веб-API. Полный URI код с доменом создается автоматически. Например, `https://contosotenant.onmicrosoft.com/api`.
9. Нажмите кнопку **Создать**.
10. На странице свойств запишите идентификатор приложения, который будет использоваться при настройке веб-приложения.

* * *

## <a name="configure-scopes"></a>Настройка областей

Области предоставляют способ контроля доступа к защищенным ресурсам. Области используются веб-API для реализации управления доступом на уровне области. Например, пользователи веб-API могут иметь доступ на чтение и запись или доступ только на чтение. В этом руководстве также можно использовать области для определения разрешений на чтение и запись для веб-API.

[!INCLUDE [active-directory-b2c-scopes](../../includes/active-directory-b2c-scopes.md)]

## <a name="grant-permissions"></a>Предоставить разрешения

Чтобы вызвать защищенный веб-API из приложения, необходимо предоставить приложению разрешения на доступ к API. Как часть предварительного требования, вы создали веб-приложение *webapp1* в Azure AD B2C. Используйте это приложение для вызова веб-API.

[!INCLUDE [active-directory-b2c-permissions-api](../../includes/active-directory-b2c-permissions-api.md)]

Приложение зарегистрировано для вызова защищенного веб-API. Пользователь выполняет аутентификацию в Azure AD B2C для использования приложения. Приложение получает предоставление авторизации из Azure AD B2C для доступа к защищенному веб-API.

## <a name="configure-the-sample"></a>Настройка примера

Теперь, когда веб-API зарегистрирован и определены области, необходимо настроить веб-API для использования клиента Azure AD B2C. В этом руководстве настройте пример веб-API. Пример веб-API включен в проект, который вы скачали при работе с предыдущей статьей.

Пример решения состоит из двух проектов.

* **TaskWebApp** — создание и изменение списка задач. Пример использует поток пользователя **регистрации или входа** для регистрации пользователей или входа в систему.
* **TaskService** — это веб-API, поддерживающий функции создания, чтения, обновления и удаления списка задач. API защищен с помощью Azure AD B2C и вызывается TaskWebApp.

### <a name="configure-the-web-application"></a>Настройка веб-приложения

1. Откройте решение **B2C-WebAPI-DotNet** в Visual Studio.
1. В проекте **TaskWebApp** откройте файл **Web.config**.
1. Для запуска API-интерфейса в локальной среде используйте параметр localhost для **api:TaskServiceUrl**. Измените файл Web.config следующим образом:

    ```csharp
    <add key="api:TaskServiceUrl" value="https://localhost:44332/"/>
    ```

1. Настройте URI API-интерфейса. Это URI, который веб-приложение использует для выполнения запроса API. Кроме того, настройте запрошенные разрешения.

    ```csharp
    <add key="api:ApiIdentifier" value="https://<Your tenant name>.onmicrosoft.com/api/" />
    <add key="api:ReadScope" value="demo.read" />
    <add key="api:WriteScope" value="demo.write" />
    ```

### <a name="configure-the-web-api"></a>Настройка веб-API

1. В проекте **TaskService** откройте файл **Web.config**.
1. Настройте API-интерфейс для использования клиента.

    ```csharp
    <add key="ida:AadInstance" value="https://<Your tenant name>.b2clogin.com/{0}/{1}/v2.0/.well-known/openid-configuration" />
    <add key="ida:Tenant" value="<Your tenant name>.onmicrosoft.com" />
    ```

1. Определите в качестве идентификатора клиента идентификатор зарегистрированного приложения веб-API — *webapi1*.

    ```csharp
    <add key="ida:ClientId" value="<application-ID>"/>
    ```

1. Измените параметр потока пользователя, указав имя потока регистрации и входа пользователя — *B2C_1_signupsignin1*.

    ```csharp
    <add key="ida:SignUpSignInPolicyId" value="B2C_1_signupsignin1" />
    ```

1. Настройте параметр области в соответствии с тем, что вы создали на портале.

    ```csharp
    <add key="api:ReadScope" value="demo.read" />
    <add key="api:WriteScope" value="demo.write" />
    ```

## <a name="run-the-sample"></a>Запуск примера

Необходимо выполнить оба проекта: **TaskWebApp** и **TaskService**.

1. В обозревателе решений щелкните решение правой кнопкой мыши и выберите **Set StartUp Projects...** (Назначить запускаемые проекты...).
1. Выберите **Несколько запускаемых проектов**.
1. Установите **Запуск** в качестве **действия** для обоих проектов.
1. Нажмите кнопку **ОК**, чтобы сохранить конфигурацию.
1. Нажмите клавишу **F5** для запуска приложений. Каждое приложение открывается в отдельной вкладке браузера.
    * `https://localhost:44316/` — это веб-приложение.
    * `https://localhost:44332/` — это веб-API.

1. В веб-приложении выберите команды **регистрации или входа в систему**, чтобы войти в веб-приложение. Используйте учетную запись, созданную ранее.
1. После входа щелкните **Список задач** и создайте элемент списка задач.

При создании элемента списка задач веб-приложение выполняет запрос к веб-API, чтобы создать элемент списка задач. Защищенное веб-приложение вызывает веб-API, защищенный с помощью Azure AD B2C.

## <a name="next-steps"></a>Дальнейшие действия

В этом руководстве вы узнали, как выполнять следующие задачи:

> [!div class="checklist"]
> * Добавление приложения веб-API
> * Настройка областей для веб-API.
> * Предоставление разрешения на использование веб-API.
> * настройка примера для использования приложения;

> [!div class="nextstepaction"]
> [Добавление поставщиков удостоверений приложениям в Azure Active Directory B2C](add-identity-provider.md)