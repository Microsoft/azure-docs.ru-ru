---
title: Определение технического профиля SAML в пользовательской политике
titleSuffix: Azure AD B2C
description: Определение технического профиля SAML в настраиваемой политике в Azure Active Directory B2C.
services: active-directory-b2c
author: msmimart
manager: celestedg
ms.service: active-directory
ms.workload: identity
ms.topic: reference
ms.date: 12/01/2020
ms.author: mimart
ms.subservice: B2C
ms.openlocfilehash: 2f16de49518e334f2f5e679ce24e24a262a1e231
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "98674949"
---
# <a name="define-a-saml-identity-provider-technical-profile-in-an-azure-active-directory-b2c-custom-policy"></a>Определение технического профиля поставщика удостоверений SAML в настраиваемой политике Azure Active Directory B2C

[!INCLUDE [active-directory-b2c-advanced-audience-warning](../../includes/active-directory-b2c-advanced-audience-warning.md)]

Azure Active Directory B2C (Azure AD B2C) обеспечивает поддержку для поставщика удостоверений SAML 2,0. В этой статье описаны особенности технического профиля для взаимодействия с поставщиком утверждений, который поддерживает этот стандартизированный протокол. С помощью технического профиля SAML можно создавать федерацию с поставщиком удостоверений на основе SAML, например [ADFS](./identity-provider-adfs.md) и [Salesforce](identity-provider-salesforce-saml.md). Она позволяет пользователям выполнять вход с использованием их удостоверений для социальных сетей или корпоративных удостоверений.

## <a name="metadata-exchange"></a>Обмен метаданными

Метаданные — это сведения, используемые в протоколе SAML для предоставления конфигурации стороны SAML, например поставщика услуг или поставщика удостоверений. Метаданные определяют расположение служб, например вход и выход, сертификаты, метод входа и многое другое. Поставщик удостоверений использует метаданные, чтобы узнать, как взаимодействовать с Azure AD B2C. Метаданные настраиваются в формате XML и могут быть подписаны с помощью цифровой подписи, чтобы другая сторона могла проверить их целостность. Когда служба Azure AD B2C создает федерацию с поставщиком удостоверений SAML, она выступает в качестве поставщика услуг, инициируя запрос SAML и ожидая ответ SAML. Кроме того, в некоторых случаях она принимает незапрашиваемую аутентификацию SAML, которая также называется инициированной поставщиком удостоверений.

Метаданные можно настроить у обеих сторон как "Статические метаданные" или "Динамические метаданные". В статическом режиме все метаданные копируются у одной стороны и настраиваются у другой. В динамическом режиме для метаданных задается URL-адрес, в то время как другая сторона считывает конфигурацию динамически. Принципы те же: вы задаете метаданные технического профиля Azure AD B2C у поставщика удостоверений и задаете метаданные поставщика удостоверений в Azure AD B2C.

В каждом поставщике удостоверений SAML предусмотрены разные действия для предоставления и настройки поставщика услуг (в данном случае Azure AD B2C), а также настройки метаданных Azure AD B2C в поставщике удостоверений. Рекомендации о том, как это сделать, см. в документации поставщика удостоверений.

В указанном ниже примере показан URL-адрес метаданных SAML, связанных с техническим профилем Azure AD B2C.

```
https://your-tenant-name.b2clogin.com/your-tenant-name/your-policy/samlp/metadata?idptp=your-technical-profile
```

Измените следующие значения:

- **your-tenant-name** — именем клиента, например fabrikam.b2clogin.com.
- **your-policy** — именем собственной политики. Используйте политику с настроенным техническим профилем поставщика SAML или политику, которая от нее наследуется.
- **ваш технический** профиль поставщика удостоверений SAML.

## <a name="digital-signing-certificates-exchange"></a>Обмен сертификатами для цифровой подписи

Чтобы создать отношение доверия между Azure AD B2C и поставщиком удостоверений SAML, необходимо указать допустимый сертификат X509 с закрытым ключом. Отправьте сертификат с закрытым ключом (PFX-файл) в хранилище ключей политики Azure AD B2C. Azure AD B2C подписывает запрос на вход SAML с использованием предоставленного вами сертификата.

Сертификат используется в следующих случаях.

- Azure AD B2C создает и подписывает запрос SAML, используя закрытый ключ Azure AD B2C сертификата. Запрос SAML отправляется поставщику удостоверений, который проверяет запрос с помощью открытого ключа Azure AD B2C сертификата. Получить доступ к открытому сертификату Azure AD B2C можно с помощью метаданных технического профиля. Кроме того, можно вручную отправить CER-файл поставщику удостоверений SAML.
- Поставщик удостоверений подписывает данные, отправляемые в Azure AD B2C, с помощью закрытого ключа поставщика удостоверений сертификата. Azure AD B2C проверяет данные, используя открытый сертификат поставщика удостоверений. В каждом поставщике удостоверений предусмотрены разные действия по настройке. Рекомендации о том, как это сделать, см. в документации к поставщикам удостоверений. В Azure AD B2C политике требуется доступ к открытому ключу сертификата с использованием метаданных поставщика удостоверений.

Самозаверяющий сертификат приемлем для большинства сценариев. В рабочей среде рекомендуется использовать сертификат X509, выданный центром сертификации. Кроме того, как описано далее в этом документе, для нерабочей среды можно отключить подписывание SAML на обеих сторонах.

На следующей схеме показан обмен метаданными и сертификатами:

![обмен метаданными и сертификатами](media/saml-technical-profile/technical-profile-idp-saml-metadata.png)

## <a name="digital-encryption"></a>Цифровое шифрование

Чтобы зашифровать утверждение ответа SAML, поставщик удостоверений всегда использует открытый ключ сертификата шифрования в техническом профиле Azure AD B2C. Когда службе Azure AD B2C необходимо расшифровать данные, она использует закрытую часть сертификата шифрования.

Шифрование утверждения ответа SAML:

1. Отправьте допустимый сертификат X509 с закрытым ключом (PFX-файл) в хранилище ключей политики Azure AD B2C.
2. Добавьте элемент **CryptographicKey** с идентификатором `SamlAssertionDecryption` в коллекцию **CryptographicKeys** технического профиля. Задайте для **StorageReferenceId** имя ключа политики, созданного на шаге 1.
3. Задайте для метаданных технического профиля **WantsEncryptedAssertions** значение `true`.
4. Добавьте в поставщик удостоверений новые метаданные технического профиля Azure AD B2C. В параметре **KeyDescriptor** свойству **use** должно быть присвоено значение `encryption`, содержащее открытый ключ сертификата.

В следующем примере показан раздел дескриптора ключа метаданных SAML, используемый для шифрования:

```xml
<KeyDescriptor use="encryption">
  <KeyInfo xmlns="https://www.w3.org/2000/09/xmldsig#">
    <X509Data>
      <X509Certificate>valid certificate</X509Certificate>
    </X509Data>
  </KeyInfo>
</KeyDescriptor>
```

## <a name="protocol"></a>Протокол

Атрибуту **Name** элемента Protocol необходимо присвоить значение `SAML2`.

## <a name="input-claims"></a>Входящие утверждения

Элемент **inputclaim** используется для отправки **NameId** внутри **субъекта** запроса SAML AuthN. Для этого добавьте входящее утверждение с параметром **партнерклаимтипе** , `subject` как показано ниже.

```xml
<InputClaims>
    <InputClaim ClaimTypeReferenceId="issuerUserId" PartnerClaimType="subject" />
</InputClaims>
```

## <a name="output-claims"></a>Исходящие утверждения

Элемент **OutputClaims** содержит список утверждений, возвращаемых поставщиком удостоверений SAML, в разделе `AttributeStatement`. Возможно, потребуется сопоставить имя утверждения, определенное в вашей политике, с именем, определенным у поставщика удостоверений. Вы также можете добавить утверждения, которые не возвращаются поставщиком удостоверений, установив атрибут `DefaultValue`.

### <a name="subject-name-output-claim"></a>Выходное утверждение имени субъекта

Чтобы считать утверждение SAML **NameId** в поле **subject** как нормализованное утверждение, задайте для утверждения **партнерклаимтипе** значение `SPNameQualifier` атрибута. Если `SPNameQualifier` атрибут не представлен, установите для утверждения **партнерклаимтипе** значение `NameQualifier` атрибута. 


Утверждение SAML: 

```xml
<saml:Subject>
  <saml:NameID SPNameQualifier="http://your-idp.com/unique-identifier" Format="urn:oasis:names:tc:SAML:2.0:nameid-format:transient">david@contoso.com</saml:NameID>
  <SubjectConfirmation Method="urn:oasis:names:tc:SAML:2.0:cm:bearer">
    <SubjectConfirmationData InResponseTo="_cd37c3f2-6875-4308-a9db-ce2cf187f4d1" NotOnOrAfter="2020-02-15T16:23:23.137Z" Recipient="https://your-tenant.b2clogin.com/your-tenant.onmicrosoft.com/B2C_1A_TrustFrameworkBase/samlp/sso/assertionconsumer" />
    </SubjectConfirmation>
  </saml:SubjectConfirmation>
</saml:Subject>
```

Исходящее утверждение:

```xml
<OutputClaim ClaimTypeReferenceId="issuerUserId" PartnerClaimType="http://your-idp.com/unique-identifier" />
```

Если `SPNameQualifier` атрибуты или `NameQualifier` не представлены в утверждении SAML, задайте для утверждения **партнерклаимтипе** значение `assertionSubjectName` . Убедитесь, что **NameId** является первым значением в XML утверждения. При определении нескольких утверждений Azure AD B2C выбирает значения субъекта из последнего утверждения.

В следующем примере показаны утверждения, возвращенные поставщиком удостоверений SAML:

- Утверждение **issuerUserId** сопоставляется с утверждением **ассертионсубжектнаме** .
- Утверждение **first_name** сопоставляется с утверждением **givenName**.
- Утверждение **last_name** сопоставляется с утверждением **surname**.
- Утверждение **DisplayName** сопоставляется с утверждением **имени** .
- Утверждение **email** не сопоставляется с именем.

Технический профиль также возвращает утверждения, которые не возвращаются поставщиком удостоверений:

- Утверждение **IdentityProvider**, содержащее имя поставщика удостоверений.
- утверждение **AuthenticationSource** со значением по умолчанию **socialIdpAuthentication**.

```xml
<OutputClaims>
  <OutputClaim ClaimTypeReferenceId="issuerUserId" PartnerClaimType="assertionSubjectName" />
  <OutputClaim ClaimTypeReferenceId="givenName" PartnerClaimType="first_name" />
  <OutputClaim ClaimTypeReferenceId="surname" PartnerClaimType="last_name" />
  <OutputClaim ClaimTypeReferenceId="displayName" PartnerClaimType="name" />
  <OutputClaim ClaimTypeReferenceId="email"  />
  <OutputClaim ClaimTypeReferenceId="identityProvider" DefaultValue="contoso.com" />
  <OutputClaim ClaimTypeReferenceId="authenticationSource" DefaultValue="socialIdpAuthentication" />
</OutputClaims>
```

Элемент **OutputClaimsTransformations** может содержать коллекцию элементов **OutputClaimsTransformation**, которые используются для изменения исходящих утверждений или создания новых.

## <a name="metadata"></a>Метаданные

| attribute | Обязательно | Описание |
| --------- | -------- | ----------- |
| PartnerEntity | Да | URL-адрес метаданных поставщика удостоверений SAML. Скопируйте метаданные поставщика удостоверений и добавьте их в элемент CDATA `<![CDATA[Your IDP metadata]]>` |
| WantsSignedRequests | Нет | Указывает, требуется ли для технического профиля, чтобы все исходящие запросы аутентификации были подписаны. Возможные значения: `true` или `false`. Значение по умолчанию — `true`. Если присвоено значение `true`, криптографический ключ **SamlMessageSigning** должен быть указан и все исходящие запросы аутентификации должны быть подписаны. Если присвоено значение `false`, параметры **SigAlg** и **Signature** (строка запроса или параметр отправки) не включаются в запрос. Эти метаданные также определяют атрибут **AuthnRequestsSigned** метаданных, который представляет собой выходные данные в метаданных технического профиля Azure AD B2C, совместно используемого с поставщиком удостоверений. Azure AD B2C не подписывает запрос, если параметр **вантссигнедрекуестс** в метаданных технического профиля имеет значение `false` , а **вантауснрекуестссигнед** метаданных поставщика удостоверений имеет значение `false` или не указано. |
| XmlSignatureAlgorithm | Нет | Метод, который Azure AD B2C использует для подписывания запроса SAML. Эти метаданные определяют значение параметра **SigAlg** (строка запроса или параметр отправки) в запросе SAML. Возможные значения: `Sha256` , `Sha384` , `Sha512` или `Sha1` (по умолчанию). Настройте алгоритм подписи на обеих сторонах, используя одно и то же значение. Используйте только тот алгоритм, который поддерживается вашим сертификатом. |
| WantsSignedAssertions | Нет | Указывает, требуется ли для технического профиля, чтобы все входящие утверждения были подписаны. Возможные значения: `true` или `false`. Значение по умолчанию — `true`. Если присвоено значение `true`, весь раздел утверждений `saml:Assertion`, отправленный поставщиком удостоверений в Azure AD B2C, должен быть подписан. Если присвоено значение `false`, поставщик удостоверений не должен подписывать утверждения, но даже если он подпишет, Azure AD B2C не проверит его подпись. Эти метаданные также определяют флаг **WantsAssertionsSigned** метаданных, который представляет собой выходные данные в метаданных технического профиля Azure AD B2C, совместно используемого с поставщиком удостоверений. Если отключить проверку утверждений, также может понадобиться отключить проверку подписи ответа (дополнительные сведения см. в разделе **ResponsesSigned**). |
| ResponsesSigned | Нет | Возможные значения: `true` или `false`. Значение по умолчанию — `true`. Если присвоено значение `false`, поставщик удостоверений не должен подписывать ответ SAML, но даже если он подпишет, Azure AD B2C не проверит его подпись. Если присвоено значение `true`, ответ SAML, отправляемый поставщиком удостоверений в Azure AD B2C, подписан и должен быть проверен. Если отключить проверку ответов SAML, также может понадобиться отключить проверку подписи утверждений (дополнительные сведения см. в разделе **WantsSignedAssertions**). |
| WantsEncryptedAssertions | Нет | Указывает, требуется ли для технического профиля, чтобы все входящие утверждения были зашифрованы. Возможные значения: `true` или `false`. Значение по умолчанию — `false`. Если присвоено значение `true`, утверждения, отправляемые поставщиком удостоверений в Azure AD B2C, должны быть подписаны, а также необходимо указать криптографический ключ **SamlAssertionDecryption**. Если присвоено значение `true`, метаданные технического профиля Azure AD B2C включают в себя раздел **encryption**. Поставщик удостоверений считывает метаданные и шифрует утверждение ответа SAML с помощью открытого ключа, указанного в метаданных технического профиля Azure AD B2C. Если включить шифрование утверждений, также может понадобиться отключить проверку подписи ответа (дополнительные сведения см. в разделе **ResponsesSigned**). |
| NameIdPolicyFormat | Нет | Задает ограничения для идентификатора имени, который будет использоваться для представления запрашиваемого субъекта. Если не указан, для запрашиваемого субъекта можно использовать любой тип идентификатора, поддерживаемый поставщиком удостоверений. Например, `urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified`. **NameIdPolicyFormat** можно использовать с **NameIdPolicyAllowCreate**. Сведения о поддерживаемых политиках идентификаторов имен см. в документации к поставщику удостоверений. |
| NameIdPolicyAllowCreate | Нет | При использовании **NameIdPolicyFormat** можно также указать свойство `AllowCreate` атрибута **NameIDPolicy**. Значение этих метаданных (`true` или `false`) указывает, разрешено ли поставщику удостоверений создавать учетную запись в процессе входа. Рекомендации о том, как это сделать, см. в документации поставщика удостоверений. |
| AuthenticationRequestExtensions | Нет | Необязательные элементы расширения сообщений протокола, согласованные между Azure AD BC и поставщиком удостоверений. Расширение представлено в формате XML. Данные XML добавляются внутри `<![CDATA[Your IDP metadata]]>` элемента CDATA. Сведения о поддержке элемента расширений см. в документации к поставщику удостоверений. |
| IncludeAuthnContextClassReferences | Нет | Указывает одну ссылку URI или несколько, определяющих классы контекста проверки подлинности. Например, чтобы разрешить пользователю выполнять вход с использованием только имени пользователя и пароля, задайте значение `urn:oasis:names:tc:SAML:2.0:ac:classes:Password`. Чтобы разрешить вход с использованием имени пользователя и пароля через защищенный сеанс (SSL/TLS), укажите `PasswordProtectedTransport`. Сведения о поддерживаемых URI **AuthnContextClassRef** см. в документации к поставщику удостоверений. Укажите несколько URI в качестве списка с разделителями-запятыми. |
| IncludeKeyInfo | Нет | Указывает, содержит ли запрос на проверку подлинности SAML открытый ключ сертификата, если привязка имеет значение `HTTP-POST`. Возможные значения: `true` или `false`. |
| инклудеклаимресолвингинклаимшандлинг  | Нет | Для входных и выходных утверждений указывает, включено ли [разрешение утверждений](claim-resolver-overview.md) в технический профиль. Возможные значения: `true` или `false` (по умолчанию). Если вы хотите использовать сопоставитель утверждений в техническом профиле, задайте для этого параметра значение `true` . |
|синглелогаутенаблед| Нет| Указывает, будет ли при входе в технический профиль попытаться выйти из федеративных поставщиков удостоверений. Дополнительные сведения см. в разделе [Azure AD B2C выхода из сеанса](session-behavior.md#sign-out).  Возможные значения: `true` (по умолчанию) или `false` .|

## <a name="cryptographic-keys"></a>Криптографические ключи

Элемент **криптографиккэйс** содержит следующие атрибуты:

| Атрибут |Обязательно | Описание |
| --------- | ----------- | ----------- |
| SamlMessageSigning |Да | Сертификат X509 (набор ключей RSA), используемый для подписывания сообщений SAML. Azure AD B2C использует этот ключ для подписывания запросов и отправки их поставщику удостоверений. |
| SamlAssertionDecryption |Нет | Сертификат X509 (набор ключей RSA). Поставщик удостоверений SAML использует открытую часть сертификата для шифрования утверждения ответа SAML. Azure AD B2C использует частную часть сертификата для расшифровки утверждения. |
| MetadataSigning |Нет | Сертификат X509 (набор ключей RSA), используемый для подписывания метаданных SAML. Azure AD B2C использует этот ключ для подписывания метаданных.  |

## <a name="saml-entityid-customization"></a>Настройка entityID для SAML

При наличии нескольких приложений SAML, зависящих от разных значений entityID, можно переопределить `issueruri` значение в файле проверяющей стороны. Для этого скопируйте технический профиль с ИДЕНТИФИКАТОРом "Saml2AssertionIssuer" из базового файла и переопределите `issueruri` значение.

> [!TIP]
> Скопируйте `<ClaimsProviders>` раздел из базы данных и сохраните эти элементы в поставщике утверждений: `<DisplayName>Token Issuer</DisplayName>` , `<TechnicalProfile Id="Saml2AssertionIssuer">` и `<DisplayName>Token Issuer</DisplayName>` .
 
Пример

```xml
   <ClaimsProviders>   
    <ClaimsProvider>
      <DisplayName>Token Issuer</DisplayName>
      <TechnicalProfiles>
        <TechnicalProfile Id="Saml2AssertionIssuer">
          <DisplayName>Token Issuer</DisplayName>
          <Metadata>
            <Item Key="IssuerUri">customURI</Item>
          </Metadata>
        </TechnicalProfile>
      </TechnicalProfiles>
    </ClaimsProvider>
  </ClaimsProviders>
  <RelyingParty>
    <DefaultUserJourney ReferenceId="SignUpInSAML" />
    <TechnicalProfile Id="PolicyProfile">
      <DisplayName>PolicyProfile</DisplayName>
      <Protocol Name="SAML2" />
      <Metadata>
     …
```

## <a name="next-steps"></a>Дальнейшие действия

Примеры работы с поставщиками удостоверений SAML в Azure AD B2C см. в следующих статьях:

- [Добавление ADFS в качестве поставщика удостоверений SAML с помощью пользовательских политик в Azure Active Directory B2C](identity-provider-adfs.md)
- [Azure Active Directory B2C. Выполнение входа с помощью учетных записей Salesforce через SAML](identity-provider-salesforce-saml.md)