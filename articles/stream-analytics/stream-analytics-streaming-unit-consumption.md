---
title: Единицы потоковой передачи в Azure Stream Analytics
description: В этой статье описывается настройка единиц потоковой передачи и другие факторы, влияющие на производительность в Azure Stream Analytics.
author: JSeb225
ms.author: jeanb
ms.service: stream-analytics
ms.topic: conceptual
ms.date: 08/28/2020
ms.openlocfilehash: a5a0e6feba966d2d10c5cd36432c3d5db172a795
ms.sourcegitcommit: 42a4d0e8fa84609bec0f6c241abe1c20036b9575
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "98020015"
---
# <a name="understand-and-adjust-streaming-units"></a>Обзор и настройка единиц потоковой передачи

Единицы потоковой передачи (SUs) представляют вычислительные ресурсы, выделенные для выполнения задания Stream Analytics. Чем больше число единиц потоковой передачи, тем больше выделяются дополнительные ресурсы ЦП и памяти для задания. Эта способность позволяет сосредоточиться на логике запросов и устраняет необходимость управления оборудованием для своевременного выполнения задания Stream Analytics.

Для обеспечения потоковой обработки с низкой задержкой все процессы Azure Stream Analytics происходят во временной памяти. При нехватке памяти выполнение потокового задания завершается с ошибкой. Поэтому для рабочего задания важно контролировать использование ресурсов потокового задания и следить за тем, чтобы было выделено достаточное количество ресурсов для непрерывного выполнения заданий в режиме 24/7.

Показатель использования единиц потоковой передачи (%), который колеблется от 0 до 100 %, описывает потребление памяти рабочей нагрузки. Для потокового задания с минимальным объемом памяти использование единиц потоковой передачи обычно составляет от 10 до 20 %. Если интенсивность использования SU% (выше 80%) или события ввода регистрируются в журнале (даже с низкой загрузкой от SU%, так как она не показывает загрузку ЦП), скорее всего, для рабочей нагрузки требуется больше вычислительных ресурсов, что требует увеличения числа серверов. Вы можете использовать метрику SU ниже 80%, чтобы учитывать случайные пики. Чтобы реагировать на повышенные рабочие нагрузки и увеличить количество единиц потоковой передачи, рассмотрите возможность установки предупреждения 80% для метрики использования SU. Кроме того, вы можете использовать показатели задержки водяного знака и события невыполненной работы, чтобы проверить, не окажется ли воздействие.

## <a name="configure-stream-analytics-streaming-units-sus"></a>Настройка единиц потоковой передачи Stream Analytics
1. Войдите на [портал Azure](https://portal.azure.com/).

2. В списке ресурсов найдите задание Stream Analytics для масштабирования и откройте его. 

3. На странице задания под заголовком **Настройка** выберите **Масштаб**. При создании задания количество по умолчанию для SUs равно 3.

    ![Настройка задания Stream Analytics на портале Azure][img.stream.analytics.preview.portal.settings.scale]
    
4. Используйте ползунок, чтобы задать количество единиц потоковой передачи для задания. Обратите внимание, что существуют определенные ограничения параметров единиц потоковой передачи. 
5. Вы можете изменить число назначенных для задания служб, даже если оно выполняется. Это невозможно, если в задании используются [несекционированные выходные данные](./stream-analytics-parallelization.md#query-using-non-partitioned-output) или имеется [многошаговый запрос с разными значениями секций](./stream-analytics-parallelization.md#multi-step-query-with-different-partition-by-values). При выполнении задания может быть ограничен выбор из набора значений SU. 

## <a name="monitor-job-performance"></a>Мониторинг производительности задания
На портале Azure можно отслеживать пропускную способность задания:

![Отслеживание заданий Azure Stream Analytics][img.stream.analytics.monitor.job]

Рассчитайте ожидаемую пропускную способность рабочей нагрузки. Если пропускная способность меньше, чем ожидалось, настройте входную секцию и запрос, а также добавьте в задание дополнительные единицы потоковой передачи.

## <a name="how-many-sus-are-required-for-a-job"></a>Сколько единиц потоковой передачи требуется для задания?

Выбор числа единиц потоковой передачи, требуемых для конкретного задания, зависит от конфигурации входных данных и запроса, определенного в задании. В колонке **Масштаб** можно задать требуемое число единиц потоковой передачи. Мы рекомендуем выделять больше единиц потоковой передачи, чем требуется. Модуль обработки Stream Analytics оптимизирует задержки и пропускную способность за счет выделения дополнительной памяти.

В общем лучше всего начать с 6 единиц потоковой передачи для запросов, не использующих **PARTITION BY**. Затем определите "золотую середину", используя метод проб и ошибок, при котором вы изменяете число единиц потоковой передачи после передачи репрезентативного объема данных и просмотра метрики процента использования единицы потоковой передачи. Максимальное количество единиц потоковой передачи, которое может использовать задание Stream Analytics, зависит от количества шагов в запросе, определенном для задания и количества разделов на каждом шаге. Дополнительные сведения об ограничениях см. [здесь](./stream-analytics-parallelization.md#calculate-the-maximum-streaming-units-of-a-job).

Дополнительные сведения о выборе оптимального числа единиц потоковой передачи см. в статье [Масштабирование заданий Azure Stream Analytics для повышения пропускной способности](stream-analytics-scale-jobs.md).

> [!Note]
> Выбор необходимого количества единиц потоковой передачи для конкретного задания зависит от конфигурации секции для входных данных и запроса, определенного для задания. Вы можете выбрать для задания количество единиц потоковой передачи согласно указанной квоте. По умолчанию каждая подписка Azure имеет квоту до 500 SUs для всех заданий аналитики в определенном регионе. Чтобы увеличить количество единиц потоковой передачи для своей подписки, свяжитесь со [службой технической поддержки Майкрософт](https://support.microsoft.com). Для задания допустимые значения количества начинаются с 1, 3, 6 и затем по возрастающей с шагом в 6.

## <a name="factors-that-increase-su-utilization"></a>Факторы, повышающие процент использования единиц потоковой передачи 

Элементы темпорального запроса (ориентированные на время) являются основным набором операторов с отслеживанием состояния, которые предоставляет Stream Analytics. Stream Analytics контролирует состояние этих операций изнутри от имени пользователя, управляя уровнем потребления памяти, контрольными точками для обеспечения устойчивости и восстановлением состояния во время обновления. Несмотря на то что Stream Analytics полностью управляет состоянием, существует несколько рекомендаций, которые следует учитывать пользователям.

Обратите внимание на то, что задание со сложной логикой запроса может иметь высокий процент использования единиц потоковой передачи даже в том случае, если оно не получает входные события на постоянной основе. Это может произойти после внезапного пика в событиях ввода-вывода. При сложном запросе задание может продолжать хранить состояние в памяти.

Использование единиц хранения может внезапно упасть до 0 в течение короткого периода времени, прежде чем ожидаемый уровень будет восстановлен. Это происходит из-за временных ошибок или системных обновлений. Увеличение числа единиц потоковой передачи для задания может не снизить использование SU%, если запрос не является [полностью параллельным](./stream-analytics-parallelization.md).

При сравнении использования в течение определенного периода времени используйте [метрики частоты событий](stream-analytics-monitoring.md). Метрики Инпутевентс и Аутпутевентс показывают, сколько событий было прочитано и обработано. Существуют метрики, указывающие количество событий ошибок, например ошибки десериализации. При увеличении числа событий за единицу времени в большинстве случаев перенимается SU%.

## <a name="stateful-query-logic-in-temporal-elements"></a>Логика запроса с отслеживанием состояния во временных элементах
Одной из уникальных возможностей задания Azure Stream Analytics является выполнение обработки с учетом состояния, например агрегаты данных на основе периодов, темпоральные соединения и темпоральные аналитические функции. Каждый из этих операторов сохраняет сведения о состоянии. Максимальный период времени для этих элементов запроса составляет семь дней. 

Концепция временного окна представлена в следующих элементах запросов Stream Analytics.
1. Агрегаты данных на основе периодов (оператор группирования GROUP BY по "переворачивающимся", "прыгающим" и "скользящим" окнам).

2. Темпоральные соединения: функция JOIN с DATEDIFF.

3. Темпоральные аналитические функции: ISFIRST, LAST и LAG с LIMIT DURATION.

Следующие факторы влияют на объем памяти (элемент метрики единиц потоковой передачи), потребляемый заданиями Stream Analytics.

## <a name="windowed-aggregates"></a>Агрегаты данных на основе периодов
Объем потребляемой памяти (размер состояния) для агрегата данных на основе периодов не всегда прямо пропорционален периоду. На самом деле, потребляемая память пропорциональна кратности данных или количеству групп в каждом периоде.


Например, в следующем запросе число, связанное с `clusterid`, является кратностью запроса. 

   ```sql
   SELECT count(*)
   FROM input 
   GROUP BY  clusterid, tumblingwindow (minutes, 5)
   ```

Чтобы устранить проблемы, вызванные большим количеством элементов в предыдущем запросе, можно отправить события в концентратор событий, секционированные по `clusterid` , и выполнить масштабирование запроса, разрешив системе обрабатывать каждую входную секцию отдельно с помощью **Partition,** как показано в следующем примере:

   ```sql
   SELECT count(*) 
   FROM input PARTITION BY PartitionId
   GROUP BY PartitionId, clusterid, tumblingwindow (minutes, 5)
   ```

Секционированный запрос распределяется между несколькими узлами. В результате число значений `clusterid`, попадающих в каждый узел, уменьшается, тем самым уменьшая кратность группы по оператору. 

Разделы концентратора событий должны быть разделены с помощью ключа группирования, чтобы вам не нужно было выполнять шаг по уменьшению. Дополнительные сведения см. в статье [Что такое Центры событий?](../event-hubs/event-hubs-about.md) 

## <a name="temporal-joins"></a>Временные соединения
Потребляемая память (размер состояния) временного объединения пропорциональна количеству событий в темпоральной колебания комнате объединения, то есть скорости ввода событий, умноженной на размер комнаты колебания. Другими словами, память, потребляемая соединением, пропорциональна диапазону времени DateDiff, умноженному на среднюю частоту событий.

Число несопоставленных событий в соединении влияет на использование памяти для выполнения запроса. Следующий запрос ищет просмотры рекламы, которые привели к переходам:

   ```sql
   SELECT clicks.id
   FROM clicks 
   INNER JOIN impressions ON impressions.id = clicks.id AND DATEDIFF(hour, impressions, clicks) between 0 AND 10.
   ```

Например, возможно, рекламу просмотрело множество людей, но только некоторые щелкнули ее. При этом все события требуется хранить в рамках временного окна. Объем используемой памяти пропорционален размеру окна и частоте событий. 

Чтобы устранить эту проблему, отправьте события в концентратор событий, секционированный по ключам объединения (идентификатор в данном случае), и выполните масштабирование запроса, разрешив системе обрабатывать каждую входную секцию отдельно с помощью  **Partition,** как показано ниже.

   ```sql
   SELECT clicks.id
   FROM clicks PARTITION BY PartitionId
   INNER JOIN impressions PARTITION BY PartitionId 
   ON impression.PartitionId = clicks.PartitionId AND impressions.id = clicks.id AND DATEDIFF(hour, impressions, clicks) between 0 AND 10 
   ```

Секционированный запрос распределяется между несколькими узлами. В результате уменьшается не только число событий, поступающих на каждый узел, но и размер состояния, сохраненного в окне соединения. 

## <a name="temporal-analytic-functions"></a>Темпоральные аналитические функции
Потребляемая память (размер состояния) темпоральной аналитической функции пропорциональна частоте событий, умноженной на длительность. Память, потребляемая аналитическими функциями, не пропорциональна периоду, но пропорциональна количеству разделов в каждом периоде.

Решение аналогично решению для темпорального соединения. Вы можете развернуть запрос, используя **PARTITION BY**. 

## <a name="out-of-order-buffer"></a>Неупорядоченный буфер 
Пользователь может настроить размер неупорядоченного буфера на панели конфигурации упорядочения событий. Буфер используется для хранения входных данных в течение определенного периода и изменения их порядка. Размер буфера пропорционален частоте ввода событий, умноженной на размер неупорядоченного окна. Размер окна по умолчанию равен 0. 

Для устранения переполнения неупорядоченного буфера нужно развернуть запрос с помощью ключевого слова **PARTITION BY**. Секционированный запрос распределяется между несколькими узлами. В результате уменьшается не только число событий, поступающих на каждый узел, но и количество событий в каждом упорядоченном буфере. 

## <a name="input-partition-count"></a>Количество входящих разделов 
Для каждого входящего раздела входных данных задания предусмотрен буфер. Чем больше количество входных разделов, тем больше ресурсов потребляет задание. Для каждой единицы потоковой передачи Azure Stream Analytics может обработать примерно 1 МБ входных данных в секунду. Таким образом можно выполнить оптимизацию, сопоставив число единиц потоковой передачи Stream Analytics с числом разделов в концентраторе событий. 

Как правило, задания, настроенного с одной единицей потоковой передачи, достаточно для концентратора событий с двумя разделами (минимальное требование для концентратора событий). Если концентратор событий содержит большее число разделов, задание Stream Analytics потребляет больше ресурсов, но не всегда использует дополнительную пропускную способность, предоставляемую концентратором событий. 

Для задания с 6 единицами потоковой передачи может понадобиться 4 или 8 разделов из концентратора событий. Однако избегайте создания слишком большого количества ненужных разделов, так как это приводит к чрезмерному использованию ресурсов. Например, концентратор событий с 16 разделами (и больше) в задании Stream Analytics с 1 единицей потоковой передачи. 

## <a name="reference-data"></a>Ссылочные данные 
Ссылочные данные в ASA загружаются в память для быстрого поиска. В текущей реализации для каждой операции соединения со ссылочными данными их копия сохраняется в памяти даже при соединении с использованием одних ссылочных данных несколько раз. Для запросов, содержащих **PARTITION BY**, каждый раздел имеет копию ссылочных данных, поэтому разделы полностью разделены. Если вы несколько раз присоединяетесь к ссылочным данным с несколькими разделами, то из-за эффекта увеличения использование памяти может быстро вырасти.  

### <a name="use-of-udf-functions"></a>Использование определяемых пользователем функций
При добавлении определяемой пользователем функции Azure Stream Analytics загружает в память среду выполнения JavaScript. Это влияет на процент единиц потоковой передачи.

## <a name="next-steps"></a>Дальнейшие действия
* [Leverage query parallelization in Azure Stream Analytics](stream-analytics-parallelization.md) (Использование параллелизации запросов в Azure Stream Analytics)
* [Масштабирование заданий Azure Stream Analytics для повышения пропускной способности](stream-analytics-scale-jobs.md)

<!--Image references-->

[img.stream.analytics.monitor.job]: ./media/stream-analytics-scale-jobs/StreamAnalytics.job.monitor-NewPortal.png
[img.stream.analytics.configure.scale]: ./media/stream-analytics-scale-jobs/StreamAnalytics.configure.scale.png
[img.stream.analytics.perfgraph]: ./media/stream-analytics-scale-jobs/perf.png
[img.stream.analytics.streaming.units.scale]: ./media/stream-analytics-scale-jobs/StreamAnalyticsStreamingUnitsExample.jpg
[img.stream.analytics.preview.portal.settings.scale]: ./media/stream-analytics-scale-jobs/StreamAnalyticsPreviewPortalJobSettings-NewPortal.png
