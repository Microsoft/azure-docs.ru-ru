---
title: Масштабирование функций Машинное обучение Studio (классическая модель) в Azure Stream Analytics
description: В этой статье описывается масштабирование Stream Analytics заданий, использующих функции Машинное обучение Studio (классическая модель), путем настройки секционирования и единиц потоковой передачи.
author: jseb225
ms.author: jeanb
ms.service: stream-analytics
ms.topic: how-to
ms.date: 01/15/2021
ms.openlocfilehash: 1ee1411aba7724d76ed8626de9b8b038d02339dc
ms.sourcegitcommit: 87a6587e1a0e242c2cfbbc51103e19ec47b49910
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/16/2021
ms.locfileid: "103574260"
---
# <a name="scale-your-stream-analytics-job-with-azure-machine-learning-studio-classic-functions"></a>Масштабирование заданий Stream Analytics с помощью функций Студии машинного обучения Azure (классической)

> [!TIP]
> Для повышения производительности и надежности настоятельно рекомендуется вместо UDF Студии машинного обучения Azure (классической) использовать [UDF машинного обучения Azure](machine-learning-udf.md).

В этой статье описывается эффективное масштабирование Azure Stream Analytics заданий, использующих функции Машинное обучение Azure Studio (классическая модель). Общие сведения о масштабировании заданий Stream Analytics см. в статье [Масштабирование заданий](stream-analytics-scale-jobs.md).

## <a name="what-is-a-studio-classic-function-in-stream-analytics"></a>Что такое функция Studio (классическая) в Stream Analytics?

Функцию Машинное обучение Studio (классическая модель) в Stream Analytics можно использовать как обычный вызов функции на языке Stream Analytics запросов. Однако в фоновом режиме эти вызовы функций фактически являются запросами веб-службы Studio (классические).

Вы можете повысить пропускную способность запросов веб-службы Studio (классической) путем пакетной обработки нескольких строк вместе в одном вызове API веб-службы. Такая группировка называется мини-пакетом. Дополнительные сведения см. в разделе [Веб-службы Студии машинного обучения Azure Studio (классической)](../machine-learning/classic/consume-web-services.md). Поддержка Studio (классической) в Stream Analytics.

## <a name="configure-a-stream-analytics-job-with-studio-classic-functions"></a>Настройка задания Stream Analytics с помощью функций студии (классическая модель)

Существует два параметра для настройки функции Studio (классической), используемой заданием Stream Analytics.

* Размер пакета для вызовов функции Studio (классическая модель).
* Количество единиц потоковой передачи (SU), подготовленных для задания Stream Analytics.

Чтобы определить необходимое количество SU, решите, что вы хотите оптимизировать — задержку задания Stream Analytics или пропускную способность каждой SU. К заданию всегда можно добавить SU для увеличения пропускной способности оптимально секционированного запроса Stream Analytics. Дополнительные SU увеличивают стоимость выполнения задания.

Определите *предельную* задержку для задания Stream Analytics. Увеличение размера пакета увеличит задержку запросов на Studio (классические) и задержку задания Stream Analytics.

Увеличение размера пакета позволяет задаче Stream Analytics обрабатывать **больше событий** с тем **же количеством** запросов веб-службы (классической). Увеличение задержки веб-службы Studio (классическая) обычно является линейным по отношению к увеличению размера пакета. 

Важно учитывать наиболее экономичный размер пакета для веб-службы Studio (классической) в любой конкретной ситуации. Размер пакета для запросов веб-служб по умолчанию — 1000. Размер по умолчанию можно изменить с помощью [REST API Stream Analytics](/previous-versions/azure/mt653706(v=azure.100) "REST API Stream Analytics") или [клиента PowerShell для Stream Analytics](stream-analytics-monitor-and-manage-jobs-use-powershell.md).

Определившись с размером пакета, вы сможете указать количество единиц потоковой передачи (SU) в зависимости от количества событий, которые функция должна обрабатывать в секунду. Дополнительные сведения о единицах потоковой передачи см. в статье [Масштабирование заданий Azure Stream Analytics для повышения пропускной способности базы данных](stream-analytics-scale-jobs.md).

Каждые 6 служб SUs получают 20 одновременных подключений к веб-службе Studio (классическая модель). При этом одно задание SU и 3 задания SU получают по 20 одновременных подключений.  

Если приложение создает 200 000 событий в секунду, а размер пакета — 1000, то задержка веб-службы составляет 200 мс. Эта скорость означает, что каждое подключение может выполнять пять запросов к веб-службе Studio (классическая) в каждую секунду. С 20 соединениями задание Stream Analytics может обрабатывать 20 000 событий за 200 мс и 100 000 событий в секунду.

Чтобы обрабатывать 200 000 событий в секунду, заданию Stream Analytics требуется 40 одновременных подключений, что соответствует 12 SU. На следующей диаграмме показаны запросы от задания Stream Analytics к конечной точке веб-службы Studio (классическая модель) — каждые 6 служб SUs с максимальным числом одновременных подключений к классической веб-службе (классическая).

![Масштабирование Stream Analytics с помощью функций Studio (классическая модель) два примера задания](./media/stream-analytics-scale-with-ml-functions/stream-analytics-scale-with-ml-functions-00.png "Масштабирование Stream Analytics с помощью функций Studio (классическая модель) два примера задания")

Как правило, ***B** _ для размера пакета, _*_L_*_ для задержки веб-службы в пакетной службе размером в миллисекундах, пропускная способность Stream Analyticsного задания с помощью _ *_N_** SUs:

![Формула масштабирования Stream Analytics с помощью функции Studio (классическая модель)](./media/stream-analytics-scale-with-ml-functions/stream-analytics-scale-with-ml-functions-02.png "Формула масштабирования Stream Analytics с помощью функции Studio (классическая модель)")

Можно также настроить "максимальное число одновременных вызовов" в веб-службе Studio (классической). Рекомендуется использовать для этого параметра максимальное значение (сейчас это 200).

Дополнительные сведения об этом параметре см. в [статье масштабирование для веб-служб машинное обучение Studio (классическая модель)](../machine-learning/classic/create-endpoint.md).

## <a name="example--sentiment-analysis"></a>Пример: анализ мнений
Следующий пример включает задание Stream Analytics с функцией тональности Analysis Studio (классическая модель), как описано в [руководстве по интеграции Stream Analytics машинное обучение Studio (классическая модель)](stream-analytics-machine-learning-integration-tutorial.md).

Запрос представляет собой простой полностью секционированный запрос, за которым следует функция **sentiment**, как показано в следующем примере:

```SQL
    WITH subquery AS (
        SELECT text, sentiment(text) as result from input
    )

    Select text, result.[Score]
    Into output
    From subquery
```

Рассмотрим конфигурацию, необходимую, чтобы создать задание Stream Analytics, выполняющее анализ тональности твитов со скоростью 10 000 твитов в секунду.

Достаточно ли 1 SU, чтобы это задание Stream Analytics могло обработать такой объем трафика? Задание должно справиться с входными данными, если использовать размер пакета по умолчанию (1000). Задержка по умолчанию веб-службы тональности Analysis Studio (классическая модель) (с размером пакета по умолчанию 1000) создает не более секунды задержки.

**Общая** (сквозная) задержка задания Stream Analytics обычно составляет несколько секунд. Более подробно Взгляните на это Stream Analytics задание, *особенно* в вызовах функций Studio (классическая модель). При размере пакета 1000 и пропускной способности 10 000 событий количество запросов к веб-службе составляет примерно 10. Даже при одной единице хранения количество одновременных подключений будет достаточным для обработки этого входящего трафика.

Но что делать, если частота входящих событий увеличится в 100 раз, а задание Stream Analytics должно обрабатывать 1 000 000 твитов в секунду? Выполнить увеличения масштаба можно двумя способами.

1. Увеличить размер пакета.
2. Секционировать входной поток для обработки событий в параллельном режиме.

Если выбрать первый вариант, то увеличится **задержка** задания.

Второй вариант заключается в подготовке дополнительных служб SUs для более параллельных запросов веб-служб Studio (классической). Увеличение числа SU приведет к повышению **стоимости** задания.

Рассмотрим масштабирование, используя для каждого размера пакета следующие значения задержки:

| Задержка | Размер пакета |
| --- | --- |
| 200 мс | Пакеты по 1000 или меньше событий |
| 250 мс | Пакеты по 5000 событий |
| 300 мс | Пакеты по 10 000 событий |
| 500 мс | Пакеты по 25 000 событий |

1. Использование первого варианта (**без** подготовки дополнительных единиц SU). Размер пакета можно увеличить до **25 000**. Таким образом, увеличение размера пакета позволит задаче обрабатывать 1 000 000 событий с 20 одновременными подключениями к веб-службе Studio (классической) (с задержкой 500 мс на вызов). Поэтому дополнительная задержка задания Stream Analytics из-за запроса функции тональности к запросам веб-службы Studio (классическая модель) будет увеличена с **200 мс** до **500 мс**. Однако размер пакета **не может** быть увеличен бесконечно, так как веб-службы Studio (классическая модель) требуют, чтобы размер полезных данных запроса был не менее 4 МБ, а время ожидания запросов веб-службы истекло через 100 секунд работы.
1. Если используется второй вариант, то размер пакета остается неизменным (1000) и при задержке веб-службы в 200 мс каждые 20 одновременных подключений к веб-службе смогут обрабатывать 1000 * 20 * 5 событий, то есть 100 000 событий в секунду. Таким образом, для обработки 1 000 000 событий в секунду заданию потребуется 60 SU. По сравнению с первым вариантом задание Stream Analytics будет создавать больше пакетных запросов к веб-службе, что приведет к увеличению затрат.

Ниже приведена таблица пропускной способности (количества событий в секунду) задания Stream Analytics для разного количества SU и размеров пакета.

| Размер пакета (задержка службы машинного обучения) | 500 (200 мс) | 1000 (200 мс) | 5000 (250 мс) | 10 000 (300 мс) | 25 000 (500 мс) |
| --- | --- | --- | --- | --- | --- |
| **1 единица хранения** |2500 |5 000 |20 000 |30 000 |50 000 |
| **3 единицы хранения** |2500 |5 000 |20 000 |30 000 |50 000 |
| **6 единиц хранения** |2500 |5 000 |20 000 |30 000 |50 000 |
| **12 единиц хранения** |5 000 |10 000 |40 000 |60 000 |100 000 |
| **18 единиц хранения** |7500 |15 000 |60 000 |90 000 |150 000 |
| **24 единицы хранения** |10 000 |20 000 |80 000 |120 000 |200 000 |
| **…** |… |… |… |… |… |
| **60 единиц хранения** |25 000 |50 000 |200 000 |300 000 |500 000 |

Теперь у вас уже должно быть хорошее понимание того, как функционируют функции Studio (классическая модель) в Stream Analytics. Скорее всего, вы также знаете, что задания Stream Analytics извлекают данные из источников данных и каждая операция извлечения возвращает пакет событий, которые обрабатывает задание Stream Analytics. Как эта модель извлечения влияет на запросы веб-службы Studio (классические)?

Как правило, размер пакета, заданный для функций Studio (классическая модель), не будет полностью кратен числу событий, возвращаемых каждым заданием Stream Analytics "Pull". В этом случае веб-служба Studio (классическая) вызывается с частичными пакетами. Применение частичных пакетов позволяет избежать дополнительных затрат на задержку задания при объединении событий из разных операций извлечения.

## <a name="new-function-related-monitoring-metrics"></a>Новые метрики мониторинга, связанные с функциями
В области мониторинга задания Stream Analytics добавлены три дополнительные метрики, связанные с функциями. Это **Запросы функций**, **События функций** и **Запросы функций со сбоем**, как показано на следующем рисунке.

![Масштабирование Stream Analytics с помощью функций Studio (классическая модель)](./media/stream-analytics-scale-with-ml-functions/stream-analytics-scale-with-ml-functions-01.png "Масштабирование Stream Analytics с помощью функций Studio (классическая модель)")

Вот их определения:

**ЗАПРОСЫ ФУНКЦИЙ**: количество запросов функций.

**СОБЫТИЯ ФУНКЦИЙ**: количество событий в запросах функций.

**НЕУДАЧНЫЕ ЗАПРОСЫ ФУНКЦИЙ**: количество неудачных запросов функций.

## <a name="key-takeaways"></a>Общие выводы

Чтобы масштабировать задание Stream Analytics с помощью функций Studio (классическая модель), учитывайте следующие факторы.

1. Частота входящих событий.
2. Допустимая задержка для выполняемого задания Stream Analytics (и, таким же, размера пакета запросов веб-службы Studio (классическая модель)).
3. Подготовленный Stream Analytics службы SUs и количество запросов веб-службы Studio (классические) (дополнительные затраты, связанные с функциями).

В качестве примера был использован полностью секционированный запрос Stream Analytics. Если требуется более сложный запрос, посетите [страницу ответов Майкрософт на вопросы об Azure Stream Analytics](/answers/topics/azure-stream-analytics.html). Это превосходный ресурс, на котором можно получить дополнительные сведения от разработчиков Stream Analytics.

## <a name="next-steps"></a>Дальнейшие действия
Дополнительные сведения о службе Stream Analytics см. в следующих статьях:

* [Приступая к работе с Azure Stream Analytics](stream-analytics-real-time-fraud-detection.md)
* [Масштабирование заданий в службе Azure Stream Analytics](stream-analytics-scale-jobs.md)
* [Справочник по языку запросов Azure Stream Analytics](/stream-analytics-query/stream-analytics-query-language-reference)
* [Справочник по API-интерфейсу REST управления Stream Analytics](/rest/api/streamanalytics/)
