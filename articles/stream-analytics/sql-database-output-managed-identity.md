---
title: Использование управляемых удостоверений для доступа к базе данных SQL Azure или Azure синапсе Analytics — Azure Stream Analytics
description: В этой статье описывается, как использовать управляемые удостоверения для проверки подлинности задания Azure Stream Analytics в базе данных SQL Azure или на выходе Azure синапсе Analytics.
author: enkrumah
ms.author: ebnkruma
ms.service: stream-analytics
ms.topic: how-to
ms.date: 11/30/2020
ms.openlocfilehash: 4246ad48624eb0ca53fbe6bb747f02daa32119bf
ms.sourcegitcommit: ba676927b1a8acd7c30708144e201f63ce89021d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/07/2021
ms.locfileid: "102432457"
---
# <a name="use-managed-identities-to-access-azure-sql-database-or-azure-synapse-analytics-from-an-azure-stream-analytics-job-preview"></a>Использование управляемых удостоверений для доступа к базе данных SQL Azure или Azure синапсе Analytics из задания Azure Stream Analytics (Предварительная версия)

Azure Stream Analytics поддерживает [проверку подлинности управляемого удостоверения](../active-directory/managed-identities-azure-resources/overview.md) для базы данных SQL Azure и приемников вывода аналитики Azure синапсе. Управляемые удостоверения устраняют ограничения методов проверки подлинности на основе пользователя, например, необходимость повторной проверки подлинности в связи с изменением пароля или истечением срока действия пользовательского токена, которое происходит каждые 90 дней. При устранении необходимости в ручной проверке подлинности ваши развертывания Stream Analytics можно полностью автоматизировать.

Управляемое удостоверение — это зарегистрированное в Azure Active Directory управляемое приложение, представляющее данное задание Stream Analytics. Управляемое приложение используется для проверки подлинности в целевом ресурсе. В этой статье показано, как включить управляемое удостоверение для базы данных SQL Azure или выходные данные аналитики Azure синапсе для задания Stream Analytics с помощью портал Azure.

## <a name="overview"></a>Обзор

В этой статье приведены шаги, необходимые для подключения задания Stream Analytics к базе данных SQL Azure или пулу SQL Azure синапсе Analytics с использованием режима аутентификации с управляемым удостоверением. 

- Сначала создается управляемое системой удостоверение, назначенное для задания Stream Analytics. Это удостоверение задания в Azure Active Directory.  

- Добавьте администратора Active Directory в рабочую область SQL Server или синапсе, которая включает проверку подлинности Azure AD (управляемое удостоверение) для этого ресурса.

- Затем создайте автономного пользователя, представляющего удостоверение Stream Analytics задания в базе данных. Когда Stream Analyticsное задание взаимодействует с ресурсом базы данных SQL или базой данных SQL синапсе, это удостоверение, на которое он ссылается для проверки разрешений, назначенных заданию Stream Analytics.

- Предоставьте разрешения на Stream Analytics для задания доступа к базе данных SQL или пулам SQL синапсе.

- Наконец, добавьте базу данных SQL Azure или Azure синапсе Analytics в качестве выходных данных в задание Stream Analytics.

## <a name="prerequisites"></a>Предварительные требования

#### <a name="azure-sql-database"></a>[База данных SQL Azure](#tab/azure-sql)

Для использования этой функции необходимо следующее:

- Задание Azure Stream Analytics.

- Ресурс для Базы данных SQL Azure.

#### <a name="azure-synapse-analytics"></a>[Azure Synapse Analytics](#tab/azure-synapse)

Для использования этой функции необходимо следующее:

- Задание Azure Stream Analytics.

- Пул SQL Azure синапсе Analytics.

- Учетная запись хранения Azure, [настроенная для задания Stream Analytics](azure-synapse-analytics-output.md).

---

## <a name="create-a-managed-identity"></a>Создание управляемого удостоверения

Сначала вы создадите управляемое удостоверение для задания Azure Stream Analytics.

1. На [портале Azure](https://portal.azure.com) откройте задание Stream Analytics.

1. В меню навигации слева в разделе **Настройка** щелкните **Управляемое удостоверение**. Затем установите флажок **Использовать управляемое удостоверение, назначаемое системой** и нажмите кнопку **Сохранить**.

   ![Выбор управляемого удостоверения, назначаемого системой](./media/sql-db-output-managed-identity/system-assigned-managed-identity.png)

   Субъект-служба для удостоверения задания Stream Analytics создается в Azure Active Directory. Жизненным циклом нового удостоверения будет управлять Azure. При удалении задания Stream Analytics Azure автоматически удаляет связанное удостоверение (то есть субъект-службу).

1. Если конфигурация сохраняется, идентификатор объекта (OID) субъекта-службы отображается в качестве идентификатора субъекта, как показано ниже: 

   ![Идентификатор объекта, отображаемый в качестве идентификатора субъекта](./media/sql-db-output-managed-identity/principal-id.png)

   Субъект-служба имеет то же имя, что и задание Stream Analytics. Например, если имя задания — *MyASAJob*, имя созданного субъекта-службы будет также *MyASAJob*.

## <a name="select-an-active-directory-admin"></a>Выбор администратора Active Directory

После создания управляемого удостоверения необходимо выбрать администратора Active Directory.

1. Перейдите в базу данных SQL Azure или ресурс пула SQL Azure синапсе Analytics и выберите рабочую область SQL Server или синапсе, в которой находится ресурс, соответственно. Ссылку на них можно найти на странице Обзор ресурсов рядом с *именем сервера* или *рабочей области*.

1. Выберите **Active Directory администратор** или **SQL Active Directory администратор** в разделе **Параметры** для рабочей области SQL Server и синапсе соответственно. Затем выберите **Задать администратора**.

   ![Страница администрирования Active Directory](./media/sql-db-output-managed-identity/active-directory-admin-page.png)

1. На странице администрирования Active Directory выберите пользователя (или группу), чтобы назначить его администратором SQL Server, и нажмите кнопку **Выбрать**. Это будет пользователь, который сможет создать **пользователя автономной базы данных** в следующем разделе.

   ![Добавление администратора Active Directory](./media/sql-db-output-managed-identity/add-admin.png)

   На странице "Администратор Active Directory" отобразятся все участники и группы Active Directory. Недоступные для выбора пользователи или группы не могут быть выбраны, так как они не поддерживаются как администраторы Azure Active Directory. Список поддерживаемых администраторов см. в разделе **Azure Active Directory функции и ограничения**   статьи [использование проверки подлинности Azure Active Directory для проверки подлинности с помощью базы данных SQL или Azure синапсе](../azure-sql/database/authentication-aad-overview.md#azure-ad-features-and-limitations).

1. На странице **Администратор Active Directory** нажмите кнопку **Сохранить**. Процесс смены администратора занимает несколько минут.

## <a name="create-a-contained-database-user"></a>Создание пользователя автономной базы данных

Далее вы создадите пользователя автономной базы данных в базе данных SQL Azure или Azure синапсе, которая сопоставлена с удостоверением Azure Active Directory. У пользователя автономной базы данных нет имени входа для базы данных-источника, но оно сопоставляется с удостоверением в каталоге, связанном с базой данных. Удостоверением Azure AD может быть учетная запись отдельного пользователя или группы. В этом случае необходимо создать пользователя автономной базы данных для задания Stream Analytics. 

Дополнительные сведения см. в следующей статье для получения дополнительных сведений об интеграции Azure AD: [универсальной аутентификации с помощью базы данных SQL и Azure синапсе Analytics (поддержка SSMS для MFA)](../azure-sql/database/authentication-mfa-ssms-overview.md) .

1. Подключитесь к базе данных Azure SQL или Azure синапсе с помощью SQL Server Management Studio. В качестве **имени пользователя** укажите пользователь Azure Active Directory с разрешением **ALTER ANY USER**. Примером может быть администратор, заданный в SQL Server. Используйте универсальную проверку подлинности **Azure Active Directory с MFA**. 

   ![Подключение к SQL Server](./media/sql-db-output-managed-identity/connect-sql-server.png)

   Имя сервера `<SQL Server name>.database.windows.net` может отличаться в разных регионах. Например, в регионе Китая используйте `<SQL Server name>.database.chinacloudapi.cn`.
 
   Вы можете указать определенную базу данных SQL Azure или Azure синапсе, выбрав **параметры > свойства соединения > подключиться к базе данных**.  

   ![Свойства подключения SQL Server](./media/sql-db-output-managed-identity/sql-server-connection-properties.png)

1. При первом подключении может появиться следующее окно:

   ![Окно нового правила брандмауэра](./media/sql-db-output-managed-identity/new-firewall-rule.png)

   1. Если это так, перейдите к ресурсу рабочей области SQL Server/синапсе на портал Azure. В разделе **Безопасность** откройте страницу **брандмауэры и виртуальная сеть/брандмауэры** . 
   1. Добавьте новое правило с любым именем.
   1. Используйте IP-адрес *Из* в окне **Новое правило брандмауэра** для параметра *Начальный IP-адрес*.
   1. Используйте IP-адрес *К* в окне **Новое правило брандмауэра** для параметра *Конечный IP-адрес*. 
   1. Нажмите кнопку **Сохранить** и повторите попытку подключения из SQL Server Management Studio. 

1. После подключения создайте пользователя автономной базы данных. Следующая команда SQL создает пользователя автономной базы данных с тем же именем, что и у задания Stream Analytics. Не забудьте добавить квадратные скобки вокруг *ASA_JOB_NAME*. Используйте следующий синтаксис T-SQL и выполните запрос. 

   ```sql
   CREATE USER [ASA_JOB_NAME] FROM EXTERNAL PROVIDER; 
   ```
   
    Чтобы проверить, правильно ли добавлен пользователь автономной базы данных, выполните следующую команду в среде SSMS в относящейся к ней базе данных и проверьте, находится ли *ASA_JOB_NAME* в столбце "имя".

   ```sql
   SELECT * FROM <SQL_DB_NAME>.sys.database_principals 
   WHERE type_desc = 'EXTERNAL_USER' 
   ```

1. Чтобы с помощью Microsoft Azure Active Directory можно было проверить, имеет ли задание Stream Analytics доступ к базе данных SQL, необходимо предоставить Azure Active Directory разрешение на взаимодействие с базой данных. Для этого перейдите на страницу "брандмауэры и виртуальная сеть"/"брандмауэры" в портал Azure снова и включите "разрешить службам Azure и ресурсам доступ к этому серверу или рабочей области".

   ![Брандмауэр и виртуальная сеть](./media/sql-db-output-managed-identity/allow-access.png)

## <a name="grant-stream-analytics-job-permissions"></a>Предоставление разрешений заданию Stream Analytics

#### <a name="azure-sql-database"></a>[База данных SQL Azure](#tab/azure-sql)

После создания пользователя автономной базы данных и получения доступа к службам Azure на портале, как описано в предыдущем разделе, у задания Stream Analytics есть разрешение на **Подключение** к ресурсу базы данных SQL Azure через управляемое удостоверение с помощью управляемого удостоверения. Рекомендуется предоставить разрешения **SELECT** и **INSERT** для задания Stream Analytics, так как они понадобятся позже в рабочем процессе Stream Analytics. Разрешение **SELECT** позволяет заданию проверить подключение к таблице в базе данных SQL Azure. Разрешение **INSERT** позволяет проводить сквозное тестирование Stream Analytics запросов после настройки входных данных и выходного файла SQL Azure.

#### <a name="azure-synapse-analytics"></a>[Azure Synapse Analytics](#tab/azure-synapse)

После создания пользователя автономной базы данных и получения доступа к службам Azure на портале, как описано в предыдущем разделе, ваше задание Stream Analytics имеет разрешение от управляемого удостоверения для **подключения** к ресурсу базы данных Azure синапсе через управляемое удостоверение. Рекомендуется дополнительно предоставить заданиям Stream Analytics, **INSERT** и **АДМИНИСТРИРОВАТЬ групповые операции базы данных** **, так** как они понадобятся позже в рабочем процессе Stream Analytics. Разрешение **SELECT** позволяет заданию проверить подключение к таблице в базе данных синапсе Azure. Разрешения на **вставку** и **Администрирование для операций с массовыми базами данных** позволяют выполнять тестирование сквозных Stream Analytics запросов после настройки входных данных и выходного файла синапсе в Azure.

Чтобы предоставить разрешение на **Управление массовыми операциями базы данных** , необходимо предоставить всем разрешениям, которые помечены как **элементы управления** , [подразумеваемые разрешением базы данных](/sql/t-sql/statements/grant-database-permissions-transact-sql?view=azure-sqldw-latest&preserve-view=true#remarks) для задания Stream Analytics. Это разрешение необходимо, так как задание Stream Analytics выполняет инструкцию **Copy** , для которой требуется [Администрирование операций с массовыми БАЗАМИ данных и вставки](/sql/t-sql/statements/copy-into-transact-sql).

---

Эти разрешения можно предоставить заданию Stream Analytics с помощью среды SQL Server Management Studio. Дополнительные сведения см. в справочнике по работе с командой GRANT (Transact-SQL).

Чтобы предоставить разрешение только для определенной таблицы или объекта в базе данных, используйте следующий синтаксис T-SQL и выполните запрос. 

#### <a name="azure-sql-database"></a>[База данных SQL Azure](#tab/azure-sql)

```sql
GRANT CONNECT, SELECT, INSERT ON OBJECT::TABLE_NAME TO ASA_JOB_NAME;
```

#### <a name="azure-synapse-analytics"></a>[Azure Synapse Analytics](#tab/azure-synapse)

```sql
GRANT CONNECT, SELECT, INSERT, CONTROL, ADMINISTER DATABASE BULK OPERATIONS OBJECT::TABLE_NAME TO ASA_JOB_NAME;
```

---

Кроме того, можно щелкнуть правой кнопкой мыши базу данных SQL Azure или Azure синапсе в SQL Server Management Studio и выбрать **свойства > разрешения**. В меню разрешения можно просмотреть задание Stream Analytics, добавленное ранее, а затем по своему усмотрению вручную предоставить или отменить разрешения.

Чтобы просмотреть все разрешения, добавленные в *ASA_JOB_NAME* пользователя, выполните следующую команду в SSMS в относящейся базе данных: 

```sql
SELECT dprin.name, dbprin.type_desc, dbperm.permission_name, dbperm.state_desc, dbperm.class_desc, object_name(dbperm.major_id) 
FROM sys.database_principals dbprin 
LEFT JOIN sys.database_permissions dbperm 
ON dbperm.grantee_principal_id = dbprin.principal_id 
WHERE dbprin.name = '<ASA_JOB_NAME>' 
```

## <a name="create-an-azure-sql-database-or-azure-synapse-output"></a>Создание базы данных SQL Azure или Azure синапсе Output

#### <a name="azure-sql-database"></a>[База данных SQL Azure](#tab/azure-sql)

Теперь, когда вы настроили управляемое удостоверение, вы можете добавить в задание Stream Analytics базу данных SQL Azure или выходные данные Azure синапсе.

Таблицу в базе данных SQL необходимо создавать с соответствующей выходной схемой. Имя этой таблицы — одно из обязательных свойств, которые должны быть заполнены при добавлении выходных данных базы данных SQL в задание Stream Analytics. Кроме того, для проверки подключения и выполнения запросов Stream Analytics заданию необходимо предоставить разрешения **SELECT** и **INSERT**. Если вы еще не сделали этого, ознакомьтесь с разделом [Предоставление разрешений заданию Stream Analytics](#grant-stream-analytics-job-permissions). 

1. Вернитесь к заданию Stream Analytics и перейдите на страницу **Выходные данные** в разделе **Топология задания**. 

1. Щелкните **Добавить > База данных SQL**. В окне свойств выходных данных приемника Базы данных SQL выберите **Управляемое удостоверение** из раскрывающегося списка режима проверки подлинности.

1. Укажите остальные свойства. Дополнительные сведения о создании выходных данных для Базы данных SQL см. в разделе [База данных SQL](sql-database-output.md). По завершении нажмите кнопку **Сохранить**.

1. После нажатия кнопки **сохранить** проверка подключения к ресурсу должна автоматически активироваться. После успешного завершения вы успешно настроили задание Stream Analytics для подключения к базе данных SQL Azure или базе данных SQL синапсе с помощью режима проверки подлинности управляемого удостоверения. 

#### <a name="azure-synapse-analytics"></a>[Azure Synapse Analytics](#tab/azure-synapse)

Теперь, когда вы настроили управляемое удостоверение и учетную запись хранения, вы можете добавить в задание Stream Analytics базу данных SQL Azure или выходные данные Azure синапсе.

Убедитесь, что вы создали в базе данных Azure синапсе таблицу с соответствующей выходной схемой. Имя этой таблицы является одним из обязательных свойств, которые необходимо заполнить при добавлении выходных данных Azure синапсе в задание Stream Analytics. Кроме того, для проверки подключения и выполнения запросов Stream Analytics заданию необходимо предоставить разрешения **SELECT** и **INSERT**. Если вы еще не сделали этого, ознакомьтесь с разделом [Предоставление разрешений заданию Stream Analytics](#grant-stream-analytics-job-permissions).

1. Вернитесь к заданию Stream Analytics и перейдите на страницу **Выходные данные** в разделе **Топология задания**.

1. Выберите **добавить > Azure синапсе Analytics**. В окне свойств выходных данных приемника Базы данных SQL выберите **Управляемое удостоверение** из раскрывающегося списка режима проверки подлинности.

1. Укажите остальные свойства. Дополнительные сведения о создании выходных данных Azure синапсе см. в статье [Azure синапсе Analytics from Azure Stream Analytics](azure-synapse-analytics-output.md). По завершении нажмите кнопку **Сохранить**.

1. После нажатия кнопки **сохранить** проверка подключения к ресурсу должна автоматически активироваться. После успешного завершения вы можете продолжить использовать управляемое удостоверение для ресурса Azure синапсе Analytics с Stream Analytics. 

---

## <a name="remove-managed-identity"></a>Удалить управляемое удостоверение

Управляемое удостоверение, созданное для задания Stream Analytics, удаляется только при удалении задания. Невозможно удалить управляемое удостоверение, не удаляя задание. Если вы больше не хотите использовать управляемое удостоверение, можно изменить метод проверки подлинности для выходных данных. Управляемое удостоверение будет продолжать существовать до тех пор, пока задание не будет удалено, и будет использоваться при повторном использовании проверки подлинности с управляемым удостоверением.

## <a name="next-steps"></a>Дальнейшие действия

* [Описание выходных данных из Azure Stream Analytics](stream-analytics-define-outputs.md)
* [Вывод данных Azure Stream Analytics в базу данных SQL Azure](stream-analytics-sql-output-perf.md)
* [Выходные данные аналитики Azure синапсе из Azure Stream Analytics](azure-synapse-analytics-output.md)
