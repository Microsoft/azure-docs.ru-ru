---
title: Устранение неполадок Azure Stream Analytics с помощью журналов ресурсов
description: В этой статье описывается, как анализировать журналы ресурсов в Azure Stream Analytics.
author: jseb225
ms.author: jeanb
ms.service: stream-analytics
ms.topic: troubleshooting
ms.custom: contperf-fy21q1
ms.date: 06/18/2020
ms.openlocfilehash: 93d881419c4854b8e46608e150b55072267e0347
ms.sourcegitcommit: e559daa1f7115d703bfa1b87da1cf267bf6ae9e8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/17/2021
ms.locfileid: "100574410"
---
# <a name="troubleshoot-azure-stream-analytics-by-using-resource-logs"></a>Устранение неполадок в Azure Stream Analytics с помощью журналов ресурсов

В некоторых случаях обработка задания Azure Stream Analytics неожиданно прекращается. Очень важно иметь возможность устранения подобных проблем. Сбои могут случиться из-за непредвиденного результата запроса, подключения к устройствам или неожиданного сбоя службы. Журналы ресурсов в Stream Analytics могут помочь определить причину возникающих проблем и сократить время восстановления.

Настоятельно рекомендуется включить журналы ресурсов для всех заданий, так как это существенно поможет в отладке и мониторинге.

## <a name="log-types"></a>Типы журналов

Stream Analytics предоставляет журналы двух типов:

* [журналы действий](../azure-monitor/essentials/platform-logs-overview.md) (всегда включены), содержащие ценные сведения об операциях, выполняемых в заданиях;

* [Журналы ресурсов](../azure-monitor/essentials/platform-logs-overview.md) (настраиваемые), которые предоставляют подробные сведения обо всем, что происходит с заданием. Журналы ресурсов запускаются при создании задания и завершаются после удаления задания. Они фиксируют события при обновлении и выполнении задания.

> [!NOTE]
> Для анализа несоответствующих данных можно использовать такие службы, как служба хранилища Azure, концентраторы событий Azure и журналы Azure Monitor. Плата за использование служб взимается с учетом модели ценообразования.

[!INCLUDE [azure-monitor-log-analytics-rebrand](../../includes/azure-monitor-log-analytics-rebrand.md)]

## <a name="debugging-using-activity-logs"></a>Отладка с помощью журналов действий

Журналы действий включены по умолчанию и содержат аналитические сведения высокого уровня об операциях, выполняемых заданием Stream Analytics. Данные, находящиеся в журналах действий, могут помочь найти причину проблемы, влияющей на ваше задание. Выполните следующие действия, чтобы использовать журналы действий в Stream Analytics.

1. Войдите на портал Azure в разделе **Обзор** и выберите **Журнал действий**.

   ![Журнал действий Stream Analytics](./media/stream-analytics-job-diagnostic-logs/stream-analytics-menu.png)

2. Отобразится список выполненных операций. Рядом с любой операцией, которая вызвала сбой вашего задания, есть красный информационный пузырек.

3. Выберите операцию, чтобы увидеть представление сводки. Здесь информация часто ограничена. Чтобы получить дополнительные сведения об операции, выберите **JSON**.

   ![Сводка операции журнала действий Stream Analytics](./media/stream-analytics-job-diagnostic-logs/operation-summary.png)

4. Прокрутите вниз до раздела **Свойства** в JSON, который предоставляет сведения об ошибке, вызвавшей неудавшуюся операцию. В этом примере ошибка произошла из-за ошибки времени выполнения и превышения значений широты. Несоответствие данных, обрабатываемых Stream Analytics заданием, приводит к ошибке данных. Вы можете узнать о различных [ошибках входных и выходных данных и о том, почему они происходят](./data-errors.md).

   ![Сведения об ошибке JSON](./media/stream-analytics-job-diagnostic-logs/error-details.png)

5. Вы можете предпринять корректирующие действия, основываясь на сообщении ошибки в JSON. В этом примере в запрос необходимо добавить проверку значения широты в диапазоне от –90 до 90 градусов.

6. Если сообщение об ошибке в журналах действий не помогает выявить основную причину, включите журналы ресурсов и используйте журналы Azure Monitor.

## <a name="send-diagnostics-to-azure-monitor-logs"></a>Отправка диагностических сведений в журналы Azure Monitor

Настоятельно рекомендуется включить журналы ресурсов и отправить их в журналы Azure Monitor. По умолчанию они **отключены** . Чтобы включить их, выполните следующие действия.

1.  Создайте рабочую область Log Analytics, если она еще не создана. Рекомендуется, чтобы Рабочая область Log Analytics в том же регионе, что и задание Stream Analytics.

2.  Войдите на портал Azure и перейдите к заданию Stream Analytics. В разделе **Мониторинг** выберите **Журналы диагностики**. Затем выберите **Turn on diagnostics** (Включить диагностику).

    ![Навигация по колонкам в журналах ресурсов](./media/stream-analytics-job-diagnostic-logs/diagnostic-logs-monitoring.png)  

2.  Укажите **имя** в поле " **имя параметров диагностики** " и установите флажки для **выполнения** и **разработки** в разделе " **Журнал**" и **аллметрикс** в разделе " **Метрика**". Затем выберите **Отправить, чтобы log Analytics** и выбрать рабочую область. Выберите команду **Сохранить**.

    ![Параметры для журналов ресурсов](./media/stream-analytics-job-diagnostic-logs/logs-setup.png)

3. При запуске задания Stream Analytics журналы ресурсов направляются в рабочую область Log Analytics. Чтобы просмотреть журналы ресурсов для задания, выберите **журналы** в разделе **мониторинг** .

   ![На снимке экрана показано меню Общие с выбранными журналами.](./media/stream-analytics-job-diagnostic-logs/diagnostic-logs.png)

4. Stream Analytics предоставляет предварительно определенные запросы, которые позволяют легко находить нужные журналы. Можно выбрать все предварительно определенные запросы на левой панели, а затем нажать кнопку **выполнить**. Результаты запроса будут отображаться в нижней области. 

   ![На снимке экрана показаны журналы для задания Stream Analytics.](./media/stream-analytics-job-diagnostic-logs/logs-example.png)

## <a name="resource-log-categories"></a>Категории журналов ресурсов

Azure Stream Analytics захватывает две категории журналов ресурсов:

* **Создание**: фиксирует события журнала, связанные с операциями создания заданий, например создание задания, Добавление и удаление входных и выходных данных, Добавление и обновление запроса, а также запуск или остановка задания.

* **Выполнение**: фиксирует события, происходящие во время выполнения задания.
    * Ошибки подключения.
    * Ошибки обработки данных:
        * события, которые не соответствуют определению запроса (несовпадение типов полей и значений, отсутствие полей и т. п.);
        * ошибки оценки выражений.
    * Другие события и ошибки.

## <a name="resource-logs-schema"></a>Схема журналов ресурсов

Все журналы хранятся в формате JSON. Каждая запись содержит следующие общие строковые поля.

Имя | Описание
------- | -------
time | Метка времени журнала (в формате UTC).
resourceId | Идентификатор ресурса (прописными буквами), с которым была выполнена операция. Содержит идентификатор подписки, группу ресурсов и имя задания. Например, **/SUBSCRIPTIONS/6503D296-DAC1-4449-9B03-609A1F4A1C87/RESOURCEGROUPS/MY-RESOURCE-GROUP/PROVIDERS/MICROSOFT.STREAMANALYTICS/STREAMINGJOBS/MYSTREAMINGJOB**.
категория | Категория журнала, **Выполнение** или **Разработка**.
operationName | Имя операции, добавленной в журнал. Например, **Send Events: Ошибка записи выходных данных SQL в mysqloutput (**.
status | Состояние операции. Например, **Сбой** или **Успешно выполнено**.
уровень | Уровень ведения журнала. Например, **Ошибка**, **Предупреждение** или **Информация**.
properties | Сведения о записи журнала, сериализованные в строку JSON. Дополнительные сведения приведены в следующем разделе этой статьи.

### <a name="execution-log-properties-schema"></a>Схема свойств журнала выполнения

Журналы выполнения содержат сведения о событиях, произошедших при выполнении задания Stream Analytics. Схема свойств зависит от того, является ли событие ошибкой данных или универсальным событием.

### <a name="data-errors"></a>Ошибки данных

Любая ошибка, возникающая при обработке данных в задании, находится в этой категории журналов. Чаще всего эти журналы создаются во время операций чтения, сериализации и записи. Эти журналы не содержат ошибок подключения, которые обрабатываются как универсальные события. Вы можете узнать больше о причинах различных [ошибок ввода и вывода данных](./data-errors.md).

Имя | Описание
------- | -------
Источник | Имя входных или выходных данных задания, в которых произошла ошибка.
Сообщение | Сообщение, связанное с ошибкой.
Type | Тип ошибки. Например **DataConversionError**, **CsvParserError** или **ServiceBusPropertyColumnMissingError**.
Данные | Содержит данные, полезные для точного поиска источника ошибки. Значение может быть усечено в зависимости от размера.

В зависимости от значения **operationName** ошибки данных имеют следующую схему:

* **События сериализации** происходят во время операций чтения событий. если входные данные не соответствуют схеме запроса по одной из следующих причин:

   * *Несоответствие типов во время десериализации или сериализации события*: определяет поле, вызывающее ошибку.

   * *Не удается прочитать события, недопустимая сериализация*: содержит сведения о месте во входных данных, где произошла ошибка (имя входного большого двоичного объекта, смещение и примеры данных).

* **События отправки** происходят во время операций записи. Они определяют событие потоковой передачи, вызвавшее ошибку.

### <a name="generic-events"></a>Универсальные события

Остальные типы ошибок считаются универсальными событиями.

Имя | Описание
-------- | --------
Ошибка | (Необязательно.) Сведения об ошибке. Как правило, это сведения об исключении (если они доступны).
Сообщение| Сообщение журнала.
Type | Тип сообщения. Сопоставляется с внутренней классификацией ошибок. Например **JobValidationError** или **BlobOutputAdapterInitializationFailure**.
Идентификатор корреляции | Идентификатор GUID, однозначно определяющий выполнение задания. Все записи журнала, зафиксированные с начала до завершения задания, имеют одинаковое значение **идентификатора корреляции**.

## <a name="next-steps"></a>Дальнейшие шаги

* [Ошибки данных Stream Analytics](./data-errors.md)
* [Stream Analytics Query Language Reference](/stream-analytics-query/stream-analytics-query-language-reference) (Справочник по языку запросов Stream Analytics)