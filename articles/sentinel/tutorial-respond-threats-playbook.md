---
title: Учебник. Использование сборников схем с правилами автоматизации в Azure Sentinel
description: Этот учебник поможет вам использовать сборники схем вместе с правилами автоматизации в Azure Sentinel для автоматизации реагирования на инциденты и устранения угроз безопасности.
services: sentinel
documentationcenter: na
author: yelevin
manager: rkarlin
editor: ''
ms.assetid: e4afc5c8-ffad-4169-8b73-98d00155fa5a
ms.service: azure-sentinel
ms.subservice: azure-sentinel
ms.devlang: na
ms.topic: tutorial
ms.custom: mvc
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 02/18/2021
ms.author: yelevin
ms.openlocfilehash: 365ba9df39b4b3bd7397e86e6a51b285bf049242
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "104600628"
---
# <a name="tutorial-use-playbooks-with-automation-rules-in-azure-sentinel"></a>Учебник. Использование сборников схем с правилами автоматизации в Azure Sentinel

В том учебнике показано, как использовать сборники схем вместе с правилами автоматизации для автоматизации реагирования на инциденты и устранения угроз безопасности, обнаруженных Azure Sentinel. После изучения этого учебника вы сможете выполнять следующие задачи.

> [!div class="checklist"]
>
> * Создание правила автоматизации
> * Создание сборника схем
> * Добавление действий в сборник схем
> * Подключение сборника схем к правилу автоматизации или правилу аналитики для автоматизации реагирования на угрозы

## <a name="what-are-automation-rules-and-playbooks"></a>Общие сведения о правилах автоматизации и сборниках схем

Правила автоматизации помогают рассматривать инциденты в Azure Sentinel. Их можно использовать для автоматического назначения инцидентов нужному персоналу, закрытия мнимых инцидентов или известных ложноположительных результатов, изменения их серьезности и добавления тегов. Они также обеспечивают механизм запуска сборников схем в ответ на инциденты.

Сборник схем — это набор процедур, которые могут запускаться из Azure Sentinel в ответ на оповещение или инцидент. Сборник схем может помочь автоматизировать и оркестрировать отклик. При подключении к правилу аналитики или правилу автоматизации он может автоматически запускаться в случае создания конкретных предупреждений или инцидентов соответственно. Его также можно запустить вручную по запросу.

Сборники схем в Azure Sentinel основаны на рабочих процессах, встроенных в [Azure Logic Apps](../logic-apps/logic-apps-overview.md). Это означает, что вы получаете все функции, возможности настройки и встроенные шаблоны Logic Apps. Каждый сборник схем создается для конкретной подписки, к которой он принадлежит, но на экране **Сборники схем** отображаются все сборники схем, доступные в выбранных подписках.

> [!NOTE]
> Так как сборники схем используют Azure Logic Apps, может взиматься дополнительная плата. Подробные сведения о ценах см. на странице цен на [Azure Logic Apps](https://azure.microsoft.com/pricing/details/logic-apps/).

Например, если вы хотите предотвратить доступ потенциально скомпрометированных пользователей к ресурсам сети и кражу информации, можно создать автоматизированный многоаспектный ответ на инциденты, созданные на основе правил обнаружения скомпрометированных пользователей. Начнем с создания сборника схем, выполняющего описанные ниже действия.

1. При вызове сборника схем правилом автоматизации, которое передает ему инцидент, сборник схем открывает запрос в [ServiceNow](/connectors/service-now/) или любой другой системе обработки запросов.

1. Он отправляет сообщение в ваш канал операций по обеспечению безопасности в [Microsoft Teams](/connectors/teams/) или [Slack](/connectors/slack/), чтобы уведомить аналитиков системы безопасности об инциденте.

1. Он также отправляет сообщение электронной почты со всей информацией об инциденте старшему сетевому администратору и администратору системы безопасности. Сообщение электронной почты будет содержать кнопки **Блокировать** и **Игнорировать** для пользователя.

1. Сборник схем ожидает получения ответа от администраторов, а затем переходит к следующим шагам.

1. Если администратор выбирает **Блокировать**, в Azure AD отправляется команда отключения пользователя, а в брандмауэр — команда блокирования IP-адреса.

1. Если администратор выбирает **Игнорировать**, сборник схем закрывает инцидент в Azure Sentinel и запрос в ServiceNow.

Чтобы активировать сборник схем, вы создадите правило автоматизации, которое будет выполняться при создании таких инцидентов. В соответствии с этим правилом будут выполняться следующие действия:

1. Состояние инцидента будет изменено на **Активно**.

1. Инцидент будет назначен аналитику, отвечающему за управление инцидентами такого типа.

1. Будет добавлен тег "скомпрометированный пользователь".

1. Наконец, будет вызван только что созданный сборник схем. ([Для этого шага требуются специальные разрешения](automate-responses-with-playbooks.md#incident-creation-automated-response).)

Сборники схем можно запускать автоматически в ответ на инциденты, создав правила автоматизации, вызывающие такие сборники в качестве действий, как в приведенном выше примере. Они также могут запускаться автоматически в ответ на предупреждения, если в правиле аналитики предусмотрено автоматическое выполнение одного или нескольких сборников схем при создании предупреждения. 

При этом можно также выбрать запуск сборника схем вручную по запросу в ответ на выбранное предупреждение.

Ознакомьтесь с более полным и подробным введением в автоматизацию реагирования на угрозы с помощью [правил автоматизации](automate-incident-handling-with-automation-rules.md) и [сборников схем](automate-responses-with-playbooks.md) в Azure Sentinel.

> [!IMPORTANT]
>
> - **Правила автоматизации** и возможность использования **триггера инцидентов** для сборника схем сейчас доступны в **предварительной версии**. Дополнительные юридические условия, применимые к функциям Azure, которые предоставляются в бета-версии, предварительной версии или еще не выпущены в общедоступной версии по другим причинам, см. на странице [Дополнительные условия использования Azure для предварительных версий в Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).

## <a name="create-a-playbook"></a>Создание сборника схем

Чтобы создать сборник схем в Azure Sentinel, сделайте следующее.

### <a name="prepare-the-playbook-and-logic-app"></a>Подготовка сборника схем и приложения логики

1. В меню навигации **Azure Sentinel** выберите **Автоматизация**.

1. В верхнем меню выберите **Создать** и **Add new playbook** (Добавить новый сборник схем).

    :::image type="content" source="./media/tutorial-respond-threats-playbook/add-new-playbook.png" alt-text="Добавление нового сборника схем":::

    Откроется новая вкладка браузера с мастером **Создание приложения логики**.

   :::image type="content" source="./media/tutorial-respond-threats-playbook/create-playbook.png" alt-text="Создайте приложение логики":::

1. Введите **подписку** и **группу ресурсов** и присвойте сборнику схем имя в поле **Имя приложения логики**.

1. В поле **Регион** выберите регион Azure, в котором будут храниться сведения о приложении логики.

1. Если вы хотите отслеживать действие этого сборника схем в целях диагностики, установите флажок **Enable log analytics** (Включить Log Analytics) и введите имя **рабочей области Log Analytics**.

1. Если вы хотите применить теги к сборнику схем, нажмите кнопку **Далее: Теги >** (без подключения к тегам, примененным правилами автоматизации, — см. [дополнительные сведения о тегах](../azure-resource-manager/management/tag-resources.md)). В противном случае щелкните **Просмотр и создание**. Проверьте указанные сведения и выберите **Создать**.

1. Во время создания и развертывания сборника схем (это займет несколько минут) на экране появится экран под названием **Microsoft.EmptyWorkflow**. Когда появится сообщение "Развертывание выполнено", щелкните **Перейти к ресурсу**.

1. Вы перейдете в [конструктору Logic Apps](../logic-apps/logic-apps-overview.md) для нового сборника схем, где сможете приступить к проектированию рабочего процесса. Здесь отобразится экран с коротким вводным видео, а также часто используемыми триггерами и шаблонами для приложений логики. См. [дополнительные сведения](../logic-apps/logic-apps-create-logic-apps-from-templates.md) о создании сборника схем с помощью Logic Apps.

1. Выберите шаблон **Пустое приложение логики**.

   :::image type="content" source="./media/tutorial-respond-threats-playbook/choose-playbook-template.png" alt-text="Коллекция шаблонов конструктора Logic Apps":::

### <a name="choose-the-trigger"></a>Выбор триггера

Каждый сборник схем должен начинаться с триггера. Триггер определяет действие, по которому запускается сборник схем, и схему, которую он должен получить.

1. Воспользуйтесь строкой поиска, чтобы найти Azure Sentinel. Выберите результат **Azure Sentinel**, когда он появится в списке.

1. На полученной в результате вкладке **Триггеры** расположено два триггера, предлагаемых в Azure Sentinel:
    - при срабатывании ответа на оповещение Azure Sentinel;
    - после запуска правила создания инцидентов Azure Sentinel.

   Выберите триггер, соответствующий типу создаваемого сборника схем.

    :::image type="content" source="./media/tutorial-respond-threats-playbook/choose-trigger.png" alt-text="Выбор триггера для сборника схем":::

### <a name="add-actions"></a>Добавление действий

Теперь можно определить, что произойдет при активации сборника схем. Чтобы добавить действия, логические условия, циклы или условия для оператора switch, выберите **Новый шаг**. При выборе этого варианта в конструкторе открывается новый фрейм, где можно выбрать систему или приложение для взаимодействия или условие, которое необходимо задать. Введите имя системы или приложения в строке поиска в верхней части фрейма, а затем выберите один из доступных результатов.

На каждом из этих шагов при щелчке в любом поле отображается панель с двумя меню: **Динамическое содержимое** и **Выражение**. В меню **Динамическое содержимое** можно добавить ссылки на атрибуты предупреждения или инцидента, которые были переданы в сборник схем, в том числе значения и атрибуты всех задействованных сущностей. С помощью меню **Выражение** можно добавить дополнительную логику к шагам, выбрав необходимые элементы из большой библиотеки функций.

   :::image type="content" source="./media/tutorial-respond-threats-playbook/logic-app.png" alt-text="Конструктор приложений логики":::

На этом снимке экрана показаны действия и условия, которые можно добавить при создании сборника схем, описанного в примере в начале этого документа. Единственное отличие заключается в том, что в показанном здесь сборнике схем вместо **триггера инцидента** используется **триггер предупреждения**. Это означает, что этот сборник схем будет вызываться непосредственно из правила аналитики, а не из правила автоматизации. Оба способа вызова сборника схем будут описаны ниже.

## <a name="automate-threat-responses"></a>Автоматизация реагирования на угрозы

Вы создали сборник схем и определили триггер, установили условия, а также задали действия, которые он будет выполнять, и выходные данные, которые он будет создавать. Теперь необходимо определить условия, при которых он будет выполняться, и настроить механизм автоматизации, который будет запускать его при выполнении этих условий.

### <a name="respond-to-incidents"></a>Реагирование на инциденты

Чтобы использовать сборник схем для реагирования на **инцидент**, необходимо создать [правило автоматизации](automate-incident-handling-with-automation-rules.md), которое будет выполняться при создании инцидента и, в свою очередь, вызывать сборник схем.

Чтобы создать правило автоматизации, выполните следующие действия.

1. В колонке **Автоматизация** в меню навигации Azure Sentinel в верхнем меню выберите **Создать**, а затем — **Добавить новое правило**.

   :::image type="content" source="./media/tutorial-respond-threats-playbook/add-new-rule.png" alt-text="Добавление нового правила":::

1. Откроется панель **Create new automation rule** (Создание правила автоматизации). Введите имя правила.

   :::image type="content" source="./media/tutorial-respond-threats-playbook/create-automation-rule.png" alt-text="Создание правила автоматизации":::

1. Если вы хотите, чтобы правило автоматизации действовало только для определенных правил аналитики, укажите их, изменив условие **Если имя правила аналитики**.

1. Добавьте любые другие условия, от которых должна зависеть активация этого правила автоматизации. Щелкните **Добавить условие** и выберите условия в раскрывающемся списке. Список условий заполняется сведениями о предупреждении и полями идентификаторов сущностей.

1. Выберите действия, которые должно выполнять это правило автоматизации. Доступные действия: **назначение владельца**, **изменение состояния**, **изменение серьезности**, **добавление тегов** и **запуск сборника схем**. Вы можете добавить любое количество действий по своему усмотрению.

1. Если вы добавите действие **Запустить сборник схем**, вам будет предложено выбрать сборник из раскрывающегося списка доступных сборников схем. Из правил автоматизации могут запускаться только сборники схем, которые начинаются с **триггера инцидента**, поэтому в списке будут отображаться только они.

    > [!IMPORTANT]
    > Для запуска сборников схем из правил автоматизации необходимо предоставить Sentinel Azure явные разрешения. Если сборник схем в раскрывающемся списке неактивен, это означает, что у Sentinel нет разрешения на доступ к группе ресурсов этого сборника. Щелкните ссылку **Manage playbook permissions** (Управление разрешениями для сборника схем), чтобы назначить разрешения.
    > На открывшейся панели **Управление разрешениями** установите флажки рядом с группами ресурсов, содержащими сборники схем, которые требуется запустить, и нажмите кнопку **Применить**.
    > :::image type="content" source="./media/tutorial-respond-threats-playbook/manage-permissions.png" alt-text="Управление разрешениями":::
    > - Вы сами должны иметь разрешения **владельца** в любой группе ресурсов, для которой вы хотите предоставить разрешения Azure Sentinel. У вас также должна быть роль **участника приложения логики** в любой группе ресурсов, содержащей сборники схем, которые нужно запустить.
    > - Если при развертывании с несколькими клиентами сборник схем, который нужно запустить, находится в другом клиенте, необходимо предоставить Azure Sentinel разрешение на запуск сборника схем в том клиенте, где расположен этот сборник.
    >    1. В меню навигации Azure Sentinel в клиенте сборника схем выберите **Параметры**.
    >    1. В колонке **Параметры** выберите вкладку **Параметры**, а затем — расширитель **разрешений сборника схем**.
    >    1. Нажмите кнопку **Настройка разрешений**, чтобы открыть панель **Управление разрешениями**, упомянутую выше, а затем выполните описанные здесь действия.

1. Задайте дату истечения срока действия правила автоматизации, если это необходимо.

1. Введите число в разделе **Порядок**, чтобы определить, где в последовательности правил автоматизации будет выполняться это правило.

1. Щелкните **Применить**. Готово!

[Узнайте о других способах](automate-incident-handling-with-automation-rules.md#creating-and-managing-automation-rules) создания правил автоматизации.

### <a name="respond-to-alerts"></a>Реагирование на оповещения

Сборник схем можно использовать для реагирования на **предупреждения**. Для этого необходимо создать новое или изменить существующее **правило аналитики**, которое будет применяться при создании предупреждений, и выбрать сборник схем в качестве автоматического ответа в [мастере правил аналитики](tutorial-detect-threats-custom.md).

1. В колонке **Аналитика** в меню навигации по Azure Sentinel выберите правило аналитики, для которого необходимо автоматизировать реагирование, и нажмите кнопку **Изменить** в области сведений.

1. На странице **Мастер правил аналитики – Изменение существующего правила** выберите вкладку **Автоматический ответ**.

   :::image type="content" source="./media/tutorial-respond-threats-playbook/automated-response-tab.png" alt-text="Вкладка &quot;Автоматический ответ&quot;":::

1. В раскрывающемся списке выберите свой сборник схем. Можно выбрать несколько сборников схем, однако доступны будут только сборники схем, в которых используется **триггер предупреждений**.

1. На вкладке **Просмотр и создание** нажмите кнопку **Сохранить**.

## <a name="run-a-playbook-on-demand"></a>Выполнение сборника схем по запросу

Вы также можете запускать сборник схем по запросу.

 > [!NOTE]
 > По запросу может запускаться только сборник схем, в котором используется **триггер предупреждения**.

Чтобы запустить сборник схем по запросу:

1. На странице **Инциденты** выберите инцидент и щелкните **Просмотр полных сведений**.

2. На вкладке **Оповещения** щелкните оповещение, для которого должен запускаться сборник схем, прокрутите до упора вправо, щелкните **Просмотреть сборники схем** и выберите сборник для **запуска** из списка доступных сборников в подписке.

## <a name="next-steps"></a>Дальнейшие действия

Из этого учебника вы узнали, как использовать сборники схем и правила автоматизации в Azure Sentinel для реагирования на угрозы. 
- Дополнительные сведения см. в статье об [упреждающем обнаружении угроз](hunting.md) с помощью Azure Sentinel.
