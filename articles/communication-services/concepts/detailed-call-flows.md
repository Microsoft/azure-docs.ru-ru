---
title: Топологии потоков вызовов в Службах коммуникации Azure
titleSuffix: An Azure Communication Services concept document
description: Сведения о топологиях потоков вызовов в Службах коммуникации Azure
author: nmurav
services: azure-communication-services
ms.author: nmurav
ms.date: 12/11/2020
ms.topic: overview
ms.service: azure-communication-services
ms.openlocfilehash: 1333bd08f8a79969817bcb21aa4580d1994d09ce
ms.sourcegitcommit: f377ba5ebd431e8c3579445ff588da664b00b36b
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/05/2021
ms.locfileid: "99594685"
---
# <a name="call-flow-topologies"></a>Топологии потоков вызовов
В этой статье описываются топологии потоков вызовов в Службах коммуникации Azure. Со сведениями, содержащимися в этой статье, будет очень полезно ознакомиться, если вы являетесь корпоративным клиентом и интегрируете Службы коммуникации в управляемую вами сеть. Общие сведения о потоках вызовов Служб коммуникации см. в [основной документации по потокам вызовов](./call-flows.md).

## <a name="background"></a>Фон

### <a name="network-concepts"></a>Основные понятия сети в Службе Azure Kubernetes (AKS)

Перед изучением топологий потоков вызовов мы определим некоторые термины, упоминаемые в документе.

**Сеть клиента** содержит любые сегменты сети, которыми вы управляете. Это могут быть проводные и беспроводные сети в офисе или между офисами, центрами обработки данных и поставщиками Интернет-услуг.

Сеть клиента обычно имеет несколько периметров сети с брандмауэрами и/или прокси-серверами, обеспечивающими выполнение политик безопасности вашей организации. Мы рекомендуем выполнить [комплексную оценку сети](https://docs.microsoft.com/microsoftteams/3-envision-evaluate-my-environment), чтобы гарантировать оптимальные производительность и качество решения по коммуникации.

**Сеть Служб коммуникации Azure** представляет собой сегмент сети, поддерживающий Службы коммуникации Azure. Этой сетью управляет корпорация Майкрософт. Доступ к ней можно получить почти в любой точке мира, поскольку ее ребра расположены в непосредственной близости от большинства клиентских сетей. Эта сеть отвечает за транспортную ретрансляцию, обработку медиа групповых вызовов и другие компоненты, поддерживающие медиа-коммуникации в режиме реального времени.

### <a name="types-of-traffic"></a>Типы трафика

Службы коммуникации Azure построены в основном на двух типах трафика: **трафик данных в реальном времени** и **трафик сигнализации**.

**Трафик данных в реальном времени** передается с использованием протокола RTP. Этот протокол поддерживает передачу аудио, видео, а также данных при предоставлении доступа к экрану. Такие данные чувствительны к проблемам с задержкой в сети. Хотя трафик данных в реальном времени можно передавать по TCP или HTTP, мы рекомендуем использовать в качестве протокола транспортного уровня UDP, поскольку это позволит обеспечить поддержку высокопроизводительных интерфейсов пользователей. Полезные данные, передаваемые по RTP, защищены с помощью SRTP.

Пользователи вашего решения Службы коммуникации будут подключаться к службам с клиентских устройств. Обмен данными между этими устройствами и вашими серверами осуществляется с помощью **трафика сигнализации**. Например: инициирование вызова и чат в реальном времени поддерживаются с помощью сигнализации между устройствами и вашей службой. В большинстве случаев трафик сигнализации использует HTTPS REST, хотя в некоторых сценариях в качестве протокола трафика сигнализации может использоваться SIP. Хотя этот тип трафика менее чувствителен к задержкам, сигнализация с низкой задержкой обеспечит приятные ощущения от работы с вашим решением для пользователей.

### <a name="interoperability-restrictions"></a>Ограничения взаимодействия

Данные, передаваемые через Службы коммуникации Azure, ограничены следующим образом.

**Сторонние ретрансляторы данных.** Взаимодействие с ретрансляторами данных сторонних производителей не поддерживается. Если одной из конечных точек данных являются Службы коммуникации, ваши данные смогут передавать только ретрансляторы данных Майкрософт, включая ретрансляторы, поддерживающие Microsoft Teams и Skype для бизнеса.

Сторонний пограничный контроллер сеансов (SBC) на границе с PSTN должен прервать поток RTP/RTCP, защищенный с помощью SRTP, и не передавать его на следующий прыжок. Если передать поток на следующий прыжок, он может быть непонятен.

**Сторонние прокси-серверы SIP.** Диалоговое окно SIP сигнализации Служб коммуникации со сторонним SBC и/или шлюзом может перенаправлять прокси-серверы SIP от Майкрософт (как Teams). Взаимодействие с прокси-серверами SIP от сторонних поставщиков не поддерживается.

**Сторонний B2BUA (или SBC).** Поток данных Служб коммуникации в, а также из PSTN завершается сторонним SBC. Взаимодействие со сторонними SBC в сети Служб коммуникации (где сторонний SBC является средством связи между двумя конечными точками Служб коммуникации) не поддерживается.

### <a name="unsupported-technologies"></a>Неподдерживаемые технологии

**Сеть VPN.** Службы коммуникации Azure не поддерживают передачу данных через VPN. Если пользователи используют VPN-клиенты, клиент должен разделить и перенаправить трафик данных через подключение, отличное от VPN, как указано в статье [Включение данных Lync для обхода VPN-туннеля.](https://techcommunity.microsoft.com/t5/skype-for-business-blog/enabling-lync-media-to-bypass-a-vpn-tunnel/ba-p/620210)

*Примечание. Хотя в заголовке и обозначено Lync, статья также применима к Службам коммуникации Azure и Teams.*

**Формирователи пакетов.** Устройства выделения, проверки или формирования пакетов не поддерживаются и могут значительно ухудшить качество.

### <a name="call-flow-principles"></a>Принципы потока вызовов

В основе потоков вызовов в Службах коммуникации лежат четыре общих принципа:

* **Первый участник группового вызова Службы коммуникации определяет регион, в котором будет размещен вызов**. В некоторых топологиях, описанных ниже, существуют исключения из этого правила.
* **Конечная точка данных, используемая для поддержки вызова Служб коммуникации, выбирается исходя из потребностей в обработке данных**, и на нее не влияет количество участников вызова. Например, вызов типа "точка — точка" может использовать конечную точку данных в облаке, чтобы обрабатывать данные для записи или транскрибирования, в то время как при вызове с двумя участниками конечные точки данных могут не использоваться. Конечна точка данных также будет использоваться при групповых вызовах, чтобы обеспечить объединение и маршрутизацию. Эта конечная точка выбирается в зависимости от региона, в котором размещается вызов. Трафик данных, отправленный с клиента на конечную точку данных, может маршрутизироваться напрямую или использовать транспортный ретранслятор в Azure, если это предусмотрено клиентскими ограничениями сетевого брандмауэра.
* **Трафик данных для одноранговых звонков принимает самую прямую доступную маршрутизацию**, предполагая, что для вызова не требуется конечная точка данных в облаке. Предпочтительным будет маршрут непосредственно к удаленному одноранговому узлу (клиенту). Если прямой маршрут недоступен, трафик будут передавать один или несколько транспортных ретрансляторов. Трафик данных не следует передавать через серверы, которые действуют как формирователи пакетов, VPN-серверы или другие функции, которые могут привести к задержке обработки и снизить эффективность взаимодействия с пользователями.
* **Трафик сигнализации всегда поступает на сервер, расположенный к пользователю ближе всего.**

Подробные сведения о выбранном пути передачи данных см. в [основной документации по потокам вызовов](./call-flows.md).


## <a name="call-flows-in-various-topologies"></a>Потоки вызовов в различных топологиях

### <a name="communication-services-internet"></a>Службы коммуникации (Интернет)

Эту топологию применяют клиенты, использующие Службы коммуникации в облаке без локального развертывания, например интерфейс SIP. В этой топологии трафик к Службам коммуникации и от них поступает через Интернет.

:::image type="content" source="./media/call-flows/detailed-flow-general.png" alt-text="Экран &quot;Топология Служб коммуникации Azure&quot;.":::

*Рис. 1. Топология Служб коммуникации Azure*

Направление стрелок на диаграмме выше отражает направление инициирования связи, которое влияет на подключение по периметру предприятия. При использовании для данных протокола UDP первые пакеты могут передаваться в обратном направлении, однако они могут быть заблокированы до получения пакетов в другом направлении.

Описания потоков:
* Поток 2*. Представляет собой поток, инициированный пользователем из сети клиента в Интернет как часть взаимодействия со Службами коммуникации пользователя. Примерами таких потоков являются DNS и одноранговая передача данных.
* Поток 2. Представляет собой поток, инициированный удаленным мобильным пользователем Служб коммуникации, с VPN в сеть клиента.
* Поток 3. Представляет собой поток, инициированный удаленным мобильным пользователем Служб коммуникации к конечным точкам Службы коммуникации.
* Поток 4. Представляет собой поток, инициированный пользователем из сети клиента к Службам коммуникации.
* Поток 5. Представляет собой одноранговый поток данных между пользователем Служб коммуникации и другим пользователем в сети клиента.
* Поток 6. Представляет собой одноранговый поток данных между удаленным мобильным пользователем Служб коммуникации Azure и другим удаленным мобильным пользователем Служб коммуникации через Интернет.

### <a name="use-case-one-to-one"></a>Вариант использования. Один к одному

Вызовы "один к одному" используют общую модель, в которой вызывающий объект получает набор кандидатов, состоящий из IP-адресов/портов, включая локальные, ретрансляционные и рефлексивные (публичные IP-адреса клиента, какими их видит ретранслятор) кандидаты. Вызывающий объект отправляет эти кандидаты вызываемой стороне; вызываемая сторона также получает аналогичный набор кандидатов и отправляет их вызывающей стороне. Сообщения для проверки подключения STUN используются для определения работоспособности путей передачи данных вызывающей/вызываемой стороны и последующего выбора наиболее работоспособного пути. Данные (т. е. пакеты TP/RTCP, защищенные с помощью SRTP) затем отправляются с использованием выбранной пары кандидатов. Транспортный ретранслятор развертывается в составе Служб коммуникации Azure.

Если локальные IP-адреса / кандидаты порта или рефлексивные кандидаты имеют подключение, то для передачи данных будет использован прямой путь между клиентами (или с помощью NAT). Если клиенты находятся в сети клиента, необходимо выбрать прямой путь. Для этого требуется прямое подключение по протоколу UDP в сети клиента. Если клиенты являются пользователями облака Nomadic, то возможность использования прямого соединения для передачи данных зависит от NAT/брандмауэра.

Если один клиент является внутренним в сети клиента, а другой — внешним (например, мобильный пользователь облака), то прямое подключение между локальными или рефлексивными кандидатами скорее всего работать не будет. В этом случае можно использовать один из кандидатов транспортного ретранслятора из любого клиента (например, внутренний клиент получил кандидат ретранслятора от транспортного ретранслятора в Azure; внешний клиент должен иметь возможность отправлять пакеты STUN/RTP/RTCP в транспортный ретранслятор). Другой вариант — внутренний клиент посылает ретранслятору кандидат, полученный мобильным клиентом облака. При этом можно использовать протокол TCP, хотя мы настоятельно рекомендуем использовать для передачи данных подключение через UDP.

**Важные действия:**
1.  Пользователь A Службы коммуникации Azure разрешает доменное имя (DNS) URL-адреса с помощью потока 2.
2.  Пользователь A определяет порт сервера ретрансляции мультимедиа в транспортном ретрансляторе Teams с помощью потока 4.
3.  Пользователь А Служб коммуникации Azure отправляет "приглашение" вместе с кандидатами ICE в Службы коммуникации с помощью потока 4.
4.  Службы коммуникации уведомляют пользователя Б, используя поток 4.
5.  Пользователь Б определяет порт сервера ретрансляции мультимедиа в транспортном ретрансляторе Teams с помощью потока 4.
6.  Пользователь Б отправляет "ответ" с кандидатами ICE, используя поток 4, который перенаправляется обратно пользователю A с помощью потока 4.
7.  Пользователь A и пользователь Б вызывают тесты подключения ICE, после чего выбирается лучший доступный путь для передачи данных (см. схемы ниже, чтобы узнать больше о различных вариантах использования).
8.  Оба пользователя отправляют данные телеметрии в Службы коммуникации, используя поток 4.

### <a name="customer-network-intranet"></a>Клиентская сеть (интрасеть)

:::image type="content" source="./media/call-flows/one-to-one-internal.png" alt-text="Экран &quot;Поток трафика в клиентской сети&quot;.":::

*Рис. 2. Поток трафика в клиентской сети*

На шаге 7 для передачи выбран одноранговый поток данных 5.

Такая передача данных является двунаправленной. Направление потока 5 указывает на то, что одна сторона инициирует связь с точки зрения подключения. В этом случае тип используемого направления не имеет значения, поскольку обе конечные точки находятся в клиентской сети.

### <a name="customer-network-to-external-user-media-relayed-by-teams-transport-relay"></a>Из клиентской сети к внешнему пользователю (данные передаются через транспортный ретранслятор Teams)

:::image type="content" source="./media/call-flows/one-to-one-via-relay.png" alt-text="Экран &quot;Поток вызова &quot;один к одному&quot; через ретранслятор&quot;.":::

*Рис. 3. От клиентской сети к внешнему пользователю (данные передаются через транспортный ретранслятор Azure)*

На шаге 7 выбраны поток 4 (из клиентской сети к Службам коммуникации) и поток 3 (из удаленного мобильного пользователя Служб коммуникации к Службам коммуникации Azure).

Эти потоки ретранслируются транспортным ретранслятором Teams в Azure.

Такая передача данных является двунаправленной. Направление указывает, какая сторона инициирует связь с точки зрения подключения. В этом случае такие потоки используются для сигнализации и передачи данных с помощью различных транспортных протоколов и адресов.

### <a name="customer-network-to-external-user-direct-media"></a>От клиентской сети к внешнему пользователю (прямая передача данных)

:::image type="content" source="./media/call-flows/one-to-one-with-extenal.png" alt-text="Экран &quot;Поток вызовов &quot;один к одному&quot;к внешнему пользователю&quot;.":::

*Рис. 4. От клиентской сети к внешнему пользователю (прямая передача данных)*

На шаге 7 выбран поток 2 (из сети клиента к одноранговому узлу клиента через Интернет).

Прямая передача данных с удаленным мобильным пользователем (без передачи через Azure) является необязательной. Иными словами, этот путь можно заблокировать, чтобы принудительно применить для передачи данных путь данных через транспортный ретранслятор в Azure.

Такая передача данных является двунаправленной. Направление потока 2 к удаленному мобильному пользователю указывает на то, что одна сторона инициирует связь с точки зрения подключения.

### <a name="vpn-user-to-internal-user-media-relayed-by-teams-transport-relay"></a>Из VPN-пользователя к внутреннему пользователю (данные передаются через транспортный ретранслятор Teams)

:::image type="content" source="./media/call-flows/vpn-to-internal-via-relay.png" alt-text="Экран &quot;Поток вызовов &quot;один к одному&quot; при использовании VPN-пользователя через ретранслятор&quot;.":::

*Рис. 5. От VPN-пользователя к внутреннему пользователю (данные передаются через Azure Relay)*

Сигнализация между VPN-подключением и сетью клиента использует поток 2*. Сигнализация между сетью клиента и Azure использует поток 4. Однако при этом данные обходят VPN и перенаправляется с помощью потоков 3 и 4 через службу Azure Media Relay.

### <a name="vpn-user-to-internal-user-direct-media"></a>Из VPN-пользователя к внутреннему пользователю (прямая передача данных)

:::image type="content" source="./media/call-flows/vpn-to-internal-direct-media.png" alt-text="Экран &quot;Поток вызовов &quot;один к одному&quot; при использовании VPN с прямой передачей данных&quot;.":::

*Рис. 6. От VPN-пользователя к внутреннему пользователю (прямая передача данных)*

Сигнализация между VPN-подключением и клиентской сетью использует поток 2'. Сигнализация между клиентской сетью и Azure использует поток 4. Однако при этом данные обходят VPN и перенаправляются с помощью потока 2 из клиентской сети в Интернет.

Такая передача данных является двунаправленной. Направление потока 2 к удаленному мобильному пользователю указывает на то, что одна сторона инициирует связь с точки зрения подключения.

### <a name="vpn-user-to-external-user-direct-media"></a>От VPN-пользователя к внутреннему пользователю (прямая передача данных)

:::image type="content" source="./media/call-flows/vpn-user-to-external-user.png" alt-text="Экран &quot;Поток вызовов &quot;один к одному&quot; при использовании VPN с прямой передачей данных&quot;.":::

*Рис. 7. От VPN-пользователя к внутреннему пользователю (прямая передача данных)*

Сигнализация использует поток 2* между VPN-пользователем и клиентской сетью и поток 4 к Azure. Однако при этом данные обходят VPN и направляются с помощью потока 6.

Такая передача данных является двунаправленной. Направление потока 6 к удаленному мобильному пользователю указывает на то, что одна сторона инициирует связь с точки зрения подключения.

### <a name="use-case-communication-services-client-to-pstn-through-communication-services-trunk"></a>Вариант использования. Из клиента Служб коммуникации к ТСОП через канал связи Служб коммуникации Azure

Службы коммуникации предоставляют возможности для размещения и получения вызовов из общедоступной телефонной сети с открытым коммутируемым доступом (ТСОП). Если канал связи ТСОП подключен с использованием телефонных номеров, предоставляемых Службами коммуникации, для этого случая использования специальных требований к подключению нет. Если вы хотите подключить собственный локальный канал связи ТСОП к Службам коммуникации, используйте интерфейс SIP (доступен в CY2021).

:::image type="content" source="./media/call-flows/acs-to-pstn.png" alt-text="Экран &quot;Вызовов &quot;один к одному&quot; с участником ТСОП&quot;":::

*Рис. 8. Подключение пользователя Служб коммуникации к ТСОП через канал связи Azure*

В этом случае сигнализация и передача данных из клиентской сети в Azure используют поток 4.

### <a name="use-case-communication-services-group-calls"></a>Вариант использования. Групповые вызовы Служб коммуникации

Служба "аудио/видео/общий доступ к экрану" (VBSS) является частью Служб коммуникации. Она имеет общедоступный IP-адрес, который должен быть доступен из клиентской сети, а также из клиента Nomadic Cloud. Каждый клиент или конечная точка должны иметь возможность подключения к службе.

Внутренние клиенты будут получать локальные, рефлексивные и ретрансляционные кандидаты в порядке, описанном для вызовов "один к одному". Клиенты будут отправлять эти кандидаты в службу в приглашении. Служба не использует ретранслятор, поскольку имеет общедоступный IP-адрес и поэтому создает ответ, используя кандидат локального IP-адреса. Клиент и служба будут проверять соединение, как описано в разделе о звонках "один к одному".

:::image type="content" source="./media/call-flows/acs-group-calls.png" alt-text="Экран &quot;Групповой вызов OACS&quot;":::

*Рис. 9. Групповые вызовы Служб коммуникации*

## <a name="next-steps"></a>Дальнейшие действия

> [!div class="nextstepaction"]
> [Начало работы с вызовами](../quickstarts/voice-video-calling/getting-started-with-calling.md)

Вас могут заинтересовать следующие документы:

- Дополнительные сведения о [типах вызовов](../concepts/voice-video-calling/about-call-types.md).
- Сведения об [архитектуре "клиент — сервер"](./client-and-server-architecture.md)

