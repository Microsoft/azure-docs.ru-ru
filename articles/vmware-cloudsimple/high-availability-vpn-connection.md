---
title: Решение Azure VMware с помощью Клаудсимпле — настройте высокий уровень доступности с локального компьютера на Клаудсимпле VPN-шлюз.
description: В этой статье описано, как настроить подключение с высокой доступностью из локальной среды к VPN-шлюзу Клаудсимпле, для которого включена высокая доступность.
author: Ajayan1008
ms.author: v-hborys
ms.date: 08/14/2019
ms.topic: article
ms.service: azure-vmware-cloudsimple
ms.reviewer: cynthn
manager: dikamath
ms.openlocfilehash: 80805aaa172518c40c7ad123ca24361ee0f15e69
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "97895705"
---
# <a name="configure-a-high-availability-connection-from-on-premises-to-cloudsimple-vpn-gateway"></a>Настройка подключения с высокой доступностью из локальной среды в VPN-шлюз Клаудсимпле

Сетевые администраторы могут настроить высокодоступное VPN-подключение типа "сеть — сеть" IPsec из локальной среды к VPN-шлюзу Клаудсимпле.

В этом руководстве представлены шаги по настройке локального брандмауэра для подключения с высоким уровнем доступности VPN типа "сеть — сеть" IPsec. Подробные инструкции относятся к типу локального брандмауэра. В качестве примера в этом руководстве описываются два типа брандмауэров: Cisco ASA и Palo Alto Networks.

## <a name="before-you-begin"></a>Перед началом

Перед настройкой локального брандмауэра выполните следующие действия.

1. Убедитесь, что в организации [подготовлены](create-nodes.md) необходимые узлы и создано по крайней мере одно частное облако клаудсимпле.
2. [Настройте VPN-шлюз типа "сеть — сеть](vpn-gateway.md#set-up-a-site-to-site-vpn-gateway) " между локальной сетью и частным облаком клаудсимпле.

Поддерживаемые предложения на этапах 1 и 2 см. в разделе [Общие сведения о VPN-шлюзах](cloudsimple-vpn-gateways.md) .

## <a name="configure-on-premises-cisco-asa-firewall"></a>Настройка локального брандмауэра Cisco ASA

Инструкции в этом разделе относятся к Cisco ASA версии 8,4 и более поздним. В примере конфигурации программное обеспечение адаптивной системы безопасности Cisco версии 9,10 развертывается и настраивается в режиме IKEv1.

Для работы VPN-подключения типа "сеть — сеть" необходимо разрешить UDP 500/4500 и ESP (IP-протокол 50) из основного и дополнительного общедоступного IP-адреса Клаудсимпле на внешнем интерфейсе локальной сети VPN-шлюза Cisco ASA.

### <a name="1-configure-phase-1-ikev1"></a>1. Настройка фазы 1 (IKEv1)

Чтобы включить фазу 1 (IKEv1) на внешнем интерфейсе, введите следующую команду интерфейса командной строки в брандмауэре Cisco ASA.

```crypto ikev1 enable outside```

### <a name="2-create-an-ikev1-policy"></a>2. Создание политики IKEv1

Создайте политику IKEv1, определяющую алгоритмы и методы, используемые для хэширования, проверки подлинности, Diffie-Hellman группы, времени существования и шифрования.

```
crypto ikev1 policy 1
authentication pre-share
encryption aes-256
hash sha
group 2
lifetime 28800
```

### <a name="3-create-a-tunnel-group"></a>3. Создание группы туннелей

Создайте группу туннелей в атрибутах IPsec. Настройте одноранговый IP-адрес и общий ключ туннеля, заданные при [настройке VPN-шлюза типа "сеть — сеть](vpn-gateway.md#set-up-a-site-to-site-vpn-gateway)".

```
tunnel-group <primary peer ip> type ipsec-l2l
tunnel-group <primary peer ip> ipsec-attributes
ikev1 pre-shared-key *****

tunnel-group <secondary peer ip> type ipsec-l2l
tunnel-group <secondary peer ip> ipsec-attributes
ikev1 pre-shared-key *****
```

### <a name="4-configure-phase-2-ipsec"></a>4. Настройка этапа 2 (IPsec)

Чтобы настроить этап 2 (IPsec), создайте список управления доступом (ACL), определяющий трафик для шифрования и туннелирования. В следующем примере нужного трафика является из туннеля, источником которого является локальная локальной подсети (10.16.1.0/24), в удаленную подсеть частного облака (192.168.0.0/24). Список ACL может содержать несколько записей, если между сайтами есть несколько подсетей.

В Cisco ASA версии 8,4 и более поздних можно создать объекты или группы объектов, которые служат контейнерами для сетей, подсетей, IP-адресов узлов или нескольких объектов. Создайте объект для локального объекта и объект для удаленных подсетей и используйте их для криптографической службы ACL и инструкций NAT.

#### <a name="define-an-on-premises-local-subnet-as-an-object"></a>Определение локальной подсети в качестве объекта

```
object network AZ_inside
subnet 10.16.1.0 255.255.255.0
```

#### <a name="define-the-cloudsimple-remote-subnet-as-an-object"></a>Определение удаленной подсети Клаудсимпле в качестве объекта

```
object network CS_inside
subnet 192.168.0.0 255.255.255.0
```

#### <a name="configure-an-access-list-for-the-traffic-of-interest"></a>Настройка списка доступа для интересующего вас трафика

```
access-list ipsec-acl extended permit ip object AZ_inside object CS_inside
```

### <a name="5-configure-the-transform-set"></a>5. Настройка набора преобразований

Настройте набор преобразований (TS), который должен содержать ключевое слово ```ikev1``` . Атрибуты шифрования и хеширования, указанные в службах терминалов, должны соответствовать параметрам, перечисленным в [конфигурации по умолчанию для VPN-шлюзов клаудсимпле](cloudsimple-vpn-gateways.md).

```
crypto ipsec ikev1 transform-set devtest39 esp-aes-256 esp-sha-hmac 
```

### <a name="6-configure-the-crypto-map"></a>6. Настройка схемы шифрования

Настройте карту шифрования, которая содержит следующие компоненты:

* Одноранговый IP-адрес
* Определенный список ACL, содержащий интересующий вас трафик
* Набор преобразований

```
crypto map mymap 1 set peer <primary peer ip> <secondary peer ip>
crypto map mymap 1 match address ipsec-acl
crypto map mymap 1 set ikev1 transform-set devtest39
```

### <a name="7-apply-the-crypto-map"></a>7. Применение схемы шифрования

Примените карту шифрования к внешнему интерфейсу:

```crypto map mymap interface outside```

### <a name="8-confirm-applicable-nat-rules"></a>8. Подтвердите применимые правила NAT.

Ниже приведено правило NAT, которое используется. Убедитесь, что трафик VPN не подчиняется каким-либо другим правилам NAT.

```nat (inside,outside) source static AZ_inside AZ_inside destination static CS_inside CS_inside```

### <a name="sample-ipsec-site-to-site-vpn-established-output-from-cisco-asa"></a>Пример VPN типа "сеть — сеть" IPsec, который устанавливает выходные данные Cisco ASA

Выходные данные этапа 1:

![Выходные данные первого этапа для брандмауэра Cisco ASA](media/ha-vpn-connection-cisco-phase1.png)

Выходные данные этапа 2:

![Выходные данные этапа 2 для брандмауэра Cisco ASA](media/ha-vpn-connection-cisco-phase2.png)

## <a name="configure-on-premises-palo-alto-networks-firewall"></a>Настройка локального брандмауэра Palo Alto Networks

Инструкции в этом разделе относятся к Palo Alto Networks версии 7,1 и более поздних версий. В этом примере конфигурации Palo Alto Networks VM-Series Software Version 8.1.0 развертывается и настраивается в режиме IKEv1.

Чтобы VPN-подключение типа "сеть — сеть" работало, необходимо разрешить UDP 500/4500 и ESP (IP-протокол 50) из основного и дополнительного общедоступного IP-адреса (IP-адрес узла Клаудсимпле) на внешнем интерфейсе локального шлюза Palo Alto Networks.

### <a name="1-create-primary-and-secondary-tunnel-interfaces"></a>1. Создание основного и дополнительного туннельных интерфейсов

Войдите в брандмауэр Palo Alto, выберите **Сетевые**  >  **интерфейсы**  >  **туннель**  >  **Добавить**, настройте следующие поля и нажмите кнопку **ОК**.

* Имя интерфейса. Первое поле заполняется автоматически с помощью ключевого слова "Tunnel". В соседнем поле введите любое число от 1 до 9999. Этот интерфейс будет использоваться в качестве интерфейса основного туннеля для передачи трафика между сайтами между локальным центром обработки данных и частным облаком.
* Комментарий Введите комментарии для простоты идентификации назначения туннеля
* Профиль NetFlow. Оставьте значение по умолчанию.
* Файле. Назначить интерфейс: виртуальному маршрутизатору: выберите **значение по умолчанию**. 
        Зона безопасности. Выберите зону для трафика доверенной локальной сети. В этом примере имя зоны для трафика локальной сети — "Trust".
* IP версии 4. Щелкните **Добавить** и добавьте в свою среду непересекающиеся неиспользуемые/32 IP-адреса, которые будут назначены первичному интерфейсу туннеля и будут использоваться для мониторинга туннелей (см. Далее).

Так как эта конфигурация предназначена для VPN высокой доступности, требуются два интерфейса туннелирования: один первичный и один вторичный. Повторите предыдущие шаги, чтобы создать дополнительный интерфейс туннеля. Выберите другой идентификатор туннеля и другой неиспользуемый или 32 IP-адрес.

### <a name="2-set-up-static-routes-for-private-cloud-subnets-to-be-reached-over-the-site-to-site-vpn"></a>2. Настройте статические маршруты для подсетей частных облаков, которые будут достигнуты через VPN-подключение типа "сеть — сеть".

Маршруты необходимы для доступа локальных подсетей к подсетям Клаудсимпле частного облака.

Выберите **Сетевые**  >  **Виртуальные маршрутизаторы**  >  *по умолчанию*  >  **статические маршруты**  >  **Добавить**, настройте следующие поля и нажмите кнопку **ОК**.

* Название Введите любое имя для простоты идентификации назначения маршрута.
* Целевой объект. Укажите подсети частного облака Клаудсимпле, которые будут достигнуты через туннельные интерфейсы S2S из локальной среды.
* Интерфейс. В раскрывающемся списке выберите основной интерфейс туннеля, созданный в шаге-1 (раздел 2). В этом примере это туннель. 20.
* Следующий прыжок. Выберите **Отсутствует**.
* Расстояние администратора. Оставьте значение по умолчанию.
* Шкал. Введите любое значение от 1 до 65535. Ключом является ввод более низкой метрики для маршрута, соответствующего интерфейсу основного туннеля, по сравнению с соответствующим маршрутом дополнительного туннельного интерфейса, который делает прежний маршрут предпочтительным. Если параметр Tunnel. 20 имеет значение метрики 20, а не значение метрики 30 для Tunnel. 30, предпочтителен туннель. 20.
* Таблица маршрутов. Оставьте значение по умолчанию.
* Профиль БФД. Оставьте значение по умолчанию.
* Мониторинг пути. не устанавливайте флажок.

Повторите предыдущие шаги, чтобы создать другой маршрут для подсетей частных облаков для использования в качестве вторичного или резервного маршрута через интерфейс вторичного туннеля. На этот раз выберите другой идентификатор туннеля и метрику более высокого уровня, чем для основного маршрута.

### <a name="3-define-the-cryptographic-profile"></a>3. Определение профиля шифрования

Определите криптографический профиль, в котором указываются протоколы и алгоритмы для идентификации, проверки подлинности и шифрования, которые будут использоваться для настройки туннелей VPN на этапе 1 в IKEv1.

Последовательно выберите **сеть**  >  **развернуть профили сети**  >  Параметры **шифрования IKE**  >  **Добавить**, настройте следующие поля и нажмите кнопку **ОК**.

* Название Введите любое имя профиля шифрования IKE.
* DH-группа. Нажмите кнопку **Добавить** и выберите соответствующую группу Диффи-Хелмана.
* Шифрование. Нажмите кнопку **Добавить** и выберите соответствующий метод шифрования.
* Аутентификация. Нажмите кнопку **Добавить** и выберите соответствующий метод проверки подлинности.
* Время существования ключа. Оставьте значение по умолчанию.
* Проверка подлинности IKEv2 несколько. Оставьте значение по умолчанию.

### <a name="4-define-ike-gateways"></a>4. определение шлюзов IKE

Определите шлюзы IKE, чтобы установить связь между одноранговыми узлами в каждом конце туннеля VPN.

Последовательно выберите **сеть**  >  **развернуть профили сети**  >  **шлюзы IKE**  >  **Добавить**, настройте следующие поля и нажмите кнопку **ОК**.

Вкладка "Общие":

* Название Введите имя для шлюза IKE, который должен быть соединен с основным узлом VPN Клаудсимпле.
* Версия. Выберите **режим "только IKEv1**".
* Тип адреса. Выберите **IPv4**.
* Интерфейс. Выберите общедоступный или внешний интерфейс.
* Локальный IP-адрес. Оставьте значение по умолчанию.
* Тип однорангового IP-адреса. Выберите **IP-адрес**.
* Адрес однорангового узла. Введите IP-адрес основного однорангового узла VPN Клаудсимпле.
* Аутентификация. Выберите **общий ключ**.
* Предварительный ключ/подтверждение общего ключа. Введите общий ключ в соответствии с ключом VPN-шлюза Клаудсимпле.
* Локальная идентификация. Введите общедоступный IP-адрес локального брандмауэра Palo Alto.
* Идентификация однорангового узла. Введите IP-адрес основного однорангового узла VPN Клаудсимпле.

Вкладка "Дополнительные параметры":

* Включить пассивный режим. не устанавливайте флажок.
* Включить обход NAT. Не устанавливайте флажок, если локальный брандмауэр Palo Alto не находится за устройством NAT. В противном случае установите флажок.

IKEv1

* Режим Exchange. Выберите **Main**.
* Профиль шифрования IKE. Выберите созданный ранее профиль шифрования IKE. Не устанавливайте флажок Включить фрагментацию.
* Обнаружение недоставленных узлов. Не устанавливайте флажок.

Повторите предыдущие шаги, чтобы создать дополнительный шлюз IKE.

### <a name="5-define-ipsec-crypto-profiles"></a>5. Определение профилей шифрования IPSEC

Последовательно выберите **сеть**  >  **развернуть сети профили**  >  **IPsec шифрование**  >  **Добавить**, настройте следующие поля и нажмите кнопку **ОК**.

* Название Введите имя для профиля шифрования IPsec.
* Протокол IPsec. Выберите **ESP**.
* Шифрование. Нажмите кнопку **Добавить** и выберите соответствующий метод шифрования.
* Аутентификация. Нажмите кнопку **Добавить** и выберите соответствующий метод проверки подлинности.
* DH-группа. Выберите **без PFS**.
* Контролиру. Задается как 30 минут.
* Включить. Не устанавливайте флажок.

Повторите предыдущие шаги, чтобы создать другой профиль шифрования IPsec, который будет использоваться в качестве вторичного VPN-узла Клаудсимпле. Один и тот же профиль шифрования IPSEC можно также использовать как для основного, так и для дополнительного туннелей IPsec (см. следующую процедуру).

### <a name="6-define-monitor-profiles-for-tunnel-monitoring"></a>6. Определение профилей монитора для мониторинга туннеля

Последовательно выберите **сеть**  >  **развернуть сетевые профили**  >  **монитор**  >  **Добавить**, настройте следующие поля и нажмите кнопку **ОК**.

* Название Введите имя профиля монитора, который будет использоваться для мониторинга туннеля, для упреждающего реагирования на сбой.
* Поддержки. Выберите **отработку отказа**.
* Пределах. Введите значение **3**.
* Пороговое значение. Введите значение **7**.

### <a name="7-set-up-primary-and-secondary-ipsec-tunnels"></a>7. Настройка основного и дополнительного туннелей IPsec.

Выберите **сеть**  >  **туннели IPSec**  >  **Добавить**, настройте следующие поля и нажмите кнопку **ОК**.

Вкладка "Общие":

* Название Введите любое имя основного туннеля IPSEC для пиринга с первичным узлом VPN Клаудсимпле.
* Интерфейс туннеля. Выберите интерфейс основного туннеля.
* Введите , Оставьте значение по умолчанию.
* Тип адреса. Выберите **IPv4**.
* Шлюз IKE. Выберите основной шлюз IKE.
* Профиль шифрования IPsec. Выберите первичный профиль IPsec. Выберите пункт **отобразить дополнительные параметры**.
* Включение защиты воспроизведения. Оставьте значение по умолчанию.
* Копировать заголовок TOS. Не устанавливайте флажок.
* Монитор туннеля. Установите флажок.
* Конечный IP-адрес. Введите любой IP-адрес, принадлежащий подсети частного облака Клаудсимпле, которая разрешена для подключения "сеть — сеть". Убедитесь, что туннельные интерфейсы (такие как Tunnel. 20-10.64.5.2/32 и Tunnel. 30-10.64.6.2/32) в Palo Alto могут получить IP-адрес частного облака Клаудсимпле через VPN-подключение типа "сеть — сеть". См. следующую конфигурацию для идентификаторов прокси-сервера.
* Профиля. Выберите профиль монитора.

Вкладка "ИД прокси-сервера": щелкните **IPv4**  >  **добавить** и настройте следующие параметры:

* ИДЕНТИФИКАТОР прокси-сервера. Введите любое имя для интересного трафика. В одном туннеле IPsec может быть перенесено несколько идентификаторов прокси-сервера.
* Локальный. Укажите локальные локальные подсети, которым разрешено взаимодействовать с подсетями частного облака через VPN-подключение типа "сеть — сеть".
* Удаленный. Укажите удаленные подсети частного облака, которым разрешено взаимодействовать с локальными подсетями.
* См. Выберите **любой**.

Повторите предыдущие шаги, чтобы создать другой туннель IPsec, который будет использоваться для вторичного узла VPN Клаудсимпле.

## <a name="references"></a>Ссылки

Настройка NAT для Cisco ASA:

<a href="https://www.cisco.com/c/en/us/td/docs/security/asa/asa84/configuration/guide/asa_84_cli_config/nat_objects.html" target="_blank">Руководства по настройке серии Cisco ASA 5500</a>

Поддерживаемые атрибуты IKEv1 и IKEv2 в Cisco ASA:

<a href="https://www.cisco.com/c/en/us/td/docs/security/asa/asa90/configuration/guide/asa_90_cli_config/vpn_ike.html#21661" target="_blank">Руководства по настройке CLI для серии Cisco ASA</a>

Настройка подключения IPsec типа "сеть — сеть" в Cisco ASA с версией 8,4 и более поздними версиями:

<a href="https://www.cisco.com/c/en/us/support/docs/security/asa-5500-x-series-next-generation-firewalls/119141-configure-asa-00.html#anc8" target="_blank">Настройка туннелей "сеть — сеть" с помощью АСДМ или CLI на ASA</a>

Настройка виртуального устройства адаптивной безопасности Cisco (Асав) в Azure:

<a href="https://www.cisco.com/c/en/us/td/docs/security/asa/asa96/asav/quick-start-book/asav-96-qsg/asav-azure.html" target="_blank">Краткое руководство по использованию виртуального устройства адаптивной безопасности Cisco (Асав)</a>

Настройка VPN-подключения "сеть — сеть" с идентификаторами прокси-сервера в Palo Alto:

[Настройка VPN типа "сеть — сеть"](https://docs.paloaltonetworks.com/pan-os/9-0/pan-os-admin/vpns/set-up-site-to-site-vpn#)

Настройка монитора туннеля:

[Настройка мониторинга туннеля](https://docs.paloaltonetworks.com/pan-os/7-1/pan-os-admin/vpns/set-up-tunnel-monitoring.html)

Действия шлюза IKE или IPsec:

<a href="https://docs.paloaltonetworks.com/pan-os/9-0/pan-os-admin/vpns/set-up-site-to-site-vpn/enabledisable-refresh-or-restart-an-ike-gateway-or-ipsec-tunnel#" target="_blank">Включение, отключение, обновление или перезапуск шлюза IKE или туннеля IPsec</a>
