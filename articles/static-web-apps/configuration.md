---
title: Настройка Статических веб-приложений Azure
description: Узнайте, как настраивать маршруты, применять правила безопасности и глобальные параметры для Статических веб-приложений Azure.
services: static-web-apps
author: craigshoemaker
ms.service: static-web-apps
ms.topic: conceptual
ms.date: 02/18/2021
ms.author: cshoe
ms.openlocfilehash: 280c13fdee281acc4f805aba27a10277eb3988c2
ms.sourcegitcommit: 3f684a803cd0ccd6f0fb1b87744644a45ace750d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/02/2021
ms.locfileid: "106218980"
---
# <a name="configure-azure-static-web-apps"></a>Настройка Статических веб-приложений Azure

Конфигурация для Статических веб-приложений Azure определяется в файле _staticwebapp.config.json_, который отвечает за следующие параметры:

- Маршрутизация
- Аутентификация
- Авторизация
- Правила отката
- Переопределения ответов HTTP
- Глобальные определения заголовков HTTP
- Пользовательские типы MIME

## <a name="file-location"></a>Размещение файла

Мы рекомендуем размещать файл _staticwebapp.config.js_ в папке, которая указана в качестве `app_location` в [файле рабочего процесса](./github-actions-workflow.md). Но вы можете поместить этот файл в любой папке исходного кода приложения.

Дополнительные сведения см. в [примере файла конфигурации](#example-configuration-file).

> [!IMPORTANT]
> [Файл _routes.jsдля_](./routes.md) игнорируется, если существует _staticwebapp.config.json_.

## <a name="routes"></a>Маршруты

Правила маршрутов позволяют определить шаблон URL-адресов, определяющих доступ к приложению в Интернете. Маршруты определяются как массив правил маршрутизации. Примеры определения см. в [примере файла конфигурации](#example-configuration-file).

- Правила определяются в массиве `routes`, даже если имеется только один маршрут.
- Правила выполняются в том порядке, в котором они отображаются в массиве `routes`.
- Оценка правил останавливается при достижении первого соответствия, то есть правила маршрутизации не объединяются в цепочки.
- У вас есть полный контроль над именами настраиваемых ролей.
  - Доступны несколько имен встроенных ролей, например [`anonymous`](./authentication-authorization.md) и [`authenticated`](./authentication-authorization.md).

Вопросы маршрутизации в значительной степени связаны с такими понятиями, как проверка подлинности (идентификацией пользователя) и авторизация (назначению возможностей пользователю). При изучении этой статьи обязательно ознакомьтесь также с руководством по [проверке подлинности и авторизации](authentication-authorization.md).

По умолчанию статическое содержимое размещается в файле *index.html*.

## <a name="defining-routes"></a>Определение маршрутов

Каждое правило состоит из шаблона маршрута, а также одного или нескольких необязательных свойств правила. Правила маршрута определяются в массиве `routes`. Примеры определения см. в [примере файла конфигурации](#example-configuration-file).

| Свойство правила  | Обязательно | Значение по умолчанию | Комментарий                                                      |
| -------------- | -------- | ------------- | ------------------------------------------------------------ |
| `route`        | Да      | Недоступно          | Шаблон маршрута, запрошенный вызывающим объектом.<ul><li>В конце путей маршрутов можно указывать [подстановочные знаки](#wildcards).<ul><li>Например, маршрут _admin/\*_ соответствует любому маршруту по пути _admin_.</ul></ul>|
| `rewrite`        | нет       | Недоступно          | Определяет файл или путь, возвращенные из запроса.<ul><li>Является взаимоисключающим с правилом `redirect`.<li>Правила перезаписи не изменяют адрес в браузере.<li>Значения нужно указывать относительно корня приложения.</ul>  |
| `redirect`        | нет       | Недоступно          | Определяет назначение перенаправления для файла или пути в запросе.<ul><li>Является взаимоисключающим с правилом `rewrite`.<li>Правила перенаправления изменяют адрес в браузере.<li>По умолчанию используется код ответа [`302`](https://developer.mozilla.org/docs/Web/HTTP/Status/302) (временное перенаправление), но можно изменить на [`301`](https://developer.mozilla.org/docs/Web/HTTP/Status/301) (постоянное перенаправление).</ul> |
| `allowedRoles` | нет       | anonymous     | Определяет список имен ролей, которые нужно иметь для доступа к маршруту. <ul><li>Допустимые символы: `a-z`, `A-Z`, `0-9` и `_`.<li>Встроенная роль [`anonymous`](./authentication-authorization.md) применяется ко всем пользователям, не прошедшим проверку подлинности.<li>Встроенная роль [`authenticated`](./authentication-authorization.md) применяется к любому пользователю, вошедшему в систему.<li>Пользователи должны принадлежать по крайней мере к одной роли.<li>Роли сопоставляются с использованием логического оператора _ИЛИ_.<ul><li>Если пользователю присвоена одна из перечисленных ролей, то доступ предоставляется.</ul><li>Отдельные пользователи связываются с ролями с помощью [приглашений](authentication-authorization.md).</ul> |
| `headers`<a id="route-headers"></a> | нет | Недоступно | Набор [заголовков HTTP](https://developer.mozilla.org/docs/Web/HTTP/Headers), которые добавляются в ответ. <ul><li>Заголовки для конкретного маршрута переопределяют значение [`globalHeaders`](#global-headers), если имена заголовков для конкретного маршрута и глобальных заголовков в ответе совпадают.<li>Чтобы удалить заголовок, задайте в качестве значения пустую строку.</ul> |
| `statusCode`   | Нет       | `200`, `301` или `302` для перенаправлений. | [Код состояния HTTP](https://developer.mozilla.org/docs/Web/HTTP/Status) для ответа. |
| `methods` | Нет | Все методы | Список методов запроса, которые сопоставляются с маршрутом. Доступные методы: `GET`, `HEAD`, `POST`, `PUT`, `DELETE`, `CONNECT`, `OPTIONS`, `TRACE` и `PATCH`. |

Каждое свойство имеет определенное назначение в конвейере "запрос — ответ".

| Назначение | Свойства |
|---|---|
| Сопоставление маршрутов | `route`, `methods` |
| Авторизация после сопоставления маршрута. | `allowedRoles` |
| Процесс, выполняемый после сопоставления и авторизации правила. | `rewrite` (изменяет запрос). <br><br>`redirect`, `headers`, `statusCode` (изменяет ответ). |

## <a name="securing-routes-with-roles"></a>Защита маршрутов с помощью ролей

Для защиты маршрутов в массив правил `allowedRoles` добавляются одно или несколько имен ролей, а пользователи сопоставляются с пользовательскими ролями с помощью [приглашений](./authentication-authorization.md). Примеры определения см. в [примере файла конфигурации](#example-configuration-file).

По умолчанию каждый пользователь принадлежит к встроенной роли `anonymous`, а все вошедшие в систему пользователи являются членами роли `authenticated`.

Например, чтобы ограничить маршрут только пользователями, прошедшими проверку подлинности, добавьте встроенную роль `authenticated` в массив `allowedRoles`.

```json
{
  "route": "/profile",
  "allowedRoles": ["authenticated"]
}
```

При необходимости в массиве `allowedRoles` можно создать новые роли. Чтобы маршрут был доступен только администраторам, можно определить собственную роль `administrator` в массиве `allowedRoles`.

```json
{
  "route": "/admin",
  "allowedRoles": ["administrator"]
}
```

- Вы можете выбрать любые имена ролей; не существует никаких обязательных списков.
- Отдельные пользователи связываются с ролями с помощью [приглашений](authentication-authorization.md).

## <a name="wildcards"></a>Подстановочные знаки

Правила с подстановочными знаками сопоставляются с любым запросом в шаблоне маршрута. Их можно использовать только в конце пути и фильтровать по расширению файла. Примеры определения см. в [примере файла конфигурации](#example-configuration-file).

Например, для реализации маршрутов в приложении календаря можно перенаправить все URL-адреса, соответствующие маршруту _calendar_, к одному файлу.

```json
{
  "route": "/calendar/*",
  "rewrite": "/calendar.html"
}
```

Тогда файл _calendar.html_ может использовать маршрутизацию на стороне клиента для предоставления разных представлений для различных вариантов URL-адресов, например `/calendar/january/1`, `/calendar/2020` и `/calendar/overview`.

Вы можете фильтровать совпадения с подстановочными знаками по расширению файла. Например, можно добавить правило, которое соответствует только HTML-файлам по указанному пути:

```json
{
  "route": "/articles/*.html",
  "headers" : {
    "Cache-Control": "public, max-age=604800, immutable"
  }
}
```

Чтобы фильтровать совпадения по нескольким расширениям файлов, перечислите все нужные варианты в фигурных скобках, как в следующем примере:

```json
{
  "route": "/images/thumbnails/*.{png,jpg,gif}",
  "headers": {
    "Cache-Control": "public, max-age=604800, immutable"
  }
}
```

Вот несколько типичных примеров использования для маршрутов с подстановочными знаками:

- обслуживание определенного файла для всего шаблона пути;
- сопоставление разных методов HTTP для всего шаблона пути;
- применение правил проверки подлинности и авторизации;
- реализация специальных правил кэширования.

## <a name="fallback-routes"></a>Резервные маршруты

Одностраничные приложения часто используют маршрутизацию на стороне клиента. Эти правила маршрутизации на стороне клиента обновляют расположение окна в браузере без отправки обратных запросов на сервер. При обновлении страницы или прямом переходе по URL-адресам, созданным правилами маршрутизации на стороне клиента, требуется использовать резервный маршрут для обработки соответствующей страницы HTML (обычно это _index.html_ для приложения на стороне клиента).

Чтобы реализовать резервный маршрут, вы можете настроить для приложения правила с подстановочным знаком и фильтром файлов, как показано в следующем примере:

```json
{
  "navigationFallback": {
    "rewrite": "/index.html",
    "exclude": ["/images/*.{png,jpg,gif}", "/css/*"]
  }
}
```

Для файловой структуры в примере ниже это правило может возвращать следующие результаты.

```files
├── images
│   ├── logo.png
│   ├── headshot.jpg
│   └── screenshot.gif
│
├── css
│   └── global.css
│
└── index.html
```

| Запрашиваемая папка | Возвращаемый файл | Состояние ответа |
| --- | --- | --- |
| */about/* | */index.html* | `200` |
| */images/logo.png* | Файл изображения  | `200` |
| */images/icon.svg* | */index.html*, так как расширение *svg* отсутствует в фильтре `/images/*.{png,jpg,gif}`   | `200` |
| */images/unknown.png* | Ошибка "Файл не найден"  | `404` |
| */css/unknown.css* | Ошибка "Файл не найден"  | `404` |
| */css/global.css* | Файл таблицы стилей | `200` |
| Любой другой файл за пределами папок */images* или */css* | */index.html* | `200` |

## <a name="global-headers"></a>Глобальные заголовки

Раздел `globalHeaders` содержит набор [HTTP-заголовков](https://developer.mozilla.org/docs/Web/HTTP/Headers), которые применяются к каждому ответу, если этот набор не переопределяется правилом [заголовка маршрута](#route-headers). В противном случае возвращается объединение заголовков из маршрута и глобальных заголовков.

Примеры определения см. в [примере файла конфигурации](#example-configuration-file).

Чтобы удалить заголовок, задайте в качестве значения пустую строку (`""`).

Ниже приведены типичные примеры использования глобальных заголовков.

- Настраиваемые правила кэширования
- Применение политик безопасности
- Параметры кодирования

## <a name="response-overrides"></a>Переопределения ответов

Раздел `responseOverrides` позволяет определить пользовательский ответ для ситуаций, в которых сервер иначе возвращал бы код ошибки. Примеры определения см. в [примере файла конфигурации](#example-configuration-file).

Для переопределения доступны следующие коды HTTP.

| Код состояния | Значение | Возможные причины |
| --- | --- | --- |
| [400](https://developer.mozilla.org/docs/Web/HTTP/Status/400) | Недопустимый запрос | Недопустимая ссылка приглашения. |
| [401](https://developer.mozilla.org/docs/Web/HTTP/Status/401) | Не авторизовано | Запрос к страницам с ограничением доступа без проверки подлинности. |
| [403](https://developer.mozilla.org/docs/Web/HTTP/Status/403) | Запрещено |<ul><li>Пользователь вошел в систему, но не имеет необходимых ролей для просмотра этой страницы.<li>Пользователь вошел в систему, но среда выполнения не может получить сведения о пользователе из идентификационных утверждений.<li>Слишком много пользователей вошли на сайт с пользовательскими ролями, поэтому среда выполнения не разрешает пользователю выполнить вход.</ul> |
| [404](https://developer.mozilla.org/docs/Web/HTTP/Status/404) | Не найдено | Файл не найден |

В следующем примере конфигурации показано, как переопределить код ошибки.

```json
{
    "responseOverrides": {
        "400" : {
            "rewrite": "/invalid-invitation-error.html",
            "statusCode": 200
        },
        "401": {
            "statusCode": 302,
            "redirect": "/login"
        },
        "403": {
            "rewrite": "/custom-forbidden-page.html",
            "statusCode": 200
        },
        "404": {
            "rewrite": "/custom-404.html",
            "statusCode": 200
        }
    }
}
```

## <a name="example-configuration-file"></a>Пример файла конфигурации

```json
{
    "routes": [
        {
            "route": "/profile",
            "allowedRoles": ["authenticated"]
        },
        {
            "route": "/admin/*",
            "allowedRoles": ["administrator"]
        },
        {
            "route": "/images/*",
            "headers": {
                "cache-control": "must-revalidate, max-age=15770000"
            }
        },
        {
            "route": "/api/*",
            "methods": [ "GET" ],
            "allowedRoles": ["registeredusers"]
        },
        {
            "route": "/api/*",
            "methods": [ "PUT", "POST", "PATCH", "DELETE" ],
            "allowedRoles": ["administrator"]
        },
        {
            "route": "/api/*",
            "allowedRoles": ["authenticated"]
        },
        {
            "route": "/customers/contoso",
            "allowedRoles": ["administrator", "customers_contoso"]
        },
        {
            "route": "/login",
            "rewrite": "/.auth/login/github"
        },
        {
            "route": "/.auth/login/twitter",
            "statusCode": 404
        },
        {
            "route": "/logout",
            "redirect": "/.auth/logout"
        },
        {
            "route": "/calendar/*",
            "rewrite": "/calendar.html"
        },
        {
            "route": "/specials",
            "redirect": "/deals",
            "statusCode": 301
        }
    ],
    "navigationFallback": {
      "rewrite": "index.html",
      "exclude": ["/images/*.{png,jpg,gif}", "/css/*"]
    },
    "responseOverrides": {
        "400" : {
            "rewrite": "/invalid-invitation-error.html"
        },
        "401": {
            "redirect": "/login",
            "statusCode": 302
        },
        "403": {
            "rewrite": "/custom-forbidden-page.html"
        },
        "404": {
            "rewrite": "/404.html"
        }
    },
    "globalHeaders": {
        "content-security-policy": "default-src https: 'unsafe-eval' 'unsafe-inline'; object-src 'none'"
    },
    "mimeTypes": {
        ".json": "text/json"
    }
}
```

Ознакомьтесь со следующими сценариями для приведенной выше конфигурации.

| Запрашиваемая папка | Возвращаемый результат |
| --- | --- |
| _/profile_ | Для пользователей, прошедших проверку подлинности, выполняется обработка файла _/profile/index.html_. Пользователи, не прошедшие проверку подлинности, перенаправляются на адрес _/login_. |
| _/admin/_ | Для пользователей, прошедших проверку подлинности в роли _administrators_, предоставляется файл _/admin/index.html_. Пользователи, прошедшие проверку подлинности, но не зарегистрированные в роли _administrator_, получают ошибку `403`<sup>1</sup>. Пользователи, не прошедшие проверку подлинности, перенаправляются на адрес _/login_. |
| _/logo.png_ | Возвращает изображение, для которого применяется пользовательское правило кэширования, определяющее максимальный возраст чуть более 182 дней (15 770 000 секунд). |
| _/api/admin_ | Запросы `GET` от пользователей, прошедших проверку подлинности, у которых есть роль _registeredusers_, отправляются в API. Пользователи, не прошедшие проверку подлинности или не имеющие роли _registeredusers_, получают ошибку `401`.<br/><br/>Запросы `POST`, `PUT`, `PATCH` и `DELETE` от пользователей, прошедших проверку подлинности, у которых есть роль _administrator_, отправляются в API. Пользователи, не прошедшие проверку подлинности или не имеющие роли _administrator_, получают ошибку `401`. |
| _/customers/contoso_ | Пользователям, прошедшим проверку подлинности и имеющим роль _administrators_ или _customers\_contoso_, предоставляется файл _/customers/contoso/index.html_. Пользователи, прошедшие проверку подлинности, но не имеющие роли _administrators_ или _customers\_contoso_, получают `403`ошибку <sup>1</sup>. Пользователи, не прошедшие проверку подлинности, перенаправляются на адрес _/login_. |
| _/login_ | Пользователям, не прошедшим проверку подлинности, предлагается сделать это с помощью GitHub. |
| _/.auth/login/twitter_ | Так как правило маршрута `404` отключает авторизацию через Twitter, возвращается ошибка и выполняется обработка _index.html_ с кодом состояния `200`. |
| _/logout_ | Пользователи вышли из какого-либо поставщика проверки подлинности. |
| _/calendar/2021/01_ | В браузере обрабатывается файл _/calendar.html_. |
| _/specials_ | Браузер постоянно перенаправляется на _/deals_. |
| _/data.json_ | Предоставляется файл с типом MIME `text/json`. |
| _/about_ или любая другая папка, соответствующая шаблонам маршрутизации на стороне клиента. | Предоставляется файл _/index.html_ с кодом состояния `200`. |
| Несуществующий файл в папке _/images/_ | Ошибка `404`. |

<sup>1</sup> Вы можете предоставлять настраиваемую страницу ошибки, используя [правило переопределения ответа](#response-overrides).

## <a name="restrictions"></a>Ограничения

Для файла _staticwebapps.config.jsв_ файле существуют следующие ограничения.

- Максимальный размер 100 КБ.
- Не более 50 различных ролей.

Общие ограничения см. в [статье о квотах](quotas.md).

## <a name="next-steps"></a>Дальнейшие действия

> [!div class="nextstepaction"]
> [Настройка проверки подлинности и авторизации](authentication-authorization.md)
