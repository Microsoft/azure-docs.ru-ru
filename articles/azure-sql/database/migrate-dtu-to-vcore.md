---
title: Переход с DTU на виртуальное ядро
description: Перенос базы данных в базе данных SQL Azure из модели DTU в модель Виртуальное ядро. Переход на виртуальное ядро аналогичен обновлению или переходу на более раннюю версию уровня "Стандартный" и "Премиум".
services: sql-database
ms.service: sql-database
ms.subservice: service
ms.topic: conceptual
ms.custom: sqldbrb=1
author: stevestein
ms.author: sstein
ms.reviewer: sashan, moslake
ms.date: 02/09/2021
ms.openlocfilehash: 332a2273a377268a425619a0cdaa5f4780b46e73
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "100361661"
---
# <a name="migrate-azure-sql-database-from-the-dtu-based-model-to-the-vcore-based-model"></a>Перенос базы данных SQL Azure из модели на основе DTU в модель на основе виртуальное ядро
[!INCLUDE[appliesto-sqldb](../includes/appliesto-sqldb.md)]

В этой статье описывается, как перенести базу данных в базу данных SQL Azure из [модели приобретения на основе DTU](service-tiers-dtu.md) в [модель приобретения на основе виртуальное ядро](service-tiers-vcore.md). 

## <a name="migrate-a-database"></a>Перенос базы данных

Перенос базы данных из модели приобретения на основе DTU в модель приобретения на основе виртуальное ядро аналогична масштабированию между целями службы на уровнях служб "базовый", "Стандартный" и "Премиум", с одинаковой [длительностью](single-database-scale.md#latency) и [минимальным временем простоя](scale-resources.md) в конце процесса миграции. База данных, перенесенная в модель приобретения на основе виртуальное ядро, может быть перенесена обратно в модель приобретения на основе DTU в любое время, за исключением баз данных, перенесенных на уровень службы "веб- [масштабирование](service-tier-hyperscale.md) ". 

## <a name="choose-the-vcore-service-tier-and-service-objective"></a>Выбор уровня службы Виртуальное ядро и цели обслуживания

Для большинства Виртуальное ядро сценариев миграции базы данных и эластичные пулы на уровне служб "базовый" и "Стандартный" будут сопоставляться с уровнем служб [общего назначения](service-tier-general-purpose.md) . Базы данных и эластичные пулы на уровне служб Premium будут сопоставляться с уровнем служб [критически важный для бизнеса](service-tier-business-critical.md) . В зависимости от сценария и требований приложения, уровень службы " [горизонтальное масштабирование](service-tier-hyperscale.md) " часто может использоваться в качестве цели миграции для отдельных баз данных на всех уровнях служб DTU.

Чтобы выбрать цель службы или размер вычислений для перенесенной базы данных в модели Виртуальное ядро, можно использовать простое, но приближенное правило: каждые 100 DTU на уровнях "базовый" или "Стандартный" требуется по крайней *мере* 1 Виртуальное ядро, а для каждых 125 DTU на уровне Premium требуется *по крайней мере* 1 Виртуальное ядро. 

> [!TIP]
> Это правило является приблизительным, поскольку оно не учитывает создание оборудования, используемое для базы данных DTU или эластичного пула. 

В модели DTU любое доступное [поколение оборудования](purchasing-models.md#hardware-generations-in-the-dtu-based-purchasing-model) можно использовать для базы данных или эластичного пула. Кроме того, вы можете получить только непрямое Управление числом виртуальных ядер (логическими процессорами), выбрав более высокие или более низкие значения DTU или eDTU. 

При использовании модели Виртуальное ядро клиентам необходимо явно выбрать как создание оборудования, так и число виртуальных ядер (логических ЦП). Модель DTU не поддерживает эти варианты, однако создание оборудования и число логических процессоров, используемых для каждой базы данных и эластичного пула, предоставляются через динамические административные представления. Это позволяет точнее определить соответствующую цель службы Виртуальное ядро. 

Следующий подход использует эти сведения для определения цели службы Виртуальное ядро с аналогичным выделением ресурсов, чтобы получить такой же уровень производительности после миграции в модель Виртуальное ядро.

### <a name="dtu-to-vcore-mapping"></a>Сопоставление DTU с виртуальное ядро

Следующий запрос T-SQL, выполняемый в контексте переносимой базы данных DTU, возвращает соответствующее (возможно, дробное) число виртуальных ядер в каждом формировании оборудования в модели Виртуальное ядро. При округлении этого числа до ближайшего числа виртуальных ядер, доступного для [баз данных](resource-limits-vcore-single-databases.md) и [эластичных пулов](resource-limits-vcore-elastic-pools.md) в каждом формировании оборудования в модели Виртуальное ядро, клиенты могут выбрать цель службы Виртуальное ядро, наиболее близкую к соответствующей базе данных DTU или эластичному пулу. 

Примеры сценариев миграции с использованием этого подхода описаны в разделе " [примеры](#dtu-to-vcore-migration-examples) ".

Выполните этот запрос в контексте переносимой базы данных, а не в `master` базе данных. При миграции эластичного пула выполните запрос в контексте любой базы данных в пуле.

```SQL
WITH dtu_vcore_map AS
(
SELECT rg.slo_name,
       DATABASEPROPERTYEX(DB_NAME(), 'Edition') AS dtu_service_tier,
       CASE WHEN rg.slo_name LIKE '%SQLG4%' THEN 'Gen4'
            WHEN rg.slo_name LIKE '%SQLGZ%' THEN 'Gen4'
            WHEN rg.slo_name LIKE '%SQLG5%' THEN 'Gen5'
            WHEN rg.slo_name LIKE '%SQLG6%' THEN 'Gen5'
            WHEN rg.slo_name LIKE '%SQLG7%' THEN 'Gen5'
       END AS dtu_hardware_gen,
       s.scheduler_count * CAST(rg.instance_cap_cpu/100. AS decimal(3,2)) AS dtu_logical_cpus,
       CAST((jo.process_memory_limit_mb / s.scheduler_count) / 1024. AS decimal(4,2)) AS dtu_memory_per_core_gb
FROM sys.dm_user_db_resource_governance AS rg
CROSS JOIN (SELECT COUNT(1) AS scheduler_count FROM sys.dm_os_schedulers WHERE status = 'VISIBLE ONLINE') AS s
CROSS JOIN sys.dm_os_job_object AS jo
WHERE dtu_limit > 0
      AND
      DB_NAME() <> 'master'
      AND
      rg.database_id = DB_ID()
)
SELECT dtu_logical_cpus,
       dtu_hardware_gen,
       dtu_memory_per_core_gb,
       dtu_service_tier,
       CASE WHEN dtu_service_tier = 'Basic' THEN 'General Purpose'
            WHEN dtu_service_tier = 'Standard' THEN 'General Purpose or Hyperscale'
            WHEN dtu_service_tier = 'Premium' THEN 'Business Critical or Hyperscale'
       END AS vcore_service_tier,
       CASE WHEN dtu_hardware_gen = 'Gen4' THEN dtu_logical_cpus
            WHEN dtu_hardware_gen = 'Gen5' THEN dtu_logical_cpus * 0.7
       END AS Gen4_vcores,
       7 AS Gen4_memory_per_core_gb,
       CASE WHEN dtu_hardware_gen = 'Gen4' THEN dtu_logical_cpus * 1.7
            WHEN dtu_hardware_gen = 'Gen5' THEN dtu_logical_cpus
       END AS Gen5_vcores,
       5.05 AS Gen5_memory_per_core_gb,
       CASE WHEN dtu_hardware_gen = 'Gen4' THEN dtu_logical_cpus
            WHEN dtu_hardware_gen = 'Gen5' THEN dtu_logical_cpus * 0.8
       END AS Fsv2_vcores,
       1.89 AS Fsv2_memory_per_core_gb,
       CASE WHEN dtu_hardware_gen = 'Gen4' THEN dtu_logical_cpus * 1.4
            WHEN dtu_hardware_gen = 'Gen5' THEN dtu_logical_cpus * 0.9
       END AS M_vcores,
       29.4 AS M_memory_per_core_gb
FROM dtu_vcore_map;
```

### <a name="additional-factors"></a>Дополнительные факторы

Помимо количества виртуальных ядер (логических ЦП) и создания оборудования, некоторые другие факторы могут повлиять на выбор цели службы Виртуальное ядро:

- Запрос T-SQL сопоставления соответствует целям службы DTU и виртуальное ядро с точки зрения их мощности ЦП, поэтому результаты будут более точными для рабочих нагрузок, привязанных к ЦП.
- Для одного и того же поколения аппаратных ресурсов виртуальных ядер, операций ввода-вывода и ограничения пропускной способности журнала транзакций для баз данных Виртуальное ядро часто имеют больший размер, чем для баз данных DTU. Для рабочих нагрузок, привязанных к операциям ввода-вывода, можно уменьшить число виртуальных ядер в модели Виртуальное ядро, чтобы добиться того же уровня производительности. Ограничения ресурсов для баз данных DTU и виртуальное ядро в абсолютных значениях представлены в представлении [sys.dm_user_db_resource_governance](/sql/relational-databases/system-dynamic-management-views/sys-dm-user-db-resource-governor-azure-sql-database) . Сравнение этих значений между переносимой базой данных DTU и базой данных Виртуальное ядро с помощью приблизительно совпадающей цели службы поможет вам более точно выбрать цель службы Виртуальное ядро.
- Запрос сопоставления также возвращает объем памяти на ядро для переносимой базы данных DTU или эластичного пула и для каждого создания оборудования в модели Виртуальное ядро. Обеспечение приблизительного или более общего объема памяти после миграции на виртуальное ядро важно для рабочих нагрузок, требующих кэш данных большого объема памяти для достижения достаточной производительности, или рабочих нагрузок, требующих большого объема памяти для обработки запросов. Для таких рабочих нагрузок, в зависимости от фактической производительности, может потребоваться увеличить число виртуальных ядер, чтобы получить достаточно общего объема памяти.
- При выборе цели обслуживания Виртуальное ядро следует учитывать [хронологию использования ресурсов](/sql/relational-databases/system-catalog-views/sys-resource-stats-azure-sql-database) в базе данных DTU. Для баз данных DTU с постоянно используемыми ресурсами ЦП может потребоваться меньше виртуальных ядер, чем число, возвращенное запросом сопоставления. Напротив, базы данных DTU, в которых постоянно высокая загрузка ЦП приводит к недостаточной производительности рабочей нагрузки, могут потребовать больше виртуальных ядер, чем возвращает запрос.
- При миграции баз данных с временными или непредсказуемыми шаблонами использования следует рассмотреть использование [Бессерверного](serverless-tier-overview.md) уровня вычислений. Обратите внимание, что максимальное количество одновременных рабочих ролей (запросов) в бессерверной конфигурации составляет 75% от предела в подготовленных вычислений для того же числа настроенных максимальных виртуальных ядер. Кроме того, максимальный объем доступной памяти на сервере составляет 3 ГБ, что превышает максимальное число виртуальных ядер. Например, максимальный объем памяти составляет 120 ГБ при настройке 40 Max виртуальных ядер.   
- В модели Виртуальное ядро максимальный поддерживаемый размер базы данных может отличаться в зависимости от создания оборудования. Для больших баз данных проверьте Поддерживаемые максимальные размеры в модели Виртуальное ядро для [отдельных баз данных](resource-limits-vcore-single-databases.md) и [эластичных пулов](resource-limits-vcore-elastic-pools.md).
- Для эластичных пулов модели [DTU](resource-limits-dtu-elastic-pools.md) и [Виртуальное ядро](resource-limits-vcore-elastic-pools.md) имеют различия в максимальном поддерживаемом количестве баз данных на пул. Это следует учитывать при переносе эластичных пулов с большим количеством баз данных.
- Некоторые поколения оборудования могут быть недоступны в каждом регионе. Проверьте доступность в разделе [поколений оборудования](service-tiers-vcore.md#hardware-generations).

> [!IMPORTANT]
> Приведенные выше рекомендации по изменению количества DTU Виртуальное ядро, чтобы помочь в первоначальной оценке целевой цели службы базы данных.
>
> Оптимальная конфигурация целевой базы данных зависит от рабочей нагрузки. Таким образом, достижение оптимального соотношения цены и производительности после миграции может потребовать использования гибкости модели Виртуальное ядро для настройки количества виртуальных ядер, [создания оборудования](service-tiers-vcore.md#hardware-generations), уровней [обслуживания](service-tiers-vcore.md#service-tiers) и [вычислений](service-tiers-vcore.md#compute-tiers) , а также настройки других параметров конфигурации базы данных, таких как [Максимальная степень параллелизма](/sql/relational-databases/query-processing-architecture-guide#parallel-query-processing).
> 

### <a name="dtu-to-vcore-migration-examples"></a>Примеры миграции DTU на виртуальное ядро

> [!NOTE]
> Значения в приведенных ниже примерах предназначены только для иллюстрации. Фактические значения, возвращаемые в описанных сценариях, могут отличаться.
> 

**Миграция стандартной базы данных S9**

Запрос сопоставления возвращает следующий результат (некоторые столбцы, не показанные для краткости):

|dtu_logical_cpus|dtu_hardware_gen|dtu_memory_per_core_gb|Gen4_vcores|Gen4_memory_per_core_gb|Gen5_vcores|Gen5_memory_per_core_gb|
|----------------|----------------|----------------------|-----------|-----------------------|-----------|-----------------------|
|24,00|5-го поколения|5,40|16,800|7|24,000|5,05|

Мы видим, что база данных DTU содержит 24 логических ЦП (виртуальных ядер) с 5,4 ГБ памяти на виртуальное ядро и использует го поколения оборудование. Непосредственное совпадение — это общего назначения 24 Виртуальное ядро база данных на го поколения оборудовании, т. е. Цель службы **GP_Gen5_24** Виртуальное ядро.

**Перенос стандартной базы данных S0**

Запрос сопоставления возвращает следующий результат (некоторые столбцы, не показанные для краткости):

|dtu_logical_cpus|dtu_hardware_gen|dtu_memory_per_core_gb|Gen4_vcores|Gen4_memory_per_core_gb|Gen5_vcores|Gen5_memory_per_core_gb|
|----------------|----------------|----------------------|-----------|-----------------------|-----------|-----------------------|
|0,25|4-е поколение|0,42|0,250|7|0,425|5,05|

Мы видим, что база данных DTU имеет эквивалент 0,25 логических ЦП (виртуальных ядер) с 0,42 Гб памяти на виртуальное ядро и использует го поколения оборудование. Минимальные цели Виртуальное ядро Service в поколениях го поколения и го поколения оборудования, **GP_Gen4_1** и **GP_Gen5_2**, предоставляют больше ресурсов вычислений, чем стандартная база данных S0, поэтому прямое соответствие невозможно. Так как оборудование го поколения выдается из [эксплуатации](https://azure.microsoft.com/updates/gen-4-hardware-on-azure-sql-database-approaching-end-of-life-in-2020/), рекомендуется использовать параметр **GP_Gen5_2** . Кроме того, если Рабочая нагрузка хорошо подходит для уровня вычислений, отличного от [сервера](serverless-tier-overview.md) , **GP_S_Gen5_1** будет более близким соответствием.

**Миграция базы данных Premium p15**

Запрос сопоставления возвращает следующий результат (некоторые столбцы, не показанные для краткости):

|dtu_logical_cpus|dtu_hardware_gen|dtu_memory_per_core_gb|Gen4_vcores|Gen4_memory_per_core_gb|Gen5_vcores|Gen5_memory_per_core_gb|
|----------------|----------------|----------------------|-----------|-----------------------|-----------|-----------------------|
|42,00|5-го поколения|4,86|29,400|7|42,000|5,05|

Мы видим, что база данных DTU имеет 42 логических ЦП (виртуальных ядер) с 4,86 ГБ памяти на виртуальное ядро и использует го поколения оборудование. Хотя не существует цели Виртуальное ядро Service с 42 ядрами, Цель службы **BC_Gen5_40** очень близка к производительности ЦП и памяти, и это хорошее соответствие.

**Миграция пула эластичных БД базового 200 eDTU**

Запрос сопоставления возвращает следующий результат (некоторые столбцы, не показанные для краткости):

|dtu_logical_cpus|dtu_hardware_gen|dtu_memory_per_core_gb|Gen4_vcores|Gen4_memory_per_core_gb|Gen5_vcores|Gen5_memory_per_core_gb|
|----------------|----------------|----------------------|-----------|-----------------------|-----------|-----------------------|
|4,00|5-го поколения|5,40|2,800|7|4,000|5,05|

Мы видим, что эластичный пул DTU содержит 4 логических ЦП (виртуальных ядер) с 5,4 ГБ памяти на виртуальное ядро и использует го поколения оборудование. Прямым соответствием в модели Виртуальное ядро является **GP_Gen5_4** эластичный пул. Однако этот целевой объект службы поддерживает не более 200 баз данных на пул, а пул эластичных баз данных "базовый 200 eDTU" поддерживает до 500. Если эластичный пул для переноса содержит более 200 баз данных, необходимо **GP_Gen5_6** соответствующей цели службы Виртуальное ядро, которая поддерживает до 500 баз данных.

## <a name="migrate-geo-replicated-databases"></a>Миграция геореплицированных баз данных

Миграция из модели на основе DTU в модель приобретения на основе виртуальное ядро аналогична обновлению или понижению отношений георепликации между базами данных на уровнях служб "Стандартный" и "Премиум". Во время миграции не нужно прекращать георепликацию, но необходимо соблюдать следующие правила виртуализации:

- При повышении сначала повысьте уровень производительности базы данных-получателя, а затем — уровень базы данных-источника.
- При понижении следует действовать в обратном порядке: сначала нужно понизить уровень производительности базы данных-источника, а после этого — базы данных-получателя.

При использовании георепликации между двумя эластичными пулами рекомендуется назначить один пул основным, а другой — сервером-получателем. В этом случае при переносе эластичных пулов следует использовать одно и то же руководство по виртуализации. Однако если у вас есть эластичные пулы, которые содержат как первичную, так и базу данных-получатель, рассматривайте пул с более высоким уровнем использования в качестве сервера-источника и следуйте соответствующим правилам.  

В следующей таблице приведены рекомендации по конкретным сценариям миграции.

|Текущий уровень служб|Целевой уровень служб|Тип перемещения|Действия пользователя|
|---|---|---|---|
|Стандартный|Общего назначения|Горизонтальный|Может выполнять миграцию в любом порядке, но необходимо обеспечить соответствующее виртуальное ядрое определение, как описано выше.|
|Premium|Критически важный для бизнеса уровень|Горизонтальный|Может выполнять миграцию в любом порядке, но необходимо обеспечить соответствующее виртуальное ядрое определение, как описано выше.|
|Стандартный|Критически важный для бизнеса уровень|Обновление|Сначала необходимо перенести базу данных-получатель|
|Критически важный для бизнеса уровень|Стандартный|Понижение уровня|Сначала необходимо перенести базу данных-источник|
|Premium|Общего назначения|Понижение уровня|Сначала необходимо перенести базу данных-источник|
|Общего назначения|Premium|Обновление|Сначала необходимо перенести базу данных-получатель|
|Критически важный для бизнеса уровень|Общего назначения|Понижение уровня|Сначала необходимо перенести базу данных-источник|
|Общего назначения|Критически важный для бизнеса уровень|Обновление|Сначала необходимо перенести базу данных-получатель|
||||

## <a name="migrate-failover-groups"></a>Перенос групп отработки отказа

Перемещение групп отработки отказа с несколькими базами данных требует отдельного перемещения базы данных-источника и базы данных-получателя. Во время этого процесса применяются те же рекомендации и правила последовательности. После преобразования баз данных в модель приобретения на основе виртуальное ядро группа отработки отказа останется в силе с теми же параметрами политики.

### <a name="create-a-geo-replication-secondary-database"></a>Создание базы данных-получателя георепликации

Базу данных-получатель георепликации (геовторичную реплику) можно создать только с помощью того же уровня служб, который использовался для базы данных-источника. Для баз данных с высокой частотой создания журналов рекомендуется создать геовторичный объект с тем же размером вычислений, что и у первичного.

Если вы создаете геовторичную реплику в эластичном пуле для одной базы данных-источника, убедитесь, что `maxVCore` параметр для пула соответствует размеру вычислений базы данных-источника. Если вы создаете геовторичную реплику для первичного пула в другом эластичном пуле, рекомендуется, чтобы пулы имели одинаковые `maxVCore` Параметры.

## <a name="use-database-copy-to-migrate-from-dtu-to-vcore"></a>Использование копирования базы данных для миграции с DTU на виртуальное ядро

Вы можете скопировать любую базу данных с объемом вычислительных ресурсов на основе DTU в базу данных с объемом вычислительных ресурсов на основе виртуальных ядер без ограничений или соблюдения специальной последовательности, если целевой объем вычислительных ресурсов поддерживает максимальный размер базы данных-источника. Копия базы данных создает моментальный снимок данных на момент начала операции копирования и не синхронизирует данные между источником и целевым объектом.

## <a name="next-steps"></a>Дальнейшие действия

- Сведения о конкретных размерах вычислений и размерах хранилища, доступных для отдельных баз данных, см. в статье [ограничения ресурсов на основе виртуальное ядро базы данных SQL для отдельных баз](resource-limits-vcore-single-databases.md)данных.
- Конкретные размеры вычислений и выбор размера хранилища, доступные для эластичных пулов, см. в разделе [SQL Database Виртуальное ядро Limits for эластичные пулы](resource-limits-vcore-elastic-pools.md).