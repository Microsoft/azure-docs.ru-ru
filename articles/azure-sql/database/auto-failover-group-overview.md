---
title: Группы автоматической отработки отказа
titleSuffix: Azure SQL Database & SQL Managed Instance
description: Группы автоматической отработки отказа позволяют управлять репликацией и автоматической или координированной отработкой отказа группы баз данных на сервере или во всех базах данных в управляемом экземпляре.
services: sql-database
ms.service: sql-db-mi
ms.subservice: high-availability
ms.custom: sqldbrb=2, devx-track-azurecli
ms.devlang: ''
ms.topic: conceptual
author: anosov1960
ms.author: sashan
ms.reviewer: mathoma, sstein
ms.date: 12/26/2020
ms.openlocfilehash: e0b9eea7be97b9b67e75c314c4a1d9e69322e5b5
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "104594263"
---
# <a name="use-auto-failover-groups-to-enable-transparent-and-coordinated-failover-of-multiple-databases"></a>Использование групп автоматической отработки отказа для включения прозрачной и согласованной отработки отказа в нескольких базах данных
[!INCLUDE[appliesto-sqldb-sqlmi](../includes/appliesto-sqldb-sqlmi.md)]

Группы автоматической отработки отказа позволяют управлять репликацией и отработкой отказа группы баз данных на сервере или всех базах данных в управляемом экземпляре в другом регионе. Это декларативная абстракция поверх существующей функции [активной георепликации](active-geo-replication-overview.md) , предназначенной для упрощения развертывания геореплицируемых баз данных и управления ими в масштабе. Вы можете инициировать отработку отказа вручную или делегировать ее службе Azure на основе определяемой пользователем политики. Последний вариант позволяет автоматически восстанавливать несколько связанных баз данных в дополнительном регионе после разрушительного сбоя или другого незапланированного события, которое приводит к полной или частичной утрате базы данных SQL или доступности SQL Управляемый экземпляр в основном регионе. Группа отработки отказа может включать одну или несколько баз данных, обычно используемых одним приложением. Кроме того, клиенты могут использовать доступные для чтения базы данных-получатели для разгрузки рабочих нагрузок запросов, доступных только для чтения. Так как группы автоматической отработки отказа включают в себя несколько баз данных, базы данных необходимо настроить на сервере-источнике. Группы автоматической отработки отказа поддерживают репликацию всех баз данных в группе только на один сервер-получатель или экземпляр в другом регионе.

> [!NOTE]
> Если требуется несколько баз данных SQL Azure в одном или разных регионах, используйте [активную георепликацию](active-geo-replication-overview.md).

Во время работы с группами автоматической отработки отказа с политикой автоматической отработки отказа любой сбой, который влияет на одну или на несколько баз данных в группе, приведет к автоматической отработке отказа. Обычно это инциденты, которые невозможно устранить самостоятельно с помощью встроенных автоматических операций высокой доступности. Примеры триггеров отработки отказа включают в себя инцидент, вызванный кругом клиентов базы данных SQL или Контрольный звонок, который не работает из-за утечки памяти ядра операционной системы на нескольких службах вычислений, или инцидента, вызванного неисправностью одного или нескольких звонков клиента, так как при списании аппаратного обеспечения произошла ошибка сетевого кабеля.  Дополнительные сведения см. в статье [Высокая доступность базы данных SQL](high-availability-sla.md).

Кроме того, группы автоматической отработки отказа предоставляют конечные точки прослушивателя только для чтения и для чтения-записи, которые во время отработки отказа не изменяются. Независимо от того, используете ли вы активацию вручную или автоматическую активацию отработки отказа, отработка отказа переключит все базы данных-получатели в группе в базу данных-источник. После выполнения автоматической отработки отказа базы данных запись DNS автоматически обновляется, чтобы перенаправить конечные точки в новый регион. Конкретные сведения о RPO и RTO можно найти в [обзоре обеспечения непрерывности бизнес-процессов](business-continuity-high-availability-disaster-recover-hadr-overview.md).

При использовании групп автоматической отработки отказа с политикой автоматической отработки отказа любой сбой, влияющий на базы данных на сервере или управляемом экземпляре, приводит к автоматической отработке отказа. Управляйте группами автоматической отработки отказа используя:

- [Портал Azure](geo-distributed-application-configure-tutorial.md)
- [Azure CLI: Группа отработки отказа](scripts/add-database-to-failover-group-cli.md)
- [PowerShell: группу отработки отказа](scripts/add-database-to-failover-group-powershell.md);
- [REST API: Группа отработки отказа](/rest/api/sql/failovergroups)

После отработки отказа убедитесь, что требования к проверке подлинности для базы данных и сервера или экземпляра настроены в новом первичном экземпляре. Дополнительные сведения см. в разделе [Безопасность базы данных SQL после аварийного восстановления](active-geo-replication-security-configure.md).

Добавление избыточности баз данных между центрами обработки данных — только часть решения для достижения настоящей непрерывности бизнес-процессов. Для комплексного восстановления приложения (службы) после катастрофического сбоя необходимо восстановить все компоненты, из которых состоит служба и все зависимые службы. К примерам этих компонентов относятся клиентское программное обеспечение (например, браузер с пользовательским кодом JavaScript), интерфейсные веб-серверы, хранилище и DNS. Очень важно, чтобы все компоненты были устойчивы к одинаковым сбоям и становились доступными в соответствии с целевым временем восстановления (RTO) вашего приложения. Следовательно, необходимо определить все зависимые службы и получить сведения о гарантиях и возможностях, которые они предоставляют. Затем необходимо выполнить соответствующие действия, чтобы обеспечить работу службы во время отработки отказа служб, от которых она зависит. Дополнительные сведения о проектировании решений для аварийного восстановления см. в статье [Разработка облачных решений для аварийного восстановления с помощью активной георепликации](designing-cloud-solutions-for-disaster-recovery.md).

## <a name="terminology-and-capabilities"></a>Терминология и возможности

- **Группа отработки отказа (туман)**

  Группа отработки отказа — это именованная группа баз данных, управляемая одним сервером или в управляемом экземпляре, которая может выполнять отработку отказа в другой регион в случае, если все или некоторые базы данных-получатели становятся недоступными вследствие сбоя в основном регионе. При создании для Управляемый экземпляр SQL группа отработки отказа содержит все пользовательские базы данных в экземпляре, поэтому в экземпляре можно настроить только одну группу отработки отказа.
  
  > [!IMPORTANT]
  > Имя группы отработки отказа должно быть глобально уникальным в пределах `.database.windows.net` домена.

- **Серверы**

     При использовании серверов некоторые или все пользовательские базы данных на сервере могут быть помещены в группу отработки отказа. Кроме того, сервер поддерживает несколько групп отработки отказа на одном сервере.

- **Источник**

  Сервер или управляемый экземпляр, на котором размещены базы данных источника в группе отработки отказа.

- **Получатель**

  Сервер или управляемый экземпляр, на котором размещены базы данных-получатели в группе отработки отказа. Источники и получатели не могут находиться в одном и том же регионе.

- **Добавление отдельных баз данных в группу отработки отказа**

  Несколько отдельных баз данных на одном сервере можно разместить в одной группе отработки отказа. Если вы добавите отдельную базу данных в группу отработки отказа, она автоматически создаст базу данных-получатель, используя тот же выпуск и объем вычислительных ресурсов на сервере-получателе.  Этот сервер следует указать при создании группы отработки отказа. Если вы добавите базу данных, у которой уже есть база данных-получатель на сервере-получателе, эта ссылка на георепликацию наследуется группой. Во время добавления базы данных, у которой уже есть база данных-получатель на сервере, которая не является частью группы отработки отказа, на этом сервере-получателе будет создана новая база данных-получатель.

  > [!IMPORTANT]
  > Убедитесь, что у сервера-получателя нет базы данных с тем же именем, если она не является существующей базой данных-получателем. В группах отработки отказа для SQL Управляемый экземпляр реплицируются все пользовательские базы данных. Нельзя выбирать подмножество для репликации пользовательских баз данных в группе отработки отказа.

- **Добавление баз данных в эластичный пул в группе отработки отказа**

  Вы можете разместить несколько баз данных или их все в эластичном пуле в одну группу отработки отказа. Если база данных-источник расположена в эластичном пуле, в нем автоматически создается база данных-получатель с тем же именем (вторичный пул). Необходимо убедиться, что сервер-получатель содержит эластичный пул с тем же именем и имеет достаточную емкость для размещения баз данных-получателей, которые будут созданы группой отработки отказа. Если вы добавите базу данных в пул, у которого уже есть база данных-получатель на вторичном пуле, эта ссылка на георепликацию наследуется группой. Во время добавления базы данных, у которой уже есть база данных-получатель на сервере, которая не является частью группы отработки отказа, в этом вторичном пуле будет создана новая база данных-получатель.
  
- **Начальное заполнение**

  При добавлении баз данных, эластичных пулов или управляемых экземпляров в группу отработки отказа перед началом репликации данных существует начальный этап заполнения. Начальная фаза заполнения — это самая длинная и дорогостоящая операция. После завершения первоначального заполнения данные синхронизируются, а затем реплицируются только последующие изменения данных. Время, необходимое для завершения начального начального значения, зависит от размера данных, количества реплицируемых баз данных и скорости связи между сущностями в группе отработки отказа. В нормальных обстоятельствах возможная скорость заполнения составляет до 500 ГБ для базы данных SQL и до 360 ГБ в час для Управляемый экземпляр SQL. Заполнение выполняется для всех баз данных в параллельном режиме.

  Для Управляемый экземпляр SQL рассмотрите скорость связи Express Route между двумя экземплярами при оценке времени начального этапа заполнения. Если скорость связи между двумя экземплярами меньше, чем требуется, то время на начальное значение, скорее всего, будет затронуто. Вы можете использовать указанную скорость заполнения, число баз данных, общий размер данных и скорость связи, чтобы определить, как долго будет выполняться начальная фаза заполнения перед началом репликации данных. Например, для одной базы данных 100 ГБ начальная фаза начального значения займет около 1,2 часов, если ссылка может отправить 84 ГБ в час и если другие базы данных не заполнены. Если ссылка может передавать не более 10 ГБ в час, то заполнение базы данных 100 ГБ займет около 10 часов. Если для репликации существует несколько баз данных, начальное заполнение будет выполняться параллельно, и, при сочетании скорости медленного канала, начальный этап заполнения может занять значительно больше времени, особенно если Параллельное заполнение данных из всех баз данных превысит доступную пропускную способность канала. Если пропускная способность сети между двумя экземплярами ограничена и вы добавляете несколько управляемых экземпляров в группу отработки отказа, рассмотрите возможность последовательно добавлять несколько управляемых экземпляров в группу отработки отказа по одной. Учитывая соответствующий размер SKU шлюза между двумя управляемыми экземплярами, и если корпоративная пропускная способность сети допускает ее, можно добиться максимальной скорости, равной 360 ГБ в час.  

- **Зона DNS**

  Уникальный идентификатор, который автоматически создается при создании нового Управляемый экземпляр SQL. Сертификат с несколькими доменами (SAN) для этого экземпляра подготавливается для проверки подлинности клиентских подключений к любому экземпляру в той же зоне DNS. Два управляемых экземпляра в одной группе отработки отказа должны иметь общий доступ к зоне DNS.
  
  > [!NOTE]
  > Идентификатор зоны DNS не требуется для групп отработки отказа, созданных для базы данных SQL.

- **Прослушиватель чтения и записи для группы отработки отказа**

  Запись DNS CNAME, которая указывает на текущий основной URL-адрес. Он создается автоматически при создании группы отработки отказа и позволяет рабочей нагрузке для чтения и записи прозрачно повторно подключаться к базе данных-источнику при изменении основных изменений после отработки отказа. При создании группы отработки отказа на сервере запись CNAME DNS для URL-адреса прослушивателя формируется как `<fog-name>.database.windows.net` . При создании группы отработки отказа на Управляемый экземпляр SQL запись CNAME DNS для URL-адреса прослушивателя формируется как `<fog-name>.<zone_id>.database.windows.net` .

- **Прослушиватель только для чтения для группы отработки отказа**

  Формируется запись DNS CNAME, которая указывает на прослушиватель только для чтения, указывающий на URL-адрес получателя. Он создается автоматически при создании группы отработки отказа и позволяет рабочей нагрузке SQL только для чтения прозрачно подключаться к базе данных-получателю с помощью указанных правил балансировки нагрузки. При создании группы отработки отказа на сервере запись CNAME DNS для URL-адреса прослушивателя формируется как `<fog-name>.secondary.database.windows.net` . При создании группы отработки отказа на Управляемый экземпляр SQL запись CNAME DNS для URL-адреса прослушивателя формируется как `<fog-name>.secondary.<zone_id>.database.windows.net` .

- **Политика автоматической отработки отказа**

  По умолчанию группа отработки отказа настроена с помощью политики автоматической отработки отказа. Azure активирует отработку отказа после обнаружения сбоя, и срок действия льготного периода истек. Система должна проверить, что сбой не может быть устранен встроенной [инфраструктурой высокого уровня доступности](high-availability-sla.md) из-за масштаба влияния. Если требуется управлять рабочим процессом отработки отказа из приложения или вручную, можно отключить автоматический переход на другой ресурс.
  
  > [!NOTE]
  > Из-за проверки масштаба сбоя и того, насколько быстро ее можно устранить, она включает в себя действия, выполняемые группой эксплуатации. льготный период не может быть указан ниже одного часа. Это ограничение применяется ко всем базам данных в группе отработки отказа независимо от состояния синхронизации данных.

- **Политика отработки отказа только для чтения**

  По умолчанию группа отработки отказа только для чтения отключена. Это гарантирует, что производительность базы данных-источника не изменится, если база данных-получателя отключена. Тем не менее, это также означает, что невозможно будет активировать сеансы только для чтения, пока база данных-получателя не восстановится. Если вы не можете допустить простои для сеансов только для чтения и можете использовать первичный трафик как для чтения, так и для чтения и записи за счет возможного снижения производительности источника, то для прослушивателя только для чтения необходимо настроить `AllowReadOnlyFailoverToPrimary` свойство. В этом случае трафик только для чтения будет автоматически перенаправлен на сервер-источник, если дополнительный сервер недоступен.

  > [!NOTE]
  > `AllowReadOnlyFailoverToPrimary`Свойство действует только в том случае, если включена политика автоматической отработки отказа и в Azure активирована автоматическая отработка отказа. В этом случае, если свойство имеет значение true, Новая база данных-источник будет обслуживать сеансы только для чтения и записи.

- **Плановая отработка отказа**

   Плановая отработка отказа выполняет полную синхронизацию между базой данных-источник и базой данных-получатель, прежде чем база данных-получатель переключится на основную роль. Такая отработка отказа гарантирует отсутствие потери данных. Плановая отработка отказа используется в следующих сценариях.

  - Тестирование аварийного восстановления (DR) в рабочей среде в случае, если потеря данных неприемлема.
  - Перемещение баз данных в другой регион.
  - Возврат баз данных в основной регион после устранения сбоя (восстановление размещения)

- **Внеплановая отработка отказа**

   При незапланированной или принудительной отработке отказа база данных-получатель немедленно переключается на основную роль без какой-либо синхронизации с базой данных-источником. Эта операция приведет к потере данных. Незапланированная отработка отказа используется в качестве метода восстановления при сбоях, когда база данных-источник недоступна. Когда исходный первичный сервер возвращается в режим «в сети», он автоматически повторно подключается без синхронизации и становится новым сервером-получателем.

- **Отработка отказа вручную**

  Вы можете запустить отработку отказа вручную в любое время, независимо от настройки автоматической отработки отказа. Если политика автоматической отработки отказа не настроена, для восстановления баз данных в группе отработки отказа в получателя требуется отработка отказа вручную. Вы можете запустить принудительную отработку отказа или адаптированную (с полной синхронизацией данных). Адаптированная отработка отказа может использоваться для перемещения источника в дополнительный регион. После завершения отработки отказа записи DNS автоматически обновляются, чтобы обеспечить подключение к новой первичной реплике.

- **Льготный период с потерей данных**

  Так как база данных-источник и база данных-получатель синхронизированы с помощью асинхронной репликации, отработка отказа может привести к потере данных. Вы можете настроить политику автоматической отработки отказа, чтобы представить устойчивость приложения к потере данных. Настроив `GracePeriodWithDataLossHours` , можно контролировать, как долго система ожидает перед началом отработки отказа, которая, скорее всего, приведет к утрате данных.

- **Несколько групп отработки отказа**

  Можно настроить несколько групп отработки отказа для одной и той же пары серверов, чтобы управлять областью отработки отказа. Каждая группа выполняет отработку отказа независимо от других групп. Если ваше мультитенантное приложение использует эластичные пулы, вы можете воспользоваться этой возможностью, чтобы объединить базу данных-источник и базу данных-получатель в каждом пуле. Таким образом вы сможете снизить последствия сбоя для половины клиентов.

  > [!NOTE]
  > SQL Управляемый экземпляр не поддерживает несколько групп отработки отказа.
  
## <a name="permissions"></a>Разрешения

Управление разрешениями для группы отработки отказа осуществляется [с помощью управления доступом на основе ролей Azure (Azure RBAC)](../../role-based-access-control/overview.md). Роль [участника SQL Server](../../role-based-access-control/built-in-roles.md#sql-server-contributor) имеет все необходимые разрешения для управления группами отработки отказа.

### <a name="create-failover-group"></a>Создание группы отработки отказа

Чтобы создать группу отработки отказа, необходим доступ на запись в Azure RBAC к серверам-источнику и серверу-получателю, а также ко всем базам данных в группе отработки отказа. Для Управляемый экземпляр SQL требуется доступ на запись в Azure RBAC к основному и дополнительному Управляемый экземпляр SQL, но разрешения для отдельных баз данных не являются значимыми, так как отдельные базы данных SQL Управляемый экземпляр нельзя добавлять в группу отработки отказов или удалять из нее.

### <a name="update-a-failover-group"></a>Обновление группы отработки отказа

Чтобы обновить группу отработки отказа, требуется доступ на запись Azure RBAC к группе отработки отказа и ко всем базам данных на текущем сервере-источнике или управляемом экземпляре.  

### <a name="fail-over-a-failover-group"></a>Переключение группы отработки отказа

Для переключения группы отработки отказа требуется доступ на запись в Azure RBAC к группе отработки отказа на новом сервере-источнике или управляемом экземпляре.

## <a name="best-practices-for-sql-database"></a>Рекомендации по работе с базой данных SQL

Группа автоматической отработки отказа должна быть настроена на сервере-источнике и будет подключаться к дополнительному серверу в другом регионе Azure. Группы могут содержать все или некоторые базы данных на этих серверах. На следующей схеме показана типичная конфигурация геоизбыточного облачного приложения, использующего несколько баз данных и активную георепликацию.

![На схеме показана типичная конфигурация геоизбыточного облачного приложения с использованием нескольких баз данных и группы автоматической отработки отказа.](./media/auto-failover-group-overview/auto-failover-group.png)

> [!NOTE]
> Подробное пошаговое руководство по добавлению базы данных SQL в группу отработки отказа см. в разделе [Добавление базы данных SQL в группу отработки отказа](failover-group-add-single-database-tutorial.md) .

При разработке службы с обеспечением непрерывности бизнес-процессов придерживайтесь следующих рекомендаций.

### <a name="using-one-or-several-failover-groups-to-manage-failover-of-multiple-databases"></a>Использование одной или нескольких групп отработки отказа для управления отработкой отказа нескольких баз данных

Вы можете создать одну или несколько групп отработки отказа между двумя серверами в различных регионах (для основного сервера и сервера-получателя). Каждая группа может содержать одну или несколько баз данных, которые восстанавливаются единым блоком в случае, когда все или часть баз данных-источников становятся недоступными из-за сбоя в основном регионе. Группа отработки отказа создает базу данных-получатель в дополнительном географическом регионе с таким же целевым уровнем служб, который указан для базы данных-источника. При добавлении существующей связи георепликации к группе отработки отказа убедитесь, что база данных-получатель геореплицируемых данных настроена с тем же уровнем служб и объемом вычислительных ресурсов, что и база данных-источник.
  
> [!IMPORTANT]
> Создание групп отработки отказа между двумя серверами в разных подписках сейчас не поддерживается для базы данных SQL Azure. Если переместить основной или дополнительный сервер в другую подписку после создания группы отработки отказа, это может привести к сбоям запросов отработки отказа и других операций.

### <a name="using-read-write-listener-for-oltp-workload"></a>Использование прослушивателя для чтения и записи для рабочей нагрузки OLTP

При выполнении операций OLTP используйте `<fog-name>.database.windows.net` в качестве URL-адреса сервера, чтобы все подключения автоматически перенаправлялись на сервер-источник. Этот URL-адрес не будет изменяться после отработки отказа. Обратите внимание на то, что отработка отказа включает в себя обновление DNS-записи, поэтому клиентские подключения будут перенаправляться на новый сервер-источник только после обновления кэша DNS на стороне клиента.

### <a name="using-read-only-listener-for-read-only-workload"></a>Использование прослушивателя только для чтения для рабочей нагрузки только для чтения

Если вы используете логически изолированную рабочую нагрузку в режиме только для чтения, устойчивую к некоторым задержкам в обновлении данных, в приложении можно использовать базу данных-получатель. Для сеансов с доступом только для чтения используйте `<fog-name>.secondary.database.windows.net` в качестве URL-адреса сервера, чтобы подключение автоматически перенаправлялось на сервер-получатель. Также рекомендуется указывать намерение Read в строке подключения с помощью `ApplicationIntent=ReadOnly` .

### <a name="preparing-for-performance-degradation"></a>Подготовка к снижению производительности

Типичное приложение Azure использует несколько служб Azure и состоит из нескольких компонентов. Автоматическая отработка отказа группы отработки отказа активируется в зависимости от состояния только компонентов SQL Azure. На другие службы Azure в основном регионе может не влиять сбой, и их компоненты могут по-прежнему быть доступны в этом регионе. Когда база данных источника переключается в регион аварийного восстановления, задержка между зависимыми компонентами может увеличиться. Чтобы избежать влияния большей задержки на производительность приложения, Обеспечьте избыточность всех компонентов приложения в регионе аварийного восстановления и следуйте этим [рекомендациям по безопасности сети](#failover-groups-and-network-security).

### <a name="preparing-for-data-loss"></a>Подготовка к утере данных

При обнаружении сбоя Azure ожидает период, указанный в `GracePeriodWithDataLossHours` . Значение этого свойства по умолчанию – 1 час. Если вы не можете позволить себе потери данных, убедитесь, что задано `GracePeriodWithDataLossHours` достаточно большое число, например 24 часа. Используйте группу ручной отработки отказа для восстановления размещения из получателя в источник.

> [!IMPORTANT]
> Эластичные пулы с 800 DTU или менее и более чем 250 базами данных, использующими георепликацию, могут испытывать проблемы, включая более длительные плановые операции отработки отказа и снижение производительности.  Эти проблемы чаще всего возникают из-за рабочих нагрузок, интенсивно записывающих данные, если конечные точки георепликации физически находятся далеко друг от друга или если используется несколько дополнительных конечных точек для каждой базы данных.  Симптомы этих проблем проявляются при увеличении задержки георепликации с течением времени.  Эту задержку можно отслеживать с помощью [sys.dm_geo_replication_link_status](/sql/relational-databases/system-dynamic-management-views/sys-dm-geo-replication-link-status-azure-sql-database).  Если эти проблемы возникли, к возможным способам их устранения относятся увеличение числа DTU пула или уменьшение количества геореплицируемых баз данных в одном пуле.

### <a name="changing-secondary-region-of-the-failover-group"></a>Изменение вторичного региона группы отработки отказа

Чтобы проиллюстрировать последовательность изменений, предполагается, что сервер A является сервером-источником, а сервер B — существующим сервером-получателем, а сервер C — новой базой данных-получателем в третьем регионе.  Чтобы выполнить переход, выполните следующие действия.

1. Создайте дополнительные получатели каждой базы данных на сервере а на сервер C, используя [активную георепликацию](active-geo-replication-overview.md). Каждая база данных на сервере A будет иметь два вторичных сервера: один на сервере B и один на сервере C. Это гарантирует, что базы данных источника останутся защищенными во время перехода.
2. Удалите группу отработки отказа. На этом этапе имена входа будут завершаться сбоем. Это связано с тем, что псевдонимы SQL для прослушивателей группы отработки отказа удалены, и шлюз не распознает имя группы отработки отказа.
3. Повторно создайте группу отработки отказа с тем же именем между серверами A и C. На этом этапе входы не будут завершаться сбоем.
4. Добавьте все базы данных-получатели на сервере а в новую группу отработки отказа.
5. Drop Server B. Все базы данных на B будут удалены автоматически.

### <a name="changing-primary-region-of-the-failover-group"></a>Изменение основного региона группы отработки отказа

Чтобы проиллюстрировать последовательность изменений, предполагается, что сервер A является сервером-источником, а сервер B — существующим сервером-получателем, а сервер C — новой базой данных-источником в третьем регионе.  Чтобы выполнить переход, выполните следующие действия.

1. Выполните плановую отработку отказа, чтобы переключить сервер-источник на B. сервер A станет новым вторичным сервером. Отработка отказа может вызвать несколько минут простоя. Фактическое время будет зависеть от размера группы отработки отказа.
2. Создайте дополнительные получатели каждой базы данных на сервере B на сервер C, используя [активную георепликацию](active-geo-replication-overview.md). Каждая база данных на сервере B будет иметь два вторичных сервера — один на сервере A и один на сервере C. Это гарантирует, что базы данных источника останутся защищенными во время перехода.
3. Удалите группу отработки отказа. На этом этапе имена входа будут завершаться сбоем. Это связано с тем, что псевдонимы SQL для прослушивателей группы отработки отказа удалены, и шлюз не распознает имя группы отработки отказа.
4. Повторно создайте группу отработки отказа с тем же именем между серверами B и C. На этом этапе входы не будут завершаться сбоем.
5. Добавьте все базы данных источника на B в новую группу отработки отказа.
6. Выполните плановую отработку отказа группы отработки отказа для переключения B и C. Теперь сервер C станет основным и B-вторичным. Все базы данных-получатели на сервере A будут автоматически связаны с первичными серверами на C. Как и на шаге 1, отработка отказа может вызвать несколько минут простоя.
7. Удалите сервер A. Все базы данных в будут удалены автоматически.

> [!IMPORTANT]
> При удалении группы отработки отказа также удаляются записи DNS для конечных точек прослушивателя. На этом этапе существует ненулевая вероятность того, что кто-то еще создает группу отработки отказа или псевдоним сервера с тем же именем, что не позволит повторно использовать его. Чтобы снизить риск, не используйте универсальные имена групп отработки отказа.

## <a name="best-practices-for-sql-managed-instance"></a>Рекомендации по использованию SQL Управляемый экземпляр

Группы автоматической отработки отказа должны быть настроены на экземпляре источника и подключены к экземпляру получателя в другом регионе Azure.  Все базы данных в экземпляре будут реплицированы в экземпляр получателя.

На следующей схеме показана типичная конфигурация геоизбыточного облачного приложения, использующего несколько управляемых экземпляров и активную георепликацию.

![Схема автоматического перехода на другой ресурс](./media/auto-failover-group-overview/auto-failover-group-mi.png)

> [!NOTE]
> Подробное пошаговое руководство по добавлению Управляемый экземпляр SQL для использования группы отработки отказа см. в разделе [Добавление управляемого экземпляра в группу отработки отказа](../managed-instance/failover-group-add-instance-tutorial.md) .

Если приложение использует SQL Управляемый экземпляр в качестве уровня данных, выполните следующие общие рекомендации при проектировании непрерывности бизнес-процессов.

### <a name="creating-the-secondary-instance"></a>Создание экземпляра-получателя

Чтобы обеспечить непрерванное подключение к основному SQL-Управляемый экземпляр после отработки отказа, первичный и вторичный экземпляры должны находиться в одной зоне DNS. Это гарантирует, что один и тот же сертификат с несколькими доменами (SAN) можно использовать для проверки подлинности клиентских подключений к одному из двух экземпляров в группе отработки отказа. Когда приложение будет готово к развертыванию в рабочей среде, создайте вторичный SQL-Управляемый экземпляр в другом регионе и убедитесь, что он использует зону DNS совместно с основным Управляемый экземпляром SQL. Это можно сделать, указав необязательный параметр во время создания. Если вы используете PowerShell или REST API, имя необязательного параметра имеет значение `DNS Zone Partner` , а имя соответствующего дополнительного поля в портал Azure является первичным управляемый экземпляр.

> [!IMPORTANT]
> Первый управляемый экземпляр, созданный в подсети, определяет зону DNS для всех последующих экземпляров в той же подсети. Это означает, что два экземпляра из одной подсети не могут принадлежать разным зонам DNS.

Дополнительные сведения о создании вторичного Управляемый экземпляр SQL в той же зоне DNS, что и у основного экземпляра, см. [в разделе Создание вторичного управляемого экземпляра](../managed-instance/failover-group-add-instance-tutorial.md#create-a-secondary-managed-instance).

### <a name="using-geo-paired-regions"></a>Использование геопарных регионов

Разверните оба управляемых экземпляра в [парные регионы](../../best-practices-availability-paired-regions.md), чтобы обеспечить максимальную производительность. Управляемые экземпляры, размещенные в геопарных регионах, обеспечат гораздо более высокую производительность по сравнению с размещением в непарных регионах. 

### <a name="enabling-replication-traffic-between-two-instances"></a>Включение трафика репликации между двумя экземплярами

Поскольку каждый экземпляр изолирован в своей виртуальной сети, двусторонний трафик между этими виртуальными сетями должен быть разрешен. См. [VPN-шлюзы Azure](../../vpn-gateway/vpn-gateway-about-vpngateways.md)

### <a name="creating-a-failover-group-between-managed-instances-in-different-subscriptions"></a>Создание группы отработки отказа между управляемыми экземплярами в разных подписках

Группу отработки отказа можно создать между управляемыми экземплярами SQL в двух разных подписках при условии, что подписки связаны с одним и тем же [клиентом Azure Active Directory](../../active-directory/fundamentals/active-directory-whatis.md#terminology). При использовании API PowerShell можно сделать это, указав `PartnerSubscriptionId` параметр для вторичного управляемый экземпляр SQL. При использовании REST API каждый идентификатор экземпляра, входящий в `properties.managedInstancePairs` параметр, может иметь собственное значение subscriptionID.
  
> [!IMPORTANT]
> Портал Azure не поддерживает создание групп отработки отказа в разных подписках. Кроме того, для существующих групп отработки отказа в разных подписках или группах ресурсов отработка отказа не может быть инициирована вручную с помощью портала из основного Управляемый экземпляр SQL. Запустите ее из вспомогательного экземпляра геообъекта.

### <a name="managing-failover-to-secondary-instance"></a>Управление отработкой отказа на экземпляр-получатель

Группа отработки отказа будет управлять отработкой отказа всех баз данных в Управляемом экземпляре SQL Azure. При создании группы каждая база данных в экземпляре будет автоматически геореплицироваться в Управляемый экземпляр SQL Azure получателя. Вы не можете использовать группы отработки отказа для запуска частичной отработки отказа подмножества баз данных.

> [!IMPORTANT]
> Если база данных удалена из основного Управляемый экземпляр SQL, она также будет автоматически удалена на геореплике SQL Управляемый экземпляр.

### <a name="using-read-write-listener-for-oltp-workload"></a>Использование прослушивателя для чтения и записи для рабочей нагрузки OLTP

При выполнении операций OLTP используйте `<fog-name>.zone_id.database.windows.net` в качестве URL-адреса сервера, чтобы все подключения автоматически перенаправлялись на сервер-источник. Этот URL-адрес не будет изменяться после отработки отказа. Отработка отказа включает в себя обновление DNS-записи, поэтому клиентские подключения будут перенаправляться на новый сервер-источник только после обновления кэша DNS на стороне клиента. Так как вторичный экземпляр использует зону DNS в качестве базы данных-источника, клиентское приложение сможет повторно подключиться к нему, используя тот же сертификат SAN.

### <a name="using-read-only-listener-to-connect-to-the-secondary-instance"></a>Использование прослушивателя только для чтения для подключения к экземпляру-получателю

Если вы используете логически изолированную рабочую нагрузку в режиме только для чтения, устойчивую к некоторым задержкам в обновлении данных, в приложении можно использовать базу данных-получатель. Для прямого подключения к георепликации получателя используйте `<fog-name>.secondary.<zone_id>.database.windows.net` в качестве URL-сервера.

> [!NOTE]
> В уровнях служб "Премиум", "критически важный для бизнеса" и "масштабирование" база данных SQL поддерживает использование [реплик только для чтения](read-scale-out.md) для выполнения рабочих нагрузок запросов только для чтения с использованием емкости одной или нескольких реплик только для чтения с использованием `ApplicationIntent=ReadOnly` параметра в строке подключения. После настройки георепликации получателя вы можете использовать эту возможность для соединения с репликой только для чтения либо в основном расположении, либо в геореплицированном расположении.
>
> - Чтобы подключиться к реплике только для чтения в основном расположении, используйте `ApplicationIntent=ReadOnly` и `<fog-name>.<zone_id>.database.windows.net` .
> - Чтобы подключиться к реплике только для чтения в дополнительном расположении, используйте `ApplicationIntent=ReadOnly` и `<fog-name>.secondary.<zone_id>.database.windows.net` .

### <a name="preparing-for-performance-degradation"></a>Подготовка к снижению производительности

Типичное приложение Azure использует несколько служб Azure и состоит из нескольких компонентов. Автоматическая отработка отказа группы отработки отказа активируется в зависимости от состояния только компонентов SQL Azure. На другие службы Azure в основном регионе может не влиять сбой, и их компоненты могут по-прежнему быть доступны в этом регионе. Когда база данных-источник переключается в дополнительный регион, задержка между зависимыми компонентами может увеличиться. Чтобы избежать влияния более высоких задержек на производительность приложения, Обеспечьте избыточность всех компонентов приложения в дополнительном регионе и отработку отказа компонентов приложения вместе с базой данных. Во время настройки следуйте [рекомендациям по сетевой безопасности](#failover-groups-and-network-security) , чтобы обеспечить подключение к базе данных в дополнительном регионе.

### <a name="preparing-for-data-loss"></a>Подготовка к утере данных

При обнаружении сбоя активируется отработка отказа при чтении и записи, если потери данных не было, в лучшие знания. В противном случае отработка отказа откладывается на период, указанный с помощью `GracePeriodWithDataLossHours` . Если вы указали `GracePeriodWithDataLossHours`, будьте готовы к потере данных. Во время сбоев Azure, как правило, повышает доступность. Если вы не можете позволить себе потери данных, обязательно задайте для GracePeriodWithDataLossHours достаточно большое число, например 24 часа, или отключите автоматический переход на другой ресурс.

После запуска отработки отказа DNS обновления прослушивателя чтения и записи произойдут автоматически. Эта операция не приведет к потере данных. Однако процесс смены ролей баз данных в обычных условиях может занять до 5 минут. До окончания этого процесса некоторые базы данных в новом экземпляре источника будут оставаться в режиме только для чтения. Если отработка отказа инициируется с помощью PowerShell, операция переключения первичной реплики выполняется синхронно. Если она инициируется с помощью портал Azure, Пользовательский интерфейс будет указывать состояние завершения. Если она инициируется с помощью REST API, то используйте стандартный механизм опроса Azure Resource Manager для мониторинга выполнения.

> [!IMPORTANT]
> Используйте группу ручной отработки отказа для перемещения источников в исходное расположение. После устранения сбоя, вызвавшего отработку отказа, вы можете переместить базы данных-источники в исходное расположение. Для этого вам следует инициировать ручную отработку отказа группы.
  
### <a name="changing-secondary-region-of-the-failover-group"></a>Изменение вторичного региона группы отработки отказа

Предположим, что экземпляр а является основным экземпляром, экземпляр б является существующим экземпляром-получателем, а экземпляр C — новым вторичным экземпляром в третьем регионе.  Чтобы выполнить переход, выполните следующие действия.

1. Создайте экземпляр C с тем же размером, что и в той же зоне DNS.
2. Удалите группу отработки отказа между экземплярами A и B. На этом этапе имена входа будут завершаться сбоем, так как псевдонимы SQL для прослушивателей группы отработки отказа удалены и шлюз не распознает имя группы отработки отказа. Базы данных-получатели будут отключены от первичного цвета и станут базами данных для чтения и записи.
3. Создайте группу отработки отказа с тем же именем между экземпляром A и C. Следуйте инструкциям в [руководстве по группе отработки отказа с помощью SQL управляемый экземпляр](../managed-instance/failover-group-add-instance-tutorial.md). Это операция по размеру данных, которая будет выполнена, когда все базы данных экземпляра A будут заполнены и синхронизированы.
4. Удалите экземпляр B, если не требуется, чтобы избежать ненужных расходов.

> [!NOTE]
> После выполнения шага 2 и до завершения шага 3 базы данных в экземпляре A останутся незащищенными от катастрофического сбоя экземпляра а.

### <a name="changing-primary-region-of-the-failover-group"></a>Изменение основного региона группы отработки отказа

Предположим, что экземпляр а является основным экземпляром, экземпляр б является существующим экземпляром-получателем, а экземпляр C — новым основным экземпляром в третьем регионе.  Чтобы выполнить переход, выполните следующие действия.

1. Создайте экземпляр C с тем же размером, что и B, и в той же зоне DNS.
2. Подключитесь к экземпляру б и отработку отказа вручную, чтобы переключить основной экземпляр в B. экземпляр A станет автоматически новым экземпляром-получателем.
3. Удалите группу отработки отказа между экземплярами A и B. На этом этапе имена входа будут завершаться сбоем, так как псевдонимы SQL для прослушивателей группы отработки отказа удалены и шлюз не распознает имя группы отработки отказа. Базы данных-получатели будут отключены от первичного цвета и станут базами данных для чтения и записи.
4. Создайте группу отработки отказа с тем же именем между экземпляром A и C. Следуйте инструкциям [руководства по использованию группы отработки отказа с управляемым экземпляром](../managed-instance/failover-group-add-instance-tutorial.md). Это операция по размеру данных, которая будет выполнена, когда все базы данных экземпляра A будут заполнены и синхронизированы.
5. Удалите экземпляр A, если не требуется, чтобы избежать ненужных расходов.

> [!CAUTION]
> После выполнения шага 3 и до завершения шага 4 базы данных в экземпляре A останутся незащищенными от катастрофического сбоя экземпляра а.

> [!IMPORTANT]
> При удалении группы отработки отказа также удаляются записи DNS для конечных точек прослушивателя. На этом этапе существует ненулевая вероятность того, что кто-то еще создает группу отработки отказа или псевдоним сервера с тем же именем, что не позволит повторно использовать его. Чтобы снизить риск, не используйте универсальные имена групп отработки отказа.

### <a name="enable-scenarios-dependent-on-objects-from-the-system-databases"></a>Включение сценариев, зависящих от объектов из системных баз данных
Системные базы данных не реплицируются на дополнительный экземпляр в группе отработки отказа. Чтобы включить сценарии, зависящие от объектов системных баз данных, на вторичном экземпляре необходимо создать те же объекты на сервере-получателе. Например, если вы планируете использовать одни и те же имена входа на экземпляре-получателе, обязательно создайте их с одинаковым идентификатором безопасности. 
```SQL
-- Code to create login on the secondary instance
CREATE LOGIN foo WITH PASSWORD = '<enterStrongPasswordHere>', SID = <login_sid>;
``` 


## <a name="failover-groups-and-network-security"></a>Группы отработки отказа и сетевая безопасность

Для некоторых приложений правила безопасности требует, чтобы сетевой доступ к уровню данных был ограничен конкретным компонентом или компонентами, такими как виртуальная машина, веб-служба и т. д. Это требование представляет некоторые трудности при проектировании непрерывности бизнес-процессов и использовании групп отработки отказа. При реализации такого ограниченного доступа учитывайте следующие параметры.

### <a name="using-failover-groups-and-virtual-network-rules"></a>Использование групп отработки отказа и правил виртуальной сети

Если вы используете [конечные точки службы и правила виртуальной сети](vnet-service-endpoint-rule-overview.md) для ограничения доступа к базе данных в базе данных sql или управляемый экземпляр SQL, учтите, что каждая конечная точка службы виртуальной сети применима только к одному региону Azure. Конечная точка не поддерживает прием подключений из подсети в других регионах. Таким образом, только клиентские приложения, развернутые в одном регионе, могут подключаться к базе данных-источнику. Поскольку отработка отказа приводит к перенаправлению сеансов клиента базы данных SQL на сервер в другом (дополнительном) регионе, эти сеансы завершатся ошибкой, если они поступили от клиента за пределами этого региона. По этой причине политика автоматического перехода на другой ресурс не может быть включена, если участвующие серверы или экземпляры включены в правила виртуальной сети. Для поддержки перехода на другой ресурс вручную выполните следующие действия:

1. Подготовьте избыточные копии интерфейсных компонентов приложения (веб-службы, виртуальные машины и т. д.) в дополнительном регионе.
2. Настройте [правила виртуальной сети](vnet-service-endpoint-rule-overview.md) по отдельности для основного и дополнительного сервера.
3. Включите [отработку отказа внешнего интерфейса с помощью конфигурации диспетчера трафика](designing-cloud-solutions-for-disaster-recovery.md#scenario-1-using-two-azure-regions-for-business-continuity-with-minimal-downtime).
4. Инициируйте отработку отказа вручную при обнаружении сбоя. Этот параметр оптимизирован для приложений, требующих последовательной задержки между внешним интерфейсом и уровнем данных, и поддерживает восстановление после сбоя внешнего интерфейса уровня данных или их обоих.

> [!NOTE]
> При использовании **прослушивателя только для чтения** для балансировки рабочей нагрузки только для чтения убедитесь, что эта рабочая нагрузка выполняется на виртуальной машине или в другом ресурсе в дополнительном регионе, чтобы прослушиватель мог подключаться к базе данных-получателю.

### <a name="use-failover-groups-and-firewall-rules"></a>Использование групп отработки отказа и правил брандмауэра

Если план непрерывности бизнес-процессов требует отработки отказа с помощью групп с автоматической отработкой отказа, можно ограничить доступ к базе данных в базе данных SQL с помощью традиционных правил брандмауэра. Для поддержки автоматического перехода на другой ресурс выполните следующие действия:

1. [Создание общедоступного IP-адреса](../../virtual-network/virtual-network-public-ip-address.md#create-a-public-ip-address)
2. [создайте общедоступный балансировщик нагрузки](../../load-balancer/quickstart-load-balancer-standard-public-portal.md) и назначьте ему общедоступный IP-адрес;
3. [создайте виртуальную сеть и виртуальные машины](../../load-balancer/quickstart-load-balancer-standard-public-portal.md) для интерфейсных компонентов;
4. [создайте группу безопасности сети](../../virtual-network/network-security-groups-overview.md) и настройте входящие подключения.
5. Убедитесь, что исходящие подключения открыты для базы данных SQL Azure с помощью [тега службы](../../virtual-network/network-security-groups-overview.md#service-tags)"SQL".
6. Создайте [правило брандмауэра базы данных SQL](firewall-configure.md) , разрешающее входящий трафик с общедоступного IP-адреса, созданного на шаге 1.

Дополнительные сведения о настройке исходящего доступа и IP-адреса для использования в правилах брандмауэра см. в разделе [Исходящие подключения балансировщика нагрузки](../../load-balancer/load-balancer-outbound-connections.md).

Приведенная выше конфигурация гарантирует, что автоматический переход на другой ресурс не будет блокировать подключения из интерфейсных компонентов, и предполагает, что приложение может выдержать более длительную задержку между интерфейсном и уровнем данных.

> [!IMPORTANT]
> Для обеспечения непрерывности бизнес-процессов при региональных сбоях должна присутствовать географическая избыточность интерфейсных компонентов и баз данных.

## <a name="enabling-geo-replication-between-managed-instances-and-their-vnets"></a>Включение георепликации между управляемыми экземплярами и их виртуальными сетями

При настройке группы отработки отказа между основным и дополнительным управляемыми экземплярами SQL в двух разных регионах каждый экземпляр изолирован с помощью независимой виртуальной сети. Чтобы разрешить трафик репликации между этими виртуальных сетей, убедитесь, что выполнены следующие условия.

- Два экземпляра SQL Управляемый экземпляр должны находиться в разных регионах Azure.
- Два экземпляра SQL Управляемый экземпляр должны быть одного уровня службы и иметь одинаковый размер хранения.
- Вторичный экземпляр SQL Управляемый экземпляр должен быть пустым (без пользовательских баз данных).
- Виртуальные сети, используемые экземплярами SQL Управляемый экземпляр, должны быть подключены через [VPN-шлюз](../../vpn-gateway/vpn-gateway-about-vpngateways.md) или [Express Route](../../expressroute/expressroute-howto-circuit-portal-resource-manager.md). Если две виртуальные сети подключаются через локальную сеть, убедитесь в отсутствии правил брандмауэра, блокирующих порты 5022 и 11000–11999. Глобальные пиринга виртуальных сетей поддерживаются с ограничениями, описанными в примечании ниже.

   > [!IMPORTANT]
   > [На 9/22/2020 мы объявили глобальный пиринг виртуальных сетей для вновь созданных виртуальных кластеров](https://azure.microsoft.com/en-us/updates/global-virtual-network-peering-support-for-azure-sql-managed-instance-now-available/). Это означает, что глобальный пиринг между виртуальными сетями поддерживается для управляемых экземпляров SQL, созданных в пустых подсетях после даты объявления, а также для всех последующих управляемых экземпляров, созданных в этих подсетях. Для всех остальных способов поддержки пиринга с управляемыми экземплярами SQL ограничены сетями в том же регионе из-за [ограничений глобального пиринга виртуальной сети](../../virtual-network/virtual-network-manage-peering.md#requirements-and-constraints). Дополнительные сведения см. в разделе, посвященном [часто задаваемым вопросам о виртуальных сетях Azure](../../virtual-network/virtual-networks-faq.md#what-are-the-constraints-related-to-global-vnet-peering-and-load-balancers) . 

- Два виртуальных сетей SQL Управляемый экземпляр не могут иметь перекрывающиеся IP-адреса.
- Вы должны настроить группы безопасности сети (NSG) так, чтобы порты 5022 и диапазон 11000–12000 были открыты для входящих и исходящих подключений из подсети или другого управляемого экземпляра. Это позволяет обеспечить трафик репликации между экземплярами.

   > [!IMPORTANT]
   > Неправильная настройка правил безопасности NSG приводит к задержке операций копирования баз данных.

- Во вторичном Управляемый экземпляр SQL настраивается правильный идентификатор зоны DNS. Зона DNS — это свойство Управляемый экземпляр SQL и базового виртуального кластера, а его идентификатор включается в адрес имени узла. Идентификатор зоны создается в виде случайной строки, когда первая Управляемый экземпляр SQL создается в каждой виртуальной сети, и один и тот же идентификатор назначается всем остальным экземплярам в той же подсети. После назначения зону DNS изменить нельзя. Управляемые экземпляры SQL, входящие в одну группу отработки отказа, должны иметь общий доступ к зоне DNS. Это достигается путем передачи идентификатора зоны основного экземпляра в качестве значения параметра Днсзонепартнер при создании экземпляра-получателя.

   > [!NOTE]
   > Подробное руководство по настройке групп отработки отказа с помощью SQL Управляемый экземпляр см. в разделе [добавление управляемый экземпляр SQL в группу отработки отказа](../managed-instance/failover-group-add-instance-tutorial.md).

## <a name="upgrading-or-downgrading-a-primary-database"></a>Повышение или понижение уровня производительности базы данных-источника

Вы можете повышать или понижать объем вычислительных ресурсов базы данных-источника (в рамках одного уровня служб, а не между уровнем общего назначения и критически важным для бизнеса) без отключения каких-либо баз данных-получателей. При обновлении рекомендуется сначала обновить все базы данных-получатели, а затем обновить сервер-источник. При переходе на более раннюю версию в обратном порядке: переход на более раннюю версию первичного и последующее понижение уровня всех баз данных-получателей. Когда вы повышаете или понижаете базу данных до следующего уровня служб, особенно важно выполнять рекомендацию выше.

В частности, эту последовательность рекомендуется использовать, чтобы избежать проблем, когда первичный экземпляр со SKU более низкого уровня перегружается и должен быть заполнен повторно при обновлении или понижении производительности. Вы также можете избежать этой проблемы, сделав первичный экземпляр доступным только для чтения, однако при этом придется отказаться от выполнения на нем всех рабочих нагрузок чтения и записи.

> [!NOTE]
> Если база данных-получатель была создана как часть конфигурации группы отработки отказа, не рекомендуется понизить уровень базы данных-получателя. Это необходимо, чтобы обеспечить достаточную емкость уровня данных для обработки регулярных рабочих нагрузок после активации отработки отказа.

## <a name="preventing-the-loss-of-critical-data"></a>Предотвращение потери важных данных

Из-за высокой задержки глобальных сетей непрерывная копия использует механизм асинхронной репликации. Ввиду асинхронной репликации потеря данных в случае сбоя неизбежна. Тем не менее для некоторых приложений терять данные недопустимо. Чтобы защитить эти критические обновления, разработчик приложения сразу же после фиксации транзакции может вызывать системную процедуру [sp_wait_for_database_copy_sync](/sql/relational-databases/system-stored-procedures/active-geo-replication-sp-wait-for-database-copy-sync). Вызов `sp_wait_for_database_copy_sync` блокирует вызывающий поток до тех пор, пока Последняя зафиксированная транзакция не будет передана в базу данных-получатель. Но вызов не дожидается воспроизведения и фиксации переданных транзакций в базе данных-получателе. `sp_wait_for_database_copy_sync` область ограничена ссылкой на определенное непрерывное копирование. Эту процедуру может вызвать любой пользователь с правами подключения к базе данных-источнику.

> [!NOTE]
> `sp_wait_for_database_copy_sync` предотвращает потерю данных после отработки отказа, но не гарантирует полную синхронизацию для доступа на чтение. Задержка, вызванная `sp_wait_for_database_copy_sync` вызовом процедуры, может быть существенной и зависит от размера журнала транзакций во время вызова.

## <a name="failover-groups-and-point-in-time-restore"></a>Группы отработки отказа и восстановление до точки во времени

Сведения об использовании восстановления до точки во времени с группами отработки отказа см. в разделе [Восстановление до точки во времени (PITR)](recovery-using-backups.md#point-in-time-restore).

## <a name="limitations-of-failover-groups"></a>Ограничения групп отработки отказа

Следует учитывать следующие ограничения.

- Группы отработки отказа не могут быть созданы между двумя серверами или экземплярами в одном регионе Azure.
- Невозможно переименовать группы отработки отказа. Необходимо удалить группу и создать ее повторно с другим именем.
- Переименование базы данных не поддерживается для экземпляров в группе отработки отказа. Чтобы иметь возможность переименовать базу данных, необходимо временно удалить группу отработки отказа.
- Системные базы данных не реплицируются на дополнительный экземпляр в группе отработки отказа. Таким образом, сценарии, зависящие от объектов системных баз данных, будут невозможны на вторичном экземпляре, если только эти объекты не будут созданы вручную на сервере-получателе.

## <a name="programmatically-managing-failover-groups"></a>Программное управление группами отработки отказа

Как уже говорилось ранее, группами автоматической отработки отказа и активной георепликацией можно также управлять программно с помощью Azure PowerShell и REST API. В приведенных ниже таблицах описан доступный для этого набор команд. Активная георепликация включает в себя набор API-интерфейсов Azure Resource Manager для управления, в том числе [REST API Базы данных SQL Azure](/rest/api/sql/) и [командлеты Azure PowerShell](/powershell/azure/). Для этих API требуется использование групп ресурсов и поддержка управления доступом на основе ролей в Azure (Azure RBAC). Дополнительные сведения о реализации ролей доступа см. в статье [Управление доступом на основе ролей в Azure (Azure RBAC)](../../role-based-access-control/overview.md).

### <a name="manage-sql-database-failover"></a>Управление отработкой отказа базы данных SQL

# <a name="powershell"></a>[PowerShell](#tab/azure-powershell)

| Командлет | Описание |
| --- | --- |
| [New-AzSqlDatabaseFailoverGroup](/powershell/module/az.sql/new-azsqldatabasefailovergroup) |Создает группу отработки отказа и регистрирует ее на основном сервере и сервере-получателе.|
| [Remove-Азсклдатабасефаиловерграуп](/powershell/module/az.sql/remove-azsqldatabasefailovergroup) | Удаляет группу отработки отказа с сервера |
| [Get-AzSqlDatabaseFailoverGroup](/powershell/module/az.sql/get-azsqldatabasefailovergroup) | Извлекает конфигурацию группы отработки отказа |
| [Set-Азсклдатабасефаиловерграуп](/powershell/module/az.sql/set-azsqldatabasefailovergroup) |Изменяет конфигурацию группы отработки отказа |
| [Switch-AzSqlDatabaseFailoverGroup](/powershell/module/az.sql/switch-azsqldatabasefailovergroup) | Активирует отработку отказа группы отработки отказа на сервер-получатель |
| [Add-AzSqlDatabaseToFailoverGroup](/powershell/module/az.sql/add-azsqldatabasetofailovergroup)|Добавляет одну или несколько баз данных в группу отработки отказа|

# <a name="azure-cli"></a>[Azure CLI](#tab/azure-cli)

| Get-Help | Описание |
| --- | --- |
| [az sql failover-group create](/cli/azure/sql/failover-group#az-sql-failover-group-create) |Создает группу отработки отказа и регистрирует ее на основном сервере и сервере-получателе.|
| [AZ SQL Failover — групповое удаление](/cli/azure/sql/failover-group#az-sql-failover-group-delete) | Удаляет группу отработки отказа с сервера |
| [AZ SQL Failover — Групповая демонстрация](/cli/azure/sql/failover-group#az-sql-failover-group-show) | Получение конфигурации группы отработки отказа |
| [AZ SQL Failover — обновление группы](/cli/azure/sql/failover-group#az-sql-failover-group-update) |Изменяет конфигурацию группы отработки отказа и (или) добавляет одну или несколько баз данных в группу отработки отказа|
| [az sql failover-group set-primary](/cli/azure/sql/failover-group#az-sql-failover-group-set-primary) | Активирует отработку отказа группы отработки отказа на сервер-получатель |

# <a name="rest-api"></a>[Azure Service Bus REST API](#tab/rest-api) (REST API служебной шины Azure)

| API | Описание |
| --- | --- |
| [Создание или обновление группы отработки отказа](/rest/api/sql/failovergroups/createorupdate) | Создает или обновляет группу отработки отказа. |
| [Удаление группы отработки отказа](/rest/api/sql/failovergroups/delete) | Удаляет группу отработки отказа с сервера |
| [Плановая отработка отказа](/rest/api/sql/failovergroups/failover) | Активирует отработку отказа с текущего сервера-источника на сервер-получатель с полной синхронизацией данных.|
| [Принудительная отработка отказа (возможна потеря данных)](/rest/api/sql/failovergroups/forcefailoverallowdataloss) | Активирует отработку отказа с текущего сервера-источника на сервер-получатель без синхронизации данных. Эта операция может привести к утере данных. |
| [Получение группы отработки отказа](/rest/api/sql/failovergroups/get) | Извлекает конфигурацию группы отработки отказа. |
| [Вывод списка групп отработки отказа с фильтрацией по серверу](/rest/api/sql/failovergroups/listbyserver) | Список групп отработки отказа на сервере. |
| [Обновление группы отработки отказа](/rest/api/sql/failovergroups/update) | Обновляет конфигурацию группы отработки отказа. |

---

### <a name="manage-sql-managed-instance-failover"></a>Управление отработкой отказа SQL Управляемый экземпляр


# <a name="powershell"></a>[PowerShell](#tab/azure-powershell)

| Командлет | Описание |
| --- | --- |
| [New-AzSqlDatabaseInstanceFailoverGroup](/powershell/module/az.sql/new-azsqldatabaseinstancefailovergroup) |Эта команда создает группу отработки отказа и регистрирует ее на первичном и вторичном экземплярах.|
| [Set-Азсклдатабасеинстанцефаиловерграуп](/powershell/module/az.sql/set-azsqldatabaseinstancefailovergroup) |Изменяет конфигурацию группы отработки отказа|
| [Get-AzSqlDatabaseInstanceFailoverGroup](/powershell/module/az.sql/get-azsqldatabaseinstancefailovergroup) |Извлекает конфигурацию группы отработки отказа|
| [Switch-AzSqlDatabaseInstanceFailoverGroup](/powershell/module/az.sql/switch-azsqldatabaseinstancefailovergroup) |Активирует отработку отказа группы отработки отказа на дополнительный экземпляр|
| [Remove-Азсклдатабасеинстанцефаиловерграуп](/powershell/module/az.sql/remove-azsqldatabaseinstancefailovergroup) | Удаляет группу отработки отказа.|


# <a name="azure-cli"></a>[Azure CLI](#tab/azure-cli)

| Get-Help | Описание |
| --- | --- |
| [az sql failover-group create](/cli/azure/sql/failover-group#az-sql-failover-group-create) |Создает группу отработки отказа и регистрирует ее на основном сервере и сервере-получателе.|
| [AZ SQL Failover — групповое удаление](/cli/azure/sql/failover-group#az-sql-failover-group-delete) | Удаляет группу отработки отказа с сервера |
| [AZ SQL Failover — Групповая демонстрация](/cli/azure/sql/failover-group#az-sql-failover-group-show) | Получение конфигурации группы отработки отказа |
| [AZ SQL Failover — обновление группы](/cli/azure/sql/failover-group#az-sql-failover-group-update) |Изменяет конфигурацию группы отработки отказа и (или) добавляет одну или несколько баз данных в группу отработки отказа|
| [az sql failover-group set-primary](/cli/azure/sql/failover-group#az-sql-failover-group-set-primary) | Активирует отработку отказа группы отработки отказа на сервер-получатель |

# <a name="rest-api"></a>[Azure Service Bus REST API](#tab/rest-api) (REST API служебной шины Azure)

| API | Описание |
| --- | --- |
| [Создание или обновление группы отработки отказа](/rest/api/sql/instancefailovergroups/createorupdate) | Создает или обновляет конфигурацию группы отработки отказа. |
| [Удаление группы отработки отказа](/rest/api/sql/instancefailovergroups/delete) | Удаляет группу отработки отказа из экземпляра. |
| [Плановая отработка отказа](/rest/api/sql/instancefailovergroups/failover) | Активирует отработку отказа с текущего первичного экземпляра на этот экземпляр с полной синхронизацией данных. |
| [Принудительная отработка отказа (возможна потеря данных)](/rest/api/sql/instancefailovergroups/forcefailoverallowdataloss) | Активирует отработку отказа из текущего первичного экземпляра в экземпляр-получатель без синхронизации данных. Эта операция может привести к утере данных. |
| [Получение группы отработки отказа](/rest/api/sql/instancefailovergroups/get) | Извлекает конфигурацию группы отработки отказа. |
| [Перечисление групп отработки отказа – Перечисление по расположению](/rest/api/sql/instancefailovergroups/listbylocation) | Перечисляет группы отработки отказа в расположении. |

---

## <a name="next-steps"></a>Дальнейшие действия

- Подробные руководства см. в разделе
  - [Добавление базы данных SQL в группу отработки отказа](failover-group-add-single-database-tutorial.md)
  - [Добавление эластичного пула в группу отработки отказа](failover-group-add-elastic-pool-tutorial.md)
  - [Добавление Управляемый экземпляр SQL в группу отработки отказа](../managed-instance/failover-group-add-instance-tutorial.md)
- Ознакомьтесь с примерами скриптов в следующих статьях:
  - [Настройка активной георепликации для базы данных SQL Azure с помощью PowerShell](scripts/setup-geodr-and-failover-database-powershell.md)
  - [Настройка активной георепликации для базы данных в пуле в Базе данных SQL Azure с помощью PowerShell](scripts/setup-geodr-and-failover-elastic-pool-powershell.md)
  - [Добавление базы данных SQL Azure в группу отработки отказа с помощью PowerShell](scripts/add-database-to-failover-group-powershell.md)
- Общие сведения о непрерывности бизнес-процессов и сценарии см. в статье [Обзор непрерывности бизнес-процессов](business-continuity-high-availability-disaster-recover-hadr-overview.md) .
- Дополнительные сведения об автоматизированных резервных копиях базы данных SQL Azure см. в статье [Автоматическое резервное копирование базы данных](automated-backups-overview.md)SQL.
- Дополнительные сведения об использовании автоматических резервных копий для восстановления см. в статье [Восстановление базы данных из резервных копий, инициированных службой](recovery-using-backups.md).
- Дополнительные сведения о требованиях к проверке подлинности для новых сервера-источника и базы данных-источника см. в статье [Безопасность базы данных SQL после аварийного восстановления](active-geo-replication-security-configure.md).
