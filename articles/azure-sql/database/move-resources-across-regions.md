---
title: Перемещение ресурсов в новый регион
titleSuffix: Azure SQL Database & Azure SQL Managed Instance
description: Узнайте, как переместить базу данных или управляемый экземпляр в другой регион.
services: sql-database
ms.service: sql-db-mi
ms.subservice: data-movement
ms.custom: sqldbrb=2
ms.devlang: ''
ms.topic: how-to
author: stevestein
ms.author: sstein
ms.reviewer: ''
ms.date: 06/25/2019
ms.openlocfilehash: ae6c87c9eabea837ba9c43676d4ca712caa385cb
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "94594170"
---
# <a name="move-resources-to-new-region---azure-sql-database--azure-sql-managed-instance"></a>Перемещение ресурсов в новый регион — база данных SQL Azure & Управляемый экземпляр SQL Azure
[!INCLUDE[appliesto-sqldb-sqlmi](../includes/appliesto-sqldb-sqlmi.md)]

В этой статье описывается универсальный рабочий процесс перемещения базы данных или управляемого экземпляра в новый регион.

## <a name="overview"></a>Обзор

Существуют различные сценарии, в которых необходимо переместить существующую базу данных или управляемый экземпляр из одного региона в другой. Например, вы разрабатываете свой бизнес в новом регионе и хотите оптимизировать его для новой клиентской базы. Или необходимо переместить операции в другой регион по соображениям соответствия. Или Azure выпустила новый регион, который обеспечивает более близкое сходство и улучшает взаимодействие с клиентами.  

В этой статье представлен общий рабочий процесс перемещения ресурсов в другой регион. Рабочий процесс состоит из следующих шагов:

1. Проверьте предварительные требования для перемещения.
1. Подготовка к перемещению ресурсов в области.
1. Отслеживайте процесс подготовки.
1. Протестируйте процесс перемещения.
1. Инициация фактического перемещения.
1. Удалите ресурсы из исходного региона.

> [!NOTE]
> Эта статья относится к миграции в общедоступном облаке Azure или в том же независимых облаке.

[!INCLUDE [updated-for-az](../../../includes/updated-for-az.md)]

## <a name="move-a-database"></a>Перемещение базы данных

### <a name="verify-prerequisites"></a>Проверка необходимых условий

1. Создайте целевой сервер для каждого исходного сервера.
1. Настройте брандмауэр с помощью правильного исключения с помощью [PowerShell](scripts/create-and-configure-database-powershell.md).  
1. Настройте серверы с правильными именами входа. Если вы не являетесь администратором подписки или администратором SQL Server, обратитесь к администратору, чтобы назначить необходимые разрешения. Дополнительные сведения см. [в статье Управление безопасностью базы данных SQL Azure после аварийного восстановления](active-geo-replication-security-configure.md).
1. Если ваши базы данных зашифрованы с помощью прозрачного шифрования данных и в Azure Key Vault используется собственный ключ шифрования, убедитесь в том, что в целевых регионах подготавливается правильный материал шифрования. Дополнительные сведения см. [в разделе прозрачное шифрование данных SQL Azure с помощью управляемых клиентом ключей в Azure Key Vault](transparent-data-encryption-byok-overview.md).
1. Если включен аудит на уровне базы данных, отключите его и включите аудит на уровне сервера. После отработки отказа аудит на уровне базы данных потребует передачи трафика между регионами, что не требуется или невозможно после перемещения.
1. Для аудита на уровне сервера убедитесь в том, что:
   - Контейнер хранилища, Log Analytics или концентратор событий с существующими журналами аудита перемещается в целевой регион.
   - Аудит настроен на целевом сервере. Дополнительные сведения см. в статье [Приступая к работе с аудитом базы данных SQL](../../azure-sql/database/auditing-overview.md).
1. Если экземпляр имеет политику долгосрочного хранения (LTR), существующие резервные копии LTR останутся связанными с текущим сервером. Так как целевой сервер отличается, вы сможете получить доступ к старым резервным копиям LTR в исходном регионе с помощью исходного сервера, даже если сервер удален.

      > [!NOTE]
      > Это будет недостаточно для перемещения между облаком независимых и общедоступным регионом. Для такого переноса потребуется переместить резервные копии LTR на целевой сервер, который сейчас не поддерживается.

### <a name="prepare-resources"></a>Подготовка ресурсов

1. Создайте [группу отработки отказа](failover-group-add-single-database-tutorial.md#2---create-the-failover-group) между сервером источника и сервером целевого объекта.  
1. Добавьте базы данных, которые необходимо переместить в группу отработки отказа.
  
    Репликация всех добавленных баз данных будет инициирована автоматически. Дополнительные сведения см. в статье рекомендации [по использованию групп отработки отказа с отдельными базами данных](auto-failover-group-overview.md#best-practices-for-sql-database).

### <a name="monitor-the-preparation-process"></a>Мониторинг процесса подготовки

Вы можете периодически вызывать [Get-азсклдатабасефаиловерграуп](/powershell/module/az.sql/get-azsqldatabasefailovergroup) для мониторинга репликации баз данных из источника в целевой объект. Выходной объект `Get-AzSqlDatabaseFailoverGroup` включает свойство для **ReplicationState**:

- **ReplicationState = 2** (CATCH_UP) указывает, что база данных синхронизирована и для нее можно выполнить безопасную отработку отказа.
- **ReplicationState = 0** (заполнение) указывает, что база данных еще не заполнена и попытка отработки отказа завершится ошибкой.

### <a name="test-synchronization"></a>Тестовая синхронизация

После **ReplicationState** `2` подключитесь к каждой базе данных или подмножеству баз данных с помощью вторичной конечной точки `<fog-name>.secondary.database.windows.net` и выполните любой запрос к базам данных, чтобы обеспечить подключение, правильную конфигурацию безопасности и репликацию данных.

### <a name="initiate-the-move"></a>Начало перемещения

1. Подключитесь к целевому серверу с помощью вторичной конечной точки `<fog-name>.secondary.database.windows.net` .
1. Используйте [параметр Switch-азсклдатабасефаиловерграуп](/powershell/module/az.sql/switch-azsqldatabasefailovergroup) , чтобы перевести вторичный управляемый экземпляр в основной с полной синхронизацией. Эта операция завершится с ошибкой или будет отменена.
1. Убедитесь, что команда выполнена успешно, используя, `nslook up <fog-name>.secondary.database.windows.net` чтобы убедиться, что запись DNS CNAME указывает на IP-адрес целевого региона. Если команда Switch завершается неудачно, запись CNAME не обновляется.

### <a name="remove-the-source-databases"></a>Удаление баз данных источника

После завершения перемещения удалите ресурсы из исходного региона, чтобы избежать ненужных расходов.

1. Удалите группу отработки отказа с помощью команды [Remove-азсклдатабасефаиловерграуп](/powershell/module/az.sql/remove-azsqldatabasefailovergroup).
1. Удалите каждую базу данных-источник с помощью команды [Remove азсклдатабасе](/powershell/module/az.sql/remove-azsqldatabase) для каждой базы данных на исходном сервере. Это приведет к автоматическому прекращению связей георепликации.
1. Удалите исходный сервер с помощью команды [Remove-азсклсервер](/powershell/module/az.sql/remove-azsqlserver).
1. Удалите хранилище ключей, аудит контейнеров хранилища, концентратор событий, Azure Active Directory (Azure AD) и другие зависимые ресурсы, которые будут выставляться за них.

## <a name="move-elastic-pools"></a>Перемещение эластичных пулов

### <a name="verify-prerequisites"></a>Проверка необходимых условий

1. Создайте целевой сервер для каждого исходного сервера.
1. Настройте брандмауэр с нужными исключениями с помощью [PowerShell](scripts/create-and-configure-database-powershell.md).
1. Настройте серверы с правильными именами входа. Если вы не являетесь администратором подписки или администратором сервера, обратитесь к администратору, чтобы назначить необходимые разрешения. Дополнительные сведения см. [в статье Управление безопасностью базы данных SQL Azure после аварийного восстановления](active-geo-replication-security-configure.md).
1. Если ваши базы данных зашифрованы с помощью прозрачного шифрования данных и в Azure Key Vault используется собственный ключ шифрования, убедитесь в том, что в целевом регионе подготовлен правильный материал шифрования.
1. Создайте целевой эластичный пул для каждого исходного пула эластичных БД, убедившись, что пул создается на том же уровне служб с тем же именем и размером.
1. Если включен аудит на уровне базы данных, отключите его и включите аудит на уровне сервера. После отработки отказа аудит на уровне базы данных потребует передачи трафика между регионами, который не нужен или может быть после перемещения.
1. Для аудита на уровне сервера убедитесь в том, что:
    - Контейнер хранилища, Log Analytics или концентратор событий с существующими журналами аудита перемещается в целевой регион.
    - Конфигурация аудита настраивается на целевом сервере. Дополнительные сведения см. в разделе [Аудит базы данных SQL](../../azure-sql/database/auditing-overview.md).
1. Если экземпляр имеет политику долгосрочного хранения (LTR), существующие резервные копии LTR останутся связанными с текущим сервером. Так как целевой сервер отличается, вы сможете получить доступ к старым резервным копиям LTR в исходном регионе с помощью исходного сервера, даже если сервер удален.

      > [!NOTE]
      > Это будет недостаточно для перемещения между облаком независимых и общедоступным регионом. Для такого переноса потребуется переместить резервные копии LTR на целевой сервер, который сейчас не поддерживается.

### <a name="prepare-to-move"></a>Подготовка к переносу

1. Создайте отдельную [группу отработки отказа](failover-group-add-elastic-pool-tutorial.md#3---create-the-failover-group) между каждым пулом эластичных баз данных на исходном сервере и его аналогом эластичного пула на целевом сервере.
1. Добавьте все базы данных из пула в группу отработки отказа.

    Репликация добавленных баз данных будет инициирована автоматически. Дополнительные сведения см. в статье рекомендации [по использованию групп отработки отказа с пулами эластичных](auto-failover-group-overview.md#best-practices-for-sql-database)баз данных.

      > [!NOTE]
      > Хотя можно создать группу отработки отказа, которая включает несколько эластичных пулов, настоятельно рекомендуется создать отдельную группу отработки отказа для каждого пула. При наличии большого количества баз данных в нескольких эластичных пулах, которые необходимо переместить, можно выполнять подготовительные действия параллельно, а затем запускать шаг перемещения параллельно. Этот процесс будет лучше масштабироваться и займет меньше времени по сравнению с наличием нескольких эластичных пулов в одной группе отработки отказа.

### <a name="monitor-the-preparation-process"></a>Мониторинг процесса подготовки

Вы можете периодически вызывать [Get-азсклдатабасефаиловерграуп](/powershell/module/az.sql/get-azsqldatabasefailovergroup) для мониторинга репликации баз данных из источника в целевой объект. Выходной объект `Get-AzSqlDatabaseFailoverGroup` включает свойство для **ReplicationState**:

- **ReplicationState = 2** (CATCH_UP) указывает, что база данных синхронизирована и для нее можно выполнить безопасную отработку отказа.
- **ReplicationState = 0** (заполнение) указывает, что база данных еще не заполнена и попытка отработки отказа завершится ошибкой.

### <a name="test-synchronization"></a>Тестовая синхронизация

После **ReplicationState** `2` подключитесь к каждой базе данных или подмножеству баз данных с помощью вторичной конечной точки `<fog-name>.secondary.database.windows.net` и выполните любой запрос к базам данных, чтобы обеспечить подключение, правильную конфигурацию безопасности и репликацию данных.

### <a name="initiate-the-move"></a>Начало перемещения

1. Подключитесь к целевому серверу с помощью вторичной конечной точки `<fog-name>.secondary.database.windows.net` .
1. Используйте [параметр Switch-азсклдатабасефаиловерграуп](/powershell/module/az.sql/switch-azsqldatabasefailovergroup) , чтобы перевести вторичный управляемый экземпляр в основной с полной синхронизацией. Эта операция либо будет выполнена, либо будет отменена.
1. Убедитесь, что команда выполнена успешно, используя, `nslook up <fog-name>.secondary.database.windows.net` чтобы убедиться, что запись DNS CNAME указывает на IP-адрес целевого региона. Если команда Switch завершается неудачно, запись CNAME не обновляется.

### <a name="remove-the-source-elastic-pools"></a>Удаление исходных пулов эластичных БД

После завершения перемещения удалите ресурсы из исходного региона, чтобы избежать ненужных расходов.

1. Удалите группу отработки отказа с помощью команды [Remove-азсклдатабасефаиловерграуп](/powershell/module/az.sql/remove-azsqldatabasefailovergroup).
1. Удалите каждый исходный эластичный пул на исходном сервере с помощью [Remove-азсклеластикпул](/powershell/module/az.sql/remove-azsqlelasticpool).
1. Удалите исходный сервер с помощью команды [Remove-азсклсервер](/powershell/module/az.sql/remove-azsqlserver).
1. Удалите хранилище ключей, аудит контейнеров хранилища, концентратор событий, экземпляр Azure AD и другие зависимые ресурсы, чтобы не оплачивать их.

## <a name="move-a-managed-instance"></a>Перемещение управляемого экземпляра

### <a name="verify-prerequisites"></a>Проверка необходимых условий

1. Для каждого исходного управляемого экземпляра Создайте целевой экземпляр SQL Управляемый экземпляр того же размера в целевом регионе.  
1. Настройка сети для управляемого экземпляра. Дополнительные сведения см. в разделе [Сетевая конфигурация](../managed-instance/how-to-content-reference-guide.md#network-configuration).
1. Настройте целевую базу данных master с использованием правильных имен входа. Если вы не являетесь подпиской или администратором SQL Управляемый экземпляр, обратитесь к администратору, чтобы назначить необходимые разрешения.
1. Если базы данных зашифрованы с помощью прозрачного шифрования данных и в Azure Key Vault используется собственный ключ шифрования, убедитесь, что Azure Key Vault с одинаковыми ключами шифрования существует в исходном и целевом регионах. Дополнительные сведения см. [в разделе прозрачное шифрование данных с помощью управляемых клиентом ключей в Azure Key Vault](transparent-data-encryption-byok-overview.md).
1. Если для управляемого экземпляра включен аудит, убедитесь, что:
    - Контейнер хранилища или концентратор событий с существующими журналами перемещается в целевой регион.
    - Аудит настроен на целевом экземпляре. Дополнительные сведения см. в разделе [Audit with SQL управляемый экземпляр](../managed-instance/auditing-configure.md).
1. Если экземпляр имеет политику долгосрочного хранения (LTR), существующие резервные копии LTR останутся связанными с текущим экземпляром. Поскольку целевой экземпляр отличается, вы сможете получить доступ к старым резервным копиям LTR в исходном регионе, используя экземпляр источника, даже если экземпляр удален.

  > [!NOTE]
  > Это будет недостаточно для перемещения между облаком независимых и общедоступным регионом. Такая миграция потребует перемещения резервных копий LTR в целевой экземпляр, который в настоящее время не поддерживается.

### <a name="prepare-resources"></a>Подготовка ресурсов

Создайте группу отработки отказа между каждым исходным управляемым экземпляром и соответствующим целевым экземпляром SQL Управляемый экземпляр.

Репликация всех баз данных на каждом экземпляре будет инициирована автоматически. Дополнительные сведения см. в статье [группы автоматической отработки отказа](auto-failover-group-overview.md).

### <a name="monitor-the-preparation-process"></a>Мониторинг процесса подготовки

Вы можете периодически вызывать [Get-азсклдатабасефаиловерграуп](/powershell/module/az.sql/get-azsqldatabasefailovergroup) для мониторинга репликации баз данных из источника в целевой объект. Выходной объект `Get-AzSqlDatabaseFailoverGroup` включает свойство для **ReplicationState**:

- **ReplicationState = 2** (CATCH_UP) указывает, что база данных синхронизирована и для нее можно выполнить безопасную отработку отказа.
- **ReplicationState = 0** (заполнение) указывает, что база данных еще не заполнена и попытка отработки отказа завершится ошибкой.

### <a name="test-synchronization"></a>Тестовая синхронизация

После **ReplicationState** `2` подключитесь к каждой базе данных или подмножеству баз данных с помощью вторичной конечной точки `<fog-name>.secondary.database.windows.net` и выполните любой запрос к базам данных, чтобы обеспечить подключение, правильную конфигурацию безопасности и репликацию данных.

### <a name="initiate-the-move"></a>Начало перемещения

1. Подключитесь к целевому управляемому экземпляру с помощью вторичной конечной точки `<fog-name>.secondary.database.windows.net` .
1. Используйте [параметр Switch-азсклдатабасефаиловерграуп](/powershell/module/az.sql/switch-azsqldatabasefailovergroup) , чтобы перевести вторичный управляемый экземпляр в основной с полной синхронизацией. Эта операция будет выполнена, или будет выполнен откат.
1. Убедитесь, что команда выполнена успешно, используя, `nslook up <fog-name>.secondary.database.windows.net` чтобы убедиться, что запись DNS CNAME указывает на IP-адрес целевого региона. Если команда Switch завершается неудачно, запись CNAME не обновляется.

### <a name="remove-the-source-managed-instances"></a>Удаление исходных управляемых экземпляров

После завершения перемещения удалите ресурсы из исходного региона, чтобы избежать ненужных расходов.

1. Удалите группу отработки отказа с помощью команды [Remove-азсклдатабасефаиловерграуп](/powershell/module/az.sql/remove-azsqldatabasefailovergroup). Это приведет к удалению конфигурации группы отработки отказа и завершению связей георепликации между двумя экземплярами.
1. Удалите исходный управляемый экземпляр с помощью [Remove-азсклинстанце](/powershell/module/az.sql/remove-azsqlinstance).
1. Удалите все дополнительные ресурсы в группе ресурсов, такие как виртуальный кластер, виртуальная сеть и группа безопасности.

## <a name="next-steps"></a>Дальнейшие действия

[Управление](manage-data-after-migrating-to-database.md) базой данных после ее переноса.
