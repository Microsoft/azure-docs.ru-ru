---
title: Активная георепликация
description: Для создания доступных для чтения баз данных-получателей отдельных баз данных в базе данных SQL Azure в одном или в разных регионах центра обработки можно использовать активную георепликацию.
services: sql-database
ms.service: sql-database
ms.subservice: high-availability
ms.custom: sqldbrb=1
ms.devlang: ''
ms.topic: conceptual
author: anosov1960
ms.author: sashan
ms.reviewer: mathoma, sstein
ms.date: 08/27/2020
ms.openlocfilehash: 3a678f6280b5f2d0fd372e75bfbeb6eb2e9b1577
ms.sourcegitcommit: 58ff80474cd8b3b30b0e29be78b8bf559ab0caa1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/17/2021
ms.locfileid: "100634300"
---
# <a name="creating-and-using-active-geo-replication---azure-sql-database"></a>Создание и использование активной георепликации в базе данных SQL Azure
[!INCLUDE[appliesto-sqldb](../includes/appliesto-sqldb.md)]

Активная Георепликация — это функция базы данных SQL Azure, позволяющая создавать доступные для чтения базы данных-получатели отдельных баз данных на сервере в том же или другом центре обработки данных (регионе).

> [!NOTE]
> Активная Георепликация не поддерживается Управляемый экземпляр Azure SQL. Для географической отработки отказа экземпляров SQL Управляемый экземпляр используйте [группы автоматической отработки отказа](auto-failover-group-overview.md).

> [!NOTE]
> Сведения о переносе баз данных SQL из Azure для Германии с помощью активной георепликации см. в статье [Миграция базы данных SQL с помощью активной георепликации](../../germany/germany-migration-databases.md#migrate-sql-database-using-active-geo-replication).

Активная георепликация разработана в качестве решения для обеспечения непрерывности бизнес-процессов, которое позволяет приложению выполнять быстрое аварийное восстановление отдельных баз данных в случае регионального сбоя или сбоя масштабирования. Если георепликация включена, приложение может инициировать отработку отказа в базу данных-получатель в другом регионе Azure. В одном или разных регионах поддерживается до четырех баз данных-получателей, которые также можно использовать для запросов на доступ только для чтения. Отработка отказа должна инициироваться вручную приложением пользователя. После отработки отказа у новой базы данных-источника будет другая конечная точка подключения.

> [!NOTE]
> Активная Георепликация реплицирует изменения в журнале транзакций базы данных потоковой передачи. Он не связан с [репликацией транзакций](/sql/relational-databases/replication/transactional/transactional-replication), которая реплицирует изменения, выполняя команды DML (INSERT, Update и DELETE).

На следующей схеме показана типичная конфигурация геоизбыточного облачного приложения, использующего активную георепликацию.

![активная георепликация](./media/active-geo-replication-overview/geo-replication.png )

> [!IMPORTANT]
> В Базе данных SQL Azure также поддерживаются группы автоматической отработки отказа. Дополнительные сведения см. в [этой статье](auto-failover-group-overview.md).

Если по какой-либо причине произойдет сбой вашей базы данных-источника (или вам просто потребуется перевести ее в автономный режим), вы можете выполнить отработку отказа на любую из доступных баз данных-получателей. При активации отработки отказа в одной из баз данных-получателей все прочие получатели автоматически связываются с новой базой данных-источником.

Вы можете управлять репликацией и отработкой отказа отдельной базы данных или набора баз данных на сервере или в эластичном пуле с помощью активной георепликации. Для этого используйте:

- [портал Azure](active-geo-replication-configure-portal.md).
- [PowerShell: отдельную базу данных](scripts/setup-geodr-and-failover-database-powershell.md);
- [PowerShell: эластичный пул](scripts/setup-geodr-and-failover-elastic-pool-powershell.md);
- [Transact-SQL: отдельную базу данных или эластичный пул](/sql/t-sql/statements/alter-database-azure-sql-database);
- [REST API: отдельную базу данных](/rest/api/sql/replicationlinks);

Активная Георепликация использует технологию [Always on группы доступности](/sql/database-engine/availability-groups/windows/overview-of-always-on-availability-groups-sql-server) ядра СУБД для асинхронной репликации зафиксированных транзакций в базе данных-источнике в базу данных получателя с помощью изоляции моментального снимка. Группы автоматической отработки отказа обеспечивают групповую семантику на основе активной георепликации, однако используется тот же механизм асинхронной репликации. Хотя в любой момент база данных-получатель может немного отстать от базы данных-источника, в базе данных-получателе никогда не будет частично выполненных транзакций. Избыточность в различных регионах позволяет быстро восстанавливать приложения после необратимой потери всего центра обработки данных или его частей, вызванной стихийным бедствием, неисправимыми человеческими ошибками или вредоносными действиями. Конкретные сведения о RPO можно найти в [обзоре непрерывности бизнес-процессов](business-continuity-high-availability-disaster-recover-hadr-overview.md).

> [!NOTE]
> В случае сбоя сети между двумя регионами каждые 10 секунд выполняется попытка установить подключения.

> [!IMPORTANT]
> Чтобы гарантировать, что критическое изменение базы данных-источника реплицировано на дополнительную базу данных перед отработкой отказа, можно вызвать принудительную синхронизацию, что позволит обеспечить репликацию критически важных изменений (например, обновлений паролей). Принудительная синхронизация снизит производительность, так как будет блокировать вызывающий поток, пока все зафиксированные транзакции не будут реплицированы. Дополнительные сведения см. в статье [sp_wait_for_database_copy_sync (база данных SQL Azure)](/sql/relational-databases/system-stored-procedures/active-geo-replication-sp-wait-for-database-copy-sync). Чтобы отследить задержку репликации между базой данных-источником и получателем, см. статью [sys.dm_geo_replication_link_status (база данных SQL Azure)](/sql/relational-databases/system-dynamic-management-views/sys-dm-geo-replication-link-status-azure-sql-database).

На следующем рисунке показан пример активной георепликации, настроенной с помощью базы данных-источника в центрально-северной части США и базы данных-получателя в центрально-южной части США.

![Отношение георепликации](./media/active-geo-replication-overview/geo-replication-relationship.png)

Так как базы данных-получатели доступны для чтения, они могут использоваться для разгрузки рабочих нагрузок только для чтения, например заданий для составления отчетов. Если вы используете активную георепликацию, вы можете создать базу данных-получатель в том же регионе, в котором расположена база данных-источник, однако устойчивость приложения к катастрофическим сбоям останется на прежнем уровне. Если вы используете группы автоматической отработки отказа, база данных-получатель всегда будет создаваться в другом регионе.

Активная георепликация может использоваться не только для аварийного восстановления, но и в следующих сценариях:

- **Миграция базы данных**. активную георепликацию можно использовать для миграции базы данных с одного сервера на другой в сети с минимальным временем простоя.
- **Обновления приложения**: при обновлении приложения вы можете создать дополнительную базу данных-получатель как резервную копию на случай сбоя.

Добавление избыточности баз данных между центрами обработки данных — только часть решения для достижения настоящей непрерывности бизнес-процессов. Для комплексного восстановления приложения (службы) после катастрофического сбоя необходимо восстановить все компоненты, из которых состоит служба и все зависимые службы. К примерам этих компонентов относятся клиентское программное обеспечение (например, браузер с пользовательским кодом JavaScript), интерфейсные веб-серверы, хранилище и DNS. Очень важно, чтобы все компоненты были устойчивы к одинаковым сбоям и становились доступными в соответствии с целевым временем восстановления (RTO) вашего приложения. Следовательно, необходимо определить все зависимые службы и получить сведения о гарантиях и возможностях, которые они предоставляют. Затем необходимо выполнить соответствующие действия, чтобы обеспечить работу службы во время отработки отказа служб, от которых она зависит. Дополнительные сведения о проектировании решений для аварийного восстановления см. в статье [Разработка облачных решений для аварийного восстановления с помощью активной георепликации](designing-cloud-solutions-for-disaster-recovery.md).

## <a name="active-geo-replication-terminology-and-capabilities"></a>Терминология и возможности активной георепликации

- **Автоматическая асинхронная репликация**

  Базу данных-получатель можно создать, только добавив ее к существующей базе данных. Вторичная реплика может быть создана на любом сервере. После создания база данных-получатель заполняется данными, которые копируются из базы данных-источника. Этот процесс называется заполнением. После создания и начального заполнения базы данных-получателя обновления базы данных-источника асинхронно и автоматически реплицируются в базу данных-получателя. Асинхронная репликация означает, что транзакции фиксируются в базе данных-источнике перед их репликацией в базу данных-получатель.

- **Доступные для чтения базы данных-получатели**

  Приложение может получить доступ к базе данных-получателю только для чтения с использованием тех же или других субъектов безопасности, которые применяются для доступа к базе данных-источнику. База данных-получатель работает в режиме изоляции моментальных снимков, чтобы гарантировать, что репликация обновлений базы данных-источника (воспроизведение журнала) не будет задерживаться из-за запросов, выполняемых на базе данных-получателе.

> [!NOTE]
> Если в базе данных-источнике есть обновления схем, воспроизведение журнала в базе данных-получателе откладывается. Для последнего требуется заблокировать схему базы данных-получателя.

> [!IMPORTANT]
> Георепликацию можно использовать для создания базы данных-получателя в том же регионе, что и первичная реплика. Этот вторичный сервер можно использовать для балансировки нагрузки рабочих нагрузок только для чтения в том же регионе. Однако база данных-получатель в том же регионе не предоставляет дополнительную устойчивость к сбоям и, следовательно, не является подходящей целью отработки отказа для аварийного восстановления. Кроме того, она не гарантирует изоляцию зоны доступности. Используйте уровень служб "критически важный для бизнеса" или "Премиум" с [избыточной конфигурацией зоны](high-availability-sla.md#premium-and-business-critical-service-tier-zone-redundant-availability) или [избыточной конфигурации зоны](high-availability-sla.md#general-purpose-service-tier-zone-redundant-availability-preview) уровня служб общего назначения для обеспечения изоляции зоны доступности.
>

- **Плановая отработка отказа**

  Плановая отработка отказа переключает роли первичной и базы данных-получателя после завершения полной синхронизации. Это оперативная операция, которая не приводит к утрате данных. Время операции зависит от размера журнала транзакций в первичной реплике, которая должна быть синхронизирована. Плановая отработка отказа предназначена для следующих сценариев: (а) для выполнения анализа аварийного восстановления в рабочей среде в случае неприемлемой потери данных; (б) перемещение базы данных в другой регион; и (c) для возврата базы данных в основной регион после устранения сбоя (восстановления размещения).

- **Внеплановая отработка отказа**

  При незапланированной или принудительной отработке отказа база данных-получатель немедленно переключается на основную роль без какой-либо синхронизации с базой данных-источником. Все транзакции, зафиксированные в базе данных-источнике, но не реплицированные на базу данных-получатель, будут потеряны. Эта операция разработана в качестве метода восстановления во время простоя, когда база данных-источник недоступна, но ее доступность должна быть быстро восстановлена. Когда исходный первичный сервер возвращается в оперативный режим, он автоматически повторно подключится и станет новым получателем. Все несинхронизированные транзакции до отработки отказа будут сохранены в файле резервной копии, но не будут синхронизированы с новым первичным сервером во избежание конфликтов. Эти транзакции необходимо объединить вручную с самой последней версией базы данных источника.

- **Несколько баз данных-получателей**

  Для каждой базы данных-источника можно создать до 4 баз данных-получателей. Если же имеется только одна база данных-получатель и на ней происходит сбой, приложение подвергается более высокому риску, пока не будет создана новая база данных-получатель. Если существует несколько баз данных-получателей, то приложение остается защищенным даже при сбое одной из баз данных-получателей. Дополнительные базы данных-получатели также могут использоваться для масштабирования рабочих нагрузок только для чтения.

  > [!NOTE]
  > Если вы используете активную георепликацию, чтобы создать глобально распределенное приложение, и вам необходимо предоставить к данным доступ только для чтения более чем в четырех регионах, вы можете создать базу данных-получатель первой базы данных-получателя (цепочку). Это гарантирует виртуально неограниченное масштабирование репликации базы данных. Кроме того, эта цепочка снижает нагрузку репликации в базе данных-источнике. Недостатком является увеличенная задержка репликации в конечных базах данных-получателях.

- **Георепликация баз данных в эластичном пуле**

  Каждая база данных-получатель может отдельно участвовать в эластичном пуле или вообще не участвовать в каком-либо эластичном пуле. Выбор пула для каждой базы данных-получателя осуществляется отдельно и не зависит от конфигурации других баз данных-получателей (источников или получателей). Каждый эластичный пул содержится в одном регионе, поэтому несколько баз данных-получателей в одной топологии никогда не могут совместно использовать один эластичный пул.

- **Управляемые пользователем отработка отказа и восстановление размещения**

  Приложение или пользователь может в любой момент явным образом использовать базу данных-получатель в качестве базы данных-источника. Во время реального сбоя следует использовать параметр "незапланированный", который немедленно повышает уровень базы данных-получателя до первичной. Когда работоспособность вышедшей из строя базы данных-источника будет восстановлена и она снова станет доступной, система автоматически пометит ее как базу данных-получатель и синхронизирует с новой базой данных-источником. Из-за асинхронного характера репликации во время внеплановой отработки отказа может быть потерян небольшой объем данных, если сбой базы данных-источника произойдет до того, как будет выполнена репликация самых последних изменений в базу данных-получатель. При сбое базы данных-источника с несколькими базами данных-получателями система автоматически перенастраивает отношения репликации и связывает оставшиеся базы данных-получатели с новой развернутой базой данных-источником без вмешательства пользователя. После устранения сбоя, который вызвал отработку отказа, желательно вернуть приложение в основной регион. Для этого команда отработки отказа должна вызываться с параметром "запланировано".

## <a name="preparing-secondary-database-for-failover"></a>Подготовка базы данных-получателя к отработке отказа

Чтобы убедиться, что приложение может немедленно получить доступ к новой первичной базе данных-источнику после отработки отказа, убедитесь, что требования к проверке подлинности для сервера-получателя и базы данные Дополнительные сведения см. в разделе [Безопасность базы данных SQL после аварийного восстановления](active-geo-replication-security-configure.md). Чтобы обеспечить соответствие после отработки отказа, убедитесь, что политика хранения резервных копий в базе данных-получателе соответствует основной. Эти параметры не являются частью базы данных и не реплицируются. По умолчанию для базы данных-получателя будет настроен период хранения PITR по умолчанию 7 дней. Дополнительные сведения см. в статье [Подробнее о резервном копировании базы данных SQL](automated-backups-overview.md).

> [!IMPORTANT]
> Если база данных является членом группы отработки отказа, запустить ее отработку отказа можно с помощью команды отработки отказа георепликации. Используйте команду отработки отказа для группы. Если необходимо выполнить отработку отказа отдельной базы данных, сначала необходимо удалить ее из группы отработки отказа. Дополнительные сведения см. в разделе  [группы отработки отказа](auto-failover-group-overview.md) .

## <a name="configuring-secondary-database"></a>Настройка базы данных-получателя

База данных-источник и база данных-получатель должны иметь один и тот же уровень служб. Также настоятельно рекомендуется создать базу данных-получатель с тем же избыточностью хранилища резервных копий и размером вычислений (DTU или виртуальных ядер), что и в первичной реплике. Если база данных-источник испытывает значительную рабочую нагрузку при записи, вторичная с меньшим размером вычислений может не поддерживаться. Это приведет к задержке повтора на вторичной реплике и потенциально недоступности вторичной реплики. Чтобы устранить эти риски, активная Георепликация будет регулировать скорость журнала транзакций первичной реплики, если это необходимо, чтобы разрешить своим получателям отследить.

Другой следствием несбалансированной вторичной конфигурации является то, что после отработки отказа производительность приложения может снизиться из-за недостаточной емкости вычислений нового первичного сервера. В этом случае потребуется масштабировать цель службы базы данных до необходимого уровня, что может занять значительное время и вычислять ресурсы, и в конце процесса увеличения потребуется отработка отказа [высокого уровня доступности](high-availability-sla.md) .

Если вы решили создать базу данных-получатель с меньшим размером вычислений, диаграмма процент ввода-вывода журнала в портал Azure предоставляет хороший способ оценки минимального объема вычислений базы данных-получателя, необходимого для поддержания нагрузки репликации. Например, если база данных-источник — P6 (1000 DTU), а ее процент записи журнала равен 50%, то дополнительный должен быть не менее P4 (500 DTU). Чтобы получить исторические данные журнала ввода-вывода, используйте представление [sys.resource_stats](/sql/relational-databases/system-catalog-views/sys-resource-stats-azure-sql-database) . Для получения последних данных о записи журнала с большей степенью детализации, которая лучше отражает краткосрочные пиковые пики в темпе ведения журнала, используйте представление [sys.dm_db_resource_stats](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-resource-stats-azure-sql-database) .

Регулирование частоты использования журнала транзакций на основном сервере-источнике с меньшим размером вычислений на вторичном сервере сообщается с использованием типа ожидания HADR_THROTTLE_LOG_RATE_MISMATCHED_SLO, видимого в представлениях базы данных [sys.dm_exec_requests](/sql/relational-databases/system-dynamic-management-views/sys-dm-exec-requests-transact-sql) и [sys.dm_os_wait_stats](/sql/relational-databases/system-dynamic-management-views/sys-dm-os-wait-stats-transact-sql) .

По умолчанию избыточность хранилища резервных копий является той же, что и база данных-источник. Вы можете настроить вторичный сервер с другой избыточностью хранилища резервных копий. Резервные копии всегда выполняются в базе данных источника. Если во вторичной реплике настроена другая избыточность хранилища резервных копий, то после отработки отказа при повышении уровня базы данных-получателя до первичного резервного копирования плата будет взиматься в соответствии с избыточностью хранилища, выбранной на новом сервере-источнике (предыдущий дополнительный) 

> [!NOTE]
> Скорость журнала транзакций на сервере-источнике может регулироваться по причинам, не связанным с меньшим размером вычислений на вторичном сервере. Такое регулирование может произойти даже в том случае, если у получателя такой же или более высокий размер вычислений, чем у базы данных-источника. Дополнительные сведения, включая типы ожидания для различных видов регулирования скорости ведения журнала, см. в разделе [Управление частотой ведения журнала транзакций](resource-limits-logical-server.md#transaction-log-rate-governance).

> [!NOTE]
> Настраиваемая избыточность хранилища резервных копий базы данных SQL Azure в настоящее время доступна в общедоступной предварительной версии Южная Бразилия и общедоступна в регионе Azure Юго-Восточной Азии. Если база данных-источник создается с избыточностью хранилища резервных копий с локально избыточностью или с избыточностью зоны, создание базы данных-получателя в другом регионе Azure не поддерживается. 

Дополнительные сведения об объеме вычислительных ресурсов Базы данных SQL см. в статье с описанием [уровней служб Базы данных SQL](purchasing-models.md).

## <a name="cross-subscription-geo-replication"></a>Георепликация между подписками

Чтобы настроить активную георепликацию между двумя базами данных, принадлежащими разным подпискам (в рамках одного клиента или вне), необходимо выполнить специальную процедуру, описанную в этом разделе.  Процедура основана на командах SQL и требует:

- Создание привилегированного имени входа на обоих серверах
- Добавление IP-адреса в список разрешений клиента, выполняющий изменение на обоих серверах (например, IP-адрес узла, на котором выполняется SQL Server Management Studio).

Клиент, выполняющий изменения, должен иметь сетевой доступ к основному серверу. Хотя один и тот же IP-адрес клиента должен быть добавлен в список разрешений на вторичном сервере, сетевое подключение к серверу-получателю не является обязательным.

### <a name="on-the-master-of-the-primary-server"></a>На главном сервере основного сервера

1. Добавьте IP-адрес в список разрешений клиента, выполняющего изменения (Дополнительные сведения см. в разделе [Настройка брандмауэра](firewall-configure.md)).
1. Создайте имя входа, выделенное для настройки активной георепликации (и при необходимости измените учетные данные):

   ```sql
   create login geodrsetup with password = 'ComplexPassword01'
   ```

1. Создайте соответствующего пользователя и назначьте его роли dbmanager:

   ```sql
   create user geodrsetup for login geodrsetup
   alter role dbmanager add member geodrsetup
   ```

1. Запишите идентификатор SID нового имени входа с помощью этого запроса:

   ```sql
   select sid from sys.sql_logins where name = 'geodrsetup'
   ```

### <a name="on-the-source-database-on-the-primary-server"></a>В базе данных источника на сервере источника

1. Создайте пользователя для того же имени входа:

   ```sql
   create user geodrsetup for login geodrsetup
   ```

1. Добавьте пользователя в роль db_owner:

   ```sql
   alter role db_owner add member geodrsetup
   ```

### <a name="on-the-master-of-the-secondary-server"></a>На главном сервере-получателе

1. Добавьте IP-адрес клиента в список разрешенных в разделе правила брандмауэра для сервера-получателя. Убедитесь в том, что на сервер-получатель также добавлен тот же IP адрес клиента, который был добавлен к серверу-источнику. Это обязательный шаг, который необходимо выполнить перед выполнением команды ALTER DATABASE ADD ВТОРИЧного сервера для запуска георепликации.

1. Создайте то же имя входа, что и на сервере источника, используя тот же пароль пользователя и идентификатор безопасности:

   ```sql
   create login geodrsetup with password = 'ComplexPassword01', sid=0x010600000000006400000000000000001C98F52B95D9C84BBBA8578FACE37C3E
   ```

1. Создайте соответствующего пользователя и назначьте его роли dbmanager:

   ```sql
   create user geodrsetup for login geodrsetup;
   alter role dbmanager add member geodrsetup
   ```

### <a name="on-the-master-of-the-primary-server"></a>На главном сервере основного сервера

1. Войдите на главный сервер источника, используя новое имя входа.
1. Создайте вторичную реплику исходной базы данных на сервере-получателе (при необходимости настройте имя базы данных и servername):

   ```sql
   alter database dbrep add secondary on server <servername>
   ```

После первоначальной настройки можно удалить пользователей, имена входа и правила брандмауэра.

## <a name="keeping-credentials-and-firewall-rules-in-sync"></a>Синхронизация учетных данных и правил брандмауэра

Мы рекомендуем использовать [правила брандмауэра IP на уровне базы данных](firewall-configure.md) для геореплицированных баз данных, чтобы эти правила можно было реплицировать вместе с базой данных, чтобы убедиться, что все базы данных-получатели имеют те же правила брандмауэра IP, что и первичная реплика. Такой подход избавляет клиентов от необходимости вручную настраивать и обслуживать правила брандмауэра на серверах, на которых размещаются как базы данных-источники, так и базы данных-получатели. Аналогично, в случае получения доступа к данным с помощью [пользователей автономной базы данных](logins-create-manage.md) базы данных-источники и базы данных-получатели всегда используют одни и те же учетные данные. Поэтому при отработке отказа можно избежать нарушений в работе из-за несоответствия имен для входа или паролей. Благодаря добавлению [Azure Active Directory](../../active-directory/fundamentals/active-directory-whatis.md) клиенты могут управлять доступом пользователей к базам данных-источникам и базам данных-получателям, и им не нужно управлять учетными данными для баз данных.

## <a name="upgrading-or-downgrading-primary-database"></a>Обновление или понижение уровня базы данных источника

Вы можете повышать или понижать объем вычислительных ресурсов базы данных-источника (в рамках одного уровня служб, а не между уровнем общего назначения и критически важным для бизнеса) без отключения каких-либо баз данных-получателей. При повышении рекомендуется сначала повысить уровень производительности базы данных-получателя, а затем — уровень базы данных-источника. При понижении следует действовать в обратном порядке: сначала нужно понизить уровень производительности базы данных-источника, а после этого — базы данных-получателя. Когда вы повышаете или понижаете базу данных до следующего уровня служб, особенно важно выполнять рекомендацию выше.

> [!NOTE]
> Если вы создали базу данных-получатель как часть конфигурации группы отработки отказа, понижение ее уровня не рекомендуется. Это необходимо, чтобы обеспечить достаточную емкость уровня данных для обработки регулярных рабочих нагрузок после активации отработки отказа.

> [!IMPORTANT]
> База данных-источника в группе отработки отказа не может масштабироваться до более высокого уровня без предварительного масштабирования базы данных-получателя до более высокого уровня. Если вы попытаетесь масштабировать базу данных-источник до масштабирования базы данных-получателя, может появиться следующее сообщение об ошибке:
>
> `Error message: The source database 'Primaryserver.DBName' cannot have higher edition than the target database 'Secondaryserver.DBName'. Upgrade the edition on the target before upgrading the source.`
>

## <a name="preventing-the-loss-of-critical-data"></a>Предотвращение потери важных данных

Из-за высокой задержки глобальных сетей непрерывная копия использует механизм асинхронной репликации. Ввиду асинхронной репликации потеря данных в случае сбоя неизбежна. Тем не менее для некоторых приложений терять данные недопустимо. Чтобы защитить эти критические обновления, разработчик приложения сразу же после фиксации транзакции может вызывать системную процедуру [sp_wait_for_database_copy_sync](/sql/relational-databases/system-stored-procedures/active-geo-replication-sp-wait-for-database-copy-sync). Вызов **sp_wait_for_database_copy_sync** блокирует вызывающий поток до передачи последней зафиксированной транзакции в базе данных-получателе. Но вызов не дожидается воспроизведения и фиксации переданных транзакций в базе данных-получателе. **sp_wait_for_database_copy_sync** ограничена конкретной связью непрерывной копии. Эту процедуру может вызвать любой пользователь с правами подключения к базе данных-источнику.

> [!NOTE]
> Процедура **sp_wait_for_database_copy_sync** предотвращает потерю данных после отработки отказа, но не гарантирует полную синхронизацию для доступа на чтение. Вызов процедуры **sp_wait_for_database_copy_sync** может привести к значительной задержке, которая будет зависеть от размера журнала транзакций во время вызова.

## <a name="monitoring-geo-replication-lag"></a>Задержка георепликации при мониторинге

Чтобы отслеживать задержку в отношении RPO, используйте *replication_lag_sec* столбец [sys.dm_geo_replication_link_status](/sql/relational-databases/system-dynamic-management-views/sys-dm-geo-replication-link-status-azure-sql-database) в базе данных источника. Он показывает задержку в секундах между транзакциями, зафиксированными в базе данных-источнике и сохраненной на сервере-получателе. Пример: Если значение запаздывания равно 1 секунде, это означает, что в данный момент на источнике влияет сбой, и инициируется отработка отказа, одна секунда последних переходов не будет сохранена.

Чтобы измерить задержку в отношении изменений в базе данных-источнике, которые были применены к вторичной реплике, т. е. доступной для чтения из базы данных-получателя, Сравните *last_commitное* время на сервере-получателе с тем же значением в базе данных-источнике.

> [!NOTE]
> Иногда *replication_lag_sec* в базе данных-источнике имеет значение null. Это означает, что в настоящее время первичный сервер не знает, насколько далеко.   Обычно это происходит после перезапуска процесса и должно быть переходным условием. Рассмотрите возможность предупреждения приложения, если *replication_lag_sec* возвращает значение NULL в течение продолжительного периода времени. Это означает, что база данных-получатель не может обмениваться данными с источником в связи с постоянной ошибкой подключения. Существуют также условия, которые могут привести к увеличению разницы между *last_commitным* временем на сервере-получателе и в базе данных-источнике. Пример: Если фиксация выполняется на первичном протяжении в течение длительного периода без изменений, разница перейдет до большого значения, прежде чем быстро возвращать значение 0. Рассмотрите ситуацию ошибки, когда разница между этими двумя значениями остается большой в течение длительного времени.

## <a name="programmatically-managing-active-geo-replication"></a>Программное управление активной георепликацией

Как уже говорилось ранее, активной георепликацией можно также управлять программно с помощью Azure PowerShell и REST API. В приведенных ниже таблицах описан доступный для этого набор команд. Активная георепликация включает в себя набор API-интерфейсов Azure Resource Manager для управления, в том числе [REST API Базы данных SQL Azure](/rest/api/sql/) и [командлеты Azure PowerShell](/powershell/azure/). Для этих API требуется использование групп ресурсов и поддержка управления доступом на основе ролей в Azure (Azure RBAC). Дополнительные сведения о реализации ролей доступа см. в статье [Управление доступом на основе ролей в Azure (Azure RBAC)](../../role-based-access-control/overview.md).

### <a name="t-sql-manage-failover-of-single-and-pooled-databases"></a>T-SQL: Управление отработкой отказа для баз данных в одной и в составе пула

> [!IMPORTANT]
> Приведенные ниже команды Transact-SQL применяются только к активной георепликации — они неприменимы к группам отработки отказа. Таким образом, они также не применяются к экземплярам SQL Управляемый экземпляр, так как они поддерживают только группы отработки отказа.

| Get-Help | Описание |
| --- | --- |
| [ALTER DATABASE](/sql/t-sql/statements/alter-database-transact-sql?preserve-view=true&view=azuresqldb-current) |Используйте аргумент ADD SECONDARY ON SERVER, чтобы создать базу данных-получатель для существующей базы данных и начать репликацию данных. |
| [ALTER DATABASE](/sql/t-sql/statements/alter-database-transact-sql?preserve-view=true&view=azuresqldb-current) |Используйте аргумент FAILOVER или FORCE_FAILOVER_ALLOW_DATA_LOSS, чтобы задать базу данных-получатель в качестве базы данных-источника для запуска отработки отказа. |
| [ALTER DATABASE](/sql/t-sql/statements/alter-database-transact-sql?preserve-view=true&view=azuresqldb-current) |Используйте аргумент REMOVE SECONDARY ON SERVER, чтобы завершить репликацию данных между базой данных SQL и указанной базой данных-получателем. |
| [sys.geo_replication_links](/sql/relational-databases/system-dynamic-management-views/sys-geo-replication-links-azure-sql-database) |Возвращает сведения обо всех существующих каналах репликации для каждой базы данных на сервере. |
| [sys.dm_geo_replication_link_status](/sql/relational-databases/system-dynamic-management-views/sys-dm-geo-replication-link-status-azure-sql-database) |Возвращает время последней репликации, запаздывание последней репликации и другие сведения о канале репликации для заданной базы данных. |
| [sys.dm_operation_status](/sql/relational-databases/system-dynamic-management-views/sys-dm-operation-status-azure-sql-database) |Показывает состояние всех операций с базой данных, включая состояние связей репликации. |
| [sp_wait_for_database_copy_sync](/sql/relational-databases/system-stored-procedures/active-geo-replication-sp-wait-for-database-copy-sync) |Указывает приложению ждать, пока все зафиксированные транзакции не будут реплицированы и подтверждены активной базой данных-получателем. |
|  | |

### <a name="powershell-manage-failover-of-single-and-pooled-databases"></a>PowerShell: Управление отработкой отказа для баз данных в одной и в составе пула

[!INCLUDE [updated-for-az](../../../includes/updated-for-az.md)]
> [!IMPORTANT]
> Модуль PowerShell Azure Resource Manager по-прежнему поддерживается базой данных SQL Azure, но вся будущая разработка сосредоточена на модуле Az.Sql. Сведения об этих командлетах см. в разделе [AzureRM.Sql](/powershell/module/AzureRM.Sql/). Аргументы команд в модулях Az и AzureRm практически идентичны.

| Командлет | Описание |
| --- | --- |
| [Get-AzSqlDatabase](/powershell/module/az.sql/get-azsqldatabase) |Получает одну или несколько баз данных. |
| [New-AzSqlDatabaseSecondary](/powershell/module/az.sql/new-azsqldatabasesecondary) |Создает базу данных-получатель для существующей базы данных и начинает репликацию данных. |
| [Set-AzSqlDatabaseSecondary](/powershell/module/az.sql/set-azsqldatabasesecondary) |Преобразует базу данных-получатель в базу данных-источник для запуска отработки отказа. |
| [Remove-AzSqlDatabaseSecondary](/powershell/module/az.sql/remove-azsqldatabasesecondary) |Завершает репликацию данных между базой данных SQL и указанной базой данных-получателем. |
| [Get-AzSqlDatabaseReplicationLink](/powershell/module/az.sql/get-azsqldatabasereplicationlink) |Получает связи георепликации между Базой данных SQL Azure и группой ресурсов или логическим сервером SQL Server. |
|  | |

> [!IMPORTANT]
> Дополнительные сведения о примерах сценариев см. в статьях [Настройка активной георепликации для отдельной базы данных SQL Azure с помощью PowerShell](scripts/setup-geodr-and-failover-database-powershell.md) и [Настройка активной георепликации для базы данных SQL Azure в пуле с помощью PowerShell](scripts/setup-geodr-and-failover-elastic-pool-powershell.md).

### <a name="rest-api-manage-failover-of-single-and-pooled-databases"></a>REST API: Управление отработкой отказа для баз данных в одной и в составе пула

| API | Описание |
| --- | --- |
| [Создание или обновление базы данных (createMode=Restore)](/rest/api/sql/databases/createorupdate) |Создает, обновляет или восстанавливает базу данных-источник или базу данных-получатель. |
| [Получение, создание или обновление состояния базы данных](/rest/api/sql/databases/createorupdate) |Возвращает состояние во время операции создания. |
| [Задание базы данных-получателя в качестве базы данных-источника (плановая отработка отказа)](/rest/api/sql/replicationlinks/failover) |Задает базу данных-получатель в качестве базы данных-источник. Для этого выполняется отработка отказа из текущей базы данных-источник. **Этот параметр не поддерживается для SQL Управляемый экземпляр.**|
| [Задание базы данных-получателя в качестве базы данных-источника (внеплановая отработка отказа)](/rest/api/sql/replicationlinks/failoverallowdataloss) |Задает базу данных-получатель в качестве базы данных-источник. Для этого выполняется отработка отказа из текущей базы данных-источник. Эта операция может привести к потере данных. **Этот параметр не поддерживается для SQL Управляемый экземпляр.**|
| [Получение связи репликации](/rest/api/sql/replicationlinks/get) |Возвращает определенный канал репликации для заданной базы данных в партнерстве георепликации. Извлекает сведения, отображаемые в представлении каталога sys.geo_replication_links. **Этот параметр не поддерживается для SQL Управляемый экземпляр.**|
| [Replication Links - List By Database](/rest/api/sql/replicationlinks/listbydatabase) (Ссылки для репликации: вывод списка по базе данных) | Возвращает все связи репликации для заданной базы данных в партнерстве георепликации. Извлекает сведения, отображаемые в представлении каталога sys.geo_replication_links. |
| [Удаление связей репликации](/rest/api/sql/replicationlinks/delete) | Удаляет связь репликации базы данных. Невозможно выполнить во время отработки отказа. |
|  | |




## <a name="next-steps"></a>Дальнейшие действия

- Ознакомьтесь с примерами скриптов в следующих статьях:
  - [Настройка активной георепликации для отдельной базы данных SQL Azure с помощью PowerShell](scripts/setup-geodr-and-failover-database-powershell.md)
  - [Настройка активной георепликации для базы данных SQL Azure в пуле с помощью PowerShell](scripts/setup-geodr-and-failover-elastic-pool-powershell.md)
- В Базе данных SQL Azure также поддерживаются группы автоматической отработки отказа. Дополнительные сведения см. в [этой статье](auto-failover-group-overview.md).
- Общие сведения о непрерывности бизнес-процессов и сценарии см. в статье [Обзор непрерывности бизнес-процессов](business-continuity-high-availability-disaster-recover-hadr-overview.md) .
- Дополнительные сведения об автоматизированных резервных копиях базы данных SQL Azure см. в статье [Автоматическое резервное копирование базы данных](automated-backups-overview.md)SQL.
- Дополнительные сведения об использовании автоматических резервных копий для восстановления см. в статье [Восстановление базы данных из резервных копий, инициированных службой](recovery-using-backups.md).
- Дополнительные сведения о требованиях к проверке подлинности для новых сервера-источника и базы данных-источника см. в статье [Безопасность базы данных SQL после аварийного восстановления](active-geo-replication-security-configure.md).
