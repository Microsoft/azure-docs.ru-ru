---
title: Настройка синхронизации данных SQL
description: В этом руководстве показано, как настроить Синхронизацию данных SQL для Azure
services: sql-database
ms.service: sql-database
ms.subservice: data-movement
ms.custom: sqldbrb=1
ms.devlang: ''
ms.topic: tutorial
author: stevestein
ms.author: sstein
ms.reviewer: ''
ms.date: 01/14/2019
ms.openlocfilehash: d6b5bab1c1b6c8db4821fdf84728eb66eb55b899
ms.sourcegitcommit: aaa65bd769eb2e234e42cfb07d7d459a2cc273ab
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/27/2021
ms.locfileid: "98882235"
---
# <a name="tutorial-set-up-sql-data-sync-between-databases-in-azure-sql-database-and-sql-server"></a>Руководство по настройке Синхронизации данных SQL между базами данных в Базе данных SQL Azure и SQL Server
[!INCLUDE[appliesto-sqldb](../includes/appliesto-sqldb.md)]

В этом руководстве показано, как настроить Синхронизацию данных SQL, создав группу синхронизации с экземплярами Базы данных SQL Azure и SQL Server. Группа синхронизации полностью настраивается и синхронизируется по заданному расписанию.

Для выполнения задач этого руководства требуется определенный опыт работы с Базой данных SQL и SQL Server.

Общие сведения см. в статье о [синхронизации данных между несколькими облачными и локальными базами данных с помощью Синхронизации данных SQL](sql-data-sync-data-sql-server-sql-database.md).

Примеры команд PowerShell для настройки Синхронизации данных SQL см. в статьях об использовании PowerShell для синхронизации данных [между несколькими базами данных SQL](scripts/sql-data-sync-sync-data-between-sql-databases.md), а также [между базой данных SQL и локальной базой данных SQL Server](scripts/sql-data-sync-sync-data-between-azure-onprem.md).

> [!IMPORTANT]
> Синхронизация данных SQL пока **не поддерживает** Управляемый экземпляр SQL Azure.

## <a name="create-sync-group"></a>Создание группы синхронизации

1. Перейдите на [портал Azure](https://portal.azure.com), чтобы найти базу данных в Базе данных SQL. Выполните поиск по запросу **базы данных SQL** и выберите этот пункт.

    ![Поиск баз данных, портал Microsoft Azure](./media/sql-data-sync-sql-server-configure/search-for-sql-databases.png)

1. Выберите базу данных, которую вы хотите использовать в качестве центральной базы данных для Синхронизации данных.

   :::image type="content" source="./media/sql-data-sync-sql-server-configure/select-sql-database.png" alt-text = "Select from the database list, Microsoft Azure portal":::

    > [!NOTE]
    > Центральная база данных является центральной конечной точкой в топологии синхронизации, в которой размещаются несколько конечных точек баз данных для группы синхронизации. Остальные базы данных, у которых есть конечные точки в этой группе синхронизации, синхронизируются с центральной базой данных.

1. В меню **База данных SQL** для выбранной базы данных щелкните **Синхронизировать с другими базами данных**.

    :::image type="content" source="./media/sql-data-sync-sql-server-configure/sync-to-other-databases.png" alt-text = "Sync to other databases, Microsoft Azure portal":::

1. На странице **Синхронизировать с другими базами данных** выберите **Новая группа синхронизации**. Откроется страница **Новая группа синхронизации** c шагом 1 **Создание группы синхронизации**.

   :::image type="content" source="./media/sql-data-sync-sql-server-configure/new-sync-group-private-link.png" alt-text = "Set up new sync group with private link":::

   На странице **Создание группы синхронизации данных** измените указанные ниже параметры.

   | Параметр                        | Описание |
   | ------------------------------ | ------------------------------------------------- |
   | **Имя группы синхронизации** | Введите имя для новой группы синхронизации. Это имя должно отличаться от имени самой базы данных. |
   | **База данных для метаданных синхронизации** | Выберите создание новой базы данных (рекомендуется) или использование существующей базы данных.<br/><br/>Если вы выбрали вариант **Новая база данных**, щелкните **Создать новую базу данных**. На странице **База данных SQL** задайте имя и параметры для новой базы данных, затем щелкните **ОК**.<br/><br/>Если вы выбрали вариант **Использовать существующую базу данных**, выберите базу данных из списка. |
   | **Автоматическая синхронизация** | Выберите значение **Включено** или **Выключено**.<br/><br/>Если вы выбрали **Включено**, в разделе **Частота синхронизации** введите число и выберите единицы измерения: **секунды**, **минуты**, **часы** или **дни**.<br/> Первая синхронизация начинается по истечении указанного периода времени с момента сохранения конфигурации.|
   | **Устранение конфликтов** | Выберите **Выиграл концентратор** или **Выиграл член**.<br/><br/>Вариант **Выиграл концентратор** означает, что при возникновении конфликта данные из центральной базы данных перезаписывают данные в рядовой базе данных.<br/><br/>Вариант **Выиграл член** означает, что при возникновении конфликта данные из рядовой базы данных перезаписывают данные в центральной базе данных. |
   | **Использование Приватного канала** | Выберите управляемую службой частную конечную точку, чтобы установить безопасное подключение между службой синхронизации и центральной базой данных. |

   > [!NOTE]
   > Корпорация Майкрософт рекомендует создать пустую **базу данных для метаданных синхронизации**. Служба синхронизации данных создает таблицы в этой базе данных и часто выполняет рабочую нагрузку. Эта база данных предоставляется в общий доступ как **База данных для метаданных синхронизации** всем группам синхронизации в выбранном регионе и подписке. Базу данных для метаданных синхронизации или ее имя невозможно изменить, не удалив все группы и агенты синхронизации в регионе.

   Нажмите кнопку **ОК** и подождите, пока будет создана и развернута группа синхронизации.
   
1. Если на странице **Новая группа синхронизации** выбрано **использование Приватного канала**, необходимо утвердить подключение к частной конечной точке. Ссылка в информационном сообщении позволяет перейти к функции "Подключения к частной конечной точке", с помощью которой можно утвердить подключение. 

   :::image type="content" source="./media/sql-data-sync-sql-server-configure/approve-private-link.png" alt-text = "Approve private link":::

## <a name="add-sync-members"></a>Добавление членов синхронизации

После создания и развертывания группы синхронизации на странице **Новая группа синхронизации** выделяется шаг 2 **Добавление членов синхронизации**.

В разделе **Центральная база данных** введите существующие учетные данные для сервера, на котором расположена центральная база данных. Не вводите *новые* учетные данные в этом разделе.

   :::image type="content" source="./media/sql-data-sync-sql-server-configure/steptwo.png" alt-text = "Enter existing credentials for the hub database server":::

### <a name="to-add-a-database-in-azure-sql-database"></a>Добавление базы данных в Базе данных SQL Azure

В разделе **Рядовая база данных** можно дополнительно добавить в группу синхронизации базу данных в Базе данных SQL Azure, щелкнув **Добавить Базу данных SQL Azure**. Откроется страница **Configure Azure SQL Database** (Настройка Базы данных SQL Azure).
  
   :::image type="content" source="./media/sql-data-sync-sql-server-configure/step-two-configure.png" alt-text = "Add a database to the sync group":::
   
  На странице **Configure Azure SQL Database** (Настройка Базы данных SQL Azure) измените указанные ниже параметры.

  | Параметр                       | Описание |
  | ----------------------------- | ------------------------------------------------- |
  | **Имя участника синхронизации** | Укажите имя нового участника синхронизации. Это имя должно отличаться от имени самой базы данных. |
  | **Подписка** | Выберите связанную подписку Azure для выставления счетов. |
  | **Azure SQL Server;** | Выберите существующий сервер. |
  | **База данных SQL Azure** | Выберите существующую базу данных в Базе данных SQL. |
  | **Направления синхронизации** | Выберите вариант **Двунаправленная синхронизация**, **К концентратору** или **Из концентратора**. |
  | **Имя пользователя** и **Пароль** | Введите существующие учетные данные для сервера, на котором расположена рядовая база данных. Не вводите *новые* учетные данные в этом разделе. |
  | **Использование Приватного канала** | Выберите управляемую службой частную конечную точку, чтобы установить безопасное подключение между службой синхронизации и рядовой базой данных. |

  Нажмите кнопку **ОК** и подождите, пока будет создан и развернут новый член синхронизации.

<a name="add-on-prem"></a>

### <a name="to-add-a-sql-server-database"></a>Добавление новой базы данных SQL Server

В разделе **Рядовая база данных** можно дополнительно добавить в группу синхронизации базу данных SQL Server, щелкнув **Добавить локальную базу данных**. Откроется страница **Настройка локальной среды**, где вы можете выполнить описанные ниже действия.

1. Щелкните **Выбор шлюза агента синхронизации**. Откроется страница **Выбор агента синхронизации**.

   :::image type="content" source="./media/sql-data-sync-sql-server-configure/steptwo-agent.png" alt-text = "Creating a sync agent":::

1. На странице **Choose the Sync Agent** (Выбор агента синхронизации) укажите, следует ли использовать существующий агент или создать новый.

   Если вы выбрали вариант **Существующие агенты**, выберите агент в списке.

   Если вы выбрали вариант **Создание агента**, сделайте следующее:

   1. Скачайте агент синхронизации данных, воспользовавшись предоставленной ссылкой, и установите его на компьютере, на котором размещен сервер SQL Server. Вы также можете скачать агент непосредственно на [странице SQL Azure Data Sync Agent](https://www.microsoft.com/download/details.aspx?id=27693).

      > [!IMPORTANT]
      > Необходимо открыть исходящий TCP-порт 1433 в брандмауэре, чтобы позволить агенту клиента обмениваться данными с сервером.

   1. Введите имя агента.

   1. Выберите **Создание и генерация ключа** и скопируйте ключ агента в буфер обмена

   1. Нажмите кнопку **ОК**, чтобы закрыть страницу **Выбор агента синхронизации**.

1. На компьютере SQL Server найдите и запустите приложение агента клиента синхронизации.

   ![Приложение агента клиента синхронизации данных](./media/sql-data-sync-sql-server-configure/datasync-preview-clientagent.png)

    1. В приложении агента синхронизации выберите **Submit Agent Key** (Отправить ключ агента). Откроется диалоговое окно **Sync Metadata Database Configuration** (Конфигурация базы данных для метаданных синхронизации).

    1. В диалоговом окне **Sync Metadata Database Configuration** (Конфигурация базы данных для метаданных синхронизации) вставьте ключ агента, скопированный на портале Azure. Укажите также существующие учетные данные для сервера, на котором расположена база данных для метаданных. (если вы создали базу данных для метаданных, то она находится на том же сервере, что и центральная база данных). Нажмите кнопку **ОК** и дождитесь завершения настройки.

        ![Ввод ключа агента и учетных данных сервера](./media/sql-data-sync-sql-server-configure/datasync-preview-agent-enterkey.png)

        > [!NOTE]
        > Если вы получите сообщение об ошибке брандмауэра, создайте в Azure правило брандмауэра, которое разрешает входящий трафик от компьютера SQL Server. Такое правило можно создать вручную на портале или с помощью SQL Server Management Studio (SSMS). В среде SSMS для подключения к центральной базе данных в Azure введите имя этой базы данных в формате <имя_центральной_базы_данных>.database.windows.net.

    1. Щелкните **Регистрация**, чтобы зарегистрировать базу данных SQL Server в агенте. Откроется диалоговое окно **SQL Server Configuration** (Конфигурация SQL Server).

        ![Добавление и настройка базы данных SQL Server](./media/sql-data-sync-sql-server-configure/datasync-preview-agent-adddb.png)

    1. В диалоговом окне **Конфигурация SQL Server** выберите, следует ли устанавливать подключение с использованием аутентификации SQL Server или аутентификации Windows. Если выбрана аутентификация SQL Server, введите существующие учетные данные. Укажите имя SQL Server и имя базы данных, которую требуется синхронизировать, и щелкните **Тестирование подключения** для проверки настроек. Теперь щелкните **Сохранить**, и зарегистрированная база данных появится в списке.

        ![База данных SQL Server зарегистрирована](./media/sql-data-sync-sql-server-configure/datasync-preview-agent-dbadded.png)

    1. Закройте приложение агента синхронизации клиента.

1. На странице портала **Настройка локальной среды** щелкните **Выбор базы данных**.

1. На странице **Выбор базы данных** в поле **Имя участника синхронизации** укажите имя нового члена синхронизации. Это имя должно отличаться от имени самой базы данных. Выберите базу данных из списка. В поле **Направления синхронизации** выберите значение **Двунаправленная синхронизация**, **К концентратору** или **Из концентратора**.

    ![Выбор локальной базы данных](./media/sql-data-sync-sql-server-configure/datasync-preview-selectdb.png)

1. Нажмите кнопку **ОК**, чтобы закрыть страницу **Выбор базы данных**. Затем нажмите кнопку **ОК**, чтобы закрыть страницу **Настройка локальной среды**, и подождите, пока новый член синхронизации не будет создан и развернут. Наконец, нажмите кнопку **ОК**, чтобы закрыть страницу **Выбор членов синхронизации**.

> [!NOTE]
> Чтобы подключиться к службе синхронизации данных SQL и к локальному агенту, добавьте используемое имя пользователя в роль *DataSync_Executor*. Служба синхронизации данных создает эту роль в экземпляре SQL Server.

## <a name="configure-sync-group"></a>Настройка группы синхронизации

После создания и развертывания участников группы синхронизации на странице **Новая группа синхронизации** выделяется шаг 3, **Настройка группы синхронизации**.

![Шаг 3. Параметры](./media/sql-data-sync-sql-server-configure/stepthree.png)

1. На странице **Таблицы** выберите базу данных из списка участников группы синхронизации, а затем щелкните **Обновить схему**.

1. Выберите в списке таблицы для синхронизации. По умолчанию здесь выбраны все столбцы, поэтому снимите флажки для тех столбцов, которые вам не нужно синхронизировать. Обязательно оставьте выбранным столбец первичного ключа.

1. Щелкните **Сохранить**.

1. По умолчанию базы данных не синхронизируются, пока вы не настроите расписание или не запустите синхронизацию вручную. Чтобы выполнить синхронизацию вручную, перейдите на портале Azure к нужной базе данных в Базе данных SQL, щелкните **Синхронизировать с другими базами данных** и выберите группу синхронизации. Откроется страница **Синхронизация данных**. Выберите **Синхронизация**.

    ![Синхронизация вручную](./media/sql-data-sync-sql-server-configure/datasync-sync.png)

## <a name="faq"></a>Вопросы и ответы

**Создает ли Синхронизация данных SQL полные таблицы?**

Если в целевой базе данных нет таблиц схемы синхронизации, то Синхронизация данных SQL создает их с выбранным для синхронизации набором столбцов. Но этот механизм не позволяет создать полноценную схему по следующим причинам:

- В целевой таблице создаются только выбранные столбцы. Все невыбранные столбцы игнорируются.
- В таблице назначения создаются индексы только по выделенным столбцам. Для невыбранных столбцов все индексы игнорируются.
- Индексы для столбцов типа XML не создаются.
- Ограничения CHECK не создаются.
- Триггеры из исходных таблиц не создаются.
- Представления и хранимые процедуры не создаются.

Из-за этих ограничений мы рекомендуем применять следующий подход:

- В рабочей среде следует самостоятельно создать полноценную схему.
- Для экспериментов со службой можно применить функцию автоматической подготовки.

**Почему в списке отображаются таблицы, созданные не мной?**

Синхронизация данных создает в базе данных дополнительные таблицы для отслеживания изменений. Не удаляйте их, иначе функция синхронизации данных перестанет работать.

**Гарантируется ли согласованность данных после синхронизации?**

Не обязательно. Для примера рассмотрим группу синхронизации с концентратором и тремя рядовыми базами данных (A, B и C), в которой настроена синхронизация из концентратора в A, из концентратора в B и из концентратора в C. Если в базу данных A внесены изменения *после* синхронизации из концентратора в A, эти изменения не попадут в базы данных B и C до следующей задачи синхронизации.

**Как применить изменения схемы в группе синхронизации?**

Все изменения схемы нужно вносить и распространять вручную.

1. Реплицируйте изменения схемы вручную в центр и все остальные члены синхронизации.
1. Обновление схемы синхронизации.

Добавление новых таблиц или столбцов

Новые таблицы и столбцы не влияют на текущую синхронизацию и Синхронизация данных игнорирует их, пока они не добавлены в схему синхронизации. При добавлении новых объектов базы данных соблюдайте такую последовательность:

1. Добавьте новые таблицы или столбцы в центральной базе данных и на всех участниках синхронизации.
1. Добавьте новые таблицы или столбцы в схему синхронизации.
1. Вносите данные в новые таблицы и столбцы.

Изменение типа данных для столбца

Если изменить тип данных существующего столбца, синхронизация данных продолжает выполняться до тех пор, пока новые значения соответствуют исходному типу данных, определенному в схеме синхронизации. Например, если вы измените в базе данных-источнике тип с **int** на **bigint**, синхронизация данных будет продолжаться, пока на обработку не поступит слишком большое для типа **int** значение. Чтобы завершить изменение, вручную реплицируйте изменения схемы в концентратор и на все участники синхронизации, а затем обновите схему синхронизации.

**Как правильно экспортировать и импортировать базу данных, для которой выполняется синхронизация данных?**

Сначала следует экспортировать базу данных в файл с расширением *.bacpac* и импортировать его для создания новой базы данных. После этого нужно применить синхронизацию к новой базе данных. Для этого выполните описанные ниже действия.

1. Очистите объекты синхронизации данных и все дополнительные таблицы в новой базе данных с помощью [этого скрипта](https://github.com/vitomaz-msft/DataSyncMetadataCleanup/blob/master/Data%20Sync%20complete%20cleanup.sql). Этот скрип удаляет из базы данных все необходимые объекты Синхронизации данных.
1. Повторно создайте группу синхронизации с новой базой данных. Если старая группа синхронизации больше не нужна, удалите ее.

**Где найти сведения об агенте клиента?**

Часто задаваемые вопросы об агенте клиента см. в [этом разделе](sql-data-sync-agent-overview.md#agent-faq).

**Нужно ли утверждать приватный канал вручную перед его использованием**

Да, необходимо вручную утвердить управляемую службой закрытую конечную точку на странице "Подключения к частной конечной точке" на портале Azure при развертывании группы синхронизации или с помощью PowerShell.

## <a name="next-steps"></a>Дальнейшие действия

Поздравляем. Вы создали группу синхронизации, которая включает и экземпляр базы данных SQL, и базу данных SQL Server.

Дополнительные сведения о синхронизации данных SQL:

- Сведения об [агенте синхронизации данных для синхронизации данных SQL Azure](sql-data-sync-agent-overview.md).
- [Рекомендации по синхронизации данных SQL](sql-data-sync-best-practices.md) и инструкции по [устранению неполадок с синхронизацией данных SQL](sql-data-sync-troubleshoot.md).
- [Мониторинг синхронизации данных SQL с помощью журналов Azure Monitor](./monitor-tune-overview.md)
- Сведения об обновлении схемы синхронизации с помощью [Transact-SQL](sql-data-sync-update-sync-schema.md) или [PowerShell](scripts/update-sync-schema-in-sync-group.md).

Дополнительные сведения о Базе данных SQL:

- [Обзор Базы данных SQL](sql-database-paas-overview.md)
- [Управление жизненным циклом базы данных](/previous-versions/sql/sql-server-guides/jj907294(v=sql.110))
