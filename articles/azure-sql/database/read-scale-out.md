---
title: Чтение запросов к репликам
description: SQL Azure предоставляет возможность использования емкости реплик только для чтения для рабочих нагрузок чтения, называемых горизонтальным масштабированием чтения.
services: sql-database
ms.service: sql-database
ms.subservice: scale-out
ms.custom: sqldbrb=1
ms.devlang: ''
ms.topic: conceptual
author: anosov1960
ms.author: sashan
ms.reviewer: sstein
ms.date: 01/20/2021
ms.openlocfilehash: 5f9e7e1c96db2b60e41fe0ded69ea562cf8fcea6
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "98663991"
---
# <a name="use-read-only-replicas-to-offload-read-only-query-workloads"></a>Использование реплик только для чтения для разгрузки рабочих нагрузок запросов только для чтения
[!INCLUDE[appliesto-sqldb-sqlmi](../includes/appliesto-sqldb-sqlmi.md)]

В рамках [архитектуры с высоким уровнем доступности](high-availability-sla.md#premium-and-business-critical-service-tier-locally-redundant-availability)каждая отдельная база данных, база данных эластичного пула и управляемый экземпляр на уровне служб Premium и критически важный для бизнеса автоматически подготавливаются к первичной реплике для чтения и записи и нескольким вторичным репликам только для чтения. Вторичные реплики подготавливаются с тем же размером вычислений, что и первичная реплика. Функция *масштабирования чтения* позволяет разгрузить рабочие нагрузки только для чтения с использованием мощности вычислений одной из реплик только для чтения, а не запускать их в реплике для чтения и записи. Таким образом, некоторые рабочие нагрузки только для чтения могут быть изолированы от рабочих нагрузок для чтения и записи и не будут влиять на их производительность. Эта функция предназначена для приложений, которые содержат логически разделенные рабочие нагрузки только для чтения, такие как аналитика. На уровнях служб "Премиум" и "критически важный для бизнеса" приложения могут повысить производительность с помощью этой дополнительной емкости без дополнительных затрат.

При создании хотя бы одной вторичной реплики также доступна функция *горизонтального масштабирования для чтения* на уровне служб. Для балансировки нагрузки только для чтения можно использовать несколько вторичных реплик, требующих больше ресурсов, чем доступно на одной вторичной реплике.

Архитектура высокого уровня доступности уровней "базовый", "Стандартный" и "общего назначения" не включает ни одной реплики. Функция *горизонтального масштабирования чтения* недоступна на этих уровнях служб.

Эта функция показана на следующей схеме.

![Реплики только для чтения](./media/read-scale-out/business-critical-service-tier-read-scale-out.png)

Функция *масштабирования чтения* по умолчанию включена для новых баз данных Premium, критически важный для бизнеса и Scale. Для линейного масштабирования одна вторичная реплика по умолчанию создается для новых баз данных. 

> [!NOTE]
> Горизонтальное масштабирование чтения всегда включено на уровне служб критически важный для бизнеса Управляемый экземпляр.

Если строка подключения SQL настроена с помощью `ApplicationIntent=ReadOnly` , приложение будет перенаправляться в реплику, доступную только для чтения этой базы данных или управляемого экземпляра. Сведения об использовании `ApplicationIntent` свойства см. в разделе [Указание намерения приложения](/sql/relational-databases/native-client/features/sql-server-native-client-support-for-high-availability-disaster-recovery#specifying-application-intent).

Если вы хотите убедиться, что приложение подключается к первичной реплике независимо от `ApplicationIntent` параметра в строке подключения SQL, необходимо явно отключить горизонтальное масштабирование чтения при создании базы данных или при изменении ее конфигурации. Например, если вы обновите базу данных с уровня "Стандартный" или "общего назначения" на "Премиум", критически важный для бизнеса или "Масштаб" и хотите убедиться, что все подключения продолжают работать с первичной репликой, отключите горизонтальное масштабирование чтения. Дополнительные сведения о том, как ее отключить, см. в разделе [Включение и отключение горизонтального масштабирования для чтения](#enable-and-disable-read-scale-out).

> [!NOTE]
> Функции хранилища запросов и SQL Profiler не поддерживаются в репликах только для чтения. 

## <a name="data-consistency"></a>Согласованность данных

Одним из преимуществ реплик является то, что реплики всегда находятся в состоянии транзакционной согласованности, но в разные моменты времени может возникать небольшая задержка между различными репликами. Масштабное масштабирование чтения поддерживает согласованность на уровне сеанса. Это означает, что если сеанс только для чтения повторно подключается после ошибки подключения, вызванной недоступностью реплики, он может быть перенаправлен на реплику, которая не 100% обновлена с репликой для чтения и записи. Аналогичным образом, если приложение записывает данные с помощью сеанса, доступного для чтения и записи, и сразу же считывает их с помощью сеанса, доступного только для чтения, возможно, что последние обновления будут отражены в реплике не сразу. Такая задержка вызвана асинхронной операцией повторной обработки журнала транзакций.

> [!NOTE]
> Задержка репликации в пределах региона мала, и такая ситуация возникает редко. Сведения о мониторинге задержки репликации см. в разделе [мониторинг и устранение неполадок реплики только для чтения](#monitoring-and-troubleshooting-read-only-replicas).

## <a name="connect-to-a-read-only-replica"></a>Подключение к реплике только для чтения

При включении масштабирования чтения для базы данных `ApplicationIntent` параметр в строке подключения, предоставленной клиентом, определяет, будет ли соединение направляться к реплике записи или к реплике только для чтения. В частности, если `ApplicationIntent` значение равно `ReadWrite` (значение по умолчанию), соединение будет перенаправляться в реплику, доступную для чтения и записи. Это идентично поведению, если `ApplicationIntent` не включено в строку подключения. Если значение `ApplicationIntent` — `ReadOnly`, подключение направляется к реплике, доступной только для чтения.

Например, следующая строка подключения позволяет подключить клиента к реплике только для чтения (замените элементы в угловых скобках правильными значениями для среды и удалите угловые скобки):

```sql
Server=tcp:<server>.database.windows.net;Database=<mydatabase>;ApplicationIntent=ReadOnly;User ID=<myLogin>;Password=<myPassword>;Trusted_Connection=False; Encrypt=True;
```

Обе приведенные ниже строки подключения подключают подключить клиента к реплике для чтения и записи (замените элементы в угловых скобках правильными значениями для среды и удалите угловые скобки):

```sql
Server=tcp:<server>.database.windows.net;Database=<mydatabase>;ApplicationIntent=ReadWrite;User ID=<myLogin>;Password=<myPassword>;Trusted_Connection=False; Encrypt=True;

Server=tcp:<server>.database.windows.net;Database=<mydatabase>;User ID=<myLogin>;Password=<myPassword>;Trusted_Connection=False; Encrypt=True;
```

## <a name="verify-that-a-connection-is-to-a-read-only-replica"></a>Убедитесь, что подключение выполняется к реплике только для чтения

Вы можете проверить, подключена ли вы к реплике только для чтения, выполнив следующий запрос в контексте базы данных. Он возвратит READ_ONLY при подключении к реплике только для чтения.

```sql
SELECT DATABASEPROPERTYEX(DB_NAME(), 'Updateability');
```

> [!NOTE]
> В уровнях служб "Премиум" и "критически важный для бизнеса" только одна из доступных только для чтения реплик доступна в любой конкретный момент времени. Масштабирование поддерживает несколько реплик только для чтения.

## <a name="monitoring-and-troubleshooting-read-only-replicas"></a>Мониторинг и устранение неполадок в репликах только для чтения

При подключении к реплике только для чтения динамические административные представления (DMV) отображают состояние реплики и могут запрашиваться для целей мониторинга и устранения неполадок. Ядро СУБД предоставляет несколько представлений для предоставления широкого спектра данных мониторинга. 

Часто используемые представления:

| Имя | Назначение |
|:---|:---|
|[sys.dm_db_resource_stats](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-resource-stats-azure-sql-database)| Предоставляет метрики использования ресурсов за последний час, включая ЦП, операции ввода-вывода данных и использование записи журнала относительно ограничений цели службы.|
|[sys.dm_os_wait_stats](/sql/relational-databases/system-dynamic-management-views/sys-dm-os-wait-stats-transact-sql)| Предоставляет совокупную статистику ожидания для экземпляра ядра СУБД. |
|[sys.dm_database_replica_states](/sql/relational-databases/system-dynamic-management-views/sys-dm-database-replica-states-azure-sql-database)| Предоставляет состояние работоспособности реплики и статистику синхронизации. Размер очереди повтора и скорость повтора служат индикаторами задержки данных в реплике только для чтения. |
|[sys.dm_os_performance_counters](/sql/relational-databases/system-dynamic-management-views/sys-dm-os-performance-counters-transact-sql)| Предоставляет счетчики производительности ядра СУБД.|
|[sys.dm_exec_query_stats](/sql/relational-databases/system-dynamic-management-views/sys-dm-exec-query-stats-transact-sql)| Предоставляет статистику выполнения по запросу, например количество выполнений, использованное время ЦП и т. д.|
|[sys.dm_exec_query_plan ()](/sql/relational-databases/system-dynamic-management-views/sys-dm-exec-query-plan-transact-sql)| Предоставляет кэшированные планы запросов. |
|[sys.dm_exec_sql_text ()](/sql/relational-databases/system-dynamic-management-views/sys-dm-exec-sql-text-transact-sql)| Предоставляет текст запроса для кэшированного плана запроса.|
|[sys.dm_exec_query_profiles](/sql/relational-databases/system-dynamic-management-views/sys-dm-exec-query-plan-stats-transact-sql)| Предоставляет ход выполнения запросов в реальном времени во время выполнения запросов.|
|[sys.dm_exec_query_plan_stats ()](/sql/relational-databases/system-dynamic-management-views/sys-dm-exec-query-plan-stats-transact-sql)| Предоставляет Последний известный фактический план выполнения, включая статистику времени выполнения для запроса.|
|[sys.dm_io_virtual_file_stats ()](/sql/relational-databases/system-dynamic-management-views/sys-dm-io-virtual-file-stats-transact-sql)| Предоставляет статистику операций ввода-вывода, пропускной способности и задержки хранилища для всех файлов базы данных. |

> [!NOTE]
> Динамические `sys.resource_stats` `sys.elastic_pool_resource_stats` административные представления и в логической базе данных master возвращают данные об использовании ресурсов первичной реплики.

### <a name="monitoring-read-only-replicas-with-extended-events"></a>Мониторинг реплик только для чтения с расширенными событиями

Сеанс расширенных событий не может быть создан при подключении к реплике только для чтения. Однако в базе данных SQL Azure определения сеансов [расширенных событий](xevent-db-diff-from-svr.md) уровня базы данных, созданные и измененные на первичной реплике, реплицируются в реплики только для чтения, включая геореплики, и записывают события в репликах только для чтения.

Сеанс расширенного события в реплике только для чтения, основанной на определении сеанса из первичной реплики, может быть запущен и остановлен независимо от первичной реплики. Когда сеанс расширенных событий удаляется на первичной реплике, он также удаляется на всех репликах, предназначенных только для чтения.

### <a name="transaction-isolation-level-on-read-only-replicas"></a>Уровень изоляции транзакций для реплик только для чтения

Запросы, выполняемые на репликах только для чтения, всегда сопоставляются с уровнем изоляции транзакции [snapshot](/dotnet/framework/data/adonet/sql/snapshot-isolation-in-sql-server) . Изоляция моментальных снимков использует управление версиями строк во избежание ситуаций блокировки, в которых читатели блокируют модули записи.

В редких случаях, если транзакция изоляции моментального снимка обращается к метаданным объекта, которые были изменены в другой параллельной транзакции, она может получить ошибку [3961](/sql/relational-databases/errors-events/mssqlserver-3961-database-engine-error), "Сбой транзакции изоляции моментального снимка в базе данных"%. * ls ", так как объект, к которому обращается инструкция, был изменен инструкцией DDL в другой параллельной транзакции с момента запуска этой транзакции. Это запрещено, так как управление версиями метаданных не осуществляется. Параллельное обновление метаданных может привести к несогласованности при использовании смешанного режима с изоляцией моментальных снимков ".

### <a name="long-running-queries-on-read-only-replicas"></a>Длительные запросы к репликам только для чтения

Запросы, выполняющиеся в репликах только для чтения, должны иметь доступ к метаданным для объектов, на которые ссылается запрос (таблицы, индексы, статистика и т. д.). В редких случаях, если объект метаданных изменяется на первичной реплике, в то время как запрос удерживает блокировку того же объекта в реплике только для чтения, запрос может [заблокировать](/sql/database-engine/availability-groups/windows/troubleshoot-primary-changes-not-reflected-on-secondary#BKMK_REDOBLOCK) процесс, который применяет изменения из первичной реплики к реплике только для чтения. Если такой запрос был выполнен в течение длительного времени, то реплика только для чтения может значительно не синхронизироваться с первичной репликой.

Если долго выполняющийся запрос в реплике только для чтения вызывает такую блокировку, он будет автоматически завершен. Сеанс получит ошибку 1219, "сеанс был отключен из-за операции DDL с высоким приоритетом" или ошибки 3947 ", транзакция была прервана, так как вторичное вычисление не смогло выполнить повтор. Повторите транзакцию ".

> [!NOTE]
> Если при выполнении запросов к реплике только для чтения появляется сообщение об ошибке 3961, 1219 или 3947, повторите запрос.

> [!TIP]
> В уровнях обслуживания Premium и критически важный для бизнеса при подключении к реплике только для чтения `redo_queue_size` `redo_rate` столбцы и в динамическом административном наборе [sys.dm_database_replica_states](/sql/relational-databases/system-dynamic-management-views/sys-dm-database-replica-states-azure-sql-database) могут использоваться для мониторинга процесса синхронизации данных, выступая в качестве индикаторов задержки данных в реплике только для чтения.
> 

## <a name="enable-and-disable-read-scale-out"></a>Включение и отключение горизонтального масштабирования для чтения

Горизонтальное масштабирование чтения включено по умолчанию на уровнях служб Premium, критически важный для бизнеса и Scale. Невозможно включить горизонтальное масштабирование чтения на уровнях служб "базовый", "Стандартный" или "общего назначения". Горизонтальное масштабирование чтения автоматически отключается для баз данных масштаба, настроенных с нулевыми репликами.

Вы можете отключить и повторно включить масштабирование чтения для отдельных баз данных и баз данных эластичного пула на уровне службы Premium или критически важный для бизнеса, используя следующие методы.

> [!NOTE]
> Для отдельных баз данных и баз данных эластичных пулов возможность отключения масштабирования чтения предоставляется для обеспечения обратной совместимости. Невозможно отключить горизонтальное масштабирование чтения для критически важный для бизнеса управляемых экземпляров.

### <a name="azure-portal"></a>Портал Azure

Вы можете управлять параметром масштабирования чтения в колонке **Настройка** базы данных.

### <a name="powershell"></a>PowerShell

> [!IMPORTANT]
> Модуль PowerShell Azure Resource Manager по-прежнему поддерживается, но вся будущая разработка предназначена для модуля AZ. SQL. Модуль Azure Resource Manager продолжит отправлять исправления ошибок до 2020 декабря.  Аргументы для команд в модуле AZ и в Azure Resource Managerных модулях значительно идентичны. Дополнительные сведения о совместимости см. в разделе [Введение в новый модуль Azure PowerShell AZ](/powershell/azure/new-azureps-module-az).

Для управления горизонтальным масштабированием чтения в Azure PowerShell требуется выпуск от декабря 2016 Azure PowerShell или более поздней версии. Последнюю версию Azure PowerShell см. [здесь](/powershell/azure/install-az-ps).

Можно отключить или повторно включить горизонтальное масштабирование чтения в Azure PowerShell, вызвав командлет [Set-азсклдатабасе](/powershell/module/az.sql/set-azsqldatabase) и передав нужное значение ( `Enabled` или `Disabled` ) для `-ReadScale` параметра.

Чтобы отключить горизонтальное масштабирование чтения в существующей базе данных (замените элементы в угловых скобках правильными значениями для вашей среды и удалите угловые скобки):

```powershell
Set-AzSqlDatabase -ResourceGroupName <resourceGroupName> -ServerName <serverName> -DatabaseName <databaseName> -ReadScale Disabled
```

Чтобы отключить горизонтальное масштабирование чтения в новой базе данных (замените элементы в угловых скобках правильными значениями для вашей среды и удалите угловые скобки):

```powershell
New-AzSqlDatabase -ResourceGroupName <resourceGroupName> -ServerName <serverName> -DatabaseName <databaseName> -ReadScale Disabled -Edition Premium
```

Чтобы повторно включить горизонтальное масштабирование чтения в существующей базе данных (заменив элементы в угловых скобках на правильные значения для вашей среды и удалив угловые скобки):

```powershell
Set-AzSqlDatabase -ResourceGroupName <resourceGroupName> -ServerName <serverName> -DatabaseName <databaseName> -ReadScale Enabled
```

### <a name="rest-api"></a>REST API

Чтобы создать базу данных с отключенным горизонтальным масштабированием чтения или изменить параметр для существующей базы данных, используйте следующий метод со `readScale` свойством, для которого задано значение `Enabled` или `Disabled` , как в следующем примере запроса.

```rest
Method: PUT
URL: https://management.azure.com/subscriptions/{SubscriptionId}/resourceGroups/{GroupName}/providers/Microsoft.Sql/servers/{ServerName}/databases/{DatabaseName}?api-version= 2014-04-01-preview
Body: {
   "properties": {
      "readScale":"Disabled"
   }
}
```

Дополнительные сведения см. в разделе [базы данных — создание или обновление](/rest/api/sql/databases/createorupdate).

## <a name="using-the-tempdb-database-on-a-read-only-replica"></a>Использование `tempdb` базы данных в реплике только для чтения

`tempdb`База данных на первичной реплике не реплицируется в реплики только для чтения. Каждая реплика имеет собственную `tempdb` базу данных, созданную при создании реплики. Это гарантирует `tempdb` обновление и может быть изменено во время выполнения запроса. Если Рабочая нагрузка только для чтения зависит от использования `tempdb` объектов, следует создать эти объекты в рамках скрипта запроса.

## <a name="using-read-scale-out-with-geo-replicated-databases"></a>Использование горизонтального масштабирования для чтения с географически реплицируемыми базами данных

Геореплицированные базы данных-получатели имеют ту же архитектуру высокого уровня доступности, что и базы данных-источники. Если вы подключаетесь к геореплицированной базе данных-получателю с включенным горизонтальным масштабированием для чтения, ваши сеансы `ApplicationIntent=ReadOnly` будут направляться в одну из реплик высокой доступности так же, как они направляются в основную базу данных, доступную для записи. Сеансы без `ApplicationIntent=ReadOnly` будут направляться в первичную реплику геореплицированной базы данных-получателя (тоже только для чтения). 

Таким образом, создание геореплики предоставляет две дополнительные реплики только для чтения для базы данных-источника, доступную для чтения и записи, всего три реплики только для чтения. Каждая дополнительная геореплика предоставляет еще одну пару реплик только для чтения. Геореплики можно создавать в любом регионе Azure, включая регион базы данных-источника.

> [!NOTE]
> Между репликами геореплицированной базы данных-получателя отсутствует автоматический циклический перебор или любая другая маршрутизация с балансировкой нагрузки.

## <a name="next-steps"></a>Дальнейшие действия

- Дополнительные сведения о предложении для масштабирования базы данных SQL см. в разделе [уровень служб в масштабе](service-tier-hyperscale.md).