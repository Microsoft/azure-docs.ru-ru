---
title: Включение автоматической настройки
description: Вы можете легко включить автоматическую настройку базы данных с помощью портал Azure.
services: sql-database
ms.service: sql-db-mi
ms.subservice: performance
ms.custom: sqldbrb=1
ms.devlang: ''
ms.topic: how-to
author: danimir
ms.author: danil
ms.reviewer: wiassaf, sstein
ms.date: 03/03/2021
ms.openlocfilehash: d60810c291984e0f57df1968f69678de8179273c
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "102042527"
---
# <a name="enable-automatic-tuning-in-the-azure-portal-to-monitor-queries-and-improve-workload-performance"></a>Включение автоматической настройки в портал Azure для отслеживания запросов и повышения производительности рабочей нагрузки
[!INCLUDE[appliesto-sqldb-sqlmi](../includes/appliesto-sqldb-sqlmi.md)]

База данных SQL Azure автоматически управляет службами данных, которые постоянно отслеживают запросы, и определяет действие, которое можно выполнить для повышения производительности рабочей нагрузки. Вы можете просматривать рекомендации и вручную применять их, или позволить базе данных SQL Azure автоматически применять действия по исправлению, что известно как **режим автоматической настройки**.

Автоматическая настройка может быть включена на уровне сервера или базы данных с помощью:

- [портал Azure](automatic-tuning-enable.md#azure-portal).
- [REST API](automatic-tuning-enable.md#rest-api) вызовы
- Команды [T-SQL](/sql/t-sql/statements/alter-database-transact-sql-set-options?view=azuresqldb-current&preserve-view=true)

> [!NOTE]
> Для Управляемый экземпляр SQL Azure поддерживаемый параметр FORCE_LAST_GOOD_PLAN можно настроить только с помощью [T-SQL](https://azure.microsoft.com/blog/automatic-tuning-introduces-automatic-plan-correction-and-t-sql-management) . Параметры настройки на основе портал Azure и автоматическая настройка индекса, описанные в этой статье, не применяются к Управляемый экземпляр SQL Azure.

> [!NOTE]
> Настройка параметров автоматической настройки через шаблон ARM (Azure Resource Manager) в настоящее время не поддерживается.

## <a name="enable-automatic-tuning-on-server"></a>Включение автоматической настройки на сервере

На уровне сервера можно выбрать или отключить наследование автоматической настройки конфигурации из значений Azure по умолчанию. Параметры Azure по умолчанию FORCE_LAST_GOOD_PLAN включены, CREATE_INDEX отключены и DROP_INDEX отключена.

> [!IMPORTANT]
> По состоянию на март 2020 новые значения Azure по умолчанию для автоматической настройки:
>
> - FORCE_LAST_GOOD_PLAN = Enabled, CREATE_INDEX = Disabled и DROP_INDEX = Disabled.
> - Существующие серверы без настроенных параметров автоматической настройки автоматически настраиваются для НАСЛЕДОВАНия значений по умолчанию в Azure. Это относится ко всем клиентам, которые в настоящее время имеют параметры сервера для автоматической настройки в неопределенном состоянии.
> - Новые созданные серверы будут автоматически настроены для НАСЛЕДОВАНия значений Azure по умолчанию (в отличие от предыдущих, когда автоматическая настройка конфигурации находилась в неопределенном состоянии после создания нового сервера).

### <a name="azure-portal"></a>Портал Azure

Чтобы включить автоматическую настройку на [сервере](logical-servers.md) в базе данных SQL Azure, перейдите к серверу в портал Azure а затем в меню выберите пункт **Автоматическая настройка** .

![На снимке экрана показана автоматическая настройка в портал Azure, где можно применить параметры для сервера.](./media/automatic-tuning-enable/server.png)

> [!NOTE]
> Обратите внимание, что параметр **DROP_INDEX** в настоящее время не совместим с приложениями, использующими переключение секций и указаниями индекса, и в таких случаях включать не следует. Удаление неиспользуемых индексов не поддерживается для уровней обслуживания "Премиум" и "критически важный для бизнеса".

Выберите параметры автоматической настройки, которые необходимо включить, и нажмите кнопку **Применить**.

Параметры автоматической настройки на сервере применяются ко всем базам данных на сервере. По умолчанию все базы данных наследуют конфигурацию из родительского сервера, но ее можно переопределить, а также указать отдельно для каждой базы данных.

### <a name="rest-api"></a>REST API

Дополнительные сведения об использовании REST API для включения автоматической настройки на **сервере** см. в разделе [Серверная автоматическая настройка обновления и получение методов HTTP](/rest/api/sql/serverautomatictuning).

## <a name="enable-automatic-tuning-on-an-individual-database"></a>Включение автоматической настройки для отдельной базы данных

База данных SQL Azure позволяет отдельно указать конфигурацию автоматической настройки для каждой базы данных. На уровне базы данных можно включить наследование автоматической настройки конфигурации из родительского сервера, значений Azure по умолчанию либо отключить наследование конфигурации. Параметры Azure по умолчанию FORCE_LAST_GOOD_PLAN включены, CREATE_INDEX отключены и DROP_INDEX отключена.

> [!TIP]
> Общая рекомендация заключается в том, чтобы управлять конфигурацией автоматической настройки на **уровне сервера** , чтобы можно было автоматически применять одни и те же параметры конфигурации к каждой базе данных. Настройте автоматические параметры для отдельной базы данных, если вам нужно, чтобы ее параметры отличались от параметров других баз на одном сервере.

### <a name="azure-portal"></a>Портал Azure

Чтобы включить автоматическую настройку для **отдельной базы данных**, перейдите к базе данных в портал Azure и выберите **Автоматическая настройка**.

Отдельные параметры автоматической настройки можно настроить отдельно для каждой базы данных. Можно вручную настроить отдельные параметры автоматической настройки или указать, что параметр наследует параметры с сервера.

![На снимке экрана показана автоматическая настройка в портал Azure, где можно применить параметры для отдельной базы данных.](./media/automatic-tuning-enable/database.png)

Обратите внимание, что параметр DROP_INDEX сейчас не поддерживается в приложениях, использующих переключения секций и подсказки индекса. В этих случаях его следует отключить.

После выбора соответствующей конфигурации щелкните **Применить**.

### <a name="rest-api"></a>Rest API

Дополнительные сведения об использовании REST API для включения автоматической настройки в отдельной базе данных см. в [статье обновление автоматической настройки базы данных SQL Azure и получение методов HTTP](/rest/api/sql/databaseautomatictuning).

### <a name="t-sql"></a>T-SQL

Чтобы включить автоматическую настройку в одной базе данных через T-SQL, подключитесь к базе данных и выполните следующий запрос.

```SQL
ALTER DATABASE current SET AUTOMATIC_TUNING = AUTO | INHERIT | CUSTOM
```

Если установить для автоматической настройки значение AUTO, будут применяться значения Azure по умолчанию. Если установить значение INHERIT, автоматическая настройка конфигурации будет унаследована от родительского сервера. Если установить значение CUSTOM, автоматическую настройку необходимо будет настраивать вручную.

Для настройки отдельных параметров автоматической настройки через T-SQL подключитесь к базе данных и выполните запрос, подобный следующему.

```SQL
ALTER DATABASE current SET AUTOMATIC_TUNING (FORCE_LAST_GOOD_PLAN = ON, CREATE_INDEX = ON, DROP_INDEX = OFF)
```

Установка параметра индивидуальной настройки в значение ON приведет к переопределению всех параметров, наследуемых базой данных, и включению параметра настройки. Если задать значение OFF, будут также переопределяться все параметры, унаследованные базой данных, и отключен параметр настройки. Параметр автоматической настройки, для которого задано значение по умолчанию, будет наследовать конфигурацию автоматической настройки из параметров уровня сервера.  

> [!IMPORTANT]
> В случае [активной георепликации](auto-failover-group-overview.md)необходимо настроить автоматическую настройку только для базы данных-источника. Автоматически примененные действия настройки, например, например, для создания или удаления индекса, будут автоматически реплицированы на вторичный сервер только для чтения. При попытке включения автоматической настройки с помощью T-SQL для дополнения только для чтения произойдет сбой, поскольку для него не поддерживаются различные конфигурации настроек.
>

Дополнительные сведения о параметрах T-SQL о для настройки автоматической настройки см. в разделе [Параметры ALTER DATABASE SET (Transact-SQL)](/sql/t-sql/statements/alter-database-transact-sql-set-options?view=azuresqldb-current&preserve-view=true).

## <a name="troubleshooting"></a>Устранение неполадок

### <a name="automated-recommendation-management-is-disabled"></a>Автоматическое управление рекомендациями отключено

В случае сообщений об ошибках, когда автоматизированное управление рекомендациями было отключено или просто отключено системой, наиболее распространенными причинами являются:
- Хранилище запросов не включено или
- Хранилище запросов находится в режиме только для чтения для указанной базы данных или
- Хранилище запросов остановлено, так как оно использовало выделенное дисковое пространство.

Чтобы исправить эту ошибку, можно рассмотреть следующие шаги.
- Очистите хранилище запросов или измените срок хранения данных на Auto с помощью T-SQL. См. раздел [Настройка рекомендуемой политики хранения и отслеживания для хранилища запросов](/azure/azure-sql/database/query-performance-insight-use#recommended-retention-and-capture-policy).
- Используйте SQL Server Management Studio (SSMS) и выполните следующие действия.
  - Подключение к базе данных SQL Azure
  - Щелкните правой кнопкой мыши базу данных
  - Перейдите в меню "Свойства" и щелкните "хранилище запросов".
  - Измените режим работы на Read-Write
  - Изменение режима записи в хранилище на "Авто"
  - Изменение режима очистки на основе размера на "Авто"

### <a name="permissions"></a>Разрешения

Так как автоматическая настройка является функцией Azure, для ее использования потребуется использовать встроенные роли Azure. Использование только проверки подлинности SQL не будет достаточным для использования функции из портал Azure.

Чтобы использовать автоматическую настройку, минимально необходимым разрешением для предоставления пользователю является встроенная роль [участника базы данных SQL](../../role-based-access-control/built-in-roles.md#sql-db-contributor) Azure. Вы также можете использовать более высокие роли привилегий, такие как участник SQL Server, участник Управляемый экземпляр SQL, участник и владелец.

## <a name="configure-automatic-tuning-e-mail-notifications"></a>Настройка уведомлений по электронной почте об автоматической настройке

Чтобы получать автоматические уведомления по электронной почте о рекомендациях, выполняемых автоматической настройкой, ознакомьтесь с руководством по [автоматической настройке уведомлений по электронной почте](automatic-tuning-email-notifications-configure.md) .

## <a name="next-steps"></a>Дальнейшие действия

- Дополнительные сведения об автоматической настройке и о том, как она повышает производительность, см. в [этой статье](automatic-tuning-overview.md).
- Общие сведения о рекомендациях по производительности базы данных SQL Azure см. в статье [Помощник по работе с базами данных SQL](database-advisor-implement-performance-recommendations.md).
- См. статью [Анализ производительности запросов базы данных Azure SQL](query-performance-insight-use.md), чтобы узнать о том, как просмотреть влияние на производительность основных запросов.
