---
title: Best practices for SQL Data Sync (Preview) (Рекомендации по синхронизации данных SQL (предварительная версия))
description: Рекомендации по настройке и выполнению синхронизации данных SQL Azure.
services: sql-database
ms.service: sql-database
ms.subservice: data-movement
ms.custom: sqldbrb=1
ms.devlang: ''
ms.topic: conceptual
author: stevestein
ms.author: sstein
ms.reviewer: ''
ms.date: 12/20/2018
ms.openlocfilehash: ee15bfaa1d69e2e5047e7d24986f8e4e7d5b8b31
ms.sourcegitcommit: 24a12d4692c4a4c97f6e31a5fbda971695c4cd68
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/05/2021
ms.locfileid: "102180247"
---
# <a name="best-practices-for-azure-sql-data-sync"></a>Best practices for SQL Data Sync (Preview) (Рекомендации по синхронизации данных SQL (предварительная версия)) 

[!INCLUDE[appliesto-sqldb](../includes/appliesto-sqldb.md)]

В этой статье описываются рекомендации по синхронизации данных SQL Azure.

Общие сведения о синхронизации данных SQL см. в статье [Синхронизация данных в нескольких облачных и локальных базах данных с помощью синхронизации данных SQL Azure](sql-data-sync-data-sql-server-sql-database.md).

> [!IMPORTANT]
> Azure синхронизация данных SQL в настоящее время **не** поддерживает azure SQL управляемый экземпляр.

## <a name="security-and-reliability"></a><a name="security-and-reliability"></a> Безопасность и надежность

### <a name="client-agent"></a>Агент клиента

-   Установите агент клиента, используя учетную запись пользователя с наименьшим уровнем привилегий и доступом к службе сети.  
-   Установите агент клиента на компьютере, который не является компьютером SQL Server.  
-   Не регистрируйте локальную базу данных в нескольких агентах.    
    -   Избегайте этого, даже если вы синхронизируете разные таблицы из разных групп синхронизации.  
    -   Регистрация локальной базы данных в нескольких агентах клиента создает проблемы при удалении вами одной из групп синхронизации.

### <a name="database-accounts-with-least-required-privileges"></a>Учетные записи базы данных с наименьшими требуемыми привилегиями

-   **Для настройки синхронизации.** Создание/изменение таблицы; изменение базы данных; создание процедуры; выбор/изменение схемы; создание пользовательских типов.

-   **Для текущей синхронизации**. Выберите/вставить/обновить/удалить для таблиц, которые выбраны для синхронизации, а затем для метаданных синхронизации и таблиц отслеживания. Разрешение EXECUTE на хранимые процедуры, созданные службой; Разрешение EXECUTE на определяемые пользователем табличные типы.

-   **Для отзыва.** Изменение части синхронизации таблиц; выбор/удаление в таблицах синхронизации метаданных; управление таблицами отслеживания синхронизации, хранимых процедур и пользовательских типов.

База данных SQL Azure поддерживает только один набор учетных данных. Для выполнения этих задач в пределах этого ограничения рассмотрите следующие варианты:

-   Изменяйте учетные данные для разных этапов (например, *учетные данные1* для настройки и *учетные данные2* для непрерывной синхронизации).  
-   Изменяйте разрешения для учетных данных (то есть изменяйте разрешение после настройки синхронизации).

### <a name="auditing"></a>Аудит

Рекомендуется включить аудит на уровне баз данных в группах синхронизации. 

## <a name="setup"></a>Настройка

### <a name="database-considerations-and-constraints"></a><a name="database-considerations-and-constraints"></a> Рекомендации по базам данных и ограничения

#### <a name="database-size"></a>Размер базы данных

При создании новой базы данных задайте максимальный размер так, чтобы он всегда был больше, чем у развертываемой базы данных. Если этого не сделать, синхронизация завершится ошибкой. Несмотря на то, что синхронизация данных SQL не предлагает автоматическое увеличение размера, вы можете выполнить команду `ALTER DATABASE`, чтобы увеличить размер базы данных после ее создания. Убедитесь, что вы следите за пределами размера базы данных.

> [!IMPORTANT]
> Синхронизация данных SQL хранит дополнительные метаданные в каждой базе данных. Обязательно учтите эти метаданные при определении необходимого пространства. Количество добавленных данных зависит от ширины таблиц (например, для узких таблиц требуются дополнительные накладные расходы) и объема трафика.

### <a name="table-considerations-and-constraints"></a><a name="table-considerations-and-constraints"></a> Рекомендации по таблицам и ограничения

#### <a name="selecting-tables"></a>Выбор таблиц

Не обязательно включать в группу синхронизации все таблицы, которые находятся в базе данных. Таблицы, которые включены в группу синхронизации, влияют на эффективность и стоимость. Включайте таблицы и таблицы, зависящие от них, в группу синхронизации только в соответствии с требованиями бизнеса.

#### <a name="primary-keys"></a>Первичные ключи

Каждая таблица в группе синхронизации должна иметь первичный ключ. Синхронизация данных SQL не может синхронизировать таблицу, у которой нет первичного ключа.

Перед использованием синхронизации данных SQL в рабочей среде проверьте эффективность начальной и непрерывной синхронизации.

#### <a name="empty-tables-provide-the-best-performance"></a>Пустые таблицы обеспечивают лучшую производительность

Пустые таблицы обеспечивают лучшую производительность во время инициализации. Если целевая таблица пуста, служба синхронизации данных использует инструкцию bulk insert для загрузки данных. В противном случае служба синхронизации данных выполняет сравнение по строкам и вставку для проверки конфликтов. Тем не менее, если производительность не является ключевым фактором, можно выполнить настройку синхронизации между таблицами, которые уже содержат данные.

### <a name="provisioning-destination-databases"></a><a name="provisioning-destination-databases"></a> Подготовка баз данных назначения

Синхронизация данных SQL предоставляет базовую автоматическую подготовку баз данных.

В этом разделе рассматриваются ограничения при подготовке синхронизации данных SQL.

#### <a name="autoprovisioning-limitations"></a>Ограничения автоматической подготовки баз данных

Для автоматической подготовки синхронизации данных SQL применяются следующие ограничения.

-   Выбирайте только столбцы, создаваемые в таблице назначения. Столбцы, которые не входят в группу синхронизации, не подготавливаются в таблицах назначения.
-   Индексы создаются только для выбранных столбцов. Если индекс исходной таблицы содержит столбцы, которые не входят в группу синхронизации, такой индекс не подготавливается в таблицах назначения.  
-   Индексы столбцов типа XML не подготавливаются.  
-   Проверочные ограничения не подготавливаются.  
-   Имеющиеся триггеры в исходных таблицах не подготавливаются.  
-   Представления и хранимые процедуры не создаются в базе данных назначения.
-   Действия ON UPDATE CASCADE и ON DELETE CASCADE в отношении ограничений внешнего ключа не создаются повторно в целевых таблицах.
-   Если у вас есть столбцы типа Decimal или numeric с точностью больше 28, синхронизация данных SQL может столкнуться с проблемой переполнения преобразования во время синхронизации. Рекомендуется ограничить точность десятичных или числовых столбцов до 28 или меньше.

#### <a name="recommendations"></a>Рекомендации

-   Используйте функцию автоматической подготовки синхронизации данных SQL только при тестировании службы.  
-   Для рабочей среды подготовьте схему базы данных.

### <a name="where-to-locate-the-hub-database"></a><a name="locate-hub"></a> Где найти центральную базу данных

#### <a name="enterprise-to-cloud-scenario"></a>Сценарий перемещения из предприятия в облако

Чтобы свести к минимуму задержки, храните центральную базу данных в регионе максимальной концентрации трафика базы данных в группе синхронизации.

#### <a name="cloud-to-cloud-scenario"></a>Сценарий перемещения из облака в облако

-   Когда все базы данных в группе синхронизации находятся в одном центре обработки данных, центральная база данных должна находиться в том же центре обработки данных. Эта конфигурация уменьшает время задержки и стоимость передачи данных между центрами обработки данных.
-   Когда базы данных в группе синхронизации находятся в нескольких центрах обработки данных, центральная база данных должна находиться в том же центре обработки данных, где и большинство баз данных и их трафик.

#### <a name="mixed-scenarios"></a>Смешанные сценарии

Примените предыдущие рекомендации к более сложным конфигурациям групп синхронизации, например со смешанными сценариями перемещения из предприятия в облако и из облака в облако.

## <a name="sync"></a>Синхронизация

### <a name="avoid-slow-and-costly-initial-sync"></a><a name="avoid-a-slow-and-costly-initial-synchronization"></a> Избегайте медленной и дорогостоящей начальной синхронизации

В этом разделе мы рассмотрим начальную синхронизацию группы синхронизации. Узнайте, как можно ускорить начальную синхронизацию и сэкономить затраты на нее.

#### <a name="how-initial-sync-works"></a>Как работает начальная синхронизация

Когда вы создаете группу синхронизации, начните с данных в одной базе данных. Если у вас есть данные в нескольких базах данных, синхронизация данных SQL обрабатывает каждую строку как конфликт, требующий разрешения. Это разрешение конфликтов приводит к замедлению начальной синхронизации. При наличии данных в нескольких базах данных начальная синхронизации может выполняться от нескольких дней до нескольких месяцев в зависимости от размера базы данных.

Если базы данных находятся в разных центрах обработки данных, то каждая строка должна пройти между всеми центрами обработки данных. Это увеличивает затраты на начальную синхронизацию.

#### <a name="recommendation"></a>Рекомендация

По возможности начинайте с данных только в одной базе данных группы синхронизации.

### <a name="design-to-avoid-sync-loops"></a><a name="design-to-avoid-synchronization-loops"></a>При проектировании избегайте петель синхронизации

Петля синхронизации возникает при наличии циклических ссылок в группе синхронизации. В этом случае каждое изменение в одной базе данных приводит к бесконечной циклической репликации по базам данных в группе синхронизации.   

Не допускайте возникновения петель синхронизации, так как они приводят к замедлению и могут значительно увеличить расходы.

### <a name="changes-that-fail-to-propagate"></a><a name="handling-changes-that-fail-to-propagate"></a> Изменения, которые не удается распространить

#### <a name="reasons-that-changes-fail-to-propagate"></a>Причины, по которым не удается распространить изменения

Изменения могут не распространиться по одной из следующих причин:

-   Несовместимость схемы или типа данных.
-   Вставка нулевого значения в столбцах, не допускающих нуля.
-   Нарушение ограничений внешнего ключа.

#### <a name="what-happens-when-changes-fail-to-propagate"></a>Что происходит, когда изменения не распространяются?

-   Группа синхронизации показывает, что находится в состоянии **предупреждения**.
-   Подробности содержатся в средстве просмотра журнала в пользовательском интерфейсе портала.
-   Если проблема не будет устранена в течение 45 дней, база данных станет устаревшей.

> [!NOTE]
> Эти изменения никогда не распространяются. Единственным способом восстановления в этом сценарии является повторное создание группы синхронизации.

#### <a name="recommendation"></a>Рекомендация

Регулярно отслеживайте состояние группы синхронизации и базы данных через интерфейс портала и журнала.


## <a name="maintenance"></a>Обслуживание

### <a name="avoid-out-of-date-databases-and-sync-groups"></a><a name="avoid-out-of-date-databases-and-sync-groups"></a> Избегайте устаревших баз данных и групп синхронизации

Группа синхронизации или база данных в группе синхронизации могут устареть. Если группа синхронизации **устаревает**, она перестает работать. Если база данных **устаревает**, данные могут быть утеряны. Лучше избежать этого сценария, а не восстанавливать данные после него.

#### <a name="avoid-out-of-date-databases"></a>Избегайте появления устаревших баз данных

База данных получает состояние **устаревшей**, если она находилась в автономном режиме более 45 дней. Чтобы избежать **устаревания** баз данных, следите за тем, чтобы ни одна из них не отключалась на срок более 45 дней.

#### <a name="avoid-out-of-date-sync-groups"></a>Избегайте появления устаревших групп синхронизации

Группа синхронизации считается **устаревшей**, если любые изменения в этой группе не распространялись на остальную часть группы синхронизации более 45 дней. Чтобы группы синхронизации не **устаревали**, регулярно проверяйте журнал групп синхронизации. Убедитесь, что все конфликты решены и изменения успешно распространяются в базах данных групп синхронизации.

Группа синхронизации может не применять изменения по одной из следующих причин:

-   Несовместимость схемы между таблицами.
-   Несовместимость данных между таблицами.
-   Вставка строки с нулевым значением в столбце, который не допускает нулевые значения.
-   Обновление строки со значением, которое нарушает ограничение внешнего ключа.

Чтобы предотвратить устаревание групп синхронизации, сделайте следующее:

-   Обновите схему, разрешив значения, содержащиеся в строках с ошибками.
-   Обновите значения внешнего ключа, чтобы включить значения, содержащиеся в строках с ошибками.
-   Обновите значения данных в строке с ошибкой, чтобы они были совместимы со схемой или внешними ключами в целевой базе данных.

### <a name="avoid-deprovisioning-issues"></a><a name="avoid-deprovisioning-issues"></a> Избегайте проблем с отменой подготовки

При определенных обстоятельствах отмена регистрации базы данных в агенте клиента может привести к сбою синхронизации.

#### <a name="scenario"></a>Сценарий

1. Группа синхронизации A была создана с помощью экземпляра базы данных SQL и базы данных SQL Server, которая связана с локальным агентом 1.
2. Та же самая локальная база данных регистрируется в локальном агенте 2 (этот агент не связан с какой-либо группой синхронизации).
3. При отмене регистрации локальной базы данных в локальном агенте 2 удаляются таблицы отслеживания и метаданных из группы синхронизации A для локальной базы данных.
4. Операции группы синхронизации A завершаются такой ошибкой: The current operation could not be completed because the database is not provisioned for sync or you do not have permissions to the sync configuration tables (Текущая операция не может быть завершена, потому что база данных не подготовлена для синхронизации или у вас нет разрешений для таблиц конфигурации синхронизации).

#### <a name="solution"></a>Решение

Чтобы избежать этого сценария, не регистрируйте базу данных в нескольких агентах.

Чтобы исправить ошибку, сделайте следующее:

1. Удалите базу данных из каждой группы синхронизации, к которой она принадлежит.  
2. Добавьте базу данных обратно в каждую группу синхронизации, из которой вы удалили ее.  
3. Разверните каждую затронутую группу синхронизации (при этом действии подготавливается база данных).  

### <a name="modifying-a-sync-group"></a><a name="modifying-your-sync-group"></a> Изменение группы синхронизации

Не пытайтесь удалить базу данных из группы синхронизации, а затем отредактировать группу без предварительного развертывания одного из этих изменений.

Вот как следует поступить вместо этого: сначала удалите базу данных из группы синхронизации. Затем разверните изменение и дождитесь отмены подготовки. После отмены подготовки вы можете отредактировать группу синхронизации и развернуть изменения.

Если вы попытаетесь удалить базу данных, а затем отредактировать группу синхронизации без предварительного развертывания одного из этих изменений, одна из операций завершится сбоем, а интерфейс портала станет несогласованным. В этом случае обновите страницу, чтобы восстановить правильное состояние.

### <a name="avoid-schema-refresh-timeout"></a>Избегайте времени ожидания обновления схемы

При наличии сложной схемы для синхронизации может возникнуть ошибка "время ожидания операции" во время обновления схемы, если база данных метаданных синхронизации имеет более низкий номер SKU (например, "базовый"). 

#### <a name="solution"></a>Решение

Чтобы устранить эту ошибку, увеличьте масштаб базы данных метаданных синхронизации, допуская более высокий номер SKU, например S3. 

## <a name="next-steps"></a>Дальнейшие действия
Дополнительные сведения о синхронизации данных SQL см. в следующих материалах:

-   Обзор: [Синхронизация данных в нескольких облачных и локальных базах данных с помощью функции синхронизации данных SQL Azure](sql-data-sync-data-sql-server-sql-database.md).
-   Настройка синхронизации данных SQL
    - На портале — [учебник. настройка синхронизация данных SQL для синхронизации данных между базой данных SQL Azure и SQL Server](sql-data-sync-sql-server-configure.md)
    - С помощью PowerShell
        -  [Синхронизация нескольких баз данных в базе данных SQL Azure с помощью PowerShell](scripts/sql-data-sync-sync-data-between-sql-databases.md)
        -  [Использование PowerShell для синхронизации между базой данных в базе данных SQL и базой данных в экземпляре SQL Server](scripts/sql-data-sync-sync-data-between-azure-onprem.md)
-   Агент синхронизации данных: [Агент синхронизации данных для синхронизации данных SQL Azure](sql-data-sync-agent-overview.md).
-   Мониторинг: [Мониторинг синхронизации данных SQL с помощью журналов Azure Monitor](./monitor-tune-overview.md)
-   Устранение неполадок: [Устранение неполадок с синхронизацией данных SQL](sql-data-sync-troubleshoot.md).
-   Обновление схемы синхронизации
    -   С помощью Transact-SQL: [Автоматическая репликация изменений схемы при синхронизации данных SQL Azure](sql-data-sync-update-sync-schema.md).
    -   С помощью PowerShell: [Использование PowerShell для обновления схемы синхронизации в существующей группе синхронизации](scripts/update-sync-schema-in-sync-group.md).

Дополнительные сведения о Базе данных SQL см. в разделах:

-   [Функции службы базы данных SQL Azure](sql-database-paas-overview.md)
-   [Управление жизненным циклом базы данных](/previous-versions/sql/sql-server-guides/jj907294(v=sql.110))
