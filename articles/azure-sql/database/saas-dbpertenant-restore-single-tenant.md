---
title: Восстановление базы данных в мультитенантном приложении SaaS
description: Узнайте, как восстановить Базу данных SQL Azure отдельного клиента после случайного удаления данных
services: sql-database
ms.service: sql-database
ms.subservice: scenario
ms.custom: seo-lt-2019, sqldbrb=1
ms.devlang: ''
ms.topic: tutorial
author: stevestein
ms.author: sstein
ms.reviewer: ''
ms.date: 12/04/2018
ms.openlocfilehash: 88496a39b0186cefb7c64e227530b5d73e693094
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "92780484"
---
# <a name="restore-a-single-tenant-with-a-database-per-tenant-saas-application"></a>Восстановление отдельного клиента приложения SaaS, использующего одну базу данных на клиент
[!INCLUDE[appliesto-sqldb](../includes/appliesto-sqldb.md)]

Модель с одной базой данных на клиент упрощает восстановление отдельного клиента до предыдущей точки во времени, не влияя на работу других клиентов.

В рамках этого руководства вы изучите два шаблона восстановления данных:

> [!div class="checklist"]
> * восстановление базы данных в параллельную базу данных (параллельное восстановление);
> * восстановление базы данных "на месте" с заменой существующей базы данных.

| Шаблон | Описание |
|:--|:--|
| Восстановление в параллельную базу данных | Этот шаблон можно использовать для таких задач, как проверка, аудит и обеспечение соответствия, чтобы клиент мог проверять свои данные по состоянию на более ранний момент времени. Текущая база данных клиента остается в сети и не изменяется. |
| Восстановление на месте | Обычно этот шаблон используется для восстановления клиента до предыдущей точки во времени после случайного удаления или повреждения данных. Исходная база данных переводится в автономный режим и заменяется восстановленной базой данных. |
|||

Для работы с этим руководством выполните следующие предварительные требования:

* Разверните приложение SaaS Wingtip. Это можно сделать менее чем за пять минут, следуя инструкциям из статьи [Развертывание и изучение мультитенантного приложения SaaS на основе базы данных SQL Azure, в котором используется отдельная база данных для каждого клиента](./saas-dbpertenant-get-started-deploy.md).
* Установите Azure PowerShell. Дополнительные сведения см. в статье [Начало работы с Azure PowerShell](/powershell/azure/get-started-azureps).

## <a name="introduction-to-the-saas-tenant-restore-patterns"></a>Общие сведения о шаблонах восстановления клиента SaaS

Данные отдельного клиента можно восстановить с использованием двух простых шаблонов. Так как базы данных клиента изолированы, восстановление одного клиента не влияет на данные других клиентов. В обоих шаблонах используется функция восстановления до точки во времени (PITR) базы данных SQL Azure. Служба PITR всегда создает новую базу данных.

* **Параллельное восстановление**. В первом шаблоне новая база данных создается параллельно с текущей базой данных клиента. Затем клиенту предоставляется доступ только для чтения к восстановленной базе данных. Восстановленные данные можно просмотреть и потенциально использовать для перезаписи текущих значений данных. Разработчик приложения определяет, как клиент получает доступ к восстановленной базе данных и какие возможности восстановления предоставляются. В некоторых случаях достаточно просто позволить клиенту просмотреть свои данные по состоянию на более ранний момент времени.

* **Восстановление "на месте"**. Второй шаблон пригодится в тех случаях, когда данные потеряны или повреждены и клиент хочет восстановить состояние данных на предыдущий момент времени. На время восстановления базы данных клиент отключается от сети. Исходная база данных удаляется, а восстановленная база данных переименовывается соответствующим образом. Цепочка резервных копий остается доступной после удаления исходной базы данных, что позволяет при необходимости восстановить базу данных до более ранней точки во времени.

Если вы используете базу данных с [активной георепликацией](active-geo-replication-overview.md), мы рекомендуем выполнить параллельное восстановление и скопировать необходимые данные из восстановленной копии в исходную базу данных. После замены исходной базы данных восстановленной необходимо перенастроить и повторно синхронизировать георепликацию.

## <a name="get-the-wingtip-tickets-saas-database-per-tenant-application-scripts"></a>Получение сценариев для приложения SaaS Wingtip Tickets, использующего одну базу данных на клиент

Скрипты и исходный код приложения SaaS Wingtip Tickets c мультитенантной базой данных размещены в репозитории GitHub [WingtipTicketsSaaS-DbPerTenant](https://github.com/Microsoft/WingtipTicketsSaaS-DbPerTenant). Инструкции по скачиванию и разблокированию скриптов приложения SaaS Wingtip Tickets см. в статье [Общие рекомендации по работе с примерами приложений SaaS Wingtip Tickets](saas-tenancy-wingtip-app-guidance-tips.md).

## <a name="before-you-start"></a>Перед началом работы

После создания базы данных может пройти 10–15 минут, прежде чем станет возможным ее восстановление из первой полной резервной копии. Если вы только что установили приложение, подождите несколько минут, прежде чем применять этот сценарий.

## <a name="simulate-a-tenant-accidentally-deleting-data"></a>Моделирование случайного удаления данных клиента

Чтобы продемонстрировать эти сценарии восстановления, сначала "случайно" удалите событие в одной из баз данных клиента. 

### <a name="open-the-events-app-to-review-the-current-events"></a>Просмотр текущих событий в приложении "События"

1. Откройте концентратор событий (http://events.wtp.&lt;user&gt;.trafficmanager.net) и выберите **Contoso Concert Hall**.

   ![Концентратор событий](./media/saas-dbpertenant-restore-single-tenant/events-hub.png)

2. Прокрутите список событий и запишите последнее из них.

   ![Отображается последнее событие](./media/saas-dbpertenant-restore-single-tenant/last-event.png)

### <a name="accidentally-delete-the-last-event"></a>"Случайное" удаление последнего события

1. В интегрированной среде сценариев PowerShell последовательно откройте …\\Learning Modules\\Business Continuity and Disaster Recovery\\RestoreTenant\\*Demo-RestoreTenant.ps1* и задайте следующее значение:

   * **$DemoScenario** = **1**, *Delete last event (with no ticket sales)* .
2. Нажмите клавишу F5, чтобы запустить скрипт и удалить последнее событие. Вы увидите следующее сообщение с подтверждением.

   ```Console
   Deleting last unsold event from Contoso Concert Hall ...
   Deleted event 'Seriously Strauss' from Contoso Concert Hall venue.
   ```

3. После этого откроется страница событий Contoso. Прокрутите вниз и убедитесь, что событие исчезло. Если событие по-прежнему в списке, щелкните **Обновить** и проверьте его еще раз.
   ![Последнее событие удалено](./media/saas-dbpertenant-restore-single-tenant/last-event-deleted.png)

## <a name="restore-a-tenant-database-in-parallel-with-the-production-database"></a>Восстановление базы данных клиента и рабочей базы данных

Эти действия позволяют восстановить базу данных Contoso Concert Hall до точки во времени перед удалением события. В этом сценарии предполагается, что вы намерены просмотреть удаленные данные в параллельной базе данных.

 Сценарий *Restore-TenantInParallel.ps1* создает параллельную базу данных клиента *ContosoConcertHall\_old* и параллельную запись каталога. Этот шаблон лучше всего подходит для восстановления после незначительной потери данных. Кроме того, его можно использовать при восстановлении данных для аудита или обеспечения соответствия. Мы также рекомендуем его для баз данных с [активной георепликацией](active-geo-replication-overview.md).

1. Выполните действия из раздела [Моделирование случайного удаления данных клиента](#simulate-a-tenant-accidentally-deleting-data).
2. В интегрированной среде сценариев PowerShell откройте …\\Learning Modules\\Business Continuity and Disaster Recovery\\RestoreTenant\\_Demo-RestoreTenant.ps1_.
3. Задайте **$DemoScenario** = **2** и выполните *восстановление клиента в параллельном режиме*.
4. Нажмите клавишу F5 для запуска сценария.

Этот сценарий восстанавливает базу данных клиента до точки во времени перед удалением события. База данных восстанавливается в новую базу данных _ContosoConcertHall\_old_. Затем удаляются метаданные каталога, существующие в восстановленной базе данных, и база данных добавляется в каталог с помощью ключа, созданного на основе имени *ContosoConcertHall\_old*.

Демонстрационный сценарий открывает в браузере страницу событий для этой новой базы данных клиента. Обратите внимание на следующий фрагмент URL-адреса: ```http://events.wingtip-dpt.&lt;user&gt;.trafficmanager.net/contosoconcerthall_old```. Элемент *_old* в имени означает, что данные на странице получены из восстановленной базы данных.

Просмотрите список событий в браузере и убедитесь, что событие, удаленное в предыдущем разделе, восстановилось.

Предоставив доступ к восстановленному клиенту как к дополнительному клиенту с собственным приложением Events, вы не сможете получить доступ к восстановленным данным. Они служат только для демонстрации шаблона восстановления. Обычно предоставляется доступ только для чтения к старым данным, а восстановленная база данных сохраняется на определенный период. В этом примере после завершения запись восстановленного клиента можно удалить, вызвав сценарий _Remove restored tenant_ (Удаление восстановленного клиента).

1. Задайте **$DemoScenario** = **4**, *Remove restored tenant*.
2. Нажмите клавишу F5 для запуска сценария.
3. После этого запись *ContosoConcertHall\_old* удаляется из каталога. Закройте в браузере страницу событий для этого клиента.

## <a name="restore-a-tenant-in-place-replacing-the-existing-tenant-database"></a>Восстановление клиента "на месте" с заменой имеющейся базы данных

Эти действия позволяют восстановить клиент Contoso Concert Hall до точки во времени перед удалением события. Сценарий *Restore-TenantInPlace* восстанавливает базу данных клиента в новую базу данных и удаляет исходную. Этот шаблон лучше всего подходит для восстановления после серьезного повреждения данных, к которому, возможно, придется адаптировать клиент.

1. Откройте в интегрированной среде сценариев PowerShell файл **Demo-RestoreTenant.ps1**.
2. Задайте **$DemoScenario** = **5** и выполните *восстановление клиента "на месте"* .
3. Нажмите клавишу F5 для запуска сценария.

Этот сценарий восстанавливает базу данных клиента то точки во времени перед удалением события. Сначала он отключает клиент Contoso Concert Hall от сети, чтобы предотвратить дальнейшие обновления. Затем из точки восстановления создается параллельная база данных. В ее имя добавляется метка времени, чтобы не возникало конфликтов между именами восстановленной и существующей баз данных клиента. Затем старая база данных клиента удаляется, а восстановленной базе данных присваивается имя исходной. После этого работа клиента Contoso Concert Hall возобновляется и приложение получает доступ к восстановленной базе данных.

Вы успешно восстановили базу данных до точки во времени, предшествующей удалению события. Когда откроется страница **События**, проверьте наличие на ней последнего восстановленного события.

После восстановления базы данных нужно снова подождать 10–15 минут, прежде чем появится полная резервная копия, доступная для восстановления данных.

## <a name="next-steps"></a>Дальнейшие действия

В этом руководстве вы узнали, как выполнять следующие задачи:

> [!div class="checklist"]
> * восстановление базы данных в параллельную базу данных (параллельное восстановление);
> * восстановление базы данных "на месте".

Изучите руководство [Управление схемой в приложении SaaS с помощью шаблона с однотенантной базой данных с использованием базы данных SQL Azure](saas-tenancy-schema-management.md).

## <a name="additional-resources"></a>Дополнительные ресурсы

* [Руководства по SaaS Wingtip базы данных SQL](saas-dbpertenant-wingtip-app-overview.md#sql-database-wingtip-saas-tutorials)
* [Обзор обеспечения непрерывности бизнес-процессов с помощью Базы данных SQL Azure](business-continuity-high-availability-disaster-recover-hadr-overview.md)
* [Подробнее о резервном копировании базы данных SQL](automated-backups-overview.md)