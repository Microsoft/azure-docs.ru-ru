---
title: Прозрачное шифрование данных
titleSuffix: Azure SQL Database & SQL Managed Instance & Azure Synapse Analytics
description: Общие сведения о прозрачном шифровании данных для базы данных SQL Azure, Управляемый экземпляр Azure SQL и Azure синапсе Analytics. В этом документе описаны преимущества и параметры конфигурации прозрачного шифрования, включая управляемое службой прозрачное шифрование данных и создание собственных ключей.
services: sql-database
ms.service: sql-database
ms.subservice: security
ms.custom: seo-lt-2019 sqldbrb=3
ms.devlang: ''
ms.topic: conceptual
author: jaszymas
ms.author: jaszymas
ms.reviewer: vanto
ms.date: 10/12/2020
ms.openlocfilehash: 8fbbd7a2aabc9de417f1eefd2513edba3119bfc0
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "92791398"
---
# <a name="transparent-data-encryption-for-sql-database-sql-managed-instance-and-azure-synapse-analytics"></a>Прозрачное шифрование данных для базы данных SQL, SQL Управляемый экземпляр и Azure синапсе Analytics
[!INCLUDE[appliesto-sqldb-sqlmi-asa](../includes/appliesto-sqldb-sqlmi-asa.md)]

[Прозрачное шифрование данных (TDE)](/sql/relational-databases/security/encryption/transparent-data-encryption) помогает защитить базу данных SQL Azure, azure SQL управляемый экземпляр и Azure синапсе Analytics относительно угрозы вредоносной автономной деятельности путем шифрования неактивных данных. Выполняется шифрование и расшифровка базы данных, связанных резервных копий и неактивных файлов журналов транзакций в реальном времени без необходимости изменения приложения. По умолчанию TDE включен для всех вновь развернутых баз данных SQL и должен быть включен вручную для старых баз данных SQL Azure, Управляемый экземпляр Azure SQL. Для Azure синапсе Analytics необходимо вручную включить TDE.

Функция TDE выполняет шифрование и расшифровку ввода-вывода данных в реальном времени на уровне страницы. Каждая страница расшифровывается при считывании в память, а затем снова шифруется перед записью на диск. TDE шифрует хранилище всей базы данных с помощью симметричного ключа, который называется ключом шифрования базы данных (DEK). При запуске базы данных зашифрованный DEK расшифровывается, а затем используется для расшифровки и повторного шифрования файлов базы данных в SQL Server процессе ядра СУБД. DEK защищается предохранителем TDE. Предохранитель TDE — это либо управляемый службой сертификат (прозрачное шифрование данных, управляемое службой), либо асимметричный ключ, хранящийся в [Azure Key Vault](../../key-vault/general/secure-your-key-vault.md) (прозрачное шифрование данных, управляемое клиентом).

Для базы данных SQL Azure и Azure синапсе средство защиты TDE устанавливается на уровне [сервера](logical-servers.md) и наследуется всеми базами данных, связанными с этим сервером. Для Управляемого экземпляра SQL Azure предохранитель TDE настраивается на уровне экземпляра и наследуется всеми зашифрованными базами данных этого экземпляра. В этом документе термин *сервер* обозначает как сервер, так и экземпляр, если не указано иное.

> [!IMPORTANT]
> Все вновь созданные базы данных SQL шифруются по умолчанию с помощью прозрачного шифрования данных, управляемого службой. Существующие базы данных SQL, созданные до 2017 мая, а базы данных SQL, созданные с помощью инструкции RESTORE, Георепликация и копия базы данных, по умолчанию не шифруются. Существующие базы данных SQL Управляемый экземпляр, созданные до февраля 2019, по умолчанию не шифруются. Базы данных SQL Управляемый экземпляр, созданные с помощью инструкции RESTORE, наследуют состояние шифрования от источника.

> [!NOTE]
> TDE нельзя использовать для шифрования системных баз данных, таких как база данных **master** , в базе данных SQL Azure и azure SQL управляемый экземпляр. База данных **master** содержит объекты, которые необходимы для выполнения операций TDE для пользовательских баз данных. Не рекомендуется хранить конфиденциальные данные в системных базах данных. Теперь при [шифровании инфраструктуры](transparent-data-encryption-byok-overview.md#doubleencryption) выполняется шифрование системных баз данных, включая Master. 

## <a name="service-managed-transparent-data-encryption"></a>Управляемое службой прозрачное шифрование данных

В Azure значение по умолчанию для TDE заключается в том, что DEK защищен встроенным сертификатом сервера. Встроенный сертификат сервера уникален для каждого сервера, а используемый алгоритм шифрования — AES 256. Если база данных находится в связи георепликации, обе базы данных базы данных-источника и геореплики защищены родительским ключом сервера-источника. Если две базы данных подключены к одному и тому же серверу, то они также совместно используют один встроенный сертификат. Корпорация Майкрософт автоматически меняет эти сертификаты в соответствии с внутренней политикой безопасности, а корневой ключ защищается внутренним секретным хранилищем Майкрософт. Клиенты могут проверять соответствие базы данных SQL и Управляемый экземпляр SQL с внутренними политиками безопасности в независимых сторонних отчетах аудита, доступных в [центре управления безопасностью Майкрософт](https://servicetrust.microsoft.com/).

Корпорация Майкрософт гарантирует простое перемещение ключей и управление ими для георепликации и восстановления.

## <a name="customer-managed-transparent-data-encryption---bring-your-own-key"></a>Управляемое клиентом прозрачное шифрование данных. Создание собственных ключей

Управляемый клиентом TDE также называется поддержкой создание собственных ключей (BYOK) для TDE. В этом сценарии средство защиты TDE, которое шифрует DEK, является асимметричным ключом, управляемым клиентом, который хранится в принадлежащем заказчике и управляемом Azure Key Vaultе (облачной системе управления внешними ключами Azure) и никогда не покидает хранилище ключей. Средство защиты TDE может быть [создано хранилищем ключей или передано в хранилище ключей](../../key-vault/keys/hsm-protected-keys.md) из локального аппаратного модуля безопасности (HSM). Для расшифровки и шифрования DEK базы данных SQL, SQL Управляемый экземпляр и Azure синапсе должны быть предоставлены разрешения в хранилище ключей, принадлежащее заказчику. Если разрешения сервера для хранилища ключей отозваны, база данных будет недоступна и все данные будут зашифрованы.

Благодаря интеграции TDE с Azure Key Vault пользователи могут самостоятельно контролировать задачи управления ключами. В Azure Key Vault можно выполнять такие операции, как смена ключей, настройка разрешений для хранилища ключей, резервное копирование ключей, а также включать аудит и отчетность по всем предохранителям TDE. Key Vault обеспечивает централизованное управление ключами, использует тщательную отслеживаемую HSM и позволяет отделить обязанности между управлением ключами и данными, чтобы обеспечить соответствие политикам безопасности.
Дополнительные сведения о BYOK для базы данных SQL Azure и Azure синапсе см. в статье [прозрачное шифрование данных с помощью интеграции с Azure Key Vault](transparent-data-encryption-byok-overview.md).

Чтобы приступить к использованию TDE с интеграцией Azure Key Vault, см. инструкции по [включению прозрачного шифрования данных с помощью собственного ключа из Key Vault](transparent-data-encryption-byok-configure.md).

## <a name="move-a-transparent-data-encryption-protected-database"></a>Перемещение базы данных, защищенной прозрачным шифрованием данных

Для операций в пределах Azure базу данных не нужно расшифровывать. Параметры TDE базы данных-источника прозрачно наследуются целевым объектом. Это относится ко всем следующим операциям:

- Геовосстановление
- восстановление на определенный момент времени через интерфейс самообслуживания;
- восстановление удаленной базы данных;
- Активная георепликация
- создание копии базы данных.
- Восстановление файла резервной копии в Управляемом экземпляре Базы данных SQL Azure

> [!IMPORTANT]
> Создание вручную резервной копии базы данных, зашифрованной с помощью TDE, управляемой службой, не поддерживается в Управляемый экземпляр Azure SQL, так как сертификат, используемый для шифрования, недоступен. Используйте функцию восстановления до точки во времени, чтобы переместить базу данных этого типа в другой Управляемый экземпляр SQL, или переключитесь на ключ, управляемый клиентом.

При экспорте защищенной с помощью TDE базы данных экспортированное содержимое базы данных не шифруется. Экспортированное содержимое хранится в незашифрованных BACPAC-файлах. Обязательно Защитите BACPAC-файлы соответствующим образом и включите TDE после завершения импорта новой базы данных.

Например, если BACPAC-файл экспортируется из SQL Server экземпляра, импортированное содержимое новой базы данных не шифруется автоматически. Аналогично, если BACPAC-файл импортируется в SQL Server экземпляр, Новая база данных также не шифруется автоматически.

Единственное исключение — при экспорте базы данных в базу данных SQL и из нее. TDE включен в новой базе данных, но сам файл BACPAC по-прежнему не шифруется.

## <a name="manage-transparent-data-encryption"></a>Управление прозрачным шифрованием данных

# <a name="the-azure-portal"></a>[Портал Azure](#tab/azure-portal)

Управление TDE в портал Azure.

Чтобы настроить TDE с помощью портал Azure, необходимо подключиться как владелец, участник или диспетчер безопасности SQL Azure.

Включение и отключение TDE на уровне базы данных. В Azure SQL Управляемый экземпляр использовать Transact-SQL (T-SQL) для включения и отключения TDE в базе данных. Для базы данных SQL Azure и Azure синапсе можно управлять TDE для базы данных в [портал Azure](https://portal.azure.com) после входа с помощью учетной записи администратора или участника Azure. Найдите параметры TDE для своей пользовательской базы данных. По умолчанию используется управляемое службой прозрачное шифрование данных. Для сервера, содержащего базу данных, автоматически создается сертификат TDE.

![Управляемое службой прозрачное шифрование данных](./media/transparent-data-encryption-tde-overview/service-managed-transparent-data-encryption.png)  

Вы устанавливаете главный ключ TDE, известный как предохранитель TDE, на уровне сервера или экземпляра. Чтобы использовать TDE с поддержкой BYOK и защитить базы данных с помощью ключа из Key Vault, откройте параметры TDE на своем сервере.

![Прозрачное шифрование данных с поддержкой создания собственных ключей](./media/transparent-data-encryption-tde-overview/tde-byok-support.png)

# <a name="powershell"></a>[PowerShell](#tab/azure-powershell)

Управление TDE с помощью PowerShell.

[!INCLUDE [updated-for-az](../../../includes/updated-for-az.md)]
> [!IMPORTANT]
> Модуль PowerShell Azure Resource Manager по-прежнему поддерживается, но вся будущая разработка предназначена для модуля AZ. SQL. Сведения об этих командлетах см. в разделе [AzureRM.Sql](/powershell/module/AzureRM.Sql/). Аргументы команд в модулях Az и AzureRm практически идентичны.

Для настройки TDE с помощью PowerShell нужно подключиться в качестве владельца Azure, участника или диспетчера безопасности SQL.

### <a name="cmdlets-for-azure-sql-database-and-azure-synapse"></a>Командлеты для базы данных SQL Azure и Azure синапсе

Используйте следующие командлеты для базы данных SQL Azure и Azure синапсе:

| Командлет | Описание |
| --- | --- |
| [Set-Азсклдатабасетранспарентдатаенкриптион](/powershell/module/az.sql/set-azsqldatabasetransparentdataencryption) |Включает или отключает прозрачное шифрование данных для базы данных.|
| [Get-Азсклдатабасетранспарентдатаенкриптион](/powershell/module/az.sql/get-azsqldatabasetransparentdataencryption) |Возвращает состояние прозрачного шифрования данных для базы данных. |
| [Get-Азсклдатабасетранспарентдатаенкриптионактивити](/powershell/module/az.sql/get-azsqldatabasetransparentdataencryptionactivity) |Проверяет ход шифрования базы данных. |
| [Add-Азсклсерверкэйваулткэй](/powershell/module/az.sql/add-azsqlserverkeyvaultkey) |Добавляет ключ Key Vault на сервер. |
| [Get-Азсклсерверкэйваулткэй](/powershell/module/az.sql/get-azsqlserverkeyvaultkey) |Возвращает ключи Key Vault для сервера.  |
| [Set-Азсклсервертранспарентдатаенкриптионпротектор](/powershell/module/az.sql/set-azsqlservertransparentdataencryptionprotector) |Задает средство защиты прозрачного шифрования данных для сервера. |
| [Get-Азсклсервертранспарентдатаенкриптионпротектор](/powershell/module/az.sql/get-azsqlservertransparentdataencryptionprotector) |Получение предохранителя TDE |
| [Remove-Азсклсерверкэйваулткэй](/powershell/module/az.sql/remove-azsqlserverkeyvaultkey) |Удаляет ключ Key Vault с сервера. |
|  | |

> [!IMPORTANT]
> Для Управляемый экземпляр Azure SQL используйте команду T-SQL [ALTER DATABASE](/sql/t-sql/statements/alter-database-azure-sql-database) , чтобы включить и отключить TDE на уровне базы данных, а также установить [образец сценария POWERSHELL](transparent-data-encryption-byok-configure.md) для управления TDE на уровне экземпляра.

# <a name="transact-sql"></a>[Transact-SQL](#tab/azure-TransactSQL)

Управление TDE с помощью Transact-SQL.

Подключитесь к базе данных, указав имя входа администратора или члена роли **dbmanager** в базе данных master.

| Команда | Описание |
| --- | --- |
| [CREATE DATABASE (база данных SQL Azure)](/sql/t-sql/statements/alter-database-azure-sql-database) | SET ENCRYPTION ON/OFF — шифрование или расшифровка базы данных |
| [sys.dm_database_encryption_keys](/sql/relational-databases/system-dynamic-management-views/sys-dm-database-encryption-keys-transact-sql) |Возврат сведений о состоянии шифрования для базы данных и связанных с ней ключей шифрования |
| [sys.dm_pdw_nodes_database_encryption_keys](/sql/relational-databases/system-dynamic-management-views/sys-dm-pdw-nodes-database-encryption-keys-transact-sql) |Возвращает сведения о состоянии шифрования каждого узла Azure синапсе и связанных с ним ключей шифрования базы данных. |
|  | |

Невозможно переключить средство защиты TDE на ключ из Key Vault с помощью Transact-SQL. Используйте для этого портал Azure или PowerShell.

# <a name="rest-api"></a>[REST API](#tab/azure-RESTAPI)

Управление TDE с помощью REST API.

Чтобы настроить TDE с помощью REST API, необходимо подключиться как владелец, участник или диспетчер безопасности SQL Azure.
Используйте следующий набор команд для базы данных SQL Azure и Azure синапсе:

| Команда | Описание |
| --- | --- |
|[Создание или обновление сервера](/rest/api/sql/servers/createorupdate)|Добавляет удостоверение Azure Active Directory на сервер. (используется для предоставления доступа к Key Vault)|
|[Создание или обновление ключа сервера](/rest/api/sql/serverkeys/createorupdate)|Добавляет ключ Key Vault на сервер.|
|[Удаление ключа сервера](/rest/api/sql/serverkeys/delete)|Удаляет ключ Key Vault с сервера. |
|[Получение ключей сервера](/rest/api/sql/serverkeys/get)|Возвращает конкретный ключ Key Vault с сервера.|
|[Список ключей серверов, упорядоченный по серверам](/rest/api/sql/serverkeys/listbyserver)|Возвращает ключи Key Vault для сервера. |
|[Создание или обновление предохранителя шифрования](/rest/api/sql/encryptionprotectors/createorupdate)|Задает средство защиты TDE для сервера.|
|[Получение предохранителя шифрования](/rest/api/sql/encryptionprotectors/get)|Возвращает средство защиты TDE для сервера.|
|[Список предохранителей шифрования, упорядоченный по серверам](/rest/api/sql/encryptionprotectors/listbyserver)|Возвращает предохранители TDE для сервера. |
|[Создание или обновление конфигурации TDE](/rest/api/sql/transparentdataencryptions/createorupdate)|Включает или отключает прозрачное шифрование данных для базы данных.|
|[Получение конфигурации TDE](/rest/api/sql/transparentdataencryptions/get)|Получает конфигурацию прозрачного шифрования данных для базы данных.|
|[Список результатов TDE, упорядоченный по конфигурации](/rest/api/sql/transparentdataencryptionactivities/listbyconfiguration)|Получает результат шифрования для базы данных.|

## <a name="see-also"></a>См. также:

- SQL Server на виртуальной машине Azure также может использовать асимметричный ключ из Key Vault. Этапы настройки в этом случае будут отличаться от настройки асимметричного ключа, сохраненного в Базе данных SQL и Управляемом экземпляре Базы данных SQL. Дополнительные сведения см. в статье о [расширенном управлении ключами с помощью Azure Key Vault (SQL Server)](/sql/relational-databases/security/encryption/extensible-key-management-using-azure-key-vault-sql-server).
- Общее описание TDE см. в разделе [прозрачное шифрование данных](/sql/relational-databases/security/encryption/transparent-data-encryption).
- Дополнительные сведения о TDE с поддержкой BYOK для базы данных SQL Azure, Управляемый экземпляр Azure SQL и Azure синапсе см. в статье [прозрачное шифрование данных с поддержкой создание собственных ключей](transparent-data-encryption-byok-overview.md).
- Чтобы приступить к использованию TDE с поддержкой создание собственных ключей, см. Руководство по [включению прозрачного шифрования данных с помощью собственного ключа из Key Vault](transparent-data-encryption-byok-configure.md).
- Дополнительные сведения о Key Vault см. [в статье безопасный доступ к хранилищу ключей](../../key-vault/general/secure-your-key-vault.md).