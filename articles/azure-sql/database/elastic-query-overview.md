---
title: Обзор эластичных запросов
description: Эластичный запрос позволяет выполнять запросы Transact-SQL, охватывающие несколько баз данных.
services: sql-database
ms.service: sql-database
ms.subservice: scale-out
ms.custom: sqldbrb=1
ms.devlang: ''
ms.topic: overview
author: MladjoA
ms.author: mlandzic
ms.reviewer: sstein
ms.date: 12/05/2019
ms.openlocfilehash: cac17bbac96d44d8d9bfce2e168de4ea6d4c5c08
ms.sourcegitcommit: f28ebb95ae9aaaff3f87d8388a09b41e0b3445b5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/29/2021
ms.locfileid: "100364959"
---
# <a name="azure-sql-database-elastic-query-overview-preview"></a>Обзор эластичных запросов к базе данных SQL Azure (предварительная версия)
[!INCLUDE[appliesto-sqldb](../includes/appliesto-sqldb.md)]

Функция эластичных запросов (предварительная версия) дает возможность выполнять запросы Transact-SQL, охватывающие сразу несколько баз данных в Базе данных SQL Azure. Эта возможность позволяет создавать межбазовые запросы для доступа к удаленным таблицам. Также вы можете подключать средства Майкрософт и сторонних производителей (Excel, PowerBI, Tableau и т. д.) для выполнения запросов на разных уровнях данных со множеством баз данных. С помощью этой функции можно горизонтально увеличивать масштаб запросов до уровней большого объема данных и визуализировать результаты в отчетах по бизнес-аналитике (BI).

## <a name="why-use-elastic-queries"></a>Почему рекомендуется использовать эластичные запросы

### <a name="azure-sql-database"></a>База данных SQL Azure

В службе "База данных SQL Azure" можно выполнять запросы к базам данных полностью на языке T-SQ. Это позволяет выполнять запросы к удаленным базам данных в режиме только для чтения, а также дает возможность текущим пользователям сервера SQL Server перемещать приложения в Базу данных SQL, применяя имена, состоящие из трех или четырех частей, либо связанный сервер.

### <a name="available-on-standard-tier"></a>Доступность на уровне "Стандартный"

Эластичные запросы поддерживаются для хранилища с уровнями служб "Стандартный" и "Премиум". Сведения об ограничениях производительности для нижних уровней служб см. в разделе "Ограничения предварительной версии" ниже.

### <a name="push-parameters-to-remote-databases"></a>Отправка параметров в удаленные базы данных

Эластичные запросы к удаленным базам данных теперь могут отправлять параметры SQL для выполнения.

### <a name="stored-procedure-execution"></a>Выполнение хранимой процедуры

Выполнить вызовы удаленных хранимых процедур или удаленных функций можно с помощью процедуры [sp\_execute\_remote](/sql/relational-databases/system-stored-procedures/sp-execute-remote-azure-sql-database).

### <a name="flexibility"></a>Гибкость

Функция эластичных запросов позволяет внешним таблицам ссылаться на удаленные таблицы с разными именами схем или таблиц.

## <a name="elastic-query-scenarios"></a>Сценарии применения эластичных запросов

Основная задача лежит в области упрощения сценариев запросов, когда строки, предоставленные несколькими базами данных, объединяются в один общий набор результатов. Запрос может быть создан либо напрямую пользователем или приложением, либо косвенно — с помощью средств, которые подключены к базе данных. Это особенно полезно при создании отчетов с помощью коммерческих средств бизнес-аналитики, интеграции данных или любого приложения, которое нельзя изменить. Функция эластичных запросов позволяет выполнять межбазовые запросы с использованием уже знакомой процедуры подключения к SQL Server в таких средствах, как Excel, Power BI, Tableau или Cognos.
Кроме того, эластичный запрос не только обеспечивает доступ ко всей коллекции баз данных через запросы, выданные SQL Server Management Studio или Visual Studio, но и упрощает обработку межбазовых запросов из Entity Framework или других сред ORM. На рисунке 1 показан сценарий, в котором существующее облачное приложение (использующее [клиентскую библиотеку эластичной базы данных](elastic-database-client-library.md)) основывается на уровне масштабируемых данных, а функция эластичных запросов используется для создания межбазовых отчетов.

**Рисунок 1.** Эластичный запрос на уровне масштабируемых данных

![Эластичный запрос на уровне масштабируемых данных][1]

Пользовательские сценарии эластичных запросов могут характеризоваться следующими топологиями:

* **Вертикальное секционирование — межбазовые запросы** (топология 1): вертикальное разделение данных между несколькими базами данных в рамках одного уровня. Как правило, разные наборы таблиц расположены в разных базах данных. Это означает, что схемы разных баз данных различаются. Например, все таблицы, связанные с данными инвентаризации, хранятся в одной базе данных, а таблицы, связанные с учетом, — в другой. Использование подобной топологии предполагает использование первой базы данных для выполнения запросов или создания отчетов по таблицам в нескольких базах данных.
* **Горизонтальное секционирование — сегментирование** (топология 2): горизонтальное разделение данных для распределения строк в рамках масштабируемого уровня данных. При таком подходе схемы всех включенных баз данных являются идентичными. Такой подход также называется сегментированием. Сегментирование может выполняться с помощью (1) библиотеки средств эластичной базы данных или (2) как самостоятельное сегментирование. Эластичные запросы используются для создания запросов или построения отчетов на основе нескольких сегментов. Сегменты обычно являются базами данных в эластичном пуле. Эластичные запросы предлагают эффективный способ одновременного обращения ко всем базам данных эластичного пула, если они совместно используют общую схему.

> [!NOTE]
> Эластичные запросы лучше всего подходят для создания отчетов, где большую часть обработки (фильтрацию, агрегирование) можно выполнить на стороне внешнего источника. Они не подходят для операций ETL, в ходе которых большой объем данных передается из удаленных баз данных. Для сценариев, предусматривающих значительные рабочие нагрузки для подготовки отчетности или хранения данных с выполнением более сложных запросов, вы можете использовать [Azure Synapse Analytics](https://azure.microsoft.com/services/synapse-analytics).
>  

## <a name="vertical-partitioning---cross-database-queries"></a>Вертикальное секционирование — межбазовые запросы

Сведения о том, как начать писать код, см. в статье [Приступая к работе с межбазовыми запросами (вертикальное секционирование) (предварительная версия)](elastic-query-getting-started-vertical.md).

Эластичные запросы можно использовать для предоставления доступа к данным, находящимся в одной из баз данных Базы данных SQL, другим базам данных из этой службы. Это позволяет добавлять в запросы из одной базы данных ссылки на таблицы в любой другой удаленной базе данных, подключенной к Базе данных SQL. Первым этапом является определение внешнего источника данных для каждой удаленной базы данных. Внешний источник данных определяется в локальной базе данных, из которой необходимо получить доступ к таблицам, расположенным в удаленной базе данных. Вносить изменения в удаленную базу данных не нужно. В стандартных сценариях вертикального секционирования, когда с разными базами данных используются разные схемы, эластичные запросы позволяют решать такие стандартные задачи, как доступ к ссылочным данным и создание межбазовых запросов.

> [!IMPORTANT]
> Требуется наличие разрешения ALTER ANY EXTERNAL DATA SOURCE. Это разрешение включено в разрешение ALTER DATABASE. Для обращения к базовому источнику данных необходимы разрешения ALTER ANY EXTERNAL DATA SOURCE.
>

**Ссылочные данные**: топология используется для управления ссылочными данными. На приведенном ниже рисунке две таблицы (T1 и T2) со ссылочными данными хранятся в выделенной базе данных. Как показано на рисунке, используя эластичный запрос, вы можете получить удаленный доступ к таблицам T1 и T2 из других баз данных. Топологию 1 рекомендуется использовать, если ссылочные таблицы имеют небольшой размер или если в удаленных запросах к таким таблицам используются предикаты селекции.

**Рисунок 2.** Вертикальное секционирование — использование эластичных запросов для обращения к ссылочным данным

![ Вертикальное секционирование — использование эластичных запросов для обращения к ссылочным данным][3]

**Запросы между базами данных**: эластичные запросы позволяют реализовывать сценарии, требующие выполнения запросов между базами данных, подключенными к Базе данных SQL. На рисунке 3 показаны четыре разных базы данных: "Управление отношениями с клиентами", "Инвентарные данные", "Управление персоналом" и "Продукты". Запросам, выполняемым в одной из этих баз данных, требуется доступ к одной или всем базам данным. Используя эластичные запросы, вы можете настроить свою базу, выполнив несколько простых инструкций DDL в каждой из этих четырех баз данных. После однократной настройки доступ к удаленной таблице будет предоставятся в виде ссылки на локальную таблицу в запросах T-SQL или используемых средствах бизнес-аналитики. Этот подход рекомендуется применять, когда удаленные запросы не возвращают большие объемы.

**Рисунок 3.** Вертикальное секционирование — использование эластичных запросов для межбазовых запросов

![ Вертикальное секционирование — использование эластичных запросов для межбазовых запросов][4]

Далее описана настройка эластичных запросов к базе данных при вертикальном секционировании с необходимостью доступа к таблице, хранящейся в удаленной базе данных в Базе данных SQL с такой же схемой.

* [CREATE MASTER KEY](/sql/t-sql/statements/create-master-key-transact-sql) mymasterkey
* [CREATE DATABASE SCOPED CREDENTIAL](/sql/t-sql/statements/create-database-scoped-credential-transact-sql) mycredential
* [CREATE/DROP EXTERNAL DATA SOURCE](/sql/t-sql/statements/create-external-data-source-transact-sql) mydatasource of type **RDBMS**
* [CREATE/DROP EXTERNAL TABLE](/sql/t-sql/statements/create-external-table-transact-sql) mytable

Выполнив эти инструкции DDL, вы получите доступ к удаленной таблице mytable как к локальной таблице. База данных SQL Azure автоматически открывает подключение к удаленной базе данных, обрабатывает запрос к удаленной базе данных и возвращает результаты.

## <a name="horizontal-partitioning---sharding"></a>Горизонтальное секционирование (сегментирование)

Чтобы использовать эластичные запросы для выполнения задач отчетности на уровне горизонтально секционированных (сегментированных) данных, базы данных на этом уровне должны быть представлены с помощью [карты сегментов эластичной базы данных](elastic-scale-shard-map-management.md). Как правило, в этом сценарии используется только одна карта сегментов, а роль точки входа для запросов отчетности выполняет выделенная база данных с поддержкой эластичных запросов (головной узел). Доступ к карте сегментов требуется только для этой выделенной базы данных. На рисунке 4 показана топология, конфигурация которой включает базу данных эластичных запросов и карту сегментов. Дополнительные сведения о клиентской библиотеке эластичной базы данных и о создании карт сегментов см. в статье [Развертывание баз данных с использованием диспетчера карты сегментов](elastic-scale-shard-map-management.md).

**Рисунок 4.** Горизонтальное секционирование — использование эластичных запросов для создания отчетности по уровням сегментированных данных

![ Горизонтальное секционирование — использование эластичных запросов для создания отчетности по уровням сегментированных данных][5]

> [!NOTE]
> База данных с поддержкой эластичных запросов (головной узел) может быть отдельной базой или базой данных, на которой размещена карта сегментов.
> Независимо от выбранной конфигурации убедитесь, что уровень служб и объем вычислительных ресурсов базы данных достаточно высок для обработки ожидаемого количества запросов и запросов на вход.

Ниже описана поэтапная настройка эластичных запросов к базе данных при горизонтальном секционировании, требующем доступа к набору таблиц, которые находятся (как правило) в нескольких удаленных базах данных в службе "База данных SQL".

* [CREATE MASTER KEY](/sql/t-sql/statements/create-master-key-transact-sql) mymasterkey
* [CREATE DATABASE SCOPED CREDENTIAL](/sql/t-sql/statements/create-database-scoped-credential-transact-sql) mycredential
* Создание [карты сегментов](elastic-scale-shard-map-management.md) для представления уровня данных с помощью клиентской библиотеки эластичной базы данных.
* [CREATE/DROP EXTERNAL DATA SOURCE](/sql/t-sql/statements/create-external-data-source-transact-sql) mydatasource of type **SHARD_MAP_MANAGER**
* [CREATE/DROP EXTERNAL TABLE](/sql/t-sql/statements/create-external-table-transact-sql) mytable

Выполнив эти шаги, вы получите доступ к горизонтально секционированной таблице mytable как к локальной таблице. База данных SQL Azure автоматически открывает несколько параллельных подключений к удаленным базам данных, хранящим таблицы, обрабатывает запросы к удаленным базам данных и возвращает результаты.
Дополнительные сведения о действиях, требуемых при горизонтальном секционировании, см. в статье [Отчеты по масштабируемым облачным базам данных (предварительная версия)](elastic-query-horizontal-partitioning.md).

Начальные сведения для написания кода см. в статье [Отчеты по масштабируемым облачным базам данных (предварительная версия)](elastic-query-getting-started.md).

> [!IMPORTANT]
> Успешное выполнение эластичного запроса к большому набору баз данных во многом зависит от доступности каждой из баз во время выполнения запроса. Если одна из ни х недоступна, весь запрос завершится ошибкой. Если вы планируете выполнять запросы к сотням или тысячам баз данных одновременно, убедитесь, что в клиентском приложении реализована встроенная логика повторных попыток. Или рассмотрите возможность использования [заданий Эластичной базы данных](./job-automation-overview.md) (предварительная версия) и выполнения запросов к меньшему количеству баз данных с направлением результатов каждого запроса в одно определенное назначение.

## <a name="t-sql-querying"></a>Запросы T-SQL

Определив внешние источники данных и внешние таблицы, вы можете использовать уже обычные строки подключения к SQL Server для соединения с базами данных, в которых определены внешние таблицы. Затем через это подключение можно выполнить инструкции T-SQL применимо к внешним таблицам. При этом будут действовать описанные ниже ограничения. Дополнительные сведения о запросах T-SQL и их примеры можно найти в разделах документации по [горизонтальному](elastic-query-horizontal-partitioning.md) и [вертикальному секционированию](elastic-query-vertical-partitioning.md).

## <a name="connectivity-for-tools"></a>Подключение для инструментов

Используйте обычные строки подключения к SQL Server, чтобы подключить приложения, а также средства бизнес-аналитики и интеграции данных к базам данных, содержащих внешние таблицы. Убедитесь, что в качестве источника данных для вашего инструмента поддерживается SQL Server. После подключения обратитесь к базе данных эластичных запросов и внешним таблицам в этой базе данных, как при подключении к любой другой базе данных SQL Server с помощью какого-либо средства.

> [!IMPORTANT]
> Проверка подлинности с помощью Azure Active Directory и эластичных запросов сейчас не поддерживается.

## <a name="cost"></a>Cost

Функция эластичных запросов включена в стоимость Базы данных SQL Azure. Обратите внимание: несмотря на поддержку топологий, в которых удаленные базы данных и конечная точка эластичного запроса находятся в разных центрах обработки данных, стоимость вывода данных из удаленных баз данных рассчитывается по обычным [тарифам Azure](https://azure.microsoft.com/pricing/details/data-transfers/).

## <a name="preview-limitations"></a>Ограничения предварительной версии

* На уровне служб "Стандартный" выполнение первого эластичного запроса может занять несколько минут. Это время требуется для загрузки функций, связанных с эластичными запросами. На более высоких уровнях служб и с большим объемом вычислительных ресурсов скорость загрузки будет выше.
* Сценарии для внешних источников данных или внешних таблиц из SSMS или SSDT в настоящее время не поддерживаются.
* Функции импорта и экспорта Базы данных SQL сейчас не поддерживают внешние источники данных и внешние таблицы. Если вам нужно использовать функции импорта и экспорта, удалите эти объекты перед экспортом и создайте их заново после импорта.
* Сейчас эластичные запросы поддерживает доступ только для чтения к внешним таблицам. Тем не менее вы можете использовать полный набор функций T-SQL при работе с базой данных, в которой определена внешняя таблица. Например, это может быть полезно для сохранения временных результатов (например, с помощью инструкции SELECT <список_столбцов> INTO <локальная_таблица>) или для определения хранимых процедур в базе данных эластичных запросов со ссылками на внешние таблицы.
* Определения внешних таблиц не поддерживают типы LOB (в том числе пространственные типы), за исключением nvarchar(max). Обойти это ограничение можно, создав представление в удаленной базе данных с преобразованием типа LOB в тип nvarchar(max). Затем нужно определить внешнюю таблицу применимо к этому представлению (а не базовой таблице) и выполнить обратное преобразование в исходный тип LOB для запросов.
* Столбцы данных типа nvarchar(max) в результирующем наборе не поддерживают возможности пакетной обработки технологии, используемые при реализации эластичных запросов. Это может повлиять на производительность запросов на один или два порядка в нестандартных вариантах использования, когда большой объем неагрегированных данных передается в результате запроса.
* Статистика по столбцам для внешних таблиц в настоящее время не поддерживается. Статистика по таблицам поддерживается, но она создается вручную.
* Эластичные запросы поддерживает только База данных SQL Azure. Нельзя выполнять их к экземпляру SQL Server.

## <a name="share-your-feedback"></a>Поделитесь своим мнением

Оставьте свой отзыв об эластичных запросах на форумах MSDN или сайте Stack Overflow. Мы будем признательны за любые отзывы о нашем сервисе, в том числе за сообщения о недостатках, недоработках и недостающих функциях.

## <a name="next-steps"></a>Дальнейшие действия

* Руководств по вертикальному секционированию см. в статье [Приступая к работе с межбазовыми запросами (вертикальное секционирование) (предварительная версия)](elastic-query-getting-started-vertical.md).
* Описание синтаксиса и примеры запросов вертикально секционированных данных см. в разделе [Запрос к нескольким облачным базам данных с разными схемами (предварительная версия)](elastic-query-vertical-partitioning.md).
* Руководство по горизонтальному секционированию (сегментированию) см. в статье [Отчеты по масштабируемым облачным базам данных (предварительная версия)](elastic-query-getting-started.md).
* Описание синтаксиса и примеры запросов горизонтально секционированных данных см. в разделе [Отчеты по масштабируемым облачным базам данных (предварительная версия)](elastic-query-horizontal-partitioning.md).
* В описании [sp\_execute \_remote](/sql/relational-databases/system-stored-procedures/sp-execute-remote-azure-sql-database) приведена хранимая процедура, которая выполняет инструкцию Transact-SQL для отдельной удаленной базы данных SQL Azure или набора баз данных, выступающих в качестве сегментов в схеме горизонтального секционирования.

<!--Image references-->
[1]: ./media/elastic-query-overview/overview.png
[2]: ./media/elastic-query-overview/topology1.png
[3]: ./media/elastic-query-overview/vertpartrrefdata.png
[4]: ./media/elastic-query-overview/verticalpartitioning.png
[5]: ./media/elastic-query-overview/horizontalpartitioning.png

<!--anchors-->