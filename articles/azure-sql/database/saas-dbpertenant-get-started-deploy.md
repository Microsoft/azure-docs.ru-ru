---
title: Руководство по использованию приложения SaaS для однотенантной базы данных
description: Разверните и изучите мультитенантное приложение SaaS Wingtip Tickets, которое демонстрирует шаблон "одна база данных на клиент" и другие схемы работы с приложениями SaaS с использованием Базы данных SQL Azure.
services: sql-database
ms.service: sql-database
ms.subservice: scenario
ms.custom: sqldbrb=1
ms.devlang: ''
ms.topic: tutorial
author: stevestein
ms.author: sstein
ms.reviewer: ''
ms.date: 01/25/2019
ms.openlocfilehash: 497e714289c834e026c6b9b767ed2b7af5442783
ms.sourcegitcommit: f28ebb95ae9aaaff3f87d8388a09b41e0b3445b5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/29/2021
ms.locfileid: "92780841"
---
# <a name="deploy-and-explore-a-multitenant-saas-app-that-uses-the-database-per-tenant-pattern-with-azure-sql-database"></a>Разверните и изучите мультитенантное приложение SaaS, в котором используется отдельная База данных SQL Azure для каждого клиента.

[!INCLUDE[appliesto-sqldb](../includes/appliesto-sqldb.md)]

В этом руководстве вы развернете и изучите приложение SaaS Wingtip Tickets, использующее одну базу данных на клиент (Wingtip). В этом приложении SaaS сохраняются данные нескольких клиентов, и для каждого клиента используется отдельная база данных. Приложение разработано для демонстрации возможностей Базы данных SQL Azure, которые обеспечивают реализацию сценариев SaaS.

Через пять минут после щелчка **Развертывание в Azure** вы получите мультитенантное приложение SaaS. Приложение включает базу данных, которая выполняется в Базе данных SQL Azure. Приложение развертывается с помощью трех примеров клиентов, каждый из которых содержит свою базу данных. Все базы данных развернуты в эластичном пуле SQL. Приложение развертывается в подписку Azure. Вы получите полный доступ для изучения отдельных компонентов приложения и экспериментов с ними. Исходный код C# приложения и скрипты управления доступны в [репозитории WingtipTicketsSaaS-DbPerTenant][github-wingtip-dpt] на GitHub.

Из этого руководства вы узнаете следующее:

> [!div class="checklist"]
> - как развернуть приложение SaaS Wingtip;
> - где можно получить исходный код приложения и сценарии управления;
> - сведения о серверах, пулах и базах данных, формирующих приложение;
> - как сопоставить клиентов с данными с помощью *каталога*;
> - как подготовить новый клиент;
> - как выполнить мониторинг активности клиента в приложении.

Чтобы изучить различные модели проектирования и управления SaaS, вы можете ознакомиться с доступной [серией связанных руководств](saas-dbpertenant-wingtip-app-overview.md#sql-database-wingtip-saas-tutorials). Они являются продолжением этого руководства, необходимого для выполнения первоначального развертывания. Изучая руководства, вы можете понять способ реализации различных шаблонов SaaS, ознакомившись с приведенными сценариями. В этих сценариях показано, как функции базы данных SQL упрощают развертывание приложений SaaS.

## <a name="prerequisites"></a>Предварительные требования

Для работы с этим руководством нужно установить Azure PowerShell. Дополнительные сведения см. в статье [Начало работы с Azure PowerShell](/powershell/azure/get-started-azureps).

## <a name="deploy-the-wingtip-tickets-saas-application"></a>Развертывание приложения SaaS Wingtip Tickets

### <a name="plan-the-names"></a>Планирование имен

При выполнении шагов в этом разделе необходимо указать значение пользователя, которое обеспечит глобальную уникальность имен ресурсов. Кроле того, следует указать имя группы ресурсов для хранения всех ресурсов, создаваемых при развертывании приложения. Для фиктивного пользователя Энн Финли мы указали следующие сведения.

- **Пользователь**: *af1*. Это инициалы Энн Финли с цифрой. Используйте другое значение при развертывании приложения во второй раз. Например, af2.
- **Группа ресурсов:***wingtip-dpt-af1*. Она указывает, что это приложение, использующее одну базу данных на клиент. Добавление имени пользователя af1 позволяет сопоставить имя группы ресурсов с именами ресурсов, содержащихся в ней.

Теперь выберите ваши имена и запишите их.

### <a name="steps"></a>Шаги

1. Щелкните **Развертывание в Azure**, чтобы открыть на портале Azure шаблон развертывания приложения SaaS Wingtip Tickets, использующего одну базу данных на клиент.

   [![Изображение с кнопкой "Развернуть в Azure".](https://azuredeploy.net/deploybutton.png)](https://aka.ms/deploywingtipdpt)

1. В шаблоне введите значения обязательных параметров.

    > [!IMPORTANT]
    > Некоторые процессы аутентификации и брандмауэры сервера не защищены специально, так как предназначены для демонстрации. Рекомендуем создать группу ресурсов. Не используйте существующие группы ресурсов, серверы или пулы. Не используйте в рабочей среде это приложение, его сценарии или развернутые ресурсы. Поработав с приложением, удалите эту группу ресурсов, чтобы прекратить выставление счетов за нее.

    - **Группа ресурсов**. Выберите **Создать** и укажите выбранное ранее уникальное имя группы ресурсов.
    - **Расположение.** Выберите расположение из раскрывающегося списка.
    - **Пользователь**. Используйте значение имени пользователя, выбранное ранее.

1. Разверните приложения.

    a. Установите флажок, чтобы принять условия.

    b. Щелкните **Приобрести**.

1. Чтобы отслеживать состояние развертывания, щелкните **Уведомления** (значок колокольчика справа от поля поиска). Развертывание приложения SaaS Wingtip Tickets занимает примерно пять минут.

   ![Развертывание выполнено](./media/saas-dbpertenant-get-started-deploy/succeeded.png)

## <a name="download-and-unblock-the-wingtip-tickets-management-scripts"></a>Загрузка и разблокировка скриптов управления для приложения Wingtip Tickets

Пока выполняется развертывание приложения, скачайте исходный код и сценарии управления.

> [!IMPORTANT]
> Исполняемое содержимое (сценарии и библиотеки DLL) может быть заблокировано Windows, в то время как ZIP-файлы можно скачать с внешнего источника, а затем извлечь их содержимое. Выполните действия по разблокированию ZIP-файла до извлечения сценариев из него. Это позволит выполнить их.

1. Перейдите к [репозиторию GitHub WingtipTicketsSaaS-DbPerTenant][github-wingtip-dpt].
1. Выберите **Clone or download**(Клонировать или скачать).
1. Выберите **Download ZIP** (Скачать ZIP-файл) и сохраните файл.
1. Щелкните правой кнопкой мыши файл **WingtipTicketsSaaS-DbPerTenant-master.zip** и выберите **Свойства**.
1. На вкладке **Общие** выберите **Разблокировать** > **Применить**.
1. Нажмите кнопку **ОК** и извлеките файлы.

Сценарии находятся в папке ...\\WingtipTicketsSaaS-DbPerTenant-master\\Learning Modules.

## <a name="update-the-user-configuration-file-for-this-deployment"></a>Обновление файла конфигурации пользователя для развертывания

Прежде чем запускать какие-либо сценарии, настройте значения resource group и user в файле UserConfig.psm1. Задайте для этих переменных значения, указанные во время развертывания.

1. В интегрированной среде сценариев PowerShell откройте файл …\\Learning Modules\\**UserConfig.psm1**.
1. В полях **ResourceGroupName** и **Name** введите специфические для развертывания значения (только в строках 10 и 11).
1. Сохраните изменения.

Эти значения используются почти во всех скриптах.

## <a name="run-the-application"></a>Выполнение приложения

Приложение служит витриной для объектов, в которых проводятся культурные мероприятия. Чаще всего это концертные залы, джаз-клубы, спортивные клубы и т. п. В Wingtip Tickets объекты регистрируются как клиенты. Это дает каждому из них простую возможность предоставлять клиентам список мероприятий и продавать билеты. Для каждого объекта создается персонализированный веб-сайт для отображения списка мероприятий и продажи билетов.

В приложении каждый клиент получает базу данных, развернутую в эластичный пул.

Центральная страница **Концентратор событий** содержит список клиентов в вашем развертывании со ссылками.

1. Откройте концентратор событий в веб-браузере по адресу:http://events.wingtip-dpt.&lt;user&gt;.trafficmanager.net. Значение &lt;пользователь&gt; замените именем пользователя для своего развертывания.

    ![Концентратор событий](./media/saas-dbpertenant-get-started-deploy/events-hub.png)

2. Щелкните **Fabrikam Jazz Club** в концентраторе событий.

    ![События](./media/saas-dbpertenant-get-started-deploy/fabrikam.png)

### <a name="azure-traffic-manager"></a>Диспетчер трафика Azure

Приложение Wingtip использует [*диспетчер трафика Azure*](../../traffic-manager/traffic-manager-overview.md), чтобы управлять распределением входящих запросов. URL-адрес для доступа к странице событий для конкретного клиента указывается в следующем формате:

- http://events.wingtip-dpt.&lt;user&gt;.trafficmanager.net/fabrikamjazzclub

    В следующей таблице описываются элементы предыдущего формата.

    | Часть URL-адреса        | Описание       |
    | :-------------- | :---------------- |
    | events.wingtip-dpt | Элементы события приложения Wingtip.<br /><br /> Суффикс *-dpt* отличает реализацию Wingtip Tickets, использующую *одну базу данных на клиент*, от других вариантов реализации. Например, от *отдельного* однотенантного приложения (*-sa*) или приложения, использующего *мультитенантную базу данных* (*-mt*). |
    | . *&lt;пользователь&gt;* | В этом примере — *af1*. |
    | .trafficmanager.net/ | Базовый URL-адрес диспетчера трафика Azure. |
    | fabrikamjazzclub | Указывает клиент Fabrikam Jazz Club. |
    | &nbsp; | &nbsp; |

- Приложение событий выполняет анализ имени клиента в URL-адресе.
- С помощью имени клиента можно создать ключ.
- Ключ используется, чтобы получить доступ к каталогу и обнаружить расположение базы данных клиента.
  - Каталог реализуется с помощью *управления размещением сегментов*.
- Концентратор событий использует расширенные метаданные из каталога для создания списка URL-адресов страниц событий для каждого клиента.

В рабочей среде обычно создается запись DNS CNAME, которая [*сопоставляет интернет-домен компании*](../../traffic-manager/traffic-manager-point-internet-domain.md) с DNS-именем диспетчера трафика.

> [!NOTE]
> Функция диспетчера трафика в рамках этого руководства может быть неочевидной. Вся эта серия учебников демонстрирует шаблоны, которые помогают масштабировать сложные рабочие среды. Например, у вас есть несколько веб-приложений, распределенных по всему миру совместно с базами данных, и вам нужен диспетчер трафика для маршрутизации трафика между этими экземплярами.
Использование диспетчера трафика демонстрируется также в руководствах по [геовосстановлению](./saas-dbpertenant-dr-geo-restore.md) и [георепликации](./saas-dbpertenant-dr-geo-replication.md). В этих руководствах диспетчер трафика помогает выполнять переключение на экземпляр восстановления приложения SaaS в случае регионального сбоя.

## <a name="start-generating-load-on-the-tenant-databases"></a>Запуск создания нагрузки в базах данных клиента

Теперь после развертывания приложение готово к работе.

Сценарий PowerShell *Demo-LoadGenerator* запускает рабочую нагрузку, выполняющуюся во всех базах данных клиента. Реальная нагрузка в приложении SaaS случайна и непредсказуема. Для моделирования этого типа нагрузки генератор создает нагрузку со случайными пиковыми нагрузками или вспышками активности на каждом клиенте. Пиковые нагрузки происходят со случайными интервалами. Шаблон нагрузки появляется в течение нескольких минут. Перед мониторингом нагрузки генератор должен работать по крайней мере три или четыре минуты.

1. В интегрированной среде сценариев PowerShell откройте сценарий …\\Learning Modules\\Utilities\\*Demo-LoadGenerator.ps1*.
2. Нажмите клавишу F5, чтобы запустить сценарий и генератор нагрузки. Оставьте значения параметров по умолчанию.
3. Войдите с учетной записью Azure и, при необходимости, выберите подписку, которую вы хотите использовать.

Сценарий генератора нагрузки запускает фоновое задание для каждой базы данных в каталоге, а затем останавливается. При повторном запуске сценарий генератора нагрузки сначала остановит все выполняемые фоновые задания, прежде чем запускать новые.

### <a name="monitor-the-background-jobs"></a>Мониторинг фоновых заданий

Если вы хотите отслеживать фоновые задания и управлять ими, вы можете выполнить следующие командлеты.

- `Get-Job`
- `Receive-Job`
- `Stop-Job`

### <a name="demo-loadgeneratorps1-actions"></a>Действия Demo-LoadGenerator.ps1

*Demo-LoadGenerator.ps1* имитирует активную рабочую нагрузку транзакций клиента. Следующие шаги описывают последовательность действий, которые инициирует *Demo-LoadGenerator.ps1*:

1. *Demo-LoadGenerator.ps1* запускает *LoadGenerator.ps1* в фоновом режиме.

    - Оба эти PS1-файла хранятся в папках Learning Modules\\Utilities\\.

2. *LoadGenerator.ps1* перебирает все базы данных клиента в каталоге.

3. *LoadGenerator.ps1* запускает фоновое задание PowerShell для каждой базы данных клиента.

    - По умолчанию фоновые задания выполняются в течение 120 минут.
    - Каждое задание создает нагрузку на ЦП в одной базе данных клиента, выполняя *sp_CpuLoadGenerator*. Интенсивность и продолжительность нагрузки изменяется в зависимости от `$DemoScenario`.
    - *sp_CpuLoadGenerator* циклически выполняет инструкцию SQL SELECT, которая создает высокую нагрузку на ЦП. Интервал времени между вызовами инструкции SELECT зависит от значений параметров, что позволяет управлять нагрузкой на ЦП. Уровни нагрузки и интервалы выбираются в случайном порядке, чтобы имитация нагрузки была более реалистичной.
    - Этот SQL-файл хранится в папке *WingtipTenantDB\\dbo\\StoredProcedures\\*.

4. Если указано `$OneTime = $false`, то генератор нагрузки запускает фоновые задания, а затем продолжает выполняться. Каждые 10 секунд он отслеживает наличие новых подготовленных клиентов. Если указано `$OneTime = $true`, то генератор нагрузки запускает фоновые задания, а затем его выполнение на переднем плане останавливается. В рамках этого руководства оставьте `$OneTime = $false`.

   Если вы хотите остановить или перезапустить генератор нагрузки, используйте клавиши CTRL+C или CTRL+BREAK.

   Если вы оставили генератор нагрузки работать на переднем плане, используйте другой экземпляр интегрированной среды сценариев PowerShell для запуска других сценариев PowerShell.

&nbsp;

Прежде чем перейти к следующему разделу, оставьте генератор нагрузки запущенным в состоянии вызова задания.

## <a name="provision-a-new-tenant"></a>Подготовка нового клиента

При первоначальном развертывании создается три примера клиента. Теперь вы создадите другой клиент, чтобы увидеть, как это влияет на развернутое приложение. Рабочий процесс подготовки новых клиентов для приложения Wingtip описан в статье [Сведения о подготовке новых клиентов и их регистрации в каталоге](saas-dbpertenant-provision-and-catalog.md). На этом этапе вы создадите клиент, что займет не больше одной минуты.

1. Откройте новый экземпляр интегрированной среды сценариев PowerShell.
2. Откройте файл …\\Learning Modules\Provision and Catalog\\*Demo-ProvisionAndCatalog.ps1*.
3. Нажмите клавишу F5 для запуска сценария. Не изменяйте значения по умолчанию.

   > [!NOTE]
   > Во многих сценариях SaaS Wingtip переменная *$PSScriptRoot* используется для перехода по папкам и вызова функций из других сценариев. Эта переменная вычисляется только при выполнении полного сценария путем нажатия клавиши F5. Если выделить несколько сценариев и запустить их клавишей F8, может произойти ошибка. Используйте клавишу F5 для запуска сценариев.

Новая база данных клиента:

- создана в эластичном пуле SQL;
- инициализирована;
- зарегистрирована в каталоге.

Когда подготовка успешно завершится, созданный сайт *Events* (События) для нового клиента откроется в браузере.

![Новый клиент](./media/saas-dbpertenant-get-started-deploy/red-maple-racing.png)

Обновите концентратор событий, чтобы отобразить в списке новый клиент.

## <a name="explore-the-servers-pools-and-tenant-databases"></a>Изучение серверов, пулов и клиентских баз данных

Теперь, когда вы запустили выполнение нагрузки в коллекции клиентов, давайте рассмотрим некоторые из развернутых ресурсов.

1. На [портале Azure](https://portal.azure.com) перейдите к списку серверов SQL Server. Откройте сервер **catalog-dpt-&lt;Пользователь&gt;**.
    - Этот сервер каталога содержит две базы данных: **tenantcatalog** и **basetenantdb**. Вторая из них является шаблоном базы данных, который копируется для создания новых клиентов.

   ![Снимок экрана: страница "Обзор" сервера каталога с двумя базами данных.](./media/saas-dbpertenant-get-started-deploy/databases.png)

2. Вернитесь к списку серверов SQL.

3. Откройте сервер **tenants1-dpt-&lt;пользователь&gt;**, который содержит клиентские базы данных.

4. Обратите внимание на следующие элементы:

    - Каждая клиентская база данных является эластичной базой данных **уровня "Стандартный"** в пуле уровня "Стандартный" на 50 eDTU.
    - База данных Red Maple Racing — это подготовленная ранее клиентская база данных.

   ![Сервер с базами данных](./media/saas-dbpertenant-get-started-deploy/server.png)

## <a name="monitor-the-pool"></a>Отслеживание пула

После выполнения *LoadGenerator.ps1* несколько минут вы должны иметь достаточный объем данных, чтобы рассмотреть некоторые функции мониторинга. Эти функции встроены в пулы и базы данных.

Перейдите к серверу **tenants1-dpt-&lt;пользователь&gt;**, а затем щелкните **Pool1**, чтобы просмотреть использование ресурсов для пула. На следующих диаграммах показан генератор нагрузки, который работал в течение часа.

   ![Отслеживание пула](./media/saas-dbpertenant-get-started-deploy/monitor-pool.png)

- На первой диаграмме с меткой **Использование ресурсов** показано использование eDTU для пула в целом.
- На второй диаграмме показано использование eDTU для пяти наиболее активных баз данных в пуле.

На этих двух диаграммах хорошо видно, что эластичные пулы и база данных SQL хорошо подходят для непредсказуемых рабочих нагрузок приложения SaaS. На диаграммах показано, что четыре базы данных передают 40 eDTU. Все базы данных легко поддерживаются пулом, рассчитанным на 50 eDTU. Пул с 50 eDTU может поддерживать даже более высокие рабочие нагрузки. Если бы базы данных были подготовлены как отдельные, то каждая из них должна быть уровня S2 (50 DTU), чтобы поддерживать пиковые нагрузки. Стоимость четырех отдельных баз данных уровня S2 в три раза превышала бы стоимость пула. На самом деле клиенты базы данных SQL используют до 500 баз данных в пулах на 200 eDTU. Дополнительные сведения см. в статье [Мониторинг производительности баз данных и пулов SQL Azure в мультитенантном приложении SaaS и управление ею](saas-dbpertenant-performance-monitoring.md).

## <a name="additional-resources"></a>Дополнительные ресурсы

- Дополнительные сведения доступны в других [руководствах на основе приложения SaaS Wingtip Tickets, использующего одну базу данных на клиент](saas-dbpertenant-wingtip-app-overview.md#sql-database-wingtip-saas-tutorials).
- Дополнительные сведения об эластичных пулах см. в статье [Мониторинг производительности баз данных и пулов SQL Azure в мультитенантном приложении SaaS и управление ею](elastic-pool-overview.md).
- Дополнительные сведения об эластичных заданиях см. в статье [Управление масштабируемыми облачными базами данных](./elastic-jobs-overview.md).
- Дополнительные сведения о мультитенантных приложениях SaaS см. в статье [Мультитенантные шаблоны клиента в базе данных SaaS](saas-tenancy-app-design-patterns.md).

## <a name="next-steps"></a>Дальнейшие действия

Из этого руководства вы узнали следующее:

> [!div class="checklist"]
> - развертывание приложения SaaS Wingtip Tickets;
> - сведения о серверах, пулах и базах данных, формирующих приложение;
> - как сопоставить клиентов с данными с помощью *каталога*;
> - как подготовить новые клиенты;
> - как просмотреть историю использования пула для отслеживания работы клиента;
> - как удалить примеры ресурсов, чтобы не оплачивать их.

Далее ознакомьтесь со статьей [Сведения о подготовке новых клиентов и их регистрации в каталоге](saas-dbpertenant-provision-and-catalog.md).

<!-- Link references. -->

[github-wingtip-dpt]: https://github.com/Microsoft/WingtipTicketsSaaS-DbPerTenant