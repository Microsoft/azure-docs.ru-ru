---
title: Новые возможности
titleSuffix: Azure SQL Database & SQL Managed Instance
description: Узнайте о новых возможностях и улучшениях документации для базы данных SQL Azure & SQL Управляемый экземпляр.
services: sql-database
author: stevestein
ms.service: sql-db-mi
ms.subservice: service
ms.custom: sqldbrb=2
ms.devlang: ''
ms.topic: conceptual
ms.date: 03/10/2021
ms.author: sstein
ms.openlocfilehash: 0ddd2c96be3513d253537cefd5b9eb83da2b3c12
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "102634844"
---
# <a name="whats-new-in-azure-sql-database--sql-managed-instance"></a>Что нового в базе данных SQL Azure & Управляемый экземпляр SQL?
[!INCLUDE[appliesto-sqldb-sqlmi](../includes/appliesto-sqldb-sqlmi.md)]

В этой статье перечислены функции базы данных SQL Azure и Управляемый экземпляр Azure SQL, которые в настоящее время доступны в общедоступной предварительной версии. Сведения об обновлениях и улучшениях базы данных SQL и Управляемый экземпляр SQL см. в разделе [SQL database & sql управляемый экземпляр Service Updates](https://azure.microsoft.com/updates/?product=sql-database). Обновления и улучшения других служб Azure см. в разделе [обновления служб](https://azure.microsoft.com/updates).

## <a name="whats-new"></a>Новые возможности

Документация по базе данных SQL Azure и Управляемый экземпляр Azure SQL разделена на отдельные разделы. Мы также обновили ссылку на управляемый экземпляр из *управляемого экземпляра базы данных SQL Azure* в *управляемый экземпляр Azure SQL*.

Это сделано потому, что некоторые функции и функциональные возможности значительно отличаются между одной базой данных и управляемым экземпляром, и все становится все сложнее объяснить сложные особенности между базой данных SQL Azure и Управляемый экземпляр Azure SQL в отдельных общих статьях.

Это уточнение между различными продуктами SQL Azure должно упростить и упростить процесс работы с SQL Server ядром СУБД в Azure, будь то единая управляемая база данных в базе данных SQL Azure, полностью управляемый экземпляр, в котором размещено несколько баз данных в Azure SQL Управляемый экземпляр, или знакомый локальный продукт SQL Server, размещенный на виртуальной машине в Azure.

Учтите, что это выполняемая работа, а не все статьи еще не обновлены. Например, документация по инструкциям Transact-SQL (T-SQL), хранимым процедурам и многим функциям, которые совместно используются базой данных SQL Azure и Управляемый экземпляр Azure SQL, еще не завершены, поэтому мы благодарим вас за терпение, так как мы продолжим прояснить содержимое. 

В этой таблице приводится краткое сравнение изменений в терминологии. 


|**Новый термин**  | **Предыдущий срок**  |**Пояснение** |
|---------|---------|---------|
|**Управляемый экземпляр SQL Azure** | *Управляемый экземпляр* базы данных SQL Azure| Управляемый экземпляр Azure SQL — это собственный продукт в семействе SQL Azure, а не только вариант развертывания в базе данных SQL Azure. | 
|**База данных SQL Azure**|*Единая база* данных SQL Azure| Если явно не указано иное, имя продукта в базе данных SQL Azure включает как отдельные базы данных, так и базы данных, развернутые в эластичном пуле. |
|**База данных SQL Azure**|*Эластичный пул* базы данных SQL Azure| Если явно не указано иное, имя продукта в базе данных SQL Azure включает как отдельные базы данных, так и базы данных, развернутые в эластичном пуле.  |
|**База данных SQL Azure** |База данных SQL Azure | Несмотря на то что термин остается прежним, он применяется только к развертыванию одиночной базы данных и пула эластичных БД и не включает управляемый экземпляр. |
| **Azure SQL;**| Н/Д | Это относится к семейству SQL Server продуктов ядра СУБД, доступных в Azure: база данных SQL Azure, Управляемый экземпляр SQL Azure и SQL Server на виртуальных машинах Azure. | 

## <a name="features-in-public-preview"></a>Возможности общедоступной предварительной версии

### <a name="azure-sql-database"></a>[База данных SQL Azure](#tab/single-database)

| Компонент | Сведения |
| ---| --- |
| Задания обработки эластичных баз данных (Предварительная версия) | Дополнительные сведения см. в статье [Создание и настройка эластичных заданий и управление ими](elastic-jobs-overview.md). |
| Эластичные запросы | Дополнительные сведения см. в разделе [Общие сведения о эластичных запросах](elastic-query-overview.md). |
| Эластичные транзакции | [Распределенные транзакции между облачными базами данных](elastic-transactions-overview.md). |
| Редактор запросов в портал Azure |Дополнительные сведения см. в разделе [Использование редактора запросов SQL портал Azure для подключения и запроса данных](connect-query-portal.md).|
|Аналитика SQL|Дополнительные сведения см. в разделе [аналитика SQL Azure](../../azure-monitor/insights/azure-sql.md).|
| &nbsp; |

### <a name="azure-sql-managed-instance"></a>[Управляемый экземпляр SQL Azure](#tab/managed-instance)

| Компонент | Сведения |
| ---| --- |
| <a href="/azure/azure-sql/database/elastic-transactions-overview">Распределенные транзакции</a> | Распределенные транзакции между управляемыми экземплярами. |
| <a href="/azure/sql-database/sql-database-instance-pools">Пулы экземпляров</a> | Удобный и экономичный способ переноса небольших экземпляров SQL в облако. |
| <a href="/en-gb/sql/t-sql/statements/create-login-transact-sql">Участники сервера Azure AD уровня экземпляра (имена для входа)</a> | Создайте имена для входа на уровне экземпляра, используя инструкцию <a href="/sql/t-sql/statements/create-login-transact-sql?view=azuresqldb-mi-current&preserve-view=true">создания имени входа из внешнего поставщика</a> . |
| [репликация транзакций](../managed-instance/replication-transactional-overview.md) | Репликация изменений из таблиц в другие базы данных в SQL Управляемый экземпляр, базе данных SQL или SQL Server. Или обновлять таблицы при изменении некоторых строк в других экземплярах SQL Управляемый экземпляр или SQL Server. Дополнительные сведения см. [в статье Настройка репликации в Azure SQL управляемый экземпляр](../managed-instance/replication-between-two-instances-configure-tutorial.md). |
| Обнаружение угроз |Дополнительные сведения см. [в статье Настройка обнаружения угроз в Azure SQL управляемый экземпляр](../managed-instance/threat-detection-configure.md).|
| Долгосрочное хранение резервных копий | Дополнительные сведения см. в статье [Настройка долгосрочного резервного копирования в Azure SQL управляемый экземпляр](../managed-instance/long-term-backup-retention-configure.md), которая в настоящее время ограничена общедоступной предварительной версией. | 

---

## <a name="new-features"></a>новые функции;

### <a name="sql-managed-instance-h2-2019-updates"></a>Обновления SQL Управляемый экземпляр H2 2019

- [Конфигурация подсети](https://azure.microsoft.com/updates/service-aided-subnet-configuration-for-managed-instance-in-azure-sql-database-available/) с учетом службы — это безопасный и удобный способ управления конфигурацией подсети, в которой вы управляете трафиком данных, а управляемый экземпляр SQL обеспечивает непрерывный поток трафика управления.
- [Прозрачное шифрование данных (TDE) с создание собственных ключей (BYOK)](https://azure.microsoft.com/updates/general-avilability-transparent-data-encryption-with-customer-managed-keys-for-azure-sql-database-managed-instance/) позволяет применять собственный ключ (BYOK) для защиты данных в неактивных целях и позволяет организациям отделить обязанности по управлению ключами и данными.
- [Группы автоматической отработки отказа](https://azure.microsoft.com/updates/azure-sql-database-auto-failover-groups-feature-now-available-in-all-regions/) позволяют реплицировать все базы данных с первичного экземпляра на дополнительный экземпляр в другом регионе.
- [Глобальные флаги трассировки](https://azure.microsoft.com/updates/global-trace-flags-are-now-available-in-azure-sql-database-managed-instance/) позволяют настроить поведение SQL управляемый экземпляр.

### <a name="sql-managed-instance-h1-2019-updates"></a>Обновления SQL Управляемый экземпляр H1 2019

Следующие функции включены в модели развертывания SQL Управляемый экземпляр в H1 2019:
  - Поддержка подписок с <a href="/azure/azure-sql/managed-instance/resource-limits"> ежемесячным кредитом Azure для подписчиков Visual Studio </a> и повышенными [региональными ограничениями](../managed-instance/resource-limits.md#regional-resource-limitations).
  - Поддержка <a href="/sharepoint/administration/deploy-azure-sql-managed-instance-with-sharepoint-servers-2016-2019"> sharepoint 2016 и sharepoint 2019 </a> и <a href="/business-applications-release-notes/october18/dynamics365-business-central/support-for-azure-sql-database-managed-instance"> Dynamics 365 Business Central. </a>
  - Создайте управляемый экземпляр с <a href="/azure/azure-sql/managed-instance/scripts/create-powershell-azure-resource-manager-template">параметрами сортировки на уровне экземпляра</a> и выбранным <a href="https://azure.microsoft.com/updates/managed-instance-time-zone-ga/">часовым поясом</a> .
  - Управляемые экземпляры теперь защищены [встроенным брандмауэром](../managed-instance/management-endpoint-verify-built-in-firewall.md).
  - Настройте Управляемый экземпляр SQL для использования [общедоступных конечных точек](../managed-instance/public-endpoint-configure.md), [Переопределение прокси-сервера](connectivity-architecture.md#connection-policy) для повышения производительности сети, <a href="https://aka.ms/four-cores-sql-mi-update"> 4 виртуальных ядер на го поколения поколение оборудования</a> или <a href="/azure/azure-sql/database/automated-backups-overview">настройте срок хранения резервных копий до 35 дней</a> для восстановления на момент времени. [Долгосрочное хранение резервных копий](long-term-retention-overview.md) (до 10 лет) сейчас находится в общедоступной предварительной версии.  
  - Новые возможности позволяют выполнять <a href="https://medium.com/@jocapc/geo-restore-your-databases-on-azure-sql-instances-1451480e90fa">геовосстановление базы данных в другом центре обработки данных с помощью PowerShell</a>, [переименования базы данных](https://azure.microsoft.com/updates/azure-sql-database-managed-instance-database-rename-is-supported/), [удаления виртуального кластера](../managed-instance/virtual-cluster-delete.md).
  - Новая встроенная [роль участника «экземпляр](../../role-based-access-control/built-in-roles.md#sql-managed-instance-contributor) » обеспечивает соответствие требованиям к разделению (разделения обязанностей) с учетом принципов безопасности и соответствия стандартам предприятия.
  - SQL Управляемый экземпляр доступен в следующих регионах Azure для государственных организаций (US Gov (Техас), US Gov (Аризона)) и в Северный Китай 2 и Восточный Китай 2. Она также доступна в следующих общедоступных регионах: Центральная Австралия, Центральная Австралия 2, Южная Бразилия, Юго-Восточная часть Франции, Центральная ОАЭ, Северная Народно-Восточная, Южная Африка, Северная Африка, Юго-Африканская Республика.

## <a name="known-issues"></a>Известные проблемы

|Проблема  |Дата обнаружения  |Состояние  |Дата разрешения  |
|---------|---------|---------|---------|
|[При использовании параметра процедура sp_send_dbmail может выполнить неустранимую ошибку @query](#procedure-sp_send_dbmail-may-transiently-fail-when--parameter-is-used)|Янв 2021|Есть обходной путь||
|[Распределенные транзакции могут выполняться после удаления Управляемый экземпляр из группы доверия сервера](#distributed-transactions-can-be-executed-after-removing-managed-instance-from-server-trust-group)|Октябрь 2020|Есть обходной путь||
|[Распределенные транзакции не могут быть выполнены после Управляемый экземпляр операции масштабирования](#distributed-transactions-cannot-be-executed-after-managed-instance-scaling-operation)|Октябрь 2020|Есть обходной путь||
|[BULK INSERT](/sql/t-sql/statements/bulk-insert-transact-sql) / [Функция OPENROWSET](/sql/t-sql/functions/openrowset-transact-sql) в Azure SQL и `BACKUP` / `RESTORE` инструкция в управляемый экземпляр не может использовать удостоверение управления Azure AD для проверки подлинности в службе хранилища Azure|Sep 2020|Есть обходной путь||
|[Субъект-служба не может получить доступ к Azure AD и AKV](#service-principal-cannot-access-azure-ad-and-akv)|Авг 2020|Есть обходной путь||
|[Восстановление резервной копии вручную без КОНТРОЛЬной суммы может завершиться ошибкой](#restoring-manual-backup-without-checksum-might-fail)|Май 2020 г.|"Разрешено"|Июнь 2020 г.|
|[Агент перестает отвечать при изменении, отключении или включении существующих заданий](#agent-becomes-unresponsive-upon-modifying-disabling-or-enabling-existing-jobs)|Май 2020 г.|"Разрешено"|Июнь 2020 г.|
|[Разрешения для группы ресурсов, не примененные к SQL Управляемый экземпляр](#permissions-on-resource-group-not-applied-to-sql-managed-instance)|Фев 2020|"Разрешено"|2020 ноября|
|[Ограничение отработки отказа вручную с помощью портала для групп отработки отказа](#limitation-of-manual-failover-via-portal-for-failover-groups)|Янв 2020|Есть обходной путь||
|[Ролям агента SQL требуются явные разрешения EXECUTE для имен для входа, отличных от системного администратора](#in-memory-oltp-memory-limits-are-not-applied)|Dec 2019|Есть обходной путь||
|[Задания агента SQL Server могут быть прерваны с помощью перезапуска процесса агента](#sql-agent-jobs-can-be-interrupted-by-agent-process-restart)|Dec 2019|"Разрешено"|Мар 2020|
|[Имена для входа и пользователи Azure AD не поддерживаются в SSDT](#azure-ad-logins-and-users-are-not-supported-in-ssdt)|2019 ноября|Обходной путь отсутствует||
|[Ограничения памяти выполняющейся в памяти OLTP не применяются](#in-memory-oltp-memory-limits-are-not-applied)|Октябрь 2019|Есть обходной путь||
|[При попытке удаления непустого файла возвращена неверная ошибка](#wrong-error-returned-while-trying-to-remove-a-file-that-is-not-empty)|Октябрь 2019|Есть обходной путь||
|[Изменение уровня служб и операций создания экземпляра заблокировано текущим восстановлением базы данных](#change-service-tier-and-create-instance-operations-are-blocked-by-ongoing-database-restore)|Sep 2019|Есть обходной путь||
|[Resource Governor на уровне служб критически важный для бизнеса может потребоваться перенастроить после отработки отказа](#resource-governor-on-business-critical-service-tier-might-need-to-be-reconfigured-after-failover)|Sep 2019|Есть обходной путь||
|[После обновления уровня службы необходимо повторно инициализировать диалоговые окна межбазовых Service Broker](#cross-database-service-broker-dialogs-must-be-reinitialized-after-service-tier-upgrade)|Авг 2019|Есть обходной путь||
|[Олицетворение типов входа Azure AD не поддерживается](#impersonation-of-azure-ad-login-types-is-not-supported)|Июл 2019|Обходной путь отсутствует||
|[@query параметр не поддерживается в sp_send_db_mail](#-parameter-not-supported-in-sp_send_db_mail)|Апр 2019|"Разрешено"|Янв 2021|
|[После географической отработки отказа необходимо перенастроить репликацию транзакций](#transactional-replication-must-be-reconfigured-after-geo-failover)|Мар 2019|Обходной путь отсутствует||
|[Во время операции восстановления используется временная база данных](#temporary-database-is-used-during-restore-operation)||Есть обходной путь||
|[Структура и содержимое базы данных TEMPDB создано повторно](#tempdb-structure-and-content-is-re-created)||Обходной путь отсутствует||
|[Превышение дискового пространства с небольшими файлами баз данных](#exceeding-storage-space-with-small-database-files)||Есть обходной путь||
|[Значения GUID, отображаемые вместо имен баз данных](#guid-values-shown-instead-of-database-names)||Есть обходной путь||
|[Журналы ошибок не сохраняются](#error-logs-arent-persisted)||Обходной путь отсутствует||
|[Область транзакций в двух базах данных в одном и том же экземпляре не поддерживается](#transaction-scope-on-two-databases-within-the-same-instance-isnt-supported)||Есть обходной путь|Мар 2020|
|[Модули CLR и связанные серверы иногда не могут ссылаться на локальный IP-адрес.](#clr-modules-and-linked-servers-sometimes-cant-reference-a-local-ip-address)||Есть обходной путь||
|Согласованность базы данных не проверена с помощью инструкции DBCC CHECKDB после восстановления базы данных из хранилища BLOB-объектов Azure.||"Разрешено"|2019 ноября|
|Восстановление базы данных на момент времени с уровня критически важный для бизнеса на уровень общего назначения не будет выполняться, если база данных-источник содержит объекты OLTP в памяти.||"Разрешено"|Октябрь 2019|
|Компонент Database Mail с внешними (не Azure) почтовыми серверами с использованием безопасного подключения||"Разрешено"|Октябрь 2019|
|Автономные базы данных не поддерживаются в SQL Управляемый экземпляр||"Разрешено"|Авг 2019|

### <a name="procedure-sp_send_dbmail-may-transiently-fail-when-query-parameter-is-used"></a>При использовании параметра процедура sp_send_dbmail может выполнить неустранимую ошибку @query

При использовании параметра процедура sp_send_dbmail может выполнить неустранимую ошибку `@query` . При возникновении этой проблемы каждое второе выполнение процедуры sp_send_dbmail завершается ошибкой `Msg 22050, Level 16, State 1` и сообщением `Failed to initialize sqlcmd library with error number -2147467259` . Чтобы эта ошибка могла отображаться правильно, процедуру следует вызывать со значением по умолчанию 0 для параметра `@exclude_query_output` , в противном случае ошибка не будет распространена.
Эта проблема вызвана известной ошибкой, связанной с тем, как sp_send_dbmail использует олицетворение и пулы соединений.
Чтобы обойти эту ошибку, заключите код для отправки электронной почты в логику повторных попыток, основанную на параметре OUTPUT `@mailitem_id` . Если выполнение завершается ошибкой, то значение параметра будет равно NULL, что означает, что sp_send_dbmail должен быть вызван еще раз для успешной отправки сообщения электронной почты. Ниже приведен пример этой логики повторных попыток.
```sql
CREATE PROCEDURE send_dbmail_with_retry AS
BEGIN
    DECLARE @miid INT
    EXEC msdb.dbo.sp_send_dbmail
        @recipients = 'name@mail.com', @subject = 'Subject', @query = 'select * from dbo.test_table',
        @profile_name ='AzureManagedInstance_dbmail_profile', @execute_query_database = 'testdb',
        @mailitem_id = @miid OUTPUT

    -- If sp_send_dbmail returned NULL @mailidem_id then retry sending email.
    --
    IF (@miid is NULL)
    EXEC msdb.dbo.sp_send_dbmail
        @recipients = 'name@mail.com', @subject = 'Subject', @query = 'select * from dbo.test_table',
        @profile_name ='AzureManagedInstance_dbmail_profile', @execute_query_database = 'testdb',
END
```

### <a name="distributed-transactions-can-be-executed-after-removing-managed-instance-from-server-trust-group"></a>Распределенные транзакции могут выполняться после удаления Управляемый экземпляр из группы доверия сервера

[Группы доверия сервера](../managed-instance/server-trust-group-overview.md) используются для установления отношений доверия между управляемыми экземплярами, необходимыми для выполнения [распределенных транзакций](./elastic-transactions-overview.md). После удаления Управляемый экземпляр из группы доверия серверов или удаления группы вы по-прежнему можете выполнять распределенные транзакции. Существует обходной путь, который можно применить, чтобы убедиться, что распределенные транзакции отключены и [инициируются пользователем вручную при отработке отказа](../managed-instance/user-initiated-failover.md) управляемый экземпляр.

### <a name="distributed-transactions-cannot-be-executed-after-managed-instance-scaling-operation"></a>Распределенные транзакции не могут быть выполнены после Управляемый экземпляр операции масштабирования

Управляемый экземпляр операции масштабирования, включающие изменение уровня служб или виртуальных ядер, будут сбрасывать параметры группы доверия сервера на серверной части и отключать выполнение [распределенных транзакций](./elastic-transactions-overview.md). В качестве обходного решения удалите и создайте новую [группу доверия серверов](../managed-instance/server-trust-group-overview.md) на портал Azure.

### <a name="bulk-insert-and-backuprestore-statements-cannot-use-managed-identity-to-access-azure-storage"></a>Инструкции BULK INSERT и BACKUP/Restore не могут использовать управляемое удостоверение для доступа к службе хранилища Azure

Инструкции BULK INSERT, BACKUP и RESTORE и функция OPENROWSET не могут использовать `DATABASE SCOPED CREDENTIAL` с управляемым удостоверением для проверки подлинности в службе хранилища Azure. В качестве обходного решения переключитесь на проверку подлинности ПОДПИСАНного URL-доступа. Следующий пример не будет работать в Azure SQL (база данных и Управляемый экземпляр):

```sql
CREATE DATABASE SCOPED CREDENTIAL msi_cred WITH IDENTITY = 'Managed Identity';
GO
CREATE EXTERNAL DATA SOURCE MyAzureBlobStorage
  WITH ( TYPE = BLOB_STORAGE, LOCATION = 'https://****************.blob.core.windows.net/curriculum', CREDENTIAL= msi_cred );
GO
BULK INSERT Sales.Invoices FROM 'inv-2017-12-08.csv' WITH (DATA_SOURCE = 'MyAzureBlobStorage');
```

**Обходное решение**. Используйте [подписанный URL для проверки подлинности в хранилище](/sql/t-sql/statements/bulk-insert-transact-sql#f-importing-data-from-a-file-in-azure-blob-storage).

### <a name="service-principal-cannot-access-azure-ad-and-akv"></a>Субъект-служба не может получить доступ к Azure AD и AKV

В некоторых обстоятельствах может существовать ошибка субъекта-службы, используемого для доступа к службам Azure AD и Azure Key Vault (AKV). В результате эта проблема влияет на использование проверки подлинности Azure AD и прозрачного шифрования базы данных (TDE) с помощью SQL Управляемый экземпляр. Это может быть вызвано нерегулярной проблемой подключения или невозможностью выполнения таких инструкций, как создание имени входа или пользователя от внешнего поставщика или выполнение от имени входа или пользователя. Настройка TDE с помощью управляемого клиентом ключа на новом Управляемый экземпляр Azure SQL может также не работать в некоторых обстоятельствах.

**Решение**. чтобы предотвратить возникновение этой проблемы в управляемый экземпляр SQL перед выполнением каких-либо команд обновления или на тот случай, если эта проблема уже возникла после выполнения команд UPDATE, перейдите в колонку портал Azure, доступ к [колонке администрирования](./authentication-aad-configure.md?tabs=azure-powershell#azure-portal)SQL управляемый экземпляр Active Directory. Убедитесь, что отображается сообщение об ошибке "Управляемый экземпляр требуется субъект-служба для доступа к Azure Active Directory. Щелкните здесь, чтобы создать субъект-службу. Если вы столкнулись с этим сообщением об ошибке, щелкните его и следуйте пошаговым инструкциям, указанным до устранения этой ошибки.

### <a name="restoring-manual-backup-without-checksum-might-fail"></a>Восстановление резервной копии вручную без КОНТРОЛЬной суммы может завершиться ошибкой

В некоторых обстоятельствах ручное резервное копирование баз данных, которые были сделаны в управляемом экземпляре без КОНТРОЛЬной суммы, может быть не восстановлено. В таких случаях повторите попытку восстановления резервной копии до тех пор, пока вы не завершите все успешно.

**Обходное решение**. Выполните резервное копирование баз данных вручную на управляемых экземплярах с ВКЛЮЧЕНной КОНТРОЛЬной суммой.

### <a name="agent-becomes-unresponsive-upon-modifying-disabling-or-enabling-existing-jobs"></a>Агент перестает отвечать при изменении, отключении или включении существующих заданий

В некоторых обстоятельствах изменение, отключение или Включение существующего задания может привести к тому, что агент перестанет отвечать на запросы. Эта ошибка автоматически снижается при обнаружении, что приводит к перезапуску процесса агента.

### <a name="permissions-on-resource-group-not-applied-to-sql-managed-instance"></a>Разрешения для группы ресурсов, не примененные к SQL Управляемый экземпляр

Когда роль SQL Управляемый экземпляр участник Azure применяется к группе ресурсов (RG), она не применяется к SQL Управляемый экземпляр и не действует.

**Обходное решение**. Настройте роль участника SQL управляемый экземпляр для пользователей на уровне подписки.

### <a name="limitation-of-manual-failover-via-portal-for-failover-groups"></a>Ограничение отработки отказа вручную с помощью портала для групп отработки отказа

Если группа отработки отказа охватывает экземпляры в разных подписках или группах ресурсов Azure, отработка отказа вручную не может быть инициирована из основного экземпляра в группе отработки отказа.

**Обходное решение**. Инициируйте отработку отказа с помощью портала из экземпляра Geo-Secondary.

### <a name="sql-agent-roles-need-explicit-execute-permissions-for-non-sysadmin-logins"></a>Ролям агента SQL требуются явные разрешения EXECUTE для имен для входа, отличных от системного администратора

Если имена входа, не относящиеся к sysadmin, добавляются в какие-либо предопределенные [роли базы данных агента SQL Server](/sql/ssms/agent/sql-server-agent-fixed-database-roles), существует проблема, в которой для работы этих имен входа необходимо предоставить явные разрешения на выполнение главным хранимым процедурам. В случае возникновения этой проблемы появляется сообщение об ошибке "недопустимое разрешение на выполнение объекта <object_name будет показано> (Microsoft SQL Server, ошибка: 229)".

**Решение**. После добавления имен входа в предопределенную роль базы данных агента SQL (SQLAgentUserRole, SQLAgentReaderRole или SQLAgentOperatorRole) для каждого имени входа, добавленного к этим ролям, выполните приведенный ниже скрипт T-SQL для явного предоставления разрешений на выполнение хранимым процедурам, перечисленным в списке.

```tsql
USE [master]
GO
CREATE USER [login_name] FOR LOGIN [login_name]
GO
GRANT EXECUTE ON master.dbo.xp_sqlagent_enum_jobs TO [login_name]
GRANT EXECUTE ON master.dbo.xp_sqlagent_is_starting TO [login_name]
GRANT EXECUTE ON master.dbo.xp_sqlagent_notify TO [login_name]
```

### <a name="sql-agent-jobs-can-be-interrupted-by-agent-process-restart"></a>Задания агента SQL Server могут быть прерваны с помощью перезапуска процесса агента

**(Разрешено в марте 2020)** При каждом запуске задания агент SQL Server создает новый сеанс, постепенно увеличивая потребление памяти. Чтобы избежать попадания в пределы внутренней памяти, которая блокирует выполнение запланированных заданий, процесс агента будет перезапущен после того, как потребление памяти достигнет порогового значения. Это может привести к прерыванию выполнения заданий, выполняемых в момент перезапуска.

### <a name="in-memory-oltp-memory-limits-are-not-applied"></a>Ограничения памяти выполняющейся в памяти OLTP не применяются

В некоторых случаях уровень служб критически важный для бизнеса не будет правильно применять [максимальные ограничения памяти для оптимизированных для памяти объектов](../managed-instance/resource-limits.md#in-memory-oltp-available-space) . SQL Управляемый экземпляр может позволить рабочей нагрузке использовать больше памяти для операций OLTP в памяти, что может повлиять на доступность и стабильность экземпляра. Запросы выполняющейся в памяти OLTP, которые достигли ограничений, могут не завершаться сбоем немедленно. Эта проблема будет исправлена в ближайшее время. Запросы, в которых используется больше памяти OLTP в памяти, будут завершаться сбоем быстрее, если достигнут [предел](../managed-instance/resource-limits.md#in-memory-oltp-available-space).

**Обходное решение**. [отслеживайте использование хранилища выполняющейся в памяти OLTP](../in-memory-oltp-monitor-space.md) с помощью [SQL Server Management Studio](/sql/relational-databases/in-memory-oltp/monitor-and-troubleshoot-memory-usage#bkmk_Monitoring) , чтобы убедиться, что Рабочая нагрузка не использует больше доступной памяти. Увеличьте ограничения памяти, зависящие от числа виртуальных ядер, или оптимизируйте рабочую нагрузку для использования меньшего объема памяти.
 
### <a name="wrong-error-returned-while-trying-to-remove-a-file-that-is-not-empty"></a>При попытке удаления непустого файла возвращена неверная ошибка

SQL Server и SQL Управляемый экземпляр [не позволяют пользователю удалять непустые файлы](/sql/relational-databases/databases/delete-data-or-log-files-from-a-database#Prerequisites). Если попытаться удалить непустой файл данных с помощью `ALTER DATABASE REMOVE FILE` инструкции, эта ошибка `Msg 5042 – The file '<file_name>' cannot be removed because it is not empty` не будет немедленно возвращена. SQL Управляемый экземпляр будет пытаться удалить файл, и операция завершится ошибкой через 30 минут с `Internal server error` .

Инструкции по **решению**: удалите содержимое файла с помощью `DBCC SHRINKFILE (N'<file_name>', EMPTYFILE)` команды. Если это единственный файл в файловой группе, необходимо удалить данные из таблицы или секции, связанной с этой группой файлов, перед сжатием файла и при необходимости загрузить эти данные в другую таблицу или секцию.

### <a name="change-service-tier-and-create-instance-operations-are-blocked-by-ongoing-database-restore"></a>Изменение уровня служб и операций создания экземпляра заблокировано текущим восстановлением базы данных

Непрерывная `RESTORE` инструкция, процесс миграции данных и встроенное восстановление на момент времени блокируют обновление уровня служб или изменение размера существующего экземпляра и создание новых экземпляров до завершения процесса восстановления. 

Процесс восстановления приведет к блокировке этих операций в управляемых экземплярах и пулах экземпляров в той же подсети, где выполняется процесс восстановления. Экземпляры в пулах экземпляров не затрагиваются. Операции создания или изменения уровня служб не будут завершаться сбоем или истечет время ожидания. После завершения или отмены процесса восстановления они будут продолжены.

**Решение**. Дождитесь завершения процесса восстановления или отмените процесс восстановления, если операция создания или обновления уровня службы имеет более высокий приоритет.

### <a name="resource-governor-on-business-critical-service-tier-might-need-to-be-reconfigured-after-failover"></a>Resource Governor на уровне служб критически важный для бизнеса может потребоваться перенастроить после отработки отказа

Функция [Resource Governor](/sql/relational-databases/resource-governor/resource-governor) , которая позволяет ограничить ресурсы, назначенные пользовательской рабочей нагрузке, может неправильно классифицировать определенную рабочую нагрузку пользователя после отработки отказа или изменения уровня обслуживания, инициированного пользователем (например, изменение максимального Виртуальное ядро или максимального размера хранилища экземпляра).

Инструкции по **решению**: периодически запускайте `ALTER RESOURCE GOVERNOR RECONFIGURE` или как часть задания агента SQL, которое выполняет задачу SQL при запуске экземпляра, если используется [Resource Governor](/sql/relational-databases/resource-governor/resource-governor).

### <a name="cross-database-service-broker-dialogs-must-be-reinitialized-after-service-tier-upgrade"></a>После обновления уровня службы необходимо повторно инициализировать диалоговые окна межбазовых Service Broker

Межбазовые Service Broker диалоговые окна перестают предоставлять сообщения службам в других базах данных после изменения уровня служб. Сообщения *не теряются*, и их можно найти в очереди отправителя. Любое изменение размера хранилища виртуальных ядер или экземпляра в SQL Управляемый экземпляр приведет к `service_broke_guid` изменению значения в представлении [sys. databases](/sql/relational-databases/system-catalog-views/sys-databases-transact-sql) для всех баз данных. Все `DIALOG` созданные с помощью инструкции [BEGIN DIALOG](/sql/t-sql/statements/begin-dialog-conversation-transact-sql) , которая ссылается на брокеры служб в другой базе данных, перестает доставлять сообщения целевой службе.

**Решение**. перед обновлением уровня службы завершите все действия, использующие диалоговые окна межбазовых Service Broker, и повторно инициализируйте их. Если остались сообщения, которые не доставляются после изменения уровня службы, прочтите сообщения из очереди источника и повторно отправьте их в целевую очередь.

### <a name="impersonation-of-azure-ad-login-types-is-not-supported"></a>Олицетворение типов входа Azure AD не поддерживается

Олицетворение с использованием `EXECUTE AS USER` или `EXECUTE AS LOGIN` следующих субъектов Azure Active Directory (Azure AD) не поддерживается:
-   Пользователи Azure AD с псевдонимами. В этом случае возвращается следующая ошибка: `15517` .
- Имена входа и пользователи Azure AD, основанные на приложениях или субъектах-службах Azure AD. В этом случае возвращаются следующие ошибки: `15517` и `15406` .

### <a name="query-parameter-not-supported-in-sp_send_db_mail"></a>@query параметр не поддерживается в sp_send_db_mail

`@query`Параметр в процедуре [sp_send_db_mail](/sql/relational-databases/system-stored-procedures/sp-send-dbmail-transact-sql) не работает.

### <a name="transactional-replication-must-be-reconfigured-after-geo-failover"></a>После географической отработки отказа необходимо перенастроить репликацию транзакций

Если для базы данных в группе автоматической отработки отказа включена репликация транзакций, администратор SQL Управляемый экземпляр должен очистить все публикации на старом первичном ресурсе и перенастроить их на новом первичном ресурсе после отработки отказа в другой регион. Дополнительные сведения см. в разделе [Replication](../managed-instance/transact-sql-tsql-differences-sql-server.md#replication).

### <a name="azure-ad-logins-and-users-are-not-supported-in-ssdt"></a>Имена для входа и пользователи Azure AD не поддерживаются в SSDT

SQL Server Data Tools не полностью поддерживают имена входа и пользователей Azure AD.

### <a name="temporary-database-is-used-during-restore-operation"></a>Во время операции восстановления используется временная база данных

При восстановлении базы данных в Управляемый экземпляр SQL Служба восстановления сначала создает пустую базу данных с требуемым именем для выделения имени экземпляра. Через некоторое время эта база данных будет удалена, и будет запущена восстановление фактической базы данных. 

База данных, которая находится в состоянии *восстановления* , временно имеет случайное значение идентификатора GUID вместо имени. После завершения процесса восстановления временное имя изменится на требуемое имя, указанное в `RESTORE` инструкции. 

На начальном этапе пользователь может получить доступ к пустой базе данных и даже создать таблицы или загрузить данные в эту базу данных. Эта временная база данных будет удалена, когда служба восстановления запустит второй этап.

Инструкции по решению: не **пытайтесь** получить доступ к восстанавливаемой базе данных до тех пор, пока не будет показано, что восстановление завершено.

### <a name="tempdb-structure-and-content-is-re-created"></a>Структура и содержимое базы данных TEMPDB создано повторно

`tempdb`База данных всегда разделяется на 12 файлов данных, и структура файла не может быть изменена. Максимальный размер для файла нельзя изменить, и новые файлы нельзя добавить в `tempdb` . `Tempdb` всегда создается повторно как пустая база данных при запуске или отработки отказа экземпляра, а любые изменения, внесенные в, `tempdb` не сохраняются.

### <a name="exceeding-storage-space-with-small-database-files"></a>Превышение дискового пространства с небольшими файлами баз данных

`CREATE DATABASE``ALTER DATABASE ADD FILE`инструкции, и `RESTORE DATABASE` могут завершиться ошибкой, так как экземпляр может достигнуть ограничения хранилища Azure.

Каждый экземпляр общего назначения SQL Управляемый экземпляр имеет до 35 ТБ хранилища, зарезервированного для дискового пространства Azure уровня "Премиум". Каждый файл базы данных размещается на отдельном физическом диске. Поддерживаются диски размером 128 ГБ, 256 ГБ, 512 ГБ, 1 ТБ или 4 ТБ. Неиспользуемое пространство на диске не заряжено, но общая сумма размеров дисков Azure уровня "Премиум" не может превышать 35 ТБ. В некоторых случаях управляемый экземпляр, для которого не требуется 8 ТБ, может превысить ограничение в 35 ТБ на размер хранилища из-за внутренней фрагментации.

Например, экземпляр общего назначения SQL Управляемый экземпляр может иметь один большой файл размером 1,2 ТБ, размещенный на диске объемом 4 ТБ. У него также может быть 248 файлов размером 1 ГБ, которые помещаются на отдельные диски размером 128 ГБ. В этом примере:

- общий размер выделенного дискового хранилища составляет 1 x 4 ТБ + 248 x 128 ГБ = 35 ТБ;
- общий объем зарезервированного пространства для баз данных в экземпляре составляет 1 x 1,2 ТБ + 248 x 1 ГБ = 1,4 ТБ.

В этом примере показано, что в некоторых случаях из-за определенного распределения файлов экземпляр SQL Управляемый экземпляр может достичь ограничения в 35 ТБ, которое зарезервировано для подключенного диска Azure уровня "Премиум", если вы можете не ожидать его.

В этом примере существующие базы данных продолжают работать и могут увеличиваться без каких бы то ни было проблем, пока новые файлы не добавляются. Новые базы данных не могут быть созданы или восстановлены, так как не хватает места для новых дисков, даже если общий размер всех баз данных не достигает предельного размера экземпляра. Ошибка, возвращаемая в этом случае, не ясно.

[Количество оставшихся файлов можно узнать](https://medium.com/azure-sqldb-managed-instance/how-many-files-you-can-create-in-general-purpose-azure-sql-managed-instance-e1c7c32886c1) с помощью системных представлений. Если вы достигли этого ограничения, попытайтесь [удалить некоторые файлы меньшего размера с помощью инструкции DBCC SHRINKFILE](/sql/t-sql/database-console-commands/dbcc-shrinkfile-transact-sql#d-emptying-a-file) или переключитесь на [уровень критически важный для бизнеса, который не имеет этого ограничения](../managed-instance/resource-limits.md#service-tier-characteristics).

### <a name="guid-values-shown-instead-of-database-names"></a>Значения GUID, отображаемые вместо имен баз данных

Несколько системных представлений, счетчиков производительности, сообщений об ошибках, XEvents и записей в журнале ошибок отображают идентификаторы базы данных GUID вместо фактических имен базы данных. Не полагайтесь на эти идентификаторы GUID, так как они заменяются фактическими именами баз данных в будущем.

**Обходное решение**. Используйте представление sys. databases для разрешения фактического имени базы данных из имени физической базы данных, указанного в виде идентификаторов базы данных GUID:

```tsql
SELECT name as ActualDatabaseName, physical_database_name as GUIDDatabaseIdentifier 
FROM sys.databases
WHERE database_id > 4
```

### <a name="error-logs-arent-persisted"></a>Журналы ошибок не сохраняются

Журналы ошибок, доступные в Управляемый экземпляр SQL, не сохраняются, и их размер не включается в максимальный предел. Если происходит отработка отказа, журналы ошибок могут автоматически удаляться. В журнале ошибок могут содержаться пробелы, так как SQL Управляемый экземпляр были перемещены несколько раз на несколько виртуальных машин.

### <a name="transaction-scope-on-two-databases-within-the-same-instance-isnt-supported"></a>Область транзакций в двух базах данных в одном и том же экземпляре не поддерживается

**(Разрешено в марте 2020)** `TransactionScope` Класс в .NET не работает, если два запроса отправляются в две базы данных в одном экземпляре в одной и той же области транзакций:

```csharp
using (var scope = new TransactionScope())
{
    using (var conn1 = new SqlConnection("Server=quickstartbmi.neu15011648751ff.database.windows.net;Database=b;User ID=myuser;Password=mypassword;Encrypt=true"))
    {
        conn1.Open();
        SqlCommand cmd1 = conn1.CreateCommand();
        cmd1.CommandText = string.Format("insert into T1 values(1)");
        cmd1.ExecuteNonQuery();
    }

    using (var conn2 = new SqlConnection("Server=quickstartbmi.neu15011648751ff.database.windows.net;Database=b;User ID=myuser;Password=mypassword;Encrypt=true"))
    {
        conn2.Open();
        var cmd2 = conn2.CreateCommand();
        cmd2.CommandText = string.Format("insert into b.dbo.T2 values(2)");        cmd2.ExecuteNonQuery();
    }

    scope.Complete();
}

```

**Обходной путь (не требуется с 2020 марта)**: используйте [SqlConnection. чанжедатабасе (String)](/dotnet/api/system.data.sqlclient.sqlconnection.changedatabase) для использования другой базы данных в контексте соединения вместо двух соединений.

### <a name="clr-modules-and-linked-servers-sometimes-cant-reference-a-local-ip-address"></a>Модули CLR и связанные серверы иногда не могут ссылаться на локальный IP-адрес.

Модули CLR в SQL Управляемый экземпляр и связанные серверы или распределенные запросы, которые ссылаются на текущий экземпляр, иногда не могут разрешить IP-адрес локального экземпляра. Это временная ошибка.

**Обходное решение**. по возможности используйте контекстные соединения в модуле CLR.

## <a name="updates"></a>Обновления

Список обновлений и улучшений базы данных SQL см. в статье [обновления службы базы данных SQL](https://azure.microsoft.com/updates/?product=sql-database).

Обновления и улучшения для всех служб Azure см. в разделе [обновления служб](https://azure.microsoft.com/updates).

## <a name="contribute-to-content"></a>Участие в разработке документации

Сведения о том, как внести изменения в документацию по SQL Azure, см. в [руководстве для участников](/contribute/)документации.
