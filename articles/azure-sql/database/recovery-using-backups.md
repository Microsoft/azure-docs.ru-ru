---
title: Восстановление базы данных из резервной копии
titleSuffix: Azure SQL Database & SQL Managed Instance
description: Узнайте о восстановлении до точки во времени, которое позволяет выполнить откат базы данных в базе данных SQL Azure или экземпляра в Azure SQL Управляемый экземпляр до 35 дней.
services: sql-database
ms.service: sql-db-mi
ms.subservice: service
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: anosov1960
ms.author: sashan
ms.reviewer: mathoma, sstein, danil
ms.date: 11/13/2020
ms.openlocfilehash: 0c3db3b3f22f9f2639012068924708537f9ada77
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "98795330"
---
# <a name="recover-using-automated-database-backups---azure-sql-database--sql-managed-instance"></a>Восстановление с помощью автоматически создаваемых резервных копий базы данных SQL Azure & SQL Управляемый экземпляр
[!INCLUDE[appliesto-sqldb-sqlmi](../includes/appliesto-sqldb-sqlmi.md)]

Для восстановления базы данных доступны следующие параметры с помощью автоматически создаваемых [резервных копий базы данных](automated-backups-overview.md). Вы можете:

- Создайте новую базу данных на том же сервере, восстановленную до указанной точки во времени в течение срока хранения.
- Создайте базу данных на том же сервере, восстановленную до времени удаления для удаленной базы данных.
- Создание новой базы данных на любом сервере в том же регионе, восстановленной до момента последнего резервного копирования.
- Создайте новую базу данных на любом сервере в любом другом регионе, восстановленную до момента последнего реплицированного резервного копирования.

Если вы настроили [долгосрочное хранение резервных копий](long-term-retention-overview.md), можно также создать новую базу данных на основе любой долгосрочной резервной копии хранения на любом сервере.

> [!IMPORTANT]
> Невозможно перезаписать существующую базу данных во время восстановления.

Если вы используете уровень служб "Стандартный" или "Премиум", восстановление базы данных может привести к дополнительным затратам на хранение. Дополнительные затраты создаются, если максимальный размер восстанавливаемой базы данных превышает объем хранилища, включенный в уровень служб и производительности целевой базы данных. Сведения о ценах на дополнительное хранилище см. на [странице цен на Базу данных SQL](https://azure.microsoft.com/pricing/details/sql-database/). Если фактический объем используемого пространства меньше, чем Включенный объем хранилища, можно избежать этой дополнительной платы, установив максимальный размер базы данных в включенном объеме.

## <a name="recovery-time"></a>Время восстановления

Время восстановления базы данных с помощью автоматически создаваемых резервных копий зависит от ряда факторов.

- Размер базы данных.
- Размер вычислений базы данных.
- Количество задействованных журналов транзакций.
- Объем действий, которые необходимо воспроизвести для восстановления до точки восстановления.
- Пропускная способность сети, если восстановление происходит в другой регион.
- количество одновременных запросов на восстановление, обрабатываемых в целевом регионе.

Для большой или очень активной базы данных восстановление может занять несколько часов. В случае длительного простоя в регионе может быть инициировано большое количество запросов геовосстановления для аварийного восстановления. При наличии большого числа запросов время восстановления отдельных баз данных может увеличиться. Большинство восстановлений баз данных завершается менее чем через 12 часов.

Для одной подписки существуют ограничения на количество одновременных запросов на восстановление. Эти ограничения применяются к любому сочетанию восстановления на момент времени, георепликации и восстановления из резервной копии долгосрочного хранения.

| **Параметр развертывания** | **Максимальное количество одновременно обрабатываемых запросов** | **Максимальное количество одновременно отправляемых запросов** |
| :--- | --: | --: |
|**Отдельная база данных (на подписку)**|30|100|
|**Эластичный пул (на пул)**|4|2000|


Нет встроенного метода для восстановления всего сервера. Пример выполнения этой задачи см. в статье [база данных SQL Azure: полное восстановление сервера](https://gallery.technet.microsoft.com/Azure-SQL-Database-Full-82941666).

> [!IMPORTANT]
> Чтобы выполнить восстановление с помощью автоматически создаваемых резервных копий, необходимо быть членом роли SQL Server участник или SQL Управляемый экземпляр участник (в зависимости от назначения восстановления) в подписке, или же вы должны быть владельцем подписки. Дополнительные сведения см. в статье о [встроенных ролях в Azure RBAC](../../role-based-access-control/built-in-roles.md). Восстановление можно выполнить с помощью портал Azure, PowerShell или REST API. Нельзя использовать Transact-SQL.

## <a name="point-in-time-restore"></a>Восстановление на момент времени

Вы можете восстановить изолированную базу данных, которая находится в пуле или экземпляре, до более ранней точки во времени с помощью портал Azure, [PowerShell](/powershell/module/az.sql/restore-azsqldatabase)или [REST API](/rest/api/sql/databases/createorupdate#creates-a-database-from-pointintimerestore.). Запрос может указывать любой уровень служб или размер вычислений для восстанавливаемой базы данных. Убедитесь в наличии достаточного количества ресурсов на сервере, на котором выполняется восстановление базы данных. 

По завершении инструкция RESTORE создает новую базу данных на том же сервере, что и исходная база данных. В восстановленной базе данных оплаты начисляются по нормальным тарифам, исходя из уровня служб и размера вычислений. Плата не взимается, пока восстановление базы данных не будет завершено.

Обычно база данных восстанавливается до более ранней точки во времени. Восстановленную базу данных можно считать заменой исходной базы данных или использовать ее в качестве источника данных для обновления исходной базы данных.

- **Замена базы данных**

  Если восстанавливаемая база данных планируется заменить исходной базой данных, следует указать размер вычислений и уровень служб исходной базы данных. Затем можно переименовать исходную базу данных и присвоить восстановленной базе данных исходное имя с помощью команды [ALTER DATABASE](/sql/t-sql/statements/alter-database-azure-sql-database) в T-SQL.

- **Восстановление данных**

  Если планируется получение данных из восстановленной базы данных для восстановления после ошибки пользователя или приложения, необходимо написать и выполнить сценарий восстановления данных, который извлекает данные из восстановленной базы данных и применяется к исходной базе данных. Несмотря на то, что операция восстановления может занять много времени, восстанавливаемая база данных будет отображаться в списке баз данных на протяжении всего процесса. Если удалить базу данных во время восстановления, операция восстановления будет отменена, и не будет взиматься дополнительная стоимость базы данных, которая не выполнила восстановление.
  
### <a name="point-in-time-restore-by-using-azure-portal"></a>Восстановление до точки во времени с помощью портал Azure

Можно восстановить одну базу данных или экземпляр до точки во времени из колонки обзора базы данных, которую необходимо восстановить в портал Azure.

#### <a name="sql-database"></a>База данных SQL

Чтобы восстановить базу данных до точки во времени с помощью портал Azure, откройте страницу Обзор базы данных и на панели инструментов выберите **восстановить** . Выберите источник резервного копирования и выберите точку резервного копирования на момент времени, из которой будет создана новая база данных.

  ![Снимок экрана параметров восстановления базы данных SQL.](./media/recovery-using-backups/pitr-backup-sql-database-annotated.png)

#### <a name="sql-managed-instance"></a>Управляемый экземпляр SQL

Чтобы восстановить базу данных управляемого экземпляра до точки во времени с помощью портал Azure, откройте страницу Обзор базы данных и выберите **восстановить** на панели инструментов. Выберите точку резервного копирования на момент времени, из которой будет создана новая база данных.

  ![Снимок экрана параметров восстановления базы данных для управляемого экземпляра SQL.](./media/recovery-using-backups/pitr-backup-managed-instance-annotated.png)

> [!TIP]
> Сведения о программном восстановлении базы данных из резервной копии см. в статье [программное восстановление с помощью автоматических резервных копий](recovery-using-backups.md)

## <a name="deleted-database-restore"></a>Восстановление удаленной базы данных

Можно восстановить удаленную базу данных до времени удаления или более ранней точки во времени на том же сервере или в том же управляемом экземпляре. Это можно сделать с помощью портал Azure, [PowerShell](/powershell/module/az.sql/restore-azsqldatabase)или [остальных (CreateMode = Restore)](/rest/api/sql/databases/createorupdate). Чтобы восстановить удаленную базу данных, создайте новую базу данных из резервной копии.

> [!IMPORTANT]
> При удалении сервера или управляемого экземпляра все его базы данных также удаляются и не могут быть восстановлены. Нельзя восстановить удаленный сервер или управляемый экземпляр.

### <a name="deleted-database-restore-by-using-the-azure-portal"></a>Восстановление базы данных удалено с помощью портал Azure

Удаленные базы данных восстанавливаются из портал Azure из ресурса сервера или управляемого экземпляра.

> [!TIP]
> Чтобы недавно удаленные базы данных отображались на странице **Удаленные базы данных** в портал Azure или при [программном](#programmatic-recovery-using-automated-backups)отображении удаленных баз данных, может потребоваться несколько минут.

#### <a name="sql-database"></a>База данных SQL

Чтобы восстановить удаленную базу данных до времени удаления с помощью портал Azure, откройте страницу Обзор сервера и выберите **Удаленные базы данных**. Выберите удаленную базу данных, которую требуется восстановить, и введите имя новой базы данных, которая будет создана с помощью данных, восстановленных из резервной копии.

  ![Снимок экрана: восстановление удаленной базы данных](./media/recovery-using-backups/restore-deleted-sql-database-annotated.png)

#### <a name="sql-managed-instance"></a>Управляемый экземпляр SQL

Чтобы восстановить управляемую базу данных с помощью портал Azure, откройте страницу Обзор управляемого экземпляра и выберите **Удаленные базы данных**. Выберите удаленную базу данных, которую требуется восстановить, и введите имя новой базы данных, которая будет создана с помощью данных, восстановленных из резервной копии.

  ![Снимок экрана: восстановление удаленных баз данных SQL Управляемый экземпляр Azure](./media/recovery-using-backups/restore-deleted-sql-managed-instance-annotated.png)

### <a name="deleted-database-restore-by-using-powershell"></a>Восстановление базы данных удалено с помощью PowerShell

Используйте приведенные ниже примеры сценариев для восстановления удаленной базы данных для базы данных SQL или SQL Управляемый экземпляр с помощью PowerShell.

#### <a name="sql-database"></a>База данных SQL

Пример сценария PowerShell, демонстрирующий восстановление удаленной базы данных в базе данных SQL Azure, см. в статье [Восстановление базы данных с помощью PowerShell](scripts/restore-database-powershell.md).

#### <a name="sql-managed-instance"></a>Управляемый экземпляр SQL

Пример сценария PowerShell, демонстрирующий восстановление удаленной базы данных экземпляра, см. в разделе [Восстановление базы данных удаленных экземпляров с помощью PowerShell](../managed-instance/point-in-time-restore.md#restore-a-deleted-database) .

> [!TIP]
> Сведения о программном восстановлении удаленной базы данных см. в разделе [программное выполнение восстановления с помощью автоматических резервных копий](recovery-using-backups.md).

## <a name="geo-restore"></a>Геовосстановление

> [!IMPORTANT]
> Геовосстановление доступно только для баз данных SQL или управляемых экземпляров, настроенных с геоизбыточным [хранилищем резервных копий](automated-backups-overview.md#backup-storage-redundancy).

Можно восстановить базу данных на любом сервере базы данных SQL или экземпляре базы данных на любом управляемом экземпляре в любом регионе Azure из самых последних геореплицированных резервных копий. При геовосстановлении используется геореплицированная резервная копия в качестве источника. Вы можете запрашивать геовосстановление, даже если база данных или Datacenter недоступны из-за сбоя.

Геовосстановление является параметром восстановления по умолчанию, если база данных недоступна из-за инцидента в регионе размещения. Базу данных можно восстановить на сервере в любом другом регионе. Между созданием резервной копии и ее георепликацией в большой двоичный объект Azure в другом регионе существует задержка. В результате восстановленная база данных может иметь один час за исходной базой данных. На следующем рисунке показана восстановление базы данных из последней доступной резервной копии в другом регионе.

![Рисунок географического восстановления](./media/recovery-using-backups/geo-restore-2.png)

### <a name="geo-restore-by-using-the-azure-portal"></a>Геовосстановление с помощью портал Azure

На портал Azure создайте новую базу данных с одним или управляемым экземпляром и выберите доступную резервную копию геовосстановления. Созданная база данных содержит данные географической резервной копии.

#### <a name="sql-database"></a>База данных SQL

Для геовосстановления отдельной базы данных из портал Azure в выбранном регионе и сервере выполните следующие действия.

1. На **панели мониторинга** выберите **Добавить**  >  **создать базу данных SQL**. На вкладке **основные** сведения введите необходимые данные.
2. выберите **Дополнительные параметры**;
3. Для **использования существующих данных** выберите **резервное копирование**.
4. В поле **резервное копирование** выберите резервную копию из списка доступных резервных копий геовосстановления.

    ![Снимок экрана: Создание параметров базы данных SQL](./media/recovery-using-backups/geo-restore-azure-sql-database-list-annotated.png)

Завершите процесс создания новой базы данных из резервной копии. При создании базы данных в базе данных SQL Azure она содержит восстановленную резервную копию геовосстановления.

#### <a name="sql-managed-instance"></a>Управляемый экземпляр SQL

Для геовосстановления базы данных управляемого экземпляра из портал Azure в существующий управляемый экземпляр в выбранном регионе выберите управляемый экземпляр, на котором нужно восстановить базу данных. Выполните следующие действия.

1. Выберите **создать базу данных**.
2. Введите имя нужной базы данных.
3. В разделе **использовать существующие данные** выберите **резервное копирование**.
4. Выберите резервную копию из списка доступных резервных копий геовосстановления.

    ![Снимок экрана: параметры новой базы данных](./media/recovery-using-backups/geo-restore-sql-managed-instance-list-annotated.png)

Завершите процесс создания новой базы данных. При создании базы данных экземпляра она содержит восстановленную резервную копию геовосстановления.

### <a name="geo-restore-by-using-powershell"></a>Геовосстановление с помощью PowerShell

#### <a name="sql-database"></a>База данных SQL

Сценарий PowerShell, который показывает, как выполнить геовосстановление для отдельной базы данных, см. в статье [Использование PowerShell для восстановления одной базы данных на более раннюю точку во времени](scripts/restore-database-powershell.md).

#### <a name="sql-managed-instance"></a>Управляемый экземпляр SQL

Сценарий PowerShell, который показывает, как выполнить геовосстановление для базы данных управляемого экземпляра, см. в статье [Использование PowerShell для восстановления базы данных управляемого экземпляра в другой географическую область](../managed-instance/scripts/restore-geo-backup.md).

### <a name="geo-restore-considerations"></a>Рекомендации относительно географического восстановления

Невозможно выполнить восстановление на момент времени в базе данных-получателе с георепликацией. Это можно сделать только в базе данных-источнике. Дополнительные сведения об использовании геовосстановления для восстановления после сбоя см. в статье [Восстановление базы данных SQL Azure или переход на базу данных-получатель при отказе](../../key-vault/general/disaster-recovery-guidance.md).

> [!IMPORTANT]
> Геовосстановление — это базовое решение аварийного восстановления, доступное в базе данных SQL и Управляемый экземпляр SQL. Он использует автоматически созданные геореплицированные резервные копии с целевой точкой восстановления (RPO) вплоть до 1 часа и оценочное время восстановления до 12 часов. Это не гарантирует, что целевой регион будет иметь емкость для восстановления баз данных после регионального сбоя, так как, скорее всего, будет резко возрастать потребность. Если приложение использует относительно небольшие базы данных и не является критически важным для бизнеса, геовосстановление является подходящим решением аварийного восстановления. 
>
> Для критически важных для бизнеса приложений, требующих больших баз данных и обеспечивающих непрерывность бизнес-процессов, используйте [группы автоматической отработки отказа](auto-failover-group-overview.md). Она предлагает более низкие целевые значения RPO и времени восстановления, и емкость всегда гарантирована. 
>
> Дополнительные сведения о вариантах непрерывности бизнес-процессов см. в разделе [Обзор непрерывности бизнес-процессов](business-continuity-high-availability-disaster-recover-hadr-overview.md).

## <a name="programmatic-recovery-using-automated-backups"></a>Программное восстановление с помощью автоматически создаваемых резервных копий

Для восстановления можно также использовать Azure PowerShell или REST API. В приведенных ниже таблицах описан доступный для этого набор команд.

### <a name="powershell"></a>PowerShell

[!INCLUDE [updated-for-az](../../../includes/updated-for-az.md)]
> [!IMPORTANT]
> Модуль PowerShell Azure Resource Manager по-прежнему поддерживается базой данных SQL и Управляемый экземпляр SQL, но вся будущая разработка предназначена для модуля AZ. SQL. Сведения об этих командлетах см. в разделе [AzureRM.Sql](/powershell/module/AzureRM.Sql/). Аргументы для команд в модуле AZ и в модулях Azure Resource Manager находятся в отличном экстенте.

#### <a name="sql-database"></a>База данных SQL

Сведения о восстановлении изолированной базы данных или в составе пула см. в разделе [RESTORE-азсклдатабасе](/powershell/module/az.sql/restore-azsqldatabase).

  | Командлет | Описание |
  | --- | --- |
  | [Get-AzSqlDatabase](/powershell/module/az.sql/get-azsqldatabase) |Получает одну или несколько баз данных. |
  | [Get-AzSqlDeletedDatabaseBackup](/powershell/module/az.sql/get-azsqldeleteddatabasebackup) | Получает удаленную базу данных, которую можно восстановить. |
  | [Get-AzSqlDatabaseGeoBackup](/powershell/module/az.sql/get-azsqldatabasegeobackup) |Получает геоизбыточную резервную копию базы данных. |
  | [Restore-AzSqlDatabase](/powershell/module/az.sql/restore-azsqldatabase) |Восстанавливает базу данных. |

  > [!TIP]
  > Пример сценария PowerShell, который показывает, как выполнить восстановление базы данных на момент времени, см. в разделе [Восстановление базы данных с помощью PowerShell](scripts/restore-database-powershell.md).

#### <a name="sql-managed-instance"></a>Управляемый экземпляр SQL

Сведения о восстановлении базы данных управляемого экземпляра см. в разделе [RESTORE-азсклинстанцедатабасе](/powershell/module/az.sql/restore-azsqlinstancedatabase).

  | Командлет | Описание |
  | --- | --- |
  | [Get-AzSqlInstance](/powershell/module/az.sql/get-azsqlinstance) |Возвращает один или несколько управляемых экземпляров. |
  | [Get-Азсклинстанцедатабасе](/powershell/module/az.sql/get-azsqlinstancedatabase) | Возвращает базу данных экземпляра. |
  | [Restore-AzSqlInstanceDatabase](/powershell/module/az.sql/restore-azsqlinstancedatabase) |Восстанавливает базу данных экземпляра. |

### <a name="rest-api"></a>REST API

Чтобы восстановить базу данных с помощью REST API, выполните следующие действия.

| API | Описание |
| --- | --- |
| [REST (createMode=Recovery)](/rest/api/sql/databases) |Восстанавливает базу данных. |
| [Получение, создание или обновление состояния базы данных](/rest/api/sql/operations) |Возвращает состояние во время операции восстановления. |

### <a name="azure-cli"></a>Azure CLI

#### <a name="sql-database"></a>База данных SQL

Инструкции по восстановлению базы данных с помощью Azure CLI см. в разделе [AZ SQL DB Restore](/cli/azure/sql/db#az-sql-db-restore).

#### <a name="sql-managed-instance"></a>Управляемый экземпляр SQL

Инструкции по восстановлению базы данных управляемого экземпляра с помощью Azure CLI см. в разделе [AZ SQL функция MidB Restore](/cli/azure/sql/midb#az-sql-midb-restore).

## <a name="summary"></a>Итоги

Создаваемые автоматически резервные копии позволяют защитить базы данных от ошибок пользователей и приложений, случайного удаления базы данных и длительных простоев. Эта встроенная возможность доступна для всех уровней служб и объемов вычислительных ресурсов.

## <a name="next-steps"></a>Дальнейшие действия

- [Общие сведения о непрерывности бизнес-процессов](business-continuity-high-availability-disaster-recover-hadr-overview.md)
- [Общие сведения об автоматическом резервном копировании базы данных SQL](automated-backups-overview.md)
- [Долгосрочное хранение](long-term-retention-overview.md)
- Чтобы узнать о более быстрых вариантах восстановления, ознакомьтесь со сведениями об [активной георепликации](active-geo-replication-overview.md) и [группах автоматической отработки отказа](auto-failover-group-overview.md).
