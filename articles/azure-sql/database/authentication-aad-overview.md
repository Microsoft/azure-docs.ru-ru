---
title: Проверка подлинности Azure Active Directory
description: Узнайте, как использовать Azure Active Directory для проверки подлинности с помощью базы данных SQL Azure, Управляемый экземпляр SQL Azure и синапсе SQL в Azure синапсе Analytics.
services: sql-database
ms.service: sql-db-mi
ms.subservice: security
ms.custom: azure-synapse, sqldbrb=1
ms.devlang: ''
ms.topic: how-to
author: GithubMirek
ms.author: mireks
ms.reviewer: vanto, sstein
ms.date: 04/23/2020
ms.openlocfilehash: a636c0e2a41b636f30ada14d4f16a022f2890b71
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "96454301"
---
# <a name="use-azure-active-directory-authentication"></a>Использовать проверку подлинности Azure Active Directory

[!INCLUDE[appliesto-sqldb-sqlmi-asa](../includes/appliesto-sqldb-sqlmi-asa.md)]

Проверка подлинности Azure Active Directory (Azure AD) — это механизм подключения к [базе данных SQL](sql-database-paas-overview.md)Azure, [Azure SQL управляемый экземпляр](../managed-instance/sql-managed-instance-paas-overview.md)и [синапсе SQL в Azure синапсе Analytics](../../synapse-analytics/sql-data-warehouse/sql-data-warehouse-overview-what-is.md) с помощью удостоверений в Azure AD.

> [!NOTE]
> Эта статья относится к базе данных SQL Azure, Управляемый экземпляр SQL и Azure синапсе Analytics.

С помощью проверки подлинности Azure AD можно централизованно управлять удостоверениями пользователей базы данных и другими службами Майкрософт. Централизованное управление удостоверениями позволяет использовать единое расположение для управления пользователями и упрощает управление разрешениями. Это дает такие преимущества:

- наличие альтернативного варианта проверки подлинности SQL Server;
- Это помогает предотвратить увеличение числа удостоверений пользователей на серверах.
- возможность смены паролей в одном месте;
- клиенты могут управлять разрешениями базы данных с помощью внешних групп (Azure AD);
- возможность исключить хранение паролей с помощью встроенной проверки подлинности Windows и других видов проверки подлинности, поддерживаемых Azure Active Directory;
- При проверке подлинности Azure AD используются данные пользователей автономной базы данных для проверки подлинности удостоверений на уровне базы данных.
- Azure AD поддерживает проверку подлинности на основе маркеров для приложений, подключающихся к базе данных SQL и Управляемый экземпляр SQL.
- Проверка подлинности Azure AD поддерживает:
  - Удостоверения Azure AD в облаке.
  - Гибридные удостоверения Azure AD, которые поддерживают:
    - Проверка подлинности в облаке с двумя параметрами с помощью простой **сквозной** проверки подлинности единого входа и проверки подлинности **хэша паролей** .
    - Федеративная проверка подлинности.
  - Дополнительные сведения о методах проверки подлинности Azure AD и их выборе см. в следующей статье:
    - [Выбор правильного метода аутентификации для гибридного решения для идентификации Azure Active Directory](../../active-directory/hybrid/choose-ad-authn.md)

- Azure AD поддерживает подключения из SQL Server Management Studio, использующие универсальную аутентификацию Active Directory, в том числе Многофакторную идентификацию. Многофакторная идентификация включает надежную проверку подлинности с помощью ряда простых вариантов проверки — телефонного звонка, текстового сообщения, смарт-карт с ПИН-кодом или уведомления мобильного приложения. Дополнительные сведения см. [в статье поддержка SSMS для многофакторной идентификации Azure AD с помощью базы данных SQL Azure, sql управляемый экземпляр и Azure синапсе](authentication-mfa-ssms-overview.md) .

- Azure AD поддерживает аналогичные подключения из SQL Server Data Tools (SSDT), использующие интерактивную аутентификацию Active Directory. Дополнительные сведения см. [в разделе поддержка Azure Active Directory в SQL Server Data Tools (SSDT)](/sql/ssdt/azure-active-directory) .

> [!NOTE]  
> Подключение к экземпляру SQL Server, работающему на виртуальной машине Azure, не поддерживается при использовании учетной записи Azure Active Directory. Вместо этого используйте учетную запись домена Active Directory.  

Для настройки и использования проверки подлинности Azure Active Directory выполните следующие действия.

1. Создайте и заполните каталог Azure AD.
2. Свяжите или измените каталог Active Directory, который сейчас связан с вашей подпиской Azure (этот шаг можно пропустить).
3. Создайте администратора Azure Active Directory.
4. Настройте клиентские компьютеры.
5. Создайте учетные записи пользователей автономной базы данных в базе данных, сопоставленной с удостоверениями Azure AD.
6. Подключитесь к базе данных с помощью удостоверений Azure AD.

> [!NOTE]
> Сведения о том, как создать и заполнить Azure AD, а затем настроить Azure AD с помощью базы данных SQL Azure, SQL Управляемый экземпляр и синапсе SQL в Azure синапсе Analytics, см. в статье [Настройка Azure AD с базой данных SQL Azure](authentication-aad-configure.md).

## <a name="trust-architecture"></a>Архитектура доверия

- Только облачная часть Azure AD, база данных SQL, SQL Управляемый экземпляр и Azure синапсе поддерживают пароли собственных пользователей Azure AD.
- Для поддержки учетных данных единого входа Windows (или пользователя или пароля для учетных данных Windows) используйте учетные данные Azure Active Directory из федеративного или управляемого домена, для которого настроен простой единый вход и проверка подлинности с помощью хэширования паролей. Дополнительные сведения см. в разделе [Устранение неполадок с простым единым входом Azure Active Directory](../../active-directory/hybrid/how-to-connect-sso.md).
- Для поддержки федеративной проверки подлинности (или имени пользователя и пароля в качестве учетных данных Windows) требуется взаимодействие с блоком ADFS.

Дополнительные сведения об гибридных удостоверениях Azure AD, установке и синхронизации см. в следующих статьях:

- Проверка подлинности хэша пароля. [Реализация синхронизации хэшей паролей с Azure AD Connect синхронизацией](../../active-directory/hybrid/how-to-connect-password-hash-synchronization.md)
- Сквозная проверка подлинности — [Azure Active Directory сквозная проверка подлинности](../../active-directory/hybrid/how-to-connect-pta-quick-start.md)
- Федеративная проверка подлинности. [развертывание службы федерации Active Directory (AD FS) в Azure](/windows-server/identity/ad-fs/deployment/how-to-connect-fed-azure-adfs) и [Azure AD Connect и Федерации](../../active-directory/hybrid/how-to-connect-fed-whatis.md)

Пример федеративной проверки подлинности с помощью инфраструктуры ADFS (или пользователя или пароля для учетных данных Windows) см. на приведенной ниже схеме. Стрелки обозначают пути обмена данными.

![схема проверки подлинности aad][1]

На следующей схеме показаны федерация, отношения доверия и отношения размещения. Все эти компоненты позволяют клиенту подключиться к базе данных, отправив маркер. Маркер проходит аутентификацию в Azure AD и становится доверенным для базы данных. Клиент 1 может представлять каталог Azure AD с собственными пользователями или федеративными пользователями. Клиент 2 представляет возможное решение, включая импортированных пользователей, из этого примера, поступающих из федеративного Azure Active Directory с ADFS, которые синхронизируются с Azure Active Directory. Важно понимать, что для доступа к базе данных с использованием проверки подлинности Azure AD необходимо связать подписку размещения с Azure AD. Для создания базы данных SQL Azure, Управляемый экземпляр SQL или ресурсов Azure синапсе необходимо использовать ту же подписку.

![отношение подписки][2]

## <a name="administrator-structure"></a>Структура администраторов

При использовании аутентификации Azure AD существует две учетные записи администратора: исходный администратор базы данных SQL Azure и администратор Azure AD. Те же принципы применимы к Azure синапсе. Создать в пользовательской базе данных первого пользователя автономной базы данных Azure AD может только администратор с учетной записью Azure AD. Администратор Azure AD может использовать для входа имя пользователя Azure AD или имя группы Azure AD. Если администратор является учетной записью группы, он может использоваться любым участником группы, что позволяет использовать несколько администраторов Azure AD для сервера. Использование учетной записи группы в качестве администратора повышает управляемость, позволяя централизованно добавлять и удалять членов группы в Azure AD без изменения пользователей или разрешений в базе данных SQL или Azure синапсе. За один раз можно настроить только одного администратора Azure AD (пользователя или группу).

![структура администраторов][3]

## <a name="permissions"></a>Разрешения

Чтобы создавать новых пользователей, у вас должно быть разрешение `ALTER ANY USER` в базе данных. Разрешение `ALTER ANY USER` можно предоставить любому пользователю базы данных. Разрешение `ALTER ANY USER` также предоставляется учетным записям администратора сервера и пользователям базы данных с разрешениями `CONTROL ON DATABASE` или `ALTER ON DATABASE` для этой базы данных, а также участникам роли `db_owner` в базе данных.

Чтобы создать пользователя автономной базы данных в базе данных SQL Azure, SQL Управляемый экземпляр или Azure синапсе, необходимо подключиться к базе данных или экземпляру с помощью удостоверения Azure AD. Чтобы создать первого пользователя автономной базы данных, необходимо подключиться к ней с использованием учетной записи администратора Azure AD (который является владельцем базы данных). Это продемонстрировано в [настройке и управлении проверкой подлинности Azure Active Directory с помощью базы данных SQL или Azure синапсе](authentication-aad-configure.md). Проверка подлинности Azure AD возможна, только если администратор Azure AD создан для базы данных SQL Azure, Управляемый экземпляр SQL или Azure синапсе. Если учетная запись администратора Azure Active Directory удалена с сервера, то существующие пользователи Azure Active Directory, учетные записи которых были созданы ранее на сервере SQL Server, больше не смогут подключаться к базе данных, используя свои текущие учетные данные Azure Active Directory.

## <a name="azure-ad-features-and-limitations"></a>Функции и ограничения Azure AD

- Для базы данных SQL Azure можно подготовить следующие члены Azure AD:

  - Собственные члены. Члены, созданные в Azure AD в управляемом домене или в домене клиента. Дополнительные сведения см. в статье [Добавление имени личного домена в Azure Active Directory](../../active-directory/fundamentals/add-custom-domain.md).
  - Члены домена Active Directory Федеративные с Azure Active Directory в управляемом домене, настроенном для простого единого входа с использованием сквозной проверки подлинности или хэширования пароля. Дополнительные сведения см. в разделе [Microsoft Azure теперь поддерживает федерацию с Windows Server Active Directory](https://azure.microsoft.com/blog/windows-azure-now-supports-federation-with-windows-server-active-directory//) и [Azure Active Directory простой единый вход](../../active-directory/hybrid/how-to-connect-sso.md).
  - Импортированные члены из других каталогов Azure AD, являющиеся собственными или федеративными членами домена.
  - Группы Active Directory, созданные как группы безопасности.

- Пользователи Azure AD, которые являются частью группы, имеющей `db_owner` роль сервера, не могут использовать синтаксис **[учетных данных для создания базы данных](/sql/t-sql/statements/create-database-scoped-credential-transact-sql)** в базе данных SQL Azure и Azure синапсе. Отобразится следующая ошибка:

    `SQL Error [2760] [S0001]: The specified schema name 'user@mydomain.com' either does not exist or you do not have permission to use it.`

    Предоставляйте роль `db_owner` напрямую отдельным пользователям Azure AD во избежание проблем с синтаксисом **CREATE DATABASE SCOPED CREDENTIAL**.

- Эти системные функции возвращают значения NULL при выполнении с помощью субъектов Azure AD:

  - `SUSER_ID()`
  - `SUSER_NAME(<admin ID>)`
  - `SUSER_SNAME(<admin SID>)`
  - `SUSER_ID(<admin name>)`
  - `SUSER_SID(<admin name>)`

### <a name="sql-managed-instance"></a>Управляемый экземпляр SQL

- Участники сервера Azure AD (имена для входа) и пользователи поддерживаются для [управляемый экземпляр SQL](../managed-instance/sql-managed-instance-paas-overview.md).
- Настройка субъектов сервера Azure AD (имен входа), сопоставленных с группой Azure AD в качестве владельца базы данных, не поддерживается в [SQL управляемый экземпляр](../managed-instance/sql-managed-instance-paas-overview.md).
  - Расширение этого параметра заключается в том, что когда группа добавляется как часть `dbcreator` роли сервера, пользователи из этой группы могут подключаться к управляемый экземпляр SQL и создавать новые базы данных, но не смогут получить доступ к базе данных. Это происходит, так как новый владелец базы данных является системным администратором, а не пользователем Azure AD. Эта проблема не проявляется при добавлении роли сервера `dbcreator` для отдельного пользователя.
- Для участников сервера Azure AD поддерживаются выполнения заданий и управления агентом SQL (имена входа).
- Операции резервного копирования и восстановления базы данных могут быть выполнены с помощью субъектов сервера (имен для входа) Azure AD.
- Поддерживается аудит всех инструкций, связанных с субъектами сервера (именами для входа) Azure AD и событиями проверки подлинности.
- Поддерживается выделенное административное соединение для субъектов сервера (имен для входа) Azure AD, которые являются участниками роли сервера системного администратора.
  - Поддерживается с помощью служебной программы SQLCMD и SQL Server Management Studio.
- Триггеры входа поддерживаются для событий входа, поступающих от субъектов сервера (имен для входа) Azure AD.
- С помощью субъектов сервера (имен для входа) Azure AD можно настроить почту Service Broker и базы данных.

## <a name="connect-by-using-azure-ad-identities"></a>Подключение с использованием удостоверений Azure AD

Проверка подлинности Azure Active Directory поддерживает следующие способы подключения к базе данных с помощью удостоверений Azure AD:

- Пароль Azure Active Directory.
- Встроенная служба Azure Active Directory.
- Azure Active Directory Universal с многофакторной проверкой подлинности
- Использование маркера проверки подлинности приложения

Для субъектов сервера (имен для входа) Azure AD поддерживаются следующие способы проверки подлинности:

- Пароль Azure Active Directory.
- Встроенная служба Azure Active Directory.
- Azure Active Directory Universal с многофакторной проверкой подлинности

### <a name="additional-considerations"></a>Дополнительные сведения

- Для повышения управляемости рекомендуем подготовить специальную группу Azure AD от имени администратора.
- Только один администратор Azure AD (пользователь или группа) можно настроить для сервера в базе данных SQL или Azure синапсе в любое время.
  - Добавление участников сервера Azure AD (имен входа) для SQL Управляемый экземпляр позволяет создавать несколько участников сервера Azure AD (имен входа), которые могут быть добавлены к `sysadmin` роли.
- Только администратор Azure AD для сервера может сначала подключиться к серверу или управляемому экземпляру с помощью учетной записи Azure Active Directory. Затем администратор Active Directory может настроить других пользователей базы данных Azure AD.
- Мы рекомендуем установить время ожидания подключения в 30 секунд.
- Проверку подлинности Azure Active Directory поддерживают SQL Server 2016 Management Studio и SQL Server Data Tools для Visual Studio 2015 (версии 14.0.60311.1, выпущенной в апреле 2016 г., или более поздней). (Проверку подлинности Azure AD поддерживает **поставщик данных .NET Framework для SQL Server**, требуется версия .NET Framework не ниже 4.6.) Поэтому новейшие версии этих средств и приложений уровня данных (DAC и BACPAC) могут использовать проверку подлинности Azure AD.
- Начиная с версии 15.0.1, [программа sqlcmd](/sql/tools/sqlcmd-utility) и [программа bcp](/sql/tools/bcp-utility) поддерживают Active Directory интерактивную проверку подлинности с помощью многофакторной проверки подлинности.
- Для SQL Server Data Tools для Visual Studio 2015 требуется версия Data Tools, выпущенная в апреле 2016 г. (14.0.60311.1), или более поздняя. Сейчас пользователи Azure AD не отображаются в обозревателе объектов SSDT. Сведения о пользователях можно просмотреть в файле [sys.database_principals](/sql/relational-databases/system-catalog-views/sys-database-principals-transact-sql).
- [Драйвер Microsoft JDBC 6.0 для SQL Server](https://www.microsoft.com/download/details.aspx?id=11774) поддерживает проверку подлинности Azure AD. Вы можете также ознакомиться с [настройкой свойств подключения](/sql/connect/jdbc/setting-the-connection-properties).
- PolyBase не поддерживает проверку подлинности Azure AD.
- Аутентификация Azure AD поддерживается для базы данных SQL Azure и Azure синапсе с помощью портал Azure **импорта базы** данных и **экспорта баз данных** . Импорт и экспорт с помощью аутентификации Azure AD также поддерживаются командой PowerShell.
- Проверка подлинности Azure AD поддерживается для базы данных SQL, SQL Управляемый экземпляр и Azure синапсе с помощью интерфейса командной строки. Дополнительные сведения см. в статьях [Настройка аутентификации Azure AD и управление ею с помощью базы данных SQL или Azure синапсе](authentication-aad-configure.md) и [SQL Server-AZ SQL Server](/cli/azure/sql/server).

## <a name="next-steps"></a>Дальнейшие действия

- Чтобы узнать, как создать и заполнить экземпляр Azure AD, а затем настроить его с помощью базы данных SQL Azure, Управляемый экземпляр SQL или Azure синапсе, см. статью [Настройка и управление Azure Active Directory аутентификацией с помощью базы данных SQL, sql управляемый экземпляр или Azure синапсе](authentication-aad-configure.md).
- Руководство по использованию участников-серверов Azure AD (имен входа) с SQL Управляемый экземпляр см. в статье [участники сервера Azure AD (имена входа) с sql управляемый экземпляр](../managed-instance/aad-security-configure-tutorial.md)
- Общие сведения о именах входа, пользователях, ролях базы данных и разрешениях в базе данных SQL см. в разделе [имена входа, пользователи, роли базы данных и разрешения](logins-create-manage.md).
- Дополнительные сведения о субъектах базы данных см. в [этой статье](/sql/relational-databases/security/authentication-access/principals-database-engine).
- Дополнительные сведения о ролях баз данных см. в статье [Роли уровня базы данных](/sql/relational-databases/security/authentication-access/database-level-roles).
- Синтаксис создания субъектов-серверов Azure AD (имен входа) для SQL Управляемый экземпляр см. в разделе  [Создание имени входа](/sql/t-sql/statements/create-login-transact-sql?view=azuresqldb-mi-current&preserve-view=true).
- Дополнительные сведения о правилах брандмауэра см. в статье [Обзор правил брандмауэра базы данных SQL Azure](firewall-configure.md).

<!--Image references-->
[1]: ./media/authentication-aad-overview/1aad-auth-diagram.png
[2]: ./media/authentication-aad-overview/2subscription-relationship.png
[3]: ./media/authentication-aad-overview/3admin-structure.png
