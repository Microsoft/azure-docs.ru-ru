---
title: Автоматическое геоизбыточное резервное копирование
titleSuffix: Azure SQL Database & Azure SQL Managed Instance
description: База данных SQL Azure и Azure SQL Управляемый экземпляр автоматически создают резервную копию локальной базы данных каждые несколько минут и используют геоизбыточное хранилище с доступом для чтения Azure для геоизбыточности.
services: sql-database
ms.service: sql-db-mi
ms.subservice: backup-restore
ms.custom: references_regions
ms.topic: conceptual
author: shkale-msft
ms.author: shkale
ms.reviewer: mathoma, stevestein, danil
ms.date: 03/10/2021
ms.openlocfilehash: 5879c9107a0ab5a2ef150d119e8b5ac8e16ac01d
ms.sourcegitcommit: e6de1702d3958a3bea275645eb46e4f2e0f011af
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "102609929"
---
# <a name="automated-backups---azure-sql-database--sql-managed-instance"></a>Автоматическое резервное копирование базы данных SQL Azure & SQL Управляемый экземпляр

[!INCLUDE[appliesto-sqldb-sqlmi](../includes/appliesto-sqldb-sqlmi.md)]

[!INCLUDE [GDPR-related guidance](../../../includes/gdpr-intro-sentence.md)]

## <a name="what-is-a-database-backup"></a>Что такое резервная копия базы данных?

Резервные копии баз данных являются важнейшей частью любой стратегии непрерывности бизнес-процессов и аварийного восстановления, так как они защищают данные от повреждения или удаления. Эти резервные копии позволяют восстановить базу данных на определенный момент времени в течение заданного срока хранения. Если для правил защиты данных требуется, чтобы резервные копии были доступны в течение длительного времени (до 10 лет), можно настроить [долгосрочное хранение](long-term-retention-overview.md) как для одной, так и для баз данных в составе пула.

### <a name="backup-frequency"></a>Частота резервного копирования

Как база данных SQL, так и SQL Управляемый экземпляр используют технологию SQL Server для создания [полных резервных копий](/sql/relational-databases/backup-restore/full-database-backups-sql-server) каждую неделю, [разностные резервные копии](/sql/relational-databases/backup-restore/differential-backups-sql-server) каждые 12-24 часов и [резервные копии журналов транзакций](/sql/relational-databases/backup-restore/transaction-log-backups-sql-server) каждые 5 – 10 минут. Периодичность резервного копирования журнала транзакций зависит от размера вычислений и объема активности базы данных.

При восстановлении базы данных служба определяет, какие резервные копии полных, разностных и журналов транзакций необходимо восстановить.

### <a name="backup-storage-redundancy"></a>Избыточность хранилища резервных копий

По умолчанию база данных SQL и SQL Управляемый экземпляр хранят данные в геоизбыточных [больших двоичных объектах хранилища](../../storage/common/storage-redundancy.md) , которые реплицируются в [парный регион](../../best-practices-availability-paired-regions.md). Это помогает защититься от простоев, влияющих на хранилище резервных копий в основном регионе, и позволяет восстановить сервер в другой регион в случае аварии. 

Возможность настройки избыточности хранилища резервных копий обеспечивает гибкость при выборе между локально избыточным, избыточным в пределах зоны или географически избыточными BLOB-объектами хранилища для SQL Управляемый экземпляр или базы данных SQL. Чтобы гарантировать, что данные находятся в том же регионе, где развернут управляемый экземпляр или база данных SQL, можно изменить геоизбыточное хранилище резервных копий по умолчанию и настроить резервные хранилища, избыточные локально или в пределах зоны. Механизмы избыточности хранилища хранят несколько копий данных, чтобы защитить их от запланированных и незапланированных событий, включая временные сбои оборудования, сети или перебои электроэнергии, а также крупномасштабные стихийные бедствия. Настроенная избыточность хранилища резервных копий применяется к параметрам краткосрочного хранения резервных копий, которые используются для восстановления на момент времени (PITR) и долгосрочного резервного копирования, используемого для долгосрочного резервного копирования (LTR). 

Для базы данных SQL избыточность хранилища резервных копий может быть настроена во время создания базы данных или может быть обновлена для существующей базы данных. изменения, вносимые в существующую базу данных, применяются только к будущим резервным копиям. После обновления избыточности хранилища резервных копий существующей базы данных для применения изменений может потребоваться до 48 часов. Обратите внимание, что геовосстановление отключено, как только база данных будет обновлена для использования локальной системы или хранилища, избыточного в рамках зоны. 


> [!IMPORTANT]
> Настройка избыточности хранилища резервных копий во время процесса создания управляемого экземпляра после подготовки ресурса невозможно изменить избыточность хранилища. 

> [!IMPORTANT]
> Хранилище, избыточное в виде зоны, в настоящее время доступно только в [определенных регионах](../../storage/common/storage-redundancy.md#zone-redundant-storage). 

> [!NOTE]
> Настраиваемая избыточность хранилища резервных копий для базы данных SQL Azure в настоящее время доступна в общедоступной предварительной версии Южная Бразилия и общедоступна только в регионе Azure Юго-Восточной Азии. Эта функция пока недоступна для уровня "горизонтальный". 

### <a name="backup-usage"></a>Использование резервного копирования

Эти резервные копии позволяют выполнить следующие операции:

- **Восстановление существующей базы данных**  -  на момент времени [Восстановите существующую базу данных до точки во времени в прошлом](recovery-using-backups.md#point-in-time-restore) в течение срока хранения с помощью портал Azure, Azure PowerShell, Azure CLI или REST API. Для базы данных SQL эта операция создает новую базу данных на том же сервере, что и исходная база данных, но использует другое имя, чтобы избежать перезаписи исходной базы данных. После завершения восстановления можно удалить исходную базу данных. Кроме того, можно [Переименовать](/sql/relational-databases/databases/rename-a-database) исходную базу данных, а затем переименовать восстановленную базу данных в исходное имя базы данных. Аналогично, для Управляемый экземпляр SQL эта операция создает копию базы данных на том же или другом управляемом экземпляре в той же подписке и том же регионе.
- **Восстановление удаленной базы данных**  -  на момент времени [Восстановление удаленной базы данных до момента удаления](recovery-using-backups.md#deleted-database-restore) или в любой момент времени в течение срока хранения. Удаленную базу данных можно восстановить только на том же сервере или в управляемом экземпляре, где была создана исходная база данных. При удалении базы данных служба выполняет окончательную резервную копию журнала транзакций перед удалением, чтобы предотвратить потери данных.
- **Геовосстановление**  -  [Восстановление базы данных в другой географический регион](recovery-using-backups.md#geo-restore). Геовосстановление позволяет восстанавливаться после географической аварии, когда доступ к базе данных или резервным копиям в основном регионе невозможен. Она создает новую базу данных на любом существующем сервере или управляемом экземпляре в любом регионе Azure.
   > [!IMPORTANT]
   > Геовосстановление доступно только для баз данных SQL или управляемых экземпляров, настроенных с геоизбыточным хранилищем резервных копий.
- **Восстановление из долгосрочного резервного копирования**  -  [Восстановление базы данных из определенной долгосрочной резервной копии](long-term-retention-overview.md) отдельной базы данных или базы данных в составе пула, если для базы данных настроена политика долгосрочного хранения (LTR). LTR позволяет восстановить старую версию базы данных с помощью [портал Azure](long-term-backup-retention-configure.md#using-the-azure-portal) или [Azure PowerShell](long-term-backup-retention-configure.md#using-powershell) для удовлетворения запроса на соответствие или запуска старой версии приложения. Дополнительные сведения см. в разделе [долгосрочное хранение](long-term-retention-overview.md).

Сведения о выполнении восстановления см. в разделе [Восстановление базы данных из резервных копий](recovery-using-backups.md).

> [!NOTE]
> В службе хранилища Azure термин *репликация* означает копирование больших двоичных объектов из одного расположения в другое. В SQL *репликация базы данных* относится к различным технологиям, используемым для синхронизации нескольких баз данных-получателей с первичной базой данных.

Вы можете выполнить операции резервного копирования и восстановления, используя следующие примеры:

| Операция | Портал Azure | Azure PowerShell |
|---|---|---|
| **Изменение срока хранения резервной копии** | [База данных SQL](automated-backups-overview.md?tabs=single-database#change-the-pitr-backup-retention-period-by-using-the-azure-portal) <br/> [Управляемый экземпляр SQL](automated-backups-overview.md?tabs=managed-instance#change-the-pitr-backup-retention-period-by-using-the-azure-portal) | [База данных SQL](automated-backups-overview.md#change-the-pitr-backup-retention-period-by-using-powershell) <br/>[Управляемый экземпляр SQL](/powershell/module/az.sql/set-azsqlinstancedatabasebackupshorttermretentionpolicy) |
| **Изменение долгосрочного хранения резервных копий** | [База данных SQL](long-term-backup-retention-configure.md#configure-long-term-retention-policies)<br/>SQL Управляемый экземпляр-N/A  | [База данных SQL](long-term-backup-retention-configure.md)<br/>[Управляемый экземпляр SQL](../managed-instance/long-term-backup-retention-configure.md)  |
| **Восстановление базы данных на момент времени** | [База данных SQL](recovery-using-backups.md#point-in-time-restore)<br>[Управляемый экземпляр SQL](../managed-instance/point-in-time-restore.md) | [База данных SQL](/powershell/module/az.sql/restore-azsqldatabase) <br/> [Управляемый экземпляр SQL](/powershell/module/az.sql/restore-azsqlinstancedatabase) |
| **Восстановление удаленной базы данных** | [База данных SQL](recovery-using-backups.md)<br>[Управляемый экземпляр SQL](../managed-instance/point-in-time-restore.md#restore-a-deleted-database) | [База данных SQL](/powershell/module/az.sql/get-azsqldeleteddatabasebackup) <br/> [Управляемый экземпляр SQL](/powershell/module/az.sql/get-azsqldeletedinstancedatabasebackup)|
| **Восстановление базы данных из хранилища BLOB-объектов Azure** | База данных SQL — н/д <br/>SQL Управляемый экземпляр-N/A  | База данных SQL — н/д <br/>[Управляемый экземпляр SQL](../managed-instance/restore-sample-database-quickstart.md) |

## <a name="backup-scheduling"></a>Планирование резервного копирования

Первая полная резервная копия планируется сразу же после создания или восстановления новой базы данных. Эта резервная копия обычно завершается в течение 30 минут, но при большом объеме базы данных может потребоваться больше времени. Например, начальное резервное копирование может занять больше времени в восстановленной базе данных или копии базы данных, что, как правило, больше, чем новая база данных. После первого полного резервного копирования все дальнейшие резервные копии планируются и управляются автоматически. Точное время резервного копирования всех баз данных определяется базой данных SQL или службой SQL Управляемый экземпляр, так как она распределяет общую рабочую нагрузку системы. Нельзя изменить расписание заданий резервного копирования или отключить их.

> [!IMPORTANT]
> Для новой, восстановленной или скопированной базы данных возможность восстановления на момент времени становится доступной с момента создания первоначальной резервной копии журнала транзакций, следующей за начальной полной резервной копией.

## <a name="backup-storage-consumption"></a>Использование хранилища резервных копий

При использовании SQL Server технологии резервного копирования и восстановления восстановление базы данных на момент времени требует наличия непрерывной цепочки резервных копий, состоящей из одной полной резервной копии, при необходимости одной разностной архивации и одной или нескольких резервных копий журналов транзакций. База данных SQL и расписание резервного копирования SQL Управляемый экземпляр включают по одной полной резервной копии каждую неделю. Таким образом, чтобы включить PITR в течение всего срока хранения, система должна хранить дополнительные резервные копии полных, разностных и журналов транзакций в течение недели дольше заданного срока хранения. 

Другими словами, для любой точки во времени в течение срока хранения должна быть полная резервная копия, которая старше, чем самое старое время срока хранения, а также непрерывная цепочка разностных резервных копий и журналов транзакций из этой полной резервной копии до следующей полной резервной копии.

> [!NOTE]
> Чтобы включить PITR, дополнительные резервные копии хранятся в течение недели дольше заданного срока хранения. Плата за хранилище резервных копий насчитывается по той же ставке для всех резервных копий. 

Резервные копии, которые больше не нужны для предоставления функциональных возможностей PITR, автоматически удаляются. Так как для разностных резервных копий и резервных копий журналов требуется, чтобы была restorable более ранняя полная резервная копия, все три типа резервного копирования удаляются в еженедельные наборы.

Для всех баз данных, включая [зашифрованные](transparent-data-encryption-tde-overview.md) базы данных TDE, резервные копии сжимаются для уменьшения сжатия и затрат на хранение резервных копий. Средняя степень сжатия резервных копий составляет 3-4 раз, однако она может быть значительно ниже или выше в зависимости от характера данных и от того, используется ли сжатие данных в базе данных.

База данных SQL и SQL Управляемый экземпляр вычисляют общее используемое хранилище резервных копий как совокупное значение. Каждый час это значение передается в конвейер выставления счетов Azure, который отвечает за агрегирование этого почасового использования для вычисления потребления в конце каждого месяца. После удаления базы данных потребление уменьшается по мере устаревания резервных копий и удаляется. Когда все резервные копии будут удалены и PITR больше невозможно, выставление счетов прекращается.
   
> [!IMPORTANT]
> Резервные копии базы данных сохраняются для включения PITR, даже если база данных была удалена. Хотя удаление и повторное создание базы данных может сэкономить на затратах на хранение и вычисление, это может привести к увеличению затрат на хранение резервных копий, так как служба сохраняет резервные копии каждой удаленной базы данных при каждом удалении. 

### <a name="monitor-consumption"></a>Мониторинг потребления

Для баз данных Виртуальное ядро хранилище, используемое каждым типом резервных копий (полная, разностная и журнал), отображается в колонке "мониторинг базы данных" как отдельная метрика. На следующей схеме показано, как отслеживать потребление хранилища резервных копий для отдельной базы данных. В настоящее время эта функция недоступна для управляемых экземпляров.

![Мониторинг потребления резервной копии базы данных в портал Azure](./media/automated-backups-overview/backup-metrics.png)

### <a name="fine-tune-backup-storage-consumption"></a>Тонкая настройка использования хранилища резервных копий

Использование хранилища резервных копий вплоть до максимального размера данных для базы данных не будет взиматься. Избыточное потребление хранилища резервных копий будет зависеть от рабочей нагрузки и максимального размера отдельных баз данных. Рассмотрите некоторые из следующих методов настройки для уменьшения потребления хранилища резервных копий:

- Сократите [срок хранения резервных копий](#change-the-pitr-backup-retention-period-by-using-the-azure-portal) до минимально возможной потребности.
- Избегайте выполнения больших операций записи, таких как перестроение индекса, чаще, чем требуется.
- Для операций загрузки больших данных рассмотрите возможность использования [кластеризованных индексов columnstore](/sql/relational-databases/indexes/columnstore-indexes-overview) и [следующих связанных рекомендаций](/sql/relational-databases/indexes/columnstore-indexes-data-loading-guidance), а также уменьшения числа некластеризованных индексов.
- На уровне служб общего назначения подготовленное хранилище данных менее затратно, чем стоимость хранилища резервных копий. При постоянном повышении затрат на хранение резервных копий можно увеличить объем хранилища данных для сохранения в хранилище резервных копий.
- Используйте базу данных TempDB вместо постоянных таблиц в логике приложения для хранения временных результатов и (или) временных данных.
- Используйте локально избыточное хранилище резервных копий везде, где это возможно (например, в средах разработки и тестирования).

## <a name="backup-retention"></a>Хранение архивных копий

Для всех новых, восстановленных и скопированных баз данных, баз данных SQL Azure и Azure SQL Управляемый экземпляр сохранять достаточно резервных копий, чтобы разрешить PITR в течение последних 7 дней по умолчанию. За исключением баз данных масштаба и уровня Basic, можно изменить срок [хранения резервной копии](#change-the-pitr-backup-retention-period) каждой активной базы данных в диапазоне 1-35 дней. Как описано в статье [Использование хранилища резервных копий](#backup-storage-consumption), резервные копии, сохраненные для включения PITR, могут быть старше, чем срок хранения. Только для Управляемый экземпляр Azure SQL можно задать скорость хранения резервных копий PITR после удаления базы данных в диапазоне 0-35 дней. 

При удалении базы данных система сохраняет резервные копии так же, как и для базы данных в сети с заданным сроком хранения. Нельзя изменить срок хранения резервной копии для удаленной базы данных.

> [!IMPORTANT]
> При удалении сервера или управляемого экземпляра все базы данных на этом сервере или управляемом экземпляре также удаляются и не могут быть восстановлены. Нельзя восстановить удаленный сервер или управляемый экземпляр. Но если вы настроили долгосрочное хранение (LTR) для базы данных или управляемого экземпляра, резервные копии долгосрочного хранения не удаляются и могут использоваться для восстановления баз данных на другом сервере или управляемом экземпляре в той же подписке на момент времени, когда была создана долгосрочная резервная копия хранения.

Хранение резервных копий в целях PITR в течение последних 1-35 дней иногда называется краткосрочным хранением резервных копий. Если необходимо хранить резервные копии дольше, чем максимальный период удержания в 35 дней, можно включить [долгосрочное хранение](long-term-retention-overview.md).

### <a name="long-term-retention"></a>Длительный период удержания

Для базы данных SQL и Управляемый экземпляр SQL можно настроить полное резервное хранение в течение 10 лет в хранилище BLOB-объектов Azure. После настройки политики LTR все резервные копии автоматически копируются в другой контейнер хранилища еженедельно. Для удовлетворения различных требований соответствия можно выбрать разные периоды хранения для еженедельных, ежемесячных и (или) ежегодно полных резервных копий. Потребление хранилища зависит от выбранной частоты и сроков хранения резервных копий на LTR. Вы можете использовать [Калькулятор цен LTR](https://azure.microsoft.com/pricing/calculator/?service=sql-database) для оценки стоимости хранения на LTR.

> [!IMPORTANT]
> Обновление избыточности хранилища резервных копий для существующей базы данных SQL Azure применяется только к будущим резервным копиям, созданным для базы данных. Все существующие резервные копии LTR для базы данных будут по-прежнему находиться в существующем BLOB-объекте хранилища, а новые резервные копии будут храниться в запрошенном типе BLOB-объекта хранилища. 

Дополнительные сведения о LTR см. в статье [долгосрочное хранение резервных копий](long-term-retention-overview.md).

## <a name="backup-storage-costs"></a>Затраты на хранение резервных копий

Цена для хранилища резервных копий зависит от модели приобретения (DTU или Виртуальное ядро), выбранного параметра избыточности хранилища резервных копий и в вашем регионе. Плата за хранилище резервных копий насчитывается за ГБ/мес. для получения цен см. страницу [цен на базу данных SQL Azure](https://azure.microsoft.com/pricing/details/sql-database/single/) и страницу [цен на управляемый экземпляр Azure SQL](https://azure.microsoft.com/pricing/details/azure-sql/sql-managed-instance/single/) .

> [!NOTE]
> В счете Azure будет отображаться только избыточное хранилище резервных копий, а не все использование хранилища резервных копий. Например, в гипотетическом сценарии, если вы подготовили 4 ТБ хранилища данных, вы получите 4 ТБ свободного пространства для хранения резервных копий. Если вы использовали сумму 5,8 ТБ места для хранения резервных копий, в счете Azure будет отображаться только 1,8 ТБ, так как будет выставлена оплата за использование только лишнего хранилища резервных копий.

### <a name="dtu-model"></a>Модель с DTU

В модели DTU не взимается дополнительная плата за хранение резервных копий для баз данных и эластичных пулов. Цена хранилища резервных копий является частью цены на базу данных или пул.

### <a name="vcore-model"></a>Модель с виртуальными ядрами

Для одной базы данных в базе данных SQL объем хранилища резервных копий, равный 100 процентам от максимального размера хранилища данных для базы данных, предоставляется без дополнительной платы. Для эластичных пулов и управляемых экземпляров объем хранилища резервных копий, равный 100 процентам от максимального объема хранилища данных для пула или максимального размера хранилища, соответственно, предоставляется без дополнительной платы. 

Для отдельных баз данных это уравнение используется для вычисления общего количества оплачиваемых использованных хранилищ резервных копий:

`Total billable backup storage size = (size of full backups + size of differential backups + size of log backups) – maximum data storage`

Для баз данных в составе пула суммарный размер оплачиваемого хранилища резервных копий вычисляется на уровне пула и вычисляется следующим образом:

`Total billable backup storage size = (total size of all full backups + total size of all differential backups + total size of all log backups) - maximum pool data storage`

Для управляемых экземпляров общий объем оплачиваемого хранилища резервных копий вычисляется на уровне экземпляра и вычисляется следующим образом:

`Total billable backup storage size = (total size of full backups + total size of differential backups + total size of log backups) – maximum instance data storage`

Общий объем оплачиваемого хранилища резервных копий, если таковой имеется, будет начисляться в ГБ/месяц в соответствии с интенсивностью использования избыточности хранилища резервных копий. Это использование хранилища резервных копий зависит от рабочей нагрузки и размера отдельных баз данных, эластичных пулов и управляемых экземпляров. Базы данных с интенсивным изменением имеют большие разностные резервные копии и журналы, так как размер этих резервных копий пропорциональен объему изменений данных. Таким образом, такие базы данных будут иметь более высокие затраты на резервное копирование.

База данных SQL и SQL Управляемый экземпляр рассчитывают общее значение оплачиваемого хранилища резервных копий в виде совокупного значения во всех файлах резервных копий. Каждый час это значение передается в конвейер выставления счетов Azure, который объединяет это почасовое использование для получения сведений о потреблении хранилища резервных копий в конце каждого месяца. Если база данных удалена, то использование хранилища резервных копий постепенно снизится по мере устаревания старых резервных копий и их удаления. Так как для разностных резервных копий и резервных копий журналов требуется, чтобы была restorable более ранняя полная резервная копия, все три типа резервного копирования удаляются в еженедельные наборы. После удаления всех резервных копий выставление счетов прекращается. 

В качестве упрощенного примера предположим, что база данных накоплена на 744 ГБ хранилища службы архивации и что эта сумма остается постоянной в течение всего месяца, так как база данных полностью бездействует. Чтобы преобразовать это совокупное потребление хранилища в почасовое использование, разделите его на 744,0 (31 день в месяц * 24 часа в день). База данных SQL сообщит о конвейере выставления счетов Azure о том, что база данных потребляет 1 ГБ резервной копии PITR каждый час с постоянной скоростью. При выставлении счетов Azure будет агрегировано это потребление и показано использование 744 ГБ на весь месяц. Стоимость будет основываться на ставке суммы/ГБ/месяц в вашем регионе.

Теперь более сложный пример. Предположим, что срок хранения одной и той же простой базы данных увеличился с 7 дней до 14 дней в середине месяца. Это увеличение приводит к увеличению общего объема хранилища резервных копий с удвоением до 1 488 ГБ. База данных SQL сообщит об использовании 1 ГБ для часов с 1 по 372 (первая половина месяца). Он будет сообщать об использовании как 2 ГБ для часов с 373 по 744 (вторая половина месяца). Это использование будет агрегировано до окончательной суммы в 1 116 ГБ/месяц.

Фактические сценарии выставления счетов по резервному копированию являются более сложными. Поскольку скорость изменений в базе данных зависит от рабочей нагрузки и имеет переменную с течением времени, размер каждой разностной резервной копии и журнала может отличаться, что приведет к неправильному израсходованию почасового хранения резервных копий. Более того, каждая разностная резервная копия содержит все изменения, внесенные в базу данных с момента последнего полного резервного копирования, поэтому общий размер всех разностных резервных копий постепенно увеличивается в течение недели, а затем резко снижается, когда возрастает более старый набор полных, разностных и резервных копий журналов. Например, если активное действие записи, такое как перестроение индекса, выполняется сразу после завершения полного резервного копирования, то изменения, внесенные в результате перестроения индекса, будут включаться в резервные копии журналов транзакций, созданные в течение периода перестроения, в следующей разностной резервной копии и в каждой разностной резервной копии, созданной до следующего полного резервного копирования. Для последнего сценария в больших базах данных оптимизация в службе создает полную резервную копию, а не разностную резервную копию, если в противном случае разностная резервная копия слишком велика. Это сокращает размер всех разностных резервных копий до создания следующей полной резервной копии.

Можно отслеживать общее использование хранилища резервных копий для каждого типа резервных копий (полное, разностное, журнал транзакций) с течением времени, как описано в разделе [мониторинг потребления](#monitor-consumption).

### <a name="backup-storage-redundancy"></a>Избыточность хранилища резервных копий

Избыточность хранилища резервных копий влияет на затраты на резервное копирование следующим образом:
- локально избыточная цена = x
- Избыточная в зоне Цена = 1,25 x
- геоизбыточная Цена = 2x

Дополнительные сведения о ценах на хранилище резервных копий см. на [странице цен на базу данных SQL Azure](https://azure.microsoft.com/pricing/details/sql-database/single/) и на [странице цен на Azure SQL управляемый экземпляр](https://azure.microsoft.com/pricing/details/azure-sql/sql-managed-instance/single/).

> [!IMPORTANT]
> Настраиваемая избыточность хранилища резервных копий для управляемого экземпляра SQL доступна во всех регионах Azure и в настоящее время доступна в регионе Azure Юго-Восточной Азии только для базы данных SQL. Для Управляемый экземпляр его можно указать только во время процесса создания управляемого экземпляра. После подготовки ресурса нельзя изменить параметр избыточность хранилища резервных копий.

### <a name="monitor-costs"></a>Мониторинг затрат

Чтобы узнать стоимость хранилища резервных копий, выберите **Управление затратами + выставление счетов** в портал Azure, щелкните **Управление затратами**, а затем выберите **анализ затрат**. Выберите нужную подписку в качестве **области**, а затем выполните фильтрацию за период времени и службу, которые вас интересуют.

Добавьте фильтр для **имени службы**, а затем выберите **база данных SQL** в раскрывающемся списке. Используйте фильтр **Подкатегория подкатегории** , чтобы выбрать счетчик выставления счетов для службы. Для отдельной базы данных или пула эластичных баз данных выберите **один или эластичный пул PITR хранилище резервных копий**. Для управляемого экземпляра выберите **PITR хранилище резервных копий**. Подкатегории **хранилища** и **вычислений** могут быть также интересны, но не связаны с затратами на хранение резервных копий.

![Анализ затрат на хранилище резервных копий](./media/automated-backups-overview/check-backup-storage-cost-sql-mi.png)

  >[!NOTE]
  > Индикаторы отображаются только для счетчиков, которые используются в данный момент. Если счетчик недоступен, скорее всего, эта категория не используется в данный момент. Например, счетчики управляемого экземпляра не будут присутствовать для клиентов, которые не развернули управляемый экземпляр. Точно так же счетчики хранилища не будут видны для ресурсов, которые не потребляют хранилище. 

## <a name="encrypted-backups"></a>Зашифрованные резервные копии

Если база данных зашифрована с помощью TDE, резервные копии автоматически шифруются при хранении, включая резервные копии LTR. По умолчанию все новые базы данных в SQL Azure настроены с включенным TDE. Дополнительные сведения о TDE см. в статье  [прозрачное шифрование данных с базой данных sql & sql управляемый экземпляр](/sql/relational-databases/security/encryption/transparent-data-encryption-azure-sql).

## <a name="backup-integrity"></a>Целостность резервной копии

На постоянной основе группа инженеров SQL Azure автоматически проверяет восстановление резервных копий баз данных. (В настоящее время это тестирование недоступно в Управляемый экземпляр SQL.) При восстановлении до точки во времени базы данных также получают проверки целостности DBCC CHECKDB.

При обнаружении ошибок в процессе проверки целостности команда разработки получает оповещения. Дополнительные сведения см. [в разделе целостность данных в базе данных SQL](https://azure.microsoft.com/blog/data-integrity-in-azure-sql-database/).

Все резервные копии базы данных создаются с параметром CHECKSUM для обеспечения дополнительной целостности резервных копий.

## <a name="compliance"></a>Соответствие нормативным требованиям

При переносе базы данных с уровня служб на основе DTU на уровень служб на основе виртуальное ядро сохраняется сохранение PITR, чтобы гарантировать, что политика восстановления данных вашего приложения не скомпрометирована. Если срок хранения по умолчанию не соответствует требованиям, можно изменить срок хранения PITR. Дополнительные сведения см. [в разделе изменение срока хранения резервной копии PITR](#change-the-pitr-backup-retention-period).

[!INCLUDE [GDPR-related guidance](../../../includes/gdpr-intro-sentence.md)]

## <a name="change-the-pitr-backup-retention-period"></a>Изменение срока хранения резервной копии PITR

Вы можете изменить срок хранения резервной копии PITR по умолчанию с помощью портал Azure, PowerShell или REST API. В следующих примерах показано, как изменить срок хранения PITR на 28 дней.

> [!WARNING]
> Уменьшение текущего срока хранения приведет к потере возможности восстановления до точек во времени, предшествующих новому сроку хранения. Резервные копии, которые больше не нужны для предоставления PITR в течение нового срока хранения, удаляются. Если вы увеличиваете текущий срок хранения, вы не сразу получаете возможность восстановления на более старые моменты времени в течение нового срока хранения. Эта возможность получается по мере того, как система начинает хранить резервные копии дольше.

> [!NOTE]
> Эти API влияют только на срок хранения PITR. Если вы настроили LTR для базы данных, это не повлияет. Сведения о том, как изменить сроки хранения слева направо, см. в разделе [долгосрочное хранение](long-term-retention-overview.md).

### <a name="change-the-pitr-backup-retention-period-by-using-the-azure-portal"></a>Измените срок хранения резервной копии PITR с помощью портал Azure

Чтобы изменить срок хранения резервной копии PITR для активных баз данных с помощью портал Azure, перейдите на сервер или управляемый экземпляр с базами данных, срок хранения которых требуется изменить. На левой панели выберите **резервные копии** , а затем перейдите на вкладку **политики хранения** . Выберите базы данных, для которых необходимо изменить период хранения резервных копий PITR. Затем выберите **настроить хранение** на панели действий.



#### <a name="sql-database"></a>[База данных SQL](#tab/single-database)

![Изменение срока хранения PITR, уровень сервера](./media/automated-backups-overview/configure-backup-retention-sqldb.png)

#### <a name="sql-managed-instance"></a>[Управляемый экземпляр SQL](#tab/managed-instance)

![Изменение срока хранения PITR, управляемый экземпляр](./media/automated-backups-overview/configure-backup-retention-sqlmi.png)

---

### <a name="change-the-pitr-backup-retention-period-by-using-powershell"></a>Изменение срока хранения резервной копии PITR с помощью PowerShell

[!INCLUDE [updated-for-az](../../../includes/updated-for-az.md)]
> [!IMPORTANT]
> Модуль PowerShell AzureRM по-прежнему поддерживается базой данных SQL и Управляемый экземпляр SQL, но вся будущая разработка предназначена для модуля AZ. SQL. Дополнительные сведения см. в разделе [AzureRM. SQL](/powershell/module/AzureRM.Sql/). Аргументы для команд в модуле AZ существенно идентичны параметрам в модулях AzureRm.

#### <a name="sql-database"></a>[База данных SQL](#tab/single-database)

Чтобы изменить срок хранения резервной копии PITR для активных баз данных SQL Azure, используйте следующий пример PowerShell.

```powershell
# SET new PITR backup retention period on an active individual database
# Valid backup retention must be between 1 and 35 days
Set-AzSqlDatabaseBackupShortTermRetentionPolicy -ResourceGroupName resourceGroup -ServerName testserver -DatabaseName testDatabase -RetentionDays 28
```

#### <a name="sql-managed-instance"></a>[Управляемый экземпляр SQL](#tab/managed-instance)

Чтобы изменить срок хранения резервной копии PITR для **отдельных активных** баз данных SQL управляемый экземпляр, используйте следующий пример PowerShell.

```powershell
# SET new PITR backup retention period on an active individual database
# Valid backup retention must be between 1 and 35 days
Set-AzSqlInstanceDatabaseBackupShortTermRetentionPolicy -ResourceGroupName resourceGroup -InstanceName testserver -DatabaseName testDatabase -RetentionDays 1
```

Чтобы изменить срок хранения резервной копии PITR для **всех активных** баз данных SQL управляемый экземпляр, используйте следующий пример PowerShell.

```powershell
# SET new PITR backup retention period for ALL active databases
# Valid backup retention must be between 1 and 35 days
Get-AzSqlInstanceDatabase -ResourceGroupName resourceGroup -InstanceName testserver | Set-AzSqlInstanceDatabaseBackupShortTermRetentionPolicy -RetentionDays 1
```

Чтобы изменить срок хранения резервной копии PITR для **отдельной удаленной** базы данных SQL управляемый экземпляр, используйте следующий пример PowerShell.
 
```powershell
# SET new PITR backup retention on an individual deleted database
# Valid backup retention must be between 0 (no retention) and 35 days. Valid retention rate can only be lower than the period of the retention period when database was active, or remaining backup days of a deleted database.
Get-AzSqlDeletedInstanceDatabaseBackup -ResourceGroupName resourceGroup -InstanceName testserver -DatabaseName testDatabase | Set-AzSqlInstanceDatabaseBackupShortTermRetentionPolicy -RetentionDays 0
```

Чтобы изменить PITR хранения резервных копий для **всех удаленных** баз данных SQL управляемый экземпляр, используйте следующий пример PowerShell.

```powershell
# SET new PITR backup retention for ALL deleted databases
# Valid backup retention must be between 0 (no retention) and 35 days. Valid retention rate can only be lower than the period of the retention period when database was active, or remaining backup days of a deleted database
Get-AzSqlDeletedInstanceDatabaseBackup -ResourceGroupName resourceGroup -InstanceName testserver | Set-AzSqlInstanceDatabaseBackupShortTermRetentionPolicy -RetentionDays 0
```

Ноль (0) дней, по истечении которого резервная копия будет немедленно удалена и больше не будет храниться в удаленной базе данных.
После уменьшения срока хранения резервной копии PITR для удаленной базы данных ее нельзя увеличить.

---

### <a name="change-the-pitr-backup-retention-period-by-using-the-rest-api"></a>Измените срок хранения резервной копии PITR с помощью REST API

#### <a name="sample-request"></a>Пример запроса

```http
PUT https://management.azure.com/subscriptions/00000000-1111-2222-3333-444444444444/resourceGroups/resourceGroup/providers/Microsoft.Sql/servers/testserver/databases/testDatabase/backupShortTermRetentionPolicies/default?api-version=2017-10-01-preview
```

#### <a name="request-body"></a>Текст запроса

```json
{
  "properties":{
    "retentionDays":28
  }
}
```

#### <a name="sample-response"></a>Пример ответа

Код состояния: 200.

```json
{
  "id": "/subscriptions/00000000-1111-2222-3333-444444444444/providers/Microsoft.Sql/resourceGroups/resourceGroup/servers/testserver/databases/testDatabase/backupShortTermRetentionPolicies/default",
  "name": "default",
  "type": "Microsoft.Sql/resourceGroups/servers/databases/backupShortTermRetentionPolicies",
  "properties": {
    "retentionDays": 28
  }
}
```

Дополнительные сведения о политиках краткосрочного хранения резервных копий см. [здесь](/rest/api/sql/backupshorttermretentionpolicies).

#### <a name="sample-request"></a>Пример запроса

```http
PUT https://management.azure.com/subscriptions/00000000-1111-2222-3333-444444444444/resourceGroups/resourceGroup/providers/Microsoft.Sql/servers/testserver/databases/testDatabase/backupShortTermRetentionPolicies/default?api-version=2017-10-01-preview
```

#### <a name="request-body"></a>Текст запроса

```json
{
  "properties":{
    "retentionDays":28
  }
}
```

#### <a name="sample-response"></a>Пример ответа

Код состояния: 200.

```json
{
  "id": "/subscriptions/00000000-1111-2222-3333-444444444444/providers/Microsoft.Sql/resourceGroups/resourceGroup/servers/testserver/databases/testDatabase/backupShortTermRetentionPolicies/default",
  "name": "default",
  "type": "Microsoft.Sql/resourceGroups/servers/databases/backupShortTermRetentionPolicies",
  "properties": {
    "retentionDays": 28
  }
}
```

Дополнительные сведения о политиках краткосрочного хранения резервных копий см. [здесь](/rest/api/sql/backupshorttermretentionpolicies).

## <a name="configure-backup-storage-redundancy"></a>Настройка избыточности хранилища резервных копий

> [!NOTE]
> Настраиваемая избыточность хранилища для резервных копий SQL Управляемый экземпляр может быть указана только во время процесса создания управляемого экземпляра. После подготовки ресурса нельзя изменить параметр избыточность хранилища резервных копий. Для базы данных SQL общедоступная Предварительная версия этой функции в настоящее время доступна в Южная Бразилия и общедоступна в регионе Azure Юго-Восточной Азии. 

Избыточность хранилища резервных копий управляемого экземпляра может быть задана только во время создания экземпляра. Для базы данных SQL ее можно задать при создании базы данных или обновить для существующей базы данных. Значение по умолчанию — геоизбыточное хранилище. Различия в ценах между локально избыточным, избыточным в пределах зоны и географически избыточным хранилищем резервных копий см. на [странице цен на управляемые экземпляры](https://azure.microsoft.com/pricing/details/azure-sql/sql-managed-instance/single/).

### <a name="configure-backup-storage-redundancy-by-using-the-azure-portal"></a>Настройка избыточности хранилища резервных копий с помощью портал Azure

#### <a name="sql-database"></a>[База данных SQL](#tab/single-database)

В портал Azure можно настроить избыточность хранилища резервных копий в колонке **Создание базы данных SQL** . Этот параметр доступен в разделе избыточность хранилища резервных копий. 
![Открыть колонку "Создание базы данных SQL"](./media/automated-backups-overview/sql-database-backup-storage-redundancy.png)

#### <a name="sql-managed-instance"></a>[Управляемый экземпляр SQL](#tab/managed-instance)

В портал Azure возможность изменить избыточность хранилища резервных копий находится в колонке " **расчеты + хранилище** ", доступной в параметре " **Настройка управляемый экземпляр** " на вкладке " **основные** " при создании управляемый экземпляр SQL.
![Откройте окно "расчеты и Настройка хранилища" — колонка](./media/automated-backups-overview/open-configuration-blade-managedinstance.png)

В колонке " **вычислить и хранилище** " найдите параметр избыточность хранилища резервных копий.
![Настройка избыточности хранилища резервных копий](./media/automated-backups-overview/select-backup-storage-redundancy-managedinstance.png)

---

### <a name="configure-backup-storage-redundancy-by-using-powershell"></a>Настройка избыточности хранилища резервных копий с помощью PowerShell

#### <a name="sql-database"></a>[База данных SQL](#tab/single-database)

Чтобы настроить избыточность хранилища резервных копий при создании новой базы данных, можно указать параметр-Баккупстоажередунданци. Возможные значения: GEO, Zone и local. По умолчанию все базы данных SQL используют геоизбыточное хранилище для резервных копий. Геовосстановление отключено, если база данных создается с локальным или избыточным хранилищем резервных копий в локальной зоне. 

```powershell
# Create a new database with geo-redundant backup storage.  
New-AzSqlDatabase -ResourceGroupName "ResourceGroup01" -ServerName "Server01" -DatabaseName "Database03" -Edition "GeneralPurpose" -Vcore 2 -ComputeGeneration "Gen5" -BackupStorageRedundancy Geo
```

Дополнительные сведения см. в описании [New-азсклдатабасе](/powershell/module/az.sql/new-azsqldatabase).

Чтобы обновить избыточность хранилища резервных копий существующей базы данных, можно использовать параметр-BackupStorageRedundancy. Возможные значения: GEO, Zone и local.
Обратите внимание, что для применения изменений к базе данных может потребоваться до 48 часов. Переключение с геоизбыточного хранилища резервных копий на локальное или в хранилище, избыточное в зоне, отключает географическое восстановление. 

```powershell
# Change the backup storage redundancy for Database01 to zone-redundant. 
Set-AzSqlDatabase -ResourceGroupName "ResourceGroup01" -DatabaseName "Database01" -ServerName "Server01" -BackupStorageRedundancy Zone
```

Дополнительные сведения см. в описании [Set-азсклдатабасе](/powershell/module/az.sql/set-azsqldatabase)

> [!NOTE]
> Чтобы использовать параметр-BackupStorageRedundancy с восстановлением базы данных, копированием базы данных или созданием вторичных операций, используйте Azure PowerShell версии AZ. SQL 2.11.0. 


#### <a name="sql-managed-instance"></a>[Управляемый экземпляр SQL](#tab/managed-instance)

Для настройки избыточности хранилища резервных копий во время создания управляемого экземпляра можно указать параметр-Баккупстоажередунданци. Возможные значения: GEO, Zone и local.

```powershell
New-AzSqlInstance -Name managedInstance2 -ResourceGroupName ResourceGroup01 -Location westcentralus -AdministratorCredential (Get-Credential) -SubnetId "/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/resourcegroup01/providers/Microsoft.Network/virtualNetworks/vnet_name/subnets/subnet_name" -LicenseType LicenseIncluded -StorageSizeInGB 1024 -VCore 16 -Edition "GeneralPurpose" -ComputeGeneration Gen4 -BackupStorageRedundancy Geo
```

Дополнительные сведения см. в описании [New-азсклинстанце](/powershell/module/az.sql/new-azsqlinstance).

---

## <a name="use-azure-policy-to-enforce-backup-storage-redundancy"></a>Использование политики Azure для обеспечения избыточности хранилища резервных копий

Если у вас есть требования к местонахождениеу данных, для которых требуется хранить все данные в одном регионе Azure, вы можете применить избыточные в пределах зоны или локально избыточные резервные копии базы данных SQL или Управляемый экземпляр с помощью политики Azure. Политика Azure — это служба, которую можно использовать для создания, назначения и управления политиками, которые применяют правила к ресурсам Azure. Политика Azure помогает защитить эти ресурсы в соответствии с корпоративными стандартами и соглашениями об уровне обслуживания. Дополнительные сведения см. в статье [Что такое служба "Политика Azure"?](../../governance/policy/overview.md). 

### <a name="built-in-backup-storage-redundancy-policies"></a>Встроенные политики избыточности хранилища резервных копий 

Добавлены следующие новые встроенные политики, которые можно назначить на уровне подписки или группы ресурсов, чтобы заблокировать создание новых баз данных или экземпляров с геоизбыточным хранилищем резервных копий. 

[База данных SQL не должна использовать избыточность GRS для резервных копий](https://portal.azure.com/#blade/Microsoft_Azure_Policy/PolicyDetailBlade/definitionId/%2Fproviders%2FMicrosoft.Authorization%2FpolicyDefinitions%2Fb219b9cf-f672-4f96-9ab0-f5a3ac5e1c13)

[Управляемые экземпляры SQL не должны использовать избыточность GRS для резервных копий](https://portal.azure.com/#blade/Microsoft_Azure_Policy/PolicyDetailBlade/definitionId/%2Fproviders%2FMicrosoft.Authorization%2FpolicyDefinitions%2Fa9934fd7-29f2-4e6d-ab3d-607ea38e9079)

Полный список определений встроенных политик для базы данных SQL и Управляемый экземпляр можно найти [здесь](./policy-reference.md).

Чтобы применить требования местонахождение данных на уровне Организации, эти политики можно назначить подписке. После того как они будут назначены на уровне подписки, пользователи в данной подписке не смогут создать базу данных или управляемый экземпляр с геоизбыточным хранилищем резервных копий с помощью портал Azure или Azure PowerShell. 

> [!IMPORTANT]
> Политики Azure не применяются при создании базы данных с помощью T-SQL. Чтобы принудительно применить местонахождение данных при создании базы данных с помощью T-SQL, [используйте в качестве входного аргумента "Local" или "Zone" для BACKUP_STORAGE_REDUNDANCY в инструкции CREATE DATABASE](/sql/t-sql/statements/create-database-transact-sql#create-database-using-zone-redundancy-for-backups).

Сведения о назначении политик с помощью [портал Azure](../../governance/policy/assign-policy-portal.md) или [Azure PowerShell](../../governance/policy/assign-policy-powershell.md)


## <a name="next-steps"></a>Дальнейшие действия

- Резервные копии базы данных являются важной частью любой стратегии непрерывности бизнес-процессов и аварийного восстановления, так как они защищают данные от случайного повреждения или удаления. Дополнительные сведения о других решениях для обеспечения непрерывности бизнес-процессов базы данных SQL см. в статье [Обзор непрерывности бизнес-процессов](business-continuity-high-availability-disaster-recover-hadr-overview.md).
- Получите дополнительные сведения о [восстановлении базы данных на момент времени с помощью портал Azure](recovery-using-backups.md).
- Получите дополнительные сведения о [восстановлении базы данных на момент времени с помощью PowerShell](scripts/restore-database-powershell.md).
- Сведения о настройке, управлении и восстановлении долгосрочного хранения автоматически создаваемых резервных копий в хранилище BLOB-объектов Azure с помощью портал Azure см. в статье [Управление долгосрочным хранением резервных копий с помощью портал Azure](long-term-backup-retention-configure.md).
- Сведения о настройке, управлении и восстановлении долгосрочного хранения автоматически создаваемых резервных копий в хранилище BLOB-объектов Azure с помощью PowerShell см. в статье [Управление долгосрочным хранением резервных копий с помощью PowerShell](long-term-backup-retention-configure.md).
- Дополнительные сведения о потреблении хранилища резервных копий в Управляемый экземпляр Azure SQL см. в статье [Использование хранилища резервных копий в управляемый экземпляр](https://aka.ms/mi-backup-explained).
- Чтобы узнать, как точно настроить хранение резервных копий и затраты на Управляемый экземпляр Azure SQL, ознакомьтесь [со статьей Настройка затрат на хранение резервных копий в управляемый экземпляр](https://aka.ms/mi-backup-tuning).
