---
title: Что такое синхронизация данных SQL для Azure?
description: В этом обзоре представлены синхронизация данных SQL для Azure, которые позволяют синхронизировать данные в нескольких облачных и локальных базах данных.
services: sql-database
ms.service: sql-database
ms.subservice: data-movement
ms.custom: data sync, sqldbrb=1, fasttrack-edit
ms.devlang: ''
ms.topic: conceptual
author: stevestein
ms.author: sstein
ms.reviewer: ''
ms.date: 08/20/2019
ms.openlocfilehash: c38e4681c76fb0dd52d77c7dc1438b87a9571a80
ms.sourcegitcommit: 18a91f7fe1432ee09efafd5bd29a181e038cee05
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/16/2021
ms.locfileid: "103562065"
---
# <a name="what-is-sql-data-sync-for-azure"></a>Что такое синхронизация данных SQL для Azure?

Синхронизация данных SQL — это служба, созданная на базе базы данных SQL Azure, которая позволяет синхронизировать данные, выбранные в двунаправленном режиме, между несколькими базами данных как локально, так и в облаке. 

> [!IMPORTANT]
> Azure синхронизация данных SQL в настоящее время не поддерживает Azure SQL Управляемый экземпляр.


## <a name="overview"></a>Обзор 

Синхронизация данных основана на концепции группы синхронизации. Группа синхронизации — это группа баз данных, которые необходимо синхронизировать.

Служба синхронизации данных использует звездообразную топологию для синхронизации данных. Вы определяете одну из баз данных в группе синхронизации как центральную базу данных. Остальные базы данных являются рядовыми базами данных. Синхронизация выполняется только между концентратором и отдельными членами.

- **Центральной базой данных** должна быть база данных SQL Azure.
- Это **могут быть базы данных** в базе данных SQL Azure или в экземплярах SQL Server.
- **База данных метаданных синхронизации** содержит метаданные и журнал для синхронизации данных. База данных метаданных синхронизации должна быть базой данных SQL Azure, расположенной в том же регионе, что и Центральная база данных. База данных метаданных синхронизации создана клиентом и принадлежит пользователю. У вас может быть только одна база данных метаданных синхронизации для каждого региона и подписки. База данных метаданных синхронизации не может быть удалена или переименована, пока существуют группы синхронизации или агенты синхронизации. Корпорация Майкрософт рекомендует создать пустую базу данных для метаданных синхронизации. Служба синхронизации данных создает таблицы в этой базе данных и часто выполняет рабочую нагрузку.

> [!NOTE]
> Если в качестве рядовой вы используете локальную базу данных, необходимо [установить и настроить локальный агент синхронизации](sql-data-sync-sql-server-configure.md#add-on-prem).

![Синхронизация данных между базами данных](./media/sql-data-sync-data-sql-server-sql-database/sync-data-overview.png)

Группа синхронизации имеет следующие свойства.

- **Схема синхронизации**: описывает, какие данные синхронизируются.
- **Направление синхронизации**: синхронизация может быть двунаправленной или выполняться в одном направлении. Это значит, что направление синхронизации может быть *концентратором и членом*, или же *членом центра* или обоими.
- **Интервал синхронизации** определяет, как часто выполняется синхронизация.
- **Политика устранения конфликтов** — это политика уровня группы, которая может задавать режим *Выигрывает концентратор* или *Member wins* (Выигрывает член).

## <a name="when-to-use"></a>Назначение

Синхронизация данных полезна в тех случаях, когда данные должны быть обновлены в нескольких базах данных SQL Azure или в SQL Server. Ниже приведены основных варианты использования синхронизации данных.

- **Гибридная синхронизация данных:** С помощью синхронизации данных можно синхронизировать данные между базами данных в SQL Server и базе данных SQL Azure, чтобы обеспечить гибридные приложения. Эта возможность может привлечь клиентов, которые рассматривают переход в облако и собираются поместить некоторые из своих приложений в Azure.
- **Распределенные приложения**. Во многих случаях полезно разделить разные рабочие нагрузки на разные базы данных. Например, если у вас есть большая рабочая база данных, но необходимо также выполнять рабочую нагрузку для составления отчетов и анализа этих данных, удобно иметь вторую базу данных для этих целей. Такой подход сводит к минимуму влияние на производительность производственной рабочей нагрузки. Чтобы синхронизировать эти две базы данных, можно использовать службу синхронизации данных.
- **Глобально распределенные приложения:** Многие компании охватывают несколько регионов и даже несколько стран или регионов. Чтобы свести к минимуму задержки в сети, рекомендуется хранить свои данные в регионе, ближайшем к вам. Используя синхронизацию данных, можно легко обеспечить синхронизацию баз данных в регионах по всему миру.

Синхронизация данных не является предпочтительным решением для следующих сценариев:

| Сценарий | Рекомендуемые решения |
|----------|----------------------------|
| Аварийное восстановление | [Геоизбыточные резервные копии Azure](automated-backups-overview.md) |
| масштаб чтения; | [Использование реплик только для чтения для распределения рабочих нагрузок запросов только для чтения (предварительная версия)](read-scale-out.md) |
| ETL (OLTP в OLAP); | [Фабрика данных Azure](https://azure.microsoft.com/services/data-factory/) или [SQL Server Integration Services](/sql/integration-services/sql-server-integration-services) |
| Миграция с SQL Server в базу данных SQL Azure. Однако синхронизация данных SQL можно использовать после завершения миграции, чтобы гарантировать синхронизацию исходного и целевого объектов.  | [Azure Database Migration Service](https://azure.microsoft.com/services/database-migration/) |
|||

## <a name="how-it-works"></a>Принцип работы

- **Отслеживание изменения данных**. Служба синхронизации данных отслеживают изменения при помощи триггеров вставки, обновления и удаления. Изменения записываются во вспомогательную таблицу в пользовательской базе данных. Обратите внимание, что BULK INSERT не запускает триггеры по умолчанию. Если FIRE_TRIGGERS не указан, триггеры INSERT не выполняются. Добавьте параметр FIRE_TRIGGERS, чтобы служба синхронизации данных могла отслеживать эти вставки. 
- **Синхронизация данных:** Синхронизация данных разработана в центрально-лучевой модели. Концентратор синхронизируется с каждым членом по отдельности. Изменения из центра загружаются в член, а затем изменения из участника передаются в центр.
- **Устранение конфликтов**. Служба синхронизации данных предоставляет два параметра для устранения конфликтов, *Выигрывает концентратор* и *Member wins* (Выигрывает член).
  - Если выбран параметр *Выигрывает концентратор*, то изменения в центральной базе данных всегда записываются поверх изменений в члене.
  - Если выбран параметр *Member wins* (Выигрывает член), то изменения в члене всегда записываются поверх изменений в центральной базе данных. Если имеется несколько членов, то конечное значение зависит от того, какой член синхронизируется первым.

## <a name="compare-with-transactional-replication"></a>Сравнение с репликацией транзакций

| | Синхронизация данных | репликация транзакций |
|---|---|---|
| **Преимущества** | — Поддержка режима "активный — активный"<br/>— Двусторонняя передача данных между локальной базой данных и службой "База данных SQL Azure" | — Низкая задержка<br/>— Согласованность транзакций<br/>— Повторное использование существующей топологии после миграции <br/>— Поддержка Управляемый экземпляр Azure SQL |
| **Недостатки** | — Отсутствует согласованность транзакций<br/>— Большее влияние на производительность | -Не удается опубликовать из базы данных SQL Azure <br/>— Дорогое обслуживание |

## <a name="private-link-for-data-sync-preview"></a>Частная ссылка для синхронизации данных (Предварительная версия)
Новая функция закрытой ссылки (Предварительная версия) позволяет выбрать управляемую закрытую конечную точку службы, чтобы установить безопасное подключение между службой синхронизации и базами данных-концентраторами в процессе синхронизации данных. Частная конечная точка, управляемая службой, является частным IP-адресом в пределах определенной виртуальной сети и подсети. В рамках синхронизации данных частная конечная точка, управляемая службой, создается корпорацией Майкрософт и монопольно используется службой синхронизации данных для данной операции синхронизации. Перед настройкой частной ссылки ознакомьтесь с [общими требованиями](sql-data-sync-data-sql-server-sql-database.md#general-requirements) для этой функции. 

![Частная ссылка для синхронизации данных](./media/sql-data-sync-data-sql-server-sql-database/sync-private-link-overview.png)

> [!NOTE]
> Необходимо вручную утвердить закрытую конечную точку, управляемую службой, на странице **подключения к частным конечным точкам** портал Azure во время развертывания группы синхронизации или с помощью PowerShell.

## <a name="get-started"></a>Начало работы 

### <a name="set-up-data-sync-in-the-azure-portal"></a>Настройка синхронизации данных на портале Azure

- [Настройка Синхронизации данных SQL Azure](sql-data-sync-sql-server-configure.md)
- Агент синхронизации данных: [Агент синхронизации данных для синхронизации данных SQL Azure](sql-data-sync-agent-overview.md).

### <a name="set-up-data-sync-with-powershell"></a>Настройка синхронизации данных с помощью PowerShell

- [Синхронизация нескольких баз данных в базе данных SQL Azure с помощью PowerShell](scripts/sql-data-sync-sync-data-between-sql-databases.md)
- [Использование PowerShell для синхронизации между базой данных в базе данных SQL Azure и базами данных в экземпляре SQL Server](scripts/sql-data-sync-sync-data-between-azure-onprem.md)

### <a name="set-up-data-sync-with-rest-api"></a>Настройка синхронизации данных с REST API
- [Использование REST API для синхронизации нескольких баз данных в базе данных SQL Azure](scripts/sql-data-sync-sync-data-between-sql-databases-rest-api.md)

### <a name="review-the-best-practices-for-data-sync"></a>Рекомендации по синхронизации данных

- [Best practices for SQL Data Sync (Preview)](sql-data-sync-best-practices.md) (Рекомендации по синхронизации данных SQL (предварительная версия))

### <a name="did-something-go-wrong"></a>Что-то пошло не так?

- [Устранение неполадок с синхронизацией данных SQL Azure (предварительная версия)](./sql-data-sync-troubleshoot.md)

## <a name="consistency-and-performance"></a>Согласованность и производительность

### <a name="eventual-consistency"></a>Итоговая согласованность

Так как синхронизация данных основана на триггерах, согласованность транзакций не гарантируется. Корпорация Майкрософт гарантирует, что все изменения будут внесены в конечном итоге, а синхронизация данных не приведет к потере данных.

### <a name="performance-impact"></a>Влияние на производительность

Служба синхронизация данных использует триггеры вставки, обновления и удаления для отслеживания изменений. Она создает вспомогательные таблицы в пользовательской базе данных для отслеживания изменений. Действия по отслеживанию изменений оказывают влияние на рабочую нагрузку базы данных. Оцените текущий уровень служб и повысьте его, если потребуется.

Подготовка и отзыв во время создания, обновление или удаления группы синхронизации могут повлиять на производительность базы данных.

## <a name="requirements-and-limitations"></a><a name="sync-req-lim"></a> Требования и ограничения

### <a name="general-requirements"></a>Общие требования

- Каждая таблица должна иметь первичный ключ. Не изменяйте значение первичного ключа ни в какой строке. Если это необходимо сделать, удалите строку и создайте ее повторно с новым значением первичного ключа.

> [!IMPORTANT]
> Изменение значения существующего первичного ключа приведет к появлению следующего поведения:
> - Данные между концентратором и элементом могут быть потеряны, хотя синхронизация не сообщает о каких-либо проблемах.
> - Синхронизация может завершиться ошибкой, так как таблица отслеживания содержит несуществующую строку из источника из-за изменения первичного ключа.

- Изоляция моментального снимка должна быть включена как для членов синхронизации, так и для центра. Дополнительные сведения см. в статье [Изоляция моментального снимка в SQL Server](/dotnet/framework/data/adonet/sql/snapshot-isolation-in-sql-server).

- Чтобы использовать частную связь с синхронизацией данных, обе базы данных-члены и концентраторы должны размещаться в Azure (один или несколько регионов) в одном типе облака (например, в общедоступном облаке или в облаке для государственных организаций). Кроме того, чтобы использовать частную ссылку, поставщики ресурсов Microsoft. Network должны быть зарегистрированы для подписок, на которых размещены серверы-концентратор и рядовой сервер. Наконец, необходимо вручную утвердить частную ссылку для синхронизации данных во время настройки синхронизации в разделе "подключения к частным конечным точкам" в портал Azure или с помощью PowerShell. Дополнительные сведения о том, как утвердить закрытую ссылку, см. в разделе [настройка синхронизация данных SQL](./sql-data-sync-sql-server-configure.md). После утверждения частной конечной точки, управляемой службой, все связи между службой синхронизации и базами данных-концентраторами будут выполняться по частной ссылке. Чтобы включить эту функцию, можно обновить существующие группы синхронизации.

### <a name="general-limitations"></a>Общие ограничения

- Таблица не может иметь столбец идентификаторов, который не является первичным ключом.
- Для использования синхронизации данных таблица должна иметь кластеризованный индекс.
- Первичный ключ не может иметь следующие типы данных: sql_variant, binary, varbinary, Image, XML.
- При использовании типов данных time, datetime, datetime2, datetimeoffset для первичного ключа нужно учитывать, что поддерживается точность только до секунды.
- Имена объектов (баз данных, таблиц и столбцов) не могут содержать печатные символы (.), левые квадратные скобки ([) или правая квадратная скобка (]).
- Имя таблицы не может содержать печатные символы:! "# $% ' () * +-пробел
- Azure Active Directory проверка подлинности не поддерживается.
- Если существуют таблицы с одинаковыми именами, но разными схемами (например, dbo. Customers и Sales. Customers), то в синхронизацию можно добавить только одну из таблиц.
- Столбцы с типами данных User-Defined не поддерживаются
- Перемещение серверов между разными подписками не поддерживается. 

#### <a name="unsupported-data-types"></a>Неподдерживаемые типы данных

- FileStream
- UDT SQL или CLR;
- XMLSchemaCollection (поддерживается XML);
- Cursor, RowVersion, Timestamp, Hierarchyid.

#### <a name="unsupported-column-types"></a>Неподдерживаемые типы столбцов

При синхронизации данных столбцы только для чтения и созданные системой столбцы не синхронизируются. Пример.

- вычисляемые столбцы;
- Созданные системой столбцы для темпоральных таблиц.

#### <a name="limitations-on-service-and-database-dimensions"></a>Ограничения характеристик служб и баз данных

| **Измерения**                                                  | **Ограничение**              | **Обходное решение**              |
|-----------------------------------------------------------------|------------------------|-----------------------------|
| Максимальное количество групп синхронизации, которым может принадлежать любая база данных       | 5                      |                             |
| Максимальное количество конечных точек в отдельной группе синхронизации              | 30                     |                             |
| Максимальное количество локальных конечных точек в отдельной группе синхронизации | 5                      | Создайте несколько групп синхронизации. |
| Имена баз данных, таблиц, схем и столбцов                       | Имя может содержать до 50 знаков. |                             |
| Таблицы в группе синхронизации                                          | 500                    | Создайте несколько групп синхронизации. |
| Столбцы в таблице в группе синхронизации                              | 1000                   |                             |
| Размер строки данных в таблице                                        | 24 МБ                  |                             |

> [!NOTE]
> В единственной группе синхронизации может находится до 30 конечных точек. Если имеется несколько групп синхронизации, общее количество конечных точек во всех группах синхронизации не может превышать 30. Если база данных принадлежит к нескольким группам синхронизации, она считается как несколько конечных точек, а не как одна.

### <a name="network-requirements"></a>Требования к сети

> [!NOTE]
> Если используется частная ссылка, эти требования к сети не применяются. 

Если группа синхронизации установлена, службе синхронизации данных необходимо подключиться к базе данных-концентратору. Во время установки группы синхронизации в параметрах сервера Azure SQL Server должна быть установлена следующая конфигурация `Firewalls and virtual networks` :

 * Параметр *запрет доступа к общедоступной сети* должен быть установлен в *Off*.
 * *Разрешить службам и ресурсам Azure доступ к этому серверу* должно быть задано значение *"Да"*, или необходимо создать правила IP- [адресов, используемые службой синхронизации данных](network-access-controls-overview.md#data-sync).

После создания и подготовки группы синхронизации эти параметры можно отключить. Агент синхронизации будет подключаться непосредственно к базе данных-концентратору, а также использовать [правила IP брандмауэра](firewall-configure.md) сервера или [частные конечные точки](private-endpoint-overview.md) , чтобы разрешить агенту доступ к серверу-концентратору.

> [!NOTE]
> Если изменить параметры схемы группы синхронизации, необходимо будет снова разрешить службе синхронизации данных доступ к серверу, чтобы можно было повторно подготовить базу данных-концентратор.

## <a name="faq-about-sql-data-sync"></a>Вопросы и ответы о синхронизации данных SQL

### <a name="how-much-does-the-sql-data-sync-service-cost"></a>Сколько стоит использование службы синхронизации данных SQL?

Плата за саму службу синхронизация данных SQL не взимается. Однако вы по-прежнему получаете оплату за передачу данных для перемещения данных в экземпляре базы данных SQL и из него. Дополнительные сведения см. на странице [цен на базу данных SQL](https://azure.microsoft.com/pricing/details/sql-database/).

### <a name="what-regions-support-data-sync"></a>Какие регионы поддерживают синхронизацию данных?

Синхронизация данных SQL доступна во всех регионах:

### <a name="is-a-sql-database-account-required"></a>Требуется ли учетная запись Базы данных SQL?

Да. Для размещения базы данных-концентратора необходима учетная запись базы данных SQL.

### <a name="can-i-use-data-sync-to-sync-between-sql-server-databases-only"></a>Можно ли использовать синхронизацию данных для синхронизации только между SQL Serverными базами данных

Не напрямую. Однако можно выполнить синхронизацию между SQL Serverными базами данных, создав центральную базу данных в Azure, а затем добавив локальные базы данных в группу синхронизации.

### <a name="can-i-use-data-sync-to-sync-between-databases-in-sql-database-that-belong-to-different-subscriptions"></a>Можно ли использовать синхронизацию данных для синхронизации баз данных в базе данных SQL, принадлежащих к разным подпискам

Да. Можно синхронизировать базы данных, принадлежащие к группам ресурсов, принадлежащим разным подпискам.

- Если подписки принадлежат к одному клиенту и у вас есть разрешения на все подписки, то на портале Azure можно настроить группу синхронизации.
- В противном случае необходимо использовать PowerShell, чтобы добавить участников синхронизации, которые принадлежат к другой подписке.

### <a name="can-i-use-data-sync-to-sync-between-databases-in-sql-database-that-belong-to-different-clouds-like-azure-public-cloud-and-azure-china-21vianet"></a>Можно ли использовать синхронизацию данных для синхронизации баз данных в базе данных SQL, принадлежащих к разным облакам (например, в общедоступном облаке Azure и в Azure Китая 21Vianet)

Да. Можно синхронизировать базы данных, принадлежащие разным облакам. Для добавления элементов синхронизации, относящихся к разным подпискам, необходимо использовать PowerShell.

### <a name="can-i-use-data-sync-to-seed-data-from-my-production-database-to-an-empty-database-and-then-sync-them"></a>Можно ли использовать синхронизацию данных для заполнения данных из рабочей базы данных в пустую базу данных с последующей синхронизацией?

Да. Вручную создайте схему в новой базе данных из оригинала с помощью скрипта. После создания схемы добавьте таблицы в группу синхронизации, чтобы скопировать данные и обеспечить их синхронизацию.

### <a name="should-i-use-sql-data-sync-to-back-up-and-restore-my-databases"></a>Следует ли использовать Синхронизацию данных SQL для резервного копирования и восстановления баз данных?

Не рекомендуется использовать синхронизация данных SQL для создания резервной копии данных. Невозможно выполнить резервное копирование и восстановление на конкретный момент времени, так как синхронизация данных SQL синхронизации не имеют версий. Кроме того, синхронизация данных SQL не выполняет резервное копирование других объектов SQL, таких как хранимые процедуры, и не позволяет быстро выполнить операцию восстановления.

Один из рекомендуемых методов резервного копирования см. [в разделе копирование базы данных в базе данных SQL Azure](database-copy.md).

### <a name="can-data-sync-sync-encrypted-tables-and-columns"></a>Можно ли с помощью службы "Синхронизация данных" синхронизировать зашифрованные таблицы и столбцы?

- Если в базе данных используется Always Encrypted, можно синхронизировать только те таблицы и столбцы, которые *не* зашифрованы. Синхронизировать зашифрованные столбцы невозможно, так как служба синхронизации данных не может расшифровать данные.
- Если к столбцу применяется шифрование на уровне столбцов (CLE), то его можно синхронизировать, если размер строки не превышает 24 МБ (это максимальный размер). Служба синхронизации данных обрабатывает столбец, зашифрованный с помощью ключа, как обычные двоичные данные. Чтобы расшифровать данные других участников синхронизации, необходимо иметь тот же сертификат, что и они.

### <a name="is-collation-supported-in-sql-data-sync"></a>Поддерживаются ли в Синхронизации данных SQL параметры сортировки?

Да. Синхронизация данных SQL поддерживает параметры сортировки в следующих сценариях.

- Если выбранные таблицы схемы синхронизации еще не находятся в базах данных концентратора или элемента, то при развертывании группы синхронизации служба автоматически создает соответствующие таблицы и столбцы с параметрами сортировки, выбранными в пустых целевых базах данных.
- Если синхронизируемые таблицы уже существуют как в центральной базе данных, так и в рядовых базах данных, синхронизация данных SQL требует, чтобы столбцы первичного ключа имели одинаковые параметры сортировки в центральной базе данных и рядовых базах данных, для успешного развертывания группы синхронизации. Для столбцов, отличных от столбцов первичного ключа, на параметры сортировки нет ограничений.

### <a name="is-federation-supported-in-sql-data-sync"></a>Поддерживается ли федерация в Синхронизации данных SQL?

Корневая база данных федерации может использоваться в службе синхронизации данных SQL без каких-либо ограничений. Невозможно добавить конечную точку федеративной базы данных в текущую версию синхронизация данных SQL.

### <a name="can-i-use-data-sync-to-sync-data-exported-from-dynamics-365-using-bring-your-own-database-byod-feature"></a>Можно ли использовать синхронизацию данных для синхронизации данных, экспортированных из Dynamics 365 с помощью функции "использовать собственную базу данных (BYOD)"?

Функция Dynamics 365 "внедрить собственную базу данных" позволяет администраторам экспортировать сущности данных из приложения в собственную базу данных SQL Microsoft Azure. Синхронизацию данных можно использовать для синхронизации этих данных в других базах данных, если данные экспортируются с помощью **добавочной push-уведомления** (полная отправка не поддерживается) и для параметра **включить триггеры в целевой базе данных** задано значение **Да**.

## <a name="next-steps"></a>Дальнейшие действия

### <a name="update-the-schema-of-a-synced-database"></a>Обновление схемы синхронизированной базы данных

Вам нужно обновить схему базы данных в группе синхронизации? Изменения схемы не реплицируются автоматически. Некоторые решения описаны в следующих статьях:

- [Автоматизация репликации изменений схемы с помощью синхронизация данных SQL в Azure](./sql-data-sync-update-sync-schema.md)
- [Использование PowerShell для обновления схемы синхронизации в существующей группе синхронизации](scripts/update-sync-schema-in-sync-group.md)

### <a name="monitor-and-troubleshoot"></a>Мониторинг и устранение неполадок

Синхронизация данных SQL выполнить так, как ожидалось? Сведения об отслеживании действий и устранении неполадок см. в следующих статьях:

- [Мониторинг синхронизации данных SQL с помощью журналов Azure Monitor](./monitor-tune-overview.md)
- [Устранение неполадок с синхронизацией данных SQL Azure (предварительная версия)](./sql-data-sync-troubleshoot.md)

### <a name="learn-more-about-azure-sql-database"></a>См. дополнительные сведения о Базе данных SQL Azure

Дополнительные сведения о базе данных SQL Azure см. в следующих статьях:

- [Обзор Базы данных SQL](sql-database-paas-overview.md)
- [Управление жизненным циклом базы данных](/previous-versions/sql/sql-server-guides/jj907294(v=sql.110))
