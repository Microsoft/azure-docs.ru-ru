---
title: Управление схемой в однотенантном приложении
description: Сведения об управлении схемой для нескольких клиентов в однотенантном приложении, использующем службу "База данных SQL Azure".
services: sql-database
ms.service: sql-database
ms.subservice: scenario
ms.custom: sqldbrb=1
ms.devlang: ''
ms.topic: tutorial
author: stevestein
ms.author: sstein
ms.reviewer: ''
ms.date: 09/19/2018
ms.openlocfilehash: e4328be0aade0658dedb034dbbb6980b810f771a
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "92793200"
---
# <a name="manage-schema-in-a-saas-application-using-the-database-per-tenant-pattern-with-azure-sql-database"></a>Управление схемой в приложении SaaS с помощью шаблона с однотенантной базой данных с использованием Базы данных SQL Azure
[!INCLUDE[appliesto-sqldb](../includes/appliesto-sqldb.md)]
 
По мере развития приложения базы данных в схему базы данных или эталонные данные обязательно придется вносить изменения.  Кроме того, иногда нужно выполнять задачи обслуживания базы данных. Для управления приложением, использующим шаблон с однотенантной базой данных, требуется, чтобы эти изменения и задачи обслуживания применялись ко всем базам данных клиентов.

В этом руководстве рассматривается два сценария: развертывание обновлений эталонных данных на всех клиентах и перестройка индекса для таблицы, содержащей эталонные данные. Функция [Задания обработки эластичных баз данных](./elastic-jobs-overview.md) позволяет выполнять эти действия на всех клиентских базах данных, а также в шаблоне базы данных, используемом для создания новых баз данных клиентов.

Из этого руководства вы узнаете, как выполнить следующие задачи:

> [!div class="checklist"]
> 
> * Создание агента задания.
> * Вызов заданий T-SQL для выполнения во всех клиентских базах данных.
> * Обновление ссылочных данных во всех базах данных клиента.
> * Создание индекса для таблицы во всех базах данных клиента.


Для работы с этим руководством выполните следующие предварительные требования:

* Развернуть SaaS-приложение Wingtip Tickets c однотенантной базой данных. См. инструкции из руководства по быстрому [развертыванию SaaS-приложения Wingtip Tickets c однотенантной БД](./saas-dbpertenant-get-started-deploy.md).
* Установите Azure PowerShell. Дополнительные сведения см. в статье [Начало работы с Azure PowerShell](/powershell/azure/get-started-azureps).
* Установите последнюю версию SQL Server Management Studio (SSMS). [Download SQL Server Management Studio (SSMS)](/sql/ssms/download-sql-server-management-studio-ssms) (Скачивание SQL Server Management Studio (SSMS))


## <a name="introduction-to-saas-schema-management-patterns"></a>Общие сведения о шаблонах управления схемой SaaS

Шаблон с однотенантной базой данных эффективно изолирует данные клиента, но увеличивает количество баз данных для управления и обслуживания. [Задания обработки эластичных баз данных](./elastic-jobs-overview.md) упрощают администрирование нескольких баз данных и управление ими. Задания позволяют вам безопасно и надежно выполнять задачи (скрипты Transact-SQL) в группах баз данных. Эти задания могут развертывать схемы и обычные изменения эталонных данных по всем клиентским базам данных в приложении. Задания обработки эластичных БД также могут использоваться для обслуживания *шаблона* базы данных, применяемого для создания клиентов, обеспечивая его самыми последними схемами и эталонными данными.

![экран](./media/saas-tenancy-schema-management/schema-management-dpt.png)


## <a name="elastic-jobs-public-preview"></a>Задания обработки эластичных баз данных (общедоступная предварительная версия)

Существует новая версия заданий обработки эластичных баз данных, которая является интегрированным компонентом Базы данных SQL Azure. Сейчас новая версия заданий обработки эластичных баз данных предоставляется в общедоступной предварительной версии. Эта общедоступная предварительная версия поддерживает создание агента заданий с помощью PowerShell и создание заданий и управление ими с помощью T-SQL.
Сведения см. в статье [Создание и настройка заданий обработки эластичных баз данных, а также управление ими (предварительная версия)](./elastic-jobs-overview.md).

## <a name="get-the-wingtip-tickets-saas-database-per-tenant-application-scripts"></a>Получение скриптов для SaaS-приложения Wingtip Tickets c однотенантной базой данных

Исходный код приложения и скрипты управления доступны в репозитории GitHub [WingtipTicketsSaaS-DbPerTenant](https://github.com/Microsoft/WingtipTicketsSaaS-DbPerTenant). Инструкции по скачиванию и разблокированию сценариев приложения SaaS Wingtip Tickets см. в статье [Общие рекомендации по работе с примерами приложений SaaS Wingtip Tickets](saas-tenancy-wingtip-app-guidance-tips.md).

## <a name="create-a-job-agent-database-and-new-job-agent"></a>Создание агента заданий и базы данных для него

В этом руководстве требуется использовать PowerShell для создания агента заданий и базы данных для него. База данных агента заданий содержит определения заданий, их состояния и журнал. Создав агент заданий и соответствующую базу данных, вы можете сразу создавать и отслеживать задания.

1. **В среде PowerShell ISE** выберите …\\Learning Modules\\Schema Management\\*Demo-SchemaManagement.ps1*.
1. Нажмите клавишу **F5** для запуска скрипта.

Скрипт *Demo-SchemaManagement.ps1* вызовет скрипт *Deploy-SchemaManagement.ps1* для создания базы данных с именем *osagent* на сервере каталога. Затем он создает агент заданий, используя базу данных в качестве параметра.

## <a name="create-a-job-to-deploy-new-reference-data-to-all-tenants"></a>Создание задания и развертывание новых справочных данных на всех клиентах

В приложении Wingtip Tickets каждая клиентская база данных включает набор поддерживаемых типов мест проведения. Каждое место проведения относится к определенному типу, который определяет тип потенциальных мероприятий и фоновое изображение, используемое в приложении. Чтобы приложение поддерживало новые типы мероприятий, необходимо обновить эталонные данные и добавить новые типы мест проведения.  В этом упражнении вы развернете обновление на все базы данных клиентов, чтобы добавить два дополнительных типа объекта: *Мотоциклетные гонки* и *Плавательный клуб*.

Сначала проверьте типы мест проведения, включенные в каждой клиентской базе данных. Подключитесь к одной из клиентских баз данных в SQL Server Management Studio (SSMS) и проверьте таблицу VenueTypes.  Выполнить запрос к этой таблице можно также в редакторе запросов на портале Azure, открыв его со страницы базы данных. 

1. Откройте SSMS и подключитесь к клиентскому серверу *tenants1-dpt-&lt;пользователь&gt;.database.windows.net*.
1. Перейдите к базе данных _contosoconcerthall_ на сервере *tenants1-dpt-&lt;пользователь&gt;* и запросите таблицу *VenueTypes*, чтобы убедиться, что места проведения *Motorcycle Racing* (Мотоциклетные гонки) и *Swimming Club (Плавательный клуб)* **отсутствуют**.

Давайте создадим задание для обновления таблицы *VenueTypes* во всех базах данных клиентов и добавим новые типы объектов.

Чтобы создать задание, используется набор системно хранимых процедур заданий, созданный в базе данных _jobagent_ при создании агента заданий.

1. В среде SSMS подключитесь к серверу каталогов: *catalog-dpt-&lt;пользователь&gt;.database.windows.net*. 
1. В среде SSMS выберите …\\Learning Modules\\Schema Management\\DeployReferenceData.sql
1. Измените инструкцию: SET @wtpUser = &lt;user&gt;, заменив значение User значением, использованным при развертывании SaaS-приложения Wingtip Tickets c однотенантной БД.
1. Убедитесь, что вы подключены к базе данных _jobagent_, и нажмите клавишу **F5** для запуска скрипта.

В скрипте *DeployReferenceData.sql* обратите внимание на следующие элементы:
* **sp\_add\_target\_group** создает целевую группу с именем DemoServerGroup.
* **sp\_add\_target\_group\_member** определяет набор целевых баз данных.  Сначала добавляется сервер _tenants1-dpt-&lt;пользователь&gt;_.  Добавление сервера в качестве целевого объекта приводит к тому, что базы данных на этом сервере во время выполнения задания будут включены в задание. Затем базы данных _basetenantdb_ и *adhocreporting* (в следующем руководстве) будут добавлены в качестве целевых объектов.
* **sp\_add\_job** создает задание с названием _Reference Data Deployment_ (Развертывание эталонных данных).
* **sp\_add\_jobstep** создает шаг задания, содержащий текст команды T-SQL для обновления ссылочной таблицы VenueTypes.
* Остальные представления в скрипте отображают сведения о существовании объектов и отслеживают выполнение задания мониторинга. С помощью этих запросов можно просмотреть значение состояния в столбце **lifecycle**, чтобы определить, когда задание будет завершено во всех целевых базах данных.

После выполнения скрипта вы можете проверить, были ли эталонные данные обновлены.  В SSMS перейдите к базе данных *contosoconcerthall* на сервере *tenants1-dpt -&lt;пользователь&gt;* и запросите таблицу *VenueTypes*.  Убедитесь, что *Мотоциклетные гонки* и *Плавательный клуб* **теперь** присутствуют.


## <a name="create-a-job-to-manage-the-reference-table-index"></a>Создание задания для управления индексом справочной таблицы

В этом разделе используется задание для перестройки индекса первичного ключа ссылочной таблицы.  Это обычная операция обслуживания базы данных, которую можно выполнить после загрузки больших объемов данных.

Создайте задание, используя те же системно хранимые процедуры задания.

1. Откройте среду SSMS и подключитесь к серверу _catalog-dpt-&lt;пользователь&gt;.database.windows.net_.
1. Откройте файл _...\\Learning Modules\\Schema Management\\OnlineReindex.sql_.
1. Щелкните правой кнопкой мыши, выберите "Подключение" и подключитесь к серверу _catalog-dpt-&lt;пользователь&gt;.database.windows.net_, если вы еще не сделали это.
1. Убедитесь, что вы подключены к базе данных _jobagent_, и нажмите клавишу **F5** для запуска скрипта.

В скрипте _OnlineReindex.sql_ обратите внимание на следующие элементы:
* **sp\_add\_job** создает новое задание с именем Online Reindex PK\_\_VenueTyp\_\_265E44FD7FD4C885
* **sp\_add\_jobstep** создает шаг задания, содержащий текст команды T-SQL для обновления индекса
* Остальные представления в скрипте отслеживают выполнение задания. С помощью этих запросов можно просмотреть значение состояния в столбце **lifecycle**, чтобы определить, когда задание будет успешно завершено во всех целевых элементах группы.



## <a name="next-steps"></a>Дальнейшие действия

Из этого руководства вы узнали, как выполнять такие задачи:

> [!div class="checklist"]
> 
> * Создание агента заданий для выполнения заданий T-SQL в нескольких базах данных.
> * Обновление ссылочных данных во всех базах данных клиента.
> * Создание индекса для таблицы во всех базах данных клиента.

После этого ознакомьтесь с руководством по [автоматизированной системе отчетности](./saas-tenancy-cross-tenant-reporting.md), чтобы узнать о выполнении распределенных запросов в клиентских базах данных.


## <a name="additional-resources"></a>Дополнительные ресурсы

* [Дополнительные руководства по использованию развертывания SaaS-приложения Wingtip Tickets c однотенантной БД](./saas-dbpertenant-wingtip-app-overview.md#sql-database-wingtip-saas-tutorials)
* [Управление масштабируемыми облачными базами данных](./elastic-jobs-overview.md)