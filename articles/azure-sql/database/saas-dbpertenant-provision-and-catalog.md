---
title: Подготовка новых клиентов в мультитенантном приложении
description: Узнайте, как подготовить и каталогизировать новые клиенты в мультитенантном приложении SaaS Базы данных SQL Azure.
services: sql-database
ms.service: sql-database
ms.subservice: scenario
ms.custom: seo-lt-2019, sqldbrb=1
ms.devlang: ''
ms.topic: tutorial
author: stevestein
ms.author: sstein
ms.reviewer: ''
ms.date: 09/24/2018
ms.openlocfilehash: 26add03929551c912b4d7b7cf10741d53333689a
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "92780569"
---
# <a name="learn-how-to-provision-new-tenants-and-register-them-in-the-catalog"></a>Сведения о подготовке новых клиентов и их регистрации в каталоге
[!INCLUDE[appliesto-sqldb](../includes/appliesto-sqldb.md)]

В этом руководстве вы узнаете, как для подготовить и каталогизировать шаблоны SaaS. Вы также узнаете, как они реализуются в приложении SaaS Wingtip Tickets, использующем одну базу данных. Мы создадим и инициализируем базы данных клиента, а также зарегистрируем их в каталоге клиента приложения. Каталог — это база данных, поддерживающая сопоставление между разными клиентами приложений SaaS и их данными. Каталог играет важную роль, направляя запросы приложений и управляющие запросы к надлежащим базам данных.

В этом руководстве описано следующее:

> [!div class="checklist"]
>
> * Подготовка отдельного нового клиента.
> * Подготовка пакета дополнительных клиентов.


Для работы с этим руководством выполните следующие предварительные требования:

* Должно быть развернуто приложение SaaS Wingtip Tickets, использующее одну базу данных на клиент. Чтобы развернуть его меньше чем за пять минут, ознакомьтесь с руководством по быстрому [развертыванию приложения SaaS Wingtip Tickets, использующего одну базу данных на клиент](./saas-dbpertenant-get-started-deploy.md).
* Установите Azure PowerShell. Дополнительные сведения см. в статье [Начало работы с Azure PowerShell](/powershell/azure/get-started-azureps).

## <a name="introduction-to-the-saas-catalog-pattern"></a>Общие сведения о шаблоне каталога SaaS

В мультитенантном приложении SaaS на основе базы данных важно знать, где хранятся сведения для каждого клиента. В схеме работы с каталогом SaaS используется база данных каталога, в которой содержатся сопоставления между клиентами и их базами данных. Этот шаблон применяется, когда данные клиента распределены по нескольким базам данных.

Каждый клиент определяет ключ в каталоге, который сопоставляется с расположением базы данных этого клиента. В приложении Wingtip Tickets ключ формируется из хэша имени клиента. Такая схема позволяет приложению использовать в ключе имя клиента, указанное в URL-адресе приложения. Вы можете использовать и другие схемы ключа клиента.

Каталог позволяет изменять имя или расположение базы данных с минимальным воздействием на приложение. В мультитенантной модели базы данных это также обеспечивает перемещение клиента между базами данных. Кроме того, каталог можно использовать, чтобы указать, находится ли клиент или база данных вне сети для обслуживания или других действий. Эта возможность рассматривается в руководстве [Восстановление отдельного клиента приложения SaaS, использующего одну базу данных на клиент](saas-dbpertenant-restore-single-tenant.md).

В каталоге также могут храниться дополнительные метаданные клиента или базы данных, такие как версия схемы, план обслуживания или соглашения об уровне обслуживания, предлагаемые клиентам. Каталог может содержать и другие сведения, которые обеспечивают управление приложениями, работу службы поддержки или операции DevOps.

Помимо функций для приложения SaaS, каталог позволяет включить средства для баз данных. В примере приложения SaaS Wingtip Tickets, использующем одну базу данных на клиент, каталог поддерживает межклиентские запросы. Такая схема подробно описана в [руководстве по автоматизированной системе отчетности](saas-tenancy-cross-tenant-reporting.md). Управление перекрестными заданиями в базах данных рассматривается в руководствах [Управление схемой в приложении SaaS с помощью шаблона с однотенантной базой данных с использованием базы данных SQL Azure](saas-tenancy-schema-management.md) и [Межклиентская аналитика с помощью извлеченных данных](saas-tenancy-tenant-analytics.md).

Каталог в приложении SaaS Wingtip Tickets реализуется с помощью функций управления сегментами из [клиентской библиотеки эластичной базы данных (EDCL)](elastic-database-client-library.md). Библиотека EDCL доступна для Java и платформы .NET Framework. EDCL позволяет приложению создавать, администрировать и использовать карту сегментов на основе базы данных.

Карта сегментов содержит список сегментов (баз данных) и сопоставления между ключами (клиентами) и сегментами. Функции EDCL используются во время подготовки клиента для создания записей в сопоставлении сегментов. Они используются приложениями во время выполнения для подключения к нужной базе данных. Служба EDCL кэширует сведения о подключении, чтобы уменьшить объем входящего трафика для базы данных каталога и ускорить работу приложения.

> [!IMPORTANT]
> Данные сопоставления доступны в базе данных каталога. *Не изменяйте их*. Изменяйте данные сопоставления только с помощью интерфейсов API EDCL. Прямые манипуляции с данными сопоставления могут привести к повреждению каталога. Такие операции не поддерживаются.


## <a name="introduction-to-the-saas-provisioning-pattern"></a>Общие сведения о шаблоне подготовки SaaS

Когда в приложении SaaS подключается новый клиент, использующий модель базы данных с одним клиентом, необходимо подготовить новую базу данных клиента. База данных должна быть создана в соответствующем расположении и на соответствующем уровне служб. Она также должна быть инициализирована с помощью соответствующей схемы и ссылочных данных. И эта база данных должна быть зарегистрирована в каталоге с помощью соответствующего ключа клиента.

Можно использовать различные способы подготовки базы данных. Можно выполнить сценарии SQL, развернуть BACPAC-файл или скопировать шаблон базы данных.

Подготовка базы данных должна быть частью стратегии управления схемами. Необходимо убедиться, что новые базы данных подготавливаются с помощью самой последней схемы. Это требование описано в руководстве [Управление схемой для нескольких клиентов в мультитенантном приложении, использующем Базу данных SQL Azure](saas-tenancy-schema-management.md).

Рассматриваемое приложение SaaS Wingtip Tickets, использующее одну базу данных на клиент, предоставляет для каждого клиента отдельную копию шаблона базы данных _basetenantdb_, который развернут на сервере каталога. Подготовку можно интегрировать в приложение как часть процесса регистрации. Можно также обеспечить ее вне сети с помощью сценариев. В этом руководстве описана подготовка с помощью PowerShell.

Сценарии подготовки копируют базу данных _basetenantdb_ для создания базы данных клиента в эластичном пуле. База данных клиента создается на сервере клиента, сопоставленном с DNS-псевдонимом _newtenant_. Этот псевдоним содержит ссылку на сервер, используемый для подготовки новых клиентов. В руководствах по аварийному восстановлению псевдоним обновляется с добавлением ссылки на сервер восстановления клиента ([аварийное восстановление с помощью географического восстановления](./saas-dbpertenant-dr-geo-restore.md), [аварийное восстановление с помощью георепликации](./saas-dbpertenant-dr-geo-replication.md)). Затем эти сценарии инициализируют базу данных с помощью данных клиента и регистрируют ее в сопоставлении сегментов каталога. Базы данных клиента именуются на основе имени клиента. Эта схема именования не является критически важной частью шаблона. Каталог сопоставляет ключ клиента с именем базы данных, поэтому можно использовать любое соглашение об именовании.


## <a name="get-the-wingtip-tickets-saas-database-per-tenant-application-scripts"></a>Получение сценариев для приложения SaaS Wingtip Tickets, использующего одну базу данных на клиент

Исходный код и сценарии приложения SaaS Wingtip Tickets доступны в репозитории GitHub [WingtipTicketsSaaS-DbPerTenant](https://github.com/Microsoft/WingtipTicketsSaaS-DbPerTenant). Инструкции по скачиванию и разблокированию сценариев приложения SaaS Wingtip Tickets см. в статье [Общие рекомендации по работе с примерами приложений SaaS Wingtip Tickets](saas-tenancy-wingtip-app-guidance-tips.md).


## <a name="provision-and-catalog-detailed-walkthrough"></a>Подробное пошаговое руководство по подготовке и каталогизации

Чтобы понять, как приложение Wingtip Tickets подготавливает новый клиент, добавьте точку останова и ознакомьтесь с пошаговым процессом подготовки клиента.

1. В интегрированной среде сценариев PowerShell откройте файл …\\Learning Modules\\ProvisionAndCatalog\\_Demo-ProvisionAndCatalog.ps1_ и задайте следующие параметры.

   * **$TenantName** — имя нового мероприятия (например, *Bushwillow Blues*).
   * **$VenueType** — один из предопределенных типов мест проведения: _blues_, classicalmusic, dance, jazz, judo, motorracing, multipurpose, opera, rockmusic, soccer.
   * Для параметра **$DemoScenario** =  установите значение **1**, чтобы *подготовить один клиент*.

2. Добавьте точку останова, поместив курсор в любом месте строки, содержащей *New-Tenant `*. Нажмите клавишу F9.

   ![Снимок экрана: скрипт с выделенной строкой New-Tenant для добавления точки останова.](./media/saas-dbpertenant-provision-and-catalog/breakpoint.png)

3. Нажмите клавишу F5 для запуска сценария.

4. После остановки выполнения сценария в точке останова нажмите клавишу F11, чтобы пошагово выполнить код.

   ![Отладка](./media/saas-dbpertenant-provision-and-catalog/debug.png)



Выполните трассировку сценария с помощью пунктов меню **Отладка**. Используйте клавиши F10 и F11, чтобы обходить вызываемые функции или переходить в них. Дополнительные сведения об отладке сценариев PowerShell см. в разделе [Отладка сценариев в интегрированной среде сценариев Windows PowerShell](/powershell/scripting/components/ise/how-to-debug-scripts-in-windows-powershell-ise).


Нет необходимости явно выполнять этот рабочий процесс. Здесь объясняется, как выполнить отладку сценария.

* **Импортируйте модуль CatalogAndDatabaseManagement.psm1.** Он предоставляет каталог и абстракцию уровня клиента с помощью функций [управления сегментами](elastic-scale-shard-map-management.md). Этот модуль инкапсулирует большую часть шаблона каталога. Его следует изучить.
* **Импортируйте модуль SubscriptionManagement.psm1.** Он содержит функции для входа в Azure и выбора подписки Azure для работы.
* **Получите сведения о конфигурации.** Перейдите к функции Get-Configuration (нажав клавишу F11) и посмотрите, как указывается конфигурация приложения. Здесь определены имена ресурсов и другие значения для приложения. Не изменяйте эти значения, пока не ознакомитесь со сценариями.
* **Получите объект каталога.** Перейдите к функции Get-Catalog, которая составляет и возвращает объект каталога, используемый в сценарии более высокого уровня. При этом используются функции управления сегментами, импортируемые из **AzureShardManagement.psm1**. Объект каталога состоит из следующих элементов.

   * $catalogServerFullyQualifiedName создается с использованием стандартного корня и имени пользователя: _catalog-\<user\>.database.windows .net_.
   * $catalogDatabaseName извлекается из файла конфигурации: *tenantcatalog*.
   * Объект $shardMapManager инициализируется из базы данных каталога.
   * Объект $shardMap инициализируется из карты сегментов _tenantcatalog_ в базе данных каталога. Объект каталога составляется и возвращается. Он используется в сценарии более высокого уровня.
* **Вычислите новый ключ клиента.** Для создания ключа клиента из имени клиента используется хэш-функция.
* **Проверьте наличия ключа клиента.** Каталог проверяется, чтобы убедиться, что ключ доступен.
* **Подготовка базы данных клиента с помощью New-TenantDatabase.** Используйте клавишу F11, чтобы перейти к функции и узнать, как база данных подготавливается с помощью [шаблона Azure Resource Manager](../../azure-resource-manager/templates/quickstart-create-templates-use-the-portal.md).

    Имя базы данных создается на основе имени клиента, чтобы было ясно, какие сегменты принадлежит определенному клиенту. Можно также использовать другие соглашения об именовании баз данных. При помощи шаблона Resource Manager создается база данных клиента. Для этого шаблон базы данных _baseTenantDB_ копируется на сервер каталога. В качестве альтернативы можно создать базу данных и инициализировать ее, импортировав BACPAC-файл. Или можно выполнить сценарий инициализации из известного расположения.

    Шаблон Resource Manager находится в папке …\Learning Modules\Common\: *tenantdatabasecopytemplate.json*

* **Выполняется дальнейшая инициализация базы данных клиента.** Добавляются имя и тип места проведения (клиент). Здесь можно также выполнить инициализацию других компонентов.

* **База данных клиента регистрируется в каталоге.** Она регистрируется функцией *Add-TenantDatabaseToCatalog* с помощью ключа клиента. Используйте клавишу F11, чтобы просмотреть дополнительные сведения.

    * База данных каталога добавляется на карту сегментов (список известных баз данных).
    * Создается сопоставление, которое связывает значение ключа с сегментом.
    * В таблицу Tenants в каталоге добавляются дополнительные метаданные клиента (название места проведения). Таблица клиентов не входит в схему Shard Management и не устанавливается EDCL. В этой таблице показано, как базу данных каталога можно расширить для поддержки дополнительных данных приложения.


После завершения подготовки возобновляется выполнение исходного сценария *Demo-ProvisionAndCatalog*. В браузере откроется страница **Events** (События) нового клиента.

   ![Страница "Events" (События)](./media/saas-dbpertenant-provision-and-catalog/new-tenant.png)


## <a name="provision-a-batch-of-tenants"></a>Подготовка пакета клиентов

В этом упражнении подготавливается пакет из 17 клиентов. Рекомендуем подготовить этот пакет клиентов перед переходом к другим руководствам по приложению SaaS Wingtip Tickets, использующему одну базу данных на клиент. Вам будет удобнее с ними работать при наличии достаточного количества баз данных.

1. В интегрированной среде сценариев PowerShell откройте файл ...\\Learning Modules\\ProvisionAndCatalog\\*Demo-ProvisionAndCatalog.ps1*. Измените значение параметра *$DemoScenario* на 3.

   * Для параметра **$DemoScenario** =  установите значение **3**, чтобы *подготовить пакет клиентов*.
2. Нажмите клавишу F5 для запуска сценария.

Скрипт подготовит пакет дополнительных клиентов. Он использует [шаблон Azure Resource Manager](../../azure-resource-manager/templates/quickstart-create-templates-use-the-portal.md), который управляет пакетом, а затем подготавливает каждую базу данных в связанном шаблоне. При использовании шаблонов таким способом Azure Resource Manager выступает в качестве посредника в процессе подготовки скрипта. Шаблоны позволяют подготавливать базы данных в параллельном режиме и, при необходимости, обрабатывать повторные попытки. Сценарий является идемпотентным, поэтому, если при его выполнении произойдет сбой или по какой-либо причине он остановится, запустите его еще раз.

### <a name="verify-the-batch-of-tenants-that-successfully-deployed"></a>Проверка успешного развертывания пакета клиентов

* На [портале Azure](https://portal.azure.com) перейдите к списку серверов и откройте сервер *tenants1*. Щелкните **Базы данных SQL** и убедитесь, что в списке появились 17 дополнительных баз данных.

   ![Список баз данных](./media/saas-dbpertenant-provision-and-catalog/database-list.png)



## <a name="other-provisioning-patterns"></a>Другие шаблоны подготовки

Далее представлены другие шаблоны подготовки, которые не рассматриваются в этом руководстве.

**Предварительная подготовка баз данных**. В шаблоне предварительной подготовки учитывается тот факт, что базы данных в эластичном пуле не создают дополнительных затрат. Счета выставляются за эластичный пул, а не базы данных. Бездействующие базы данных не потребляют ресурсы. Предварительная подготовка баз данных в пуле и их выделение при необходимости может ускорить добавление клиентов. Вы можете заранее подготовить любое удобное количество баз данных, чтобы поддерживать буфер достаточного размера для ожидаемого темпа добавления клиентов.

**Автоматическая подготовка**. В шаблоне автоматической подготовки используется служба подготовки для автоматической подготовки серверов, пулов и баз данных по мере необходимости. Если необходимо, можно добавить предварительную подготовку баз данных в эластичных пулах. Служба подготовки заполняет свободные места, которые появляются в эластичных пулах по мере вывода из эксплуатации и удаления баз данных. Такая служба может быть простой или более сложной. С ее помощью можно, например, управлять подготовкой в нескольких географических регионах и настраивать георепликацию для аварийного восстановления.

С помощью шаблона автоматической подготовки клиентское приложение или сценарий может отправить запрос на подготовку в очередь для обработки службой подготовки. Затем оно может опрашивать службу на предмет завершения. При использовании предварительной подготовки запросы обрабатываются быстро. Служба подготавливает базу данных для замены в фоновом режиме.


## <a name="next-steps"></a>Дальнейшие действия

Из этого руководства вы узнали, как выполнять такие задачи:

> [!div class="checklist"]
>
> * Подготовка отдельного нового клиента.
> * Подготовка пакета дополнительных клиентов.
> * Получение сведений о подготовке клиентов и их регистрация в каталоге.

Ознакомьтесь с [руководством по мониторингу производительности](./saas-dbpertenant-performance-monitoring.md).

## <a name="additional-resources"></a>Дополнительные ресурсы

* Дополнительные [руководства на основе приложения SaaS Wingtip Tickets, использующего одну базу данных на клиент](saas-dbpertenant-wingtip-app-overview.md#sql-database-wingtip-saas-tutorials).
* [Клиентская библиотека эластичной базы данных](elastic-database-client-library.md)
* [Отладка сценариев в интегрированной среде сценариев Windows PowerShell](/powershell/scripting/components/ise/how-to-debug-scripts-in-windows-powershell-ise)