---
title: Непрерывность облачных бизнес-процессов — восстановление базы данных
titleSuffix: Azure SQL Database & SQL Managed Instance
description: Узнайте, как база данных SQL Azure и SQL Управляемый экземпляр поддерживают непрерывность бизнес-процессов в облаке и восстановление базы данных, а так же помогают выполнять критически важные облачные приложения.
keywords: непрерывность бизнес-процессов, непрерывность облачных бизнес-процессов, аварийное восстановление базы данных, восстановление базы данных
services: sql-database
ms.service: sql-db-mi
ms.subservice: high-availability
ms.custom: sqldbrb=2
ms.devlang: ''
ms.topic: conceptual
author: anosov1960
ms.author: sashan
ms.reviewer: mathoma, sstein
ms.date: 06/25/2019
ms.openlocfilehash: 7bd991bd709bb4be69325afe967d7e5600a9e1a4
ms.sourcegitcommit: d59abc5bfad604909a107d05c5dc1b9a193214a8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/14/2021
ms.locfileid: "98222570"
---
# <a name="overview-of-business-continuity-with-azure-sql-database"></a>Обзор обеспечения непрерывности бизнес-процессов с помощью Базы данных SQL Azure
[!INCLUDE[appliesto-sqldb-sqlmi](../includes/appliesto-sqldb-sqlmi.md)]

**Непрерывность бизнес-процессов** в базе данных SQL Azure и SQL управляемый экземпляр относится к механизмам, политикам и процедурам, которые позволяют бизнесу продолжать работу в случае нарушения работы, особенно в вычислительной инфраструктуре. В большинстве случаев база данных SQL и SQL Управляемый экземпляр будут обрабатывать события, которые могут возникнуть в облачной среде и поддерживать работу приложений и бизнес-процессов. Однако существуют некоторые события, которые не могут быть автоматически обработаны базой данных SQL, например:

- Пользователь случайно удалил или обновил строку в таблице.
- Злоумышленник удалил данные или базу данных.
- Землетрясения привел к сбою питания и временному отключенному центру обработки данных.

В этом обзоре описываются возможности, предоставляемые базой данных SQL и SQL Управляемый экземпляр для обеспечения непрерывности бизнес-процессов и аварийного восстановления. Вы узнаете о параметрах, рекомендациях и руководствах по восстановлению после аварийных событий, которые могут приводить к потере данных или недоступности базы данных и приложений. Здесь также содержатся сведения о том, как действовать в ситуациях, когда ошибка пользователя или приложения нарушает целостность данных, происходит сбой региона Azure или приложение требует обслуживания.

## <a name="sql-database-features-that-you-can-use-to-provide-business-continuity"></a>Функции базы данных SQL, которые можно использовать для обеспечения непрерывности бизнес-процессов

С точки зрения базы данных существуют четыре основных сценария возможных нарушений:

- Локальные сбои оборудования или программного обеспечения, затрагивающие узел базы данных, например сбой диска.
- Повреждение или удаление данных, которое, как правило, возникает из-за ошибки приложения или пользователя. Такие сбои зависят от приложения и обычно не могут быть обнаружены службой базы данных.
- Отключение центра обработки данных, возможно, вызванное стихийным бедствием. Этот сценарий требует определенного уровня геоизбыточности с отработкой отказа приложений в альтернативном центре обработки данных.
- Ошибки обновления или обслуживания. непредвиденные проблемы, возникающие во время запланированного обслуживания или обновления инфраструктуры, могут потребовать быстрого отката до состояния предыдущей базы данных.

Чтобы устранить неполадки с локальным оборудованием и программным обеспечением, база данных SQL включает в себя [архитектуру высокого уровня доступности](high-availability-sla.md), которая гарантирует автоматическое восстановление из этих сбоев до 99,995% соглашения об уровне обслуживания.  

Чтобы защитить бизнес от потери данных, база данных SQL и SQL Управляемый экземпляр автоматически создают полные резервные копии баз данных еженедельно, разностные резервные копии каждые 12 часов и резервные копии журналов транзакций каждые 5-10 минут. Резервные копии хранятся в хранилище RA-GRS по крайней мере за 7 дней для всех уровней служб. Все уровни служб, за исключением поддержка Basic настраиваемого срока хранения резервных копий для восстановления до точки во времени, до 35 дней.

База данных SQL и Управляемый экземпляр SQL также предоставляют несколько функций обеспечения непрерывности бизнес-процессов, которые можно использовать для устранения различных незапланированных сценариев.

- [Временные таблицы](../temporal-tables.md) позволяют восстанавливать версии строк из любой точки во времени.
- [Встроенные автоматические резервные копии](automated-backups-overview.md) и [восстановление на момент времени](recovery-using-backups.md#point-in-time-restore) позволяют восстановить полную базу данных до некоторой точки во времени в пределах настроенного периода хранения до 35 дней.
- Вы можете [восстановить удаленную базу данных](recovery-using-backups.md#deleted-database-restore) до той точки, в которой она была удалена, если **сервер не был удален**.
- [Долгосрочное хранение архивных копий](long-term-retention-overview.md) позволяет хранить резервные копии до 10 лет. Это ограниченная общедоступная Предварительная версия для SQL Управляемый экземпляр
- [Активная Георепликация](active-geo-replication-overview.md) позволяет создавать реплики, доступные для чтения, и вручную отработку отказа для любой реплики в случае сбоя центра обработки данных или обновления приложения.
- [Группа автоматической отработки отказа](auto-failover-group-overview.md#terminology-and-capabilities) позволяет приложению автоматически восстанавливаться в случае сбоя центра обработки данных.

## <a name="recover-a-database-within-the-same-azure-region"></a>Восстановление базы данных в том же регионе Azure

Можно использовать автоматическое резервное копирование базы данных для восстановления базы данных до точки во времени в прошлом. Таким образом можно выполнить восстановление после повреждения данных, вызванных ошибками человека. Восстановление на момент времени позволяет создать новую базу данных на том же сервере, который представляет состояние данных до повреждения события. Для большинства баз данных операции восстановления выполняются менее 12 часов. Восстановление очень большой или очень активной базы данных может занять больше времени. Дополнительные сведения см. в разделе [Время восстановления](recovery-using-backups.md#recovery-time).

Если максимальный поддерживаемый период хранения резервных копий для восстановления на момент времени (PITR) недостаточно для вашего приложения, его можно расширить, настроив политику долгосрочного хранения (LTR) для баз данных. Дополнительные сведения см. в разделе [Долгосрочное хранение резервных копий](long-term-retention-overview.md).

## <a name="compare-geo-replication-with-failover-groups"></a>Сравнение георепликации с группами отработки отказа

[Группы автоматической отработки отказа](auto-failover-group-overview.md#terminology-and-capabilities) упрощают развертывание и использование [георепликации](active-geo-replication-overview.md) и добавляют дополнительные возможности, как описано в следующей таблице.

|                                              | Георепликация | Группы отработки отказа  |
|:---------------------------------------------| :-------------- | :----------------|
| **Автоматическая отработка отказа**                          |     Нет          |      Да         |
| **Одновременная отработка отказа нескольких баз данных**  |     Нет          |      Да         |
| **Пользователь должен обновить строку подключения после отработки отказа**      |     Да         |      Нет          |
| **Поддержка Управляемого экземпляра SQL**                   |     Нет          |      Да         |
| **Может находиться в том же регионе, что и первичная реплика**             |     Да         |      Нет          |
| **Несколько реплик**                            |     Да         |      Нет          |
| **Поддерживает масштабирование для чтения**                          |     Да         |      Да         |


## <a name="recover-a-database-to-the-existing-server"></a>Восстановление базы данных на имеющемся сервере

Несмотря на редкие случаи, в центре обработки данных Azure может возникнет сбой. Такой сбой вызывает нарушение работы компании, которое может длиться от считанных минут до нескольких часов.

- Один из вариантов — дождаться возврата базы данных в режим «в сети», когда происходит сбой в работе центра данных. Это подходит для приложений, которые допускают отключение базы данных от сети. Например, вам не нужно непрерывно работать с проектом по разработке или бесплатной пробной версией. В случае сбоя центра обработки данных вы не узнаете, как долго происходит сбой, поэтому этот вариант работает только в том случае, если в течение длительного времени не нужна база.
- Другим вариантом является восстановление базы данных на любом сервере в любом регионе Azure с использованием [резервных копий геоизбыточных баз данных](recovery-using-backups.md#geo-restore) (геовосстановление). В качестве источника геовосстановление использует геоизбыточную резервную копию для восстановления базы данных, даже если она или центр обработки данных недоступны из-за сбоя.
- Наконец, вы можете быстро восстановиться после сбоя, если вы настроили геовторичную [репликацию с помощью активной георепликации](active-geo-replication-overview.md) или [группы автоматической отработки отказа](auto-failover-group-overview.md) для базы данных или баз. В зависимости от выбора технологии можно использовать переход на другой ресурс автоматически или вручную. Хотя отработка отказа занимает всего несколько секунд, службе понадобится как минимум 1 час, чтобы активировать ее. Нужно удостовериться, что отработка отказа соответствует масштабу сбоя. Кроме того, при отработке отказа возможна небольшая потеря данных из-за характера асинхронной репликации.

При разработке плана обеспечения непрерывности бизнес-процессов нужно понимать, какое максимальное время до полного восстановления приложения после аварийного события допустимо. Время, необходимое для полного восстановления приложения, называется целевым временем восстановления (RTO). Кроме того, необходимо определить максимальный период последних обновлений данных (интервал времени), который приложение может потерять при восстановлении после незапланированного аварийного события. Возможная потеря данных известна как Целевая точка восстановления (RPO).

Различные методы восстановления предлагают разные уровни RPO и RTO. Можно выбрать конкретный метод восстановления или использовать сочетание методов для полного восстановления приложения. В следующей таблице сравниваются RPO и RTO каждого варианта восстановления. Группы автоматической отработки отказа упрощают развертывание и использование георепликации и добавляет дополнительные возможности, описанные в следующей таблице.

| Метод восстановления | RTO | RPO |
| --- | --- | --- |
| Геовосстановление из геореплицированных резервных копий | 12 h | 1 ч |
| Группы автоматической отработки отказа | 1 ч | 5 с |
| Отработка отказа базы данных вручную | 30 с | 5 с |

> [!NOTE]
> *Ручная отработка отказа базы данных* означает отработку отказа отдельной базы данных до геореплицированной вторичной реплики с использованием [незапланированного режима](active-geo-replication-overview.md#active-geo-replication-terminology-and-capabilities).
Для дополнительной информации об автоматической отработке отказа RTO и RPO см. таблицу, приведенную выше.

Используйте группы автоматической отработки отказа, если приложение соответствует любому из следующих критериев:

- оно является критически важным;
- его условия Соглашения об уровне обслуживания (SLA) не допускают более 12 часов простоя;
- его простой может повлечь финансовую ответственность;
- имеет высокую частоту изменения данных, и потеря данных за час не допускается;
- дополнительные затраты на активную георепликацию ниже, чем потенциальная финансовая ответственность и связанная с ней утрата деловых возможностей.

> [!VIDEO https://channel9.msdn.com/Blogs/Azure/Azure-SQL-Database-protecting-important-DBs-from-regional-disasters-is-easy/player]
>

В зависимости от требований приложения вы можете использовать сочетание резервных копий базы данных и активной георепликации. Обсуждение вопросов проектирования автономных баз данных и эластичных пулов с использованием этих функций обеспечения непрерывности бизнеса см. в статье [Разработка приложения для аварийного восстановления облака](designing-cloud-solutions-for-disaster-recovery.md) и [стратегий аварийного восстановления эластичного пула](disaster-recovery-strategies-for-applications-with-elastic-pool.md).

В следующих разделах описываются инструкции по восстановлению с использованием резервных копий базы данных или активной георепликации. Подробные инструкции, включая требования к планированию, действия после восстановления, а также сведения о том, как имитировать сбой для выполнения анализа аварийного восстановления, см. в статье [Восстановление базы данных SQL из строя](disaster-recovery-guidance.md).

### <a name="prepare-for-an-outage"></a>Подготовка к сбою

Независимо от выбранной функции обеспечения непрерывности бизнес-процессов необходимо выполнить следующее.

- Определите и подготовьте целевой сервер, включая правила брандмауэра для IP-адресов, имена для входа и разрешения уровня базы данных master.
- Определите, как клиенты и клиентские приложения будут перенаправляться на новый сервер.
- Задокументируйте прочие зависимости, такие как параметры аудита и оповещения.

Без соответствующей подготовки возобновление работы приложений после отработки отказа или восстановления базы данных занимает больше времени и, вероятно, также требует устранения неполадок во время стрессовой нагрузки, а это весьма неудачное сочетание.

### <a name="fail-over-to-a-geo-replicated-secondary-database"></a>Отработка отказа в геореплицируемую базу данных-получатель

Если в качестве механизма восстановления используется активная Георепликация или группы автоматической отработки отказа, можно настроить политику автоматической отработки отказа или использовать [незапланированную отработку отказа вручную](active-geo-replication-configure-portal.md#initiate-a-failover). После запуска отработка отказа приводит к повышению базы данных-получателя до новой базы данных-источника и делает ее доступной для записи новых транзакций и реагирования на запросы. При этом происходят минимальные потери данных, которые еще не реплицированы. Сведения о разработке процесса отработки отказа см. в статье [Проектирование приложения для облачного аварийного восстановления с использованием активной георепликации в базе данных SQL](designing-cloud-solutions-for-disaster-recovery.md).

> [!NOTE]
> Когда центр обработки данных снова переходит в оперативный режим, старые первичные базы данных автоматически повторно подключаются к новому первичному источнику и становятся вторичными. Если базу данных-источник необходимо повторно переместить в исходный регион, вы можете вручную запустить плановую отработку отказа (восстановление размещения).

### <a name="perform-a-geo-restore"></a>Процедура геовосстановления

При использовании автоматически создаваемых резервных копий и геоизбыточного хранилища (включено по умолчанию) базу данных можно восстановить с помощью функции [геовосстановление](disaster-recovery-guidance.md#recover-using-geo-restore). Обычно восстановление выполняется в пределах 12 часов с потерей данных за период до одного часа, что зависит от времени создания и репликации последней резервной копии журналов. До завершения восстановления база данных не может записывать какие-либо транзакции или отвечать на запросы. Обратите внимание, что функция геовосстановления восстанавливает базу данных до последней доступной точки во времени.

> [!NOTE]
> Если центр обработки данных возвращается в режим «в сети» перед переключением приложения на восстановленную базу, можно отменить восстановление.

### <a name="perform-post-failover--recovery-tasks"></a>Выполнение задач после восстановления размещения и восстановления

После восстановления посредством любого из механизмов восстановления необходимо выполнить следующие дополнительные задачи, прежде чем данные пользователей и приложений будут заархивированы, а они смогут возобновить работу.

- Перенаправление клиентов и клиентских приложений на новый сервер и восстановленную базу данных.
- Убедитесь, что заданы соответствующие правила брандмауэра для IP-адресов уровня сервера, позволяющие пользователям подключаться к [брандмауэрам уровня базы данных](firewall-configure.md#use-the-azure-portal-to-manage-server-level-ip-firewall-rules) или использовать их, чтобы включить соответствующие правила.
- Убедитесь, что имеются соответствующие имена входа и разрешения уровня базы данных master (или используйте [автономные пользователи](/sql/relational-databases/security/contained-database-users-making-your-database-portable)).
- Настройте аудит соответствующим образом.
- Настройте оповещения соответствующим образом.

> [!NOTE]
> Если вы используете группу отработки отказа и подключается к базам данных с помощью прослушивателя чтения и записи, перенаправление после отработки отказа происходит автоматически и прозрачно для приложения.

## <a name="upgrade-an-application-with-minimal-downtime"></a>Обновление приложения с минимальным простоем

Иногда приложение нужно перевести в автономный режим для планового обслуживания, например, чтобы обновить его. В статье [Управление последовательными обновлениями для облачных приложений с помощью активной георепликации базы данных SQL](manage-application-rolling-upgrade.md) описывается, как с помощью активной георепликации обеспечить последовательное обновление облачного приложения, чтобы свести к минимуму простой при обновлениях и обеспечить путь восстановления, если случится сбой.

## <a name="next-steps"></a>Дальнейшие действия

Обсуждение вопросов разработки приложений для отдельных баз данных и эластичных пулов см. в статье [проектирование приложения для аварийного восстановления облака](designing-cloud-solutions-for-disaster-recovery.md) и [стратегий аварийного восстановления эластичного пула](disaster-recovery-strategies-for-applications-with-elastic-pool.md).
