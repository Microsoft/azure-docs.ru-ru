---
title: Защита базы данных
description: В этом учебнике рассказывается о методах и функциях, используемых для защиты отдельной базы данных или базы данных в составе пула в службе "База данных SQL Azure".
services: sql-database
ms.service: sql-database
ms.subservice: security
ms.topic: tutorial
author: VanMSFT
ms.author: vanto
ms.reviewer: ''
ms.date: 09/21/2020
ms.custom: seoapril2019 sqldbrb=1
ms.openlocfilehash: 8cdf95dd3c0e801896328136b15e4bd4efe53005
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "102563818"
---
# <a name="tutorial-secure-a-database-in-azure-sql-database"></a>Руководство по Защита базы данных в службе "База данных SQL Azure"
[!INCLUDE[appliesto-sqldb](../includes/appliesto-sqldb.md)]

Из этого руководства вы узнаете, как выполнить следующие задачи:

> [!div class="checklist"]
>
> - Создавать правила брандмауэра уровня сервера и уровня базы данных.
> - Назначение администратора Azure Active Directory (Azure AD)
> - Управлять пользовательским доступом с помощью аутентификации SQL, аутентификации Azure AD и безопасных строк подключения.
> - Включать функции безопасности, такие как Azure Defender для SQL, аудит, маскирование данных и шифрование.

База данных SQL Azure защищает данные, предоставляя возможность:

- ограничить доступ с помощью правил брандмауэра;
- использовать механизмы аутентификации, требующие учетных данных;
- использовать авторизацию на основе разрешений и членства с учетом ролей.
- Включение функций безопасности

> [!NOTE]
> Управляемый экземпляр SQL Azure защищен с помощью правил безопасности сети и частных конечных точек, как описано в статьях [Сведения об Управляемом экземпляре SQL Azure](../managed-instance/sql-managed-instance-paas-overview.md) и [Архитектура подключения к Управляемому экземпляру](../managed-instance/connectivity-architecture-overview.md).

Дополнительные сведения см. в статьях [Расширенные функции безопасности Базы данных SQL Azure](./security-overview.md) и [Обзор возможностей безопасности Базы данных SQL Azure](security-overview.md).

> [!TIP]
> Следующий модуль Microsoft Learn поможет вам получить бесплатные сведения о [защите базы данных в службе "База данных SQL Azure"](/learn/modules/secure-your-azure-sql-database/).

## <a name="prerequisites"></a>Предварительные требования

Для работы с руководством требуется наличие следующих компонентов:

- [Среда SQL Server Management Studio](/sql/ssms/download-sql-server-management-studio-ssms)
- [Сервер](logical-servers.md) и единая база данных.
  - Создайте их с помощью [портала Azure](single-database-create-quickstart.md), [CLI](az-cli-script-samples-content-guide.md) или [PowerShell](powershell-script-content-guide.md).

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/), прежде чем начинать работу.

## <a name="sign-in-to-the-azure-portal"></a>Вход на портал Azure

Чтобы выполнить все действия из этого руководства, войдите на [портал Azure](https://portal.azure.com/).

## <a name="create-firewall-rules"></a>Создание правил брандмауэра

Базы данных в службе "База данных SQL" защищены брандмауэрами в Azure. По умолчанию все подключения к серверу и базе данных отклоняются. Дополнительные сведения см. в статье о [правилах брандмауэра уровня сервера и базы данных](firewall-configure.md).

Чтобы обеспечить наибольшую безопасность, для параметра **Разрешить доступ к службам Azure** следует установить значение **Выключено**. Затем создайте [зарезервированный IP-адрес (классическое развертывание)](/previous-versions/azure/virtual-network/virtual-networks-reserved-public-ip) для ресурса, от которого нужно принять подключение (виртуальная машина Azure или облачная служба), и разрешите доступ через брандмауэр только этому IP-адресу. Если вы используете модель развертывания [Resource Manager](../../virtual-network/public-ip-addresses.md), для каждого ресурса необходим выделенный общедоступный IP-адрес.

> [!NOTE]
> База данных SQL обменивается данными через порт 1433. Если вы пытаетесь подключиться из корпоративной сети, исходящий трафик через порт 1433 может быть запрещен сетевым брандмауэром. В таком случае вы не сможете подключиться к серверу, пока администратор не откроет порт 1433.

### <a name="set-up-server-level-firewall-rules"></a>Установка правил брандмауэра уровня сервера

Правила брандмауэра для IP-адресов уровня сервера применяются ко всем базам данных на одном сервере.

Чтобы установить правило брандмауэра на уровне сервера, сделайте следующее:

1. На портале Azure в меню слева выберите пункт **Базы данных SQL** и на странице **Базы данных SQL** выберите имя своей базы данных.

    ![правило брандмауэра для сервера](./media/secure-database-tutorial/server-name.png)

    > [!NOTE]
    > Не забудьте скопировать полное имя сервера (например, *ваш_сервер.database.windows.net*) для дальнейшего использования в этом руководстве.

1. На странице **Обзор** выберите **Настройка брандмауэра для сервера**. Откроется страница **Параметры брандмауэра** сервера.

   1. На панели инструментов выберите **Добавить IP-адрес клиента**, чтобы добавить текущий IP-адрес в новое правило брандмауэра. С использованием правила можно открыть порт 1433 для одного IP-адреса или диапазона IP-адресов. Щелкните **Сохранить**.

      ![Настройка правила брандмауэра для сервера](./media/secure-database-tutorial/server-firewall-rule2.png)

   1. Щелкните **ОК**, а затем закройте страницу **Параметры брандмауэра**.

Теперь можно подключиться к любой базе данных на сервере с указанным IP-адресом или диапазоном IP-адресов.

### <a name="setup-database-firewall-rules"></a>Настройка правил брандмауэра для базы данных

Правила брандмауэра на уровне базы данных применяются только к отдельным базам данных. Базы данных сохранит эти правила при отработке отказа сервера. Правила брандмауэра уровня базы данных можно настроить только с помощью инструкций Transact-SQL (T-SQL) и только после настройки правила брандмауэра уровня сервера.

Чтобы настроить правило брандмауэра на уровне базы данных, сделайте следующее:

1. Подключитесь к базе данных, например с помощью [SQL Server Management Studio](connect-query-ssms.md).

1. В **обозревателе объектов** щелкните правой кнопкой мыши базу данных и выберите команду **Создать запрос**.

1. Добавьте этот оператор в окне запроса и измените IP-адрес на свой общедоступный IP-адрес:

    ```sql
    EXECUTE sp_set_database_firewall_rule N'Example DB Rule','0.0.0.4','0.0.0.4';
    ```

1. На панели инструментов выберите **Выполнить**, чтобы создать правило брандмауэра.

> [!NOTE]
> Вы также можете создать правило брандмауэра уровня сервера в среде SSMS с помощью команды [sp_set_firewall_rule](/sql/relational-databases/system-stored-procedures/sp-set-firewall-rule-azure-sql-database?view=azuresqldb-current), однако сначала нужно подключиться к базе данных *master*.

## <a name="create-an-azure-ad-admin"></a>Создание администратора Azure AD

Убедитесь, что вы используете соответствующий управляемый домен Azure Active Directory (AD). Щелкните в правом верхнем углу окна портала Azure, чтобы выбрать домен AD. С помощью этого процесса подтверждается, что одна подписка используется для Azure AD и логического сервера SQL Server, на котором размещены база данных или хранилище данных.

   ![choose-ad](./media/secure-database-tutorial/8choose-ad.png)

Чтобы настроить администратора Azure AD:

1. На портале Azure на странице **SQL Server** выберите элемент **Администратор Active Directory**. Затем щелкните **Задать администратора**.

    ![выбор Active Directory](./media/secure-database-tutorial/admin-settings.png)  

    > [!IMPORTANT]
    > Для выполнения этой задачи требуется роль глобального администратора.

1. На странице **Добавление администратора** найдите и выберите группу или пользователя AD, а затем щелкните **Выбрать**. На странице перечислены все участники и группы Active Directory, а те, которые выделены серым цветом, не поддерживаются как администраторы Azure AD. Обратитесь к разделу [Функции и ограничения Azure AD](authentication-aad-overview.md#azure-ad-features-and-limitations).

    ![Выбор администратора](./media/secure-database-tutorial/admin-select.png)

    > [!IMPORTANT]
    > Управление доступом на основе ролей Azure (Azure RBAC) применяется только к порталу и не распространяется на SQL Server.

1. В верхней части страницы **Администратор Active Directory** нажмите кнопку **Сохранить**.

    Изменение администратора может занять несколько минут. После этого новый администратор появится в поле **Администратор Active Directory**.

> [!NOTE]
> При настройке администратора Azure AD новое имя администратора (пользователя или группы) не может существовать в базе данных *master* как пользователь или учетные данные SQL Server. Если оно присутствует, настройка завершится ошибкой. Будет выполнен откат изменений и появится сообщение, что такое имя администратора уже существует. Такие пользователь и учетные данные SQL Server не входят в Azure AD, поэтому любая попытка подключить пользователя с помощью аутентификации Azure AD завершится сбоем.

Сведения о настройке Azure AD см. в статьях:

- [Что собой представляет гибридная идентификация](../../active-directory/hybrid/whatis-hybrid-identity.md)
- [Добавление имени личного домена с помощью портала Azure Active Directory](../../active-directory/fundamentals/add-custom-domain.md)
- [Windows Azure now supports federation with Windows Server Active Directory](https://azure.microsoft.com/blog/20../../windows-azure-now-supports-federation-with-windows-server-active-directory/) (Теперь Microsoft Azure поддерживает федерацию с Windows Server AD)
- [Администрирование каталога Azure AD](../../active-directory/fundamentals/active-directory-whatis.md)
- [Общие сведения об Azure PowerShell](/powershell/azure/)
- [Порты и протоколы, необходимые для гибридной идентификации](../../active-directory/hybrid/reference-connect-ports.md)

## <a name="manage-database-access"></a>Управление доступом к базе данных

Управляйте доступом к базе данных, добавляя пользователей в базу данных или предоставляя доступ с помощью безопасных строк подключения. Строки подключения можно использовать для внешних приложений. Дополнительные сведения см. в статьях [Управление именами входа и учетными записями пользователей](logins-create-manage.md) и [Проверка подлинности с помощью Active Directory](authentication-aad-overview.md).

Чтобы добавить пользователей, выберите тип аутентификации базы данных:

- **Аутентификация SQL**: для входа используются имя пользователя и пароль, действительные только в контексте конкретной базы данных на сервере.

- **Аутентификация Azure AD**: используются удостоверения, управляемые Azure AD.

### <a name="sql-authentication"></a>Проверка подлинности SQL

Чтобы добавить пользователя с аутентификацией SQL:

1. Подключитесь к базе данных, например с помощью [SQL Server Management Studio](connect-query-ssms.md).

1. В **обозревателе объектов** щелкните правой кнопкой мыши базу данных и выберите **Создать запрос**.

1. В окне запроса введите следующую команду:

    ```sql
    CREATE USER ApplicationUser WITH PASSWORD = 'YourStrongPassword1';
    ```

1. На панели инструментов выберите **Выполнить**, чтобы создать пользователя.

1. По умолчанию пользователь может подключаться к базе данных, но не имеет разрешений на чтение и запись данных. Чтобы предоставить эти разрешения, выполните следующие две команды в новом окне запроса.

    ```sql
    ALTER ROLE db_datareader ADD MEMBER ApplicationUser;
    ALTER ROLE db_datawriter ADD MEMBER ApplicationUser;
    ```

> [!NOTE]
> Создайте учетные записи без прав администратора на уровне базы данных, если только не требуется выполнять задачи администрирования, например создавать пользователей.

### <a name="azure-ad-authentication"></a>Аутентификация Azure AD

Для аутентификации Azure Active Directory необходимо, чтобы пользователи базы данных создавались как автономные. Пользователь автономной базы данных сопоставляется с удостоверением в каталоге Azure AD, связанном с базой данных, и у него нет имени для входа в базе данных *master*. Удостоверение Azure AD может быть для отдельного пользователя или группы. Дополнительные сведения об аутентификации с помощью Azure AD см. в статьях [Пользователи автономной базы данных — создание переносимой базы данных](/sql/relational-databases/security/contained-database-users-making-your-database-portable) и [Настройка и администрирование аутентификации Azure Active Directory с помощью SQL](authentication-aad-configure.md).

> [!NOTE]
> Пользователей баз данных (за исключением администраторов) невозможно создавать с помощью портала Azure. Роли Azure не распространяются на серверы, базы данных или хранилища данных SQL. Они используются для управления ресурсами Azure и не относятся к разрешениям базы данных.
>
> Например, роль *Участник SQL Server* не предоставляет разрешение на подключение к базе данных или хранилищу данных. Это разрешение должно быть предоставлено в рамках базы данных с помощью инструкций T-SQL.

> [!IMPORTANT]
> Специальные символы, например двоеточие `:` или амперсанд `&`, не поддерживаются в именах пользователей в инструкциях T-SQL `CREATE LOGIN` и `CREATE USER`.

Чтобы добавить пользователя с аутентификацией Azure AD:

1. Подключитесь к своему серверу в Azure с помощью учетной записи Azure AD, используя по крайней мере разрешение *ALTER ANY USER*.

1. В **обозревателе объектов** щелкните правой кнопкой мыши базу данных и выберите команду **Создать запрос**.

1. В окне запроса введите следующую команду и измените `<Azure_AD_principal_name>` на имя участника-пользователя Azure AD или отображаемое имя для группы Azure AD:

   ```sql
   CREATE USER <Azure_AD_principal_name> FROM EXTERNAL PROVIDER;
   ```

> [!NOTE]
> Для пользователей Azure AD в метаданных базы данных указывается тип `E (EXTERNAL_USER)`, а для групп — тип `X (EXTERNAL_GROUPS)`. Дополнительные сведения см. в статье [sys.database_principals (Transact-SQL)](/sql/relational-databases/system-catalog-views/sys-database-principals-transact-sql).

### <a name="secure-connection-strings"></a>Безопасные строки подключения

Чтобы обеспечить защищенное зашифрованное подключение между клиентским приложением и Базой данных SQL, строка подключения должна быть настроена таким образом, чтобы:

- запрашивалось зашифрованное подключение;
- сертификат сервера не считался доверенным.

Устанавливается подключение по протоколу TLS, и уменьшается риск атак "злоумышленник в середине". Строки подключения доступны отдельно для каждой базы данных и предварительно настроены на поддержку клиентских драйверов, например ADO.NET, JDBC, ODBC и PHP. Чтобы получить сведения о протоколе TLS и проверить возможность подключения, просмотрите [рекомендации по использованию протокола TLS](connect-query-content-reference-guide.md#tls-considerations-for-database-connectivity).

Чтобы скопировать безопасную строку подключения, сделайте следующее:

1. На портале Azure в меню слева выберите пункт **Базы данных SQL** и на странице **Базы данных SQL** выберите имя своей базы данных.

1. На странице **Обзор** щелкните **Показать строки подключения к базам данных**.

1. Выберите вкладку "Драйвер" и скопируйте полную строку подключения.

    ![Строка подключения по протоколу ADO.NET](./media/secure-database-tutorial/connection.png)

## <a name="enable-security-features"></a>Включение функций безопасности

База данных SQL Azure предоставляет возможности безопасности, доступ к которым можно получить на портале Azure. Эти возможности представлены и для сервера, и для базы данных, за исключением маскирования данных, доступного только в базе данных. См. дополнительные сведения об [Azure Defender для SQL](azure-defender-for-sql.md), [аудите](../../azure-sql/database/auditing-overview.md), [динамическом маскировании данных](dynamic-data-masking-overview.md) и [прозрачном шифровании данных](transparent-data-encryption-tde-overview.md).

### <a name="azure-defender-for-sql"></a>Azure Defender для SQL

Azure Defender для SQL обнаруживает потенциальные угрозы по мере их возникновения и отправляет оповещения системы безопасности о подозрительных действиях. Пользователи могут анализировать подозрительные события с помощью функции аудита и определять их причину (попытка получить доступ к данным в базе данных, нарушить безопасность или использовать их уязвимость). Пользователям также предоставляются общие сведения о безопасности, включающие оценку уязвимостей, а также средство поиска и классификации данных.

> [!NOTE]
> Примером угрозы является атака путем внедрения кода SQL — это процесс, при котором злоумышленники внедряют вредоносный код SQL во входные данные приложения. Затем приложение может невольно выполнить вредоносный код SQL и предоставить злоумышленникам доступ на проникновение или изменение данных в базе данных.

Чтобы включить Azure Defender для SQL:

1. На портале Azure в меню слева выберите пункт **Базы данных SQL** и на странице **Базы данных SQL** выберите имя своей базы данных.

1. На странице **Обзор** выберите ссылку **Имя сервера**. Откроется страница сервера.

1. На странице **SQL Server** найдите раздел **Безопасность** и выберите **Центр безопасности**.

   1. Выберите **Вкл.** в разделе **Azure Defender для SQL**, чтобы включить эту функцию. Выберите учетную запись хранения для записи результатов оценки уязвимостей. Затем нажмите кнопку **Save** (Сохранить).

      ![Область навигации](./media/secure-database-tutorial/threat-settings.png)

      Вы также можете настроить сообщения электронной почты для получения оповещений системы безопасности, подробностей о хранилище и типах обнаружения угроз.

1. Вернитесь на страницу **Базы данных SQL** вашей базы данных и выберите **Центр безопасности** в разделе **Безопасность**. Здесь вы найдете различные индикаторы безопасности, доступные для базы данных.

    ![Состояние угрозы](./media/secure-database-tutorial/threat-status.png)

В случае обнаружения подозрительной активности вам будет отправлено сообщение электронной почты со сведениями о событии. Это такая информация, как характер активности, сведения о базе данных, сервере, времени события, возможных причинах, а также рекомендуемые действия по поиску и устранению потенциальной угрозы. Если вы получили такое сообщение, выберите ссылку **Журнал аудита SQL Azure**, чтобы открыть портал Azure и отобразить соответствующие записи аудита, появившиеся во время возникновения подозрительного события.

   ![Электронное сообщение об обнаружении угроз](./media/secure-database-tutorial/threat-email.png)

### <a name="auditing"></a>Аудит

Функция аудита отслеживает события базы данных и записывает их в журнал аудита в службе хранилища Azure, журналы Azure Monitor или концентратор событий. Аудит помогает вам соблюсти требования нормативов, проанализировать работу с базой данных и получить представление о расхождениях и аномалиях, которые могут указывать на предполагаемые нарушения безопасности.

Чтобы включить аудит:

1. На портале Azure в меню слева выберите пункт **Базы данных SQL** и на странице **Базы данных SQL** выберите имя своей базы данных.

1. В разделе **Безопасность** щелкните **Аудит**.

1. В разделе параметров **Аудит** установите следующие значения:

   1. Выберите для параметра **Аудит** значение **Включено**.

   1. Выберите в качестве **места назначения журнала аудита** любой из следующих ресурсов:

       - **Хранилище** — это учетная запись хранения Azure, в которой будут сохраняться журналы событий, доступные для загрузки как файлы *XEL*.

          > [!TIP]
          > Для того чтобы в полной мере воспользоваться возможностями шаблонов отчетов об аудите, используйте одну и ту же учетную запись хранения для всех баз данных.

       - **Служба Log Analytics**, которая автоматически сохраняет события для запроса или для дальнейшего анализа.

           > [!NOTE]
           > **Рабочая область Log Analytics** является обязательной для поддержки расширенных функций, таких как аналитика, настраиваемые правила генерации оповещений, а также экспорт из Excel или Power BI. Без рабочей области доступен только редактор запросов.

       - **Концентратор событий**, который позволяет событиям перенаправляться для использования в других приложениях.

   1. Щелкните **Сохранить**.

      ![Параметры аудита](./media/secure-database-tutorial/audit-settings.png)

1. Теперь вы можете щелкнуть **Ознакомиться с журналами аудита**, чтобы просмотреть данные о событиях в базе данных.

    ![Записи аудита](./media/secure-database-tutorial/audit-records.png)

> [!IMPORTANT]
> Дополнительные сведения о том, как настроить события аудита с помощью PowerShell или REST API, см. в статье [Аудит в Базе данных SQL и Azure Synapse Analytics](../../azure-sql/database/auditing-overview.md).

### <a name="dynamic-data-masking"></a>Динамическое маскирование данных

Функция маскирования данных автоматически скрывает конфиденциальные данные в базе данных.

Чтобы включить маскирование данных:

1. На портале Azure в меню слева выберите пункт **Базы данных SQL** и на странице **Базы данных SQL** выберите имя своей базы данных.

1. В разделе **Безопасность** выберите **Динамическое маскирование данных**.

1. В параметрах **Динамического маскирования данных** щелкните **Добавить маску**, чтобы добавить правило маскирования. Azure будет автоматически заполнять доступные для выбора схемы базы данных, таблицы и столбцы.

    ![Параметры маскирования](./media/secure-database-tutorial/mask-settings.png)

1. Щелкните **Сохранить**. Теперь выбранные данные скрыты для обеспечения конфиденциальности.

    ![Пример маскирования](./media/secure-database-tutorial/mask-query.png)

### <a name="transparent-data-encryption"></a>Прозрачное шифрование данных

Функция шифрования позволяет автоматически шифровать неактивные данные, не внося каких-либо изменений в приложения, обращающиеся к зашифрованной базе данных. Для новых баз данных шифрование включено по умолчанию. Кроме того, можно зашифровать данные с помощью SSMS и функции [Постоянное шифрование](always-encrypted-certificate-store-configure.md).

Чтобы включить и проверить шифрование:

1. На портале Azure в меню слева выберите пункт **Базы данных SQL** и на странице **Базы данных SQL** выберите имя своей базы данных.

1. В разделе **Безопасность** выберите **Прозрачное шифрование данных**.

1. Если требуется, для параметра **Шифрование данных** задайте значение **Включено**. Щелкните **Сохранить**.

    ![прозрачное шифрование данных.](./media/secure-database-tutorial/encryption-settings.png)

> [!NOTE]
> Чтобы просмотреть состояние шифрования, подключитесь к базе данных, используя [SSMS](connect-query-ssms.md), и запросите столбец `encryption_state` представления [sys.dm_database_encryption_keys](/sql/relational-databases/system-dynamic-management-views/sys-dm-database-encryption-keys-transact-sql). Состояние `3` указывает, что база данных зашифрована.

## <a name="next-steps"></a>Дальнейшие действия

Из этого руководства вы узнали, как повысить безопасность базы данных с помощью нескольких простых шагов. Вы ознакомились с выполнением следующих задач:

> [!div class="checklist"]
>
> - Создавать правила брандмауэра уровня сервера и уровня базы данных.
> - Назначать администратора Azure Active Directory (AD).
> - Управлять пользовательским доступом с помощью аутентификации SQL, аутентификации Azure AD и безопасных строк подключения.
> - Включать функции безопасности, такие как Azure Defender для SQL, аудит, маскирование данных и шифрование.

Перейдите к следующему руководству, чтобы узнать, как реализовать географическое распределение.

> [!div class="nextstepaction"]
>[Реализация географически распределенной базы данных](geo-distributed-application-configure-tutorial.md)