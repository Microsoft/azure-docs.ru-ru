---
title: Управление схемой в мультитенантном приложении
description: Управление схемой для нескольких клиентов в мультитенантном приложении, использующем базу данных SQL Azure
services: sql-database
ms.service: sql-database
ms.subservice: scenario
ms.custom: sqldbrb=1
ms.devlang: ''
ms.topic: tutorial
author: stevestein
ms.author: sstein
ms.reviewer: ''
ms.date: 12/18/2018
ms.openlocfilehash: d222234cd6ff3d910e6dbc51a394695ce467edce
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "96011866"
---
# <a name="manage-schema-in-a-saas-application-that-uses-sharded-multi-tenant-databases"></a>Управление схемой в приложении SaaS, которое использует сегментированные мультитенантные базы данных
[!INCLUDE[appliesto-sqldb](../includes/appliesto-sqldb.md)]

В этом руководстве рассматриваются сложности обслуживания группы баз данных в приложении "программное обеспечение как услуга" (SaaS). Демонстрируются решения для распространения изменений схемы в группе баз данных.

Как и любое приложение, приложение SaaS Wingtip Tickets будет развиваться со временем и иногда будет требовать изменений в базе данных. Изменения могут влиять на схему или ссылочные данные, а также инициировать задачи обслуживания базы данных. В случае приложения SaaS, использующего одну базу данных на клиент, изменения необходимо координировать в потенциально большой группе баз данных клиента. Кроме того, необходимо внедрить эти изменения в процесс подготовки баз данных, чтобы они были внесены в новые базы данных при их создании.

#### <a name="two-scenarios"></a>Два сценария

В этом руководстве рассматриваются два сценария:
- Развертывание обновления справочных данных для всех клиентов.
- Перестройка индекса для таблицы, содержащей ссылочные данные.

Функция Базы данных SQL Azure [Задания обработки эластичных баз данных](./elastic-jobs-overview.md) используется для выполнения этих операций на всех клиентах. Задания также выполняются для шаблона базы данных клиента. В примере приложения Wingtip Tickets этот шаблон базы данных копируется для подготовки новой базы данных клиента.

Из этого руководства вы узнаете, как выполнить следующие задачи:

> [!div class="checklist"]
> * Создание агента задания.
> * Выполнение запроса T-SQL к нескольким базам данных клиента.
> * Обновление ссылочных данных во всех базах данных клиента.
> * Создание индекса для таблицы во всех базах данных клиента.

## <a name="prerequisites"></a>Предварительные требования

- Должно быть развернуто приложение SaaS Wingtip Tickets для мультитенантных баз данных.
    - Соответствующие инструкции представлены в первом руководстве по приложению SaaS Wingtip Tickets для мультитенантных баз данных.<br />[Deploy and explore a sharded multi-tenant application that uses Azure SQL Database](./saas-multitenantdb-get-started-deploy.md) (Развертывание и изучение сегментированного мультитенантного приложения, использующего Базу данных SQL Azure).
        - Процесс развертывания занимает меньше пяти минут.
    - Установите версию Wingtip с *сегментированной мультитенантной базой данных*. В данном руководстве не поддерживаются версии для *автономной* и *однотенантной* баз данных.

- Установите последнюю версию SQL Server Management Studio (SSMS). [Скачайте и установите SSMS](/sql/ssms/download-sql-server-management-studio-ssms).

- Установите Azure PowerShell. Дополнительные сведения см. в статье [Начало работы с Azure PowerShell](/powershell/azure/get-started-azureps).

> [!NOTE]
> В этом руководстве используются функции службы Базы данных SQL Azure в ограниченной предварительной версии ([Задания обработки эластичных баз данных](elastic-database-client-library.md)). Если вы хотите изучить это руководство, отправьте идентификатор своей подписки на адрес *SaaSFeedback\@microsoft.com* с темой "Задания обработки эластичных баз данных (предварительная версия)". Получив подтверждение о включении подписки, [скачайте и установите предварительную версию командлетов заданий](https://github.com/jaredmoo/azure-powershell/releases). Это ограниченная предварительная версия, поэтому если у вас возникнут вопросы или необходимость получить поддержку, напишите на адрес *SaaSFeedback\@microsoft.com*.

## <a name="introduction-to-saas-schema-management-patterns"></a>Общие сведения о шаблонах управления схемой SaaS

Благодаря модели сегментированной мультитенантной базы данных, используемой в этом примере, база данных может содержать один или больше клиентов. В этом примере рассматривается возможность использования комбинации мультитенантных и однотенантных баз данных, что обеспечивает *гибридную* модель управления клиентами. Управление изменениями для этих баз данных может быть затруднительным. [Эластичные задания](./elastic-jobs-overview.md) упрощают администрирование большого числа баз данных и управление ими. Задания позволяют вам безопасно и надежно выполнять задачи (сценарии Transact-SQL) в группах баз данных клиента. Задачи не зависят от действий пользователя. Этот метод можно использовать для развертывания изменений в схему или справочных данных по всем клиентам в приложении. Задания обработки эластичных баз данных также могут использоваться для обслуживания эталонной копии шаблона базы данных. Этот шаблон используется для создания клиентов, обеспечивая ее самыми последними схемами и справочными данными.

![экран](./media/saas-multitenantdb-schema-management/schema-management.png)

## <a name="elastic-jobs-limited-preview"></a>Ограниченная предварительная версия заданий обработки эластичных БД

Существует новая версия заданий обработки эластичных баз данных, которая является интегрированным компонентом Базы данных SQL Azure. Сейчас новая версия заданий обработки эластичных БД находится на этапе ограниченной предварительной версии. Эта ограниченная предварительная версия поддерживает создание агента заданий с помощью PowerShell и создание заданий и управление ими с помощью T-SQL.
> [!NOTE]
> В этом руководстве используются функции службы базы данных SQL в ограниченной предварительной версии (задания обработки эластичных баз данных). Если вы хотите изучить это руководство, отправьте идентификатор своей подписки по адресу SaaSFeedback@microsoft.com с темой "Задания обработки эластичных баз данных (предварительная версия)". Получив подтверждение о включении подписки, скачайте и установите предварительную версию командлетов заданий. Это ограниченная предварительная версия, поэтому если у вас возникнут вопросы или необходимость получить поддержку, напишите по адресу SaaSFeedback@microsoft.com.

## <a name="get-the-wingtip-tickets-saas-multi-tenant-database-application-source-code-and-scripts"></a>Получение скриптов и исходного кода для SaaS-приложения Wingtip Tickets c мультитенантной БД

Скрипты для SaaS-приложения Wingtip Tickets c мультитенантной базой данных и исходный код этого приложения вы найдете в репозитории GitHub [WingtipTicketsSaaS-MultitenantDB](https://github.com/microsoft/WingtipTicketsSaaS-MultiTenantDB). Инструкции по скачиванию и разблокированию сценариев приложения SaaS Wingtip Tickets см. в статье [Общие рекомендации по работе с примерами приложений SaaS Wingtip Tickets](saas-tenancy-wingtip-app-guidance-tips.md).

## <a name="create-a-job-agent-database-and-new-job-agent"></a>Создание агента заданий и базы данных для него

В этом руководстве требуется создать базу данных агента заданий и агент заданий с помощью PowerShell. Как Агент SQL использует базу данных MSDB, так и агент заданий использует базу данных в Базе данных SQL Azure для хранения определений и состояния заданий, а также журнала. Создав агент заданий, вы можете сразу создавать и отслеживать задания.

1. В среде **PowerShell ISE** выберите *...\\Learning Modules\\Schema Management\\Demo-SchemaManagement.ps1*.
2. Нажмите клавишу **F5** для запуска скрипта.

Сценарий *Demo-SchemaManagement.ps1* вызовет сценарий *Deploy-SchemaManagement.ps1* для создания базы данных SQL _jobagent_ на сервере каталога. Затем он создает агент заданий, передавая имя базы данных _jobagent_ в качестве параметра.

## <a name="create-a-job-to-deploy-new-reference-data-to-all-tenants"></a>Создание задания и развертывание новых справочных данных на всех клиентах

#### <a name="prepare"></a>Подготовка.

В каждой базе данных клиента в таблице **VenueTypes** содержится набор типов мест проведения. Они определяют вид событий, проводимых в этом месте. Эти типы мест проведения соответствуют фоновому изображению, которое отображается в приложении событий клиента.  В этом упражнении вы развернете обновление во всех базах данных, чтобы добавить два дополнительных типа объектов: *Motorcycle Racing* (Мотоциклетные гонки) и *Swimming Club* (Плавательный клуб).

Сначала проверьте типы мест проведения, включенные в каждой клиентской базе данных. Подключитесь к одной из клиентских баз данных в SQL Server Management Studio (SSMS) и проверьте таблицу VenueTypes.  Выполнить запрос к этой таблице можно также в редакторе запросов на портале Azure, открыв его со страницы базы данных.

1. Откройте SSMS и подключитесь к клиентскому серверу *tenants1-dpt-&lt;пользователь&gt;.database.windows.net*.
1. Перейдите к базе данных *contosoconcerthall* на сервере *tenants1-dpt-&lt;пользователь&gt;* и запросите таблицу *VenueTypes*, чтобы убедиться, что места проведения *Motorcycle Racing* (Мотоциклетные гонки) и *Swimming Club (Плавательный клуб)* **отсутствуют**.



#### <a name="steps"></a>Шаги

Теперь создайте задание для обновления таблицы **VenueTypes** в каждой базе данных клиента, добавив два новых типа объектов.

Чтобы создать задание, используйте набор системных хранимых процедур заданий, созданный в базе данных _jobagent_. Эти хранимые процедуры были созданы вместе с агентом заданий.

1. В среде SSMS подключитесь к серверу клиента: tenants1-mt-&lt;пользователь&gt;.database.windows.net

2. Перейдите к базе данных *tenants1*.

3. Запросите таблицу *VenueTypes*, чтобы убедиться, что объекты *Motorcycle Racing* (Мотоциклетные гонки) и *Swimming Club* (Плавательный клуб) отсутствуют в списке результатов.

4. Подключитесь к серверу каталогов: *catalog-mt-&lt;пользователь&gt;.database.windows.net*.

5. Подключитесь к базе данных _jobagent_ на сервере каталогов.

6. В среде SSMS выберите *...\\Learning Modules\\Schema Management\\DeployReferenceData.sql*.

7. Измените инструкцию: set @User = &lt;пользователь&gt;, заменив значение "пользователь" значением, использованным при развертывании SaaS-приложения Wingtip Tickets c мультитенантной базой данных.

8. Нажмите клавишу **F5** для запуска скрипта.

#### <a name="observe"></a>Наблюдение

В сценарии *DeployReferenceData.sql* обратите внимание на следующие элементы:

- **sp\_add\_target\_group** создает целевую группу с именем *DemoServerGroup* и добавляет целевые элементы в группу.

- **sp\_add\_target\_group\_member** добавляет следующие элементы:
    - Тип целевого элемента *server*.
        - Сервер *tenants1-mt-&lt;user&gt;* содержит клиентские базы данных.
        - При добавлении сервера добавляются базы данных клиента, существующие на момент выполнения задания.
    - Тип целевого элемента *database* для шаблона базы данных (*basetenantdb*), которая находится на сервере *catalog-mt-&lt;пользователь&gt;*.
    - Тип целевого элемента *database* для включения базы данных *adhocanalytics*, которая будет использоваться в следующем руководстве.

- **sp\_add\_job** создает задание с названием *Reference Data Deployment* (Развертывание справочных данных).

- **sp\_add\_jobstep** создает шаг задания, содержащий текст команды T-SQL для обновления ссылочной таблицы VenueTypes.

- Остальные представления в скрипте отображают сведения о существовании объектов и отслеживают выполнение задания мониторинга. С помощью этих запросов можно просмотреть значение состояния в столбце **lifecycle**, чтобы определить, когда задание будет завершено. Задание обновляет базу данных клиентов и две дополнительных базы данных, содержащих ссылочную таблицу.

В среде SSMS перейдите к базе данных клиента на сервере *tenants1-dpt-&lt;user&gt;*. Запросите таблицу *VenueTypes*, чтобы убедиться, что объекты *Motorcycle Racing* (Мотоциклетные гонки) и *Swimming Club* (Плавательный клуб) теперь добавлены в таблицу. Общее число типов объектов должно увеличиться вдвое.

## <a name="create-a-job-to-manage-the-reference-table-index"></a>Создание задания для управления индексом справочной таблицы

Оно создает задание для перестройки индекса первичного ключа ссылочной таблицы во всех базах данных клиента. Перестройка индекса — это обычная операция управления базой данных, которую администратор может выполнить для улучшения производительности после загрузки больших объемов данных.

1. В SSMS подключитесь к базе данных _jobagent_ на сервере *catalog-mt-&lt;пользователь&gt;.database.windows.net*.

2. В среде SSMS откройте файл *...\\Learning Modules\\Schema Management\\OnlineReindex.sql*.

3. Нажмите клавишу **F5** для запуска скрипта.

#### <a name="observe"></a>Наблюдение

В сценарии *OnlineReindex.sql* обратите внимание на следующие элементы:

* **sp\_add\_job** создает новое задание с именем *Online Reindex PK\_\_VenueTyp\_\_265E44FD7FD4C885*.

* **sp\_add\_jobstep** создает шаг задания, содержащий текст команды T-SQL для обновления индекса.

* Остальные представления в скрипте отслеживают выполнение задания. С помощью этих запросов можно просмотреть значение состояния в столбце **lifecycle**, чтобы определить, когда задание будет успешно завершено во всех целевых элементах группы.

## <a name="additional-resources"></a>Дополнительные ресурсы

<!-- TODO: Additional tutorials that build upon the Wingtip Tickets SaaS Multi-tenant Database application deployment (*Tutorial link to come*)
(saas-multitenantdb-wingtip-app-overview.md#sql-database-wingtip-saas-tutorials)
-->
* [Управление масштабируемыми облачными базами данных](./elastic-jobs-overview.md)

## <a name="next-steps"></a>Дальнейшие действия

Из этого руководства вы узнали, как выполнять такие задачи:

> [!div class="checklist"]
> * Создание агента заданий для выполнения заданий T-SQL в нескольких базах данных.
> * Обновление ссылочных данных во всех базах данных клиента.
> * Создание индекса для таблицы во всех базах данных клиента.

После этого ознакомьтесь с [руководством по автоматизированной системе отчетности](./saas-multitenantdb-adhoc-reporting.md), чтобы узнать о выполнении распределенных запросов в клиентских базах данных.