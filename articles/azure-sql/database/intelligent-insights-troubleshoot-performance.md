---
title: Устранение проблем с производительностью с помощью Intelligent Insights
description: Intelligent Insights помогает устранять неполадки с производительностью базы данных SQL Azure и Azure SQL Управляемый экземпляр.
services: sql-database
ms.service: sql-db-mi
ms.subservice: performance
ms.custom: sqldbrb=2
ms.devlang: ''
ms.topic: troubleshooting
author: danimir
ms.author: danil
ms.reviewer: wiassaf, sstein
ms.date: 1/14/2021
ms.openlocfilehash: 17ea6716f090144e8dfef16721bfb69dc23e9912
ms.sourcegitcommit: e559daa1f7115d703bfa1b87da1cf267bf6ae9e8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/17/2021
ms.locfileid: "100589327"
---
# <a name="troubleshoot-azure-sql-database-and-azure-sql-managed-instance-performance-issues-with-intelligent-insights"></a>Устранение неполадок с производительностью базы данных SQL Azure и SQL Azure Управляемый экземпляр с Intelligent Insights
[!INCLUDE[appliesto-sqldb-sqlmi](../includes/appliesto-sqldb-sqlmi.md)]

На этой странице содержатся сведения о проблемах производительности базы данных SQL Azure и SQL Azure Управляемый экземпляр, обнаруженных в журнале ресурсов [Intelligent Insights](intelligent-insights-overview.md) . Метрики и журналы ресурсов можно передавать в [Azure Monitor журналы](../../azure-monitor/insights/azure-sql.md), [концентраторы событий Azure](../../azure-monitor/essentials/resource-logs.md#send-to-azure-event-hubs), службу [хранилища Azure](metrics-diagnostic-telemetry-logging-streaming-export-configure.md#stream-into-azure-storage)или стороннее решение для настраиваемых оповещений и отчетов DevOps.

> [!NOTE]
> Краткое руководство по устранению неполадок производительности с помощью Intelligent Insights см [. в этом](intelligent-insights-troubleshoot-performance.md#recommended-troubleshooting-flow) документе.
>
> Intelligent Insights — это предварительная версия функции, недоступная в следующих регионах: Западная Европа, Северная Европа, Западная часть США 1 и Восточная часть США 1.

## <a name="detectable-database-performance-patterns"></a>Выявляемые шаблоны снижения производительности базы данных

Intelligent Insights автоматически обнаруживает проблемы с производительностью в зависимости от времени ожидания выполнения запроса, ошибок или времени ожидания. Intelligent Insights выводит в журнал ресурсов обнаруженные шаблоны производительности. Ниже в таблице кратко описаны выявляемые шаблоны снижения производительности.

| Выявляемые шаблоны снижения производительности | База данных SQL Azure | Управляемый экземпляр SQL Azure |
| :------------------- | ------------------- | ------------------- |
| [Достижение лимитов ресурсов](intelligent-insights-troubleshoot-performance.md#reaching-resource-limits) | Достигнут предел использования доступных ресурсов (DTU), рабочих потоков базы данных или сеансов входа в базу данных, доступных в отслеживаемой подписке. Это влияет на производительность. | Использование ресурсов ЦП приближается к пределам ресурсов. Это негативно влияет на производительность базы данных. |
| [Увеличение рабочей нагрузки](intelligent-insights-troubleshoot-performance.md#workload-increase) | Обнаружено увеличение рабочей нагрузки или непрерывное накопление рабочей нагрузки для базы данных. Это влияет на производительность. | Обнаружено увеличение рабочей нагрузки. Это негативно влияет на производительность базы данных. |
| [Нехватка памяти](intelligent-insights-troubleshoot-performance.md#memory-pressure) | Работники, которые запросили предоставление памяти, должны ожидать выделения памяти для статистически значимых объемов времени или увеличить совокупность рабочих ролей, которые запросили предоставление памяти. Это влияет на производительность. | Рабочие роли, запрашивающие временно предоставляемый буфер памяти, ожидают выделения памяти статистически значимое количество времени. Это негативно влияет на производительность базы данных. |
| [Блокировка](intelligent-insights-troubleshoot-performance.md#locking) | Обнаружена чрезмерная блокировка базы данных, влияющая на производительность. | Обнаружена чрезмерная блокировка базы данных, негативно влияющая на производительность базы данных. |
| [Повышенное значение MAXDOP](intelligent-insights-troubleshoot-performance.md#increased-maxdop) | Значение параметра максимальной степени параллелизма (MAXDOP) было изменено, что негативно влияет на эффективность выполнения запроса. Это влияет на производительность. | Значение параметра максимальной степени параллелизма (MAXDOP) было изменено, что негативно влияет на эффективность выполнения запроса. Это влияет на производительность. |
| [Состязание за кратковременную блокировку страниц](intelligent-insights-troubleshoot-performance.md#pagelatch-contention) | Несколько потоков одновременно пытаются обратиться к одним и тем же страницам в буфере данных в памяти, что приводит к увеличению времени ожидания и вызывает состязание за кратковременную блокировку страниц. Это влияет на производительность. | Несколько потоков одновременно пытаются обратиться к одним и тем же страницам в буфере данных в памяти, что приводит к увеличению времени ожидания и вызывает состязание за кратковременную блокировку страниц. Это негативно влияет на производительность базы данных. |
| [Отсутствующий индекс](intelligent-insights-troubleshoot-performance.md#missing-index) | Обнаружен отсутствующий индекс, влияющий на производительность. | Обнаружен отсутствующий индекс базы данных, негативно влияющий на производительность базы данных. |
| [Новый запрос](intelligent-insights-troubleshoot-performance.md#new-query) | Обнаружен новый запрос, влияющий на общую производительность. | Обнаружен новый запрос, который негативно влияет на общую производительность базы данных. |
| [Повышенное значение статистики ожидания](intelligent-insights-troubleshoot-performance.md#increased-wait-statistic) | Обнаружено увеличенное время ожидания базы данных, влияющее на производительность. | Обнаружены повышенные значения времени ожидания базы данных, негативно влияющие на производительность базы данных. |
| [Состязание за TempDB](intelligent-insights-troubleshoot-performance.md#tempdb-contention) | Несколько потоков пытается получить доступ к одному и тому же ресурсу TempDB, создавая узкое место. Это влияет на производительность. | Несколько потоков пытается получить доступ к одному и тому же ресурсу TempDB, создавая узкое место. Это негативно влияет на производительность базы данных. |
| [Нехватка DTU эластичного пула](intelligent-insights-troubleshoot-performance.md#elastic-pool-dtu-shortage) | Недостаток доступных Edtu в эластичном пуле влияет на производительность. | Недоступно для Управляемый экземпляр Azure SQL, так как в нем используется модель Виртуальное ядро. |
| [Регрессия плана](intelligent-insights-troubleshoot-performance.md#plan-regression) | Обнаружен новый план или изменение рабочей нагрузки существующего плана. Это влияет на производительность. | Обнаружен новый план или изменение рабочей нагрузки существующего плана. Это негативно влияет на производительность базы данных. |
| [Изменение значения конфигурации уровня базы данных](intelligent-insights-troubleshoot-performance.md#database-scoped-configuration-value-change) | Обнаружено изменение конфигурации базы данных, негативно влияющее на производительность базы данных. | Обнаружено изменение конфигурации базы данных, негативно влияющее на производительность базы данных. |
| [Медленная работа клиента](intelligent-insights-troubleshoot-performance.md#slow-client) | Медленный клиент приложения не может достаточно быстро использовать выходные данные из базы данных. Это влияет на производительность. | Медленный клиент приложения не может достаточно быстро использовать выходные данные из базы данных. Это негативно влияет на производительность базы данных. |
| [Переход на более низкую ценовую категорию](intelligent-insights-troubleshoot-performance.md#pricing-tier-downgrade) | Действие перехода на более низкую ценовую категорию уменьшило объем доступных ресурсов. Это влияет на производительность. | Действие перехода на более низкую ценовую категорию уменьшило объем доступных ресурсов. Это негативно влияет на производительность базы данных. |

> [!TIP]
> Для непрерывной оптимизации производительности баз данных Включите [автоматическую настройку](automatic-tuning-overview.md). Эта встроенная функция анализа постоянно отслеживает базу данных, автоматически настраивает индексы и применяет исправления плана выполнения запросов.
>

В следующем разделе более подробно описаны обнаруженные шаблоны снижения производительности.

## <a name="reaching-resource-limits"></a>достижение лимитов ресурсов;

### <a name="what-is-happening"></a>Что происходит

Этот выявляемый шаблон снижения производительности объединяет проблемы производительности, связанные с достижением лимитов доступных ресурсов, рабочих ролей и сеансов. После обнаружения этой проблемы с производительностью в поле описания журнала диагностики указывается, связана ли она с лимитами ресурсов, рабочих ролей или сеансов.

Ресурсы в базе данных SQL Azure обычно называются ресурсами [DTU](service-tiers-dtu.md) или [Виртуальное ядро](service-tiers-vcore.md) , а ресурсы в Azure SQL управляемый экземпляр называются ресурсами Виртуальное ядро. Шаблон достижения лимитов ресурсов обнаруживается, когда причиной выявленного снижения производительности обработки запросов является достижение лимитов измеряемого ресурса.

Ресурс «ограничения сеанса» обозначает количество доступных одновременных операций входа в базу данных. Этот шаблон производительности распознается, когда приложения, подключенные к базам данных, достигли количества доступных одновременных операций входа в базу данных. Если приложения пытаются использовать больше сеансов, чем позволяет база данных, производительность обработки запросов снижается.

Достижение лимита рабочих ролей — это частный случай достижения лимитов ресурсов, так как доступные рабочие роли не учитываются при использовании DTU или виртуального ядра. Достижение лимитов рабочих ролей для базы данных может привести к увеличению времени ожидания ресурсов, что вызывает снижение производительности обработки запросов.

### <a name="troubleshooting"></a>Устранение неполадок

Журнал диагностики генерирует хэши запросов, которые повлияли на производительность и процент потребления ресурсов. Эти сведения можно использовать в качестве отправной точки для оптимизации рабочей нагрузки базы данных. В частности, можно оптимизировать запросы, приводящие к снижению производительности, путем добавления индексов. Или оптимизировать приложения за счет более равномерного распределения рабочей нагрузки. Если вы не можете сократить рабочие нагрузки или выполнить оптимизацию, рассмотрите возможность увеличения ценовой категории подписки базы данных, чтобы увеличить объем доступных ресурсов.

При достижении лимитов доступных сеансов можно оптимизировать приложения, уменьшив количество имен для входа в базу данных. Если вы не можете уменьшить количество имен входа из приложений в базу данных, рассмотрите возможность увеличения ценовой категории подписки базы данных. или разделить базу данных на несколько баз данных, чтобы обеспечить более сбалансированное распределение рабочей нагрузки.

Дополнительные рекомендации по устранению ограничений сеанса см. в разделе [как работать с ограничениями максимального числа имен входа](/archive/blogs/latam/how-to-deal-with-the-limits-of-azure-sql-database-maximum-logins). Сведения об ограничениях на уровне сервера и подписки см. [в разделе Обзор ограничений ресурсов на сервере](resource-limits-logical-server.md) .

## <a name="workload-increase"></a>Увеличение рабочей нагрузки

### <a name="what-is-happening"></a>Что происходит

Этот шаблон снижения производительности позволяет выявить проблемы из-за увеличения рабочей нагрузки или, если ситуация серьезнее, из-за накопления рабочей нагрузки.

Для обнаружения используется сочетание нескольких метрик. Основные измеряемые метрики позволяют обнаружить увеличение рабочей нагрузки по сравнению с предыдущими базовыми показателями рабочей нагрузки. Кроме того, для обнаружения используется измерение значительного увеличения числа рабочих потоков, которого достаточно для того, чтобы негативно повлиять на производительность запросов.

В более серьезной форме Рабочая нагрузка может постоянно отображаться из-за невозможности базы данных справиться с рабочей нагрузкой. В результате размер рабочей нагрузки постоянно растет, то есть возникает ее накопление. В этой ситуации время, на протяжении которого рабочая нагрузка ожидает выполнения, увеличивается. Это состояние — одна из наиболее серьезных проблем с производительностью базы данных. Данная проблема выявляется за счет мониторинга увеличения числа прерванных рабочих потоков.

### <a name="troubleshooting"></a>Устранение неполадок

Журнал диагностики содержит число запросов, время выполнения которых увеличилось, и хэш запросов, составляющих наибольшую часть рабочей нагрузки. Эти сведения можно использовать в качестве отправной точки для оптимизации рабочей нагрузки, в частности определенного запроса, который больше остальных повлиял на увеличение рабочей нагрузки.

Можно также рассмотреть возможность более равномерного распределения рабочих нагрузок в базе данных. Вы можете оптимизировать запрос, который влияет на производительность, добавив индексы. Можно также распределить рабочую нагрузку между несколькими базами данных. Если эти решения невозможны, рассмотрите возможность увеличения ценовой категории подписки базы данных, чтобы увеличить объем доступных ресурсов.

## <a name="memory-pressure"></a>Нехватка памяти

### <a name="what-is-happening"></a>Что происходит

Этот шаблон снижения производительности указывает на снижение текущей производительности базы данных из-за нехватки памяти или, если ситуация более серьезная, из-за накопления запросов на выделение памяти по сравнению с базовыми показателями производительности за последние семь дней.

Нехватка памяти означает условие производительности, при котором существует большое количество рабочих потоков, запрашивающих предоставление памяти. Большое количество томов приводит к высокой степени использования памяти, при которой база данных не может эффективно выделять память для всех рабочих потоков, запрашивающих ее. Одна из наиболее распространенных причин этой проблемы связана с объемом памяти, доступной для базы данных с одной стороны. а с другой стороны — с увеличением рабочей нагрузки, приводящей к увеличению числа рабочих потоков и нехватке памяти.

В более серьезной ситуации нехватки памяти запросы на выделение памяти накапливаются. Это признак того, что число рабочих потоков, запрашивающих временно предоставляемый буфер памяти, превышает число запросов, освобождающих память. Это число рабочих потоков, запрашивающих предоставление памяти, также может постоянно увеличиваться (накапливаться up), так как ядру СУБД не удается эффективно выделить память, достаточную для удовлетворения спроса. Накопление запросов на выделение памяти представляет собой одну из наиболее серьезных проблем с производительностью базы данных.

### <a name="troubleshooting"></a>Устранение неполадок

Журнал диагностики содержит сведения о хранении объектов в памяти, включая клерк (то есть рабочий поток), который помечен как основная причина использования большого объема памяти, и соответствующие метки времени. Эти сведения можно использовать как основу при устранении неполадок.

Можно оптимизировать или удалить запросы, связанные с клерками с наибольшим использованием памяти. Можно также проследить за тем, чтобы данные, которые не планируется использовать, не запрашивались. Рекомендуется всегда использовать в запросах предложение WHERE. Кроме того, рекомендуется создать некластеризованные индексы для поиска данных, а не сканирования.

Вы можете снизить рабочую нагрузку, оптимизировав или распределив ее по нескольким базам данных. Рабочую нагрузку также можно распределить между несколькими базами данных. Если эти решения невозможны, рассмотрите возможность увеличения ценовой категории базы данных, чтобы увеличить объем ресурсов памяти, доступных базе данных.

Дополнительные рекомендации по устранению неполадок см. в разделе [Memory Grants Meditation: The mysterious SQL Server memory consumer with Many Names](https://techcommunity.microsoft.com/t5/sql-server-support/memory-grants-meditation-the-mysterious-sql-server-memory/ba-p/333994) (Устранение проблем с памятью: загадочный потребитель памяти SQL Server со множеством имен).

## <a name="locking"></a>Блокировка

### <a name="what-is-happening"></a>Что происходит

Этот шаблон снижения производительности указывает на снижение производительности текущей базы данных, при котором была выявлена чрезмерная блокировка базы данных по сравнению с базовыми показателями производительности за последние семь дней.

В современных реляционных СУБД блокировка необходима для реализации многопоточных систем, в которых максимальная производительность достигается благодаря выполнению нескольких одновременных рабочих процессов и параллельных транзакций базы данных, где это возможно. Блокировка в этом контексте означает встроенный механизм доступа, при котором только одна транзакция может иметь монопольный доступ к необходимым строкам, страницам, таблицам и файлам, не состязаясь за ресурсы с другой транзакцией. После того как транзакция, заблокировавшая ресурсы, завершает их использование, их блокировка снимается и они становятся доступны другим транзакциям. Дополнительные сведения о блокировке см. в статье [Блокировка в ядре СУБД](/previous-versions/sql/sql-server-2008-r2/ms190615(v=sql.105)).

Транзакции, выполняемые ядром SQL, в течение длительного времени ожидают доступа к заблокированным ресурсам, это вызывает снижение производительности выполнения рабочей нагрузки.

### <a name="troubleshooting"></a>Устранение неполадок

Журнал диагностики создает сведения о блокировке, которые можно использовать как основу для устранения неполадок. Можно проанализировать блокирующие запросы из отчетов, то есть запросы, блокирующие ресурсы и снижающие производительность, и удалить их. В некоторых случаях возможна успешная оптимизация блокирующих запросов.

Наиболее простой и безопасный способ устранения проблемы — ограничение объема транзакций и сокращение объема блокируемых ресурсов для наиболее ресурсоемких запросов. Большой пакет операций можно разбить на операции меньшего размера. Рекомендуется сократить объем блокируемых запросом ресурсов, максимально повысив его эффективность. Сократите крупные операции сканирования, так как они повышают вероятность возникновения взаимоблокировок и отрицательно влияют на общую производительность базы данных. Для выявленных запросов, которые вызывают блокировку, можно создать новые индексы или добавить столбцы в существующий индекс, чтобы избежать сканирования таблиц.

Дополнительные рекомендации см. в следующих статьях:
- [Изучение и устранение проблем с блокировкой SQL Azure](understand-resolve-blocking.md)
- [Устранение проблем с блокировкой, вызванных укрупнением блокировок в SQL Server](https://support.microsoft.com/help/323630/how-to-resolve-blocking-problems-that-are-caused-by-lock-escalation-in)

## <a name="increased-maxdop"></a>Повышенное значение MAXDOP

### <a name="what-is-happening"></a>Что происходит

Этот выявляемый шаблон снижения производительности указывает на ситуацию, в которой выбранный план выполнения запроса распараллелен больше, чем следует. Оптимизатор запросов может повысить производительность рабочей нагрузки за счет параллельного выполнения запросов, чтобы ускорить работу, когда это возможно. В некоторых случаях параллельная обработка запросов рабочими ролями требует больше времени на ожидание друг друга для синхронизации и объединения результатов по сравнению с выполнением того же запроса с меньшим распараллеливанием рабочих ролей, а в некоторых случаях по сравнению с выполнением отдельным рабочим потоком.

Экспертная система анализирует текущую производительность базы данных по сравнению с базовым периодом. Она определяет, выполняется ли запрос, который ранее уже выполнялся, медленнее, так как план выполнения запросов более параллелизован, чем необходимо.

Параметр конфигурации сервера MAXDOP используется для управления количеством ядер ЦП, которые можно использовать для параллельного выполнения одного и того же запроса.

### <a name="troubleshooting"></a>Устранение неполадок

Журнал диагностики содержит хэши запросов, время выполнения которых увеличилось из-за чрезмерного распараллеливания. Журнал также содержит значения времени ожидания CXP. Это время, которое отдельный поток организатора или координатора (поток 0) ожидает завершения выполнения всех остальных потоков перед объединением результатов и переходом к следующей операции. Кроме того, журнал диагностики содержит общее время ожидания выполнения для запросов с низкой производительностью. Эти сведения можно использовать как основу при устранении неполадок.

Сначала следует оптимизировать или упростить сложные запросы. Рекомендуется разбить длительные пакетных задания на более мелкие. Кроме того, убедитесь, что созданы индексы для обработки запросов. Можно также вручную задать максимальную степень параллелизма (MAXDOP) для запроса, производительность которого оказалась низкой. Для настройки этой операции с помощью T-SQL см. сведения в разделе [Настройка параметра конфигурации сервера max degree of parallelism](/sql/database-engine/configure-windows/configure-the-max-degree-of-parallelism-server-configuration-option).

Если задать для параметра конфигурации сервера MAXDOP нулевое значение (0), то в качестве значения по умолчанию это означает, что база данных может использовать все доступные ядра ЦП для параллелизации потоков для выполнения одного запроса. Если для параметра конфигурации сервера MAXDOP задать единицу (1), то для выполнения отдельного запроса сможет использоваться только одно ядро. То есть фактически распараллеливание будет отключено. В зависимости от ситуации, доступных ядер базы данных и сведений в журнале диагностики, можно задать для параметра MAXDOP соответствующее число ядер для параллельного выполнения запросов, чтобы устранить возникшую проблему.

## <a name="pagelatch-contention"></a>Состязание за кратковременную блокировку страниц

### <a name="what-is-happening"></a>Что происходит

Этот шаблон снижения производительности указывает на снижение текущей производительности рабочей нагрузки базы данных из-за состязания с кратковременной блокировкой страниц по сравнению с базовыми показателями рабочей нагрузки за последние семь дней.

Кратковременные блокировки — это механизмы упрощенной синхронизации, используемые для реализации многопоточности. Они гарантируют согласованность структур в памяти, включая индексы, страницы данных и другие внутренние структуры.

Существует много типов кратковременных блокировок. В целях упрощения кратковременные блокировки буфера используются для защиты страниц в памяти в буферном пуле, а кратковременные блокировки ввода-вывода используются для защиты страниц, которые еще не загружены в буферный пул. При каждой операции записи или чтения данных страницы в буферном пуле рабочий поток должен сначала наложить кратковременную блокировку на буфер для этой страницы. Каждый раз, когда рабочий поток пытается получить доступ к странице, которая еще не доступна в буферном пуле в памяти, выполняется запрос на ввод-вывод для загрузки необходимых сведений из хранилища. Эта последовательность событий указывает на более серьезное снижение производительности.

Состязание за кратковременную блокировку страниц происходит, когда несколько потоков одновременно пытаются наложить кратковременную блокировку на одну и ту же структуру в памяти, что приводит к увеличению времени ожидания выполнения запроса. В случае состязания за блокировку страниц для вода-вывода, когда требуется доступ к данным из хранилища, время ожидания будет еще больше. Это может значительно повлиять на производительность рабочей нагрузки. Состязание за кратковременную блокировку страниц — наиболее распространенная ситуация, в которой потоки ожидают друг друга и состязаются за ресурсы в многопроцессорных системах.

### <a name="troubleshooting"></a>Устранение неполадок

Журнал диагностики выводит сведения о состязании за кратковременную блокировку страниц. Эти сведения можно использовать как основу при устранении неполадок.

Поскольку вода является внутренним механизмом управления, он автоматически определяет, когда их использовать. Решения в разработке приложений, включая структуру схемы, могут влиять на поведение кратковременных блокировок страниц ввиду детерминированного поведения кратковременных блокировок.

Один из методов обработки состязаний за кратковременную блокировку — замена последовательного ключа индекса непоследовательным ключом, что позволяет равномерно распределить вставку данных в пределах индекса. Как правило, начальный столбец в индексе распределяет рабочую нагрузку пропорционально. Кроме того, можно рассмотреть возможность секционирования таблиц. Создание схемы хэш-секционирования с вычисляемым столбцом для секционированной таблицы — распространенный способ устранения чрезмерного состязания за кратковременную блокировку. В случае состязания за блокировку страниц для вода-вывода рекомендуется добавить индексы, что позволит устранить данную проблему с производительностью.

Дополнительные сведения см. в документе [Diagnosing and Resolving Latch Contention on SQL Server](http://databaser.net/moniwiki/pds/PerformanceTuning/SQLServerLatchContention.pdf) (Диагностика и устранение состязания за кратковременную блокировку в SQL Server), который можно скачать в формате PDF.

## <a name="missing-index"></a>Отсутствующий индекс

### <a name="what-is-happening"></a>Что происходит

Этот шаблон снижения производительности указывает на снижение текущей производительности рабочей нагрузки базы данных по сравнению с базовыми показателями за последние семь дней из-за отсутствующего индекса.

Индекс используется для повышения производительность запросов. Он обеспечивает быстрый доступ к данным таблиц, уменьшая число страниц в наборе данных, которые должны быть просмотрены или просканированы.

Запросы, которые привели к снижению производительности, определяются с помощью этого шаблона, и для повышения их производительности можно создать индексы.

### <a name="troubleshooting"></a>Устранение неполадок

Журнал диагностики содержит хэши выявленных запросов, которые негативно влияют на производительность рабочей нагрузки. Можно создавать индексы для этих запросов. Можно также оптимизировать или удалить эти запросы, если они не являются обязательными. Для повышения производительности рекомендуется избегать выполнения запросов к данным, которые не используются.

> [!TIP]
> Знаете ли вы, что встроенные аналитические средства могут автоматически управлять лучшими индексами для баз данных?
>
> Для обеспечения непрерывной оптимизации производительности рекомендуется включить [автоматическую настройку](automatic-tuning-overview.md). Эта уникальная встроенная функция анализа постоянно отслеживает базу данных и автоматически настраивает и создает индексы для баз данных.
>

## <a name="new-query"></a>Создать запрос

### <a name="what-is-happening"></a>Что происходит

Этот шаблон снижения производительности указывает, что был обнаружен новый запрос с низкой производительностью, который снижает производительность рабочей нагрузки по сравнению с базовыми показателями производительности за последние семь дней.

Иногда создание высокопроизводительного запроса может быть сложной задачей. Дополнительные сведения о создании запросов см. в статье о [написании SQL-запросов](/previous-versions/sql/sql-server-2005/express-administrator/bb264565(v=sql.90)). Дополнительные сведения об оптимизации производительности имеющихся запросов см. в статье [Настройка запроса](/previous-versions/sql/sql-server-2008-r2/ms176005(v=sql.105)).

### <a name="troubleshooting"></a>Устранение неполадок

Журнал диагностики содержит до двух новых запросов, потребляющих больше всего ресурсов ЦП, включая их описание и хэши. Так как обнаруженный запрос влияет на производительность рабочей нагрузки, его можно оптимизировать. Целесообразно извлекать только те данные, которые необходимо использовать. Мы советуем использовать запросы с предложением WHERE, а также упростить сложные запросы и разделить их на запросы меньшего размера. Рекомендуется также разбивать большие пакетные запросы на пакетные запросы меньшего размера. Как правило, устранить данную проблему с производительностью помогает создание индексов для новых запросов.

В базе данных SQL Azure рассмотрите возможность использования [Анализ производительности запросов](query-performance-insight-use.md).

## <a name="increased-wait-statistic"></a>Увеличенная статистика ожидания

### <a name="what-is-happening"></a>Что происходит

Этот выявляемый шаблон снижения производительности указывает на снижение производительности рабочей нагрузки, которое определяется на основе низкой производительности запросов по сравнению с базовыми показателями рабочей нагрузки за последние семь дней.

В этом случае системе не удалось отнести запросы с низкой производительностью к другим стандартным категориям снижения производительности, но она обнаружила статистику ожидания, связанную со снижением эффективности. Поэтому она отнесла их к категории *повышенное значение статистики ожидания*. Это категория запросов, в которой снижение производительности связано с повышенным значением статистики ожидания.

### <a name="troubleshooting"></a>Устранение неполадок

Журнал диагностики содержит сведения о повышенных значениях времени ожидания и хэши соответствующих запросов.

Так как системе не удалось определить первопричину низкой производительности запросов, сведения диагностики выступают хорошей отправной точкой для устранения неполадок вручную. Производительность этих запросов можно оптимизировать. Рекомендуется получать только данные, которые необходимо использовать, а также упростить и разбить сложные запросы на запросы меньшего размера.

Дополнительные сведения об оптимизации производительности запросов см. в разделе [Настройка запросов](/previous-versions/sql/sql-server-2008-r2/ms176005(v=sql.105)).

## <a name="tempdb-contention"></a>Состязание за tempdb

### <a name="what-is-happening"></a>Что происходит

Этот выявляемый шаблон снижения производительности указывает, что на производительность базы данных негативно влияет узкое место, возникшее из-за потоков, пытающихся получить доступ к ресурсам tempdb. (Это условие не связано с операциями ввода-вывода.) Типичный сценарий для этой проблемы с производительностью — сотни параллельных запросов, которые создают, используют и удаляют небольшие таблицы tempDB. Система обнаружила, что число одновременно выполняющихся запросов, использующих одинаковые таблицы tempdb, статистически значительно увеличилось и теперь негативно влияет на производительность базы данных по сравнению с базовыми показателями производительности за последние семь дней.

### <a name="troubleshooting"></a>Устранение неполадок

Журнал диагностики выводит сведения о состязании за tempdb. Данные можно использовать в качестве отправной точки при устранении неполадок. Есть две вещи, которые можно предпринять, чтобы обойти эту проблему и увеличить пропускную способность всей рабочей нагрузки: прекратить использование временных таблиц и использовать таблицы, оптимизированные для памяти.

Дополнительные сведения см. [в разделе Введение в оптимизированные для памяти таблицы](/sql/relational-databases/in-memory-oltp/introduction-to-memory-optimized-tables).

## <a name="elastic-pool-dtu-shortage"></a>Нехватка DTU эластичного пула

### <a name="what-is-happening"></a>Что происходит

Этот выявляемый шаблон снижения производительности указывает на снижение текущей производительности рабочей нагрузки базы данных по сравнению с базовыми показателями за последние семь дней. Это происходит из-за нехватки DTU, доступных в эластичном пуле подписки.

[Ресурсы пула эластичных БД Azure](elastic-pool-overview.md) используются в качестве пула доступных ресурсов, совместно используемых несколькими базами данных в целях масштабирования. Когда ресурсов eDTU, доступных в эластичном пуле, недостаточно, чтобы обеспечить все базы данных в пуле, система выявляет проблему с производительностью из-за нехватки DTU эластичного пула.

### <a name="troubleshooting"></a>Устранение неполадок

Журнал диагностики содержит сведения об эластичном пуле, перечень баз данных, которые используют больше всего ресурсов DTU, и процент ресурсов DTU пула, используемых наиболее ресурсоемкой базой данных.

Так как данная проблема производительности связана с несколькими базами данных, использующими один пул eDTU в эластичном пуле, действия по устранению этой проблемы сосредотачиваются на базах данных, которые используют больше всего ресурсов DTU. Вы можете уменьшить нагрузку на самые ресурсоемкие базы данных, оптимизировав самые ресурсоемкие запросы в этих базах данных. Можно также проследить за тем, чтобы данные, которые не используются, не запрашивались. Другой подход заключается в оптимизации приложений, использующих базы данных, которые потребляют больше всего ресурсов DTU, и перераспределении рабочей нагрузки между несколькими базами данных.

Если невозможно сократить и оптимизировать текущую рабочую нагрузку наиболее ресурсоемких баз данных, рассмотрите возможность увеличения ценовой категории эластичного пула. Ее повышение позволит увеличить число DTU в эластичном пуле.

## <a name="plan-regression"></a>Снижение эффективности плана

### <a name="what-is-happening"></a>Что происходит

Этот шаблон производительности определяет условие, в котором база данных использует неоптимальный план выполнения запроса. Как правило, неоптимальный план повышает объем выполняемых запросов и приводит к увеличению времени ожидания текущих и других запросов.

Ядро СУБД определяет план выполнения запроса с наименьшими затратами на выполнение запроса. При изменении типа запросов и рабочих нагрузок иногда существующие планы перестают работать, или, возможно, ядро СУБД не делало хорошую оценку. Исправить планы выполнения запросов можно вручную.

Этот выявляемый шаблон снижения производительности учитывает три разных случая снижения эффективности плана: ухудшение показателей нового плана, ухудшение показателей старого плана и изменение рабочей нагрузки существующего плана. Определенный тип регрессии плана, возникший в предоставленном свойстве *details* в журнале диагностики.

Новое условие регрессии плана означает состояние, в котором ядро СУБД начинает выполнять новый план выполнения запроса, который не так эффективен, как старый план. Предыдущая регрессия плана относится к состоянию, когда ядро СУБД переключается с использования нового, более эффективного плана к старому плану, что не так эффективно, как новый план. Снижение эффективности существующих планов из-за изменения рабочей нагрузки означает ситуацию, в которой новый и старый план непрерывно использовались по очереди, причем предпочтение отдавалось плану с более низкой эффективностью.

Дополнительные сведения о снижении эффективности планов см. в разделе [What is plan regression in SQL Server?](/archive/blogs/sqlserverstorageengine/what-is-plan-regression-in-sql-server) (Что такое снижение эффективности плана в SQL Server?).

### <a name="troubleshooting"></a>Устранение неполадок

Журнал диагностики содержит хэши запросов, идентификатор высокоэффективного плана, идентификатор низкоэффективного плана и идентификаторы запросов. Эти сведения можно использовать как основу при устранении неполадок.

Можно проанализировать, какой план лучше подходит для конкретных запросов. Это можно определить с помощью указанных хэшей запросов. Когда вы определите, какой план лучше подходит для запросов, можно будет применить его вручную.

Дополнительные сведения см. в разделе [How SQL Server 2017 prevents plan regressions](/archive/blogs/sqlserverstorageengine/you-shall-not-regress-how-sql-server-2017-prevents-plan-regressions) (Как SQL Server 2017 предотвращает снижение эффективности).

> [!TIP]
> Знаете ли вы, что встроенная функция анализа может автоматически управлять наиболее производительными планами выполнения запросов для баз данных?
>
> Для обеспечения непрерывной оптимизации производительности рекомендуется включить [автоматическую настройку](automatic-tuning-overview.md). Эта встроенная функция анализа постоянно отслеживает базу данных и автоматически настраивает и создает оптимальные планы выполнения запросов для баз данных.

## <a name="database-scoped-configuration-value-change"></a>Изменение значения конфигурации уровня базы данных

### <a name="what-is-happening"></a>Что происходит

Этот выявляемый шаблон снижения производительности указывает, что в конфигурацию уровня базы данных было внесено изменение, которое является причиной снижения производительности по сравнению с показателями рабочей нагрузки базы данных за последние семь дней. Этот шаблон означает, что последнее изменение, внесенное в конфигурацию уровня базы данных, негативно влияет на производительность базы данных.

Изменение конфигурации уровня базы данных можно задать отдельно для каждой базы данных. Данная конфигурация используется на индивидуальной основе для оптимизации производительности отдельных баз данных. Для каждой отдельной базы данных можно настроить следующие параметры: MAXDOP, LEGACY_CARDINALITY_ESTIMATION, PARAMETER_SNIFFING, QUERY_OPTIMIZER_HOTFIXES и CLEAR PROCEDURE_CACHE.

### <a name="troubleshooting"></a>Устранение неполадок

Журнал диагностики содержит последние изменения конфигурации уровня базы данных, которые привели к снижению производительности по сравнению с показателями рабочей нагрузки за последние семь дней. Вы можете отменить изменения конфигурации и восстановить предыдущие значения. Можно также поочередно настроить все ее значения, пока не будет достигнут нужный уровень производительности. Можно также скопировать значения конфигурации уровня базы данных из аналогичной базы данных с удовлетворительной производительностью. Если не удается устранить неполадки производительности, вернитесь к значениям по умолчанию и попытайтесь выполнить точную настройку, начиная с этого базового плана.

Дополнительные сведения об оптимизации конфигурации уровня базы данных и синтаксисе T-SQL для изменения конфигурации приведены в статье [ALTER DATABASE SCOPED CONFIGURATION (Transact-SQL)](/sql/t-sql/statements/alter-database-scoped-configuration-transact-sql).

## <a name="slow-client"></a>Медленная работа клиента

### <a name="what-is-happening"></a>Что происходит

Этот шаблон производительности указывает на то, что клиент, использующий базу данных, не может использовать выходные данные базы данных так быстро, как база данных отправляет результаты. Поскольку база данных не хранит результаты выполненных запросов в буфере, она замедляет работу и ждет, пока клиент потребляет передаваемые выходные данные запроса перед продолжением. Это условие также может быть связано с сетью, недостаточно быстрым для передачи выходов из базы данных в клиент, который использует.

Это состояние выявляется только при обнаружении снижения производительности по сравнению с показателями рабочей нагрузки базы данных за последние семь дней. Эта проблема производительности будет обнаружена только в том случае, если снижение производительности статистически значимое по сравнению с предыдущими показателями производительности.

### <a name="troubleshooting"></a>Устранение неполадок

Этот выявляемый шаблон снижения производительности указывает условие на стороне клиента. Требуется устранить неполадки в работе приложения или сети на стороне клиента. Журнал диагностики содержит хэши запросов и наибольшие значения времени ожидания клиентом данных за последние два часа. Эти сведения можно использовать как основу при устранении неполадок.

Можно оптимизировать производительность приложения для использования таких запросов и рассмотреть возможные проблемы из-за задержки сети. Так как снижение производительности определяется на основании изменения базовых показателей производительности за последние семь дней, может потребоваться изучить изменения состояния приложения или сети, произошедшие за последнее время, которые могли привести к снижению производительности.

## <a name="pricing-tier-downgrade"></a>Переход на более низкую ценовую категорию

### <a name="what-is-happening"></a>Что происходит

Этот шаблон определения производительности указывает на то, что ценовая категория подписки базы данных была понижена. Из-за сокращения ресурсов (DTU) базы данных система обнаружила снижение текущей производительности базы данных по сравнению с базовыми показателями за последние семь дней.

Кроме того, может существовать условие, в котором ценовая категория подписки базы данных была более ранней, а затем обновлена до более высокого уровня в течение короткого периода времени. Обнаружение такого временного снижения производительности будет выведено в разделе сведений журнала диагностики в виде описания понижения и повышения ценовой категории.

### <a name="troubleshooting"></a>Устранение неполадок

Если вы сократили ценовую категорию и, следовательно, задействуете DTU и удовлетворена производительностью, вам ничего не нужно делать. Если вы сократили ценовую категорию и не удовлетворены производительностью базы данных, сократите рабочие нагрузки базы данных или рассмотрите возможность увеличения ценовой категории до более высокого уровня.

## <a name="recommended-troubleshooting-flow"></a>Рекомендуемая процедура устранения неполадок

 На блок-схеме показан рекомендуемый подход к устранению проблем с производительностью с помощью Intelligent Insights.

Функции Intelligent Insights доступны на портале Azure. Чтобы воспользоваться ими, следует перейти к SQL Azure Analytics. Попытайтесь найти входящее оповещение о производительности и выберите его. На странице "Обнаружения" выясните, что происходит. Изучите предоставленный анализ первопричин проблемы, текст запросов, тенденции длительности запросов и развитие инцидента. Попытайтесь устранить проблему с производительностью с помощью соответствующей рекомендации Intelligent Insights.

[![Схема устранения неполадок](./media/intelligent-insights-troubleshoot-performance/intelligent-insights-troubleshooting-flowchart.png)](https://github.com/Microsoft/sql-server-samples/blob/master/samples/features/intelligent-insight/Troubleshoot%20Azure%20SQL%20Database%20performance%20issues%20using%20Intelligent%20Insight.pdf)

> [!TIP]
> Выберите блок-схему, чтобы загрузить версию PDF.

Обычно Intelligent Insights требуется один час для выполнения анализа первопричин проблемы с производительностью. Если проблему не удается найти в Intelligent Insights, но это крайне важно для вас, используйте хранилище запросов, чтобы вручную определить первопричину проблемы производительности. (Как правило, эти проблемы менее одного часа назад.) Дополнительные сведения см. [в статье мониторинг производительности с помощью хранилища запросов](/sql/relational-databases/performance/monitoring-performance-by-using-the-query-store).

## <a name="next-steps"></a>Дальнейшие шаги

- Изучение [Intelligent Insights](intelligent-insights-overview.md) концепций.
- Используйте [Журнал диагностики производительности Intelligent Insights](intelligent-insights-use-diagnostics-log.md).
- Мониторинг с помощью [аналитика SQL Azure](../../azure-monitor/insights/azure-sql.md).
- Изучите [сбор и использование данных журнала из ресурсов Azure](../../azure-monitor/essentials/platform-logs-overview.md).