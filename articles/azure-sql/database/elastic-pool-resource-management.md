---
title: Управление ресурсами в сжатых эластичных пулах
description: Управление ресурсами вычислений в эластичных пулах базы данных SQL Azure с большим количеством баз данных.
services: sql-database
ms.service: sql-database
ms.subservice: elastic-pools
ms.custom: sqldbrb=1
ms.devlang: ''
ms.topic: conceptual
author: dimitri-furman
ms.author: dfurman
ms.reviewer: sstein
ms.date: 09/16/2020
ms.openlocfilehash: 40b6c5a86184860cf3e7a9840f980706485ae977
ms.sourcegitcommit: e559daa1f7115d703bfa1b87da1cf267bf6ae9e8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/17/2021
ms.locfileid: "100572230"
---
# <a name="resource-management-in-dense-elastic-pools"></a>Управление ресурсами в сжатых эластичных пулах
[!INCLUDE[appliesto-sqldb](../includes/appliesto-sqldb.md)]

[Эластичные пулы](./elastic-pool-overview.md) базы данных SQL Azure — это экономичное решение для управления множеством баз данных с различным использованием ресурсов. Все базы данных в эластичном пуле используют одни и те же ресурсы, такие как ЦП, память, рабочие потоки, дисковое пространство, tempdb. Исходя из предположения, что **только подмножество баз данных в пуле будет использовать вычислительные ресурсы в любой момент времени**. Это предположение позволяет использовать эластичные пулы в экономичном виде. Вместо того чтобы платить за все ресурсы, которые могут потребоваться для каждой отдельной базы данных, клиенты платят за намного меньший набор ресурсов, совместно используемых всеми базами данных в пуле.

## <a name="resource-governance"></a>Управление ресурсами

Для общего доступа к ресурсам требуется, чтобы система тщательно вывлияла на использование ресурсов, чтобы максимально интенсивно использовать бесшумный сосед, где база данных с большим потреблением ресурсов влияет на другие базы данных в том же пуле эластичных БД. В то же время система должна предоставить достаточно ресурсов для таких функций, как высокая доступность и аварийное восстановление (HADR), резервное копирование и восстановление, мониторинг, хранилище запросов, автоматическая настройка и т. д. для надежной работы.

База данных SQL Azure достигает этих целей с помощью нескольких механизмов управления ресурсами, включая [объекты заданий](/windows/win32/procthread/job-objects) Windows для управления ресурсами на уровне процесса, [файловый сервер Windows Диспетчер ресурсов (FSRM)](/windows-server/storage/fsrm/fsrm-overview) в управлении квотами на хранилище, а также модифицированную и расширенную версию SQL Server [Resource Governor](/sql/relational-databases/resource-governor/resource-governor) для реализации администрирования ресурсов в базе данных SQL.

Основная цель проектирования эластичных пулов — экономичная. По этой причине система намеренно позволяет клиентам создавать _сжатые_ пулы, то есть пулы с количеством баз данных, рекомендуемым или максимально допустимым, но с умеренным выделением ресурсов для вычислений. По той же причине система не резервирует все потенциально необходимые ресурсы для внутренних процессов, но позволяет совместно использовать ресурсы между внутренними процессами и пользовательскими рабочими нагрузками.

Такой подход позволяет клиентам использовать сжатые эластичные пулы для достижения достаточной производительности и существенного сокращения затрат. Однако, если Рабочая нагрузка для многих баз данных в плотном пуле достаточно интенсивна, состязание за ресурсы становится значительным. Состязание за ресурсы снижает производительность рабочей нагрузки пользователя и может негативно сказаться на внутренних процессах.

> [!IMPORTANT]
> В сжатых пулах с множеством активных баз данных может оказаться невозможным увеличить число баз данных в пуле вплоть до максимума, задокументированного для эластичных пулов [DTU](resource-limits-dtu-elastic-pools.md) и [Виртуальное ядро](resource-limits-vcore-elastic-pools.md) .
>
> Количество баз данных, которые могут быть помещены в сжатые пулы без возникновения проблем с состязанием за ресурсы и производительностью, зависит от количества параллельно активных баз данных и от потребления ресурсов пользовательскими рабочими нагрузками в каждой базе данных. Это число может меняться со временем по мере изменения пользовательских рабочих нагрузок.

Если состязание за ресурсы происходит в пуле с уплотнением, клиенты могут выбрать одно или несколько из следующих действий, чтобы устранить ее.

- Настройте рабочую нагрузку запроса, чтобы уменьшить потребление ресурсов или распределить потребление ресурсов между несколькими базами данных с течением времени.
- Сократите плотность пула, переместив некоторые базы данных в другой пул, или сделав их автономными базами данных.
- Увеличьте масштаб пула, чтобы получить дополнительные ресурсы.

Рекомендации по реализации последних двух действий см. в разделе рекомендации по [эксплуатации](#operational-recommendations) далее в этой статье. Уменьшение количества конфликтов ресурсов как пользовательских рабочих нагрузок, так и внутренних процессов и позволяет системе надежно поддерживать ожидаемый уровень обслуживания.

## <a name="monitoring-resource-consumption"></a>Мониторинг потребления ресурсов

Чтобы избежать снижения производительности из-за конфликта ресурсов, клиенты, использующие сжатые эластичные пулы, должны заранее отслеживать потребление ресурсов и предпринимать своевременные действия, если увеличение конфликтов ресурсов начинает влиять на рабочие нагрузки. Непрерывный мониторинг важен, так как использование ресурсов в пуле изменяется с течением времени из-за изменений рабочей нагрузки пользователя, изменений в томах и распределении данных, изменениях плотности пула и изменений в службе базы данных SQL Azure.

База данных SQL Azure предоставляет несколько метрик, относящихся к этому типу мониторинга. Превышение рекомендуемого среднего значения для каждой метрики означает состязание за ресурсы в пуле и должно быть адресовано с помощью одного из действий, упомянутых ранее.

|Имя метрики|Описание|Рекомендуемое среднее значение|
|----------|--------------------------------|------------|
|`avg_instance_cpu_percent`|Использование ЦП процессом SQL, связанным с пулом эластичных баз данных, измеряемым в базовой операционной системе. Доступно в представлении [sys.dm_db_resource_stats](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-resource-stats-azure-sql-database) в каждой базе данных и в представлении [sys.elastic_pool_resource_stats](/sql/relational-databases/system-catalog-views/sys-elastic-pool-resource-stats-azure-sql-database) в `master` базе данных. Эта метрика также создается для Azure Monitor, где [она называется](../../azure-monitor/essentials/metrics-supported.md#microsoftsqlserverselasticpools) `sqlserver_process_core_percent` , и ее можно просмотреть в портал Azure. Это значение одинаково для каждой базы данных в том же пуле эластичных БД.|Ниже 70%. Возможные кратковременные пики до 90% могут быть приемлемыми.|
|`max_worker_percent`|Использование [рабочего потока]( https://docs.microsoft.com/sql/relational-databases/thread-and-task-architecture-guide) . Предоставляется для каждой базы данных в пуле, а также для самого пула. Существуют разные ограничения на количество рабочих потоков на уровне базы данных и на уровне пула, поэтому рекомендуется отслеживать эту метрику на обоих уровнях. Доступно в представлении [sys.dm_db_resource_stats](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-resource-stats-azure-sql-database) в каждой базе данных и в представлении [sys.elastic_pool_resource_stats](/sql/relational-databases/system-catalog-views/sys-elastic-pool-resource-stats-azure-sql-database) в `master` базе данных. Эта метрика также создается для Azure Monitor, где [она называется](../../azure-monitor/essentials/metrics-supported.md#microsoftsqlserverselasticpools) `workers_percent` , и ее можно просмотреть в портал Azure.|Ниже 80%. Пики до 100% приведут к сбоям при попытке подключения и выполнению запросов.|
|`avg_data_io_percent`|Использование операций ввода-вывода для чтения и записи физических операций ввода-вывода. Предоставляется для каждой базы данных в пуле, а также для самого пула. Существуют различные ограничения на количество операций ввода-вывода на уровне базы данных и на уровне пула, поэтому рекомендуется отслеживать эту метрику на обоих уровнях. Доступно в представлении [sys.dm_db_resource_stats](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-resource-stats-azure-sql-database) в каждой базе данных и в представлении [sys.elastic_pool_resource_stats](/sql/relational-databases/system-catalog-views/sys-elastic-pool-resource-stats-azure-sql-database) в `master` базе данных. Эта метрика также создается для Azure Monitor, где [она называется](../../azure-monitor/essentials/metrics-supported.md#microsoftsqlserverselasticpools) `physical_data_read_percent` , и ее можно просмотреть в портал Azure.|Ниже 80%. Возможные кратковременные пики до 100% могут быть приемлемыми.|
|`avg_log_write_percent`|Использование пропускной способности для операций ввода-вывода при записи в журнал транзакций. Предоставляется для каждой базы данных в пуле, а также для самого пула. Существуют разные ограничения на пропускную способность журнала на уровне базы данных и на уровне пула, поэтому рекомендуется наблюдать за этой метрикой на обоих уровнях. Доступно в представлении [sys.dm_db_resource_stats](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-resource-stats-azure-sql-database) в каждой базе данных и в представлении [sys.elastic_pool_resource_stats](/sql/relational-databases/system-catalog-views/sys-elastic-pool-resource-stats-azure-sql-database) в `master` базе данных. Эта метрика также создается для Azure Monitor, где [она называется](../../azure-monitor/essentials/metrics-supported.md#microsoftsqlserverselasticpools) `log_write_percent` , и ее можно просмотреть в портал Azure. Если эта метрика близка к 100%, все изменения базы данных (инструкции INSERT, UPDATE, DELETE, MERGE, SELECT... В, BULK INSERT и т. д.) будет выполняться медленнее.|Ниже 90%. Возможные кратковременные пики до 100% могут быть приемлемыми.|
|`oom_per_second`|Частота ошибок нехватки памяти в эластичном пуле, которая является индикатором нехватки памяти. Доступно в представлении [sys.dm_resource_governor_resource_pools_history_ex](/sql/relational-databases/system-dynamic-management-views/sys-dm-resource-governor-resource-pools-history-ex-azure-sql-database) . См. [примеры](#examples) запроса для вычисления этой метрики.|0|
|`avg_storage_percent`|Общий объем хранилища, используемый данными во всех базах данных в эластичном пуле. Не включает пустое пространство в файлах базы данных. Доступно в представлении [sys.elastic_pool_resource_stats](/sql/relational-databases/system-catalog-views/sys-elastic-pool-resource-stats-azure-sql-database) в `master` базе данных. Эта метрика также создается для Azure Monitor, где [она называется](../../azure-monitor/essentials/metrics-supported.md#microsoftsqlserverselasticpools) `storage_percent` , и ее можно просмотреть в портал Azure.|Ниже 80%. Может подходить к 100% для пулов без роста объема данных.|
|`avg_allocated_storage_percent`|Общий объем хранилища, используемый файлами базы данных в хранилище во всех базах данных в эластичном пуле. Включает в себя пустое пространство в файлах базы данных. Доступно в представлении [sys.elastic_pool_resource_stats](/sql/relational-databases/system-catalog-views/sys-elastic-pool-resource-stats-azure-sql-database) в `master` базе данных. Эта метрика также создается для Azure Monitor, где [она называется](../../azure-monitor/essentials/metrics-supported.md#microsoftsqlserverselasticpools) `allocated_data_storage_percent` , и ее можно просмотреть в портал Azure.|Ниже 90%. Может подходить к 100% для пулов без роста объема данных.|
|`tempdb_log_used_percent`|Использование пространства журнала транзакций в `tempdb` базе данных. Несмотря на то, что временные объекты, созданные в одной базе данных, не видны в других базах данных одного пула эластичных БД, `tempdb` это общий ресурс для всех баз данных в одном пуле. Длительная или потерянная транзакция `tempdb` , запущенная из одной базы данных в пуле, может использовать большую часть журнала транзакций и вызывать сбои для запросов в других базах данных в том же пуле. Является производным от представлений [sys.dm_db_log_space_usage](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-log-space-usage-transact-sql) и [sys.database_files](/sql/relational-databases/system-catalog-views/sys-database-files-transact-sql) . Эта метрика также создается для Azure Monitor и может быть просмотрена в портал Azure. См. [примеры](#examples) для примера запроса, который возвращает текущее значение этой метрики.|Ниже 50%. Возможные пиковые пики до 80% приемлемы.|
|||

Помимо этих метрик, база данных SQL Azure предоставляет представление, которое возвращает фактические ограничения управления ресурсами, а также дополнительные представления, которые возвращают статистику использования ресурсов на уровне пула ресурсов и на уровне группы рабочей нагрузки.

|Имя представления|Описание|  
|-----------------|--------------------------------|  
|[sys.dm_user_db_resource_governance](/sql/relational-databases/system-dynamic-management-views/sys-dm-user-db-resource-governor-azure-sql-database)|Возвращает фактические параметры конфигурации и емкости, используемые механизмами управления ресурсами в текущей базе данных или эластичном пуле.|
|[sys.dm_resource_governor_resource_pools](/sql/relational-databases/system-dynamic-management-views/sys-dm-resource-governor-resource-pools-transact-sql)|Возвращает сведения о текущем состоянии пула ресурсов, текущую конфигурацию пулов ресурсов и статистику пула ресурсов.|
|[sys.dm_resource_governor_workload_groups](/sql/relational-databases/system-dynamic-management-views/sys-dm-resource-governor-workload-groups-transact-sql)|Возвращает статистику общей группы рабочей нагрузки и текущую конфигурацию группы рабочей нагрузки. Это представление можно объединить с sys.dm_resource_governor_resource_pools в `pool_id` столбце, чтобы получить сведения о пуле ресурсов.|
|[sys.dm_resource_governor_resource_pools_history_ex](/sql/relational-databases/system-dynamic-management-views/sys-dm-resource-governor-resource-pools-history-ex-azure-sql-database)|Возвращает статистику использования пула ресурсов за последние 32 минут. Каждая строка представляет собой 20-секундный интервал. `delta_`Столбцы возвращают изменения в каждой статистике в течение интервала.|
|[sys.dm_resource_governor_workload_groups_history_ex](/sql/relational-databases/system-dynamic-management-views/sys-dm-resource-governor-workload-groups-history-ex-azure-sql-database)|Возвращает статистику использования группы рабочей нагрузки за последние 32 минут. Каждая строка представляет собой 20-секундный интервал. `delta_`Столбцы возвращают изменения в каждой статистике в течение интервала.|
|||

Эти представления можно использовать для отслеживания использования ресурсов и устранения конфликтов ресурсов практически в реальном времени. Рабочая нагрузка пользователя на первичную и доступную для чтения вторичные реплики, включая геореплики, классифицируется в `SloSharedPool1` пул ресурсов и `UserPrimaryGroup.DBId[N]` группу рабочей нагрузки, где `N` означает значение идентификатора базы данных.

Помимо отслеживания текущего использования ресурсов, клиенты, использующие сжатые пулы, могут сохранять данные об использовании ресурсов в отдельном хранилище данных. Эти данные можно использовать в прогнозном анализе для упреждающего управления использованием ресурсов на основе исторических и сезонных тенденций.

## <a name="operational-recommendations"></a>Рекомендации по эксплуатации

**Оставьте достаточный запас ресурсов**. Если происходит состязание за ресурсы и снижение производительности, устранение рисков может привести к перемещению некоторых баз данных из задействованного эластичного пула или масштабированию пула, как отмечалось ранее. Однако для выполнения этих действий требуются дополнительные ресурсы вычислений. В частности, для пулов уровня "Премиум" и "критически важный для бизнеса" для этих действий требуется передать все данные для перемещаемых баз данных или для всех баз данных в пуле эластичных БД при масштабировании пула. Перенос данных — это длительная работа и ресурсоемкие операции. Если пул уже находится в условиях высокой интенсивности ресурсов, то сама операция по устранению рисков будет снижать производительность еще больше. В экстремальных случаях может быть невозможно решить состязание за ресурсы с помощью перемещения базы данных или увеличения масштаба пула, так как необходимые ресурсы недоступны. В этом случае единственным решением может быть временное сокращение рабочей нагрузки запросов в задействованном эластичном пуле.

Клиенты, использующие сжатые пулы, должны тщательно отслеживать тенденции использования ресурсов, как описано выше, и предпринимать меры по устранению рисков, когда метрики остаются в рекомендуемых диапазонах и все еще достаточно ресурсов в пуле эластичных БД.

Использование ресурсов зависит от нескольких факторов, которые меняются со временем для каждой базы данных и каждого пула эластичных БД. Достижение оптимального соотношения цены и производительности в сжатых пулах требует непрерывного мониторинга и повторного распределения, то есть перемещение баз данных из большего числа используемых пулов в менее загруженные пулы и создание новых пулов по мере необходимости для повышения рабочей нагрузки.

**Не переносите «горячие» базы данных**. Если состязание за ресурсы на уровне пула в основном вызвано небольшим количеством высокопроизводительных баз данных, может возникнуть желание переместить эти базы данных в менее загруженный пул или сделать их автономными базами данных. Однако это не рекомендуется делать, когда база данных остается высокой степенью использования, так как операция перемещения будет дополнительно снижать производительность, как для перемещаемой базы данных, так и для всего пула. Вместо этого дождитесь завершения высокой загрузки или переместите менее используемые базы данных, чтобы снизить нагрузку на ресурсы на уровне пула. Но перемещение баз данных с очень низким уровнем использования не предоставляет никаких преимуществ в этом случае, так как оно не позволяет существенно сократить использование ресурсов на уровне пула.

**Создание новых баз данных в "карантинном" пуле**. В сценариях, где часто создаются новые базы данных, например приложения, использующие модель "клиент-база данных", существует риск того, что новая база данных, помещенная в существующий пул эластичных БД, неожиданно будет потреблять значительные ресурсы и повлияет на другие базы данных и внутренние процессы в пуле. Чтобы устранить этот риск, создайте отдельный "карантин" пул с достаточным выделением ресурсов. Используйте этот пул для новых баз данных с неизвестными шаблонами потребления ресурсов. После того, как база данных неизменности в этом пуле для бизнес-цикла, например недели или месяца, и его потребление ресурсов будет известно, его можно переместить в пул с достаточной емкостью, чтобы удовлетворить это дополнительное использование ресурсов.

**Отслеживайте используемые и выделенные пространства**. Если выделенное пространство пула (общий размер всех файлов базы данных в хранилище для всех баз данных в пуле) достигает максимального размера пула, могут возникать ошибки нехватки места. Если объем выделяемой памяти высок и для него достигнут максимальный размер пула, возможны следующие варианты устранения рисков.
- Переместите несколько баз данных из пула, чтобы уменьшить общее выделенное пространство
- [Сжатие](file-space-manage.md) файлов базы данных для сокращения пустого выделенного пространства в файлах
- Увеличьте масштаб пула до цели обслуживания с большим максимальным размером пула.

Если объем используемого пула (общий размер данных во всех базах данных в пуле, не включая пустое пространство в файлах) высок и находится в курсе, чтобы достичь максимального размера пула, возможны следующие варианты устранения рисков.
- Переместите несколько баз данных из пула, чтобы сократить общее используемое пространство.
- Перемещение (архивация) данных за пределы базы данных или удаление данных, которые больше не нужны
- Реализация [сжатия данных](/sql/relational-databases/data-compression/data-compression)
- Увеличьте масштаб пула до цели обслуживания с большим максимальным размером пула.

**Избегайте чрезмерно плотных серверов**. База данных SQL Azure [поддерживает](./resource-limits-logical-server.md) до 5000 баз данных на один сервер. Клиенты, использующие эластичные пулы с тысячами баз данных, могут рассмотреть возможность размещения нескольких эластичных пулов на одном сервере с общим количеством баз данных вплоть до поддерживаемого ограничения. Однако серверы с множеством тысяч баз данных создают рабочие проблемы. Операции, для которых требуется перечисление всех баз данных на сервере, например просмотр баз данных на портале, будут выполняться медленнее. Операционные ошибки, такие как неправильное изменение имен входа на уровне сервера или правил брандмауэра, повлияют на большее количество баз данных. Случайное удаление сервера потребует помощи от служба поддержки Майкрософт восстановления баз данных на удаленном сервере и вызовет длительный сбой для всех затронутых баз данных.

Рекомендуется ограничить количество баз данных на каждый сервер меньшим, чем максимальное поддерживаемое. Во многих случаях оптимальным является использование до 1000-2000 баз данных на сервер. Чтобы снизить вероятность случайного удаления сервера, рекомендуется поместить [блокировку удаления](../../azure-resource-manager/management/lock-resources.md) на сервер или в группу ресурсов.

В прошлом некоторые сценарии, включающие перемещение баз данных в, из пулов эластичных БД на одном сервере, выполнялись быстрее, чем при перемещении баз данных между серверами. В настоящее время все перемещения базы данных выполняются на одинаковой скорости независимо от исходного и целевого сервера.

## <a name="examples"></a>Примеры

### <a name="monitoring-memory-utilization"></a>Мониторинг использования памяти

Этот запрос вычисляет `oom_per_second` метрику для каждого пула ресурсов за последние 32 минут. Этот запрос может быть выполнен в любой базе данных в эластичном пуле.

```sql
SELECT pool_id,
       name AS resource_pool_name,
       IIF(name LIKE 'SloSharedPool%' OR name LIKE 'UserPool%', 'user', 'system') AS resource_pool_type,
       SUM(CAST(delta_out_of_memory_count AS decimal))/(SUM(duration_ms)/1000.) AS oom_per_second
FROM sys.dm_resource_governor_resource_pools_history_ex
GROUP BY pool_id, name
ORDER BY pool_id;
```

### <a name="monitoring-tempdb-log-space-utilization"></a>Мониторинг `tempdb` использования пространства журнала

Этот запрос возвращает текущее значение `tempdb_log_used_percent` метрики, показывающее относительное использование `tempdb` журнала транзакций относительно максимально допустимого размера. Этот запрос может быть выполнен в любой базе данных в эластичном пуле.

```sql
SELECT (lsu.used_log_space_in_bytes / df.log_max_size_bytes) * 100 AS tempdb_log_space_used_percent
FROM tempdb.sys.dm_db_log_space_usage AS lsu
CROSS JOIN (
           SELECT SUM(CAST(max_size AS bigint)) * 8 * 1024. AS log_max_size_bytes
           FROM tempdb.sys.database_files
           WHERE type_desc = N'LOG'
           ) AS df
;
```

## <a name="next-steps"></a>Дальнейшие шаги

- Общие сведения о эластичных пулах см. [в разделе эластичные пулы помогают управлять и масштабировать несколько баз данных в базе данных SQL Azure](./elastic-pool-overview.md).
- Сведения о настройке рабочих нагрузок запросов для уменьшения использования ресурсов см. в разделе [мониторинг и настройка]( https://docs.microsoft.com/azure/sql-database/sql-database-monitoring-tuning-index), [мониторинг и настройка производительности](./monitor-tune-overview.md).