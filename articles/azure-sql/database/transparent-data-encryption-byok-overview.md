---
title: Прозрачное шифрование данных, управляемое клиентом (TDE)
description: Поддержка создание собственных ключей (BYOK) для прозрачное шифрование данных (TDE) с Azure Key Vault для базы данных SQL и Azure синапсе Analytics. Обзор TDE с поддержкой BYOK, преимущества, принцип работы, замечания и рекомендации.
titleSuffix: Azure SQL Database & SQL Managed Instance & Azure Synapse Analytics
services: sql-database
ms.service: sql-db-mi
ms.subservice: security
ms.custom: seo-lt-2019, azure-synapse
ms.devlang: ''
ms.topic: conceptual
author: jaszymas
ms.author: jaszymas
ms.reviewer: vanto
ms.date: 02/01/2021
ms.openlocfilehash: 74c0dbaaa511e2fd2f20a3c245a561a177dd2b9a
ms.sourcegitcommit: 8c8c71a38b6ab2e8622698d4df60cb8a77aa9685
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/01/2021
ms.locfileid: "99223446"
---
# <a name="azure-sql-transparent-data-encryption-with-customer-managed-key"></a>Прозрачное шифрование данных Azure SQL с ключом, управляемым клиентом
[!INCLUDE[appliesto-sqldb-sqlmi-asa](../includes/appliesto-sqldb-sqlmi-asa.md)]

Прозрачное шифрование данных Azure SQL [(TDE)](/sql/relational-databases/security/encryption/transparent-data-encryption) с ключом, управляемым клиентом, позволяет использовать создание собственных ключей (BYOK) для защиты данных в неактивных и позволяет организациям реализовать разделение обязанностей в управлении ключами и данными. При использовании прозрачного шифрования данных, управляемого клиентом, клиент несет ответственность за управление жизненным циклом ключа (создание ключа, передачу, вращение, удаление), разрешения на использование ключа и аудит операций с ключами.

В этом сценарии ключ, используемый для шифрования ключа шифрования базы данных (DEK), который называется предохранителем TDE, представляет собой управляемый клиентом асимметричный ключ, хранящийся в принадлежащем заказчике и управляемом клиентом [Azure Key Vault (AKV)](../../key-vault/general/secure-your-key-vault.md), облачной системе управления внешними ключами. Key Vault является высокодоступным и масштабируемым надежным хранилищем для криптографических ключей RSA (при необходимости поддерживается стандартом FIPS 140-2, проверенным аппаратными модулями безопасности (HSM)). Он не разрешает прямой доступ к сохраненному ключу, но предоставляет службы шифрования и расшифровки с помощью ключа для полномочных сущностей. Ключ может создаваться хранилищем ключей, импортировано или [перенесено в хранилище ключей из локального устройства HSM](../../key-vault/keys/hsm-protected-keys.md).

Для базы данных SQL Azure и Azure синапсе Analytics средство защиты TDE устанавливается на уровне сервера и наследуется всеми зашифрованными базами данных, связанными с этим сервером. Для Управляемый экземпляр Azure SQL средство защиты TDE устанавливается на уровне экземпляра и наследуется всеми зашифрованными базами данных на этом экземпляре. Термин *сервер* относится к серверу в базе данных SQL и Azure синапсе, а также к управляемому экземпляру SQL управляемый экземпляр в рамках этого документа, если не указано иное.

> [!IMPORTANT]
> При использовании управляемых службой TDE, которые хотели бы начать использовать управляемую клиентом TDE, данные остаются зашифрованными во время переключения, а просто и без повторного шифрования файлов базы данных. Переключение с управляемого службой ключа на ключ, управляемый клиентом, требует только повторного шифрования DEK, что является быстрой и оперативной операцией.

> [!NOTE]
> <a id="doubleencryption"></a> Чтобы предоставить клиентам Azure SQL два уровня шифрования неактивных данных, необходимо развернуть шифрование инфраструктуры (с использованием алгоритма шифрования AES-256) с управляемыми ключами платформы. Это обеспечивает дополнительный уровень шифрования при хранении, а также TDE с управляемыми клиентом ключами, которые уже доступны. Для базы данных SQL Azure и Управляемый экземпляр все базы данных, включая базу данных master и другие системные базы данных, будут зашифрованы при включении шифрования инфраструктуры. В настоящее время клиенты должны запрашивать доступ к этой возможности. Если вы заинтересованы в этой возможности, обратитесь к AzureSQLDoubleEncryptionAtRest@service.microsoft.com .

## <a name="benefits-of-the-customer-managed-tde"></a>Преимущества управляемых клиентом TDE

Управляемый клиентом TDE предоставляет клиенту следующие преимущества.

- Полный и детализированный контроль над использованием и управлением предохранителем TDE;

- Прозрачность использования предохранителя TDE;

- Возможность реализовать разделение обязанностей в управлении ключами и данными в Организации;

- Администратор Key Vault может отозвать разрешения на доступ к ключам, чтобы сделать зашифрованную базу данных недоступной.

- Централизованное управление ключами в AKV;

- Более высокий уровень доверия от конечных пользователей, так как AKV спроектирован таким образом, что корпорация Майкрософт не может просматривать и извлекать ключи шифрования.

## <a name="how-customer-managed-tde-works"></a>Как работает управляемый клиентом TDE

![Настройка и работа управляемого клиентом TDE](./media/transparent-data-encryption-byok-overview/customer-managed-tde-with-roles.PNG)

Чтобы сервер мог использовать средство защиты TDE, хранящееся в AKV для шифрования DEK, администратору хранилища ключей необходимо предоставить следующие права доступа к серверу с помощью уникального удостоверения Azure Active Directory (Azure AD):

- **Get** — для получения общедоступной части и свойств ключа в Key Vault

- **wrapKey** — для обеспечения возможности защиты (шифрования) DEK

- **unwrapKey** — чтобы иметь возможность снять защиту (расшифровка) DEK

Администратор хранилища ключей также может [включить ведение журнала событий аудита хранилища ключей](../../azure-monitor/insights/key-vault-insights-overview.md), чтобы их можно было проследить позднее.

Если сервер настроен для использования предохранителя TDE из AKV, сервер отправляет DEK из каждой базы данных с поддержкой TDE в хранилище ключей для шифрования. Хранилище ключей возвращает зашифрованный DEK, который затем хранится в пользовательской базе данных.

При необходимости сервер отправляет защищенные DEK в хранилище ключей для расшифровки.

Аудиторы могут использовать Azure Monitor для просмотра журналов AuditEvent хранилища ключей, если ведение журнала включено.

[!INCLUDE [sql-database-akv-permission-delay](../includes/sql-database-akv-permission-delay.md)]

## <a name="requirements-for-configuring-customer-managed-tde"></a>Требования для настройки управляемого клиентом TDE

### <a name="requirements-for-configuring-akv"></a>Требования для настройки AKV

- Хранилище ключей и база данных SQL или управляемый экземпляр должны принадлежать к одному и тому же клиенту Azure Active Directory. Взаимодействия ключа хранилища для нескольких клиентов и сервера не поддерживаются. Чтобы переместить ресурсы позже, необходимо будет перенастроить TDE с AKV. Дополнительные сведения о [перемещении ресурсов](../../azure-resource-manager/management/move-resource-group-and-subscription.md).

- Функция [обратимого удаления](../../key-vault/general/soft-delete-overview.md) должна быть включена в хранилище ключей для защиты от случайного удаления ключа (или хранилища ключей) с потерей данных. Обратимо удаленные ресурсы хранятся в течение 90 дней, если только они не будут восстановлены или очищены клиентом. С действиями *Восстановить* и *Удалить* связаны отдельные разрешения в политике доступа хранилища ключей. Функция обратимого удаления отключена по умолчанию и может быть включена с помощью [PowerShell](../../key-vault/general/key-vault-recovery.md?tabs=azure-powershell) или [интерфейса командной строки](../../key-vault/general/key-vault-recovery.md?tabs=azure-cli). Его нельзя включить с помощью портал Azure.  

- Предоставьте серверу или управляемому экземпляру доступ к хранилищу ключей (Get, wrapKey, unwrapKey), используя удостоверение Azure Active Directory. При использовании портал Azure удостоверение Azure AD автоматически создается. При использовании PowerShell или интерфейса командной строки удостоверение Azure AD должно быть создано явным образом, и его выполнение должно быть проверено. Подробные пошаговые инструкции по использованию PowerShell см. в статьях [Настройка TDE с помощью BYOK](transparent-data-encryption-byok-configure.md) и [Настройка TDE с BYOK for SQL управляемый экземпляр](../managed-instance/scripts/transparent-data-encryption-byok-powershell.md) .

- При использовании брандмауэра с AKV необходимо включить параметр *разрешить доверенным службам Майкрософт обходить брандмауэр*.

### <a name="requirements-for-configuring-tde-protector"></a>Требования для настройки средства защиты TDE

- Средство защиты TDE может быть только асимметричным ключом HSM или RSA. Поддерживаемая длина ключа — 2048 и 3072 байт.

- Дата активации ключа (если задана) должна быть датой и временем в прошлом. Дата истечения срока действия (если она задана) должна быть будущей датой и временем.

- Ключ должен находиться в состоянии *Включено*.

- При импорте существующего ключа в хранилище ключей обязательно укажите его в поддерживаемых форматах файлов (. pfx,. byok или. Backup).

> [!NOTE]
> Теперь SQL Azure поддерживает использование ключа RSA, хранящегося в управляемом HSM, как средство защиты TDE. Эта функция доступна в **общедоступной предварительной версии**. Azure Key Vault управляемым HSM — это полностью управляемая высокодоступная облачная служба с одним клиентом, которая позволяет защищать криптографические ключи для облачных приложений, используя проверенный HSM уровня 2 FIPS 140-2. Дополнительные сведения об [управляемых HSM](../../key-vault/managed-hsm/index.yml).


## <a name="recommendations-when-configuring-customer-managed-tde"></a>Рекомендации по настройке TDE, управляемой клиентом

### <a name="recommendations-when-configuring-akv"></a>Рекомендации по настройке AKV

- Подключайте более 500 общего назначения или 200 критически важный для бизнеса баз данных в целом с помощью хранилища ключей в одной подписке, чтобы обеспечить высокий уровень доступности при доступе сервера к предохранителю TDE в хранилище ключей. Эти цифры основаны на опыте и описаны в [разделе Ограничения службы хранилища ключей](../../key-vault/general/service-limits.md). Цель здесь — избежать проблем после отработки отказа сервера, так как он будет активировать столько ключевых операций с хранилищем, сколько есть баз данных на этом сервере.

- Установите блокировку ресурсов в хранилище ключей, чтобы контролировать, кто может удалять этот критический ресурс и предотвращать случайное или несанкционированное удаление. Дополнительные сведения о [блокировках ресурсов](../../azure-resource-manager/management/lock-resources.md).

- Включите аудит и создание отчетов по всем ключам шифрования. хранилище ключей содержит журналы, которые можно легко внедрить в другие сведения о безопасности и средства управления событиями. Operations Management Suite [log Analytics](../../azure-monitor/insights/key-vault-insights-overview.md) — это один из примеров службы, которая уже интегрирована.

- Чтобы обеспечить высокий уровень доступности зашифрованных баз данных, свяжите каждый сервер с двумя хранилищами ключей, которые находятся в разных регионах, и содержали один и тот же материал ключа. Пометьте только ключ из хранилища ключей в том же регионе, что и предохранитель TDE. Система автоматически переключается на хранилище ключей в удаленном регионе, если происходит сбой, влияющий на хранилище ключей в том же регионе.

### <a name="recommendations-when-configuring-tde-protector"></a>Рекомендации по настройке предохранителя TDE

- Обеспечьте копию предохранителя TDE в безопасном месте или передайте ее в депонированную службу.

- Если ключ создается в хранилище ключей, создайте резервную копию ключа, прежде чем использовать ключ в AKV в первый раз. Резервное копирование можно восстановить только в Azure Key Vault. Дополнительные сведения о команде [BACKUP-азкэйваулткэй](/powershell/module/az.keyvault/backup-azkeyvaultkey) .

- Создайте новую резервную копию каждый раз при внесении изменений в ключ (например, ключевые атрибуты, теги, списки ACL).

- **Сохраняйте предыдущие версии** ключа в хранилище ключей при смене ключа, чтобы сохранить возможность восстановления из старых резервных копий базы данных. При изменении предохранителя TDE для базы данных старые резервные копии базы данных **не обновляются** для использования последнего предохранителя TDE. Во время восстановления каждой резервной копии требуется средство защиты TDE, которое было зашифровано во время создания. Чтобы правильно сменить ключ, используйте инструкции из [этой статьи](transparent-data-encryption-byok-key-rotation.md).

- Используйте все ранее использовавшиеся ключи в AKV даже после переключения на ключи, управляемые службой. Это гарантирует, что резервное копирование базы данных можно восстановить с помощью средств защиты TDE, хранящихся в AKV.  Защита TDE, созданная с помощью Azure Key Vault, должна поддерживаться до тех пор, пока все оставшиеся сохраненные резервные копии не будут созданы с помощью ключей, управляемых службой. Сделайте восстанавливаемые резервные копии этих ключей с помощью [BACKUP-азкэйваулткэй](/powershell/module/az.keyvault/backup-azkeyvaultkey).

- Чтобы удалить потенциально скомпрометированный ключ во время инцидента безопасности без риска потери данных, выполните действия из [раздела Удаление потенциально скомпрометированного ключа](transparent-data-encryption-byok-remove-tde-protector.md).

## <a name="inaccessible-tde-protector"></a>Недоступный предохранитель TDE

Если прозрачное шифрование данных настроено для использования управляемого клиентом ключа, то для поддержания базы данных в режиме «в сети» требуется постоянный доступ к компоненту защиты TDE. Если сервер теряет доступ к управляемому пользователем предохранителю TDE в AKV, то в течение 10 минут база данных начинает отклонять все подключения с соответствующим сообщением об ошибке и изменяет его состояние на *недоступное*. Единственным действием, разрешенным в базе данных в недоступном состоянии, является ее удаление.

> [!NOTE]
> Если база данных недоступна из-за периодического сбоя сети, никаких действий не требуется, и базы данных будут автоматически возвращаться в оперативный режим.

После восстановления доступа к ключу перевод базы данных в оперативный режим требует дополнительного времени и действий, которые могут меняться в зависимости от времени, прошедшего без доступа к ключу и размера данных в базе данных:

- Если доступ к ключам восстанавливается в течение 8 часов, база данных будет автовосстановление в течение следующего часа.

- Если до восстановления доступа к ключам прошло более 8 часов, автоматическое восстановление невозможно, и возврат базы данных требует дополнительных действий на портале и может занять значительное время в зависимости от размера базы данных. После возвращения базы данных в режим «в сети» ранее настроенные параметры уровня сервера, такие как конфигурация [группы отработки отказа](auto-failover-group-overview.md) , журнал восстановления на момент времени и теги, **будут потеряны**. Поэтому рекомендуется реализовать систему уведомлений, которая позволяет выявление и устранение проблем доступа к базовому ключу в течение 8 часов.

Ниже приведено описание дополнительных действий, которые необходимо выполнить на портале, чтобы перевести недоступную базу данных обратно в режим «в сети».

![Недоступная база данных TDE BYOK](./media/transparent-data-encryption-byok-overview/customer-managed-tde-inaccessible-database.jpg)


### <a name="accidental-tde-protector-access-revocation"></a>Отзыв о случайном доступе предохранителя TDE

Возможно, кто-то, имеющий достаточные права доступа к хранилищу ключей, случайно отключил доступ к этому разделу на сервере:

- Отмена разрешений *Get*, *wrapKey*, *unwrapKey* хранилища ключей с сервера

- Удаление ключа

- идет Удаление хранилища ключей

- изменение правил брандмауэра для хранилища ключей

- Удаление управляемого удостоверения сервера в Azure Active Directory

Дополнительные сведения об [основных причинах, по которым база данных становится недоступной](/sql/relational-databases/security/encryption/troubleshoot-tde?view=azuresqldb-current&preserve-view=true#common-errors-causing-databases-to-become-inaccessible).

## <a name="monitoring-of-the-customer-managed-tde"></a>Мониторинг управляемого клиентом TDE

Чтобы отслеживать состояние базы данных и включать предупреждения для потери доступа к TDE предохранителю, настройте следующие функции Azure:

- [Работоспособность ресурсов Azure](../../service-health/resource-health-overview.md). Недоступная база данных, которая потеряла доступ к предохранителю TDE, будет отображаться как "недоступно" после того, как было отказано в первом подключении к базе данных.
- [Журнал действий](../../service-health/alerts-activity-log-service-notifications-portal.md) при сбое доступа к предохранителю TDE в хранилище ключей, управляемом клиентом, записи добавляются в журнал действий.  Создание оповещений для этих событий позволит возобновить доступ как можно скорее.
- [Группы действий](../../azure-monitor/platform/action-groups.md) можно определить для отправки уведомлений и оповещений в зависимости от ваших предпочтений, например электронной почты, SMS, Push/Voice, приложения логики, веб-перехватчика, ITSM или Runbook службы автоматизации.

## <a name="database-backup-and-restore-with-customer-managed-tde"></a>Резервное копирование и восстановление базы данных с помощью управляемого клиентом TDE

После того как база данных будет зашифрована с помощью TDE, используя ключ из Key Vault, все созданные резервные копии также шифруются с тем же предохранителем TDE. При изменении предохранителя TDE старые резервные копии базы данных **не обновляются** для использования последнего предохранителя TDE.

Чтобы восстановить резервную копию, зашифрованную с помощью средства защиты TDE, из Key Vault, убедитесь, что материал ключа доступен для целевого сервера. Поэтому рекомендуется сохранить все старые версии предохранителя TDE в хранилище ключей, чтобы можно было восстановить резервные копии баз данных.

> [!IMPORTANT]
> В любой момент времени для сервера может быть задано не более одного набора предохранителей TDE. Это ключ, помеченный как "сделать ключ TDE предохранителем по умолчанию" в колонке портал Azure. Однако несколько дополнительных ключей можно связать с сервером, не помечая их как средство защиты TDE. Эти ключи не используются для защиты DEK, но могут использоваться во время восстановления из резервной копии, если файл резервной копии зашифрован с помощью ключа с соответствующим отпечатком.

Если ключ, необходимый для восстановления резервной копии, больше не доступен для целевого сервера, то при восстановлении будет возвращено следующее сообщение об ошибке: "целевой сервер `<Servername>` не имеет доступа ко всем URI AKV, созданным между \<Timestamp #1> и \<Timestamp #2> . Повторите операцию после восстановления всех URI AKV. "

Чтобы устранить эту проблемы, выполните командлет [Get-азсклсерверкэйваулткэй](/powershell/module/az.sql/get-azsqlserverkeyvaultkey) для целевого сервера или [Get-азсклинстанцекэйваулткэй](/powershell/module/az.sql/get-azsqlinstancekeyvaultkey) для целевого управляемого экземпляра, чтобы получить список доступных ключей и найти недостающие. Чтобы обеспечить возможность восстановления всех резервных копий, убедитесь, что целевой сервер для восстановления имеет доступ ко всем необходимым ключам. Эти ключи не обязательно должны быть помечены как предохранитель TDE.

Дополнительные сведения о восстановлении резервной копии базы данных SQL см. в статье [Восстановление](recovery-using-backups.md)базы данных SQL. Дополнительные сведения о восстановлении резервной копии для выделенного пула SQL в Azure синапсе Analytics см. в статье [Восстановление выделенного пула SQL](../../synapse-analytics/sql-data-warehouse/backup-and-restore.md). Инструкции для собственного резервного копирования и восстановления SQL Server с помощью SQL Управляемый экземпляр см. в разделе [Краткое руководство. Восстановление базы данных в sql управляемый экземпляр](../managed-instance/restore-sample-database-quickstart.md)

Дополнительные сведения о файлах журналов. резервные копии файлов журналов остаются зашифрованными с помощью исходного предохранителя TDE, даже если они были повернуты, а база данных теперь использует новый предохранитель TDE.  Для восстановления базы данных потребуется оба ключа.  Если файл журнала использует средство защиты TDE, хранящееся в Azure Key Vault, этот ключ потребуется во время восстановления, даже если база данных была изменена для использования управляемых службой TDE.

## <a name="high-availability-with-customer-managed-tde"></a>Высокий уровень доступности с управляемыми клиентом TDE

Даже если для сервера нет настроенной геоизбыточности, настоятельно рекомендуется настроить сервер для использования двух разных хранилищ ключей в двух разных регионах с одинаковым материалом ключа. Ключ в дополнительном хранилище ключей в другом регионе не должен быть помечен как предохранитель TDE, и он даже не разрешен. В случае сбоя, влияющего на основное хранилище ключей, система автоматически переключается на другой связанный ключ с тем же отпечатком в дополнительном хранилище ключей, если он существует. Обратите внимание, что параметр не будет выполняться, если средство защиты TDE недоступно из-за отозванных прав доступа или из-за удаления ключа или хранилища ключей, так как это может означать, что пользователь намеренно хочет ограничить доступ к ключу. Чтобы предоставить один и тот же материал ключа для двух хранилищ ключей в разных регионах, создайте ключ за пределами хранилища ключей и импортируйте их в оба хранилища. 

Кроме того, это можно сделать, создав ключ с помощью первичного хранилища ключей, размещенного в том же регионе, что и сервер, и клонировать ключ в хранилище ключей в другом регионе Azure. Используйте командлет [BACKUP-азкэйваулткэй](https://docs.microsoft.com/powershell/module/az.keyvault/Backup-AzKeyVaultKey) , чтобы получить ключ в зашифрованном формате из хранилища первичного ключа, а затем используйте командлет [RESTORE-азкэйваулткэй](https://docs.microsoft.com/powershell/module/az.keyvault/restore-azkeyvaultkey) и укажите хранилище ключей во втором регионе, чтобы клонировать ключ. Кроме того, можно использовать портал Azure для резервного копирования и восстановления ключа. Операция резервного копирования и восстановления ключей разрешена только между хранилищами ключей в рамках одной подписки Azure и службы " [География](https://azure.microsoft.com/global-infrastructure/geographies/)Azure".  

![ВЫСОКАЯ ДОСТУПНОСТЬ Single-Server](./media/transparent-data-encryption-byok-overview/customer-managed-tde-with-ha.png)

## <a name="geo-dr-and-customer-managed-tde"></a>Географическое управление и TDE, управляемые клиентом

В сценариях « [Активная Георепликация](active-geo-replication-overview.md) » и « [Групповая отработка отказа](auto-failover-group-overview.md) » для каждого задействованного сервера требуется отдельное хранилище ключей, которое должно быть совместно расположено с сервером в том же регионе Azure. Клиент несет ответственность за хранение ключевых материалов в хранилищах ключей, чтобы он был синхронизирован и мог использовать тот же ключ из локального хранилища ключей, если первичный ключ станет недоступным из-за сбоя в регионе и активации отработки отказа. Можно настроить до четырех вторичных реплик и не поддерживать цепочки (вторичные реплики вторичных реплик).

Во избежание проблем при установке или во время георепликации из-за неполного материала ключа важно соблюдать следующие правила при настройке управляемого клиентом TDE:

- Все задействованные хранилища ключей должны иметь одинаковые свойства и права доступа для соответствующих серверов.

- Все задействованные хранилища ключей должны содержать одинаковый ключевой материал. Он применяется не только к текущему средству защиты TDE, но и ко всем предыдущим предохранителям TDE, которые могут использоваться в файлах резервных копий.

- Начальная настройка и вращение предохранителя TDE должны быть выполнены на вторичной базе данных-получателе, а затем на первичной.

![Группы отработки отказа и географическое аварийное восстановление](./media/transparent-data-encryption-byok-overview/customer-managed-tde-with-bcdr.png)

Чтобы протестировать отработку отказа, выполните действия, описанные в разделе [Общие сведения об активной георепликации](active-geo-replication-overview.md). Тестирование отработки отказа должно выполняться регулярно, чтобы убедиться, что база данных SQL хранит разрешение на доступ к обоим хранилищам ключей.

## <a name="next-steps"></a>Дальнейшие действия

Вы также можете проверить следующие примеры сценариев PowerShell для распространенных операций с управляемыми клиентом TDE:

- [Смена предохранителя прозрачное шифрование данных для базы данных SQL с помощью PowerShell](transparent-data-encryption-byok-key-rotation.md)

- [Удаление предохранителя прозрачное шифрование данных (TDE) для базы данных SQL с помощью PowerShell](transparent-data-encryption-byok-remove-tde-protector.md)

- [Управление прозрачное шифрование данных в Управляемый экземпляр SQL с помощью собственного ключа с использованием PowerShell](../managed-instance/scripts/transparent-data-encryption-byok-powershell.md?toc=%2fpowershell%2fmodule%2ftoc.json)
