---
title: Подготовка в приложении SaaS мультитенантной базы данных
description: Сведения о подготовке и каталогизации новых клиентов в приложении SaaS мультитенантной базы данных SQL Azure
services: sql-database
ms.service: sql-database
ms.subservice: scenario
ms.custom: sqldbrb=1
ms.devlang: ''
ms.topic: tutorial
author: stevestein
ms.author: sstein
ms.reviewer: ''
ms.date: 09/24/2018
ms.openlocfilehash: eddb0c8339069025f0742e9bcbc371efbef094ee
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "92793336"
---
# <a name="provision-and-catalog-new-tenants-in-a-saas-application-using-a-sharded-multi-tenant-azure-sql-database"></a>Подготовка и каталогизация новых клиентов и в приложении SaaS с помощью сегментированной мультитенантной Базы данных SQL Azure
[!INCLUDE[appliesto-sqldb](../includes/appliesto-sqldb.md)]

В этой статье рассматривается подготовка и каталогизация новых клиентов в модели или шаблоне *мультитенантной сегментированной базы данных*.

Эта статья состоит из двух основных частей:

- [Основное описание](#goto_2_conceptual) подготовки и каталогизации новых клиентов.

- [Руководство](#goto_1_tutorial), в котором приведен код скрипта PowerShell, выполняющий подготовку и каталогизацию.
  - В руководстве используется приложение SaaS Wingtip Tickets, адаптированное для шаблона мультитенантной сегментированной базы данных.

<a name="goto_2_conceptual"></a>

## <a name="database-pattern"></a>Шаблон базы данных

В этом и в нескольких следующих разделах рассматриваются концепции шаблона мультитенантной сегментированной базы данных.

В этой мультитенантной сегментированной модели табличные схемы в каждой базе данных содержат ключ клиента в первичном ключе таблиц, в которых хранятся данные клиента. Ключ клиента позволяет каждой отдельной базе данных хранить 0, 1 или несколько клиентов. Благодаря использованию сегментированной базы данных системе приложения проще поддерживать очень большое количество клиентов. Все данные для любого клиента хранятся в одной базе данных. Большое количество клиентов распределено по многим сегментированным базам данных. В базе данных каталога хранится сопоставление каждого клиента со своей базой данных.

#### <a name="isolation-versus-lower-cost"></a>Изоляция и меньшая стоимость

Клиент, в распоряжении которого имеется вся база данных, пользуется преимуществами изоляции. Клиент может восстановить базу данных на более раннюю дату, при этом к нему не будут применены ограничения из-за влияния на другие клиенты. Производительность базы данных можно оптимизировать для одного клиента, при этом не повлияв негативным образом на другие клиенты. Проблема заключается в том, что изоляция стоит дороже, чем совместное использование базы данных с другими клиентами.

При подготовке нового клиента он может использовать базу данных совместно с другими клиентами либо его можно поместить в собственную новую базу данных. Позже можно изменить свое решение и использовать базу данных в другом сценарии.

Базы данных с несколькими клиентами и с одним клиентом совместно используются в одном приложении SaaS для оптимизации затрат или изоляции каждого клиента.

   ![Приложение с сегментированной мультитенантной базой данных и каталогом клиента](./media/saas-multitenantdb-provision-and-catalog/MultiTenantCatalog.png)

## <a name="tenant-catalog-pattern"></a>Шаблон каталога клиента

При наличии двух или более баз данных, в каждой из которых содержится по крайней мере один клиент, приложение должно иметь возможность обнаруживать, какая база данных содержит необходимый клиент. База данных каталога хранит это сопоставление.

#### <a name="tenant-key"></a>Ключ клиента

Для каждого клиента приложение Wingtip может наследовать уникальный ключ, который представляет собой ключ клиента. Приложение извлекает имя клиента из URL-адреса веб-страницы, хэширует имя, чтобы получить ключ, и использует ключ для доступа к каталогу. Каталог содержит перекрестную ссылку на сведения о базе данных, в которой хранится клиент. Приложение использует сведения о базе данных для подключения. Вы также можете использовать и другие схемы ключа клиента.

Благодаря использованию каталога можно изменить имя или расположение базы данных клиента после подготовки, не прерывая работу приложения. В мультитенантной модели базы данных каталог обеспечивает перемещение клиента между базами данных.

#### <a name="tenant-metadata-beyond-location"></a>Метаданные клиента за пределами расположения

Каталог также может указывать, находится ли клиент в автономном режиме для обслуживания или других действий. Каталог можно увеличить, чтобы хранить метаданные дополнительного клиента или базы данных, например следующие элементы:
- уровень служб или выпуск базы данных;
- Версия схемы базы данных.
- имя клиента и его Соглашение об уровне обслуживания;
- сведения для управления приложениями, работы службы поддержки клиентов или процессов DevOps.

Каталог можно также использовать, чтобы создавать отчеты между клиентами, управлять схемой и извлекать данные для аналитики.

### <a name="elastic-database-client-library"></a>Клиентская библиотека эластичной базы данных

В Wingtip каталог реализуется в базе данных *tenantcatalog*. *tenantcatalog* создан с помощью функций управления сегментами в [клиентской библиотеке эластичной базы данных (EDCL)](elastic-database-client-library.md). Библиотека позволяет приложению создавать, администрировать и использовать *карту сегментов*, которая хранится в базе данных. Карта сегментов содержит перекрестную ссылку на ключ клиента с его сегментами, то есть его сегментированную базу данных.

При подготовке клиента функции EDCL можно использовать в приложениях или скриптах PowerShell, чтобы создавать записи в карте сегментов. Затем функции EDCL можно использовать для подключения к нужной базе данных. EDCL кэширует сведения о подключении, чтобы уменьшить объем входящего трафика для базы данных каталога и ускорить процесс подключения.

> [!IMPORTANT]
> *Не* изменяйте данные в базе данных каталога с использованием прямого доступа! Прямые обновления не поддерживаются из-за высокого риска повреждения данных. Вместо этого измените данные сопоставления с использованием только API-интерфейсов EDCL.

## <a name="tenant-provisioning-pattern"></a>Шаблон подготовки клиента

#### <a name="checklist"></a>Контрольный список

Если необходимо подготовить новый клиент в имеющейся общей базе данных, необходимо задать следующие вопросы относительно ее:
- Достаточно ли в ней места для нового клиента?
- Содержит ли она таблицы с необходимыми эталонными данными для нового клиента или данные можно добавить?
- Есть ли в ней соответствующий вариант базовой схемы для нового клиента?
- Находится ли она в соответствующем географическом расположении, близком к новому клиенту?
- Находится ли она на необходимом уровне служб для нового клиента?

Если необходимо, чтобы новый клиент был изолирован в собственной базе данных, ее можно создать для соответствия спецификациям для клиента.

После завершения подготовки клиент необходимо зарегистрировать в каталоге. Наконец, можно добавить сопоставление клиентов, чтобы ссылаться на соответствующий сегмент.

#### <a name="template-database"></a>Шаблон базы данных

Чтобы подготовить базу данных, выполните скрипты SQL, разверните файл BACPAC или скопируйте шаблон базы данных. Приложения Wingtip копируют шаблон базы данных, чтобы создать базы данных клиентов.

Как и любое приложение, Wingtip будет меняться с течением времени. В некоторых случаях для Wingtip потребуется внести изменения в базу данных. В число этих изменений могут входить следующие:
- новая или измененная схема;
- новые или измененные эталонные данные;
- рутинные задачи обслуживания базы данных для обеспечения оптимальной производительности приложения.

С приложением SaaS эти изменения необходимо развертывать скоординировано в потенциально большом количестве баз данных клиентов. Чтобы эти изменения были внесены в будущие базы данных клиентов, их нужно включить в процесс подготовки. Эта задача описана далее в руководстве [Управление схемой для нескольких клиентов в мультитенантном приложении, использующем Базу данных SQL Azure](saas-tenancy-schema-management.md).

#### <a name="scripts"></a>Сценарии

Скрипты подготовки клиентов в этом руководстве поддерживают оба следующих сценария:
- подготовка клиента в имеющейся базе данных, используемой совместно с другими клиентами;
- подготовка клиента в собственной базе данных.

Данные клиента затем инициализируются и регистрируются в карте сегментов каталога. В примере приложения базы данных, содержащие несколько клиентов, получают общее имя, например *tenants1* или *tenants2*. Базы данных, содержащие один клиент, получают имя клиента. Определенные соглашения об именовании, используемые в примере, не являются критически важным требованием для шаблона, так как благодаря применению каталога базе данных можно присвоить любое имя.

<a name="goto_1_tutorial"></a>

## <a name="tutorial-begins"></a>Начало руководства

В этом руководстве описано следующее:

> [!div class="checklist"]
> * подготавливать клиента в мультитенантной базе данных;
> * подготавливать клиента в однотенантной базе данных;
> * подготавливать пакет клиентов в мультитенантной и однотенантной базе данных;
> * регистрировать сопоставление баз данных и клиентов в каталоге.

#### <a name="prerequisites"></a>Предварительные требования

Для работы с этим руководством выполните следующие предварительные требования:

- Установите Azure PowerShell. Дополнительные сведения см. в статье [Начало работы с Azure PowerShell](/powershell/azure/get-started-azureps).

- Разверните приложение SaaS-приложение Wingtip Tickets c мультитенантной БД. Вы можете развернуть его менее чем за пять минут, используя инструкцию из статьи [Deploy and explore a sharded multi-tenant application that uses Azure SQL Database](./saas-multitenantdb-get-started-deploy.md) (Развертывание и изучение сегментированного мультитенантного приложения, использующего Базу данных SQL Azure).

- Получите скрипты Wingtip и исходный код:
    - Сценарии для приложения SaaS Wingtip Tickets c мультитенантной базой данных и исходный код этого приложения вы найдете в репозитории GitHub [WingtipTicketsSaaS-MultitenantDB](https://github.com/microsoft/WingtipTicketsSaaS-MultiTenantDB).
    - Инструкции по загрузке и разблокированию скриптов Wingtip см. в статье [Общие рекомендации по работе с примерами приложений SaaS Wingtip Tickets](saas-tenancy-wingtip-app-guidance-tips.md).

## <a name="provision-a-tenant-into-a-database-shared-with-other-tenants"></a>Подготовка клиента в базе данных, *используемой совместно* с другими клиентами

В этом разделе приведен список основных действий по подготовке, выполняемых с помощью скриптов PowerShell. Затем чтобы увидеть действия в коде, необходимо пошагово выполнить скрипты с помощью отладчика интегрированной среды сценариев PowerShell.

#### <a name="major-actions-of-provisioning"></a>Основные действия по подготовке

Ниже приведены основные этапы рабочего процесса подготовки.

- **Вычисление нового ключа клиента.** Для создания ключа клиента из имени клиента используется хэш-функция.
- **Проверка наличия ключа клиента.** Каталог проверяется, чтобы убедиться, что ключ еще не зарегистрирован.
- **Подготовка клиента в базе данных клиента по умолчанию.** База данных клиента обновляется путем добавления новых данных клиента.
- **Регистрация клиента в каталоге.** Сопоставление нового ключа клиента и существующей базы данных tenants1 добавляется в каталог.
- **Добавление имени клиента в таблицу расширения каталога.** Имя места проведения добавляется в таблицу клиентов в каталоге.  Это добавление показывает, как можно расширить базу данных каталога для поддержки дополнительных данных приложения.
- **Открытие страницы мероприятий для нового клиента.** Страница мероприятий *Bushwillow Blues* открыта в браузере.

   ![Снимок экрана, на котором показана страница мероприятий для нового клиента.](./media/saas-multitenantdb-provision-and-catalog/bushwillow.png)

#### <a name="debugger-steps"></a>Действия отладчика

Чтобы понять, как приложение Wingtip подготавливает новый клиент в общей базе данных, добавьте точку останова и перейдите к выполнению рабочего процесса:

1. В *интегрированной среде сценариев PowerShell* откройте файл …\\Learning Modules\\ProvisionTenants\\*Demo-ProvisionTenants.ps1* и задайте следующие параметры.
   - **$TenantName** = **Bushwillow Blues** — имя нового места проведения.
   - **$VenueType** = **blues** — один из предопределенных типов мест проведения: blues, classicalmusic, dance, jazz, judo, motorracing, multipurpose, opera, rockmusic, soccer (строчными буквами, без пробелов).
   - Задайте **$DemoScenario** = **1**, чтобы подготовить клиент в базе данных, используемой совместно с другими клиентами.

2. Добавьте точку останова, поместив курсор в любом месте строки 38, содержащей *New-Tenant `*, а затем нажмите клавишу **F9**.

   ![Снимок экрана, на котором выделена строка, содержащая объект New-Tenant.](./media/saas-multitenantdb-provision-and-catalog/breakpoint.png)

3. Запустите сценарий, нажав клавишу **F5**.

4. После остановки выполнения скрипта в точке останова нажмите клавишу **F11**, чтобы пошагово выполнить код.

   ![Снимок экрана: интегрированная среда сценариев Windows PowerShell с меню "Отладка" и выбранным пунктом "Выполнять по шагам".](./media/saas-multitenantdb-provision-and-catalog/debug.png)

5. Отслеживайте выполнение скрипта и используйте клавиши **F10** и **F11** (меню **Отладка**), чтобы обойти вызываемые функции или перейти в них по очереди.

Дополнительные сведения об отладке сценариев PowerShell см. в разделе [Отладка сценариев в интегрированной среде сценариев Windows PowerShell](/powershell/scripting/components/ise/how-to-debug-scripts-in-windows-powershell-ise).

## <a name="provision-a-tenant-in-its-own-database"></a>Подготовка клиента в *собственной* базе данных

#### <a name="major-actions-of-provisioning"></a>Основные действия по подготовке

Ниже приведены основные этапы рабочего процесса при трассировке скрипта.

- **Вычисление нового ключа клиента.** Для создания ключа клиента из имени клиента используется хэш-функция.
- **Проверка наличия ключа клиента.** Каталог проверяется, чтобы убедиться, что ключ еще не зарегистрирован.
- **Создание базы данных клиента.** База данных создается путем копирования базы данных *basetenantdb* с помощью шаблона Resource Manager.  Имя новой базы данных основано на имени клиента.
- **Добавление базы данных в каталог.** Новая база данных клиента регистрируется в качестве сегмента в каталоге.
- **Подготовка клиента в базе данных клиента по умолчанию.** База данных клиента обновляется путем добавления новых данных клиента.
- **Регистрация клиента в каталоге.** Сопоставление нового ключа клиента и существующей базы данных *sequoiasoccer* добавляется в каталог.
- **Имя клиента добавляется в каталог.** Имя места проведения добавляется в таблицу расширения клиентов в каталоге.
- **Открытие страницы мероприятий для нового клиента.** Страница мероприятий *Sequoia Soccer* открыта в браузере.

   ![события](./media/saas-multitenantdb-provision-and-catalog/sequoiasoccer.png)

#### <a name="debugger-steps"></a>Действия отладчика

Теперь рассмотрите выполнение скрипта во время создания клиента в собственной базе данных.

1. В файле …\\Learning Modules\\ProvisionTenants\\*Demo-ProvisionTenants.ps1* задайте следующие параметры.
   - **$TenantName** = **Sequoia Soccer** — имя нового места проведения.
   - **$VenueType** = **soccer** — один из предопределенных типов мест проведения: blues, classicalmusic, dance, jazz, judo, motorracing, multipurpose, opera, rockmusic, soccer (строчными буквами, без пробелов).
   - Задайте **$DemoScenario** = **2**, чтобы подготовить клиент в собственной базе данных.

2. Добавьте новую точку останова, поместив курсор в любом месте строки 57, содержащей *&&nbsp;$PSScriptRoot\New-TenantAndDatabase `* , и нажмите клавишу **F9**.

   ![точка останова](./media/saas-multitenantdb-provision-and-catalog/breakpoint2.png)

3. Запустите сценарий, нажав клавишу **F5**.

4. После остановки выполнения сценария в точке останова нажмите клавишу **F11**, чтобы пошагово выполнить код.  С помощью клавиш **F10** и **F11** можно обойти функцию или перейти в нее для отслеживания выполнения.

## <a name="provision-a-batch-of-tenants"></a>Подготовка пакета клиентов

В этом упражнении подготавливается пакет из 17 клиентов. Рекомендуется подготовить этот пакет клиентов перед выполнением задач других руководств по Wingtip Tickets, чтобы вы могли работать с большим количеством баз данных.

1. В *интегрированной среде сценариев PowerShell* откройте файл …\\Learning Modules\\ProvisionTenants\\*Demo-ProvisionTenants.ps1* и измените значение параметра *$DemoScenario* на 4.
   - Задайте **$DemoScenario** = **4**, чтобы подготовить пакет клиентов в общей базе данных.

2. Нажмите клавишу **F5** для запуска скрипта.

### <a name="verify-the-deployed-set-of-tenants"></a>Проверка развернутого набора клиентов

На этом этапе у вас есть клиенты, развернутые в общей базе данных, и клиенты, развернутые в собственных базах данных. С помощью портала Azure можно просмотреть созданные базы данных. На [портале Azure](https://portal.azure.com) откройте сервер **tenants1-mt-\<USER\>** , перейдя к списку серверов SQL.  Список **баз данных SQL** должен включать общую базу данных **tenants1** и базы данных для клиентов, которые расположены в собственных базах данных.

   ![список баз данных](./media/saas-multitenantdb-provision-and-catalog/Databases.png)

Хотя на портале Azure отображаются базы данных клиентов, вы не можете просмотреть клиенты *внутри* общих баз данных. Полный список клиентов можно просмотреть на веб-странице **концентратора событий** Wingtip или с помощью каталога.

#### <a name="using-wingtip-tickets-events-hub-page"></a>Использование страницы концентратора событий Wingtip Tickets

Откройте страницу концентратора событий в браузере (http:events.wingtip-mt.\<USER\>.trafficmanager.net).

#### <a name="using-catalog-database"></a>Использование базы данных каталога

Полный список клиентов и их соответствующие базы данных можно просмотреть в каталоге. Доступно представление SQL, в котором имя клиента объединяется с именем базы данных. В этом представлении хорошо показано ценность расширения метаданных, хранящихся в каталоге.
- Представление SQL содержится в базе данных tenantcatalog.
- Имя клиента хранится в таблице клиентов.
- Имя базы данных хранится в таблицах управления сегментами.

1. В SQL Server Management Studio (SSMS) подключитесь к серверу клиентов по адресу **catalog-mt.\<USER\>.database.windows.net**, указав в качестве имени для входа **developer**, а в качестве пароля — **P\@ssword1**.

    ![Диалоговое окно подключения SSMS](./media/saas-multitenantdb-provision-and-catalog/SSMSConnection.png)

2. В обозревателе объектов SSMS перейдите к представлениям в базе данных *tenantcatalog*.

3. Щелкните правой кнопкой мыши представление *TenantsExtended* и выберите **Select Top 1000 Rows** (Выбрать первые 1000 строк). Обратите внимание на сопоставление имени клиента и базы данных для разных клиентов.

    ![Представление ExtendedTenants в SSMS](./media/saas-multitenantdb-provision-and-catalog/extendedtenantsview.png)

## <a name="other-provisioning-patterns"></a>Другие шаблоны подготовки

В этом разделе приведены другие интересные шаблоны подготовки.

#### <a name="pre-provisioning-databases-in-elastic-pools"></a>Предварительная подготовка баз данных в эластичных пулах

В шаблоне предварительной подготовки учитывается тот факт, что при использовании эластичных пулов счета выставляются за пулы, а не за базы данных. Таким образом, можно добавить базы данных в эластичный пул до того, как они понадобятся, чтобы избежать лишних расходов. Эта предварительная подготовка значительно уменьшает время, необходимое для подготовки клиента в базе данных. Вы можете заранее подготовить любое удобное количество баз данных, чтобы поддерживать буфер достаточного размера для ожидаемого темпа добавления клиентов.

#### <a name="auto-provisioning"></a>Автоматическая подготовка

В шаблоне автоматической подготовки используется выделенная служба для автоматической подготовки серверов, пулов и баз данных. Эта автоматическая подготовка включает предварительную подготовку баз данных в эластичных пулах. При списании и удалении баз данных созданные пропуски в эластичных пулах могут заполняться службой подготовки в случае необходимости.

Автоматизированная служба такого типа может быть простой или сложной. С ее помощью можно, например, управлять подготовкой в нескольких географических регионах и настраивать георепликацию для аварийного восстановления. С помощью шаблона автоматической подготовки клиентское приложение или скрипт может отправить запрос на подготовку в очередь для обработки службой подготовки. Затем скрипт будет выполнять запрос, чтобы получить данные о завершении. Если используется предварительная подготовка, запросы обрабатываются быстро, в то время как фоновая служба будет управлять подготовкой базы данных для замены.

## <a name="additional-resources"></a>Дополнительные ресурсы

<!-- - Additional [tutorials that build upon the Wingtip SaaS application](./saas-dbpertenant-wingtip-app-overview.md#sql-database-wingtip-saas-tutorials)-->
- [Клиентская библиотека эластичной базы данных](elastic-database-client-library.md)
- [Отладка сценариев в интегрированной среде сценариев Windows PowerShell](/powershell/scripting/components/ise/how-to-debug-scripts-in-windows-powershell-ise)


## <a name="next-steps"></a>Дальнейшие действия

Из этого руководства вы узнали, как выполнять такие задачи:

> [!div class="checklist"]
> * Подготовка нового клиента в общей мультитенантной базе данных и в собственной базе данных.
> * Подготовка пакета дополнительных клиентов.
> * Получение сведений о подготовке клиентов и их регистрация в каталоге.

Ознакомьтесь с [руководством по мониторингу производительности](./saas-multitenantdb-performance-monitoring.md).