---
title: Перенос баз данных в SQL Управляемый экземпляр с помощью службы воспроизведения журналов
description: Узнайте, как перенести базы данных из SQL Server в SQL Управляемый экземпляр с помощью службы воспроизведения журналов.
services: sql-database
ms.service: sql-managed-instance
ms.custom: seo-lt-2019, sqldbrb=1
ms.topic: how-to
author: danimir
ms.author: danil
ms.reviewer: sstein
ms.date: 03/01/2021
ms.openlocfilehash: 0bc00aea67fa2f71599ee62e657e1ca1b0627681
ms.sourcegitcommit: dda0d51d3d0e34d07faf231033d744ca4f2bbf4a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/05/2021
ms.locfileid: "102199855"
---
# <a name="migrate-databases-from-sql-server-to-sql-managed-instance-by-using-log-replay-service-preview"></a>Перенос баз данных из SQL Server в SQL Управляемый экземпляр с помощью службы воспроизведения журналов (Предварительная версия)
[!INCLUDE[appliesto-sqlmi](../includes/appliesto-sqlmi.md)]

В этой статье объясняется, как вручную настроить миграцию базы данных с SQL Server 2008-2019 на Azure SQL Управляемый экземпляр с помощью службы воспроизведения журналов (LRS), которая в настоящее время доступна в общедоступной предварительной версии. LRS — это облачная служба, которая включена для SQL Управляемый экземпляр и основана на SQL Server технологии доставки журналов. 

[Azure Database Migration Service](/azure/dms/tutorial-sql-server-to-managed-instance) и LRS используют ту же самую базовую технологию переноса и те же интерфейсы API. Выпустив LRS, мы дополнительно реализуем сложные пользовательские миграции и гибридную архитектуру между локальными SQL Server и Управляемый экземпляр SQL.

## <a name="when-to-use-log-replay-service"></a>Когда следует использовать службу воспроизведения журналов

Если вы не можете использовать Azure Database Migration Service для миграции, вы можете использовать LRS непосредственно с PowerShell, Azure CLI командлетами или API-интерфейсами для ручной сборки и координации миграции баз данных на Управляемый экземпляр SQL. 

Вы можете использовать LRS в следующих случаях:
- Для проекта переноса базы данных требуется больший контроль.
- Малое время простоя прямую миграцию миграции.
- Не удается установить исполняемый файл Database Migration Service в вашей среде.
- Исполняемый файл Database Migration Service не имеет доступа к резервным копиям базы данных.
- Доступ к ОС узла невозможен, или отсутствуют права администратора.
- Вы не можете открыть сетевые порты из вашей среды в Azure.
- Резервные копии хранятся непосредственно в хранилище BLOB-объектов Azure с помощью `TO URL` параметра.
- Необходимо использовать разностные резервные копии.

> [!NOTE]
> Рекомендуется автоматизировать перенос баз данных из SQL Server в SQL Управляемый экземпляр с помощью Database Migration Service. Эта служба использует одну и ту же облачную службу LRS в серверной части с доставкой журналов в `NORECOVERY` режиме. Рекомендуется вручную использовать LRS для координации миграций, когда Database Migration Service не полностью поддерживает ваши сценарии.

## <a name="how-it-works"></a>Принципы работы

Для создания пользовательского решения с помощью LRS для переноса баз данных в облако требуется выполнить несколько шагов оркестрации, как показано на схеме и таблице далее в этом разделе.

Миграция состоит из создания полных резервных копий базы данных на SQL Server с `CHECKSUM` включенным, а также копирования файлов резервных копий в хранилище BLOB-объектов Azure. LRS используется для восстановления файлов резервных копий из хранилища BLOB-объектов в SQL Управляемый экземпляр. Хранилище BLOB-объектов — это промежуточное хранилище между SQL Server и Управляемый экземпляр SQL.

LRS отслеживает хранилище BLOB-объектов для любых новых разностных резервных копий или архивов журналов, добавленных после восстановления полной резервной копии. Затем LRS автоматически восстанавливает эти новые файлы. Службу можно использовать для наблюдения за ходом выполнения восстанавливаемых файлов резервных копий на Управляемый экземпляр SQL, а также при необходимости можно прерывать процесс.

LRS не требует определенного соглашения об именовании для файлов резервных копий. Он сканирует все файлы, размещенные в хранилище BLOB-объектов, и конструирует цепочку резервных копий только для чтения заголовков файлов. В процессе миграции базы данных находятся в состоянии восстановления. Базы данных восстанавливаются в режиме [NORECOVERY](/sql/t-sql/statements/restore-statements-transact-sql#comparison-of-recovery-and-norecovery) , поэтому их нельзя использовать для чтения или записи до завершения процесса миграции. 

Если выполняется миграция нескольких баз данных, необходимо выполнить следующие действия.
 
- Размещайте резервные копии для каждой базы данных в отдельной папке в хранилище BLOB-объектов.
- Запустите LRS отдельно для каждой базы данных.
- Укажите разные пути для отдельных папок хранилища BLOB-объектов. 

Вы можете запустить LRS в *автозаполнении* или *непрерывном* режиме. При запуске в режиме автозаполнения миграция будет завершена автоматически при восстановлении последней из указанных файлов резервной копии. При запуске LRS в непрерывном режиме служба постоянно восстанавливает все добавленные файлы резервных копий, и миграция будет завершена только в ручном прямую миграцию. 

Рекомендуется вручную выполнить вырезание после завершения окончательного резервного копирования заключительного фрагмента журнала, который отображается как восстановленный в Управляемый экземпляр SQL. Окончательный шаг прямую миграцию сделает базу данных доступной для чтения и записи в SQL Управляемый экземпляр.

После остановки LRS, автоматически с помощью автозаполнения или вручную с помощью прямую миграцию, невозможно возобновить процесс восстановления для базы данных, которая была подключена к SQL Управляемый экземпляр. Чтобы восстановить дополнительные файлы резервных копий после завершения миграции через Автозаполнение или прямую миграцию, необходимо удалить базу данных. Также необходимо восстановить всю цепочку резервных копий с нуля, перезапуская LRS.

:::image type="content" source="./media/log-replay-service-migrate/log-replay-service-conceptual.png" alt-text="Схема, объясняющая шаги оркестрации службы воспроизведения журналов для SQL Управляемый экземпляр." border="false":::
    
| Операция | Подробнее |
| :----------------------------- | :------------------------- |
| **1. Скопируйте резервные копии базы данных из SQL Server в хранилище BLOB-объектов**. | Копирование полных, разностных и резервных копий журналов из SQL Server в контейнер хранилища BLOB-объектов с помощью [Azcopy](/azure/storage/common/storage-use-azcopy-v10) или [Обозреватель службы хранилища Azure](https://azure.microsoft.com/features/storage-explorer/). <br /><br />Используйте любые имена файлов. LRS не требует определенного соглашения об именовании файлов.<br /><br />При переносе нескольких баз данных требуется отдельная папка для каждой базы данных. |
| **2. ЗАПУСТИТЕ LRS в облаке**. | Вы можете перезапустить службу с помощью командлетов PowerShell ([Start-азсклинстанцедатабаселогреплай](/powershell/module/az.sql/start-azsqlinstancedatabaselogreplay)) или Azure CLI ([az_sql_midb_log_replay_start командлетов](/cli/azure/sql/midb/log-replay#az_sql_midb_log_replay_start)). <br /><br /> Запустите LRS отдельно для каждой базы данных, указывающей на папку резервного копирования в хранилище BLOB-объектов. <br /><br /> После запуска службы она получит резервные копии из контейнера хранилища BLOB-объектов и начнет их восстановление в SQL Управляемый экземпляр.<br /><br /> Если вы начали LRS в непрерывном режиме, то после восстановления всех начальных резервных копий служба будет следить за новыми файлами, отправленными в папку. Служба будет постоянно применять журналы на основе цепочки регистрационных номеров транзакции в журнале (LSN) до ее остановки. |
| **2,1. Отслеживайте ход выполнения операции**. | Ход выполнения операции восстановления можно отслеживать с помощью командлетов PowerShell ([Get-азсклинстанцедатабаселогреплай](/powershell/module/az.sql/get-azsqlinstancedatabaselogreplay)) или Azure CLI ([az_sql_midb_log_replay_show командлетов](/cli/azure/sql/midb/log-replay#az_sql_midb_log_replay_show)). |
| **2,2. при необходимости прервите выполнение операции**. | Если необходимо прерывать процесс миграции, можно выбрать командлеты: PowerShell ([азсклинстанцедатабаселогреплай](/powershell/module/az.sql/stop-azsqlinstancedatabaselogreplay)) или Azure CLI ([az_sql_midb_log_replay_stop](/cli/azure/sql/midb/log-replay#az_sql_midb_log_replay_stop)). <br /><br /> Остановка операции приведет к удалению базы данных, которую вы восстанавливаете в SQL Управляемый экземпляр. После того как операция будет приостановлена, вы не сможете возобновить LRS для базы данных. Необходимо перезапустить процесс миграции с нуля. |
| **3. вырежьте в облако, когда будете готовы**. | Завершите работу приложения и рабочей нагрузки. Выполните последнюю резервную копию заключительного фрагмента журнала и отправьте ее в хранилище BLOB-объектов Azure.<br /><br /> Завершите прямую миграцию, инициируя `complete` операцию LRS с помощью командлетов: PowerShell ([Complete-азсклинстанцедатабаселогреплай](/powershell/module/az.sql/complete-azsqlinstancedatabaselogreplay)) или Azure CLI [az_sql_midb_log_replay_complete](/cli/azure/sql/midb/log-replay#az_sql_midb_log_replay_complete). Эта операция останавливает LRS и заставит базу данных в оперативный режим для чтения и записи в Управляемый экземпляр SQL.<br /><br /> Переведите строку подключения приложения с SQL Server на SQL Управляемый экземпляр. |

## <a name="requirements-for-getting-started"></a>Требования к началу работы

### <a name="sql-server-side"></a>SQL Serverная сторона
- SQL Server 2008-2019
- Полное резервное копирование баз данных (один или несколько файлов)
- Разностная резервная копия (один или несколько файлов)
- Резервная копия журнала (не разбиение для файла журнала транзакций)
- `CHECKSUM` включено для резервного копирования (обязательно)

### <a name="azure-side"></a>На стороне Azure
- PowerShell AZ. SQL Module 2.16.0 или более поздней версии ([установлен](https://www.powershellgallery.com/packages/Az.Sql/) или доступен через [Azure Cloud Shell](/azure/cloud-shell/))
- Azure CLI версии 2.19.0 или более поздней ([установлена](/cli/azure/install-azure-cli))
- Контейнер хранилища BLOB-объектов Azure подготовлен
- Маркер безопасности подписанного URL-адрес (SAS) с разрешениями на чтение и перечисление, созданные для контейнера хранилища больших двоичных объектов.

### <a name="migration-of-multiple-databases"></a>Перенос нескольких баз данных
Файлы резервных копий для разных баз данных необходимо размещать в отдельных папках в хранилище BLOB-объектов.

Запустите LRS отдельно для каждой базы данных, указав соответствующую папку в хранилище BLOB-объектов. LRS может поддерживать до 100 процессов одновременного восстановления на один управляемый экземпляр.

### <a name="azure-rbac-permissions"></a>Разрешения RBAC в Azure
Для запуска LRS с помощью указанных клиентов требуется одна из следующих ролей Azure:
- Роль владельца подписки
- Роль [участника управляемый экземпляр](../../role-based-access-control/built-in-roles.md#sql-managed-instance-contributor)
- Пользовательская роль со следующим разрешением: `Microsoft.Sql/managedInstances/databases/*`

## <a name="best-practices"></a>Рекомендации

Рекомендуются следующие методы:
- Запустите [Помощник по миграции данных](/sql/dma/dma-overview) , чтобы убедиться, что базы данных готовы к миграции в SQL управляемый экземпляр. 
- Разбейте полные и разностные резервные копии на несколько файлов вместо использования одного файла.
- Включите сжатие резервных копий.
- Используйте Cloud Shell для запуска скриптов, так как он всегда будет обновлен до выпуска последних версий командлетов.
- Запланируйте Завершение миграции в течение 47 часов после запуска LRS. Это льготный период, который предотвращает установку исправлений программного обеспечения, управляемых системой.

> [!IMPORTANT]
> - Базу данных, которая восстанавливается через LRS, нельзя использовать до завершения процесса миграции. 
> - LRS не поддерживает доступ только для чтения к базам данных во время миграции.
> - После завершения миграции процесс миграции завершается, так как LRS не поддерживает возобновление процесса восстановления.

## <a name="steps-to-execute"></a>Шаги для выполнения

### <a name="make-backups-of-sql-server"></a>Создание резервных копий SQL Server

Резервные копии SQL Server можно создавать с помощью одного из следующих параметров.

- Создайте резервную копию на локальном диске, а затем отправьте файлы в хранилище BLOB-объектов Azure, если среда ограничена прямым резервным копированием в хранилище BLOB-объектов.
- Резервное копирование данных непосредственно в хранилище BLOB-объектов с помощью `TO URL` параметра в T-SQL, если среда и процедуры безопасности разрешают эту функцию. 

Настройте базы данных, которые требуется перенести в режим полного восстановления, чтобы разрешить резервное копирование журналов.

```SQL
-- To permit log backups, before the full database backup, modify the database to use the full recovery
USE master
ALTER DATABASE SampleDB
SET RECOVERY FULL
GO
```

Чтобы вручную создать полные, разностные и резервные копии журналов базы данных в локальном хранилище, используйте приведенные ниже примеры скриптов T-SQL. Убедитесь, что `CHECKSUM` параметр включен, так как он обязателен для LRS.

```SQL
-- Example of how to make a full database backup to the local disk
BACKUP DATABASE [SampleDB]
TO DISK='C:\BACKUP\SampleDB_full.bak'
WITH INIT, COMPRESSION, CHECKSUM
GO

-- Example of how to make a differential database backup to the local disk
BACKUP DATABASE [SampleDB]
TO DISK='C:\BACKUP\SampleDB_diff.bak'
WITH DIFFERENTIAL, COMPRESSION, CHECKSUM
GO

-- Example of how to make a transactional log backup to the local disk
BACKUP LOG [SampleDB]
TO DISK='C:\BACKUP\SampleDB_log.trn'
WITH COMPRESSION, CHECKSUM
GO
```

### <a name="create-a-storage-account"></a>Создание учетной записи хранения

Хранилище BLOB-объектов Azure используется в качестве промежуточного хранилища для файлов резервных копий между SQL Server и SQL Управляемый экземпляр. Чтобы создать новую учетную запись хранения и контейнер больших двоичных объектов в учетной записи хранения, выполните следующие действия.

1. [Создание учетной записи хранения](../../storage/common/storage-account-create.md?tabs=azure-portal).
2. [Создавайте контейнер больших двоичных объектов](../../storage/blobs/storage-quickstart-blobs-portal.md) в учетной записи хранения.

### <a name="copy-backups-from-sql-server-to-blob-storage"></a>Копировать резервные копии из SQL Server в хранилище BLOB-объектов

При переносе баз данных в управляемый экземпляр с помощью LRS для отправки резервных копий в хранилище BLOB-объектов можно использовать следующие подходы.
- Использование SQL Server собственного [резервного копирования в функции URL-адреса](/sql/relational-databases/backup-restore/sql-server-backup-to-url)
- Использование [Azcopy](/azure/storage/common/storage-use-azcopy-v10) или [Обозреватель службы хранилища Azure](https://azure.microsoft.com/en-us/features/storage-explorer) для отправки резервных копий в контейнер больших двоичных объектов
- Использование Обозреватель службы хранилища в портал Azure

### <a name="make-backups-from-sql-server-directly-to-blob-storage"></a>Создание резервных копий из SQL Server непосредственно в хранилище BLOB-объектов
Если корпоративная и сетевая политики позволяют выполнять резервное копирование из SQL Server непосредственно в хранилище BLOB-объектов, используйте параметр SQL Server Native [BACKUP to URL](/sql/relational-databases/backup-restore/sql-server-backup-to-url) . Если вы можете использовать этот вариант, вам не нужно создавать резервные копии в локальном хранилище и отправлять их в хранилище BLOB-объектов.

В качестве первого шага для этой операции требуется создать маркер проверки подлинности SAS для хранилища BLOB-объектов, а затем импортировать маркер в SQL Server. Вторым шагом является создание резервных копий с `TO URL` параметром в T-SQL. Убедитесь, что выполнены все резервные копии с `CHEKSUM` включенным параметром.

Приведенный ниже пример кода создает резервные копии в хранилище BLOB-объектов. Этот пример не содержит инструкций по импорту маркера SAS. Подробные инструкции, включая сведения о создании и импорте маркера SAS для SQL Server, см. в руководстве [Использование хранилища BLOB-объектов Azure с SQL Server](/sql/relational-databases/tutorial-use-azure-blob-storage-service-with-sql-server-2016#1---create-stored-access-policy-and-shared-access-storage). 

```SQL
-- Example of how to make a full database backup to a URL
BACKUP DATABASE [SampleDB]
TO URL = 'https://<mystorageaccountname>.blob.core.windows.net/<mycontainername>/SampleDB_full.bak'
WITH INIT, COMPRESSION, CHECKSUM
GO
-- Example of how to make a differential database backup to a URL
BACKUP DATABASE [SampleDB]
TO URL = 'https://<mystorageaccountname>.blob.core.windows.net/<mycontainername>/SampleDB_diff.bak'  
WITH DIFFERENTIAL, COMPRESSION, CHECKSUM
GO

-- Example of how to make a transactional log backup to a URL
BACKUP LOG [SampleDB]
TO URL = 'https://<mystorageaccountname>.blob.core.windows.net/<mycontainername>/SampleDB_log.trn'  
WITH COMPRESSION, CHECKSUM
```

### <a name="generate-a-blob-storage-sas-authentication-token-for-lrs"></a>Создание маркера проверки подлинности SAS хранилища BLOB-объектов для LRS

Хранилище BLOB-объектов Azure используется в качестве промежуточного хранилища для файлов резервных копий между SQL Server и SQL Управляемый экземпляр. Для LRS необходимо создать маркер проверки подлинности SAS, имеющий только разрешения List и Read. Маркер позволит LRS получить доступ к хранилищу BLOB-объектов и использовать файлы резервных копий для их восстановления в SQL Управляемый экземпляр. 

Чтобы создать маркер, выполните следующие действия.

1. Откройте Обозреватель службы хранилища из портал Azure.
2. Разверните узел **контейнеры больших двоичных объектов**.
3. Щелкните правой кнопкой мыши контейнер больших двоичных объектов и выберите **получить подпись общего доступа**.

   :::image type="content" source="./media/log-replay-service-migrate/lrs-sas-token-01.png" alt-text="Снимок экрана, на котором показаны варианты создания маркера проверки подлинности S S.":::

4. Выберите период истечения срока действия маркера. Убедитесь, что маркер действителен в течение всего периода миграции.
5. Выберите часовой пояс для маркера: UTC или местное время.
    
   > [!IMPORTANT]
   > Часовой пояс маркера и управляемого экземпляра могут быть несогласованными. Убедитесь, что маркер SAS имеет соответствующие сроки, принимая во внимание часовой пояс. Если это возможно, задайте в качестве часового пояса более раннюю и позднее время планового окна миграции.
6. Выберите только разрешения на **Чтение** и **Список** .

   > [!IMPORTANT]
   > Не выбирайте никаких других разрешений. В противном случае LRS не запустится. Это требование безопасности предназначено для разработки.
7. Нажмите кнопку **создания**.

   :::image type="content" source="./media/log-replay-service-migrate/lrs-sas-token-02.png" alt-text="Снимок экрана, на котором показаны варианты истечения срока действия маркера S, часового пояса и разрешений, а также кнопка &quot;создать&quot;.":::

Проверка подлинности SAS создается с заданной допустимостью времени. Вам потребуется версия URI маркера, как показано на следующем снимке экрана.

:::image type="content" source="./media/log-replay-service-migrate/lrs-generated-uri-token.png" alt-text="Снимок экрана, показывающий пример версии U R I маркера s A S.":::

### <a name="copy-parameters-from-the-sas-token"></a>Копировать параметры из маркера SAS

Прежде чем использовать маркер SAS для запуска LRS, необходимо понимать его структуру. Универсальный код ресурса (URI) созданного маркера SAS состоит из двух частей, разделенных вопросительным знаком ( `?` ), как показано в следующем примере:

:::image type="content" source="./media/log-replay-service-migrate/lrs-token-structure.png" alt-text="Пример U R I для созданного маркера s A S для службы воспроизведения журнала." border="false":::

Первая часть, начиная с, `https://` пока вопросительный знак ( `?` ) не используется для `StorageContainerURI` параметра, который подается в качестве входных данных LRS. Он предоставляет LRS сведения о папке, в которой хранятся файлы резервной копии базы данных.

Вторая часть, начиная с вопросительного знака ( `?` ) и заканчивая до конца строки, является `StorageContainerSasToken` параметром. Это фактически подписанный маркер проверки подлинности, который действителен в течение указанного времени. Эта часть не обязательно должна начинаться с, `sp=` как показано в примере. Ваш случай может отличаться.

Скопируйте параметры следующим образом:

1. Скопируйте первую часть маркера, начиная с `https://` всего пути, до вопросительного знака ( `?` ). Используйте его в качестве `StorageContainerUri` параметра в PowerShell или Azure CLI для запуска LRS.

   :::image type="content" source="./media/log-replay-service-migrate/lrs-token-uri-copy-part-01.png" alt-text="Снимок экрана, на котором показано копирование первой части маркера.":::

2. Скопируйте вторую часть маркера, начиная с вопросительного знака ( `?` ) до конца строки. Используйте его в качестве `StorageContainerSasToken` параметра в PowerShell или Azure CLI для запуска LRS.

   :::image type="content" source="./media/log-replay-service-migrate/lrs-token-uri-copy-part-02.png" alt-text="Снимок экрана, показывающий копирование второй части маркера.":::
   
> [!NOTE]
> Не включайте вопросительный знак при копировании любой части маркера.

### <a name="log-in-to-azure-and-select-a-subscription"></a>Войдите в Azure и выберите подписку.

Используйте следующий командлет PowerShell для входа в Azure:

```powershell
Login-AzAccount
```

Выберите подходящую подписку, в которой находится управляемый экземпляр, с помощью следующего командлета PowerShell:

```powershell
Select-AzSubscription -SubscriptionId <subscription ID>
```

## <a name="start-the-migration"></a>Начало миграции

Начать миграцию можно с запуска LRS. Службу можно запустить в автозаполнении или непрерывном режиме. 

При использовании режима автозаполнения миграция будет завершена автоматически при восстановлении последней из указанных файлов резервной копии. Для этого параметра требуется команда Start, чтобы указать имя файла последнего файла резервной копии. 

При использовании непрерывного режима служба постоянно восстанавливает все новые файлы резервных копий, которые были добавлены. Миграция будет завершена только в ручном прямую миграцию. 

### <a name="start-lrs-in-autocomplete-mode"></a>Запуск LRS в режиме автозаполнения

Чтобы запустить LRS в режиме автозаполнения, используйте следующие команды PowerShell или Azure CLI. Укажите имя последнего файла резервной копии с помощью `-LastBackupName` параметра. После восстановления последней из указанных файлов резервной копии служба автоматически запустит прямую миграцию.

Ниже приведен пример запуска LRS в режиме автозаполнения с помощью PowerShell:

```PowerShell
Start-AzSqlInstanceDatabaseLogReplay -ResourceGroupName "ResourceGroup01" `
    -InstanceName "ManagedInstance01" `
    -Name "ManagedDatabaseName" `
    -Collation "SQL_Latin1_General_CP1_CI_AS" `
    -StorageContainerUri "https://<mystorageaccountname>.blob.core.windows.net/<mycontainername>" `
    -StorageContainerSasToken "sv=2019-02-02&ss=b&srt=sco&sp=rl&se=2023-12-02T00:09:14Z&st=2019-11-25T16:09:14Z&spr=https&sig=92kAe4QYmXaht%2Fgjocqwerqwer41s%3D" `
    -AutoCompleteRestore `
    -LastBackupName "last_backup.bak"
```

Ниже приведен пример запуска LRS в режиме автозаполнения с помощью Azure CLI:

```CLI
az sql midb log-replay start -g mygroup --mi myinstance -n mymanageddb -a --last-bn "backup.bak"
    --storage-uri "https://<mystorageaccountname>.blob.core.windows.net/<mycontainername>"
    --storage-sas "sv=2019-02-02&ss=b&srt=sco&sp=rl&se=2023-12-02T00:09:14Z&st=2019-11-25T16:09:14Z&spr=https&sig=92kAe4QYmXaht%2Fgjocqwerqwer41s%3D"
```

### <a name="start-lrs-in-continuous-mode"></a>Запуск LRS в непрерывном режиме

Ниже приведен пример запуска LRS в непрерывном режиме с помощью PowerShell:

```PowerShell
Start-AzSqlInstanceDatabaseLogReplay -ResourceGroupName "ResourceGroup01" `
    -InstanceName "ManagedInstance01" `
    -Name "ManagedDatabaseName" `
    -Collation "SQL_Latin1_General_CP1_CI_AS" -StorageContainerUri "https://<mystorageaccountname>.blob.core.windows.net/<mycontainername>" `
    -StorageContainerSasToken "sv=2019-02-02&ss=b&srt=sco&sp=rl&se=2023-12-02T00:09:14Z&st=2019-11-25T16:09:14Z&spr=https&sig=92kAe4QYmXaht%2Fgjocqwerqwer41s%3D"
```

Ниже приведен пример запуска LRS в непрерывном режиме с помощью Azure CLI.

```CLI
az sql midb log-replay start -g mygroup --mi myinstance -n mymanageddb
    --storage-uri "https://<mystorageaccountname>.blob.core.windows.net/<mycontainername>"
    --storage-sas "sv=2019-02-02&ss=b&srt=sco&sp=rl&se=2023-12-02T00:09:14Z&st=2019-11-25T16:09:14Z&spr=https&sig=92kAe4QYmXaht%2Fgjocqwerqwer41s%3D"
```

Клиенты PowerShell и CLI для запуска LRS в непрерывном режиме являются синхронными. Это означает, что клиенты будут ждать, пока ответ API сообщит об успешном или неудачном запуске задания. 

В ходе этого ожидания команда не будет возвращать управление командной строке. Если вы создаете скрипт для процесса миграции и вам нужна команда LRS Start, чтобы немедленно вернуть управление к остальной части скрипта, можно запустить PowerShell как фоновое задание с `-AsJob` параметром. Пример:

```PowerShell
$lrsjob = Start-AzSqlInstanceDatabaseLogReplay <required parameters> -AsJob
```

При запуске фонового задания объект задания возвращается немедленно, даже если для завершения задания требуется дополнительное время. Пока задание выполняется, можно продолжать работу с данным сеансом. Дополнительные сведения о запуске PowerShell в качестве фонового задания см. в документации по [началу работы с PowerShell](/powershell/module/microsoft.powershell.core/start-job#description) .

Аналогично, чтобы запустить команду Azure CLI в Linux в качестве фонового процесса, используйте амперсанд ( `&` ) в конце команды LRS Start:

```CLI
az sql midb log-replay start <required parameters> &
```

> [!IMPORTANT]
> После запуска LRS все обновления программного обеспечения, управляемые системой, будут остановлены в течение 47 часов. После выполнения этого окна следующее автоматическое исправление программного обеспечения автоматически останавливает LRS. В таком случае вы не сможете возобновить миграцию и перезапустить ее с нуля. 

## <a name="monitor-the-migration-progress"></a>Мониторинг хода выполнения миграции

Чтобы отслеживать ход выполнения миграции с помощью PowerShell, используйте следующую команду:

```PowerShell
Get-AzSqlInstanceDatabaseLogReplay -ResourceGroupName "ResourceGroup01" `
    -InstanceName "ManagedInstance01" `
    -Name "ManagedDatabaseName"
```

Чтобы отслеживать ход выполнения миграции с помощью Azure CLI, используйте следующую команду:

```CLI
az sql midb log-replay show -g mygroup --mi myinstance -n mymanageddb
```

## <a name="stop-the-migration"></a>Завершение миграции

Если необходимо прерывать миграцию, используйте следующие командлеты. Остановка миграции приведет к удалению восстановления базы данных на Управляемый экземпляр SQL, поэтому возобновление миграции будет невозможно.

Чтобы прерывать процесс миграции с помощью PowerShell, используйте следующую команду:

```PowerShell
Stop-AzSqlInstanceDatabaseLogReplay -ResourceGroupName "ResourceGroup01" `
    -InstanceName "ManagedInstance01" `
    -Name "ManagedDatabaseName"
```

Чтобы прерывать процесс миграции с помощью Azure CLI, используйте следующую команду:

```CLI
az sql midb log-replay stop -g mygroup --mi myinstance -n mymanageddb
```

## <a name="complete-the-migration-continuous-mode"></a>Завершение миграции (непрерывный режим)

Если вы начали LRS в непрерывном режиме, то после того, как убедитесь, что все резервные копии восстановлены, запуск прямую миграцию завершит миграцию. После прямую миграцию база данных будет перенесена и готова к доступу на чтение и запись.

Чтобы завершить процесс миграции в LRS непрерывном режиме с помощью PowerShell, используйте следующую команду:

```PowerShell
Complete-AzSqlInstanceDatabaseLogReplay -ResourceGroupName "ResourceGroup01" `
-InstanceName "ManagedInstance01" `
-Name "ManagedDatabaseName" `
-LastBackupName "last_backup.bak"
```

Чтобы завершить процесс миграции в LRS непрерывном режиме с помощью Azure CLI, используйте следующую команду:

```CLI
az sql midb log-replay complete -g mygroup --mi myinstance -n mymanageddb --last-backup-name "backup.bak"
```

## <a name="functional-limitations"></a>Ограничения функциональных возможностей

Функциональные ограничения LRS:
- Базу данных, которую вы восстанавливаете, нельзя использовать в процессе миграции для доступа только для чтения.
- Обновления программного обеспечения, управляемые системой, блокируются в течение 47 часов после запуска LRS. После истечения срока действия этого временного интервала следующее обновление программного обеспечения перестанет LRS. После этого необходимо перезапустить LRS с нуля.
- Для LRS требуется включить резервное копирование баз данных на SQL Server с `CHECKSUM` включенным параметром.
- Токен SAS, который будет использоваться LRS, должен быть создан для всего контейнера хранилища BLOB-объектов Azure. он должен иметь только разрешения на чтение и перечисление.
- Файлы резервных копий для разных баз данных должны размещаться в отдельных папках в хранилище BLOB-объектов.
- LRS должен быть запущен отдельно для каждой базы данных, которая указывает на отдельные папки с файлами резервных копий в хранилище BLOB-объектов.
- LRS может поддерживать до 100 процессов одновременного восстановления на один управляемый экземпляр.

## <a name="troubleshooting"></a>Устранение неполадок

После запуска LRS используйте командлет Monitoring ( `get-azsqlinstancedatabaselogreplay` или), `az_sql_midb_log_replay_show` чтобы просмотреть состояние операции. Если LRS не удается запустить через некоторое время и появится сообщение об ошибке, проверьте наличие наиболее распространенных проблем.

- Совпадает ли имя существующей базы данных на SQL Управляемый экземпляр с именем, которое вы пытаетесь перенести из SQL Server? Устраните этот конфликт, переименовав одну из баз данных.
- Была ли резервная копия базы данных SQL Server сделана с помощью `CHECKSUM` параметра?
- Являются ли разрешения маркера SAS только чтением и списком для LRS?
- Вы скопировали маркер SAS для LRS после вопросительного знака ( `?` ) с содержимым, начинающимся следующим образом: `sv=2020-02-10...` ? 
- Допустимо ли время действия маркера SAS для временного интервала запуска и завершения миграции? Могут возникнуть несоответствия из-за различных часовых поясов, используемых для Управляемый экземпляр SQL и маркера SAS. Попробуйте повторно создать маркер SAS и продлить срок действия маркера временного окна до и после текущей даты.
- Правильно ли написано имя базы данных, имя группы ресурсов и имя управляемого экземпляра?
- Если LRS запущен в режиме автозаполнения, было ли указано допустимое имя для последнего файла резервной копии?

## <a name="next-steps"></a>Дальнейшие действия
- Дополнительные сведения о [миграции SQL Server в управляемый экземпляр SQL](../migration-guides/managed-instance/sql-server-to-managed-instance-guide.md).
- Дополнительные сведения о [различиях между SQL Server и управляемый экземпляр SQL](transact-sql-tsql-differences-sql-server.md).
- Узнайте больше о [рекомендациях по затратам и размеру рабочих нагрузок, перенесенных в Azure](/azure/cloud-adoption-framework/migrate/azure-best-practices/migrate-best-practices-costs).
