---
title: Настройка общедоступной конечной точки — Управляемый экземпляр Azure SQL
description: Узнайте, как настроить общедоступную конечную точку для Azure SQL Управляемый экземпляр
services: sql-database
ms.service: sql-managed-instance
ms.subservice: security
ms.custom: sqldbrb=1
ms.topic: how-to
author: srdan-bozovic-msft
ms.author: srbozovi
ms.reviewer: vanto, sstein
ms.date: 02/08/2021
ms.openlocfilehash: 7d5f40be895aea26a234d9ae622aa5bf22528231
ms.sourcegitcommit: 706e7d3eaa27f242312d3d8e3ff072d2ae685956
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/09/2021
ms.locfileid: "99981448"
---
# <a name="configure-public-endpoint-in-azure-sql-managed-instance"></a>Configure public endpoint in Azure SQL Managed Instance (Настройка общедоступной конечной точки в управляемом экземпляре SQL Azure)
[!INCLUDE[appliesto-sqlmi](../includes/appliesto-sqlmi.md)]

Общедоступная конечная точка для [управляемого экземпляра](./sql-managed-instance-paas-overview.md) обеспечивает доступ к данным управляемого экземпляра извне [виртуальной сети](../../virtual-network/virtual-networks-overview.md). Вы можете получить доступ к управляемому экземпляру из нескольких клиентов Azure, таких как Power BI, служба приложений Azure или локальная сеть. Используя общедоступную конечную точку на управляемом экземпляре, не нужно использовать VPN, что может помочь избежать проблем с пропускной способностью VPN.

В этой статье вы узнаете, как выполнять следующие задачи.

> [!div class="checklist"]
>
> - Включите общедоступную конечную точку для управляемого экземпляра в портал Azure
> - Включение общедоступной конечной точки для управляемого экземпляра с помощью PowerShell
> - Настройка группы безопасности сети управляемого экземпляра для разрешения трафика в общедоступную конечную точку управляемого экземпляра
> - Получение строки подключения общедоступной конечной точки управляемого экземпляра

## <a name="permissions"></a>Разрешения

Из-за чувствительности данных, которые находятся в управляемом экземпляре, в конфигурации для включения общедоступной конечной точки управляемого экземпляра требуется двухэтапный процесс. Эта мера безопасности соответствует разделению обязанностей (разделения обязанностей):

- Включение общедоступной конечной точки в управляемом экземпляре должно осуществляться администратором управляемого экземпляра. Администратор управляемого экземпляра можно найти на странице **обзора** ресурса управляемого экземпляра.
- Разрешение трафика с помощью группы безопасности сети, которая должна выполняться администратором сети. Дополнительные сведения см. в разделе [разрешения группы безопасности сети](../../virtual-network/manage-network-security-group.md#permissions).

## <a name="enabling-public-endpoint-for-a-managed-instance-in-the-azure-portal"></a>Включение общедоступной конечной точки для управляемого экземпляра в портал Azure

1. Запустите портал Azure по адресу <https://portal.azure.com/.>
1. Откройте группу ресурсов с управляемым экземпляром и выберите **управляемый экземпляр SQL** , для которого требуется настроить общедоступную конечную точку.
1. В окне Параметры **безопасности** перейдите на вкладку **Виртуальная сеть** .
1. На странице Конфигурация виртуальной сети выберите **включить** , а затем значок **сохранить** , чтобы обновить конфигурацию.

![На снимке экрана показана страница виртуальной сети управляемого экземпляра SQL с включенной общедоступной конечной точкой.](./media/public-endpoint-configure/mi-vnet-config.png)

## <a name="enabling-public-endpoint-for-a-managed-instance-using-powershell"></a>Включение общедоступной конечной точки для управляемого экземпляра с помощью PowerShell

### <a name="enable-public-endpoint"></a>Включение общедоступной конечной точки

Выполните приведенные ниже команды PowerShell. Замените **Subscription-ID** своим идентификатором подписки. Также замените **RG-Name** группой ресурсов для управляемого экземпляра и замените **MI-Name** именем управляемого экземпляра.

```powershell
Install-Module -Name Az

Import-Module Az.Accounts
Import-Module Az.Sql

Connect-AzAccount

# Use your subscription ID in place of subscription-id below

Select-AzSubscription -SubscriptionId {subscription-id}

# Replace rg-name with the resource group for your managed instance, and replace mi-name with the name of your managed instance

$mi = Get-AzSqlInstance -ResourceGroupName {rg-name} -Name {mi-name}

$mi = $mi | Set-AzSqlInstance -PublicDataEndpointEnabled $true -force
```

### <a name="disable-public-endpoint"></a>Отключить общедоступную конечную точку

Чтобы отключить общедоступную конечную точку с помощью PowerShell, выполните следующую команду (а также не забудьте закрыть NSG для входящего порта 3342, если он настроен):

```powershell
Set-AzSqlInstance -PublicDataEndpointEnabled $false -force
```

## <a name="allow-public-endpoint-traffic-on-the-network-security-group"></a>Разрешить трафик общедоступной конечной точки в группе безопасности сети

1. Если страница Конфигурация управляемого экземпляра по-прежнему открыта, перейдите на вкладку **Обзор** . В противном случае вернитесь к ресурсу **управляемого экземпляра SQL** . Выберите ссылку **Виртуальная сеть или подсеть** , чтобы перейти на страницу конфигурации виртуальной сети.

    ![На снимке экрана показана страница конфигурации виртуальной сети, на которой можно найти значение виртуальной сети или подсети.](./media/public-endpoint-configure/mi-overview.png)

1. Выберите вкладку **подсети** в левой области конфигурации виртуальной сети и запишите **группу безопасности** для управляемого экземпляра.

    ![На снимке экрана показана вкладка подсеть, на которой можно получить группу безопасности для управляемого экземпляра.](./media/public-endpoint-configure/mi-vnet-subnet.png)

1. Вернитесь к группе ресурсов, содержащей управляемый экземпляр. Вы должны увидеть имя **группы безопасности сети** , указанное выше. Выберите имя для перехода на страницу Конфигурация группы безопасности сети.

1. Перейдите на вкладку **правила безопасности для входящего трафика** и **добавьте** правило с более высоким приоритетом, чем правило **deny_all_inbound** со следующими параметрами. </br> </br>

    |Параметр  |Рекомендуемое значение  |Описание  |
    |---------|---------|---------|
    |**Источник**     |Любой IP-адрес или тег службы         |<ul><li>Для служб Azure, таких как Power BI, выберите тег облачной службы Azure.</li> <li>Для компьютера или виртуальной машины Azure используйте IP-адрес NAT.</li></ul> |
    |**Диапазоны исходных портов**     |* |Оставьте это значение равным * (Any), так как порты источника обычно выделяются динамически и, как таковые, непредсказуемые. |
    |**Назначение**     |Любой         |Запрет места назначения в качестве любого, чтобы разрешить трафик в подсеть управляемого экземпляра |
    |**Диапазоны портов назначения**     |3342         |Порт назначения области 3342, который является общедоступной конечной точкой TDS управляемого экземпляра. |
    |**протокол**;     |TCP         |SQL Управляемый экземпляр использует протокол TCP для TDS |
    |**Действие**     |Allow         |Разрешить входящий трафик к управляемому экземпляру через общедоступную конечную точку |
    |**Приоритет**     |1300         |Убедитесь, что это правило имеет более высокий приоритет, чем правило **deny_all_inbound** |

    ![На снимке экрана показаны правила безопасности для входящего трафика с новым правилом public_endpoint_inbound над правилом deny_all_inbound.](./media/public-endpoint-configure/mi-nsg-rules.png)

    > [!NOTE]
    > Порт 3342 используется для подключений к общедоступной конечной точке к управляемому экземпляру и не может быть изменен на этом этапе.

## <a name="obtaining-the-managed-instance-public-endpoint-connection-string"></a>Получение строки подключения общедоступной конечной точки управляемого экземпляра

1. Перейдите на страницу "Конфигурация управляемого экземпляра", для которой была включена общедоступная конечная точка. Перейдите на вкладку **строки подключения** в разделе Конфигурация **параметров** .
1. Обратите внимание, что имя узла общедоступной конечной точки имеет формат <mi_name>. **Public**. <dns_zone>. Database.Windows.NET и порт, используемый для соединения, — 3342. Ниже приведен пример значения сервера строки подключения, которое обозначает порт общедоступной конечной точки, который можно использовать в SQL Server Management Studio или Azure Data Studioных соединениях: `<mi_name>.public.<dns_zone>.database.windows.net,3342`

    ![На снимке экрана показаны строки подключения для общедоступных и частных конечных точек.](./media/public-endpoint-configure/mi-public-endpoint-conn-string.png)

## <a name="next-steps"></a>Дальнейшие действия

Узнайте, как [безопасно использовать Azure SQL управляемый экземпляр с общедоступной конечной точкой](public-endpoint-overview.md).
