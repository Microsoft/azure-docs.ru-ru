---
title: Архитектура подключения
titleSuffix: Azure SQL Managed Instance
description: Узнайте о архитектуре связи и подключения Управляемый экземпляр Azure SQL, а также о том, как компоненты направляют трафик на управляемый экземпляр.
services: sql-database
ms.service: sql-managed-instance
ms.subservice: operations
ms.custom: fasttrack-edit
ms.devlang: ''
ms.topic: conceptual
author: srdan-bozovic-msft
ms.author: srbozovi
ms.reviewer: sstein, bonova
ms.date: 10/22/2020
ms.openlocfilehash: 58563629b30e7be764732a9810162e1a0b1931e6
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "98725842"
---
# <a name="connectivity-architecture-for-azure-sql-managed-instance"></a>Архитектура подключения к Управляемому экземпляру SQL Azure
[!INCLUDE[appliesto-sqlmi](../includes/appliesto-sqlmi.md)]

В этой статье объясняется, как осуществляется обмен данными в Azure SQL Управляемый экземпляр. Он также описывает архитектуру подключения и то, как компоненты направляют трафик в управляемый экземпляр.  

Управляемый экземпляр SQL размещается в виртуальной сети Azure и подсети, выделенной для управляемых экземпляров. Это развертывание предоставляет следующие сведения.

- Защищенный частный IP-адрес.
- Возможность подключения локальной сети к SQL Управляемый экземпляр.
- Возможность подключения Управляемый экземпляр SQL к связанному серверу или другому локальному хранилищу данных.
- Возможность подключения Управляемый экземпляр SQL к ресурсам Azure.

## <a name="communication-overview"></a>Общие сведения об обмене данными

На следующей диаграмме показаны сущности, подключающиеся к SQL Управляемый экземпляр. Здесь также показаны ресурсы, необходимые для взаимодействия с управляемым экземпляром. Процесс связи в нижней части схемы представляет приложения и средства клиента, подключающиеся к SQL Управляемый экземпляр в качестве источников данных.  

![Сущности в архитектуре подключения](./media/connectivity-architecture-overview/connectivityarch001.png)

SQL Управляемый экземпляр — это предложение "платформа как услуга" (PaaS). Azure использует автоматические агенты (управление, развертывание и обслуживание) для управления этой службой на основе потоков данных телеметрии. Так как Azure отвечает за управление, клиенты не могут получить доступ к виртуальным машинам SQL Управляемый экземпляр с помощью протокол удаленного рабочего стола (RDP).

Для взаимодействия с платформой некоторые операции, запущенные конечными пользователями или приложениями, могут потребовать SQL Управляемый экземпляр. Один из вариантов — создание базы данных SQL Управляемый экземпляр. Этот ресурс предоставляется через портал Azure, PowerShell, Azure CLI и REST API.

SQL Управляемый экземпляр зависит от служб Azure, таких как хранилище Azure для резервного копирования, концентраторов событий Azure для телеметрии, Azure Active Directory (Azure AD) для проверки подлинности, Azure Key Vault для прозрачное шифрование данных (TDE) и нескольких служб платформы Azure, предоставляющих функции обеспечения безопасности и поддержки. SQL Управляемый экземпляр устанавливает подключения к этим службам.

Все взаимодействия шифруются и подписываются с использованием сертификатов. Чтобы проверить надежность взаимодействующих сторон, SQL Управляемый экземпляр постоянно проверяет эти сертификаты с помощью списков отзыва сертификатов. Если сертификаты отозваны, SQL Управляемый экземпляр закрывает подключения для защиты данных.

## <a name="high-level-connectivity-architecture"></a>Высокоуровневая архитектура подключения

На высоком уровне SQL Управляемый экземпляр — это набор компонентов службы. Эти компоненты размещаются на выделенном наборе изолированных виртуальных машин, которые выполняются внутри подсети клиента. Эти компьютеры формируют виртуальный кластер.

В виртуальном кластере может размещаться несколько управляемых экземпляров. При необходимости кластер автоматически развертывает или отменяет контракты, когда клиент изменяет число подготовленных экземпляров в подсети.

Клиентские приложения могут подключаться к SQL Управляемый экземпляр и выполнять запросы и обновлять базы данных в виртуальной сети, в одноранговой виртуальной сети или в сети, подключенной через VPN или Azure ExpressRoute. Эта сеть должна использовать конечную точку и частный IP-адрес.  

![Схема архитектуры подключения](./media/connectivity-architecture-overview/connectivityarch002.png)

Службы управления и развертывания Azure выполняются за пределами виртуальной сети. SQL Управляемый экземпляр и службы Azure подключаются через конечные точки, имеющие общедоступные IP-адреса. Когда SQL Управляемый экземпляр создает исходящее подключение, в результате преобразования адресов исходящей сети (NAT) подключение будет выглядеть так, как оно поступает от этого общедоступного IP-адреса.

Трафик управления проходит через виртуальную сеть клиента. Это означает, что элементы инфраструктуры виртуальной сети могут повредить трафик управления, делая его недоступным и перестало работать.

> [!IMPORTANT]
> Для повышения эффективности работы клиентов и доступности служб Azure применяет политику намерения к сети в элементах инфраструктуры виртуальной сети Azure. Политика может повлиять на работу SQL Управляемый экземпляр. Этот механизм платформы прозрачно передает пользователям требования к сети. Основная цель политики — предотвратить неправильное конфигурирование сети и обеспечить нормальные операции SQL Управляемый экземпляр. При удалении управляемого экземпляра также удаляется политика намерения к сети.

## <a name="virtual-cluster-connectivity-architecture"></a>Архитектура подключения виртуального кластера

Давайте подробнее рассмотрим архитектуру подключения для Управляемый экземпляр SQL. На схеме ниже показан концептуальной макет виртуального кластера.

![Архитектура подключения виртуального кластера](./media/connectivity-architecture-overview/connectivityarch003.png)

Клиенты подключаются к SQL Управляемый экземпляр с помощью имени узла, имеющего форму `<mi_name>.<dns_zone>.database.windows.net` . Это имя узла разрешается в частный IP-адрес, хотя он регистрируется в общедоступной DNS-зоне и является общедоступным. `zone-id`Автоматически создается при создании кластера. Если в созданном кластере размещен вторичный управляемый экземпляр, его идентификатор зоны будет совместно с основным кластером. Дополнительные сведения см. [в разделе Использование групп автоматической отработки отказа для включения прозрачной и координированной отработки отказа нескольких баз данных](../database/auto-failover-group-overview.md#enabling-geo-replication-between-managed-instances-and-their-vnets).

Этот частный IP-адрес принадлежит внутренней подсистеме балансировки нагрузки для SQL Управляемый экземпляр. Балансировщик нагрузки направляет трафик в шлюз SQL Управляемый экземпляр. Поскольку несколько управляемых экземпляров могут работать в одном кластере, шлюз использует имя узла Управляемый экземпляр SQL, чтобы перенаправить трафик в правильную службу ядра SQL.

Службы управления и развертывания подключаются к SQL Управляемый экземпляр с помощью [конечной точки управления](#management-endpoint) , сопоставленной с внешней подсистемой балансировки нагрузки. Трафик направляется на узлы, только если он получен на предопределенном наборе портов, которые используются только компонентами управления SQL Управляемый экземпляр. Встроенный брандмауэр на узлах настроен на разрешение трафика только из диапазонов IP-адресов Майкрософт. Сертификаты взаимно проходят проверку подлинности всего обмена данными между компонентами управления и плоскостью управления.

## <a name="management-endpoint"></a>Конечная точка управления

Azure управляет Управляемый экземпляр SQL с помощью конечной точки управления. Эта конечная точка находится внутри виртуального кластера экземпляра. Конечная точка управления защищена встроенным брандмауэром на уровне сети. На уровне приложения он защищен взаимной проверкой сертификатов. Чтобы найти IP-адрес конечной точки, см. раздел [Определение IP-адреса конечной точки управления](management-endpoint-find-ip-address.md).

При запуске подключений в SQL Управляемый экземпляр (как и в случае резервного копирования и журналов аудита) трафик запускается с общедоступного IP-адреса конечной точки управления. Можно ограничить доступ к общедоступным службам из Управляемый экземпляр SQL, установив правила брандмауэра, разрешающие только IP-адрес для Управляемый экземпляр SQL. Дополнительные сведения см. [в разделе Проверка встроенного брандмауэра SQL управляемый экземпляр](management-endpoint-verify-built-in-firewall.md).

> [!NOTE]
> Трафик, переходящий в службы Azure в регионе SQL Управляемый экземпляр, оптимизирован и по этой причине не заносятся в общедоступный IP-адрес для конечной точки управления. По этой причине, если необходимо использовать правила брандмауэра на основе IP-адресов, чаще всего для хранилища, служба должна находиться в другом регионе, отличном от Управляемый экземпляр SQL.

## <a name="service-aided-subnet-configuration"></a>Автоматизированное управление конфигурацией подсети в службе

Чтобы устранить требования к безопасности и управлению клиентами, SQL Управляемый экземпляр переходит от ручной к конфигурации подсети с поддержкой служб.

С помощью конфигурации подсети, разступающих от службы, пользователь получает полный контроль над трафиком данных (TDS), в то время как SQL Управляемый экземпляр отвечает за обеспечение непрерывного потока управления для выполнения соглашения об уровне обслуживания.

Конфигурация подсети с разавтоматизированными службами строится на основе функции [делегирования подсети](../../virtual-network/subnet-delegation-overview.md) виртуальной сети, чтобы обеспечить автоматическое управление конфигурацией сети и включить конечные точки служб. 

Конечные точки службы можно использовать для настройки правил брандмауэра виртуальной сети в учетных записях хранения, которые хранят резервные копии и журналы аудита. Даже если включены конечные точки службы, клиентам рекомендуется использовать [закрытую ссылку](../../private-link/private-link-overview.md) , которая обеспечивает дополнительную безопасность для конечных точек служб.

> [!IMPORTANT]
> Из-за особенностей конфигурации плоскости управления конфигурация подсетей с независимыми службами не включает конечные точки службы в национальных облаках. 

### <a name="network-requirements"></a>Требования к сети

Развертывание Управляемый экземпляр SQL в выделенной подсети в виртуальной сети. Подсеть должна иметь следующие характеристики:

- **Выделенная подсеть:** Подсеть SQL Управляемый экземпляр не может содержать связанную с ней облачную службу, которая не может быть подсетью шлюза. Подсеть не может содержать ресурсы, но Управляемый экземпляр SQL, и позднее добавить другие типы ресурсов в подсеть невозможно.
- **Делегирование подсети:** Подсеть SQL Управляемый экземпляр должна быть делегирована `Microsoft.Sql/managedInstances` поставщику ресурсов.
- **Группа безопасности сети (NSG):** NSG необходимо связать с подсетью SQL Управляемый экземпляр. NSG можно использовать для управления доступом к конечной точке данных SQL Управляемый экземпляр путем фильтрации трафика через порт 1433 и порты 11000-11999, если SQL Управляемый экземпляр настроен для подключений перенаправления. Служба автоматически подготавливает и сохраняет текущие [правила](#mandatory-inbound-security-rules-with-service-aided-subnet-configuration) , необходимые, чтобы разрешить непрерывный поток трафика управления.
- **Таблица определяемого пользователем маршрута (UDR):** UDR таблица должна быть связана с подсетью SQL Управляемый экземпляр. Вы можете добавить записи в таблицу маршрутизации для маршрутизации трафика с локальными частными диапазонами IP-адресов в качестве назначения через шлюз виртуальной сети или виртуальное сетевое устройство (NVA). Служба автоматически подготовит и сохранит текущие [записи](#user-defined-routes-with-service-aided-subnet-configuration), необходимые для обеспечения непрерывного потока трафика управления.
- **Достаточное количество IP-адресов:** Подсеть SQL Управляемый экземпляр должна иметь по крайней мере 32 IP-адресов. Дополнительные сведения см. [в разделе Определение размера подсети для управляемый экземпляр SQL](vnet-subnet-determine-size.md). Вы можете развернуть управляемые экземпляры в [существующей сети](vnet-existing-add-subnet.md) после ее настройки в соответствии [с требованиями к сети для управляемый экземпляр SQL](#network-requirements). В противном случае создайте [сеть и подсеть](virtual-network-subnet-create-arm-template.md).

> [!IMPORTANT]
> При создании управляемого экземпляра в подсети применяется политика намерения к сети, чтобы предотвратить несоответствующие изменения в настройке сети. После удаления последнего экземпляра из подсети политика с намерением к сети также удаляется. Приведенные ниже правила предназначены только для информационных целей, и их не следует развертывать с помощью шаблона ARM, PowerShell или CLI. Если вы хотите использовать последний официальный шаблон, его всегда можно [получить на портале](../../azure-resource-manager/templates/quickstart-create-templates-use-the-portal.md).

### <a name="mandatory-inbound-security-rules-with-service-aided-subnet-configuration"></a>Обязательные правила безопасности для входящего трафика с конфигурацией подсети с разавтоматизированной службой

| Имя       |Порт                        |Протокол|Источник           |Назначение|Действие|
|------------|----------------------------|--------|-----------------|-----------|------|
|управление  |9000, 9003, 1438, 1440, 1452|TCP     |SqlManagement    |MI SUBNET  |Allow |
|            |9000, 9003                  |TCP     |корпнетсав       |MI SUBNET  |Allow |
|            |9000, 9003                  |TCP     |корпнетпублик    |MI SUBNET  |Allow |
|mi_subnet   |Любой                         |Любой     |MI SUBNET        |MI SUBNET  |Allow |
|health_probe|Любой                         |Любой     |AzureLoadBalancer|MI SUBNET  |Allow |

### <a name="mandatory-outbound-security-rules-with-service-aided-subnet-configuration"></a>Обязательные правила безопасности для исходящего трафика с конфигурацией подсети с разавтоматизированной службой

| Имя       |Порт          |Протокол|Источник           |Назначение|Действие|
|------------|--------------|--------|-----------------|-----------|------|
|управление  |443, 12000    |TCP     |MI SUBNET        |AzureCloud; |Allow |
|mi_subnet   |Любой           |Любой     |MI SUBNET        |MI SUBNET  |Allow |

### <a name="user-defined-routes-with-service-aided-subnet-configuration"></a>Определяемые пользователем маршруты с конфигурацией подсети с разавтоматизированной службой

|Имя|Префикс адреса|Следующий прыжок|
|----|--------------|-------|
|подсеть — vnetlocal|MI SUBNET|Виртуальная сеть|
|Mi-13-64-11-NextHop-Internet|13.64.0.0/11|Интернет|
|Mi-13-104-14-NextHop-Internet|13.104.0.0/14|Интернет|
|Mi-20-33-16-NextHop-Internet|20.33.0.0/16|Интернет|
|Mi-20-34-15-NextHop-Internet|20.34.0.0/15|Интернет|
|Mi-20-36-14-NextHop-Internet|20.36.0.0/14|Интернет|
|Mi-20-40-13-NextHop-Internet|20.40.0.0/13|Интернет|
|Mi-20-48-12-NextHop-Internet|20.48.0.0/12|Интернет|
|Mi-20-64-10-NextHop-Internet|20.64.0.0/10|Интернет|
|Mi-20-128-16-NextHop-Internet|20.128.0.0/16|Интернет|
|Mi-20-135-16-NextHop-Internet|20.135.0.0/16|Интернет|
|Mi-20-136-16-NextHop-Internet|20.136.0.0/16|Интернет|
|Mi-20-140-15-NextHop-Internet|20.140.0.0/15|Интернет|
|Mi-20-143-16-NextHop-Internet|20.143.0.0/16|Интернет|
|Mi-20-144-14-NextHop-Internet|20.144.0.0/14|Интернет|
|Mi-20-150-15-NextHop-Internet|20.150.0.0/15|Интернет|
|Mi-20-160-12-NextHop-Internet|20.160.0.0/12|Интернет|
|Mi-20-176-14-NextHop-Internet|20.176.0.0/14|Интернет|
|Mi-20-180-14-NextHop-Internet|20.180.0.0/14|Интернет|
|Mi-20-184-13-NextHop-Internet|20.184.0.0/13|Интернет|
|Mi-20-192-10-NextHop-Internet|20.192.0.0/10|Интернет|
|Mi-40-64-10-NextHop-Internet|40.64.0.0/10|Интернет|
|Mi-51-4-15-NextHop-Internet|51.4.0.0/15|Интернет|
|Mi-51-8-16-NextHop-Internet|51.8.0.0/16|Интернет|
|Mi-51-10-15-NextHop-Internet|51.10.0.0/15|Интернет|
|Mi-51-18-16-NextHop-Internet|51.18.0.0/16|Интернет|
|Mi-51-51-16-NextHop-Internet|51.51.0.0/16|Интернет|
|Mi-51-53-16-NextHop-Internet|51.53.0.0/16|Интернет|
|Mi-51-103-16-NextHop-Internet|51.103.0.0/16|Интернет|
|Mi-51-104-15-NextHop-Internet|51.104.0.0/15|Интернет|
|Mi-51-132-16-NextHop-Internet|51.132.0.0/16|Интернет|
|Mi-51-136-15-NextHop-Internet|51.136.0.0/15|Интернет|
|Mi-51-138-16-NextHop-Internet|51.138.0.0/16|Интернет|
|Mi-51-140-14-NextHop-Internet|51.140.0.0/14|Интернет|
|Mi-51-144-15-NextHop-Internet|51.144.0.0/15|Интернет|
|Mi-52-96-12-NextHop-Internet|52.96.0.0/12|Интернет|
|Mi-52-112-14-NextHop-Internet|52.112.0.0/14|Интернет|
|Mi-52-125-16-NextHop-Internet|52.125.0.0/16|Интернет|
|Mi-52-126-15-NextHop-Internet|52.126.0.0/15|Интернет|
|Mi-52-130-15-NextHop-Internet|52.130.0.0/15|Интернет|
|Mi-52-132-14-NextHop-Internet|52.132.0.0/14|Интернет|
|Mi-52-136-13-NextHop-Internet|52.136.0.0/13|Интернет|
|Mi-52-145-16-NextHop-Internet|52.145.0.0/16|Интернет|
|Mi-52-146-15-NextHop-Internet|52.146.0.0/15|Интернет|
|Mi-52-148-14-NextHop-Internet|52.148.0.0/14|Интернет|
|Mi-52-152-13-NextHop-Internet|52.152.0.0/13|Интернет|
|Mi-52-160-11-NextHop-Internet|52.160.0.0/11|Интернет|
|Mi-52-224-11-NextHop-Internet|52.224.0.0/11|Интернет|
|Mi-64-4-18-NextHop-Internet|64.4.0.0/18|Интернет|
|Mi-65-52-14-NextHop-Internet|65.52.0.0/14|Интернет|
|Mi-66-119-144-20-NextHop-Internet|66.119.144.0/20|Интернет|
|Mi-70-37-17-NextHop-Internet|70.37.0.0/17|Интернет|
|Mi-70-37-128-18-NextHop-Internet|70.37.128.0/18|Интернет|
|Mi-91-190-216-21-NextHop-Internet|91.190.216.0/21|Интернет|
|Mi-94-245-64-18-NextHop-Internet|94.245.64.0/18|Интернет|
|Mi-103-9-8-22-NextHop-Internet|103.9.8.0/22|Интернет|
|Mi-103-25-156-24-NextHop-Internet|103.25.156.0/24|Интернет|
|Mi-103-25-157-24-NextHop-Internet|103.25.157.0/24|Интернет|
|Mi-103-25-158-23-NextHop-Internet|103.25.158.0/23|Интернет|
|Mi-103-36-96-22-NextHop-Internet|103.36.96.0/22|Интернет|
|Mi-103-255-140-22-NextHop-Internet|103.255.140.0/22|Интернет|
|Mi-104-40-13-NextHop-Internet|104.40.0.0/13|Интернет|
|Mi-104-146-15-NextHop-Internet|104.146.0.0/15|Интернет|
|Mi-104-208-13-NextHop-Internet|104.208.0.0/13|Интернет|
|Mi-111-221-16-20-NextHop-Internet|111.221.16.0/20|Интернет|
|Mi-111-221-64-18-NextHop-Internet|111.221.64.0/18|Интернет|
|Mi-129-75-16-NextHop-Internet|129.75.0.0/16|Интернет|
|Mi-131-107-16-NextHop-Internet|131.107.0.0/16|Интернет|
|Mi-131-253-1-24-NextHop-Internet|131.253.1.0/24|Интернет|
|Mi-131-253-3-24-NextHop-Internet|131.253.3.0/24|Интернет|
|Mi-131-253-5-24-NextHop-Internet|131.253.5.0/24|Интернет|
|Mi-131-253-6-24-NextHop-Internet|131.253.6.0/24|Интернет|
|Mi-131-253-8-24-NextHop-Internet|131.253.8.0/24|Интернет|
|Mi-131-253-12-22-NextHop-Internet|131.253.12.0/22|Интернет|
|Mi-131-253-16-23-NextHop-Internet|131.253.16.0/23|Интернет|
|Mi-131-253-18-24-NextHop-Internet|131.253.18.0/24|Интернет|
|Mi-131-253-21-24-NextHop-Internet|131.253.21.0/24|Интернет|
|Mi-131-253-22-23-NextHop-Internet|131.253.22.0/23|Интернет|
|Mi-131-253-24-21-NextHop-Internet|131.253.24.0/21|Интернет|
|Mi-131-253-32-20-NextHop-Internet|131.253.32.0/20|Интернет|
|Mi-131-253-61-24-NextHop-Internet|131.253.61.0/24|Интернет|
|Mi-131-253-62-23-NextHop-Internet|131.253.62.0/23|Интернет|
|Mi-131-253-64-18-NextHop-Internet|131.253.64.0/18|Интернет|
|Mi-131-253-128-17-NextHop-Internet|131.253.128.0/17|Интернет|
|Mi-132-245-16-NextHop-Internet|132.245.0.0/16|Интернет|
|Mi-134-170-16-NextHop-Internet|134.170.0.0/16|Интернет|
|Mi-134-177-16-NextHop-Internet|134.177.0.0/16|Интернет|
|Mi-137-116-15-NextHop-Internet|137.116.0.0/15|Интернет|
|Mi-137-135-16-NextHop-Internet|137.135.0.0/16|Интернет|
|Mi-138-91-16-NextHop-Internet|138.91.0.0/16|Интернет|
|Mi-138-196-16-NextHop-Internet|138.196.0.0/16|Интернет|
|Mi-139-217-16-NextHop-Internet|139.217.0.0/16|Интернет|
|Mi-139-219-16-NextHop-Internet|139.219.0.0/16|Интернет|
|Mi-141-251-16-NextHop-Internet|141.251.0.0/16|Интернет|
|Mi-146-147-16-NextHop-Internet|146.147.0.0/16|Интернет|
|Mi-147-243-16-NextHop-Internet|147.243.0.0/16|Интернет|
|Mi-150-171-16-NextHop-Internet|150.171.0.0/16|Интернет|
|Mi-150-242-48-22-NextHop-Internet|150.242.48.0/22|Интернет|
|Mi-157-54-15-NextHop-Internet|157.54.0.0/15|Интернет|
|Mi-157-56-14-NextHop-Internet|157.56.0.0/14|Интернет|
|Mi-157-60-16-NextHop-Internet|157.60.0.0/16|Интернет|
|Mi-167-105-16-NextHop-Internet|167.105.0.0/16|Интернет|
|Mi-167-220-16-NextHop-Internet|167.220.0.0/16|Интернет|
|Mi-168-61-16-NextHop-Internet|168.61.0.0/16|Интернет|
|Mi-168-62-15-NextHop-Internet|168.62.0.0/15|Интернет|
|Mi-191-232-13-NextHop-Internet|191.232.0.0/13|Интернет|
|Mi-192-32-16-NextHop-Internet|192.32.0.0/16|Интернет|
|Mi-192-48-225-24-NextHop-Internet|192.48.225.0/24|Интернет|
|Mi-192-84-159-24-NextHop-Internet|192.84.159.0/24|Интернет|
|Mi-192-84-160-23-NextHop-Internet|192.84.160.0/23|Интернет|
|Mi-192-197-157-24-NextHop-Internet|192.197.157.0/24|Интернет|
|Mi-193-149-64-19-NextHop-Internet|193.149.64.0/19|Интернет|
|Mi-193-221-113-24-NextHop-Internet|193.221.113.0/24|Интернет|
|Mi-194-69-96-19-NextHop-Internet|194.69.96.0/19|Интернет|
|Mi-194-110-197-24-NextHop-Internet|194.110.197.0/24|Интернет|
|Mi-198-105-232-22-NextHop-Internet|198.105.232.0/22|Интернет|
|Mi-198-200-130-24-NextHop-Internet|198.200.130.0/24|Интернет|
|Mi-198-206-164-24-NextHop-Internet|198.206.164.0/24|Интернет|
|Mi-199-60-28-24-NextHop-Internet|199.60.28.0/24|Интернет|
|Mi-199-74-210-24-NextHop-Internet|199.74.210.0/24|Интернет|
|Mi-199-103-90-23-NextHop-Internet|199.103.90.0/23|Интернет|
|Mi-199-103-122-24-NextHop-Internet|199.103.122.0/24|Интернет|
|Mi-199-242-32-20-NextHop-Internet|199.242.32.0/20|Интернет|
|Mi-199-242-48-21-NextHop-Internet|199.242.48.0/21|Интернет|
|Mi-202-89-224-20-NextHop-Internet|202.89.224.0/20|Интернет|
|Mi-204-13-120-21-NextHop-Internet|204.13.120.0/21|Интернет|
|Mi-204-14-180-22-NextHop-Internet|204.14.180.0/22|Интернет|
|Mi-204-79-135-24-NextHop-Internet|204.79.135.0/24|Интернет|
|Mi-204-79-179-24-NextHop-Internet|204.79.179.0/24|Интернет|
|Mi-204-79-181-24-NextHop-Internet|204.79.181.0/24|Интернет|
|Mi-204-79-188-24-NextHop-Internet|204.79.188.0/24|Интернет|
|Mi-204-79-195-24-NextHop-Internet|204.79.195.0/24|Интернет|
|Mi-204-79-196-23-NextHop-Internet|204.79.196.0/23|Интернет|
|Mi-204-79-252-24-NextHop-Internet|204.79.252.0/24|Интернет|
|Mi-204-152-18-23-NextHop-Internet|204.152.18.0/23|Интернет|
|Mi-204-152-140-23-NextHop-Internet|204.152.140.0/23|Интернет|
|Mi-204-231-192-24-NextHop-Internet|204.231.192.0/24|Интернет|
|Mi-204-231-194-23-NextHop-Internet|204.231.194.0/23|Интернет|
|Mi-204-231-197-24-NextHop-Internet|204.231.197.0/24|Интернет|
|Mi-204-231-198-23-NextHop-Internet|204.231.198.0/23|Интернет|
|Mi-204-231-200-21-NextHop-Internet|204.231.200.0/21|Интернет|
|Mi-204-231-208-20-NextHop-Internet|204.231.208.0/20|Интернет|
|Mi-204-231-236-24-NextHop-Internet|204.231.236.0/24|Интернет|
|Mi-205-174-224-20-NextHop-Internet|205.174.224.0/20|Интернет|
|Mi-206-138-168-21-NextHop-Internet|206.138.168.0/21|Интернет|
|Mi-206-191-224-19-NextHop-Internet|206.191.224.0/19|Интернет|
|Mi-207-46-16-NextHop-Internet|207.46.0.0/16|Интернет|
|Mi-207-68-128-18-NextHop-Internet|207.68.128.0/18|Интернет|
|Mi-208-68-136-21-NextHop-Internet|208.68.136.0/21|Интернет|
|Mi-208-76-44-22-NextHop-Internet|208.76.44.0/22|Интернет|
|Mi-208-84-21-NextHop-Internet|208.84.0.0/21|Интернет|
|Mi-209-240-192-19-NextHop-Internet|209.240.192.0/19|Интернет|
|Mi-213-199-128-18-NextHop-Internet|213.199.128.0/18|Интернет|
|Mi-216-32-180-22-NextHop-Internet|216.32.180.0/22|Интернет|
|Mi-216-220-208-20-NextHop-Internet|216.220.208.0/20|Интернет|
|Mi-23-96-13-NextHop-Internet|23.96.0.0/13|Интернет|
|Mi-42-159-16-NextHop-Internet|42.159.0.0/16|Интернет|
|Mi-51-13-17-NextHop-Internet|51.13.0.0/17|Интернет|
|Mi-51-107-16-NextHop-Internet|51.107.0.0/16|Интернет|
|Mi-51-116-16-NextHop-Internet|51.116.0.0/16|Интернет|
|Mi-51-120-16-NextHop-Internet|51.120.0.0/16|Интернет|
|Mi-51-120-128-17-NextHop-Internet|51.120.128.0/17|Интернет|
|Mi-51-124-16-NextHop-Internet|51.124.0.0/16|Интернет|
|Mi-102-37-18-NextHop-Internet|102.37.0.0/18|Интернет|
|Mi-102-133-16-NextHop-Internet|102.133.0.0/16|Интернет|
|Mi-199-30-16-20-NextHop-Internet|199.30.16.0/20|Интернет|
|Mi-204-79-180-24-NextHop-Internet|204.79.180.0/24|Интернет|
||||

\* Подсеть MI ссылается на диапазон IP-адресов для подсети в формате x. x. x. x/y. Эти сведения можно найти в портал Azure в свойствах подсети.

\** Если адрес назначения предназначен для одной из служб Azure, Azure направляет трафик непосредственно в службу через магистральную сеть Azure вместо маршрутизации трафика в Интернет. Трафик между службами Azure не проходит через Интернет, независимо от того, в каком регионе Azure находится виртуальная сеть или в каком регионе развернута служба Azure. Дополнительные сведения см. на [странице документации по UDR](../../virtual-network/virtual-networks-udr-overview.md).

Кроме того, можно добавить записи в таблицу маршрутов для маршрутизации трафика с локальными частными IP-адресами в качестве назначения через шлюз виртуальной сети или устройство виртуальной сети (NVA).

Если виртуальная сеть содержит настраиваемую службу DNS, пользовательский DNS-сервер должен иметь возможность разрешать общедоступные записи DNS. Использование дополнительных функций, таких как аутентификация Azure AD, может потребовать разрешения дополнительных полных доменных имен. Дополнительные сведения см. в разделе [Настройка настраиваемой службы DNS](custom-dns-configure.md).

### <a name="networking-constraints"></a>Ограничения сети

**Tls 1,2 применяется к исходящим подключениям**. в январе 2020 Корпорация Майкрософт применяет TLS 1,2 для трафика внутри службы во всех службах Azure. Для Управляемый экземпляр Azure SQL это привело к применению TLS 1,2 для исходящих соединений, используемых для репликации и связанных соединений с сервером SQL Server. Если вы используете версии SQL Server старше 2016 с SQL Управляемый экземпляр, убедитесь, что были применены [специальные обновления TLS 1,2](https://support.microsoft.com/help/3135244/tls-1-2-support-for-microsoft-sql-server) .

В настоящее время в SQL Управляемый экземпляр *не поддерживаются* следующие функции виртуальной сети:

- **Пиринг Майкрософт**: включение [пиринга Майкрософт](../../expressroute/expressroute-faqs.md#microsoft-peering) для каналов ExpressRoute, напрямую или транзитных с помощью виртуальной сети, в которой SQL управляемый экземпляр влияет на поток трафика между компонентами SQL управляемый экземпляр в виртуальной сети и службах, от которых она зависит, вызывая проблемы с доступностью. Предполагается, что развертывание SQL Управляемый экземпляр в виртуальной сети с уже включенным пирингом Майкрософт не выполняется.
- **Глобальный пиринг между виртуальными сетями**. подключение [пиринга виртуальных сетей](../../virtual-network/virtual-network-peering-overview.md) между регионами Azure не работает для управляемых экземпляров SQL, размещенных в подсетях, созданных до 9/22/2020.
- **Азуреплатформднс**: использование [тега службы](../../virtual-network/service-tags-overview.md) АЗУРЕПЛАТФОРМДНС для блокировки разрешения DNS платформы может привести к недоступности управляемый экземпляр SQL. Несмотря на то, что SQL Управляемый экземпляр поддерживает определяемые клиентом DNS для разрешения DNS в ядре, существует зависимость от DNS платформы для операций платформы.
- **Шлюз NAT**. Использование [NAT виртуальной сети Azure](../../virtual-network/nat-overview.md) для управления исходящим подключением с помощью определенного общедоступного IP-адреса приведет к недоступности управляемый экземпляр SQL. В настоящее время служба SQL Управляемый экземпляр ограничена использованием базовой подсистемы балансировки нагрузки, которая не обеспечивает сосуществование входящих и исходящих потоков с NAT виртуальной сети.
- **IPv6 для виртуальной сети Azure**. Ожидается, что развертывание управляемый экземпляр SQL в [двух виртуальных сетях IPv4/IPv6 с двумя стеками](../../virtual-network/ipv6-overview.md) может завершиться ошибкой. Сопоставление группы безопасности сети (NSG) или таблицы маршрутов (UDR) с префиксами IPv6-адресов к подсети SQL Управляемый экземпляр или добавление префиксов IPv6-адресов к NSG или UDR, уже связанным с подсетью управляемого экземпляра, приведет к недоступности SQL Управляемый экземпляр. Для развертывания SQL Управляемый экземпляр в подсети с NSG и UDR, которые уже имеют префиксы IPv6, должны завершаться сбоем.

## <a name="next-steps"></a>Дальнейшие действия

- Общие сведения см. в статье [что такое Azure SQL управляемый экземпляр?](sql-managed-instance-paas-overview.md).
- Узнайте, как [настроить новую виртуальную сеть Azure](virtual-network-subnet-create-arm-template.md) или [существующую виртуальную сеть Azure](vnet-existing-add-subnet.md) , где можно развернуть управляемый экземпляр SQL.
- [Вычислите размер подсети,](vnet-subnet-determine-size.md) в которой требуется развернуть SQL управляемый экземпляр.
- Узнайте, как создать управляемый экземпляр:
  - Из [портал Azure](instance-create-quickstart.md).
  - С помощью [PowerShell](scripts/create-configure-managed-instance-powershell.md).
  - С помощью [шаблона Azure Resource Manager](https://azure.microsoft.com/resources/templates/101-sqlmi-new-vnet/).
  - С помощью [шаблона Azure Resource Manager (с помощью JumpBox, в котором включена среда SSMS)](https://azure.microsoft.com/resources/templates/201-sqlmi-new-vnet-w-jumpbox/).