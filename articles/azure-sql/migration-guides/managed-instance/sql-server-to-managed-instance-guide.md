---
title: 'SQL Server Управляемый экземпляр SQL: руководство по миграции'
description: Следуйте этому руководству, чтобы перенести базы данных SQL Server в Azure SQL Управляемый экземпляр.
ms.service: sql-managed-instance
ms.subservice: migration-guide
ms.custom: ''
ms.devlang: ''
ms.topic: how-to
author: mokabiru
ms.author: mokabiru
ms.reviewer: MashaMSFT
ms.date: 11/06/2020
ms.openlocfilehash: 67f5665225bc1297d0eb1b1e1da954fb47660dee
ms.sourcegitcommit: 8d1b97c3777684bd98f2cfbc9d440b1299a02e8f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/09/2021
ms.locfileid: "102488976"
---
# <a name="migration-guide-sql-server-to-sql-managed-instance"></a>Руководство по миграции: SQL Server в SQL Управляемый экземпляр
[!INCLUDE[appliesto-sqldb-sqlmi](../../includes/appliesto-sqlmi.md)]

Это руководством поможет перенести экземпляр SQL Server в Azure SQL Управляемый экземпляр. 

Вы можете выполнить миграцию SQL Server, выполняемого локально или в: 

- SQL Server на виртуальных машинах  
- Amazon Web Services (AWS) EC2 
- Служба реляционной базы данных Amazon (AWS RDS) 
- Подсистема вычислений (Google Cloud Platform-обеспечить)  
- Облачный SQL для SQL Server (Google Cloud Platform – обеспечить) 

Дополнительные сведения о миграции см. в разделе [Общие сведения о миграции](sql-server-to-managed-instance-overview.md). Другие сценарии см. в разделе [руководств по миграции баз данных](https://datamigration.microsoft.com/).

:::image type="content" source="media/sql-server-to-managed-instance-overview/migration-process-flow-small.png" alt-text="Поток процесса миграции":::

## <a name="prerequisites"></a>Предварительные требования 

Чтобы перенести SQL Server в Управляемый экземпляр SQL Azure, необходимо выполнить следующие предварительные требования: 

- Выберите [метод миграции](sql-server-to-managed-instance-overview.md#compare-migration-options) и соответствующие средства, необходимые для выбранного метода.
- Установите [Помощник по миграции данных (DMA)](https://www.microsoft.com/download/details.aspx?id=53595) на компьютере, который может подключиться к исходному SQL Server


## <a name="pre-migration"></a>Подготовка к миграции

Убедившись, что исходная среда поддерживается, начните с этапа перед переносом. Обнаружение всех существующих источников данных, оценка пригодности к миграции и определение проблем с блокировкой, которые могут препятствовать миграции.  

### <a name="discover"></a>Обнаружить

На этапе обнаружения проверьте сеть, чтобы определить все SQL Server экземпляры и функции, используемые в Организации. 

Используйте службу " [Миграция Azure](../../../migrate/migrate-services-overview.md) ", чтобы оценить пригодность для миграции локальных серверов, вычислить размер на основе производительности и оценить затраты на их запуск в Azure. 

Кроме того, для оценки текущей ИТ-инфраструктуры можно воспользоваться [набором средств оценки и планирования Microsoft ("набор средств для MAP Toolkit")](https://www.microsoft.com/download/details.aspx?id=7826) . Набор средств предоставляет мощный инструмент для инвентаризации, оценки и создания отчетов, позволяющий упростить процесс планирования миграции. 

Дополнительные сведения о средствах, доступных для использования в фазе обнаружения, см. в разделе [службы и средства, доступные для сценариев переноса данных](../../../dms/dms-tools-matrix.md). 

### <a name="assess"></a>Оценка 

[!INCLUDE [assess-estate-with-azure-migrate](../../../../includes/azure-migrate-to-assess-sql-data-estate.md)]

После обнаружения источников данных оцените все локальные SQL Server экземпляры, которые можно перенести в Управляемый экземпляр SQL Azure для определения блокирования или проблем совместимости миграции. 

Для оценки получаемых баз данных можно использовать Помощник по миграции данных (версии 4,1 и более поздних версий): 

- [Рекомендации для целевого объекта Azure](/sql/dma/dma-assess-sql-data-estate-to-sqldb)
- [Рекомендации по SKU Azure](/sql/dma/dma-sku-recommend-sql-db)

Чтобы оценить среду с помощью оценки миграции базы данных, выполните следующие действия. 

1. Откройте [Помощник по миграции данных (DMA)](https://www.microsoft.com/download/details.aspx?id=53595). 
1. Выберите **файл** и нажмите кнопку **создать оценку**. 
1. Укажите имя проекта, выберите SQL Server в качестве типа исходного сервера, а затем выберите Управляемый экземпляр SQL Azure в качестве типа целевого сервера. 
1. Выберите типы отчетов оценки, которые требуется создать. Например, совместимость базы данных и функции четности. В зависимости от типа оценки разрешения, необходимые для источника SQL Server, могут отличаться.  Прежде чем выполнять оценку, DMA выделит разрешения, необходимые для выбранного помощника.
    - Категория " **четность функций** " содержит исчерпывающий набор рекомендаций, альтернативы, доступные в Azure, и действия по планированию проекта миграции. (требуются разрешения sysadmin)
    - Категория **проблемы совместимости** определяет частично поддерживаемые или неподдерживаемые проблемы совместимости компонентов, которые могут блокировать миграцию, а также рекомендации по их устранению ( `CONNECT SQL` , `VIEW SERVER STATE` и `VIEW ANY DEFINITION` необходимые разрешения).
1. Укажите сведения о подключении к источнику для SQL Server и подключитесь к базе данных источника.
1. Выберите **начать оценку**. 
1. После завершения процесса выберите и ознакомьтесь с отчетами об оценке для блокировки миграции и проблем с контролем четности компонентов. Отчет об оценке также можно экспортировать в файл, который можно использовать совместно с другими командами или сотрудниками Организации. 
1. Определите уровень совместимости базы данных, который снизит усилия, выполняемые после миграции.  
1. Найдите оптимальный номер SKU Azure SQL Управляемый экземпляр для локальной рабочей нагрузки. 

Дополнительные сведения см. в разделе [выполнение SQL Serverной оценки миграции с помощью помощник по миграции данных](/sql/dma/dma-assesssqlonprem).

Если SQL Управляемый экземпляр не является подходящим целевым объектом для вашей рабочей нагрузки, SQL Server на виртуальных машинах Azure может быть альтернативным целевым объектом для вашего бизнеса. 

#### <a name="scaled-assessments-and-analysis"></a>Масштабируемые оценки и анализ

Помощник по миграции данных поддерживает выполнение масштабируемых оценок и консолидацию отчетов об оценке для анализа. Если у вас есть несколько серверов и баз данных, которые необходимо оценить и проанализировать в масштабе, чтобы обеспечить более широкое представление о разотношении данных, перейдите по следующим ссылкам, чтобы получить дополнительные сведения.

- [Выполнение масштабируемых оценок с помощью PowerShell](/sql/dma/dma-consolidatereports)
- [Анализ отчетов об оценке с помощью Power BI](/sql/dma/dma-consolidatereports#dma-reports)

> [!IMPORTANT]
>Выполнение оценок в масштабе для нескольких баз данных также может быть автоматизировано с помощью [программы командной строки DMA](/sql/dma/dma-commandline) , что также позволяет отправлять результаты в службу " [Миграция Azure](/sql/dma/dma-assess-sql-data-estate-to-sqldb#view-target-readiness-assessment-results) " для дальнейшего анализа и обеспечения готовности к работе.

### <a name="create-a-performance-baseline"></a>Создание базового показателя производительности

Если необходимо сравнить производительность рабочей нагрузки на Управляемый экземпляр SQL с исходной рабочей нагрузкой, работающей на SQL Server, создайте базовый уровень производительности, который будет использоваться для сравнения. Дополнительные сведения см. в разделе [базовые показатели производительности](sql-server-to-managed-instance-performance-baseline.md) . 

### <a name="create-sql-managed-instance"></a>Создание Управляемого экземпляра 

На основе информации на этапе обнаружения и оценки создайте соответствующий Целевой Управляемый экземпляр SQL. Это можно сделать с помощью шаблона [портал Azure](../../managed-instance/instance-create-quickstart.md), [PowerShell](../../managed-instance/scripts/create-configure-managed-instance-powershell.md)или [Azure Resource Manager (ARM)](../../managed-instance/create-template-quickstart.md). 


## <a name="migrate"></a>Миграция

После завершения задач, связанных с стадией перед миграцией, можно приступать к выполнению переноса схемы и данных. 

Перенесите данные с помощью выбранного [метода миграции](sql-server-to-managed-instance-overview.md#compare-migration-options). 

В этом руководством описаны два наиболее популярных варианта: Azure Database Migration Service (DMS), а также встроенное резервное копирование и восстановление. 

### <a name="database-migration-service"></a>Database Migration Service

Чтобы выполнить миграцию с помощью DMS, выполните следующие действия:

1. Зарегистрируйте поставщик ресурсов **Microsoft. Migration** в подписке, если вы выполняете это в первый раз.
1. Создайте экземпляр Azure Database Migration Service в нужном месте (предпочтительно в том же регионе, что и Целевая Управляемый экземпляр SQL Azure) и выберите существующую виртуальную сеть или создайте новую для размещения экземпляра DMS.
1. После создания экземпляра DMS создайте новый проект миграции и укажите в качестве типа исходного сервера **SQL Server** , а для типа целевого сервера — **управляемый экземпляр базы данных SQL Azure**. Выберите тип действия в колонке создания проекта — оперативная или автономная миграция данных. 
1.  Укажите сведения об источнике SQL Server на странице сведений об **источнике миграции** , а также на целевом управляемый экземпляр SQL Azure на странице сведений о **целевом объекте миграции** . Выберите **Далее**.
1. Выберите базу данных, которую требуется перенести. 
1. Укажите параметры конфигурации, чтобы указать **общую сетевую папку SMB** , содержащую файлы резервной копии базы данных. Используйте учетные данные пользователя Windows с DMS, который может получить доступ к сетевой папке. Укажите **сведения об учетной записи хранения Azure**. 
1. Ознакомьтесь со сводкой о миграции и выберите команду **запустить миграцию**. Затем можно отслеживать действие миграции и проверять ход выполнения миграции базы данных.
1. После восстановления базы данных нажмите кнопку **Start прямую миграцию (запустить**). Процесс миграции копирует резервную копию заключительного фрагмента журнала после того, как она стала доступной в сетевой общей папке SMB, и восстанавливает ее на целевом объекте. 
1. Завершите весь входящий трафик к базе данных источника и обновите строку подключения до новой базы данных SQL Azure Управляемый экземпляр. 

Подробное пошаговое руководство по этому варианту миграции см. в статье [перенос SQL Server в Azure SQL управляемый экземпляр Online с помощью DMS](../../../dms/tutorial-sql-server-managed-instance-online.md). 
   


### <a name="backup-and-restore"></a>Резервное копирование и восстановление 

Одной из основных возможностей Управляемый экземпляр Azure SQL для обеспечения быстрой и простой миграции баз данных является встроенное восстановление файлов резервных копий базы данных ( `.bak` ), хранящихся в [службе хранилища Azure](https://azure.microsoft.com/services/storage/). Резервное копирование и восстановление — это асинхронная операция в зависимости от размера базы данных. 

На следующей схеме представлен общий обзор процесса:

![На схеме показано, SQL Server со стрелкой, обозначенной как резервное копирование и передача на URL-адрес в службу хранилища Azure, и вторая стрелка с меткой восстановление из URL-адреса, передаваемого из службы хранилища Azure в Управляемый экземпляр SQL.](./media/sql-server-to-managed-instance-overview/migration-restore.png)

> [!NOTE]
> Время, необходимое для резервного копирования, передачи в службу хранилища Azure и выполнения собственной операции восстановления в Azure SQL Управляемый экземпляр, зависит от размера базы данных. Учитывайте достаточное время простоя, чтобы разместить операцию для больших баз данных. 


Чтобы выполнить миграцию с помощью резервного копирования и восстановления, выполните следующие действия. 

1. Создайте резервную копию базы данных в хранилище BLOB-объектов Azure. Например, используйте [резервное копирование в URL-адрес](/sql/relational-databases/backup-restore/sql-server-backup-to-url) в [SQL Server Management Studio](/sql/ssms/download-sql-server-management-studio-ssms). Используйте [средство Microsoft Azure](https://go.microsoft.com/fwlink/?LinkID=324399) для поддержки баз данных, предшествующих SQL Server 2012 с пакетом обновления 1 (SP1) Cu2. 
1. Подключитесь к Управляемый экземпляр Azure SQL с помощью SQL Server Management Studio. 
1. Создайте учетные данные, используя подписанный URL-доступ для доступа к учетной записи хранилища BLOB-объектов Azure с резервными копиями базы данных. Пример:

   ```sql
   CREATE CREDENTIAL [https://mitutorials.blob.core.windows.net/databases]
   WITH IDENTITY = 'SHARED ACCESS SIGNATURE'
   , SECRET = 'sv=2017-11-09&ss=bfqt&srt=sco&sp=rwdlacup&se=2028-09-06T02:52:55Z&st=2018-09-04T18:52:55Z&spr=https&sig=WOTiM%2FS4GVF%2FEEs9DGQR9Im0W%2BwndxW2CQ7%2B5fHd7Is%3D'
   ```
1. Восстановите резервную копию из контейнера больших двоичных объектов службы хранилища Azure. Пример: 

    ```sql
   RESTORE DATABASE [TargetDatabaseName] FROM URL =
     'https://mitutorials.blob.core.windows.net/databases/WideWorldImporters-Standard.bak'
   ```

1. После завершения восстановления просмотрите базу данных в **обозревателе объектов** в SQL Server Management Studio. 

Дополнительные сведения об этом варианте миграции см. в статье [Восстановление базы данных в Azure SQL управляемый экземпляр с помощью SSMS](../../managed-instance/restore-sample-database-quickstart.md).

> [!NOTE]
> Операция восстановления базы данных является асинхронной и повторяемой. В случае разрыва подключения или истечения времени ожидания в SQL Server Management Studio может возникнуть ошибка. База данных SQL Azure будет пытаться восстановить базу данных в фоновом режиме, и вы сможете отслеживать ход восстановления с помощью представлений [sys.dm_exec_requests](/sql/relational-databases/system-dynamic-management-views/sys-dm-exec-requests-transact-sql) и [sys.dm_operation_status](/sql/relational-databases/system-dynamic-management-views/sys-dm-operation-status-azure-sql-database).



## <a name="data-sync-and-cutover"></a>Синхронизация данных и прямую миграцию

При использовании параметров миграции, которые постоянно реплицируют и синхронизируют изменения данных от источника к целевому объекту, исходные данные и схема могут измениться и отменяться от целевого объекта. Во время синхронизации данных убедитесь, что все изменения в источнике фиксируются и применяются к целевому объекту в процессе миграции. 

Убедившись, что данные одинаковы для исходной и целевой сред, можно прямую миграцию из источника в целевую среду. Важно спланировать процесс прямую миграцию с группами бизнеса или приложений, чтобы обеспечить минимальное прерывание во время прямую миграцию, не влияющее на непрерывность бизнес-процессов. 

> [!IMPORTANT]
> Дополнительные сведения о конкретных действиях, связанных с выполнением прямую миграцию в процессе миграции с помощью DMS, см. в разделе [выполнение миграции прямую миграцию](../../../dms/tutorial-sql-server-managed-instance-online.md#performing-migration-cutover).


## <a name="post-migration"></a>После миграции

После успешного завершения этапа миграции пройдите ряд задач, выполняемых после миграции, чтобы обеспечить бесперебойную работу всех компонентов. 

Этап, выполняемый после миграции, крайне важен для согласования любых проблем с точностью данных и проверки полноты, а также для устранения проблем с производительностью рабочей нагрузки. 

### <a name="remediate-applications"></a>Исправление приложений 

После переноса данных в целевую среду все приложения, которые раньше использовали источник, должны приступить к приему целевого объекта. Для этого в некоторых случаях потребуется внести изменения в приложения.

### <a name="perform-tests"></a>Выполнение тестов

Тестирование переноса базы данных включает следующие действия.

1. **Разработка проверочных тестов**. Чтобы протестировать перенос базы данных, необходимо использовать SQL-запросы. Необходимо создать запросы проверки, которые будут выполняться как в исходной, так и в целевой базах данных. Запросы на проверку должны охватывать определенную область.
1. **Настройка тестовой среды**. Тестовая среда должна содержать копию исходной и целевой баз данных. Не забудьте изолировать тестовую среду.
1. **Выполнение проверочных тестов**. Выполните проверочные тесты для источника и целевого объекта, а затем проанализируйте результаты.
1. **Выполнение тестов производительности**. Запустите тест производительности для источника и целевого объекта, а затем проанализируйте и сравните результаты.

   > [!NOTE]
   > Чтобы получить помощь в разработке и выполнении проверочных тестов, выполняемых после переноса, используйте решение по обеспечению качества данных, предоставляемое нашим партнером [QuerySurge](https://www.querysurge.com/company/partners/microsoft). 



## <a name="leverage-advanced-features"></a>Использование дополнительных функций 

Не забудьте воспользоваться преимуществами расширенных облачных функций, предлагаемых Управляемый экземпляр SQL, таких как [Встроенная Высокая доступность](../../database/high-availability-sla.md), [обнаружение угроз](../../database/azure-defender-for-sql.md), [мониторинг и Настройка рабочей нагрузки](../../database/monitor-tune-overview.md). 

[Аналитика SQL Azure](../../../azure-monitor/insights/azure-sql.md) позволяет централизованно отслеживать большой набор управляемых экземпляров.

Некоторые SQL Server функции доступны только после изменения [уровня совместимости базы данных](/sql/relational-databases/databases/view-or-change-the-compatibility-level-of-a-database) на последний уровень совместимости (150). 


## <a name="next-steps"></a>Дальнейшие действия

- Сведения о службах и средствах Майкрософт и сторонних поставщиков, которые помогут вам в использовании различных сценариев переноса баз данных и данных, а также специальных задач см. в разделе [служба и средства для переноса данных](../../../dms/dms-tools-matrix.md).

- Дополнительные сведения о Управляемый экземпляр Azure SQL см. в следующих статьях:
   - [Уровни служб в Azure SQL Управляемый экземпляр](../../managed-instance/sql-managed-instance-paas-overview.md#service-tiers)
   - [Различия между SQL Server и Управляемый экземпляр SQL Azure](../../managed-instance/transact-sql-tsql-differences-sql-server.md)
   - [Калькулятор совокупной стоимости владения Azure](https://azure.microsoft.com/pricing/tco/calculator/) 


- Дополнительные сведения о структуре и цикле внедрения для миграции в облако см. в разделе
   -  [Cloud Adoption Framework для Azure](/azure/cloud-adoption-framework/migrate/azure-best-practices/contoso-migration-scale)
   -  [Рекомендации по затратам и изменению размеров рабочих нагрузок, переносятся в Azure](/azure/cloud-adoption-framework/migrate/azure-best-practices/migrate-best-practices-costs) 

- Чтобы оценить уровень доступа к приложениям, см. раздел [набор средств миграции для доступа к данным (Предварительная версия)](https://marketplace.visualstudio.com/items?itemName=ms-databasemigration.data-access-migration-toolkit)
- Дополнительные сведения о выполнении проверки уровня доступа к данным A/B см. [Database experimentation Assistant](/sql/dea/database-experimentation-assistant-overview).