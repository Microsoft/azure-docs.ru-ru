---
title: Экземпляры отказоустойчивого кластера
description: Сведения об использовании экземпляров отказоустойчивого кластера с SQL Server на Виртуальных машинах Azure.
services: virtual-machines
documentationCenter: na
author: MashaMSFT
editor: monicar
tags: azure-service-management
ms.service: virtual-machines-sql
ms.subservice: hadr
ms.topic: overview
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 06/02/2020
ms.author: mathoma
ms.openlocfilehash: a7735de9763f3924cd6baae6af1258f6448c874e
ms.sourcegitcommit: f28ebb95ae9aaaff3f87d8388a09b41e0b3445b5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/29/2021
ms.locfileid: "101690929"
---
# <a name="failover-cluster-instances-with-sql-server-on-azure-virtual-machines"></a>Экземпляры отказоустойчивого кластера с SQL Server на Виртуальных машинах Azure
[!INCLUDE[appliesto-sqlvm](../../includes/appliesto-sqlvm.md)]

В этой статье рассматриваются различия в функциях, с которыми можно столкнуться при работе с экземплярами отказоустойчивого кластера (FCI) для SQL Server на Виртуальных машинах Azure. 

## <a name="overview"></a>Обзор

SQL Server на Виртуальных машинах Azure использует функциональные возможности отказоустойчивой кластеризации Windows Server (WSFC) для обеспечения высокого уровня доступности локальных ресурсов за счет избыточности на уровне экземпляра сервера: экземпляра отказоустойчивого кластера. Экземпляр отказоустойчивого кластера является единственным экземпляром SQL Server, установленным на узлах WSFC (или просто узлах кластера) и, возможно, в нескольких подсетях. В сети FCI представляет собой экземпляр SQL Server, выполняющийся на одном компьютере. Но FCI обеспечивает отработку отказу с одного узла WSFC на другой, если текущий узел становится недоступным.

В остальной части статьи рассматриваются различия между экземплярами отказоустойчивого кластера, которые используются с SQL Server на Виртуальных машинах Azure. Дополнительные сведения о технологии отказоустойчивой кластеризации см. в следующих статьях: 

- [технологии кластера под управлением Windows](/windows-server/failover-clustering/failover-clustering-overview);
- [Экземпляры отказоустойчивого кластера SQL Server](/sql/sql-server/failover-clusters/windows/always-on-failover-cluster-instances-sql-server)

## <a name="quorum"></a>Кворум

Экземпляры отказоустойчивого кластера с SQL Server на Виртуальных машинах Azure поддерживают использование диска-свидетеля, облака-свидетеля или файлового ресурса-свидетеля для кворума кластера.

Дополнительные сведения см. в разделе [Рекомендации по использованию кворума с виртуальными машинами SQL Server в Azure](hadr-cluster-best-practices.md#quorum). 


## <a name="storage"></a>Память

В традиционных локальных кластеризованных средах отказоустойчивый кластер Windows использует сеть хранения данных (SAN), которая доступна для обоих узлов в качестве общего хранилища. Файлы SQL Server размещаются в общем хранилище, к файлам в котором имеет доступ только активный узел. 

SQL Server на Виртуальных машинах Azure предлагает различные варианты в качестве решения общего хранилища для развертывания экземпляров отказоустойчивого кластера SQL Server: 

||[Общие диски Azure](../../../virtual-machines/disks-shared.md)|[Общие папки ценовой категории "Премиум"](../../../storage/files/storage-how-to-create-file-share.md) |[Локальные дисковые пространства (S2D)](/windows-server/storage/storage-spaces/storage-spaces-direct-overview)|
|---------|---------|---------|---------|
|**Минимальная версия ОС**| All |Windows Server 2012|Windows Server 2016|
|**Минимальная версия SQL Server**|All|SQL Server 2012|SQL Server 2016|
|**Поддерживаемые варианты доступности виртуальных машин** |Группы доступности с группами размещения близкого взаимодействия (для SSD ценовой категории "Премиум") </br> Та же зона доступности (для SSD ценовой категории "Ультра") |Группы доступности и зоны доступности|Группы доступности |
|**Поддержка FileStream**|Да|Нет|Да |
|**Кэш BLOB-объектов Azure**|Нет|Нет|Да|

В оставшейся части этой статьи приводятся преимущества и ограничения каждого варианта хранилища, доступного для SQL Server на Виртуальных машинах Azure. 

### <a name="azure-shared-disks"></a>Общие диски Azure

[Общие диски Azure](../../../virtual-machines/disks-shared.md) — это функция [управляемых дисков Azure](../../../virtual-machines/managed-disks-overview.md). Отказоустойчивая кластеризация Windows Server поддерживает использование общих дисков Azure с экземпляром отказоустойчивого кластера. 

**Поддерживаемая ОС:** All   
**Поддерживаемая версия SQL:** All     

**Преимущества:** 
- Используются для приложений, которые планируется перенести в Azure с сохранением архитектуры с высокой доступностью и аварийным восстановлением (HADR). 
- Обеспечивают возможность переноса кластерных приложений в Azure без изменений благодаря поддержке постоянного резервирования SCSI (SCSI PR). 
- Поддерживают общее хранилище на базе Azure SSD (цен. категория"Премиум") и Дисков Azure (цен. категория"Ультра").
- Позволяют использовать один общий диск или несколько чередующихся общих дисков для создания общего пула носителей. 
- Поддерживают FileStream.
- Диски SSD ценовой категории "Премиум" поддерживают группы доступности. 


**Ограничения**. 
- Рекомендуем размещать виртуальные машины в одной группе доступности и одной группе размещения близкого взаимодействия.
- Диски ценовой категории "Ультра" не поддерживают группы доступности. 
- Зоны доступности поддерживаются для дисков ценовой категории "Ультра", но виртуальные машины должны находиться в одной зоне доступности, что снижает доступность виртуальной машины. 
- Независимо от выбранного решения доступности оборудования доступность отказоустойчивого кластера при использовании общих дисков Azure всегда составляет 99,9 %. 
- Кэширование диска SSD (цен. категория "Премиум") не поддерживается.

 
Сведения о начале работы см. в статье [Экземпляр отказоустойчивого кластера SQL Server с общими дисками Azure](failover-cluster-instance-azure-shared-disks-manually-configure.md). 

### <a name="storage-spaces-direct"></a>Локальные дисковые пространства

[Локальные дисковые пространства](/windows-server/storage/storage-spaces/storage-spaces-direct-overview) — это функция Windows Server, которая поддерживается с отказоустойчивой кластеризацией на Виртуальных машинах Azure. Она предоставляет программную виртуальную сеть хранения данных (SAN).

**Поддерживаемая ОС:** Windows Server 2016 и более поздних версий.   
**Поддерживаемая версия SQL:** SQL Server 2016 и более поздние версии   


**Преимущества.** 
- Достаточная пропускная способность сети обеспечивает надежность и высокую производительность решения общего хранилища. 
- Поддерживают кэш BLOB-объектов Azure, поэтому операции чтения могут обслуживаться локально из кэша. (Обновления реплицируются одновременно на оба узла.) 
- Поддерживают FileStream. 

**Ограничения:**
- Доступно только для Windows Server 2016 и более поздних версий. 
- Зоны доступности не поддерживаются.
- Обеим виртуальным машинам должен быть доступен одинаковый объем подключенного диска. 
- Для обеспечения высокой производительности требуется высокая пропускная способность сети из-за непрерывной репликации дисков. 
- Требуется больший размер виртуальной машины, а плата за хранилище удваивается, так как оно подключено к каждой виртуальной машине. 

Сведения о начале работы см. в статье [Экземпляр отказоустойчивого кластера SQL Server с функцией "Локальные дисковые пространства"](failover-cluster-instance-storage-spaces-direct-manually-configure.md). 

### <a name="premium-file-share"></a>Общая папка ценовой категории "Премиум"

[Общие папки ценовой категории "Премиум"](../../../storage/files/storage-how-to-create-file-share.md) — это компоненты службы [Файлы Azure](../../../storage/files/index.yml). Общие папки ценовой категории "Премиум" работают на базе SSD и обеспечивают малую задержку. Они полностью поддерживаются для использования с экземплярами отказоустойчивого кластера для SQL Server 2012 или более поздней версии в Windows Server 2012 или более поздней версии. Общие папки ценовой категории "Премиум" отличаются повышенной гибкостью, так как вы можете менять их размеры и масштабировать их без простоя.

**Поддерживаемая ОС:** Windows Server 2012 и более поздних версий   
**Поддерживаемая версия SQL:** SQL Server 2012 и более поздней версии   

**Преимущества.** 
- Единое решение общего хранилища для виртуальных машин, распределенное по нескольким зонам доступности. 
- Полностью управляемая файловая система с задержкой менее 10 мс и возможностью ускорения операций ввода-вывода. 

**Ограничения:**
- Доступно только для Windows Server 2012 и более поздних версий. 
- FileStream не поддерживается. 


Сведения о начале работы см. в статье [Экземпляр отказоустойчивого кластера SQL Server с общей папкой ценовой категории "Премиум"](failover-cluster-instance-premium-file-share-manually-configure.md). 

### <a name="partner"></a>Партнер

Доступны партнерские решения для кластеризации с поддерживаемым хранилищем. 

**Поддерживаемая ОС:** All   
**Поддерживаемая версия SQL:** All   

В одном из примеров в качестве хранилища используется SIOS DataKeeper. Дополнительные сведения см. в записи блога [Отказоустойчивая кластеризация и SIOS DataKeeper](https://azure.microsoft.com/blog/high-availability-for-a-file-share-using-wsfc-ilb-and-3rd-party-software-sios-datakeeper/).

### <a name="iscsi-and-expressroute"></a>iSCSI и ExpressRoute

Вы также можете предоставить доступ к целевому общему блочному хранилищу iSCSI с помощью Azure ExpressRoute. 

**Поддерживаемая ОС:** All   
**Поддерживаемая версия SQL:** All   

Например, решение NetApp Private Storage (NPS) предоставляет цели iSCSI через ExpressRoute с Equinix для виртуальных машин Azure.

По любым вопросам, связанным с доступом к данным при отработке отказа и касающимся решений репликации данных и общих хранилищ от партнеров корпорации Майкрософт, обращайтесь к поставщикам решений.

## <a name="connectivity"></a>Соединение

Экземпляры отказоустойчивого кластера с SQL Server на Виртуальных машинах Azure используют [имя распределенной сети (DNN)](failover-cluster-instance-distributed-network-name-dnn-configure.md) или [имя виртуальной сети (VNN) с Azure Load Balancer](failover-cluster-instance-vnn-azure-load-balancer-configure.md) для маршрутизации трафика к экземпляру SQL Server независимо от того, какой узел в текущий момент владеет кластерными ресурсами. При использовании определенных функций и DNN с экземплярами отказоустойчивого кластера SQL Server необходимо учитывать дополнительные факторы. Дополнительные сведения см. в статье [Взаимодействие функций с SQL Server FCI и DNN](failover-cluster-instance-dnn-interoperability.md). 

Дополнительные сведения о вариантах подключения кластеров см. в статье [Рекомендации по настройке кластера (SQL Server на Виртуальных машинах Azure)](hadr-cluster-best-practices.md#connectivity). 

## <a name="limitations"></a>Ограничения

Примите во внимание следующие ограничения для экземпляров отказоустойчивого кластера с SQL Server на Виртуальных машинах Azure. 

### <a name="lightweight-extension-support"></a>Упрощенная поддержка расширений   

На текущий момент экземпляры отказоустойчивого кластера SQL Server на виртуальных машинах Azure поддерживаются только в [режиме упрощенного управления](sql-server-iaas-agent-extension-automate-management.md#management-modes) расширения агента IaaS SQL Server. Чтобы перейти с полного режима расширения на упрощенный, удалите ресурс **виртуальной машины SQL** для соответствующих виртуальных машин, а затем зарегистрируйте их с помощью расширения агента IaaS SQL в упрощенном режиме. Если вы удаляете ресурс **виртуальной машины SQL** с помощью портала Azure, снимите флажок рядом с соответствующей виртуальной машиной, чтобы предотвратить ее удаление. 

Полное расширение поддерживает такие компоненты, как автоматическое резервное копирование, установка исправлений и расширенное управление порталом. Эти функции не будут работать для виртуальных машин SQL, зарегистрированных в упрощенном режиме управления.

### <a name="msdtc"></a>MSDTC 

Виртуальные машины Azure поддерживают координатор распределенных транзакций (Майкрософт) в Windows Server 2019 с хранилищем на общих томах кластера (CSV) и с [Azure Load Balancer ценовой категории "Стандартный"](../../../load-balancer/load-balancer-overview.md) или на виртуальных машинах SQL Server, использующих общие диски Azure. 

Координатор распределенных транзакций (Майкрософт) не поддерживается на Виртуальных машинах Azure в Windows Server 2016 и более ранних версий с общими томами кластера по следующим причинам:

- Кластерный ресурс MSDTC нельзя настроить для использования общего хранилища. В Windows Server 2016, если вы создаете ресурс MSDTC, не будет отображаться доступное общее хранилище, даже если оно существует. Эта проблема устранена в Windows Server 2019.
- Load Balancer ценовой категории "Стандартный" не обрабатывает порты RPC.


## <a name="next-steps"></a>Дальнейшие действия

Ознакомьтесь с [рекомендациями по настройке кластера](hadr-cluster-best-practices.md), а затем [подготовьте виртуальную машину SQL Server для FCI](failover-cluster-instance-prepare-vm.md). 

Дополнительные сведения см. в разделе: 

- [технологии кластера под управлением Windows](/windows-server/failover-clustering/failover-clustering-overview);   
- [Экземпляры отказоустойчивого кластера SQL Server](/sql/sql-server/failover-clusters/windows/always-on-failover-cluster-instances-sql-server)