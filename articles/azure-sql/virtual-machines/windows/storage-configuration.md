---
title: Настройка хранилища для SQL Server виртуальных машин | Документация Майкрософт
description: В этом разделе описано, как Azure настраивает хранилище для SQL Server виртуальных машин во время подготовки (модель развертывания Azure Resource Manager). Здесь также описывается настройка хранилища для имеющихся виртуальных машин SQL Server.
services: virtual-machines-windows
documentationcenter: na
author: MashaMSFT
tags: azure-resource-manager
ms.assetid: 169fc765-3269-48fa-83f1-9fe3e4e40947
ms.service: virtual-machines-sql
ms.subservice: management
ms.topic: how-to
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 12/26/2019
ms.author: mathoma
ms.openlocfilehash: 982bd9239c5e95c9b7af09b5f54c5a09067ca7c6
ms.sourcegitcommit: f0a3ee8ff77ee89f83b69bc30cb87caa80f1e724
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/26/2021
ms.locfileid: "105565432"
---
# <a name="configure-storage-for-sql-server-vms"></a>Настройка хранилища для SQL Server виртуальных машин
[!INCLUDE[appliesto-sqlvm](../../includes/appliesto-sqlvm.md)]

В этой статье рассказывается, как настроить хранилище для SQL Server на виртуальных машинах Azure.

SQL Server виртуальные машины, развернутые с помощью образов Marketplace, автоматически следуют рекомендациям по [хранению](performance-guidelines-best-practices-storage.md) по умолчанию, которые можно изменить во время развертывания. Некоторые из этих параметров конфигурации можно изменить после развертывания. 


## <a name="prerequisites"></a>Предварительные требования

Для поддержки параметров автоматической настройки хранилища виртуальная машина должна:

* Подготовлено с помощью [SQL Server образа коллекции](sql-server-on-azure-vm-iaas-what-is-overview.md#payasyougo) или зарегистрировано в [расширении SQL IaaS]().
* использовать [модель развертывания с помощью Resource Manager](../../../azure-resource-manager/management/deployment-models.md);
* использовать [твердотельные накопители класса Premium](../../../virtual-machines/disks-types.md).

## <a name="new-vms"></a>Новые виртуальные машины

В следующих разделах описаны действия по настройке хранилища для новых виртуальных машин SQL Server.

### <a name="azure-portal"></a>Портал Azure

При подготовке виртуальной машины Azure с помощью образа коллекции SQL Server нажмите **Изменить конфигурацию** на вкладке **Параметры SQL Server**, чтобы открыть страницу конфигурации с хранилищем, оптимизированным для высокой производительности. Можно либо оставить значения по умолчанию, либо изменить тип конфигурации диска на тот, который лучше соответствует вашим потребностям в зависимости от рабочей нагрузки. 

![Снимок экрана, на котором показана вкладка "параметры SQL Server" и параметр "изменить конфигурацию".](./media/storage-configuration/sql-vm-storage-configuration-provisioning.png)

Выберите тип рабочей нагрузки, для которой вы развертываете SQL Server, в разделе **Оптимизация хранилища**. С параметром оптимизации **Общая** по умолчанию у вас будет один диск данных с максимумом 5000 операций ввода-вывода в секунду. Этот же диск будет использоваться для данных, журнала транзакций и хранилища TempDB. 

При выборе **Обработка транзакций** (OLTP) или **Хранилище данных** будет создан отдельный диск для данных, отдельный диск для журнала транзакций, а также будет использоваться локальный SSD для TempDB. Между **обработкой транзакций** и **хранилища данных** нет различий в плане хранилища, но от этого зависит [конфигурация чередования и флаги трассировки](#workload-optimization-settings). Выбор хранилища уровня "Премиум" устанавливает для кэширование значение *ReadOnly* для диска данных, а для диска журнала значение *None* согласно [рекомендациям по повышению производительности виртуальных машин SQL Server](performance-guidelines-best-practices.md). 

![Настройка хранилища для виртуальной машины SQL Server во время подготовки](./media/storage-configuration/sql-vm-storage-configuration.png)

Конфигурация диска полностью поддается настройке, поэтому вы можете настроить топологию хранилища, тип диска и число операций ввода-вывода для рабочей нагрузки виртуальной машины SQL Server. Вы также можете использовать UltraSSD (предварительная версия) в качестве параметра для **типа диска**, если ваша виртуальная машина SQL Server находится в одном из поддерживаемых регионов (восточная часть США 2, Юго-Восточная Азия и Северная Европа) и вы включили [Ultra Disks для своей подписки](../../../virtual-machines/disks-enable-ultra-ssd.md).  

Кроме того, вы можете задать кэширование для дисков. На виртуальных машинах Azure есть многоуровневая технология кэширования, называемая [кэшем BLOB](../../../virtual-machines/premium-storage-performance.md#disk-caching), которая используется с дисками [класса "Премиум"](../../../virtual-machines/disks-types.md#premium-ssd). При таком кэшировании используется ОЗУ виртуальной машины и локальный SSD. 

Режим кэширования дисков для SSD цен. категории "Премиум" может быть *ReadOnly*, *ReadWrite* или *None*. 

- Кэширование *ReadOnly* (только для чтения) особенно полезно для файлов данных SQL Server, расположенных в хранилище класса Premium. Кэширование *ReadOnly* обеспечивает низкую задержку чтения, высокую скорость операций чтения и пропускную способность, так как операции чтения выполняются из кэша, который находится в памяти виртуальной машины и на локальном SSD. Эти операции чтения выполняются гораздо быстрее, чем чтение с диска данных, который находится в хранилище BLOB-объектов Azure. В хранилище класса "Премиум" операции чтения, выполненные из кэша, не относятся к операциям ввода-вывода и пропускной способности диска. Таким образом, приложение может выполнять больше операций ввода-вывода и достичь высокой пропускной способности. 
- Конфигурация кэша *None* не должна использоваться для дисков, на которых размещен файл журнала SQL Server, так как файл журнала записывается последовательно и не имеет преимущества от кэширования *ReadOnly*. 
- Кэширование *ReadWrite* не следует использовать для размещения файлов SQL Server, так как SQL Server не поддерживает согласованность данных с кэшем *ReadWrite*. Операции записи тратят производительность кэша BLOB-объектов в режиме *ReadOnly*, а также происходит увеличение задержек, если записи проходят через уровни кэша BLOB-объектов в режиме *ReadOnly*. 


   > [!TIP]
   > Конфигурация хранилища должна соответствовать ограничениям, накладываемым выбранным размером виртуальной машины. Выбор параметров хранилища, превышающих ограничение производительности для размера виртуальной машины, приведет к появлению предупреждения: `The desired performance might not be reached due to the maximum virtual machine disk performance cap` . Либо сократите число операций ввода-вывода, изменив тип диска, либо увеличьте ограничение производительности, увеличив размер виртуальной машины. Подготовка не будет прервана. 


После создания виртуальной машины в зависимости от вашего выбора Azure выполняет следующие задачи по настройке хранилища:

* Создает и прикрепляет к виртуальной машине расширенные твердотельные накопители.
* настраивает доступность дисков данных для SQL Server;
* настраивает диски данных в пуле носителей в зависимости от указанных требований к размеру и производительности (операции ввода-вывода в секунду и пропускная способность);
* связывает пул носителей с новым диском на виртуальной машине;
* оптимизирует этот диск в зависимости от указанного типа рабочей нагрузки ("Хранилище данных", "Обработка транзакций" или "Общая").

Полное пошаговое руководство по созданию виртуальной машины SQL Server на портале Azure см. в статье [Подготовка виртуальной машины SQL Server на портале Azure](../../../azure-sql/virtual-machines/windows/create-sql-vm-portal.md).

### <a name="resource-manager-templates"></a>Шаблоны Resource Manager

При использовании следующих шаблонов Resource Manager по умолчанию к виртуальной машине присоединяются два диска данных класса Premium. В этом случае пул носителей не настраивается. Однако эти шаблоны можно настроить, чтобы изменить количество дисков данных класса Premium, присоединенных к виртуальной машине.

* [Создание виртуальной машины с поддержкой автоматической архивации](https://github.com/Azure/azure-quickstart-templates/tree/master/201-vm-sql-full-autobackup)
* [Создание виртуальной машины с автоматической установкой исправлений](https://github.com/Azure/azure-quickstart-templates/tree/master/201-vm-sql-full-autopatching)
* [Создание виртуальной машины с интеграцией AKV](https://github.com/Azure/azure-quickstart-templates/tree/master/201-vm-sql-full-keyvault)

### <a name="quickstart-template"></a>Шаблон быстрого запуска

Для развертывания виртуальной машины SQL Server с помощью оптимизации хранилища можно использовать следующий шаблон быстрого запуска. 

* [Создание виртуальной машины с оптимизацией хранилища](https://github.com/Azure/azure-quickstart-templates/tree/master/101-sql-vm-new-storage/)
* [Создание виртуальной машины с помощью UltraSSD](https://github.com/Azure/azure-quickstart-templates/tree/master/101-sql-vm-new-storage-ultrassd)

## <a name="existing-vms"></a>Существующие виртуальные машины

[!INCLUDE [windows-virtual-machines-sql-use-new-management-blade](../../../../includes/windows-virtual-machines-sql-new-resource.md)]

Для имеющихся виртуальных машин SQL Server на портале Azure можно изменить некоторые параметры хранилища. Откройте [Ресурс виртуальных машин SQL](manage-sql-vm-portal.md#access-the-sql-virtual-machines-resource) и выберите **Обзор**. На странице "Обзор SQL Server" отображаются сведения о текущем использовании хранилища вашей виртуальной машиной. На этой диаграмме отображаются все диски, подключенные к виртуальной машине. Дисковое пространство для каждого диска разбито на 4 раздела:

* SQL-данные
* журнал SQL;
* прочее (не хранилище SQL);
* Доступно

Чтобы изменить параметры хранилища, нажмите **Настроить** в разделе **Параметры**. 

![Снимок экрана, посвященный параметру настройки и разделу "использование хранилища".](./media/storage-configuration/sql-vm-storage-configuration-existing.png)

Вы можете изменить параметры диска для дисков, которые были настроены во время создания виртуальной машины SQL Server. При выборе **Расширить диск** открывается страница изменения диска, позволяющая изменить тип диска, а также добавить дополнительные диски. 

![Настройка хранилища для имеющейся виртуальной машины SQL Server](./media/storage-configuration/sql-vm-storage-extend-drive.png)


## <a name="automated-changes"></a>Автоматические изменения

В этом разделе содержится ссылка на изменения конфигурации хранилища, которые автоматически выполняет Azure во время SQL Server подготовки или настройки виртуальной машины в портал Azure.

* Azure настраивает пул носителей из хранилища, выбранного на виртуальной машине. В следующем разделе этой статьи приведены сведения о конфигурации пула носителей.
* При автоматической настройке хранилища всегда используются диски данных P30 [на базе твердотельных накопителей класса Premium](../../../virtual-machines/disks-types.md). Следовательно, между выбранным числом терабайт и количеством дисков, прикрепленных к виртуальной машине, существует полноценное сопоставление.

Сведения о ценах см. на странице [Цены на хранилища Azure](https://azure.microsoft.com/pricing/details/storage) на вкладке **Хранилище дисков**.

### <a name="creation-of-the-storage-pool"></a>Создание пула носителей

Для создания пула носителей на виртуальных машинах SQL Server Azure использует следующие параметры.

| Параметр | Значение |
| --- | --- |
| Размер полосы |256 КБ (хранение данных), 64 КБ (обработка транзакций) |
| Размеры диска |1 ТБ каждый |
| Кэш |Чтение |
| Размер выделения |Размер единицы выделения NTFS — 64 КБ |
| Восстановление | Простая модель восстановления (без устойчивости) |
| Number of columns |Количество дисков данных: до 8<sup>1</sup> |


<sup>1</sup> После создания пула носителей вы не сможете изменить в нем количество столбцов.


### <a name="workload-optimization-settings"></a>Параметры оптимизации рабочей нагрузки

В следующей таблице описаны три доступных типа рабочей нагрузки и соответствующие оптимизации для каждого из них.

| Тип рабочей нагрузки | Описание | Оптимизация |
| --- | --- | --- |
| **Общие сведения** |Значение по умолчанию, поддерживающее большинство рабочих нагрузок |None |
| **Обработка транзакций** |Оптимизирует хранилище для рабочих нагрузок OLTP в традиционных базах данных |Флаг трассировки 1117<br/>Флаг трассировки 1118 |
| **Хранение данных** |Оптимизирует хранилище для рабочих нагрузок аналитики и отчетов |Флаг трассировки 610<br/>Флаг трассировки 1117 |

> [!NOTE]
> Тип рабочей нагрузки можно указать только при подготовке виртуальной машины SQL Server, выбрав ее на шаге настройки хранилища.

## <a name="enable-caching"></a>Включение кэширования 

Измените политику кэширования на уровне диска. Это можно сделать с помощью портал Azure, [PowerShell](/powershell/module/az.compute/set-azvmdatadisk)или [Azure CLI](/cli/azure/vm/disk). 

Чтобы изменить политику кэширования в портал Azure, выполните следующие действия.

1. Завершите работу службы SQL Server. 
1. Войдите на [портал Azure](https://portal.azure.com). 
1. Перейдите к виртуальной машине, в разделе **Параметры** выберите **диски** . 
   
   ![Снимок экрана, показывающий колонку "Конфигурация диска виртуальной машины" в портал Azure.](./media/storage-configuration/disk-in-portal.png)

1. Выберите подходящую политику кэширования для диска из раскрывающегося списка. 

   ![Снимок экрана, показывающий конфигурацию политики кэширования дисков в портал Azure.](./media/storage-configuration/azure-disk-config.png)

1. Когда изменение вступит в силу, перезагрузите SQL Server виртуальную машину и запустите службу SQL Server. 


## <a name="enable-write-accelerator"></a>Включение ускорителя записи

Ускорение записи — это функция диска, доступная только для виртуальных машин серии M. Целью ускорения записи является повышение задержки операций ввода-вывода при записи в хранилище Azure класса Premium, если требуется задержка ввода-вывода в течение одного числа из-за большого объема критически важных рабочих нагрузок OLTP или сред хранилища данных. 

Остановите все действия SQL Server и завершите работу службы SQL Server, прежде чем вносить изменения в политику ускорения записи. 

Если диски чередуются, включите ускорение записи для каждого диска отдельно, и перед внесением изменений необходимо завершить работу виртуальной машины Azure. 

Чтобы включить ускорение записи с помощью портал Azure, выполните следующие действия.

1. Завершите работу службы SQL Server. Если диски распределены, завершите работу виртуальной машины. 
1. Войдите на [портал Azure](https://portal.azure.com). 
1. Перейдите к виртуальной машине, в разделе **Параметры** выберите **диски** . 
   
   ![Снимок экрана, показывающий колонку "Конфигурация диска виртуальной машины" в портал Azure.](./media/storage-configuration/disk-in-portal.png)

1. Выберите параметр кэш с **ускоритель записи** для диска из раскрывающегося списка. 

   ![Снимок экрана, показывающий политику кэша ускорителя записи.](./media/storage-configuration/write-accelerator.png)

1. Когда изменение вступит в силу, запустите виртуальную машину и службу SQL Server. 

## <a name="disk-striping"></a>Чередование дисков

Для повышения пропускной способности можно добавить дополнительные диски с данными и использовать чередование дисков. Чтобы определить количество дисков данных, проанализируйте пропускную способность и пропускную способность, необходимую для файлов данных SQL Server, включая журналы и tempdb. Пропускная способность и ограничения пропускной способности зависят от размера виртуальной машины. Дополнительные сведения см. в статье [Размер виртуальной машины](../../../virtual-machines/sizes.md) .


* Для Windows 8 и Windows Server 2012 или более поздней версии используйте [дисковые пространства](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/hh831739(v=ws.11)), придерживаясь приведенных ниже рекомендаций.

  1. Установите чередование (размер блока чередования) в 64 КБ (65 536 байт), чтобы избежать влияния на производительность из-за неправильного выравнивания разделов. Это следует сделать в PowerShell.

  2. Задайте число столбцов равным количеству физических дисков. Используйте PowerShell (не пользовательский интерфейс диспетчера сервера) при настройке более 8 дисков.

Например, следующая оболочка PowerShell создает новый пул носителей с размером чередования в 64 КБ и число столбцов, равное количеству физических дисков в пуле носителей:

  ```powershell
  $PhysicalDisks = Get-PhysicalDisk | Where-Object {$_.FriendlyName -like "*2" -or $_.FriendlyName -like "*3"}
  
  New-StoragePool -FriendlyName "DataFiles" -StorageSubsystemFriendlyName "Storage Spaces*" `
      -PhysicalDisks $PhysicalDisks | New- VirtualDisk -FriendlyName "DataFiles" `
      -Interleave 65536 -NumberOfColumns $PhysicalDisks .Count -ResiliencySettingName simple `
      –UseMaximumSize |Initialize-Disk -PartitionStyle GPT -PassThru |New-Partition -AssignDriveLetter `
      -UseMaximumSize |Format-Volume -FileSystem NTFS -NewFileSystemLabel "DataDisks" `
      -AllocationUnitSize 65536 -Confirm:$false 
  ```

  * Для Windows 2008 R2 или более ранней версии можно воспользоваться динамическими дисками (чередующимися томами операционной системы), при этом размер чередования всегда составляет 64 КБ. Эта возможность не поддерживается в Windows 8 и Windows Server 2012. Дополнительные сведения см. в заявлении о поддержке в статье [Virtual Disk Service is transitioning to Windows Storage Management API](https://docs.microsoft.com/windows/win32/w8cookbook/vds-is-transitioning-to-wmiv2-based-windows-storage-management-api) (Служба виртуальных дисков переходит на API управления хранилищами Windows).
 
  * Если вы используете [локальные дисковые пространства (S2D)](https://docs.microsoft.com/windows-server/storage/storage-spaces/storage-spaces-direct-in-vm) с [экземплярами отказоустойчивого кластера SQL Server](https://docs.microsoft.com/azure/azure-sql/virtual-machines/windows/failover-cluster-instance-storage-spaces-direct-manually-configure), вам нужно настроить единый пул. Хотя в этом пуле можно создать тома с разной емкостью, они будут иметь общую характеристику, например одну политику кэширования.
 
  * Определите число дисков, связанных с пулом хранилищ, на основании ожидаемой нагрузки. Помните, что в разных размерах виртуальной машины можно подключать различное число дисков данных. Дополнительные сведения см. в статье [размеры виртуальных машин](../../../virtual-machines/sizes.md?toc=/azure/virtual-machines/windows/toc.json).


## <a name="next-steps"></a>Дальнейшие действия

Другие темы, связанные с запуском SQL Server на виртуальных машинах Azure, рассматриваются в статье [SQL Server на виртуальных машинах Azure](sql-server-on-azure-vm-iaas-what-is-overview.md).
