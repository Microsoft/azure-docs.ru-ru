---
title: Учебник. Предварительные требования для группы доступности
description: В этом руководстве показано, как настроить необходимые компоненты для создания группы доступности SQL Server Always On на виртуальных машинах Azure.
services: virtual-machines
documentationCenter: na
author: MashaMSFT
editor: monicar
tags: azure-service-management
ms.assetid: c492db4c-3faa-4645-849f-5a1a663be55a
ms.service: virtual-machines-sql
ms.subservice: hadr
ms.topic: how-to
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 03/29/2018
ms.author: mathoma
ms.custom: seo-lt-2019
ms.openlocfilehash: f5739604537ccc67e2cf57310269369909038d67
ms.sourcegitcommit: e6de1702d3958a3bea275645eb46e4f2e0f011af
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "102508764"
---
# <a name="tutorial-prerequisites-for-creating-availability-groups-on-sql-server-on-azure-virtual-machines"></a>Учебник. Предварительные требования для создания групп доступности на SQL Server на виртуальных машинах Azure

[!INCLUDE[appliesto-sqlvm](../../includes/appliesto-sqlvm.md)]

В этом руководстве показано, как выполнить необходимые условия для создания [группы доступности SQL Server Always on на виртуальных машинах Azure](availability-group-manually-configure-tutorial.md). После завершения предварительных требований у вас будет контроллер домена, две SQL Server виртуальные машины и следящий сервер в одной группе ресурсов.

В этой статье, показано как настроить среду группы доступности вручную, но эту процедуру можно также выполнить с помощью [портала Azure](availability-group-azure-portal-configure.md), [PowerShell или Azure CLI](availability-group-az-commandline-configure.md) либо [шаблонов быстрого запуска Azure](availability-group-quickstart-template-configure.md). 

**Оценка времени**. На завершение настройки необходимых компонентов необходимо несколько часов. Большая часть времени уходит на создание виртуальных машин.

На схеме ниже показаны шаги, которые описываются в этом руководстве.

![группа доступности](./media/availability-group-manually-configure-prerequisites-tutorial-/00-EndstateSampleNoELB.png)

## <a name="review-availability-group-documentation"></a>Обзор документации по группам доступности

В этом руководстве предполагается, что у вас имеется базовое представление о группах доступности AlwaysOn SQL Server. Если вы не знакомы с этой технологией, см. раздел [обзор группы доступности Always On (SQL Server)](/sql/database-engine/availability-groups/windows/overview-of-always-on-availability-groups-sql-server).


## <a name="create-an-azure-account"></a>Создание учетной записи Azure

Вам понадобится учетная запись Azure. Вы можете [создать бесплатную учетную запись Azure](https://signup.azure.com/signup?offer=ms-azr-0044p&appId=102&ref=azureplat-generic) или [активировать преимущества для подписчиков Visual Studio](/visualstudio/subscriptions/subscriber-benefits).

## <a name="create-a-resource-group"></a>Создание группы ресурсов

1. Войдите на [портал Azure](https://portal.azure.com).
2. Выберите **+** , чтобы создать новый объект на портале.

   ![Новый объект](./media/availability-group-manually-configure-prerequisites-tutorial-/01-portalplus.png)

3. В окне поиска **Marketplace** введите **группа ресурсов**.

   ![Группа ресурсов](./media/availability-group-manually-configure-prerequisites-tutorial-/01-resourcegroupsymbol.png)

4. Выберите **Группа ресурсов**.
5. Нажмите кнопку **создания**.
6. В разделе **Имя группы ресурсов** введите имя для группы ресурсов. Например, введите **sql-ha-rg**.
7. При наличии нескольких подписок Azure выберите ту, в которой необходимо создать группу доступности.
8. Выберите расположение. Расположение — это регион Azure, где необходимо создать группу доступности. В этой статье все ресурсы созданы в одном расположении Azure.
9. Убедитесь, что флажок **Закрепить на панели мониторинга** установлен. Этот необязательный параметр позволяет разместить ярлык для группы ресурсов на панели мониторинга портала Azure.

   ![Ярлык группы ресурсов для портал Azure](./media/availability-group-manually-configure-prerequisites-tutorial-/01-resourcegroup.png)

10. Выберите **создать** , чтобы создать группу ресурсов.

В среде Azure будет создана группа ресурсов, а ее ярлык закреплен на портале.

## <a name="create-the-network-and-subnets"></a>Создание сети и подсетей

Следующий шаг — создание сетей и подсетей в группе ресурсов Azure.

В решении используется виртуальная сеть с двумя подсетями. Дополнительные сведения о сетях в Azure см. в разделе [Обзор виртуальной сети](../../../virtual-network/virtual-networks-overview.md).

Чтобы создать виртуальную сеть в портал Azure, выполните следующие действия.

1. В группе ресурсов выберите **+ Добавить**. 

   ![Изменения](./media/availability-group-manually-configure-prerequisites-tutorial-/02-newiteminrg.png)
2. Введите в поле поиска **виртуальная сеть**.

     ![Поиск виртуальной сети](./media/availability-group-manually-configure-prerequisites-tutorial-/04-findvirtualnetwork.png)
3. Щелкните **Виртуальная сеть**.
4. В **виртуальной сети** выберите модель развертывания **Диспетчер ресурсов** и нажмите кнопку **создать**.

    В таблице ниже приведены параметры для виртуальной сети.

   | **Поле** | Значение |
   | --- | --- |
   | **имя**; |autoHAVNET |
   | **Пространство адресов** |10.0.0.0/24 |
   | **Имя подсети** |Административный |
   | **Диапазон адресов подсети** |10.0.0.0/29 |
   | **Подписка** |Укажите подписку, которую нужно использовать. **Подписка.** Если есть только одна подписка, то этот параметр может быть пустым. |
   | **Группа ресурсов** |Выберите **Использовать существующую** и выберите имя группы ресурсов. |
   | **Расположение** |Укажите расположение Azure. |

   Адресное пространство и диапазон адресов подсети могут отличаться от указанных в таблице. В зависимости от подписки портал подскажет доступное адресное пространство и соответствующий диапазон адресов подсети. Если достаточное пространство адресов недоступно, используйте другую подписку.

   В примере используется имя подсети **admin**. Эта подсеть для контроллеров домена.

5. Нажмите кнопку **создания**.

   ![Настройка виртуальной сети](./media/availability-group-manually-configure-prerequisites-tutorial-/06-configurevirtualnetwork.png)

Вы вернетесь к панели мониторинга портала Azure и получите уведомление о создании сети.

### <a name="create-a-second-subnet"></a>Создание второй подсети

Новая виртуальная сеть имеет одну подсеть с именем **admin**. Ее используют контроллеры домена. Виртуальные машины SQL Server используют вторую подсеть, **SQL**. Чтобы настроить эту подсеть, сделайте следующее:

1. На панели мониторинга выберите созданную группу ресурсов **SQL-Ha-RG**. Найдите сеть в группе ресурсов в разделе **Ресурсы**.

    Если **SQL-Ha-RG** не отображается, найдите его, выбрав **группы ресурсов** и выполнив фильтрацию по имени группы ресурсов.

2. Выберите **autoHAVNET** в списке ресурсов. 
3. В виртуальной сети **autoHAVNET** выберите **Параметры**, а затем — **Подсети**.

    Обратите внимание на созданную подсеть.

   ![Обратите внимание на уже созданную подсеть.](./media/availability-group-manually-configure-prerequisites-tutorial-/07-addsubnet.png)

5. Чтобы создать вторую подсеть, выберите **+ Subnet (+ подсеть**).
6. В колонке **Добавление подсети** настройте подсеть, указав в поле **Имя** значение **sqlsubnet**. Azure автоматически укажет допустимое значение в поле **Диапазон адресов**. Убедитесь, что этот диапазон адресов содержит по крайней мере 10 адресов. Для рабочей среды может потребоваться больше адресов.
7. Щелкните **ОК**.

    ![Настройка подсети](./media/availability-group-manually-configure-prerequisites-tutorial-/08-configuresubnet.png)

В следующей таблице описаны параметры конфигурации сети.

| **Поле** | Значение |
| --- | --- |
| **имя**; |**autoHAVNET** |
| **Пространство адресов** |Это значение зависит от доступных адресных пространств в подписке. Стандартное значение — 10.0.0.0/16. |
| **Имя подсети** |**admin** |
| **Диапазон адресов подсети** |Это значение зависит от доступных диапазонов адресов в подписке. Стандартное значение — 10.0.0.0/24. |
| **Имя подсети** |**sqlsubnet** |
| **Диапазон адресов подсети** |Это значение зависит от доступных диапазонов адресов в подписке. Стандартное значение — 10.0.1.0/24. |
| **Подписка** |Укажите подписку, которую нужно использовать. |
| **Группа ресурсов** |**SQL-HA-RG** |
| **Расположение** |Укажите расположение, выбранное для группы ресурсов. |

## <a name="create-availability-sets"></a>Создание групп доступности

Прежде чем создавать виртуальные машины, необходимо создать группы доступности. Такие группы позволяют сократить простой при плановых и внеплановых событиях обслуживания. Группа доступности Azure представляет собой логическую группу ресурсов, которую Azure помещает в физические домены сбоя и домены обновления. Домен сбоя обеспечивает разделение ресурсов питания и сетевых ресурсов для элементов группы доступности. Домен обновления гарантирует, что элементы группы доступности не отключаются для обслуживания одновременно. Дополнительные сведения см. в статье [Управление доступностью виртуальных машин](../../../virtual-machines/availability.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json).

Вам потребуется две группы доступности: одна для контроллеров домена, а вторая для виртуальных машин SQL Server.

Чтобы создать группу доступности, перейдите к группе ресурсов и выберите **Добавить**. Отфильтруйте результаты по запросу **Группа доступности**. В результатах выберите **Группа доступности** и нажмите кнопку **создать**.

Настройте две группы доступности в соответствии с параметрами в таблице ниже.

| **Поле** | Группа доступности контроллера домена | Группа доступности SQL Server |
| --- | --- | --- |
| **имя**; |adavailabilityset |sqlavailabilityset |
| **Группа ресурсов** |SQL-HA-RG |SQL-HA-RG |
| **Домены сбоя** |3 |3 |
| **Домены обновления** |5 |3 |

Создав группы доступности, вернитесь в колонку группы ресурсов на портале Azure.

## <a name="create-domain-controllers"></a>Создание контроллеров домена

После создания сети, подсетей и групп доступности вы можете приступать к созданию виртуальных машин для контроллеров домена.

### <a name="create-virtual-machines-for-the-domain-controllers"></a>Создание виртуальных машин для контроллеров домена

Чтобы создать и настроить контроллеры домена, вернитесь к группе ресурсов **SQL-HA-RG** .

1. Выберите **Добавить**. 
2. Введите **Windows Server 2016 Datacenter**.
3. Выберите **Windows Server 2016 Datacenter**. В **Windows Server 2016 Datacenter** убедитесь, что модель развертывания **Диспетчер ресурсов**, и нажмите кнопку **создать**. 

Повторите действия выше, чтобы создать две виртуальные машины. Присвойте этим виртуальным машинам следующие имена:

* ad-primary-dc
* ad-secondary-dc.

  > [!NOTE]
  > **ad-secondary-dc** — дополнительная виртуальная машина, служащая для обеспечения высокого уровня доступности доменных служб Active Directory.
  >

В таблице ниже приведены параметры для этих двух машин.

| **Поле** | Значение |
| --- | --- |
| **имя**; |Первый контроллер домена: *ad-primary-dc*.</br>Второй контроллер домена *ad-secondary-dc*. |
| **Тип диска виртуальной машины** |SSD |
| **User name** |DomainAdmin |
| **Пароль** |Contoso!0000 |
| **Подписка** |*Ваша подписка* |
| **Группа ресурсов** |SQL-HA-RG |
| **Расположение** |*Ваше расположение* |
| **Размер** |DS1_V2 |
| **Память** | **Использование управляемых дисков** - **Да** |
| **Виртуальная сеть** |autoHAVNET |
| **Подсеть** |admin |
| **Общедоступный IP-адрес** |*Совпадает с именем виртуальной машины* |
| **группа безопасности сети**. |*Совпадает с именем виртуальной машины* |
| **группа доступности;** |adavailabilityset </br>**Домены сбоя**: 2 </br>**Домены обновления**: 2|
| **Диагностика** |Активировано |
| **Учетная запись хранения для диагностики** |*Создается автоматически* |

   >[!IMPORTANT]
   >Виртуальную машину можно разместить в группе доступности только при ее создании. После создания виртуальной машины группу доступности изменить невозможно. Дополнительные сведения см. в статье [Управление доступностью виртуальных машин](../../../virtual-machines/availability.md).

Azure создаст виртуальные машины.

После создания виртуальных машин следует настроить контроллер домена.

### <a name="configure-the-domain-controller"></a>Настройка контроллера домена

На следующих этапах необходимо настроить машину **ad-primary-dc** в качестве контроллера домена для corp.contoso.com.

1. На портале откройте группу ресурсов **SQL-HA-RG** и выберите машину **ad-primary-dc**. В **AD-PRIMARY-DC** нажмите кнопку **Подключиться** , чтобы открыть файл RDP для доступа к удаленному рабочему столу.

    ![Подключение к виртуальной машине](./media/availability-group-manually-configure-prerequisites-tutorial-/20-connectrdp.png)

2. Войдите в систему, используя настроенную учетную запись администратора ( **\DomainAdmin**) и ее пароль (**Contoso!0000**).
3. По умолчанию отображается панель мониторинга **Диспетчер серверов** .
4. На панели мониторинга щелкните ссылку **Добавить роли и компоненты** .

    ![Диспетчер сервера. Добавление ролей](./media/availability-group-manually-configure-prerequisites-tutorial-/22-addfeatures.png)

5. Нажимайте **Далее**, пока не откроется раздел **Роли сервера**.
6. Выберите роли **Доменные службы Active Directory** и **DNS-сервер**. При появлении запроса добавьте требуемые для этих ролей дополнительные компоненты.

   > [!NOTE]
   > Windows предупреждает о том, что статического IP-адреса не существует. Если вы тестируете конфигурацию, нажмите кнопку **продолжить**. Для рабочих сценариев на портале Azure установите статический IP-адрес или [используйте PowerShell для установки статического IP-адреса компьютера контроллера домена](/previous-versions/azure/virtual-network/virtual-networks-reserved-private-ip).
   >

    ![Диалоговое окно добавления ролей](./media/availability-group-manually-configure-prerequisites-tutorial-/23-addroles.png)

7. Выберите **Далее** , пока не появится раздел **подтверждения** . Установите флажок **Автоматически перезапускать конечный сервер, если это потребуется**.
8. Нажмите кнопку **Установить**.
9. После установки компонентов вернитесь к панели мониторинга **Диспетчер серверов** .
10. Выберите новый вариант **AD DS** на левой панели.
11. Щелкните ссылку **Дополнительно** на желтой панели предупреждений.

    ![Диалоговое окно службы каталогов Active Directory на виртуальной машине DNS-сервера](./media/availability-group-manually-configure-prerequisites-tutorial-/24-addsmore.png)
    
12. В столбце **действие** диалогового окна **сведения о задаче все сервера** выберите **повысить уровень этого сервера до контроллера домена**.
13. В **мастере настройки доменных служб Active Directory** используйте следующие значения:

    | **Страница** | Параметр |
    | --- | --- |
    | **Конфигурация развертывания** |**Добавить новый лес**<br/> **Имя корневого домена** = corp.contoso.com |
    | **Параметры контроллера домена** |**Пароль DSRM** = Contoso!0000<br/>**Подтверждение пароля** = Contoso!0000 |

14. Нажмите кнопку **Далее** , чтобы просмотреть другие страницы мастера. Убедитесь, что на странице **Проверка предварительных требований** отображается следующее сообщение: **Все проверки готовности к установке выполнены успешно**. Можно просмотреть все применимые предупреждающие сообщения, хотя для продолжения установки это и не обязательно.
15. Нажмите кнопку **Установить**. Виртуальная машина **ad-primary-dc** перезагружается автоматически.

### <a name="note-the-ip-address-of-the-primary-domain-controller"></a>Запишите IP-адрес основного контроллера домена.

Используйте основной контроллер домена для DNS. Запишите IP-адрес основного контроллера домена.

Получить IP-адрес основного контроллера домена можно только через портал Azure.

1. На портале Azure откройте группу ресурсов.

2. Выберите основной контроллер домена.

3. На основном контроллере домена выберите **Сетевые интерфейсы**.

![Сетевые интерфейсы](./media/availability-group-manually-configure-prerequisites-tutorial-/25-primarydcip.png)

Сохраните частный IP-адрес для этого сервера.

### <a name="configure-the-virtual-network-dns"></a>Настройка DNS виртуальной сети

После создания первого контроллера домена и включения DNS на первом сервере, настройте виртуальную сеть для использования этого сервера для DNS.

1. В портал Azure выберите виртуальную сеть.

2. В разделе **Параметры** выберите **DNS-сервер**.

3. Выберите **Настраиваемый** и введите частный IP-адрес основного контроллера домена.

4. Щелкните **Сохранить**.

### <a name="configure-the-second-domain-controller"></a>Настройка второго контроллера домена

После перезагрузки основного контроллера домена можно настроить второй контроллер домена. Этот необязательный шаг выполняется для обеспечения высокой доступности. Чтобы настроить второй контроллер домена, сделайте следующее:

1. На портале откройте группу ресурсов **SQL-HA-RG** и выберите машину **ad-secondary-dc**. В **AD-Secondary-DC** нажмите кнопку **Подключиться** , чтобы открыть файл RDP для доступа к удаленному рабочему столу.
2. Войдите в виртуальную машину, используя настроенную учетную запись администратора (**BUILTIN\DomainAdmin**) и ее пароль (**Contoso!0000**).
3. Измените предпочтительный адрес DNS-сервера на адрес контроллера домена.
4. В **центре управления сетями и общим доступом** выберите сетевой интерфейс.

   ![Сетевой интерфейс](./media/availability-group-manually-configure-prerequisites-tutorial-/26-networkinterface.png)

5. Выберите **Свойства**.
6. Выберите **протокол IP версии 4 (TCP/IPv4)** и щелкните **свойства**.
7. Выберите **использовать следующие адреса DNS-серверов** , а затем укажите адрес основного контроллера домена на **предпочитаемом DNS-сервере**.
8. Нажмите кнопку **ОК**, а затем **Закрыть** , чтобы зафиксировать изменения. Теперь вы можете присоединить виртуальную машину к домену **corp.contoso.com**.

   >[!IMPORTANT]
   >Если вы потеряете подключение к удаленному рабочему столу после изменения параметров DNS-сервера, перейдите на портал Azure и перезапустите виртуальную машину.

9. С удаленного рабочего стола на втором контроллере домена откройте **панель мониторинга диспетчера сервера**.
10. На панели мониторинга щелкните ссылку **Добавить роли и компоненты** .

    ![Диспетчер сервера. Добавление ролей](./media/availability-group-manually-configure-prerequisites-tutorial-/22-addfeatures.png)
11. Нажимайте **Далее**, пока не откроется раздел **Роли сервера**.
12. Выберите роли **Доменные службы Active Directory** и **DNS-сервер**. При появлении запроса добавьте требуемые для этих ролей дополнительные компоненты.
13. После установки компонентов вернитесь к панели мониторинга **Диспетчер серверов** .
14. Выберите новый вариант **AD DS** на левой панели.
15. Щелкните ссылку **Дополнительно** на желтой панели предупреждений.
16. В столбце **действие** диалогового окна **сведения о задаче все сервера** выберите **повысить уровень этого сервера до контроллера домена**.
17. На вкладке **Конфигурация развертывания** установите переключатель **Добавить контроллер домена в существующий домен**.

    ![Конфигурация развертывания](./media/availability-group-manually-configure-prerequisites-tutorial-/28-deploymentconfig.png)

18. Нажмите кнопку **Выбрать**.
19. Подключитесь, используя учетную запись администратора (**CORP.CONTOSO.COM\domainadmin**) и ее пароль (**Contoso!0000**).
20. В списке **выберите домен из леса** выберите свой домен и нажмите кнопку **ОК**.
21. В разделе **Параметры контроллера домена** используйте значения по умолчанию и задайте пароль DSRM.

    >[!NOTE]
    >На странице **Параметры DNS** может отобразиться предупреждение о том, что делегирование для этого DNS-сервера создать невозможно. В нерабочей среде это предупреждение можно игнорировать.
    >

22. Нажмите кнопку **Далее** , пока диалоговое окно не достигнет проверки **готовности** к установке. Щелкните **Установить**.

После завершения изменений конфигурации перезапустите сервер.

### <a name="add-the-private-ip-address-to-the-second-domain-controller-to-the-vpn-dns-server"></a>Добавьте частный IP-адрес во второй контроллер домена на DNS-сервер VPN.

На портале Azure в колонке виртуальной сети измените параметры DNS-сервера, добавив IP-адрес дополнительного контроллера домена. Этот параметр обеспечивает избыточность службы DNS.

### <a name="configure-the-domain-accounts"></a><a name="DomainAccounts"></a>Настройка доменных учетных записей

На следующих шагах настраиваются учетные записи Active Directory. Учетные записи показаны в следующей таблице.

| |Учетная запись установки<br/> |sqlserver-0 <br/>Учетная запись SQL Server и службы агента SQL |sqlserver-1<br/>Учетная запись SQL Server и службы агента SQL
| --- | --- | --- | ---
|**First Name** |Установка |SQLSvc1 | SQLSvc2
|**User SamAccountName** |Установка |SQLSvc1 | SQLSvc2

Чтобы создать каждую учетную запись, сделайте следующее:

1. Войдите в виртуальную машину **ad-primary-dc**.
2. В **Диспетчер сервера** выберите **инструменты** и щелкните **центр администрирования Active Directory**.   
3. Выберите **corp (local)** в левой области.
4. В правой области **задачи** выберите **создать**, а затем выберите **пользователь**.

   ![Центр администрирования Active Directory](./media/availability-group-manually-configure-prerequisites-tutorial-/29-addcnewuser.png)

   >[!TIP]
   >Задайте сложный пароль для каждой учетной записи.<br/> Для нерабочей среды задайте неограниченный срок действия учетной записи пользователя.
   >

5. Нажмите кнопку **ОК** , чтобы создать пользователя.
6. Повторите предыдущие действия для каждой из трех учетных записей.

### <a name="grant-the-required-permissions-to-the-installation-account"></a>Предоставление требуемых разрешений учетной записи установки

1. В **центре администрирования Active Directory** выберите **corp (локальный)** на левой панели. Затем в правой области **задачи** выберите **свойства**.

    ![Свойства пользователя CORP](./media/availability-group-manually-configure-prerequisites-tutorial-/31-addcproperties.png)

2. Выберите **расширения**, а затем нажмите кнопку **Дополнительно** на вкладке **Безопасность** .
3. В диалоговом окне **Дополнительные параметры безопасности для Corp** выберите **Добавить**.
4. Щелкните **выбрать участника**, выполните поиск по запросу **CORP\Install**, а затем нажмите кнопку **ОК**.
5. Установите флажок **Чтение всех свойств**.

6. Установите флажок **Create Computer objects** (Создание объектов-компьютеров).

     ![Разрешения пользователя CORP](./media/availability-group-manually-configure-prerequisites-tutorial-/33-addpermissions.png)

7. Щелкните **ОК**, а затем снова **ОК**. Закройте окно свойств **corp**.

После завершения настройки Active Directory и объектов-пользователей нужно создать две виртуальные машины SQL Server и виртуальную машину следящего сервера. Затем присоедините их к этому домену.

## <a name="create-sql-server-vms"></a>Создание виртуальных машин SQL Server

Создайте три дополнительные виртуальные машины. Для решения требуются две виртуальные машины с экземплярами SQL Server. Третья виртуальная машина будет выполнять роль свидетеля. Windows Server 2016 может использовать [облако-свидетель](/windows-server/failover-clustering/deploy-cloud-witness). Однако для обеспечения согласованности с предыдущими операционными системами в этой статье для следящего сервера используется виртуальная машина.  

Перед продолжением рассмотрите следующие решения разработки.

* **Хранилище — управляемые диски Azure**

   Для хранилища виртуальных машин используйте управляемые диски Azure. Корпорация Майкрософт рекомендует управляемые диски для виртуальных машин SQL Server. Управляемые диски управляют хранилищем в фоновом режиме. Кроме того, когда виртуальные машины с управляемыми дисками находятся в одной группе доступности, Azure распределяет ресурсы хранения, чтобы обеспечить соответствующую избыточность. Дополнительные сведения см. в [обзоре управляемых дисков Azure](../../../virtual-machines/managed-disks-overview.md). Подробные сведения об управляемых дисках в группе доступности см. в разделе [Использование управляемых дисков для виртуальных машин в группе доступности](../../../virtual-machines/availability.md).

* **Сеть — частные IP-адреса в рабочей среде**

   В этом руководстве для виртуальных машин используются общедоступные IP-адреса. Общедоступный IP-адрес обеспечивает удаленное подключение непосредственно к виртуальной машине через Интернет и упрощает настройку. Корпорация Майкрософт рекомендует использовать в рабочих средах только частные IP-адреса для снижения уязвимости ресурса виртуальной машины с экземпляром SQL Server.

* **Сеть — рекомендуется одна сетевая карта на сервер** 

Используйте одну сетевую карту на сервер (узел кластера) и одну подсеть. Сеть Azure имеет физическую избыточность, что делает дополнительные сетевые карты и подсети ненужными в гостевом кластере виртуальной машины Azure. Отчет о проверке кластера выдаст предупреждение о том, что узлы доступны только в одной сети. Это предупреждение можно игнорировать в гостевых отказоустойчивых кластерах виртуальных машин Azure.

### <a name="create-and-configure-the-sql-server-vms"></a>Создание и настройка виртуальных машин SQL Server

Затем создайте три виртуальные машины — две SQL Server виртуальные машины и одну виртуальную машину для дополнительного узла кластера. Чтобы создать каждую из виртуальных машин, вернитесь в группу ресурсов **SQL-Ha-RG** и нажмите кнопку **Добавить**. Найдите нужный элемент коллекции, выберите **Виртуальная машина**, а затем выберите **из коллекции**. Используйте информацию из следующей таблицы, чтобы упростить создание виртуальных машин.


| Страница | VM1 | VM2 | VM3 |
| --- | --- | --- | --- |
| Выбор соответствующего элемента коллекции |**Windows Server 2016 Datacenter** |**SQL Server 2016 SP1 Enterprise на базе Windows Server 2016** |**SQL Server 2016 SP1 Enterprise на базе Windows Server 2016** |
| Конфигурация виртуальной машины **Базовый** |**Имя** = cluster-fsw<br/>**Имя пользователя** = DomainAdmin<br/>**Пароль** = Contoso!0000<br/>**Подписка** = ваша подписка<br/>**Группа ресурсов** = SQL-HA-RG<br/>**Расположение** — расположение Azure. |**Имя** = sqlserver-0<br/>**Имя пользователя** = DomainAdmin<br/>**Пароль** = Contoso!0000<br/>**Подписка** = ваша подписка<br/>**Группа ресурсов** = SQL-HA-RG<br/>**Расположение** — расположение Azure. |**Имя** = sqlserver-1<br/>**Имя пользователя** = DomainAdmin<br/>**Пароль** = Contoso!0000<br/>**Подписка** = ваша подписка<br/>**Группа ресурсов** = SQL-HA-RG<br/>**Расположение** — расположение Azure. |
| Конфигурация виртуальной машины **Размер** |**РАЗМЕР** = DS1\_V2 (1 виртуальный ЦП, 3,5 ГБ) |**РАЗМЕР** = DS2\_V2 (2 виртуальных ЦП, 7 ГБ)</br>Размер должен поддерживать SSD-хранилище (поддержка дисков "Премиум" )) |**РАЗМЕР** = DS2\_V2 (2 виртуальных ЦП, 7 ГБ) |
| Конфигурация виртуальной машины **Параметры** |**Служба хранилища**: Использует управляемые диски.<br/>**Виртуальная сеть** = autoHAVNET<br/>**Подсеть** = sqlsubnet(10.1.1.0/24)<br/>**Общедоступный IP-адрес** создается автоматически.<br/>**Группа безопасности сети** = нет<br/>**Диагностика мониторинга** = включено<br/>**Учетная запись хранения для диагностики** = используйте автоматически созданную учетную запись хранения<br/>**Группа доступности** = sqlAvailabilitySet<br/> |**Служба хранилища**: Использует управляемые диски.<br/>**Виртуальная сеть** = autoHAVNET<br/>**Подсеть** = sqlsubnet(10.1.1.0/24)<br/>**Общедоступный IP-адрес** создается автоматически.<br/>**Группа безопасности сети** = нет<br/>**Диагностика мониторинга** = включено<br/>**Учетная запись хранения для диагностики** = используйте автоматически созданную учетную запись хранения<br/>**Группа доступности** = sqlAvailabilitySet<br/> |**Служба хранилища**: Использует управляемые диски.<br/>**Виртуальная сеть** = autoHAVNET<br/>**Подсеть** = sqlsubnet(10.1.1.0/24)<br/>**Общедоступный IP-адрес** создается автоматически.<br/>**Группа безопасности сети** = нет<br/>**Диагностика мониторинга** = включено<br/>**Учетная запись хранения для диагностики** = используйте автоматически созданную учетную запись хранения<br/>**Группа доступности** = sqlAvailabilitySet<br/> |
| Конфигурация виртуальной машины **Параметры SQL Server** |Неприменимо |**Подключение к SQL** = закрытое (в виртуальной сети)<br/>**Порт** = 1433<br/>**Проверка подлинности SQL** = отключено<br/>**Конфигурация хранилища** = общая<br/>**Автоматическое исправление** = воскресенье в 2:00<br/>**Автоматическая архивация** = отключено</br>**Интеграция хранилища ключей Azure** = отключено |**Подключение к SQL** = закрытое (в виртуальной сети)<br/>**Порт** = 1433<br/>**Проверка подлинности SQL** = отключено<br/>**Конфигурация хранилища** = общая<br/>**Автоматическое исправление** = воскресенье в 2:00<br/>**Автоматическая архивация** = отключено</br>**Интеграция хранилища ключей Azure** = отключено |

<br/>

> [!NOTE]
> Предлагаемые здесь размеры компьютеров предназначены для тестирования групп доступности на виртуальных машинах Azure. Для обеспечения оптимальной производительности рабочих нагрузок см. рекомендации по размерам машин SQL Server и их настройке в статье [Рекомендации по оптимизации производительности SQL Server в виртуальных машинах Azure](performance-guidelines-best-practices.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json).
>

После завершения подготовки трех виртуальных машин вам потребуется присоединить их к домену **corp.contoso.com** и предоставить пользователю CORP\Install права администратора виртуальных машин.

### <a name="join-the-servers-to-the-domain"></a><a name="joinDomain"></a>Присоединение серверов к домену

Теперь вы можете присоединить виртуальные машины к домену **corp.contoso.com**. Выполните следующие действия для виртуальных машин SQL Server и сервера файловых ресурсов-свидетелей.

1. Удаленно подключитесь к виртуальной машине в качестве пользователя **BUILTIN\DomainAdmin**.
2. В **диспетчере сервера** выберите **Локальный сервер**.
3. Выберите ссылку **Рабочая группа** .
4. В разделе **имя компьютера** выберите **изменить**.
5. Установить флажок **Домен** и введите в текстовом поле **corp.contoso.com**. Щелкните **ОК**.
6. Во всплывающем диалоговом окне **Безопасность Windows** укажите имя (**CORP\DomainAdmin**) и пароль (**Contoso!0000**) учетной записи администратора домена по умолчанию.
7. Когда появится сообщение "Добро пожаловать в corp.contoso.com домен", нажмите кнопку **ОК**.
8. Нажмите кнопку **Закрыть**, а затем в диалоговом окне всплывающее окно выберите **перезагрузить** .

## <a name="add-accounts"></a>Добавление учетных записей

Добавьте учетную запись установки в качестве администратора на каждой виртуальной машине, предоставьте разрешения учетной записи установки и локальных учетных записей в SQL Server и обновите учетную запись службы SQL Server. 

### <a name="add-the-corpinstall-user-as-an-administrator-on-each-cluster-vm"></a>Добавление пользователя Corp\Install в качестве администратора на каждой виртуальной машине кластера

После того как каждая виртуальная машина будет перезапущена и войдет в состав домена, добавьте **CORP\Install** как участника группы локальных администраторов.

1. Дождитесь перезапуска виртуальной машины, а затем запустите RDP-файл еще раз на основном контроллере домена, чтобы войти на **sqlserver-0**, используя учетную запись **CORP\DomainAdmin**.

   >[!TIP]
   >Обязательно выполните вход с использованием учетной записи администратора домена. Ранее вы использовали учетную запись администратора BUILTIN. Теперь, когда сервер находится в домене, используйте учетную запись домена. В сеансе RDP укажите *Домен*\\*имя пользователя*.
   >

2. В **Диспетчер сервера** выберите **инструменты**, а затем — **Управление компьютером**.
3. В окне **Управление компьютерами** разверните пункт **Локальные пользователи и группы**, а затем выберите **Группы**.
4. Дважды щелкните группу **Администраторы** .
5. В диалоговом окне **Свойства администратора** нажмите кнопку **Добавить** .
6. Введите **CORP\Install** пользователя и нажмите кнопку **ОК**.
7. Нажмите кнопку **ОК** , чтобы закрыть диалоговое окно **Свойства администратора** .
8. Повторите описанные выше шаги для **sqlserver-1** и **cluster-fsw**.


### <a name="create-a-sign-in-on-each-sql-server-vm-for-the-installation-account"></a>Создание на каждой виртуальной машине SQL Server имени для входа для учетной записи установки

Используйте учетную запись установки (CORP\install), чтобы настроить группу доступности. Эта учетная запись должна быть участником фиксированной роли сервера **sysadmin** на каждой виртуальной машине SQL Server. Чтобы создать имя для входа для учетной записи установки, сделайте следующее.

1. Подключитесь к серверу по протоколу удаленного рабочего стола (RDP) с помощью учетной записи *\<MachineName\>\DomainAdmin*.

1. Откройте SQL Server Management Studio и подключитесь к локальному экземпляру сервера SQL Server.

1. В **обозревателе объектов** выберите **Безопасность**.

1. Щелкните правой кнопкой мыши **Имена входа**. Выберите **создать имя входа**.

1. В меню **Создание имени входа** выберите **Поиск**.

1. Выберите **расположения**.

1. Введите сетевые учетные данные администратора домена.

1. Используйте учетную запись установки (CORP\install).

1. Сделайте имя для входа участником фиксированной роли сервера **sysadmin**.

1. Щелкните **ОК**.

Повторите эти действия на другой виртуальной машине SQL Server.

### <a name="configure-system-account-permissions"></a>Настройка разрешений системной учетной записи

Чтобы создать учетную запись для системной учетной записи и предоставить соответствующие разрешения, выполните указанные ниже действия в каждом экземпляре SQL Server.

1. Создайте учетную запись для `[NT AUTHORITY\SYSTEM]` в каждом экземпляре SQL Server. Для этого используйте следующий сценарий.

   ```sql
   USE [master]
   GO
   CREATE LOGIN [NT AUTHORITY\SYSTEM] FROM WINDOWS WITH DEFAULT_DATABASE=[master]
   GO 
   ```

1. Предоставьте указанные ниже разрешения для `[NT AUTHORITY\SYSTEM]` в каждом экземпляре SQL Server.

   - `ALTER ANY AVAILABILITY GROUP`
   - `CONNECT SQL`
   - `VIEW SERVER STATE`

   Для этого используйте следующий сценарий.

   ```sql
   GRANT ALTER ANY AVAILABILITY GROUP TO [NT AUTHORITY\SYSTEM]
   GO
   GRANT CONNECT SQL TO [NT AUTHORITY\SYSTEM]
   GO
   GRANT VIEW SERVER STATE TO [NT AUTHORITY\SYSTEM]
   GO 
   ```

### <a name="set-the-sql-server-service-accounts"></a><a name="setServiceAccount"></a>Настройка учетных записей службы SQL Server

На каждой виртуальной машине SQL Server настройте учетную запись службы SQL Server. Используйте учетные записи, созданные при настройке учетных записей домена.

1. Откройте **Диспетчер конфигурации SQL Server**.
2. Щелкните правой кнопкой мыши службу SQL Server и выберите пункт **Свойства**.
3. Настройте учетную запись и задайте пароль.
4. Повторите эти действия на другой виртуальной машине SQL Server.  

Для групп доступности SQL Server каждая виртуальная машине SQL Server должна запускаться как учетная запись домена.

## <a name="add-failover-clustering-features-to-both-sql-server-vms"></a>Добавление функций отказоустойчивого кластера на обеих виртуальных машинах SQL Server

Чтобы добавить функции отказоустойчивого кластера, на обеих виртуальных машинах SQL Server сделайте следующее.

1. Подключитесь к виртуальной машине SQL Server по протоколу удаленного рабочего стола (RDP) с помощью учетной записи *CORP\install*. Откройте **панель мониторинга диспетчера сервера**.
2. На панели мониторинга щелкните ссылку **Добавить роли и компоненты** .

    ![Диспетчер сервера. Добавление ролей](./media/availability-group-manually-configure-prerequisites-tutorial-/22-addfeatures.png)

3. Нажимайте кнопку **Далее**, пока не откроется раздел **Server Features** (Функции сервера).
4. В разделе **функций** выберите **Отказоустойчивость кластеров**.
5. Добавьте другие необходимые функции.
6. Нажмите кнопку **установить** , чтобы добавить компоненты.

Повторите эти действия на другой виртуальной машине SQL Server.

  >[!NOTE]
  > Этот шаг вместе с фактическим присоединением виртуальных машин SQL Server к отказоустойчивому кластеру теперь можно автоматизировать с помощью [интерфейса командной строки виртуальной машины Azure SQL](./availability-group-az-commandline-configure.md) и [шаблонов быстрого запуска Azure](availability-group-quickstart-template-configure.md).
  >

### <a name="tuning-failover-cluster-network-thresholds"></a>Настройка пороговых значений сети отказоустойчивого кластера

При запуске узлов отказоустойчивого кластера Windows на виртуальных машинах Azure с SQL Server группами доступности измените параметр кластера на более неявное состояние мониторинга.  Это сделает кластер более стабильным и надежным.  Дополнительные сведения см. в разделе [IaaS с пороговыми значениями сети отказоустойчивого кластера SQL Server](/windows-server/troubleshoot/iaas-sql-failover-cluster).


## <a name="configure-the-firewall-on-each-sql-server-vm"></a><a name="endpoint-firewall"></a> Настройка брандмауэра на каждой виртуальной машине SQL Server

Это решение требует, чтобы в брандмауэре были открыты следующие TCP-порты:

- **SQL Server виртуальная машина**: порт 1433 для экземпляра по умолчанию SQL Server.
- **Проба балансировщика нагрузки Azure:** Любой доступный порт. В примерах часто используется 59999.
- **Конечная точка зеркального отображения базы данных:** Любой доступный порт. В примерах часто используется 5022.

Порты брандмауэра должны быть открыты на обеих виртуальных машинах SQL Server.

Метод открытия портов зависит от используемого решения брандмауэра. В следующем разделе показано, как открыть порты в брандмауэре Windows. Откройте необходимые порты на каждой из виртуальных машин SQL Server.

### <a name="open-a-tcp-port-in-the-firewall"></a>Открытие TCP-порта в брандмауэре

1. На первом сервере SQL Server на **начальном экране** запустите **Брандмауэр Windows в режиме повышенной безопасности**.
2. В левой области выберите **Правила для входящих подключений**. На правой панели выберите **создать правило**.
3. Для параметра **Тип правила** выберите **Порт**.
4. Для порта выберите тип **TCP** и введите соответствующие номера портов. См. следующий пример.

   ![Брандмауэр SQL](./media/availability-group-manually-configure-prerequisites-tutorial-/35-tcpports.png)

5. Выберите **Далее**.
6. На странице **действие** установите флажок **Разрешить подключение** выбранным, а затем нажмите кнопку **Далее**.
7. На странице **профиль** примите параметры по умолчанию, а затем нажмите кнопку **Далее**.
8. На странице **имя** укажите имя правила (например, **проба нагрузки Azure**) в текстовом поле **имя** , а затем нажмите кнопку **Готово**.

Повторите эти действия на второй виртуальной машине SQL Server.


## <a name="next-steps"></a>Дальнейшие действия

* [Создание SQL Server Always On группы доступности на виртуальных машинах Azure](availability-group-manually-configure-tutorial.md)
