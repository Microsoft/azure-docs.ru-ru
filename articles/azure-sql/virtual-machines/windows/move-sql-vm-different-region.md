---
title: Перемещение виртуальной машины в другой регион (Azure Site Recovery)
description: Узнайте, как перенести виртуальную машину SQL Server из одного региона Azure в другой.
services: virtual-machines-windows
documentationcenter: na
author: MashaMSFT
tags: azure-resource-manager
ms.assetid: aa5bf144-37a3-4781-892d-e0e300913d03
ms.service: virtual-machines-sql
ms.subservice: migration
ms.topic: how-to
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 07/30/2019
ms.author: mathoma
ms.reviewer: jroth
ms.custom: seo-lt-2019
ms.openlocfilehash: 789554121af1c83d9077e6153ca9db01477bde25
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "97360158"
---
# <a name="move-a-sql-server-vm-to-another-region-within-azure-with-azure-site-recovery"></a>Перемещение SQL Server виртуальной машины в другой регион в Azure с помощью Azure Site Recovery
[!INCLUDE[appliesto-sqlvm](../../includes/appliesto-sqlvm.md)]

В этой статье рассказывается, как использовать Azure Site Recovery для переноса виртуальной машины SQL Server из одного региона Azure в другой. 

Для переноса виртуальной машины SQL Server в другой регион требуется выполнить следующие действия:
1. [Подготовка](#prepare-to-move). Убедитесь, что исходная виртуальная машина SQL Server и целевой регион правильно подготовлены для переноса. 
1. [Настройка](#configure-azure-site-recovery-vault). Для переноса виртуальной машины SQL Server требуется, чтобы она была реплицируемым объектом в хранилище Azure Site Recovery. Необходимо добавить виртуальную машину SQL Server в хранилище Azure Site Recovery. 
1. [Тестирование](#test-move-process). Перенос виртуальной машины SQL Server требует ее переключения с исходного региона на реплицированный целевой регион в рамках отработки отказа. Чтобы убедиться в том, что процесс перемещения завершится успешно, необходимо сначала проверить, может успешно выполнить отработку отказа виртуальной машины SQL Server в целевой регион. Это поможет выявить возможные проблемы и избежать их при фактическом переносе. 
1. [Перенос](#move-the-sql-server-vm). После успешного тестирования отработки можно выполнить перенос виртуальной машины SQL Server в целевой регион. 
1. [Очистка](#clean-up-source-resources). Чтобы избежать расходов при выставлении счетов, удалите виртуальную машину SQL Server из хранилища и очистите все ненужные ресурсы, оставшиеся в группе ресурсов. 

## <a name="verify-prerequisites"></a>Проверка предварительных требований 

- Убедитесь, что перенос из исходного региона в целевой [поддерживается](../../../site-recovery/azure-to-azure-support-matrix.md#region-support).  
- Изучите [архитектуру и компоненты сценария](../../../site-recovery/azure-to-azure-architecture.md), а также [ограничения и требования поддержки](../../../site-recovery/azure-to-azure-support-matrix.md). 
- Проверьте разрешения для учетной записи. Если вы создали бесплатную учетную запись Azure, вы являетесь администратором этой подписки. Если вы не администратор подписки, свяжитесь с администратором, чтобы получить необходимые разрешения. Чтобы включить репликацию для виртуальной машины и скопировать данные с помощью Azure Site Recovery, необходимо следующее. 
    - Разрешения для создания виртуальной машины. Встроенная роль *Участник виртуальных машин* обладает следующими разрешениями: 
        - Разрешения на создание виртуальной машины в выбранной группе ресурсов. 
        - Разрешения на создание виртуальной машины в выбранной виртуальной сети. 
        - Разрешения на запись в выбранной учетной записи хранения. 
      - Разрешения на управление операциями Azure Site Recovery. Роль *Участник Site Recovery* имеет все разрешения, необходимые для управления операциями Site Recovery в хранилище служб восстановления.  

## <a name="prepare-to-move"></a>Подготовка к переносу
Подготовьте исходную виртуальную машину SQL Server и целевой регион для переноса. 

### <a name="prepare-the-source-sql-server-vm"></a>Подготовка исходной виртуальной машины SQL Server

- Убедитесь, что на виртуальной машине SQL Server, которую вы решили перенести, установлены все действующие корневые сертификаты. Если на ней отсутствуют действующие корневые сертификаты, ограничения безопасности заблокируют копирование данных в целевой регион. 
- При использовании виртуальных машин Windows установите на виртуальной машине все последние обновления Windows, чтобы гарантировать наличие всех доверенных корневых сертификатов. В отключенной среде выполните стандартные Центр обновления Windows и процесс обновления сертификата для вашей организации. 
- На виртуальных машинах Linux выполните инструкции, предоставленные распространителем Linux, чтобы установить все действующие доверенные корневые сертификаты и список отзыва сертификатов. 
- Убедитесь, что для управления подключением к сети виртуальных машин, которые вы хотите перенести, не используется прокси-сервер аутентификации. 
- Если виртуальная машина, которую вы пытаетесь перенести, не имеет доступа к Интернету или использует прокси-сервер брандмауэра для управления исходящим доступом, проверьте соответствующие требования. 
- Определите структуру сети в исходном регионе и все ресурсы, которые вы сейчас используете. Сюда могут входить, среди прочего, подсистемы балансировки нагрузки, группы безопасности сети и общедоступные IP-адреса. 

### <a name="prepare-the-target-region"></a>Подготовка целевого региона

- Убедитесь, что используемая подписка Azure позволяет создавать виртуальные машины в целевом регионе, который настроен для аварийного восстановления. Свяжитесь со службой поддержки, чтобы включить необходимые квоты. 
- Убедитесь, что ваша подписка располагает достаточными ресурсами для поддержки виртуальных машин тех же размеров, что и исходные. Если для копирования данных в целевой регион вы используете Site Recovery, эта служба выберет для целевой виртуальной машины такой же размер или наиболее близкий к нему. 
- Убедитесь, что вы создали в целевом регионе аналог каждого компонента, который вы обнаружили ранее в структуре сети исходного региона. Это важно для того, чтобы после перехода в целевой регион виртуальные машины сохранили все функции и возможности виртуальных машин в исходном регионе. 
    - При включении репликации для исходной виртуальной машины служба Azure Site Recovery автоматически обнаруживает и создает виртуальную сеть. Можно также предварительно создать сеть и назначить ее виртуальной машине для включения репликации. Все остальные ресурсы в целевом регионе необходимо создать вручную.
- Сведения о создании наиболее часто используемых сетевых ресурсов на основе конфигурации исходной виртуальной машины см. в следующих документах. 
    - [Группы безопасности сети](../../../virtual-network/tutorial-filter-network-traffic.md) 
    - [Подсистема балансировки нагрузки](../../../load-balancer/quickstart-load-balancer-standard-internal-portal.md)
    - [Общедоступный IP-адрес](../../../virtual-network/virtual-network-public-ip-address.md)
    - Сведения о дополнительных сетевых компонентах см. в [документации по сетям](../../../virtual-network/virtual-networks-overview.md).
- Вручную создайте непроизводственную сеть в целевом регионе, если вы хотите протестировать конфигурацию перед окончательным переносом в целевой регион. Мы рекомендуем не пропускать этот шаг, так как он позволит минимизировать влияние на рабочую сеть. 

## <a name="configure-azure-site-recovery-vault"></a>Настройка хранилища Azure Site Recovery

Чтобы скопировать данные в целевой регион с помощью Azure Site Recovery, выполните указанные ниже действия. Создайте хранилище служб восстановления в любом регионе, отличном от исходного. 

1. Войдите на [портал Azure](https://portal.azure.com). 
1. Выберите **Создать ресурс** в левом верхнем углу области навигации. 
1. Выберите **ИТ и средства управления**, а затем **Backup and Site Recovery**. 
1. На вкладке **Основные сведения** в разделе **Сведения о проекте** создайте новую или выберите существующую группу ресурсов в целевом регионе. 
1. В разделе **Сведения об экземпляре** укажите имя хранилища, а затем выберите целевой регион в раскрывающемся списке **Регион**. 
1. Нажмите кнопку **Просмотреть и создать**, чтобы создать хранилище служб восстановления. 
1. Выберите **Все службы** в левом верхнем углу области навигации и в поле поиска введите "`recovery services`". 
1. (Необязательно.) Щелкните звездочку рядом со страницей **Хранилища служб восстановления**, чтобы добавить ее на панель быстрой навигации. 
1. Щелкните **Хранилища служб восстановления**, а затем выберите созданное хранилище служб восстановления. 
1. В области **Обзор** нажмите кнопку **Реплицировать**. 

   ![Настройка репликации](./media/move-sql-vm-different-region/configure-replication.png)

1. Выберите **Источник**, а затем в качестве источника укажите **Azure**. Выберите соответствующие значения в других раскрывающихся полях, например расположение исходных виртуальных машин. В поле **Исходная группа ресурсов** будут видны только группы ресурсов, которые расположены в регионе, указанном в поле **Исходное расположение**. 
1. Щелкните **Виртуальные машины**, а затем выберите виртуальные машины, которые необходимо перенести. Нажмите кнопку **ОК** , чтобы сохранить выбор виртуальных машин. 
1. Щелкните **Параметры**, а затем выберите значение в раскрывающемся списке **Целевое расположение**. Это должна быть ранее подготовленная группа ресурсов. 
1. После настройки репликации выберите **Создать целевые ресурсы**, чтобы создать ресурсы в новом расположении. 
1. После завершения создания ресурсов выберите **Включить репликацию**, чтобы запустить репликацию виртуальной машины SQL Server из исходного региона в целевой.
1. Состояние репликации можно проверить, перейдя в хранилище служб восстановления, выбрав **Реплицированные элементы** и просмотрев **Состояние** виртуальной машины SQL Server. Состояние **Защищено** указывает, что репликация завершена. 

   ![Проверка состояния репликации](./media/move-sql-vm-different-region/check-replication-status.png)

## <a name="test-move-process"></a>Тестирование процесса переноса
Чтобы протестировать процесс переноса с помощью Azure Site Recovery, выполните указанные ниже действия. 

1. Перейдите к своему **хранилищу служб восстановления** на [портале Azure](https://portal.azure.com) и выберите **Реплицированные элементы**. 
1. Выберите виртуальную машину SQL Server, которую необходимо перенести, убедитесь, что в строке **Работоспособность репликации** отображается значение **Работоспособна**, а затем нажмите кнопку **Тестовая отработка отказа**. 

   ![Тестовая отработка отказа для виртуальной машины](./media/move-sql-vm-different-region/test-failover-of-replicated-vm.png)

1. На странице **Тестовая отработка отказа** выберите точку восстановления **Последняя точка во времени согласованности приложений**, которая будет использоваться для отработки отказа, так как это единственный тип моментального снимка, который может гарантировать согласованность данных SQL Server. 
1. Выберите виртуальную сеть в разделе **Виртуальная сеть Azure**, а затем нажмите кнопку **ОК**, чтобы выполнить тестовую отработку отказа. 
   
   >[!IMPORTANT]
   > Мы рекомендуем использовать для тестовой отработки отказа отдельную сеть виртуальных машин Azure. Не используйте для этого рабочую сеть, которая была настроена при включении репликации, то есть в которую вы намерены переместить виртуальные машины. 

1. Чтобы отслеживать ход выполнения, перейдите к своему хранилищу, выберите **Задания Site Recovery** в разделе **Мониторинг**, а затем выберите выполняемое задание **Тестовая отработка отказа**.

   ![Отслеживание хода выполнения тестовой отработки отказа](./media/move-sql-vm-different-region/monitor-failover-test-job.png)

1. После завершения теста перейдите на страницу портала **Виртуальные машины** и просмотрите только что созданную виртуальную машину. Убедитесь, что виртуальная машина SQL Server работает, имеет правильный размер и подключена к нужной сети. 
1. Удалите виртуальную машину, созданную в ходе теста, так как кнопка **Отработка отказа** будет неактивна до тех пор, пока не будут очищены ресурсы тестовой отработки отказа. Вернитесь к хранилищу, щелкните **Реплицированные элементы**, выберите виртуальную машину SQL Server, а затем нажмите кнопку **Очистить тестовую отработку отказа**. Запишите и сохраните все наблюдения, связанные с тестом, в разделе **Примечания** и установите флажок **Тестирование завершено. Удалить виртуальные машины для тестовой отработки отказа**. Нажмите кнопку **ОК**, чтобы очистить ресурсы после теста. 

   ![Очистка элементов после тестовой отработки отказа](./media/move-sql-vm-different-region/cleanup-test-items.png)

## <a name="move-the-sql-server-vm"></a>Перенос виртуальной машины SQL Server 
Чтобы перенести виртуальную машину SQL Server из исходного региона в целевой, выполните указанные ниже действия. 

1. Перейдите к хранилищу **Службы восстановления**, щелкните **Реплицированные элементы**, выберите виртуальную машину и нажмите кнопку **Отработка отказа**. 

   ![Запуск отработки отказа](./media/move-sql-vm-different-region/initiate-failover.png)

1. Выберите точку восстановления **Последняя точка во времени согласованности приложений** в разделе **Точка восстановления**. 
1. Установите флажок **завершить работу компьютера, прежде чем начать отработку отказа**. Служба Site Recovery попытается завершить работу исходной виртуальной машины перед запуском отработки отказа. Отработка отказа продолжится, даже если завершить работу не удастся. 
1. Нажмите кнопку **ОК**, чтобы начать отработку отказа.
1. Процесс отработки отказа можно отслеживать на той же странице **Задания Site Recovery**, которую вы просматривали при мониторинге тестовой отработки отказа в предыдущем разделе. 
1. Когда задание будет завершено, проверьте, отображается ли виртуальная машина SQL Server в целевом регионе, как ожидалось. 
1. Вернитесь к хранилищу, щелкните **Реплицированные элементы**, выберите виртуальную машину SQL Server и нажмите кнопку **Зафиксировать**, чтобы завершить процесс переноса в целевой регион. Дождитесь, пока завершится задание фиксации. 
1. Зарегистрируйте ВИРТУАЛЬную машину SQL Server с расширением агента IaaS SQL, чтобы обеспечить управляемость **виртуальных машин SQL** в портал Azure и компонентах, связанных с расширением. Дополнительные сведения см. [в статье регистрация SQL Server виртуальной машины с расширением агента IaaS SQL](sql-agent-extension-manually-register-single-vm.md). 

  > [!WARNING]
  > Согласованность данных SQL Server гарантируют только моментальные снимки с согласованием приложений. **Последний обработанный** моментальный снимок невозможно использовать для отработки отказа SQL Server, поскольку моментальный снимок аварийного восстановления не может гарантировать согласованность данных SQL Server. 

## <a name="clean-up-source-resources"></a>Очистка исходных ресурсов
Чтобы избежать расходов при выставлении счетов, удалите виртуальную машину SQL Server из хранилища и очистите все ненужные связанные ресурсы. 

1. Перейдите к хранилищу **Site Recovery**, щелкните **Реплицированные элементы** и выберите виртуальную машину SQL Server. 
1. Щелкните **Отключить репликацию**. Выберите причину отключения защиты, а затем нажмите кнопку **ОК**, чтобы отключить репликацию. 

   >[!IMPORTANT]
   > Это важный шаг, который избавляет от лишних расходов на репликацию Azure Site Recovery. 

1. Если вы не планируете повторно использовать какие-либо ресурсы в исходном регионе, удалите все релевантные сетевые ресурсы и соответствующие учетные записи хранения. 


## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения см. в следующих статьях: 

* [Обзор SQL Server на виртуальных машинах Windows](sql-server-on-azure-vm-iaas-what-is-overview.md).
* [Вопросы и ответы по SQL Server на виртуальных машинах Windows](frequently-asked-questions-faq.md).
* [Руководство по выбору ценовой категории для виртуальных машин SQL Server в Azure](pricing-guidance.md)
* [Заметки о выпуске SQL Server на виртуальных машинах Windows](doc-changes-updates-release-notes.md).