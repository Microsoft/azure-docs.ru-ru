---
title: Настройка группы доступности (шаблон быстрого запуска Azure)
description: С помощью шаблонов быстрого запуска Azure вы можете создать отказоустойчивый кластер Windows, присоединить к нему виртуальные машины SQL Server, создать прослушиватель, а также настроить внутреннюю подсистему балансировки нагрузки в Azure.
services: virtual-machines-windows
documentationcenter: na
author: MashaMSFT
tags: azure-resource-manager
ms.assetid: aa5bf144-37a3-4781-892d-e0e300913d03
ms.service: virtual-machines-sql
ms.subservice: hadr
ms.topic: how-to
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 01/04/2019
ms.author: mathoma
ms.reviewer: jroth
ms.custom: seo-lt-2019
ms.openlocfilehash: d7dfe010a3f4a1559454c49545af81eb14797bf1
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "97359920"
---
# <a name="use-azure-quickstart-templates-to-configure-an-availability-group-for-sql-server-on-azure-vm"></a>Использование шаблонов быстрого запуска Azure для настройки группы доступности для SQL Server на виртуальной машине Azure
[!INCLUDE[appliesto-sqlvm](../../includes/appliesto-sqlvm.md)]

В этой статье объясняется, как использовать шаблоны быстрого запуска Azure для частичной автоматизации развертывания конфигурации группы доступности Always On для виртуальных машин SQL Server в Azure. При этом используются два шаблона быстрого запуска Azure: 

   | Шаблон | Описание |
   | --- | --- |
   | [101-sql-vm-ag-setup](https://github.com/Azure/azure-quickstart-templates/tree/master/101-sql-vm-ag-setup) | Создает отказоустойчивый кластер Windows и присоединить к нему виртуальные машины SQL Server. |
   | [101-sql-vm-aglistener-setup](https://github.com/Azure/azure-quickstart-templates/tree/master/101-sql-vm-aglistener-setup) | Создает прослушиватель группы доступности и настроить внутреннюю подсистему балансировки нагрузки. Этот шаблон можно использовать, только если отказоустойчивый кластер Windows был создан с помощью шаблона **101-sql-vm-ag-setup**. |
   | &nbsp; | &nbsp; |

Остальные действия по настройке группы доступности, в том числе создание группы доступности и внутренней подсистемы балансировки нагрузки, выполняются вручную. В этой статье описана последовательность автоматизированных и выполняемых вручную действий.

Хотя в этой статье используются шаблоны быстрого запуска Azure для настройки среды группы доступности, ее также можно выполнить с помощью [портал Azure](availability-group-azure-portal-configure.md), [PowerShell или Azure CLI](availability-group-az-commandline-configure.md)или [вручную](availability-group-manually-configure-tutorial.md) . 
 

## <a name="prerequisites"></a>Предварительные требования 
Чтобы автоматизировать настройку группы доступности Always On с помощью шаблонов быстрого запуска, требуется следующее: 
- [Подписка Azure](https://azure.microsoft.com/free/).
- Группа ресурсов с контроллером домена. 
- Одна или несколько виртуальных машин, присоединенных к домену, [в Azure под управлением SQL Server 2016 (или более поздней версии) Enterprise Edition](./create-sql-vm-portal.md) , которые находятся в одной группе доступности или зоне доступности и [зарегистрированы в расширении агента IaaS SQL](sql-agent-extension-manually-register-single-vm.md).  
- Два доступных (не используемых какими-либо сущностями) IP-адреса: один для внутренней подсистемы балансировки нагрузки и один для прослушивателя группы доступности в той же подсети, что и группа доступности. Если используется существующая подсистема балансировки нагрузки, вам потребуется только один доступный IP-адрес.  

## <a name="permissions"></a>Разрешения
Для настройки группы доступности Always On с помощью шаблонов быстрого запуска Azure требуются следующие разрешения: 

- Существующая учетная запись пользователя домена с разрешением для **создания объекта компьютера** в домене.  Например, учетная запись администратора домена обычно имеет соответствующие разрешения (например: account@domain.com). _Эта учетная запись также должна входить в группу локальных администраторов на каждой виртуальной машине для создания кластера._
- Учетная запись пользователя домена, которая используется для управления SQL Server. 


## <a name="create-cluster"></a>Создание кластера
После регистрации SQL Server виртуальных машин с расширением агента IaaS SQL можно присоединить SQL Server виртуальные машины к *склвиртуалмачинеграупс*. Этот ресурс определяет метаданные отказоустойчивого кластера Windows, в том числе версию, выпуск, полное доменное имя, учетные записи Active Directory для управления кластером и SQL Server, а также учетную запись хранения для роли облака-свидетеля. 

Добавление виртуальных машин SQL Server в группу ресурсов *SqlVirtualMachineGroups* запускает службу отказоустойчивого кластера Windows для создания кластера, а затем присоединяет эти виртуальные машины SQL Server к этому кластеру. Этот шаг автоматизирован с помощью шаблона быстрого запуска **101-sql-vm-ag-setup**. Это можно сделать следующим образом:

1. Перейдите к шаблону быстрого запуска [**101-sql-vm-ag-setup**](https://github.com/Azure/azure-quickstart-templates/tree/master/101-sql-vm-ag-setup). Затем выберите **Развернуть в Azure**, чтобы открыть шаблон быстрого запуска на портале Azure.
1. Заполните все обязательные поля, чтобы настроить метаданные отказоустойчивого кластера Windows. Необязательные поля можно оставить пустыми.

   В следующей таблице представлены необходимые значения для этого шаблона: 

   | **Поле** | Значение |
   | --- | --- |
   | **Подписка** |  Подписка, в которой находятся ваши виртуальные машины SQL Server. |
   |**Группа ресурсов** | Группа ресурсов, где находятся ваши виртуальные машины SQL Server. | 
   |**Failover Cluster Name** (Имя отказоустойчивого кластера) | Имя, которое вы выбрали для нового отказоустойчивого кластера Windows. |
   | **Existing Vm List** (Список существующих виртуальных машин) | Виртуальные машины SQL Server, которые вы хотите разместить в этой группе доступности и в новом кластере. Разделите эти значения запятыми с пробелом (например, так: *SQLVM1, SQLVM2*). |
   | **Версия SQL Server** | Версия SQL Server для виртуальных машин SQL Server. Выберите ее в раскрывающемся списке. В настоящее время поддерживаются только образы SQL Server 2016 и SQL Server 2017. |
   | **Existing Fully Qualified Domain Name** (Существующее полное доменное имя) | Полное доменное имя существующего домена, в котором находятся виртуальные машины SQL Server. |
   | **Existing Domain Account** (Учетная запись существующего домена) | Существующая учетная запись пользователя домена, у которой есть разрешение на **создание объекта компьютера** в домене, так как во время развертывания шаблона создается [CNO](/windows-server/failover-clustering/prestage-cluster-adds). Как правило, учетная запись администратора домена обычно имеет соответствующие разрешения (например, account@domain.com). *Эта учетная запись также должна входить в группу локальных администраторов на каждой виртуальной машине для создания кластера.*| 
   | **Domain Account Password** (Пароль к учетной записи домена) | Пароль для указанной выше учетной записи пользователя домена. | 
   | **Existing Sql Service Account** (Существующая учетная запись службы SQL Server) | Учетная запись пользователя домена, которая контролирует [службу SQL Server](/sql/database-engine/configure-windows/configure-windows-service-accounts-and-permissions) во время развертывания группы доступности (например, account@domain.com). |
   | **Sql Service Password** (Пароль службы SQL) | Пароль для учетной записи пользователя домена, которая используется для управления SQL Server. |
   | **Имя облака-свидетеля** | Новая учетная запись хранения Azure, которая создается и используется для облака-свидетеля. Это имя можно изменить. |
   | **Расположение \_артефактов** | Это поле имеет значение по умолчанию, и его можно изменить. |
   | **Маркер SaS расположения \_артефактов** | Это поле остается пустым специально. |
   | &nbsp; | &nbsp; |

1. Если вы принимаете условия, установите флажок **Я принимаю указанные выше условия**. Затем щелкните **Приобрести**, чтобы завершить развертывание шаблона быстрого запуска. 
1. Для мониторинга развертывания выберите развертывание с помощью значка **Уведомления** на верхнем баннере навигации или перейдите в раздел **Группа ресурсов** на портале Azure. Щелкните **Развертывания** в разделе **Параметры** и выберите развертывание **Microsoft.Template**. 

>[!NOTE]
> Учетные данные, предоставляемые во время развертывания шаблона, хранятся только во время выполнения развертывания. По завершении операции эти пароли удаляются. Вам будет предложено ввести их снова, если в кластер будут добавлены дополнительные виртуальные машины SQL Server. 



## <a name="validate-cluster"></a>Проверка кластера 

Чтобы отказоустойчивый кластер поддерживался корпорацией Майкрософт, он должен пройти проверку кластера. Подключитесь к виртуальной машине с помощью предпочтительного метода, например протокол удаленного рабочего стола (RDP), и убедитесь, что кластер прошел проверку, прежде чем продолжить. Несоблюдение этого действия оставляет кластер в неподдерживаемом состоянии. 

Вы можете проверить кластер с помощью диспетчер отказоустойчивости кластеров (FCM) или следующей команды PowerShell:

   ```powershell
   Test-Cluster –Node ("<node1>","<node2>") –Include "Inventory", "Network", "System Configuration"
   ```


## <a name="create-availability-group"></a>Создание группы доступности 
Создайте группу доступности вручную обычным способом с помощью [SQL Server Management Studio](/sql/database-engine/availability-groups/windows/use-the-availability-group-wizard-sql-server-management-studio), [PowerShell](/sql/database-engine/availability-groups/windows/create-an-availability-group-sql-server-powershell) или [Transact-SQL](/sql/database-engine/availability-groups/windows/create-an-availability-group-transact-sql). 

>[!IMPORTANT]
> Но на этот раз *не* создавайте прослушиватель, так как это действие автоматизировано в шаблоне быстрого запуска **101-sql-vm-aglistener-setup** (см. шаг 4). 

## <a name="create-load-balancer"></a>Создание подсистемы балансировки нагрузки

[!INCLUDE [sql-ag-use-dnn-listener](../../includes/sql-ag-use-dnn-listener.md)]

Прослушивателю группы доступности Always On требуется внутренний экземпляр Azure Load Balancer. Внутренняя подсистема балансировки нагрузки предоставляет "плавающий" IP-адрес прослушивателю группы доступности, что обеспечивает более быструю отработку отказа и восстановление подключения. Если виртуальные машины SQL Server в группе доступности входят в одну группу доступности, вы можете использовать подсистему балансировки нагрузки ценовой категории "Базовый". В противном случае используйте подсистему балансировки нагрузки ценовой категории "Стандартный". 

> [!IMPORTANT]
> Внутренняя подсистема балансировки нагрузки должна находиться в той же виртуальной сети, что и экземпляры виртуальных машин SQL Server. 

Вам просто нужно создать внутреннюю подсистему балансировки нагрузки вручную, так как за настройку остальных элементов конфигурации (серверный пул, зонд работоспособности и правила балансировки нагрузки) отвечает шаблон быстрого запуска **101-sql-vm-aglistener-setup** (см. шаг 4). 

1. На портале Azure откройте группу ресурсов, в которой содержатся виртуальные машины SQL Server. 
2. В группе ресурсов щелкните **Добавить**.
3. Найдите **балансировщик нагрузки**. В результатах поиска выберите **Load Balancer**, опубликованный корпорацией **Майкрософт**.
4. В колонке **Load Balancer** щелкните **Создать**.
5. В диалоговом окне **Создание подсистемы балансировки нагрузки** настройте подсистему балансировки нагрузки, задав следующие параметры:

   | Параметр | Значение |
   | --- | --- |
   | **имя**; |Введите текстовое имя, представляющее подсистему балансировки нагрузки, например **sqlLB**. |
   | **Тип** |**Внутренние**. В большинстве реализаций используется внутренняя подсистема балансировки нагрузки, которая позволяет приложениям в одной и той же виртуальной сети подключаться к группе доступности.  </br> **Внешние**. Позволяет приложениям устанавливать общедоступное интернет-подключение к группе доступности. |
   | **Виртуальная сеть** | Выберите виртуальную сеть, в которой расположены экземпляры SQL Server. |
   | **Подсеть** | Выберите подсеть, в которой расположены экземпляры SQL Server. |
   | **Назначение IP-адресов** |**Статическое** |
   | **Частный IP-адрес** | Укажите свободный IP-адрес из нужной подсети. |
   | **Подписка** |Это поле может появиться, если у вас несколько подписок. Выберите подписку, которую требуется связать с этим ресурсом. Обычно это подписка, с которой связаны все ресурсы группы доступности. |
   | **Группа ресурсов** |Выберите группу ресурсов, в которой расположены экземпляры SQL Server. |
   | **Расположение** |Выберите расположение Azure, в котором расположены экземпляры SQL Server. |
   | &nbsp; | &nbsp; |

6. Нажмите кнопку **создания**. 


>[!IMPORTANT]
> Ресурс общедоступного IP-адреса для каждой виртуальной машины SQL Server должен иметь номер SKU "Стандартный", чтобы обеспечить совместимость с Load Balancer ценовой категории "Стандартный". Чтобы определить номер SKU для ресурса общедоступного IP-адреса виртуальной машины, в разделе **Группа ресурсов** выберите ресурс **Общедоступный IP-адрес** для виртуальной машины SQL Server, а затем найдите значение параметра **Номер SKU** в области **Обзор**. 

## <a name="create-listener"></a>Создание прослушивателя 

Создайте прослушиватель группы доступности и автоматически настройте внутреннюю подсистему балансировки нагрузки с помощью шаблона быстрого запуска **101-sql-vm-aglistener-setup**. Шаблон подготавливает к работе ресурс Microsoft.SqlVirtualMachine/SqlVirtualMachineGroups/AvailabilityGroupListener. Шаблон быстрого запуска  **101-SQL-VM-аглистенер-Setup** с помощью расширения агента IaaS SQL выполняет следующие действия.

- Создает новый ресурс протокола IP внешнего интерфейса (на основе значения IP-адреса, предоставленного во время развертывания) для прослушивателя. 
- Настраивает параметры сети для кластера и внутренней подсистемы балансировки нагрузки. 
- Настраивает внутренний пул для внутренней подсистемы балансировки нагрузки, пробы работоспособности и правила балансировки нагрузки.
- Создает прослушивателя группы доступности с указанными IP-адресом и именем.
 
>[!NOTE]
> **101-sql-vm-aglistener-setup** можно использовать, только если отказоустойчивый кластер Windows был создан с помощью шаблона **101-sql-vm-ag-setup**.
   
   
Чтобы настроить внутреннюю подсистему балансировки нагрузки и создать прослушиватель группы доступности, выполните следующие действия:
1. На портале Azure перейдите к шаблону быстрого запуска [101-sql-vm-aglistener-setup](https://github.com/Azure/azure-quickstart-templates/tree/master/101-sql-vm-aglistener-setup) и щелкните **Развернуть в Azure**, чтобы запустить этот шаблон быстрого запуска.
1. Заполните обязательные поля для настройки внутренней подсистемы балансировки нагрузки и создайте прослушиватель группы доступности. Необязательные поля можно оставить пустыми. 

   В следующей таблице представлены необходимые значения для этого шаблона: 

   | **Поле** | Значение |
   | --- | --- |
   |**Группа ресурсов** | Группа ресурсов, в которой размещены виртуальные машины SQL Server и группа доступности. | 
   |**Existing Failover Cluster Name** (Имя существующего отказоустойчивого кластера) | Имя кластера, к которому присоединены виртуальные машины SQL Server. |
   | **Existing Sql Availability Group** (Существующая группа доступности SQL)| Имя группы доступности, в которую входят виртуальные машины SQL Server. |
   | **Existing Vm List** (Список существующих виртуальных машин) | Имена виртуальных машин SQL Server, которые входят в указанную выше группу доступности. Разделите эти имена запятыми с пробелом (например, так: *SQLVM1, SQLVM2*). |
   | **Средство прослушивания** | DNS-имя, которое нужно назначить прослушивателю. По умолчанию в шаблоне указано имя aglistener, но его можно изменить. Имя не должно превышать 15 символов. |
   | **Listener Port** (Порт прослушивателя) | Порт, который будет использовать прослушиватель. Как правило, это порт по умолчанию с номером 1433. Номер порта, который указан в шаблоне. Но если вы изменили порт по умолчанию, то и порт прослушивателя следует изменить аналогичным образом. | 
   | **Прослушиватель IP-адреса** | IP-адрес, который должен использовать прослушиватель. Этот IP-адрес будет создан во время развертывания шаблона, поэтому укажите такой адрес, который еще не используется.  |
   | **Existing Subnet** (Существующая подсеть) | Имя внутренней подсети, в которой размещена виртуальная машина SQL Server (например, *default*). Чтобы узнать это значение, в разделе **Группа ресурсов** выберите свою виртуальную сеть, щелкните **Подсети** в области **Параметры** и скопируйте значение параметра **Имя**. |
   | **Existing Internal Load Balancer** (Существующий внутренний ресурс Load Balancer) | Имя внутренней подсистемы балансировки нагрузки, созданной на шаге 3. |
   | **Порт пробы** | Порт пробы, который будет использоваться внутренней подсистемой балансировки нагрузки. В этом шаблоне указано стандартное значение 59999, но его можно изменить. |
   | &nbsp; | &nbsp; |

1. Если вы принимаете условия, установите флажок **Я принимаю указанные выше условия**. Щелкните **Приобрести**, чтобы завершить развертывание шаблона быстрого запуска. 
1. Для мониторинга развертывания выберите развертывание с помощью значка **Уведомления** на верхнем баннере навигации или перейдите в раздел **Группа ресурсов** на портале Azure. Щелкните **Развертывания** в разделе **Параметры** и выберите развертывание **Microsoft.Template**. 

>[!NOTE]
>Если развертывание завершается сбоем в середине процесса, следует вручную [удалить только что созданный прослушиватель](#remove-listener) с помощью PowerShell и повторить попытку развернуть шаблон быстрого запуска **101-sql-vm-aglistener-setup**. 

## <a name="remove-listener"></a>Удаление прослушивателя
Если позже потребуется удалить прослушиватель группы доступности, настроенный для этого шаблона, необходимо пройти расширение агента IaaS SQL. Так как прослушиватель зарегистрирован с помощью расширения агента IaaS SQL, просто его удаление с помощью SQL Server Management Studio недостаточно. 

Лучший способ — удалить его через расширение агента IaaS SQL, используя следующий фрагмент кода в PowerShell. Это приведет к удалению метаданных прослушивателя группы доступности из расширения агента IaaS SQL. а из группы доступности физически удаляется прослушиватель. 

```PowerShell
# Remove the availability group listener
# example: Remove-AzResource -ResourceId '/subscriptions/a1a11a11-1a1a-aa11-aa11-1aa1a11aa11a/resourceGroups/SQLAG-RG/providers/Microsoft.SqlVirtualMachine/SqlVirtualMachineGroups/Cluster/availabilitygrouplisteners/aglistener' -Force
Remove-AzResource -ResourceId '/subscriptions/<SubscriptionID>/resourceGroups/<resource-group-name>/providers/Microsoft.SqlVirtualMachine/SqlVirtualMachineGroups/<cluster-name>/availabilitygrouplisteners/<listener-name>' -Force
```
 
## <a name="common-errors"></a>Распространенные ошибки
В этом разделе описаны некоторые известные проблемы и возможные способы их устранения. 

**Прослушиватель группы доступности для группы доступности " \<AG-Name> " уже существует** . выбранная группа доступности, используемая в шаблоне быстрого запуска Azure для прослушивателя группы доступности, уже содержит прослушиватель. Либо он физически находится в группе доступности, либо его метаданные остаются в расширении агента IaaS SQL. Удалите прослушиватель с помощью [PowerShell](#remove-listener) и повторно разверните шаблон быстрого запуска **101-sql-vm-aglistener-setup**. 

**Подключение работает только из первичной реплики** Это может быть вызвано сбоем развертывания шаблона **101-SQL-VM-аглистенер-** Configuration, которое оставляет конфигурацию внутренней подсистемы балансировки нагрузки в нестабильном состоянии. Убедитесь, что в серверном пуле отображается группа доступности, и что есть правила для зонда работоспособности и для балансировки нагрузки. Конфигурация внутренней подсистемы балансировки нагрузки будет несогласованной при отсутствии требуемых компонентов. 

Чтобы решить эту проблему, удалите прослушиватель с помощью [PowerShell](#remove-listener), затем удалите внутреннюю подсистему балансировки нагрузки на портале Azure и повторите процесс, начиная с шага 3. 

**BadRequest — можно обновить только список виртуальных машин SQL** Эта ошибка может возникать при развертывании шаблона **101-SQL-VM-аглистенер-Setup** , если прослушиватель был удален с помощью SQL Server Management Studio (SSMS), но он не был удален из расширения агента IaaS SQL. Удаление прослушивателя с помощью SSMS не приводит к удалению метаданных прослушивателя из расширения агента IaaS SQL. Прослушиватель должен быть удален из поставщика ресурсов с помощью [PowerShell](#remove-listener). 

**Учетная запись домена не существует** Эта ошибка может быть вызвана двумя причинами. либо указанная учетная запись домена действительно не существует, либо отсутствуют данные [имени участника-пользователя (UPN)](/windows/desktop/ad/naming-properties#userprincipalname). Шаблон **101-sql-vm-ag-setup** ожидает учетную запись домена в формате UPN (т. е. user@domain.com), но некоторые учетные записи домена могут ее пропустить. Обычно это происходит, если локальный пользователь был перенесен в первую учетную запись администратора домена, когда сервер был повышен до контроллера домена, или если пользователь был создан с помощью PowerShell. 

Проверьте, что учетная запись существует. Если она существует, вы можете столкнуться со второй ситуацией. Чтобы решить эту проблему, выполните следующие действия:

1. На контроллере домена откройте окно **Пользователи и компьютеры Active Directory** из параметра **Средства** в **Диспетчере серверов**. 
2. Перейдите к учетной записи, выбрав в области слева раздел **Пользователи**.
3. Щелкните правой кнопкой мыши учетную запись и выберите **Свойства**.
4. Перейдите на вкладку **Учетная запись**. Если поле **Имя входа пользователя** пусто, это и является причиной ошибки. 

    ![Пустая учетная запись пользователя указывает на отсутствие UPN](./media/availability-group-quickstart-template-configure/account-missing-upn.png)

5. Введите данные в поле **Имя входа пользователя** в соответствии с требованиями и выберите необходимый домен в раскрывающемся списке. 
6. Выберите **Применить**, чтобы сохранить изменения, и закройте диалоговое окно, выбрав **ОК**. 

После внесения этих изменений попытайтесь развернуть шаблон быстрого запуска Azure еще раз. 


## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения см. в следующих статьях: 

* [Общие сведения о виртуальных машинах SQL Server](sql-server-on-azure-vm-iaas-what-is-overview.md)
* [Часто задаваемые вопросы о виртуальных машинах SQL Server](frequently-asked-questions-faq.md)
* [Руководство по выбору ценовой категории для виртуальных машин SQL Server](pricing-guidance.md)
* [Заметки о выпуске для виртуальных машин SQL Server](../../database/doc-changes-updates-release-notes.md)
* [Изменение модели лицензирования для виртуальной машины SQL Server](licensing-model-azure-hybrid-benefit-ahb-change.md)