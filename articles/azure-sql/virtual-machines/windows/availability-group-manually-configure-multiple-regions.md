---
title: Настройка группы доступности Always On SQL Server в разных регионах
description: В этой статье объясняется, как настроить SQL Server Always On группы доступности на виртуальных машинах Azure с репликой в другом регионе.
services: virtual-machines
documentationCenter: na
author: MashaMSFT
editor: monicar
tags: azure-service-management
ms.assetid: 388c464e-a16e-4c9d-a0d5-bb7cf5974689
ms.service: virtual-machines-sql
ms.subservice: hadr
ms.topic: how-to
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 05/02/2017
ms.author: mathoma
ms.custom: seo-lt-2019
ms.openlocfilehash: 7ef3535158c99226da135ad3726266023ac0690f
ms.sourcegitcommit: 15d27661c1c03bf84d3974a675c7bd11a0e086e6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/09/2021
ms.locfileid: "102509410"
---
# <a name="configure-a-sql-server-always-on-availability-group-across-different-azure-regions"></a>Настройка группы доступности Always On SQL Server в разных регионах Azure

[!INCLUDE[appliesto-sqlvm](../../includes/appliesto-sqlvm.md)]

В этой статье описывается, как настроить группу доступности AlwaysOn SQL Server на виртуальных машинах Azure в удаленном регионе Azure. Эту конфигурацию можно использовать для поддержки аварийного восстановления.

Данная статья относится к виртуальным машинам Azure в режиме Resource Manager.

На следующем рисунке показано типичное развертывание группы доступности на виртуальных машинах Azure.

   ![На схеме показана подсистема балансировки нагрузки Azure и группа доступности с "отказоустойчивым кластером Windows Server" и "Always On группы доступности".](./media/availability-group-manually-configure-multiple-regions/00-availability-group-basic.png)

В таком развертывании все виртуальные машины находятся в одном регионе Azure. Реплики группы доступности могут использовать синхронную фиксацию с автоматической отработкой отказа на SQL-1 и SQL-2. Для создания этой архитектуры ознакомьтесь с [шаблоном группы доступности или соответствующим руководством](availability-group-overview.md).

Данная архитектура подвержена простоям в случаях, когда регион Azure становится недоступным. Чтобы устранить эту уязвимость, добавьте реплику в другой регион Azure. На следующей схеме показано, как будет выглядеть новая архитектура.

   ![Аварийное восстановление группы доступности](./media/availability-group-manually-configure-multiple-regions/00-availability-group-basic-dr.png)

На предыдущей схеме показана новая виртуальная машина с именем SQL-3. SQL-3 находится в другом регионе Azure. Она добавлена в отказоустойчивый кластер Windows Server. На SQL-3 можно разместить реплику группы доступности. Наконец, обратите внимание, что для региона Azure виртуальной машины SQL-3 используется новая подсистема Azure Load Balancer.

>[!NOTE]
> Группа доступности Azure нужна, если в одном регионе размещено более одной виртуальной машины. Если в регионе находится только одна виртуальная машина, то использовать группу доступности не обязательно. Поместить виртуальную машину в группу доступности можно только во время создания виртуальной машины. Если в группе доступности уже есть виртуальная машина, то позже в нее можно будет добавить виртуальную машину для размещения дополнительной реплики.

В данной архитектуре для реплики в удаленном регионе обычно настраивается режим доступности с асинхронной фиксацией и режим ручной отработки отказа.

Если реплики группы доступности находятся на виртуальных машинах Azure в разных регионах Azure, то для каждого региона требуется:

* шлюз виртуальной сети;
* подключение к шлюзу виртуальной сети.

На следующей схеме показано взаимодействие сетей между центрами обработки данных.

   ![На этой схеме показаны две виртуальные сети в разных регионах Azure, взаимодействующие с помощью шлюзов V P N.](./media/availability-group-manually-configure-multiple-regions/01-vpngateway-example.png)

>[!IMPORTANT]
>Эта архитектура влечет за собой оплату исходящего трафика для данных, реплицируемых между регионами Azure. Ознакомьтесь с разделом [Сведения о стоимости пропускной способности](https://azure.microsoft.com/pricing/details/bandwidth/).  

## <a name="create-remote-replica"></a>Создание удаленной реплики

Чтобы создать реплику в удаленном центре обработки данных, выполните следующие действия.

1. [Создайте виртуальную сеть в новом регионе](../../../virtual-network/manage-virtual-network.md#create-a-virtual-network).

1. [Настройте подключение между виртуальными сетями на портале Azure](../../../vpn-gateway/vpn-gateway-howto-vnet-vnet-resource-manager-portal.md).

   >[!NOTE]
   >В некоторых случаях для создания подключения между виртуальными сетями может потребоваться использовать PowerShell. Например, при использовании разных учетных записей Azure подключение невозможно настроить на портале. В этом случае ознакомьтесь с разделом [Настройка подключения между виртуальными сетями на портале Azure](../../../vpn-gateway/vpn-gateway-vnet-vnet-rm-ps.md).

1. [Создайте контроллер домена в новом регионе](/windows-server/identity/ad-ds/introduction-to-active-directory-domain-services-ad-ds-virtualization-level-100).

   Этот контроллер домена обеспечивает аутентификацию в случае, если контроллер домена на первичном сайте недоступен.

1. [Создайте виртуальную машину SQL Server в новом регионе](create-sql-vm-portal.md).

1. [Создайте Azure Load Balancer в сети в новом регионе](availability-group-manually-configure-tutorial.md#configure-internal-load-balancer).

   Эта подсистема балансировки нагрузки должна:

   - находиться в той же сети и подсети, что и новая виртуальная машина;
   - использовать статический IP-адрес для прослушивателя группы доступности;
   - включать в себя внутренний пул, состоящий только из виртуальных машин, размещенных в том же регионе, что и подсистема балансировки нагрузки;
   - использовать пробу TCP-порта для IP-адреса;
   - использовать правило балансировки нагрузки для SQL Server в том же регионе.  
   - являться подсистемой Load Balancer уровня "Стандартный", если виртуальные машины в серверном пуле не входят ни в отдельную группу доступности, ни в масштабируемый набор виртуальных машин. Дополнительные сведения см. в разделе [Обзор Azure Load Balancer уровня "Стандартный"](../../../load-balancer/load-balancer-overview.md).
   - Быть Load Balancer (цен. категория "Стандартный"), если две виртуальные сети в двух разных регионах являются равноправными через пиринг глобальной виртуальной сети. Дополнительные сведения см. в статье часто задаваемые [вопросы о виртуальной сети Azure](../../../virtual-network/virtual-networks-faq.md#what-are-the-constraints-related-to-global-vnet-peering-and-load-balancers).

1. [Добавьте компонент отказоустойчивой кластеризации на новый сервер SQL Server](availability-group-manually-configure-prerequisites-tutorial.md#add-failover-clustering-features-to-both-sql-server-vms).

1. [Присоедините новый сервер SQL Server к домену](availability-group-manually-configure-prerequisites-tutorial.md#joinDomain).

1. [Настройте новую учетную запись службы SQL Server для использования доменной учетной записи](availability-group-manually-configure-prerequisites-tutorial.md#setServiceAccount).

1. [Добавьте новый сервер SQL Server в отказоустойчивый кластер Windows Server](availability-group-manually-configure-tutorial.md#addNode).

1. Добавьте ресурс IP-адреса в кластер.

   Для этого можно использовать диспетчер отказоустойчивости кластеров. Выберите имя кластера, затем щелкните правой кнопкой мыши имя кластера в разделе **Основные ресурсы кластера** и выберите **Свойства**. 

   ![Снимок экрана, на котором показано "диспетчер отказоустойчивости кластеров" с именем кластера, именем сервера и выбранным свойством.](./media/availability-group-manually-configure-multiple-regions/cluster-name-properties.png)

   В диалоговом окне **Свойства** нажмите кнопку **Добавить** внизу поля **IP-адрес**, а затем добавьте IP-адрес имени кластера из удаленного региона сети. Нажмите кнопку **ОК** в диалоговом окне **IP-адрес** , а затем еще раз нажмите кнопку **ОК** в диалоговом окне **Свойства кластера** , чтобы сохранить новый IP-адрес. 

   ![Добавление IP-адреса кластера](./media/availability-group-manually-configure-multiple-regions/add-cluster-ip-address.png)


1. Добавьте IP-адрес в качестве зависимости для имени основного кластера.

   Откройте свойства кластера еще раз и перейдите на вкладку **зависимости** . Настройте зависимость или для двух IP-адресов: 

   ![Свойства кластера](./media/availability-group-manually-configure-multiple-regions/cluster-ip-dependencies.png)

1. Добавьте ресурс IP-адреса в роль группы доступности в кластере. 

   Щелкните правой кнопкой мыши роль группы доступности в диспетчер отказоустойчивости кластеров, выберите **Добавить ресурс**, **Дополнительные ресурсы** и выберите **IP-адрес**.

   ![Создание IP-адреса](./media/availability-group-manually-configure-multiple-regions/20-add-ip-resource.png)

   Настройте этот IP-адрес следующим образом.

   - Используйте сеть удаленного центра обработки данных.
   - Назначьте IP-адрес из новой подсистемы Azure Load Balancer. 

1. Добавьте ресурс IP-адреса в качестве зависимости для кластера (сетевое имя) точки доступа клиента прослушивателя.

   На следующем рисунке показан правильно настроенного ресурс IP-адреса кластера.

   ![Группа доступности](./media/availability-group-manually-configure-multiple-regions/50-configure-dependency-multiple-ip.png)

   >[!IMPORTANT]
   >Группа ресурсов кластера включает в себя оба IP-адреса. Оба IP-адреса являются зависимостями для точки доступа клиента прослушивателя. Используйте оператор **OR** в конфигурации зависимостей кластера.

1. [Настройте параметры кластера в PowerShell](availability-group-manually-configure-tutorial.md#setparam).

   Выполните сценарий PowerShell с сетевым именем кластера, IP-адресом и портом пробы, настроенными для подсистемы балансировки нагрузки в новом регионе.

   ```powershell
   $ClusterNetworkName = "<MyClusterNetworkName>" # The cluster name for the network in the new region (Use Get-ClusterNetwork on Windows Server 2012 of higher to find the name).
   $IPResourceName = "<IPResourceName>" # The cluster name for the new IP Address resource.
   $ILBIP = "<n.n.n.n>" # The IP Address of the Internal Load Balancer (ILB) in the new region. This is the static IP address for the load balancer you configured in the Azure portal.
   [int]$ProbePort = <nnnnn> # The probe port you set on the ILB.

   Import-Module FailoverClusters

   Get-ClusterResource $IPResourceName | Set-ClusterParameter -Multiple @{"Address"="$ILBIP";"ProbePort"=$ProbePort;"SubnetMask"="255.255.255.255";"Network"="$ClusterNetworkName";"EnableDhcp"=0}
   ```

1. [Включите группы доступности AlwaysOn](/sql/database-engine/availability-groups/windows/enable-and-disable-always-on-availability-groups-sql-server) на новом сервере SQL Server с помощью диспетчера конфигурации SQL Server.

1. [Откройте порты брандмауэра на новом сервере SQL Server](availability-group-manually-configure-prerequisites-tutorial.md#endpoint-firewall).

   Номера портов, которые необходимо открыть, зависят от вашей среды. Откройте порты для конечной точки зеркального отображения и пробы работоспособности Azure Load Balancer.


1. [Добавьте реплику в группу доступности на новом сервере SQL Server](/sql/database-engine/availability-groups/windows/use-the-add-replica-to-availability-group-wizard-sql-server-management-studio).

   Для реплики в удаленном регионе Azure настройте асинхронную репликацию с ручной отработкой отказа.  

## <a name="set-connection-for-multiple-subnets"></a>Настройка подключения для нескольких подсетей

Реплика в удаленном центре обработки данных входит в группу доступности, но находится в другой подсети. Если это реплика станет первичной, то возможно превышение времени ожидания подключения к приложению. Точно так же работает локальная группа доступности в развертывании с несколькими подсетями. Чтобы разрешить подключения из клиентских приложений, либо измените подключение клиента, либо настройте кэширование разрешения имен для ресурса сетевого имени кластера.

Желательно изменить строки подключения клиента, чтобы задать `MultiSubnetFailover=Yes`. Ознакомьтесь с разделом [Соединение с помощью MultiSubnetFailover](/sql/relational-databases/native-client/features/sql-server-native-client-support-for-high-availability-disaster-recovery#Anchor_0).

Если вам не удается изменить строки подключения, можно настроить кэширование разрешения имен. См. статью [Ошибка времени ожидания и проблемы при подключении к прослушивателю группы доступности SQL Server 2012 AlwaysOn в среде с несколькими подсетями](https://support.microsoft.com/help/2792139/time-out-error-and-you-cannot-connect-to-a-sql-server-2012-alwayson-av).

## <a name="fail-over-to-remote-region"></a>Отработка отказа в удаленный регион

Чтобы проверить возможность подключения прослушивателя к удаленному региону, можно отработать отказ реплики в удаленный регион. Если реплика является асинхронной, то отработка отказа может привести к потере данных. Чтобы отработать отказ без потери данных, измените режим доступности на синхронный и задайте автоматический режим отработки отказа. Выполните указанные ниже действия.

1. В **обозревателе объектов** подключитесь к экземпляру SQL Server, на котором размещена первичная реплика.
1. В разделе **группы доступности AlwaysOn**, **группы доступности** щелкните правой кнопкой мыши группу доступности и выберите пункт **Свойства**.
1. На странице **Общие** в разделе **Реплики доступности** задайте для вторичной реплики на узле аварийного восстановления режим доступности **Синхронная фиксация** и **автоматический** режим отработки отказа.
1. Если вторичная реплика находится на том же узле, что и первичная реплика, для обеспечения высокого уровня доступности, то задайте для нее режимы **Асинхронная фиксация** и **Ручной**.
1. Нажмите кнопку "ОК".
1. В **обозревателе объектов** щелкните правой кнопкой мыши группу доступности и выберите пункт **отобразить панель мониторинга**.
1. На панели мониторинга убедитесь, что реплика на сайте аварийного восстановления синхронизирована.
1. В **обозревателе объектов** щелкните правой кнопкой мыши группу доступности и выберите пункт **отработка отказа...**. SQL Server управления Studios открывает мастер для отработки отказа SQL Server.  
1. Нажмите кнопку **Далее** и выберите экземпляр SQL Server на сайте аварийного восстановления. Снова нажмите кнопку **Далее** .
1. Подключитесь к экземпляру SQL Server на сайте аварийного восстановления и нажмите кнопку **Далее**.
1. На странице **Сводка** проверьте параметры и нажмите кнопку **Готово**.

После проверки подключения верните первичную реплику в основной центр обработки данных и восстановите обычные рабочие параметры режима доступности. В таблице ниже приведены обычные рабочие параметры для архитектуры, описанной в этом документе.

| Расположение | Экземпляр сервера | Роль | Режим доступности | Режим отработки отказа
| ----- | ----- | ----- | ----- | -----
| Основной центр обработки данных | SQL-1 | Первичная | Синхронная | Автоматически
| Основной центр обработки данных | SQL-2 | Вторичная | Синхронная | Автоматически
| Дополнительный или удаленный центр обработки данных | SQL-3 | Вторичная | Асинхронная | Вручную


### <a name="more-information-about-planned-and-forced-manual-failover"></a>Дополнительные сведения о плановой и принудительной отработке отказа вручную

Дополнительные сведения см. в следующих разделах:

- [Выполнение запланированного перехода на другой ресурс вручную для группы доступности (SQL Server)](/sql/database-engine/availability-groups/windows/perform-a-planned-manual-failover-of-an-availability-group-sql-server)
- [Выполнение принудительного перехода на другой ресурс вручную для группы доступности (SQL Server)](/sql/database-engine/availability-groups/windows/perform-a-forced-manual-failover-of-an-availability-group-sql-server)

## <a name="next-steps"></a>Дальнейшие действия

* [Группы доступности AlwaysOn](/sql/database-engine/availability-groups/windows/always-on-availability-groups-sql-server)
* [Виртуальные машины Azure](../../../virtual-machines/index.yml)
* [Подсистемы Azure Load Balancer](availability-group-manually-configure-tutorial.md#configure-internal-load-balancer)
* [Группы доступности Azure](../../../virtual-machines/availability.md)