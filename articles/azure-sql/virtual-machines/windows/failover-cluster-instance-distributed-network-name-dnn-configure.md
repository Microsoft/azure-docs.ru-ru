---
title: Настройка DNN для экземпляра отказоустойчивого кластера
description: Узнайте, как настроить имя распределенной сети (DNN) для маршрутизации трафика в SQL Server на экземпляре отказоустойчивого кластера виртуальной машины Azure (FCI).
services: virtual-machines-windows
documentationcenter: na
author: MashaMSFT
manager: jroth
tags: azure-resource-manager
ms.service: virtual-machines-sql
ms.subservice: hadr
ms.devlang: na
ms.topic: how-to
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 10/07/2020
ms.author: mathoma
ms.reviewer: jroth
ms.openlocfilehash: 8549592ace00e712929ebc76045a32531b9db659
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "97358322"
---
# <a name="configure-a-dnn-for-failover-cluster-instance"></a>Настройка DNN для экземпляра отказоустойчивого кластера
[!INCLUDE[appliesto-sqlvm](../../includes/appliesto-sqlvm.md)]

На виртуальных машинах Azure имя распределенной сети (DNN) направляет трафик в соответствующий кластеризованный ресурс. Он обеспечивает более простой способ подключения к SQL Server экземпляру отказоустойчивого кластера (FCI), чем имя виртуальной сети (VNN) без необходимости Azure Load Balancer. 

В этой статье описывается настройка ресурса DNN для маршрутизации трафика к экземпляру отказоустойчивого кластера с SQL Server на виртуальных машинах Azure для обеспечения высокой доступности и аварийного восстановления (HADR). 

Функция DNN в настоящее время доступна только на SQL Server 2019 CU2 и более поздних версиях на Windows Server 2016 и более поздних версиях. 

В качестве альтернативного варианта подключения рассмотрим [имя виртуальной сети и Azure Load Balancer](failover-cluster-instance-vnn-azure-load-balancer-configure.md) . 

## <a name="overview"></a>Обзор

Имя распределенной сети (DNN) заменяет имя виртуальной сети (VNN) в качестве точки подключения при использовании с [экземпляром отказоустойчивого кластера Always on на SQL Server виртуальных машинах](failover-cluster-instance-overview.md). Это отрицательно потребует от Azure Load Balancer трафика маршрутизации к VNN, упрощая развертывание, Обслуживание и повышение отработки отказа. 

При развертывании FCI VNN по-прежнему существует, но клиент подключается к DNS-имени DNN вместо имени VNN. 

## <a name="prerequisites"></a>Предварительные требования 

Чтобы выполнить действия, описанные в этой статье, необходимо следующее:

- SQL Server 2019 в CU2 или более поздней версии, на Windows Server 2016 и более поздних версиях
- Принято решение о том, что имя распределенной сети является подходящим [вариантом подключения для вашего решения HADR](hadr-cluster-best-practices.md#connectivity).
- Настроены [экземпляры отказоустойчивого кластера](failover-cluster-instance-overview.md). 
- Установлена последняя версия [PowerShell](/powershell/azure/install-az-ps). 

## <a name="create-dnn-resource"></a>Создание ресурса DNN 

Ресурс DNN создается в той же кластерной группе, что и SQL Server FCI. С помощью PowerShell создайте ресурс DNN в кластерной группе FCI. 

Следующая команда PowerShell добавляет ресурс DNN в группу кластера SQL Server FCI с именем ресурса `<dnnResourceName>` . Имя ресурса используется для уникальной идентификации ресурса. Используйте тот, который имеет смысл и уникален в пределах кластера. Тип ресурса должен быть `Distributed Network Name` . 

`-Group`Значение должно быть именем группы кластера, соответствующей SQL Server FCI, в которую нужно добавить имя распределенной сети. Для экземпляра по умолчанию обычно используется формат `SQL Server (MSSQLSERVER)` . 


```powershell
Add-ClusterResource -Name <dnnResourceName> `
-ResourceType "Distributed Network Name" -Group "<WSFC role of SQL server instance>"
```

Например, чтобы создать ресурс DNN `dnn-demo` для SQL Server FCI по умолчанию, используйте следующую команду PowerShell:

```powershell
Add-ClusterResource -Name dnn-demo `
-ResourceType "Distributed Network Name" -Group "SQL Server (MSSQLSERVER)"

```

## <a name="set-cluster-dnn-dns-name"></a>Задать DNS-имя кластера DNN

Задайте DNS-имя для ресурса DNN в кластере. Затем кластер использует это значение для маршрутизации трафика на узел, на котором в данный момент размещается SQL Server FCI. 

Клиенты используют DNS-имя для подключения к SQL Server FCI. Можно выбрать уникальное значение. Если у вас уже есть FCI и вы не хотите обновлять строки подключения клиента, можно настроить DNN для использования текущих VNN, которые уже используются клиентами. Для этого необходимо [Переименовать VNN](#rename-the-vnn) , прежде чем задавать DNN в DNS.

Используйте эту команду, чтобы задать DNS-имя для DNN: 

```powershell
Get-ClusterResource -Name <dnnResourceName> | `
Set-ClusterParameter -Name DnsName -Value <DNSName>
```

`DNSName`Это значение используется клиентами для подключения к SQL Server FCI. Например, чтобы клиенты подключались к `FCIDNN` , используйте следующую команду PowerShell:

```powershell
Get-ClusterResource -Name dnn-demo | `
Set-ClusterParameter -Name DnsName -Value FCIDNN
```

`FCIDNN`После подключения к SQL Server FCI клиенты будут вводить в строку подключения. 

   > [!WARNING]
   > Не удаляйте текущее имя виртуальной сети (VNN), так как оно является необходимым компонентом инфраструктуры FCI. 


### <a name="rename-the-vnn"></a>Переименование VNN 

Если у вас есть имя виртуальной сети и вы хотите, чтобы клиенты продолжали использовать это значение для подключения к SQL Server FCI, необходимо переименовать текущий VNN в значение заполнителя. После переименования текущего VNN можно задать значение имени DNS для DNN в VNN. 

Некоторые ограничения применяются для переименования VNN. Дополнительные сведения см. в разделе [переименование FCI](/sql/sql-server/failover-clusters/install/rename-a-sql-server-failover-cluster-instance).

Если использование текущего VNN не требуется для вашего бизнеса, пропустите этот раздел. После переименования VNN [установите DNS-имя DNN кластера](#set-cluster-dnn-dns-name). 

   
## <a name="set-dnn-resource-online"></a>Настройка ресурса DNN в сети

После надлежащего именования ресурса DNN и установки значения DNS-имени в кластере с помощью PowerShell настройте ресурс DNN в сети в кластере. 

```powershell
Start-ClusterResource -Name <dnnResourceName>
```

Например, чтобы запустить ресурс DNN `dnn-demo` , используйте следующую команду PowerShell: 

```powershell
Start-ClusterResource -Name dnn-demo
```

## <a name="configure-possible-owners"></a>Настройка возможных владельцев

По умолчанию кластер привязывает DNS-имя DNN ко всем узлам в кластере. Однако узлы в кластере, не являющиеся частью SQL Server FCI, следует исключить из списка возможных владельцев DNN. 

Чтобы обновить возможных владельцев, выполните следующие действия.

1. Перейдите к ресурсу DNN в диспетчер отказоустойчивости кластеров. 
1. Щелкните правой кнопкой мыши ресурс DNN и выберите пункт **Свойства**. 

   :::image type="content" source="media/hadr-distributed-network-name-dnn-configure/fci-dnn-properties.png" alt-text="Контекстное меню для ресурса DNN с выделенной командой &quot;Свойства&quot;.":::

1. Снимите флажки для всех узлов, которые не участвуют в экземпляре отказоустойчивого кластера. Список возможных владельцев для ресурса DNN должен соответствовать списку возможных владельцев для ресурса экземпляра SQL Server. Например, если data3 не участвует в FCI, на следующем рисунке приведен пример удаления data3 из списка возможных владельцев для ресурса DNN: 

   :::image type="content" source="media/hadr-distributed-network-name-dnn-configure/clear-check-for-nodes-not-in-fci.png" alt-text="Снимите флажок рядом с узлами, которые не участвуют в FCI, для возможных владельцев ресурса DNN.":::

1. Нажмите кнопку **ОК**, чтобы сохранить параметры. 


## <a name="restart-sql-server-instance"></a>Перезапустить SQL Server экземпляр 

Используйте диспетчер отказоустойчивости кластеров, чтобы перезапустить экземпляр SQL Server. Выполните следующие действия.

1. Перейдите к ресурсу SQL Server в диспетчер отказоустойчивости кластеров.
1. Щелкните правой кнопкой мыши ресурс SQL Server и переведите его в режим «вне сети». 
1. После отключения всех связанных ресурсов щелкните правой кнопкой мыши ресурс SQL Server и снова переведите его в сеть. 

## <a name="update-connection-string"></a>Обновление строки подключения

Чтобы обеспечить быстрое подключение при отработке отказа, добавьте `MultiSubnetFailover=True` в строку подключения значение, если версия клиента SQL более ранняя, чем 4.6.1. 

Кроме того, если DNN не использует исходный VNN, то клиенты SQL, подключающиеся к SQL Server FCI, должны будут обновить строку подключения до DNS-имени DNN. Чтобы избежать этого требования, можно обновить значение DNS-имени, чтобы оно было именем VNN. Но сначала необходимо [заменить существующий VNN заполнителем](#rename-the-vnn) . 

## <a name="test-failover"></a>Тестовая отработка отказа


Тестовая отработка отказа кластеризованного ресурса для проверки функциональности кластера. 


Чтобы протестировать отработку отказа, выполните следующие действия. 

1. Подключитесь к одному из SQL Server узлов кластера по протоколу RDP.
1. Откройте **диспетчер отказоустойчивости кластеров**. Выберите **Роли**. Обратите внимание, какой узел является владельцем роли SQL Server FCI.
1. Щелкните правой кнопкой мыши роль SQL Server FCI. 
1. Выберите **Переместить**, а затем выберите **Лучший возможный узел**.

В **диспетчере отказоустойчивости кластеров** отобразится роль, и ее ресурсы перейдут в автономный режим. Затем ресурсы переместятся и снова станут доступными на другом узле.

## <a name="test-connectivity"></a>Проверка подключения

Чтобы проверить подключение, войдите на другую виртуальную машину в той же виртуальной сети. Откройте **SQL Server Management Studio** и подключитесь к SQL Server FCI с помощью DNS-имени DNN.

При необходимости можно [скачать SQL Server Management Studio](/sql/ssms/download-sql-server-management-studio-ssms).


## <a name="avoid-ip-conflict"></a>Избежание конфликта IP-адресов

Это необязательный шаг для предотвращения назначения виртуального IP-адреса, используемого ресурсом FCI, другому ресурсу в Azure в качестве дубликата. 

Хотя клиенты теперь используют DNN для подключения к SQL Server FCI, имя виртуальной сети (VNN) и виртуальный IP-адрес не могут быть удалены, так как они являются необходимыми компонентами инфраструктуры FCI. Тем не менее, так как подсистема балансировки нагрузки не позволяет повторно обслуживать виртуальный IP-адрес в Azure, существует риск того, что другому ресурсу в виртуальной сети будет назначен тот же IP-адрес, что и для виртуального IP-адреса, используемого FCI. Это потенциально может привести к дублированию проблемы с конфликтом IP. 

Настройте адрес APIPA или выделенный сетевой адаптер для резервирования IP-адреса. 

### <a name="apipa-address"></a>Адрес APIPA

Чтобы избежать использования повторяющихся IP-адресов, настройте APIPA-адрес (также известный как адрес локальной связи). Для этого выполните следующую команду:

```powershell
Get-ClusterResource "virtual IP address" | Set-ClusterParameter 
    –Multiple @{"Address”=”169.254.1.1”;”SubnetMask”=”255.255.0.0”;"OverrideAddressMatch"=1;”EnableDhcp”=0}
```

В этой команде «виртуальный IP-адрес» — это имя ресурса кластеризованного виртуального адреса, а «169.254.1.1» — это адрес, выбранный для виртуального IP-адреса. Выберите адрес, который лучше подходит для вашего бизнеса. Установите этот параметр, `OverrideAddressMatch=1` чтобы разрешить IP-адрес в любой сети, включая адресное пространство APIPA. 

### <a name="dedicated-network-adapter"></a>Выделенный сетевой адаптер

Кроме того, можно настроить сетевой адаптер в Azure для резервирования IP-адреса, используемого ресурсом виртуального IP-адреса. Однако это потребляет адрес в адресном пространстве подсети, и есть дополнительные издержки, гарантирующие, что сетевой адаптер не используется для других целей.

## <a name="limitations"></a>Ограничения

- В настоящее время DNN с FCI поддерживается только для SQL Server 2019 CU2 и более поздних версий на Windows Server 2016 и более поздних версиях. 
- При работе с другими функциями SQL Server и FCI с DNN могут возникнуть дополнительные соображения. Дополнительные сведения см. в разделе [FCI with DNN, взаимодействие](failover-cluster-instance-dnn-interoperability.md). 

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о SQL Serverии функций HADR в Azure см. в разделе [группы доступности](availability-group-overview.md) и [экземпляр отказоустойчивого кластера](failover-cluster-instance-overview.md). Вы также [можете ознакомиться с рекомендациями](hadr-cluster-best-practices.md) по настройке среды для обеспечения высокого уровня доступности и аварийного восстановления. 


