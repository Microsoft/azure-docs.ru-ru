---
title: Что такое расширение агента SQL Server IaaS?
description: В этой статье описывается, как расширение агента IaaS для SQL Server помогает автоматизировать административные задачи администрирования SQL Server на виртуальных машинах Azure. К ним относятся такие функции, как автоматическая архивация, автоматическая установка исправлений, интеграция Azure Key Vault, Управление лицензированием, Настройка хранилища и централизованное управление всеми экземплярами виртуальных машин SQL Server.
services: virtual-machines-windows
documentationcenter: ''
author: MashaMSFT
editor: ''
tags: azure-resource-manager
ms.assetid: effe4e2f-35b5-490a-b5ef-b06746083da4
ms.service: virtual-machines-sql
ms.subservice: management
ms.devlang: na
ms.topic: conceptual
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 11/07/2020
ms.author: mathoma
ms.reviewer: jroth
ms.custom: seo-lt-2019
ms.openlocfilehash: 7ddc13306f4adb1730169c4811b9d2227dedca33
ms.sourcegitcommit: 484f510bbb093e9cfca694b56622b5860ca317f7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/21/2021
ms.locfileid: "98632772"
---
# <a name="automate-management-with-the-sql-server-iaas-agent-extension"></a>Автоматизация управления с помощью расширения агента SQL Server IaaS
[!INCLUDE[appliesto-sqlvm](../../includes/appliesto-sqlvm.md)]


Расширение агента SQL Server IaaS (SqlIaasExtension) выполняется в SQL Server на виртуальных машинах Azure для автоматизации задач управления и администрирования. 

В этой статье приводятся общие сведения о расширении. Чтобы установить расширение IaaS SQL Server для SQL Server на виртуальных машинах Azure, изучите статьи для [автоматической установки](sql-agent-extension-automatic-registration-all-vms.md), [отдельных виртуальных машин](sql-agent-extension-manually-register-single-vm.md)или [виртуальных машин](sql-agent-extension-manually-register-vms-bulk.md). 

## <a name="overview"></a>Общие сведения

Расширение агента SQL Server IaaS предоставляет ряд преимуществ для SQL Server на виртуальных машинах Azure. 

- **Преимущества функций**. расширение разблокирует ряд преимуществ функций автоматизации, таких как Управление порталом, гибкость лицензий, автоматическая архивация, автоматическая установка исправлений и многое другое. Дополнительные сведения см. в разделе [преимущества функций](#feature-benefits) далее в этой статье. 

- **Соответствие**. расширение предлагает упрощенный метод выполнения требования для уведомления корпорации Майкрософт о том, что преимущество гибридного использования Azure включена, как указано в условиях продукта. Этот процесс устраняет необходимость в управлении формами регистрации лицензий для каждого ресурса.  

- **Free**. расширение во всех трех режимах управляемости полностью бесплатное. Нет дополнительных затрат, связанных с расширением, или с изменением режимов управления. 

- **Упрощенное управление лицензиями**. расширение упрощает управление лицензиями SQL Server и позволяет быстро выявление SQL Server виртуальных машин с преимущество гибридного использования Azure, включенными с помощью [портал Azure](manage-sql-vm-portal.md), PowerShell или Azure CLI: 

   # <a name="powershell"></a>[PowerShell](#tab/azure-powershell)

   ```powershell-interactive
   Get-AzSqlVM | Where-Object {$_.LicenseType -eq 'AHUB'}
   ```

   # <a name="azure-cli"></a>[Azure CLI](#tab/azure-cli)

   ```azurecli-interactive
   $ az sql vm list --query "[?sqlServerLicenseType=='AHUB']"
   ```



   ---


> [!IMPORTANT]
> Расширение агента IaaS SQL собирает данные для предоставления клиентам дополнительных преимуществ при использовании SQL Server в виртуальных машинах Azure. Корпорация Майкрософт не будет использовать эти данные для аудита лицензирования без согласия клиента. Дополнительные сведения см. в разделе [SQL Server о конфиденциальности](/sql/sql-server/sql-server-privacy#non-personal-data) .


## <a name="feature-benefits"></a>Преимущества функций 

Расширение агента SQL Server IaaS разблокирует ряд преимуществ для управления виртуальной машиной SQL Server. 

Эти преимущества приведены в следующей таблице. 


| Функция | Описание |
| --- | --- |
| **Управление на портале** | Разблокирует [Управление на портале](manage-sql-vm-portal.md), чтобы вы могли просматривать все SQL Server виртуальные машины в одном месте, а также включать и отключать функции SQL непосредственно на портале. 
| **Автоматическая архивация** |Автоматизирует планирование резервного копирования всех баз данных для экземпляра по умолчанию или [правильно установленного](frequently-asked-questions-faq.md#administration) именованного экземпляра SQL Server на виртуальной машине SQL Server. Дополнительные сведения см. в статье [Автоматическое резервное копирование для виртуальных машин SQL Server (Resource Manager)](automated-backup-sql-2014.md). |
| **Автоматическая установка исправлений** |Настраивает период обслуживания, в течение которого могут выполняться важные обновления системы безопасности Windows и SQL Server, поэтому во время пиковой нагрузки можно избежать обновлений в рабочее время. Дополнительные сведения см. в статье [Автоматическая установка исправлений SQL Server на виртуальных машинах Azure (Resource Manager)](automated-patching.md). |
| **Интеграция с Azure Key Vault** |Автоматически устанавливает и настраивает хранилище ключей Azure на виртуальной машине SQL Server. Дополнительные сведения см. в статье [Настройка интеграции Azure Key Vault для SQL Server на виртуальных машинах Azure (Resource Manager)](azure-key-vault-integration-configure.md). |
| **Гибкое лицензирование** | Изменяйте затраты путем [простого перехода](licensing-model-azure-hybrid-benefit-ahb-change.md) с собственной лицензии (также известной как преимущество гибридного использования Azure) в модель лицензирования с оплатой по мере использования и обратно. | 
| **Гибкая версия или выпуск** | Если вы решили изменить [версию](change-sql-server-version.md) или [выпуск](change-sql-server-edition.md) SQL Server, можно обновить метаданные в портал Azure без необходимости повторного развертывания всей виртуальной машины SQL Server.  | 


## <a name="management-modes"></a>Режимы управления

Вы можете зарегистрировать расширение SQL IaaS в трех режимах управления: 

- **Облегченный** режим копирует двоичные файлы РАСШИРЕНИЙ на виртуальную машину, но не устанавливает агент и не перезапускает службу SQL Server. Упрощенный режим поддерживает только изменение типа лицензии и выпуска SQL Server и обеспечивает ограниченное управление порталом. Используйте этот параметр для SQL Server виртуальных машин с несколькими экземплярами или с участием в экземпляре отказоустойчивого кластера (FCI). Упрощенный режим является режимом управления по умолчанию при использовании функции [автоматической регистрации](sql-agent-extension-automatic-registration-all-vms.md) или если тип управления не указан во время ручной регистрации. Упрощенный режим не влияет на память или загрузку ЦП и дополнительная плата не взимается. Рекомендуется сначала зарегистрировать виртуальную машину SQL Server в упрощенном режиме, а затем выполнить обновление до полного режима в течение запланированного периода обслуживания. 

- **Полный** режим устанавливает агент IaaS SQL на виртуальную машину, чтобы обеспечить все функциональные возможности, но требует перезапуска службы SQL Server и системного администратора. Используйте его для управления виртуальной машиной SQL Server с одним экземпляром. В полном режиме устанавливаются две службы Windows, которые минимально воздействуют на память и загрузку ЦП. Это воздействие можно отслеживать с помощью диспетчера задач. Плата за использование режима полного управления не взимается. 

- Режим **NoAgent** предназначен для SQL Server 2008 и SQL Server 2008 R2, установленных в Windows Server 2008. Режим NoAgent не влияет на память или загрузку ЦП. При использовании режима управления с помощью агента не взимается плата, SQL Server не перезапускается, а агент не устанавливается на виртуальную машину. 

Текущий режим агента SQL Server IaaS можно просмотреть с помощью Azure PowerShell. 

  ```powershell-interactive
  # Get the SqlVirtualMachine
  $sqlvm = Get-AzSqlVM -Name $vm.Name  -ResourceGroupName $vm.ResourceGroupName
  $sqlvm.SqlManagementType
  ```

## <a name="installation"></a>Установка

Зарегистрируйте SQL Server ВИРТУАЛЬную машину с расширением агента SQL Server IaaS, чтобы создать _ресурс_ **виртуальной машины SQL** в рамках подписки, который является _отдельным_ ресурсом из ресурса виртуальной машины. При отмене регистрации ВИРТУАЛЬНОЙ машины SQL Server в расширении _ресурс_ **виртуальной машины SQL** будет удален, но фактические виртуальные машины не будут удалены.

При развертывании образа виртуальной машины Azure Marketplace SQL Server с помощью портал Azure автоматически регистрирует виртуальную машину SQL Server с расширением. Однако, если вы решили самостоятельно установить SQL Server на виртуальной машине Azure или подготовили виртуальную машину Azure из пользовательского виртуального жесткого диска, то необходимо зарегистрировать ВИРТУАЛЬную машину SQL Server с расширением SQL IaaS, чтобы разблокировать преимущества функций. 

Регистрация расширения в упрощенном режиме скопирует двоичные файлы, но не установит агент на виртуальную машину. Агент устанавливается на виртуальную машину при обновлении расширения до полного режима управления. 

Существует три способа регистрации в расширении: 
- [Автоматически для всех текущих и будущих виртуальных машин в подписке](sql-agent-extension-automatic-registration-all-vms.md)
- [Вручную для одной виртуальной машины](sql-agent-extension-manually-register-single-vm.md)
- [Ручное копирование нескольких виртуальных машин](sql-agent-extension-manually-register-vms-bulk.md)

### <a name="named-instance-support"></a>Поддержка именованного экземпляра

Расширение агента SQL Server IaaS работает с именованным экземпляром SQL Server если это единственный экземпляр SQL Server, доступный на виртуальной машине. Расширение не удается установить на виртуальных машинах с несколькими именованными экземплярами SQL Server, если на виртуальной машине нет экземпляра по умолчанию. 

Чтобы использовать именованный экземпляр SQL Server, разверните виртуальную машину Azure, установите в нее один именованный экземпляр SQL Server, а затем зарегистрируйте его с помощью [расширения SQL IaaS](sql-agent-extension-manually-register-single-vm.md).

Кроме того, чтобы использовать именованный экземпляр с образом SQL Server Azure Marketplace, выполните следующие действия. 

   1. Разверните виртуальную машину SQL Server из Azure Marketplace. 
   1. [Отмените регистрацию](sql-agent-extension-manually-register-single-vm.md#unregister-from-extension) SQL Server виртуальной машины в расширении агента IaaS SQL. 
   1. Полностью удалите SQL Server в виртуальной машине SQL Server.
   1. Установите SQL Server с именованным экземпляром в виртуальной машине SQL Server. 
   1. [Зарегистрируйте виртуальную машину с расширением агента IaaS SQL](sql-agent-extension-manually-register-single-vm.md#register-with-extension). 

## <a name="verify-status-of-extension"></a>Проверка состояния расширения

Чтобы проверить состояние расширения, используйте портал Azure или Azure PowerShell. 

### <a name="azure-portal"></a>Портал Azure

Убедитесь, что расширение установлено в портал Azure. 

Выберите **все параметры** в области виртуальная машина, а затем щелкните **расширения**. В списке будет указано расширение **SqlIaasExtension**.

![Состояние расширения агента IaaS SQL Server в портал Azure](./media/sql-server-iaas-agent-extension-automate-management/azure-rm-sql-server-iaas-agent-portal.png)


### <a name="azure-powershell"></a>Azure PowerShell

Вы также можете использовать командлет Azure PowerShell **Get-AzVMSqlServerExtension**:

   ```powershell-interactive
   Get-AzVMSqlServerExtension -VMName "vmname" -ResourceGroupName "resourcegroupname"
   ```

Предыдущая команда подтверждает, что агент установлен, и предоставляет общие сведения о состоянии. С помощью следующих команд можно получить определенные сведения о состоянии автоматической архивации и установки исправлений.

   ```powershell-interactive
    $sqlext = Get-AzVMSqlServerExtension -VMName "vmname" -ResourceGroupName "resourcegroupname"
    $sqlext.AutoPatchingSettings
    $sqlext.AutoBackupSettings
   ```


## <a name="limitations"></a>Ограничения

Расширение агента IaaS SQL поддерживает только: 

- Виртуальные машины SQL Server, развернутые с помощью Azure Resource Manager. Виртуальные машины SQL Server, развернутые с помощью классической модели развертывания, не поддерживаются. 
- Виртуальные машины SQL Server, развернутые в общедоступном облаке или в облаке Azure для государственных организаций. Развертывания в других частных облаках или облаках для государственных организаций не поддерживаются. 


## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы 

**Следует ли регистрировать виртуальную машину SQL Server, подготовленную на основе образа SQL Server, в Azure Marketplace?**

Нет. Корпорация Майкрософт автоматически регистрирует виртуальные машины, подготовленные на основе образов SQL Server в Azure Marketplace. Регистрация в расширении требуется только в том случае, если виртуальная машина *не* была подготовлена из образов SQL Server в Azure Marketplace и SQL Server была самостоятельно установлена.

**Доступно ли расширение агента IaaS SQL для всех клиентов?** 

Да. Клиенты должны зарегистрировать свои SQL Server виртуальные машины с расширением, если они не использовали SQL Serverный образ из Azure Marketplace, а вместо этого самостоятельно установили SQL Server или добавили свой пользовательский виртуальный жесткий диск. Виртуальные машины, принадлежащие всем типам подписок (Direct, Соглашение Enterprise и поставщик облачных решений), могут зарегистрироваться в расширении агента IaaS SQL.

**Что представляет собой режим управления по умолчанию при регистрации в расширении агента IaaS SQL?**

Режим управления по умолчанию при регистрации в расширении агента IaaS SQL является *облегченным*. Если свойство управления SQL Server не задано при регистрации в расширении, режим будет установлен как легковесный, а служба SQL Server не будет перезапускаться. Рекомендуется сначала зарегистрироваться в расширении агента IaaS SQL в упрощенном режиме, а затем выполнить обновление до полной версии в течение периода обслуживания. Аналогично, Управление по умолчанию также упрощено при использовании [функции автоматической регистрации](sql-agent-extension-automatic-registration-all-vms.md).

**Каковы предварительные требования для регистрации в расширении агента IaaS SQL?**

Нет предварительных требований для регистрации с расширением агента IaaS SQL, отличным от установки SQL Server на виртуальной машине. Обратите внимание, что если расширение агента IaaS SQL установлено в полном режиме, SQL Server служба будет перезапущена, поэтому рекомендуется использовать его в течение периода обслуживания.

**Будет ли регистрация в расширении агента IaaS SQL установить агент на виртуальной машине?**

Да, регистрация в расширении агента IaaS SQL в режиме полной управляемости устанавливает агент на виртуальную машину. Регистрация в режиме Lightweight или без агента не выполняется. 

При регистрации в расширении агента IaaS SQL в упрощенном режиме на виртуальную машину копируются только *двоичные файлы* расширения агента SQL IaaS. агент не устанавливается. Затем эти двоичные файлы используются для установки агента при обновлении режима управления до полного.


**Будет ли регистрация с помощью расширения агента IaaS SQL SQL Server перезапуска на моей виртуальной машине?**

Это зависит от режима, выбранного во время регистрации. Если указан режим "упрощенный" или "неагентный", то служба SQL Server не будет перезапущена. Однако при указании режима управления Full это приведет к перезапуску службы SQL Server. Функция автоматической регистрации регистрирует SQL Server виртуальные машины в упрощенном режиме, если только версия Windows Server не 2008. в этом случае SQL Server виртуальная машина будет зарегистрирована в режиме "без агента". 

**В чем разница между режимами упрощения и управления агентами при регистрации с помощью расширения агента IaaS SQL?** 

Режим управления "без агента" является единственным доступным режимом управления для SQL Server 2008 и SQL Server 2008 R2 на Windows Server 2008. Для всех последующих версий Windows Server доступны два режима управления: Облегченный и полный. 

Для режима "без агента" требуется, чтобы свойства SQL Server версии и выпуска были заданы клиентом. Упрощенный режим запрашивает у виртуальной машины версию и выпуск экземпляра SQL Server.

**Можно ли зарегистрироваться в расширении агента IaaS SQL без указания типа лицензии SQL Server?**

Нет. Тип лицензии SQL Server не является дополнительным свойством при регистрации с расширением агента IaaS SQL. При регистрации с помощью расширения агента IaaS SQL необходимо задать тип лицензии SQL Server как "Оплата по мере использования" или "Преимущество гибридного использования Azure" во всех режимах управления (без агента, lightweight и Full). Если у вас есть какие-либо бесплатные версии SQL Server, например Выпуск Developer или Evaluation Edition, вы должны зарегистрироваться в лицензии с оплатой по мере использования. Преимущество гибридного использования Azure доступны только для платных версий SQL Server, таких как выпуски Enterprise и Standard.

**Можно ли обновить расширение SQL Server IaaS из режима агента в полный режим?**

Нет. Обновление режима управляемости до Full или lightweight недоступно для режима "без агента". Это техническое ограничение Windows Server 2008. Необходимо сначала обновить ОС до Windows Server 2008 R2 или более поздней версии, после чего вы сможете выполнить обновление до режима полного управления. 

**Можно ли обновить расширение IaaS для SQL Server и перейти с упрощенного режима на полный?**

Да. Обновление режима управляемости с Lightweight на Full поддерживается с помощью Azure PowerShell или портал Azure. Это приведет к перезапуску службы SQL Server.

**Можно ли понизить расширение SQL Server IaaS с полного режима до агента или упрощенного режима управления?**

Нет. Понижение уровня режима управления расширения IaaS для SQL Server не поддерживается. Режим управляемости не может быть понижен из полного режима в режим "упрощенный" или "без агента", и его нельзя понизить с упрощенного режима на режим "без агента". 

Чтобы изменить режим управляемости с полной управляемости, [Отмените регистрацию](sql-agent-extension-manually-register-single-vm.md#unregister-from-extension) SQL Server виртуальной машины в расширении агента IaaS SQL, удалив _ресурс_ виртуальной машины SQL и повторно ЗАрегистрируйте SQL Serverную виртуальную машину с расширением агента IaaS SQL в другом режиме управления.

**Можно ли зарегистрироваться в расширении агента IaaS SQL из портал Azure?**

Нет. Регистрация в расширении агента IaaS SQL недоступна в портал Azure. Регистрация в расширении агента IaaS SQL поддерживается только в Azure CLI или Azure PowerShell. 

**Можно ли зарегистрировать виртуальную машину с расширением агента IaaS SQL до установки SQL Server?**

Нет. Для успешной регистрации в расширении агента IaaS SQL виртуальная машина должна иметь хотя бы один экземпляр SQL Server (ядро СУБД). Если на виртуальной машине нет экземпляра SQL Server, новый ресурс Microsoft.SqlVirtualMachine будет находиться в состоянии сбоя.

**Можно ли зарегистрировать виртуальную машину с расширением агента IaaS SQL при наличии нескольких SQL Server экземпляров?**

Да, если на виртуальной машине имеется экземпляр по умолчанию. Расширение агента IaaS SQL будет регистрировать только один экземпляр SQL Server (ядро СУБД). Расширение агента IaaS SQL будет регистрировать экземпляр SQL Server по умолчанию в случае нескольких экземпляров.

**Можно ли зарегистрировать экземпляр отказоустойчивого кластера SQL Server с расширением агента IaaS SQL?**

Да. SQL Server экземпляры отказоустойчивого кластера на виртуальной машине Azure можно зарегистрировать с помощью расширения агента IaaS SQL в упрощенном режиме. Однако экземпляры отказоустойчивого кластера SQL Server нельзя обновить до режима полного управления.

**Можно ли зарегистрировать виртуальную машину с расширением агента IaaS SQL, если группа доступности Always On настроена?**

Да. Регистрация SQL Server экземпляра на виртуальной машине Azure с расширением агента IaaS SQL не ограничена, если вы участвуете в конфигурации группы доступности Always On.

**Какова стоимость регистрации в расширении агента IaaS SQL или обновления до полного режима управления?**

Нет. Не взимается плата, связанная с регистрацией в расширении агента IaaS SQL, или с использованием любого из трех режимов управления. Управление виртуальной машиной SQL Server с помощью расширения полностью бесплатное. 

**Как сказывается на производительности использование различных режимов управления?**

Использование *упрощенного* режима управления и *NoAgent* не влияет на производительность. При использовании режима *полного* управления есть минимальное влияние двух служб, установленных в операционной системе. Их можно отслеживать с помощью диспетчера задач и просматривать во встроенной консоли служб Windows. 

Имена этих двух служб:
- `SqlIaaSExtensionQuery` (отображаемое имя — `Microsoft SQL Server IaaS Query Service`);
- `SQLIaaSExtension` (отображаемое имя — `Microsoft SQL Server IaaS Agent`).

**Разделы справки удалить расширение?**

Удалите расширение, отменив [регистрацию](sql-agent-extension-manually-register-single-vm.md#unregister-from-extension) SQL Server виртуальной машины в расширении агента IaaS SQL. 

## <a name="next-steps"></a>Дальнейшие действия

Чтобы установить расширение IaaS SQL Server для SQL Server на виртуальных машинах Azure, изучите статьи для [автоматической установки](sql-agent-extension-automatic-registration-all-vms.md), [отдельных виртуальных машин](sql-agent-extension-manually-register-single-vm.md)или [виртуальных машин](sql-agent-extension-manually-register-vms-bulk.md).

Подробные сведения о работе SQL Server на виртуальных машинах Azure см. в статье [Что собой представляет SQL Server на виртуальных машинах Azure](sql-server-on-azure-vm-iaas-what-is-overview.md).
