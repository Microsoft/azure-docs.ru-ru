---
title: Настройка подсистемы балансировки нагрузки для прослушивателя VNN группы доступности
description: Узнайте, как настроить Azure Load Balancer для маршрутизации трафика в прослушиватель имени виртуальной сети (VNN) для группы доступности с SQL Server на виртуальных машинах Azure для обеспечения высокой доступности и аварийного восстановления (HADR).
services: virtual-machines-windows
documentationcenter: na
author: MashaMSFT
manager: jroth
tags: azure-resource-manager
ms.service: virtual-machines-sql
ms.subservice: hadr
ms.devlang: na
ms.topic: how-to
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 06/02/2020
ms.author: mathoma
ms.reviewer: jroth
ms.openlocfilehash: 2d89759438cb625a0e220af10ab6b287096f6390
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "97359886"
---
# <a name="configure-load-balancer-for-ag-vnn-listener"></a>Настройка подсистемы балансировки нагрузки для прослушивателя VNN группы доступности
[!INCLUDE[appliesto-sqlvm](../../includes/appliesto-sqlvm.md)]

На виртуальных машинах Azure кластеры используют подсистему балансировки нагрузки для хранения IP-адреса, который должен находиться на одном узле кластера за раз. В этом решении подсистема балансировки нагрузки содержит IP-адрес для прослушивателя имени виртуальной сети (VNN) для группы доступности Always On. 

В этой статье описывается, как настроить подсистему балансировки нагрузки с помощью службы Azure Load Balancer. Балансировщик нагрузки будет направлять трафик в [прослушиватель группы доступности](availability-group-overview.md) с SQL Server на виртуальных машинах Azure для обеспечения высокой доступности и аварийного восстановления (HADR). 

Для альтернативного варианта подключения для клиентов на SQL Server 2019 CU8 и более поздних версий рассмотрите возможность использования [прослушивателя DNN](availability-group-vnn-azure-load-balancer-configure.md) для упрощения настройки и улучшения отработки отказа.  



## <a name="prerequisites"></a>Предварительные требования

Чтобы выполнить действия, описанные в этой статье, необходимо следующее:

- Решили, что Azure Load Balancer является подходящим [вариантом подключения для вашего решения HADR](hadr-cluster-best-practices.md#connectivity).
- Настроен [прослушиватель группы доступности](availability-group-overview.md).
- Установлена последняя версия [PowerShell](/powershell/azure/install-az-ps). 


## <a name="create-load-balancer"></a>Создание подсистемы балансировки нагрузки

Для создания балансировщика нагрузки используйте [портал Azure](https://portal.azure.com) :

1. На портале Azure перейдите в группу ресурсов с виртуальными машинами.

1. Выберите **Добавить**. Поиск **Load Balancer** в Azure Marketplace. Выберите **Load Balancer**.

1. Нажмите кнопку **создания**.

1. Настройте подсистему балансировки нагрузки, указав следующие значения:

   - **Подписка**: Вашу подписку Azure.
   - **Группа ресурсов.** Группа ресурсов, которая содержит ваши виртуальные машины.
   - **Name** (Имя). Имя, определяющее подсистему балансировки нагрузки.
   - **Регион**. Расположение Azure, которое содержит ваши виртуальные машины.
   - **Тип**. Открытый или закрытый. Доступ к закрытой подсистеме балансировки нагрузки может осуществляться в пределах одной виртуальной сети. Большинство приложений Azure могут использовать закрытый балансировщик нагрузки. Если приложению требуется доступ к SQL Server непосредственно через Интернет, используйте открытую подсистему балансировки нагрузки.
   - **SKU**: Стандартная.
   - **Виртуальная сеть.** Виртуальная сеть, в которой находятся виртуальные машины.
   - **Назначение IP-адресов**. Статический. 
   - **Частный IP-адрес**: IP-адрес, назначенный кластерному сетевому ресурсу.

   На следующем изображении показан пользовательский интерфейс **создания подсистемы балансировки нагрузки**:

   ![Настройка подсистемы балансировки нагрузки](./media/failover-cluster-instance-premium-file-share-manually-configure/30-load-balancer-create.png)
   

## <a name="configure-backend-pool"></a>Настройка внутреннего пула

1. Вернитесь в группу ресурсов Azure с виртуальными машинами и найдите новую подсистему балансировки нагрузки. Возможно, потребуется обновить представление в группе ресурсов. Выберите подсистему балансировки нагрузки.

1. Выберите **Серверные пулы**, а затем щелкните **Добавить**.

1. Свяжите серверный пул с группой доступности, в которую входят виртуальные машины.

1. В разделе **Целевые IP-конфигурации сети** установите флажок **Виртуальная машина** и выберите виртуальные машины, которые будут узлами кластера. Не забудьте включить все виртуальные машины, на которых будет размещена FCI или группа доступности.

1. Нажмите кнопку **ОК**, чтобы создать серверный пул.

## <a name="configure-health-probe"></a>Настройка проверки работоспособности

1. В области подсистема балансировки нагрузки выберите **зонды работоспособности**.

1. Выберите **Добавить**.

1. В области " **добавить проверку работоспособности** " <span id="probe"></span> задайте следующие параметры проверки работоспособности.

   - **Name** (Имя). Имя для проверки работоспособности.
   - **Протокол**. Протокол TCP.
   - **Порт**. порт, созданный в брандмауэре для проверки работоспособности [при подготовке виртуальной машины](failover-cluster-instance-prepare-vm.md#uninstall-sql-server-1). В качестве примера в этой статье используется TCP-порт `59999`.
   - **Интервал**: 5 секунд.
   - **Пороговое значение сбоя**: 2 последовательных сбоя.

1. Щелкните **ОК**.

## <a name="set-load-balancing-rules"></a>Задание правил балансировки нагрузки

1. В области подсистема балансировки нагрузки выберите **правила балансировки нагрузки**.

1. Выберите **Добавить**.

1. Задайте параметры правила балансировки нагрузки:

   - **Имя**: имя правил балансировки нагрузки.
   - **Интерфейсный IP-адрес**: IP-адрес SQL Server FCI или кластеризованного сетевого ресурса прослушивателя AG.
   - **Порт**: SQL Server TCP-порт. Порт экземпляра по умолчанию — 1433.
   - **Внутренний порт**: тот же порт, что и значение **порта** , при включении **плавающего IP-адреса (прямой возврат сервера)**.
   - **Серверный пул**. Имя серверного пула, настроенного ранее.
   - **Зонд работоспособности**. Проба работоспособности, настроенная ранее.
   - **Сохранение сеанса**. Нет.
   - **Время ожидания простоя (в минутах)** . 4.
   - **Плавающий IP-адрес (прямой ответ от сервера)** . Включено.

1. Щелкните **ОК**.

## <a name="configure-cluster-probe"></a>Настройка проверки кластера

Задайте параметр порта проверки кластера в PowerShell.

Чтобы задать параметр порта пробы кластера, измените переменные в следующем скрипте, указав значения для своей среды. Удалите из скрипта угловые скобки (`<` и `>`).

```powershell
$ClusterNetworkName = "<Cluster Network Name>"
$IPResourceName = "<SQL Server FCI / AG Listener IP Address Resource Name>" 
$ILBIP = "<n.n.n.n>" 
[int]$ProbePort = <nnnnn>

Import-Module FailoverClusters

Get-ClusterResource $IPResourceName | Set-ClusterParameter -Multiple @{"Address"="$ILBIP";"ProbePort"=$ProbePort;"SubnetMask"="255.255.255.255";"Network"="$ClusterNetworkName";"EnableDhcp"=0}
```

В следующей таблице описаны значения, которые необходимо обновить.


|**Значение**|**Описание**|
|---------|---------|
|`Cluster Network Name`| Имя отказоустойчивого кластера Windows Server для сети. Выберите **Диспетчер отказоустойчивости кластеров** > **Сети**, щелкните сеть правой кнопкой мыши и выберите **Свойства**. Правильное значение указано в поле **Имя** на вкладке **Общие**.|
|`AG listener IP Address Resource Name`|Имя ресурса для IP-адреса прослушивателя SQL Server FCI или AG. Выберите **Диспетчер отказоустойчивости кластеров** > **Роли**. Для роли экземпляра отказоустойчивого кластера SQL Server в разделе **Имя сервера** щелкните правой кнопкой мыши ресурс IP-адреса и выберите **Свойства**. Правильное значение указано в поле **Имя** на вкладке **Общие**.|
|`ILBIP`|IP-адрес внутренней подсистемы балансировки нагрузки (ILB). Этот адрес настраивается в портал Azure в качестве внешнего адреса ILB. Это также IP-адрес SQL Server FCI. Его можно найти в окне **Диспетчер отказоустойчивости кластеров** на той же странице свойств, где указано значение `<AG listener IP Address Resource Name>`.|
|`nnnnn`|Порт пробы, настроенный в пробе работоспособности балансировщика нагрузки. Допускается любой неиспользуемый TCP-порт.|
|SubnetMask| Маска подсети для параметра кластера. Он должен быть широковещательным IP-адресом TCP: `255.255.255.255` .| 


После настройки пробы кластера все параметры кластера можно просмотреть в PowerShell. Выполните следующий скрипт:

```powershell
Get-ClusterResource $IPResourceName | Get-ClusterParameter
```


## <a name="test-failover"></a>Тестовая отработка отказа


Тестовая отработка отказа кластеризованного ресурса для проверки функциональности кластера. 


Выполните следующие шаги.

1. Откройте [SQL Server Management Studio)](/sql/ssms/download-sql-server-management-studio-ssms) и подключитесь к прослушивателю группы доступности. 
1. Разверните **Always on группа доступности** в **обозревателе объектов**. 
1. Щелкните правой кнопкой мыши группу доступности и выберите пункт **отработка отказа**. 
1. Следуйте указаниям мастера, чтобы выполнить отработку отказа группы доступности на вторичную реплику. 

Отработка отказа выполняется, когда реплики переключают роли и обе синхронизируются. 


## <a name="test-connectivity"></a>Проверка подключения

Чтобы проверить подключение, войдите на другую виртуальную машину в той же виртуальной сети. Откройте **SQL Server Management Studio** и подключитесь к прослушивателю группы доступности.

>[!NOTE]
>При необходимости можно [скачать SQL Server Management Studio](/sql/ssms/download-sql-server-management-studio-ssms).

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о SQL Serverии функций HADR в Azure см. в разделе [группы доступности](availability-group-overview.md) и [экземпляр отказоустойчивого кластера](failover-cluster-instance-overview.md). Вы также [можете ознакомиться с рекомендациями](hadr-cluster-best-practices.md) по настройке среды для обеспечения высокого уровня доступности и аварийного восстановления. 



