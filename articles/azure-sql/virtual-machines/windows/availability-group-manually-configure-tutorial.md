---
title: Руководство по Настройка группы доступности Always On для SQL Server
description: В этом руководстве показано, как создать группу доступности AlwaysOn SQL Server на виртуальных машинах Azure.
services: virtual-machines
documentationCenter: na
author: MashaMSFT
editor: monicar
tags: azure-service-management
ms.assetid: 08a00342-fee2-4afe-8824-0db1ed4b8fca
ms.service: virtual-machines-sql
ms.subservice: hadr
ms.topic: tutorial
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 08/30/2018
ms.author: mathoma
ms.custom: seo-lt-2019
ms.openlocfilehash: feab48f32396bcc89621433930c9a9f4689d8286
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "97355449"
---
# <a name="tutorial-manually-configure-an-availability-group-sql-server-on-azure-vms"></a>Руководство по настройке группы доступности вручную (SQL Server на виртуальных машинах Azure)
[!INCLUDE[appliesto-sqlvm](../../includes/appliesto-sqlvm.md)]

В этом руководстве показано, как создать группу доступности Always On для SQL Server на виртуальных машинах Azure. Выполнив все действия в этом руководстве, вы создадите группу доступности с репликой базы данных на двух серверах SQL Server.

В этой статье, показано как настроить среду группы доступности вручную, но эту процедуру можно также выполнить с помощью [портала Azure](availability-group-azure-portal-configure.md), [PowerShell или Azure CLI](availability-group-az-commandline-configure.md) либо [шаблонов быстрого запуска Azure](availability-group-quickstart-template-configure.md). 


**Оценка времени**. Выполнение займет около 30 минут, если [предварительные требования](availability-group-manually-configure-prerequisites-tutorial.md) выполнены.


## <a name="prerequisites"></a>Предварительные требования

К этому руководству стоит приступать, если у вас есть хотя бы базовое представление о группах доступности Always On для SQL Server. Если вы хотите узнать больше, ознакомьтесь со статьей [Что такое группа доступности Always On](/sql/database-engine/availability-groups/windows/overview-of-always-on-availability-groups-sql-server).

Прежде чем приступить к этому руководству, необходимо [настроить необходимые компоненты для создания групп доступности Always On на виртуальных машинах Azure](availability-group-manually-configure-prerequisites-tutorial.md). Если эти предварительные условия уже выполнены, то можно перейти к [созданию кластера](#CreateCluster).

В следующей таблице перечислены предварительные условия, которые необходимо выполнить перед изучением данного руководства.

| Требование |Описание |
|----- |----- |----- |
|:::image type="icon" source="./media/availability-group-manually-configure-tutorial/square.png" border="false":::   **Два экземпляра SQL Server** | В группе доступности Azure. <br/> В отдельном домене. <br/> С установленным компонентом отказоустойчивой кластеризации. |
|:::image type="icon" source="./media/availability-group-manually-configure-tutorial/square.png" border="false":::   **Windows Server** | Файловый ресурс для свидетеля кластера. |  
|:::image type="icon" source="./media/availability-group-manually-configure-tutorial/square.png" border="false":::   **Учетная запись службы SQL Server** | Доменная учетная запись |
|:::image type="icon" source="./media/availability-group-manually-configure-tutorial/square.png" border="false":::   **Учетная запись службы агента SQL Server** | Доменная учетная запись |  
|:::image type="icon" source="./media/availability-group-manually-configure-tutorial/square.png" border="false":::   **Открытые порты брандмауэра** | — SQL Server: **1433** для экземпляра по умолчанию. <br/> — Конечная точка зеркального отображения базы данных: **5022** или любой доступный порт. <br/> — Проверка работоспособности группы доступности подсистемы балансировки нагрузки для IP-адреса: **59999** или любой доступный порт. <br/> — Проверка работоспособности ядра кластера подсистемы балансировки нагрузки для IP-адреса: **58888** или любой доступный порт. |
|:::image type="icon" source="./media/availability-group-manually-configure-tutorial/square.png" border="false":::   **Добавление компонента отказоустойчивой кластеризации** | Этот компонент нужен на обоих экземплярах SQL Server |
|:::image type="icon" source="./media/availability-group-manually-configure-tutorial/square.png" border="false":::   **Доменная учетная запись для установки** | Локальный администратор на каждом сервере SQL Server. <br/> Участник фиксированной роли сервера SQL Server sysadmin для каждого экземпляра SQL Server.  |

>[!NOTE]
> Многие шаги, приведенные в этом руководстве, уже можно автоматизировать с помощью [портала Azure](availability-group-azure-portal-configure.md), [PowerShell и Az CLI](./availability-group-az-commandline-configure.md) или [шаблонов быстрого запуска Azure](availability-group-quickstart-template-configure.md).


<!--**Procedure**: *This is the first "step". Make titles H2's and short and clear – H2's appear in the right pane on the web page and are important for navigation.*-->

<a name="CreateCluster"></a>

## <a name="create-the-cluster"></a>Создайте кластер.

Первым шагом после выполнения предварительных условий является создание отказоустойчивого кластера Windows Server, включающего в себя два сервера SQL Server и следящий сервер.

1. Подключитесь по протоколу удаленного рабочего стола к первому серверу SQL Server, используя доменную учетную запись с правами администратора для двух экземпляров SQL Server и следящего сервера.

   >[!TIP]
   >Если вы следовали указаниям в [документе с предварительными требованиями](availability-group-manually-configure-prerequisites-tutorial.md), то уже создали учетную запись **CORP\Install**. Используйте ее.

2. На панели мониторинга **Диспетчер сервера** выберите **Инструменты** и **Диспетчер отказоустойчивости кластеров**.
3. В левой области щелкните правой кнопкой мыши **Диспетчер отказоустойчивости кластеров** и выберите **Создать кластер**.

   ![Создать кластер](./media/availability-group-manually-configure-tutorial/40-createcluster.png)

4. В мастере создания кластеров создайте кластер с одним узлом, поэтапно настроив параметры на всех страницах, как указано в таблице ниже.

   | Страница | Настройки |
   | --- | --- |
   | Перед началом |По умолчанию |
   | Выбор серверов |Введите имя первого сервера SQL Server в поле **Введите имя сервера** и щелкните **Добавить**. |
   | Предупреждение проверки |Выберите вариант **Нет. Для этого кластера не требуется поддержка корпорации Майкрософт, поэтому нет необходимости выполнять проверочные тесты. После нажатия кнопки "Далее" продолжить создание кластера**. |
   | Точка доступа для администрирования кластера |Введите имя кластера, например **SQLAGCluster1**, в поле **Имя кластера**.|
   | Подтверждение |Используйте параметры по умолчанию, если вы не используете дисковые пространства. Ознакомьтесь с примечанием после этой таблицы. |

### <a name="set-the-windows-server-failover-cluster-ip-address"></a>Указание IP-адреса отказоустойчивого кластера Windows Server

  > [!NOTE]
  > В Windows Server 2019 кластер создает **имя распределенного сервера** вместо **сетевого имени кластера**. Если вы используете Windows Server 2019, пропустите все действия, которые ссылаются на имя ядра кластера в этом руководстве. Вы можете создать имя сети кластера с помощью [PowerShell](failover-cluster-instance-storage-spaces-direct-manually-configure.md#create-failover-cluster). Ознакомьтесь с блогом [Отказоустойчивый кластер: объекта сети кластера](https://blogs.windows.com/windowsexperience/2018/08/14/announcing-windows-server-2019-insider-preview-build-17733/#W0YAxO8BfwBRbkzG.97) для получения дополнительных сведений. 

1. В **диспетчере отказоустойчивости кластеров** прокрутите вниз до раздела **Ресурсы ядра кластера** и разверните сведения о кластере. Вы увидите ресурсы **Имя** и **IP-адрес** с состоянием **Ошибка**. Ресурс IP-адреса невозможно подключить к сети, так как кластеру назначен тот же IP-адрес, что и виртуальной машине, то есть он повторяется.

2. Щелкните правой кнопкой мыши ресурс **IP-адрес** в состоянии сбоя и выберите **Свойства**.

   ![Свойства кластера](./media/availability-group-manually-configure-tutorial/42_IPProperties.png)

3. Выберите **Статический IP-адрес** и укажите доступный адрес из той же подсети, что и ваши виртуальные машины.

4. В разделе **Ресурсы ядра кластера** щелкните правой кнопкой мыши имя кластера и выберите **Подключить**. Подождите, пока оба ресурса будут подключены. Когда ресурс имени кластера подключится, на сервер контроллера домена будет добавлена новая учетную запись компьютера Active Directory (AD). Эта учетная запись впоследствии будет использоваться для запуска кластерной службы группы доступности.

### <a name="add-the-other-sql-server-to-cluster"></a><a name="addNode"></a>Добавление в кластер другого сервера SQL Server

Добавьте в кластер другой сервер SQL Server.

1. В дереве обозревателя щелкните правой кнопкой мыши кластер и выберите **Добавить узел**.

    ![Добавление узла в кластер](./media/availability-group-manually-configure-tutorial/44-addnode.png)

1. В **мастере добавления узлов** нажмите кнопку **Далее**. На странице **Выбор серверов** добавьте второй сервер SQL Server. Введите имя этого сервера в поле **Введите имя сервера** и щелкните **Добавить**. Когда все будет готово, нажмите кнопку **Далее**.

1. На странице **Предупреждение проверки** нажмите кнопку **Нет** (в рабочем сценарии следует выполнить проверочные тесты). Затем нажмите кнопку **Далее**.

8. Если вы используете дисковые пространства, то на странице **Подтверждение** снимите флажок **Добавление всех допустимых хранилищ в кластер**.

   ![Подтверждение добавления узла](./media/availability-group-manually-configure-tutorial/46-addnodeconfirmation.png)

   >[!WARNING]
   >Если вы используете дисковые пространства и не сняли флажок **Добавление всех допустимых хранилищ в кластер**, то Windows отключит виртуальные диски во время процесса кластеризации. Как следствие, они не будут отображаться в диспетчере дисков или проводнике, пока дисковые пространства не будут удалены из кластера и повторно подключены с помощью PowerShell. Дисковые пространства группируют несколько дисков в пулы носителей. Дополнительные сведения см. в статье [Обзор дисковых пространств](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/hh831739(v=ws.11)).
   >

1. Выберите **Далее**.

1. Нажмите кнопку **Готово**.

   Диспетчер отказоустойчивости кластеров показывает, что в кластере появился новый узел. Он отображается в контейнере **Nodes**.

10. Выйдите из сеанса удаленного рабочего стола.

### <a name="add-a-cluster-quorum-file-share"></a>Добавление файлового ресурса кворума кластера

В этом примере кластер Windows использует общую папку для создания кворума кластера. В этом руководстве используется кворум "Большинство узлов и общих файловых ресурсов". Дополнительные сведения см. в разделе [Общее представление о конфигурациях кворума в отказоустойчивом кластере](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc731739(v=ws.11)).

1. Подключитесь к рядовому серверу файлового ресурса-свидетеля с помощью сеанса удаленного рабочего стола.

1. В **диспетчере сервера** выберите **Инструменты**. Откройте **Управление компьютером**.

1. Выберите **Общие папки**.

1. Щелкните правой кнопкой мыши **Общие ресурсы** и выберите **Создать папку**.

   ![Щелчок элемента "Общие ресурсы" правой кнопкой мыши и выбор пункта "Создать папку"](./media/availability-group-manually-configure-tutorial/48-newshare.png)

   Используйте **мастер создания общих ресурсов**, чтобы создать общий ресурс.

1. Рядом с полем **Путь к папке** нажмите кнопку **Обзор** и укажите путь к общей папке или создайте его. Выберите **Далее**.

1. В окне **Имя, описание и параметры** проверьте имя и путь общего ресурса. Выберите **Далее**.

1. В окне **Разрешения для общей папки** выберите **Настройка разрешений доступа**. Выберите **Пользовательские**.

1. В окне **Настройка разрешений доступа** нажмите кнопку **Добавить**.

1. Убедитесь, что у учетной записи, используемой для создания кластера, имеется полный доступ.

   ![Убедитесь, что у учетной записи, используемой для создания кластера, имеется полный доступ.](./media/availability-group-manually-configure-tutorial/50-filesharepermissions.png)

1. Щелкните **ОК**.

1. В окне **Разрешения для общей папки** нажмите кнопку **Готово**. Выберите **Готово** еще раз.  

1. Выйдите с сервера.

### <a name="configure-the-cluster-quorum"></a>Настройка кворума кластера

Теперь настройте кворум кластера.

1. Подключитесь к первому узлу кластера с помощью сеанса удаленного рабочего стола.

1. В **диспетчере отказоустойчивости кластеров** щелкните кластер правой кнопкой мыши, наведите указатель на пункт **Дополнительные действия** и выберите **Настройка параметров кворума кластера**.

   ![Выбор элемента "Настройка параметров кворума кластера"](./media/availability-group-manually-configure-tutorial/52-configurequorum.png)

1. В **мастере настройки кворума кластера** нажмите кнопку **Далее**.

1. В окне **Выбор параметра конфигурации кворума** выберите **Выбрать свидетель кворума** и нажмите кнопку **Далее**.

1. В окне **Выбор свидетеля кворума** выберите **Настроить файловый ресурс-свидетель**.

   >[!TIP]
   >Windows Server 2016 поддерживает облако-свидетель. При выборе этого типа свидетеля файловый ресурс-свидетель не требуется. Дополнительные сведения см. в разделе [Развертывание облачного следящего сервера для отказоустойчивого кластера](/windows-server/failover-clustering/deploy-cloud-witness). В этом руководстве используется файловый ресурс-свидетель, который поддерживается в предыдущих операционных системах.
   >

1. В поле **Настройка файлового ресурса-свидетеля** введите путь к созданному общему ресурсу. Выберите **Далее**.

1. Проверьте параметры в окне **Подтверждение**. Выберите **Далее**.

1. Нажмите кнопку **Готово**.

Теперь ресурсы ядра кластера настроены для использования файлового ресурса-свидетеля.

## <a name="enable-availability-groups"></a>Включение групп доступности

Теперь вам нужно включить функцию **групп доступности Always On**. Выполните эти шаги для обоих серверов SQL Server.

1. На **начальном экране** запустите **Диспетчер конфигурации SQL Server**.
2. В дереве обозревателя выберите **Службы SQL Server**, затем щелкните правой кнопкой мыши службу **SQL Server (MSSQLSERVER)** и выберите пункт **Свойства**.
3. Откройте вкладку **Высокий уровень доступности AlwaysOn**, а затем щелкните **Включить группы доступности AlwaysOn**, как показано ниже:

    ![Включение групп доступности AlwaysOn](./media/availability-group-manually-configure-tutorial/54-enableAlwaysOn.png)

4. Нажмите кнопку **Применить**. Нажмите кнопку **ОК** во всплывающем диалоговом окне.

5. Перезапустите службу SQL Server.

Повторите эти действия на другом сервере SQL Server.

<!-----------------
## <a name="endpoint-firewall"></a>Open firewall for the database mirroring endpoint

Each instance of SQL Server that participates in an availability group requires a database mirroring endpoint. This endpoint is a TCP port for the instance of SQL Server that is used to synchronize the database replicas in the availability groups on that instance.

On both SQL Servers, open the firewall for the TCP port for the database mirroring endpoint.

1. On the first SQL Server **Start** screen, launch **Windows Firewall with Advanced Security**.
2. In the left pane, select **Inbound Rules**. On the right pane, select **New Rule**.
3. For **Rule Type**, choose **Port**.
1. For the port, specify TCP and choose an unused TCP port number. For example, type *5022* and select **Next**.

   >[!NOTE]
   >For this example, we're using TCP port 5022. You can use any available port.

5. In the **Action** page, keep **Allow the connection** selected and select **Next**.
6. In the **Profile** page, accept the default settings and select **Next**.
7. In the **Name** page, specify a rule name, such as **Default Instance Mirroring Endpoint** in the **Name** text box, then select **Finish**.

Repeat these steps on the second SQL Server.
-------------------------->

## <a name="create-a-database-on-the-first-sql-server"></a>Создание базы данных на первом сервере SQL Server

1. Запустите RDP-файл подключения к первому серверу SQL Server с доменной учетной записью, которая является участником фиксированной серверной роли sysadmin.
1. Откройте SQL Server Management Studio и подключитесь к первому серверу SQL Server.
7. В **обозревателе объектов** щелкните правой кнопкой мыши **Базы данных** и выберите пункт **Создать базу данных**.
8. В поле **Имя базы данных** введите **MyDB1**, а затем нажмите кнопку **ОК**.

### <a name="create-a-backup-share"></a><a name="backupshare"></a>Создание общего ресурса для резервных копий

1. На первом сервере SQL Server в **диспетчере сервера** выберите **Инструменты**. Откройте **Управление компьютером**.

1. Выберите **Общие папки**.

1. Щелкните правой кнопкой мыши **Общие ресурсы** и выберите **Создать папку**.

   ![Выбор элемента "Создать папку"](./media/availability-group-manually-configure-tutorial/48-newshare.png)

   Используйте **мастер создания общих ресурсов**, чтобы создать общий ресурс.

1. Рядом с полем **Путь к папке** нажмите кнопку **Обзор** и укажите путь к общей папке резервных копий баз данных или создайте его. Выберите **Далее**.

1. В окне **Имя, описание и параметры** проверьте имя и путь общего ресурса. Выберите **Далее**.

1. В окне **Разрешения для общей папки** выберите **Настройка разрешений доступа**. Выберите **Пользовательские**.

1. В окне **Настройка разрешений доступа** нажмите кнопку **Добавить**.

1. Убедитесь, что учетные записи службы SQL Server и агента службы SQL Server для обоих серверов имеют полный доступ.

   ![Убедитесь, что учетные записи службы SQL Server и агента службы SQL Server для обоих серверов имеют полный доступ.](./media/availability-group-manually-configure-tutorial/68-backupsharepermission.png)

1. Щелкните **ОК**.

1. В окне **Разрешения для общей папки** нажмите кнопку **Готово**. Выберите **Готово** еще раз.  

### <a name="take-a-full-backup-of-the-database"></a>Создание полной резервной копии базы данных

Необходимо создать резервную копию новой базы данных, чтобы инициализировать цепочку журналов. Без создания резервной копии для новой базы данных вы не сможете добавить ее в группу доступности.

1. В **обозревателе объектов** щелкните правой кнопкой мыши базу данных, наведите указатель на пункт **Задачи** и выберите **Создать резервную копию**.

1. Нажмите кнопку **ОК**, чтобы создать полную резервную копию в расположении резервных копий по умолчанию.

## <a name="create-the-availability-group"></a>Создание группы доступности

Теперь все готово к настройке группы доступности. Для этого выполните следующее:

* Создайте базу данных на первом сервере SQL Server.
* Создание полной резервной копии и резервной копии журнала транзакций базы данных.
* Восстановите полную резервную копию и резервную копию журналов на втором сервере SQL Server с параметром **NORECOVERY**.
* Создание группы доступности (**AG1**) с синхронной фиксацией, автоматической отработкой отказа и доступными для чтения вторичными репликами.

### <a name="create-the-availability-group"></a>Создание группы доступности:

1. Откройте сеанс удаленного рабочего стола для первого сервера SQL Server. В **обозревателе объектов** в SSMS щелкните правой кнопкой мыши элемент **Высокий уровень доступности AlwaysOn** и выберите пункт **Мастер создания групп доступности**.

    ![Запуск мастера создания групп доступности](./media/availability-group-manually-configure-tutorial/56-newagwiz.png)

2. На странице **Введение** выберите **Далее**. На странице **Указание имени группы доступности** в поле **Имя группы доступности** введите имя группы доступности (например, **AG1**). Выберите **Далее**.

    ![Мастер создания групп доступности, страница "Указание имени группы доступности"](./media/availability-group-manually-configure-tutorial/58-newagname.png)

3. На странице **Выбор баз данных** выберите свою базу данных и нажмите кнопку **Далее**.

   >[!NOTE]
   >Эта база данных отвечает требованиям для создания группы доступности, так как вы создали для нее как минимум одну полную резервную копию на соответствующей первичной реплике.
   >

   ![Мастер создания групп доступности, страница "Выбор баз данных"](./media/availability-group-manually-configure-tutorial/60-newagselectdatabase.png)

4. На странице **Указание реплик** выберите **Добавить реплику**.

   ![Мастер создания групп доступности, страница "Указание реплик"](./media/availability-group-manually-configure-tutorial/62-newagaddreplica.png)

5. Появится диалоговое окно **Подключение к серверу** . Введите имя второго сервера в поле **Имя сервера**. Щелкните **Подключить**.

   На странице **Указание реплик** в списке **Реплики доступности** должен отобразиться второй сервер. Настройте реплики, как описано ниже.

   ![Мастер создания групп доступности, заполненная страница "Указание реплик"](./media/availability-group-manually-configure-tutorial/64-newagreplica.png)

6. Выберите **Конечные точки**, чтобы просмотреть конечную точку зеркального отображения базы данных для этой группы доступности. Используйте тот же порт, что и при настройке [правила брандмауэра для конечных точек зеркального отображения базы данных](availability-group-manually-configure-prerequisites-tutorial.md#endpoint-firewall).

    ![Мастер создания групп доступности, страница "Выбор начальной синхронизации данных"](./media/availability-group-manually-configure-tutorial/66-endpoint.png)

8. На странице **Выбор начальной синхронизации данных** выберите **Полная** и укажите сетевую папку. Это должен быть [созданный вами общий ресурс для резервных копий](#backupshare). В примере используется папка **\\\\<первый сервер SQL Server\>\Backup\\** . Выберите **Далее**.

   >[!NOTE]
   >При полной синхронизации полная резервная копия базы данных создается на первом экземпляре SQL Server и восстанавливается на втором экземпляре. Полная синхронизация не рекомендуется для больших баз данных, так как может занимать много времени. Это время можно сократить, вручную создав резервную копию базы данных и восстановив ее с параметром `NO RECOVERY`. Если до настройки группы доступности база данных уже была восстановлена с параметром `NO RECOVERY` на втором сервере SQL Server, выберите вариант **Только присоединение**. Если вы хотите создать резервную копию после настройки группы доступности, выберите переключатель **Пропустить начальную синхронизацию данных**.
   >

   ![Выбор элемента "Пропустить начальную синхронизацию данных"](./media/availability-group-manually-configure-tutorial/70-datasynchronization.png)

9. На странице **Проверка** нажмите кнопку **Далее**. Эта страница должна выглядеть, как на рисунке ниже.

    ![Мастер создания групп доступности, страница "Проверка"](./media/availability-group-manually-configure-tutorial/72-validation.png)

    >[!NOTE]
    >Появится предупреждение о конфигурации прослушивателя группы доступности, так как он еще не настроен. Это предупреждение можно игнорировать, так как на виртуальных машинах Azure создать прослушиватель можно и после создания Azure Load Balancer.

10. На странице **Сводка** щелкните **Готово** и подождите, пока мастер настроит новую группу доступности. На странице **Ход выполнения** вы можете нажать кнопку **Дополнительные сведения**, чтобы просмотреть подробности хода выполнения. После того как мастер закончит работу, проверьте страницу **Результаты**, чтобы убедиться, что группа доступности успешно создана.

     ![Мастер создания групп доступности, страница "Результаты"](./media/availability-group-manually-configure-tutorial/74-results.png)

11. Нажмите кнопку **Закрыть**, чтобы выйти из мастера.

### <a name="check-the-availability-group"></a>Проверка группы доступности

1. В **обозревателе объектов** разверните узел **Высокий уровень доступности AlwaysOn** и узел **Группы доступности**. Теперь в этом контейнере должна появиться новая группа доступности. Щелкните правой кнопкой мыши группу доступности и выберите **Показать панель мониторинга**.

   ![Отображение панели мониторинга для группы доступности](./media/availability-group-manually-configure-tutorial/76-showdashboard.png)

   **Панель мониторинга Always On** должна выглядеть, как показано на снимке экрана ниже:

   ![Панель мониторинга для группы доступности](./media/availability-group-manually-configure-tutorial/78-agdashboard.png)

   Вы увидите реплики, режим отработки отказа для каждой из них и состояние синхронизации.

2. В **диспетчере отказоустойчивости кластеров** выберите свой кластер. Выберите **Роли**. Имя группы доступности, которое вы использовали, представляет собой роль в кластере. Так как вы не настроили прослушиватель, у этой группы доступности нет IP-адреса для подключений клиентов. Вы настроите прослушиватель после создания Azure Load Balancer.

   ![Группа доступности в диспетчере отказоустойчивости кластеров](./media/availability-group-manually-configure-tutorial/80-clustermanager.png)

   > [!WARNING]
   > Не пытайтесь выполнить отработку отказа для группы доступности через диспетчер отказоустойчивости кластеров. Все операции отработки отказов следует выполнять через **панель мониторинга AlwaysOn** в SSMS. Дополнительные сведения см. в статье [Отказоустойчивая кластеризация и группы доступности AlwaysOn (SQL Server)](/sql/database-engine/availability-groups/windows/failover-clustering-and-always-on-availability-groups-sql-server).
    >

На этом этапе у вас есть группа доступности с репликами в двух экземплярах SQL Server. Группу доступности можно перемещать между экземплярами. Пока невозможно подключиться к этой группе доступности, так как отсутствует прослушиватель. В виртуальных машинах Azure для прослушивателя требуется подсистема балансировки нагрузки. Следующий шаг — создание подсистемы балансировки нагрузки в Azure.

<a name="configure-internal-load-balancer"></a>

## <a name="create-an-azure-load-balancer"></a>Создание Azure Load Balancer

[!INCLUDE [sql-ag-use-dnn-listener](../../includes/sql-ag-use-dnn-listener.md)]

Для группы доступности SQL Server на виртуальных машинах Azure необходима подсистема балансировки нагрузки. Подсистема балансировки нагрузки хранит IP-адреса для прослушивателей группы доступности и отказоустойчивого кластера Windows Server. В этом разделе кратко описывается, как создать подсистему балансировки нагрузки на портале Azure.

Azure Load Balancer может быть подсистемой балансировки нагрузки цен. категории "Стандартный" или "Базовый". Load Balancer уровня "Стандартный" имеет больше возможностей, чем Load Balancer уровня "Базовый". Для группы доступности Load Balancer уровня "Базовый" является обязательным, если используется зона доступности (вместо набора доступности). Дополнительные сведения о различиях между подсистемами балансировки нагрузки см. в разделе [Сравнение SKU Load Balancer](../../../load-balancer/skus.md).

1. На портале Azure перейдите к группе ресурсов, содержащей ваши экземпляры SQL Server, и нажмите кнопку **+ Добавить**.
1. Найдите **балансировщик нагрузки**. Выберите подсистему балансировки нагрузки, опубликованную корпорацией Майкрософт.

   ![Выбор подсистемы балансировки нагрузки, опубликованной корпорацией Майкрософт](./media/availability-group-manually-configure-tutorial/82-azureloadbalancer.png)

1. Выберите **Создать**.
1. Настройте следующие параметры для балансировщика нагрузки:

   | Параметр | Поле |
   | --- | --- |
   | **имя**; |Используйте для подсистемы балансировки нагрузки текстовое имя, например **sqlLB**. |
   | **Тип** |Внутренние |
   | **Виртуальная сеть** |Используйте имя виртуальной сети Azure. |
   | **Подсеть** |Используйте имя подсети, в которой находится виртуальная машина.  |
   | **Назначение IP-адресов** |Статические |
   | **IP-адрес** |Используйте доступный адрес из подсети. Этот адрес используется для прослушивателя группы доступности. Обратите внимание, что он отличается от IP-адреса кластера.  |
   | **Подписка** |Используйте подписку, в которой находится виртуальная машина. |
   | **Расположение** |Используйте расположение, в котором находится виртуальная машина. |

   Колонка портала Azure должна выглядеть следующим образом.

   ![Создание балансировщика нагрузки](./media/availability-group-manually-configure-tutorial/84-createloadbalancer.png)

1. Нажмите кнопку **Создать**, чтобы создать подсистему балансировки нагрузки.

Для настройки подсистемы балансировки нагрузки необходимо создать внутренний пул, пробу и задать правила балансировки нагрузки. Это можно сделать на портале Azure.

### <a name="add-a-backend-pool-for-the-availability-group-listener"></a>Добавление серверного пула для прослушивателя группы доступности

1. На портале Azure перейдите к своей группе доступности. Может потребоваться обновить представление, чтобы отобразить только что созданную подсистему балансировки нагрузки.

   ![Поиск подсистемы балансировки нагрузки в группе ресурсов](./media/availability-group-manually-configure-tutorial/86-findloadbalancer.png)

1. Откройте подсистему балансировки нагрузки, выберите **Серверные пулы** и нажмите кнопку **+ Добавить**.

1. Введите имя для серверного пула.

1. Свяжите серверный пул с группой доступности, в которую входят виртуальные машины.

1. В разделе **Целевые IP-конфигурации сети** установите флажок **Виртуальная машина** и выберите обе виртуальные машины, на которых будут размещаться реплики группы доступности. Не следует добавлять сервер файлового ресурса-свидетеля.

   >[!NOTE]
   >Если не указать обе виртуальные машины, будет установлено подключение только к первичной реплике.

1. Нажмите кнопку **ОК**, чтобы создать серверный пул.

### <a name="set-the-probe"></a>Настройка пробы

1. Откройте подсистему балансировки нагрузки, выберите **Пробы работоспособности** и нажмите кнопку **+ Добавить**.

1. Настройте пробу работоспособности прослушивателя, как показано ниже.

   | Параметр | Описание | Пример
   | --- | --- |---
   | **имя**; | текст | SQLAlwaysOnEndPointProbe |
   | **протокол**; | Выберите протокол TCP. | TCP |
   | **порт**. | Любой неиспользуемый порт. | 59999 |
   | **Интервал**  | Промежуток времени между повторными попытками выполнения пробы в секундах. |5 |
   | **Пороговое значение сбоя** | Число последовательных сбоев пробы, после которых виртуальная машина будет считаться неработоспособной.  | 2 |

1. Нажмите кнопку **ОК**, чтобы задать пробу работоспособности.

### <a name="set-the-load-balancing-rules"></a>Настройка правил балансировки нагрузки

1. Откройте подсистему балансировки нагрузки, выберите **Правила балансировки нагрузки** и нажмите кнопку **+ Добавить**.

1. Настройте правила балансировки нагрузки прослушивателя, как показано ниже.

   | Параметр | Описание | Пример
   | --- | --- |---
   | **имя**; | текст | SQLAlwaysOnEndPointListener |
   | **Frontend IP address** (Интерфейсный IP-адрес) | Выберите адрес. |Используйте адрес, который был создан при создании подсистемы балансировки нагрузки. |
   | **протокол**; | Выберите протокол TCP. |TCP |
   | **порт**. | Создайте порт для прослушивателя группы доступности | 1433 |
   | **Серверный порт** | Это поле не используется, если задан плавающий IP-адрес для прямого ответа от сервера. | 1433 |
   | **Проба** |Имя, указанное для пробы. | SQLAlwaysOnEndPointProbe |
   | **Сохранение сеанса** | Раскрывающийся список. | **None** |
   | **Время ожидания простоя** | Интервал (в минутах), в течение которого подключение TCP остается открытым. | 4 |
   | **Плавающий IP-адрес (прямой ответ от сервера)** | |Активировано |

   > [!WARNING]
   > Параметры прямого ответа от сервера задаются во время создания. Их невозможно изменить.
   >

1. Нажмите кнопку **OK**, чтобы задать правила балансировки нагрузки прослушивателя.

### <a name="add-the-cluster-core-ip-address-for-the-windows-server-failover-cluster-wsfc"></a>Добавьте IP-адрес ядра кластера для отказоустойчивого кластера Windows Server (WSFC).

IP-адрес WSFC также должен находиться в подсистеме балансировки нагрузки.

1. На портале Azure перейдите к этой же подсистеме балансировки нагрузки Azure. Выберите **Конфигурация IP внешнего интерфейса** и нажмите кнопку **+ Добавить**. Используйте IP-адрес, настроенный для WSFC в ресурсах ядра кластера. Укажите статический IP-адрес.

1. Откройте подсистему балансировки нагрузки, выберите **Пробы работоспособности** и нажмите кнопку **+ Добавить**.

1. Настройте пробу работоспособности IP-адреса ядра кластера WSFC следующим образом.

   | Параметр | Описание | Пример
   | --- | --- |---
   | **имя**; | текст | WSFCEndPointProbe |
   | **протокол**; | Выберите протокол TCP. | TCP |
   | **порт**. | Любой неиспользуемый порт. | 58888 |
   | **Интервал**  | Промежуток времени между повторными попытками выполнения пробы в секундах. |5 |
   | **Пороговое значение сбоя** | Число последовательных сбоев пробы, после которых виртуальная машина будет считаться неработоспособной.  | 2 |

1. Нажмите кнопку **ОК**, чтобы задать пробу работоспособности.

1. Настройте правила балансировки нагрузки. Выберите **Правила балансировки нагрузки** и нажмите кнопку **+ Добавить**.

1. Задайте правила балансировки нагрузки IP-адресов ядра кластера следующим образом.

   | Параметр | Описание | Пример
   | --- | --- |---
   | **имя**; | текст | WSFCEndPoint |
   | **Frontend IP address** (Интерфейсный IP-адрес) | Выберите адрес. |Используйте адрес, который был создан при настройке IP-адреса WSFC. Он отличается от IP-адреса прослушивателя |
   | **протокол**; | Выберите протокол TCP. |TCP |
   | **порт**. | Используйте порт для IP-адреса кластера. Это доступный порт, который не используется для порта пробы прослушивателя. | 58888 |
   | **Серверный порт** | Это поле не используется, если задан плавающий IP-адрес для прямого ответа от сервера. | 58888 |
   | **Проба** |Имя, указанное для пробы. | WSFCEndPointProbe |
   | **Сохранение сеанса** | Раскрывающийся список. | **None** |
   | **Время ожидания простоя** | Интервал (в минутах), в течение которого подключение TCP остается открытым. | 4 |
   | **Плавающий IP-адрес (прямой ответ от сервера)** | |Активировано |

   > [!WARNING]
   > Параметры прямого ответа от сервера задаются во время создания. Их невозможно изменить.
   >

1. Нажмите кнопку **ОК**, чтобы задать правила балансировки нагрузки.

## <a name="configure-the-listener"></a><a name="configure-listener"></a>Настройка прослушивателя

Далее нужно настроить прослушиватель группы доступности в отказоустойчивом кластере.

> [!NOTE]
> В этом руководстве показано, как создать отдельный прослушиватель с одним IP-адресом внутренней подсистемы балансировки нагрузки (ILB). Чтобы создать один или несколько прослушивателей с использованием одного или нескольких IP-адресов, ознакомьтесь со статьей [Configure one or more Always On Availability Group Listeners - Resource Manager](availability-group-listener-powershell-configure.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json) (Настройка одного или нескольких прослушивателей групп доступности AlwaysOn в модели Resource Manager).
>

[!INCLUDE [ag-listener-configure](../../../../includes/virtual-machines-ag-listener-configure.md)]

## <a name="set-listener-port"></a>Настройка порта прослушивателя

Настройте порт прослушивателя в SQL Server Management Studio.

1. Запустите SQL Server Management Studio и подключитесь к основной реплике.

1. Перейдите в раздел **Высокий уровень доступности AlwaysOn** > **Группы доступности** > **Прослушиватели группы доступности**.

1. Теперь вы увидите имя прослушивателя, созданного в диспетчере отказоустойчивости кластеров. Щелкните имя прослушивателя правой кнопкой мыши и выберите пункт **Свойства**.

1. В поле **Порт** укажите номер порта для прослушивателя группы доступности. Значение по умолчанию — 1433. Щелкните **ОК**.

Теперь у вас есть группа доступности SQL Server на виртуальных машинах Azure в режиме Resource Manager.

## <a name="test-connection-to-listener"></a>Проверка подключения к прослушивателю

Чтобы проверить подключение:

1. Подключитесь по протоколу удаленного рабочего стола к экземпляру SQL Server, который находится в той же виртуальной сети, но не содержит реплику. Можно использовать другой сервер SQL Server в кластере.

1. Для проверки подключения используйте служебную программу **sqlcmd**. Например, в следующем сценарии **sqlcmd** подключается к основной реплике через прослушиватель с использованием аутентификации Windows.

   ```cmd
   sqlcmd -S <listenerName> -E
   ```

   Если прослушиватель использует порт, отличный от порта по умолчанию (1433), укажите порт в строке подключения. Например, следующая команда `sqlcmd` подключается к прослушивателю через порт 1435:

   ```cmd
   sqlcmd -S <listenerName>,1435 -E
   ```

sqlcmd автоматически подключается к любому экземпляру SQL Server, на котором размещена основная реплика.

> [!TIP]
> Указанный порт должен быть открыт в брандмауэре обоих серверов SQL Server. Для обоих серверов требуется правило для входящего трафика используемого TCP-порта. Дополнительные сведения см. в статье [Добавление и изменение правила брандмауэра](/previous-versions/orphan-topics/ws.11/cc753558(v=ws.11)).
>

## <a name="next-steps"></a>Дальнейшие действия

- [Добавление в подсистему балансировки нагрузки IP-адреса для второй группы доступности](availability-group-listener-powershell-configure.md#Add-IP).