---
title: Подготовка виртуальных машин для FCI
description: Подготовьте виртуальные машины Azure, чтобы использовать их с экземпляром отказоустойчивого кластера (FCI) и SQL Server на виртуальных машинах Azure.
services: virtual-machines
documentationCenter: na
author: MashaMSFT
editor: monicar
tags: azure-service-management
ms.service: virtual-machines-sql
ms.subservice: hadr
ms.topic: how-to
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 06/02/2020
ms.author: mathoma
ms.openlocfilehash: 10f01fd5943928eda1f1e4518f30c8e3ccf56b46
ms.sourcegitcommit: 78ecfbc831405e8d0f932c9aafcdf59589f81978
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/23/2021
ms.locfileid: "98737801"
---
# <a name="prepare-virtual-machines-for-an-fci-sql-server-on-azure-vms"></a>Подготовка виртуальных машин для FCI (SQL Server на виртуальных машинах Azure)
[!INCLUDE[appliesto-sqlvm](../../includes/appliesto-sqlvm.md)]

В этой статье описывается, как подготовить виртуальные машины Azure для их использования с экземпляром отказоустойчивого кластера SQL Server (FCI). Параметры конфигурации зависят от решения для хранения FCI, поэтому убедитесь, что выбрана правильная конфигурация в соответствии с вашей средой и бизнесом. 

Дополнительные сведения см. в обзоре [FCI с SQL Server на виртуальных машинах Azure и в](failover-cluster-instance-overview.md) разделе рекомендации по работе с [кластерами](hadr-cluster-best-practices.md). 

## <a name="prerequisites"></a>Предварительные условия 

- Подписка Microsoft Azure. Начните работу [бесплатно](https://azure.microsoft.com/free/). 
- Домен Windows на виртуальных машинах Azure или локальный центр обработки данных, который был расширен в Azure с помощью связывания виртуальных сетей.
- Учетная запись с разрешениями на создание объектов на виртуальных машинах Azure и в Active Directory.
- виртуальная сеть и подсеть Azure с достаточным пространством IP-адресов для следующих компонентов:
   - Обе виртуальные машины
   - IP-адрес отказоустойчивого кластера Windows
   - IP-адрес для каждого FCI
- служба DNS, настроенная в сети Azure, которая указывает на контроллеры домена;

## <a name="choose-an-fci-storage-option"></a>Выбор параметра хранилища FCI

Параметры конфигурации для виртуальной машины зависят от варианта хранения, который планируется использовать для экземпляра отказоустойчивого кластера SQL Server. Перед подготовкой виртуальной машины ознакомьтесь с [доступными вариантами FCI Storage](failover-cluster-instance-overview.md#storage) и выберите вариант, который лучше подходит для вашей среды и бизнес-нужд. Затем внимательно выберите подходящие параметры конфигурации виртуальной машины в этой статье в зависимости от выбранного хранилища. 

## <a name="configure-vm-availability"></a>Настройка доступности виртуальной машины 

Для функции отказоустойчивого кластера требуется, чтобы виртуальные машины размещались в [группе доступности](../../../virtual-machines/linux/tutorial-availability-sets.md) или [зоне доступности](../../../availability-zones/az-overview.md#availability-zones). При выборе групп доступности можно использовать [группы размещения](../../../virtual-machines/co-location.md#proximity-placement-groups) для более близкого поиска виртуальных машин. На самом деле группы размещения с учетом расположения являются необходимым условием для использования общих дисков Azure. 

Тщательно выберите вариант доступности виртуальной машины, соответствующий предполагаемой конфигурации кластера: 

- **Общие диски Azure**. параметр доступности зависит от того, используете ли вы службы SSDS или ултрадиск уровня "Премиум":
   - SSD (цен. категория "Премиум"): группа [доступности](../../../virtual-machines/windows/tutorial-availability-sets.md#create-an-availability-set) в разных доменах сбоя и обновления для твердотельных накопителей уровня "Премиум" размещена в [группе размещения](../../../virtual-machines/windows/proximity-placement-groups-portal.md)с учетом расположения.
   - Ultra Disk: [Зона доступности](../../../virtual-machines/windows/create-portal-availability-zone.md#confirm-zone-for-managed-disk-and-ip-address) , но виртуальные машины должны размещаться в той же зоне доступности, что приводит к снижению доступности кластера до 99,9%. 
- **Общие файловые ресурсы** уровня "Премиум": [Группа доступности](../../../virtual-machines/windows/tutorial-availability-sets.md#create-an-availability-set) или [Зона доступности](../../../virtual-machines/windows/create-portal-availability-zone.md#confirm-zone-for-managed-disk-and-ip-address).
- **Локальные дисковые пространства**: [Группа доступности](../../../virtual-machines/windows/tutorial-availability-sets.md#create-an-availability-set).

> [!IMPORTANT]
> После создания виртуальной машины установить или изменить группу доступности невозможно.

## <a name="create-the-virtual-machines"></a>Создание виртуальных машин

После настройки доступности виртуальной машины можно приступать к созданию виртуальных машин. Вы можете использовать образ Azure Marketplace, который не имеет SQL Server уже установлен на нем. Однако при выборе образа для SQL Server на виртуальных машинах Azure необходимо удалить SQL Server с виртуальной машины перед настройкой экземпляра отказоустойчивого кластера. 

### <a name="considerations"></a>Рекомендации

В гостевом отказоустойчивом кластере виртуальной машины Azure рекомендуется использовать один сетевой адаптер для каждого сервера (узел кластера) и одну подсеть. Сеть Azure обладает физической избыточностью, что делает ненужными дополнительные сетевые адаптеры и подсети в кластере гостевых виртуальных машин IaaS Azure. Несмотря на то, что отчет о проверке кластера выдаст предупреждение о том, что узлы доступны только в одной сети, это предупреждение можно спокойно проигнорировать в отказоустойчивых кластерах гостевых виртуальных машин IaaS Azure.

Разместите обе виртуальные машины:

- Если вы используете группы доступности, в той же группе ресурсов Azure, что и ваша группа доступности.
- В той же виртуальной сети, что и контроллер домена, или в виртуальной сети, имеющей подходящее подключение к контроллеру домена.
- в подсети с достаточным пространством IP-адресов для обеих виртуальных машин и всех экземпляров отказоустойчивого кластера, которые со временем могут использоваться в этом кластере;
- В группе доступности или зоне доступности Azure.

Вы можете создать виртуальную машину Azure с помощью образа [с](sql-vm-create-portal-quickstart.md) предварительно установленными SQL Server или [без](../../../virtual-machines/windows/quick-create-portal.md) них. При выборе образа SQL Server необходимо вручную удалить экземпляр SQL Server перед установкой экземпляра отказоустойчивого кластера. 


## <a name="uninstall-sql-server"></a>Удаление SQL Server

В рамках процесса создания FCI вы устанавливаете SQL Server как кластеризованный экземпляр в отказоустойчивый кластер. *Если вы развернули виртуальную машину с образом Azure Marketplace без SQL Server, этот шаг можно пропустить.* При развертывании образа с предварительно установленной SQL Server необходимо отменить регистрацию виртуальной машины SQL Server из расширения агента IaaS SQL, а затем удалить SQL Server. 

### <a name="unregister-from-the-sql-iaas-agent-extension"></a>Отменить регистрацию в расширении агента IaaS SQL

SQL Server образы виртуальных машин из Azure Marketplace автоматически регистрируются с расширением агента IaaS SQL. Перед удалением предварительно установленного экземпляра SQL Server необходимо сначала [отменить регистрацию каждой виртуальной машины SQL Server из расширения агента IaaS SQL](sql-agent-extension-manually-register-single-vm.md#unregister-from-extension). 

### <a name="uninstall-sql-server"></a>Удаление SQL Server

После отмены регистрации в расширении можно удалить SQL Server. Выполните следующие действия на каждой виртуальной машине. 

1. Подключитесь к виртуальной машине по протоколу RDP.

   При первом подключении к виртуальной машине с помощью протокола удаленного рабочего стола вы получаете запрос, должен ли этот компьютер быть доступным в сети. Выберите **Да**.

1. Если вы используете один из образов виртуальных машин на основе SQL Server, удалите экземпляр SQL Server.

   1. В разделе **Программы и компоненты** правой кнопкой мыши щелкните **Microsoft SQL Server 201_ (64-разрядная версия)** и выберите **Удалить/Изменить**.
   1. Щелкните **Удалить**.
   1. Выберите экземпляр по умолчанию.
   1. Удалите все компоненты в разделе **Службы ядра СУБД**. Не удаляйте ничего в разделе **Общие компоненты**. Вы должны увидеть примерно следующее:

      ![Выбор функций](./media/failover-cluster-instance-prepare-vm/03-remove-features.png)

   1. Щелкните **Далее**, а затем **Удалить**.
   1. После успешного удаления экземпляра перезапустите виртуальную машину. 

## <a name="open-the-firewall"></a>Открытие брандмауэра 

На каждой виртуальной машине откройте TCP-порт брандмауэра Windows, который SQL Server использует. По умолчанию это порт 1433. Но вы можете изменить порт SQL Server в развертывании виртуальной машины Azure, поэтому откройте порт, который SQL Server использует в вашей среде. Этот порт автоматически открывается в SQL Server образах, развернутых из Azure Marketplace. 

Если вы используете [подсистему балансировки нагрузки](failover-cluster-instance-vnn-azure-load-balancer-configure.md), необходимо также открыть порт, используемый зондом работоспособности. По умолчанию это порт 59999. Но это может быть любой TCP-порт, указанный при создании балансировщика нагрузки. 

В этой таблице содержатся сведения о портах, которые может потребоваться открыть, в зависимости от конфигурации FCI: 

   | Назначение | Port | Примечания
   | ------ | ------ | ------
   | SQL Server | TCP 1433 | Обычный порт для экземпляров SQL Server по умолчанию. Если используется образ из коллекции, этот порт будет автоматически открыт. </br> </br> **Используется**: всеми конфигурациями FCI. |
   | Проверка работоспособности | TCP 59999 | Любой открытый TCP-порт. Настройте [проверку работоспособности](failover-cluster-instance-vnn-azure-load-balancer-configure.md#configure-health-probe) балансировщика нагрузки и кластер для использования этого порта. </br> </br> **Используется**: FCI с подсистемой балансировки нагрузки. |
   | Общая папка | UDP 445 | Порт, используемый службой файлового ресурса. </br> </br> **Используется**: FCI с общей папкой Premium. |

## <a name="join-the-domain"></a>Присоединение к домену.

Кроме того, необходимо присоединить виртуальные машины к домену. Это можно сделать с помощью [шаблона](../../../active-directory-domain-services/join-windows-vm-template.md#join-an-existing-windows-server-vm-to-a-managed-domain)быстрого запуска. 

## <a name="review-storage-configuration"></a>Проверка конфигурации хранилища

Виртуальные машины, созданные из Azure Marketplace, имеют подключенное хранилище. Если вы планируете настроить хранилище FCI с помощью файловых ресурсов уровня "Премиум" или общих дисков Azure, можно удалить подключенное хранилище, чтобы сэкономить на затратах, поскольку локальное хранилище не используется для экземпляра отказоустойчивого кластера. Однако можно использовать подключенное хранилище для Локальные дисковые пространства решений FCI, поэтому их удаление в этом случае может оказаться неполезным. Ознакомьтесь с решением хранилища FCI, чтобы определить, оптимально ли удаление подключенного хранилища для экономии затрат. 


## <a name="next-steps"></a>Следующие шаги

Теперь, когда вы подготовили среду виртуальной машины, вы можете настроить экземпляр отказоустойчивого кластера. 

Выберите один из следующих руководств, чтобы настроить среду FCI, подходящую для вашего бизнеса: 
- [Настройка FCI с общими дисками Azure](failover-cluster-instance-azure-shared-disks-manually-configure.md)
- [Настройка FCI с помощью файлового ресурса Premium](failover-cluster-instance-premium-file-share-manually-configure.md)
- [Настройка FCI с помощью Локальные дисковые пространства](failover-cluster-instance-storage-spaces-direct-manually-configure.md)

Дополнительные сведения см. в обзоре [FCI с SQL Server на виртуальных машинах Azure](failover-cluster-instance-overview.md) и [ПОДДЕРЖИВАЕМЫХ конфигурациях HADR](hadr-cluster-best-practices.md). 

Дополнительные сведения см. в следующих источниках: 
- [технологии кластера под управлением Windows](/windows-server/failover-clustering/failover-clustering-overview);   
- [Экземпляры отказоустойчивого кластера SQL Server](/sql/sql-server/failover-clusters/windows/always-on-failover-cluster-instances-sql-server)