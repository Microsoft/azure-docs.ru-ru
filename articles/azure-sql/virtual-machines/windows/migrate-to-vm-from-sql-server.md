---
title: Перенос базы данных SQL Server в экземпляр SQL Server на виртуальной машине | Документация Майкрософт
description: Узнайте, как перенести локальную пользовательскую базу данных в экземпляр SQL Server на виртуальной машине Azure.
services: virtual-machines-windows
documentationcenter: ''
author: MashaMSFT
editor: ''
tags: azure-service-management
ms.assetid: 00fd08c6-98fa-4d62-a3b8-ca20aa5246b1
ms.service: virtual-machines-sql
ms.workload: iaas-sql-server
ms.tgt_pltfrm: vm-windows-sql-server
ms.subservice: migration
ms.topic: how-to
ms.date: 08/18/2018
ms.author: mathoma
ms.reviewer: jroth
ms.openlocfilehash: f6e9009040d2d02702f8a71c352716491d07d1f7
ms.sourcegitcommit: 75041f1bce98b1d20cd93945a7b3bd875e6999d0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/22/2021
ms.locfileid: "98704310"
---
# <a name="migrate-a-sql-server-database-to-sql-server-on-an-azure-virtual-machine"></a>Перенос базы данных SQL Server в экземпляр SQL Server на виртуальной машине Azure

[!INCLUDE[appliesto-sqlvm](../../includes/appliesto-sqlvm.md)]

Существует несколько способов переноса пользовательской базы данных из локального экземпляра SQL Server в экземпляр SQL Server на виртуальной машине Azure. В этой статье будут кратко рассмотрены разные методы и рекомендованы лучшие из них для различных сценариев.


[!INCLUDE [learn-about-deployment-models](../../../../includes/learn-about-deployment-models-both-include.md)]

  > [!NOTE]
  > Приближается [срок окончания поддержки](https://www.microsoft.com/sql-server/sql-server-2008) локальных экземпляров SQL Server 2008 и SQL Server 2008 R2. Чтобы продлить поддержку, можно перенести экземпляр SQL Server на виртуальную машину Azure или приобрести Расширенные обновления безопасности, чтобы оставить этот экземпляр в локальной среде. Дополнительные сведения см. в статье о [продлении поддержки SQL Server 2008 и 2008 R2 с помощью Azure](sql-server-2008-extend-end-of-support.md).

## <a name="what-are-the-primary-migration-methods"></a>Описание основных методов миграции

Ниже перечислены основные методы миграции.

* Локальная архивация с использованием сжатия и ручное копирование файла резервной копии на виртуальную машину Azure.
* Выполните резервное копирование по URL-адресу, а затем восстановите виртуальную машину Azure по URL-адресу.
* Отключение файлов данных и журналов, их копирование в хранилище BLOB-объектов Azure с последующим подключением их к SQL Server на виртуальной машине Azure с использованием URL-адреса.
* Преобразование локального физического компьютера в VHD Hyper-V, передача VHD в хранилище BLOB-объектов Azure и последующее развертывание в виде новой виртуальной машины на базе отправленного VHD.
* Доставка жестких дисков с помощью службы импорта и экспорта Windows.
* При наличии локального развертывания группы доступности Always On с помощью [мастера добавления реплики Azure](/previous-versions/azure/virtual-machines/windows/sqlclassic/virtual-machines-windows-classic-sql-onprem-availability) можно создать реплику в Azure, выполнить отработку отказа и перенаправлять пользователей к экземпляру базы данных Azure.
* Использование [репликации транзакций](/sql/relational-databases/replication/transactional/transactional-replication) SQL Server для настройки экземпляра SQL Server Azure в качестве подписчика, отключение репликации и перенаправление пользователей к экземпляру базы данных Azure.

> [!TIP]
> Эти методы можно также использовать для перемещения баз данных между виртуальными машинами SQL Server в Azure. Например, нет поддерживаемого способа обновления версии или выпуска виртуальной машины на основе образа SQL Server из коллекции. В этом случае следует создать новую виртуальную машину SQL Server с новым выпуском или версией и использовать один из способов переноса, описанных в этой статье, чтобы переместить базы данных. 

## <a name="choose-a-migration-method"></a>Выбор метода миграции

Для повышения производительности переноса данных перенесите файлы базы данных на виртуальную машину Azure с помощью сжатого файла резервной копии.

Чтобы свести к минимуму время простоя в процессе миграции базы данных, используйте функцию AlwaysOn или репликацию транзакций.

Если использовать указанные выше методы невозможно, перенесите базу данных вручную. Как правило, следует начать с резервной копии базы данных, после нее скопировать резервную копию базы данных в Azure, а затем восстановить базу данных. Кроме того, в Azure можно скопировать сами файлы базы данных, а затем подключить их. Существует несколько методов, с помощью которых можно выполнить ручной перенос базы данных на виртуальную машину Azure.

> [!NOTE]
> При обновлении до SQL Server 2014 или SQL Server 2016 с предыдущих версий SQL Server необходимо определить, нужны ли изменения. При разработке проекта миграции рекомендуется решить вопрос со всеми зависимостями от компонентов, не поддерживаемых в новой версии SQL Server. Дополнительные сведения о поддерживаемых выпусках и сценариях см. в статье [Обновление до SQL Server](/sql/database-engine/install-windows/upgrade-sql-server).

В таблице ниже перечислены основные методы миграции и указано, в каком случае лучше всего использовать каждый из методов.

| Метод | Версия исходной базы данных | Версия базы данных назначения | Ограничение на размер файла резервной копии исходной базы данных | Примечания |
| --- | --- | --- | --- | --- |
| [Выполните локальную архивацию с помощью сжатия и вручную скопируйте файл резервной копии на виртуальную машину Azure.](#back-up-and-restore) |SQL Server 2005 или более поздней версии |SQL Server 2005 или более поздней версии |[Ограничение на размер хранилища виртуальной машины Azure](../../../index.yml) | Эта методика проста и хорошо тестируется для перемещения баз данных между компьютерами. |
| [Архивация в URL-адрес и последующее восстановление на виртуальную машину Azure с этого URL-адреса.](#backup-to-url-and-restore-from-url) |SQL Server 2012 SP1 CU2 или более поздней версии | SQL Server 2012 SP1 CU2 или более поздней версии | Менее 12,8 ТБ для SQL Server 2016, в противном случае менее 1 ТБ | Этот просто еще один способ перемещения файла резервной копии на виртуальную машину с помощью службы хранилища Azure. |
| [Отключение и копирование файлов данных и журналов в хранилище BLOB-объектов Azure с последующим подключением к SQL Server на виртуальной машине Azure с использованием URL-адреса](#detach-and-attach-from-a-url) | SQL Server 2005 или более поздней версии |SQL Server 2014 или более поздней версии | [Ограничение на размер хранилища виртуальной машины Azure](../../../index.yml) | Используйте этот метод, если необходимо [сохранить файлы с помощью службы хранилища больших двоичных объектов Azure](/sql/relational-databases/databases/sql-server-data-files-in-microsoft-azure) и подключить их к SQL Server на виртуальной машине Azure, особенно при работе с очень большими базами данных. |
| [Преобразование локального компьютера в VHD Hyper-V, отправка VHD в хранилище больших двоичных объектов Azure и последующее развертывание новой виртуальной машины на базе отправленного VHD.](#convert-to-a-vm-upload-to-a-url-and-deploy-as-a-new-vm) |SQL Server 2005 или более поздней версии |SQL Server 2005 или более поздней версии |[Ограничение на размер хранилища виртуальной машины Azure](../../../index.yml) |Используйте при переносе [собственной лицензии на SQL Server](../../../azure-sql/azure-sql-iaas-vs-paas-what-is-overview.md), при миграции базы данных, которая будет выполняться в более ранней версии SQL Server, или при совместной миграции системных и пользовательских баз данных в рамках миграции базы данных, зависящей от других пользовательских баз данных и (или) системных баз данных. |
| [Доставка жестких дисков в службу импорта и экспорта Windows.](#ship-a-hard-drive) |SQL Server 2005 или более поздней версии |SQL Server 2005 или более поздней версии |[Ограничение на размер хранилища виртуальной машины Azure](../../../index.yml) |Следует использовать [службу импорта и экспорта Windows](../../../import-export/storage-import-export-service.md) , когда на ручное копирование требуется слишком много времени, особенно при работе с базами данных очень большого размера. |
| [Использование мастера добавления реплики Azure](/previous-versions/azure/virtual-machines/windows/sqlclassic/virtual-machines-windows-classic-sql-onprem-availability) |SQL Server 2012 или более поздней версии |SQL Server 2012 или более поздней версии |[Ограничение на размер хранилища виртуальной машины Azure](../../../index.yml) |Сокращает время простоя, используется при наличии локального развертывания AlwaysOn. |
| [Использование репликации транзакций SQL Server](/sql/relational-databases/replication/transactional/transactional-replication) |SQL Server 2005 или более поздней версии |SQL Server 2005 или более поздней версии |[Ограничение на размер хранилища виртуальной машины Azure](../../../index.yml) |Используйте, когда необходимо сократить время простоя и не иметь Always On локального развертывания. |

## <a name="back-up-and-restore"></a>Резервное копирование и восстановление

Создайте резервную копию базы данных с использованием сжатия, скопируйте ее на виртуальную машину, а затем восстановите базу данных. Если размер файла резервной копии превышает 1 ТБ, необходимо создать чередующийся набор, так как максимальный размер диска виртуальной машины — 1 ТБ. Для миграции пользовательской базы данных с помощью этого ручного метода выполните указанные ниже общие действия.

1. Создайте полную резервную копию базы данных в локальном расположении.
2. Создайте или отправьте виртуальную машину с требуемой версией SQL Server.
3. Настройте подключения в соответствии со своими требованиями. Ознакомьтесь с разделом [Подключение к виртуальной машине SQL Server в Azure (диспетчер ресурсов)](ways-to-connect-to-sql.md).
4. Скопируйте файлы резервных копий на виртуальную машину с помощью удаленного рабочего стола, проводника Windows или команды копирования из командной строки.

## <a name="backup-to-url-and-restore-from-url"></a>Резервное копирование на URL-адрес и восстановление из URL-адреса

Вместо резервного копирования в локальный файл можно использовать [резервное копирование на URL-адрес](/sql/relational-databases/backup-restore/sql-server-backup-to-url) , а затем восстановить его с URL-адреса на виртуальную машину. SQL Server 2016 поддерживает чередующиеся резервные наборы данных. Они рекомендуются для повышения производительности и необходимы для превышения ограничений на размер для BLOB-объекта. Для очень больших баз данных рекомендуется использовать [службу импорта и экспорта Windows](../../../import-export/storage-import-export-service.md).

## <a name="detach-and-attach-from-a-url"></a>Отключение и подключение с использованием URL-адреса

Отключите базу данных и файлы журнала и передайте их в [хранилище BLOB-объектов Azure](/sql/relational-databases/databases/sql-server-data-files-in-microsoft-azure). Затем подключите к виртуальной машине Azure базу данных по URL-адресу. Используйте этот метод, если требуется, чтобы файлы физической базы данных находились в хранилище BLOB-объектов, что может оказаться полезным для очень больших баз данных. Для миграции пользовательской базы данных с помощью этого ручного метода выполните указанные ниже общие действия.

1. Отключите файлы базы данных от локального экземпляра базы данных.
2. Скопируйте отключенные файлы базы данных в хранилище BLOB-объектов Azure с помощью [служебной программы командной строки AZCopy](../../../storage/common/storage-use-azcopy-v10.md).
3. Подключите файлы базы данных из URL-адреса Azure к экземпляру SQL Server в виртуальной машине Azure.

## <a name="convert-to-a-vm-upload-to-a-url-and-deploy-as-a-new-vm"></a>Преобразование в виртуальную машину, отправка по URL-адресу и развертывание в качестве новой виртуальной машины

Этот метод используется для переноса всех системных и пользовательских баз данных из локального экземпляра SQL Server на виртуальную машину Azure. Для переноса всего экземпляра SQL Server с помощью этого ручного метода выполните указанные ниже действия.

1. Преобразуйте физические компьютеры или виртуальные машины в виртуальные жесткие диски Hyper-V.
2. Отправьте VHD-файлы в службу хранилища Azure с помощью [командлета Add-AzureVHD](/previous-versions/azure/dn495173(v=azure.100)).
3. Разверните новую виртуальную машину на базе отправленного VHD-файла.

> [!NOTE]
> Чтобы перенести приложение целиком, можно воспользоваться [Azure Site Recovery](../../../site-recovery/site-recovery-overview.md).

## <a name="ship-a-hard-drive"></a>Отправка жестких дисков

Для передачи больших объемов данных в хранилище больших двоичных объектов Azure в ситуациях, когда отправка этих данных по сети чрезвычайно дорога или невыполнима, можно использовать [службу импорта и экспорта Windows](../../../import-export/storage-import-export-service.md) . При использовании этой службы можно отправить один или несколько жестких дисков с данными в центр обработки данных Azure, где данные будут перемещены в вашу учетную запись хранения.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения см. в статье [Обзор SQL Server на виртуальных машинах Azure](sql-server-on-azure-vm-iaas-what-is-overview.md).

> [!TIP]
> Если у вас есть вопросы по виртуальным машинам SQL Server, см. раздел [часто задаваемых вопросов](frequently-asked-questions-faq.md).

Инструкции по созданию экземпляра SQL Server на виртуальной машине Azure из записанного образа см. в [рекомендациях по клонированию виртуальных машин Azure SQL из записанных образов](/archive/blogs/psssql/tips-tricks-on-cloning-azure-sql-virtual-machines-from-captured-images) в блоге разработчиков CSS SQL Server.