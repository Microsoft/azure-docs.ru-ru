---
title: Правила преобразования и экранирования JSON в Azure Time Series Insights Gen2 | Документация Майкрософт
description: Сведения об обучении JSON, экранировании и обработке массивов в службе "аналитика временных рядов Azure" Gen2.
author: lyrana
ms.author: lyhughes
manager: deepakpalled
ms.workload: big-data
ms.service: time-series-insights
services: time-series-insights
ms.topic: conceptual
ms.date: 01/21/2021
ms.openlocfilehash: 9f768982e69f785c146f026040a91f7a63eef64c
ms.sourcegitcommit: b39cf769ce8e2eb7ea74cfdac6759a17a048b331
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/22/2021
ms.locfileid: "98673457"
---
# <a name="json-flattening-escaping-and-array-handling"></a>Преобразование JSON в плоскую структуру, экранирование и обработка массивов

Среда Gen2 "аналитика временных рядов Azure" динамически создает столбцы теплого и холодного магазинов, следуя определенному набору соглашений об именовании. При приеме события к полезной нагрузке JSON и именам свойств применяется набор правил. Они включают в себя экранирование определенных специальных символов и сведение вложенных объектов JSON. Важно знать эти правила, чтобы понять, как форма JSON будет влиять на хранение и запрос событий. Полный список правил см. в таблице ниже. Примеры A & б также демонстрируют, как можно эффективно выполнять пакетную обработку нескольких временных рядов в массиве.

> [!IMPORTANT]
>
> * Ознакомьтесь с правилами, приведенными ниже, прежде чем выбирать [свойство идентификатора временного ряда](./how-to-select-tsid.md) и [(или) соответствующую отметку времени](concepts-streaming-ingestion-event-sources.md#event-source-timestamp)источника события. Если идентификатор или метка времени TS находится внутри вложенного объекта или содержит один или несколько специальных символов, то важно убедиться, что указанное имя свойства совпадает с именем столбца *после* применения правил приема. См. пример [б](concepts-json-flattening-escaping-rules.md#example-b) ниже.

| Правило | Пример JSON | [Синтаксис выражений временных рядов](/rest/api/time-series-insights/reference-time-series-expression-syntax) | Имя столбца свойств в Parquet
|---|---|---|---|
| Тип данных Gen2 "аналитика временных рядов Azure" добавляется в конец имени столбца как "_ \<dataType\> " | ```"type": "Accumulated Heat"``` | `$event.type.String` |`type_string` |
| [Свойство timestamp](concepts-streaming-ingestion-event-sources.md#event-source-timestamp) источника события будет сохранено в службе "аналитика временных рядов Azure" Gen2 как "timestamp" в хранилище, и значение, хранящееся в формате UTC. Вы можете настроить свойство отметок времени источника событий в соответствии с потребностями вашего решения, но имя столбца в «теплый» и «холодном» хранилище — «timestamp». Другие свойства DateTime JSON, не являющиеся отметкой времени источника события, будут сохранены с "_datetime" в имени столбца, как упоминалось в приведенном выше правиле.  | ```"ts": "2020-03-19 14:40:38.318"``` |  `$event.$ts` | `timestamp` |
| Имена свойств JSON, которые содержат специальные символы. символы [\ и "экранированы с помощью [" и "]  |  ```"id.wasp": "6A3090FD337DE6B"``` |  `$event['id.wasp'].String` | `['id.wasp']_string` |
| В пределах ["и"] есть дополнительные Escape, заключенные в одинарные и обратные кавычки. Одинарная кавычка будет записана как \ ", а обратная косая черта будет записана как \\\ | ```"Foo's Law Value": "17.139999389648"``` | `$event['Foo\'s Law Value'].Double` | `['Foo\'s Law Value']_double` |
| Вложенные объекты JSON обравниваются с точкой в виде разделителя. Поддерживается вложение до 10 уровней. |  ```"series": {"value" : 316 }``` | `$event.series.value.Long`, `$event['series']['value'].Long` или `$event.series['value'].Long` |  `series.value_long` |
| Массивы типов-примитивов хранятся в виде динамического типа |  ```"values": [154, 149, 147]``` | Динамические типы могут быть получены только через API-интерфейсы [событий](/rest/api/time-series-insights/dataaccessgen2/query/execute#getevents) . | `values_dynamic` |
| Массивы, содержащие объекты, имеют два поведения в зависимости от содержимого объекта: Если ИДЕНТИФИКАТОРы служб терминалов или свойства отметки времени (ий) находятся внутри объектов в массиве, массив будет недоступен таким образом, что первоначальная полезная нагрузка JSON создает несколько событий. Это позволяет пакетировать несколько событий в одну структуру JSON. Все свойства верхнего уровня, являющиеся одноранговыми для массива, будут сохранены с каждым невыполненным объектом. Если ИДЕНТИФИКАТОРы служб терминалов и отметка времени находятся за *пределами* массива, они будут сохранены в целом как динамические типы. | См. примеры [A](concepts-json-flattening-escaping-rules.md#example-a), [B](concepts-json-flattening-escaping-rules.md#example-b)и [C](concepts-json-flattening-escaping-rules.md#example-c) ниже.
| Массивы, содержащие смешанные элементы, не являются плоскими. |  ```"values": ["foo", {"bar" : 149}, 147]``` | Динамические типы могут быть получены только через API-интерфейсы [событий](/rest/api/time-series-insights/dataaccessgen2/query/execute#getevents) . | `values_dynamic` |
| 512 символов — это ограничение имени свойства JSON. Если имя превышает 512 символов, оно усекается до 512 и добавляется символ "_<" хэш-код ">". **Обратите внимание** , что это также относится к именам свойств, которые были объединены из объекта, обозначая путь к вложенному объекту. |``"data.items.datapoints.values.telemetry<...continuing to over 512 chars>" : 12.3440495`` |`"$event.data.items.datapoints.values.telemetry<...continuing to include all chars>.Double"` | `data.items.datapoints.values.telemetry<...continuing to 512 chars>_912ec803b2ce49e4a541068d495ab570_double` |

## <a name="understanding-the-dual-behavior-for-arrays"></a>Основные сведения о двойном поведении массивов

Массивы объектов либо хранятся целиком, либо разбиваются на несколько событий в зависимости от модели моделирования данных. Это позволяет использовать массив для пакетных событий и избегать повторяющихся свойств телеметрии, определенных на уровне корневого объекта. Пакетная обработка может быть полезна, так как в результате отправляется меньшее число концентраторов событий или сообщений центра Интернета вещей.

Однако в некоторых случаях массивы, содержащие объекты, имеют смысл только в контексте других значений. Создание нескольких событий приведет к небессмысленному отображению данных. Чтобы гарантировать, что массив объектов хранится как динамический тип, следуйте указаниям в руководстве по моделированию данных, приведенным ниже, а затем рассмотрим [пример в C](concepts-json-flattening-escaping-rules.md#example-c) .

### <a name="how-to-know-if-my-array-of-objects-will-produce-multiple-events"></a>Как убедиться, что мой массив объектов будет создавать несколько событий

Если один или несколько соответствующих ИДЕНТИФИКАТОРов временных рядов (ий) вложены в объекты в массиве *или* если свойство timestamp источника события является вложенным, подсистема приема разделит его для создания нескольких событий. Имена свойств, которые вы указали для ИДЕНТИФИКАТОРов служб терминалов и (или) отметок времени, должны соответствовать правилам обработки данных, приведенным выше, и поэтому будут указывать форму JSON. См. примеры ниже и ознакомьтесь с руководством по [выбранию свойства идентификатора временного ряда.](./how-to-select-tsid.md)

### <a name="example-a"></a>Пример A

Идентификатор временных рядов в корне объекта и timestamp Nested \
**Идентификатор временного ряда среды:**`"id"`\
**Отметка времени источника события:**`"values.time"`\
**Полезные данные JSON:**

```JSON
[
    {
        "id": "caaae533-1d6c-4f58-9b75-da102bcc2c8c",
        "values": [
            {
                "time": "2020-05-01T00:59:59.000Z",
                "value": 25.6073
            },
            {
                "time": "2020-05-01T01:00:29.000Z",
                "value": 43.9077
            }
        ]
    },
    {
        "id": "1ac87b74-0865-4a07-b512-56602a3a576f",
        "values": [
            {
                "time": "2020-05-01T00:59:59.000Z",
                "value": 0.337288
            },
            {
                "time": "2020-05-01T01:00:29.000Z",
                "value": 4.76562
            }
        ]
    }
]
```

**Результат в файле Parquet:**\
Приведенная выше конфигурация и полезные данные создадут три столбца и четыре события.

| TIMESTAMP  | id_string | values.value_double
| ---- | ---- | ---- |
| `2020-05-01T00:59:59.000Z` | `caaae533-1d6c-4f58-9b75-da102bcc2c8c`| ``25.6073`` |
| `2020-05-01T01:00:29.000Z` |`caaae533-1d6c-4f58-9b75-da102bcc2c8c` | ``43.9077`` |
| `2020-05-01T00:59:59.000Z` | `1ac87b74-0865-4a07-b512-56602a3a576f` | ``0.337288`` |
| `2020-05-01T01:00:29.000Z` | `1ac87b74-0865-4a07-b512-56602a3a576f` | ``4.76562`` |

### <a name="example-b"></a>Пример Б

ИДЕНТИФИКАТОР составного временного ряда с одним свойством Nested \
**Идентификатор временного ряда среды:** `"plantId"` перетаскивани `"telemetry.tagId"`\
**Отметка времени источника события:**`"timestamp"`\
**Полезные данные JSON:**

```JSON
[
    {
        "plantId": "9336971",
        "timestamp": "2020-01-22T16:38:09Z",
        "telemetry": [
            {
                "tagId": "100231-A-A6",
                "tagValue": -31.149018
            },
            {
                "tagId": "100231-A-A1",
                "tagValue": 20.560796
            },
            {
                "tagId": "100231-A-A9",
                "tagValue": 177
            },
            {
                "tagId": "100231-A-A8",
                "tagValue": 420
            },
        ]
    },
    {
        "plantId": "9336971",
        "timestamp": "2020-01-22T16:42:14Z",
        "telemetry": [
            {
                "tagId": "103585-A-A7",
                "value": -30.9918
            },
            {
                "tagId": "103585-A-A4",
                "value": 19.960796
            }
        ]
    }
]
```

**Результат в файле Parquet:**\
Приведенная выше конфигурация и полезные данные создадут четыре столбца и шесть событий.

| TIMESTAMP  | plantId_string | telemetry.tagId_string | telemetry.value_double
| ---- | ---- | ---- | ---- |
| `2020-01-22T16:38:09Z` | `9336971`| ``100231-A-A6`` |  — 31,149018 |
| `2020-01-22T16:38:09Z` |`9336971` | ``100231-A-A1`` | 20,560796 |
| `2020-01-22T16:38:09Z` | `9336971` | ``100231-A-A9`` | 177 |
| `2020-01-22T16:38:09Z` | `9336971` | ``100231-A-A8`` | 420 |
| `2020-01-22T16:42:14Z` | `9336971` | ``100231-A-A7`` | — 30,9918 |  
| `2020-01-22T16:42:14Z` | `9336971` | ``100231-A-A4`` | 19,960796 |

### <a name="example-c"></a>Пример В

Идентификатор временных рядов и отметка времени находятся в корне объекта \
**Идентификатор временного ряда среды:**`"id"`\
**Отметка времени источника события:**`"timestamp"`\
**Полезные данные JSON:**

```JSON
{
    "id": "800500054755",
    "timestamp": "2020-11-01T10:00:00.000Z",
    "datapoints": [{
            "value": 120
        },
        {
            "value": 124
        }
    ]
}
```

**Результат в файле Parquet:**\
Приведенная выше конфигурация и полезные данные создадут три столбца и одно событие.

| TIMESTAMP  | id_string | datapoints_dynamic  
| ---- | ---- | ---- |
| `2020-11-01T10:00:00.000Z` | `800500054755`| ``[{"value": 120},{"value":124}]`` |

## <a name="next-steps"></a>Следующие шаги

* Общие сведения об [ограничениях пропускной способности](./concepts-streaming-ingress-throughput-limits.md) среды
