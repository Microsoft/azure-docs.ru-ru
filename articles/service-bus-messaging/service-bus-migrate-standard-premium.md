---
title: Перенос пространств имен служебной шины Azure с уровня "Стандартный" на "Премиум"
description: Инструкции по разрешению переноса существующих стандартных пространств имен служебной шины Azure в Premium
ms.topic: article
ms.date: 06/23/2020
ms.openlocfilehash: 1ed09a077f086390c658e6650171c552b361008d
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "85340741"
---
# <a name="migrate-existing-azure-service-bus-standard-namespaces-to-the-premium-tier"></a>Перенос существующих стандартных пространств имен служебной шины Azure на уровень "Премиум"

Ранее пространства имен, предлагаемые служебной шиной Azure, предоставляются только на уровне "Стандартный". Пространства имен — это многоклиентские настройки, оптимизированные для небольших пропускной способности и сред разработки. Уровень "Премиум" предлагает выделенные ресурсы на пространство имен для прогнозируемой задержки и увеличения пропускной способности по фиксированной цене. Уровень "Премиум" оптимизирован для высокой пропускной способности и рабочих сред, требующих дополнительных корпоративных функций.

В этой статье описывается, как перенести существующие пространства имен уровня "Стандартный" на уровень "Премиум".  

>[!WARNING]
> Миграция предназначена для обновления стандартных пространств имен служебной шины до уровня Premium. Средство миграции не поддерживает переход на использование более ранней версии.

Обратите внимание на некоторые моменты.

- Такая миграция предполагается на месте, что означает, что существующие приложения отправителя и получателя **не нуждаются в каких-либо изменениях в коде или конфигурации**. Существующая строка подключения будет автоматически указывать на новое пространство имен Premium.
- Для успешности миграции пространство имен **Premium** не должно иметь **сущностей** .
- Все **сущности** в стандартном пространстве имен **копируются** в пространство имен уровня "Премиум" во время процесса миграции.
- Миграция поддерживает **1 000 сущностей на единицу обмена сообщениями** на уровне Premium. Чтобы узнать, сколько единиц обмена сообщениями требуется, начните с количества сущностей, имеющихся в текущем стандартном пространстве имен.
- Вы не можете напрямую перейти с уровня " **базовый** " на **уровень "Премиум**", но это можно сделать косвенным образом, переполнив переход с базовых на стандартные, а затем от уровня "Стандартный" к "Премиум" на следующем шаге.

## <a name="migration-steps"></a>Этапы миграции

Некоторые условия связаны с процессом миграции. Ознакомьтесь со следующими шагами, чтобы снизить вероятность ошибок. Эти шаги описывают процесс миграции и пошаговые инструкции перечислены в следующих разделах.

1. Создайте новое пространство имен уровня "Премиум".
1. Свяжите пространства имен Standard и Premium друг с другом.
1. Синхронизация (поверх) сущностей из стандарта в пространство имен Premium.
1. Зафиксируйте миграцию.
1. Очистка сущностей в пространстве имен Standard с помощью имени пространства имен, выполняемого после миграции.
1. Удалите стандартное пространство имен.

>[!IMPORTANT]
> После фиксации миграции получите доступ к старому стандартному пространству имен и остановите очереди и подписки. После очистки сообщений они могут быть отправлены в новое пространство имен уровня "Премиум" для обработки приложениями получателя. После очистки очередей и подписок рекомендуется удалить старое стандартное пространство имен.

### <a name="migrate-by-using-the-azure-cli-or-powershell"></a>Миграция с помощью Azure CLI или PowerShell

Чтобы перенести стандартное пространство имен служебной шины в Premium с помощью средства Azure CLI или PowerShell, выполните следующие действия.

1. Создайте новое пространство имен Service Bus Premium. Вы можете ссылаться на [шаблоны Azure Resource Manager](service-bus-resource-manager-namespace.md) или [использовать портал Azure](service-bus-create-namespace-portal.md). Не забудьте выбрать **Premium** для параметра **сервицебусску** .

1. Задайте следующие переменные среды, чтобы упростить команды миграции.

   ```
   resourceGroup = <resource group for the standard namespace>
   standardNamespace = <standard namespace to migrate>
   premiumNamespaceArmId = <Azure Resource Manager ID of the premium namespace to migrate to>
   postMigrationDnsName = <post migration DNS name entry to access the standard namespace>
   ```

    >[!IMPORTANT]
    > Псевдоним и имя после миграции (post_migration_dns_name) будут использоваться для доступа к старому стандартному пространству имен после миграции. Используйте этот параметр для очистки очередей и подписок, а затем удалите пространство имен.

1. Свяжите пространства имен Standard и Premium и запустите синхронизацию с помощью следующей команды:

    ```azurecli-interactive
    az servicebus migration start --resource-group $resourceGroup --name $standardNamespace --target-namespace $premiumNamespaceArmId --post-migration-name $postMigrationDnsName
    ```

1. Проверьте состояние миграции с помощью следующей команды:

    ```azurecli-interactive
    az servicebus migration show --resource-group $resourceGroup --name $standardNamespace
    ```

    Миграция считается завершенной, если отображаются следующие значения:

    * Мигратионстате = "Active"
    * Пендингрепликатионсоператионскаунт = 0
    * provisioningState = "успех"

    Эта команда также отображает конфигурацию миграции. Убедитесь, что значения заданы правильно. Также проверьте пространство имен Premium на портале, чтобы убедиться в том, что все очереди и разделы созданы, и что они совпадают с тем, что существовало в пространстве имен уровня "Стандартный".

1. Зафиксируйте миграцию, выполнив следующую команду:

   ```azurecli-interactive
   az servicebus migration complete --resource-group $resourceGroup --name $standardNamespace
   ```

### <a name="migrate-by-using-the-azure-portal"></a>Миграция с помощью портал Azure

Миграция с использованием портал Azure имеет тот же логический поток, что и миграция с помощью команд. Выполните следующие действия, чтобы выполнить миграцию с помощью портал Azure.

1. В меню **навигации** в левой области выберите **перенести в Premium**. Нажмите кнопку " **Начало работы** ", чтобы перейти на следующую страницу.
    ![Целевая страница миграции][]

1. Завершите **установку**.
   ![Пространство имен установки][]
   1. Создайте и назначьте пространство имен Premium, чтобы перенести существующее стандартное пространство имен в.
        ![Пространство имен установки — создание пространства имен уровня "Премиум"][]
   1. Выберите **имя после миграции**. Это имя будет использоваться для доступа к стандартному пространству имен после завершения миграции.
        ![Настройка пространства имен — выбор после переноса имени][]
   1. Нажмите кнопку **"Далее"** , чтобы продолжить.
1. Синхронизация сущностей между пространствами имен Standard и Premium.
    ![Пространство имен установки — синхронизация сущностей — запуск][]

   1. Нажмите кнопку **начать синхронизацию** , чтобы начать синхронизацию сущностей.
   1. Нажмите кнопку **Да** в диалоговом окне, чтобы подтвердить и запустить синхронизацию.
   1. Дождитесь завершения синхронизации. Состояние доступно в строке состояния.
        ![Пространство имен установки — синхронизация сущностей — ход выполнения][]
        >[!IMPORTANT]
        > Если вам нужно прервать перенос по какой бы то ни было причине, проверьте поток прерывания в разделе часто задаваемых вопросов этого документа.
   1. После завершения синхронизации нажмите кнопку **Далее** в нижней части страницы.

1. Проверьте изменения на странице Сводка. Выберите **завершить миграцию** , чтобы переключить пространства имен и завершить миграцию.
    ![Переключение пространства имен в меню коммутатора][]  
    После завершения миграции появится страница подтверждения.
    ![Переключение пространства имен — успешное завершение][]

## <a name="caveats"></a>Предупреждения

Некоторые функции, предоставляемые стандартным уровнем служебной шины Azure, не поддерживаются на уровне Premium служебной шины Azure. Они предназначены для разработки, так как уровень Premium предлагает выделенные ресурсы для прогнозируемой пропускной способности и задержки.

Ниже приведен список функций, не поддерживаемых Premium, и их устранение.

### <a name="express-entities"></a>Экспресс-сущности

   В версии Premium не поддерживаются сущности Express, которые не записывают данные сообщений в хранилище. Выделенные ресурсы обеспечивают значительное улучшение пропускной способности и гарантируют сохранение данных, как ожидается в любой системе обмена сообщениями предприятия.

   Во время миграции любые сущности Express в пространстве имен уровня "Премиум" будут созданы в пространстве имен Premium как сущность, не относящаяся к Express.

   Если используются шаблоны Azure Resource Manager (ARM), убедитесь, что вы удалили флаг "enableExpress" из конфигурации развертывания, чтобы автоматические рабочие процессы выполнялись без ошибок.

### <a name="partitioned-entities"></a>Секционированные сущности

   Секционированные сущности поддерживались на уровне Standard, чтобы обеспечить лучшую доступность при настройке нескольких клиентов. Предоставление выделенных ресурсов, доступных для каждого пространства имен на уровне Premium, больше не требуется.

   Во время миграции любая секционированная сущность в стандартном пространстве имен создается в пространстве имен уровня "Премиум" как несекционированная сущность.

   Если шаблон ARM устанавливает для "enablePartitioning" значение "true" для определенной очереди или раздела, он будет проигнорирован брокером.

## <a name="faqs"></a>Часто задаваемые вопросы

### <a name="what-happens-when-the-migration-is-committed"></a>Что происходит при фиксации миграции?

После фиксации миграции строка подключения, указывающая на стандартное пространство имен, будет указывать на пространство имен Premium.

Приложения отправителя и получателя будут отключены от стандартного пространства имен и автоматически подключаться к пространству имен Premium.

### <a name="what-do-i-do-after-the-standard-to-premium-migration-is-complete"></a>Что делать после завершения миграции уровня "Стандартный" до уровня "Премиум"?

Уровень "Стандартный" для миграции гарантирует, что метаданные сущности, такие как разделы, подписки и фильтры, копируются из стандартного пространства имен в пространство имен Premium. Данные сообщений, зафиксированные в стандартном пространстве имен, не копируются из стандартного пространства имен в пространство имен уровня "Премиум".

Стандартное пространство имен может содержать сообщения, которые были отправлены и зафиксированы во время миграции. Вручную проостановите эти сообщения из стандартного пространства имен и вручную отправьте их в пространство имен уровня "Премиум". Чтобы вручную очистить сообщения, используйте консольное приложение или сценарий для очистки сущностей стандартных пространств имен, используя DNS-имя после миграции, указанное в командах миграции. Отправьте эти сообщения в пространство имен Premium, чтобы они могли обрабатываться получателями.

После очистки сообщений удалите стандартное пространство имен.

>[!IMPORTANT]
> После очистки сообщений из стандартного пространства имен удалите стандартное пространство имен. Это важно, так как строка подключения, которая изначально называлась стандартным пространством имен, теперь ссылается на пространство имен уровня "Премиум". Стандартное пространство имен больше не потребуется. Удаление стандартного пространства имен, которое вы перенесли, помогает сократить путаницу.

### <a name="how-much-downtime-do-i-expect"></a>Сколько времени простоя я хотел?

Процесс миграции предназначен для уменьшения ожидаемого времени простоя приложений. Время простоя сокращается с помощью строки подключения, которую приложения-отправитель и получатель используют для указания на новое пространство имен Premium.

Время простоя, которое использует приложение, ограничено временем обновления записи DNS для указания на пространство имен Premium. Время простоя составляет примерно 5 минут.

### <a name="do-i-have-to-make-any-configuration-changes-while-doing-the-migration"></a>Нужно ли вносить изменения в конфигурацию во время миграции?

Нет, нет необходимости вносить изменения в код или конфигурацию для миграции. Строка подключения, используемая приложениями-отправителем и получателем для доступа к стандартному пространству имен, автоматически сопоставляется с действием псевдонима пространства имен Premium.

### <a name="what-happens-when-i-abort-the-migration"></a>Что происходит при прерывании миграции?

Миграцию можно прервать либо с помощью команды, `Abort` либо с помощью портал Azure.

#### <a name="azure-cli"></a>Azure CLI

```azurecli-interactive
az servicebus migration abort --resource-group $resourceGroup --name $standardNamespace
```

#### <a name="azure-portal"></a>Портал Azure

![Прервать синхронизацию потока прерывание ][]
 ![ прервано — прерывание завершено][]

Когда процесс миграции прерывается, процесс копирования сущностей (разделов, подписок и фильтров) из стандарта в пространство имен уровня "Премиум" и разбиение на них прекращается.

Строка подключения не обновляется, чтобы указывать на пространство имен Premium. Существующие приложения продолжают работать, как и до начала миграции.

Однако они не удаляют сущности в пространстве имен Premium или не удаляют пространство имен Premium. Удалите сущности вручную, если вы решили не перемещаться вперед с миграцией.

>[!IMPORTANT]
> Если вы решили прервать миграцию, удалите пространство имен Premium, которое было подготовлено для миграции, чтобы не оплатить ресурсы.

#### <a name="i-dont-want-to-have-to-drain-the-messages-what-do-i-do"></a>Я не хочу выполнять сток сообщений. Что делать?

Могут существовать сообщения, которые отправляются приложениями отправителя и фиксируются в хранилище в стандартном пространстве имен во время миграции и непосредственно перед фиксацией миграции.

Во время миграции фактические данные и полезные данных сообщения не копируются из стандарта в пространство имен уровня "Премиум". Сообщения необходимо вручную прерядиться, а затем отправлять в пространство имен уровня "Премиум".

Однако если вы можете выполнить миграцию во время планового периода обслуживания или настройки и вы не хотите вручную выполнять сток и отсылать сообщения, выполните следующие действия.

1. Останавливает приложения отправителя. Приложения получателя будут обрабатывать сообщения, которые в настоящее время находятся в стандартном пространстве имен, и будут прерядиться в очередь.
1. После пустых очередей и подписок в пространстве имен Standard выполните процедуру, описанную выше, чтобы выполнить миграцию из стандарта в пространство имен Premium.
1. После завершения миграции можно перезапустить приложения отправителя.
1. Отправители и получатели теперь будут автоматически подключаться к пространству имен уровня "Премиум".

    >[!NOTE]
    > Для миграции не нужно прекращать работу приложений получателя.
    >
    > После завершения миграции приложения-получатели будут отключены от стандартного пространства имен и автоматически подключаться к пространству имен уровня "Премиум".

## <a name="next-steps"></a>Дальнейшие действия

* Узнайте больше о [различиях в обмене сообщениями](./service-bus-premium-messaging.md)уровня "Стандартный" и "Премиум".
* Узнайте о [высоком уровне доступности и Geo-Disaster аспектах восстановления для служебной шины Premium](service-bus-outages-disasters.md#protecting-against-outages-and-disasters---service-bus-premium).

[Целевая страница миграции]: ./media/service-bus-standard-premium-migration/1.png
[Пространство имен установки]: ./media/service-bus-standard-premium-migration/2.png
[Пространство имен установки — создание пространства имен уровня "Премиум"]: ./media/service-bus-standard-premium-migration/3.png
[Настройка пространства имен — выбор после переноса имени]: ./media/service-bus-standard-premium-migration/4.png
[Пространство имен установки — синхронизация сущностей — запуск]: ./media/service-bus-standard-premium-migration/5.png
[Пространство имен установки — синхронизация сущностей — ход выполнения]: ./media/service-bus-standard-premium-migration/8.png
[Переключение пространства имен в меню коммутатора]: ./media/service-bus-standard-premium-migration/9.png
[Переключение пространства имен — успешное завершение]: ./media/service-bus-standard-premium-migration/12.png

[Прервать поток — синхронизировать синхронизацию]: ./media/service-bus-standard-premium-migration/abort1.png
[Прерывание потока прервано завершено]: ./media/service-bus-standard-premium-migration/abort3.png
