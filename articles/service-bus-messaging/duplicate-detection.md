---
title: Поиск повторяющихся сообщений служебной шины Azure | Документация Майкрософт
description: В этой статье объясняется, как можно обнаружить дубликаты в сообщениях служебной шины Azure. Повторяющееся сообщение можно пропустить и удалить.
ms.topic: article
ms.date: 01/13/2021
ms.openlocfilehash: 527c2dea34b02733907372b6e75a40a5ef5fc289
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "101711932"
---
# <a name="duplicate-detection"></a>Обнаружение дубликатов

Если в приложении возникает неустранимая ошибка сразу после отправки сообщения, из-за чего перезапущенный экземпляр приложения ошибочно полагает, что доставка предыдущего сообщения не выполнена, то последующая его отправка приводит к тому, что сообщение отображается в системе дважды.

Кроме того, может произойти ошибка на уровне клиента или сети в течение некоторого времени, а отправка сообщения зафиксирована в очередь с подтверждением, которое не удалось вернуть клиенту. В этом сценарии клиенту не известен однозначный результат операции отправки.

Поиск повторяющихся сообщений устраняет эту неизвестность, позволяя отправителю повторно отправить то же самое сообщение, после чего очередь или раздел отклонит его дубликаты.

> [!NOTE]
> Базовый уровень служебной шины не поддерживает обнаружение повторяющихся данных. Уровни "Стандартный" и "Премиум" поддерживают обнаружение дубликатов. Различия между этими ценовыми категориями приведены на странице [цен на Служебную шину](https://azure.microsoft.com/pricing/details/service-bus/).

## <a name="how-it-works"></a>Принципы работы. 
Включение поиска повторяющихся сообщений помогает отслеживать управляемое приложением значение *MessageId* всех сообщений, отправленных в очередь или раздел в течение указанного интервала времени. Если отправляется какое-либо новое сообщение со значением *MessageId*, которое уже занесено в журнал за текущий период времени, то сообщается, что сообщение принято (операция отправки завершена успешно), а вновь отправленное сообщение мгновенно пропускается и удаляется. Другие части сообщения, кроме значения *MessageId*, не учитываются.

Управления приложением идентификатора очень важно, так как только это позволяет приложению связать *MessageId* с контекстом бизнес-процесса, из которого его можно прогнозируемым образом восстановить в случае сбоя.

Для бизнес-процесса, в котором сообщения отправляются при обработке какого-либо контекста приложения, значение *MessageId* может быть частью идентификатора контекста уровня приложения, например номера заказа на покупку, и темы сообщения, например **12345.2017/payment**.

Идентификатор *MessageId* всегда может быть идентификатором GUID, но привязка идентификатора к бизнес-процессу дает предсказуемую повторяемость, что необходимо для эффективного использования функции обнаружения дубликатов.

> [!IMPORTANT]
>- Если **секционирование** **включено**, `MessageId+PartitionKey` используется для определения уникальности. Если сеансы включены, ключ секции и идентификатор сеанса должны быть одинаковыми. 
>- Если **секционирование** **отключено** (по умолчанию), `MessageId` используется только для определения уникальности.
>- Сведения о SessionId, PartitionKey и MessageId см. в разделе [Использование ключей секций](service-bus-partitioning.md#use-of-partition-keys).
>- [Уровень Premier](service-bus-premium-messaging.md) не поддерживает секционирование, поэтому рекомендуется использовать уникальные идентификаторы сообщений в приложениях и не полагаться на ключи разделов для обнаружения дубликатов. 


## <a name="enable-duplicate-detection"></a>Включение поиска повторяющихся сообщений

На портале эта функция включается во время создания сущности с помощью флажка **Включить обнаружение повторений**, который снят по умолчанию. Аналогичный параметр доступен при создании разделов.

![Снимок экрана: диалоговое окно "Создание очереди" с выбранным параметром "включить обнаружение дубликатов", выделенным красным цветом.][1]

> [!IMPORTANT]
> Вы не можете включить и отключить обнаружение дубликатов после создания очереди. Вы можете сделать это только во время создания очереди. 

Можно программно установить флаг с помощью свойства [QueueDescription.requiresDuplicateDetection](/dotnet/api/microsoft.servicebus.messaging.queuedescription.requiresduplicatedetection#Microsoft_ServiceBus_Messaging_QueueDescription_RequiresDuplicateDetection), воспользовавшись API полнофункциональной платформы .NET Framework. При использовании API Azure Resource Manager это значение задается с помощью свойства [queueProperties.requiresDuplicateDetection](/azure/templates/microsoft.servicebus/namespaces/queues#property-values).

По умолчанию в журнале времени обнаружения дубликатов для очередей и разделов используется значение 10 минут, минимальное из которых — от 20 секунд до максимального значения 7 дней. Можно изменить этот параметр в окне свойств очереди или раздела на портале Azure.

![Снимок экрана функции служебной шины с выделенным параметром "Свойства" и параметром журнала обнаружения дубликатов, отмеченным красным цветом.][2]

Можно программно настроить размер интервала поиска повторяющихся сообщений, в течение которого сохраняются идентификаторы сообщений, задав свойство [QueueDescription.DuplicateDetectionHistoryTimeWindow](/dotnet/api/microsoft.servicebus.messaging.queuedescription.duplicatedetectionhistorytimewindow#Microsoft_ServiceBus_Messaging_QueueDescription_DuplicateDetectionHistoryTimeWindow) с помощью API полнофункциональной платформы .NET Framework. При использовании API Azure Resource Manager это значение задается с помощью свойства [queueProperties.duplicateDetectionHistoryTimeWindow](/azure/templates/microsoft.servicebus/namespaces/queues#property-values).

Обратите внимание на то, что включение поиска повторяющихся сообщений и размер интервала непосредственно повлияют на пропускную способность очереди (и раздела), так как все записанные идентификаторы сообщений должны сопоставляться с идентификатором каждого нового отправленного сообщения.

Чем меньше этот интервал, тем меньше идентификаторов сообщений нужно хранить и сопоставлять, и тем меньше используется пропускной способности. Для сущностей с высоким потреблением пропускной способности, для которых требуется поиск повторяющихся сообщений, следует задавать как можно меньшее значение этого интервала.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения об обмене сообщениями через служебную шину см. в следующих статьях:

* [Очереди, разделы и подписки служебной шины](service-bus-queues-topics-subscriptions.md)
* [Начало работы с очередями служебной шины](service-bus-dotnet-get-started-with-queues.md)
* [Как использовать разделы и подписки служебной шины](service-bus-dotnet-how-to-use-topics-subscriptions.md)

В сценариях, где код клиента не может повторно отправить сообщение с тем же идентификатором *MessageId* , что и раньше, важно разработать сообщения, которые можно безопасно обработать. В этой записи [блога о Идемпотентность](https://particular.net/blog/what-does-idempotent-mean) описаны различные методы их выполнения.

[1]: ./media/duplicate-detection/create-queue.png
[2]: ./media/duplicate-detection/queue-prop.png
