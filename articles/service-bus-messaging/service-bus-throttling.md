---
title: Обзор регулирования служебной шины Azure | Документация Майкрософт
description: Обзор регулирования служебной шины — уровня "Стандартный" и "Премиум".
ms.topic: article
ms.date: 06/23/2020
ms.openlocfilehash: 436f9a40269f7eea4e31b55b9657d38849876eb4
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "85340955"
---
# <a name="throttling-operations-on-azure-service-bus"></a>Операции регулирования в служебной шине Azure

Облачные решения для машинного кода дают представление о неограниченных ресурсах, которые можно масштабировать с помощью рабочей нагрузки. Хотя это понятие является более верным в облаке, чем в локальных системах, все еще существуют ограничения в облаке.

Эти ограничения могут привести к регулированию запросов клиентских приложений в уровнях "Стандартный" и "Премиум", как описано в этой статье. 

## <a name="throttling-in-azure-service-bus-standard-tier"></a>Регулирование на стандартном уровне служебной шины Azure

Уровень "Стандартный" служебной шины Azure действует как настройка с оплатой по мере использования для нескольких клиентов. Здесь несколько пространств имен в одном кластере совместно используют выделенные ресурсы. Уровень "Стандартный" — это рекомендуемый вариант для сред разработки, тестирования и контроля качества, а также для производственных систем с низкой пропускной способностью.

В прошлом, в служебной шине Azure были неограниченные ограничения регулирования, строго зависящие от использования ресурсов. Однако существует возможность уточнить логику регулирования и обеспечить предсказуемое поведение регулирования для всех пространств имен, которые совместно используют эти ресурсы.

При попытке обеспечить справедливое использование и распределение ресурсов во всех стандартных пространствах имен служебной шины Azure, использующих те же ресурсы, логика регулирования была изменена на кредитные.

> [!NOTE]
> Важно отметить, что регулирование ***не является новым*** для служебной шины Azure или любой облачной собственной службы.
>
> Регулирование на основе кредита — это просто уточнение того, как различные пространства имен совместно используют ресурсы в среде уровня "Стандартный" с несколькими клиентами. Таким образом, это позволяет использовать все пространства имен, совместно использующие ресурсы.

### <a name="what-is-credit-based-throttling"></a>Что такое регулирование на основе кредита?

Регулирование на основе кредита ограничивает количество операций, которые могут быть выполнены с заданным пространством имен за определенный период времени. 

Ниже приведен рабочий процесс регулирования на основе кредита. 

  * В начале каждого периода времени мы предоставляем определенное количество кредитов каждому пространству имен.
  * Любые операции, выполняемые клиентскими приложениями отправителя или получателя, будут учитываться для этих кредитов (и вычитаются из доступных кредитов).
  * Если кредиты исчерпаны, последующие операции будут регулироваться до начала следующего периода времени.
  * Кредиты пополняются в начале следующего периода времени.

### <a name="what-are-the-credit-limits"></a>Каковы кредитные лимиты?

В настоящее время лимиты кредита задаются как "1000" кредиты каждую секунду (для каждого пространства имен).

Не все операции создаются равными. Ниже приведены затраты на кредит каждой операции. 

| Операция | Стоимость кредита|
|-----------|-----------|
| Операции с данными (отправка, SendAsync, получение, ReceiveAsync, просмотр) |1 кредит на одно сообщение |
| Операции управления (создание, чтение, обновление, удаление в очередях, разделы, подписки, фильтры) | 10 кредитов |

> [!NOTE]
> Обратите внимание, что при отправке в раздел каждое сообщение оценивается по фильтрам до того, как оно станет доступно в подписке.
> Каждая оценка фильтра также учитывает кредитный лимит (т. е. 1 кредит на оценку фильтра).
>

### <a name="how-will-i-know-that-im-being-throttled"></a>Как я знаю, что выполняется регулирование?

Когда запросы клиентского приложения регулируется, приложение и записывается в журнал следующий ответ сервера.

```
The request was terminated because the entity is being throttled. Error code: 50009. Please wait 2 seconds and try again.
```

### <a name="how-can-i-avoid-being-throttled"></a>Как избежать регулирования?

При использовании общих ресурсов важно обеспечить некоторое справедливое использование в различных пространствах имен служебной шины, использующих эти ресурсы. Регулирование гарантирует, что все пиковые нагрузки в одной рабочей нагрузке не приводят к регулированию других рабочих нагрузок на тех же ресурсах.

Как упоминалось далее в этой статье, нет риска перерегулироваться, так как в клиентских пакетах SDK (и других предложениях Azure PaaS) встроена политика повтора по умолчанию. Все регулируемые запросы будут повторены с экспоненциальной задержкой и, в конечном итоге, будут проходить по мере пополнения кредитов.

Понятно, что некоторые приложения могут быть чувствительны к регулированию. В этом случае рекомендуется [перенести текущее стандартное пространство имен служебной шины в Premium](service-bus-migrate-standard-premium.md). 

При миграции можно выделить выделенные ресурсы для пространства имен служебной шины и соответствующим образом масштабировать ресурсы, если в рабочей нагрузке есть Пиковая нагрузка и снижена вероятность регулирования. Кроме того, если Рабочая нагрузка сокращается до обычных уровней, можно масштабировать ресурсы, выделенные для пространства имен.

## <a name="throttling-in-azure-service-bus-premium-tier"></a>Регулирование на уровне Premium служебной шины Azure

Уровень [Premium служебной шины Azure](service-bus-premium-messaging.md) выделяет выделенные ресурсы в терминах единиц обмена сообщениями для каждой установки пространства имен клиентом. Эти выделенные ресурсы обеспечивают предсказуемую пропускную способность и задержку и рекомендуются для высокопроизводительных и конфиденциальных систем производственного уровня.

Кроме того, уровень "Премиум" позволяет клиентам увеличивать пропускную способность, когда они сталкиваются с пиковыми нагрузками.

### <a name="how-does-throttling-work-in-service-bus-premium"></a>Как работает регулирование в Service Bus Premium?

При использовании эксклюзивного выделения ресурсов для служебной шины Premium регулирование регулируется исключительно ограничениями ресурсов, выделенных пространству имен.

Если количество запросов больше, чем текущие ресурсы могут обслуживаться, запросы будут регулироваться.

### <a name="how-will-i-know-that-im-being-throttled"></a>Как я знаю, что выполняется регулирование?

Существует несколько способов идентификации регулирования в служебной шине Azure Premium — 
  * **Регулируемые запросы** отображаются в [метриках запроса Azure Monitor](service-bus-metrics-azure-monitor.md#request-metrics) , чтобы узнать, сколько запросов было отрегулировано.
  * Высокая загрузка **ЦП** указывает, что текущее выделение ресурсов велико и запросы могут регулироваться, если текущая рабочая нагрузка не уменьшается.
  * Высокий уровень **использования памяти** указывает, что текущее выделение ресурсов велико и запросы могут регулироваться, если текущая рабочая нагрузка не уменьшается.

### <a name="how-can-i-avoid-being-throttled"></a>Как избежать регулирования?

Так как пространство имен Premium служебной шины уже содержит выделенные ресурсы, можно уменьшить возможность регулирования, увеличив количество единиц обмена сообщениями, выделенных для пространства имен, в рамках события (или предполагаемого) пиковой нагрузки.

Увеличение или уменьшение масштаба можно выполнить, создав [модули Runbook](../automation/automation-create-alert-triggered-runbook.md) , которые могут быть активированы изменениями в указанных выше метриках.

## <a name="faqs"></a>Часто задаваемые вопросы

### <a name="how-does-throttling-affect-my-application"></a>Как регулирование влияет на мое приложение?

Когда запрос регулируется, это означает, что служба занята, так как она имеет больше запросов, чем разрешено ресурсами. Если одна и та же операция повторяется через несколько секунд, после того, как служба будет работать через текущую рабочую нагрузку, запрос может быть принят.

Так как регулирование является ожидаемым поведением любой облачной службы, мы создали логику повторных попыток в самом пакете SDK служебной шины Azure. Значение по умолчанию — автоматическая повторная попытка с экспоненциальной задержкой, чтобы гарантировать, что у нас нет того же запроса, который регулируется каждый раз.

Логика повторных попыток по умолчанию будет применяться к каждой операции.

### <a name="does-throttling-result-in-data-loss"></a>Приводит ли регулирование к утрате данных?

Служебная шина Azure оптимизирована для сохранения, поэтому все данные, отправленные в служебную шину, фиксируются в хранилище, прежде чем служба подтвердит успешность запроса.

После успешного выполнения запроса "подтверждение" (подтверждено) служебной шиной это означает, что служебная шина успешно обработала запрос. Если служебная шина возвращает "НАКК" (сбой), это означает, что служебная шина не смогла обработать запрос, и клиентское приложение должно повторить запрос.

Однако при регулировании запроса служба подразумевает, что она не может принять и обработать запрос прямо сейчас из-за ограничений ресурсов. Это **не** подразумевает потери данных, так как служебная шина просто не просмотрела запрос. В этом случае, используя политику повтора по умолчанию пакета SDK служебной шины, вы гарантируете, что запрос будет обработан в конечном итоге.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения и примеры использования обмена сообщениями в служебной шине Microsoft Azure см. в следующих дополнительных статьях:

* [Основные сведения об обмене сообщениями через служебную шину](service-bus-messaging-overview.md)
* [Краткое руководство по отправке и получению сообщений Служебной шины Azure с помощью портала Azure и .NET](service-bus-quickstart-portal.md)
* [Руководство. Обновление информации о запасах с помощью портала Azure, разделов и подписок](service-bus-tutorial-topics-subscriptions-portal.md)

