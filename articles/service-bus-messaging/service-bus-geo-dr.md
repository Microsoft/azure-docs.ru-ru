---
title: Географическое аварийное восстановление в служебной шине Azure | Документация Майкрософт
description: Способы использования географических регионов для отработки отказа и аварийного восстановления в служебной шине Azure
ms.topic: article
ms.date: 01/04/2021
ms.openlocfilehash: c07721c07923a40da9fe28e0e3116bfd6a52210f
ms.sourcegitcommit: aeba98c7b85ad435b631d40cbe1f9419727d5884
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/04/2021
ms.locfileid: "97862361"
---
# <a name="azure-service-bus-geo-disaster-recovery"></a>Географическое аварийное восстановление в служебной шине Azure

Устойчивость к неустойчивым простоям ресурсов обработки данных является обязательным требованием для многих предприятий и в некоторых случаях даже для отраслевых нормативов. 

Служебная шина Azure уже распределяет риск разрушительных сбоев отдельных компьютеров или даже полных стоек в кластерах, охватывающих несколько доменов сбоя в центре обработки данных, и реализует прозрачное обнаружение сбоев и механизмы отработки отказа, так что служба будет продолжать работать на уровне служб и обычно без заметных перерывов в работе таких сбоев. Если пространство имен служебной шины создано с параметром Enabled для [зон доступности](../availability-zones/az-overview.md), риск простоя распределяется по трем физически разделенным средствам, а служба имеет достаточно резервных копий, чтобы быстро справиться с полной, катастрофической потерей всех средств. 

Полная активная модель кластера служебной шины Azure с поддержкой зон доступности является старшим для любого продукта брокера локальных сообщений с точки зрения устойчивости к сбоям оборудования и даже катастрофической потери всех центров обработки данных. Тем не менее могут возникнуть случаи с грависом при значительном физическом уничтожении, и даже эти меры не могут быть достаточными для защиты. 

Функция географического аварийного восстановления служебной шины призвана упростить восстановление после аварии и отказаться от неисправного региона Azure и без необходимости изменять конфигурации приложений. Прекращение использования региона Azure обычно влечет за собой несколько служб, и эта функция в основном нацелена на сохранение целостности конфигурации составного приложения. Эта функция доступна глобально для SKU Service Bus уровня "Премиум". 

Функция восстановления Geo-Disaster гарантирует, что вся конфигурация пространства имен (очередей, разделов, подписок, фильтров) постоянно реплицируется из основного пространства имен в дополнительное пространство имен при связывании и позволяет инициировать отработку отказа только один раз из основной базы данных-получателя в любое время. При перемещении отработки отказа выбранное имя псевдонима для пространства имен будет повторно назначено дополнительному пространству имен, а затем нарушено связывание. Отработка отказа почти мгновенно инициируется. 

> [!IMPORTANT]
> Эта функция обеспечивает мгновенную непрерывность операций с такой же конфигурацией, но **не реплицирует сообщения, хранящиеся в очередях или подписках разделов или недоставленных очередях**. Чтобы сохранить семантику очереди, такая репликация потребует не только репликации данных сообщений, но и каждого изменения состояния в брокере. Для большинства пространств имен служебной шины необходимый трафик репликации значительно превышает трафик приложения и очереди с высокой пропускной способностью, и большинство сообщений по-прежнему будут реплицироваться на вторичный сервер, в то время как они уже удаляются из основной базы данных, что приводит к чрезмерному непроизводительнаму трафику. Для маршрутов репликации с высокой задержкой, которые применяются ко многим комбинациям, которые можно выбрать для географического аварийного восстановления, трафик репликации может быть недоступен для поддержания трафика приложения из-за эффектов регулирования, вызванных задержками.
 
> [!TIP]
> Для репликации содержимого очередей и подписок на разделы и работы соответствующих пространств имен в конфигурациях "активный/активный" с учетом сбоев и аварий не следует поменять этот набор функций географического аварийного восстановления, но следовать [указаниям по репликации](service-bus-federation-overview.md).  

## <a name="outages-and-disasters"></a>Сбои и аварийные ситуации

Важно отметить различия между "сбоями" и "авариями". 

*Сбой* — это временная недоступность служебной шины Azure. Он может повлиять на некоторые компоненты службы, такие как хранилище сообщений, или даже весь центр обработки данных. Однако после устранения проблемы служебная шина снова становится доступной. Как правило, простой не приводит к утрате сообщений или других данных. Примером такого сбоя может быть сбой питания в центре обработки данных. Некоторые сбои являются всего лишь короткими потерями подключения из-за временных или сетевых проблем. 

*Авария* определяется как полная или долговременная потеря кластера служебной шины, региона Azure или центра обработки данных. Регион или центр обработки данных может снова стать доступным, но может и не стать или быть отключенным в течение нескольких часов или дней. Примеры аварий — пожар, наводнение или землетрясение. Длительное аварийное состояние может привести к потере некоторых сообщений, событий или других данных. Но в большинстве случаев потеря данных не происходит и сообщения можно восстановить сразу же после резервного копирования в центре обработки данных.

Функция географического аварийного восстановления служебной шины Azure — это решение для аварийного восстановления. Основные понятия и рабочий процесс, описанные в этой статье, относятся к сценариям восстановления после аварий, но не временных сбоев. Дополнительные сведения об аварийном восстановлении в Microsoft Azure см. в статье [Аварийное восстановление для приложений на платформе Azure](/azure/architecture/resiliency/disaster-recovery-azure-applications).   

## <a name="basic-concepts-and-terms"></a>Основные понятия и термины

Функция аварийного восстановления реализует аварийное восстановление метаданных и основывается на первичном и вторичном пространстве имен для аварийного восстановления. Обратите внимание, что функция географического аварийного восстановления доступна только для [SKU "Премиум"](service-bus-premium-messaging.md). Вам не нужно изменять какие-либо строки подключения, так как соединение выполняется через псевдоним.

В этом руководстве используются термины, представленные ниже.

-  *Псевдоним*. Имя настроенной конфигурации аварийного восстановления. Псевдоним предоставляет единую стабильную строку подключения полного доменного имени (FQDN). Приложения используют ее для подключения к пространству имен. Использование псевдонимов гарантирует, что строка подключения не изменится, когда активируется отработка отказа.

-  *Основное или дополнительное пространство имен*. Пространство имен, соответствующее псевдониму. Основное пространство имен является "активным" и получает сообщения (это может быть существующее или новое пространство имен). Дополнительное пространство имен является "пассивным" и не получает сообщений. Метаданные между ними синхронизированы, поэтому они могут беспрепятственно принимать сообщения без каких-либо изменений кода или строки подключения приложения. Чтобы убедиться, что только активное пространство имен получает сообщения, необходимо использовать псевдоним. 

-  *Метаданные*. Сущности, такие как очереди, разделы и подписки, и их свойства службы, связанные с пространством имен. Обратите внимание, что только сущности и их параметры реплицируются автоматически. Сообщения не реплицируются.

-  *Отработка отказа*. Процесс активации дополнительного пространства имен.

## <a name="setup"></a>Настройка

В следующем разделе рассматривается настройка парных пространств имен.

![1][]

Вот как это можно сделать.

1. Подготавливает пространство имен ***PRIMARY** служебная шина уровня "Премиум".

2. Подготавливает пространство имен _*_Premium служебной_*_ шины в регионе _different из которого подготовлено основное пространство имен *. Это поможет изолировать сбои в разных регионах размещения центров обработки данных.

3. Создайте связывание между основным пространством имен и дополнительным пространством имен, чтобы получить ***Alias** _.

    >[!NOTE] 
    > Если вы [перенесли стандартное пространство имен служебной шины Azure в служебную шину Azure Premium](service-bus-migrate-standard-premium.md), необходимо использовать существующий псевдоним (т. е. строку подключения к стандартному пространству имен служебной шины), чтобы создать конфигурацию аварийного восстановления с помощью _ *PS/CLI** или **REST API**.
    >
    >
    > Это связано с тем, что во время миграции имя строки подключения или DNS для пространства имен Служебной шины Azure категории "Стандартный" становится псевдонимом для пространства имен Служебной шины Azure категории "Премиум".
    >
    > Клиентские приложения должны использовать этот псевдоним (т. е. строку подключения к пространству имен Служебной шины Azure категории "Стандартный") для подключения к пространству имен службы категории"Премиум", в котором была установлена пара аварийного восстановления.
    >
    > Если вы используете портал для настройки конфигурации аварийного восстановления, портал выдаст это предостережение.


4. Используйте **_Alias_* _, полученную на шаге 3, чтобы подключить клиентские приложения к основному пространству имен с поддержкой географического восстановления. Изначально псевдоним указывает на основное пространство имен.

5. [Необязательно.] Добавьте некоторые функции мониторинга, чтобы определить, необходимо ли выполнять отработку отказа.

## <a name="failover-flow"></a>Поток отработки отказа

Отработка отказа активируется клиентом вручную (явно командой или посредством клиента с бизнес-логикой, которая выполняет команду), а не Azure. Это дает клиенту полный контроль и видимость для устранения сбоя в магистрали Azure.

![4][]

После активации отработки отказа происходит следующее.

1. Строка подключения _*_псевдонима_*_ обновляется так, чтобы указывать на дополнительное пространство имен Premium.

2. Клиенты (отправители и получатели) автоматически подключаются к дополнительному пространству имен.

3. Существующая связь между основным и дополнительным пространствами имен ценовой категории "Премиум" разрывается.

После инициирования отработки отказа происходит следующее.

1. В случае другого сбоя необходимо иметь возможность повторной отработки отказа. Поэтому настройте другое пассивное пространство имен и обновите связывание. 

2. Извлеките сообщения из прежнего основного пространства имен, как только оно станет доступным. После этого используйте это пространство имен для регулярного обмена сообщениями вне настройки географического восстановления или удалите старое основное пространство имен.

> [!NOTE]
> Поддерживается только семантика переадресации сбоя. В этом сценарии выполняется отработка отказа, а затем повторное связывание с новым пространством имен. Восстановление размещения не поддерживается, к примеру, в кластере SQL. 

Отработку отказа можно автоматизировать с помощью систем мониторинга или пользовательских решений для мониторинга. Однако такая автоматизация требует дополнительного планирования и работы, что выходит за рамки данной статьи.

![2][]

## <a name="management"></a>Управление

Если допущена ошибка, например, во время первоначальной настройки связаны неправильные регионы, связь двух пространств имен можно разорвать в любое время. Если вы хотите использовать сопряженные пространства имен в качестве обычных пространств имен, удалите псевдоним.

## <a name="use-existing-namespace-as-alias"></a>Использование имеющихся пространств имен в качестве псевдонима

При наличии сценария, в котором невозможно изменить подключения отправителей и потребителей, можно повторно использовать имя пространства имен в качестве псевдонима. Дополнительные сведения см. в [примере кода на GitHub](https://github.com/Azure/azure-service-bus/tree/master/samples/DotNet/Microsoft.ServiceBus.Messaging/GeoDR/SBGeoDR2/SBGeoDR_existing_namespace_name).

## <a name="samples"></a>Примеры

В [примере из GitHub](https://github.com/Azure/azure-service-bus/tree/master/samples/DotNet/Microsoft.ServiceBus.Messaging/GeoDR/SBGeoDR2/) показано, как настроить и инициировать отработку отказа. В этих примерах демонстрируются следующие понятия:

- Пример .NET и параметры, необходимые в Azure Active Directory для настройки и включения географически избыточного восстановления с помощью Azure Resource Manager и служебной шины.
- шаги, необходимые для выполнения примера кода;
- Использование имеющегося пространства имен в качестве псевдонима.
- Инструкции по включению географически избыточного восстановления с помощью PowerShell или CLI.
- [Отправка и получение](https://github.com/Azure/azure-service-bus/tree/master/samples/DotNet/Microsoft.ServiceBus.Messaging/GeoDR/TestGeoDR/ConsoleApp1) из текущего основного и дополнительного пространства имен с помощью псевдонима.

## <a name="considerations"></a>Рекомендации

Обратите внимание на следующие моменты для этого выпуска:

1. При планировании отработки отказа следует также учитывать фактор времени. Например, в случае потери подключения на более чем 15–20 минут можно запустить отработку отказа.

2. Тот факт, что данные не реплицируются, означает, что в настоящее время активные сеансы не реплицируются. Кроме того, обнаружение дубликатов и запланированные сообщения могут не работать. Новые сеансы, новые запланированные сообщения и новые дубликаты будут работать. 

3. Отработку отказа сложной распределенной инфраструктуры необходимо [протестировать](/azure/architecture/reliability/disaster-recovery#disaster-recovery-plan) по крайней мере один раз.

4. Синхронизация сущностей может занять некоторое время (примерно 50–100 сущностей в минуту). Подписки и правила также учитываются как сущности.

## <a name="availability-zones"></a>зоны доступности;

SKU уровня "Премиум" служебной шины также поддерживает [зоны доступности](../availability-zones/az-overview.md), предоставляя изолированные от сбоев места в регионе Azure.

> [!NOTE]
> Поддержка Зон доступности Служебной шины Azure ценовой категории "Премицм"доступна только в [регионах Azure](../availability-zones/az-region.md), в которых представлены зоны доступности.

Вы можете включить эту функцию только в новых пространствах имен с помощью портала Azure. Служебная шина не поддерживает миграцию существующих пространств имен. Вы не можете отключить избыточность в пределах зоны после ее включения в пространстве имен.

![3][]

## <a name="private-endpoints"></a>Частные конечные точки
В этом разделе приводятся дополнительные рекомендации при использовании геоизбыточного аварийного восстановления с пространствами имен, в которых используются частные конечные точки. Дополнительные сведения об использовании частных конечных точек со Служебной шиной см. в статье [Интеграция Служебной шины Azure с Приватным каналом Azure](private-link-service.md).

### <a name="new-pairings"></a>Новые пары
При попытке создать пару между основным пространством имен с частной конечной точкой и дополнительным пространством имен без частной конечной точки связывание завершится ошибкой. Связывание выполнится успешно, только если у основного и дополнительного пространств имен есть частные конечные точки. Рекомендуется использовать одинаковые конфигурации в основном и дополнительном пространствах имен и в виртуальных сетях, в которых создаются частные конечные точки. 

> [!NOTE]
> При попытке связать основное пространство имен с частной конечной точкой и дополнительное пространство имен проверяется только, существует ли частная конечная точка в дополнительном пространстве имен. Не проверяется, работает ли конечная точка и будет ли она работать после отработки отказа. Вы должны убедиться, что дополнительное пространство имен с частной конечной точкой будет корректно работать после отработки отказа.
>
> Чтобы проверить, совпадают ли конфигурации частных конечных точек, отправьте запрос [Получить очереди](/rest/api/servicebus/stable/queues/get) к дополнительному пространству имен из-за пределов виртуальной сети и убедитесь, что служба выдает сообщение об ошибке.

### <a name="existing-pairings"></a>Существующие пары
Если связывание между основным и дополнительным пространством имен уже существует, создание частной конечной точки в основном пространстве имен завершится ошибкой. Чтобы устранить эту проблему, сначала создайте частную конечную точку в дополнительном пространстве имен, а затем — в основном.

> [!NOTE]
> Хотя мы допускаем доступ только для чтения к дополнительному пространству имен, обновление конфигураций частных конечных точек разрешено. 

### <a name="recommended-configuration"></a>Рекомендуемая конфигурация
При создании конфигурации аварийного восстановления для приложения и Служебной шины необходимо создать частные конечные точки для основного и дополнительного пространств имен Служебной шины для виртуальных сетей, в которых размещаются как первичные, так и вторичные экземпляры приложения.

Предположим, у вас есть две виртуальные сети (VNET-1, VNET-2) и основное и дополнительное пространства имен: ServiceBus-Namespace1-Primary, ServiceBus-Namespace2-Secondary. Сделайте следующее: 

- В ServiceBus-Namespace1-Primary создайте две частные конечные точки, которые используют подсети VNET-1 и VNET-2
- В ServiceBus-Namespace2-Secondary создайте две частные конечные точки, которые используют подсети VNET-1 и VNET-2 

![Частные конечные точки и виртуальные сети](./media/service-bus-geo-dr/private-endpoints-virtual-networks.png)


Преимуществом этого подхода является то, что отработка отказа может происходить на уровне приложения независимо от пространства имен Служебной шины. Рассмотрим следующие сценарии. 

_ *Отработка отказа только приложения:** здесь приложение не будет существовать в vnet-1, но будет перемещено в vnet-2. Так как обе частные конечные точки настроены в VNET-1 и VNET-2 как для основного, так и для дополнительного пространства имен, приложение будет работать. 

**Отработка отказа только в пространстве имен Служебной шины**: И здесь, так как обе частные конечные точки настроены в обеих виртуальных сетях как для основного, так и для дополнительного пространства имен, приложение будет работать. 

> [!NOTE]
> Рекомендации по геоизбыточному аварийному восстановлению виртуальной сети см. в статье [Виртуальная сеть — непрерывность бизнес-процессов](../virtual-network/virtual-network-disaster-recovery-guidance.md).

## <a name="next-steps"></a>Дальнейшие действия

- Ознакомьтесь со справочными материалами по [REST API для географического аварийного восстановления](/rest/api/servicebus/stable/disasterrecoveryconfigs).
- Запустите пример географического аварийного восстановления [на GitHub](https://github.com/Azure/azure-service-bus/tree/master/samples/DotNet/Microsoft.ServiceBus.Messaging/GeoDR/SBGeoDR2/SBGeoDR2).
- Ознакомьтесь с примером [географического аварийного восстановления, отправляющим сообщения псевдониму](https://github.com/Azure/azure-service-bus/tree/master/samples/DotNet/Microsoft.ServiceBus.Messaging/GeoDR/TestGeoDR/ConsoleApp1).

Дополнительную информацию об обмене сообщениями через служебную шину см. в следующих статьях:

* [Очереди, разделы и подписки служебной шины](service-bus-queues-topics-subscriptions.md)
* [Начало работы с очередями служебной шины](service-bus-dotnet-get-started-with-queues.md)
* [Как использовать разделы и подписки служебной шины](service-bus-dotnet-how-to-use-topics-subscriptions.md)
* [Azure Service Bus REST API](/rest/api/servicebus/) (REST API служебной шины Azure) 

[1]: ./media/service-bus-geo-dr/geodr_setup_pairing.png
[2]: ./media/service-bus-geo-dr/geo2.png
[3]: ./media/service-bus-geo-dr/az.png
[4]: ./media/service-bus-geo-dr/geodr_failover_alias_update.png
