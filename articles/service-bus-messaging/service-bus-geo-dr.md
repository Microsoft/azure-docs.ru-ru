---
title: Географическое аварийное восстановление в служебной шине Azure | Документация Майкрософт
description: Использование географических регионов для отработки отказа и аварийного восстановления в служебной шине Azure
ms.topic: article
ms.date: 02/10/2021
ms.openlocfilehash: 3e8050cdaaae7e16a0f5125292df4b89b3690ed3
ms.sourcegitcommit: f3ec73fb5f8de72fe483995bd4bbad9b74a9cc9f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/04/2021
ms.locfileid: "102035400"
---
# <a name="azure-service-bus-geo-disaster-recovery"></a>Географическое аварийное восстановление в служебной шине Azure

Устойчивость к неустойчивым простоям ресурсов обработки данных является обязательным требованием для многих предприятий и в некоторых случаях даже для отраслевых нормативов. 

Служебная шина Azure уже распределяет риск разрушительных сбоев отдельных компьютеров или даже полных стоек в кластерах, охватывающих несколько доменов сбоя в центре обработки данных, и реализует прозрачное обнаружение сбоев и механизмы отработки отказа, так что служба будет продолжать работать в пределах проверенных уровней обслуживания и обычно без заметного перерыва при возникновении таких сбоев. Если пространство имен служебной шины создано с параметром Enabled для [зон доступности](../availability-zones/az-overview.md), риск простоя распределяется по трем физически разделенным средствам, а служба имеет достаточно резервных копий, чтобы быстро справиться с полной, катастрофической потерей всех средств. 

Полная активная модель кластера служебной шины Azure с поддержкой зон доступности является старшим для любого продукта брокера локальных сообщений с точки зрения устойчивости к сбоям оборудования и даже катастрофической потери всех центров обработки данных. Тем не менее могут возникнуть случаи с грависом при широком физическом уничтожении, в котором даже эти меры не могут быть достаточными для защиты. 

Функция географического аварийного восстановления служебной шины призвана упростить восстановление после аварии и отказаться от неисправного региона Azure и без необходимости изменять конфигурации приложений. Прекращение использования региона Azure обычно влечет за собой несколько служб, и эта функция в основном нацелена на сохранение целостности конфигурации составного приложения. Эта функция доступна глобально для SKU Service Bus уровня "Премиум". 

Функция восстановления Geo-Disaster гарантирует, что вся конфигурация пространства имен (очередей, разделов, подписок, фильтров) постоянно реплицируется из основного пространства имен в дополнительное пространство имен при связывании и позволяет инициировать отработку отказа только один раз из основной базы данных-получателя в любое время. Перемещение отработки отказа будет повторно указывать выбранное имя псевдонима для пространства имен в дополнительное пространство имен, а затем разрывать связывание. Отработка отказа почти мгновенно инициируется. 

> [!IMPORTANT]
> Эта функция обеспечивает мгновенную непрерывность операций с такой же конфигурацией, но **не реплицирует сообщения, хранящиеся в очередях или подписках разделов или недоставленных очередях**. Чтобы сохранить семантику очереди, такая репликация потребует не только репликации данных сообщений, но и каждого изменения состояния в брокере. Для большинства пространств имен служебной шины необходимый трафик репликации значительно превышает трафик приложения и очереди с высокой пропускной способностью, и большинство сообщений по-прежнему будут реплицироваться на вторичный сервер, в то время как они уже удаляются из основной базы данных, что приводит к чрезмерному непроизводительнаму трафику. Для маршрутов репликации с высокой задержкой, которые применяются ко многим комбинациям, которые можно выбрать для географического аварийного восстановления, трафик репликации может быть недоступен для поддержания трафика приложения из-за эффектов регулирования, вызванных задержками.
 
> [!TIP]
> Для репликации содержимого очередей и подписок на разделы и работы соответствующих пространств имен в конфигурациях "активный/активный" с учетом сбоев и аварий не следует поменять этот набор функций географического аварийного восстановления, но следовать [указаниям по репликации](service-bus-federation-overview.md).  

## <a name="outages-and-disasters"></a>Сбои и аварийные ситуации

Важно отметить различия между "сбоями" и "авариями". 

*Сбой* — это временная недоступность служебной шины Azure. Он может повлиять на некоторые компоненты службы, такие как хранилище сообщений, или даже весь центр обработки данных. Однако после устранения проблемы служебная шина снова становится доступной. Как правило, простой не приводит к утрате сообщений или других данных. Примером такого сбоя может быть сбой питания в центре обработки данных. Некоторые сбои являются всего лишь кратковременными потерями подключения из-за временных или сетевых проблем. 

*Авария* определяется как полная или долговременная потеря кластера служебной шины, региона Azure или центра обработки данных. Регион или центр обработки данных может снова стать доступным, но может и не стать или быть отключенным в течение нескольких часов или дней. Примеры аварий — пожар, наводнение или землетрясение. Длительное аварийное состояние может привести к потере некоторых сообщений, событий или других данных. Но в большинстве случаев потеря данных не происходит и сообщения можно восстановить сразу же после резервного копирования в центре обработки данных.

Функция географического аварийного восстановления служебной шины Azure — это решение для аварийного восстановления. Основные понятия и рабочий процесс, описанные в этой статье, относятся к сценариям восстановления после аварий, но не временных сбоев. Дополнительные сведения об аварийном восстановлении в Microsoft Azure см. в статье [Аварийное восстановление для приложений на платформе Azure](/azure/architecture/resiliency/disaster-recovery-azure-applications).   

## <a name="basic-concepts-and-terms"></a>Основные понятия и термины

Функция аварийного восстановления реализует аварийное восстановление метаданных и основывается на первичном и вторичном пространстве имен для аварийного восстановления. Функция географического аварийного восстановления доступна только для [SKU](service-bus-premium-messaging.md) уровня "Премиум". Вам не нужно изменять какие-либо строки подключения, так как подключение выполняется через псевдоним.

В этом руководстве используются термины, представленные ниже.

-  *Псевдоним*. Имя настроенной конфигурации аварийного восстановления. Псевдоним предоставляет единую стабильную строку подключения полного доменного имени (FQDN). Приложения используют ее для подключения к пространству имен. Использование псевдонимов гарантирует, что строка подключения не изменится, когда активируется отработка отказа.

-  *Основное или дополнительное пространство имен*. Пространство имен, соответствующее псевдониму. Основное пространство имен является "активным" и получает сообщения (это может быть существующее или новое пространство имен). Дополнительное пространство имен является "пассивным" и не получает сообщений. Метаданные между ними синхронизированы, поэтому они могут беспрепятственно принимать сообщения без каких-либо изменений кода или строки подключения приложения. Чтобы убедиться, что только активное пространство имен получает сообщения, необходимо использовать псевдоним. 
-  *Метаданные*. Сущности, такие как очереди, разделы и подписки, и их свойства службы, связанные с пространством имен. Только сущности и их параметры реплицируются автоматически. Сообщения не реплицируются.
-  *Отработка отказа*. Процесс активации дополнительного пространства имен.

## <a name="setup"></a>Настройка

В следующем разделе приведены общие сведения о настройке связывания между пространствами имен.

![1][]

Сначала создается или используется существующее основное пространство имен и новое дополнительное пространство имен, а затем они связываются. Это связывание предоставит псевдоним, который можно использовать для подключения. Так как используется псевдоним, нет необходимости изменять строки подключения. Только новые пространства имен могут быть добавлены к вашему связыванию. 

1. Создайте основное пространство имен.
1. Создайте дополнительное пространство имен в другом регионе. Это необязательный шаг. Вы можете создать вторичное пространство имен при создании связывания на следующем шаге. 
1. В портал Azure перейдите к основному пространству имен.
1. Выберите **географическое восстановление** в меню слева и выберите **начать связывание** на панели инструментов. 

    :::image type="content" source="./media/service-bus-geo-dr/primary-namspace-initiate-pairing-button.png" alt-text="Инициация связывания из основного пространства имен":::    
1. На странице **Инициация связывания** выполните следующие действия.
    1. Выберите существующее вторичное пространство имен или создайте его в другом регионе. В этом примере в качестве дополнительного пространства имен используется существующее пространство имен.  
    1. В поле **псевдоним** введите псевдоним для пары "географическое восстановление". 
    1. Затем выберите **Создать**. 

        :::image type="content" source="./media/service-bus-geo-dr/initiate-pairing-page.png" alt-text="Выбор дополнительного пространства имен":::        
1. Должна отобразиться страница **псевдонима служебной шины Geo-Dr** , как показано на следующем рисунке. Вы также можете переходить на страницу **псевдонима географического аварийного** восстановления со страницы первичного пространства имен, выбрав **географическое восстановление** в меню слева. 

    :::image type="content" source="./media/service-bus-geo-dr/service-bus-geo-dr-alias-page.png" alt-text="Страница псевдонима географического аварийного восстановления служебной шины":::
1. На странице **псевдоним географического аварийного восстановления** выберите **политики общего доступа** в меню слева для доступа к основной строке подключения для псевдонима. Используйте эту строку соединения вместо строки подключения к первичному/вторичному пространству имен напрямую. Изначально псевдоним указывает на основное пространство имен.
1. Перейдите на страницу **Обзор**. Можно выполнить следующие действия. 
    1. Разбиение пары между основным и дополнительным пространствами имен. На панели инструментов нажмите кнопку **приостановить связывание** . 
    1. Вручную отработка отказа в дополнительное пространство имен. 
        1. На панели инструментов выберите **отработка отказа** . 
        1. Убедитесь, что вы хотите выполнить отработку отказа в дополнительное пространство имен, введя свой псевдоним. 
        1. Включите параметр **безопасного перехода на другой ресурс** , чтобы безопасно выполнить отработку отказа в дополнительное пространство имен. Эта функция обеспечивает завершение ожидающих репликации географического аварийного восстановления перед переключением на сервер-получатель. 
        1. Затем выберите **отработка отказа**. 
        
            :::image type="content" source="./media/service-bus-geo-dr/failover-page.png" alt-text="{alt-text}":::
    
            > [!IMPORTANT]
            > При отработки отказа будет активировано дополнительное пространство имен и удалено основное пространство имен из Geo-Disaster связывания с восстановлением. Создайте другое пространство имен, чтобы создать пару географического аварийного восстановления. 

1. Наконец, следует добавить некоторые функции мониторинга, чтобы определить, необходимо ли выполнять отработку отказа. В большинстве случаев служба — это одна из частей большой экосистемы, поэтому автоматический переход на другой ресурс не всегда возможен, так как отработки отказа следует выполнять синхронно с оставшимися подсистемами или инфраструктурой.

### <a name="service-bus-standard-to-premium"></a>Стандарт Service Bus уровня "Премиум"
Если вы [перенесли стандартное пространство имен служебной шины Azure в служебную шину Azure Premium](service-bus-migrate-standard-premium.md), необходимо использовать существующий псевдоним (то есть строку подключения к стандартному пространству имен служебной шины), чтобы создать конфигурацию аварийного восстановления с помощью **PS/CLI** или **REST API**.

Это связано с тем, что во время миграции имя строки подключения к пространству имен "Стандартный" служебной шины Azure является псевдонимом для пространства имен уровня "Премиум" служебной шины Azure.

Клиентские приложения должны использовать этот псевдоним (то есть строку подключения к стандартному пространству имен служебной шины Azure) для подключения к пространству имен уровня "Премиум", в котором настроено связывание с аварийным восстановлением.

Если вы используете портал для настройки конфигурации аварийного восстановления, портал выдаст это предостережение.


## <a name="failover-flow"></a>Поток отработки отказа

Отработка отказа активируется клиентом вручную (явно командой или посредством клиента с бизнес-логикой, которая выполняет команду), а не Azure. Он предоставляет клиенту полный доступ и видимость для разрешения сбоя в магистрали Azure.

![4][]

После активации отработки отказа происходит следующее.

1. Строка подключения с ***псевдонимом*** обновляется и указывает на дополнительное пространство имен ценовой категории "Премиум".

2. Клиенты (отправители и получатели) автоматически подключаются к дополнительному пространству имен.

3. Существующая связь между основным и дополнительным пространствами имен ценовой категории "Премиум" разрывается.

После инициирования отработки отказа происходит следующее.

1. В случае другого сбоя необходимо иметь возможность повторной отработки отказа. Поэтому настройте другое пассивное пространство имен и обновите связывание. 

2. Извлеките сообщения из прежнего основного пространства имен, как только оно станет доступным. После этого используйте это пространство имен для регулярного обмена сообщениями вне настройки географического восстановления или удалите старое основное пространство имен.

> [!NOTE]
> Поддерживается только семантика переадресации сбоя. В этом сценарии выполняется отработка отказа, а затем повторное связывание с новым пространством имен. Восстановление размещения не поддерживается, к примеру, в кластере SQL. 

Отработку отказа можно автоматизировать с помощью систем мониторинга или пользовательских решений для мониторинга. Однако такая автоматизация требует дополнительного планирования и работы, что выходит за рамки данной статьи.

![2][]

## <a name="management"></a>Управление

Если допущена ошибка, например, во время первоначальной настройки связаны неправильные регионы, связь двух пространств имен можно разорвать в любое время. Если вы хотите использовать сопряженные пространства имен в качестве обычных пространств имен, удалите псевдоним.

## <a name="use-existing-namespace-as-alias"></a>Использование имеющихся пространств имен в качестве псевдонима

Если у вас есть сценарий, в котором невозможно изменить подключения поставщиков и потребителей, можно повторно использовать имя пространства имен в качестве псевдонима. Дополнительные сведения см. в [примере кода на GitHub](https://github.com/Azure/azure-service-bus/tree/master/samples/DotNet/Microsoft.ServiceBus.Messaging/GeoDR/SBGeoDR2/SBGeoDR_existing_namespace_name).

## <a name="samples"></a>Примеры

В [примере из GitHub](https://github.com/Azure/azure-service-bus/tree/master/samples/DotNet/Microsoft.ServiceBus.Messaging/GeoDR/SBGeoDR2/) показано, как настроить и инициировать отработку отказа. В этих примерах демонстрируются следующие понятия:

- Пример и параметры .NET, необходимые в Azure Active Directory для использования Azure Resource Manager с служебной шиной, для настройки и включения географического аварийного восстановления.
- шаги, необходимые для выполнения примера кода;
- Использование имеющегося пространства имен в качестве псевдонима.
- Инструкции по включению географически избыточного восстановления с помощью PowerShell или CLI.
- [Отправка и получение](https://github.com/Azure/azure-service-bus/tree/master/samples/DotNet/Microsoft.ServiceBus.Messaging/GeoDR/TestGeoDR/ConsoleApp1) из текущего основного и дополнительного пространства имен с помощью псевдонима.

## <a name="considerations"></a>Рекомендации

Обратите внимание на следующие моменты для этого выпуска:

1. При планировании отработки отказа следует также учитывать фактор времени. Например, в случае потери подключения на более чем 15–20 минут можно запустить отработку отказа.

2. Тот факт, что данные не реплицируются, означает, что в настоящее время активные сеансы не реплицируются. Кроме того, обнаружение дубликатов и запланированные сообщения могут не работать. Будут работать новые сеансы, новые запланированные сообщения и новые дубликаты. 

3. Отработку отказа сложной распределенной инфраструктуры необходимо [протестировать](/azure/architecture/reliability/disaster-recovery#disaster-recovery-plan) по крайней мере один раз.

4. Синхронизация сущностей может занять некоторое время (примерно 50–100 сущностей в минуту). Подписки и правила также учитываются как сущности.

### <a name="availability-zones"></a>зоны доступности;

SKU Служебной шины ценовой категории "Премиум" поддерживает [Зоны доступности](../availability-zones/az-overview.md), предоставляя изолированные от сбоев расположения в пределах одного и того же региона Azure. Служебная шина управляет тремя копиями хранилища сообщений (1 первичный и 2-вторичный). Служебная шина хранит все три копии в синхронизации для операций с данными и управления. Если первичная копия завершается сбоем, одна из дополнительных копий повышается до первичной без наблюдаемого простоя. Если приложения видят временную отсоединение от служебной шины, логика повторных попыток в пакете SDK автоматически подключится к служебной шине. 

При использовании зон доступности метаданные и данные (сообщения) реплицируются в центрах обработки данных в зоне доступности. 

> [!NOTE]
> Поддержка Зон доступности Служебной шины Azure ценовой категории "Премицм"доступна только в [регионах Azure](../availability-zones/az-region.md), в которых представлены зоны доступности.

Вы можете включить эту функцию только в новых пространствах имен с помощью портала Azure. Служебная шина не поддерживает миграцию существующих пространств имен. Вы не можете отключить избыточность в пределах зоны после ее включения в пространстве имен.

![3][]

## <a name="private-endpoints"></a>Частные конечные точки
В этом разделе приводятся дополнительные рекомендации при использовании географического аварийного восстановления с пространствами имен, в которых используются частные конечные точки. Дополнительные сведения об использовании частных конечных точек со Служебной шиной см. в статье [Интеграция Служебной шины Azure с Приватным каналом Azure](private-link-service.md).

### <a name="new-pairings"></a>Новые пары
При попытке создать пару между основным пространством имен с частной конечной точкой и дополнительным пространством имен без частной конечной точки связывание завершится ошибкой. Связывание выполнится успешно, только если у основного и дополнительного пространств имен есть частные конечные точки. Рекомендуется использовать одинаковые конфигурации в основном и дополнительном пространствах имен и в виртуальных сетях, в которых создаются частные конечные точки. 

> [!NOTE]
> При попытке связать основное пространство имен с частной конечной точкой и дополнительное пространство имен проверяется только, существует ли частная конечная точка в дополнительном пространстве имен. Не проверяется, работает ли конечная точка и будет ли она работать после отработки отказа. Вы должны убедиться, что дополнительное пространство имен с частной конечной точкой будет корректно работать после отработки отказа.
>
> Чтобы проверить, совпадают ли конфигурации частных конечных точек, отправьте запрос [Получить очереди](/rest/api/servicebus/stable/queues/get) к дополнительному пространству имен из-за пределов виртуальной сети и убедитесь, что служба выдает сообщение об ошибке.

### <a name="existing-pairings"></a>Существующие пары
Если связывание между основным и дополнительным пространством имен уже существует, создание частной конечной точки в основном пространстве имен завершится ошибкой. Чтобы устранить эту проблему, сначала создайте частную конечную точку в дополнительном пространстве имен, а затем — в основном.

> [!NOTE]
> Хотя мы допускаем доступ только для чтения к дополнительному пространству имен, обновление конфигураций частных конечных точек разрешено. 

### <a name="recommended-configuration"></a>Рекомендуемая конфигурация
При создании конфигурации аварийного восстановления для приложения и Служебной шины необходимо создать частные конечные точки для основного и дополнительного пространств имен Служебной шины для виртуальных сетей, в которых размещаются как первичные, так и вторичные экземпляры приложения.

Предположим, у вас есть две виртуальные сети (VNET-1, VNET-2) и основное и дополнительное пространства имен: ServiceBus-Namespace1-Primary, ServiceBus-Namespace2-Secondary. Сделайте следующее: 

- В ServiceBus-Namespace1-Primary создайте две частные конечные точки, которые используют подсети VNET-1 и VNET-2
- В ServiceBus-Namespace2-Secondary создайте две частные конечные точки, которые используют подсети VNET-1 и VNET-2 

![Частные конечные точки и виртуальные сети](./media/service-bus-geo-dr/private-endpoints-virtual-networks.png)


Преимуществом этого подхода является то, что отработка отказа может происходить на уровне приложения независимо от пространства имен Служебной шины. Рассмотрим следующие сценарии. 

**Отработка отказа только на уровне приложения.** Здесь приложение не будет существовать в VNET-1, но будет перемещено в VNET-2. Так как обе частные конечные точки настроены в VNET-1 и VNET-2 как для основного, так и для дополнительного пространства имен, приложение будет работать. 

**Отработка отказа только в пространстве имен Служебной шины**: И здесь, так как обе частные конечные точки настроены в обеих виртуальных сетях как для основного, так и для дополнительного пространства имен, приложение будет работать. 

> [!NOTE]
> Рекомендации по геоизбыточному аварийному восстановлению виртуальной сети см. в статье [Виртуальная сеть — непрерывность бизнес-процессов](../virtual-network/virtual-network-disaster-recovery-guidance.md).

## <a name="next-steps"></a>Дальнейшие действия

- Ознакомьтесь со справочными материалами по [REST API для географического аварийного восстановления](/rest/api/servicebus/stable/disasterrecoveryconfigs).
- Запустите пример географического аварийного восстановления [на GitHub](https://github.com/Azure/azure-service-bus/tree/master/samples/DotNet/Microsoft.ServiceBus.Messaging/GeoDR/SBGeoDR2/SBGeoDR2).
- Ознакомьтесь с примером [географического аварийного восстановления, отправляющим сообщения псевдониму](https://github.com/Azure/azure-service-bus/tree/master/samples/DotNet/Microsoft.ServiceBus.Messaging/GeoDR/TestGeoDR/ConsoleApp1).

Дополнительную информацию об обмене сообщениями через служебную шину см. в следующих статьях:

* [Очереди, разделы и подписки служебной шины](service-bus-queues-topics-subscriptions.md)
* [Начало работы с очередями служебной шины](service-bus-dotnet-get-started-with-queues.md)
* [Как использовать разделы и подписки служебной шины](service-bus-dotnet-how-to-use-topics-subscriptions.md)
* [Azure Service Bus REST API](/rest/api/servicebus/) (REST API служебной шины Azure) 

[1]: ./media/service-bus-geo-dr/geodr_setup_pairing.png
[2]: ./media/service-bus-geo-dr/geo2.png
[3]: ./media/service-bus-geo-dr/az.png
[4]: ./media/service-bus-geo-dr/geodr_failover_alias_update.png
