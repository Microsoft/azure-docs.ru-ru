---
title: Как использовать очереди Служебной шины Azure с Ruby
description: В этом руководстве описано, как создавать приложения Ruby для отправки и получения сообщений через очередь Служебной шины.
documentationcenter: ruby
ms.devlang: ruby
ms.topic: quickstart
ms.date: 06/23/2020
ms.openlocfilehash: 16dda6fc4637f052514a0e78a0804bf4702ed20b
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "85336651"
---
# <a name="quickstart-how-to-use-service-bus-queues-with-ruby"></a>Краткое руководство. Как использовать очереди служебной шины с Ruby

[!INCLUDE [service-bus-selector-queues](../../includes/service-bus-selector-queues.md)]

В этом руководстве описано, как создавать приложения Ruby для отправки и получения сообщений через очередь Служебной шины. Примеры написаны с помощью Ruby и используют пакет Azure.

## <a name="prerequisites"></a>Предварительные требования
1. Подписка Azure. Для работы с этим учебником требуется учетная запись Azure. Вы можете активировать [преимущества подписчика MSDN](https://azure.microsoft.com/pricing/member-offers/credit-for-visual-studio-subscribers/?WT.mc_id=A85619ABF) или зарегистрироваться для получения [бесплатной учетной записи](https://azure.microsoft.com/free/?WT.mc_id=A85619ABF).
2. Следуйте инструкциям по [созданию очереди Служебной шины с помощью портала Azure](service-bus-quickstart-portal.md).
    1. Ознакомьтесь с **общими сведениями** об **очередях** Служебной шины. 
    2. Создайте **пространство имен** Служебной шины. 
    3. Получите **строку подключения**. 

        > [!NOTE]
        > В этом руководстве описано, как создать **очередь** в пространстве имен Служебной шины с помощью Ruby. 

[!INCLUDE [service-bus-ruby-setup](../../includes/service-bus-ruby-setup.md)]

## <a name="how-to-create-a-queue"></a>Как создать очередь
Объект **Azure::ServiceBusService** позволяет работать с очередями. Чтобы создать очередь, используйте метод `create_queue()`. В следующем примере создается очередь или выводится ошибка, если она возникла.

```ruby
azure_service_bus_service = Azure::ServiceBus::ServiceBusService.new(sb_host, { signer: signer})
begin
  queue = azure_service_bus_service.create_queue("test-queue")
rescue
  puts $!
end
```

Можно также передать объект **Azure::ServiceBus::Queue** с дополнительными параметрами, которые позволяют переопределить параметры очереди по умолчанию, например, срок жизни сообщения или максимальный размер очереди. В следующем примере показано, как установить максимальный размер очереди в 5 ГБ и срок жизни в 1 минуту.

```ruby
queue = Azure::ServiceBus::Queue.new("test-queue")
queue.max_size_in_megabytes = 5120
queue.default_message_time_to_live = "PT1M"

queue = azure_service_bus_service.create_queue(queue)
```

## <a name="how-to-send-messages-to-a-queue"></a>Как отправлять сообщения в очередь
Чтобы отправить сообщение в очередь служебной шины, приложение вызывает метод `send_queue_message()` для объекта **Azure::ServiceBusService**. Сообщения, отправленные из очередей служебной шины (и полученные из них) представляют собой объекты **Azure::ServiceBus::BrokeredMessage**. У них есть набор стандартных свойств (например, `label` и `time_to_live`), словарь, используемый для хранения настраиваемых свойств приложения, и текст произвольных данных приложения. Приложение может задать текст сообщения, передав строковое значение как сообщение, а все необходимые стандартные свойства заполняются значениями по умолчанию.

В следующем примере показано, как отправить тестовое сообщение в очередь с именем `test-queue` с помощью метода `send_queue_message()`:

```ruby
message = Azure::ServiceBus::BrokeredMessage.new("test queue message")
message.correlation_id = "test-correlation-id"
azure_service_bus_service.send_queue_message("test-queue", message)
```

Очереди служебной шины поддерживают максимальный размер сообщения 256 КБ для [уровня "Стандартный"](service-bus-premium-messaging.md) и 1 МБ для [уровня Premium](service-bus-premium-messaging.md). Максимальный размер заголовка, который содержит стандартные и настраиваемые свойства приложения, — 64 КБ. Ограничения на количество сообщений в очереди нет, но есть максимальный общий размер сообщений, содержащихся в очереди. Этот размер очереди, определяемый в момент ее создания, не должен превышать 5 ГБ.

## <a name="how-to-receive-messages-from-a-queue"></a>Как получать сообщения из очереди
Сообщения извлекаются из очереди с помощью метода `receive_queue_message()` для объекта **Azure::ServiceBusService**. По умолчанию сообщения считываются и блокируются без удаления из очереди. Но вы можете удалить сообщения из очереди после их чтения, установив для параметра `:peek_lock` значение **false**.

По умолчанию чтение и удаление выполняются в два этапа, что позволяет поддерживать приложения, не способные обрабатывать отсутствующие сообщения. Получив запрос, служебная шина находит следующее сообщение, блокирует его, чтобы предотвратить его получение другими получателями, и возвращает его приложению. Обработав сообщение (или сохранив его в надежном месте для последующей обработки), приложение вызывает метод `delete_queue_message()` и указывает сообщение, которое будет удалено как параметр, таким образом завершая второй этап процесса получения. Метод `delete_queue_message()` помечает сообщение как использованное и удаляет его из очереди.

Если параметр `:peek_lock` имеет значение **false**, чтение и удаление сообщения осуществляется очень просто. Этот метод оптимально подходит для сценариев, в которых приложение может допускать сбои обработки сообщения. Чтобы это понять, рассмотрим сценарий, в котором объект-получатель выдает запрос на получение и выходит из строя до его обработки. Так как служебная шина помечает сообщение как использованное, перезапущенное приложение, начав снова использовать сообщения, пропустит сообщение, использованное до аварийного завершения работы.

В следующем примере показано, как получать и обрабатывать сообщения с помощью метода `receive_queue_message()`. Сначала приложение получает и удаляет сообщение в примере с помощью параметра `:peek_lock`, для которого задано значение **false**, а затем получает другое сообщение и удаляет его с помощью метода `delete_queue_message()`.

```ruby
message = azure_service_bus_service.receive_queue_message("test-queue",
  { :peek_lock => false })
message = azure_service_bus_service.receive_queue_message("test-queue")
azure_service_bus_service.delete_queue_message(message)
```

## <a name="how-to-handle-application-crashes-and-unreadable-messages"></a>Как обрабатывать сбои приложения и нечитаемые сообщения
служебная шина предоставляет функции, помогающие корректно выполнить восстановление после ошибок в приложении или трудностей, возникших при обработке сообщения. Если по какой-либо причине приложению-получателю не удается обработать сообщение, оно вызывает метод `unlock_queue_message()` для объекта **Azure::ServiceBusService**. Этот вызов позволяет служебной шине разблокировать сообщение в очереди и сделать его доступным для приема тем же или другим приложением-пользователем.

Кроме того, с сообщением, блокированным в очереди, связано время ожидания. Если приложение не сможет обработать сообщение в течение времени ожидания (например, при сбое приложения), служебная шина автоматически разблокирует сообщение и снова сделает его доступным для получения.

Если в приложении происходит сбой после обработки сообщения, но перед вызовом метода `delete_queue_message()`, сообщение будет повторно доставлено в приложение после его перезапуска. Часто такой процесс называют *обработать хотя бы один раз*, т. е. каждое сообщение будет обрабатываться по крайней мере один раз, но в некоторых случаях это же сообщение может быть доставлено повторно. Если повторная обработка недопустима, разработчики приложения должны добавить дополнительную логику для обработки повторной доставки сообщений. Как правило, это достигается с помощью свойства `message_id` сообщения, которое остается постоянным для различных попыток доставки.

> [!NOTE]
> Вы можете управлять ресурсами служебной шины с помощью [обозревателя служебной шины](https://github.com/paolosalvatori/ServiceBusExplorer/). Обозреватель служебной шины позволяет без труда подключаться к пространству имен служебной шины и управлять сущностями обмена сообщениями. Средство предоставляет дополнительные возможности, например функции импорта и экспорта или возможность проверять разделы, очереди, подписки, службы ретрансляции, центры уведомлений и концентраторы событий. 

## <a name="next-steps"></a>Дальнейшие действия
Вы узнали основные сведения об очередях служебной шины. Для получения дополнительных сведений используйте следующие ссылки.

* Обзор [очередей, разделов и подписок](service-bus-queues-topics-subscriptions.md).
* Посетите репозиторий [Azure SDK для Ruby](https://github.com/Azure/azure-sdk-for-ruby) на веб-сайте GitHub.

Сравнение очередей служебной шины Azure, описанных в этой статье, и очередей служебной шины Azure, описанных в статье [Использование хранилища очередей из Ruby](../storage/queues/storage-ruby-how-to-use-queue-storage.md), см. в статье [Очереди Azure и очереди служебной шины: сходства и различия](service-bus-azure-and-service-bus-queues-compared-contrasted.md).

