---
title: Создание секционированных очередей и разделов служебной шины Azure | Документация Майкрософт
description: В этой статье описывается, как секционировать очереди и разделы служебной шины с помощью нескольких брокеров сообщений.
ms.topic: article
ms.date: 06/23/2020
ms.custom: devx-track-csharp
ms.openlocfilehash: 9c500a69f853b11437a0dcaa48213fe3a84da53b
ms.sourcegitcommit: ab829133ee7f024f9364cd731e9b14edbe96b496
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/28/2020
ms.locfileid: "97796641"
---
# <a name="partitioned-queues-and-topics"></a>Секционированные очереди и разделы

Служебная шина Azure использует несколько посредников сообщений для обработки сообщений и несколько хранилищ сообщений для их хранения. Обычная очередь или раздел обрабатываются одним брокером сообщений и сохраняются в одном хранилище сообщений. *Секции* служебной шины позволяют секционировать очереди, разделы или *сущности обмена сообщениями* между несколькими брокерами сообщений и хранилищами сообщений. Секционирование означает, что общая пропускная способность секционированной сущности больше не ограничивается производительностью одного брокера сообщений или хранилища сообщений. Кроме того, при возникновении временного сбоя хранилища сообщений секционированная очередь или раздел останутся доступными. Секционированные очереди и разделы могут предоставлять все расширенные функции служебной шины, в том числе поддержку транзакций и сеансов.

> [!NOTE]
> Секционирование доступно при создании сущности для всех очередей и разделов для номеров SKU уровня "Базовый" или "Стандартный". Оно недоступно для номера SKU для обмена сообщениями уровня "Премиум", но любые ранее существовавшие секционированные сущности в пространствах имен уровня "Премиум" будут работать должным образом.
 
Параметр секционирования для имеющейся очереди или раздела изменить невозможно. Его можно задать только при создании сущности.

## <a name="how-it-works"></a>Принцип работы

Каждая секционированная очередь или раздел состоит из нескольких секций. Каждая секция хранится в другом хранилище сообщений и обрабатывается другим брокером сообщений. При отправке сообщения в секционированную очередь или раздел служебная шина назначает сообщение одной из секций. Выбор фрагмента осуществляется произвольно или по ключу секции, который может указать отправитель.

Когда клиент хочет получить сообщение из секционированной очереди или из подписки на секционированный раздел, служебная шина запрашивает все секции для сообщений, а затем возвращает первое сообщение, полученное от любого хранилища сообщений получателю. Служебная шина кэширует другие сообщения и возвращает их при получении дополнительных запросов. Клиент ничего не знает о секционировании, для него поведение секционированных очередей или разделов (например, чтение, завершение, откладывание, недоставление или предварительная выборка) аналогично поведению обычной сущности.

Операция просмотра в несекционированной сущности всегда возвращает самое старое сообщение, но не для секционированной сущности. Вместо этого он возвращает самое старое сообщение в одной из секций, чей брокер сообщений ответил первым. Нет никакой гарантии, что возвращенное сообщение является самым старым по всем секциям. 

При отправке или получении сообщения из секционированной очереди или раздела не возникает никаких дополнительных затрат.

> [!NOTE]
> Операция считывания Возвращает самое старое сообщение из секции на основе его порядкового номера. Для секционированных сущностей порядковый номер выдается в соответствии с секцией. Дополнительные сведения см. в разделе [последовательность сообщений и метки времени](../service-bus-messaging/message-sequencing.md).

## <a name="enable-partitioning"></a>Включение секционирования

Чтобы применять секционированные очереди и разделы в службе "Служебная шина Azure", используйте пакет SDK для Azure 2.2 или более поздней версии либо укажите `api-version=2013-10` или более позднюю версию в HTTP-запросах.

### <a name="standard"></a>Стандартный

На уровне обмена сообщениями "Стандартный" можно создавать очереди и разделы служебной шины размером в 1, 2, 3, 4 или 5 ГБ (по умолчанию — 1 ГБ). Если секционирование включено, служебная шина создает 16 копий (16 секций) сущности, каждый из которых указан в одном и том же размере. Поэтому при создании очереди размером 5 ГБ с 16 разделами максимальный размер очереди составит 80 ГБ (5 \* 16). Чтобы просмотреть максимальный размер секционированной очереди или раздела, откройте соответствующую запись на [портале Azure][Azure portal] в колонке **Обзор** для этой сущности.

### <a name="premium"></a>Premium

В пространстве имен уровня "Премиум" сущности секционирования не поддерживаются. Однако все еще можно создать разделы служебной шины размером в 1, 2, 3, 4, 5, 10, 20, 40 или 80 ГБ (по умолчанию — 1 ГБ). Чтобы просмотреть размер очереди или раздела, откройте соответствующую запись на [портале Azure][Azure portal] в колонке **Обзор** для этой сущности.

### <a name="create-a-partitioned-entity"></a>Создание секционированной сущности

Создать секционированную очередь или раздел можно несколькими способами. При создании очереди или раздела из приложения можно включить секционирование очереди или раздела, задав значение **true** для свойства [QueueDescription.EnablePartitioning][QueueDescription.EnablePartitioning] или [TopicDescription.EnablePartitioning][TopicDescription.EnablePartitioning], соответственно. Эти свойства должны задаваться во время создания очереди или раздела и доступны только в более старых версиях библиотеки [WindowsAzure.ServiceBus](https://www.nuget.org/packages/WindowsAzure.ServiceBus/). Как упоминалось ранее, для имеющийся очереди или раздела изменить эти свойства невозможно. Пример:

```csharp
// Create partitioned topic
NamespaceManager ns = NamespaceManager.CreateFromConnectionString(myConnectionString);
TopicDescription td = new TopicDescription(TopicName);
td.EnablePartitioning = true;
ns.CreateTopic(td);
```

Кроме того, секционированную очередь или раздел можно создать на [портале Azure][Azure portal]. Когда вы создаете очередь или раздел, на портале по умолчанию установлен флажок **Включить секционирование** в диалоговом окне **Создать**. Этот параметр можно отключить только в сущности уровня "Стандартный". Секционирование на уровне "Премиум" не поддерживается, и этот флажок не работает. 

## <a name="use-of-partition-keys"></a>Использование ключей секции

Когда сообщение добавляется в секционированную очередь или раздел, служебная шина проверяет наличие ключа секции. Если он найден, он выбирает секцию на основе этого ключа. Если ключ секции не найден, он выбирает секцию на основе внутреннего алгоритма.

### <a name="using-a-partition-key"></a>Использование ключа секции

В некоторых сценариях, например в сеансах или транзакциях, сообщения должны храниться в определенной секции. Для всех этих сценариев необходимо использовать ключ секции. Все сообщения, использующие один и тот же ключ раздела, назначаются одной секции. Если раздел временно недоступен, служебная шина возвращает ошибку.

В зависимости от сценария в качестве ключа секции используются разные свойства сообщения:

**SessionId**. Если для сообщения установлено свойство [SessionId](/dotnet/api/microsoft.azure.servicebus.message.sessionid), то служебная шина использует свойство **SessionID** в качестве ключа секции. Таким образом, все сообщения, которые относятся к одному сеансу, обрабатываются одним и тем же посредником сообщений. Сеансы позволяют служебной шине гарантировать порядок сообщений и согласованность состояний сеансов.

**PartitionKey**. Если для сообщения установлено свойство [PartitionKey](/dotnet/api/microsoft.azure.servicebus.message.partitionkey), но не установлено свойство [SessionId](/dotnet/api/microsoft.azure.servicebus.message.sessionid), то служебная шина использует значение свойства [PartitionKey](/dotnet/api/microsoft.azure.servicebus.message.partitionkey) в качестве ключа секции. Если для сообщения установлены оба свойства [SessionId](/dotnet/api/microsoft.azure.servicebus.message.sessionid) и [PartitionKey](/dotnet/api/microsoft.azure.servicebus.message.partitionkey), то их значения должны совпадать. Если значение свойства [PartitionKey](/dotnet/api/microsoft.azure.servicebus.message.partitionkey) отличается от значения свойства [SessionId](/dotnet/api/microsoft.azure.servicebus.message.sessionid), служебная шина возвращает исключение недопустимой операции. Свойство [PartitionKey](/dotnet/api/microsoft.azure.servicebus.message.partitionkey) нужно использовать, если отправитель отправляет транзакционные сообщения без учета сеансов. Ключ секции гарантирует, что все сообщения, отправленные в транзакции, будут обработаны одним и тем же посредником сообщений.

**MessageId**. Если для свойства [RequiresDuplicateDetection](/dotnet/api/microsoft.azure.management.servicebus.models.sbqueue.requiresduplicatedetection) очереди или раздела задано значение **true**, а свойства [SessionId](/dotnet/api/microsoft.azure.servicebus.message.sessionid) или [PartitionKey](/dotnet/api/microsoft.azure.servicebus.message.partitionkey) не заданы, то в качестве ключа секции выступает значение свойства [MessageId](/dotnet/api/microsoft.azure.servicebus.message.messageid). (Библиотеки Microsoft .NET и AMQP автоматически присваивают идентификатор сообщения, если в отправляющем приложении нет.) В этом случае все копии одного и того же сообщения обрабатываются одним и тем же посредником сообщений. Этот идентификатор позволяет служебной шине находить и исключать повторяющиеся сообщения. Если свойство [RequiresDuplicateDetection](/dotnet/api/microsoft.azure.management.servicebus.models.sbqueue.requiresduplicatedetection) не установлено в значение **true**, служебная шина не рассматривает свойство [MessageId](/dotnet/api/microsoft.azure.servicebus.message.messageid) в качестве ключа секции.

### <a name="not-using-a-partition-key"></a>Неиспользование ключа секции

В отсутствие ключа секции служебная шина распределяет сообщения циклическим образом во все разделы секционированной очереди или раздела. Если выбранная Секция недоступна, служебная шина назначает сообщение другой секции. Таким образом, операция отправки выполняется даже при временной недоступности хранилища сообщений. Тем не менее вы не получите гарантированного количества, обеспечиваемого ключом раздела.

Более подробно компромисс между доступностью (нет ключа раздела) и целостностью (с использованием ключа раздела) рассматривается [в этой статье](../event-hubs/event-hubs-availability-and-consistency.md). Эта информация также применима к секционированным сущностям службы "Служебная шина".

Чтобы предоставить служебной шине достаточно времени для постановки сообщения в очередь в другую секцию, значение [OperationTimeout](/dotnet/api/microsoft.azure.servicebus.queueclient.operationtimeout) , указанное клиентом, который отправляет сообщение, должно быть больше 15 секунд. Рекомендуется установить свойство [OperationTimeout](/dotnet/api/microsoft.azure.servicebus.queueclient.operationtimeout) в значение по умолчанию 60 секунд.

Ключ секции "закрепляет" сообщение в указанную секцию. Если хранилище сообщений, в котором находится этот раздел, недоступно, служебная шина возвращает ошибку. При отсутствии ключа секции служебная шина может выбрать другую секцию, и операция будет выполнена. Поэтому рекомендуется не указывать ключ раздела, если он не является обязательным.

## <a name="advanced-topics-use-transactions-with-partitioned-entities"></a>Дополнительные разделы: использование транзакций и секционированных сущностей

Сообщения, отправленные в рамках транзакции, должны указать ключ секции. Ключ может принимать одно из следующих свойств: [SessionId](/dotnet/api/microsoft.azure.servicebus.message.sessionid), [PartitionKey](/dotnet/api/microsoft.azure.servicebus.message.partitionkey) или [MessageId](/dotnet/api/microsoft.azure.servicebus.message.messageid). Сообщения, отправляемые в рамках одной транзакции, должны иметь один и тот же ключ секции. При попытке отправить сообщение без ключа секции в рамках транзакции служебная шина возвращает исключение недопустимой операции. При попытке отправить несколько сообщений с различными ключами секции в рамках одной транзакции служебная шина возвращает исключение недопустимой операции. Пример:

```csharp
CommittableTransaction committableTransaction = new CommittableTransaction();
using (TransactionScope ts = new TransactionScope(committableTransaction))
{
    Message msg = new Message("This is a message");
    msg.PartitionKey = "myPartitionKey";
    await messageSender.SendAsync(msg); 
    await ts.CompleteAsync();
}
committableTransaction.Commit();
```

Если заданы какие-либо свойства, которые используются в качестве ключа секции, служебная шина закрепляет сообщение в определенной секции. Это происходит независимо от того, используется ли транзакция. Рекомендуется не указывать ключ секции, если в этом нет необходимости.

## <a name="using-sessions-with-partitioned-entities"></a>Использование сеансов и секционированных сущностей

Чтобы отправить транзакционное сообщение в раздел или очередь, учитывающие сеансы, для этого сообщения должно быть задано свойство [SessionId](/dotnet/api/microsoft.azure.servicebus.message.sessionid). Если также установлено свойство [PartitionKey](/dotnet/api/microsoft.azure.servicebus.message.partitionkey), оно должно быть идентично свойству [SessionId](/dotnet/api/microsoft.azure.servicebus.message.sessionid). Если они различаются, служебная шина возвращает исключение недопустимой операции.

В отличие от обычных (несекционированных) очередей и разделов, использовать одну транзакцию для отправки нескольких сообщений в различные сеансы невозможно. Если же попытаться это сделать, служебная шина возвращает исключение недопустимой операции. Пример:

```csharp
CommittableTransaction committableTransaction = new CommittableTransaction();
using (TransactionScope ts = new TransactionScope(committableTransaction))
{
    Message msg = new Message("This is a message");
    msg.SessionId = "mySession";
    await messageSender.SendAsync(msg); 
    await ts.CompleteAsync();
}
committableTransaction.Commit();
```

## <a name="automatic-message-forwarding-with-partitioned-entities"></a>Автоматическая переадресация сообщений для секционированных сущностей

Служебная шина поддерживает автоматическую переадресацию сообщений в секционированные сущности, из них или между ними. Чтобы включить автоматическую переадресацию сообщений, установите свойство [QueueDescription.ForwardTo][QueueDescription.ForwardTo] исходной очереди или подписки. Если в сообщении указан ключ секции ([SessionId](/dotnet/api/microsoft.azure.servicebus.message.sessionid), [PartitionKey](/dotnet/api/microsoft.azure.servicebus.message.partitionkey) или [MessageId](/dotnet/api/microsoft.azure.servicebus.message.messageid)), то этот ключ секции используется для сущности назначения.

## <a name="considerations-and-guidelines"></a>Рекомендации и советы
* **Функции высокой согласованности**: Если сущность использует такие функции, как сеансы, обнаружение дубликатов или явное управление ключом секционирования, то операции обмена сообщениями всегда направляются в определенную секцию. Если какой-либо из разделов работает с большим объемом трафика или базовым хранилищем является неработоспособным, эти операции завершаются сбоем, и доступ уменьшается. В целом уровень согласованности гораздо выше, чем при использовании несекционированных сущностей, поэтому проблемы возникают лишь в некоторой части трафика. Дополнительные сведения см. в этом [обсуждении доступности и целостности](../event-hubs/event-hubs-availability-and-consistency.md).
* **Управление**: операции создания, обновления и удаления должны выполняться во всех секциях сущности. Если какая-либо из секций неработоспособна, это может привести к сбоям при выполнении этих операций. Для операции Get такие сведения, как количество сообщений, должны быть объединены из всех секций. Если какая-либо из секций неработоспособна, состояние доступности сущности указывается как ограниченное.
* **Сообщения небольших объемов**. Чтобы получить все сообщения в таких сценариях, особенно при использовании протокола HTTP, может потребоваться выполнить несколько операций получения. Для запросов Receive внешний интерфейс выполняет получение по всем секциям и кэширует все полученные ответы. Это кэширование повышает производительность последующего запроса на получение при том же подключении, уменьшая задержки получения. Тем не менее при наличии нескольких подключений или использовании протокола HTTP для каждого запроса устанавливается новое подключение. Таким образом, нет никакой гарантии, что запрос будет выполняться на том же узле. Если все имеющиеся сообщения блокируются и кэшируются в другом внешнем интерфейсе, операция получения возвращает значение **NULL**. Когда в конечном итоге срок действия сообщений истекает, их снова можно получать. Рекомендуется выполнить проверку активности HTTP. При использовании секционирования в сценариях с низким объемом действия операции Receive могут занимать больше времени, чем ожидалось. Поэтому в этих сценариях рекомендуется не использовать секционирование. Удалите все существующие секционированные сущности и повторно создайте их с отключенным секционированием для повышения производительности.
* **Обзор и просмотр сообщений**. Доступен только в более старой версии библиотеки [WindowsAzure.ServiceBus](https://www.nuget.org/packages/WindowsAzure.ServiceBus/). Метод [PeekBatch](/dotnet/api/microsoft.servicebus.messaging.queueclient.peekbatch) не всегда возвращает количество сообщений, указанное в свойстве [MessageCount](/dotnet/api/microsoft.servicebus.messaging.queuedescription.messagecount). На это есть две распространенные причины. Первая причина — общий размер коллекции сообщений превышает максимальное значение в 256 КБ. Вторая причина заключается в том, что если для [свойства EnablePartitioning](/dotnet/api/microsoft.servicebus.messaging.queuedescription.enablepartitioning) очереди или раздела задано значение **true**, то секция может содержать недостаточно сообщений для выполнения запроса. Как правило, если приложению требуется получить определенное количество сообщений, оно должно вызывать метод [PeekBatch](/dotnet/api/microsoft.servicebus.messaging.queueclient.peekbatch), пока не получит желаемое количество сообщений или пока не закончатся сообщения, которые можно просмотреть. Дополнительные сведения, включая примеры кода, см. в документах по API [QueueClient.PeekBatch](/dotnet/api/microsoft.servicebus.messaging.queueclient.peekbatch) или [SubscriptionClient.PeekBatch](/dotnet/api/microsoft.servicebus.messaging.subscriptionclient.peekbatch).

## <a name="latest-added-features"></a>Новые функции

* Теперь для секционированных сущностей поддерживаются операции добавления и удаления правила. В отличие от несекционированных сущностей эти операции не поддерживаются при выполнении транзакций. 
* Теперь AMQP может использоваться для обмена сообщениями (отправка и получение) с секционированными сущностями.
* Теперь протокол AMQP поддерживается для следующих операций: [пакетная отправка](/dotnet/api/microsoft.servicebus.messaging.queueclient.sendbatch), [пакетное получение](/dotnet/api/microsoft.servicebus.messaging.queueclient.receivebatch), [получение по порядковому номеру](/dotnet/api/microsoft.servicebus.messaging.queueclient.receive), [обзор](/dotnet/api/microsoft.servicebus.messaging.queueclient.peek), [блокировка обновления](/dotnet/api/microsoft.servicebus.messaging.queueclient.renewmessagelock), [планирование сообщений](/dotnet/api/microsoft.azure.servicebus.queueclient.schedulemessageasync), [отмена запланированных сообщений](/dotnet/api/microsoft.azure.servicebus.queueclient.cancelscheduledmessageasync), [добавление правила](/dotnet/api/microsoft.azure.servicebus.ruledescription), [удаление правила](/dotnet/api/microsoft.azure.servicebus.ruledescription), [блокировка обновления сеанса](/dotnet/api/microsoft.servicebus.messaging.messagesession.renewlock), [установка состояния сеанса](/dotnet/api/microsoft.servicebus.messaging.messagesession.setstate), [получение состояния сеанса](/dotnet/api/microsoft.servicebus.messaging.messagesession.getstate) и [перечисление сеансов](/dotnet/api/microsoft.servicebus.messaging.queueclient.getmessagesessions).

## <a name="partitioned-entities-limitations"></a>Ограничения секционированных сущностей

В настоящее время служебная шина накладывает следующие ограничения на секционированные очереди и разделы:

* Секционированные очереди и разделы не поддерживаются в службе сообщений уровня "Премиум". Сеансы поддерживаются в ценовой категории "Премиум" с помощью SessionId. 
* Секционированные очереди и разделы не поддерживают отправку сообщений, принадлежащих разным сеансам, в одной транзакции.
* В настоящее время служебная шина обеспечивает до 100 секционированных очередей или разделов на пространство имен. Каждая секционированная очередь или раздел учитывается в квоте в 10 000 сущностей на пространство имен (не относится к уровню "Премиум").

## <a name="next-steps"></a>Дальнейшие действия

Ознакомьтесь с основными понятиями спецификации для обмена сообщениями AMQP 1.0 в [руководстве по протоколу AMQP 1.0](service-bus-amqp-protocol-guide.md).

[Azure portal]: https://portal.azure.com
[QueueDescription.EnablePartitioning]: /dotnet/api/microsoft.servicebus.messaging.queuedescription.enablepartitioning
[TopicDescription.EnablePartitioning]: /dotnet/api/microsoft.servicebus.messaging.topicdescription.enablepartitioning
[QueueDescription.ForwardTo]: /dotnet/api/microsoft.servicebus.messaging.queuedescription.forwardto
[AMQP 1.0 support for Service Bus partitioned queues and topics]: ./service-bus-amqp-protocol-guide.md
