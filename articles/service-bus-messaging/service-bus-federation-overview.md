---
title: Репликация сообщений и Федерация между регионами — служебная шина Azure | Документация Майкрософт
description: В этой статье представлен обзор репликации событий и Федерации между регионами с помощью служебной шины Azure.
ms.topic: article
ms.date: 12/12/2020
ms.openlocfilehash: e47f633fcd9248eab6f47936aa7c45877decc1fe
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "98880833"
---
# <a name="message-replication-and-cross-region-federation"></a>Репликация сообщений и федерация между регионами

В пространствах имен служебная шина Azure поддерживает [Создание топологий цепочек очередей и подписок разделов с помощью функции перемотки](service-bus-auto-forwarding.md) , что позволяет реализовать различные шаблоны маршрутизации. Например, можно предоставить партнерам выделенные очереди, для которых у них есть разрешения на отправку или получение и которые можно временно приостановить при необходимости, и гибко подключать их к другим сущностям, которые являются частными для приложения. Кроме того, можно создавать сложные топологии многоэтапной маршрутизации или создавать очереди в стиле почтовых ящиков, которые пропускают подписки на очереди разделов и обеспечивают дополнительную емкость хранилища на каждого подписчика. 

Во многих сложных решениях также требуется реплицировать сообщения между границами пространства имен для реализации этих и других шаблонов. Сообщения могут передаваться между пространствами имен, связанными с несколькими клиентами приложений, или несколькими разными регионами Azure. 

Решение будет поддерживать несколько пространств имен служебной шины в разных регионах и реплицировать сообщения между очередями и разделами и (или) обмениваться сообщениями с источниками и целями, такими как [концентраторы событий Azure](../event-hubs/event-hubs-about.md), [центр Интернета вещей Azure](../iot-fundamentals/iot-introduction.md)или [Apache Kafka](https://kafka.apache.org). 

Эти сценарии касаются этой статьи. 

## <a name="federation-patterns"></a>Шаблоны Федерации

Существует множество потенциальных причин, по которым может потребоваться переместить сообщения между сущностями служебной шины, например очередями или разделами или между служебной шиной и другими источниками и целями. 

По сравнению с аналогичным набором шаблонов для [концентраторов событий](../service-bus-messaging/service-bus-federation-overview.md), Федерация для сущностей, подобных очередям, сложнее, так как очереди сообщений представляют своим потребителям монопольный доступ к любому отдельному сообщению, должны сохранять порядок поступления в доставку сообщений и, чтобы брокер мог координировать равномерное распределение сообщений между [конкурирующими потребителями](/azure/architecture/patterns/competing-consumers). 

Существуют практические препятствия, в том числе ограничения [теоремаа Cap](https://en.wikipedia.org/wiki/CAP_theorem), которые затрудняют предоставление унифицированного представления очереди, которая одновременно доступна в нескольких регионах, и что позволяет выполнять распределенное распределение по регионам, [конкурирующим потребителям](/azure/architecture/patterns/competing-consumers) принимать монопольное владение сообщениями. Для такой геораспределенной очереди потребуется полностью последовательная репликация не только сообщений, но и состояние доставки каждого сообщения, прежде чем сообщения можно будет сделать доступными для потребителей. Цель полной согласованности для гипотетических, распределенных по регионам очередей заключается в прямом конфликте с ключевой целью, которую практически все клиенты служебной шины Azure могут учитывать при рассмотрении сценариев Федерации: максимальная доступность и надежность для своих решений. 

Приведенные здесь шаблоны позволяют сосредоточиться на доступности и надежности, а также надежде, чтобы лучше избежать потери информации и дублирования обработки сообщений. 

### <a name="resiliency-against-regional-availability-events"></a>Устойчивость к событиям региональной доступности 

Хотя максимальная доступность и надежность являются основными рабочими приоритетами для служебной шины, существует множество способов, с помощью которых производитель или потребитель может не обращаться к назначенной "основной" служебной шине из-за проблем с сетью или разрешением имен, или когда сущность служебной шины может быть временно недоступна или возвращать ошибки. Назначенный обработчик сообщений также может стать недоступным.

Такие условия не являются «катастрофами», так что вы хотите полностью отказаться от региона в случае аварийного восстановления, но бизнес-сценарий некоторых приложений может уже повлиять на события доступности, которые находятся в течение нескольких минут или даже секунд. Служебная шина Azure часто используется в гибридных облачных средах и с клиентами, расположенными на границе сети, например в розничных магазинах, ресторане, банковских ветвях, производственных площадках, логистиках и аэропортах. Сетевая маршрутизация или перегрузка может повлиять на способность одного узла обращаться к назначенной конечной точке служебной шины, пока вторичная конечная точка в другом регионе будет доступна. В то же время системные процессы, поступающие от этих сайтов, могут по-прежнему иметь неограниченный доступ к основным и дополнительным конечным точкам служебной шины. 

Существует множество практических примеров таких гибридных облачных и пограничных приложений с низкой допустимостью для бизнеса в отношении проблем с маршрутизацией сети или временных проблем доступности сущности служебной шины. К ним относятся обработка платежей на веб-узлах розничной торговли, плата в аэропорту Гейтс и заказы на мобильные телефоны в рестораны, все из которых приходятся на мгновение, и полная стандстилл, когда надежный путь обмена данными недоступен.

В этой категории обсуждаются три различных распределенных шаблона: "все — активная" репликация, "Активная-пассивная" Репликация и "переброски" репликация. 

#### <a name="all-active-replication"></a>Репликация All-Active

Шаблон репликации "все-активные" позволяет использовать активную реплику того же логического раздела (или очереди) в нескольких пространствах имен (и регионах), а также для того, чтобы все сообщения стали доступны во всех репликах независимо от того, где они были поставлены в очередь. Обычно шаблон сохраняет порядок сообщений относительно любого издателя. 

![Весь активный шаблон](media/service-bus-federation-overview/mirrored-topics.jpg)

Как показано на рисунке, шаблон обычно является экономичным в разделах служебной шины. Один раздел для каждого пространства имен, которое должно участвовать в схеме репликации. В каждом из этих разделов имеется одна подписка на репликацию для любого из других разделов, на которые должны реплицироваться сообщения. На рисунке выше у нас просто есть пара разделов и, следовательно, одна подписка на репликацию для соответствующего раздела. В сценарии с тремя пространствами имен *{N1, N2, N3}* раздел в пространстве имен *N1* будет иметь две подписки репликации: одна для соответствующего раздела в *N2* , а другая — для соответствующего раздела в *N3*. 

Каждая подписка репликации имеет правило, объединяющее выражение фильтра SQL ( `replicated <> 1` ) и действие SQL ( `set replicated = 1` ). Фильтр Правила гарантирует, что только сообщения, в которых пользовательское свойство `replication` не задано или не имеют значения `1` , станут допустимыми для этой подписки, и действие задает конкретное свойство значению для `1` каждого выбранного сообщения сразу после этого. В результате, когда сообщение копируется в соответствующий раздел, оно больше не подходит для репликации в обратном направлении, поэтому мы не можем переключать сообщения между репликами.

Подписку с соответствующим правилом можно легко добавить в любой раздел с помощью Azure CLI подобного.

```azurecli

az servicebus topic subscription rule create --resource-group myresourcegroup \
   --namespace mynamespace --topic-name mytopic 
   --subscription-name replication --name replication \
   --action-sql-expression "set replication = 1" \
   --filter-sql-expression "replication IS NULL"
```

Для моделирования очереди каждый раздел ограничен только одной обычной подпиской (отличной от подписок репликации), которые совместно используют все потребители.

> Модель «все-активная репликация» помещает копию каждого сообщения, отправленного в любой раздел, в каждый из разделов. Это означает, что код приложения в каждом регионе будет видеть и обрабатывать все сообщения.
> Этот шаблон подходит для сценариев, в которых данные совместно используются в нескольких регионах или если обычно требуется избыточная обработка. Если необходимо обработать каждое сообщение только один раз, как в случае обычной очереди, необходимо принять во внимание один из следующих двух шаблонов.  

#### <a name="active-passive-replication"></a>Репликация Active-Passive

Шаблон репликации "активный-пассивный" является разновидностью более ранней модели, где только один из разделов ("основной") активно используется приложением для отправки и получения сообщений, а сообщения реплицируются в дополнительный раздел в случае, если основной раздел может стать недоступным или недоступным. 

![Активный пассивный шаблон](media/service-bus-federation-overview/mirrored-topics-passive.jpg)

Основное различие между этим шаблоном и предыдущей моделью состоит в том, что репликация является однонаправленной от основной темы во вторичный раздел. Вторичный раздел никогда не становится первичным, но является параметром резервного копирования, когда основной раздел временно непригоден для использования. 

Переворачивание этого шаблона заключается в том, что он пытается свести к минимуму обработку дубликатов. Во время репликации `TimeToLive` свойству Message задается длительность в реплицированных сообщениях, которая отражает ожидаемое время, в течение которого сбой источника приведет к отработке отказа. Например, если сценарий варианта использования требует переключения потребителя на вторичную часть в течение не более 1 минуты при извлечении сообщений с первичного начала, то в идеале в идеальном случае все сообщения, к которым не удалось получить доступ в базе данных-источнике, будут доступны, но минимальное количество сообщений, которые уже были обработаны в основном, до появления проблем. Если установить значение в `TimeToLive` два раза в течение этого периода, 2 минуты, во время репликации ( `set sys.TimeToLive = '0:2:0'` в действии правила), получатель будет хранить только сообщения в течение 2 минут и удалит старые. Это означает, что когда получатель переключается на вторичный, он может быстро считывать и отбрасывать сообщения, которые старше последнего обработанного, а затем обрабатывать первое сообщение, которое еще не встречалось. Фактическое время хранения будет зависеть от конкретного варианта использования, и вы сможете быстро переключиться на базу данных-получатель в приложении. Параметр учитывается `TimeToLive` в диапазоне от нескольких секунд до дней. 

Хотя приложение использует вторичную базу, оно также может публиковаться непосредственно во вторичном разделе, который затем действует как любой обычный раздел. После переключения на базу данных-получатель потребитель увидит сочетание реплицированных сообщений и сообщений, опубликованных непосредственно на сервере-получателе. Поэтому приложение должно сначала переключить публикацию на основной сервер и разрешить сток локально опубликованных сообщений перед переключением потребителя обратно на сервер-получатель. Из-за того, что репликация будет автоматически возобновлена после повторного доступа к первичной реплике, потребитель также будет получать новые сообщения, опубликованные в первичном периоде, хотя с некоторой задержкой. 

> Этот шаблон подходит для сценариев, в которых сообщения должны обрабатываться только один раз. Приложение должно сотрудничать с отслеживанием сообщений, обработанных из базы данных-источника, так как он найдет дубликаты в течение периода отработки отказа в базе данных-получателе и снова обнаружит дубликаты при переключении обратно.
> В качестве критерия отмены дублирования лучше использовать предоставляемое приложением Приложение `MessageId` . `EnqueuedTimeUtc`Это значение также подходит в качестве индикатора водяного знака, но приложение должно разрешить некоторое количество часов (несколько секунд) между первичной и вторичной системами, как и в любой распределенной системе.


#### <a name="spillover-replication"></a>Репликация переброски

Шаблон репликации "переброски" позволяет активному или активному использованию нескольких сущностей служебной шины в нескольких регионах работать с сценарием, в котором служебная шина работоспособна, но *потребитель* становится слишком большим, чем количество ожидающих сообщений или недоступно. Причиной может быть то, что база данных, в которой выполняется резервное копирование, может быть слишком высокой или недоступной. Этот шаблон работает с обычными очередями и с подписками разделов.  

![Репликация переброски](media/service-bus-federation-overview/spillover.jpg)  

Как показано на рисунке, шаблон репликации переброски реплицирует сообщения из [очереди недоставленных](service-bus-dead-letter-queues.md) сообщений очереди или подписке в связанную очередь или раздел в другом пространстве имен. 

Без ситуации, когда происходит сбой, два пространства имен используются параллельно, каждый из которых получает некоторую часть общего трафика сообщений и связанных с ними потребителей, обрабатывающих это подмножество. Когда один из потребителей начинает работать с высокой частотой сбоев или останавливается вправо, соответствующие сообщения будут находиться в очереди недоставленных сообщений либо через превышение числа доставок, либо из-за истечения срока действия. Затем задачи репликации выбирают их и повторно поставят в очередь в парной очереди, где они затем представляются предполагаемому работоспособному потребителю. 

Если обработка должна выполняться в пределах определенного крайнего срока, то `TimeToLive` для очереди и (или) сообщений должно быть задано, что обработка может произойти в течение времени с помощью вторичной базы данных переброски. Например, для экземпляра `TimeToLive` может быть задана половина допустимого времени.

Как и в случае с [шаблоном «все-активный](#all-active-replication)», приложение может добавить к сообщению индикатор, если сообщение уже было реплицировано по мере того, что оно не помещается между парой очередей, а просто помещена во вспомогательную очередь, которая выступает в качестве очереди недоставленных сообщений для составного шаблона.

> Этот шаблон подходит для сценариев, в которых важнейшим фактором является защита от проблем с доступностью в потребителях или ресурсах, на которых полагаются потребители, а также повторное распространение пиков трафика в одной из связанных очередей. Кроме того, защита от одного из пространств имен становится недоступной, если потребители считываются из обеих очередей, но задержка репликации, накладываемая `TimeToLive` истечением срока действия, может привести к тому, что сообщения в этом временном окне могут быть вызваны в недоступном пространстве имен. 

### <a name="latency-optimization"></a>Оптимизация задержки 

Разделы используются для распространения сведений нескольким потребителям. В некоторых случаях, особенно для потребителей с широким географическим распределением, может быть полезно реплицировать сообщения из раздела в раздел дополнительного пространства имен, расположенный ближе к потребителям.

![Оптимизация задержки](media/service-bus-federation-overview/latency-optimization.jpg)  

Например, при совместном использовании данных между региональными континентальной частиыми центрами более эффективно передавать данные между концентраторами и получать копии данных от этих концентраторов потребителями. 

Передача репликации может выполняться пакетами, что позволяет клиентам часто получать и сопоставлять сообщения по одному. При базовой сетевой задержке 100 мс между, скажем, Северная Америка и Европы, каждое сообщение занимает 200 мс для обработки двух обращений к удаленной сущности для получения и сопоставления сообщений по сравнению с сущностью в том же регионе. 

### <a name="validation-reduction-and-enrichment"></a>Проверка, сокращение и обогащение

Сообщения могут быть отправлены в очередь или раздел служебной шины клиентами, которые являются внешними для вашего решения.

![Проверка, сокращение, обогащение](media/service-bus-federation-overview/validation.jpg)  

Такие сообщения могут требовать проверки соответствия данной схеме, а для несоответствующих сообщений — удалять или относиться от недоставленных. Некоторые сообщения могут быть снижены по сложности путем пропуска данных, а некоторые могут быть дополнены путем добавления данных на основе уточняющих запросов ссылочных данных. Операции могут выполняться с пользовательскими функциональными возможностями в задаче репликации. 

### <a name="stream-to-queue-replication"></a>Поток для репликации в очередь

Концентраторы событий Azure — это идеальное решение для обработки крайних объемов входящих событий. Но ни концентраторы событий, ни аналогичные модули, такие как Apache Kafka, предоставляют модель [конкурирующих потребителей](/azure/architecture/patterns/competing-consumers) под управлением службы, где несколько потребителей могут обрабатывать сообщения из одного и того же источника одновременно, не рискуя дублирование обработки и, наконец, сопоставлять эти сообщения после их обработки. 

![Интеграция](media/service-bus-federation-overview/hub-to-queue.jpg)

Поток для репликации в очередь передает содержимое одной секции концентратора событий или содержимого полного концентратора событий в очередь служебной шины, откуда сообщения могут быть безопасно обработаны, транзакционными и с конкурирующими потребителями. Эта репликация также позволяет использовать все остальные возможности служебной шины для этих сообщений, включая маршрутизацию с разделами и демультиплексированием на основе сеансов. 

### <a name="consolidation-and-normalization"></a>Консолидация и нормализация 

Глобальные решения часто состоят из региональных ресурсов, которые во многом независимы, в том числе с помощью собственных возможностей обработки, но для супра-региона и глобальных перспектив потребуется интеграция данных и, следовательно, централизованная консолидация тех же данных сообщений, которые оцениваются в соответствии с региональными потребностями локальной перспективы. 

![Процесс](media/service-bus-federation-overview/merge.jpg)

Нормализация — это разновидность сценария консолидации, при которой две или более входящие последовательности сообщений содержат одинаковую информацию, но с разными структурами или разными кодировками, а сообщения должны быть преобразованы или преобразовываться до их использования. 

Нормализация может также включать в себя криптографические операции, такие как расшифровка сквозных полезных данных и их повторное шифрование с помощью различных ключей и алгоритмов для аудитории-получателя. 

### <a name="splitting-and-routing"></a>Разделение и маршрутизация

Разделы служебной шины и их правила подписок часто используются для фильтрации потока сообщений для определенной аудитории, а затем получают отфильтрованный набор из подписки. 

![Разделение](media/service-bus-federation-overview/split.jpg)

В глобальной системе, где аудитория этих сообщений глобально распределена или относится к различным приложениям, репликация может использоваться для передачи сообщений из такой подписки в очередь или раздел в другом пространстве имен, откуда они используются.

### <a name="replication-applications-in-azure-functions"></a>Приложения репликации в функциях Azure

Для реализации приведенных выше шаблонов требуется масштабируемая и надежная среда выполнения для задач репликации, которые необходимо настроить и запустить. В Azure среда выполнения, которая лучше всего подходит для задач без отслеживания состояния, — это [функции Azure](../azure-functions/functions-overview.md). 

Функции Azure могут выполняться под [управлением управляемого удостоверения Azure](../active-directory/managed-identities-azure-resources/overview.md) , так что задачи репликации могут интегрироваться с правилами управления доступом на основе ролей для исходной и целевой служб без необходимости управлять секретами по пути репликации. Для источников и целевых объектов репликации, для которых требуются явные учетные данные, функции Azure могут содержать значения конфигурации для этих учетных данных в тесно контролируемом хранилище в [Azure Key Vault](../key-vault/general/overview.md).

Функции Azure Кроме того позволяют задачам репликации напрямую интегрироваться с виртуальными сетями и [конечными точками службы](../virtual-network/virtual-network-service-endpoints-overview.md) Azure для всех служб обмена сообщениями Azure, и они легко интегрируются с [Azure Monitor](../azure-monitor/overview.md).

Что важнее всего, функции Azure имеют предварительно созданные, масштабируемые триггеры и выходные привязки для [концентраторов событий Azure](../azure-functions/functions-bindings-service-bus.md), [центра Интернета вещей](../azure-functions/functions-bindings-event-iot.md)Azure, [служебной шины Azure, службы](../azure-functions/functions-bindings-service-bus.md)" [Сетка событий Azure](../azure-functions/functions-bindings-event-grid.md)" и [хранилища очередей Azure](../azure-functions/functions-bindings-storage-queue.md), пользовательские расширения для [RabbitMQ](https://github.com/azure/azure-functions-rabbitmq-extension)и [Apache Kafka](https://github.com/azure/azure-functions-kafka-extension). Большинство триггеров динамически адаптируются к потребностям пропускной способности путем масштабирования количества параллельно выполняемых экземпляров на основе документированных метрик. 

При использовании плана потребления функций Azure готовые триггеры могут даже масштабироваться до нуля, а для репликации нет доступных сообщений. Это означает отсутствие затрат на поддержание готовности к масштабированию. Ключевым недостатком использования плана потребления является то, что задержка задач репликации, "Пробуждение" из этого состояния, значительно выше, чем планы размещения, в которых работает инфраструктура.  

В отличие от всех этих, наиболее распространенных механизмов репликации для обмена сообщениями и событий, таких как [MirrorMaker](http://kafka.apache.org/documentation/#basic_ops_mirror_maker) Apache Kafka, требуется предоставить среду размещения и самостоятельно масштабировать модуль репликации. Это включает в себя настройку и интеграцию функций безопасности и сети, а также упрощает поток данных мониторинга, а затем не имеет возможности внедрять в последовательность пользовательские задачи репликации. 

## <a name="next-steps"></a>Дальнейшие действия

В этой статье мы изучили ряд шаблонов Федерации и объяснили роль функций Azure в качестве среды выполнения репликации событий и обмена сообщениями в Azure. 

Далее, возможно, потребуется ознакомиться со статьей Настройка приложения репликатора с помощью функций Azure, а также репликация потоков событий между концентраторами событий и другими системами обработки и обмена сообщениями.

- [Приложения репликации в функциях Azure](service-bus-federation-replicator-functions.md)
- [Репликация событий между сущностями служебной шины](https://github.com/Azure-Samples/azure-messaging-replication-dotnet/tree/main/functions/config/ServiceBusCopy)
- [Маршрутизация событий в концентраторы событий Azure](https://github.com/Azure-Samples/azure-messaging-replication-dotnet/tree/main/functions/config/ServiceBusCopyToEventHub)
- [Получение событий из концентраторов событий Azure](https://github.com/Azure-Samples/azure-messaging-replication-dotnet/tree/main/functions/config/EventHubCopyToServiceBus)

[1]: ./media/service-bus-auto-forwarding/IC628632.gif