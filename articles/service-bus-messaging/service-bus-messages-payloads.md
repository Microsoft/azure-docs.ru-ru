---
title: Сообщения, полезные данные и сериализация в служебной шине Azure | Документация Майкрософт
description: В этой статье содержатся общие сведения о сообщениях, полезных данных, маршрутизации сообщений и сериализации в служебной шине Azure.
ms.topic: article
ms.date: 01/29/2021
ms.openlocfilehash: e1baca1cd3dedee5917670a00b62c68752b5e4b8
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "101095098"
---
# <a name="messages-payloads-and-serialization"></a>Сообщения, полезные данные и сериализация

Служебная шина Microsoft Azure обрабатывает сообщения. Сообщения содержат полезные данные и метаданные. Метаданные представлены в виде пар "ключ-значение", а также описание полезных данных и инструкции по обработке служебной шины и приложений. Иногда для хранения информации, которую отправитель хочет донести до получателей, достаточно одних метаданных, и полезные данные остаются пустыми.

Объектная модель официальных клиентов служебной шины для .NET и Java отражает абстрактную структуру сообщений служебной шины, сопоставленную с сетевыми протоколами передачи, которые поддерживает служебная шина.
 
Сообщение служебной шины состоит из раздела полезных данных в двоичном формате, который служебная шина никак не обрабатывает на стороне службы, и двух наборов свойств. *Свойства брокера* предопределяются системой. Эти свойства управляют функциональными возможностями (на уровне сообщения) внутри брокера либо сопоставляются с общими и стандартизированными элементами метаданных. *Свойства пользователя* представляют собой коллекцию пар "ключ — значение", которая может быть определена и установлена приложением.
 
В таблице ниже содержится список предопределенных свойств брокера. Имена используются со всеми API официальных клиентов, а также в объекте JSON [BrokerProperties](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage) сопоставления протокола HTTP.
 
В скобках указаны эквивалентные имена, используемые на уровне протокола AMQP. 

| Имя свойства                         | Описание                                                                                                                                                                                                                                                                                                                                                                                                                               |
|---------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|  [`ContentType`](/dotnet/api/microsoft.azure.servicebus.message.contenttype) (Content-Type)           | При необходимости описывает полезные данные сообщения с помощью дескриптора, используя формат RFC2045 раздела 5, например `application/json`.                                                                                                                                                                                                                                                                                             |
|  [`CorrelationId`](/dotnet/api/microsoft.azure.servicebus.message.correlationid#Microsoft_Azure_ServiceBus_Message_CorrelationId) (Correlation-ID)       | Позволяет приложению указать контекст сообщения для корреляции, например **MessageId** сообщения, для которого предоставляется ответ.                                                                                                                                                                                                                                                                  |
| [`DeadLetterSource`](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage.deadlettersource)                      | Задается только в сообщениях, которые были недоставленными и перенаправлены в другую сущность из очереди недоставленных сообщений. Указывает сущность, в которой сообщения перешли в состояние недоставленных. Это свойство доступно только для чтения.                                                                                                                                                                                                                                  |
| [`DeliveryCount`](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage.deliverycount)                         | <p>Количество попыток доставки этого сообщения. Значение счетчика увеличивается, когда заканчивается период блокировки сообщения или сообщение явно отклоняется получателем. Это свойство доступно только для чтения.</p> <p>Число доставок увеличивается при закрытии базового соединения AMQP.</p>                                                                                                                                                                                                                                                 |
| [`EnqueuedSequenceNumber`](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage.enqueuedsequencenumber)                | Для сообщений, которые были перенаправлены, это свойство отражает порядковый номер, который был впервые назначен сообщению в его исходной точке отправки. Это свойство доступно только для чтения.                                                                                                                                                                                                                                                                |
| [`EnqueuedTimeUtc`](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage.enqueuedtimeutc)                       | Время в формате UTC, когда сообщение было принято и сохранено в сущности. Это значение можно использовать в качестве полномочного и нейтрального индикатора времени прибытия, когда получателю не нужно доверять часам отправителя. Это свойство доступно только для чтения.                                                                                                                                                                                                   |
|  [`ExpiresAtUtc`](/dotnet/api/microsoft.azure.servicebus.message.expiresatutc) (абсолютное время окончания срока действия) | Время в формате UTC, в котором сообщение помечено для удаления и больше не доступно для извлечения из сущности из-за истечения срока действия. Срок действия контролируется свойством **TimeToLive**, которое вычисляется по формуле EnqueuedTimeUtc+TimeToLive. Это свойство доступно только для чтения.                                                                                                                                                                           |
| [`ForcePersistence`](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage.forcepersistence)                      | Для очередей или разделов с [`EnableExpress`](/dotnet/api/microsoft.servicebus.messaging.queuedescription.enableexpress) установленным флагом это свойство можно задать, чтобы указать, что сообщение должно быть сохранено на диске перед тем, как оно будет подтверждено. Это поведение является стандартным для всех сущностей, не являющихся Express.                                                                                                                                                                                                         |
| [`Label`](/dotnet/api/microsoft.azure.servicebus.message.label) применяются                       | Это свойство позволяет приложению указать цель сообщения для получателя в обычном виде, аналогично строке темы сообщения электронной почты.                                                                                                                                                                                                                                                                                  |
| [`LockedUntilUtc`](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage.lockeduntilutc)                        | Для сообщений, полученных с блокировкой (режим блокировки для просмотра предварительно несопоставленных сообщений), это свойство отражает время в формате UTC, до которого удерживается блокировка сообщения в очереди или подписке. По истечении срока действия блокировки [DeliveryCount](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage.deliverycount) увеличивается, и сообщение снова доступно для извлечения. Это свойство доступно только для чтения.                                                                                                                         |
| [`LockToken`](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage.locktoken)                             | Маркер блокировки является ссылкой на блокировку, удерживаемую брокером в режиме *блокировки для просмотра*. Маркер можно использовать для окончательного закрепления блокировки через API [отсрочки](message-deferral.md) и, таким образом, принимать сообщения из потока состояния обычной доставки. Это свойство доступно только для чтения.                                                                                                                                                               |
| [`MessageId`](/dotnet/api/microsoft.azure.servicebus.message.messageid) (Message-ID)                | Идентификатор сообщения — это определяемое приложением значение, позволяющее уникально идентифицировать сообщение и его полезные данные. Идентификатор — это строка в свободной форме, которая может отразить глобальный уникальный идентификатор или идентификатор, производный от контекста приложения. Если включена, функция [обнаружения дубликатов](duplicate-detection.md) определяет и удаляет вторые и последующие отправки сообщений с тем же **MessageId**.                                                                |
| [`PartitionKey`](/dotnet/api/microsoft.azure.servicebus.message.partitionkey)                          | Для [секционированных сущностей](service-bus-partitioning.md) установка этого значения позволяет назначить связанные сообщения тому же внутреннему разделу, чтобы порядок последовательности отправки был правильно записан. Секция выбирается хэш-функцией для этого значения и не может быть выбрана напрямую. Для сущностей, учитывающих сеансы, свойство **SessionId** переопределяет это значение.                                                                                                       |
| [`ReplyTo`](/dotnet/api/microsoft.azure.servicebus.message.replyto) (обратный адрес)                    | Это необязательное значение, определяемое приложением, является стандартным способом выражения пути ответа для получателя сообщения. Когда отправитель ожидает ответа, он присваивает значение абсолютному или относительному пути очереди или раздела, куда будет отправлен ответ.                                                                                                                                           |
| [`ReplyToSessionId`](/dotnet/api/microsoft.azure.servicebus.message.replytosessionid) (Reply-to-Group-ID)  | Это значение расширяет сведения **ReplyTo** и указывает, какой **SessionId** должен быть задан для ответа при отправке в сущность ответа.                                                                                                                                                                                                                                                                            |
| [`ScheduledEnqueueTimeUtc`](/dotnet/api/microsoft.azure.servicebus.message.scheduledenqueuetimeutc)               | Для сообщений, которые доступны для извлечения после задержки, это свойство определяет время в формате UTC, когда сообщение будет логически поставлено в очередь, упорядочено и, следовательно, станет доступно для извлечения.                                                                                                                                                                                                                 |
| [`SequenceNumber`](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage.sequencenumber)                        | Порядковый номер — это уникальное 64-битное целое число, присваиваемое сообщению, когда его принимает и сохраняет брокер, которое выступает в качестве правильного идентификатора. Для секционированных сущностей верхние 16 бит отражают идентификатор раздела. Порядковые номера монотонно увеличиваются и не имеют промежутков. Когда диапазон 48–64 бит исчерпан, используется значение 0. Это свойство доступно только для чтения.                                                                |
| [`SessionId`](/dotnet/api/microsoft.azure.servicebus.message.sessionid) (Group-ID)                  | Для сущностей, учитывающих сеансы, это значение, определяемое приложением, указывает принадлежность сеанса сообщения. В сообщениях с одинаковым идентификатором сеанса может быть заблокирована сводка и включена точная порядковая обработка и демультиплексирование. Для сущностей, которые не поддерживают сеансы, это значение игнорируется.                                                                                                                                     |
| [`Size`](/dotnet/api/microsoft.azure.servicebus.message.size)                                  | Отражает хранимый размер сообщения в журнале брокера как количество байтов, так как он учитывается в квоте хранилища. Это свойство доступно только для чтения.                                                                                                                                                                                                                                                                                                       |
| [`State`](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage.state)                                 | Указывает состояние сообщения в журнале. Это свойство применяется только во время просмотра сообщения (обзора), чтобы определить, является ли оно активным и доступным для извлечения, когда оно достигает начала очереди, а также является ли оно отложенным или ожидает планирования. Это свойство доступно только для чтения.                                                                                                                                           |
| [`TimeToLive`](/dotnet/api/microsoft.azure.servicebus.message.timetolive)                            | Это относительная длительность, после которой истекает срок действия сообщения, начиная с момента, когда его принял и сохранил брокер, как записано в **EnqueueTimeUtc**. Если не задано явно, для соответствующей очереди или раздела используется значение **DefaultTimeToLive**. Значение **TimeToLive** уровня сообщения не может быть длиннее значения параметра **DefaultTimeToLive** сущности. В противном случае оно будет автоматически скорректировано. |
| [To](/dotnet/api/microsoft.azure.servicebus.message.to) (to)                               | Это свойство зарезервировано для будущего использования в сценариях маршрутизации. Сейчас брокер игнорирует это свойство. Приложения могут использовать это значение в сценариях, управляемых правилами, для указания предполагаемого логического назначения сообщения.                                                                                                                                                                                   |
| [`ViaPartitionKey`](/dotnet/api/microsoft.azure.servicebus.message.viapartitionkey)                       | Если сообщение отправляется через очередь передачи в области транзакции, это значение выбирает раздел очереди передачи.                                                                                                                                                                                                                                                                                                                 |

Модель абстрактных сообщений позволяет публиковать сообщение в очереди через HTTPS и может быть получено через AMQP. В любом случае сообщение выглядит обычным в контексте соответствующего протокола. Свойства брокера преобразовываются при необходимости, а свойства пользователя сопоставляются с наиболее подходящим расположением соответствующей модели сообщения протокола. В HTTP свойства пользователя сопоставляются непосредственно с заголовками HTTP, в AMQP они сопоставляются со схемой **свойств приложения**.

## <a name="message-routing-and-correlation"></a>Маршрутизация и корреляция сообщений

Свойства брокера, описанные ранее, в частности [To](/dotnet/api/microsoft.azure.servicebus.message.to), [ReplyTo](/dotnet/api/microsoft.azure.servicebus.message.replyto), [ReplyToSessionId](/dotnet/api/microsoft.azure.servicebus.message.replytosessionid), [MessageId](/dotnet/api/microsoft.azure.servicebus.message.messageid), [CorrelationId](/dotnet/api/microsoft.azure.servicebus.message.correlationid) и [SessionId](/dotnet/api/microsoft.azure.servicebus.message.sessionid), помогают приложению направлять сообщения в определенные пункты назначения. Чтобы продемонстрировать эту функцию, рассмотрим несколько шаблонов:

- **Простой шаблон "запрос — ответ".** Издатель отправляет сообщение в очередь и ожидает ответа от получателя. Чтобы получить ответ, издателю должна принадлежать очередь, в которую будет доставлен ответ. Адрес этой очереди обозначается в свойстве **ReplyTo** исходящего сообщения. Когда пользователь отвечает, он копирует **MessageId** обработанного сообщения в свойство **CorrelationId** сообщения ответа и отправляет сообщение в пункт назначения, обозначаемый свойством **ReplyTo**. Одно сообщение может выдавать несколько ответов в зависимости от контекста приложения.
- **Многоадресная рассылка "запрос — ответ".** В качестве одного из вариантов предыдущего шаблона издатель отправляет сообщение в раздел, и несколько подписчиков могут получить это сообщение. Каждый подписчик может ответить описанным выше образом. Этот шаблон используется в сценариях обнаружения или вызовов. Респондент обычно идентифицируется с помощью свойства пользователя или внутри полезных данных. Если **ReplyTo** указывает на раздел, такой набор ответов обнаружения может быть распределен среди аудитории.
- **Мультиплексирование.** Эта функция сеанса позволяет выполнить мультиплексирование потоков связанных сообщений через одну очередь или подписку таким образом, чтобы каждый сеанс (или группа) связанных сообщений, определенных путем сопоставления значений **SessionId**, направлялся конкретному получателю, в то время как получатель блокирует сеанс. Дополнительные сведения о сеансах см. [здесь](message-sessions.md).
- **Мультиплексированный шаблон "запрос — ответ".** Эта функция сеанса включает мультиплексированные ответы, позволяя нескольким издателям использовать одну и ту же очередь ответов. Задав **ReplyToSessionId**, издатель может указать получателю скопировать это значение в свойство **SessionId** сообщения ответа. Очередь или раздел публикации не обязательно должны быть осведомлены о сеансе. При отправке сообщения издатель может специально дождаться сеанса с указанным **SessionId**, чтобы материализовать очередь, условно приняв получателя сеанса. 

Маршрутизацию внутри пространства имен служебной шины можно реализовать с помощью правил для подписке и подписок на разделы. Маршрутизацию в пространстве имен можно реализовать с помощью [Azure LogicApps](https://azure.microsoft.com/services/logic-apps/). Как указано в списке выше, свойство **To** зарезервировано для будущего использования и в итоге может интерпретироваться брокером со специально включенной функцией. Приложения, которые хотят реализовать маршрутизацию, должны сделать это на основе свойств пользователя, а не экономично в свойстве **to** ; Однако это не приведет к проблемам совместимости.

## <a name="payload-serialization"></a>Сериализация полезных данных

Во время передачи или хранения в служебной шине полезные данные всегда непрозрачны и имеют двоичный блок. Свойство [ContentType](/dotnet/api/microsoft.azure.servicebus.message.contenttype) позволяет приложению описывать полезные данные, используя предполагаемый формат для значений свойств, и является описанием типа содержимого MIME в соответствии с IETF RFC2045, например `application/json;charset=utf-8`.

В отличие от вариантов Java или .NET Standard версия .NET Framework API служебной шины поддерживает создание экземпляров **BrokeredMessage**, передавая произвольные объекты .NET в конструктор. 

При использовании предыдущих версий протокола SBMP эти объекты затем сериализуются с помощью стандартного двоичного сериализатора или с помощью сериализатора, который предоставляется извне. При использовании протокола AMQP объект сериализуется в объект AMQP. Получатель может получить объекты с помощью метода [GetBody\<T>()](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage.getbody#Microsoft_ServiceBus_Messaging_BrokeredMessage_GetBody__1), передавая ожидаемый тип. При использовании AMQP объекты сериализуются в AMQP граф `ArrayList` `IDictionary<string,object>` объектов и, а любой клиент AMQP может декодировать их. 

Хотя эта скрытая волшебная команда сериализации удобна, приложение должно явно контролировать сериализацию объектов и преобразовать их диаграммы объектов в потоки, прежде чем включить их в сообщение и выполнить обратную операцию на стороне получателя. Это дает взаимодействующие результаты. Хотя AMQP имеет мощную модель двоичного кодирования, она привязана к экосистеме обмена сообщениями AMQP и HTTP-клиенты не могут декодировать такие полезные данные. 

Варианты .NET Standard и API Java принимают только массивы байтов. Это означает, что приложение должно обрабатывать элементы управления сериализации объектов. 

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения об обмене сообщениями через служебную шину см. в следующих статьях:

* [Очереди, разделы и подписки служебной шины](service-bus-queues-topics-subscriptions.md)
* [Начало работы с очередями служебной шины](service-bus-dotnet-get-started-with-queues.md)
* [Как использовать разделы и подписки служебной шины](service-bus-dotnet-how-to-use-topics-subscriptions.md)
