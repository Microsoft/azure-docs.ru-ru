---
title: Фильтры разделов в служебной шине Azure | Документация Майкрософт
description: В этой статье объясняется, как подписчики могут определить, какие сообщения они хотят получить из раздела, указав фильтры.
ms.topic: conceptual
ms.date: 01/22/2021
ms.openlocfilehash: 63cf6e67d4fa32c5c7f52f569094e1165554108c
ms.sourcegitcommit: 6272bc01d8bdb833d43c56375bab1841a9c380a5
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/23/2021
ms.locfileid: "98742970"
---
# <a name="topic-filters-and-actions"></a>Фильтры и действия разделов

Подписчики могут самостоятельно определять, какие сообщения они хотят получать из раздела. Эти сообщения определяются в одном или нескольких именованных правилах подписки. Каждое правило состоит из условия **фильтра** , которое выбирает конкретные сообщения и, **при необходимости** , содержит **действие** , которое заметит выбранное сообщение. 

Все правила **без действий** объединяются с помощью `OR` условия и приводят к созданию **одного сообщения** в подписке, даже если имеется несколько правил сопоставления. 

Каждое правило **с действием** создает копию сообщения. Это сообщение будет иметь свойство, называемое, `RuleName` где значение — это имя правила сопоставления. Действие может добавлять или обновлять свойства или удалять свойства исходного сообщения для получения сообщения в подписке. 

Рассмотрим следующий сценарий.

- Подписка включает пять правил.
- Два правила содержат действия.
- Три правила не содержат действий.

В этом примере, если вы отправляете одно сообщение, соответствующее всем пяти правилам, вы получаете три сообщения в подписке. Это два сообщения для двух правил с действиями и одно сообщение для трех правил без действий. 

Для каждой новой подписки на раздел устанавливается правило подписки с начальным значением по умолчанию. Если явно не указать условие фильтра для этого правила, применяется фильтр **true**, который отбирает в подписку все сообщения раздела. Для правила по умолчанию не установлено действие по созданию заметок.

## <a name="filters"></a>Фильтры
Служебная шина поддерживает три условия фильтрации:

-   *Фильтры SQL*. **SqlFilter** содержит SQL-подобное условное выражение, которое вычисляется в брокере для определяемых пользователем свойств и системных свойств каждого поступившего сообщения. Все системные свойства в условном выражении предваряются префиксом `sys.`. [Подмножество языка SQL для условий фильтра](service-bus-messaging-sql-filter.md) проверяет наличие свойств ( `EXISTS` ), значений NULL ( `IS NULL` ), ЛОГИЧЕСКИХ операторов Not/and/or, операторам отношения, простой числовой арифметической операции и простому текстовому шаблону, совпадающему с `LIKE` .

-   *Логические фильтры*. **TrueFilter** отбирает все поступившие сообщения (**true**), а **FalseFilter** не отбирает ни одного сообщения (**false**). Эти два фильтра являются производными от фильтра SQL. 

-   *Фильтры корреляции*. **CorrelationFilter** содержит набор условий, которые сопоставляются с одним или несколькими из пользовательских и системных свойств для каждого поступающего сообщения. Обычно используется для сопоставления со свойством **correlationId** , но приложение также может выбрать сопоставление со следующими свойствами:

    - **ContentType**
     - **Label**
     - **MessageId**
     - **ReplyTo**
     - **ReplyToSessionId**
     - **SessionId** 
     - **Чтобы**
     - все определяемые пользователем свойства. 
     
     Совпадение регистрируется, когда значение свойства поступающего сообщения равно тому значению, которое указано в фильтре корреляции. Для строковых выражений при сравнении учитывается регистр. Если вы укажете несколько свойств для сравнения, фильтр объединяет эти условия логическим оператором И (AND). Это означает, что для регистрации совпадения должны выполняться все условия фильтра.

Все фильтры оценивают только свойства сообщения. Фильтры не могут вычислить текст сообщения.

Сложные правила фильтрации требуют значительных вычислительных ресурсов. В частности, использование правил фильтра SQL приводит к снижению общей пропускной способности сообщений на уровне подписки, раздела и пространства имен. Когда это возможно, приложения должны выбирать фильтры корреляции для фильтров, похожих на SQL, так как они гораздо эффективнее в обработке и имеют меньше влияния на пропускную способность.

## <a name="actions"></a>Действия

С помощью условий фильтров SQL можно определить действие, которое добавляет примечания с помощью добавления, удаления или изменения свойств и их значений. Это действие [использует выражение в стиле SQL](service-bus-messaging-sql-filter.md), отдаленно напоминающее синтаксис инструкции SQL UPDATE. Действие выполняется с сообщением после его сопоставления и до того, как сообщение было выбрано в подписке. Все изменения свойств сообщения действуют только для той копии сообщения, которая помещается в подписку.

## <a name="usage-patterns"></a>Варианты использования

Самый простой сценарий использования разделов — копирование в каждую подписку каждого сообщения, отправляемого в раздел, что соответствует режиму широковещательной трансляции.

Фильтры и действия позволяют реализовать еще две группы методов: секционирование и маршрутизацию.

При секционировании фильтры распределяют сообщения по нескольким подпискам на разделы так, что каждое сообщение попадает только в один строго прогнозируемый раздел. Метод секционирования удобен в том случае, если масштаб системы требует обрабатывать много идентичных по функциональности секций, каждая из которых имеет свой контекст и содержит определенное подмножество данных. В качестве примера можно указать данные профилей клиентов. Издатель, отправляющий сообщение в определенный раздел, не обязан понимать, как работает модель секционирования, и даже знать о ее существовании. Сообщение помещается в нужную подписку, из которой его получает обработчик сообщений, настроенный для этой секции.

При маршрутизации фильтры распределяют сообщения между подписками на разделы прогнозируемым образом, но не обязательно уникально. В сочетании с функцией [автоматической переадресации](service-bus-auto-forwarding.md) фильтры разделов позволяют создавать сложные схемы маршрутов в пространстве имен сервисной шины и распространять сообщения внутри региона Azure. Если вы примените Функции Azure или Azure Logic Apps в качестве моста между пространствами имен Служебной шины Azure, вы получите возможность создавать еще более сложные глобальные топологии с прямой интеграцией в бизнес-приложения.

[!INCLUDE [service-bus-filter-examples](../../includes/service-bus-filter-examples.md)]



> [!NOTE]
> Поскольку портал Azure теперь поддерживает работу обозревателя служебной шины, фильтры подписки можно создавать и изменять на портале. 

## <a name="next-steps"></a>Дальнейшие действия
См. следующие примеры: 

- [.NET — руководство по отправке и получению с фильтрами](https://github.com/Azure/azure-service-bus/tree/master/samples/DotNet/GettingStarted/BasicSendReceiveTutorialwithFilters/BasicSendReceiveTutorialWithFilters)
- [Фильтры разделов .NET](https://github.com/Azure/azure-service-bus/tree/master/samples/DotNet/Microsoft.Azure.ServiceBus/TopicFilters)
- [Шаблон Azure Resource Manager](/azure/templates/microsoft.servicebus/2017-04-01/namespaces/topics/subscriptions/rules)