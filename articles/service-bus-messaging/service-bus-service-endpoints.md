---
title: Настройка конечных точек службы виртуальной сети для служебной шины Azure
description: В этой статье содержатся сведения о том, как добавить конечную точку службы Microsoft. ServiceBus в виртуальную сеть.
ms.topic: article
ms.date: 02/12/2021
ms.custom: fasttrack-edit
ms.openlocfilehash: 2e00c9429ab3e39f95bc5ce6df072a99e4f02b86
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "100559582"
---
# <a name="allow-access-to-azure-service-bus-namespace-from-specific-virtual-networks"></a>Разрешение доступа к пространству имен служебной шины Azure из конкретных виртуальных сетей
Интеграция служебной шины с [конечными точками службы виртуальной сети][vnet-sep] обеспечивает безопасный доступ к возможностям обмена сообщениями из рабочих нагрузок, таких как виртуальные машины, привязанные к виртуальным сетям, с использованием пути сетевого трафика, защищенного на обоих концах.

После настройки привязки по крайней мере к одной конечной точке службы подсети в соответствующем пространстве имен служебной шины больше не будет принимать трафик из любого места, но с проверенными виртуальными сетями и, по желанию, определенные IP-адреса в Интернете. С точки зрения виртуальной сети привязка пространства имен Служебной шины к конечной точке службы настраивает изолированный сетевой туннель от подсети виртуальной сети к службе обмена сообщениями.

Результатом является частная и изолированная взаимосвязь между рабочими нагрузками, связанными с подсетью, и соответствующим пространством имен Служебной шины, несмотря на то что наблюдаемый сетевой адрес конечной точки службы обмена сообщениями находится в общедоступном диапазоне IP-адресов.

Реализация интеграции виртуальных сетей может препятствовать взаимодействию других служб Azure со служебной шиной. В качестве исключения можно разрешить доступ к ресурсам служебной шины из определенных доверенных служб, даже если включены конечные точки сетевой службы. Список доверенных служб см. в разделе [Доверенные службы](#trusted-microsoft-services).

В виртуальной сети должны присутствовать следующие службы Майкрософт:
- Служба приложений Azure
- Функции Azure

Виртуальные сети поддерживаются только в пространствах имен службы "Служебная шина" [ценовой категории "Премиум"](service-bus-premium-messaging.md). При использовании конечных точек службы виртуальной сети с служебной шиной не следует включать эти конечные точки в приложениях, которые используют пространства имен Standard и Premium уровня "Премиум". Так как уровень Standard не поддерживает виртуальных сетей. Конечная точка ограничена только пространствами имен уровня "Премиум".

> [!IMPORTANT]
> Укажите по крайней мере одно правило IP-адреса или правило виртуальной сети для пространства имен, разрешающее трафик только с указанных IP-адресов или из подсети виртуальной сети. Если правила IP-адресов и виртуальных сетей отсутствуют, доступ к пространству имен можно получить через общедоступный Интернет (с помощью ключа доступа).  

## <a name="advanced-security-scenarios-enabled-by-vnet-integration"></a>Расширенные сценарии обеспечения безопасности, доступные при интеграции с виртуальной сетью 

Решения, требующие жесткой и раздельной защиты, где подсети виртуальной сети обеспечивают сегментирование между разделенными службами, обычно все же нуждаются в путях взаимодействия между службами, находящимися в этих секциях.

Любой прямой IP-маршрут между секциями, включая передачу трафика HTTPS через TCP/IP, несет риск использования уязвимостей на сетевом уровне. Службы обмена сообщениями обеспечивают полностью изолированные пути взаимодействия, где сообщения даже записываются на диск при передаче между сторонами. Рабочие нагрузки в двух разных виртуальных сетях, которые связаны с одним и тем же экземпляром Служебной шины, могут эффективно и надежно связываться с использованием сообщений, в то время как целостность границ изолированной сети сохраняется.
 
Это означает, что ваши конфиденциальные облачные решения, влияющие на безопасность, не только получают доступ к ведущим в отрасли надежным, масштабируемым и асинхронным службам обмена сообщениями Azure, но теперь могут использовать обмен сообщениями, чтобы создавать пути передачи данных между защищенными секциями решений. По своей сути такие пути обеспечивают больше безопасности, чем при любом режиме одноранговой связи, включая HTTPS и другие протоколы сокетов TLS.

## <a name="binding-service-bus-to-virtual-networks"></a>Привязка Служебной шины к виртуальным сетям

*Правила виртуальной сети* — это функция безопасности брандмауэра, которая позволяет контролировать, принимает ли сервер Служебной шины Azure соединения из определенной подсети виртуальной сети.

Привязка пространства имен Служебной шины к виртуальной сети состоит из двух этапов. Сначала необходимо создать **конечную точку службы виртуальной** сети в подсети виртуальной сети и включить ее для **Microsoft. servicebus** , как описано в [обзоре конечной точки службы][vnet-sep]. Добавив конечную точку службы, вы привязываете к ней пространство имен Служебной шины с помощью **правила виртуальной сети**.

Правило виртуальной сети — это связь пространства имен Служебной шины с подсетью виртуальной сети. Пока правило существует, всем рабочим нагрузкам, привязанным к подсети, предоставляется доступ к пространству имен Служебной шины. Служебная шина никогда не устанавливает исходящие подключения и не нуждается в доступе, и поэтому это правило не предоставляет ей доступ к вашей подсети.

> [!NOTE]
> Помните, что конечная точка сетевой службы предоставляет приложениям, выполняемым в виртуальной сети, доступ к пространству имен служебной шины. Виртуальная сеть управляет достижимостью конечной точки, но не может выполнять операции с сущностями служебной шины (очередями, разделами или подписками). Используйте Azure Active Directory (Azure AD) для авторизации операций, которые могут выполнять приложения в пространстве имен и его сущностях. Дополнительные сведения см. в статьях [Проверка подлинности и авторизация приложения с помощью Azure AD для доступа к сущностям служебной шины](authenticate-application.md).


## <a name="use-azure-portal"></a>Использование портала Azure
В этом разделе показано, как с помощью портал Azure добавить конечную точку службы виртуальной сети. Чтобы ограничить доступ, необходимо интегрировать конечную точку службы виртуальной сети для этого пространства имен концентраторов событий.

1. Перейдите к **пространству имен служебной шины** на [портале Azure](https://portal.azure.com).
2. В меню слева выберите параметр **сеть** в разделе **Параметры**.  

    > [!NOTE]
    > Вкладка " **сеть** " отображается только для пространств имен " **премиум** ".  
    
    :::image type="content" source="./media/service-bus-ip-filtering/default-networking-page.png" alt-text="Страница &quot;Сетевые подключения&quot; — по умолчанию" lightbox="./media/service-bus-ip-filtering/default-networking-page.png":::
    
    Если выбран параметр **все сети** , пространство имен служебной шины принимает подключения с любого IP-адреса. То есть, такое значение параметра по умолчанию равноценно правилу, которое принимает диапазон IP-адресов 0.0.0.0/0. 

    ![Брандмауэр — выбран вариант "Все сети"](./media/service-bus-ip-filtering/firewall-all-networks-selected.png)
2. Чтобы ограничить доступ к определенным виртуальным сетям, выберите вариант **Выбранные сети** , если он еще не выбран.
1. В разделе **Виртуальная сеть** страницы выберите **+ Добавить существующую виртуальную сеть**. 

    ![Добавить существующую виртуальную сеть](./media/service-endpoints/add-vnet-menu.png)

    >[!WARNING]
    > Если вы выбрали вариант **Выбранные сети** и не добавили хотя бы одно правило брандмауэра IP или виртуальную сеть на этой странице, доступ к пространству имен можно получить через общедоступный Интернет (с помощью ключа доступа).
3. Выберите виртуальную сеть из списка виртуальных сетей, а затем выберите **подсеть**. Прежде чем добавлять виртуальную сеть в список, необходимо включить конечную точку службы. Если конечная точка службы не включена, на портале будет предложено включить ее.
   
   ![Выбор подсети](./media/service-endpoints/select-subnet.png)

4. После включения конечной точки службы для подсети в **Microsoft. servicebus** должно отобразиться следующее сообщение об успешном выполнении. Нажмите кнопку **Добавить** в нижней части страницы, чтобы добавить сеть. 

    ![выбор подсети и включение конечной точки](./media/service-endpoints/subnet-service-endpoint-enabled.png)

    > [!NOTE]
    > Если вы не можете включить конечную точку службы, вы можете проигнорировать отсутствующую конечную точку службы виртуальной сети с помощью шаблона диспетчер ресурсов. Эта функция недоступна на портале.
6. На панели инструментов нажмите **Сохранить**, чтобы сохранить параметры. Подождите несколько минут, пока подтверждение отобразится в уведомлениях на портале. Кнопка **сохранить** должна быть отключена. 

    ![Сохранить сеть](./media/service-endpoints/save-vnet.png)

    > [!NOTE]
    > Инструкции по предоставлению доступа с конкретных IP-адресов или диапазонов см. в разделе [разрешение доступа с конкретных IP-адресов или диапазонов](service-bus-ip-filtering.md).

[!INCLUDE [service-bus-trusted-services](../../includes/service-bus-trusted-services.md)]

## <a name="use-resource-manager-template"></a>Использование шаблона Resource Manager
Следующий образец диспетчер ресурсов шаблон добавляет правило виртуальной сети к существующему пространству имен служебной шины. Для правила сети указывает идентификатор подсети в виртуальной сети. 

Идентификатор — это полный диспетчер ресурсов путь к подсети виртуальной сети. Например, `/subscriptions/{id}/resourceGroups/{rg}/providers/Microsoft.Network/virtualNetworks/{vnet}/subnets/default` для подсети по умолчанию виртуальной сети.

При добавлении правил виртуальной сети или брандмауэра присвойте параметру значение `defaultAction` `Deny` .

Шаблон:

```json
{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "servicebusNamespaceName": {
        "type": "string",
        "metadata": {
          "description": "Name of the Service Bus namespace"
        }
      },
      "virtualNetworkName": {
        "type": "string",
        "metadata": {
          "description": "Name of the Virtual Network Rule"
        }
      },
      "subnetName": {
        "type": "string",
        "metadata": {
          "description": "Name of the Virtual Network Sub Net"
        }
      },
      "location": {
        "type": "string",
        "metadata": {
          "description": "Location for Namespace"
        }
      }
    },
    "variables": {
      "namespaceNetworkRuleSetName": "[concat(parameters('servicebusNamespaceName'), concat('/', 'default'))]",
      "subNetId": "[resourceId('Microsoft.Network/virtualNetworks/subnets/', parameters('virtualNetworkName'), parameters('subnetName'))]"
    },
    "resources": [
      {
        "apiVersion": "2018-01-01-preview",
        "name": "[parameters('servicebusNamespaceName')]",
        "type": "Microsoft.ServiceBus/namespaces",
        "location": "[parameters('location')]",
        "sku": {
          "name": "Premium",
          "tier": "Premium"
        },
        "properties": { }
      },
      {
        "apiVersion": "2017-09-01",
        "name": "[parameters('virtualNetworkName')]",
        "location": "[parameters('location')]",
        "type": "Microsoft.Network/virtualNetworks",
        "properties": {
          "addressSpace": {
            "addressPrefixes": [
              "10.0.0.0/23"
            ]
          },
          "subnets": [
            {
              "name": "[parameters('subnetName')]",
              "properties": {
                "addressPrefix": "10.0.0.0/23",
                "serviceEndpoints": [
                  {
                    "service": "Microsoft.ServiceBus"
                  }
                ]
              }
            }
          ]
        }
      },
      {
        "apiVersion": "2018-01-01-preview",
        "name": "[variables('namespaceNetworkRuleSetName')]",
        "type": "Microsoft.ServiceBus/namespaces/networkruleset",
        "dependsOn": [
          "[concat('Microsoft.ServiceBus/namespaces/', parameters('servicebusNamespaceName'))]"
        ],
        "properties": {
          "virtualNetworkRules": 
          [
            {
              "subnet": {
                "id": "[variables('subNetId')]"
              },
              "ignoreMissingVnetServiceEndpoint": false
            }
          ],
          "ipRules":[<YOUR EXISTING IP RULES>],
          "trustedServiceAccessEnabled": false,          
          "defaultAction": "Deny"
        }
      }
    ],
    "outputs": { }
  }
```

Инструкции по развертыванию шаблона см. в статье [Развертывание ресурсов с помощью шаблонов ARM и Azure PowerShell][lnk-deploy].

> [!IMPORTANT]
> Если правила IP-адресов и виртуальных сетей отсутствуют, весь трафик передается в пространство имен, даже если для свойства задано значение `defaultAction` `deny` .  Доступ к пространству имен можно получить через общедоступный Интернет (с помощью ключа доступа). Укажите по крайней мере одно правило IP-адреса или правило виртуальной сети для пространства имен, разрешающее трафик только с указанных IP-адресов или из подсети виртуальной сети.  

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о виртуальных сетях см. по следующим ссылкам:

- [Конечные точки службы виртуальной сети Azure][vnet-sep]
- [Use IP filters][ip-filtering] (Использование IP-фильтров)

[vnet-sep]: ../virtual-network/virtual-network-service-endpoints-overview.md
[lnk-deploy]: ../azure-resource-manager/templates/deploy-powershell.md
[ip-filtering]: service-bus-ip-filtering.md
