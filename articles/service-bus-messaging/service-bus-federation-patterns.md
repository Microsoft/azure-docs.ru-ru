---
title: Шаблоны задач репликации сообщений — служебная шина Azure | Документация Майкрософт
description: В этой статье приводятся подробные инструкции по реализации шаблонов задач репликации сообщений.
ms.topic: article
ms.date: 12/12/2020
ms.openlocfilehash: d823ee7ccd4f53bfc3e10211a4f44908273a110d
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "97657506"
---
# <a name="message-replication-tasks-patterns"></a>Шаблоны задач репликации сообщений

Общие сведения [о Федерации](service-bus-federation-overview.md) и [функции репликатора](service-bus-federation-replicator-functions.md) описывают причину и основные элементы задач репликации, поэтому рекомендуется ознакомиться с ними перед тем, как продолжить работу с этой статьей.

В этой статье подробно описываются рекомендации по реализации некоторых шаблонов, выделенных в разделе Обзор. 

## <a name="replication"></a>Репликация 

Шаблон репликации копирует сообщения из одной очереди или раздела в следующую или из очереди или раздела в другое назначение, например в концентратор событий. Сообщения перенаправляются без внесения изменений в полезные данные сообщения. 

Реализация этого шаблона охватывается [репликацией сообщений в пример служебной шины Azure и из](https://github.com/Azure-Samples/azure-messaging-replication-dotnet/tree/main/functions/config/ServiceBusCopy) нее.

### <a name="sequences-and-order-preservation"></a>Последовательности и сохранение порядка

Модель репликации не нацелена на сохранение абсолютного порядка сообщений исходной очереди или раздела в целевую очередь или раздел, но при необходимости она фокусируется на том, чтобы сохранить относительный порядок сообщений, где это требуется приложению. Это позволяет приложению включить поддержку сеансов для исходной сущности и сгруппировать связанные сообщения с тем же [сеансом](message-sessions.md).

Встроенные функции репликации с учетом сеанса гарантируют, что последовательности сообщений с одним и тем же идентификатором сеанса, извлеченными из исходной сущности, отправляются в целевую очередь или раздел в качестве пакета в исходной последовательности и с тем же идентификатором сеанса. 

### <a name="service-assigned-metadata"></a>Метаданные, назначенные службе 

Присвоенные службе метаданные сообщения, полученного из исходной очереди или раздела, исходного времени и порядкового номера постановки в очередь, заменяются новыми значениями, назначенными службой в целевой очереди или разделе, но с задачами репликации по умолчанию, которые предоставляются в примерах, исходные значения сохраняются в свойствах пользователя: `repl-enqueue-time` (строка ISO8601) и `repl-sequence` .

Эти свойства имеют тип String и содержат значение переведенные соответствующих исходных свойств.  Если сообщение пересылается несколько раз, к уже существующим свойствам добавляются метаданные немедленного источника, назначенные службе, со значениями, разделенными точкой с запятой. 

### <a name="failover"></a>Отработка отказа

Если вы используете репликацию для аварийного восстановления, чтобы защититься от региональных сообщений о доступности в службе служебной шины или от сетевых прерываний, любой такой сценарий сбоя потребует выполнения отработки отказа из одной очереди или раздела на следующий, указывая производителям и (или) потребителям использовать вторичную конечную точку.

Для всех сценариев отработки отказа предполагается, что необходимые элементы пространств имен структурно идентичны, что означает, что очереди и разделы идентичны именам, а правила подписи общего доступа и/или правила управления доступом на основе ролей настраиваются аналогичным образом. Вы можете создать (и обновить) дополнительное пространство имен, следуя [указаниям по перемещению пространств имен](move-across-regions.md) и пропущению шага очистки.

Чтобы принудительно переключиться производителями и потребителями, необходимо предоставить сведения о том, какое пространство имен использовать доступно для поиска в расположении, которое легко достигать и обновление. Если производители или потребители сталкиваются с частыми или постоянными ошибками, они должны обратиться к этому расположению и изменить конфигурацию. Существует множество способов совместного использования этой конфигурации, но мы разносимся на две из следующих: DNS и общие файловые ресурсы.

#### <a name="dns-based-failover-configuration"></a>Конфигурация отработки отказа на основе DNS

Одним из потенциальных подходов является хранение информации в SRV-записях DNS в управляемом вами DNS и указание соответствующей конечной точки очереди или раздела. Обратите внимание, что концентраторы сообщений не допускают присвоения конечным точкам напрямую псевдонимов с записями CNAME. Это означает, что вы будете использовать DNS в качестве механизма отказоустойчивого поиска адресов конечных точек, а не для непосредственного разрешения IP-адресов. 

Предположим, что вы владеете доменом `example.com` и, для своего приложения, зоной `test.example.com` . Для двух альтернативных служебных шин теперь вы создадите две вложенные зоны и запись SRV в каждой из них. 

Записи SRV — это, согласно общему стандартному соглашению, с префиксом `_azure_servicebus._amqp` и хранением двух записей конечных точек: одна для AMQP-over-TLS через порт 5671, а другая для AMQP через WebSocket по порту 443, указывают на конечную точку служебной шины пространства имен, соответствующей зоне.

| Зона                 | Запись SRV
|----------------------|-------------------------------------------------------------
| `sb1.test.example.com` | **`_azure_servicebus._amqp.sb1.test.example.com`**<br>`1 1 5671 sb1-test-example-com.servicebus.windows.net`<br>`2 2 443 sb1-test-example-com.servicebus.windows.net`
| `sb2.test.example.com` | **`_azure_servicebus._amqp.sb1.test.example.com`**<br>`1 1 5671 sb2-test-example-com.servicebus.windows.net`<br>`2 2 443 sb2-test-example-com.servicebus.windows.net`

В зоне приложения вы создадите запись CNAME, которая указывает на подчиненную зону, соответствующую основной очереди или разделу:

| Запись CNAME                 | Псевдоним
|------------------------------|-------------------------------------------------------------
| `servicebus.test.example.com`  | `test1.test.example.com`

Используя DNS-клиент, который позволяет явно запрашивать записи CNAME и SRV (встроенные клиенты Java и .NET разрешают только простое разрешение имен в IP-адреса), вы можете разрешить нужную конечную точку. Например, с помощью [DnsClient.NET](https://dnsclient.michaco.net/)функция уточняющего запроса имеет следующее:

``` C#
static string GetServiceBusName(string aliasName)
{
    const string SrvRecordPrefix = "_azure_servicebus._amqp.";
    LookupClient lookup = new LookupClient();

    return (from CNameRecord alias in (lookup.Query(aliasName, QueryType.CNAME).Answers)
            from SrvRecord srv in lookup.Query(SrvRecordPrefix + alias.CanonicalName, QueryType.SRV).Answers
            where srv.Port == 5671
            select srv.Target).FirstOrDefault()?.Value.TrimEnd('.');
}
```

Функция возвращает имя целевого узла, зарегистрированное для порта 5671 зоны, в настоящее время псевдонимом которых является CNAME, как показано выше. 

Для выполнения отработки отказа необходимо изменить запись CNAME и указать ее на альтернативную зону. 

Преимущество использования DNS и, в частности [Azure DNS](../dns/dns-overview.md), состоит в том, что Azure DNS информация глобально реплицируется и, следовательно, устойчива к простоям одной области.

Эта процедура аналогична работе [географического аварийного восстановления служебной шины](service-bus-geo-dr.md) , но полностью размещается в собственном элементе управления и работает с сценариями "активный/активный".

#### <a name="file-share-based-failover-configuration"></a>Конфигурация отработки отказа на основе общей папки

Самый простой альтернативой использованию DNS для предоставления сведений о конечной точке является помещение имени основной конечной точки в обычный текстовый файл и обслуживание файла из инфраструктуры, которая является надежной по отношению к сбоям и по-прежнему позволяет выполнять обновления. 

Если вы уже запустили инфраструктуру веб-сайтов высокой надежности с глобальной репликацией доступности и содержимого, добавьте такой файл и повторно опубликуйте его, если требуется параметр.

## <a name="merge"></a>Объединение

Шаблон слияния содержит одну или несколько задач репликации, указывающих на одну цель, возможно, одновременно с обычными производителями, которые также отправляют сообщения в один и тот же целевой объект. 

Варианты этого шаблона:
- Две или более функции репликации одновременно получают сообщения из разных источников и отправляют их в один и тот же целевой объект.
- Еще одна функция репликации, получающая сообщения из источника, в то время как целевой объект также используется непосредственно производителями. 
- Более ранний шаблон, но сообщения, которые были отражены между двумя или более разделами, в результате чего эти разделы содержат одни и те же сообщения независимо от того, где создаются сообщения.

Первые два варианта шаблона являются тривиальными и не отличаются от обычных задач репликации.

Последний сценарий требует повторной репликации уже реплицированных сообщений. Этот метод демонстрируется и описывается в примере "активный/активный".

## <a name="editor"></a>Редактор

Шаблон редактора строится на схеме [репликации](#replication) , но сообщения изменяются до их пересылки. Ниже приведены примеры таких изменений.

- ***Перекодирование*** — если содержимое сообщения (также называемое "телом" или "полезная нагрузка") поступает из источника, закодированного с помощью формата *Apache Avro* или какого-либо собственного формата сериализации, но ожидание системы, владеющей целевым объектом, заключается в том, что для кодирования содержимого в формате *JSON* она сначала десериализует полезные данные из *Apache Avro* в граф объектов в памяти, а затем сериализует этот граф в формат *JSON* для перенаправляемого сообщения. Перекодирование также включает задачи **сжатия и распаковки содержимого** .
- ***Преобразование*** — сообщения, содержащие структурированные данные, могут потребовать перерисовки этих данных для упрощения использования нижестоящими потребителями. Это может затрагивать работу, например сведение вложенных структур, очистку лишних элементов данных или изменение формы полезной нагрузки в соответствии с заданной схемой.
- ***Пакетная обработка*** — сообщения могут быть получены пакетами (несколько сообщений в одной передачи) из источника, но должны перенаправляться в целевой объект или наоборот. Задача может, таким образом, пересылать несколько сообщений на основе одного входящего сообщения или объединять набор сообщений, которые затем передаются вместе. 
- ***Проверка*** — данные сообщений из внешних источников часто должны проверяться на соответствие набору правил, прежде чем они могут быть перенаправлены. Правила могут быть выражены с помощью схем или кода. сообщения, которые не соответствуют условиям соответствия, могут быть удалены с учетом проблемы, указанной в журналах, или могут быть перенаправлены в специальное целевое назначение для дальнейшей их работы.   
-  Для получения сообщений, поступающих из некоторых источников, может потребоваться обогащение с другим контекстом, чтобы его можно было использовать в целевых системах. Это может привести к поиску эталонных данных и внедрению этих данных с сообщением или добавлению сведений об источнике, известном задаче репликации, но не содержащихся в сообщениях. 
- ***Фильтрация*** . Некоторые сообщения, поступающие из источника, могут быть удержаны от целевого объекта на основе какого-либо правила. Фильтр проверяет сообщение по правилу и удаляет сообщение, если оно не соответствует правилу. Фильтрация повторяющихся сообщений путем наблюдения за определенными условиями и удаления последующих сообщений с теми же значениями является формой фильтрации.
- ***Маршрутизация и секционирование*** . Некоторые задачи репликации могут допускать две или более альтернативных целевых объектов, а также определять правила, для которых целевой объект репликации выбран для конкретного сообщения на основе метаданных или содержимого сообщения. Особая форма маршрутизации — секционирование, где задача явным образом назначает секции в одном целевом объекте репликации на основе правил.
- ***Шифрование*** — задача репликации может попытаться расшифровать содержимое, поступающие от источника, или зашифровать содержимое, перенаправленное в целевой объект, и (или) проверить целостность содержимого и метаданных относительно подписи, переданной в сообщении, или присоединить такую подпись. 
- ***Аттестация*** . Задача репликации может прикреплять метаданные, потенциально защищенные цифровой подписью, к сообщению, которое подтверждает, что сообщение было получено через конкретный канал или в определенное время.     
- ***Цепочка*** . Задача репликации может применять подписи к последовательностям сообщений таким же, что целостность последовательности защищена, и могут быть обнаружены отсутствующие сообщения.

Все эти шаблоны можно реализовать с помощью функций Azure, используя [триггер концентраторов сообщений](../azure-functions/functions-bindings-service-bus-trigger.md) для получения сообщений и [выходную привязку очереди или раздела](../azure-functions/functions-bindings-service-bus-output.md) для доставки. 

## <a name="routing"></a>Маршрутизация

Шаблон маршрутизации строится на схеме [репликации](#replication) , но вместо одного источника и одного целевого объекта задача репликации имеет несколько целевых объектов, показанных здесь в C#:

``` csharp
[FunctionName("SBRouter")]
public static async Task Run(
    [ServiceBusTrigger("source", Connection = "serviceBusConnectionAppSetting")] Message[] messages,
    [ServiceBus("dest1", Connection = "serviceBusConnectionAppSetting")] QueueClient output1,
    [ServiceBus("dest2", Connection = "serviceBusConnectionAppSetting")] QueueClient output2,
    ILogger log)
{
    foreach (Message messageData in messages)
    {
        // send to output1 or output2 based on criteria 
    }
}
```

Функция маршрутизации будет учитывать метаданные сообщения и (или) полезные данные сообщения, а затем выбрать одно из доступных назначений для отправки.

## <a name="next-steps"></a>Дальнейшие действия

- [приложения репликатора сообщений в функциях Azure][1]
- [Репликация сообщений между служебной шиной][2]
- [Репликация сообщений в концентраторы событий Azure][3]

[1]: service-bus-federation-replicator-functions.md
[2]: https://github.com/Azure-Samples/azure-messaging-replication-dotnet/tree/main/functions/config/ServiceBusCopy
[3]: https://github.com/Azure-Samples/azure-messaging-replication-dotnet/tree/main/functions/config/ServiceBusCopyToEventHub