---
title: JIT-доступ к виртуальным машинам в Центре безопасности Azure | Документация Майкрософт
description: В этом документе показано, как JIT-доступ к виртуальной машине в центре безопасности Azure помогает контролировать доступ к виртуальным машинам Azure.
services: security-center
author: memildin
manager: rkarlin
ms.service: security-center
ms.topic: how-to
ms.date: 07/12/2020
ms.author: memildin
ms.openlocfilehash: 60ae36d80e34f27ed68c679f47edacf3e402417c
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "98916156"
---
# <a name="secure-your-management-ports-with-just-in-time-access"></a>Защита портов управления с помощью JIT-доступа

Блокировка входящего трафика на виртуальные машины Azure с помощью функции доступа к виртуальной машине в центре безопасности Azure (JIT). Это снижает уязвимость атак, обеспечивая легкий доступ при необходимости подключения к виртуальной машине.

Полное описание принципов работы JIT и базовой логики см. [в разделе JIT-разъяснение](just-in-time-explained.md).

На этой странице описывается, как включить JIT в программу безопасности. Вы узнаете, как: 

- **Включите JIT на виртуальных машинах** . Вы можете включить JIT с собственными пользовательскими параметрами для одной или нескольких виртуальных машин с помощью центра безопасности, PowerShell или REST API. Кроме того, можно включить JIT с жестко заданными параметрами на виртуальных машинах Azure. При включении JIT-компилятор блокирует входящий трафик на виртуальные машины Azure, создавая правило в группе безопасности сети.
- **Запрос доступа к виртуальной машине с поддержкой JIT** . Цель JIT заключается в том, чтобы убедиться, что несмотря на то, что входящий трафик заблокирован, центр безопасности по-прежнему предоставляет простой доступ для подключения к виртуальным машинам при необходимости. Вы можете запросить доступ к виртуальной машине с поддержкой JIT, используя центр безопасности, виртуальные машины Azure, PowerShell или REST API.
- **Аудит действий** . чтобы убедиться, что виртуальные машины защищены надлежащим образом, проверьте доступ к виртуальным машинам с поддержкой JIT в рамках регулярных проверок безопасности.   



## <a name="availability"></a>Доступность

|Аспект|Сведения|
|----|:----|
|Состояние выпуска:|Общедоступная версия|
|Цены|Требуется [Azure Defender для серверов](defender-for-servers-introduction.md)|
|Поддерживаемые виртуальные машины:|![Да ](./media/icons/yes-icon.png) , виртуальные машины развернуты с помощью Azure Resource Manager.<br>![Нет ](./media/icons/no-icon.png) виртуальных машин, развернутых с помощью классических моделей развертывания. Дополнительные [сведения об этих моделях развертывания](../azure-resource-manager/management/deployment-models.md).<br>![Нет ](./media/icons/no-icon.png) виртуальных машин, защищенных брандмауэрами Azure, которыми управляет [Диспетчер брандмауэра Azure](../firewall-manager/overview.md)|
|Требуемые роли и разрешения|Роли **Reader** и **секуритиреадер** могут просматривать состояние JIT и параметры.<br>Сведения о создании настраиваемых ролей, которые могут работать с JIT-компилятором, см. в разделе [какие разрешения необходимы для настройки и использования JIT?](just-in-time-explained.md#what-permissions-are-needed-to-configure-and-use-jit).<br>Чтобы создать роль с минимальными привилегиями для пользователей, которым требуется запросить JIT-доступ к виртуальной машине, и не выполнять другие операции JIT, используйте [Скрипт Set-житлеастпривилежедроле](https://github.com/Azure/Azure-Security-Center/tree/master/Powershell%20scripts/JIT%20Custom%20Role) на страницах сообщества центра безопасности GitHub.|
|Облако.|![Да](./media/icons/yes-icon.png) Коммерческие облака<br>![Да](./media/icons/yes-icon.png) Национальные и независимые (US Gov, China Gov, другие правительственные облака)|
|||


## <a name="enable-jit-vm-access"></a>Включить JIT-доступ к виртуальной машине <a name="jit-configure"></a>

Вы можете включить JIT-доступ к виртуальным машинам с собственными пользовательскими параметрами для одной или нескольких виртуальных машин с помощью центра безопасности или программно. 

Кроме того, можно включить JIT с жестко заданными параметрами на виртуальных машинах Azure.

Каждый из этих вариантов описан на отдельной вкладке ниже.

### <a name="azure-security-center"></a>[**Центр безопасности Azure**](#tab/jit-config-asc)

### <a name="enable-jit-on-your-vms-from-azure-security-center"></a>Включение JIT на виртуальных машинах из центра безопасности Azure <a name="jit-asc"></a>

:::image type="content" source="./media/security-center-just-in-time/jit-config-security-center.gif" alt-text="Настройка JIT-доступа к виртуальным машинам в центре безопасности Azure":::

В центре безопасности можно включить и настроить JIT-доступ к виртуальной машине.

1. Откройте панель мониторинга защитника Azure и в области Расширенная защита выберите **JIT-доступ к виртуальной машине**.

    Откроется страница **JIT-доступа к виртуальной машине** с виртуальными машинами, сгруппированными в следующие вкладки:

    - **Настроенные** — виртуальные машины, которые уже настроены для поддержки JIT-доступа к виртуальным машинам. Для каждой виртуальной машины в настроенной вкладке отображается следующее:
        - число утвержденных JIT-запросов за последние семь дней
        - Дата и время последнего доступа
        - настроенные сведения о подключении
        - Последний пользователь
    - **Не настроено** — виртуальные машины без JIT-активации, которые могут поддерживать JIT. Рекомендуется включить JIT для этих виртуальных машин.
    - **Неподдерживаемые** виртуальные машины без JIT-активации и не поддерживают эту функцию. Виртуальная машина может находиться на этой вкладке по следующим причинам.
      - Отсутствует группа безопасности сети (NSG) — для JIT требуется настроить NSG
      - Классическая виртуальная машина — JIT поддерживает виртуальные машины, развернутые с помощью Azure Resource Manager, а не "классическое развертывание". Дополнительные [сведения о классической модели развертывания vs Azure Resource Manager](../azure-resource-manager/management/deployment-models.md).
      - Другие. на этой вкладке может быть виртуальная машина, если JIT-решение отключено в политике безопасности подписки или группы ресурсов.

1. На вкладке **не настроена** пометьте виртуальные машины для защиты с помощью JIT и выберите **включить JIT на виртуальных машинах**. 

    Откроется страница JIT-доступ к виртуальной машине с перечнем портов, которые центр безопасности рекомендует защищать:
    - 22 — SSH;
    - 3389 — RDP;
    - 5985 — WinRM; 
    - 5986 — WinRM.

    Чтобы принять параметры по умолчанию, нажмите кнопку **сохранить**.

1. Чтобы настроить параметры JIT, выполните следующие действия.

    - Добавьте настраиваемые порты с помощью кнопки **Добавить** . 
    - Измените один из портов по умолчанию, выбрав его из списка.

    Для каждого порта (настраиваемое и по умолчанию) на панели **Добавление конфигурации порта** доступны следующие параметры.

    - **Протокол**— протокол, разрешенный на этом порту при утверждении запроса.
    - **Разрешенные исходные** IP-адреса — диапазоны, разрешенные на этом порте при утверждении запроса.
    - **Максимальное время запроса**— максимальное время, в течение которого может быть открыт конкретный порт

     1. Настройте Безопасность порта в отношении ваших потребностей.

     1. Щелкните **ОК**.

1. Щелкните **Сохранить**.



### <a name="edit-the-jit-configuration-on-a-jit-enabled-vm-using-security-center"></a>Изменение JIT-конфигурации на виртуальной машине с поддержкой JIT с помощью центра безопасности <a name="jit-modify"></a>

Настроить JIT-конфигурацию виртуальной машины можно, добавив и настроив новый порт для защиты этой виртуальной машины или изменив любой другой параметр, связанный с уже защищенным портом.

Чтобы изменить существующие правила JIT для виртуальной машины, выполните следующие действия.

1. Откройте панель мониторинга защитника Azure и в области Расширенная защита выберите **адаптивные элементы управления приложениями**.

1. На вкладке **настроенный** щелкните правой кнопкой мыши виртуальную машину, к которой нужно добавить порт, и выберите Изменить. 

    ![Изменение конфигурации JIT-доступа к виртуальной машине в центре безопасности Azure](./media/security-center-just-in-time/jit-policy-edit-security-center.png)

1. В колонке **Настройка JIT-доступа к виртуальной машине** можно изменить существующие параметры уже защищенного порта или добавить новый порт.

1. Завершив редактирование портов, нажмите кнопку **сохранить**.
 


### <a name="azure-virtual-machines"></a>[**Виртуальные машины Azure**](#tab/jit-config-avm)

### <a name="enable-jit-on-your-vms-from-azure-virtual-machines"></a>Включение JIT для виртуальных машин Azure на виртуальных машинах

Активировать JIT на виртуальной машине можно на страницах виртуальных машин Azure портал Azure.

![Настройка JIT-доступа к виртуальной машине на виртуальных машинах Azure](./media/security-center-just-in-time/jit-config-virtual-machines.gif)

> [!TIP]
> Если у виртуальной машины уже есть включенная JIT-поддержка, при переходе на страницу ее настройки вы увидите, что JIT-поддержка включена и вы можете использовать ссылку, чтобы открыть страницу JIT-доступа к виртуальной машине в центре безопасности, а также просмотреть и изменить параметры.

1. В [портал Azure](https://ms.portal.azure.com)найдите и выберите **виртуальные машины**. 

1. Выберите виртуальную машину, которую необходимо защитить с помощью JIT.

1. В меню выберите пункт **Конфигурация**.

1. В разделе **JIT-доступ** выберите **включить JIT**. 

    Это обеспечивает JIT-доступ к виртуальной машине, используя следующие параметры по умолчанию:

    - Компьютеры Windows:
        - RDP-порт 3389;
        - Три часа максимального разрешенного доступа
        - Для разрешенных IP-адресов источника задано значение Any
    - Компьютеры Linux:
        - SSH-порт 22;
        - Три часа максимального разрешенного доступа
        - Для разрешенных IP-адресов источника задано значение Any

1. Чтобы изменить любое из этих значений или добавить порты в конфигурацию JIT, используйте страницу JIT центра безопасности Azure:

    1. В меню центра безопасности выберите JIT- **доступ к виртуальной машине**.

    1. На вкладке **настроенный** щелкните правой кнопкой мыши виртуальную машину, к которой нужно добавить порт, и выберите Изменить. 

        ![Изменение конфигурации JIT-доступа к виртуальной машине в центре безопасности Azure](./media/security-center-just-in-time/jit-policy-edit-security-center.png)

    1. В колонке **Настройка JIT-доступа к виртуальной машине** можно изменить существующие параметры уже защищенного порта или добавить новый порт.

    1. Завершив редактирование портов, нажмите кнопку **сохранить**.


### <a name="powershell"></a>[**PowerShell**](#tab/jit-config-powershell)

### <a name="enable-jit-on-your-vms-using-powershell"></a>Включение JIT-доступа на виртуальных машинах с помощью PowerShell

Чтобы включить JIT-доступ к виртуальным машинам из PowerShell, используйте официальный командлет PowerShell центра безопасности Azure `Set-AzJitNetworkAccessPolicy` .

**Пример** . Включение JIT-доступа к виртуальной машине на конкретной виртуальной машине со следующими правилами:

* Закройте порты 22 и 3389
* Установите максимальное время в 3 часа для каждого из них, чтобы их можно было открыть для утвержденного запроса.
* Разрешить пользователю, запрашивающему доступ, управлять исходными IP-адресами
* Разрешить пользователю, запрашивающему доступ, установить успешный сеанс при утверждении запроса на своевременный доступ

Эта JIT-конфигурация создается с помощью следующих команд PowerShell:

1. Назначьте переменную, которая содержит правила JIT-доступа к ВИРТУАЛЬНОЙ машине для виртуальной машины:

    ```azurepowershell
    $JitPolicy = (@{
        id="/subscriptions/SUBSCRIPTIONID/resourceGroups/RESOURCEGROUP/providers/Microsoft.Compute/virtualMachines/VMNAME";
        ports=(@{
             number=22;
             protocol="*";
             allowedSourceAddressPrefix=@("*");
             maxRequestAccessDuration="PT3H"},
             @{
             number=3389;
             protocol="*";
             allowedSourceAddressPrefix=@("*");
             maxRequestAccessDuration="PT3H"})})
    ```

1. Вставьте в массив правила JIT-доступа к виртуальной машине.
    
    ```azurepowershell
    $JitPolicyArr=@($JitPolicy)
    ```

1. Настройте правила JIT-доступа к виртуальной машине на выбранной виртуальной машине.
    
    ```azurepowershell
    Set-AzJitNetworkAccessPolicy -Kind "Basic" -Location "LOCATION" -Name "default" -ResourceGroupName "RESOURCEGROUP" -VirtualMachine $JitPolicyArr
    ```

    Используйте параметр-name, чтобы указать виртуальную машину. Например, чтобы установить JIT-конфигурацию для двух различных виртуальных машин, VM1 и VM2, используйте: ```Set-AzJitNetworkAccessPolicy -Name VM1``` и ```Set-AzJitNetworkAccessPolicy -Name VM2``` .


### <a name="rest-api"></a>[**Use the Application Insights REST API to build custom solutions**](#tab/jit-config-api) (Использование интерфейса REST API Application Insights для создания пользовательских решений)

### <a name="enable-jit-on-your-vms-using-the-rest-api"></a>Включение JIT на виртуальных машинах с помощью REST API

Функцию JIT-доступа к виртуальной машине можно использовать через API Центра безопасности Azure. Используйте этот API, чтобы получить сведения о настроенных виртуальных машинах, добавить новые, запросить доступ к виртуальной машине и многое другое. 

Дополнительные сведения см. в статье [политики JIT-доступа к сети](/rest/api/securitycenter/jitnetworkaccesspolicies).


--- 










## <a name="request-access-to-a-jit-enabled-vm"></a>Запрос доступа к виртуальной машине с поддержкой JIT

Вы можете запросить доступ к виртуальной машине с поддержкой JIT из портал Azure (в центре безопасности или виртуальных машинах Azure) или программно.

Каждый из этих вариантов описан на отдельной вкладке ниже.

### <a name="azure-security-center"></a>[**Центр безопасности Azure**](#tab/jit-request-asc)

### <a name="request-access-to-a-jit-enabled-vm-from-azure-security-center"></a>Запрос доступа к виртуальной машине с поддержкой JIT из центра безопасности Azure 

Если на виртуальной машине включен JIT-компилятор, необходимо запросить доступ для подключения к ней. Доступ можно запросить любым из поддерживаемых способов, независимо от того, как вы включили JIT.

:::image type="content" source="./media/security-center-just-in-time/jit-request-security-center.gif" alt-text="Запрос JIT-доступа из центра безопасности":::

1. На странице **JIT-доступ к виртуальной машине** выберите **настроенную** вкладку.

1. Пометьте виртуальные машины, к которым требуется получить доступ.

    - Значок в столбце **сведения о подключении** указывает, включен ли JIT в группе безопасности сети или брандмауэре. Если он включен для обоих типов, отображается только значок брандмауэра.

    - Столбец **сведения о подключении** содержит сведения, необходимые для подключения виртуальной машины и ее открытых портов.

1. Выберите **Запросить доступ**. Откроется окно **запрос доступа** .

1. В колонке **Запрос на доступ** укажите для каждой виртуальной машины порты, которые нужно открыть, IP-адреса источников для этих портов и временной интервал, в течение которого будет открыт порт. Можно будет запросить доступ только к настроенным портам. Каждый порт имеет максимально допустимое время, полученное на основе созданной JIT-конфигурации.

1. Выберите **Открыть порты**.

> [!NOTE]
> Если пользователь запрашивает доступ через прокси-сервер, то параметр **Мой IP-адрес** может не работать. Возможно, потребуется определить полный диапазон IP-адресов организации.



### <a name="azure-virtual-machines"></a>[**Виртуальные машины Azure**](#tab/jit-request-avm)

### <a name="request-access-to-a-jit-enabled-vm-from-the-azure-virtual-machines-connect-page"></a>Запрос доступа к виртуальной машине с поддержкой JIT с помощью страницы подключения виртуальной машины Azure

Если на виртуальной машине включен JIT-компилятор, необходимо запросить доступ для подключения к ней. Доступ можно запросить любым из поддерживаемых способов, независимо от того, как вы включили JIT.

  >![JIT-запрос по требованию](./media/security-center-just-in-time/jit-request-vm.png)


Чтобы запросить доступ из виртуальных машин Azure, сделайте следующее:

1. В портал Azure откройте страницы виртуальных машин.

1. Выберите виртуальную машину, к которой необходимо подключиться, и откройте страницу **Подключение** .

    Azure проверяет, включена ли JIT на этой виртуальной машине.

    - Если JIT не включен для виртуальной машины, вам будет предложено включить ее.

    - Если включена JIT, выберите **запрос доступа** для передачи запроса на доступ с запрошенным IP-адресом, диапазоном времени и портами, настроенными для этой виртуальной машины.

> [!NOTE]
> После утверждения запроса для виртуальной машины, защищенной с помощью брандмауэра Azure, центр безопасности предоставляет пользователю правильные сведения о подключении (сопоставление портов из таблицы ДНАТ), используемые для подключения к виртуальной машине.



### <a name="powershell"></a>[**PowerShell**](#tab/jit-request-powershell)

### <a name="request-access-to-a-jit-enabled-vm-using-powershell"></a>Запрос доступа к виртуальной машине с поддержкой JIT с помощью PowerShell

В следующем примере приведен запрос на JIT-доступ к выбранной виртуальной машине, где запрашивается открытие порта 22 для определенного IP-адреса и на определенное время.

В PowerShell выполните следующее.

1. Настройте свойства доступа для запроса виртуальной машины:

    ```azurepowershell
    $JitPolicyVm1 = (@{
        id="/subscriptions/SUBSCRIPTIONID/resourceGroups/RESOURCEGROUP/providers/Microsoft.Compute/virtualMachines/VMNAME";
        ports=(@{
           number=22;
           endTimeUtc="2020-07-15T17:00:00.3658798Z";
           allowedSourceAddressPrefix=@("IPV4ADDRESS")})})
    ```

1. Вставка параметров запроса доступа к виртуальной машине в массив.

    ```azurepowershell
    $JitPolicyArr=@($JitPolicyVm1)
    ```
        
1. Отправьте запрос на доступ (используйте идентификатор ресурса из шага 1).

    ```azurepowershell
    Start-AzJitNetworkAccessPolicy -ResourceId "/subscriptions/SUBSCRIPTIONID/resourceGroups/RESOURCEGROUP/providers/Microsoft.Security/locations/LOCATION/jitNetworkAccessPolicies/default" -VirtualMachine $JitPolicyArr
    ```

Дополнительные сведения см. в [документации по командлетам PowerShell](/powershell/scripting/developer/cmdlet/cmdlet-overview).



### <a name="rest-api"></a>[**Use the Application Insights REST API to build custom solutions**](#tab/jit-request-api) (Использование интерфейса REST API Application Insights для создания пользовательских решений)

### <a name="request-access-to-a-jit-enabled-vms-using-the-rest-api"></a>Запросите доступ к виртуальным машинам с поддержкой JIT, используя REST API

Функцию JIT-доступа к виртуальной машине можно использовать через API Центра безопасности Azure. Используйте этот API, чтобы получить сведения о настроенных виртуальных машинах, добавить новые, запросить доступ к виртуальной машине и многое другое. 

Дополнительные сведения см. в статье [политики JIT-доступа к сети](/rest/api/securitycenter/jitnetworkaccesspolicies).

---








## <a name="audit-jit-access-activity-in-security-center"></a>Аудит действий JIT-доступа в центре безопасности

Для просмотра действий виртуальной машины можно воспользоваться поиском по журналам. Чтобы просмотреть журналы, выполните следующие действия:

1. С **момента JIT-доступа к виртуальной машине** перейдите на вкладку **настроенные** .

1. Для виртуальной машины, для которой необходимо выполнить аудит, откройте меню с многоточием в конце строки.
 
1. В меню выберите пункт **Журнал действий** .

   ![Выбор JIT-журнала действий JIT](./media/security-center-just-in-time/jit-select-activity-log.png)

   Журнал действий содержит отфильтрованное представление предыдущих операций для этой виртуальной машины, а также время, дату и подписку.

1. Чтобы скачать данные журнала, выберите **скачать как CSV**.








## <a name="next-steps"></a>Дальнейшие действия

В этой статье вы узнали, как настроить и использовать JIT-доступ к виртуальной машине. Чтобы узнать, зачем использовать JIT, ознакомьтесь со статьей концепция, в которой объясняются угрозы для защиты:

> [!div class="nextstepaction"]
> [Описание JIT](just-in-time-explained.md)