---
title: Защита рабочих нагрузок для рабочих нагрузок Kubernetes
description: Узнайте, как использовать набор рекомендаций по безопасности для защиты рабочей нагрузки в центре безопасности Azure Kubernetes
services: security-center
author: memildin
manager: rkarlin
ms.service: security-center
ms.topic: how-to
ms.date: 09/12/2020
ms.author: memildin
ms.openlocfilehash: 99e217c6d8065d19f7b03419306f4992735cb587
ms.sourcegitcommit: ea822acf5b7141d26a3776d7ed59630bf7ac9532
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/03/2021
ms.locfileid: "99526740"
---
# <a name="protect-your-kubernetes-workloads"></a>Защита рабочих нагрузок Kubernetes

На этой странице описывается, как использовать набор рекомендаций по безопасности центра безопасности Azure, выделенный для защиты рабочей нагрузки Kubernetes.

Дополнительные сведения об этих функциях см. в статье [рекомендации по защите рабочих нагрузок с помощью управления допуском Kubernetes](container-security.md#workload-protection-best-practices-using-kubernetes-admission-control)

Центр безопасности предлагает больше функций безопасности контейнеров, если вы включаете защитник Azure. В частности, внесены следующие изменения.

- Проверка реестров контейнеров на наличие уязвимостей с помощью [защитника Azure для реестров контейнеров](defender-for-container-registries-introduction.md)
- Получение оповещений об обнаружении угроз в реальном времени для вашего кластера K8s в [защитнике Azure для Kubernetes](defender-for-kubernetes-introduction.md)

> [!TIP]
> Список *всех* рекомендаций по безопасности, которые могут появиться для кластеров и узлов Kubernetes, см. в [разделе Вычисление](recommendations-reference.md#recs-compute) в справочной таблице рекомендации.



## <a name="availability"></a>Доступность

|Аспект|Сведения|
|----|:----|
|Состояние выпуска:|Общедоступная версия|
|Цены|Free|
|Требуемые роли и разрешения|**Владелец** или **администратор безопасности** для изменения назначения<br>**Читатель** для просмотра рекомендаций|
|Требования к среде:|Требуется Kubernetes v 1.14 (или более поздняя версия)<br>Нет ресурса Подсекуритиполици (старая модель PSP) в кластерах<br>Узлы Windows не поддерживаются|
|Облако.|![Да](./media/icons/yes-icon.png) Коммерческие облака<br>![Нет](./media/icons/no-icon.png) Национальные и независимые (US Gov, China Gov, другие правительственные облака)|
|||


## <a name="set-up-your-workload-protection"></a>Настройка защиты рабочей нагрузки

Центр безопасности Azure включает набор рекомендаций, доступных при установке **надстройки политики Azure для Kubernetes**.

### <a name="step-1-deploy-the-add-on"></a>Шаг 1. развертывание надстройки

Чтобы настроить рекомендации, установите  **надстройку политики Azure для Kubernetes**. 

- Вы можете выполнить автоматическое развертывание этой надстройки, как описано в разделах [Включение автоматической подготовки расширений](security-center-enable-data-collection.md#enable-auto-provisioning-of-extensions). Если для автоматической подготовки для надстройки установлено значение "Вкл.", расширение по умолчанию включено во всех существующих и будущих кластерах (что соответствует требованиям к установке надстройки).

    :::image type="content" source="media/defender-for-kubernetes-usage/policy-add-on-auto-provision.png" alt-text="Использование средства автоматической подготовки центра безопасности для установки надстройки политики для Kubernetes":::

- Чтобы вручную развернуть надстройку, выполните следующие действия.

    1. На странице рекомендации найдите рекомендацию "**надстройка политики Azure для Kubernetes" должна быть установлена и включена в кластерах**". 

        :::image type="content" source="./media/defender-for-kubernetes-usage/recommendation-to-install-policy-add-on-for-kubernetes.png" alt-text="Рекомендация * * надстройка политики Azure для Kubernetes должна быть установлена и включена в кластерах * *":::

        > [!TIP]
        > Эта рекомендация включена в пять различных элементов управления безопасностью, и не имеет значения, выбранного на следующем шаге.

    1. В любом из элементов управления безопасностью выберите рекомендацию, чтобы просмотреть ресурсы, на которых можно установить надстройку.
    1. Выберите соответствующий кластер и **исправьте** его.

        :::image type="content" source="./media/defender-for-kubernetes-usage/recommendation-to-install-policy-add-on-for-kubernetes-details.png" alt-text="Страница сведений об рекомендации для * * надстройка политики Azure для Kubernetes должна быть установлена и включена в кластерах * *":::

### <a name="step-2-view-and-configure-the-bundle-of-13-recommendations"></a>Шаг 2. Просмотр и настройка пакета из 13 рекомендаций

1. Примерно через 30 минут после завершения установки надстройки центр безопасности отображает состояние работоспособности кластеров для следующих рекомендаций, каждое в соответствующем элементе управления безопасностью, как показано ниже.

    > [!TIP]
    > Некоторые рекомендации имеют параметры, которые необходимо настроить с помощью политики Azure, чтобы эффективно использовать их. Например, чтобы воспользоваться преимуществами образов контейнеров рекомендаций, которые **должны быть развернуты только из доверенных реестров**, необходимо определить доверенные реестры.
    > 
    > Если вы не вводите необходимые параметры для рекомендаций, требующих настройки, рабочие нагрузки будут отображаться как неработоспособные.

    | Имя рекомендации                                                         | Управление безопасностью                         | Требуется настройка |
    |-----------------------------------------------------------------------------|------------------------------------------|------------------------|
    | Для контейнеров должны соблюдаться ограничения по числу ЦП и объему оперативной памяти.                          | Защита приложений от атак от атак DDoS | Нет                     |
    | Требуется избегать привилегированных контейнеров                                     | Управление доступом и разрешениями            | Нет                     |
    | Для контейнеров должна применяться неизменяемая (доступная только для чтения) корневая файловая система     | Управление доступом и разрешениями            | Нет                     |
    | Контейнеры с повышением привилегий должны по возможности исключаться                       | Управление доступом и разрешениями            | Нет                     |
    | Работа контейнеров от имени привилегированного пользователя должна по возможности исключаться                           | Управление доступом и разрешениями            | Нет                     |
    | Контейнеры с общим доступом к важным пространствам имен узлов должны по возможности исключаться              | Управление доступом и разрешения            | Нет                     |
    | Для контейнеров должны применяться минимальные привилегированные возможности Linux.       | Управление доступом и разрешениями            | **Да**                |
    | Использование подключений тома с типом HostPath для pod должно быть ограничено известным списком    | Управление доступом и разрешения            | **Да**                |
    | Контейнеры должны ожидать передачи данных только на разрешенных портах                              | Ограничение несанкционированного доступа к сети     | **Да**                |
    | Службы должны ожидать передачи данных только на разрешенных портах                                | Ограничение несанкционированного доступа к сети     | **Да**                |
    | Использование сети и портов узлов должно быть ограничено                     | Ограничение несанкционированного доступа к сети     | **Да**                |
    | Возможности переопределения или отключения профиля AppArmor для контейнеров должны быть ограничены | Исправление конфигураций системы безопасности        | **Да**                |
    | Образы контейнеров должны развертываться только из доверенных реестров.            | Исправление уязвимостей                | **Да**                |
    |||


1. Чтобы получить рекомендации с параметрами, необходимо настроить параметры.

    1. В меню центра безопасности выберите пункт **Политика безопасности**.
    1. Выберите нужную подписку.
    1. В разделе **политика центра безопасности по умолчанию** выберите **Просмотреть действующую политику**.
    1. Выберите "ASC Default".
    1. Откройте вкладку **Параметры** и при необходимости измените значения.
    1. Выберите **Проверить и сохранить**.
    1. Щелкните **Сохранить**.


1. Чтобы применить любые рекомендации, 

    1. Откройте страницу сведений об рекомендации и выберите **запретить**:

        :::image type="content" source="./media/defender-for-kubernetes-usage/enforce-workload-protection-example.png" alt-text="Параметр Deny для параметра политики Azure":::

        Откроется область, где задается область. 

    1. Завершив настройку области, выберите Изменить, **чтобы запретить**.

1. Чтобы узнать, какие рекомендации применяются к кластерам:

    1. Откройте страницу " [Инвентаризация активов](asset-inventory.md) " центра безопасности и используйте фильтр типов ресурсов для **Kubernetes Services**.

    1. Выберите кластер для изучения и просмотрите доступные рекомендации. 

1. При просмотре рекомендаций из набора защиты рабочей нагрузки вы увидите число затронутых модулей Pod ("компоненты Kubernetes"), перечисленных рядом с кластером. Для получения списка конкретных модулей Pod выберите кластер и нажмите кнопку **выполнить действие**.

    :::image type="content" source="./media/defender-for-kubernetes-usage/view-affected-pods-for-recommendation.gif" alt-text="Просмотр затронутых модулей Pod для рекомендации по K8s"::: 

1. Чтобы протестировать принудительное применение, используйте два развертывания Kubernetes ниже:

    - Один предназначен для работоспособного развертывания, соответствующий набору рекомендаций по защите рабочей нагрузки.
    - Второй — для неработоспособного развертывания, не соответствующего *ни одной* из рекомендаций.

    Разверните файл example. YAML как есть или используйте их в качестве ссылки для исправления собственной рабочей нагрузки (шаг ВИИИ).  


## <a name="healthy-deployment-example-yaml-file"></a>Пример работоспособного развертывания. YAML файл

```yml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis-healthy-deployment
  labels:
    app: redis
spec:
  replicas: 3
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
      annotations:
        apparmor.security.beta.kubernetes.io/pod: runtime/default
        container.apparmor.security.beta.kubernetes.io/redis: runtime/default
    spec:
      containers:
      - name: redis
        image: healthyClusterRegistry.azurecr.io/redis:latest
        ports:
        - containerPort: 80
        resources:
          limits:
            cpu: 100m
            memory: 250Mi
        securityContext:
          privileged: false
          readOnlyRootFilesystem: true
          allowPrivilegeEscalation: false
          runAsNonRoot: true
          runAsUser: 1000
---
apiVersion: v1
kind: Service
metadata:
  name: redis-healthy-service
spec:
  type: LoadBalancer
  selector:
    app: redis
  ports:
  - port: 80
    targetPort: 80
```

## <a name="unhealthy-deployment-example-yaml-file"></a>Пример неработоспособного развертывания. файл YAML

```yml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-unhealthy-deployment
  labels:
    app: nginx
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:      
      labels:
        app: nginx
    spec:
      hostNetwork: true
      hostPID: true 
      hostIPC: true
      containers:
      - name: nginx
        image: nginx:1.15.2
        ports:
        - containerPort: 9001
          hostPort: 9001
        securityContext:
          privileged: true
          readOnlyRootFilesystem: false
          allowPrivilegeEscalation: true
          runAsUser: 0
          capabilities:
            add:
              - NET_ADMIN
        volumeMounts:
        - mountPath: /test-pd
          name: test-volume
          readOnly: true
      volumes:
      - name: test-volume
        hostPath:
          # directory location on host
          path: /tmp
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-unhealthy-service
spec:
  type: LoadBalancer
  selector:
    app: nginx
  ports:
  - port: 6001
    targetPort: 9001
```



## <a name="next-steps"></a>Следующие шаги

В этой статье вы узнали, как настроить защиту рабочей нагрузки Kubernetes. 

Другие связанные материалы см. на следующих страницах: 

- [Рекомендации центра безопасности для вычислений](recommendations-reference.md#recs-compute)
- [Оповещения для уровня кластера AKS](alerts-reference.md#alerts-akscluster)
- [Оповещения для уровня узла контейнера](alerts-reference.md#alerts-containerhost)