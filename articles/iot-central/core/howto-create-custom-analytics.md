---
title: Расширение IoT Central Azure с помощью настраиваемой аналитики | Документация Майкрософт
description: Разработчик решения настраивает IoT Central приложение для настраиваемой аналитики и визуализаций. В этом решении используется Azure Databricks.
author: TheRealJasonAndrew
ms.author: v-anjaso
ms.date: 03/15/2021
ms.topic: how-to
ms.service: iot-central
services: iot-central
ms.custom: mvc
manager: philmea
ms.openlocfilehash: 3132ec8fb3cb123653887d92a2f33788f40564c0
ms.sourcegitcommit: bb330af42e70e8419996d3cba4acff49d398b399
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/24/2021
ms.locfileid: "105033829"
---
# <a name="extend-azure-iot-central-with-custom-analytics-using-azure-databricks"></a>Расширьте IoT Central Azure с помощью настраиваемой аналитики, используя Azure Databricks

В этом пошаговом руководство показано, как разработчик решения, как расширить приложение IoT Central с помощью пользовательской аналитики и визуализаций. В примере используется рабочая область [Azure Databricks](/azure/azure-databricks/) для анализа потока данных телеметрии IOT Central и создания визуализаций, таких как [блочные графики](https://wikipedia.org/wiki/Box_plot).  

В этом пошаговом руководство показано, как расширить IoT Central, за исключением того, что он может сделать с помощью [встроенных средств анализа](./howto-create-custom-analytics.md).

В этом пошаговом руководство вы узнаете, как выполнять следующие задачи:

* Потоковая передача телеметрии из IoT Central приложения с помощью *непрерывного экспорта данных*.
* Создайте среду Azure Databricks для анализа и построения данных телеметрии устройств.

## <a name="prerequisites"></a>Предварительные требования

Чтобы выполнить действия, описанные в этом руководстве, вам потребуется активная подписка Azure.

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

### <a name="iot-central-application"></a>Приложение IoT Central

Создайте приложение IoT Central на веб-сайте [диспетчера приложений Azure IOT Central](https://aka.ms/iotcentral) со следующими параметрами:

| Параметр | Значение |
| ------- | ----- |
| Ценовой план | Standard |
| Шаблон приложения | Аналитика в магазине — мониторинг условий |
| имя приложения; | Примите значение по умолчанию или выберите собственное имя. |
| URL-адрес | Примите значение по умолчанию или выберите собственный уникальный префикс URL-адреса. |
| Каталог | Клиент Azure Active Directory |
| Подписка Azure. | Ваша подписка Azure. |
| Region | Ближайший регион |

В примерах и снимках экрана в этой статье используется **США** регион. Выберите расположение, близкое к вам, и убедитесь, что вы создали все ресурсы в том же регионе.

Этот шаблон приложения включает два смоделированных устройства термостата, которые отправляют данные телеметрии.

### <a name="resource-group"></a>Группа ресурсов

Используйте [портал Azure, чтобы создать группу ресурсов](https://portal.azure.com/#create/Microsoft.ResourceGroup) с именем **иотцентраланалисис** , которая будет содержать другие создаваемые ресурсы. Создайте ресурсы Azure в том же расположении, что и приложение IoT Central.

### <a name="event-hubs-namespace"></a>пространство имен Центров событий;

Используйте [портал Azure, чтобы создать пространство имен концентраторов событий](https://portal.azure.com/#create/Microsoft.EventHub) со следующими параметрами:

| Параметр | Значение |
| ------- | ----- |
| Имя    | Выберите имя пространства имен |
| Ценовая категория | Basic |
| Подписка | Ваша подписка |
| Группа ресурсов | иотцентраланалисис |
| Расположение | Восточная часть США |
| Единицы пропускной способности | 1 |

### <a name="azure-databricks-workspace"></a>Рабочая область Azure Databricks

Используйте [портал Azure для создания службы Azure Databricks](https://portal.azure.com/#create/Microsoft.Databricks) со следующими параметрами:

| Параметр | Значение |
| ------- | ----- |
| имя рабочей области.    | Выберите имя рабочей области |
| Подписка | Ваша подписка |
| Группа ресурсов | иотцентраланалисис |
| Расположение | Восточная часть США |
| Ценовая категория | Standard |

После создания необходимых ресурсов ваша группа ресурсов **иотцентраланалисис** выглядит как на следующем снимке экрана:

:::image type="content" source="media/howto-create-custom-analytics/resource-group.png" alt-text="изображение группы ресурсов IoT Central Analysis.":::

## <a name="create-an-event-hub"></a>Создание концентратора событий

Вы можете настроить IoT Central приложение для непрерывного экспорта данных телеметрии в концентратор событий. В этом разделе вы создадите концентратор событий для получения данных телеметрии из приложения IoT Central. Концентратор событий доставляет данные телеметрии в задание Stream Analytics для обработки.

1. В портал Azure перейдите к пространству имен концентраторов событий и выберите **+ концентратор событий**.
1. Назовите концентратор событий **централекспорт**.
1. В списке концентраторов событий в пространстве имен выберите **централекспорт**. Затем выберите **политики общего доступа**.
1. Щелкните **+ Добавить**. Создайте политику с именем **сендлистен** с утверждениями **Send** и **Listen** .
1. Когда политика будет готова, выберите ее в списке, а затем скопируйте значение **строки подключения — первичный ключ** .
1. Запишите эту строку подключения, которая будет использоваться позже при настройке записной книжки модуля данных для чтения из концентратора событий.

Пространство имен концентраторов событий выглядит как на следующем снимке экрана:

:::image type="content" source="media/howto-create-custom-analytics/event-hubs-namespace.png" alt-text="изображение пространства имен концентраторов событий.":::

## <a name="configure-export-in-iot-central"></a>Настройка экспорта в IoT Central

В этом разделе вы настроите приложение для потоковой передачи данных телеметрии из виртуальных устройств в концентратор событий.

На веб-сайте [Azure IOT Central Application Manager](https://aka.ms/iotcentral) перейдите к созданному ранее приложению IOT Central. Чтобы настроить экспорт, сначала создайте назначение:

1. Перейдите на страницу **Экспорт данных** , а затем выберите **назначения**.
1. Выберите **+ новое назначение**.
1. Чтобы создать назначение, используйте значения из следующей таблицы:

    | Параметр | Значение |
    | ----- | ----- |
    | Имя назначения | Концентратор событий телеметрии |
    | Тип назначения | Центры событий Azure |
    | Строка подключения | Строка подключения концентратора событий, к которой вы предоставили заметку ранее |

    **Концентратор событий** показывает как **централекспорт**.

    :::image type="content" source="media/howto-create-custom-analytics/data-export-1.png" alt-text="Снимок экрана, на котором показано назначение экспорта данных.":::

1. Нажмите кнопку **Сохранить**.

Чтобы создать определение экспорта, выполните следующие действия.

1. Перейдите на страницу **экспорта данных** и выберите **+ Новый экспорт**.

1. Для настройки экспорта используйте значения, приведенные в следующей таблице.

    | Параметр | Значение |
    | ------- | ----- |
    | Имя экспорта | Экспорт концентратора событий |
    | Активировано | Включено |
    | Тип данных для экспорта | Телеметрия |
    | Места назначения | Выберите **+ назначение**, а затем выберите **концентратор событий телеметрии** . |

1. Нажмите кнопку **Сохранить**.

    :::image type="content" source="media/howto-create-custom-analytics/data-export-2.png" alt-text="Снимок экрана, показывающий определение экспорта данных.":::

Прежде чем продолжить, подождите, пока состояние экспорта будет **работоспособно** на странице **экспорта данных** .

## <a name="configure-databricks-workspace"></a>Настройка рабочей области кирпичей

В портал Azure перейдите к службе Azure Databricks и выберите **запустить рабочую область**. В браузере откроется новая вкладка с входом в рабочую область.

### <a name="create-a-cluster"></a>Создание кластера

На странице **Azure Databricks** в списке типичных задач выберите **новый кластер**.

Используйте сведения, приведенные в следующей таблице, чтобы создать кластер.

| Параметр | Значение |
| ------- | ----- |
| Имя кластера, | централаналисис |
| Режим кластера | Standard |
| Версия Databricks Runtime | 5,5 LTS (Scala 2,11, Spark 2.4.5) |
| Версия Python | 3 |
| Включение автомасштабирования | Нет |
| Завершить через несколько минут бездействия | 30 |
| Тип рабочего процесса | Standard_DS3_v2 |
| Рабочие роли | 1 |
| Тип драйвера | То же, что и Рабочая роль |

Создание кластера может занять несколько минут, дождитесь завершения создания кластера, прежде чем продолжить.

### <a name="install-libraries"></a>Установка библиотек

На странице **кластеры** дождитесь **выполнения** состояния кластера.

Ниже показано, как импортировать библиотеку, которая требуется для примера, в кластер.

1. На странице **кластеры** дождитесь **работоспособности** интерактивного кластера **централаналисис** .

1. Выберите кластер, а затем перейдите на вкладку **библиотеки** .

1. На вкладке **библиотеки** выберите **установить новый**.

1. На странице **Установка библиотеки** выберите **Maven** в качестве источника библиотеки.

1. В текстовом поле **координаты** введите следующее значение: `com.microsoft.azure:azure-eventhubs-spark_2.11:2.3.10`

1. Нажмите кнопку **установить** , чтобы установить библиотеку в кластере.

1. Теперь состояние библиотеки **установлено**:

:::image type="content" source="media/howto-create-custom-analytics/cluster-libraries.png" alt-text="Снимок экрана с установленной библиотекой.":::

### <a name="import-a-databricks-notebook"></a>Импорт записной книжки кирпичей

Выполните следующие действия, чтобы импортировать записную книжку данных о модулях данных, содержащую код Python, для анализа и визуализации данных телеметрии IoT Central:

1. Перейдите на страницу **рабочей области** в среде "кирпичы". Выберите раскрывающийся список рядом с именем своей учетной записи и нажмите кнопку **Импорт**.

1. Выберите Импорт из URL-адреса и введите следующий адрес: [https://github.com/Azure-Samples/iot-central-docs-samples/blob/master/databricks/IoT%20Central%20Analysis.dbc?raw=true](https://github.com/Azure-Samples/iot-central-docs-samples/blob/master/databricks/IoT%20Central%20Analysis.dbc?raw=true)

1. Чтобы импортировать записную книжку, нажмите кнопку **Импорт**.

1. Выберите **рабочую область** , чтобы просмотреть импортированную записную книжку:

:::image type="content" source="media/howto-create-custom-analytics/import-notebook.png" alt-text="Снимок экрана импортированной записной книжки.":::

5. Измените код в первой ячейке Python, чтобы добавить сохраненную ранее строку подключения концентраторов событий:

    ```python
    from pyspark.sql.functions import *
    from pyspark.sql.types import *

    ###### Event Hub Connection strings ######
    telementryEventHubConfig = {
      'eventhubs.connectionString' : '{your Event Hubs connection string}'
    }
    ```

## <a name="run-analysis"></a>Запустить анализ

Чтобы запустить анализ, необходимо подключить записную книжку к кластеру:

1. Выберите **отсоединено** и выберите кластер **централаналисис** .
1. Если кластер не запущен, запустите его.
1. Чтобы запустить записную книжку, нажмите кнопку выполнить.

В последней ячейке может появиться сообщение об ошибке. Если да, убедитесь, что предыдущие ячейки запущены, подождите, пока некоторые данные будут записаны в хранилище, а затем снова запустите последнюю ячейку.

### <a name="view-smoothed-data"></a>Просмотр сглаженных данных

В записной книжке прокрутите вниз до ячейки 14, чтобы увидеть график влажности скользящего среднего по типу устройства. Этот график непрерывно обновляется, когда поступает потоковая передача телеметрии:

:::image type="content" source="media/howto-create-custom-analytics/telemetry-plot.png" alt-text="Снимок экрана с сглаженной диаграммой телеметрии.":::

Вы можете изменить размер диаграммы в записной книжке.

### <a name="view-box-plots"></a>Диаграммы в окне просмотра

В записной книжке прокрутите вниз до ячейки 20, чтобы увидеть [блочные диаграммы](https://en.wikipedia.org/wiki/Box_plot). Блочные диаграммы основаны на статических данных, поэтому для их обновления необходимо повторно запустить ячейку:

:::image type="content" source="media/howto-create-custom-analytics/box-plots.png" alt-text="Снимок экрана с блочными графиками.":::

Можно изменить размер графиков в записной книжке.

## <a name="tidy-up"></a>Удаление ненужных элементов

Чтобы устранить эту работу и избежать ненужных затрат, удалите группу ресурсов **иотцентраланалисис** в портал Azure.

Вы можете удалить IoT Centralное приложение со страницы **Управление** в приложении.

## <a name="next-steps"></a>Дальнейшие действия

В этом руководстве вы узнали следующее:

* Потоковая передача телеметрии из IoT Central приложения с помощью *непрерывного экспорта данных*.
* Создание Azure Databricks среды для анализа и построения данных телеметрии.

Теперь, когда вы узнали, как создать пользовательскую аналитику, предлагаем следующий шаг — Узнайте, как [визуализировать и анализировать данные IOT Central Azure на панели мониторинга Power BI](howto-connect-powerbi.md).
