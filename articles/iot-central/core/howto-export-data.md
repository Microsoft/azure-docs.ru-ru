---
title: Экспорт данных из IoT Central Azure | Документация Майкрософт
description: Как использовать новый экспорт данных для экспорта данных IoT в Azure и назначения пользовательских облаков.
services: iot-central
author: viv-liu
ms.author: viviali
ms.date: 01/27/2021
ms.topic: how-to
ms.service: iot-central
ms.custom: contperf-fy21q1, contperf-fy21q3
ms.openlocfilehash: d31673b8d789cff5de3ddce63b67a98854b7aabc
ms.sourcegitcommit: e972837797dbad9dbaa01df93abd745cb357cde1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/14/2021
ms.locfileid: "100515909"
---
# <a name="export-iot-data-to-cloud-destinations-using-data-export"></a>Экспорт данных IoT в облачные назначения с помощью экспорта данных

> [!Note]
> В этой статье описываются функции экспорта данных в IoT Central. Дополнительные сведения о функциях экспорта данных прежних версий см. в статье [Экспорт данных Интернета вещей в облачные назначения с помощью экспорта данных (прежние версии)](./howto-export-data-legacy.md).

В этой статье описывается, как использовать новую функцию экспорта данных в Azure IoT Central. Используйте эту функцию для непрерывного экспорта отфильтрованных и обогащенных данных IoT из приложения IoT Central. Экспорт данных позволяет отправлять изменения практически в реальном времени в другие части облачного решения для получения подробных сведений, аналитики и хранилища для теплого пути.

Например, вы можете:

- Непрерывно экспортируйте данные телеметрии и изменения свойств в формате JSON практически в реальном времени.
- Фильтрация потоков данных для экспорта данных, соответствующих пользовательским условиям.
- Расширить потоки данных с помощью пользовательских значений и значений свойств с устройства.
- Отправьте данные в назначения, такие как концентраторы событий Azure, служебная шина Azure, хранилище BLOB-объектов Azure и конечные точки веб-перехватчика.

> [!Tip]
> При включении экспорта данных вы получаете только данные из этого момента. В настоящее время невозможно получить данные за время отключения экспорта данных. Чтобы хранить более исторические данные, включите экспорт данных на раннем этапе.

## <a name="prerequisites"></a>Предварительные требования

Чтобы использовать функции экспорта данных, необходимо иметь [приложение v3](howto-get-app-info.md)и иметь разрешение на [Экспорт данных](howto-manage-users-roles.md) .

Если у вас есть приложение v2, см. статью [миграция приложения IOT Central v2 в версии 3](howto-migrate.md).

## <a name="set-up-export-destination"></a>Настройка места назначения экспорта

Назначение экспорта должно существовать до настройки экспорта данных. В настоящее время доступны следующие типы назначения:

- Центры событий Azure
- Очередь служебной шины Azure
- Раздел служебной шины Azure
- хранилище BLOB-объектов Azure
- webhook

### <a name="create-an-event-hubs-destination"></a>Создание назначения концентраторов событий

Если у вас нет пространства имен концентраторов событий для экспорта, выполните следующие действия.

1. Создайте [пространство имен Центров событий на портале Azure](https://ms.portal.azure.com/#create/Microsoft.EventHub). Дополнительные сведения см. в [документации по Центрам событий Azure](../../event-hubs/event-hubs-create.md).

1. Создайте концентратор событий в пространстве имен в Центрах событий. Перейдите к пространству имен и выберите **+ Концентратор событий** в верхней части, чтобы создать экземпляр концентратора событий.

1. Создайте ключ, который будет использоваться при настройке экспорта данных в IoT Central.

    - Выберите созданный экземпляр концентратора событий.
    - Выберите **параметры > политики общего доступа**.
    - Создайте новый ключ или выберите существующий ключ с разрешениями на **отправку** .
    - Скопируйте основную или дополнительную строку подключения. Эта строка подключения используется для настройки нового назначения в IoT Central.
    - Кроме того, можно создать строку подключения для всего пространства имен концентраторов событий:
        1. Перейдите к пространству имен концентраторов событий в портал Azure.
        2. В разделе **Параметры** выберите **политики общего доступа** .
        3. Создайте новый ключ или выберите существующий ключ с разрешениями на **отправку** .
        4. Скопируйте основную или дополнительную строку подключения.
        
### <a name="create-a-service-bus-queue-or-topic-destination"></a>Создание очереди или назначения раздела служебной шины

Если у вас нет пространства имен служебной шины для экспорта, выполните следующие действия.

1. Создайте [новое пространство имен служебной шины в портал Azure](https://ms.portal.azure.com/#create/Microsoft.ServiceBus.1.0.5). Дополнительные сведения см. в [документации по Служебной шине Azure](../../service-bus-messaging/service-bus-create-namespace-portal.md).

1. Чтобы создать очередь или раздел для экспорта, перейдите к пространству имен служебной шины и выберите **+ очередь** или **+ раздел**.

1. Создайте ключ, который будет использоваться при настройке экспорта данных в IoT Central.

    - Выберите созданную очередь или раздел.
    - Выберите **Параметры/политики общего доступа**.
    - Создайте новый ключ или выберите существующий ключ с разрешениями на **отправку** .
    - Скопируйте основную или дополнительную строку подключения. Эта строка подключения используется для настройки нового назначения в IoT Central.
    - Кроме того, можно создать строку подключения для всего пространства имен служебной шины:
        1. Перейдите к пространству имен служебной шины в портал Azure.
        2. В разделе **Параметры** выберите **политики общего доступа** .
        3. Создайте новый ключ или выберите существующий ключ с разрешениями на **отправку** .
        4. Скопируйте основную или дополнительную строку подключения.

### <a name="create-an-azure-blob-storage-destination"></a>Создание места назначения хранилища BLOB-объектов Azure

Если у вас нет существующей учетной записи хранения Azure для экспорта, выполните следующие действия.

1. Создайте [учетную запись хранения на портале Azure](https://ms.portal.azure.com/#create/Microsoft.StorageAccount-ARM). Вы можете узнать больше о создании новых [учетных записей хранения BLOB-объектов Azure](../../storage/blobs/storage-quickstart-blobs-portal.md) или [учетных записей хранения Azure Data Lake Storage v2](../../storage/common/storage-account-create.md). Экспорт данных может записывать данные только в учетные записи хранения, поддерживающие блочные BLOB-объекты. В следующем списке приведены известные совместимые типы учетных записей хранения.

    |Уровень производительности|Тип учетной записи|
    |-|-|
    |Стандартный|общего назначения v2|
    |Стандартный|общего назначения v1|
    |Стандартный|Хранилище BLOB-объектов|
    |Premium|Блочное хранилище BLOB-объектов|

1. Чтобы создать контейнер в учетной записи хранения, перейдите к своей учетной записи хранения. Выберите **Обзор BLOB-объектов** в разделе **Служба BLOB-объектов**. Выберите **+ Контейнер** в верхней части экрана, чтобы создать контейнер.

1. Создайте строку подключения для учетной записи хранения, выбрав **параметры > ключи доступа**. Скопируйте одну из двух строк подключения.

### <a name="create-a-webhook-endpoint"></a>Создание конечной точки веб-перехватчика

Вы можете экспортировать данные в общедоступную конечную точку веб-перехватчика HTTP. Вы можете создать тестовую конечную точку веб-перехватчика с помощью [RequestBin](https://requestbin.net/). RequestBin регулирование запроса при достижении предельного числа запросов:

1. Откройте [RequestBin](https://requestbin.net/).
2. Создайте новый RequestBin и скопируйте **Bin URL** (URL-адрес Bin). Этот URL-адрес используется при проверке экспорта данных.

## <a name="set-up-data-export"></a>Настройка экспорта данных

Теперь, когда у вас есть место для экспорта данных, настройте экспорт данных в приложении IoT Central:

1. Войдите в приложение IoT Central.

1. На левой панели выберите **Экспорт данных**.

    > [!Tip]
    > Если вы не видите элемент **Экспорт данных** в левой области, у вас нет разрешений на настройку экспорта данных в приложении. Обратитесь к администратору, чтобы настроить экспорт данных.

1. Выберите **+ Новый экспорт**.

1. Введите отображаемое имя для нового экспорта и убедитесь, что экспорт данных **включен**.

1. Выберите тип данных для экспорта. В следующей таблице перечислены поддерживаемые типы экспорта данных.

    | Тип данных | Описание | Формат данных |
    | :------------- | :---------- | :----------- |
    |  Телеметрия | Экспорт сообщений телеметрии с устройств практически в реальном времени. Каждое экспортированное сообщение содержит полное содержимое исходного сообщения устройства, нормализованное.   |  [Формат сообщений телеметрии](#telemetry-format)   |
    | Изменения свойств | Экспорт изменений в свойства устройства и облака в ближайшем режиме реального времени. Для свойств устройств, доступных только для чтения, экспортируются изменения в сообщаемых значениях. Для свойств, доступных для чтения и записи, экспортируются и сообщаемые, и нужные значения. | [Формат сообщения об изменении свойства](#property-changes-format) |

<a name="DataExportFilters"></a>
1. При необходимости добавьте фильтры, чтобы уменьшить объем экспортируемых данных. Существует несколько типов фильтров, доступных для каждого типа экспорта данных:

    Для фильтрации телеметрических данных можно:

    - **Отфильтруйте** экспортированный поток, чтобы он содержал только данные телеметрии с устройств, которые соответствуют имени устройства, идентификатору устройства и условию фильтра шаблона устройства.
    - **Фильтрация** по возможностям. при выборе элемента телеметрии в раскрывающемся списке **имя** экспортированный поток содержит только данные телеметрии, соответствующие условию фильтра. При выборе элемента свойств устройства или облака в раскрывающемся списке **имя** экспортированный поток содержит только данные телеметрии с устройств со свойствами, соответствующими условию фильтра.
    - **Фильтр свойств сообщения**. устройства, использующие пакеты SDK для устройств, могут передавать *Свойства сообщений* или *свойства приложения* в каждое сообщение телеметрии. Свойства представляют собой набор пар "ключ-значение", которые отмечают сообщение пользовательскими идентификаторами. Чтобы создать фильтр свойств сообщения, введите искомый ключ свойства сообщения и укажите условие. Экспортируются только сообщения телеметрии со свойствами, соответствующими заданному условию фильтра. Поддерживаются следующие операторы сравнения строк: Equals, не равно, Contains, не содержит, не существует. Дополнительные [сведения о свойствах приложений из документации центра Интернета вещей](../../iot-hub/iot-hub-devguide-messages-construct.md).

    Чтобы отфильтровать изменения свойств, используйте **Фильтр возможностей**. Выберите элемент свойства в раскрывающемся списке. Экспортированный поток содержит только изменения выбранного свойства, соответствующие условию фильтра.

<a name="DataExportEnrichmnents"></a>
1. При необходимости дополняет экспортированные сообщения дополнительными метаданными пары "ключ-значение". Для типов экспорта данных телеметрии и свойств доступны следующие дополнения:

    - **Пользовательская строка**: добавляет пользовательскую статическую строку к каждому сообщению. Введите любой ключ и введите строковое значение.
    - **Свойство**: добавляет текущее свойство сообщаемого устройства или значение облачного свойства в каждое сообщение. Введите любой ключ и выберите свойство устройства или облака. Если экспортированное сообщение относится к устройству, которое не имеет указанного свойства, экспортируемое сообщение не получается.

1. Добавьте новое место назначения или добавьте уже созданное назначение. Выберите ссылку **создать новую** и добавьте следующую информацию:

    - **Имя назначения**: отображаемое имя назначения в IOT Central.
    - **Тип назначения**: выберите тип назначения. Если вы еще не настроили Назначение, см. раздел [Настройка назначения экспорта](#set-up-export-destination).
    - Для концентраторов событий Azure, очереди или раздела служебной шины Azure вставьте строку подключения для ресурса и при необходимости введите сведения о концентраторе событий, очереди или имени раздела с учетом регистра.
    - Для хранилища BLOB-объектов Azure вставьте строку подключения для ресурса и при необходимости введите имя контейнера с учетом регистра.
    - Для веб-перехватчика вставьте URL обратного вызова для конечной точки веб-перехватчика. При необходимости можно настроить авторизацию веб-перехватчика (OAuth 2,0 и токен авторизации) и добавить пользовательские заголовки. 
        - Для OAuth 2,0 поддерживается только поток учетных данных клиента. После сохранения места назначения IoT Central будет взаимодействовать с поставщиком OAuth для получения маркера авторизации. Этот маркер будет присоединен к заголовку "Authorization" для каждого сообщения, отправленного в это место назначения.
        - Для маркера авторизации можно указать значение маркера, которое будет напрямую присоединен к заголовку Authorization для каждого сообщения, отправляемого в это место назначения.
    - Щелкните **Создать**.

1. Выберите **+ назначение** и выберите назначение из раскрывающегося списка. В один экспорт можно добавить до пяти назначений.

1. Завершив настройку экспорта, нажмите кнопку **сохранить**. Через несколько минут данные отобразятся в местах назначения.

## <a name="monitor-your-export"></a>Мониторинг экспорта

Помимо состояния экспортируемых компонентов в IoT Central можно отслеживать объем данных, передаваемых через экспорты, и наблюдать за ошибками экспорта на платформе данных Azure Monitor. Вы можете получить доступ к метрикам экспорта и работоспособности устройств на диаграммах в портал Azure, REST API или запросах в PowerShell или Azure CLI. Сейчас вы можете отслеживать эти метрики экспорта данных в Azure Monitor:

1. Число сообщений, входящих в экспорт до применения фильтров
2. Число сообщений, прошедших через фильтры
3. Число сообщений, успешно экспортированных в назначения
4. Число обнаруженных ошибок
 
[Узнайте больше о том, как получить доступ к метрикам IoT Central.](howto-monitor-application-health.md)

## <a name="destinations"></a>Места назначения

### <a name="azure-blob-storage-destination"></a>Назначение хранилища BLOB-объектов Azure

Данные экспортируются один раз в минуту, при этом каждый файл содержит пакет изменений с момента предыдущего экспорта. Экспортированные данные сохраняются в формате JSON. К экспортированным данным в вашей учетной записи хранения применяются следующие пути по умолчанию:

- Данные телеметрии: _{Container}/{апп-ид}/{partition_id}/{ИИИИ}/{мм}/{дд}/{ХХ}/{мм}/{филенаме}_
- Изменения свойств: _{Container}/{апп-ид}/{partition_id}/{ИИИИ}/{мм}/{дд}/{ХХ}/{мм}/{филенаме}_

Чтобы просмотреть экспортированные файлы в портал Azure, перейдите к файлу и выберите **изменить BLOB-объект**.

### <a name="azure-event-hubs-and-azure-service-bus-destinations"></a>Концентраторы событий Azure и назначения служебной шины Azure

Данные экспортируются практически в режиме реального времени. Данные находятся в теле сообщения и имеют формат JSON, закодированный как UTF-8.

Контейнер заметок или системных свойств сообщения содержит `iotcentral-device-id` `iotcentral-application-id` поля,, `iotcentral-message-source` и `iotcentral-message-type` , имеющие те же значения, что и соответствующие поля в тексте сообщения.

### <a name="webhook-destination"></a>Назначение веб-перехватчика

Для назначений веб-перехватчиков данные также экспортируются практически в режиме реального времени. Данные в тексте сообщения имеют тот же формат, что и для концентраторов событий и служебной шины.

## <a name="telemetry-format"></a>Формат телеметрии

Каждое экспортированное сообщение содержит нормализованную форму полного сообщения, отправленного устройством в тексте сообщения. Сообщение представлено в формате JSON и кодируется как UTF-8. В каждом сообщении содержатся следующие сведения:

- `applicationId`— Идентификатор приложения IoT Central.
- `messageSource`: Источник сообщения — `telemetry` .
- `deviceId`— ИДЕНТИФИКАТОР устройства, отправившего сообщение телеметрии.
- `schema`: Имя и версия схемы полезных данных.
- `templateId`— Идентификатор шаблона устройства, связанного с устройством.
- `enrichments`: Все дополнения, настроенные для экспорта.
- `messageProperties`: Дополнительные свойства, отправляемые устройством с сообщением. Эти свойства иногда называют *свойствами приложения*. [Дополнительные сведения см. в документах центра Интернета вещей](../../iot-hub/iot-hub-devguide-messages-construct.md).

Для концентраторов событий и служебной шины IoT Central быстро экспортирует новое сообщение после получения сообщения с устройства. В свойствах пользователя (также называемых свойствами приложения) каждого сообщения,, `iotcentral-device-id` `iotcentral-application-id` и `iotcentral-message-source` включаются автоматически.

Для хранилища BLOB-объектов сообщения помещаются в пакет и экспортируются один раз в минуту.

В следующем примере показано экспортированное сообщение телеметрии.

```json

{
    "applicationId": "1dffa667-9bee-4f16-b243-25ad4151475e",
    "messageSource": "telemetry",
    "deviceId": "1vzb5ghlsg1",
    "schema": "default@v1",
    "templateId": "urn:qugj6vbw5:___qbj_27r",
    "enqueuedTime": "2020-08-05T22:26:55.455Z",
    "telemetry": {
        "Activity": "running",
        "BloodPressure": {
            "Diastolic": 7,
            "Systolic": 71
        },
        "BodyTemperature": 98.73447010562934,
        "HeartRate": 88,
        "HeartRateVariability": 17,
        "RespiratoryRate": 13
    },
    "enrichments": {
      "userSpecifiedKey": "sampleValue"
    },
    "messageProperties": {
      "messageProp": "value"
    }
}
```
### <a name="message-properties"></a>Свойства сообщений

Сообщения телеметрии имеют свойства метаданных в дополнение к полезным данным телеметрии. В предыдущем фрагменте показаны примеры системных сообщений, таких как `deviceId` и `enqueuedTime` . Дополнительные сведения о свойствах системных сообщений см. в разделе [Свойства системы сообщений центра Интернета вещей D2C](../../iot-hub/iot-hub-devguide-messages-construct.md#system-properties-of-d2c-iot-hub-messages).

Вы можете добавить свойства в сообщения телеметрии, если необходимо добавить пользовательские метаданные в сообщения телеметрии. Например, необходимо добавить отметку времени при создании сообщения устройством.

В следующем фрагменте кода показано, как добавить `iothub-creation-time-utc` свойство в сообщение при его создании на устройстве:

# <a name="javascript"></a>[JavaScript](#tab/javascript)

```javascript
async function sendTelemetry(deviceClient, index) {
  console.log('Sending telemetry message %d...', index);
  const msg = new Message(
    JSON.stringify(
      deviceTemperatureSensor.updateSensor().getCurrentTemperatureObject()
    )
  );
  msg.properties.add("iothub-creation-time-utc", new Date().toISOString());
  msg.contentType = 'application/json';
  msg.contentEncoding = 'utf-8';
  await deviceClient.sendEvent(msg);
}
```

# <a name="java"></a>[Java](#tab/java)

```java
private static void sendTemperatureTelemetry() {
  String telemetryName = "temperature";
  String telemetryPayload = String.format("{\"%s\": %f}", telemetryName, temperature);

  Message message = new Message(telemetryPayload);
  message.setContentEncoding(StandardCharsets.UTF_8.name());
  message.setContentTypeFinal("application/json");
  message.setProperty("iothub-creation-time-utc", Instant.now().toString());

  deviceClient.sendEventAsync(message, new MessageIotHubEventCallback(), message);
  log.debug("My Telemetry: Sent - {\"{}\": {}°C} with message Id {}.", telemetryName, temperature, message.getMessageId());
  temperatureReadings.put(new Date(), temperature);
}
```

# <a name="c"></a>[C#](#tab/csharp)

```csharp
private async Task SendTemperatureTelemetryAsync()
{
  const string telemetryName = "temperature";

  string telemetryPayload = $"{{ \"{telemetryName}\": {_temperature} }}";
  using var message = new Message(Encoding.UTF8.GetBytes(telemetryPayload))
  {
      ContentEncoding = "utf-8",
      ContentType = "application/json",
  };
  message.Properties.Add("iothub-creation-time-utc", DateTime.UtcNow.ToString("yyyy-MM-ddTHH:mm:ssZ"));
  await _deviceClient.SendEventAsync(message);
  _logger.LogDebug($"Telemetry: Sent - {{ \"{telemetryName}\": {_temperature}°C }}.");
}
```

# <a name="python"></a>[Python](#tab/python)

```python
async def send_telemetry_from_thermostat(device_client, telemetry_msg):
    msg = Message(json.dumps(telemetry_msg))
    msg.custom_properties["iothub-creation-time-utc"] = datetime.now(timezone.utc).isoformat()
    msg.content_encoding = "utf-8"
    msg.content_type = "application/json"
    print("Sent message")
    await device_client.send_message(msg)
```

---

В следующем фрагменте кода показано это свойство в сообщении, экспортированном в хранилище BLOB-объектов:

```json
{
  "applicationId":"5782ed70-b703-4f13-bda3-1f5f0f5c678e",
  "messageSource":"telemetry",
  "deviceId":"sample-device-01",
  "schema":"default@v1",
  "templateId":"urn:modelDefinition:mkuyqxzgea:e14m1ukpn",
  "enqueuedTime":"2021-01-29T16:45:39.143Z",
  "telemetry":{
    "temperature":8.341033560421833
  },
  "messageProperties":{
    "iothub-creation-time-utc":"2021-01-29T16:45:39.021Z"
  },
  "enrichments":{}
}
```

## <a name="property-changes-format"></a>Формат изменения свойства

Каждое сообщение или запись представляет одно изменение в свойстве устройства или облака. Для свойств устройства только изменения в сообщаемом значении экспортируются как отдельное сообщение. В экспортированном сообщении содержатся следующие сведения:

- `applicationId`— Идентификатор приложения IoT Central.
- `messageSource`: Источник сообщения — `properties` .
- `messageType`: `cloudPropertyChange` , `devicePropertyDesiredChange` Или `devicePropertyReportedChange` .
- `deviceId`— ИДЕНТИФИКАТОР устройства, отправившего сообщение телеметрии.
- `schema`: Имя и версия схемы полезных данных.
- `templateId`— Идентификатор шаблона устройства, связанного с устройством.
- `enrichments`: Все дополнения, настроенные для экспорта.

Для концентраторов событий и служебной шины IoT Central экспортирует данные новых сообщений в концентратор событий или в очередь или раздел служебной шины практически в реальном времени. В свойствах пользователя (также называемых свойствами приложения) каждого сообщения,,, `iotcentral-device-id` `iotcentral-application-id` `iotcentral-message-source` и `iotcentral-message-type` включаются автоматически.

Для хранилища BLOB-объектов сообщения помещаются в пакет и экспортируются один раз в минуту.

В следующем примере показано сообщение об изменении экспортированного свойства, полученное в хранилище BLOB-объектов Azure.

```json
{
    "applicationId": "1dffa667-9bee-4f16-b243-25ad4151475e",
    "messageSource": "properties",
    "messageType": "cloudPropertyChange",
    "deviceId": "18a985g1fta",
    "schema": "default@v1",
    "templateId": "urn:qugj6vbw5:___qbj_27r",
    "enqueuedTime": "2020-08-05T22:37:32.942Z",
    "properties": [{
        "name": "MachineSerialNumber",
        "value": "abc"
    }],
    "enrichments": {
        "userSpecifiedKey" : "sampleValue"
    }
}
```

## <a name="comparison-of-legacy-data-export-and-data-export"></a>Сравнение экспорта устаревших данных и экспорта данных

В следующей таблице показаны различия между [экспортом устаревших данных](howto-export-data-legacy.md) и новыми функциями экспорта данных.

| Характеристики  | Экспорт устаревших данных | Новый экспорт данных |
| :------------- | :---------- | :----------- |
| Доступные типы данных | Данные телеметрии, устройства, шаблоны устройств | Данные телеметрии, изменения свойств |
| Фильтрация | None | Зависит от типа экспортируемых данных. Для телеметрии, фильтрации по телеметрии, свойствам сообщений, значениям свойств |
| Усовершенствования | None | Улучшение с помощью пользовательской строки или значения свойства на устройстве |
| Места назначения | Концентраторы событий Azure, очереди и разделы служебной шины Azure, хранилище BLOB-объектов Azure | То же, что и для экспорта устаревших данных и веб-перехватчиков|
| Версии поддерживаемых приложений | V2, V3 | Только версия 3 |
| Важные ограничения | 5 экспортов на приложение, 1 назначение на экспорт | 10 экспортов — подключений назначения на приложение |

## <a name="next-steps"></a>Дальнейшие шаги

Теперь, когда вы умеете использовать новый экспорт данных, предлагаем следующий шаг: Узнайте, [как использовать аналитику в IOT Central](./howto-create-analytics.md)
