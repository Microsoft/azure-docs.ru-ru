---
title: Учебник. Добавление устройства Azure IoT Edge в Azure IoT Central | Документация Майкрософт
description: Учебник. Добавление устройства Azure IoT Edge в приложение Azure IoT Central (для операторов)
author: rangv
ms.author: rangv
ms.date: 05/29/2020
ms.topic: tutorial
ms.service: iot-central
services: iot-central
ms.custom:
- mvc
- device-developer
- iot-edge
ms.openlocfilehash: 373d144b4df818a075f0088e9cbf31cb5027e747
ms.sourcegitcommit: c27a20b278f2ac758447418ea4c8c61e27927d6a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/03/2021
ms.locfileid: "101724886"
---
# <a name="tutorial-add-an-azure-iot-edge-device-to-your-azure-iot-central-application"></a>Руководство по добавлению устройства Azure IoT Edge в приложение Azure IoT Central

*Эта статья предназначена для операторов, создателей решений и разработчиков устройств.*

В этом учебнике показано, как добавить устройство Azure IoT Edge в приложение Azure IoT Central и настроить его. В этом учебнике для имитации устройства IoT Edge используется виртуальная машина Linux с поддержкой IoT Edge. Устройство IoT Edge использует модуль, который создает смоделированные данные телеметрии окружающей среды. Данные телеметрии можно просмотреть на панели мониторинга в приложении IoT Central.

В этом руководстве описано следующее:

> [!div class="checklist"]
> * создание шаблона для устройства IoT Edge;
> * создание устройства IoT Edge в IoT Central;
> * развертывание имитированного устройства IoT Edge на виртуальной машине Linux.

## <a name="prerequisites"></a>Предварительные требования

Выполните инструкции из краткого руководства [Создание приложения Azure IoT Central](./quick-deploy-iot-central.md), чтобы создать приложение IoT Central с помощью шаблона **Пользовательское приложение > Пользовательское приложение**.

Для работы с этим учебником требуется активная подписка Azure.

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

Скачайте файл манифеста IoT Edge на GitHub. Щелкните ссылку ниже правой кнопкой мыши и выберите пункт **Сохранить ссылку как**. [EnvironmentalSensorManifest.json](https://raw.githubusercontent.com/Azure-Samples/iot-central-docs-samples/master/iotedge/EnvironmentalSensorManifest.json)

## <a name="create-device-template"></a>Создание шаблона устройства

В этом разделе вы создадите шаблон устройства IoT Central для устройства IoT Edge. Для начала импортируйте манифест IoT Edge, а затем измените шаблон, добавив определения телеметрии и представления.

### <a name="import-manifest-to-create-template"></a>Импорт манифеста для создания шаблона

Чтобы создать шаблон устройства на основе манифеста IoT Edge, выполните следующие действия.

1. В приложении IoT Central перейдите в раздел **Шаблоны устройств** и щелкните **+ Создать**.

1. На странице **Select template type** (Выбрать тип шаблона) выберите плитку **Azure IoT Edge**. Затем щелкните **Next: Настройка**.

1. На странице **Отправить манифест развертывания Azure IoT Edge** введите в качестве имени шаблона устройства *Пограничное устройство с датчиком окружающей среды*. Щелкните **Обзор**, чтобы загрузить файл **EnvironmentalSensorManifest.json**, скачанный ранее. Затем щелкните **Next: Review** (Далее: проверка).

1. На странице **Отзыв** выберите **Создать**.

1. Щелкните интерфейс **Управление** в модуле **SimulatedTemperatureSensor**, чтобы просмотреть два свойства, определенные в манифесте:

:::image type="content" source="media/tutorial-add-edge-as-leaf-device/imported-manifest.png" alt-text="Шаблон устройства, созданный на основе манифеста IoT Edge":::

> [!TIP]
> Этот манифест развертывания извлекает образы модулей из репозитория Реестра контейнеров Azure, которым не требуются учетные данные для подключения. Если вы хотите использовать образы модулей из частного репозитория, задайте учетные данные реестра контейнеров в манифесте.

### <a name="add-telemetry-to-manifest"></a>Добавление телеметрии в манифест

Манифест IoT Edge не определяет телеметрию, которую отправляет модуль. Необходимо добавить определения телеметрии в шаблон устройства в IoT Central. Модуль **SimulatedTemperatureSensor** отправляет сообщения телеметрии, которые выглядят как следующий код JSON:

```json
{
  "machine": {
    "temperature": 75.0,
    "pressure": 40.2
  },
  "ambient": {
    "temperature": 23.0,
    "humidity": 30.0
  },
  "timeCreated": ""
}
```

Чтобы добавить определения телеметрии в шаблон устройства, выполните шаги ниже:

1. Выберите интерфейс **Управление** в шаблоне **Устройство Edge с датчиком окружающей среды**.

1. Нажмите кнопку **+ Добавить возможность**. Введите *machine* как **отображаемое имя** и убедитесь, что для параметра **Тип возможности** установлено значение **Телеметрия**.

1. Выберите значение **Объект** для параметра типа схемы, а затем щелкните **Определить**. На странице определения объекта добавьте *temperature* и *pressure* как атрибуты типа **Двойной**, а затем щелкните **Применить**.

1. Нажмите кнопку **+ Добавить возможность**. Введите *ambient* как **отображаемое имя** и убедитесь, что для параметра **Тип возможности** установлено значение **Телеметрия**.

1. Выберите значение **Объект** для параметра типа схемы, а затем щелкните **Определить**. На странице определения объекта добавьте *temperature* и *humidity* как атрибуты типа **Двойной**, а затем щелкните **Применить**.

1. Нажмите кнопку **+ Добавить возможность**. Введите *timeCreated* как **отображаемое имя** и убедитесь, что для параметра **Тип возможности** установлено значение **Телеметрия**.

1. Выберите **DateTime** в качестве типа схемы.

1. Щелкните **Сохранить**, чтобы обновить этот шаблон.

Интерфейс **Управление** теперь содержит типы телеметрии **machine**, **ambient** и **timeCreated**.

:::image type="content" source="media/tutorial-add-edge-as-leaf-device/manage-interface.png" alt-text="Интерфейс с типами телеметрии компьютера и окружающей среды":::

### <a name="add-views-to-template"></a>Добавление представлений в шаблон

В шаблоне устройства еще нет представления, которое позволяло бы оператору просматривать данные телеметрии с устройства IoT Edge. Чтобы добавить такое представление в шаблон устройства, выполните следующие действия.

1. Выберите раздел **Представления** в шаблоне **Устройство Edge с датчиком окружающей среды**.

1. На странице **Select to add a new view** (Добавление нового представления) щелкните плитку **Визуализация устройства**.

1. Измените имя представления на *Просмотр телеметрии устройства IoT Edge*.

1. Выберите типы телеметрии **ambient** и **machine**. Затем нажмите кнопку **Добавить плитку**.

1. Щелкните **Сохранить**, чтобы сохранить представление **Просмотр телеметрии устройства IoT Edge**.

:::image type="content" source="media/tutorial-add-edge-as-leaf-device/template-telemetry-view.png" alt-text="Шаблон устройства с представлением телеметрии":::

### <a name="publish-the-template"></a>Публикация шаблона

Чтобы можно было добавить устройство, которое использует шаблон **Устройство Edge с датчиком окружающей среды**, необходимо опубликовать этот шаблон.

Перейдите к шаблону **Устройство Edge с датчиком окружающей среды** и нажмите значок **Опубликовать**. На панели **Опубликовать этот шаблон устройства в приложении** щелкните **Опубликовать**, чтобы опубликовать шаблон:

:::image type="content" source="media/tutorial-add-edge-as-leaf-device/publish-template.png" alt-text="Публикация шаблона устройства":::

## <a name="add-iot-edge-device"></a>Добавление устройства IoT Edge

После публикации шаблона **Устройство Edge с датчиком окружающей среды** можно добавить устройство в приложение IoT Central:

1. В приложении IoT Central перейдите на страницу **Устройства** и щелкните **Устройство Edge с датчиком окружающей среды** в списке доступных шаблонов.

1. Щелкните **+Создать**, чтобы добавить новое устройство из шаблона. На странице **Создание устройства** щелкните **Создать**.

Теперь у вас есть новое устройство с состоянием **Зарегистрировано**:

:::image type="content" source="media/tutorial-add-edge-as-leaf-device/new-device.png" alt-text="Новое зарегистрированное устройство":::

### <a name="get-the-device-credentials"></a>Получение учетных данных устройства

При развертывании устройства IoT Edge далее в этом руководстве необходимы учетные данные, которые позволят устройству подключаться к приложению IoT Central. Чтобы получить учетные данные устройства, выполните шаги ниже:

1. На странице **Устройства** выберите устройство, которое вы только что создали.

1. Выберите **Подключиться**.

1. На странице **Подключение к устройству** запишите значения параметров **Область идентификатора**, **ИД устройства** и **Первичный ключ**. Эти значения понадобятся позже.

1. Выберите **Закрыть**.

Теперь вы настроили в приложении IoT Central возможность подключения устройства IoT Edge.

## <a name="deploy-an-iot-edge-device"></a>Развертывание на устройстве IoT Edge

В этом учебнике вы используете виртуальную машину Linux с поддержкой Azure IoT Edge, созданную в Azure для имитации устройства IoT Edge. Чтобы создать виртуальную машину с поддержкой IoT Edge в подписке Azure, щелкните:

[![Кнопка "Развернуть в Azure" для iotedge-vm-deploy](https://aka.ms/deploytoazurebutton)](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fazure%2Fiotedge-vm-deploy%2Fmaster%2FedgeDeploy.json)

На странице **Настраиваемое развертывание**:

1. Выберите подписку Azure.

1. Нажмите **Создать**, чтобы создать новую группу ресурсов с именем *central-edge-rg*.

1. Выберите регион рядом с вами.

1. Добавьте уникальный **префикс метки DNS**, например *contoso-central-edge*.

1. Выберите имя пользователя администратора виртуальной машины.

1. Введите *temp* в качестве строки подключения. Позже вы настроите устройство для подключения с помощью DPS.

1. Примите значения по умолчанию для размера виртуальной машины, версии Ubuntu и расположения.

1. Выберите **пароль** в качестве типа проверки подлинности.

1. Введите пароль для виртуальной машины.

1. Щелкните **Просмотр и создание**.

1. Просмотрите выбранные параметры и нажмите **Создать**:

    :::image type="content" source="media/tutorial-add-edge-as-leaf-device/vm-deployment.png" alt-text="Создание виртуальной машины IoT Edge":::

Для завершения развертывания требуется несколько минут. После завершения развертывания перейдите к группе ресурсов **central-edge-rg** на портале Azure.

### <a name="configure-the-iot-edge-vm"></a>Настройка виртуальной машины IoT Edge

Чтобы настроить IoT Edge на виртуальной машине для использования DPS для регистрации и подключения к приложению IoT Central:

1. В группе ресурсов **contoso-edge-rg** выберите экземпляр виртуальной машины.

1. В разделе **Поддержка и устранение неполадок** щелкните **Последовательная консоль**. Если будет предложено настроить диагностику загрузки, следуйте инструкциям на портале.

1. Нажмите клавишу **ВВОД**, чтобы просмотреть запрос `login:`. Введите имя пользователя и пароль для входа.

1. Выполните следующую команду, чтобы проверить версию среды выполнения IoT Edge. На момент написания статьи это версия 1.0.9.1:

    ```bash
    sudo iotedge --version
    ```

1. Используйте редактор `nano`, чтобы открыть файл config.yaml IoT Edge.

    ```bash
    sudo nano /etc/iotedge/config.yaml
    ```

1. Прокручивайте код вниз, пока не отобразится `# Manual provisioning configuration`. Закомментируйте следующие три строки, как показано в следующем фрагменте кода:

    ```yaml
    # Manual provisioning configuration
    #provisioning:
    #  source: "manual"
    #  device_connection_string: "temp"
    ```

1. Прокручивайте код вниз, пока не отобразится `# DPS symmetric key provisioning configuration`. Раскомментируйте следующие восемь строк, как показано в следующем фрагменте кода:

    ```yaml
    # DPS symmetric key provisioning configuration
    provisioning:
      source: "dps"
      global_endpoint: "https://global.azure-devices-provisioning.net"
      scope_id: "{scope_id}"
      attestation:
        method: "symmetric_key"
        registration_id: "{registration_id}"
        symmetric_key: "{symmetric_key}"
    ```

    > [!TIP]
    > Убедитесь, что перед `provisioning:` нет пробелов.

1. Замените `{scope_id}` значением **области идентификатора**, которое вы записали ранее.

1. Замените `{registration_id}` **идентификатором устройства**, который вы записали ранее.

1. Замените `{symmetric_key}` **первичным ключом**, который вы записали ранее.

1. Сохраните изменения (нажмите клавиши **CTRL+O**) и выйдите из редактора `nano` (**CTRL+X**).

1. Выполните следующую команду, чтобы перезапустить управляющую программу IoT Edge:

    ```bash
    sudo systemctl restart iotedge
    ```

1. Чтобы проверить состояние модулей IoT Edge, выполните следующую команду:

    ```bash
    iotedge list
    ```

    Пример выходных данных показывает запущенные модули:

    ```bash
    NAME                        STATUS           DESCRIPTION      CONFIG
    SimulatedTemperatureSensor  running          Up 20 seconds    mcr.microsoft.com/azureiotedge-simulated-temperature-sensor:1.0
    edgeAgent                   running          Up 27 seconds    mcr.microsoft.com/azureiotedge-agent:1.0
    edgeHub                     running          Up 22 seconds    mcr.microsoft.com/azureiotedge-hub:1.0
    ```

    > [!TIP]
    > Возможно, потребуется подождать, пока все модули запустятся.

## <a name="view-the-telemetry"></a>Просмотр телеметрии

Имитированное устройство IoT Edge теперь работает в виртуальной машине. В приложении IoT Central на странице **Устройства** теперь отображается состояние устройства **Подготовлено**:

:::image type="content" source="media/tutorial-add-edge-as-leaf-device/provisioned-device.png" alt-text="Подготовленное устройство IoT Edge":::

Данные телеметрии с устройства можно просмотреть на странице **Просмотр телеметрии устройства IoT Edge**:

:::image type="content" source="media/tutorial-add-edge-as-leaf-device/device-telemetry-view.png" alt-text="Телеметрия устройства":::

На странице **Модули** отображается состояние модулей IoT Edge на устройстве:

:::image type="content" source="media/tutorial-add-edge-as-leaf-device/edge-module-status.png" alt-text="Состояние модулей устройства":::

## <a name="clean-up-resources"></a>Очистка ресурсов

Если вы планируете продолжить работу с виртуальной машиной IoT Edge, вы можете сохранить и повторно использовать ресурсы, используемые в этом руководстве. В противном случае вы можете удалить их, чтобы избежать дополнительных расходов:

* Чтобы удалить виртуальную машину IoT Edge и связанные с ней ресурсы, удалите группу ресурсов **contoso-edge-rg** на портале Azure.
* Чтобы удалить приложение IoT Central, перейдите на страницу **Ваше приложение** в разделе **Администрирование** и выберите **Удалить**.

Теперь, когда вы как разработчик решений или оператор узнали, как управлять устройствами IoT Edge в IoT Central, ознакомьтесь со следующим руководством:

> [!div class="nextstepaction"]
> [Использование групп устройств для анализа телеметрии устройств](./tutorial-use-device-groups.md)

## <a name="next-steps"></a>Дальнейшие действия

Теперь, когда вы как разработчик устройства узнали, как управлять устройствами IoT Edge в IoT Central, ознакомьтесь со следующим руководством:

> [!div class="nextstepaction"]
> [Разработка модулей IoT Edge](../../iot-edge/tutorial-develop-for-linux.md)