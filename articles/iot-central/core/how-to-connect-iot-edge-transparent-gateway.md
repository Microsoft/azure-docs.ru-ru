---
title: Подключение IoT Edge прозрачного шлюза к приложению IoT Central Azure
description: Подключение устройств с помощью IoT Edge прозрачного шлюза к IoT Central приложению
author: dominicbetts
ms.author: dobett
ms.date: 03/08/2021
ms.topic: how-to
ms.service: iot-central
services: iot-central
ms.custom: device-developer
ms.openlocfilehash: 4e88ad58c7baba1c66c30df3f4effdbf11371c18
ms.sourcegitcommit: ed7376d919a66edcba3566efdee4bc3351c57eda
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/24/2021
ms.locfileid: "105045337"
---
# <a name="how-to-connect-devices-through-an-iot-edge-transparent-gateway"></a>Подключение устройств с помощью IoT Edge прозрачного шлюза

IoT Edge устройство может действовать в качестве шлюза, обеспечивающего подключение между другими устройствами в локальной сети и приложением IoT Central. Шлюз используется, когда устройство не может напрямую получить доступ к IoT Central приложению.

IoT Edge поддерживает [шаблоны шлюзов *прозрачности* и *преобразования*](../../iot-edge/iot-edge-as-gateway.md). В этой статье описывается, как реализовать шаблон прозрачного шлюза. В этом шаблоне шлюз передает сообщения от подчиненного устройства к конечной точке центра Интернета вещей в приложении IoT Central.

В этой статье для размещения подчиненного устройства и шлюза используются виртуальные машины. В реальной ситуации подчиненное устройство и шлюз будут выполняться на физических устройствах в локальной сети.

## <a name="prerequisites"></a>Предварительные требования

Для работы с этим учебником требуется активная подписка Azure.

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

Выполните инструкции из краткого руководства [Создание приложения Azure IoT Central](./quick-deploy-iot-central.md), чтобы создать приложение IoT Central с помощью шаблона **Пользовательское приложение > Пользовательское приложение**.

Чтобы выполнить действия, описанные в этой статье, скачайте на компьютер следующие файлы:

- [Модель устройства термостата](https://raw.githubusercontent.com/Azure/iot-plugandplay-models/main/dtmi/com/example/thermostat-1.json)
- [Манифест прозрачного шлюза](https://raw.githubusercontent.com/Azure-Samples/iot-central-docs-samples/master/transparent-gateway/EdgeTransparentGatewayManifest.json)

## <a name="add-device-templates"></a>Добавление шаблонов устройств

Как подчиненным устройствам, так и устройству шлюза требуются шаблоны устройств в IoT Central. IoT Central позволяет моделировать связь между нижестоящими устройствами и шлюзом, чтобы вы могли просматривать их и управлять ими после подключения.

Чтобы создать шаблон устройства для подчиненного устройства, создайте шаблон стандартного устройства, моделирующего возможности устройства. В примере, приведенном в этой статье, используется модель устройства термостата.

Чтобы создать шаблон устройства для подчиненного устройства, сделайте следующее:

1. Создайте шаблон устройства и выберите в качестве типа шаблона **устройство IOT** .

1. На странице **Настройка** мастера введите имя, например *термостата* , для шаблона устройства.

1. После создания шаблона устройства выберите **импортировать модель**. Выберите модель, например *thermostat-1.jsдля* скачанного ранее файла.

1. Чтобы создать некоторые представления по умолчанию для термостата, выберите представления, а затем выберите **создать представления по умолчанию**.

1. публикация шаблона устройства;

Чтобы создать шаблон устройства для прозрачного шлюза IoT Edge, выполните следующие действия.

1. Создайте шаблон устройства и выберите **Azure IOT Edge** в качестве типа шаблона.

1. На странице **Настройка** мастера введите имя, такое как *пограничная шлюз* для шаблона устройства.

1. На странице **Настройка** мастера проверьте **устройство шлюза с помощью подчиненных устройств**.

1. На странице **Настройка** мастера нажмите кнопку **Обзор**. Отправьте *EdgeTransparentGatewayManifest.jsв* скачанный ранее файл.

1. Добавление записи в **связи** с шаблоном подчиненного устройства.

На следующем снимке экрана показана страница **связи** для устройства шлюза IOT Edge с подчиненными устройствами, использующими шаблон устройства **термостата** :

:::image type="content" source="media/how-to-connect-iot-edge-transparent-gateway/device-template-relationship.png" alt-text="Снимок экрана: связь шаблона устройства IoT Edge шлюза с шаблоном подчиненного устройства термостата.":::

На предыдущем снимке экрана показан шаблон устройства шлюза IoT Edge без определенных модулей. Для прозрачного шлюза не требуются модули, так как среда выполнения IoT Edge перенаправляет сообщения с подчиненных устройств в IoT Central. Если шлюзу необходимо отправить данные телеметрии, синхронизировать свойства или обработку команд, эти возможности можно определить в компоненте по умолчанию или в модуле.

Перед публикацией шлюза и шаблонов подчиненных устройств добавьте необходимые свойства и представления облака.

## <a name="add-the-devices"></a>Добавление устройств

При добавлении устройств в приложение IoT Central можно определить связь между подчиненными устройствами и прозрачным шлюзом.

Чтобы добавить устройства, сделайте следующее:

1. Перейдите на страницу устройства в приложении IoT Central.

1. Добавьте экземпляр IoT Edge устройства со прозрачным шлюзом. В этой статье идентификатор устройства шлюза — `edgegateway` .

1. Добавьте один или несколько экземпляров подчиненного устройства. В этой статье подчиненные устройства термостатов с идентификаторами `thermostat1` и `thermostat2` .

1. В списке устройств выберите каждое подчиненное устройство и щелкните **подключить к шлюзу**.

На следующем снимке экрана показано, как можно просмотреть список устройств, подключенных к шлюзу на странице **подчиненных устройств** .

:::image type="content" source="media/how-to-connect-iot-edge-transparent-gateway/downstream-devices.png" alt-text="Снимок экрана, на котором показан список подчиненных устройств, подключенных к прозрачному шлюзу.":::

В прозрачном шлюзе подчиненные устройства подключаются к самому шлюзу, а не к пользовательскому модулю, размещенному в шлюзе.

Перед развертыванием устройств необходимо:

- **Область идентификатора** приложения IOT Central.
- Значения **идентификаторов устройств** для шлюза и подчиненных устройств.
- Значения **первичного ключа** для шлюза и подчиненных устройств.

Чтобы найти эти значения, перейдите к каждому устройству в списке устройств и нажмите кнопку **подключить**. Прежде чем продолжить, запишите эти значения.

## <a name="deploy-the-gateway-and-devices"></a>Развертывание шлюза и устройств

Чтобы воспользоваться этим сценарием, выполните следующие действия, чтобы узнать, как развернуть шлюз и подчиненные устройства на виртуальных машинах Azure. В реальной ситуации подчиненное устройство и шлюз работают на физических устройствах в локальной сети.

Чтобы испытать ситуацию с прозрачным шлюзом, нажмите следующую кнопку, чтобы развернуть две виртуальные машины Linux. Одна виртуальная машина — это прозрачный шлюз IoT Edge, второй — это подчиненное устройство, моделирующее термостата:

<a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure-Samples%2Fiot-central-docs-samples%2Fmaster%2Ftransparent-gateway%2FDeployGatewayVMs.json" target="_blank">
    <img src="https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/1-CONTRIBUTION-GUIDE/images/deploytoazure.png" alt="Deploy to Azure button" />
</a>

После развертывания и запуска двух виртуальных машин убедитесь, что на виртуальной машине работает устройство шлюза IoT Edge `edgegateway` .

1. Перейдите на страницу **устройства** в приложении IOT Central. Если устройство шлюза IoT Edge подключено к IoT Central, его состояние — **Подготовка**.

1. Откройте IoT Edge устройство шлюза и проверьте состояние модулей на странице **модули** . Если среда выполнения IoT Edge успешно запущена, состояние модулей **$edgeAgent** и **$edgeHub** **выполняется**:

    :::image type="content" source="media/how-to-connect-iot-edge-transparent-gateway/iot-edge-runtime.png" alt-text="Снимок экрана, показывающий модули $edgeAgent и $edgeHub, работающие в шлюзе IoT Edge.":::

> [!TIP]
> Может потребоваться подождать несколько минут, пока виртуальная машина запустится и устройство будет подготовлено в приложении IoT Central.

## <a name="configure-the-gateway"></a>Настройка шлюза

Чтобы устройство IoT Edge было работать в качестве прозрачного шлюза, ему необходимы некоторые сертификаты для подтверждения его подлинности на всех нижестоящих устройствах. В этой статье используются демонстрационные сертификаты. В рабочей среде используйте сертификаты из центра сертификации.

Чтобы создать демонстрационные сертификаты и установить их на устройстве шлюза, выполните следующие действия.

1. Используйте SSH для подключения к виртуальной машине устройства шлюза и входа в нее.

1. Выполните следующие команды, чтобы клонировать репозиторий IoT Edge и создать демонстрационные сертификаты:

    ```bash
    # Clone the repo
    cd ~
    git clone https://github.com/Azure/iotedge.git

    # Generate the demo certificates
    mkdir certs
    cd certs
    cp ~/iotedge/tools/CACertificates/*.cnf .
    cp ~/iotedge/tools/CACertificates/certGen.sh .
    ./certGen.sh create_root_and_intermediate
    ./certGen.sh create_edge_device_ca_certificate "mycacert"
    ```

    После выполнения предыдущих команд следующие файлы готовы к использованию в следующих шагах:

    - *~/цертс/цертс/Азуре-ИОТ-тест-Онли.Рут.ка.церт.пем* — сертификат КОРНЕВого ЦС, используемый для создания всех других демонстрационных сертификатов для тестирования IOT Edge сценария.
    - *~/цертс/цертс/ИОТ-Едже-девице-микацерт-фулл-Чаин.церт.пем* — сертификат ЦС устройства, на который ссылается файл *config. YAML* . В сценарии шлюза этот сертификат ЦС определяет, как устройство IoT Edge проверяет свое удостоверение на наличие подчиненных устройств.
    - *~/цертс/привате/ИОТ-Едже-девице-микацерт.Кэй.пем* — закрытый ключ, связанный с сертификатом ЦС устройства.

    Дополнительные сведения об этих демонстрационных сертификатах см. в статье [создание демонстрационных сертификатов для тестирования IOT Edge компонентов устройства](../../iot-edge/how-to-create-test-certificates.md).

1. Откройте файл *config. YAML* в текстовом редакторе. Пример:

    ```bash
    sudo nano /etc/iotedge/config.yaml
    ```

1. Нахождение `Certificate settings` параметров. Раскомментируйте и измените параметры сертификата следующим образом:

    ```text
    certificates:
      device_ca_cert: "file:///home/AzureUser/certs/certs/iot-edge-device-ca-mycacert-full-chain.cert.pem"
      device_ca_pk: "file:///home/AzureUser/certs/private/iot-edge-device-ca-mycacert.key.pem"
      trusted_ca_certs: "file:///home/AzureUser/certs/certs/azure-iot-test-only.root.ca.cert.pem"
    ```

    В приведенном выше примере предполагается, что вы вошли как **AzureUser** и СОЗДАЛИ сертификат ЦС устройства с именем "микацерт".

1. Сохраните изменения и перезапустите среду выполнения IoT Edge.

    ```bash
    sudo systemctl restart iotedge
    ```

Если IoT Edge среда выполнения успешно запускается после внесения изменений, состояние модулей **$edgeAgent** и **$EdgeHub** меняется на **выполняется** на странице **модули** для устройства шлюза в IOT Central.

Если среда выполнения не запускается, проверьте изменения, внесенные в *файл config. YAML* , и см. раздел [Устранение неполадок устройства с IOT Edge](../../iot-edge/troubleshoot.md).

Теперь ваш прозрачный шлюз настроен и готов начать пересылку телеметрических данных с подчиненных устройств.

## <a name="provision-a-downstream-device"></a>Подготавливает подчиненное устройство

В настоящее время IoT Edge не может автоматически подготавливать подчиненное устройство к приложению IoT Central. Ниже описано, как подготавливать `thermostat1` устройство. Для выполнения этих действий требуется среда с установленным Python 3,6 (или более поздней версии) и подключением к Интернету. В [Azure Cloud Shell](https://shell.azure.com/) предварительно установлен Python 3,7:

1. Выполните следующую команду, чтобы установить `azure.iot.device` модуль:

    ```bash
    pip install azure.iot.device
    ```

1. Выполните следующую команду, чтобы скачать скрипт Python, который выполняет подготовку:

    ```bash
    wget https://raw.githubusercontent.com/Azure-Samples/iot-central-docs-samples/master/transparent-gateway/provision_device.py
    ```

1. Чтобы подготавливать `thermostat1` подчиненное устройство в IOT Central приложении, выполните следующие команды, заменив `{your application id scope}` и `{your device primary key}`  :

    ```bash
    export IOTHUB_DEVICE_DPS_DEVICE_ID=thermostat1
    export IOTHUB_DEVICE_DPS_ID_SCOPE={your application id scope}
    export IOTHUB_DEVICE_DPS_DEVICE_KEY={your device primary key}
    python provision_device.py
    ```

Убедитесь, что в приложении IoT Central **подготовлено** **состояние устройства** для устройства thermostat1. 

## <a name="configure-a-downstream-device"></a>Настройка подчиненного устройства

В предыдущем разделе вы настроили `edgegateway` виртуальную машину с помощью демонстрационных сертификатов, чтобы включить ее для запуска от имени шлюза. `leafdevice`Виртуальная машина готова к установке симулятора термостата, который использует шлюз для подключения к IOT Central.

`leafdevice`Виртуальной машине требуется копия сертификата корневого ЦС, созданного на `edgegateway` виртуальной машине. Скопируйте файл */Хоме/азуреусер/цертс/цертс/Азуре-ИОТ-тест-Онли.Рут.ка.церт.пем* из `edgegateway` виртуальной машины в домашний каталог на `leafdevice` виртуальной машине. Для копирования файлов на виртуальную машину Linux и обратно можно использовать команду **SCP** .

Сведения о том, как проверить подключение от подчиненного устройства к шлюзу, см. в разделе [Проверка подключения шлюза](../../iot-edge/how-to-connect-downstream-device.md#test-the-gateway-connection).

Чтобы запустить симулятор термостата на `leafdevice` виртуальной машине, сделайте следующее:

1. Скачайте пример Python в домашний каталог:

    ```bash
    cd ~
    wget https://raw.githubusercontent.com/Azure-Samples/iot-central-docs-samples/master/transparent-gateway/simple_thermostat.py
    ```

1. Установите модуль Python для устройства Azure IoT:

    ```bash
    sudo apt update
    sudo apt install python3-pip
    pip3 install azure.iot.device
    ```

1. Задайте переменные среды, чтобы настроить пример. Замените на `{your device shared key}` первичный ключ ранее созданной `thermostat1` заметки. В этих переменных предполагается, что имя виртуальной машины шлюза равно, `edgegateway` а идентификатор устройства термостата `thermostat1` :

    ```bash
    export IOTHUB_DEVICE_SECURITY_TYPE=connectionString
    export IOTHUB_DEVICE_CONNECTION_STRING="HostName=edgegateway;DeviceId=thermostat1;SharedAccessKey={your device shared key}"
    export IOTEDGE_ROOT_CA_CERT_PATH=~/azure-iot-test-only.root.ca.cert.pem
    ```

    Обратите внимание, что в строке подключения используется имя устройства шлюза, а не имя центра Интернета вещей.

1. Чтобы запустить код, используйте следующую команду:

    ```bash
    python3 simple_thermostat.py
    ```

    Выходные данные этой команды выглядят следующим образом:

    ```output
    Connecting using Connection String HostName=edgegateway;DeviceId=thermostat1;SharedAccessKey={your device shared key}
    Listening for command requests and property updates
    Press Q to quit
    Sending telemetry for temperature
    Sent message
    Sent message
    Sent message
    ...
    ```

1. Чтобы просмотреть данные телеметрии в IoT Central, перейдите на страницу **Обзор** для устройства **thermostat1** :

    :::image type="content" source="media/how-to-connect-iot-edge-transparent-gateway/downstream-device-telemetry.png" alt-text="Снимок экрана, показывающий данные телеметрии из подчиненного устройства.":::

    На странице **About (сведения** ) можно просмотреть значения свойств, отправленные с подчиненного устройства, а на странице **команды** можно вызвать команды на подчиненном устройстве.

## <a name="next-steps"></a>Дальнейшие действия

Теперь, когда вы узнали, как настроить прозрачный шлюз с IoT Central, рекомендуем следующий шаг — получить дополнительные сведения о [IOT Edge](../../iot-edge/about-iot-edge.md).
