---
title: Книга аналитики и отчетов условного доступа — Azure Active Directory
description: Использование книги аналитики и отчетов условного доступа Azure AD для устранения неполадок политик
services: active-directory
ms.service: active-directory
ms.subservice: conditional-access
ms.topic: conceptual
ms.date: 08/27/2020
ms.author: joflore
author: MicrosoftGuyJFlo
manager: daveba
ms.reviewer: dawoo
ms.collection: M365-identity-device-management
ms.openlocfilehash: ae802038626a1fbf8d533800a0b8eb43c4565e8c
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "100574167"
---
# <a name="conditional-access-insights-and-reporting"></a>Аналитика и отчеты условного доступа

С помощью книги аналитики и отчетов условного доступа можно понять, как меняется влияние политик условного доступа на организацию с течением времени. Во время входа в систему могут применяться одна или несколько политик условного доступа, которые предоставляют или запрещают доступ в соответствии с определенными элементами управления предоставлением прав. Так как во время каждого входа могут оцениваться несколько политик условного доступа, книга аналитики и отчетов позволяет проверить влияние отдельной политики или подмножества всех политик.  

## <a name="prerequisites"></a>Предварительные требования

Чтобы включить книгу аналитики и отчетов, клиент должен иметь рабочую область Log Analytics для хранения журналов входа. Для использования условного доступа пользователи должны иметь лицензии Azure AD Premium P1 или P2.

Доступ к аналитике и отчетам могут получать следующие роли:  

- Администратор условного доступа 
- Читатель сведений о безопасности 
- администратор безопасности; 
- глобальный читатель; 
- Глобальный администратор. 

Кроме того, у пользователей должна быть одна из следующих ролей рабочей области Log Analytics:  

- Участник  
- Владелец 

### <a name="stream-sign-in-logs-from-azure-ad-to-azure-monitor-logs"></a>Потоковая передача журналов входа из Azure AD в журналы Azure Monitor 

Если журналы Azure AD не интегрированы с журналами Azure Monitor, необходимо выполнить следующие действия, прежде чем книга будет загружена.  

1. [Создайте рабочую область Log Analytics в Azure Monitor](../../azure-monitor/logs/quick-create-workspace.md).
1. [Интегрируйте журналы Azure AD с журналами Azure Monitor](../reports-monitoring/howto-integrate-activity-logs-with-log-analytics.md).

## <a name="how-it-works"></a>Принцип работы 

Чтобы получить доступ к книге аналитики и отчетов, выполните указанные ниже действия.  

1. Войдите на **портал Azure**.
1. Выберите **Azure Active Directory** > **Безопасность** > **Условный доступ** > **Аналитические данные и отчеты**.

### <a name="get-started-select-parameters"></a>Приступая к работе: выбор параметров 

На панели мониторинга аналитики и отчетов можно увидеть влияние одной или нескольких политик условного доступа за указанный период. Сначала задайте все параметры в верхней части книги. 

![Панель мониторинга аналитики и отчетов условного доступа на портале Azure](./media/howto-conditional-access-insights-reporting/conditional-access-insights-and-reporting-dashboard.png)

**Политика условного доступа**. Выберите одну или несколько политик условного доступа, чтобы просмотреть их совокупное влияние. Политики делятся на две группы: включенные и политики в режиме "Только отчет". По умолчанию выбраны все включенные политики. Это политики, которые в настоящее время применяются в клиенте.  

**Диапазон времени**. Выберите диапазон времени от 4 часов до 90 дней. Если начало диапазона времени будет раньше момента интеграции журналов Azure AD с Azure Monitor, будут отображаться только входы после интеграции.  

**Пользователь**. По умолчанию на панели мониторинга отображается влияние выбранных политик для всех пользователей. Чтобы выполнить фильтрацию по отдельному пользователю, введите его имя в текстовом поле. Чтобы выполнить фильтрацию по всем пользователям, введите "Все пользователи" в текстовом поле или оставьте параметр пустым. 

**Приложение**. По умолчанию на панели мониторинга отображается влияние выбранных политик для всех приложений. Чтобы выполнить фильтрацию по отдельному приложению, введите его имя в текстовом поле. Чтобы выполнить фильтрацию по всем приложениям, введите "Все приложения" в текстовом поле или оставьте параметр пустым. 

**Представление данных**. Укажите, должны ли результаты на панели мониторинга содержать число пользователей или число входов. У отдельного пользователя могут быть сотни входов во множество приложений с множеством различных результатов в течение заданного диапазона времени. Если для представления данных выбрано число пользователей, то пользователь может включаться как в число успешных попыток входа, так и в числа неудачных попыток (например, если имеется 10 пользователей, 8 из них могли иметь успешные попытки за последние 30 дней и 9 из них могли иметь неудачные попытки за этот же период).

## <a name="impact-summary"></a>Сводка данных по влиянию 

После задания параметров загружается сводка данных по влиянию. В сводке показано, сколько пользователей или входов в течение указанного интервала времени имело результат оценки выбранных политик "Успешно", "Сбой", "Требуется действие пользователя" или "Неприменимо".  

![Сводка данных по влиянию в книге условного доступа](./media/howto-conditional-access-insights-reporting/workbook-impact-summary.png)

**Total**: Количество пользователей или входов в систему за период времени, в течение которого была оценена хотя бы одна из выбранных политик.

**Выполнено**. Количество пользователей или входов в систему за период времени, в течение которого совокупный результат для выбранных политик был "Успешно" или "Только отчет: успешно".

**Сбой**. Количество пользователей или входов в систему за период времени, в течение которого результат для по крайней мере одной из выбранных политик был "Сбой" или "Только отчет: сбой".

**Требуется действие пользователя**. Количество пользователей или входов в систему за период времени, в течение которого совокупный результат для выбранных политик был "Только отчет: требуется действие пользователя". Действие пользователя требуется, если для политики условного доступа в режиме "Только отчет" требуется интерактивный элемент управления предоставлением прав, например многофакторная проверка подлинности. Так как интерактивные элементы управления предоставлением прав не применяются политиками в режиме "Только отчет", успешный или неудачный результат определить невозможно.  

**Не применено**. Количество пользователей или входов в систему за период времени, в течение которого ни одна из выбранных политик не была применена.

### <a name="understanding-the-impact"></a>Анализ влияния 

![Разбивка книги по условиям и состоянию](./media/howto-conditional-access-insights-reporting/workbook-breakdown-condition-and-status.png)

Вы можете просмотреть распределение пользователей или входов для каждого из условий. Вы можете отфильтровать операции входа с определенным результатом (например, "Успешно" или "Сбой"), выбрав плитку сводки в верхней части книги. Вы можете просмотреть разбивку входов по каждому из условий условного доступа: состояние устройства, платформа устройства, клиентское приложение, расположение, приложение и риск входа.  

## <a name="sign-in-details"></a>Подробности данных для входа 

![Подробности данных для входа в книге](./media/howto-conditional-access-insights-reporting/workbook-sign-in-details.png)

Вы также можете исследовать операции входа конкретного пользователя, выполнив поиск в нижней части панели мониторинга. В запросе слева отображаются наиболее часто выполнявшие вход пользователи. При выборе пользователя запрос справа будет отфильтрован.  

> [!NOTE]
> При скачивании журналов входа выберите формат JSON, чтобы включить в отчет условный доступ только результирующие данные.

## <a name="configure-a-conditional-access-policy-in-report-only-mode"></a>Настройка политики условного доступа в режиме «только отчет»

Настройка политики условного доступа в режиме «только отчет».

1. Войдите в **портал Azure** в качестве администратора условного доступа, администратора безопасности или глобального администратора.
1. Выберите **Azure Active Directory** > **Безопасность** > **Условный доступ**.
1. Выберите существующую политику или создайте новую.
1. В разделе **включить политику** установите переключатель в режим **только для отчетов** .
1. Нажмите кнопку **Сохранить**.

> [!TIP]
> При изменении параметра **включить политику** для существующей политики из **в в** отчет отключается **только** существующее применение политики. 

## <a name="troubleshooting"></a>Устранение неполадок

### <a name="why-are-queries-failing-due-to-a-permissions-error"></a>Почему происходит сбой запросов из-за ошибки в разрешениях?

Чтобы получить доступ к книге, необходимы соответствующие разрешения Azure AD, а также разрешения Log Analytics рабочей области. Чтобы проверить, имеются ли нужные разрешения рабочей области, запустив пример запроса log Analytics:

1. Войдите на **портал Azure**.
1. Перейдите к   >  **журналам** Azure Active Directory.
1. Введите `SigninLogs` в поле запрос и выберите **выполнить**.
1. Если запрос не возвращает никаких результатов, возможно, Рабочая область настроена неправильно. 

![Устранение неполадок при сбое запросов](./media/howto-conditional-access-insights-reporting/query-troubleshoot-sign-in-logs.png)

Дополнительные сведения о потоковой передаче журналов входа Azure AD в Log Analytics рабочей области см. в статье [Интеграция журналов Azure AD с Azure Monitor журналами](../reports-monitoring/howto-integrate-activity-logs-with-log-analytics.md).

### <a name="why-are-the-queries-in-the-workbook-failing"></a>Почему происходит сбой запросов в книге?

Клиенты заметили, что запросы иногда завершаются ошибкой, если с книгой связано неправильное или несколько рабочих областей. Чтобы устранить эту проблему, щелкните **изменить** в верхней части книги, а затем выберите параметры. Выберите и удалите рабочие области, не связанные с книгой. С каждой книгой должна быть связана только одна рабочая область.

### <a name="why-is-the-conditional-access-policies-parameter-is-empty"></a>Почему параметр политик условного доступа пуст?

Список политик создается путем просмотра политик, оцененных для самого последнего события входа. Если в клиенте нет недавних входов, может потребоваться подождать несколько минут, чтобы книга загрузила список политик условного доступа. Это может произойти сразу после настройки Log Analytics или может занять больше времени, если у клиента нет недавних действий входа.

### <a name="why-is-the-workbook-taking-a-long-time-to-load"></a>Почему книга долго загружается?  

В зависимости от выбранного диапазона времени и размера клиента книга может оценивать чрезвычайно большое количество событий входа. Для больших клиентов количество входов в систему может превысить емкость запроса в Log Analytics. Попробуйте сократить диапазон времени до 4 часов, чтобы проверить, загружается ли книга.  

### <a name="after-loading-for-a-few-minutes-why-is-the-workbook-returning-zero-results"></a>Почему книга возвращает нулевые результаты после нескольких минут загрузки? 

Когда количество входов в систему превышает емкость запроса в Log Analytics, книга возвращает нулевые результаты. Попробуйте сократить диапазон времени до 4 часов, чтобы проверить, загружается ли книга.  

### <a name="can-i-save-my-parameter-selections"></a>Можно ли сохранить выбранные параметры?  

Вы можете сохранить выбранные в верхней части книги параметры, последовательно выбрав **Azure Active Directory** > **Книги** > **Аналитические сведения и отчеты условного доступа**. Здесь можно найти шаблон книги, который можно изменить, а затем сохранить копию книги, включая параметры, в рабочей области в папке **Мои отчеты** или **Общие отчеты**. 

### <a name="can-i-edit-and-customize-the-workbook-with-additional-queries"></a>Можно ли изменить и настроить книгу с дополнительными запросами? 

Вы можете изменить и настроить книгу, последовательно выбрав **Azure Active Directory** > **Книги** > **Аналитические сведения и отчеты условного доступа**. Здесь можно найти шаблон книги, который можно изменить, а затем сохранить копию книги, включая параметры, в рабочей области в папке **Мои отчеты** или **Общие отчеты**. Чтобы начать редактирование запросов, щелкните **Изменить** в верхней части книги.  
 
## <a name="next-steps"></a>Дальнейшие действия

- [Режим условного доступа "Только отчет"](concept-conditional-access-report-only.md)

- Дополнительные сведения о книгах Azure AD см. в статье [использование Azure Monitor книг для Azure Active Directory отчетов](../reports-monitoring/howto-use-azure-monitor-workbooks.md).

- [Распространенные политики условного доступа](concept-conditional-access-policy-common.md)
