---
title: Часто задаваемые вопросы об управляемых удостоверениях для Azure AD, а также известные проблемы в их работе
description: Известные проблемы с управляемыми удостоверениями для ресурсов Azure.
services: active-directory
documentationcenter: ''
author: barclayn
manager: daveba
editor: ''
ms.assetid: 2097381a-a7ec-4e3b-b4ff-5d2fb17403b6
ms.service: active-directory
ms.subservice: msi
ms.devlang: ''
ms.topic: conceptual
ms.tgt_pltfrm: ''
ms.workload: identity
ms.date: 02/04/2021
ms.author: barclayn
ms.collection: M365-identity-device-management
ms.custom: has-adal-ref
ms.openlocfilehash: 3f1be2e64435cb0bcdb369a398a9a65fc3714fb2
ms.sourcegitcommit: 49ea056bbb5957b5443f035d28c1d8f84f5a407b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/09/2021
ms.locfileid: "100008542"
---
# <a name="faqs-and-known-issues-with-managed-identities-for-azure-resources"></a>Часто задаваемые вопросы об управляемых удостоверениях для ресурсов Azure, а также известные проблемы в их работе

[!INCLUDE [preview-notice](../../../includes/active-directory-msi-preview-notice.md)]

## <a name="frequently-asked-questions-faqs"></a>Часто задаваемые вопросы (FAQ)

> [!NOTE]
> Управляемые удостоверения для ресурсов Azure — это новое название службы "Управляемое удостоверение службы" (MSI).

### <a name="how-can-you-find-resources-that-have-a-managed-identity"></a>Как можно найти ресурсы с управляемым удостоверением?

Список ресурсов, которым назначено системное управляемое удостоверение, можно найти с помощью следующей команды Azure CLI: 

```azurecli-interactive
az resource list --query "[?identity.type=='SystemAssigned'].{Name:name,  principalId:identity.principalId}" --output table
```

### <a name="do-managed-identities-have-a-backing-app-object"></a>Есть ли управляемые удостоверения с резервным объектом приложения?

Нет. Управляемые удостоверения и Azure AD App регистрации в каталоге не совпадают. 

Регистрация приложений два компонента: объект приложения и объект субъекта-службы. Управляемые удостоверения для ресурсов Azure имеют только один из этих компонентов: объект субъекта-службы. 

Управляемые удостоверения не содержат объект приложения в каталоге, который обычно используется для предоставления разрешений приложению для MS Graph. Вместо этого разрешения на MS Graph для управляемых удостоверений должны быть предоставлены непосредственно субъекту-службе.  

### <a name="can-the-same-managed-identity-be-used-across-multiple-regions"></a>Можно ли использовать одно и то же управляемое удостоверение в нескольких регионах?

Вкратце, вы можете использовать управляемые удостоверения, назначенные пользователем, в нескольких регионах Azure. Более длинный ответ заключается в том, что в то время как управляемые удостоверения, назначенные пользователем, создаются в качестве региональных ресурсов, связанный [субъект-служба](../develop/app-objects-and-service-principals.md#service-principal-object) (SPN), созданный в Azure AD, доступен глобально. Субъект-служба можно использовать из любого региона Azure, и его доступность зависит от доступности Azure AD. Например, если вы создали управляемое удостоверение, назначенное пользователем в регионе South-Central и этот регион становится недоступным, эта проблема влияет только на действия [плоскости управления](../../azure-resource-manager/management/control-plane-and-data-plane.md) в самом управляемом удостоверении.  Действия, выполняемые любыми ресурсами, которые уже настроены на использование управляемых удостоверений, не будут затронуты.

### <a name="does-managed-identities-for-azure-resources-work-with-azure-cloud-services"></a>Можно ли использовать управляемые удостоверения для ресурсов Azure с облачными службами Azure?

Нет, мы не планируем реализовать поддержку управляемых удостоверений для ресурсов Azure в облачных службах Azure.

### <a name="what-is-the-credential-associated-with-a-managed-identity-how-long-is-it-valid-and-how-often-is-it-rotated"></a>Что такое учетные данные, связанные с управляемым удостоверением? Сколько времени оно действительно и как часто оно поворачивается?

> [!NOTE]
> Проверка подлинности управляемых удостоверений — это внутренняя реализация, которая может быть изменена без предварительного уведомления.

Управляемые удостоверения используют проверку подлинности на основе сертификатов. Срок действия всех учетных данных управляемого удостоверения составляет 90 дней, и он будет выполнен после 45 дней.

### <a name="what-is-the-security-boundary-of-managed-identities-for-azure-resources"></a>Что такое периметр безопасности для управляемых удостоверений для ресурсов Azure?

Периметром безопасности удостоверения является ресурс, к которому оно подключено. Например, периметром безопасности для виртуальной машины с включенными управляемыми удостоверениями для ресурсов Azure является виртуальная машина. В любом коде, выполняемом на этой виртуальной машине, можно вызвать управляемые удостоверения для конечной точки ресурсов Azure и маркеров запроса. Этот принцип применяется и к другим ресурсам, которые поддерживают управляемые удостоверения для ресурсов Azure.

### <a name="what-identity-will-imds-default-to-if-dont-specify-the-identity-in-the-request"></a>Какое удостоверение IMDS будет использовать по умолчанию, если не указать удостоверение в запросе?

- По умолчанию в IMDS будет использоваться управляемое удостоверение, назначаемое системой, если оно включено и если удостоверение не указано в запросе.
- Если такое удостоверение не включено и существует только одно управляемое удостоверение, назначаемое пользователем, по умолчанию в IMDS будет использоваться это управляемое удостоверение, назначаемое пользователем. 
- Если управляемое удостоверение не включено и существует несколько управляемых удостоверений, назначаемых пользователем, то указание конкретного удостоверения в запросе является обязательным.

### <a name="will-managed-identities-be-recreated-automatically-if-i-move-a-subscription-to-another-directory"></a>Воссоздаются ли управляемые удостоверения автоматически, если подписка перемещена в другой каталог?

Нет. Если вы перемещаете подписку в другой каталог, потребуется вручную повторно создать ее и снова предоставить назначения ролей Azure.
- Управляемые удостоверения, назначаемые системой, нужно отключить и снова включить. 
- Для управляемых удостоверений, назначенных пользователем: удалите, повторно создайте и повторно подключите их к необходимым ресурсам (например, к виртуальным машинам).

### <a name="can-i-use-a-managed-identity-to-access-a-resource-in-a-different-directorytenant"></a>Можно использовать управляемое удостоверение для доступа к ресурсу в другом каталоге или клиенте?

Нет. Сейчас управляемые удостоверения не поддерживаются в сценариях работы с разными каталогами. 

### <a name="what-azure-rbac-permissions-are-required-to-managed-identity-on-a-resource"></a>Какие разрешения Azure RBAC требуются для управляемого удостоверения в ресурсе? 

- Управляемое удостоверение, назначаемое системой: необходимо разрешение на запись для ресурса. Например, для виртуальных машин необходимо разрешение Microsoft.Compute/virtualMachines/write. Это действие включено во встроенные роли для конкретных ресурсов, например [Участник виртуальных машин](../../role-based-access-control/built-in-roles.md#virtual-machine-contributor).
- Управляемое удостоверение, назначаемое пользователем: необходимо разрешение на запись для ресурса. Например, для виртуальных машин необходимо разрешение Microsoft.Compute/virtualMachines/write. Вдобавок к назначению роли [Оператора управляемого удостоверения](../../role-based-access-control/built-in-roles.md#managed-identity-operator) для управляемого удостоверения.

### <a name="how-do-i-prevent-the-creation-of-user-assigned-managed-identities"></a>Разделы справки предотвратить создание управляемых удостоверений, назначаемых пользователем?

Вы можете запретить пользователям создавать управляемые удостоверения, назначенные пользователем, с помощью [политики Azure](../../governance/policy/overview.md) .

- Перейдите к [портал Azure](https://portal.azure.com) и перейдите к **политике**.
- Выбор **определений**
- Выберите **+ Определение политики** и введите необходимые сведения.
- В разделе правила политики вставьте

```json
{
  "mode": "All",
  "policyRule": {
    "if": {
      "field": "type",
      "equals": "Microsoft.ManagedIdentity/userAssignedIdentities"
    },
    "then": {
      "effect": "deny"
    }
  },
  "parameters": {}
}

```

После создания политики назначьте ее группе ресурсов, которую вы хотите использовать.

- Перейдите к разделу группы ресурсов.
- Найдите группу ресурсов, используемую для тестирования.
- В меню слева выберите **политики** .
- Выбор **назначения политики**
- В разделе " **Основные сведения** " укажите:
    - **Область действия** Группа ресурсов, используемая для тестирования
    - **Определение политики**. ранее созданная политика.
- Оставьте все остальные параметры по умолчанию и выберите **Просмотр и создание** .

На этом этапе все попытки создания управляемого удостоверения, назначенного пользователем в группе ресурсов, завершатся ошибкой.

  ![Нарушение политики](./media/known-issues/policy-violation.png)

## <a name="known-issues"></a>Известные проблемы

### <a name="automation-script-fails-when-attempting-schema-export-for-managed-identities-for-azure-resources-extension"></a>Скрипт автоматизации завершается ошибкой при попытке экспорта схемы для расширения управляемых удостоверений для ресурсов Azure

Если на виртуальной машине включены управляемые удостоверения для ресурсов Azure, отображается следующая ошибка при попытке использовать функцию "Скрипт автоматизации" для виртуальной машины или ее группы ресурсов.

![Ошибка экспорта скрипта автоматизации управляемых удостоверений для ресурсов Azure](./media/msi-known-issues/automation-script-export-error.png)

Расширение виртуальной машины для управляемых удостоверений для ресурсов Azure (которое будет выведено из эксплуатации в январе 2019 г.) сейчас не поддерживает возможность экспорта его схемы в шаблон группы ресурсов. Поэтому созданный шаблон не содержит параметры конфигурации для включения управляемых удостоверений для ресурсов Azure в ресурсе. Эти разделы можно добавить вручную. Инструкции и примеры см. в статье [Настройка управляемых удостоверений для ресурсов Azure на виртуальной машине Azure с помощью шаблонов](qs-configure-template-windows-vm.md).

Когда функция экспорта схемы станет доступной для расширения виртуальной машины для управляемых удостоверений для ресурсов Azure (которое будет выведено из эксплуатации в январе 2019 г.), оно будет добавлено в раздел [Поддерживаемые расширения виртуальной машины](../../virtual-machines/extensions/export-templates.md#supported-virtual-machine-extensions).

### <a name="vm-fails-to-start-after-being-moved-from-resource-group-or-subscription"></a>Виртуальная машина не запускается после перемещения из группы ресурсов или подписки

Если перемещается запущенная виртуальная машина, то она продолжает работать во время перемещения. Однако если после перемещения виртуальная машина останавливается и перезапускается, то ее запуск завершается сбоем. Эта проблема возникает из-за того, что виртуальная машина не обновляет ссылку на идентификатор управляемых удостоверений для ресурсов Azure и продолжает указывать на него в старой группе ресурсов.

**Обходное решение** 
 
Активируйте обновление на виртуальной машине, чтобы она могла получить правильные значения управляемых удостоверений для ресурсов Azure. Можно изменить свойства виртуальной машины, чтобы обновить ссылку на ресурс управляемых удостоверений для ресурсов Azure. Например, можно задать новое значение тега виртуальной машины с помощью следующей команды.

```azurecli-interactive
az vm update -n <VM Name> -g <Resource Group> --set tags.fixVM=1
```
 
Эта команда задает новый тег fixVM со значением 1 для виртуальной машины. 
 
После установки этого свойства виртуальная машина обновится и будет использовать правильный универсальный код ресурса (URI) управляемых удостоверений для ресурсов Azure, и вы сможете запустить ее. 
 
После запуска виртуальной машины этот тег можно будет удалить, выполнив следующую команду.

```azurecli-interactive
az vm update -n <VM Name> -g <Resource Group> --remove tags.fixVM
```

### <a name="transferring-a-subscription-between-azure-ad-directories"></a>Передача подписки между каталогами Azure AD

Управляемые удостоверения не обновляются при перемещении или перенесении подписки в другой каталог. Таким образом, любые существующие управляемые удостоверения, назначаемые системой или пользователем, будут повреждены. 

Обходное решение для управляемых удостоверений в подписке, перемещенной в другой каталог:

 - Управляемые удостоверения, назначаемые системой, нужно отключить и снова включить. 
 - Для управляемых удостоверений, назначенных пользователем: удалите, повторно создайте и повторно подключите их к необходимым ресурсам (например, к виртуальным машинам).

Дополнительные сведения см. в статье [Перенос подписки Azure в другой каталог Azure AD](../../role-based-access-control/transfer-subscription.md).

### <a name="moving-a-user-assigned-managed-identity-to-a-different-resource-groupsubscription"></a>Перемещение управляемого удостоверения, назначаемого пользователем, в другую группу ресурсов/подписку

Перемещение управляемого удостоверения, назначаемого пользователем, в другую группу ресурсов не поддерживается.
