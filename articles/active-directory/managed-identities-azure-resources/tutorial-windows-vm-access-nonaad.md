---
title: Учебник. Получение доступа к Azure Key Vault для Windows в Azure AD с помощью управляемого удостоверения
description: Из этого руководства вы узнаете, как получить доступ к хранилищу Azure Key Vault с помощью назначенного системой управляемого удостоверения на виртуальной машине Windows.
services: active-directory
documentationcenter: ''
author: barclayn
manager: daveba
editor: daveba
ms.service: active-directory
ms.subservice: msi
ms.devlang: na
ms.topic: tutorial
ms.tgt_pltfrm: na
ms.workload: identity
ms.date: 12/10/2020
ms.author: barclayn
ms.collection: M365-identity-device-management
ms.openlocfilehash: 0f29c9daba80ffc57b96cf5bd82690dea9ac6429
ms.sourcegitcommit: 97c48e630ec22edc12a0f8e4e592d1676323d7b0
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/18/2021
ms.locfileid: "101093748"
---
# <a name="tutorial-use-a-windows-vm-system-assigned-managed-identity-to-access-azure-key-vault"></a>Руководство по Использование назначенного системой управляемого удостоверения на виртуальной машине Windows для доступа к Azure Key Vault 

[!INCLUDE [preview-notice](../../../includes/active-directory-msi-preview-notice.md)]

В этом руководстве показано, как получить доступ к [Azure Key Vault](../../key-vault/general/overview.md) с помощью назначаемого системой управляемого удостоверения для виртуальной машины Windows. При использовании в качестве начальной загрузки хранилище Key Vault позволяет клиентскому приложению использовать секрет для обращения к ресурсам, которые не защищены с помощью Azure Active Directory (AD). Управляемыми удостоверениями службы автоматически управляет Azure. Они позволяют проходить проверку подлинности в службах, поддерживающих аутентификацию Azure AD, без указания сведений о проверке подлинности кода.

Вы узнаете, как выполнять следующие задачи:

> [!div class="checklist"]
> * предоставлять виртуальной машине доступ к секрету в Key Vault;
> * получать маркер доступа с помощью удостоверения виртуальной машины и использовать его для получения секрета из Key Vault. 

## <a name="prerequisites"></a>Предварительные требования

- Основные сведения об управляемых удостоверениях. См. дополнительные сведения об [управляемых удостоверениях для ресурсов Azure](overview.md). 
- Учетная запись Azure. Зарегистрируйте [бесплатную учетную запись](https://azure.microsoft.com/free/).
- Разрешения роли "Владелец" в соответствующей области (подписка или группа ресурсов) для выполнения требуемых операций создания ресурсов и управления ролями учетной записи. Если нуждаетесь в помощи с назначением ролей, прочитайте статью [Назначение ролей Azure с помощью портала Azure](../../role-based-access-control/role-assignments-portal.md).
- Кроме того, вам потребуется виртуальная машина Windows с включенными управляемыми удостоверениями, назначенными системой.
  - Если вам нужно создать виртуальную машину для работы с этим руководством, см. раздел [Управляемое удостоверение, назначаемое системой](./qs-configure-portal-windows-vm.md#system-assigned-managed-identity).

## <a name="create-a-key-vault"></a>Создание хранилища ключей  

В этом разделе показано, как предоставить виртуальной машине доступ к секрету в Key Vault. С помощью управляемых удостоверений для ресурсов Azure код может получить маркеры доступа, чтобы пройти проверку подлинности и получить доступ к ресурсам, поддерживающим аутентификацию Azure AD.Однако не все службы Azure поддерживают аутентификацию Azure AD. Чтобы использовать управляемые удостоверения для ресурсов Azure с такими службами, сохраните учетные данные службы в Azure Key Vault и используйте управляемое удостоверение виртуальной машины для доступа к Key Vault и получения учетных данных.

Сначала нужно создать хранилище Key Vault и предоставить удостоверению виртуальной машины доступ к нему.

1. Откройте [портал Azure](https://portal.azure.com/).
1. В верхней части меню навигации слева выберите **Создать ресурс**.  
1. В поле **Поиск в Marketplace** введите **Key Vault** и нажмите клавишу **ВВОД**.  
1. В списке результатов выберите **Key Vault**.
1. Выберите **Создать**.
1. Укажите **имя** для нового хранилища Key Vault.

    ![Экран "Создание хранилища ключей"](./media/msi-tutorial-windows-vm-access-nonaad/create-key-vault.png)

1. Укажите необходимые сведения, чтобы выбрать подписку и группу ресурсов, в которых была создана виртуальная машина, используемая для работы с этим учебником.
1. Выберите **Просмотр и создание**.
1. Выберите **Создать**.

### <a name="create-a-secret"></a>Создание секрета

Затем добавьте секрет в хранилище Key Vault, чтобы позже извлечь его с помощью кода, который вы запустите на виртуальной машине: Для работы с этим руководством мы используем PowerShell, но эти принципы применимы к любому коду, выполняющемуся в этой виртуальной машине.

1. Вернитесь к только что созданному экземпляру Key Vault.
1. Выберите **Секреты** и щелкните **Добавить**.
1. Выберите **Создать или импортировать**.
1. На экране **Создание секрета** в разделе **Параметры отправки** выберите **Вручную**.
1. Введите имя и значение для секрета.  Значение может быть любым. 
1. Не указывайте дату активации и окончания срока действия и для параметра **Включено** оставьте значение **Да**. 
1. Щелкните **Создать**, чтобы создать секрет.

   ![Создание секрета](./media/msi-tutorial-windows-vm-access-nonaad/create-secret.png)

## <a name="grant-access"></a>Предоставление доступа

Управляемому удостоверению, используемому виртуальной машиной, необходимо предоставить доступ для чтения секрета, который будет храниться в Key Vault.

1. Вернитесь к только что созданному экземпляру Key Vault.
1. Выберите **Политика доступа** в меню слева.
1. Нажмите **Добавить политику доступа**

   ![Экран создания политики доступа к Key Vault](./media/msi-tutorial-windows-vm-access-nonaad/key-vault-access-policy.png)

1. В разделе **Добавить политику доступа** в окне **Настроить при помощи шаблона (необязательно)** в раскрывающемся меню выберите **Управление секретами**.
1. Выберите **Выбор субъекта** и в поле поиска введите имя созданной ранее виртуальной машины.  Выберите виртуальную машину в списке результатов и щелкните **Выбрать**.
1. Нажмите **Добавить**
1. Нажмите кнопку **Сохранить**.


## <a name="access-data"></a>Доступ к данным  

В этом разделе показано, как получить маркер доступа с помощью удостоверения виртуальной машины и использовать этот маркер для получения секрета из Key Vault. Если вы не установили версию PowerShell 4.3.1 или выше, [загрузите и установите последнюю версию](/powershell/azure/).

Сначала получим маркер доступа для аутентификации в Key Vault с помощью управляемого удостоверения виртуальной машины:
 
1. На портале перейдите к разделу **Виртуальные машины**, выберите свою виртуальную машину Windows и в разделе **Обзор** щелкните **Подключить**.
2. Введите **имя пользователя** и **пароль**, добавленные при создании **виртуальной машины Windows**.  
3. Теперь, когда создано **подключение к удаленному рабочему столу** с виртуальной машиной, откройте PowerShell в удаленном сеансе.  
4. Отправьте веб-запрос к клиенту в PowerShell, чтобы получить токен для локального узла на конкретный порт для виртуальной машины.  

Запрос PowerShell:

```powershell
$Response = Invoke-RestMethod -Uri 'http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https%3A%2F%2Fvault.azure.net' -Method GET -Headers @{Metadata="true"} 
```

Вы можете увидеть, как выглядит ответ:

![Ответ на запрос с маркером](./media/msi-tutorial-windows-vm-access-nonaad/token.png)

Затем извлеките маркер доступа из ответа.  

```powershell
   $KeyVaultToken = $Response.access_token
```

Наконец используйте команду Invoke-WebRequest PowerShell для извлечения секрета, созданного ранее в хранилище Key Vault, и передайте маркер доступа в заголовок авторизации.  Вам потребуется URL-адрес вашего хранилища ключей, который находится в разделе **Основные компоненты** на странице **Обзор** в этом хранилище.  

```powershell
Invoke-RestMethod -Uri https://<your-key-vault-URL>/secrets/<secret-name>?api-version=2016-10-01 -Method GET -Headers @{Authorization="Bearer $KeyVaultToken"}
```

Ответ будет выглядеть следующим образом: 

```powershell
  value       id                                                                                    attributes
  -----       --                                                                                    ----------
  'My Secret' https://mi-lab-vault.vault.azure.net/secrets/mi-test/50644e90b13249b584c44b9f712f2e51 @{enabled=True; created=16…
```

После получения секрета из хранилища Key Vault, его можно использовать для аутентификации в службе, требующей имя пользователя и пароль.

## <a name="clean-up-resources"></a>Очистка ресурсов

Чтобы очистить ресурсы, перейдите на [портал Azure](https://portal.azure.com), выберите **Группы ресурсов**, найдите и выберите группу ресурсов (например, `mi-test`), созданную при работе с этим руководством, и используйте команду **Удалить группу ресурсов**.

Вы также можете использовать [PowerShell или CLI](../../azure-resource-manager/management/delete-resource-group.md).

## <a name="next-steps"></a>Дальнейшие действия

Из этого руководства вы узнали, как получить доступ к хранилищу Azure Key Vault с помощью назначенного системой управляемого удостоверения на виртуальной машине Windows.  Дополнительные сведения об Azure Key Vault см. здесь:

> [!div class="nextstepaction"]
>[Azure Key Vault](../../key-vault/general/overview.md)