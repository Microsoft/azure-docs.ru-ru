---
title: Вход в виртуальную машину Windows в Azure с помощью Azure Active Directory (Предварительная версия)
description: Вход Azure AD в виртуальную машину Azure под Windows
services: active-directory
ms.service: active-directory
ms.subservice: devices
ms.topic: how-to
ms.date: 07/20/2020
ms.author: joflore
author: MicrosoftGuyJFlo
manager: daveba
ms.reviewer: sandeo
ms.custom: references_regions, devx-track-azurecli
ms.collection: M365-identity-device-management
ms.openlocfilehash: 22a4bdc92ea2a91425c1070a5837c672307de665
ms.sourcegitcommit: b39cf769ce8e2eb7ea74cfdac6759a17a048b331
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/22/2021
ms.locfileid: "98683782"
---
# <a name="sign-in-to-windows-virtual-machine-in-azure-using-azure-active-directory-authentication-preview"></a>Вход в виртуальную машину Windows в Azure с помощью проверки подлинности Azure Active Directory (Предварительная версия)

Организации теперь могут использовать проверку подлинности Azure Active Directory (AD) для виртуальных машин Azure под **Windows Server 2019 Datacenter Edition** или **Windows 10 1809** и более поздних версий. Использование Azure AD для проверки подлинности на виртуальных машинах обеспечивает централизованное управление и применение политик. Такие средства, как управление доступом на основе ролей Azure (Azure RBAC) и условный доступ Azure AD, позволяют управлять доступом к виртуальной машине. В этой статье показано, как создать и настроить виртуальную машину Windows Server 2019 для использования проверки подлинности Azure AD.

> [!NOTE]
> Функция входа Azure AD для виртуальных машин Azure Windows — это общедоступная Предварительная версия функции Azure Active Directory. Дополнительные сведения о предварительных версиях см. в разделе Дополнительные  [условия использования для предварительных версий Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).

Существует множество преимуществ использования проверки подлинности Azure AD для входа на виртуальные машины Windows в Azure, в том числе:

- Используйте те же Федеративные или управляемые учетные данные Azure AD, которые вы обычно используете.
- Больше не требуется управлять учетными записями локального администратора.
- Azure RBAC позволяет предоставлять соответствующий доступ к виртуальным машинам в зависимости от необходимости и удалять его, если он больше не нужен.
- Перед предоставлением доступа к виртуальной машине условный доступ Azure AD может применять дополнительные требования, например: 
   - Многофакторная Идентификация
   - Проверка риска при входе
- Автоматизируйте и масштабируйте присоединение Azure AD к виртуальным машинам Windows Azure, которые являются частью развертывания VDI.

> [!NOTE]
> После включения этой возможности виртуальные машины Windows в Azure будут присоединены к Azure AD. Вы не можете присоединить его к другому домену, например к локальной службе AD или Azure AD DS. Если это необходимо, необходимо отключить виртуальную машину от клиента Azure AD путем удаления расширения.

## <a name="requirements"></a>Требования

### <a name="supported-azure-regions-and-windows-distributions"></a>Поддерживаемые регионы Azure и дистрибутивы Windows

В настоящее время в предварительной версии этой функции поддерживаются следующие дистрибутивы Windows:

- Windows Server 2019 Datacenter
- Windows 10 1809 и более поздние версии

> [!IMPORTANT]
> Удаленное подключение к виртуальным машинам, присоединенным к Azure AD, разрешено только с компьютеров Windows 10, которые зарегистрированы в Azure AD (начиная с Windows 10 20H1), присоединенных к Azure AD или гибридной службы Azure AD к тому **же** каталогу, что и виртуальная машина. 

В режиме предварительной версии этой функции сейчас поддерживаются следующие регионы Azure:

- Все глобальные регионы Azure

> [!IMPORTANT]
> Чтобы использовать эту предварительную версию функции, разверните только поддерживаемое распространение Windows и в поддерживаемом регионе Azure. В настоящее время эта функция не поддерживается в облаках Azure для государственных организаций и независимых.

### <a name="network-requirements"></a>Требования к сети

Чтобы включить проверку подлинности Azure AD для виртуальных машин Windows в Azure, необходимо убедиться, что конфигурация сети виртуальных машин разрешает исходящий доступ к следующим конечным точкам через TCP-порт 443:

- HTTPS: \/ /enterpriseregistration.Windows.NET
- https:\//login.microsoftonline.com
- HTTPS: \/ /Device.Login.microsoftonline.com
- HTTPS: \/ /PAS.Windows.NET

## <a name="enabling-azure-ad-login-in-for-windows-vm-in-azure"></a>Включение входа Azure AD в для виртуальной машины Windows в Azure

Чтобы использовать вход Azure AD в для виртуальной машины Windows в Azure, необходимо сначала включить параметр входа в Azure AD для виртуальной машины Windows, а затем настроить назначения ролей Azure для пользователей, которым разрешено выполнять вход на виртуальную машину.
Существует несколько способов включения имени входа Azure AD для виртуальной машины Windows.

- Использование портал Azure при создании виртуальной машины Windows
- Использование Azure Cloud Shell при создании виртуальной машины Windows **или существующей виртуальной машины Windows**

### <a name="using-azure-portal-create-vm-experience-to-enable-azure-ad-login"></a>Использование портал Azure создания виртуальной машины для включения имени входа Azure AD

Вы можете включить имя входа Azure AD для Windows Server 2019 Datacenter или Windows 10 1809 и более поздних образов виртуальных машин. 

Чтобы создать виртуальную машину Windows Server 2019 Datacenter в Azure с помощью входа Azure AD, выполните следующие действия. 

1. Войдите в [портал Azure](https://portal.azure.com)с учетной записью, которая имеет доступ для создания виртуальных машин, и выберите **+ создать ресурс**.
1. Введите **Windows Server** в поле Поиск в строке поиска Marketplace.
   1. Щелкните **Windows Server** и выберите **Windows Server 2019 Datacenter** в раскрывающемся списке выберите план программного обеспечения.
   1. Щелкните **создать**.
1. На вкладке "Управление" включите параметр **войти с использованием учетных данных AAD (Предварительная версия)** в разделе **Azure Active Directory.**
1. Убедитесь, что **управляемое удостоверение, назначенное системой** , в разделе удостоверение установлено в значение **вкл**. Это действие должно выполняться автоматически при включении входа с использованием учетных данных Azure AD.
1. Пройдите весь процесс создания виртуальной машины. Во время этой предварительной версии потребуется создать имя пользователя и пароль администратора для виртуальной машины.

![Вход с использованием учетных данных Azure AD создание виртуальной машины](./media/howto-vm-sign-in-azure-ad-windows/azure-portal-login-with-azure-ad.png)

> [!NOTE]
> Чтобы войти в виртуальную машину с помощью учетных данных Azure AD, сначала необходимо настроить назначения ролей для виртуальной машины, как описано в одном из следующих разделов.

### <a name="using-the-azure-cloud-shell-experience-to-enable-azure-ad-login"></a>Использование интерфейса Azure Cloud Shell для включения имени входа Azure AD

Azure Cloud Shell — это бесплатная интерактивная оболочка, с помощью которой можно выполнять действия, описанные в этой статье. В Cloud Shell предварительно установлены и настроены общие инструменты Azure для использования с вашей учетной записью. Нажмите кнопку "Копировать", чтобы скопировать код. Вставьте его в Cloud Shell и нажмите клавишу "ВВОД", чтобы выполнить код. Cloud Shell можно открыть разными способами:

Нажмите кнопку Попробовать в правом верхнем углу блока с кодом.
Откройте Cloud Shell в браузере.
Нажмите кнопку меню Cloud Shell в правом верхнем углу окна [портала Azure](https://portal.azure.com).

Если вы решили установить и использовать CLI локально, для работы с этой статьей требуется Azure CLI версии 2.0.31 или более поздней. Чтобы узнать версию, выполните команду az --version. Если необходимо установить или обновить, см. статью [установка Azure CLI](/cli/azure/install-azure-cli).

1. Создайте группу ресурсов с помощью команды [az group create](/cli/azure/group#az-group-create). 
1. Создайте виртуальную машину с помощью команды [AZ VM Create](/cli/azure/vm#az-vm-create) , используя поддерживаемое распространение в поддерживаемом регионе. 
1. Установите расширение виртуальной машины для входа в Azure AD. 

В следующем примере выполняется развертывание виртуальной машины с именем myVM, которая использует Win2019Datacenter, в группу ресурсов с именем myResourceGroup в регионе southcentralus. В следующих примерах можно при необходимости указать собственную группу ресурсов и имена виртуальных машин.

```AzureCLI
az group create --name myResourceGroup --location southcentralus

az vm create \
    --resource-group myResourceGroup \
    --name myVM \
    --image Win2019Datacenter \
    --assign-identity \
    --admin-username azureuser \
    --admin-password yourpassword
```

> [!NOTE]
> Перед установкой расширения виртуальной машины для входа в Azure AD необходимо включить управляемое удостоверение, назначенное системой, на виртуальной машине.

Создание виртуальной машины и вспомогательных ресурсов занимает несколько минут.

Наконец, установите расширение виртуальной машины для входа Azure AD, чтобы включить имя входа Azure AD для виртуальной машины Windows. Расширения виртуальных машин — это небольшие приложения, которые выполняют задачи настройки и автоматизации после развертывания виртуальных машин Azure. Используйте команду [AZ VM Extension](/cli/azure/vm/extension#az-vm-extension-set) Set, чтобы установить расширение аадлогинфорвиндовс на виртуальной машине с именем myVM в группе ресурсов myResourceGroup:

> [!NOTE]
> Вы можете установить расширение Аадлогинфорвиндовс на имеющейся виртуальной машине Windows Server 2019 или Windows 10 1809 и более поздних версий, чтобы включить ее для проверки подлинности Azure AD. Ниже приведен пример AZ CLI.

```AzureCLI
az vm extension set \
    --publisher Microsoft.Azure.ActiveDirectory \
    --name AADLoginForWindows \
    --resource-group myResourceGroup \
    --vm-name myVM
```

Параметр `provisioningState` из отображается `Succeeded` , если расширение установлено на виртуальной машине.

## <a name="configure-role-assignments-for-the-vm"></a>Настройка назначений ролей для виртуальной машины

Теперь, когда виртуальная машина создана, необходимо настроить политику Azure RBAC, чтобы определить, кто может войти в виртуальную машину. Для авторизации имени входа виртуальной машины используются две роли Azure:

- **Имя для входа администратора виртуальной машины**. пользователи с этой ролью могут войти в виртуальную машину Azure с правами администратора.
- **Имя для входа пользователя виртуальной машины.** Пользователи с этой ролью могут входить на виртуальную машину Azure с правами обычного пользователя.

> [!NOTE]
> Чтобы разрешить пользователю входить на ВИРТУАЛЬную машину по протоколу RDP, необходимо назначить имя входа администратора виртуальной машины или роль входа пользователя виртуальной машины. Пользователь Azure с ролями владельца или участника, назначенных для виртуальной машины, не имеет автоматически привилегий для входа на виртуальную машину по протоколу RDP. Это позволяет обеспечить разделение между набором пользователей, управляющих виртуальными машинами, и набором пользователей, которые имеют доступ к виртуальным машинам.

Существует несколько способов настройки назначений ролей для виртуальной машины.

- Использование интерфейса портала Azure AD
- Использование интерфейса Azure Cloud Shell

> [!NOTE]
> Роли входа администратора виртуальной машины и пользователя виртуальной машины используют действия с данными и поэтому не могут быть назначены в области группы управления. В настоящее время эти роли можно назначать только в подписке, группе ресурсов или области ресурсов.

### <a name="using-azure-ad-portal-experience"></a>Использование интерфейса портала Azure AD

Чтобы настроить назначения ролей для виртуальных машин Windows Server 2019 Datacenter с поддержкой Azure AD, выполните следующие действия.

1. Перейдите на страницу обзора конкретных виртуальных машин.
1. Выберите **Управление доступом (IAM)** в меню Параметры.
1. Выберите **Добавить**, **добавить назначение ролей** , чтобы открыть панель Добавление назначения ролей.
1. В раскрывающемся списке **Role (роль** ) выберите роль, например **имя входа администратора виртуальной машины** или **имя входа пользователя виртуальной машины**.
1. В поле **Выбор** выберите пользователя, группу, субъект-службу или управляемое удостоверение. Если субъект безопасности не отображается в списке, введите его имя в поле **Выбор**, чтобы найти в каталоге отображаемые имена, адреса электронной почты и идентификаторы объектов.
1. Нажмите кнопку **сохранить**, чтобы назначить роль.

Через несколько секунд субъекту безопасности будет назначена роль в выбранной области.

![Назначение ролей пользователям, которые будут получать доступ к виртуальной машине](./media/howto-vm-sign-in-azure-ad-windows/azure-portal-access-control-assign-role.png)

### <a name="using-the-azure-cloud-shell-experience"></a>Использование интерфейса Azure Cloud Shell

В следующем примере используется команда [az role assignment create](/cli/azure/role/assignment#az-role-assignment-create) для назначения роли Имя для входа администратора виртуальной машины виртуальной машине текущего пользователя Azure. Имя пользователя активной учетной записи Azure можно получить с помощью команды [az account show](/cli/azure/account#az-account-show). В качестве области задается виртуальная машина, созданная на предыдущем шаге с помощью команды [az vm show](/cli/azure/vm#az-vm-show). Область может также быть назначена на уровне группы ресурсов или подписки, и применяются обычные разрешения на наследование Azure RBAC. Дополнительные сведения см. в статье [Вход в виртуальную машину Linux в Azure с использованием проверки подлинности Azure Active Directory](../../virtual-machines/linux/login-using-aad.md).

```   AzureCLI
$username=$(az account show --query user.name --output tsv)
$vm=$(az vm show --resource-group myResourceGroup --name myVM --query id -o tsv)

az role assignment create \
    --role "Virtual Machine Administrator Login" \
    --assignee $username \
    --scope $vm
```

> [!NOTE]
> Если домен доменных имен AAD и имя пользователя для входа не совпадают, необходимо указать идентификатор объекта учетной записи пользователя, а `--assignee-object-id` не только имя пользователя для `--assignee` . Идентификатор объекта учетной записи пользователя можно получить с помощью команды [az ad user list](/cli/azure/ad/user#az-ad-user-list).

Дополнительные сведения об использовании Azure RBAC для управления доступом к ресурсам подписки Azure см. в следующих статьях:

- [Добавление и удаление назначений ролей Azure с помощью Azure CLI](../../role-based-access-control/role-assignments-cli.md)
- [Добавление и удаление назначений ролей Azure с помощью портала Azure](../../role-based-access-control/role-assignments-portal.md)
- [Добавление или удаление назначений ролей Azure с помощью Azure PowerShell](../../role-based-access-control/role-assignments-powershell.md).

## <a name="using-conditional-access"></a>Использование условного доступа

Вы можете применить политики условного доступа, такие как многофакторная проверка подлинности или проверка риска входа пользователя, прежде чем разрешить доступ к виртуальным машинам Windows в Azure, включенным при входе в Azure AD. Чтобы применить политику условного доступа, необходимо выбрать приложение "вход в виртуальную машину Azure" из параметра "облачные приложения" или "назначение действий", а затем использовать риск для входа в качестве условия и/или требовать многофакторную проверку подлинности в качестве предоставления контроля доступа. 

> [!NOTE]
> Если вы используете параметр "требовать многофакторную проверку подлинности", чтобы предоставить управление доступом для запроса доступа к приложению "вход в виртуальную машину Azure", необходимо предоставить утверждение многофакторной проверки подлинности как часть клиента, который инициирует сеанс RDP для целевой виртуальной машины Windows в Azure. Единственный способ добиться этого на клиенте Windows 10 — использовать ПИН-код Windows Hello для бизнеса или биометрическую проверку подлинности с клиентом RDP. Поддержка биометрической проверки подлинности была добавлена в клиент RDP в Windows 10 версии 1809. Удаленный рабочий стол с проверкой подлинности Windows Hello для бизнеса доступен только для развертываний, использующих модель доверия сертификатов и в настоящее время недоступно для модели доверия ключей.

> [!WARNING]
> Многофакторная проверка подлинности Azure AD для каждого пользователя включена и не поддерживается для входа на виртуальную машину.

## <a name="log-in-using-azure-ad-credentials-to-a-windows-vm"></a>Вход с использованием учетных данных Azure AD для виртуальной машины Windows

> [!IMPORTANT]
> Удаленное подключение к виртуальным машинам, присоединенным к Azure AD, разрешено только с компьютеров Windows 10, которые зарегистрированы в Azure AD (минимальная требуемая сборка — 20H1) или присоединена к Azure AD либо к тому **же** каталогу, что и виртуальная машина. Кроме того, в RDP с использованием учетных данных Azure AD пользователь должен принадлежать к одной из двух ролей Azure, имени входа администратора виртуальной машины или имени входа пользователя виртуальной машины. При использовании компьютера с Windows 10, зарегистрированного в Azure AD, необходимо ввести учетные данные в формате Азуреад\упн (например, AzureAD\john@contoso.com ). В настоящее время Azure бастиона нельзя использовать для входа с использованием Azure Active Directory проверки подлинности с помощью расширения Аадлогинфорвиндовс. поддерживается только прямой протокол RDP.

Чтобы войти в виртуальную машину Windows Server 2019 с помощью Azure AD, выполните следующие действия. 

1. Перейдите на страницу обзора виртуальной машины, которая была включена с помощью входа в Azure AD.
1. Щелкните **подключить** , чтобы открыть колонку подключение к виртуальной машине.
1. Выберите **Скачать RDP-файл**.
1. Нажмите кнопку **Открыть** , чтобы запустить клиент Подключение к удаленному рабочему столу.
1. Нажмите кнопку **Подключиться** , чтобы открыть диалоговое окно входа в Windows.
1. Вход с использованием учетных данных Azure AD.

Теперь вы вошли в виртуальную машину Azure Windows Server 2019 с назначенными разрешениями роли, например "пользователь виртуальной машины" или "Администратор виртуальной машины". 

> [!NOTE]
> Можно сохранить. RDP-файл локально на компьютере для запуска будущих подключений к удаленному рабочему столу виртуальной машины вместо перехода на страницу обзора виртуальных машин в портал Azure и с помощью параметра Connect.

## <a name="troubleshoot"></a>Диагностика

### <a name="troubleshoot-deployment-issues"></a>Устранение неполадок развертывания

Расширение Аадлогинфорвиндовс должно быть успешно установлено, чтобы виртуальная машина завершила процесс приподключения к Azure AD. Если расширение виртуальной машины не удается правильно установить, выполните следующие действия.

1. Подключитесь к виртуальной машине по протоколу RDP, используя учетную запись локального администратора, и изучите Коммандексекути'н. log в разделе  
   
   C:\WindowsAzure\Logs\Plugins\Microsoft.Azure.ActiveDirectory.AADLoginForWindows\0.3.1.0. 

   > [!NOTE]
   > Если расширение перезапускается после первоначального сбоя, журнал с ошибкой развертывания будет сохранен как CommandExecution_YYYYMMDDHHMMSSSSS. log. "
1. Откройте командную строку PowerShell на виртуальной машине и убедитесь, что эти запросы к конечной точке службы метаданных экземпляра (IMDS), работающей на узле Azure, возвращают:

   | Команда для запуска | Ожидаемые выходные данные |
   | --- | --- |
   | `curl -H @{"Metadata"="true"} "http://169.254.169.254/metadata/instance?api-version=2017-08-01"` | Правильные сведения о виртуальной машине Azure |
   | `curl -H @{"Metadata"="true"} "http://169.254.169.254/metadata/identity/info?api-version=2018-02-01"` | Допустимый идентификатор клиента, связанный с подпиской Azure |
   | `curl -H @{"Metadata"="true"} "http://169.254.169.254/metadata/identity/oauth2/token?resource=urn:ms-drs:enterpriseregistration.windows.net&api-version=2018-02-01"` | Допустимый маркер доступа, выданный Azure Active Directory для управляемого удостоверения, назначенного этой виртуальной машине |

   > [!NOTE]
   > Маркер доступа можно декодировать с помощью такого средства, как [http://calebb.net/](http://calebb.net/) . Проверьте, что идентификатор AppID в маркере доступа соответствует управляемому удостоверению, назначенному виртуальной машине.

1. Убедитесь, что необходимые конечные точки доступны из виртуальной машины с помощью командной строки:
   
   - фигурная HTTPS: \/ /Login.microsoftonline.com/-D —
   - фигурная HTTPS: \/ /Login.microsoftonline.com/ `<TenantID>` /-D —

   > [!NOTE]
   > Замените `<TenantID>` идентификатором клиента Azure AD, связанным с подпиской Azure.

   - фигурная HTTPS: \/ /enterpriseregistration.Windows.NET/-D-
   - фигурная HTTPS: \/ /Device.Login.microsoftonline.com/-D-
   - фигурная HTTPS: \/ /PAS.Windows.NET/-D-

1. Состояние устройства можно просмотреть, выполнив `dsregcmd /status` . Цель — показывать состояние устройства как `AzureAdJoined : YES` .

   > [!NOTE]
   > Действие присоединение к Azure AD регистрируется в средстве просмотра событий в журнале Регистратион\админов устройств пользователя.

Если расширение Аадлогинфорвиндовс завершается с определенным кодом ошибки, можно выполнить следующие действия.

#### <a name="issue-1-aadloginforwindows-extension-fails-to-install-with-terminal-error-code-1007-and-exit-code--2145648574"></a>Ошибка 1. не удается установить расширение Аадлогинфорвиндовс с кодом ошибки терминала "1007" и кодом выхода:-2145648574.

Этот код выхода преобразуется в DSREG_E_MSI_TENANTID_UNAVAILABLE, так как расширение не может запросить сведения о клиенте Azure AD.

1. Убедитесь, что виртуальная машина Azure может получить значение TenantID из службы метаданных экземпляра.

   - Подключитесь к виртуальной машине по протоколу RDP с правами локального администратора и убедитесь, что конечная точка возвращает допустимый идентификатор клиента, выполнив следующую команду из командной строки с повышенными привилегиями на виртуальной машине:
      
      - фигурные-H метаданные: true http://169.254.169.254/metadata/identity/info?api-version=2018-02-01

1. Администратор виртуальной машины пытается установить расширение Аадлогинфорвиндовс, но для управляемого удостоверения, назначенного системой, предварительно не была включена виртуальная машина. Перейдите в колонку удостоверение виртуальной машины. На вкладке назначенная система убедитесь, что параметр состояние имеет значение Вкл.

#### <a name="issue-2-aadloginforwindows-extension-fails-to-install-with-exit-code--2145648607"></a>Причина 2. не удается установить расширение Аадлогинфорвиндовс с кодом выхода:-2145648607

Этот код выхода преобразуется в DSREG_AUTOJOIN_DISC_FAILED, так как расширение не может достичь `https://enterpriseregistration.windows.net` конечной точки.

1. Убедитесь, что необходимые конечные точки доступны из виртуальной машины с помощью командной строки:

   - фигурная HTTPS: \/ /Login.microsoftonline.com/-D —
   - фигурная HTTPS: \/ /Login.microsoftonline.com/ `<TenantID>` /-D —
   
   > [!NOTE]
   > Замените `<TenantID>` идентификатором клиента Azure AD, связанным с подпиской Azure. Если необходимо найти идентификатор клиента, можно навести указатель мыши на имя учетной записи, чтобы получить идентификатор каталога или клиента, или выбрать Azure Active Directory > свойства > идентификатор каталога в портал Azure.

   - фигурная HTTPS: \/ /enterpriseregistration.Windows.NET/-D-
   - фигурная HTTPS: \/ /Device.Login.microsoftonline.com/-D-
   - фигурная HTTPS: \/ /PAS.Windows.NET/-D-

1. Если какая-либо из команд завершается с ошибкой "не удалось разрешить узел `<URL>` ", попробуйте выполнить эту команду, чтобы определить сервер DNS, используемый виртуальной машиной.
   
   `nslookup <URL>`

   > [!NOTE] 
   > Замените на `<URL>` полные доменные имена, используемые конечными точками, например "Login.microsoftonline.com".

1. Далее, если указать общедоступный DNS-сервер, команда будет выполнена:

   `nslookup <URL> 208.67.222.222`

1. При необходимости измените DNS-сервер, назначенный группе безопасности сети, к которой принадлежит виртуальная машина Azure.

#### <a name="issue-3-aadloginforwindows-extension-fails-to-install-with-exit-code-51"></a>Причина 3. не удается установить расширение Аадлогинфорвиндовс с кодом выхода: 51

Код выхода 51 преобразуется в "это расширение не поддерживается в операционной системе виртуальной машины".

В общедоступной предварительной версии расширение Аадлогинфорвиндовс предназначено только для установки на Windows Server 2019 или Windows 10 (сборка 1809 или более поздняя версия). Убедитесь, что версия Windows поддерживается. Если сборка Windows не поддерживается, удалите расширение виртуальной машины.

### <a name="troubleshoot-sign-in-issues"></a>Устранение неполадок при входе

Некоторые распространенные ошибки при попытке входа по протоколу RDP с использованием учетных данных Azure AD включают в себя не назначенные роли Azure, несанкционированный клиент или 2FA. Чтобы устранить эти проблемы, используйте следующие сведения.

Состояние устройства и единого входа можно просмотреть, выполнив `dsregcmd /status` . Целью является отображение состояния устройства, которое отображается как `AzureAdJoined : YES` и `SSO State` для отображения `AzureAdPrt : YES` .

Кроме того, вход по протоколу RDP с помощью учетных записей Azure AD регистрируется в средстве просмотра событий в журналах событий Аад\оператионал.

#### <a name="azure-role-not-assigned"></a>Роль Azure не назначена

Если при инициации подключения удаленного рабочего стола к виртуальной машине отображается следующее сообщение об ошибке: 

- Ваша учетная запись настроена для предотвращения использования этого устройства. Для получения дополнительных сведений обратитесь к системному администратору.

![Ваша учетная запись настроена для предотвращения использования этого устройства.](./media/howto-vm-sign-in-azure-ad-windows/rbac-role-not-assigned.png)

Убедитесь, что для ВИРТУАЛЬНОЙ машины [настроены политики RBAC Azure](../../virtual-machines/linux/login-using-aad.md) , которые предоставляют пользователю имя входа администратора виртуальной машины или роль входа пользователя виртуальной машины.

> [!NOTE]
> Если вы используете проблемы с назначениями ролей Azure, см. статью [Устранение неполадок в Azure RBAC](../../role-based-access-control/troubleshooting.md#azure-role-assignments-limit).
 
#### <a name="unauthorized-client"></a>Неавторизованный клиент

Если при инициации подключения удаленного рабочего стола к виртуальной машине отображается следующее сообщение об ошибке: 

- Ваши учетные данные не работали

![Ваши учетные данные не работали](./media/howto-vm-sign-in-azure-ad-windows/your-credentials-did-not-work.png)

Убедитесь, что компьютер Windows 10, который вы используете для запуска подключения к удаленному рабочему столу, — это одно из присоединенных к Azure AD или гибридное приложение Azure AD, присоединенное к тому же каталогу Azure AD, к которому присоединена виртуальная машина. Дополнительные сведения об удостоверении устройств см. в статье [что такое удостоверение устройства](./overview.md).

> [!NOTE]
> В Windows 10 Build 20H1 добавлена поддержка компьютера, зарегистрированного в Azure AD, для инициирования подключения RDP к виртуальной машине. Если вы используете зарегистрированный Azure AD (не присоединенный к Azure AD или Гибридный компьютер с Azure AD) в качестве клиента RDP для запуска подключений к виртуальной машине, необходимо ввести учетные данные в формате Азуреад\упн (например, AzureAD\john@contoso.com ).

Кроме того, убедитесь, что расширение Аадлогинфорвиндовс не было удалено после завершения приподключения к Azure AD.
 
#### <a name="mfa-sign-in-method-required"></a>Требуется метод входа MFA

Если при инициации подключения удаленного рабочего стола к виртуальной машине отображается следующее сообщение об ошибке: 

- Метод входа, который вы пытаетесь использовать, не разрешен. Попробуйте использовать другой метод входа или обратитесь к системному администратору.

![Метод входа, который вы пытаетесь использовать, не разрешен.](./media/howto-vm-sign-in-azure-ad-windows/mfa-sign-in-method-required.png)

Если вы настроили политику условного доступа, для которой требуется многофакторная проверка подлинности (MFA), прежде чем вы сможете получить доступ к ресурсу, необходимо убедиться, что компьютер с Windows 10, инициирующий подключение к удаленному рабочему столу к виртуальной машине, использует строгий метод проверки подлинности, например Windows Hello. Если вы не используете строгий метод проверки подлинности для подключения к удаленному рабочему столу, вы увидите предыдущую ошибку.

Если вы не развернули Windows Hello для бизнеса и если это не так, можно исключить требование MFA, настроив политику условного доступа, которая исключает приложение "вход в виртуальную машину Azure" из списка облачных приложений, требующих MFA. Дополнительные сведения о Windows Hello для бизнеса см. в статье [Обзор Windows Hello для бизнеса](/windows/security/identity-protection/hello-for-business/hello-identity-verification).

> [!NOTE]
> Проверка подлинности ПИН-кода Windows Hello для бизнеса с помощью протокола RDP поддерживается в Windows 10 для нескольких версий, однако в Windows 10 версии 1809 была добавлена поддержка биометрической проверки подлинности с помощью протокола RDP. Использование проверки подлинности Windows Hello для бизнеса во время RDP доступно только для развертываний, использующих модель доверия сертификатов и в настоящее время недоступно для модели доверия ключей.
 
## <a name="preview-feedback"></a>Отзывы о предварительной версии

Поделитесь своими отзывами об этой предварительной версии функции или сообщите о проблемах с ее помощью на [форуме обратной связи Azure AD](https://feedback.azure.com/forums/169401-azure-active-directory?category_id=166032).

## <a name="next-steps"></a>Следующие шаги

Дополнительные сведения об Azure Active Directory см. в статье [Что такое Azure Active Directory](../fundamentals/active-directory-whatis.md).