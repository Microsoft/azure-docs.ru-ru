---
title: Основной маркер обновления (PRT) и Azure AD — Azure Active Directory
description: Роль основного маркера обновления (PRT) в Azure Active Directory и способы управления им.
services: active-directory
ms.service: active-directory
ms.subservice: devices
ms.topic: conceptual
ms.date: 07/20/2020
ms.author: joflore
author: MicrosoftGuyJFlo
manager: daveba
ms.reviewer: ravenn
ms.collection: M365-identity-device-management
ms.openlocfilehash: 46cc8ef1158c02190f905cbe8eb1d12ea7be50a2
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "101644941"
---
# <a name="what-is-a-primary-refresh-token"></a>Что такое основной маркер обновления?

Основной маркер обновления (PRT) является ключевым артефактом проверки подлинности Azure AD на устройствах Windows 10, Windows Server 2016 и более поздних версий, iOS и Android. Это маркер JSON Web Token (JWT), специально выданный для собственных брокеров маркеров корпорации Майкрософт, чтобы обеспечить единый вход для приложений на этих устройствах. Эта статья содержит сведения о том, как выдается, используется и защищается маркер PRT на устройствах Windows 10.

В этой статье предполагается, что вы уже знакомы с различными состояниями устройств, доступными в Azure AD, и знаете, как работает единый вход в Windows 10. Дополнительные сведения об устройствах в Azure AD см. в статье [Что такое управление устройствами в Azure Active Directory?](overview.md)

## <a name="key-terminology-and-components"></a>Ключевые термины и компоненты

Следующие компоненты Windows играют ключевую роль в запросе и использовании PRT:

* **Облачный поставщик проверки подлинности** (CloudAP). CloudAP — это современный поставщик проверки подлинности для входа в Windows, который проверяет вход пользователей на устройство Windows 10. CloudAP предоставляет платформу подключаемых модулей, на основе которой поставщики удостоверений могут выполнять проверку подлинности в Windows с использованием данных для входа этого поставщика удостоверений.
* **Диспетчер учетных веб-записей** (WAM). WAM — это брокер маркеров по умолчанию на устройствах Windows 10. WAM также предоставляет платформу подключаемых модулей, на основе которой поставщики удостоверений могут создавать и включать единый вход для своих приложений, использующих этого поставщика удостоверений.
* **Подключаемый модуль Azure AD CloudAP**. Специальный подключаемый модуль Azure AD, созданный на платформе CloudAP, который проверяет учетные данные пользователя с помощью Azure AD во время входа в Windows.
* **Подключаемый модуль Azure AD WAM**. Специальный подключаемый модуль AAD, созданный на платформе WAM, который позволяет выполнять единый вход в приложения, использующие Azure AD для проверки подлинности.
* **Dsreg**. Специальный компонент Azure AD в Windows 10, который обрабатывает процесс регистрации устройства для всех его состояний.
* **Доверенный платформенный модуль** (TPM). TPM — это встроенный в устройство компонент оборудования, предоставляющий аппаратные функции безопасности для секретов пользователя и устройства. Дополнительные сведения см. в статье [Общие сведения о технологии доверенного платформенного модуля](/windows/security/information-protection/tpm/trusted-platform-module-overview).

## <a name="what-does-the-prt-contain"></a>Что содержит PRT?

PRT содержит утверждения, которые обычно находятся в маркере обновления Azure AD. Кроме того, в PRT есть некоторые утверждения для конкретных устройств. Вот они:

* **Код устройства**. PRT выдается пользователю определенного устройства. Утверждение кода устройства `deviceID` определяет устройство, на котором пользователю был выдан PRT. Это утверждение позже выдается маркерам, полученным через PRT. Утверждение кода устройства используется, чтобы определить авторизацию для условного доступа на основе соответствия или состояния устройства.
* **Сеансовый ключ**. Сеансовый ключ — это зашифрованный симметричный ключ, созданный службой аутентификации Azure AD, выданный в составе PRT. Сеансовый ключ выступает в качестве подтверждения владения, если PRT используется для получения маркеров для других приложений.

### <a name="can-i-see-whats-in-a-prt"></a>Можно ли увидеть содержимое PRT?

PRT — это непрозрачный большой двоичный объект, отправленный из Azure AD, содержимое которого не известно ни одному из клиентских компонентов. Вы не можете увидеть содержимое PRT.

## <a name="how-is-a-prt-issued"></a>Как выдается PRT?

Регистрация устройств является необходимым условием для проверки подлинности на основе устройств в Azure AD. PRT выдается пользователям только на зарегистрированных устройствах. Более подробные сведения о регистрации устройств см. в статье [Windows Hello для бизнеса и регистрация устройств](/windows/security/identity-protection/hello-for-business/hello-how-it-works-device-registration). Во время регистрации устройства компонент dsreg создает два набора пар криптографических ключей:

* ключ устройства (dkpub/dkpriv);
* ключ транспорта (tkpub/tkpriv).

Закрытые ключи привязываются к модулю TPM устройства, если оно имеет действительный и работоспособный TPM, а открытые ключи отправляются в Azure AD во время процесса регистрации устройства. Эти ключи используются для проверки состояния устройства во время запросов PRT.

PRT выдается во время проверки подлинности пользователя на устройстве Windows 10 в двух сценариях:

* **Во время обычного** или **гибридного присоединения к Azure AD**. Маркер PRT выдается при входе пользователя в Windows с учетными данными организации. Он выдается со всеми учетными данными, поддерживаемыми Windows 10, например паролем и Windows Hello для бизнеса. В этом сценарии подключаемый модуль Azure AD CloudAP является основным центром для PRT.
* **Устройство, зарегистрированное в Azure AD**. PRT выдается, если пользователь добавляет дополнительную рабочую учетную запись на устройство Windows 10. Пользователи могут добавить учетную запись в Windows 10 двумя разными способами:  
   * Добавив учетную запись с помощью запроса **Использовать эту учетную запись везде на устройстве** после входа в приложение (например, Outlook).
   * Добавив учетную запись из раздела **Параметры** > **Учетные записи** > **Доступ к учетной записи места работы или учебного заведения** > **Подключение**.

В сценариях зарегистрированных устройств в Azure AD подключаемый модуль Azure AD WAM является основным центром для PRT, так как с помощью этой учетной записи Azure AD нельзя выполнить вход в Windows.

> [!NOTE]
> Сторонние поставщики удостоверений должны поддерживать протокол WS-Trust, чтобы включить выдачу PRT на устройствах Windows 10. Без WS-Trust PRT не может выдаваться пользователям на гибридных присоединенных к Azure AD или устройствах, присоединенных к Azure AD. В службах ADFS требуются только конечные точки усернамемиксед. ADFS/Services/Trust/2005/windowstransport и ADFS/Services/Trust/13/windowstransport должны быть включены только в качестве конечных точек в интрасети и **не должны предоставляться** в качестве конечных точек с внешними экстрасетями через прокси-сервер приложения.

## <a name="what-is-the-lifetime-of-a-prt"></a>Какое время существования PRT?

После выдачи PRT действителен в течение 14 дней и постоянно обновляется при условии, что пользователь активно использует устройство.  

## <a name="how-is-a-prt-used"></a>Как используется PRT?

PRT используют два ключевых компонента в Windows:

* **Подключаемый модуль Azure AD CloudAP**. Во время входа в Windows подключаемый модуль Azure AD CloudAP запрашивает PRT из Azure AD, используя предоставленные пользователем учетные данные. Кроме того, модуль кэширует PRT, чтобы включить кэшированный вход, если у пользователя нет доступа к Интернету.
* **Подключаемый модуль Azure AD WAM**. Когда пользователи пытаются получить доступ к приложениям, подключаемый модуль Azure AD WAM использует PRT для включения единого входа в Windows 10. Подключаемый модуль Azure AD WAM использует PRT для запроса маркеров обновления и доступа для приложений, которые используют WAM для запросов маркеров. Он также позволяет выполнять единый вход в браузерах, внедряя PRT в запросы браузера. Единый вход в браузер в Windows 10 поддерживается в Microsoft Edge (изначально) и Chrome (с помощью расширений [Учетные записи Windows 10](https://chrome.google.com/webstore/detail/windows-10-accounts/ppnbnpeolgkicgegkbkbjmhlideopiji?hl=en) или [Office Online](https://chrome.google.com/webstore/detail/office/ndjpnladcallmjemlbaebfadecfhkepb?hl=en)).

## <a name="how-is-a-prt-renewed"></a>Как обновляется PRT?

PRT обновляется двумя разными методами:

* **Подключаемый модуль Azure AD CloudAP обновляется каждые 4 часа**. Подключаемый модуль CloudAP обновляет PRT каждые 4 часа при входе в Windows. Если у пользователя нет подключения к Интернету в течение этого времени, подключаемый модуль CloudAP обновит PRT после того, как оно появится.
* **Подключаемый модуль Azure AD WAM обновляется во время запросов маркера приложения**. Подключаемый модуль WAM позволяет выполнять единый вход на устройствах Windows 10, включив автоматические запросы маркеров для приложений. Подключаемый модуль WAM может обновить PRT во время запросов маркеров двумя разными способами:
   * Приложение автоматически запрашивает WAM для маркера доступа, но для этого приложения нет доступного маркера обновления. В этом случае WAM использует PRT, чтобы запросить маркер для приложения и возвратить новый PRT в ответ.
   * Приложение запрашивает WAM для маркера доступа, но PRT является недопустимым, или Azure AD требует дополнительной авторизации (например, многофакторную идентификацию Azure AD). В этом сценарии WAM инициирует интерактивный вход, в котором пользователь должен выполнить повторную проверку подлинности или дополнительную проверку. В случае успешной проверки подлинности будет выдан новый PRT.

В среде ADFS прямая информация об контроллере домена не требуется для продления PRT. Для возобновления PRT на прокси-сервере должны быть включены только конечные точки/ADFS/Services/Trust/2005/usernamemixed и/ADFS/Services/Trust/13/usernamemixed с помощью протокола WS-Trust.

Конечные точки транспорта Windows необходимы для проверки подлинности пароля только при изменении пароля, а не для PRT обновления.

### <a name="key-considerations"></a>Основные рекомендации

* PRT выдается и обновляется только во время проверки подлинности в собственном приложении. PRT не обновляется и не выдается во время сеанса браузера.
* В устройствах, присоединенных к Azure AD, и в устройствах с гибридным присоединением к Azure AD подключаемый модуль CloudAP является основным центром для PRT. Если PRT обновляется во время запроса маркера на основе WAM, PRT отправляется обратно в подключаемый модуль CloudAP, который проверяет допустимость PRT в Azure AD перед его принятием.

## <a name="how-is-the-prt-protected"></a>Как защищен PRT?

PRT защищен с помощью привязки к устройству, в которое пользователь выполнил вход. Azure AD и Windows 10 включают защиту PRT с помощью следующих методов:

* **Во время первого входа**. При первом входе PRT выдает запросы на подпись, используя криптографически формируемый ключ устройства во время его регистрации. Ключ устройства защищен модулем TPM, работающим и допустимым на устройстве, который предотвращает любой вредоносный доступ. PRT не выдается, если не удается проверить соответствующую подпись ключа устройства.
* **Во время запросов и обновления маркера**. При выдаче PRT Azure AD также выдает устройству зашифрованный сеансовый ключ. Он шифруется с помощью открытого ключа транспорта (tkpub), который создается и отправляется в Azure AD в рамках регистрации устройства. Этот сеансовый ключ может быть расшифрован только закрытым ключом транспорта (tkpriv), защищенным модулем TPM. Сеансовый ключ — это ключ подтверждения владения (POP) для любых запросов, отправленных в Azure AD.  Он также защищен модулем TPM, а другие компоненты ОС не могут получить к нему доступ. Запросы маркеров или обновления PRT безопасно подписываются этим сеансовым ключом через модуль TPM, поэтому его нельзя незаконно изменить. Azure AD делает недействительными все запросы устройства, которые не подписаны соответствующим сеансовым ключом.

Обеспечивая защиту этих ключей с помощью TPM, мы улучшаем безопасность PRT от вредоносных субъектов, пытающихся украсть ключи или воспроизводить PRT.  Поэтому использование доверенного платформенного модуля значительно повышает безопасность присоединенных к Azure AD, гибридных присоединенных к Azure AD и устройств, зарегистрированных в Azure AD, для кражи учетных данных. Для повышения производительности и надежности рекомендуется использовать TPM 2.0 для всех сценариев регистрации устройств Azure AD в Windows 10. Начиная с Windows 10, обновление 1903 в Azure AD не использует TPM 1,2 для любого из перечисленных выше ключей из-за проблем с надежностью. 

### <a name="how-are-app-tokens-and-browser-cookies-protected"></a>Как защищены маркеры приложений и файлы cookie браузера?

**Маркеры приложений**. Если приложение запрашивает маркер через WAM, Azure AD выдает маркер обновления и маркер доступа. Однако WAM возвращает только маркер доступа к приложению и защищает маркер обновления в своем кэше путем его шифрования с помощью ключа API защиты данных (DPAPI). WAM безопасно использует маркер обновления, подписывая запросы с помощью сеансового ключа, чтобы выдать дополнительные маркеры доступа. Ключ DPAPI защищен симметричным ключом на основе Azure AD в самой Azure AD. Если устройству требуется расшифровать профиль пользователя ключом с помощью ключа DPAPI, Azure AD предоставляет ключ DPAPI, зашифрованный сеансовым ключом, который подключаемый модуль CloudAP запрашивает для расшифровки TPM. Эта возможность гарантирует согласованность при защите маркеров обновления и позволяет приложениям избежать применения собственных механизмов защиты.  

**Файлы cookie браузера**. В Windows 10 Azure AD поддерживает единый вход в браузеры Internet Explorer и Microsoft Edge (изначально) или в Google Chrome с помощью расширения учетных записей Windows 10. Система безопасности позволяет защитить не только файлы cookie, но и конечные точки, на которые отправляются эти файлы. Файлы cookie браузера защищены так же, как и PRT. Для подписывания и защиты файлов cookie используется сеансовый ключ.

Если пользователь инициирует взаимодействие с браузером, браузер (или расширение) вызывает узел собственного клиента COM. Узел собственного клиента гарантирует, что страница находится в одном из разрешенных доменов. Браузер может отправить другие параметры на узел собственного клиента, в том числе специальное значение, однако узел собственного клиента гарантирует проверку имени узла. Узел собственного клиента запрашивает файл PRT-cookie из подключаемого модуля CloudAP, который создает и подписывает его с помощью сеансового ключа, защищенного модулем TPM. Так как PRT-cookie подписывается ключом сеанса, очень трудно изменить его. Этот файл PRT-cookie включен в заголовок запроса для Azure AD, чтобы проверить устройство, с которого он инициирован. При использовании браузера Chrome только расширение, явно определенное в манифесте узла собственного клиента, может вызывать его, предотвращая выполнение этих запросов произвольными расширениями. После того как Azure AD проверит файл cookie PRT, он выдает браузеру файл cookie сеанса. Этот файл cookie сеанса также содержит тот же сеансовый ключ, который был выдан с помощью PRT. Во время последующих запросов сеансовый ключ проверяется с помощью эффективной привязки файла cookie к устройству и предотвращения воспроизведения из другого расположения.

## <a name="when-does-a-prt-get-an-mfa-claim"></a>Когда PRT получает утверждение MFA?

PRT может получить утверждение многофакторной проверки подлинности (MFA) в конкретных сценариях. Если PRT на основе MFA используется для запроса маркеров для приложений, этим маркерам передается утверждение MFA. Эта возможность упрощает работу пользователей, предотвращая необходимое прохождение MFA в каждом приложении. PRT может получить утверждение MFA следующими способами:

* **Вход с помощью Windows Hello для бизнеса**. Windows Hello для бизнеса заменяет пароли и использует криптографические ключи для обеспечения надежной двухфакторной проверки подлинности. Windows Hello для бизнеса относится к конкретному пользователю на устройстве, а для его подготовки к работе требуется MFA. Когда пользователь входит в систему с помощью Windows Hello для бизнеса, PRT пользователя получает утверждение MFA. Этот сценарий также применяется к пользователям, входящим в систему с помощью смарт-карт, если при проверке подлинности с использованием смарт-карт создается утверждение MFA из ADFS.
   * Так как Windows Hello для бизнеса считается многофакторной проверкой подлинности, утверждение MFA обновляется при обновлении самого PRT, поэтому длительность MFA будет постоянно увеличиваться при входе пользователей с помощью WIndows Hello для бизнеса.
* **MFA во время интерактивного входа в систему WAM**. При запросе маркера через WAM, если пользователю требуется выполнить MFA для доступа к приложению, PRT, который обновляется во время этого взаимодействия, будет зафиксирован с помощью утверждения MFA.
   * В этом случае утверждение MFA не обновляется непрерывно, поэтому продолжительность MFA зависит от установленного времени существования в каталоге.
   * Если для доступа к приложению используются предыдущие существующие PRT и RT, то они будут рассматриваться как первое подтверждение проверки подлинности. Потребуется новый маркер доступа со вторым подтверждением и зафиксированным утверждением MFA. При этом также будут выдаваться новый PRT и RT.
* **MFA во время регистрации устройства**. Если администратор настроил параметры устройства в Azure AD, чтобы [требовать выполнения MFA для регистрации устройств](device-management-azure-portal.md#configure-device-settings) для завершения регистрации, пользователю необходимо выполнить MFA. Во время этого процесса PRT, выданный пользователю, имеет утверждение MFA, полученное во время регистрации. Эта возможность применяется только к пользователю, который выполнил операцию присоединение, а не к пользователям, которые входят на это устройство.
   * Как и при интерактивном входе WAM, утверждение MFA не обновляется непрерывно, поэтому продолжительность MFA зависит от установленного времени существования в каталоге.

Windows 10 поддерживает секционированный список маркеров PRT отдельно для всех учетных данных. Таким образом, существует PRT для каждого Windows Hello для бизнеса, пароля или смарт-карты. Секционирование гарантирует, что утверждения MFA будут изолированы на основе используемых учетных данных и не будут смешиваться во время запросов маркеров.

## <a name="how-is-a-prt-invalidated"></a>Как PRT становится недействительным?

PRT становится недействительным в следующих случаях:

* **Недопустимый пользователь**. Если пользователь удален или отключен в Azure AD, его маркер PRT становится недействительным и не может быть использован для получения маркеров для приложений. Если удаленный или отключенный пользователь уже вошел на устройство раньше, он сможет входить в систему, используя кэшированные данные для входа, пока CloudAP не узнает о недопустимом состоянии. После того как CloudAP определит, что пользователь является недопустимым, он блокирует последующие входы в систему. Недопустимый пользователь автоматически блокируется при входе на новые устройства, для которых учетные данные не кэшируются.
* **Недопустимое устройство**. Если устройство удалено или отключено в Azure AD, то маркер PRT, полученный на этом устройстве, становится недействительным и не может использоваться для получения маркеров для других приложений. Если пользователь уже вошел в систему на недопустимом устройстве, он может и дальше это делать. Но все маркеры на устройстве становятся недействительными, и пользователь не может воспользоваться единым входом для ресурсов с этого устройства.
* **Изменение пароля**. После того как пользователь изменит свой пароль, полученный с предыдущим паролем, PRT становится недействительным в Azure AD. В результате изменения пароля пользователь получает новый PRT. Такое аннулирование может быть выполнено двумя разными способами:
   * Если пользователь выполняет вход в Windows с новым паролем, CloudAP отменяет старый PRT и запрашивает у Azure AD новый PRT с новым паролем. Если у пользователя нет подключения к Интернету, новый пароль не может быть проверен, Windows может потребовать от пользователя ввести старый пароль.
   * Если пользователь вошел в систему со старым паролем или изменил свой пароль после входа в Windows, старый PRT используется для всех запросов маркеров на основе WAM. В этом сценарии пользователю предлагается выполнить повторную проверку подлинности во время запроса маркера WAM, после чего выдается новый PRT.
* **Проблемы в работе модуля TPM**. В некоторых случаях в модуле TPM может происходить сбой, что приведет к недоступности ключей, защищенных модулем TPM. В этом случае устройство не может получить маркер PRT или запросить маркеры с помощью существующего PRT, так как оно не может подтвердить владение криптографическими ключами. В результате все существующие маркеры PRT в Azure AD станут недействительными. Если система Windows 10 обнаружит сбой, она инициирует поток восстановления для повторной регистрации устройства с новыми криптографическими ключами. При использовании гибридного присоединения к Azure AD, как и при первоначальной регистрации, восстановление происходит автоматически без ввода данных пользователем. Для присоединенных к Azure AD или зарегистрированных в нем устройств восстановление должно выполняться пользователем с правами администратора на устройстве. В этом сценарии поток восстановления инициируется запросом Windows, который позволяет пользователю успешно восстановить устройство.

## <a name="detailed-flows"></a>Подробно о потоках

На следующих диаграммах показаны базовые сведения о выдаче, обновлении и использовании PRT для запроса маркера доступа для приложения. Кроме того, эти шаги также описывают, как упомянутые выше механизмы безопасности применяются во время этих взаимодействий.

### <a name="prt-issuance-during-first-sign-in"></a>Выдача PRT при первом входе

![Подробное описание потока выдачи PRT при первом входе](./media/concept-primary-refresh-token/prt-initial-sign-in.png)

> [!NOTE]
> В устройствах, присоединенных к Azure AD, этот обмен выполняется синхронно, чтобы выдать PRT, прежде чем пользователь сможет войти в Windows. В устройствах с гибридным присоединением к Azure AD локальные доменные службы Active Directory являются основным центром. Таким образом, пользователь только ждет, пока он сможет получить билет TGT для входа в систему, в то время как выдача PRT происходит асинхронно. Этот сценарий не применяется к зарегистрированным устройствам в Azure AD, так как при входе не используются учетные данные Azure AD.

| Шаг | Описание |
| :---: | --- |
| Объект | Пользователь вводит свой пароль в пользовательском интерфейсе входа. LogonUI передает учетные данные в буфер проверки подлинности в LSA, который в свою очередь внутренне передает его в CloudAP. CloudAP перенаправляет этот запрос в подключаемый модуль CloudAP. |
| B | Подключаемый модуль CloudAP инициирует запрос обнаружения области определения приложения для идентификации поставщика удостоверений для пользователя. Если у клиента пользователя установлен поставщик федерации, Azure AD возвращает конечную точку обмена метаданными поставщика федерации (MEX). В противном случае Azure AD определяет, что пользователь является управляемым, указывая, что он может пройти проверку подлинности в Azure AD. |
| C | Если пользователь является управляемым, CloudAP получит специальное значение из Azure AD. Если пользователь является федеративным, подключаемый модуль CloudAP запрашивает токен SAML от поставщика федерации с учетными данными пользователя. После получения токена SAML он запрашивает специальное значение из Azure AD. |
| D | Подключаемый модуль CloudAP формирует запрос проверки подлинности с учетными данными пользователя, специальным значением и областью брокера, подписывает запрос с помощью ключа устройства (dkpriv) и отправляет его в Azure AD. В федеративной среде подключаемый модуль CloudAP использует токен SAML, возвращенный поставщиком федерации, а не учетные данные пользователя. |
| E | Azure AD проверяет учетные данные пользователя, специальное значение и подпись устройства, а также является ли устройство допустимым в клиенте, и выдает зашифрованный маркер PRT. Вместе с маркером PRT Azure AD также выдает симметричный ключ, который называется сеансовым ключом, зашифрованным Azure AD с помощью ключа транспорта (tkpub). Кроме того, сеансовый ключ также внедряется в маркер PRT. Сеансовый ключ выступает в качестве ключа подтверждения владения (POP) для последующих запросов с маркером PRT. |
| F | Подключаемый модуль CloudAP передает зашифрованный маркер PRT и сеансовый ключ в CloudAP. CloudAP запрашивает модуль TPM для расшифровки сеансового ключа с помощью ключа транспорта (tkpriv) и его повторного шифрования с помощью собственного ключа TPM. CloudAP сохраняет зашифрованный сеансовый ключ в своем кэше вместе с маркером PRT. |

### <a name="prt-renewal-in-subsequent-logons"></a>Обновление маркера PRT при последующих входах

![Обновление маркера PRT при последующих входах](./media/concept-primary-refresh-token/prt-renewal-subsequent-logons.png)

| Шаг | Описание |
| :---: | --- |
| Объект | Пользователь вводит свой пароль в пользовательском интерфейсе входа. LogonUI передает учетные данные в буфер проверки подлинности в LSA, который в свою очередь внутренне передает его в CloudAP. CloudAP перенаправляет этот запрос в подключаемый модуль CloudAP. |
| B | Если пользователь ранее вошел в систему, Windows инициирует кэшированный вход и проверяет учетные данные для входа пользователя в систему. Каждые 4 часа подключаемый модуль CloudAP инициирует асинхронное обновление маркера PRT. |
| C | Подключаемый модуль CloudAP инициирует запрос обнаружения области определения приложения для идентификации поставщика удостоверений для пользователя. Если у клиента пользователя установлен поставщик федерации, Azure AD возвращает конечную точку обмена метаданными поставщика федерации (MEX). В противном случае Azure AD определяет, что пользователь является управляемым, указывая, что он может пройти проверку подлинности в Azure AD. |
| D | Если пользователь является федеративным, подключаемый модуль CloudAP запрашивает токен SAML от поставщика федерации с учетными данными пользователя. После получения токена SAML он запрашивает специальное значение из Azure AD. Если пользователь является управляемым, CloudAP получит специальное значение непосредственно из Azure AD. |
| E | Подключаемый модуль CloudAP формирует запрос проверки подлинности с учетными данными пользователя, специальным значением и существующим маркером PRT, подписывает запрос с помощью сеансового ключа и отправляет его в Azure AD. В федеративной среде подключаемый модуль CloudAP использует токен SAML, возвращенный поставщиком федерации, а не учетные данные пользователя. |
| F | Azure AD проверяет подпись сеансового ключа, сравнивая ее с сеансовым ключом, внедренным в PRT, анализирует специальное значение и допустимость устройства в клиенте, после чего выдает новый маркер PRT. Как показано выше, маркер PRT снова сопровождается сеансовым ключом, который зашифрован ключом транспорта (tkpub). |
| G. | Подключаемый модуль CloudAP передает зашифрованный маркер PRT и сеансовый ключ в CloudAP. CloudAP запрашивает модуль TPM для расшифровки сеансового ключа с помощью ключа транспорта (tkpriv) и его повторного шифрования с помощью собственного ключа TPM. CloudAP сохраняет зашифрованный сеансовый ключ в своем кэше вместе с маркером PRT. |

> [!NOTE]
> PRT можно обновлять извне, не требуя VPN-подключения, когда конечные точки усернамемиксед включены извне.

### <a name="prt-usage-during-app-token-requests"></a>Использование маркера PRT при запросах маркера приложения

![Использование маркера PRT при запросах маркера приложения](./media/concept-primary-refresh-token/prt-usage-app-token-requests.png)

| Шаг | Описание |
| :---: | --- |
| Объект | Приложение (например, Outlook, OneNote и т. д.) инициирует запрос маркера к WAM. WAM, в свою очередь, запрашивает подключаемый модуль Azure AD WAM для обслуживания запроса маркера. |
| B | Если маркер обновления для приложения уже доступен, подключаемый модуль Azure AD WAM использует его для запроса маркера доступа. Чтобы обеспечить подтверждение привязки устройства, подключаемый модуль WAM подписывает запрос с помощью сеансового ключа. Azure AD проверяет сеансовый ключ и выдает для приложения маркер доступа и новый маркер обновления, зашифрованные сеансовым ключом. Подключаемый модуль WAM запрашивает подключаемый модуль Cloud AP для расшифровки маркеров, который, в свою очередь, запрашивает модуль TPM для расшифровки с помощью сеансового ключа. В результате чего подключаемый модуль WAM получает оба маркера. Затем подключаемый модуль WAM предоставляет приложению только маркер доступа, в то время как он повторно шифрует маркер обновления с помощью DPAPI и сохраняет его в собственном кэше.  |
| C |  Если маркер обновления для приложения не доступен, подключаемый модуль Azure AD WAM использует маркер PRT для запроса маркера доступа. Чтобы подтвердить владения, подключаемый модуль WAM подписывает запрос, содержащий маркер PRT, с помощью сеансового ключа. Azure AD проверяет подпись сеансового ключа, сравнивая ее с сеансовым ключом, внедренным в маркер PRT, анализирует допустимость устройства, после чего выдает маркера доступа и обновления для приложения. Кроме того, Azure AD может выдать новый маркер PRT (в зависимости от цикла обновления). Все они шифруются сеансовым ключом. |
| D | Подключаемый модуль WAM запрашивает подключаемый модуль Cloud AP для расшифровки маркеров, который, в свою очередь, запрашивает модуль TPM для расшифровки с помощью сеансового ключа. В результате чего подключаемый модуль WAM получает оба маркера. Затем подключаемый модуль WAM предоставляет приложению только маркер доступа, в то время как он повторно шифрует маркер обновления с помощью DPAPI и сохраняет его в собственном кэше. Подключаемый модуль WAM будет в дальнейшем использовать для этого приложения маркер обновления. Подключаемый модуль WAM также возвращает новый маркер PRT подключаемому модулю CloudAP, который проверяет PRT с помощью Azure AD перед его обновлением в собственном кэше. Подключаемый модуль CloudAP в дальнейшем будет использовать новый маркер PRT. |
| E | WAM предоставляет вновь выданный маркер доступа для WAM, который, в свою очередь, предоставляет его обратно вызывающему приложению.|

### <a name="browser-sso-using-prt"></a>Единый вход в браузер с помощью маркера PRT

![Единый вход в браузер с помощью маркера PRT](./media/concept-primary-refresh-token/browser-sso-using-prt.png)

| Шаг | Описание |
| :---: | --- |
| Объект | Пользователь входит в Windows с помощью своих учетных данных для получения маркера PRT. Когда пользователь открывает браузер, он (или расширение) загружает URL-адреса из реестра. |
| B | Когда пользователь открывает URL-адрес для входа в Azure AD, браузер или расширение сверяет URL-адрес с полученными из реестра. Если они совпадают, браузер вызывает узел собственного клиента для получения маркера. |
| C | Узел собственного клиента проверяет, принадлежат ли URL-адреса поставщикам удостоверений Майкрософт (учетная запись Майкрософт или Azure AD), извлекает специальное значение, отправленное с URL-адреса, и вызывает подключаемый модуль CloudAP для получения файла cookie PRT. |
| D | Подключаемый модуль CloudAP создаст файл cookie PRT, выполнит вход с помощью сеансового ключа, привязанного к модулю TPM, и отправит его обратно на узел собственного клиента. |
| E | Узел собственного клиента вернет этот файл cookie PRT в браузер, который включит его в заголовок запроса с именем x-ms-RefreshTokenCredential и маркеры запроса из Azure AD. |
| F | Azure AD проверяет подпись сеансового ключа в файле cookie PRT, анализирует специальное значение и допустимость устройства в клиенте, после чего выдает маркер идентификатора для веб-страницы и зашифрованный файл cookie сеанса для браузера. |

> [!NOTE]
> Поток единого входа браузера, описанный в приведенных выше шагах, не применяется для сеансов в частных режимах, таких как InPrivate в Microsoft ребра, или режиме инкогнито в Google Chrome (при использовании расширения учетных записей Майкрософт).

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения об устранении неполадок, связанных с PRT, см. в статье [Устранение неполадок на устройствах под управлением Windows 10 и Windows Server 2016 с гибридным присоединением к Azure Active Directory](troubleshoot-hybrid-join-windows-current.md).
