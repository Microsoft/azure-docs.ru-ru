---
title: Устранение неполадок с помощью команды dsregcmd Azure Active Directory
description: Использование выходных данных из dsregcmd для понимания состояния устройств в Azure AD
services: active-directory
ms.service: active-directory
ms.subservice: devices
ms.topic: troubleshooting
ms.date: 11/21/2019
ms.author: joflore
author: MicrosoftGuyJFlo
manager: daveba
ms.reviewer: spunukol
ms.collection: M365-identity-device-management
ms.openlocfilehash: 614b3f927dc22bc534168f8fe95cc2f97031b621
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "98725529"
---
# <a name="troubleshooting-devices-using-the-dsregcmd-command"></a>Устранение неполадок устройств с помощью команды dsregcmd

Служебную программу dsregcmd/Status следует запускать от имени учетной записи пользователя домена.

## <a name="device-state"></a>Состояние устройства

В этом разделе перечислены параметры состояния присоединение к устройству. В следующей таблице перечислены критерии для устройства, находящиеся в различных состояниях объединения.

| AzureAdJoined | ентерприсежоинед | домаинжоинед | Состояние устройства |
| ---   | ---   | ---   | ---   |
| YES | NO | NO | Присоединение к Azure AD |
| NO | NO | YES | быть присоединено к домену; |
| YES | NO | YES | Гибридное присоединение к AD |
| NO | YES | YES | Локальная DRS присоединена |

> [!NOTE]
> Состояние Workplace Join (Azure AD Registered) отображается в разделе "пользовательское состояние"

- **AzureAdJoined:** — задайте значение "Да", если устройство присоединено к Azure AD. В противном случае — нет.
- **Ентерприсежоинед:** — задайте значение "Да", если устройство присоединено к локальной DRS. Устройство не может одновременно Ентерприсежоинед и AzureAdJoined.
- **Домаинжоинед:** — задайте значение "Да", если устройство присоединено к домену (AD).
- **Имя_домена:** — укажите имя домена, если устройство присоединено к домену.

### <a name="sample-device-state-output"></a>Пример выходных данных состояния устройства

```
+----------------------------------------------------------------------+
| Device State                                                         |
+----------------------------------------------------------------------+
             AzureAdJoined : YES
          EnterpriseJoined : NO
              DomainJoined : YES
                DomainName : HYBRIDADFS
+----------------------------------------------------------------------+
```

## <a name="device-details"></a>Сведения об устройстве

Отображается только в том случае, если устройство присоединено к Azure AD или присоединено к гибридной службе Azure AD (не зарегистрирована в Azure AD). В этом разделе перечислены сведения об устройстве, идентифицирующие данные, хранящиеся в облаке.

- **DeviceID:** уникальный идентификатор устройства в клиенте Azure AD.
- **Отпечаток:** -отпечаток сертификата устройства 
- **Девицецертификатевалидити:** — действительность сертификата устройства.
- **Кэйконтаинерид:** -ContainerId закрытого ключа устройства, связанного с сертификатом устройства
- **Кэйпровидер:** -Кэйпровидер (оборудование или программное обеспечение), используемое для хранения закрытого ключа устройства.
- **Тпмпротектед:** -"Да", если закрытый ключ устройства хранится в аппаратном доверенном платформенном модуле.

### <a name="sample-device-details-output"></a>Вывод сведений об образце устройства

```
+----------------------------------------------------------------------+
| Device Details                                                       |
+----------------------------------------------------------------------+

                  DeviceId : e92325d0-xxxx-xxxx-xxxx-94ae875dxxxx
                Thumbprint : D293213EF327483560EED8410CAE36BB67208179
 DeviceCertificateValidity : [ 2019-01-11 21:02:50.000 UTC -- 2029-01-11 21:32:50.000 UTC ]
            KeyContainerId : 13e68a58-xxxx-xxxx-xxxx-a20a2411xxxx
               KeyProvider : Microsoft Software Key Storage Provider
              TpmProtected : NO
+----------------------------------------------------------------------+
```

## <a name="tenant-details"></a>Сведения о клиенте

Отображается только в том случае, если устройство присоединено к Azure AD или присоединено к гибридной службе Azure AD (не зарегистрирована в Azure AD). В этом разделе перечислены общие сведения о клиенте при присоединении устройства к Azure AD.

> [!NOTE]
> Если URL-адреса MDM в этом разделе пусты, это означает, что MDM либо не настроен, либо текущий пользователь не находится в области регистрации MDM. Проверьте параметры мобильности в Azure AD, чтобы просмотреть конфигурацию MDM.

> [!NOTE]
> Даже если вы видите URL-адреса MDM, это не означает, что устройство управляется MDM. Сведения отображаются, если у клиента есть конфигурация MDM для автоматической регистрации, даже если само устройство не управляется. 

### <a name="sample-tenant-details-output"></a>Пример выходных данных о клиенте

```
+----------------------------------------------------------------------+
| Tenant Details                                                       |
+----------------------------------------------------------------------+

                TenantName : HybridADFS
                  TenantId : 96fa76d0-xxxx-xxxx-xxxx-eb60cc22xxxx
                       Idp : login.windows.net
               AuthCodeUrl : https://login.microsoftonline.com/96fa76d0-xxxx-xxxx-xxxx-eb60cc22xxxx/oauth2/authorize
            AccessTokenUrl : https://login.microsoftonline.com/96fa76d0-xxxx-xxxx-xxxx-eb60cc22xxxx/oauth2/token
                    MdmUrl : https://enrollment.manage-beta.microsoft.com/EnrollmentServer/Discovery.svc
                 MdmTouUrl : https://portal.manage-beta.microsoft.com/TermsOfUse.aspx
          MdmComplianceUrl : https://portal.manage-beta.microsoft.com/?portalAction=Compliance
               SettingsUrl : eyJVxxxxIjpbImh0dHBzOi8va2FpbGFuaS5vbmUubWljcm9zb2Z0LmNvbS8iLCJodHRwczovL2thaWxhbmkxLm9uZS5taWNyb3NvZnQuY29tLyxxxx==
            JoinSrvVersion : 1.0
                JoinSrvUrl : https://enterpriseregistration.windows.net/EnrollmentServer/device/
                 JoinSrvId : urn:ms-drs:enterpriseregistration.windows.net
             KeySrvVersion : 1.0
                 KeySrvUrl : https://enterpriseregistration.windows.net/EnrollmentServer/key/
                  KeySrvId : urn:ms-drs:enterpriseregistration.windows.net
        WebAuthNSrvVersion : 1.0
            WebAuthNSrvUrl : https://enterpriseregistration.windows.net/webauthn/96fa76d0-xxxx-xxxx-xxxx-eb60cc22xxxx/
             WebAuthNSrvId : urn:ms-drs:enterpriseregistration.windows.net
    DeviceManagementSrvVer : 1.0
    DeviceManagementSrvUrl : https://enterpriseregistration.windows.net/manage/96fa76d0-xxxx-xxxx-xxxx-eb60cc22xxxx/
     DeviceManagementSrvId : urn:ms-drs:enterpriseregistration.windows.net
+----------------------------------------------------------------------+
```

## <a name="user-state"></a>состояние пользователя;

В этом разделе перечислены сведения о состоянии различных атрибутов для пользователя, который в данный момент вошел в систему на устройстве.

> [!NOTE]
> Чтобы получить допустимое состояние, команда должна быть запущена в контексте пользователя.

- **Нгксет:** — задайте значение "Да", если для текущего пользователя, выполнившего вход, задан ключ Windows Hello.
- **Нгккэйид:** — идентификатор ключа Windows Hello, если он задан для текущего вошедшего в систему пользователя.
- **Канресет:** — указывает, можно ли сбросить ключ Windows Hello пользователем. 
- **Возможные значения:** -Деструктивеонли, Нондеструктивеонли, Деструктивеанднондеструктиве или Unknown при ошибке. 
- **Воркплацежоинед:** — задайте значение "Да", если зарегистрированные учетные записи Azure AD были добавлены на устройство в текущем контексте NTuser.
- **Вамдефаултсет:** — задайте значение "Да", если для вошедшего в систему пользователя создана учетная запись WAM по умолчанию. В этом поле может отображаться сообщение об ошибке, если дсрег/Status запускается из командной строки с повышенными привилегиями. 
- **Вамдефаултаусорити:** — значение "Организации" для Azure AD.
- **Вамдефаултид:** -Always " https://login.microsoft.com " для Azure AD.
- **WamDefaultGUID:** — GUID поставщика WAM (Azure AD/учетная запись Майкрософт) для учетной записи WAM по умолчанию. 

### <a name="sample-user-state-output"></a>Пример выходных данных пользовательского состояния

```
+----------------------------------------------------------------------+
| User State                                                           |
+----------------------------------------------------------------------+

                    NgcSet : YES
                  NgcKeyId : {FA0DB076-A5D7-4844-82D8-50A2FB42EC7B}
                  CanReset : DestructiveAndNonDestructive
           WorkplaceJoined : NO
             WamDefaultSet : YES
       WamDefaultAuthority : organizations
              WamDefaultId : https://login.microsoft.com
            WamDefaultGUID : { B16898C6-A148-4967-9171-64D755DA8520 } (AzureAd)

+----------------------------------------------------------------------+
```

## <a name="sso-state"></a>Состояние единого входа

Этот раздел можно игнорировать для зарегистрированных устройств Azure AD.

> [!NOTE]
> Команда должна выполняться в контексте пользователя, чтобы получить допустимое состояние для этого пользователя.

- **Азуреадпрт:** — задайте значение "Да", если на устройстве есть PRT для вошедшего в систему пользователя.
- **Азуреадпртупдатетиме:** — задайте время в формате UTC при последнем обновлении PRT.
- **Азуреадпртекспиритиме:** — задайте время в формате UTC, если срок действия PRT истекает, если он не продлен.
- **Азуреадпртаусорити:** — URL-адрес центра Azure AD
- **Ентерприсепрт:** — задайте значение "Да", если устройство имеет PRT из локальных служб ADFS. Для гибридных устройств, присоединенных к Azure AD, устройство могло бы PRT одновременно как из Azure AD, так и из локальной службы AD. Локальные подключенные устройства будут иметь только корпоративный PRT.
- **Ентерприсепртупдатетиме:** — задайте время в формате UTC при последнем обновлении корпоративного PRT.
- **Ентерприсепртекспиритиме:** — задайте время в формате UTC, если срок действия PRT истекает, если он не продлен.
- **Ентерприсепртаусорити:** URL-адрес центра ADFS

### <a name="sample-sso-state-output"></a>Пример выходных данных состояния единого входа

```
+----------------------------------------------------------------------+
| SSO State                                                            |
+----------------------------------------------------------------------+

                AzureAdPrt : YES
      AzureAdPrtUpdateTime : 2019-01-24 19:15:26.000 UTC
      AzureAdPrtExpiryTime : 2019-02-07 19:15:26.000 UTC
       AzureAdPrtAuthority : https://login.microsoftonline.com/96fa76d0-xxxx-xxxx-xxxx-eb60cc22xxxx
             EnterprisePrt : YES
   EnterprisePrtUpdateTime : 2019-01-24 19:15:33.000 UTC
   EnterprisePrtExpiryTime : 2019-02-07 19:15:33.000 UTC
    EnterprisePrtAuthority : https://fs.hybridadfs.nttest.microsoft.com:443/adfs

+----------------------------------------------------------------------+
```

## <a name="diagnostic-data"></a>Диагностические данные

### <a name="pre-join-diagnostics"></a>Диагностика перед соединением

Этот раздел отображается только в том случае, если устройство присоединено к домену и не может выполнить гибридное присоединение к Azure AD.

В этом разделе выполняются различные тесты, помогающие диагностировать сбои при соединении. В этом разделе также содержатся сведения о предыдущем (?). Эти сведения включают в себя фазу ошибки, код ошибки, идентификатор запроса сервера, состояние ответа сервера HTTP, сообщение об ошибке ответа сервера.

- **Контекст пользователя:** — контекст, в котором выполняется диагностика. Возможные значения: системный, без повышения прав пользователя, пользователь с повышенными правами. 

   > [!NOTE]
   > Поскольку фактическое соединение выполняется в СИСТЕМном контексте, выполнение диагностики в контексте системы наиболее близко к сценарию фактического объединения. Чтобы запустить диагностику в контексте системы, команда dsregcmd/Status должна быть запущена из командной строки с повышенными привилегиями.

- **Время клиента:** — системное время в формате UTC.
- **Проверка подключения Active Directory:** -Test выполняет проверку подключения к контроллеру домена. Ошибка в этом тесте, скорее всего, приведет к ошибкам соединения на этапе предварительной проверки.
- **Проверка конфигурации Active Directory:** -Test считывает и проверяет, правильно ли НАСТРОЕН объект SCP в локальном лесу AD. Ошибки в этом тесте, скорее всего, приведут к ошибкам соединения на этапе обнаружения с кодом ошибки 0x801c001d.
- **Тест обнаружения DRS:** -Test получает конечные точки DRS из конечной точки метаданных обнаружения и выполняет запрос области пользователя. Ошибки в этом тесте, скорее всего, приведут к ошибкам соединения на этапе обнаружения.
- **Тест подключения DRS:** -Test выполняет базовый тест подключения к КОНЕЧНОЙ точке DRS.
- **Проверка получения маркера:** -Test пытается получить маркер проверки подлинности Azure AD, если клиент пользователя является федеративным. Ошибки в этом тесте, скорее всего, приведут к ошибкам соединения на этапе проверки подлинности. Если проверка подлинности не удалась, будет предпринята попытка выполнить откат, если откат не будет явно отключен с помощью следующих параметров раздела реестра.
```
    Keyname: Computer\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\CDJ
    Value: FallbackToSyncJoin
    Type:  REG_DWORD
    Value: 0x0 -> Disabled
    Value: 0x1 -> Enabled
    Default (No Key): Enabled
 ```
- **Откат к синхронизации — соединение:** задайте для параметра значение "включено", если указанный выше раздел реестра предотвращает синхронизацию резервной стратегии с ошибками проверки подлинности. Этот параметр доступен в Windows 10 1803 и более поздних версиях.
- **Предыдущая регистрация:** время, когда была выполнена предыдущая попыток объединения. Регистрируются только неудачные попытки объединения.
- **Фаза ошибки:** — этап соединения, в котором он был прерван. Возможные значения: Предварительная проверка, обнаружение, проверка подлинности, соединение.
- **ErrorCode клиента:** возвращен код ошибки клиента (HRESULT).
- **ErrorCode сервера:** — код ошибки сервера, если запрос был отправлен на сервер, а сервер вернул ответ с кодом ошибки. 
- **Сообщение сервера:** — сообщение сервера возвращено вместе с кодом ошибки.
- **Состояние HTTPS:** — состояние HTTP, возвращенное сервером.
- **Идентификатор запроса:** — запрос клиента, отправленный на сервер. Полезно для сопоставления с журналами на стороне сервера.

### <a name="sample-pre-join-diagnostics-output"></a>Пример выходных данных диагностики перед соединением

В следующем примере показан сбой теста диагностики с ошибкой обнаружения.

```
+----------------------------------------------------------------------+
| Diagnostic Data                                                      |
+----------------------------------------------------------------------+

     Diagnostics Reference : www.microsoft.com/aadjerrors
              User Context : SYSTEM
               Client Time : 2019-01-31 09:25:31.000 UTC
      AD Connectivity Test : PASS
     AD Configuration Test : PASS
        DRS Discovery Test : FAIL [0x801c0021/0x801c000c]
     DRS Connectivity Test : SKIPPED
    Token acquisition Test : SKIPPED
     Fallback to Sync-Join : ENABLED

     Previous Registration : 2019-01-31 09:23:30.000 UTC
               Error Phase : discover
          Client ErrorCode : 0x801c0021

+----------------------------------------------------------------------+
```

В следующем примере показана передача диагностических тестов, но попытка регистрации завершилась ошибкой каталога, которая ожидается при соединении с синхронизацией. После завершения задания синхронизации Azure AD Connect устройство сможет присоединиться.

```
+----------------------------------------------------------------------+
| Diagnostic Data                                                      |
+----------------------------------------------------------------------+

     Diagnostics Reference : www.microsoft.com/aadjerrors
              User Context : SYSTEM
               Client Time : 2019-01-31 09:16:50.000 UTC
      AD Connectivity Test : PASS
     AD Configuration Test : PASS
        DRS Discovery Test : PASS
     DRS Connectivity Test : PASS
    Token acquisition Test : PASS
     Fallback to Sync-Join : ENABLED

     Previous Registration : 2019-01-31 09:16:43.000 UTC
         Registration Type : sync
               Error Phase : join
          Client ErrorCode : 0x801c03f2
          Server ErrorCode : DirectoryError
            Server Message : The device object by the given id (e92325d0-7ac4-4714-88a1-94ae875d5245) is not found.
              Https Status : 400
                Request Id : 6bff0bd9-820b-484b-ab20-2a4f7b76c58e

+----------------------------------------------------------------------+
```

### <a name="post-join-diagnostics"></a>Диагностика после объединения

В этом разделе отображаются выходные данные проверок работоспособности, выполненных на устройстве, присоединенном к облаку.

- **Аадрековеренаблед.** Если выбрано значение "Да", ключи, хранящиеся на устройстве, не будут использоваться и устройство будет отмечено для восстановления. Следующий вход запустит поток восстановления и повторно зарегистрирует устройство.
- **Кэйсигнтест:** — если "передано", ключи устройства имеют хорошую работоспособность. В случае сбоя Кэйсигнтест устройство обычно будет отмечено для восстановления. Следующий вход запустит поток восстановления и повторно зарегистрирует устройство. Для гибридных устройств, присоединенных к Azure AD, восстановление происходит в автоматическом режиме. При присоединении Azure AD или регистрации Azure AD устройства будут запрашивать проверку подлинности пользователя для восстановления и повторной регистрации устройства при необходимости. **Для Кэйсигнтест требуются повышенные привилегии.**

#### <a name="sample-post-join-diagnostics-output"></a>Пример выходных данных диагностики после подключения

```
+----------------------------------------------------------------------+
| Diagnostic Data                                                      |
+----------------------------------------------------------------------+

         AadRecoveryEnabled: NO
               KeySignTest : PASSED
+----------------------------------------------------------------------+
```

## <a name="ngc-prerequisite-check"></a>Проверка готовности NGC

В этом разделе выполняются проверки готовности для подготовки Windows Hello для бизнеса (WHFB). 

> [!NOTE]
> Если пользователь уже успешно настроил WHFB, данные проверки готовности к установке NGC в dsregcmd/Status могут не отображаться.

- **Исдевицежоинед:** — задайте значение "Да", если устройство присоединено к Azure AD.
- **Исусеразуреад:** — задайте значение "Да", если вошедший в систему пользователь имеется в Azure AD.
- **Полициенаблед:** — задайте значение "Да", если на устройстве включена политика WHFB.
- **Постлогоненаблед:** — задайте значение "Да", если регистрация WHFB запускается платформой изначально. Если задано значение "нет", это означает, что регистрация Windows Hello для бизнеса активируется настраиваемым механизмом
- **Девицеелигибле:** — задайте значение "Да", если устройство соответствует требованиям к оборудованию для регистрации в WHFB.
- **Сессиониснотремоте:** — задайте значение "Да", если текущий пользователь вошел непосредственно в устройство, а не удаленно.
- **Цертенроллмент:** — только для WHFB доверия к сертификату, указывающий центр регистрации сертификатов для WHFB. Задайте значение "центр регистрации", если источником политики WHFB является групповая политика "Управление мобильными устройствами", если источником является MDM. None в противном случае
- **Адфсрефрештокен:** — только для WHFB развертывания доверия сертификатов. Имеется только в том случае, если Цертенроллмент — "центр регистрации". Указывает, имеет ли устройство корпоративный PRT для пользователя.
- **Адфсраисреади:** — только для WHFB развертывания доверия сертификатов.  Имеется только в том случае, если Цертенроллмент — "центр регистрации". Задайте значение "Да", если службы ADFS, указанные в метаданных обнаружения, поддерживают WHFB *и* доступен шаблон сертификата для входа.
- **Логонцерттемплатереади:** — только для WHFB развертывания доверия сертификатов. Имеется только в том случае, если Цертенроллмент — "центр регистрации". Задайте значение "Да", если шаблон сертификата входа является допустимым и помогает устранить неполадки RA.
- **Пререкресулт:** — приводится результат всех предварительных испытаний WHFB. Задайте значение "подготавливается", если регистрация WHFB будет запускаться как задача после входа при следующем входе пользователя в систему.

### <a name="sample-ngc-prerequisite-check-output"></a>Пример выходных данных проверки готовности к установке NGC

```
+----------------------------------------------------------------------+
| Ngc Prerequisite Check                                               |
+----------------------------------------------------------------------+

            IsDeviceJoined : YES
             IsUserAzureAD : YES
             PolicyEnabled : YES
          PostLogonEnabled : YES
            DeviceEligible : YES
        SessionIsNotRemote : YES
            CertEnrollment : enrollment authority
          AdfsRefreshToken : YES
             AdfsRaIsReady : YES
    LogonCertTemplateReady : YES ( StateReady )
              PreReqResult : WillProvision
+----------------------------------------------------------------------+
```

## <a name="next-steps"></a>Дальнейшие действия

Ответы на вопросы можно найти в статье [Azure Active Directory device management FAQ](faq.md) (Часто задаваемые вопросы по управлению устройствами Azure Active Directory).
