---
title: Управление устаревшими устройствами в Azure AD | Документация Майкрософт
description: Узнайте, как удалить устаревшие устройства из базы данных зарегистрированных устройств в Azure Active Directory.
services: active-directory
ms.service: active-directory
ms.subservice: devices
ms.topic: how-to
ms.date: 06/28/2019
ms.author: joflore
author: MicrosoftGuyJFlo
manager: daveba
ms.reviewer: spunukol
ms.collection: M365-identity-device-management
ms.openlocfilehash: d12679e64d690614aaf788837a02af007448f83d
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "93393682"
---
# <a name="how-to-manage-stale-devices-in-azure-ad"></a>Руководство. управление устаревшими устройствами в Azure AD

Чтобы правильно завершить жизненный цикл ставшего ненужным зарегистрированного устройства, нужно отменить его регистрацию. Но в некоторых случаях такие устройства остаются в среде как устаревшие, например если они украдены, потеряны, сломаны или на них переустановлена ОС. ИТ-администратору будет полезно научиться удалять такие устаревшие устройства, чтобы не тратить время не на них, а на другие актуальные ресурсы.

В этой статье описано, как управлять устаревшими устройствами в вашей среде.
  

## <a name="what-is-a-stale-device"></a>Что такое устаревшее устройство?

Устаревшим называется устройство, которое было зарегистрировано в Azure AD, но в течение некоторого времени уже не используется для доступа к приложениям. Устаревшие устройства негативно влияют на возможности поддержки устройств и пользователей и управлению ими в клиенте, так как: 

- избыточное число устройств мешает сотрудникам службы поддержки быстро определить, какое устройство используется;
- Увеличение числа устройств создает ненужные записи устройств, увеличивая время синхронизации Azure AD Connect.
- поддержание актуальных сведений о состоянии устройств нужно для поддержания "гигиены" и соблюдения требований в среде. 

Устаревшие устройства в AAD мешают правильно применять политики жизненного цикла для устройств в организации.

## <a name="detect-stale-devices"></a>Выявление устаревших устройств

По определению устаревшими являются устройства, которые все еще зарегистрированы, но в течение периода времени не используются для доступа к облачным приложениям. Это означает, что для их выявления нужно свойство, сохраняющее метки времени. В AAD для этой цели используется свойство **ApproximateLastLogonTimestamp**, называемое **меткой активности**. Устройство считается устаревшим, если разница между текущей датой и значением **метки активности** превышает определенный для активных устройств интервал времени. Свойство **метки активности** предоставляется в режиме общедоступной предварительной версии.

## <a name="how-is-the-value-of-the-activity-timestamp-managed"></a>Как используется значение отметки активности?  

Оценка метки активности инициируется при запросе аутентификации с устройства. Azure AD оценивает метку активности в следующих случаях:

- Активированы политики условного доступа, которым требуются [управляемые устройства](../conditional-access/require-managed-devices.md) или [утвержденные клиентские приложения](../conditional-access/app-based-conditional-access.md) .
- когда в сети активируются устройства Windows 10, использующие обычное или гибридное присоединение к AAD; 
- когда управляемые устройства Intune подключаются к этой службе.

Если разница между существующим значением метки времени действия и текущим значением превышает 14 дней (+/-5 дней), существующее значение заменяется новым значением.

## <a name="how-do-i-get-the-activity-timestamp"></a>Как получить метку активности?

У вас есть два способа получить значение метки активности.

- Столбец **Действия** на [странице устройств](https://portal.azure.com/#blade/Microsoft_AAD_IAM/DevicesMenuBlade/Devices) на портале Azure:

    :::image type="content" source="./media/manage-stale-devices/01.png" alt-text="Снимок экрана страницы в портал Azure со списком имен, владельцев и других сведений на устройствах. В одном столбце отображается метка времени действия." border="false":::

- Командлет [Get-азуреаддевице](/powershell/module/azuread/Get-AzureADDevice)

    :::image type="content" source="./media/manage-stale-devices/02.png" alt-text="Снимок экрана, показывающий выходные данные командной строки. Одна строка выделена и содержит отметку времени для значения Аппроксимателастлогонтиместамп." border="false":::

## <a name="plan-the-cleanup-of-your-stale-devices"></a>Планирование очистки устаревших устройств

Для эффективной очистки устаревших устройств в вашей среде следует определить соответствующую политику. Эта политика поможет вам учесть все аспекты, связанные с устаревшими устройствами. В следующих разделах приводятся разные аспекты, учитываемые при создании таких политик. 

### <a name="cleanup-account"></a>Учетная запись для очистки

Чтобы обновить сведения об устройствах в AAD, нужно использовать учетную запись с одной из следующих ролей:

- глобальный администратор
- Администратор облачного устройства
- администратор службы Intune;

Выберите для политики очистки учетные записи, которым назначены необходимые роли. 

### <a name="timeframe"></a>Временной интервал

Определите интервал времени, по которому определяются устаревшие устройства. При определении временных интервалов следует учесть, что для обновления метки времени действия в значении указано окно. Например, не следует рассматривать метку времени, которая меньше 21 дня (включает дисперсию) в качестве индикатора устаревшего устройства. В некоторых ситуациях устройство может казаться устаревшим, хотя фактически им не является. Например, если владелец устройства уехал в отпуск или заболел  на период, превышающий выбранный вами интервал.

### <a name="disable-devices"></a>Отключение устройств

Мы не рекомендуем немедленно удалять устаревшее устройство, ведь в случае ложных положительных срабатываний отменить эту операцию не удастся. Лучше всего перед удалением отключать такое устройство на указанный период. Определите в политике интервал времени, в течение которого устройство будет отключено перед удалением.

### <a name="mdm-controlled-devices"></a>Устройства, управляемые MDM

Если устройство находится под управлением Intune или другого решения MDM, снимите устройство с учета в системе управления перед его отключением или удалением.

### <a name="system-managed-devices"></a>Устройства, управляемые системой

Не удаляйте устройства, управляемые системой. Обычно это устройства, такие как автопилот. После удаления эти устройства нельзя будет повторно подготавливать. Новый командлет `Get-AzureADDevice` по умолчанию пропускает устройства, управляемые системой. 

### <a name="hybrid-azure-ad-joined-devices"></a>Гибридные устройства, присоединенные к Azure AD

Гибридные устройства, присоединенные к Azure AD, должны соблюдать настроенные политики для управления локальными устаревшими устройствами. 

Для очистки AAD сделайте следующее:

- **Устройства Windows 10** — отключите или удалите устройства Windows 10 в локальном каталоге AD и дождитесь синхронизации изменений в Azure Active Directory.
- **Windows 7/8** . сначала отключите или удалите устройства Windows 7/8 в локальной службе AD. Azure AD Connect нельзя использовать для отключения или удаления устройств Windows 7 или 8 в Azure AD. Вместо этого при внесении изменений в локальную среду необходимо отключить или удалить в Azure AD.

> [!NOTE]
>* Удаление устройств в локальной службе AD или Azure AD не приводит к удалению регистрации на клиенте. Он будет препятствовать доступу к ресурсам с помощью устройства в качестве удостоверения (например, условный доступ). Ознакомьтесь с дополнительными сведениями о том, как [Удалить регистрацию на клиенте](faq.md#hybrid-azure-ad-join-faq).
>* При удалении устройства Windows 10 только в Azure AD будет выполнена повторная синхронизация устройства из локальной среды с помощью Azure AD Connect, но в качестве нового объекта в состоянии "ожидание". На устройстве требуется повторная регистрация.
>* При удалении устройства из области синхронизации для устройств Windows 10 или Server 2016 устройство Azure AD будет удалено. При добавлении обратно в область синхронизации новый объект будет находиться в состоянии "ожидание". Требуется повторная регистрация устройства.
>* Если вы не используете Azure AD Connect для синхронизации устройств с Windows 10 (например, только AD FS для регистрации), необходимо управлять жизненным циклом, аналогичным устройствам Windows 7/8.


### <a name="azure-ad-joined-devices"></a>Устройства, присоединенные к Azure AD

Отключите или удалите в Azure AD устройства, присоединенные к Azure AD.

> [!NOTE]
>* При удалении устройства Azure AD регистрация на клиенте не удаляется. Он будет препятствовать доступу к ресурсам с помощью устройства в качестве удостоверения (например, условный доступ). 
>* Дополнительные сведения о [том, как отсоединиться от Azure AD](faq.md#azure-ad-join-faq) 

### <a name="azure-ad-registered-devices"></a>Устройства, зарегистрированные в Azure AD

Отключите или удалите в Azure AD устройства, зарегистрированные в Azure AD.

> [!NOTE]
>* Удаление зарегистрированного устройства Azure AD в Azure AD не приводит к удалению регистрации на клиенте. Он будет препятствовать доступу к ресурсам с помощью устройства в качестве удостоверения (например, условный доступ).
>* Дополнительные сведения [о том, как удалить регистрацию на клиенте](faq.md#azure-ad-register-faq)

## <a name="clean-up-stale-devices-in-the-azure-portal"></a>Очистка устаревших устройств на портале Azure  

Хотя вы можете очистить устаревшие устройства на портале Azure, этот процесс удобнее выполнять с помощью скрипта PowerShell. Используйте последний модуль PowerShell версии 1 для использования фильтра меток времени и фильтрации устройств, управляемых системой, таких как автопилот. Сейчас мы не рекомендуем применять PowerShell версии 2.

Типичная процедура состоит из следующих шагов:

1. Подключение к Azure Active Directory с помощью командлета [Connect-AzureAD](/powershell/module/azuread/connect-azuread)
1. Получение списка устройств
1. Отключите устройство с помощью командлета [Set-азуреаддевице](/powershell/module/azuread/Set-AzureADDevice) (отключите с помощью параметра-AccountEnabled). 
1. Ожидание периода времени перед удалением, в зависимости от количества указанных вами дней.
1. Удалите устройство с помощью командлета [Remove-азуреаддевице](/powershell/module/azuread/Remove-AzureADDevice) .

### <a name="get-the-list-of-devices"></a>Получение списка устройств

Чтобы получить список всех устройств и сохранить эти данные в CSV-файл, выполните:

```PowerShell
Get-AzureADDevice -All:$true | select-object -Property Enabled, DeviceId, DisplayName, DeviceTrustType, ApproximateLastLogonTimestamp | export-csv devicelist-summary.csv
```

Если в вашем каталоге имеется большое количество устройств, используйте фильтр меток времени, чтобы уменьшить количество возвращенных устройств. Чтобы получить и сохранить в CSV-файл список всех устройств, у которых метка времени старше указанной даты, выполните: 

```PowerShell
$dt = [datetime]’2017/01/01’
Get-AzureADDevice -All:$true | Where {$_.ApproximateLastLogonTimeStamp -le $dt} | select-object -Property Enabled, DeviceId, DisplayName, DeviceTrustType, ApproximateLastLogonTimestamp | export-csv devicelist-olderthan-Jan-1-2017-summary.csv
```

## <a name="what-you-should-know"></a>Необходимая информация

### <a name="why-is-the-timestamp-not-updated-more-frequently"></a>Почему метка времени не обновляется чаще?

Эта метка времени обновляется только для управления жизненным циклом устройств. Она не предназначена для аудита. Чтобы получать более частые сведения об устройствах, применяйте журналы аудита входов.

### <a name="why-should-i-worry-about-my-bitlocker-keys"></a>Почему мне нужно беспокоиться о ключах BitLocker?

Если у вас настроены ключи BitLocker для устройств Windows 10, они хранятся в объекте устройства в AAD. Удаляя устаревшее устройство, вы удалите и сохраненные для него ключи BitLocker. Прежде чем удалять устаревшие устройства, нужно убедиться, соответствует ли выбранная политика очистки фактическим жизненным циклам устройств. 

### <a name="why-should-i-worry-about-windows-autopilot-devices"></a>Почему следует беспокоиться о устройствах Windows для автопилота?

При удалении устройства Azure AD, связанного с объектом Windows автопилота, могут возникнуть следующие три ситуации, если устройство будет переназначено в будущем:
- При развертывании на основе пользователя Windows автопилота без использования предварительной подготовки будет создано новое устройство Azure AD, но оно не будет помечено как ЗТДИД.
- При развертывании в режиме саморазвертывания Windows автопилота произойдет сбой, так как не удается найти связанное устройство Azure AD.  (Это механизм безопасности для того, чтобы устройства "фальшивый" не попытаются присоединиться к Azure AD без учетных данных.) Ошибка сообщит о несоответствии ЗТДИД.
- При развертывании предварительной подготовки Windows для автопилота произойдет сбой, так как не удается найти связанное устройство Azure AD. (В фоновом режиме развертывания предварительной подготовки используют один и тот же процесс саморазвертывания, поэтому они применяют те же механизмы безопасности.)

### <a name="how-do-i-know-all-the-type-of-devices-joined"></a>Как мне изучить все типы присоединенных устройств?

Дополнительные сведения о разных типах вы найдете в руководстве по [управлению устройствами](overview.md).

### <a name="what-happens-when-i-disable-a-device"></a>Что произойдет, если я отключу устройство?

Будет запрещена любая аутентификация, которая включает проверку этого устройства в AAD. Ниже приведены распространенные примеры.

- **Гибридное устройство, присоединенное к Azure AD** . пользователи могут иметь возможность использовать устройство для входа в свой локальный домен. Однако они не могут получить доступ к ресурсам Azure AD, таким как Microsoft 365.
- **Устройства, присоединенные к AAD** — пользователь не может использовать устройство для входа. 
- **Мобильные устройства** — пользователь не может получить доступ к ресурсам Azure AD, таким как Microsoft 365. 

## <a name="next-steps"></a>Дальнейшие действия

Чтобы получить общие сведения о том, как управлять устройствами на портале Azure, см. раздел [Управление устройствами с помощью портала Azure (предварительная версия)](device-management-azure-portal.md)
