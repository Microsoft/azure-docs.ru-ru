---
title: Устранение неполадок защиты паролей в локальной среде Azure AD
description: Узнайте, как устранять неполадки защиты паролей Azure AD для локальной среды служб домен Active Directory
services: active-directory
ms.service: active-directory
ms.subservice: authentication
ms.topic: troubleshooting
ms.date: 11/21/2019
ms.author: justinha
author: justinha
manager: daveba
ms.reviewer: jsimmons
ms.collection: M365-identity-device-management
ms.openlocfilehash: f2bbc1c555824d4c632c5bf85a9cd0aa83087fc8
ms.sourcegitcommit: b4647f06c0953435af3cb24baaf6d15a5a761a9c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/02/2021
ms.locfileid: "101648731"
---
# <a name="troubleshoot-on-premises-azure-ad-password-protection"></a>Устранение неполадок: Локальная защита паролей Azure AD

После развертывания функции защиты паролей Azure AD может потребоваться устранить неполадки. В этой статье подробно рассматриваются некоторые общие шаги по устранению неполадок.

## <a name="the-dc-agent-cannot-locate-a-proxy-in-the-directory"></a>Агенту контроллера домена не удается располагать прокси-сервер в каталоге

Основным симптомом этой проблемы является 30017 событий в журнале событий администратора агента контроллера домена.

Обычно причиной этой проблемы является то, что прокси-сервер еще не зарегистрирован. Если прокси-сервер зарегистрирован, в связи с задержкой репликации AD может возникнуть задержка, пока конкретный агент контроллера домена не сможет увидеть этот прокси-сервер.

## <a name="the-dc-agent-is-not-able-to-communicate-with-a-proxy"></a>Агенту контроллера домена не удается связаться с прокси-сервером

Основным симптомом этой проблемы является 30018 событий в журнале событий администратора агента контроллера домена. Эта проблема может иметь несколько возможных причин.

1. Агент контроллера домена находится в изолированной части сети, которая не разрешает сетевое подключение к зарегистрированным прокси-серверам. Эта проблема может быть недостаточной, если другие агенты контроллера домена могут обмениваться данными с прокси-сервером для загрузки политик паролей из Azure. После загрузки эти политики будут получены изолированным контроллером домена через репликацию файлов политики в общем ресурсе Sysvol.

1. Компьютер-посредник блокирует доступ к конечной точке сопоставителя конечных точек RPC (порт 135).

   Установщик прокси-сервера защиты паролей Azure AD автоматически создает правило входящего трафика брандмауэра Windows, которое разрешает доступ к порту 135. Если это правило будет удалено или отключено, агенты контроллера домена не смогут взаимодействовать со службой прокси. Если встроенный брандмауэр Windows был отключен вместо другого продукта брандмауэра, необходимо настроить этот брандмауэр, чтобы разрешить доступ к порту 135.

1. Компьютер-посредник блокирует доступ к конечной точке RPC (динамической или статической), прослушиваемой службой прокси

   Установщик прокси-сервера защиты паролей Azure AD автоматически создает правило входящего трафика брандмауэра Windows, которое разрешает доступ ко всем входящим портам, прослушиваемым прокси-службой защиты паролей Azure AD. Если это правило будет удалено или отключено, агенты контроллера домена не смогут взаимодействовать со службой прокси. Если встроенный брандмауэр Windows был отключен вместо другого продукта брандмауэра, необходимо настроить этот брандмауэр, чтобы разрешить доступ ко всем входящим портам, прослушиваемым прокси-службой защиты паролей Azure AD. Эта конфигурация может быть сделана более конкретной, если прокси-служба настроена на прослушивание определенного статического порта RPC (с помощью `Set-AzureADPasswordProtectionProxyConfiguration` командлета).

1. На компьютере-прокси не настроено разрешение контроллерам домена возможности входа на компьютер. Это поведение управляется с помощью назначения привилегий пользователя "доступ к компьютеру из сети". Эта привилегия должна быть предоставлена всем контроллерам домена во всех доменах леса. Этот параметр часто ограничивается в рамках большой работы по укреплению сети.

## <a name="proxy-service-is-unable-to-communicate-with-azure"></a>Службе прокси не удается связаться с Azure

1. Убедитесь, что на прокси-компьютере есть подключение к конечным точкам, указанным в [требованиях к развертыванию](howto-password-ban-bad-on-premises-deploy.md).

1. Убедитесь, что лес и все прокси-серверы зарегистрированы в одном клиенте Azure.

   Это требование можно проверить, запустив  `Get-AzureADPasswordProtectionProxy` `Get-AzureADPasswordProtectionDCAgent` командлеты и PowerShell, а затем сравните `AzureTenant` свойство каждого возвращенного элемента. Для правильной работы сообщаемое имя клиента должно быть одинаковым для всех агентов контроллера домена и прокси-серверов.

   Если условие несоответствия регистрации клиента Azure существует, эту проблему можно устранить, запустив `Register-AzureADPasswordProtectionProxy` командлеты и (или `Register-AzureADPasswordProtectionForest` ) PowerShell по мере необходимости, чтобы использовать учетные данные из одного и того же клиента Azure для всех регистраций.

## <a name="dc-agent-is-unable-to-encrypt-or-decrypt-password-policy-files"></a>Агенту контроллера домена не удалось зашифровать или расшифровать файлы политики паролей

Защита паролей Azure AD имеет критическую зависимость от функций шифрования и расшифровки, предоставляемых службой распространения ключей (Майкрософт). Ошибки шифрования или расшифровки могут быть манифестами с различными симптомами и иметь несколько возможных причин.

1. Убедитесь, что служба KDS включена и работает на всех контроллерах домена Windows Server 2012 и более поздних версий в домене.

   По умолчанию для режима запуска службы KDS задано значение вручную (запуск триггера). Такая конфигурация означает, что при первой попытке клиента использовать службу она запускается по запросу. Этот режим запуска службы по умолчанию приемлем для работы защиты паролей Azure AD.

   Если для режима запуска службы KDS задано значение отключено, эту конфигурацию необходимо исправить, прежде чем защита паролей Azure AD будет работать правильно.

   Простая проверка этой проблемы заключается в запуске службы KDS вручную с помощью консоли MMC для управления службами или при использовании других средств управления (например, запустите NET start кдссвк из консоли командной строки). Служба KDS должна начаться успешно и продолжать работать.

   Наиболее распространенной причиной невозможности запуска службы KDS является то, что объект контроллера домена Active Directory находится за пределами подразделения контроллеров домена по умолчанию. Эта конфигурация не поддерживается службой KDS и не является ограничением, наложенным защитой паролем Azure AD. Исправление для этого условия заключается в перемещении объекта контроллера домена в расположение в подразделении контроллеров домена по умолчанию.

1. Несовместимое изменение формата зашифрованного буфера KDS с Windows Server 2012 R2 на Windows Server 2016

   Исправление безопасности KDS было введено в Windows Server 2016, изменяющее формат зашифрованных буферов KDS. Иногда эти буферы не будут расшифровываться в Windows Server 2012 и Windows Server 2012 R2. Обратное направление — это допустимые буферы, KDS в Windows Server 2012 и Windows Server 2012 R2, которые всегда будут успешно расшифрованы в Windows Server 2016 и более поздних версиях. Если контроллеры домена в доменах Active Directory работают с этими операционными системами, могут быть зарегистрированы нерегулярные сбои расшифровки защиты паролей Azure AD. Невозможно точно предсказать время или симптомы этих сбоев, учитывая характер исправления безопасности, и учитывая, что он недетерминирован, какой агент DC защиты паролей Azure AD будет шифровать данные в определенный момент времени.

   Для этой проблемы не существует обходного решения, Кроме того, чтобы не выполнять сочетание этих несовместимых операционных систем в доменах Active Directory. Иными словами, следует запускать только контроллеры домена Windows Server 2012 и Windows Server 2012 R2. Кроме того, следует запускать только контроллеры домена Windows Server 2016 и выше.

## <a name="dc-agent-thinks-the-forest-has-not-been-registered"></a>Агент контроллера домена считает, что лес не зарегистрирован

Симптомом этой проблемы является 30016 событий, регистрируемых в канале Ажент\админ контроллера домена, который указан в части:

```text
The forest has not been registered with Azure. Password policies cannot be downloaded from Azure unless this is corrected.
```

Существует две возможные причины этой проблемы.

1. Лес в действительности не зарегистрирован. Чтобы устранить эту проблему, выполните команду Register-AzureADPasswordProtectionForest, как описано в разделе [требования к развертыванию](howto-password-ban-bad-on-premises-deploy.md).
1. Лес зарегистрирован, но агенту контроллера домена не удалось расшифровать данные регистрации леса. Этот случай имеет ту же основную причину, что и #2, указанные выше в разделе [Агент контроллера домена, не может шифровать или расшифровывать файлы политики паролей](howto-password-ban-bad-on-premises-troubleshoot.md#dc-agent-is-unable-to-encrypt-or-decrypt-password-policy-files). Простой способ подтвердить эту теорию заключается в том, что эта ошибка возникает только на агентах КОНТРОЛЛЕРов домена, работающих на контроллерах доменов Windows Server 2012 или Windows Server 2012 R2, а агенты КОНТРОЛЛЕРов домена под Windows Server 2016 и более поздних версий — прекрасно. Решение аналогично: обновление всех контроллеров домена до Windows Server 2016 или более поздней версии.

## <a name="weak-passwords-are-being-accepted-but-should-not-be"></a>Ненадежные пароли принимаются, но не должны быть

Эта проблема может быть вызвана несколькими причинами.

1. На агентах контроллера домена запущена общедоступная Предварительная версия программного обеспечения с истекшим сроком действия. См. [срок действия программного обеспечения агента контроллера домена общедоступной предварительной версии](howto-password-ban-bad-on-premises-troubleshoot.md#public-preview-dc-agent-software-has-expired).

1. Агентам контроллера домена не удается загрузить политику или расшифровать существующие политики. Проверьте возможные причины в указанных выше разделах.

1. Режим принудительного применения политики паролей по-прежнему имеет значение "Аудит". Если эта конфигурация действует, перенастройте ее для принудительного применения с помощью портала защиты паролей Azure AD. Дополнительные сведения см. в разделе [режимы работы](howto-password-ban-bad-on-premises-operations.md#modes-of-operation).

1. Политика паролей отключена. Если эта конфигурация действует, перенастройте ее для включения с помощью портала защиты паролей Azure AD. Дополнительные сведения см. в разделе [режимы работы](howto-password-ban-bad-on-premises-operations.md#modes-of-operation).

1. Программное обеспечение агента контроллера домена не установлено на всех контроллерах домена в домене. В этом случае трудно убедиться, что удаленные клиенты Windows нацелены на конкретный контроллер домена во время операции смены пароля. Если вы считаете, что вы успешно нацелены на конкретный контроллер домена, на котором установлено программное обеспечение агента контроллера домена, вы можете проверить его, дважды проверив журнал событий администратора агента контроллеров доменов. независимо от результата, для документирования результатов проверки пароля будет существовать по крайней мере одно событие. Если для пользователя, чей пароль изменен, не существует события, то изменение пароля, скорее всего, было обработано другим контроллером домена.

   В качестве альтернативного теста попробуйте сеттинг\чангинг пароли, войдя непосредственно в контроллер домена, где установлено программное обеспечение агента контроллера домена. Этот метод не рекомендуется для рабочих Active Directory доменов.

   Хотя добавочное развертывание программного обеспечения агента контроллера домена поддерживается в соответствии с этими ограничениями, корпорация Майкрософт настоятельно рекомендует как можно скорее установить программное обеспечение агента DC на всех контроллерах домена в домене.

1. В действительности алгоритм проверки пароля может работать должным образом. Узнайте [, как оцениваются пароли](concept-password-ban-bad.md#how-are-passwords-evaluated).

## <a name="ntdsutilexe-fails-to-set-a-weak-dsrm-password"></a>Ntdsutil.exe не удалось задать надежный пароль DSRM

Active Directory всегда будет проверять новый пароль режима восстановления служб каталогов, чтобы убедиться, что он соответствует требованиям к сложности паролей домена. Эта проверка также вызывает библиотеки DLL фильтрации паролей, такие как защита паролей Azure AD. Если новый пароль DSRM отклоняется, появляется следующее сообщение об ошибке:

```text
C:\>ntdsutil.exe
ntdsutil: set dsrm password
Reset DSRM Administrator Password: reset password on server null
Please type password for DS Restore Mode Administrator Account: ********
Please confirm new password: ********
Setting password failed.
        WIN32 Error Code: 0xa91
        Error Message: Password doesn't meet the requirements of the filter dll's
```

Когда служба защиты паролей Azure AD регистрирует события журнала событий проверки пароля для Active Directory пароля DSRM, ожидается, что сообщения журнала событий не будут содержать имя пользователя. Это происходит из-за того, что учетная запись DSRM — это локальная учетная запись, не входящая в домен фактического Active Directory.  

## <a name="domain-controller-replica-promotion-fails-because-of-a-weak-dsrm-password"></a>Сбой повышения реплики контроллера домена из-за ненадежного пароля DSRM

Во время процесса продвижения контроллера домена новый пароль режима восстановления служб каталогов будет отправлен в существующий контроллер домена в домене для проверки. Если новый пароль DSRM отклоняется, появляется следующее сообщение об ошибке:

```powershell
Install-ADDSDomainController : Verification of prerequisites for Domain Controller promotion failed. The Directory Services Restore Mode password does not meet a requirement of the password filter(s). Supply a suitable password.
```

Как и в описанной выше причине, любое событие результата проверки пароля для защиты паролем Azure AD будет иметь пустые имена пользователей для этого сценария.

## <a name="domain-controller-demotion-fails-due-to-a-weak-local-administrator-password"></a>Сбой понижения роли контроллера домена из-за ненадежного пароля локального администратора

Поддерживается понижение контроллера домена, который все еще запускает программное обеспечение агента контроллера. Администраторы должны знать, что программное обеспечение агента контроллера домена продолжает применять текущую политику паролей во время процедуры понижения. Новый пароль учетной записи локального администратора (указанный как часть операции понижения) проверяется, как и любой другой пароль. Корпорация Майкрософт рекомендует выбирать защищенные пароли для учетных записей локального администратора в рамках процедуры понижения роли контроллера домена.

После успешного понижения роли контроллера домена и перезагрузки и повторного запуска в качестве обычного рядового сервера программное обеспечение агента контроллера домена возвращается к работе в пассивном режиме. Затем его можно удалить в любое время.

## <a name="booting-into-directory-services-repair-mode"></a>Загрузка в режиме восстановления служб каталогов

Если контроллер домена загружается в режиме восстановления служб каталогов, то библиотека DLL фильтра паролей агента контроллера домена обнаружит это условие и приведет к отключению всех действий по проверке пароля или принудительного применения, независимо от текущей конфигурации политики. Библиотека DLL фильтра паролей агента контроллера домена регистрирует событие предупреждения 10023 в журнале событий администратора, например:

```text
The password filter dll is loaded but the machine appears to be a domain controller that has been booted into Directory Services Repair Mode. All password change and set requests will be automatically approved. No further messages will be logged until after the next reboot.
```
## <a name="public-preview-dc-agent-software-has-expired"></a>Срок действия программного обеспечения агента контроллера домена общедоступной предварительной версии истек

Во время общедоступного периода предварительной версии защиты пароля Azure AD программное обеспечение агента контроллера домена было жестко закодировано для отмены обработки запросов на проверку пароля в следующих датах:

* Версия 1.2.65.0 будет прерывать обработку запросов на проверку пароля в 1 2019 сентября.
* Версия 1.2.25.0 и ранее прекратила обработку запросов на проверку пароля в июле 1 2019.

По мере приближения крайнего срока все версии агента контроллера домена с ограниченным временем будут выдавать событие 10021 в журнале событий администратора агента контроллера домена во время загрузки, которое выглядит следующим образом:

```text
The password filter dll has successfully loaded and initialized.

The allowable trial period is nearing expiration. Once the trial period has expired, the password filter dll will no longer process passwords. Please contact Microsoft for an newer supported version of the software.

Expiration date:  9/01/2019 0:00:00 AM

This message will not be repeated until the next reboot.
```

После прохождения крайнего срока все версии агента контроллера домена с ограниченным временем будут выдавать событие 10022 в журнале событий администратора агента контроллера домена во время загрузки, которое выглядит следующим образом:

```text
The password filter dll is loaded but the allowable trial period has expired. All password change and set requests will be automatically approved. Please contact Microsoft for a newer supported version of the software.

No further messages will be logged until after the next reboot.
```

Так как крайний срок проверяется только при начальной загрузке, эти события могут не отображаться до тех пор, пока не истечет крайний срок календаря. После того как крайний срок будет распознан, никакие негативные последствия на контроллере домена или в более крупной среде не будут выполняться автоматически.

> [!IMPORTANT]
> Корпорация Майкрософт рекомендует немедленно обновить общедоступные агенты контроллера домена предварительной версии.

Простой способ обнаружения агентов контроллеров домена в среде, которую необходимо обновить, заключается в выполнении `Get-AzureADPasswordProtectionDCAgent` командлета, например:

```powershell
PS C:\> Get-AzureADPasswordProtectionDCAgent

ServerFQDN            : bpl1.bpl.com
SoftwareVersion       : 1.2.125.0
Domain                : bpl.com
Forest                : bpl.com
PasswordPolicyDateUTC : 8/1/2019 9:18:05 PM
HeartbeatUTC          : 8/1/2019 10:00:00 PM
AzureTenant           : bpltest.onmicrosoft.com
```

В этом разделе поле SoftwareVersion является, очевидно, ключевым свойством для поиска. Можно также использовать фильтрацию PowerShell для фильтрации агентов контроллеров домена, которые уже находятся в или выше требуемой базовой версии, например:

```powershell
PS C:\> $LatestAzureADPasswordProtectionVersion = "1.2.125.0"
PS C:\> Get-AzureADPasswordProtectionDCAgent | Where-Object {$_.SoftwareVersion -lt $LatestAzureADPasswordProtectionVersion}
```

По для прокси-сервера защиты паролей Azure AD не ограничено по времени в любой версии. Корпорация Майкрософт по-прежнему рекомендует обновлять контроллеры домена и прокси-сервера до последних версий по мере их выпуска. `Get-AzureADPasswordProtectionProxy`Командлет можно использовать для поиска агентов прокси-сервера, требующих обновления, аналогично приведенному выше примеру для агентов контроллеров домена.

Дополнительные сведения о конкретных процедурах обновления см. в статье [обновление агента контроллера домена](howto-password-ban-bad-on-premises-deploy.md#upgrading-the-dc-agent) и [Обновление службы прокси-сервера](howto-password-ban-bad-on-premises-deploy.md#upgrading-the-proxy-service) .

## <a name="emergency-remediation"></a>Аварийное исправление

Если служба агента контроллера домена вызывает проблемы, ее можно немедленно отключить. Библиотека DLL фильтрации паролей агента контроллера домена по-прежнему пытается вызвать нерабочую службу и регистрирует события предупреждения (10012, 10013), но все входящие пароли принимаются в течение этого времени. Затем служба агента контроллера домена также может быть настроена с помощью диспетчера управления службами Windows с типом запуска "Отключено" при необходимости.

Еще один способ устранения неполадки — установить для режима включения значение "Нет" на портале функции защиты паролей Azure AD. Как только обновленная политика будет скачана, каждая служба агента контроллера домена перейдет в режим бездействия, в котором все пароли принимаются как есть. Дополнительные сведения см. в разделе [режимы работы](howto-password-ban-bad-on-premises-operations.md#modes-of-operation).

## <a name="removal"></a>Удаление

Если решено удалить программное обеспечение защиты паролей Azure AD и очистить все связанные состояния от доменов и леса, эту задачу можно выполнить, выполнив следующие действия.

> [!IMPORTANT]
> Важно выполнить эти шаги по порядку. Если какой-либо экземпляр службы прокси-сервера остается включенным, он будет периодически повторно создавать объект serviceConnectionPoint. Если какой-либо экземпляр службы агента контроллера домена остается включенным, он будет периодически повторно создавать объект serviceConnectionPoint и состояние sysvol.

1. Удалите программное обеспечение прокси-сервера со всех компьютеров. Для этого шага **не** требуется перезагрузка компьютера.
2. Удалите программное обеспечение агента контроллера домена со всех контроллеров. Для этого шага **требуется** перезагрузка компьютера.
3. Вручную удалите все точки подключения службы прокси-сервера в каждом контексте именования домена. Расположение этих объектов можно обнаружить с помощью следующей команды PowerShell Active Directory:

   ```powershell
   $scp = "serviceConnectionPoint"
   $keywords = "{ebefb703-6113-413d-9167-9f8dd4d24468}*"
   Get-ADObject -SearchScope Subtree -Filter { objectClass -eq $scp -and keywords -like $keywords }
   ```

   Не опускайте звездочку (*) в конце значения переменной $keywords.

   Полученные объекты, найденные с помощью команды `Get-ADObject`, затем можно переадресовать в `Remove-ADObject` или удалить вручную.

4. Вручную удалите все точки подключения агента контроллера домена в каждом контексте именования домена. В каждом контроллере домена в лесу может быть один из этих объектов, в зависимости от того, насколько сильно развернуто программное обеспечение. Расположение этого объекта можно обнаружить с помощью следующей команды PowerShell Active Directory:

   ```powershell
   $scp = "serviceConnectionPoint"
   $keywords = "{2bac71e6-a293-4d5b-ba3b-50b995237946}*"
   Get-ADObject -SearchScope Subtree -Filter { objectClass -eq $scp -and keywords -like $keywords }
   ```

   Полученные объекты, найденные с помощью команды `Get-ADObject`, затем можно переадресовать в `Remove-ADObject` или удалить вручную.

   Не опускайте звездочку (*) в конце значения переменной $keywords.

5. Вручную удалите состояние конфигурации уровня леса. Состояние конфигурации леса поддерживается в контейнере в контексте именования конфигурации Active Directory. Его можно обнаружить и удалить следующим образом:

   ```powershell
   $passwordProtectionConfigContainer = "CN=Azure AD Password Protection,CN=Services," + (Get-ADRootDSE).configurationNamingContext
   Remove-ADObject -Recursive $passwordProtectionConfigContainer
   ```

6. Вручную удалите все сведения о состоянии sysvol, удалив следующую папку и все ее содержимое:

   `\\<domain>\sysvol\<domain fqdn>\AzureADPasswordProtection`

   При необходимости к этому пути также можно получить доступ локально на данном контроллере домена. Расположение по умолчанию будет выглядеть следующим образом:

   `%windir%\sysvol\domain\Policies\AzureADPasswordProtection`

   Этот путь будет другим, если общий ресурс sysvol настроен в нестандартном местоположении.

## <a name="health-testing-with-powershell-cmdlets"></a>Тестирование работоспособности с помощью командлетов PowerShell

Модуль PowerShell Азуреадпассвордпротектион включает два командлета, связанных с работоспособностью, которые выполняют базовую проверку того, что программное обеспечение установлено и работает. Рекомендуется запускать эти командлеты после настройки нового развертывания, периодически после этого и при исследовании проблемы.

Каждый отдельный тест работоспособности возвращает базовый пройденный или непройденный результат, а также необязательное сообщение об ошибке. В случаях, когда причина сбоя неясно, найдите сообщения об ошибках в журнале, которые могут объяснить ошибку. Включение сообщений журнала в текстовом журнале также может быть полезным. Дополнительные сведения см. в статье [мониторинг защиты паролей Azure AD](howto-password-ban-bad-on-premises-monitor.md).

## <a name="proxy-health-testing"></a>Проверка работоспособности прокси-сервера

Командлет Test-AzureADPasswordProtectionProxyHealth поддерживает два теста работоспособности, которые можно выполнять по отдельности. Третий режим позволяет выполнять все тесты, не требующие ввода параметров.

### <a name="proxy-registration-verification"></a>Проверка регистрации прокси-сервера

Этот тест проверяет, правильно ли зарегистрирован прокси-агент в Azure и способен ли пройти проверку подлинности в Azure. Успешный запуск будет выглядеть следующим образом:

```powershell
PS C:\> Test-AzureADPasswordProtectionProxyHealth -VerifyProxyRegistration

DiagnosticName          Result AdditionalInfo
--------------          ------ --------------
VerifyProxyRegistration Passed
```

При обнаружении ошибки тест вернет неудачный результат и необязательное сообщение об ошибке. Ниже приведен пример одной из возможных сбоев.

```powershell
PS C:\> Test-AzureADPasswordProtectionProxyHealth -VerifyProxyRegistration

DiagnosticName          Result AdditionalInfo
--------------          ------ --------------
VerifyProxyRegistration Failed No proxy certificates were found - please run the Register-AzureADPasswordProtectionProxy cmdlet to register the proxy.
```

### <a name="proxy-verification-of-end-to-end-azure-connectivity"></a>Проверка прокси-сервера для сквозного подключения Azure

Этот тест является надмножеством Верифипроксирегистратион теста. Для этого требуется, чтобы прокси-агент был правильно зарегистрирован в Azure, который может пройти проверку подлинности в Azure, и, наконец, добавляет проверку того, что сообщение может быть успешно отправлено в Azure, что позволяет проверить, работает ли полное сквозное взаимодействие.

Успешный запуск будет выглядеть следующим образом:

```powershell
PS C:\> Test-AzureADPasswordProtectionProxyHealth -VerifyAzureConnectivity

DiagnosticName          Result AdditionalInfo
--------------          ------ --------------
VerifyAzureConnectivity Passed
```

### <a name="proxy-verification-of-all-tests"></a>Проверка прокси всех тестов

Этот режим позволяет выполнять полный запуск всех тестов, поддерживаемых командлетом, не требующих ввода параметров. Успешный запуск будет выглядеть следующим образом:

```powershell
PS C:\> Test-AzureADPasswordProtectionProxyHealth -TestAll

DiagnosticName          Result AdditionalInfo
--------------          ------ --------------
VerifyTLSConfiguration  Passed
VerifyProxyRegistration Passed
VerifyAzureConnectivity Passed
```

## <a name="dc-agent-health-testing"></a>Тестирование работоспособности агента контроллера домена

Командлет Test-AzureADPasswordProtectionDCAgentHealth поддерживает несколько тестов работоспособности, которые можно выполнять по отдельности. Третий режим позволяет выполнять все тесты, не требующие ввода параметров.

### <a name="basic-dc-agent-health-tests"></a>Тесты работоспособности агентов основного контроллера домена

Следующие тесты можно выполнять по отдельности и не принимать. Краткое описание

|Проверка работоспособности агента контроллера домена|Описание|
| --- | :---: |
|-Верифипассвордфилтердлл|Проверяет, загружена ли в настоящее время библиотека DLL фильтра паролей, и может ли она вызывать службу агента контроллера домена|
|-Верифифорестрегистратион|Проверяет, зарегистрирован ли лес в настоящий момент|
|-Верифенкриптиондекриптион|Проверка работы базового шифрования и расшифровки с помощью службы Microsoft KDS|
|-Верифидомаинисусингдфср|Проверяет, что текущий домен использует DFSR для репликации SYSVOL.|
|-Верифязуреконнективити|Проверяет, работает ли сквозное взаимодействие с Azure, используя любой доступный прокси-сервер|

Ниже приведен пример тестовой передачи Верифипассвордфилтердлл. другие тесты будут выглядеть аналогично успешно:

```powershell
PS C:\> Test-AzureADPasswordProtectionDCAgentHealth -VerifyPasswordFilterDll

DiagnosticName          Result AdditionalInfo
--------------          ------ --------------
VerifyPasswordFilterDll Passed
```

### <a name="dc-agent-verification-of-all-tests"></a>Проверка агента контроллера домена для всех тестов

Этот режим позволяет выполнять полный запуск всех тестов, поддерживаемых командлетом, не требующих ввода параметров. Успешный запуск будет выглядеть следующим образом:

```powershell
PS C:\> Test-AzureADPasswordProtectionDCAgentHealth -TestAll

DiagnosticName             Result AdditionalInfo
--------------             ------ --------------
VerifyPasswordFilterDll    Passed
VerifyForestRegistration   Passed
VerifyEncryptionDecryption Passed
VerifyDomainIsUsingDFSR    Passed
VerifyAzureConnectivity    Passed
```

### <a name="connectivity-testing-using-specific-proxy-servers"></a>Тестирование подключения с использованием конкретных прокси-серверов

Многие ситуации, связанные с устранением неполадок, относятся к исследованию сетевого подключения между агентами контроллера домена и прокси-серверами. Существуют два теста работоспособности, которые позволяют сосредоточиться на таких проблемах. Для этих тестов требуется указать конкретный прокси-сервер.

#### <a name="verifying-connectivity-between-a-dc-agent-and-a-specific-proxy"></a>Проверка подключения между агентом контроллера домена и конкретным прокси-сервером

Этот тест проверяет подключение к прокси-серверу с помощью первого участка связи от агента контроллера домена. Он проверяет, получает ли прокси-сервер вызов, но не участвует в обмене данными с Azure. Успешный запуск выглядит следующим образом:

```powershell
PS C:\> Test-AzureADPasswordProtectionDCAgentHealth -VerifyProxyConnectivity bpl2.bpl.com

DiagnosticName          Result AdditionalInfo
--------------          ------ --------------
VerifyProxyConnectivity Passed
```

Ниже приведен пример состояния сбоя, при котором служба прокси-сервера, запущенная на целевом сервере, была остановлена.

```powershell
PS C:\> Test-AzureADPasswordProtectionDCAgentHealth -VerifyProxyConnectivity bpl2.bpl.com

DiagnosticName          Result AdditionalInfo
--------------          ------ --------------
VerifyProxyConnectivity Failed The RPC endpoint mapper on the specified proxy returned no results; please check that the proxy service is running on that server.
```

#### <a name="verifying-connectivity-between-a-dc-agent-and-azure-using-a-specific-proxy"></a>Проверка подключения между агентом контроллера домена и Azure (с помощью определенного прокси-сервера)

Этот тест проверяет полное сквозное подключение между агентом контроллера домена и Azure с помощью определенного прокси-сервера. Успешный запуск выглядит следующим образом:

```powershell
PS C:\> Test-AzureADPasswordProtectionDCAgentHealth -VerifyAzureConnectivityViaSpecificProxy bpl2.bpl.com

DiagnosticName                          Result AdditionalInfo
--------------                          ------ --------------
VerifyAzureConnectivityViaSpecificProxy Passed
```

## <a name="next-steps"></a>Дальнейшие действия

[Часто задаваемые вопросы о функции защиты паролей Azure AD](howto-password-ban-bad-on-premises-faq.md)

Для получения дополнительной информации о глобальном и пользовательском запрещенных списках паролей см. статью [Запрет неверных паролей в организации](concept-password-ban-bad.md).
