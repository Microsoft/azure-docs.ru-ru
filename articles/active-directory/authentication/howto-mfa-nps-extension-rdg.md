---
title: Интеграция расширения NPS RDG с Azure AD MFA — Azure Active Directory
description: Интеграция инфраструктуры шлюза удаленный рабочий стол с Azure AD MFA с помощью расширения сервера политики сети для Microsoft Azure
services: multi-factor-authentication
ms.service: active-directory
ms.subservice: authentication
ms.topic: how-to
ms.date: 11/21/2019
ms.author: justinha
author: justinha
manager: daveba
ms.reviewer: michmcla
ms.collection: M365-identity-device-management
ms.openlocfilehash: 20b0150c18f2c007ed104d34daacd49ab03131a7
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "96743383"
---
# <a name="integrate-your-remote-desktop-gateway-infrastructure-using-the-network-policy-server-nps-extension-and-azure-ad"></a>Интеграция инфраструктуры шлюза удаленных рабочих столов с помощью расширения сервера политики сети (NPS) и Azure AD

Эта статья содержит сведения о том, как интегрировать инфраструктуру шлюза удаленный рабочий стол с многофакторной проверкой подлинности Azure AD (MFA) с помощью расширения сервера политики сети (NPS) для Microsoft Azure.

Расширение сервера политики сети (NPS) для Azure позволяет клиентам защищать проверку подлинности клиента протокол RADIUS (RADIUS) с помощью облачной [многофакторной идентификации Azure (MFA)](./concept-mfa-howitworks.md). Это решение предоставляет двухфакторную проверку подлинности в качестве второго уровня безопасности для входа пользователей в систему и транзакций.

В этой статье содержатся пошаговые инструкции по интеграции инфраструктуры NPS с Azure AD MFA с помощью расширения NPS для Azure. Это обеспечивает надежную проверку пользователей, пытающихся войти на шлюз удаленных рабочих столов.

> [!NOTE]
> Эта статья не должна использоваться при развертывании сервера MFA и должна использоваться только с развертываниями Azure AD MFA (на основе облака).

Службы политики сети и доступа (NPS) дают организациям следующие возможности.

* Можно определить центральные расположения для управления сетевыми запросами и их контроля, указав, кто может подключаться, в какое время дня подключения разрешены, продолжительность подключений, уровень безопасности, который клиенты должны использовать для подключения, и так далее. Вместо того, чтобы задавать эти политики на каждом VPN-сервере или сервере шлюза удаленных рабочих столов, их можно указать один раз в центральном расположении. Протокол RADIUS обеспечивает централизованную аутентификацию, авторизацию и учет.
* Можно устанавливать и применять политики работоспособности клиента защиты доступа к сети (NAP), которые определяют, предоставляется ли устройствам неограниченный или ограниченный доступ к сетевым ресурсам.
* Можно внедрить средства аутентификации и авторизации для доступа к точкам беспроводного доступа и коммутаторам Ethernet, поддерживающим протокол 802.1x.

Как правило, организации используют NPS (RADIUS) для упрощения и централизации управления политиками VPN. Однако во многих организациях NPS также используется для упрощения и централизации управления политиками авторизации подключений к удаленным рабочим столам.

Организации также могут интегрировать NPS с Azure AD MFA для повышения безопасности и обеспечения высокого уровня соответствия. Это позволяет обеспечить применение пользователями двухфакторной проверки подлинности для входа на шлюз удаленных рабочих столов. Чтобы получить доступ, пользователю необходимо предоставить свои имя пользователя и пароль, а также сведения, которыми он управляет. Эта информация должна быть надежной, и ее копирование должно быть затруднено. Например, это может быть номер мобильного телефона, номер стационарного телефона, приложение на мобильном устройстве и т. д. В настоящее время RDG поддерживает телефонные звонки и Push-уведомления от методов приложения Microsoft Authenticator для 2FA. Дополнительные сведения о поддерживаемых методах проверки подлинности см. в разделе [Определение методов проверки подлинности, которые смогут использовать пользователи](howto-mfa-nps-extension.md#determine-which-authentication-methods-your-users-can-use).

До появления расширения NPS для Azure пользователям, желающим реализовать двухфакторную проверку подлинности для интегрированной службы NPS и сред Azure AD MFA, пришлось настроить и поддерживать отдельный сервер MFA в локальной среде, как описано в [Удаленный рабочий стол Gateway и Azure сервер многофакторной идентификации с использованием RADIUS](howto-mfaserver-nps-rdg.md).

Теперь, когда доступно расширение NPS для Azure, организации имеют возможность развернуть локальное или облачное решение MFA для защиты аутентификации клиентов RADIUS.

## <a name="authentication-flow"></a>Поток аутентификации

Чтобы пользователи могли получить доступ к сетевым ресурсам через шлюз удаленных рабочих столов, они должны соответствовать условиям, заданным в одной политике авторизации подключений к удаленным рабочим столам (RD CAP) и одной политике авторизации ресурсов удаленных рабочих столов (RD RAP). Политики авторизации подключений к удаленным рабочим столам определяют, кому разрешено подключаться к шлюзам удаленных рабочих столов. Политики авторизации ресурсов удаленных рабочих столов определяют сетевые ресурсы, например удаленные рабочие столы или удаленные приложения, к которым пользователь может подключаться с помощью шлюза удаленных рабочих столов.

Шлюз удаленных рабочих столов можно настроить для использования центрального хранилища политик авторизации подключений к удаленным рабочим столам. Политики авторизации ресурсов удаленных рабочих столов не могут использовать центральное хранилище политик, так как они обрабатываются на шлюзе удаленных рабочих столов. В качестве примера шлюза удаленных рабочих столов, настроенного для использования центрального хранилища политик авторизации подключений к удаленным рабочим столам, можно привести клиент RADIUS на другом NPS-сервере, который выступает в качестве центрального хранилища политик.

Когда расширение NPS интегрировано с сервером политики сети и шлюзом удаленных рабочих столов, поток успешной аутентификации выглядит следующим образом.

1. Сервер шлюза удаленных рабочих столов получает запрос на аутентификацию от пользователя удаленного рабочего стола для подключения к ресурсу (например, к сеансу удаленного рабочего стола). Выступая в качестве клиента RADIUS, сервер шлюза удаленных рабочих столов преобразовывает запрос в сообщение Access-Request RADIUS и отправляет его на сервер RADIUS (NPS), на котором установлено расширение NPS.
1. Сочетание имени пользователя и пароля проверяется в Active Directory, после чего пользователь аутентифицируется.
1. Если все условия, указанные в запросе на подключение к NPS и политиках сети, выполняются (например, время суток или ограничения членства в группе), расширение NPS запускает запрос на вторичную проверку подлинности в Azure AD MFA.
1. Azure AD MFA обменивается данными с Azure AD, получает сведения о пользователе и выполняет дополнительную проверку подлинности с помощью поддерживаемых методов.
1. После успеха запроса MFA Azure AD MFA передает результат в расширение NPS.
1. NPS-сервер, на котором установлено расширение NPS, отправляет сообщение Access-Accept RADIUS для политики авторизации подключений к удаленным рабочим столам на сервер шлюза удаленных рабочих столов.
1. Пользователю предоставляется доступ к запрошенному сетевому ресурсу через шлюз удаленных рабочих столов.

## <a name="prerequisites"></a>Предварительные условия

В этом разделе подробно описаны предварительные условия, необходимые перед интеграцией Azure AD MFA с помощью шлюза удаленный рабочий стол. Прежде чем приступить к работе, следует подготовить приведенные ниже необходимые компоненты:  

* Инфраструктура служб удаленных рабочих столов (RDS)
* Лицензия Azure AD MFA
* программное обеспечение Windows Server;
* роль "Службы политики сети и доступа" (NPS);
* Синхронизация Azure Active Directory с локальной службой Active Directory
* идентификатор GUID Azure Active Directory.

### <a name="remote-desktop-services-rds-infrastructure"></a>Инфраструктура служб удаленных рабочих столов (RDS)

Необходима рабочая инфраструктура служб удаленных рабочих столов (RDS). Если этого не сделать, вы сможете быстро создать эту инфраструктуру в Azure, используя следующий шаблон быстрого запуска: [создание удаленный рабочий стол развертывания коллекции сеансов](https://github.com/Azure/azure-quickstart-templates/tree/ad20c78b36d8e1246f96bb0e7a8741db481f957f/rds-deployment).

Если вы хотите быстро вручную создать локальную инфраструктуру служб удаленных рабочих столов для тестирования, выполните соответствующие инструкции.
**Дополнительные сведения** см. [в руководстве по развертыванию RDS с помощью Azure](/windows-server/remote/remote-desktop-services/rds-in-azure) и [базовой инфраструктуры RDS](/windows-server/remote/remote-desktop-services/rds-deploy-infrastructure).

### <a name="azure-ad-mfa-license"></a>Лицензия Azure AD MFA

Required — лицензия для Azure AD MFA, которая доступна в Azure AD Premium или в других пакетах, включающих эту службу. Лицензии на основе потребления для Azure AD MFA, например для каждого пользователя или для каждой лицензии проверки подлинности, несовместимы с расширением NPS. Дополнительные сведения см. [в статье как получить многофакторную идентификацию Azure AD](concept-mfa-licensing.md). Для тестирования можно использовать пробную подписку.

### <a name="windows-server-software"></a>программное обеспечение Windows Server;

Для работы расширения NPS требуется Windows Server 2008 R2 с пакетом обновления 1 (SP1) или более поздней версии с установленной службой роли NPS. Все действия в этом разделе были выполнены с помощью Windows Server 2016.

### <a name="network-policy-and-access-services-nps-role"></a>роль "Службы политики сети и доступа" (NPS);

Служба роли NPS предоставляет функциональные возможности сервера и клиента RADIUS, а также службу работоспособности NAP. Эту роль необходимо установить как минимум на двух компьютерах в инфраструктуре: одну на шлюзе удаленных рабочих столов, а другую — на рядовом сервере или контроллере домена. По умолчанию эта роль уже существует на компьютере, который настроен в качестве шлюза удаленных рабочих столов.  Необходимо также установить роль NPS по крайней мере еще на одном компьютере, например контроллере домена или рядовом сервере.

Дополнительные сведения об установке службы роли NPS на компьютер под управлением Windows Server 2012 или более ранней версии см. в разделе [Install a NAP Health Policy Server](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/dd296890(v=ws.10)) (Установка сервера политики работоспособности NAP). Описание рекомендаций для сервера политики сети, включая рекомендации по установке сервера политики сети на контроллере домена, см. в разделе рекомендации [для NPS](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc771746(v=ws.10)).

### <a name="azure-active-directory-synched-with-on-premises-active-directory"></a>Синхронизация Azure Active Directory с локальной службой Active Directory

Для использования расширения NPS локальные пользователи должны быть синхронизированы с Azure AD и настроены для использования Многофакторной идентификации. В этом разделе предполагается, что синхронизация локальных пользователей с Azure AD выполнена с помощью AD Connect. Дополнительные сведения про Azure AD Connect см. в статье [Выборочная установка Azure AD Connect](../hybrid/whatis-hybrid-identity.md).

### <a name="azure-active-directory-guid-id"></a>идентификатор GUID Azure Active Directory.

Чтобы установить расширение NPS, необходимо знать идентификатор GUID Azure AD. Ниже приведены инструкции по поиску идентификатора GUID Azure AD.

## <a name="configure-multi-factor-authentication"></a>Настройка Многофакторной идентификации

В этом разделе приводятся инструкции по интеграции Azure AD MFA с шлюзом удаленный рабочий стол. Как администратор, необходимо настроить службу Azure AD MFA, прежде чем пользователи смогут самостоятельно регистрировать многофакторные устройства или приложения.

Выполните действия, описанные в статье [Приступая к работе с многофакторной идентификацией Azure AD в облаке](howto-mfa-getstarted.md) , чтобы включить MFA для пользователей Azure AD.

### <a name="configure-accounts-for-two-step-verification"></a>Настройка учетных записей для двухфакторной проверки подлинности

После включения MFA для учетной записи вы не сможете выполнить вход для доступа к ресурсам, управляемым политикой MFA, пока не настроите доверенное устройство для второго фактора аутентификации и не пройдете двухфакторную проверку подлинности.

Выполните действия, описанные в разделе [что такое многофакторная идентификация Azure AD для меня](../user-help/multi-factor-authentication-end-user-first-time.md) , чтобы понять и правильно настроить устройства для MFA с учетной записью пользователя.

> [!IMPORTANT]
> Поведение при входе для шлюза удаленный рабочий стол не предоставляет возможности ввода кода проверки с помощью многофакторной идентификации Azure AD. Учетная запись пользователя должна быть настроена для проверки телефона или приложения Microsoft Authenticator с Push-уведомлениями.
>
> Если один из этих двух методов проверки подлинности не настроен для пользователя, он не сможет выполнить запрос многофакторной идентификации Azure AD и войти в шлюз удаленный рабочий стол.

## <a name="install-and-configure-nps-extension"></a>Установка и настройка расширения NPS

В этом разделе приведены инструкции по настройке инфраструктуры RDS для использования Azure AD MFA для аутентификации клиента с помощью шлюза удаленный рабочий стол.

### <a name="acquire-azure-active-directory-tenant-id"></a>Получение идентификатора клиента Azure Active Directory

При настройке расширения NPS необходимо ввести учетные данные администратора и идентификатор Azure AD для клиента Azure AD. Чтобы получить идентификатор клиента, выполните следующие действия.

1. Войдите на [портал Azure](https://portal.azure.com) как глобальный администратор клиента Azure.
1. В меню портала Azure выберите **Azure Active Directory** или выполните на любой странице поиск по запросу **Azure Active Directory** и выберите этот пункт.
1. На странице **Обзор** отображаются *сведения о клиенте* . Рядом с *идентификатором клиента* выберите значок **копирования** , как показано на снимке экрана ниже.

   ![Получение идентификатора клиента из портал Azure](./media/howto-mfa-nps-extension-rdg/azure-active-directory-tenant-id-portal.png)

### <a name="install-the-nps-extension"></a>Установка расширения NPS

Установите расширение NPS на сервер, на котором установлена роль "Службы политики сети и доступа" (NPS). Он выполняет роль сервера RADIUS в нашей инфраструктуре.

> [!IMPORTANT]
> Не устанавливайте расширение NPS на сервере шлюза удаленный рабочий стол (RDG). Сервер RDG не использует протокол RADIUS с клиентом, поэтому расширение не может интерпретировать и выполнять MFA.
>
> Если сервер RDG и сервер политики сети с расширением NPS являются разными серверами, RDG использует NPS внутренне для взаимодействия с другими серверами NPS и использует RADIUS в качестве протокола для правильной связи.

1. Скачайте [расширение NPS](https://aka.ms/npsmfa).
1. Скопируйте исполняемый установочный файл (NpsExtnForAzureMfaInstaller.exe) на NPS-сервер.
1. На NPS-сервере дважды щелкните файл **NpsExtnForAzureMfaInstaller.exe**. При появлении запроса щелкните **Запустить**.
1. В диалоговом окне Установка расширения NPS для Azure AD MFA просмотрите условия лицензионного соглашения, установите флажок **я принимаю условия лицензии** и нажмите кнопку **установить**.
1. В диалоговом окне Установка расширения NPS для Azure AD MFA нажмите кнопку **Закрыть**.

### <a name="configure-certificates-for-use-with-the-nps-extension-using-a-powershell-script"></a>Настройка сертификатов для расширения NPS с помощью сценария PowerShell

Далее необходимо настроить сертификаты для расширения NPS, чтобы обеспечить безопасную связь и контроль. Компоненты NPS включают в себя сценарий Windows PowerShell, предназначенный для настройки самозаверяющего сертификата для сервера политики сети.

Этот сценарий выполняет следующие действия:

* создает самозаверяющий сертификат;
* связывает открытый ключ сертификата с субъектом-службой в Azure AD;
* сохраняет сертификат в хранилище на локальном компьютере;
* Предоставляет пользователю сети доступ к закрытому ключу сертификата.
* перезапускает службу сервера политики сети.

Если вы хотите использовать собственные сертификаты, необходимо привязать открытый ключ сертификата к субъекту-службе в Azure AD и т. д.

Чтобы использовать этот сценарий, укажите в расширении свои учетные данные администратора Azure AD и идентификатор клиента Azure AD, скопированный ранее. Запустите сценарий на каждом NPS-сервере, на котором установлено расширение NPS. После этого выполните описанные ниже действия.

1. Откройте командную строку Windows PowerShell с правами администратора.
1. В командной строке PowerShell введите `cd 'c:\Program Files\Microsoft\AzureMfa\Config'` и нажмите клавишу **ВВОД**.
1. Введите `.\AzureMfaNpsExtnConfigSetup.ps1` и нажмите клавишу **ВВОД**. Сценарий проверяет, установлен ли модуль Azure Active Directory для PowerShell. Если он не установлен, сценарий автоматически установит этот модуль.

   ![Выполнение AzureMfaNpsExtnConfigSetup.ps1 в Azure AD PowerShell](./media/howto-mfa-nps-extension-rdg/image4.png)
  
1. Проверив установку модуля PowerShell, сценарий отображает диалоговое окно модуля Azure Active Directory для PowerShell. В этом диалоговом окне введите учетные данные администратора Azure AD и пароль, затем щелкните **Вход**.

   ![Проверка подлинности в Azure AD в PowerShell](./media/howto-mfa-nps-extension-rdg/image5.png)

1. При появлении запроса вставьте *идентификатор клиента* , скопированный ранее в буфер обмена, и нажмите клавишу **Ввод**.

   ![Вывод идентификатора клиента в PowerShell](./media/howto-mfa-nps-extension-rdg/image6.png)

1. Этот сценарий создает самозаверяющий сертификат и выполняет другие изменения конфигурация. На рисунке ниже показан пример выходных данных.

   ![Выходные данные PowerShell, отображающие самозаверяющий сертификат](./media/howto-mfa-nps-extension-rdg/image7.png)

## <a name="configure-nps-components-on-remote-desktop-gateway"></a>Настройка компонентов NPS на шлюзе удаленных рабочих столов

В этом разделе описывается настройка политик авторизации подключений к шлюзу удаленных рабочих столов и других параметров RADIUS.

Поток проверки подлинности требует обмена сообщениями RADIUS между шлюзом удаленный рабочий стол и сервером политики сети, на котором установлено расширение NPS. Это означает, что необходимо настроить параметры клиента RADIUS на шлюзе удаленных рабочих столов и NPS-сервере, на котором установлено расширение NPS.

### <a name="configure-remote-desktop-gateway-connection-authorization-policies-to-use-central-store"></a>Настройка политик авторизации подключений к шлюзу удаленных рабочих столов для использования центрального хранилища

Политики авторизации подключений к удаленным рабочим столам определяют требования для подключения к серверу шлюза удаленных рабочих столов. Эти политики могут сохраняться локально (по умолчанию) или в центральном хранилище, в котором выполняется сервер политики сети. Чтобы настроить интеграцию Azure AD MFA с RDS, необходимо указать использование центрального хранилища.

1. На сервере шлюза удаленных рабочих столов откройте **диспетчер сервера**.
1. В меню щелкните **Средства**, наведите указатель мыши на пункт **Службы удаленных рабочих столов**, а затем щелкните **Диспетчер шлюза удаленных рабочих столов**.
1. В диспетчере шлюзов удаленных рабочих столов щелкните правой кнопкой мыши **\[ имя сервера \] (local)** и выберите пункт **Свойства**.
1. В диалоговом окне Свойства перейдите на вкладку **хранилище политик авторизации подключений к удаленному рабочему столу** .
1. На вкладке "Хранилище политики авторизации подключений к удаленным рабочим столам" выберите **Центральный сервер политики сети**. 
1. В поле **Введите имя или IP-адрес сервера политики сети** введите IP-адрес или имя сервера, на котором установлено расширение NPS.

   ![Введите имя или IP-адрес сервера NPS](./media/howto-mfa-nps-extension-rdg/image10.png)
  
1. Нажмите кнопку **Добавить**.
1. В диалоговом окне **Общий секрет** введите общий секрет и нажмите кнопку **ОК**. Обязательно запишите этот общий секрет и сохраните в безопасном месте.

   >[!NOTE]
   >Он используется для установления доверия между серверами и клиентами RADIUS. Создайте длинный и сложный секрет.
   >

   ![Создание общего секрета для установления доверия](./media/howto-mfa-nps-extension-rdg/image11.png)

1. Нажмите кнопку **ОК** , чтобы закрыть диалоговое окно.

### <a name="configure-radius-timeout-value-on-remote-desktop-gateway-nps"></a>Настройка значения времени ожидания RADIUS на сервере политики сети шлюза удаленных рабочих столов

Чтобы убедиться в наличии времени на проверку учетных данных пользователей, выполнить двухфакторную проверку подлинности, получить ответы и ответить на сообщения RADIUS, необходимо настроить значение времени ожидания RADIUS.

1. На сервере шлюза удаленных рабочих столов откройте диспетчер сервера. В меню щелкните **Средства**, а затем щелкните **Сервер политики сети**.
1. В консоли **Сервер сетевых политик (локальный)** разверните элемент **RADIUS-клиенты и серверы** и выберите **Remote RADIUS Server** (Удаленный сервер RADIUS).

   ![Консоль управления сервером политики сети, показывающая удаленный сервер RADIUS](./media/howto-mfa-nps-extension-rdg/image12.png)

1. В области сведений дважды щелкните **TS GATEWAY SERVER GROUP** (Группа серверов шлюза службы терминалов).

   >[!NOTE]
   >Данная группа серверов RADIUS была создана при настройке центрального сервера для политик NPS. Шлюз удаленных рабочих столов перенаправляет сообщения RADIUS на этот сервер или в группу серверов, если серверов в группе несколько.
   >

1. В диалоговом окне **TS GATEWAY SERVER GROUP Properties** (Свойства группы серверов шлюза службы терминалов) выберите IP-адрес или имя NPS-сервера, настроенного для хранения политик авторизации подключений к удаленным рабочим столам, а затем нажмите кнопку **Изменить**.

   ![Выберите IP-адрес или имя сервера NPS, настроенного ранее](./media/howto-mfa-nps-extension-rdg/image13.png)

1. В диалоговом окне **Изменение сервера RADIUS** выберите вкладку **Балансировка нагрузки**.
1. На вкладке **Балансировка нагрузки** в поле **Число секунд без ответа, после которого запрос считается отброшенным** измените значение по умолчанию, равное 3, на значение в диапазоне от 30 до 60 секунд.
1. В поле **Число секунд между запросами, после которого сервер считается недоступным** измените значение по умолчанию, равное 30 секундам, на значение, которое равно или больше значения, указанного на предыдущем шаге.

   ![Изменение параметров времени ожидания сервера RADIUS на вкладке "Балансировка нагрузки"](./media/howto-mfa-nps-extension-rdg/image14.png)

1. Дважды нажмите кнопку **ОК**, чтобы закрыть диалоговые окна.

### <a name="verify-connection-request-policies"></a>Проверка политик запросов на подключение

По умолчанию при настройке шлюза удаленных рабочих столов для использования центрального хранилища для политик авторизации подключений шлюз удаленных рабочих столов перенаправляет запросы политик авторизации подключений на NPS-сервер. NPS-сервер с установленным расширением MFA Azure AD обрабатывает запрос на доступ RADIUS. Ниже показано, как проверить политику запросов на подключение по умолчанию.  

1. На шлюзе удаленных рабочих столов в консоли "Сервер сетевых политик (локальный)" разверните элемент **Политики** и выберите **Политики запросов на подключение**.
1. Дважды щелкните **TS GATEWAY AUTHORIZATION POLICY** (Политика аутентификации шлюза службы терминалов).
1. В диалоговом окне **TS GATEWAY AUTHORIZATION POLICY properties** (Свойства политики авторизации шлюза службы терминалов) щелкните вкладку **Параметры**.
1. На вкладке **Параметры** в разделе "Пересылка запроса на подключение" щелкните **Проверка подлинности**. Клиент RADIUS настроен для пересылки запросов на аутентификацию.

   ![Настройка параметров проверки подлинности, указывающих группу серверов](./media/howto-mfa-nps-extension-rdg/image15.png)

1. Щелкните **Отмена**.

>[!NOTE]
> Дополнительные сведения о создании политики запросов на подключение см. в статье [Настройка политик запросов на подключение](/windows-server/networking/technologies/nps/nps-crp-configure#add-a-connection-request-policy) . 

## <a name="configure-nps-on-the-server-where-the-nps-extension-is-installed"></a>Настройка компонентов NPS на сервере, на котором установлено расширение NPS

NPS-сервер, на котором установлено расширение NPS, должен иметь возможность обмениваться сообщениями RADIUS с NPS-сервером в шлюзе удаленных рабочих столов. Чтобы обеспечить этот обмен сообщениями, необходимо настроить компоненты NPS на сервере, на котором установлена служба расширения NPS.

### <a name="register-server-in-active-directory"></a>Регистрация сервера в Active Directory

Для правильной работы в этом сценарии NPS-сервер должен быть зарегистрирован в Active Directory.

1. На NPS-сервере откройте **диспетчер сервера**.
1. В диспетчере сервера щелкните **Средства**, а затем щелкните **Сервер политики сети**.
1. В консоли сервера политики сети щелкните правой кнопкой мыши **Сервер сетевых политик (локальный)**, а затем щелкните **Зарегистрировать сервер в Active Directory**.
1. Два раза нажмите кнопку **ОК**.

   ![Регистрация сервера NPS в Active Directory](./media/howto-mfa-nps-extension-rdg/image16.png)

1. Оставьте консоль открытой для выполнения следующей процедуры.

### <a name="create-and-configure-radius-client"></a>Создание и настройка клиента RADIUS

Шлюз удаленных рабочих столов необходимо настроить как клиент RADIUS на NPS-сервере.

1. На NPS-сервере, на котором установлено расширение NPS, в консоли **Сервер сетевых политик (локальный)** щелкните правой кнопкой мыши **RADIUS-клиенты** и выберите **Создать**.

   ![Создание нового RADIUS-клиента в консоли NPS](./media/howto-mfa-nps-extension-rdg/image17.png)

1. В диалоговом окне **Новый RADIUS-клиент** введите понятное имя, например _шлюз_, и IP-адрес или DNS-имя сервера шлюза удаленный рабочий стол.
1. В полях **Общий секрет** и **Подтвердите общий секрет** введите тот же секрет, который использовался ранее.

   ![Настройте понятное имя и IP-адрес или DNS-сервер.](./media/howto-mfa-nps-extension-rdg/image18.png)

1. Нажмите кнопку **ОК** , чтобы закрыть диалоговое окно Новый RADIUS-клиент.

### <a name="configure-network-policy"></a>Настройка политики сети

Помните, что NPS-сервер с расширением Azure AD MFA является назначенным централизованным хранилищем политик для политики авторизации подключений (CAP). Поэтому необходимо внедрить политику авторизации подключений на NPS-сервере для авторизации допустимых запросов на подключение.  

1. На NPS-сервере откройте консоль "Сервер сетевых политик (локальный)", разверните элемент **Политики** и щелкните **Сетевые политики**.
1. Щелкните правой кнопкой мыши **Подключения к другим серверам доступа** и щелкните **Повторяющаяся политика**.

   ![Дублирование подключения к другим политикам серверов доступа](./media/howto-mfa-nps-extension-rdg/image19.png)

1. Щелкните правой кнопкой мыши **Copy of Connections to other access servers** (Копия политики подключения к другим серверам доступа) и щелкните **Свойства**.
1. В диалоговом окне **Copy of Connections to other access servers** (Копировать подключения к другим серверам доступа) в поле **Имя политики** введите подходящее имя, например _RDG_CAP_. Установите флажок **включить политику** и выберите **предоставить доступ**. При необходимости в разделе **Тип сервера доступа к сети** выберите **Шлюз удаленных рабочих столов** или оставьте значение **Не указано**.

   ![Назовите политику, включите и предоставьте доступ.](./media/howto-mfa-nps-extension-rdg/image21.png)

1. Щелкните вкладку **Ограничения** и установите флажок **Разрешить подключение клиентов без согласования метода проверки подлинности**.

   ![Изменение методов проверки подлинности, чтобы разрешить клиентам подключаться](./media/howto-mfa-nps-extension-rdg/image22.png)

1. При необходимости щелкните вкладку **Условия** и добавьте условия, которые должны быть выполнены для авторизации подключения, например членство в определенной группе Windows.

   ![При необходимости укажите условия подключения](./media/howto-mfa-nps-extension-rdg/image23.png)

1. Нажмите кнопку **OK**. При появлении предложения просмотреть соответствующий раздел справки нажмите кнопку **Нет**.
1. Убедитесь, что новая политика находится вверху списка, включена и предоставляет доступ.

   ![Перемещение политики в начало списка](./media/howto-mfa-nps-extension-rdg/image24.png)

## <a name="verify-configuration"></a>Проверка конфигурации

Чтобы проверить конфигурацию, необходимо войти на шлюз удаленных рабочих столов с помощью подходящего клиента RDP. Обязательно используйте учетную запись, которая разрешена политиками авторизации подключений и включена для Azure AD MFA.

Как показано на рисунке ниже, вы можете использовать страницу **Веб-доступ к удаленным рабочим столам**.

![Тестирование в удаленный рабочий стол Веб-доступ](./media/howto-mfa-nps-extension-rdg/image25.png)

После успешного ввода учетных данных для основной аутентификации в диалоговом окне подключения к удаленному рабочему столу отобразится состояние "Инициализация удаленного подключения", как показано ниже. 

Если вы успешно прошли аутентификацию во вторичном методе проверки подлинности, настроенном ранее в Azure AD MFA, вы подключаетесь к ресурсу. Однако если вы не пройдете дополнительную аутентификацию, доступ к ресурсу будет запрещен. 

![подключение к удаленному рабочему столу инициализации удаленного подключения](./media/howto-mfa-nps-extension-rdg/image26.png)

В следующем примере приложение Authenticator в Windows Phone используется для дополнительной аутентификации.

![Пример Windows Phone приложения проверки подлинности, показывающего проверку](./media/howto-mfa-nps-extension-rdg/image27.png)

После успешного прохождения дополнительной аутентификации вы вошли в шлюз удаленных рабочих столов в обычном режиме. Однако, поскольку требуется использовать дополнительный метод проверки подлинности с помощью мобильного приложения на доверенном устройстве, процесс входа более безопасен, чем в противном случае.

### <a name="view-event-viewer-logs-for-successful-logon-events"></a>Просмотр событий успешного входа в журналах службы "Просмотр событий"

Чтобы просмотреть события успешного входа в журналах службы "Просмотр событий" Windows, можно выполнить приведенную команду Windows PowerShell, которая запрашивает журналы служб терминалов Windows и журналы безопасности Windows.

Чтобы запросить события успешного входа из операционных журналов шлюза _(Event Viewer\Applications and Services Logs\Microsoft\Windows\TerminalServices-Gateway\Operational)_, используйте следующие команды PowerShell.

* `Get-WinEvent -Logname Microsoft-Windows-TerminalServices-Gateway/Operational | where {$_.ID -eq '300'} | FL`
* Эта команда отображает события Windows, в которых пользователь выполнил требования политики авторизации ресурсов удаленных рабочих столов и получил доступ.

![Просмотр событий с помощью PowerShell](./media/howto-mfa-nps-extension-rdg/image28.png)

* `Get-WinEvent -Logname Microsoft-Windows-TerminalServices-Gateway/Operational | where {$_.ID -eq '200'} | FL`
* Эта команда отображает события, в которых пользователь выполнил требования политики авторизации подключений.

![Просмотр политики авторизации подключений с помощью PowerShell](./media/howto-mfa-nps-extension-rdg/image29.png)

Можно также просмотреть этот журнал и отфильтровать информацию по идентификаторам событий, 300 и 200. Чтобы запросить события успешного входа из журналов безопасности службы "Просмотр событий", используйте следующую команду.

* `Get-WinEvent -Logname Security | where {$_.ID -eq '6272'} | FL`
* Эта команда может выполняться на центральном NPS-сервере или сервере шлюза удаленных рабочих столов.

![Примеры успешных событий входа](./media/howto-mfa-nps-extension-rdg/image30.png)

Можно также просмотреть настраиваемое представление журналов безопасности или служб политики сети и доступа, как показано ниже.

![Службы политики сети и доступа Просмотр событий](./media/howto-mfa-nps-extension-rdg/image31.png)

На сервере, где установлено расширение NPS для Azure AD MFA, можно найти Просмотр событий Журналы приложений, относящиеся к этому расширению, в _приложении и службах Logs\Microsoft\AzureMfa_.

![Журналы приложения Просмотр событий AuthZ](./media/howto-mfa-nps-extension-rdg/image32.png)

## <a name="troubleshoot-guide"></a>Руководство по устранению неполадок

Если конфигурация не работает должным образом, то первое, что нужно начать, — это убедиться, что пользователь настроен для использования Azure AD MFA. Подключите пользователя к [порталу Azure](https://portal.azure.com). Если пользователи получат запрос на дополнительную проверку и могут пройти проверку подлинности, можно исключить неправильную конфигурацию Azure AD MFA.

Если Azure AD MFA работает для пользователей, следует ознакомиться с соответствующими журналами событий. К ним относятся события безопасности, работоспособность шлюза и журналы Azure AD MFA, которые обсуждаются в предыдущем разделе.

Ниже приведен пример выходных данных журнала безопасности, содержащих событие неудачного входа (идентификатор события 6273).

![Пример события сбоя входа в систему](./media/howto-mfa-nps-extension-rdg/image33.png)

Ниже приведено связанное событие из журналов Azure MFA.

![Пример входа Azure AD MFA в Просмотр событий](./media/howto-mfa-nps-extension-rdg/image34.png)

Чтобы расширить возможности устранения неполадок, просмотрите файлы журнала в формате базы данных NPS в расположении, в котором установлена служба NPS. Эти файлы журналов создаются в папке _%SystemRoot%\System32\Logs_ в виде файлов с разделителями-запятыми.

Описание этих файлов журнала см. в разделе [Interpret NPS Database Format Log Files](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc771748(v=ws.10)) (Интерпретация файлов журнала в формате базы данных NPS). Записи в этих файлах журнала может быть сложно интерпретировать, не импортировав их в электронную таблицу или базу данных. Помочь в интерпретации файлов журнала могут несколько средств синтаксического анализа IAS в Интернете.

На рисунке ниже показаны выходные данные одной из таких скачиваемых [условно бесплатных программ](https://www.deepsoftware.com/iasviewer).

![Пример условно-бесплатного приложения для синтаксического анализа IAS](./media/howto-mfa-nps-extension-rdg/image35.png)

Наконец, чтобы еще больше расширить возможности устранения неполадок, можно использовать анализатор протокола, например [Microsoft Message Analyzer](/message-analyzer/microsoft-message-analyzer-operating-guide).

На рисунке ниже анализатора сообщений Майкрософт отображается сетевой трафик, отфильтрованный по протоколу RADIUS, содержащему имя пользователя **контосо\алицек**.

![Окно Microsoft Message Analyzer, где отображается отфильтрованный трафик](./media/howto-mfa-nps-extension-rdg/image36.png)

## <a name="next-steps"></a>Дальнейшие действия

[Как получить многофакторную идентификацию Azure AD](concept-mfa-licensing.md)

[Шлюз удаленных рабочих столов и сервер Многофакторной идентификации Azure, использующие проверку подлинности RADIUS](howto-mfaserver-nps-rdg.md)

[Интеграция локальных каталогов с Azure Active Directory](../hybrid/whatis-hybrid-identity.md)