---
title: Устранение неполадок при объединении регистрации Azure Active Directory
description: Устранение неполадок многофакторной идентификации Azure AD и общей регистрации для самостоятельного сброса пароля
services: active-directory
ms.service: active-directory
ms.subservice: authentication
ms.topic: troubleshooting
ms.date: 01/19/2021
ms.author: justinha
author: justinha
manager: daveba
ms.reviewer: rhicock
ms.collection: M365-identity-device-management
ms.openlocfilehash: db87887fc2b51c7cb8cb300eb8e711d3ae9b6ac8
ms.sourcegitcommit: 8a74ab1beba4522367aef8cb39c92c1147d5ec13
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/20/2021
ms.locfileid: "98610795"
---
# <a name="troubleshooting-combined-security-information-registration"></a>Устранение общей регистрации сведений о безопасности

Сведения, приведенные в этой статье, предназначены для администраторов, которые устраняют проблемы, о которых сообщили пользователи в Объединенных средствах регистрации.

## <a name="audit-logs"></a>Журналы аудита

События, регистрируемые в журнале для Объединенной регистрации, находятся в службе методов проверки подлинности в журналах аудита Azure AD.

![Интерфейс журналов аудита Azure AD, отображающий события регистрации](media/howto-registration-mfa-sspr-combined-troubleshoot/combined-security-info-audit-log.png)

В следующей таблице перечислены все события аудита, создаваемые Объединенной регистрацией.

| Действие | Состояние | Причина | Описание |
| --- | --- | --- | --- |
| Пользователь зарегистрировал все необходимые сведения для защиты | Успешное завершение | Пользователь зарегистрировал все необходимые сведения о безопасности. | Это событие возникает, когда пользователь успешно завершил регистрацию.|
| Пользователь зарегистрировал все необходимые сведения для защиты | Сбой | Пользователь отменил регистрацию сведений о безопасности. | Это событие возникает, когда пользователь отменяет регистрацию из режима прерывания.|
| Сведения о безопасности, зарегистрированные пользователем | Успешное завершение | Зарегистрированный пользователем *метод*. | Это событие возникает, когда пользователь регистрирует отдельный метод. *Метод* может быть приложением проверки подлинности, телефоном, электронной почтой, контрольными вопросами, паролем приложения, дополнительным телефоном и т. д.| 
| Сведения о безопасности, проверенные пользователем | Успешное завершение | Пользователь успешно проверил сведения о безопасности. | Это событие возникает, когда пользователь выбирает **хорошее** значение на странице просмотра сведений о безопасности.|
| Сведения о безопасности, проверенные пользователем | Сбой | Пользователю не удалось проверить сведения о безопасности. | Это событие возникает, когда пользователь выбирает **хорошее** значение на странице Проверка сведений о безопасности, но что-то не удается выполнить в серверной части.|
| Сведения о безопасности, удаленные пользователем | Успешное завершение | *Метод* удален пользователем. | Это событие возникает, когда пользователь удаляет отдельный метод. *Метод* может быть приложением проверки подлинности, телефоном, электронной почтой, контрольными вопросами, паролем приложения, дополнительным телефоном и т. д.|
| Сведения о безопасности, удаленные пользователем | Сбой | Пользователю не удалось удалить *метод*. | Это событие возникает, когда пользователь пытается удалить метод, но попытка по какой-либо причине завершается неудачно. *Метод* может быть приложением проверки подлинности, телефоном, электронной почтой, контрольными вопросами, паролем приложения, дополнительным телефоном и т. д.|
| Пользователь изменил сведения о безопасности по умолчанию | Успешное завершение | Пользователь изменил сведения о безопасности по умолчанию для *метода*. | Это событие возникает, когда пользователь изменяет метод по умолчанию. *Метод* может быть уведомлением приложения для проверки подлинности, кодом из моего приложения или токеном средства проверки подлинности, вызовом + x Кскскскскскскскскскс, текстом Code to + x XXXXXXXXX и т. д.|
| Пользователь изменил сведения о безопасности по умолчанию | Сбой | Пользователю не удалось изменить сведения о безопасности по умолчанию для *метода*. | Это событие возникает, когда пользователь пытается изменить метод по умолчанию, но попытка по какой-либо причине завершается неудачей. *Метод* может быть уведомлением приложения для проверки подлинности, кодом из моего приложения или токеном средства проверки подлинности, вызовом + x Кскскскскскскскскскс, текстом Code to + x XXXXXXXXX и т. д.|

## <a name="troubleshooting-interrupt-mode"></a>Устранение неполадок режима прерывания

| Симптом | Действия по устранению неполадок |
| --- | --- |
| Я не вижу ожидаемых методов. | 1. Проверьте, имеет ли пользователь роль администратора Azure AD. Если да, просмотрите различия в политиках администратора SSPR. <br> 2. Определите, прерывается ли пользователь из-за применения регистрации многофакторной проверки подлинности или SSPR регистрации. Чтобы определить, какие методы должны отображаться, см. [блок-схему](../../active-directory/authentication/concept-registration-mfa-sspr-combined.md#combined-registration-modes) в разделе "Объединенные режимы регистрации". <br> 3. Определите, как недавно была изменена политика многофакторной идентификации или SSPR. Если изменение было последним, обновленная политика может занять некоторое время.|

## <a name="troubleshooting-manage-mode"></a>Устранение неполадок в режиме управления

| Симптом | Действия по устранению неполадок |
| --- | --- |
| У меня нет возможности добавить определенный метод. | 1. Определите, включен ли метод для многофакторной проверки подлинности или для SSPR. <br> 2. Если этот метод включен, снова сохраните политики и подождите 1-2 часа перед повторным тестированием. <br> 3. Если этот метод включен, убедитесь, что пользователь еще не установил максимальное число, которое разрешено настраивать для этого метода.|

## <a name="disable-combined-registration"></a>Отключить объединенную регистрацию

Когда пользователь регистрирует номер телефона и (или) мобильное приложение в новом комбинированном интерфейсе, наша служба помечает набор флагов (Стронгаусентикатионмесодс) для этих методов этого пользователя. Эта функция позволяет пользователю выполнять многофакторную проверку подлинности с использованием этих методов, когда требуется многофакторная проверка подлинности.

Если администратор включает предварительную версию, пользователи регистрируются в новом интерфейсе, а затем администратор отключает предварительную версию, а пользователи могут непреднамеренно регистрироваться для многофакторной проверки подлинности.

Если пользователь, который выполнил объединенную регистрацию, переходит на текущую страницу регистрации самостоятельного сброса пароля (SSPR) [https://aka.ms/ssprsetup](https://aka.ms/ssprsetup) , пользователю будет предложено выполнить многофакторную проверку подлинности, прежде чем они смогут получить доступ к этой странице. Этот шаг ожидается с технической точки зрения, но это новая возможность для пользователей, которые ранее были зарегистрированы только для SSPR. Хотя этот дополнительный шаг улучшает безопасность пользователя, предоставляя другой уровень безопасности, администраторам может потребоваться откатить пользователей, чтобы они больше не могли выполнять многофакторную проверку подлинности.  

### <a name="how-to-roll-back-users"></a>Как откатить пользователей

Если вы, как администратор, хотите сбросить параметры многофакторной проверки подлинности пользователя, можно использовать сценарий PowerShell, приведенный в следующем разделе. Скрипт очистит свойство Стронгаусентикатионмесодс для мобильного приложения пользователя и (или) номера телефона. При запуске этого скрипта для пользователей потребуется повторно зарегистрироваться для многофакторной проверки подлинности, если это необходимо. Рекомендуется проверить откат с помощью одного или двух пользователей, прежде чем выполнять откат всех затронутых пользователей.

Приведенные ниже действия помогут вам выполнить откат пользователя или группы пользователей.

#### <a name="prerequisites"></a>Предварительные требования

1. Установите соответствующие модули Azure AD PowerShell. В окне PowerShell выполните следующие команды для установки модулей:

   ```powershell
   Install-Module -Name MSOnline
   Import-Module MSOnline
   ```

1. Сохраните список затронутых идентификаторов объектов пользователей на компьютере в виде текстового файла с одним ИДЕНТИФИКАТОРом в строке. Запишите расположение файла.
1. Сохраните следующий скрипт на своем компьютере и запишите расположение скрипта:

   ```powershell
   <# 
   //********************************************************
   //*                                                      *
   //*   Copyright (C) Microsoft. All rights reserved.      *
   //*                                                      *
   //********************************************************
   #>

   param($path)

   # Define Remediation Fn
   function RemediateUser {

       param  
       (
           $ObjectId
       )

       $user = Get-MsolUser -ObjectId $ObjectId

       Write-Host "Checking if user is eligible for rollback: UPN: "  $user.UserPrincipalName  " ObjectId: "  $user.ObjectId -ForegroundColor Yellow

       $hasMfaRelyingParty = $false
       foreach($p in $user.StrongAuthenticationRequirements)
       {
           if ($p.RelyingParty -eq "*")
           {
               $hasMfaRelyingParty = $true
               Write-Host "User was enabled for per-user MFA." -ForegroundColor Yellow
           }
       }

       if ($user.StrongAuthenticationMethods.Count -gt 0 -and -not $hasMfaRelyingParty)
       {
           Write-Host $user.UserPrincipalName " is eligible for rollback" -ForegroundColor Yellow
           Write-Host "Rolling back user ..." -ForegroundColor Yellow
           Reset-MsolStrongAuthenticationMethodByUpn -UserPrincipalName $user.UserPrincipalName
           Write-Host "Successfully rolled back user " $user.UserPrincipalName -ForegroundColor Green
       }
       else
       {
           Write-Host $user.UserPrincipalName " is not eligible for rollback. No action required."
       }

       Write-Host ""
       Start-Sleep -Milliseconds 750
   }

   # Connect
   Import-Module MSOnline
   Connect-MsolService

   foreach($line in Get-Content $path)
   {
       RemediateUser -ObjectId $line
   }
   ```

#### <a name="rollback"></a>Откат

В окне PowerShell выполните следующую команду, указав расположение скрипта и файла пользователя. При появлении запроса введите учетные данные глобального администратора. Сценарий выведет результат каждой операции обновления пользователя.

`<script location> -path <user file location>`

### <a name="disable-the-updated-experience"></a>Отключение обновленного интерфейса

Чтобы отключить обновленный интерфейс для пользователей, выполните следующие действия.

1. Войдите в портал Azure в качестве администратора пользователей.
2. Выберите **Azure Active Directory**  >  **Параметры пользователя**  >  **Управление параметрами для функций предварительной версии панели доступа**.
3. В разделе **пользователи могут использовать функции предварительной версии для регистрации и управления сведениями о безопасности**, установите для селектора значение **нет**, а затем нажмите кнопку **сохранить**.

Пользователям больше не будет предложено зарегистрироваться, используя обновленный интерфейс.

## <a name="next-steps"></a>Дальнейшие действия

* [Дополнительные сведения о Объединенной регистрации для самостоятельного сброса пароля и службы многофакторной идентификации Azure AD](concept-registration-mfa-sspr-combined.md)
