---
title: Защита паролем Azure AD — Azure Active Directory
description: BЗлоумышленник слабых паролей в локальных средах домен Active Directory Services с помощью защиты паролей Azure AD
services: active-directory
ms.service: active-directory
ms.subservice: authentication
ms.topic: conceptual
ms.date: 07/17/2020
ms.author: justinha
author: justinha
manager: daveba
ms.reviewer: jsimmons
ms.collection: M365-identity-device-management
ms.openlocfilehash: 8f5df1cb158821fb0cd85d90f9ba3b79d80adf45
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "96743927"
---
# <a name="enforce-on-premises-azure-ad-password-protection-for-active-directory-domain-services"></a>Принудительная защита паролей в локальной среде Azure AD для домен Active Directory Services

Служба защиты паролей Azure AD обнаруживает и блокирует известные ненадежные пароли и их варианты, а также может блокировать дополнительные слабые термины, характерные для вашей организации. Локальное развертывание защиты паролей Azure AD использует те же глобальные и настраиваемые списки запрещенных паролей, которые хранятся в Azure AD, и выполняет те же проверки для локальных изменений паролей, что и Azure AD для облачных изменений. Эти проверки выполняются во время изменений паролей и событий сброса пароля для локальных контроллеров домена домен Active Directory служб (AD DS).

## <a name="design-principles"></a>Принципы проектирования

Защита паролей Azure AD разработана с учетом следующих принципов.

* Контроллеры домена никогда не должны взаимодействовать напрямую с Интернетом.
* На контроллерах домена не открыты новые сетевые порты.
* AD DS изменений схемы не требуется. Программное обеспечение использует существующий *контейнер* AD DS и объекты схемы *serviceConnectionPoint* .
* Минимальный режим работы AD DS домена или леса (ДФЛ/FFL) не требуется.
* Программное обеспечение не создает или не требует учетных записей в защищенных доменах AD DS.
* Пользовательские пароли никогда не оставляют контроллер домена во время операций проверки пароля или в любое другое время.
* Программное обеспечение не зависит от других функций Azure AD. Например, служба синхронизации хэшированных паролей Azure AD (PHS) не связана или является обязательной для защиты паролей Azure AD.
* Добавочное развертывание поддерживается, однако политика паролей применяется только в том случае, когда установлен агент контроллера домена (агент DC).

## <a name="incremental-deployment"></a>Добавочное развертывание

Защита паролей Azure AD поддерживает добавочное развертывание на контроллерах домена в домене AD DS. Важно понимать, что это действительно означает и каковы компромиссы.

Программное обеспечение агента DC для защиты паролем Azure AD может проверять только пароли, установленные на контроллере домена, и только для изменения паролей, отправленных на этот контроллер домена. Невозможно контролировать, какие контроллеры домена выбираются клиентскими компьютерами Windows для обработки изменений паролей пользователей. Чтобы обеспечить согласованное поведение и обеспечение безопасности защиты паролем в универсальной службе Azure AD, необходимо установить по для всех контроллеров домена в домене программного обеспечения агента DC.

Многим организациям необходимо тщательно протестировать защиту пароля Azure AD на подмножестве контроллеров домена до полного развертывания. Для поддержки этого сценария защита паролей Azure AD поддерживает частичное развертывание. Программное обеспечение агента контроллера домена на заданном КОНТРОЛЛЕРе домена активно проверяет пароли, даже если на других контроллерах домена не установлено программное обеспечение агента DC. Частичные развертывания этого типа не являются безопасными и не рекомендуются для целей тестирования.

## <a name="architectural-diagram"></a>Схема архитектуры

Прежде чем развертывать защиту паролей Azure AD в локальной среде AD DS, важно понимать основные понятия проектирования и функций. На следующей схеме показано, как компоненты Защиты паролей Azure AD работают вместе.

![Взаимодействие компонентов защиты паролем Azure AD](./media/concept-password-ban-bad-on-premises/azure-ad-password-protection.png)

* Прокси-служба защиты паролей Azure AD выполняется на любом компьютере, присоединенном к домену, в текущем лесу AD DS. Основная цель службы — пересылка запросов на скачивание политики паролей из контроллеров домена в Azure AD и возврат ответов из Azure AD на контроллер домена.
* Библиотека DLL фильтра паролей агента контроллера домена получает запросы проверки пароля пользователя от операционной системы. Фильтр перенаправляет их в службу агента контроллера домена, которая работает локально на контроллере домена.
* Служба агента контроллера домена в службе защиты паролей Azure AD получает запросы на проверку пароля от библиотеки DLL фильтра паролей агента контроллера домена. Служба агента контроллера домена обрабатывает их с использованием текущей (доступной локально) политики паролей и возвращает результат *Pass* или *Fail*.

## <a name="how-azure-ad-password-protection-works"></a>Как работает защита паролей Azure AD

Компоненты защиты паролей в локальной среде Azure AD работают следующим образом.

1. Каждый экземпляр прокси-службы защиты паролей Azure AD объявляет себя контроллерам домена в лесу, создавая объект *serviceConnectionPoint* в Active Directory.

    Каждая служба агента контроллера домена для защиты паролей Azure AD также создает объект *serviceConnectionPoint* в Active Directory. Этот объект используется в основном для создания отчетов и диагностики.

1. Служба агента контроллера домена отвечает за запуск скачивания новой политики паролей из Azure AD. Первым шагом является поиск прокси-службы защиты паролей Azure AD путем запроса леса для прокси-объектов *serviceConnectionPoint* .

1. При обнаружении доступной прокси-службы агент контроллера домена отправляет запрос на скачивание политики паролей в прокси-службу. Прокси-служба, в свою очередь, отправляет запрос в Azure AD, а затем возвращает ответ службе агента контроллера домена.

1. После того как служба агента контроллера домена получает новую политику паролей из Azure AD, она сохраняет политику в выделенной папке в корне общей папки *SYSVOL* домена. Служба агента контроллера домена также отслеживает эту папку в случае, если более новые политики реплицируются из других служб агента контроллера домена в домене.

1. Служба агента контроллера домена всегда запрашивает новую политику при запуске службы. После запуска службы агента контроллера домена он проверяет возраст текущей локальной политики ежечасно. Если политика старше одного часа, агент контроллера домена запрашивает новую политику из Azure AD через прокси-службу, как описано выше. Если текущая политика не старше одного часа, агент контроллера домена продолжит использовать эту политику.

1. Когда контроллер домена получает события изменения пароля, используется кэшированная политика, позволяющая определить, принимается ли новый пароль или отклоняется.

### <a name="key-considerations-and-features"></a>Ключевые аспекты и функции

* При загрузке политики паролей для защиты паролем Azure AD эта политика относится к клиенту. Иными словами, политики паролей всегда являются сочетанием списка с глобальными запрещенными паролями Майкрософт и списка запрещенных паролей для каждого клиента.
* Агент контроллера домена взаимодействует со службой прокси через RPC через TCP. Прокси-служба прослушивает эти вызовы на динамическом или статическом порте RPC в зависимости от конфигурации.
* Агент контроллера домена никогда не прослушивает порт, доступный по сети.
* Прокси-служба никогда не вызывает службу агента контроллера домена.
* Служба прокси-сервера не имеет состояния. Он никогда не кэширует политики или другие состояния, скачанные из Azure.
* Служба агента контроллера домена всегда использует последнюю локальную политику паролей для вычисления пароля пользователя. Если на локальном контроллере домена нет доступной политики паролей, пароль будет автоматически принят. В этом случае в журнал заносится сообщение о событии, чтобы предупредить администратора.
* Защита паролей Azure AD не является ядром приложения политики реального времени. Возможна задержка между изменением конфигурации политики паролей в Azure AD, а также тем, когда это изменение достигается и применяется ко всем контроллерам домена.
* Защита паролей Azure AD действует как дополнение к существующим политикам паролей AD DS, а не к замене. Сюда входят любые другие DLL-библиотеки фильтрации паролей сторонних производителей, которые могут быть установлены. AD DS всегда требует, чтобы все компоненты проверки пароля были согласованы перед принятием пароля.

## <a name="forest--tenant-binding-for-azure-ad-password-protection"></a>Привязка леса или клиента для защиты паролей Azure AD

Для развертывания защиты паролей Azure AD в лесу AD DS требуется регистрация этого леса в Azure AD. Каждая развернутая служба прокси-сервера также должна быть зарегистрирована в Azure AD. Эти регистрации леса и прокси-сервера связаны с определенным клиентом Azure AD, который неявно определяется учетными данными, используемыми во время регистрации.

Лес AD DS и все развернутые прокси-службы в лесу должны быть зарегистрированы в одном и том же клиенте. Не поддерживается наличие AD DS леса или любых прокси-служб в этом лесу, которые регистрируются в разных клиентах Azure AD. Симптомы такого неправильного развертывания включают невозможность загрузки политик паролей.

> [!NOTE]
> Поэтому клиенты, имеющие несколько клиентов Azure AD, должны выбрать один различающиеся клиенты для регистрации каждого леса в целях защиты паролей Azure AD.

## <a name="download"></a>Скачать

Два необходимых установщика агента для защиты паролей Azure AD доступны в [центре загрузки Майкрософт](https://www.microsoft.com/download/details.aspx?id=57071).

## <a name="next-steps"></a>Дальнейшие действия

Чтобы приступить к работе с локальной защитой паролей Azure AD, выполните следующие действия.

> [!div class="nextstepaction"]
> [Развертывание локальной защиты паролей Azure AD](howto-password-ban-bad-on-premises-deploy.md)
