---
title: Вход с помощью электронной почты в качестве альтернативного имени пользователя для Azure Active Directory
description: Узнайте, как разрешить пользователям входить в Azure Active Directory, используя свой адрес электронной почты в качестве альтернативного имени пользователя (предварительная версия).
services: active-directory
ms.service: active-directory
ms.subservice: authentication
ms.topic: how-to
ms.date: 10/01/2020
ms.author: justinha
author: justinha
manager: daveba
ms.reviewer: calui
ms.openlocfilehash: 4e39d7f15e3ca3c6e241c767a5f881d7170c6379
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "99255973"
---
# <a name="sign-in-to-azure-active-directory-using-email-as-an-alternate-login-id-preview"></a>Вход в Azure Active Directory использование электронной почты в качестве альтернативного имени для входа (Предварительная версия)

> [!NOTE]
> Вход в Azure AD с помощью электронной почты в качестве альтернативного имени пользователя — это общедоступная предварительная версия функции Azure Active Directory. См. подробные сведения о [дополнительных условиях использования предварительных выпусков Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).

Многие организации хотят разрешить пользователям входить в Azure Active Directory (Azure AD), используя те же учетные данные, что и в локальной среде каталогов. При таком подходе, известном как гибридная проверка подлинности, пользователям нужно запоминать только один набор учетных данных.

Некоторые организации не перешли к гибридной проверке подлинности по следующим причинам.

* По умолчанию для имени участника-пользователя (UPN) Azure AD задан тот же UPN, что и в локальном каталоге.
* Изменение имени участника-пользователя Azure AD создает неверное соответствие между локальной средой и средами Azure AD, которые могут вызвать проблемы с определенными приложениями и службами.
* Из-за бизнес-требований или по соображениям соответствия Организации не требуется использовать локальный UPN для входа в Azure AD.

Чтобы упростить переход на гибридную проверку подлинности, теперь можно настроить Azure AD, чтобы позволить пользователям входить по электронной почте в проверенном домене в качестве альтернативного имени для входа. Например, если *Contoso* сменила имя на *Fabrikam*, вместо того чтобы продолжать входить с помощью устаревшего имени участника-пользователя `balas@contoso.com`, можно использовать адрес электронной почты в качестве альтернативного имени пользователя. Чтобы получить доступ к приложению или службам, пользователи будут входить в Azure AD, используя назначенный им адрес электронной почты, например `balas@fabrikam.com` .

В этой статье показано, как включить и использовать адрес электронной почты в качестве альтернативного идентификатора входа. Эта функция доступна в Azure AD Free Edition и более поздних версиях.

> [!NOTE]
> Эта функция предназначена только для пользователей Azure AD с аутентификацией в облаке.

> [!NOTE]
> Сейчас эта функция не поддерживается на устройствах с Windows 10, присоединенных к Azure AD, для клиентов с проверкой подлинности в облаке. Эта функция неприменима к гибридным устройствам, присоединенным к Azure AD.

## <a name="overview-of-azure-ad-sign-in-approaches"></a>Обзор подходов к входу в Azure AD

Чтобы войти в Azure AD, пользователи вводят имя, уникально идентифицирующее свою учетную запись. Исторически имя участника-пользователя Azure AD можно было бы использовать только в качестве имени для входа.

Для организаций, где локальный UPN является предпочтительным адресом электронной почты входа пользователя, этот подход был великолепно. В этих организациях для имени участника-пользователя Azure AD будет указано то же значение, что и для локального имени участника-пользователя, а пользователи будут иметь единообразный вход в систему.

Однако в некоторых организациях локальное имя участника-пользователя не используется в качестве имени для входа. В локальных средах можно настроить локальный AD DS для разрешения входа с альтернативным ИДЕНТИФИКАТОРом входа. При настройке имени участника-пользователя Azure AD на то же значение, что и локальное имя участника-пользователя, не обязательно, так как Azure AD потребует от пользователя войти с этим значением.

Типичным решением этой проблемы было Установка имени участника-пользователя Azure AD на адрес электронной почты, с которым пользователь должен войти. Этот подход работает, хотя в этом случае разные имена участников-пользователей между локальной AD и в Azure AD, а эта конфигурация несовместима со всеми Microsoft 365 рабочими нагрузками.

Другой подход — синхронизировать Azure AD и локальные UPN с одним и тем же значением, а затем настроить Azure AD, чтобы разрешить пользователям входить в Azure AD с помощью проверенного электронного письма. Чтобы предоставить эту возможность, необходимо определить один или несколько адресов электронной почты в атрибуте *proxyAddresses* пользователя в локальном каталоге. Затем *proxyAddresses* синхронизируются с Azure AD автоматически с помощью Azure AD Connect.

## <a name="preview-limitations"></a>Ограничения предварительной версии

Вход в Azure AD с помощью электронной почты в качестве альтернативного идентификатора входа доступен в Azure AD Free Edition и более поздних версиях.

В текущем состоянии предварительного просмотра применяются следующие ограничения, когда пользователь входит в систему по электронной почте, не являющейся именем участника-пользователя, в качестве альтернативного имени входа.

* Пользователи могут видеть свое имя участника-пользователя, даже если они вошли в сообщение, не являющееся именем участника-пользователя. Может появиться следующий пример поведения:
    * Пользователю предлагается выполнить вход с использованием имени участника-пользователя при переходе к входу в Azure AD с помощью `login_hint=<non-UPN email>` .
    * Когда пользователь входит в систему с помощью сообщения, отличного от имени участника-пользователя, и вводит неверный пароль, на странице *"ввод пароля"* изменяется имя участника-пользователя.
    * На некоторых веб-узлах и приложениях Майкрософт, таких как [https://portal.azure.com](https://portal.azure.com) и Microsoft Office, элемент управления **диспетчера учетных записей** , обычно отображаемый в правом верхнем углу, может отображать UPN пользователя вместо адреса электронной почты, отличного от UPN, используемого для входа.

* Некоторые потоки в настоящее время несовместимы с адресом электронной почты, отличным от UPN, например:
    * В настоящее время защита идентификации не соответствует альтернативным идентификаторам входа электронной почты с *утечкой учетных данных* . Это обнаружение рисков использует имя участника-пользователя для сопоставления учетных данных, которые были утечки. Дополнительные сведения см. в разделе [Защита идентификации Azure AD обнаружение рисков и исправление][identity-protection].
    * Приглашения B2B, отправленные по адресу альтернативного имени входа, не полностью поддерживаются. После принятия приглашения, отправленного по электронной почте в качестве альтернативного имени пользователя, вход с альтернативным адресом электронной почты может не работать для пользователя на клиентской конечной точке.

## <a name="synchronize-sign-in-email-addresses-to-azure-ad"></a>Синхронизация адресов электронной почты для входа в Azure AD

Традиционная проверка подлинности доменных служб Active Directory Services (AD DS) или служб федерации Active Directory (AD FS) производится непосредственно в вашей сети и обрабатывается вашей инфраструктурой AD DS. При использовании гибридной проверки подлинности пользователи могут вместо этого входить непосредственно в Azure AD.

Для поддержки такого подхода к гибридной проверке подлинности следует синхронизировать локальную среду AD DS с Azure AD с помощью [Azure AD Connect][azure-ad-connect] и настроить ее для использования синхронизации хэшей паролей (PHS) или сквозной проверки подлинности (PTA).

В обоих параметрах конфигурации пользователь отправляет свое имя пользователя и пароль в Azure AD, где они проверяются и пользователю выдается билет. Вход пользователей в Azure AD избавляет организацию от необходимости размещать инфраструктуру AD FS и управлять ею.

![Схема гибридной идентификации Azure AD с синхронизацией хэша паролей.](media/howto-authentication-use-email-signin/hybrid-password-hash-sync.png)

![Схема гибридной идентификации Azure AD со сквозной аутентификацией.](media/howto-authentication-use-email-signin/hybrid-pass-through-authentication.png)

Один из пользовательских атрибутов, которые автоматически синхронизируются Azure AD Connect, является *ProxyAddresses*. Если у пользователей есть адрес электронной почты, определенный в локальной среде AD DS как часть атрибута *ProxyAddresses*, он автоматически синхронизируется с Azure AD. Этот адрес электронной почты можно затем использовать непосредственно в процессе входа в Azure AD как альтернативное имя пользователя.

> [!IMPORTANT]
> Только сообщения электронной почты в проверенных доменах для клиента синхронизируются с Azure AD. Каждый клиент Azure AD имеет один или несколько проверенных доменов, у которых имеется проверенный владелец и которые уникально привязаны к клиенту.
>
> Дополнительные сведения см. в статье [Добавление и проверка пользовательского доменного имени для облачной службы Azure][verify-domain].

Дополнительные сведения см. в статье [Выбор правильного метода аутентификации для решения гибридной идентификации Azure AD][hybrid-auth-methods].

## <a name="enable-user-sign-in-with-an-email-address"></a>Включение входа пользователя с помощью адреса электронной почты

После того как пользователи с примененным атрибутом *ProxyAddresses* синхронизируются с Azure AD с помощью Azure AD Connect, необходимо включить эту функцию, чтобы пользователи могли входить, используя электронную почту в качестве альтернативного имени пользователя для входа в клиент. Эта функция сообщает серверам входа Azure AD, что нужно сравнивать имя входа не только со значениями имени участника-пользователя, но и со значениями *ProxyAddresses* для адреса электронной почты.

Сейчас, на этапе предварительной версии, вход с помощью электронной почты в качестве альтернативного имени пользователя можно включить только с помощью PowerShell. Для выполнения следующих действий требуются разрешения *администратора клиента*.

1. Откройте сеанс PowerShell от имени администратора, а затем установите модуль *AzureADPreview* с помощью командлета [Install-Module][Install-Module]:

    ```powershell
    Install-Module AzureADPreview
    ```

    При появлении запроса выберите **Y** для установки NuGet или установки из ненадежного репозитория.

1. Войдите в клиент Azure AD от имени *администратора клиента* с помощью командлета [Connect-AzureAD][Connect-AzureAD]:

    ```powershell
    Connect-AzureAD
    ```

    Команда возвращает информацию о вашей учетной записи, среде и идентификаторе клиента.

1. Убедитесь, что политика *HomeRealmDiscoveryPolicy* уже существует в клиенте, использовав командлет [Get-AzureADPolicy][Get-AzureADPolicy] следующим образом.

    ```powershell
    Get-AzureADPolicy | Where-Object Type -eq "HomeRealmDiscoveryPolicy" | Format-List *
    ```

1. Если политика в настоящее время не настроена, команда не возвращает ничего. Если возвращается политика, пропустите этот шаг и перейдите к следующему шагу, чтобы обновить существующую политику.

    Чтобы добавить политику *HomeRealmDiscoveryPolicy* в клиент, используйте командлет [New-AzureADPolicy][New-AzureADPolicy] и задайте для атрибута *AlternateIdLogin* значение *"Enabled": true*, как показано в следующем примере.

    ```powershell
    $AzureADPolicyDefinition = @(
      @{
         "HomeRealmDiscoveryPolicy" = @{
            "AlternateIdLogin" = @{
               "Enabled" = $true
            }
         }
      } | ConvertTo-JSON -Compress
    )
    $AzureADPolicyParameters = @{
      Definition            = $AzureADPolicyDefinition
      DisplayName           = "BasicAutoAccelerationPolicy"
      IsOrganizationDefault = $true
      Type                  = "HomeRealmDiscoveryPolicy"
    }
    New-AzureADPolicy @AzureADPolicyParameters
    ```

    После успешного создания политики эта команда возвращает идентификатор политики, как показано в следующем примере выходных данных:

    ```powershell
    Id                                   DisplayName                 Type                     IsOrganizationDefault
    --                                   -----------                 ----                     ---------------------
    5de3afbe-4b7a-4b33-86b0-7bbe308db7f7 BasicAutoAccelerationPolicy HomeRealmDiscoveryPolicy True
    ```

1. Если настроенная политика уже существует, проверьте, включен ли атрибут  *AlternateIdLogin* , как показано в следующем примере выходных данных политики:

    ```powershell
    Id : 5de3afbe-4b7a-4b33-86b0-7bbe308db7f7
    OdataType :
    AlternativeIdentifier :
    Definition : {{"HomeRealmDiscoveryPolicy" :{"AlternateIdLogin":{"Enabled": true}}}}
    DisplayName : BasicAutoAccelerationPolicy
    IsOrganizationDefault : True
    KeyCredentials : {}
    Type : HomeRealmDiscoveryPolicy
    ```

    Если политика существует, но атрибут *AlternateIdLogin* отсутствует или отключен или если в политике есть другие атрибуты, которые вы хотите сохранить, обновите существующую политику, используя командлет [Set-AzureADPolicy][Set-AzureADPolicy].

    > [!IMPORTANT]
    > При обновлении политики убедитесь, что в нее включены все старые параметры и новый атрибут  *AlternateIdLogin*.

    В следующем примере добавляется атрибут  *AlternateIdLogin* и сохраняется атрибут  *AllowCloudPasswordValidation*, который мог быть уже установлен:

    ```powershell
    $AzureADPolicyDefinition = @(
      @{
         "HomeRealmDiscoveryPolicy" = @{
            "AllowCloudPasswordValidation" = $true
            "AlternateIdLogin" = @{
               "Enabled" = $true
            }
         }
      } | ConvertTo-JSON -Compress
    )
    $AzureADPolicyParameters = @{
      ID                    = "b581c39c-8fe3-4bb5-b53d-ea3de05abb4b"
      Definition            = $AzureADPolicyDefinition
      DisplayName           = "BasicAutoAccelerationPolicy"
      IsOrganizationDefault = $true
      Type                  = "HomeRealmDiscoveryPolicy"
    }
    
    Set-AzureADPolicy @AzureADPolicyParameters
    ```

    Убедитесь, что обновленная политика отображает изменения и атрибут *AlternateIdLogin* включен:

    ```powershell
    Get-AzureADPolicy | Where-Object Type -eq "HomeRealmDiscoveryPolicy" | Format-List *
    ```

После применения политики может пройти до часа, чтобы распространить и предоставить пользователям возможность входа с использованием альтернативного имени пользователя.

## <a name="test-user-sign-in-with-email"></a>Проверка входа пользователя в систему с помощью электронной почты

Чтобы проверить возможность входа пользователей с помощью электронной почты, перейдите в [https://myprofile.microsoft.com][my-profile] и войдите, используя учетную запись пользователя на основе адреса электронной почты, например `balas@fabrikam.com`, а не имени участника-пользователя, например `balas@contoso.com`. Процедура входа в систему должна выглядеть так же, как и с событием входа на основе имени участника-пользователя.

## <a name="enable-staged-rollout-to-test-user-sign-in-with-an-email-address"></a>Включение промежуточного развертывания для проверки входа пользователя с помощью адреса электронной почты  

[Поэтапное развертывание][staged-rollout] позволяет администраторам клиентов включать функции для конкретных групп. Рекомендуется, чтобы администраторы клиента использовали промежуточное развертывание для проверки входа пользователя с помощью адреса электронной почты. Когда администраторы готовы к развертыванию этой функции для всего клиента, они должны использовать политику обнаружения домашней области.  


Для выполнения следующих действий требуются разрешения *администратора клиента*.

1. Откройте сеанс PowerShell от имени администратора, а затем установите модуль *AzureADPreview* с помощью командлета [Install-Module][Install-Module] :

    ```powershell
    Install-Module AzureADPreview
    ```

    При появлении запроса выберите **Y** для установки NuGet или установки из ненадежного репозитория.

2. Войдите в клиент Azure AD от имени *администратора клиента* с помощью командлета [Connect-AzureAD][Connect-AzureAD]:

    ```powershell
    Connect-AzureAD
    ```

    Команда возвращает информацию о вашей учетной записи, среде и идентификаторе клиента.

3. Перечислите все существующие политики промежуточного развертывания с помощью следующего командлета:
   
   ```powershell
   Get-AzureADMSFeatureRolloutPolicy
   ``` 

4. Если для этой функции нет существующих политик развертывания с промежуточным развертыванием, создайте новую политику промежуточного развертывания и запишите идентификатор политики:

   ```powershell
   $AzureADMSFeatureRolloutPolicy = @{
      Feature    = "EmailAsAlternateId"
      DisplayName = "EmailAsAlternateId Rollout Policy"
      IsEnabled   = $true
   }
   New-AzureADMSFeatureRolloutPolicy @AzureADMSFeatureRolloutPolicy
   ```

5. Найдите идентификатор directoryObject для группы, которая будет добавлена в политику промежуточного развертывания. Обратите внимание на значение, возвращаемое для параметра *ID* , так как оно будет использоваться на следующем шаге.
   
   ```powershell
   Get-AzureADMSGroup -SearchString "Name of group to be added to the staged rollout policy"
   ```

6. Добавьте группу в политику промежуточного развертывания, как показано в следующем примере. Замените значение в параметре *-ID* на значение, возвращенное для идентификатора политики на шаге 4, и замените значение параметра *-RefObjectId* на *идентификатор* , указанный в шаге 5. Может потребоваться до 1 часа, прежде чем пользователи в группе смогут использовать их прокси-адреса для входа.

   ```powershell
   Add-AzureADMSFeatureRolloutPolicyDirectoryObject -Id "ROLLOUT_POLICY_ID" -RefObjectId "GROUP_OBJECT_ID"
   ```
   
Для новых участников, добавленных в группу, может потребоваться до 24 часов, прежде чем они смогут использовать их прокси-адреса для входа.

### <a name="removing-groups"></a>Удаление групп

Чтобы удалить группу из промежуточной политики развертывания, выполните следующую команду:

```powershell
Remove-AzureADMSFeatureRolloutPolicyDirectoryObject -Id "ROLLOUT_POLICY_ID" -ObjectId "GROUP_OBJECT_ID" 
```

### <a name="removing-policies"></a>Удаление политик

Чтобы удалить политику промежуточного развертывания, сначала отключите ее, а затем удалите из системы:

```powershell
Set-AzureADMSFeatureRolloutPolicy -Id "ROLLOUT_POLICY_ID" -IsEnabled $false 
Remove-AzureADMSFeatureRolloutPolicy -Id "ROLLOUT_POLICY_ID"
```

## <a name="troubleshoot"></a>Диагностика

Если у пользователей возникают проблемы с событиями входа при помощи адреса электронной почты, ознакомьтесь со следующими действиями по устранению неполадок.

1. Убедитесь, что в учетной записи пользователя задан адрес электронной почты для атрибута *ProxyAddresses* в локальной среде AD DS.
1. Убедитесь, что служба Azure AD Connect настроена и успешно синхронизирует учетные записи пользователей из локальной среды AD DS в Azure AD.
1. Убедитесь, что в политике Azure AD *HomeRealmDiscoveryPolicy* атрибут *AlternateIdLogin* установлен на *"Enabled": true*:

    ```powershell
    Get-AzureADPolicy | Where-Object Type -eq "HomeRealmDiscoveryPolicy" | Format-List *
    ```

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о гибридных удостоверениях, например прокси Azure AD App или доменных службах Azure AD, см. в статье [Гибридное удостоверение Azure AD для доступа и управления локальными рабочими нагрузками][hybrid-overview].

Дополнительные сведения об операциях гибридной идентификации см. в работах по синхронизации [как выполняется синхронизация хэшей паролей][phs-overview] или [сквозная проверка подлинности][pta-overview].

<!-- INTERNAL LINKS -->
[verify-domain]: ../fundamentals/add-custom-domain.md
[hybrid-auth-methods]: ../hybrid/choose-ad-authn.md
[azure-ad-connect]: ../hybrid/whatis-azure-ad-connect.md
[hybrid-overview]: ../hybrid/cloud-governed-management-for-on-premises.md
[phs-overview]: ../hybrid/how-to-connect-password-hash-synchronization.md
[pta-overview]: ../hybrid/how-to-connect-pta-how-it-works.md
[identity-protection]: ../identity-protection/overview-identity-protection.md#risk-detection-and-remediation

<!-- EXTERNAL LINKS -->
[Install-Module]: /powershell/module/powershellget/install-module
[Connect-AzureAD]: /powershell/module/azuread/connect-azuread
[Get-AzureADPolicy]: /powershell/module/azuread/get-azureadpolicy
[New-AzureADPolicy]: /powershell/module/azuread/new-azureadpolicy
[Set-AzureADPolicy]: /powershell/module/azuread/set-azureadpolicy
[staged-rollout]: /powershell/module/azuread/?view=azureadps-2.0-preview&preserve-view=true#staged-rollout
[my-profile]: https://myprofile.microsoft.com
