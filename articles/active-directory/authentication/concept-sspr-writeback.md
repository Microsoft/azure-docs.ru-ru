---
title: Локальная обратная запись паролей при самостоятельном сбросе пароля — Azure Active Directory
description: Узнайте, как события изменения или сброса пароля в Azure Active Directory можно записать обратно в локальную среду каталога.
services: active-directory
ms.service: active-directory
ms.subservice: authentication
ms.topic: conceptual
ms.date: 07/14/2020
ms.author: justinha
author: justinha
manager: daveba
ms.reviewer: rhicock
ms.collection: M365-identity-device-management
ms.openlocfilehash: 53f416a23dbb47660097c41ada09c8c135434bcb
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "96743655"
---
# <a name="how-does-self-service-password-reset-writeback-work-in-azure-active-directory"></a>Как работает самостоятельная обратная запись паролей в Azure Active Directory?

Самостоятельный сброс пароля (SSPR) Azure Active Directory (Azure AD) позволяет пользователям сбрасывать пароли в облаке, но в большинстве компаний также есть локальная среда доменных служб Active Directory (AD DS), в которой работают пользователи. Обратная запись паролей — это функция на основе [Azure AD Connect](../hybrid/whatis-hybrid-identity.md), позволяющая записывать изменения паролей, внесенные в облаке, в имеющийся локальный каталог в режиме реального времени. В такой конфигурации, когда пользователи изменяют или сбрасывают свои пароли с помощью SSPR в облаке, обновленные пароли также записываются обратно в локальную среду AD DS.

> [!IMPORTANT]
> В этой статье объясняется, как работает функция обратной записи паролей самостоятельного сброса пароля. Если вы обычный пользователь, для вас разрешен самостоятельный сброс пароля и вы хотите восстановить доступ к учетной записи, перейдите на страницу https://aka.ms/sspr.
>
> Если ваша группа ИТ пока не включила возможность самостоятельно сбрасывать пароль, обратитесь за помощью в службу поддержки.

Обратная запись паролей поддерживается в средах, использующих следующие гибридные модели идентификации.

* [Синхронизации хэша паролей](../hybrid/how-to-connect-password-hash-synchronization.md)
* [Сквозная проверка подлинности](../hybrid/how-to-connect-pta.md)
* [Active Directory Federation Services](../hybrid/how-to-connect-fed-management.md) (Службы федерации Active Directory)

Компонент обратной записи паролей предоставляет следующие возможности:

* **Принудительное применение политик паролей локальной доменной службы Active Directory (AD DS)** . Когда пользователь сбрасывает свой пароль, перед его фиксацией в соответствующем каталоге выполняется проверка соблюдения политики локальной службы AD DS. Проверяется журнал, сложность, срок пользования, фильтры паролей и любые другие ограничения паролей, заданные в AD DS.
* **Обратная связь с нулевой задержкой**.  Обратная запись паролей выполняется в синхронном режиме. Пользователи немедленно получают уведомление, если их пароль не соответствует политике или его не удалось сбросить или изменить по какой-либо причине.
* **Поддерживает смену паролей на панели доступа и Microsoft 365**: когда для федеративных пользователей или синхронизированных с хэшированием паролей пользователя приходится изменять пароли с истекшим сроком действия или без их истечения, эти пароли записываются обратно в AD DS.
* **Поддержка компонента обратной записи паролей при их сбросе администратором на портале Azure**. Когда администратор сбрасывает пароль пользователя на [портале Azure](https://portal.azure.com), если этот пользователь является федеративным или для него включена синхронизация хэшей паролей, пароль записывается обратно в локальную среду. В настоящее время эта функциональная возможность не поддерживается на портале администрирования Office.
* **Не требуется никаких правил брандмауэра для входящего трафика**. Компонент обратной записи паролей использует ретранслятор служебной шины Azure в качестве базового коммуникационного канала. Весь обмен данными является исходящим и осуществляется через порт 443.

> [!NOTE]
> Обратная запись паролей не поддерживается для учетных записей администраторов в защищенных группах в локальной службе Active Directory. Администраторы могут изменять свой пароль в облаке, но не могут использовать сброс пароля для сброса забытого пароля. Дополнительные сведения о защищенных группах см. [в разделе защищенные учетные записи и группы в AD DS](/windows-server/identity/ad-ds/plan/security-best-practices/appendix-c--protected-accounts-and-groups-in-active-directory).

Чтобы приступить к работе с обратной записью SSPR, ознакомьтесь со следующим руководством.

> [!div class="nextstepaction"]
> [Руководство. Включение обратной записи при самостоятельном сбросе пароля (SSPR)](./tutorial-enable-sspr-writeback.md)

## <a name="how-password-writeback-works"></a>Как работает обратная запись паролей

При попытке сброса или смены пароля в облаке федеративным пользователем или пользователем с синхронизацией хэшей паролей происходит следующее.

1. Проверяется установленный у пользователя тип пароля. Если пароль управляется локально:
   * Проверяется, работает ли служба обратной записи. Если это так, пользователь может продолжить операцию.
   * Если служба обратной записи отключена, пользователю сообщается о том, что сейчас невозможно сбросить пароль.
1. Затем пользователь проходит соответствующие этапы аутентификации и переходит на страницу **Сброс пароля**.
1. Пользователь выбирает новый пароль и подтверждает его.
1. После нажатия пользователем кнопки **Отправить** указанный в виде простого текста пароль шифруется с помощью симметричного ключа, который был создан в процессе установки компонента обратной записи.
1. Зашифрованный пароль добавляется в полезные данные, которые передаются по каналу HTTPS на ретранслятор служебной шины для определенного клиента (который был также настроен в процессе установки компонента обратной записи). Этот ретранслятор защищается случайно генерируемым паролем, который известен только локальной установленной системе.
1. После того как сообщение достигает служебной шины, конечная точка сброса пароля автоматически активируется и обнаруживает ожидающий запрос на сброс.
1. Затем служба выполняет поиск пользователя с помощью атрибута привязки облака. Для успешного поиска должны быть выполнены следующие условия.

   * Объект пользователя должен существовать в пространстве соединителя AD DS.
   * Объект пользователя должен быть связан с соответствующим объектом метавселенной (MV).
   * Объект пользователя должен быть связан с соответствующим объектом соединителя Azure AD.
   * Ссылка из объекта соединителя AD DS в MV должна иметь правило синхронизации `Microsoft.InfromADUserAccountEnabled.xxx` по ссылке.

   Когда вызов поступает из облака, обработчик синхронизации использует атрибут **cloudAnchor** для поиска объекта пространства СОЕДИНИТЕЛЯ Azure AD. Затем он выполняет обратную ссылку к объекту MV, а затем снова выполняет ссылку на объект AD DS. Так как для одного пользователя может существовать несколько AD DS объектов (несколько лесов), модуль синхронизации использует `Microsoft.InfromADUserAccountEnabled.xxx` ссылку, чтобы выбрать правильный.

1. После того как учетная запись пользователя будет найдена, выполняется попытка сбросить пароль непосредственно в соответствующем AD DS лесе.
1. Если операция установки пароля прошла успешно, пользователь уведомляется о том, что его пароль изменен.

   > [!NOTE]
   > Если хэш пароля пользователя синхронизирован с Azure AD с помощью функции синхронизации хэшей паролей, то существует вероятность, что локальная политика паролей не такая строгая, как облачная. В этом случае применяется локальная политика. Благодаря этому ваша локальная политика применяется в облаке независимо от того, обеспечиваете ли вы единый вход с помощью синхронизации хэшей паролей или федерации.

1. В случае сбоя операции установки пароля отображается сообщение об ошибки и пользователю предлагается повторить попытку. Сбой может произойти по следующим причинам.
    * Служба была отключена.
    * Выбранный пароль не соответствует политикам организации.
    * Не удалось найти пользователя в локальной среде AD DS.

   Сообщения об ошибках содержат рекомендации для пользователей, с помощью которых они могут попытаться устранить проблему без помощи администратора.

## <a name="password-writeback-security"></a>Безопасность компонента обратной записи паролей

Обратная запись паролей — это служба с высоким уровнем безопасности. Для защиты информации реализуется четырехуровневая модель безопасности, описанная ниже.

* **Ретранслятор служебной шины для определенного клиента**
   * При настройке службы настраивается ретранслятор служебной шины для определенного клиента, который защищается случайно генерируемым надежным паролем. У корпорации Майкрософт нет доступа к этому паролю.
* **Заблокированный криптографически надежный ключ шифрования пароля**
   * После создания ретранслятора служебной шины создается надежный симметричный ключ, который используется для шифрования пароля при передаче по сети. Этот ключ существует только в секретном хранилище компании в облаке, которое тщательно блокируется и контролируется, подобно любому паролю в каталоге.
* **Отраслевой стандартный протокол TLS**
   1. При выполнении сброса или изменения пароля в облаке пароль в виде простого текста шифруется с помощью вашего открытого ключа.
   1. Затем зашифрованный пароль вставляется в сообщение HTTPS, которое передается по зашифрованному каналу с использованием TLS/SSL-сертификатов Майкрософт на ваш ретранслятор служебной шины.
   1. После поступления сообщения в служебную шину ваш локальный агент активируется и проходит аутентификацию в служебной шине с использованием ранее созданного надежного пароля.
   1. Локальный агент извлекает зашифрованное сообщение и расшифровывает его с помощью закрытого ключа.
   1. Затем локальный агент пытается установить пароль через интерфейс AD DS SetPassword API. Этот шаг позволяет принудительно применить локальную политику паролей AD DS (например, сложность, возраст, журнал и фильтры) в облаке.
* **Политики срока действия сообщений**
   * Если по какой-либо причине сообщение задержится в служебной шине из-за неработающей локальной службы, срок его ожидания истечет и оно будет удалено через несколько минут. Время ожидания и удаление сообщения повышают безопасность.

### <a name="password-writeback-encryption-details"></a>Сведения о шифровании компонента обратной записи паролей

После того, как пользователь отправит пароль, запрос на сброс пройдет несколько этапов шифрования, прежде чем поступит в вашу локальную среду. Эти этапы шифрования обеспечивают максимальную надежность и безопасность службы. Они описаны ниже.

1. **Шифрование пароля с использованием 2048-разрядного ключа RSA**. Когда пользователь отправляет пароль для обратной записи в локальную среду, сначала этот пароль шифруется с использованием 2048-разрядного ключа RSA.
1. **Шифрование на уровне пакета с использованием алгоритма AES-GCM**. Весь пакет (пароль и необходимые метаданные) шифруется с использованием алгоритма AES-GCM. Такое шифрование предотвращает просмотр и изменение содержимого с помощью прямого доступа к основному каналу служебной шины.
1. **Все взаимодействие осуществляется через TLS/SSL**: все взаимодействие с служебной шиной происходит в канале SSL/TLS. Это позволяет защитить содержимое от несанкционированного стороннего доступа.
1. **Автоматическая смена ключей каждые шесть месяцев**: все ключи переносятся каждые шесть месяцев или каждый раз, когда компонент обратной записи паролей отключается, а затем повторно включается на Azure AD Connect, чтобы обеспечить максимальную безопасность и защиту службы.

### <a name="password-writeback-bandwidth-usage"></a>Использование пропускной способности компонента обратной записи паролей

Компонент обратной записи паролей — это служба с низкой пропускной способностью, которая отправляет запросы в локальный агент только при следующих условиях:

* Два сообщения отправляются при включении или отключении компонента с помощью Azure AD Connect.
* Одно сообщение отправляется каждые 5 минут как сигнал пульса службы, если служба запущена.
* Два сообщения отправляются при каждой отправке нового пароля.
   * Первое сообщение является запросом на выполнение операции.
   * Второе сообщение содержит результат этой операции и отправляется в следующих случаях:
      * Во время каждой отправки нового пароля при самостоятельном сбросе пароля пользователем.
      * Во время каждой отправки нового пароля в ходе операции по смене пароля пользователя.
      * Во время каждой отправки нового пароля при сбросе пароля, инициированном администратором (только на портале администрирования Azure).

#### <a name="message-size-and-bandwidth-considerations"></a>Рекомендации по размеру сообщений и пропускной способности

Размер каждого сообщения, описанного выше, как правило, не превышает 1 КБ. Даже при экстремальных нагрузках служба обратной записи паролей будет потреблять несколько килобитов в секунду. Так как каждое сообщение отправляется в режиме реального времени, только если этого требует операция обновления пароля, и размер сообщения невелик, потребляемая компонентом обратной записи пропускная способность будет слишком незначительна, чтобы оказывать заметное влияние.

## <a name="supported-writeback-operations"></a>Поддерживаемые операции обратной записи

Обратная запись паролей осуществляется во всех следующих ситуациях:

* **Поддерживаемые операции пользователей:**
   * все самостоятельные добровольные операции изменения пароля конечного пользователя;
   * все самостоятельные принудительные операции изменения пароля пользователя (например, из-за окончания срока действия пароля);
   * все самостоятельные операции сброса пароля пользователя, выполняемые на [портале сброса паролей](https://passwordreset.microsoftonline.com).

* **Поддерживаемые операции администрирования:**
   * все самостоятельные добровольные операции изменения пароля администратора;
   * все самостоятельные принудительные операции изменения пароля администратора (например, из-за окончания срока действия пароля);
   * все самостоятельные операции сброса пароля администратора, выполняемые на [портале сброса пароля](https://passwordreset.microsoftonline.com);
   * все операции сброса пароля конечного пользователя, инициируемые администратором на [портале Azure](https://portal.azure.com);
   * все операции сброса пароля конечного пользователя, инициируемые администратором через [API Microsoft Graph (бета-версия)](/graph/api/passwordauthenticationmethod-resetpassword?tabs=http&view=graph-rest-beta).

## <a name="unsupported-writeback-operations"></a>Неподдерживаемые операции обратной записи

Обратная запись паролей не осуществляется во всех следующих ситуациях:

* **Неподдерживаемые операции пользователей:**
   * все операции сброса пароля пользователя с помощью PowerShell версии 1, PowerShell версии 2 или API Microsoft Graph.
* **Неподдерживаемые операции администрирования:**
   * все операции сброса пароля пользователя, инициируемые администратором с помощью PowerShell версии 1 и версии 2 или API Microsoft Graph (поддерживается [бета-версия API Microsoft Graph](/graph/api/passwordauthenticationmethod-resetpassword?tabs=http&view=graph-rest-beta)).
   * все операции сброса пароля конечного пользователя, инициируемые администратором из [центра администрирования Microsoft 365](https://admin.microsoft.com).
   * Никакой администратор не может использовать средство сброса пароля, чтобы сбросить свой пароль для обратной записи.

> [!WARNING]
> Использование флажка "Пользователь должен сменить пароль при следующем входе в систему" в локальных средствах администрирования AD DS, таких как "Active Directory пользователи и компьютеры" и "Центр администрирования Active Directory", поддерживается в качестве предварительной версии функции Azure AD Connect. Дополнительные сведения см. в статье о [реализации синхронизации хэша паролей с помощью службы синхронизации Azure AD Connect](../hybrid/how-to-connect-password-hash-synchronization.md).

## <a name="next-steps"></a>Дальнейшие действия

Чтобы приступить к работе с обратной записью SSPR, ознакомьтесь со следующим руководством.

> [!div class="nextstepaction"]
> [Руководство. Включение обратной записи при самостоятельном сбросе пароля (SSPR)](./tutorial-enable-sspr-writeback.md)