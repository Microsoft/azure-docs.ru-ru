---
title: Предоставление пользователям B2B доступа к локальным приложениям в Azure AD
description: Здесь показано, как предоставить облачным пользователям B2B доступ к локальным приложениям с помощью службы совместной работы Azure AD B2B.
services: active-directory
ms.service: active-directory
ms.subservice: B2B
ms.topic: how-to
ms.date: 10/30/2020
ms.author: mimart
author: msmimart
manager: celestedg
ms.reviewer: mal
ms.collection: M365-identity-device-management
ms.openlocfilehash: cd91d1d2c9f5a4a413f9ea64cfdef649823d0f09
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "93131026"
---
# <a name="grant-b2b-users-in-azure-ad-access-to-your-on-premises-applications"></a>Предоставление пользователям B2B в Azure AD доступа к локальным приложениям

Теперь организации, использующие возможности совместной работы в Azure Active Directory (AAD) B2B для приглашения гостевых пользователей из партнерских организаций в AAD, могут предоставлять таким пользователям B2B доступ к локальным приложениям. В таких приложениях нужно использовать аутентификацию на основе SAML или встроенную проверку подлинности Windows (IWA) с ограниченным делегированием Kerberos (KCD).

## <a name="access-to-saml-apps"></a>Доступ к приложениям SAML

Если ваше локальное приложение использует аутентификацию на основе SAML, вы легко можете с помощью портала Azure предоставить к ним доступ пользователям службы совместной работы AAD B2B.

Выполните два следующих действия.

- Интегрируйте приложение с помощью SAML, как описано в разделе [Настройка единого входа на основе SAML](../manage-apps/configure-saml-single-sign-on.md). Обязательно запишите значение, которое вы используете для параметра **URL-адрес входа**.
-  С помощью AD Application Proxy опубликуйте локальное приложение и укажите для него источник аутентификации **Azure Active Directory**. Этот процесс описан в статье [Публикация приложений с помощью Azure Active Directory Application Proxy](../manage-apps/application-proxy-add-on-premises-application.md). 

   При настройке **внутреннего URL-адреса** введите URL-адрес входа, указанный ранее в шаблоне приложения, не включенного в коллекцию. Это позволит сторонним пользователям обращаться к этому приложению. Прокси приложения реализует функции единого входа SAML для локального приложения.
 
   ![Параметры внутреннего URL-адреса приложения и аутентификации для локального приложения](media/hybrid-cloud-to-on-premises/OnPremAppSettings.PNG)

## <a name="access-to-iwa-and-kcd-apps"></a>Доступ к приложениям IWA и KCD

Чтобы предоставить пользователям B2B доступ к локальным приложениям, защищенным с помощью встроенной проверки подлинности Windows и ограниченного делегирования Kerberos, требуются следующие компоненты:

- **Аутентификация через Azure Active Directory Application Proxy**. Возможность аутентификации пользователей B2B в локальном приложении. Чтобы предоставить эту возможность, локальное приложение следует опубликовать через AD Application Proxy. Дополнительные сведения см. [в разделе Учебник. Добавление локального приложения для удаленного доступа через прокси приложения](../manage-apps/application-proxy-add-on-premises-application.md).
- **Авторизация через объект пользователя B2B в локальном каталоге**. Приложение должно иметь возможность проверять права пользователей и правильно предоставлять им доступ к ресурсам. Встроенная проверка подлинности Windows и ограниченное делегирование Kerberos требуют наличия объекта пользователя в локальном каталоге Active Directory на Windows Server. Как описано в разделе [Принцип работы единого входа с применением KCD](../manage-apps/application-proxy-configure-single-sign-on-with-kcd.md#how-single-sign-on-with-kcd-works), прокси приложения использует этот объект пользователя для олицетворения пользователя и получения маркера Kerberos для приложения. 

   > [!NOTE]
   > При настройке AD Application Proxy Azure убедитесь, что для **удостоверения делегированного входа** задано **имя участника-пользователя** (по умолчанию) в конфигурации единого входа для встроенной проверки подлинности Windows (IWA).

   При работе с пользователями B2B вы можете использовать два метода создания объектов для гостевых пользователей, которым нужна авторизации в локальном каталоге.

   - Microsoft Identity Manager (MIM) и агент управления MIM для Microsoft Graph. 
   - [Скрипт PowerShell](#create-b2b-guest-user-objects-through-a-script-preview). Решение на основе сценария проще в реализации и не требует наличия MIM. 

Ниже представлена обобщенная схема совместной работы AD Application Proxy и создания объекта пользователя B2B в локальном каталоге для предоставления пользователям B2B доступа к локальным приложениям на основе IWA и KCD. Порядок шагов описан на схеме ниже.

![Схема решений на основе MIM и скрипта B2B](media/hybrid-cloud-to-on-premises/MIMScriptSolution.PNG)

1.  В клиент Contoso приглашается пользователь из партнерской организации (из клиента Fabrikam).
2.  В клиенте Contoso создается объект гостевого пользователя (например, объект пользователя с именем участника-пользователя guest_fabrikam.com#EXT#@contoso.onmicrosoft.com).
3.  Гость Fabrikam импортируется из Contoso через MIM или с помощью скрипта B2B PowerShell.
4.  В локальном каталоге Contoso.com с помощью MIM или скрипта B2B PowerShell создается представление объекта гостевого пользователя Fabrikam (Guest#EXT#).
5.  Гостевой пользователь обращается к локальному приложению app.contoso.com.
6.  Запрос на аутентификацию подтверждается через прокси приложения с применением ограниченного делегирования Kerberos. 
7.  Так как гостевой пользователь существует в локальной среде, аутентификация происходит успешно.

### <a name="lifecycle-management-policies"></a>Политики управления жизненным циклом

Вы можете управлять локальными объектами пользователей B2B с помощью политик управления жизненным циклом. Пример:

- Вы можете настроить для гостевого пользователя политику многофакторной проверки подлинности (MFA), чтобы она обязательно использовалась при аутентификации через прокси приложений. Дополнительные сведения см. в статье [Условный доступ для пользователей службы совместной работы B2B](conditional-access.md).
- К локальным пользователям применяются любые правила спонсорства, проверки доступа, проверки учетных записей и пр., которые определены для облачного пользователя B2B. Например, если пользователь облака удаляется через политики управления жизненным циклом, локальный пользователь также удаляется с помощью синхронизации MIM или синхронизации Azure AD Connect. Дополнительные сведения см. в статье [Управление гостевым доступом с помощью проверок доступа Azure AD](../governance/manage-guest-access-with-access-reviews.md).

### <a name="create-b2b-guest-user-objects-through-mim"></a>Создание объектов гостевых пользователей B2B через MIM

Сведения о том, как с помощью пакета обновления 1 для MIM 2016 и агента управления MIM для Microsoft Graph создавать объекты гостевых пользователей в локальном каталоге, см. в статье [Совместная работа Azure Active Directory B2B с Microsoft Identity Manager (MIM) 2016 с пакетом обновления 1 (SP1) и Azure Active Directory Application Proxy](/microsoft-identity-manager/microsoft-identity-manager-2016-graph-b2b-scenario).

### <a name="create-b2b-guest-user-objects-through-a-script-preview"></a>Создание объектов гостевых пользователей B2B через скрипт (предварительная версия)

Мы предлагаем вам пример скрипта PowerShell, на основе которого вы можете разработать свой механизм для создания объектов гостевых пользователей в локальной службе Active Directory.

Вы можете скачать сценарий и файл сведений из [соединителей для Microsoft Identity Manager 2016 и Forefront Identity Manager 2010 R2](https://www.microsoft.com/download/details.aspx?id=51495). В загружаемом пакете выберите **Скрипт и файл сведений для извлечения пользователей Azure AD B2B on-prem.zip** файле.

Прежде чем запускать этот скрипт, обязательно проверьте предварительные требования и изучите важные рекомендации, перечисленные в README-файле. Не забывайте, что этот скрипт предлагается только в качестве примера. Перед запуском скрипта команда разработчиков вашей и (или) партнерской организации должна настроить и проверить его.

## <a name="license-considerations"></a>Рекомендации по лицензированию

Убедитесь, что вы правильно настроили клиентские лицензии (CAL) для внешних гостевых пользователей, которые обращаются к локальным приложениям. Дополнительные сведения см. в разделе "Лицензии External Connector" статьи [Клиентские лицензии и лицензии на управление](https://www.microsoft.com/licensing/product-licensing/client-access-license.aspx). Конкретные требования к лицензированию вы можете обсудить с представителем Microsoft или локальным торговым посредником.

## <a name="next-steps"></a>Дальнейшие действия

- [Служба совместной работы Azure Active Directory B2B для гибридных организаций](hybrid-organizations.md)

- Общие сведения об Azure AD Connect см. в статье [Интеграция локальных каталогов с Azure Active Directory](../hybrid/whatis-hybrid-identity.md).