---
title: Руководство по развертыванию FortiGate | Документация Майкрософт
description: Настройка и использование брандмауэра Fortinet FortiGate следующего поколения.
services: active-directory
author: jeevansd
manager: CelesteDG
ms.reviewer: celested
ms.service: active-directory
ms.subservice: saas-app-tutorial
ms.workload: identity
ms.topic: tutorial
ms.date: 10/30/2020
ms.author: jeedes
ms.openlocfilehash: cdaa6a9601452100ab90ef8b0f2191002f256b74
ms.sourcegitcommit: f28ebb95ae9aaaff3f87d8388a09b41e0b3445b5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/29/2021
ms.locfileid: "95025527"
---
# <a name="fortigate-azure-virtual-machine-deployment-guide"></a>Руководство по развертыванию виртуальных машин Azure в FortiGate

С помощью этого учебника по развертыванию вы узнаете, как настроить и использовать брандмауэр следующего поколения Fortinet FortiGate, развернутый в виртуальной машине Azure. Кроме того, здесь рассматривается настройка приложения коллекции FortiGate SSL VPN Azure AD для обеспечения проверки подлинности VPN с помощью Azure Active Directory.

## <a name="redeem-the-fortigate-license"></a>Активация лицензии FortiGate

Брандмауэр следующего поколения Fortinet FortiGate доступен в виде виртуальной машины в инфраструктуре как услуге (IaaS) Azure. Для этой виртуальной машины существует два режима лицензирования: с оплатой по мере использования и с использованием собственной лицензии (BYOL).

Если вы приобрели лицензию на FortiGate у компании Fortinet для использования при развертывании виртуальной машины с собственной лицензией, используйте ее на странице активации продукта Fortinet — https://support.fortinet.com. Полученный файл лицензии будет иметь расширение LIC.

## <a name="download-firmware"></a>Скачивание встроенного ПО

На момент написания статьи виртуальная машина Azure Fortinet FortiGate не поставляется с версией встроенного ПО, необходимой для проверки подлинности SAML. Последняя версия должна быть получена из Fortinet.

1. Выполните вход на странице https://support.fortinet.com/.
2. Последовательно выберите **Download** > **Firmware Images** (Загрузить > Образы встроенного ПО).
3. Справа от **Release Notes** (Заметки о выпуске) выберите **Download** (Скачать).
4. Выберите версии **6.00** > **6.4** > **6.4.2**.
5. Скачайте **FGT_VM64_AZURE-v6-build1723-FORTINET.out**, выбрав ссылку **HTTPS** в той же строке.
6. Сохраните файл для последующего использования.

## <a name="deploy-the-fortigate-vm"></a>Развертывание FortiGate VM

1. Перейдите на портал Azure и войдите в подписку, в которой будет развернута виртуальная машина FortiGate.
2. Создайте или откройте группу ресурсов, в которой вы хотите развернуть виртуальную машину FortiGate.
3. Нажмите **Добавить**.
4. В поле **Search the Marketplace** (Поиск в Marketplace), введите *Forti*. Выберите **Fortinet FortiGate Next-Generation Firewall** (Брандмауэр Fortinet FortiGate следующего поколения).
5. Выберите план программного обеспечения (с использованием собственной лицензии, если она есть, или с оплатой по мере использования в случае ее отсутствия). Выберите **Создать**.
6. Заполните конфигурацию виртуальной машины.

    ![Снимок экрана, демонстрирующий создание виртуальной машины.](virtual-machine.png)

7. Задайте для параметра **Authentication type** (Тип аутентификации) значение **Password** (Пароль) и укажите учетные данные администратора для виртуальной машины.
8. Выберите **Просмотреть и создать** > **Создать**.
9. Дождитесь завершения развертывания виртуальной машины.


### <a name="set-a-static-public-ip-address-and-assign-a-fully-qualified-domain-name"></a>Установка статического общедоступного IP-адреса и назначение полного доменного имени

Чтобы обеспечить единообразное взаимодействие с пользователем, установите общедоступный IP-адрес, назначенный виртуальной машине FortiGate статически. Кроме того, сопоставьте его с полным доменным именем (FQDN).

1. Перейдите на портал Azure и откройте параметры виртуальной машины FortiGate.
2. На экране **Overview** (Обзор) выберите общедоступный IP-адрес.

    ![Снимок экрана настроек VPN для подключения к FortiGate через SSL.](public-ip-address.png)

3. Выберите **Static** > **Save** (Статический > Сохранить).

Если вы владеете общедоступным доменным именем с маршрутизацией для среды, в которой развертывается виртуальная машина FortiGate, создайте запись узла (A) для виртуальной машины. Эта запись сопоставляется с общедоступным IP-адресом статически.

### <a name="create-a-new-inbound-network-security-group-rule-for-tcp-port-8443"></a>Создание входящего правила группы безопасности сети для TCP-порта 8443

1. Перейдите на портал Azure и откройте параметры виртуальной машины FortiGate.
2. В меню слева выберите **Сеть**. Будет показан список с сетевым интерфейсом, а также правила входящих портов.
3. Выберите **Добавить правило входящего порта**.
4. Создайте правило входящего порта для TCP 8443.

    ![Снимок экрана, на котором показано добавление правила безопасности для входящего порта.](port-rule.png)

5. Нажмите **Добавить**.

## <a name="create-a-second-virtual-nic-for-the-vm"></a>Создание второго виртуального сетевого адаптера для виртуальной машины

Чтобы сделать доступными для пользователей внутренние ресурсы, необходимо добавить второй виртуальный сетевой адаптер в виртуальную машину FortiGate. Виртуальная сеть в Azure, в которой находится виртуальный сетевой адаптер, должна иметь подключение с возможностью маршрутизации к этим внутренним ресурсам.

1. Перейдите на портал Azure и откройте параметры виртуальной машины FortiGate.
2. Если виртуальная машина FortiGate еще не остановлена, выберите команду **Остановить** и дождитесь завершения работы виртуальной машины.
3. В меню слева выберите **Сеть**.
4. Выберите **Подключить сетевой интерфейс**.
5. Выберите команду **Create and attach network interface** (Создать и присоединить сетевой интерфейс).
6. Настройте свойства нового сетевого интерфейса, а затем выберите команду **Создать**.

    ![Снимок экрана создания сетевого интерфейса.](new-network-interface.png)

7. Запустите виртуальную машину FortiGate.


## <a name="configure-the-fortigate-vm"></a>Настройка FortiGate VM

В следующих разделах описано, как настроить виртуальную машину FortiGate.

### <a name="install-the-license"></a>Установка лицензии

1. Перейдите по адресу `https://<address>`. Здесь `<address>` — это полное доменное имя или общедоступный IP-адрес, назначенный виртуальной машине FortiGate.

2. Пропустите все ошибки сертификата.
3. Войдите с использованием учетных данных администратора, предоставленных при развертывании виртуальной машины FortiGate.
4. Если в развертывании используется модель с собственной лицензией, вы увидите запрос на ее отправку. Выберите созданный ранее файл лицензии и отправьте его. Нажмите **ОК** и перезапустите виртуальную машину FortiGate.

    ![Снимок экрана с лицензией для виртуальной машины FortiGate.](license.png)

5. После перезагрузки опять войдите в систему с учетными данными администратора, чтобы проверить лицензию.

### <a name="update-firmware"></a>Обновление встроенного ПО

1. Перейдите по адресу `https://<address>`. Здесь `<address>` — это полное доменное имя или общедоступный IP-адрес, назначенный виртуальной машине FortiGate.

2. Пропустите все ошибки сертификата.
3. Войдите с использованием учетных данных администратора, предоставленных при развертывании виртуальной машины FortiGate.
4. В меню слева выберите **System** > **Firmware** (Система > Встроенное ПО).
5. На странице **Firmware Management** (Управление встроенным ПО) нажмите **Browse** (Обзор) и выберите скачанный ранее файл встроенного ПО.
6. Игнорируйте предупреждение и выберите **Backup config and upgrade** (Резервное копирование конфигурации и обновление).

    ![Снимок экрана страницы управления встроенным ПО.](backup-configure-upgrade.png)

7. Выберите **Continue** (Продолжить).
8. При появлении запроса на сохранение конфигурации FortiGate (в формате файла CONF) нажмите кнопку **Save** (Сохранить).
9. Дождитесь отправки и применения встроенного ПО. Дождитесь перезагрузки виртуальной машины FortiGate.
10. После перезагрузки виртуальной машины FortiGate опять войдите в систему с учетными данными администратора.
11. Когда появится запрос на настройку панели мониторинга, выберите **Later** (Позже).
12. После запуска учебного видео нажмите кнопку **ОК**.

### <a name="change-the-management-port-to-tcp-8443"></a>Изменение порта управления на TCP 8443

1. Перейдите по адресу `https://<address>`. Здесь `<address>` — это полное доменное имя или общедоступный IP-адрес, назначенный виртуальной машине FortiGate.

2. Пропустите все ошибки сертификата.
3. Войдите с использованием учетных данных администратора, предоставленных при развертывании виртуальной машины FortiGate.
4. В меню слева выберите **System** (Система).
5. В разделе **Administration Settings** (Параметры администрирования) измените HTTPS-порт на **8443** и нажмите **Apply**.
6. После применения изменения браузер попытается перезагрузить страницу администрирования, но произойдет сбой. С этого момента адресом страницы администрирования будет `https://<address>:8443`.

    ![Снимок экрана, демонстрирующий отправку удаленного сертификата.](certificate.png)

### <a name="upload-the-azure-ad-saml-signing-certificate"></a>Отправка сертификата для подписи SAML в Azure AD

1. Перейдите по адресу `https://<address>:8443`. Здесь `<address>` — это полное доменное имя или общедоступный IP-адрес, назначенный виртуальной машине FortiGate.

2. Пропустите все ошибки сертификата.
3. Войдите с использованием учетных данных администратора, предоставленных при развертывании виртуальной машины FortiGate.
4. В меню слева выберите **System** > **Certificates** (Система > Сертификаты).
5. Выберите **Импорт** > **Remote Certificate** (Удаленный сертификат).
6. Перейдите к сертификату, скачанному из развертывания пользовательского приложения FortiGate в клиенте Azure. Выберите его и нажмите кнопку **ОК**.

### <a name="upload-and-configure-a-custom-ssl-certificate"></a>Отправка и настройка пользовательского SSL-сертификата

При необходимости можно настроить виртуальную машину FortiGate с помощью собственного SSL-сертификата, который поддерживает используемое полное доменное имя. Если у вас есть доступ к SSL-сертификату, упакованному с помощью закрытого ключа в формат PFX, то его можно использоваться для этой цели.

1. Перейдите по адресу `https://<address>:8443`. Здесь `<address>` — это полное доменное имя или общедоступный IP-адрес, назначенный виртуальной машине FortiGate.

2. Пропустите все ошибки сертификата.
3. Войдите с использованием учетных данных администратора, предоставленных при развертывании виртуальной машины FortiGate.
4. В меню слева выберите **System** > **Certificates** (Система > Сертификаты).
5. Выберите **Import** > **Local Certificate** > **PKCS #12 Certificate** (Импорт > Локальный сертификат >Сертификат PKCS #12).
6. Перейдите к PFX-файлу, содержащему SSL-сертификат и закрытый ключ.
7. Введите пароль к PFX-файлу и понятное имя для сертификата. Нажмите кнопку **ОК**.
8. В меню слева выберите **System** > **Settings** (Система > Параметры).
9. В разделе **Administration Settings** (Параметры администрирования) разверните список рядом с пунктом **HTTPS server certificate** (Сертификат сервера HTTPS) и выберите SSL-сертификат, импортированный ранее.
10. Нажмите кнопку **Применить**.
11. Закройте окно браузера и перейдите на страницу `https://<address>:8443`.
12. Для входа укажите учетные данные администратора FortiGate. Теперь должен использовать правильный SSL-сертификат.

### <a name="configure-authentication-timeout"></a>Настройка превышения времени ожидания аутентификации

1. Перейдите на портал Azure и откройте параметры виртуальной машины FortiGate.
2. В меню слева выберите **Последовательная консоль**.
3. Войдите в последовательную консоль с учетными данными администратора виртуальной машины FortiGate.
4. В последовательной консоли запустите выполнение таких команд:

    ```
    config system global
    set remoteauthtimeout 60
    end
    ```

### <a name="ensure-network-interfaces-are-obtaining-ip-addresses"></a>Убедитесь, что сетевые интерфейсы получают IP-адреса.

1. Перейдите по адресу `https://<address>:8443`. Здесь `<address>` — это полное доменное имя или общедоступный IP-адрес, назначенный виртуальной машине FortiGate.

2. Войдите с использованием учетных данных администратора, предоставленных при развертывании виртуальной машины FortiGate.
3. В меню слева выберите **Сеть**.
4. В разделе "Сеть" выберите **Интерфейсы**.
5. Изучите port1 (внешний интерфейс) и port2 (внутренний интерфейс), чтобы убедиться, что они получают IP-адреса из правильной подсети Azure.
    а. Если ни один из портов не получает IP-адрес из подсети (с помощью DHCP), щелкните порт правой кнопкой мыши и выберите **Изменить**.
    b. Для параметра "Режим адресации" убедитесь, что выбрано значение **DHCP**.
    c. Нажмите кнопку **OK**.

    ![Снимок экрана с адресацией сетевого интерфейса.](addressing.png)

### <a name="ensure-fortigate-vm-has-correct-route-to-on-premises-corporate-resources"></a>Убедитесь, что виртуальная машина FortiGate имеет правильный маршрут к локальным корпоративным ресурсам.

Виртуальные машины Azure с несколькими сетевыми интерфейсами содержат все сетевые интерфейсы в одной виртуальной сети (но, возможно, отдельные подсети). Это часто означает, что оба сетевых интерфейса имеют подключение к локальным корпоративным ресурсам, публикуемым через FortiGate. По этой причине необходимо создать пользовательские записи маршрутов, обеспечивающие движение трафика от правильного интерфейса при создании запросов к локальным корпоративным ресурсам.

1. Перейдите по адресу `https://<address>:8443`. Здесь `<address>` — это полное доменное имя или общедоступный IP-адрес, назначенный виртуальной машине FortiGate.

2. Войдите с использованием учетных данных администратора, предоставленных при развертывании виртуальной машины FortiGate.
3. В меню слева выберите **Сеть**.
4. В разделе "Сеть" выберите **Статические маршруты**.
5. Щелкните **Создать**.
6. Для параметра "Назначение" выберите **Подсеть**.
7. В разделе подсеть укажите сведения о подсети, в которой находятся локальные корпоративные ресурсы (например, 10.1.0.0/255.255.255.0).
8. Для параметра "Адрес шлюза" укажите шлюз в подсети Azure, к которой подключен интерфейс port2 (например, это обычно адрес, который заканчивается на 1, например 10.6.1.1).
9. Для параметра "Интерфейс" выберите внутренний сетевой интерфейс port2.
10. Щелкните **ОК**.

    ![Снимок экрана с настройкой маршрута.](route.png)

## <a name="configure-fortigate-ssl-vpn"></a>Настройка VPN для SSL в FortiGate

Выполните действия, описанные в разделе https://docs.microsoft.com/azure/active-directory/saas-apps/fortigate-ssl-vpn-tutorial
