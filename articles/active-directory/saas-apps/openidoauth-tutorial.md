---
title: Настройка приложения OpenID или OAuth из коллекции приложений Azure AD | Документация Майкрософт
description: Инструкции по настройке приложения OpenID или OAuth из коллекции приложений Azure AD
services: active-directory
author: jeevansd
manager: CelesteDG
ms.reviewer: celested
ms.service: active-directory
ms.subservice: saas-app-tutorial
ms.workload: identity
ms.topic: tutorial
ms.date: 05/30/2019
ms.author: jeedes
ms.custom: has-adal-ref
ms.openlocfilehash: 32f79f24df6fe705146b39750c710450ef8f1f7b
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "98735947"
---
# <a name="configure-an-openidoauth-application-from-the-azure-ad-app-gallery"></a>Настройка приложения OpenID или OAuth из коллекции приложений Azure AD

## <a name="process-of-adding-an-openid-application-from-the-gallery"></a>Добавление приложения OpenID из коллекции

1. На [портале Azure](https://portal.azure.com)выберите **Azure Active Directory**.

    ![Кнопка Azure Active Directory](common/select-azuread.png)

2. Выберите **Корпоративные приложения** > **Все приложения**.

    ![Колонка "Корпоративные приложения"](common/enterprise-applications.png)

3. В верхней части диалогового окна выберите **Создать приложение**.

    ![Кнопка "Создать приложение"](common/add-new-app.png)

4. В поле поиска введите имя приложения. Выберите нужное приложение на панели результатов и выполните его регистрацию.

    ![OpenID в списке результатов](common/search-new-app.png)


1. На странице с именем приложения нажмите кнопку **Зарегистрироваться**.

    ![Кнопка "Добавить"](./media/openidoauth-tutorial/addbutton.png)

    > [!NOTE]
    > Администратор клиента должен нажать кнопку "Регистрация" и дать согласие на регистрацию приложения. Затем приложение добавляется к клиенту пользователя, где выполняется конфигурация. Нет необходимости явно добавлять приложение.

5. Вы будете перенаправлены на страницу входа в приложение или на страницу Azure Active Directory (Azure AD) учетных данных для входа.

6. После успешной проверки подлинности дайте согласие на странице согласия. После этого откроется домашняя страница приложения.

    > [!NOTE]
    > Вы можете добавить только один экземпляр приложения. Если вы уже добавили экземпляр приложения и пытаетесь еще раз дать согласие, экземпляр не будет повторно добавлен в клиент. Поэтому можно использовать только один экземпляр приложения в клиенте.

1. Чтобы добавить приложение OpenID из коллекции, выполните инструкции из приведенного ниже видео.
    >[!VIDEO https://www.microsoft.com/videoplayer/embed/RE4HoNI]

## <a name="authentication-flow-using-openid-connect"></a>Поток проверки подлинности при использовании OpenID Connect

Наиболее простой процесс входа содержит следующие этапы.

![Поток проверки подлинности при использовании OpenID Connect](./media/openidoauth-tutorial/authenticationflow.png)

### <a name="multitenant-application"></a>Мультитенантное приложение
Мультитенантное приложение предназначено для использования не только в одной организации, а в нескольких. Как правило, это приложения категории "программное обеспечение как услуга" (SaaS), которые создают независимые поставщики программных продуктов (ISV).

Мультитенантные приложения должны быть подготовлены в каждом каталоге, где они будут использоваться. Для их регистрации требуется согласие пользователей или администраторов. Процесс предоставление разрешений начинается, когда приложение регистрируется в каталоге и получает доступ к API-интерфейсу Graph или, возможно, к другому веб-интерфейсу API. Когда пользователь или администратор из другой организации регистрируется для использования приложения, появляется диалоговое окно, в котором отображаются разрешения, необходимые для приложения.

Затем пользователь или администратор может предоставить согласие для приложения. Согласие дает приложению доступ к необходимым данным и регистрирует приложение в каталоге.

> [!NOTE]
> Если вы делаете свое приложение доступным для пользователей в нескольких каталогах, нужно предусмотреть механизм, который будет определять, членами какого арендатора они являются. Приложение с одним клиентом должно присутствовать только в собственном каталоге для пользователя. Мультитенантное приложение должно определить конкретного пользователя из всех каталогов в Azure AD.
>
> Для выполнения этой задачи система Azure AD предоставляет общую конечную точку проверки подлинности, в которую мультитенантное приложение может направлять запросы на вход, вместо конечной точки для конкретного клиента. Для всех каталогов в Azure AD эта конечная точка — `https://login.microsoftonline.com/common`. Конечной точкой для конкретного арендатора может быть `https://login.microsoftonline.com/contoso.onmicrosoft.com`.
>
> Общую конечную точку следует учитывать при разработке своего приложения. Вам понадобится специальная логика для обработки нескольких арендаторов во время входа, выхода и проверки маркеров.

Azure AD поддерживает мультитенантные приложения по умолчанию. Они легко доступные между организациями и простые в использовании после принятия согласия.

## <a name="consent-framework"></a>Платформа предоставления согласия

Платформа согласия Azure AD позволяет легко разрабатывать мультитенантные веб-приложения и собственные клиентские приложения. Эти приложения позволяют входить в учетные записи пользователей с клиентов Azure AD, отличных от того, где было зарегистрировано приложение. Им также может потребоваться доступ к веб-API, таким как:
- API Microsoft Graph, для доступа к Azure AD, Intune и службам Microsoft 365;
- других API служб Майкрософт;
- собственных веб-API.

Эта платформа использует согласие пользователя или администратора на регистрацию приложения в своем каталоге. Для регистрации может потребоваться доступ к данным каталога. После предоставления такого согласия клиентское приложение сможет вызывать API Microsoft Graph от имени этого пользователя и пользоваться сведениями по мере необходимости.

[API Microsoft Graph](https://developer.microsoft.com/graph/) предоставляет доступ к данным в Microsoft 365, например:

- календарям и сообщениям Exchange;
- сайтам и спискам SharePoint;
- документам в OneDrive;
- записным книжкам в OneNote;
- задачам Планировщика;
- книгам Excel.

API Graph также обеспечивает доступ для пользователей и групп из Azure AD и других объектов данных из нескольких облачных служб Майкрософт.

Ниже показаны особенности работы процедуры согласия для разработчика приложения и пользователя.

1. Предположим, у вас есть приложение веб-клиента, которому необходимо запросить конкретные разрешения для получения доступа к ресурсу или API. Портал Azure используется для объявления запросов на разрешения во время настройки. Как и другие параметры конфигурации, они становятся частью регистрации Azure AD приложения. Для получения пути запроса разрешений необходимо выполнить следующие действия:

    а. Щелкните **Регистрация приложений** в левой части меню и откройте приложение, введя его имя в поле поиска.

    ![Снимок экрана: пункт "Регистрация приложений", выбранные в меню слева, и выделенное поле поиска "Идентификатор приложения"](./media/openidoauth-tutorial/application.png)

    b. Щелкните **Просмотреть разрешения API**.

    ![Снимок экрана: страница "Вызов API" с выделенной кнопкой "Просмотреть разрешения API"](./media/openidoauth-tutorial/api-permission.png)

    c. Щелкните **Добавить разрешение**.

    ![Снимок экрана: раздел "Разрешения API" с выбранной кнопкой "Добавить разрешение"](./media/openidoauth-tutorial/add-permission.png)

    d. Щелкните **Microsoft Graph**.

    ![Снимок экрана: страница "Запрос разрешений API" с выделенной вкладкой "API Microsoft" и плиткой "Microsoft Graph"](./media/openidoauth-tutorial/microsoft-graph.png)

    д) Выберите необходимые параметры из списка **Делегированные разрешения** и **Разрешения приложения**.

    ![API Graph](./media/openidoauth-tutorial/graphapi.png)

2. Предположим, что разрешения приложения были обновлены. Само приложение запущено, а пользователь собирается воспользоваться им в первый раз. Сначала приложение должно получить код авторизации из Azure AD или конечной точки авторизации. Код авторизации можно использовать для получения новых маркеров доступа или обновления.

3. Если пользователь еще не выполнил проверку подлинности, Azure AD или конечная точка авторизации запросит данные для входа.

    ![Снимок экрана запроса на вход для учетной записи](./media/openidoauth-tutorial/authentication.png)

4. После входа Azure AD определяет, требуется ли отобразить этому пользователю страницу согласия. Это решение будет зависеть от того, предоставил ли этот пользователь (или администратор его организации) свое согласие для приложения.

   Если согласие еще не было дано, Azure AD запрашивает у пользователя согласие и отображает необходимые для этого разрешения. Разрешения, отображаемые в диалоговом окне согласия, соответствуют разрешениям, выбранным в делегированных разрешениях на портале Azure.

    ![Страница предоставления согласия](./media/openidoauth-tutorial/consentpage.png)

Обычный пользователь может дать согласие на некоторые разрешения. Для других разрешений требуется согласие администратора арендатора.

## <a name="difference-between-admin-consent-and-user-consent"></a>Разница между согласием администратора и согласием пользователя

Обладая правами администратора, вы можете также согласиться использовать делегированные разрешения приложения от имени всех пользователей в клиенте. Согласие администратора предотвращает появление диалогового окна согласия отдельно для каждого пользователя в клиенте. Пользователи, которым назначена роль администратора, могут предоставить согласие на портале Azure. На странице **Параметры** своего приложения выберите **Необходимые разрешения** > **Дать согласие администратора**.

![Кнопка "Предоставление разрешений"](./media/openidoauth-tutorial/grantpermission.png)

> [!NOTE]
> Для одностраничных приложений (SPA), использующих ADAL.js, сейчас требуется явным образом предоставить разрешение с помощью кнопки **Дать согласие администратора**. В противном случае происходит сбой приложения при запросе маркера доступа.

Для разрешений "только для приложения" всегда требуется согласие администратора арендатора. Если приложение запрашивает разрешение "только для приложения", и пользователь пытается войти в приложение, появится сообщение об ошибке. Это сообщение информирует о том, что пользователь не может предоставить согласие.

Если приложение использует разрешения, требующие согласия администратора, то в приложении должен быть элемент, такой как кнопка или ссылка, с помощью которого администратор может запустить действие. Запрос, отправляемый приложением для этого действия, является обычным запросом авторизации OAuth2 или OpenID Connect. Этот запрос содержит параметр строки запроса *prompt=admin_consent*.

Когда администратор предоставит свое согласие, а в арендаторе пользователя будет создан субъект-служба, в последующих запросах на вход не нужно будет указывать параметр *prompt=admin_consent*. После того как администратор решил, что запрошенные разрешения являются приемлемыми, у других пользователей клиента согласие запрашиваться не будет.

Администратор клиента может отключить возможность обычным пользователям предоставлять согласие для приложений. Если эта возможность отключена, то для использования приложения в клиенте всегда требуется согласие администратора. Чтобы протестировать приложение, в котором отключена возможность предоставления согласия для конечных пользователей, найдите соответствующий параметр на [портале Azure](https://portal.azure.com/). Перейдите к разделу [Параметры пользователя](https://portal.azure.com/#blade/Microsoft_AAD_IAM/StartboardApplicationsMenuBlade/UserSettings/menuId/) и выберите **Корпоративные приложения**.

Параметр *prompt=admin_consent* может использоваться приложениями, запрашивающими разрешения, которые не требуют согласия администратора. Примером может служить приложение, которое требует одноразовую регистрацию администратора арендатора. После этой регистрации согласие у других пользователей не запрашивается.

Представьте, что приложение требует согласия администратора, и администратор выполняет вход, но параметр *prompt=admin_consent* не передается. Когда администратор успешно предоставит приложению согласие, оно применяется только для своей учетной записи пользователя. Обычные пользователи по-прежнему не смогут выполнять вход и давать свое согласие приложению. Это удобно в тех случаях, когда администратору клиента нужно просмотреть приложение, прежде чем предоставлять доступ к приложению другим пользователям.

## <a name="next-steps"></a>Дальнейшие действия

[Настройка единого входа на основе OIDC для приложения в арендаторе Azure Active Directory (Azure AD)](../manage-apps/add-application-portal-setup-oidc-sso.md)