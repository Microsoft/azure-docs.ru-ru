---
title: Настройка групповых утверждений для приложений с Azure Active Directory | Документация Майкрософт
description: Сведения о том, как настроить утверждения группы для использования с Azure AD.
services: active-directory
documentationcenter: ''
ms.reviewer: paulgarn
manager: daveba
ms.subservice: hybrid
ms.service: active-directory
ms.workload: identity
ms.topic: how-to
ms.date: 02/27/2019
ms.author: billmath
author: billmath
ms.openlocfilehash: bef5942707c1ded22ba82bdb0d945b9fdb23fffa
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "96349356"
---
# <a name="configure-group-claims-for-applications-with-azure-active-directory"></a>Настройка групповых утверждений для приложений с Azure Active Directory

Azure Active Directory могут предоставить сведения о членстве в группах пользователей в маркерах для использования в приложениях.  Поддерживаются два основных шаблона:

- Группы, определяемые по атрибуту "идентификатор объекта Azure Active Directory (OID)"
- Группы, определяемые атрибутами sAMAccountName или Граупсид для синхронизированных групп и пользователей Active Directory (AD)

> [!IMPORTANT]
> Существует ряд предостережений, которые следует учитывать при работе с этой функцией:
>
>- Поддержка использования атрибутов sAMAccountName и идентификатора безопасности (SID), синхронизированных из локальной среды, предназначена для перемещения существующих приложений из AD FS и других поставщиков удостоверений. Группы, управляемые в Azure AD, не содержат атрибуты, необходимые для выпуска этих утверждений.
>- В крупных организациях число групп, членом которых является пользователь, может превысить ограничение, Azure Active Directory будет добавляться в маркер. 150. группы для токена SAML и 200 для JWT. Это может привести к непредсказуемым результатам. Если пользователи имеют большое количество членств в группах, рекомендуется использовать параметр, чтобы ограничить группы, созданные в заявках, соответствующими группами для приложения.  
>- При разработке новых приложений или в случаях, когда приложение может быть настроено для этого, а также когда поддержка вложенных групп не требуется, рекомендуется, чтобы авторизация в приложении основывалась на ролях приложений, а не на группах.  Это ограничивает объем информации, которую необходимо переключиться на маркер, является более безопасным и отделяет назначение пользователей от конфигурации приложения.

## <a name="group-claims-for-applications-migrating-from-ad-fs-and-other-identity-providers"></a>Групповые утверждения для приложений, выполняющих миграцию с AD FS и других поставщиков удостоверений

Многие приложения, настроенные для проверки подлинности с AD FS, используют сведения о членстве в группах в форме атрибутов группы Windows AD.   Эти атрибуты представляют собой значение sAMAccountName группы, которое может быть дополнено именем домена или идентификатором безопасности группы Windows (Граупсид).  Если приложение объединено с AD FS, AD FS использует функцию Токенграупс для получения членства в группах для пользователя.

Приложение, перемещенное из AD FS, должно иметь утверждения в том же формате. Утверждения групп и ролей могут выдаваться из Azure Active Directory, содержащих доменные sAMAccountName или Граупсид, синхронизированные из Active Directory, а не Azure Active Directory objectID группы.

Поддерживаемые форматы для утверждения группы:

- **ObjectID группы Azure Active Directory** (доступно для всех групп)
- **SamAccountName** (доступен для групп, синхронизированных из Active Directory)
- **Нетбиосдомаин\самаккаунтнаме** (доступно для групп, синхронизированных из Active Directory)
- **Днсдомаиннаме\самаккаунтнаме** (доступно для групп, синхронизированных из Active Directory)
- **Идентификатор безопасности локальной группы** (доступен для групп, синхронизированных из Active Directory)

> [!NOTE]
> атрибуты идентификатора безопасности sAMAccountName и on локальной группы доступны только для объектов группы, синхронизированных из Active Directory.   Они недоступны в группах, созданных в Azure Active Directory или Office 365.   Приложения, настроенные в Azure Active Directory для получения синхронизированных атрибутов локальной группы, получают их только для синхронизированных групп.

## <a name="options-for-applications-to-consume-group-information"></a>Параметры для использования сведений о группе в приложениях

Приложения могут вызывать конечную точку группы MS Graph для получения сведений о группе для пользователя, прошедшего проверку подлинности. Этот вызов гарантирует, что все группы, членом которых является пользователь, будут доступны даже при наличии большого количества групп.  Затем перечисление групп не зависит от ограничений размера маркера.

Однако если существующее приложение планирует использовать сведения о группе через утверждения, Azure Active Directory можно настроить с помощью ряда различных форматов утверждений.  Следуйте приведенным ниже рекомендациям.

- При использовании членства в группах в целях авторизации в приложении предпочтительнее использовать группу ObjectID. Группа ObjectID является неизменяемой и уникальна в Azure Active Directory и доступна для всех групп.
- Если для авторизации используется локальная группа sAMAccountName, используйте полные имена доменов;  вероятность конфликта имен меньше. значение sAMAccountName может быть уникальным в домене Active Directory, но если несколько Active Directory домена синхронизируются с клиентом Azure Active Directory, существует возможность, чтобы несколько групп имели одно и то же имя.
- Рассмотрите возможность использования [ролей приложения](../../active-directory/develop/howto-add-app-roles-in-azure-ad-apps.md) для обеспечения уровня косвенного обращения между членством в группе и приложением.   Затем приложение выполняет внутренние решения по авторизации на основе утверждений ролей в маркере.
- Если приложение настроено для получения атрибутов группы, которые синхронизируются из Active Directory и группа не содержит этих атрибутов, она не будет включена в утверждения.
- Групповые утверждения в маркерах включают вложенные группы, за исключением случаев использования параметра для ограничения групповых утверждений группам, назначенным приложению.  Если пользователь является членом Граупб, а Граупб является членом группы a, то утверждения группы для пользователя будут содержать как группы a, так и Граупб. Если пользователи организации имеют большое количество членств в группах, число групп, перечисленных в маркере, может увеличить размер маркера.  Azure Active Directory ограничивает количество групп, которое будет выдаваться в токене, в 150 для утверждений SAML и 200 для JWT.  Если пользователь является членом большего числа групп, группы пропускаются, а вместо этого включается ссылка на конечную точку графа для получения сведений о группе.

## <a name="prerequisites-for-using-group-attributes-synchronized-from-active-directory"></a>Необходимые условия для использования атрибутов группы, синхронизированных из Active Directory

При использовании формата ObjectId утверждения членства в группе можно выдавать в токенах для любой группы. Чтобы использовать групповые утверждения в форматах, отличных от ObjectId, группы необходимо синхронизировать из Active Directory с помощью Azure AD Connect.

Настройка Azure Active Directory для создания имен групп для Active Directory групп состоит из двух этапов.

1. **Синхронизация имен групп из Active Directory** Прежде чем Azure Active Directory может выдать имена групп или идентификатор безопасности локальной группы в утверждениях группы или роли, необходимо синхронизировать необходимые атрибуты из Active Directory.  Необходимо запустить Azure AD Connect версии 1.2.70 или более поздней.   Более ранние версии Azure AD Connect, чем 1.2.70, будут синхронизировать объекты группы из Active Directory, но не будут содержать обязательные атрибуты имени группы.  Обновление до текущей версии.

2. **Настройка регистрации приложения в Azure Active Directory для включения групповых утверждений в токенах** Утверждения группы можно настроить в разделе корпоративные приложения на портале или с помощью манифеста приложения в разделе регистрации приложений.  Сведения о настройке групповых утверждений в манифесте приложения см. в разделе "Настройка регистрации приложения Azure Active Directory для атрибутов группы" ниже.

## <a name="add-group-claims-to-tokens-for-saml-applications-using-sso-configuration"></a>Добавление групповых утверждений в токены для приложений SAML с помощью конфигурации единого входа

Чтобы настроить утверждения группы для приложения SAML коллекции или не коллекции, откройте приложение " **корпоративные приложения**", щелкните приложение в списке, выберите **Конфигурация единого входа**, а затем выберите **атрибуты пользователя & утверждения**.

Щелкните " **Добавить утверждение группы** ".  

![Снимок экрана, на котором показана страница "атрибуты пользователя & утверждения" с выбранным параметром "Добавить утверждение группы".](media/how-to-connect-fed-group-claims/group-claims-ui-1.png)

Использование переключателей для выбора групп, которые должны быть добавлены в маркер

![Снимок экрана, на котором показано окно "групповые утверждения" с выбранными группами безопасности.](media/how-to-connect-fed-group-claims/group-claims-ui-2.png)

| Выбор | Описание |
|----------|-------------|
| **Все группы** | Выдает группы безопасности и списки рассылки и роли.  |
| **Группы безопасности** | Создает группы безопасности, членом которых является пользователь в утверждении групп |
| **Роли каталога** | Если пользователю назначаются роли каталога, они выдаются как утверждение "видс" (утверждение групп не будет выдаваться). |
| **Группы, назначенные приложению** | Выдает только те группы, которые явным образом назначены приложению, а пользователь является членом |

Например, чтобы выдать всех групп безопасности, членом которых является пользователь, выберите группы безопасности.

![Снимок экрана, на котором показано окно "групповые утверждения" с выбранными группами безопасности и открывающееся раскрывающееся меню "атрибут источника".](media/how-to-connect-fed-group-claims/group-claims-ui-3.png)

Чтобы выдать группы с использованием Active Directoryных атрибутов, синхронизированных из Active Directory вместо идентификаторов objectID Azure AD выберите нужный формат в раскрывающемся списке. В утверждениях будут включаться только группы, синхронизированные из Active Directory.

![Снимок экрана, показывающий открытие раскрывающегося меню "исходный атрибут".](media/how-to-connect-fed-group-claims/group-claims-ui-4.png)

Чтобы выдать приложению только группы, назначенные для приложения, выберите **группы, назначенные приложению** .

![Снимок экрана, на котором показано окно "групповые утверждения" с выбранными группами "группы, назначенные приложению".](media/how-to-connect-fed-group-claims/group-claims-ui-4-1.png)

Группы, назначенные приложению, будут включаться в маркер.  Другие группы, членом которых является пользователь, будут пропущены.  При использовании этого параметра вложенные группы не включаются, и пользователь должен быть прямым членом группы, назначенной приложению.

Чтобы изменить группы, назначенные приложению, выберите приложение из списка **корпоративные приложения** , а затем щелкните **Пользователи и группы** в левом меню навигации приложения.

Сведения об управлении назначением групп для приложений см. в документе [Назначение пользователя или группы корпоративному приложению](../../active-directory/manage-apps/assign-user-or-group-access-portal.md) .

### <a name="advanced-options"></a>Расширенные параметры

Способ выдачи заявок на группы можно изменить с помощью параметров в разделе Дополнительные параметры.

Настройка имени утверждения группы. Если этот параметр выбран, для групповых утверждений можно указать другой тип утверждения.   Введите тип утверждения в поле имя и необязательное пространство имен для утверждения в поле пространство имен.

![Снимок экрана, на котором показан раздел "Дополнительные параметры" с выбранными значениями "настроить имя утверждения группы" и "имя" и "пространство имен".](media/how-to-connect-fed-group-claims/group-claims-ui-5.png)

Для некоторых приложений требуется, чтобы сведения о членстве в группе отображались в утверждении Role. При необходимости можно создать группы пользователей в качестве ролей, установив флажок "выдавать группы в утверждениях ролей".

![Снимок экрана, показывающий раздел "Дополнительные параметры" с выбранным параметром "настроить имя утверждения группы" и "выдавать группы как утверждения роли".](media/how-to-connect-fed-group-claims/group-claims-ui-6.png)

> [!NOTE]
> Если используется параметр для отправки данных группы в качестве ролей, в заявке роли будут отображаться только группы.  Любые роли приложений, назначенные пользователю, не будут отображаться в заявке роли.

### <a name="edit-the-group-claims-configuration"></a>Изменение конфигурации групповых утверждений

После добавления конфигурации утверждения группы в атрибуты пользователя & конфигурации утверждений возможность добавления утверждения группы будет неактивна.  Чтобы изменить конфигурацию утверждения группы, щелкните утверждение группы в списке **дополнительных утверждений** .

![Пользовательский интерфейс утверждений](media/how-to-connect-fed-group-claims/group-claims-ui-7.png)

## <a name="configure-the-azure-ad-application-registration-for-group-attributes"></a>Настройка регистрации приложения Azure AD для атрибутов группы

Утверждения группы также можно настроить в разделе [необязательные утверждения](../../active-directory/develop/active-directory-optional-claims.md) [манифеста приложения](../../active-directory/develop/reference-app-manifest.md).

1. На портале >регистрация приложения Azure Active Directory > — >выберите манифест приложения->.

2. Включение утверждений о членстве в группах путем изменения Граупмембершипклаим

Допустимые значения:

| Выбор | Описание |
|----------|-------------|
| **Каждого** | Выдает группы безопасности, списки рассылки и роли |
| **"SecurityGroup"** | Создает группы безопасности, членом которых является пользователь в утверждении групп |
| **"DirectoryRole"** | Если пользователю назначаются роли каталога, они выдаются как утверждение "видс" (утверждение групп не будет выдаваться). |
| **ApplicationGroup** | Выдает только те группы, которые явным образом назначены приложению, а пользователь является членом |
| **None** | Группы не возвращаются. (Его не сенсетиве, так что он не работает, и его можно задать непосредственно в манифесте приложения.) |

   Пример:

   ```json
   "groupMembershipClaims": "SecurityGroup"
   ```

   По умолчанию группы ObjectID будут выдаваться в значении утверждения группы.  Чтобы изменить значение утверждения в соответствии с атрибутами локальной группы или изменить тип утверждения на роль, используйте конфигурацию OptionalClaims следующим образом.

3. Задайте необязательные утверждения для конфигурации имени группы.

   Если требуется, чтобы группы в токене содержали атрибуты on локальной группы AD, укажите, к какому типу токена следует применить обязательное утверждение в разделе дополнительные утверждения.  В списке можно указать несколько типов маркеров:

   - idToken для маркера идентификатора OIDC;
   - accessToken для маркера доступа OAuth/OIDC
   - Saml2Token для маркеров SAML.

   > [!NOTE]
   > Тип Saml2Token применяется к маркерам формата SAML1.1 и SAML2.0.

   Для каждого соответствующего типа токена измените утверждение групп, чтобы в манифесте использовался раздел OptionalClaims. Схема OptionalClaims выглядит следующим образом:

   ```json
   {
   "name": "groups",
   "source": null,
   "essential": false,
   "additionalProperties": []
   }
   ```

   | Схема необязательных утверждений | Значение |
   |----------|-------------|
   | **name:** | Должно быть "groups" |
   | **source:** | Не используется. Пропустите или укажите "null" |
   | **essential:** | Не используется. Пропустите или укажите "false" |
   | **additionalProperties:** | Список дополнительных свойств.  Допустимые значения: "sam_account_name", "dns_domain_and_sam_account_name", "netbios_domain_and_sam_account_name", "emit_as_roles" |

   В additionalProperties требуется только один из них: "sam_account_name", "dns_domain_and_sam_account_name", "netbios_domain_and_sam_account_name".  Если указано более одного, используется первый, а остальные игнорируются.

   Некоторым приложениям требуются сведения о группе пользователя в утверждении роли.  Чтобы изменить тип утверждения с утверждения группы на утверждение роли, добавьте "emit_as_roles" к дополнительным свойствам.  Значения группы будут выдаваться в утверждении роли.

   > [!NOTE]
   > Если используется "emit_as_roles", все роли приложения, настроенные для назначения пользователя, не будут отображаться в утверждении роли.

### <a name="examples"></a>Примеры

Выдавать группы в виде имен групп в маркерах доступа OAuth в формате Днсдомаиннаме\самаккаунтнаме

```json
"optionalClaims": {
    "accessToken": [{
        "name": "groups",
        "additionalProperties": ["dns_domain_and_sam_account_name"]
    }]
}
 ```

Чтобы выдать имена групп, возвращаемых в формате Нетбиосдомаин\самаккаунтнаме, в качестве утверждения ролей в маркерах ИДЕНТИФИКАТОРов SAML и OIDC:

```json
"optionalClaims": {
    "saml2Token": [{
        "name": "groups",
        "additionalProperties": ["netbios_name_and_sam_account_name", "emit_as_roles"]
    }],

    "idToken": [{
        "name": "groups",
        "additionalProperties": ["netbios_name_and_sam_account_name", "emit_as_roles"]
    }]
 }
 ```

## <a name="next-steps"></a>Дальнейшие действия

- [Добавление авторизации с помощью групп & групп, утвержденных в веб-приложение ASP.NET Core (пример кода)](https://github.com/Azure-Samples/active-directory-aspnetcore-webapp-openidconnect-v2/blob/master/5-WebApp-AuthZ/5-2-Groups/README.md)
- [Назначение корпоративному приложению пользователя или группы](../../active-directory/manage-apps/assign-user-or-group-access-portal.md)
- [Настройка утверждений ролей](../../active-directory/develop/active-directory-enterprise-app-role-management.md)
