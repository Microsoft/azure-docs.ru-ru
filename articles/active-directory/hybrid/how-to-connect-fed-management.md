---
title: Azure AD Connect. Управление службами AD FS и их настройка | Документация Майкрософт
description: Управление службами AD FS с помощью Azure AD Connect и настройка пользовательского входа в AD FS с помощью Azure AD Connect и PowerShell.
keywords: AD FS, ADFS, управление AD FSми, AAD Connect, Connect, вход, настройка AD FS, исправление доверия, M365, Федерация, проверяющая сторона
services: active-directory
documentationcenter: ''
author: billmath
manager: daveba
editor: ''
ms.assetid: 2593b6c6-dc3f-46ef-8e02-a8e2dc4e9fb9
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: how-to
ms.date: 07/18/2017
ms.subservice: hybrid
ms.author: billmath
ms.custom: seohack1
ms.collection: M365-identity-device-management
ms.openlocfilehash: cc0c8c40e370579100c562e0289c97e3f5ce4236
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "91274118"
---
# <a name="manage-and-customize-active-directory-federation-services-by-using-azure-ad-connect"></a>Управление службами федерации Active Directory и их настройка с помощью Azure AD Connect
В этой статье описывается управление службами федерации Active Directory (AD FS) и их настройка с помощью Azure Active Directory (Azure AD) Connect, а также рассматриваются другие стандартные задачи AD FS, которые может потребоваться выполнить для полной настройки фермы AD FS.

| Раздел | Что описывает |
|:--- |:--- |
| **Управление AD FS** | |
| [Восстановление доверия](#repairthetrust) |Как восстановить доверие федерации с помощью Microsoft 365. |
| [Федерацию с Azure AD с помощью альтернативного имени пользователя](#alternateid) | Настройка федерации с использованием альтернативного имени пользователя.  |
| [Добавление сервера AD FS](#addadfsserver) |Расширение фермы AD FS с использованием дополнительного сервера AD FS. |
| [Добавление прокси-сервера веб-приложения AD FS](#addwapserver) |Добавление к ферме AD FS дополнительного сервера прокси-службы веб-приложения (WAP). |
| [Добавление федеративного домена](#addfeddomain) |Добавление федеративного домена. |
| [Обновление сертификата TLS/SSL](how-to-connect-fed-ssl-update.md)| Как обновить сертификат TLS/SSL для AD FS фермы. |
| **Настройка AD FS** | |
| [Добавление настраиваемого логотипа компании или иллюстрации](#customlogo) |Настройка логотипа компании и иллюстрации для страницы входа AD FS. |
| [Добавление описания входа в систему](#addsignindescription) |Добавление описания страницы входа в систему. |
| [Изменение правил утверждений AD FS](#modclaims) |Изменение утверждений AD FS для различных сценариев федерации. |

## <a name="manage-ad-fs"></a>Управление AD FS
В Azure AD Connect можно выполнять разные связанные с AD FS задачи с помощью мастера Azure AD Connect с минимальным участием пользователя. Завершив установку Azure AD Connect с помощью мастера, вы можете снова запустить этот мастер, чтобы выполнить дополнительные задачи.

## <a name="repair-the-trust"></a><a name="repairthetrust"></a>Восстановление доверия 
Azure AD Connect может проверить текущую работоспособность AD FS и доверие Azure AD и предпринять соответствующие действия для восстановления доверия. Выполните приведенные ниже действия для восстановления доверия Azure AD и AD FS.

1. Выберите в списке дополнительных задач пункт **Восстановление доверия AAD и ADFS** .
   ![Восстановление доверия AAD и ADFS](./media/how-to-connect-fed-management/RepairADTrust1.PNG)

2. На странице **Подключение к Azure AD** укажите учетные данные глобального администратора для Azure AD и нажмите кнопку **Далее**.
   ![Снимок экрана, на котором показана страница "подключение к Azure AD" с указанными учетными данными.](./media/how-to-connect-fed-management/RepairADTrust2.PNG)

3. На странице **Учетные данные для удаленного доступа** введите учетные данные администратора домена.

   ![Снимок экрана, на котором показана страница "учетные данные удаленного доступа" с указанными учетными данными.](./media/how-to-connect-fed-management/RepairADTrust3.PNG)

    Когда вы нажмете кнопку **Далее**, Azure AD Connect проверит работоспособность сертификата и отобразит возможные проблемы.

    ![Состояние сертификатов](./media/how-to-connect-fed-management/RepairADTrust4.PNG)

    На странице **Готово к настройке** отобразится список действий, которые будут выполнены для восстановления доверия.

    ![Снимок экрана, на котором показана страница "готовность к настройке" со списком действий.](./media/how-to-connect-fed-management/RepairADTrust5.PNG)

4. Чтобы восстановить доверие, нажмите кнопку **Установить** .

> [!NOTE]
> Azure AD Connect может выполнить восстановление или другие действия только для самозаверяющих сертификатов. С помощью Azure AD Connect нельзя восстановить сертификаты третьих сторон.

## <a name="federate-with-azure-ad-using-alternateid"></a><a name="alternateid"></a>Использование Федерации с Azure AD с помощью альтернативного имени пользователя 
Рекомендуется, чтобы локальное имя участника-пользователя (UPN) и имя участника-пользователя в облаке были одинаковыми. Если в локальном имени участника-пользователя используется не поддерживающий маршрутизацию домен (например, Contoso.local), или если его невозможно изменить из-за зависимостей локального приложения, то рекомендуется настроить альтернативное имя пользователя. Альтернативное имя пользователя позволяет настроить процедуру входа таким образом, что пользователи смогут использовать для входа атрибут, отличный от имени участника-пользователя, например адрес электронной почты. По умолчанию для имени участника-пользователя в Azure AD Connect используется атрибут userPrincipalName в Active Directory. Если выбрать для имени участника-пользователя любой другой атрибут и выполнить федерацию с помощью AD FS, то Azure AD Connect настроит AD FS на использование альтернативного имени пользователя. В приведенном ниже примере показано, как выбрать другой атрибут для имени участника-пользователя.

![Выбор альтернативного атрибута имени пользователя](./media/how-to-connect-fed-management/attributeselection.png)

Настройка альтернативного имени пользователя для AD FS состоит из двух основных этапов:
1. **Настройка правильного набора утверждений выдачи**. Изменяются правила утверждений выдачи в отношениях доверия с проверяющей стороной Azure AD, чтобы использовать выбранный атрибут UserPrincipalName в качестве альтернативного имени пользователя.
2. **Включение альтернативного имени пользователя в конфигурации AD FS**. Обновляется конфигурация AD FS, чтобы служба AD FS могла выполнять поиск пользователей в соответствующих лесах, используя альтернативное имя пользователя. Эта конфигурация поддерживается для службы AD FS, работающей под управлением Windows Server 2012 R2 (с обновлением KB2919355) и более поздних версий. Если серверы AD FS работают под управлением версии 2012 R2, то Azure AD Connect проверяет наличие необходимого обновления. Если обновление не удается обнаружить, то после выполнения настройки отображается предупреждение, как показано ниже.

    ![Предупреждение об отсутствии обновления в версии 2012 R2](./media/how-to-connect-fed-management/kbwarning.png)

    При обнаружении такой проблемы необходимо исправить конфигурацию, установив обязательное обновление [KB2919355](https://go.microsoft.com/fwlink/?LinkID=396590) и восстановив доверие с помощью действия [Восстановление доверия AAD и ADFS](#repairthetrust).

> [!NOTE]
> Дополнительные сведения об альтернативном имени пользователя и о его настройке вручную см. в статье [Configuring Alternate Login ID](/windows-server/identity/ad-fs/operations/configuring-alternate-login-id) (Настройка альтернативного имени пользователя).

## <a name="add-an-ad-fs-server"></a><a name="addadfsserver"></a>Добавление сервера AD FS 

> [!NOTE]
> Для добавления сервера AD FS Azure AD Connect требует PFX-файл сертификата. Таким образом, эту операцию можно выполнить, только если ферма AD FS настроена с помощью Azure AD Connect.

1. Выберите пункт **Развернуть дополнительный сервер федерации** и нажмите кнопку **Далее**.

   ![Дополнительный сервер федерации](./media/how-to-connect-fed-management/AddNewADFSServer1.PNG)

2. На странице **Подключение к Azure AD** укажите учетные данные глобального администратора для Azure AD и нажмите кнопку **Далее**.

   ![Снимок экрана, на котором показана страница "подключение к Azure AD" с указанными учетными данными.](./media/how-to-connect-fed-management/AddNewADFSServer2.PNG)

3. Введите учетные данные администратора домена.

   ![Учетные данные администратора домена](./media/how-to-connect-fed-management/AddNewADFSServer3.PNG)

4. Azure AD Connect запросит пароль PFX-файла, который был указан при настройке новой фермы AD FS с помощью Azure AD Connect. Щелкните **Введите пароль** , чтобы указать пароль для PFX-файла.

   ![Снимок экрана, на котором отображается страница "указание SSL-сертификата" с открытым окном "пароль сертификата".](./media/how-to-connect-fed-management/AddNewADFSServer4.PNG)

    ![Снимок экрана, на котором показана страница "указание SSL-сертификата" после ввода пароля для PFX-файла.](./media/how-to-connect-fed-management/AddNewADFSServer5.PNG)

5. На странице **Серверы AD FS** введите имя сервера или IP-адрес, который нужно добавить к ферме AD FS.

   ![Серверы AD FS](./media/how-to-connect-fed-management/AddNewADFSServer6.PNG)

6. Нажмите кнопку **Далее** и выполните инструкции на последней странице **Настройка**. После того как Azure AD Connect завершит добавление серверов в ферму AD FS, у вас будет возможность проверить подключение.

   ![Снимок экрана, на котором показана страница "готовность к настройке" со списком действий, которые необходимо выполнить после нажатия кнопки "установить".](./media/how-to-connect-fed-management/AddNewADFSServer7.PNG)

    ![Снимок экрана, на котором отображается страница "Завершение установки" с сообщением "Конфигурация интрасети успешно проверена". ](./media/how-to-connect-fed-management/AddNewADFSServer8.PNG)

## <a name="add-an-ad-fs-wap-server"></a><a name="addwapserver"></a>Добавление AD FS WAP Server 

> [!NOTE]
> Для добавления WAP-сервера Azure AD Connect требует PFX-файл сертификата. Таким образом, эту операцию можно выполнить, только если ферма AD FS настроена с помощью Azure AD Connect.

1. Выберите пункт **Развертывание прокси-службы веб-приложения** в списке доступных задач.

   ![Развертывание прокси-службы веб-приложения](./media/how-to-connect-fed-management/WapServer1.PNG)

2. Введите учетные данные глобального администратора Azure.

   ![Снимок экрана, на котором показана страница "подключение к Azure AD" с указанным именем пользователя и паролем.](./media/how-to-connect-fed-management/wapserver2.PNG)

3. На странице **Укажите SSL-сертификат** введите пароль для PFX-файла, который использовался при настройке фермы AD FS с помощью Azure AD Connect.
   ![Пароль сертификата](./media/how-to-connect-fed-management/WapServer3.PNG)

    ![Укажите сертификат TLS/SSL](./media/how-to-connect-fed-management/WapServer4.PNG)

4. Добавьте сервер в качестве WAP-сервера. Так как WAP-сервер может быть не присоединен к домену, мастер запросит учетные данные администратора для добавляемого сервера.

   ![Учетные данные администратора сервера](./media/how-to-connect-fed-management/WapServer5.PNG)

5. На странице **Учетные данные доверия прокси-сервера** введите учетные данные администратора, чтобы настроить доверие прокси-сервера и доступ к основному серверу в ферме AD FS.

   ![Учетные данные доверия прокси-сервера](./media/how-to-connect-fed-management/WapServer6.PNG)

6. В мастере на странице **Готово к настройке** отображается список действий, которые будут выполнены.

   ![Снимок экрана, на котором показана страница "готовность к настройке" со списком действий для выполнения.](./media/how-to-connect-fed-management/WapServer7.PNG)

7. Чтобы завершить настройку, нажмите кнопку **Установить** . По завершении настройки мастер предоставляет возможность проверить подключение к серверам. Чтобы проверить подключение, щелкните **Проверить** .

   ![Установка завершена](./media/how-to-connect-fed-management/WapServer8.PNG)

## <a name="add-a-federated-domain"></a><a name="addfeddomain"></a>Добавление федеративного домена 

Вы можете быстро добавить домен в федерацию с Azure AD с помощью Azure AD Connect. Azure AD Connect добавляет домен для федерации, а также изменяет правила утверждения, чтобы правильно отражать издателя при наличии нескольких доменов в федерации с Azure AD.

1. Чтобы добавить федеративный домен, выберите задачу **Добавить дополнительный домен Azure AD**.

   ![Дополнительный домен Azure AD](./media/how-to-connect-fed-management/AdditionalDomain1.PNG)

2. На следующей странице мастера введите учетные данные глобального администратора для Azure AD.

   ![Подключение к Azure AD](./media/how-to-connect-fed-management/AdditionalDomain2.PNG)

3. На странице **Учетные данные для удаленного доступа** введите учетные данные администратора домена.

   ![Учетные данные удаленного доступа](./media/how-to-connect-fed-management/additionaldomain3.PNG)

4. На следующей странице мастера будет предоставлен список доменов Azure AD, которые можно использовать для федерации вашего локального каталога. Выберите домен из списка.

   ![Домен Azure AD](./media/how-to-connect-fed-management/AdditionalDomain4.PNG)

    Когда вы выберете домен, мастер предоставит соответствующие сведения о дальнейших действиях, которые будут выполнены мастером, а также о результатах настроек. В некоторых случаях при выборе домена, еще не проверенного в Azure AD, мастер предоставит сведения, которые помогут проверить домен. Дополнительные сведения см. в разделе [Добавление имени личного домена в Azure Active Directory](../fundamentals/add-custom-domain.md).

5. Щелкните **Далее**. На странице **Готово к настройке** отображается список действий, которые выполнит Azure AD Connect. Чтобы завершить настройку, нажмите кнопку **Установить** .

   ![Готово к настройке](./media/how-to-connect-fed-management/AdditionalDomain5.PNG)

> [!NOTE]
> Пользователи из добавленного федеративного домена должна быть синхронизированы, прежде чем они смогут войти в Azure AD.

## <a name="ad-fs-customization"></a>Пользовательская настройка AD FS
Ниже приведены сведения о некоторых стандартных задачах, связанных с пользовательской настройкой страницы входа AD FS.

## <a name="add-a-custom-company-logo-or-illustration"></a><a name="customlogo"></a>Добавление настраиваемого логотипа компании или иллюстрации 
Чтобы изменить логотип компании, который отображается на странице **входа**, используйте приведенный ниже командлет Windows PowerShell и синтаксис.

> [!NOTE]
> Рекомендуемые размеры логотипа — 260 x 35 \@ 96 точек на дюйм. Размер файла не должен превышать 10 КБ.

```azurepowershell-interactive
Set-AdfsWebTheme -TargetName default -Logo @{path="c:\Contoso\logo.PNG"}
```

> [!NOTE]
> Параметр *TargetName* является обязательным. Стандартная тема для AD FS называется темой по умолчанию.

## <a name="add-a-sign-in-description"></a><a name="addsignindescription"></a>Добавление описания входа в систему 
Чтобы добавить на **страницу входа** описание страницы входа, используйте следующий командлет Windows PowerShell и синтаксис.

```azurepowershell-interactive
Set-AdfsGlobalWebContent -SignInPageDescriptionText "<p>Sign-in to Contoso requires device registration. Click <A href='http://fs1.contoso.com/deviceregistration/'>here</A> for more information.</p>"
```

## <a name="modify-ad-fs-claim-rules"></a><a name="modclaims"></a>Изменение правил утверждений служб федерации Active Directory 
Службы AD FS поддерживают обширный язык утверждений, с помощью которого можно создавать настраиваемые правила утверждений. Дополнительные сведения см. в разделе [Роль языка правил утверждений](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dd807118(v=ws.11)).

Далее рассматривается, как можно создавать пользовательские правила для некоторых сценариев, связанных с использованием Azure AD и федерации AD FS.

### <a name="immutable-id-conditional-on-a-value-being-present-in-the-attribute"></a>Неизменяемый идентификатор, зависящий от наличия значения в атрибуте
Azure AD Connect позволяет указывать атрибут, используемый в качестве привязки к источнику, когда объекты синхронизируются с Azure AD. Если значение в настраиваемом атрибуте не пустое, можно выдать утверждение неизменяемого идентификатора.

Например, можно выбрать в качестве привязки к источнику атрибут **ms-ds-consistencyguid** и настроить выдачу **ImmutableID** как **ms-ds-consistencyguid** в случае наличия у атрибута значения. Если у атрибута нет значения, в качестве неизменяемого идентификатора следует выдать **objectGuid**. Можно создать набор пользовательских правил утверждения, как описано ниже.

**Правило 1. Атрибуты запросов**

```claim-rule-language
c:[Type == "http://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountname"]
=> add(store = "Active Directory", types = ("http://contoso.com/ws/2016/02/identity/claims/objectguid", "http://contoso.com/ws/2016/02/identity/claims/msdsconsistencyguid"), query = "; objectGuid,ms-ds-consistencyguid;{0}", param = c.Value);
```

В этом правиле запрашиваются значения **ms-ds-consistencyguid** и **objectGuid** для пользователя из Active Directory. Измените имя хранилища на имя соответствующего хранилища в развертывании AD FS. Также измените тип утверждений на соответствующий тип утверждений для Федерации, как определено для **objectGuid** и **MS-DS-consistencyguid**.

Кроме того, используя параметр **add** вместо **issue**, можно предотвратить добавление исходящей выдачи для сущности и использовать значения в качестве промежуточных. Утверждение будет выдано в последующем правиле после того, как будет установлено, какое значение следует использовать в качестве неизменяемого идентификатора.

**Правило 2. Проверка наличия ms-ds-consistencyguid для пользователя**

```claim-rule-language
NOT EXISTS([Type == "http://contoso.com/ws/2016/02/identity/claims/msdsconsistencyguid"])
=> add(Type = "urn:anandmsft:tmp/idflag", Value = "useguid");
```

Это правило определяет временный флаг с именем **idflag**, который получает значение **useguid**, если **ms-ds-concistencyguid** для пользователя не заполнен. Логика такого решения в том, что службы AD FS запрещают пустые утверждения. Поэтому при добавлении утверждений `http://contoso.com/ws/2016/02/identity/claims/objectguid` и `http://contoso.com/ws/2016/02/identity/claims/msdsconsistencyguid` в правило 1 вы получаете утверждение **msdsconsistencyguid**, только если значение для пользователя заполнено. Если оно не заполнено, службы AD FS определяют, что значение окажется пустым, и немедленно его опускают. **objectGuid** имеют все объекты, поэтому такое утверждение всегда будет присутствовать после выполнения правила 1.

**Правило 3. Выдача ms-ds-consistencyguid в качестве неизменяемого идентификатора, если он присутствует**

```claim-rule-language
c:[Type == "http://contoso.com/ws/2016/02/identity/claims/msdsconsistencyguid"]
=> issue(Type = "http://schemas.microsoft.com/LiveID/Federation/2008/05/ImmutableID", Value = c.Value);
```

Это неявная проверка **Exist** . Если значение для утверждения существует, выполняется его выдача в качестве неизменяемого идентификатора. В предыдущем примере используется утверждение **nameidentifier** . Его потребуется заменить соответствующим типом утверждения для неизменяемого идентификатора в конкретной среде.

**Правило 4. Выдача objectGuid в качестве неизменяемого идентификатора при отсутствии ms-ds-consistencyGuid**

```claim-rule-language
c1:[Type == "urn:anandmsft:tmp/idflag", Value =~ "useguid"]
&& c2:[Type == "http://contoso.com/ws/2016/02/identity/claims/objectguid"]
=> issue(Type = "http://schemas.microsoft.com/LiveID/Federation/2008/05/ImmutableID", Value = c2.Value);
```

В этом правиле просто выполняется проверка временного флага **idflag**. На основе его значения определяется, следует ли выдавать утверждение.

> [!NOTE]
> Последовательность этих правил важна.

### <a name="sso-with-a-subdomain-upn"></a>Единый вход с помощью UPN поддомена

Можно включить несколько доменов в федерацию с помощью Azure AD Connect, как описано в разделе [Добавление нового федеративного домена](how-to-connect-fed-management.md#addfeddomain). Azure AD Connect версии 1.1.553.0 и более поздней создает корректное правило утверждения для issuerID автоматически. Если вы не можете использовать Azure AD Connect версии 1.1.553.0 или более поздней, рекомендуется использовать средство [Правила утверждений Azure AD RPT](https://aka.ms/aadrptclaimrules) для создания и установки корректных правил утверждений для доверия проверяющей стороне Azure AD.

## <a name="next-steps"></a>Дальнейшие действия
См. [дополнительные сведения о параметрах входа пользователя](plan-connect-user-signin.md).