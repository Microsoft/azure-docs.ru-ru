---
title: Конечная точка синхронизации Azure AD Connect версии 2 | Документация Майкрософт
description: Этот документ освещает обновления API конечной точки версии 2 для синхронизации Azure AD.
services: active-directory
author: billmath
manager: daveba
editor: ''
ms.service: active-directory
ms.workload: identity
ms.topic: how-to
ms.date: 12/04/2020
ms.subservice: hybrid
ms.author: billmath
ms.collection: M365-identity-device-management
ms.openlocfilehash: 0ecfd277f2cc86102d59b201e7b43fa8519bdd3a
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "98937616"
---
# <a name="azure-ad-connect-sync-v2-endpoint-api"></a>API конечной точки версии 2 для синхронизации Azure AD Connect 
Корпорация Майкрософт развернула новую конечную точку (API) для Azure AD Connect, которая повышает производительность операций службы синхронизации с Azure Active Directory. Используя новую конечную точку версии 2, вы получите заметное улучшение показателей при экспорте и импорте в Azure AD. Эта новая конечная точка поддерживает следующее:
    
 - синхронизация групп, насчитывающих до 250 000 участников;
 - выигрыш в производительности при экспорте из Azure AD и импорте в нее.
 
> [!NOTE]
> В настоящее время новая конечная точка не имеет настроенного предела размера группы для Microsoft 365 групп, которые записываются обратно. Это может повлиять на Active Directory и задержки цикла синхронизации. Рекомендуется увеличивать размеры групп постепенно.  

## <a name="prerequisites"></a>Предварительные условия  
Чтобы использовать новую конечную точку версии 2, необходимо использовать [Azure AD Connect версии 1.5.30.0](https://www.microsoft.com/download/details.aspx?id=47594) или более поздней, а также выполнить приведенные ниже шаги по развертыванию, делающие возможным использование конечной точки версии 2 для сервера Azure AD Connect.   

## <a name="deployment-guidance"></a>Руководства по развертыванию 
Для использования конечной точки версии 2 потребуется развернуть [Azure AD Connect версии 1.5.30.0](https://www.microsoft.com/download/details.aspx?id=47594) или более поздней. Используйте ссылку, предоставленную для скачивания. 

Рекомендуется следовать методу [пошаговой миграции](./how-to-upgrade-previous-version.md#swing-migration) для развертывания новой конечной точки в среде. Это обеспечит четкий план на случай непредвиденной ситуации, требующей значительного отката. Следующий пример иллюстрирует, как в этом сценарии можно использовать обновление со сменой сервера. Дополнительные сведения о методе развертывания, использующем обновление со сменой сервера, см. по указанной ссылке. 

### <a name="swing-migration-for-deploying-v2-endpoint"></a>Обновление со сменой сервера для развертывания конечной точки версии 2
Ниже демонстрируется, как развернуть конечную точку версии 2, используя метод обновления со сменой сервера.

1. Разверните конечную точку версии 2 на текущем промежуточном сервере. Этот сервер будет называться **сервером версии 2** в следующих шагах. Текущий активный сервер продолжит обрабатывать рабочую нагрузку с помощью конечной точки версии 1, которая будет называться **сервером версии 1** ниже.
1. Убедитесь, что сервер **версии 2** все еще обрабатывает импортируемые данные, как и ожидалось. На этом этапе большие группы не будут подготовлены к работе с Azure AD или локальной AD, но вы сможете убедиться, что обновление не привело к каким-либо другим непредвиденным последствиям для существующего процесса синхронизации. 
2. После завершения проверки переключите сервер **версии 2** в режим активного сервера, а сервер **версии 1** в режим промежуточного сервера. В настоящее время большие группы, которые находятся в области синхронизации, будут подготовлены для Azure AD, а также большие Microsoft 365 Объединенные группы будут подготовлены для AD, если включена обратная запись группы.
3. Убедитесь, что сервер **версии 2** успешно работает и обрабатывает большие группы. Вы можете на некоторое время остаться на этом шаге и отслеживать процесс синхронизации.
  >[!NOTE]
  > Если необходимо вернуться к предыдущей конфигурации, то можно выполнить обновление со сменой сервера **версии 2** обратно на сервер **версии 1**. Так как конечная точка версии 1 не поддерживает группы с более чем 50 000 членов, любая большая группа, которая была подготовлена с помощью Azure AD Connect, как в Azure AD, так и в локальной службе AD, будет впоследствии удалена. 
4. Убедившись в том, что конечная точка версии 2 работает нормально, обновите сервер **версии 1**, чтобы начать использовать конечную точку версии 2. 
 

## <a name="expectations-of-performance-impact"></a>Ожидаемое влияние на производительность  
При использовании конечной точки версии 2 рост производительности является функцией числа синхронизированных групп, размера и текучести этих групп (процесса добавления и удаления пользователей в качестве членов группы). Использование новой конечной точки без увеличения числа, размера или текучести синхронизированных групп должно привести к сокращению времени экспорта и импорта в Azure AD. 
 
Однако при синхронизации больших групп выигрыш в производительности может быть съеден необходимостью в дополнительной обработке. Общее время синхронизации можно даже увеличить, если добавить в процесс синхронизации слишком много больших групп.  

Чтобы получить более полное представление о том, как добавление новых групп повлияет на производительность синхронизации, рекомендуется начать с синхронизации лишь нескольких больших групп, имеющих менее 100 000 членов. Затем можно увеличить число и размер групп, добавив большее их число в область, используя фильтрацию по подразделению, атрибуту или максимальному размеру группы. Улучшения производительности будут реализованы в задачах экспорта и импорта для соединителя Azure AD, а не локального соединителя AD. 

## <a name="deployment-step-by-step"></a>Развертывание шаг за шагом 
Три следующих этапа являются подробным примером развертывания новой конечной точки версии 2.  Используйте эти этапы в качестве руководства по собственному развертыванию.

### <a name="phase-1--install-and-validate-azure-ad-connect"></a>Этап 1 — установка и проверка Azure AD Connect 
Рекомендуется сначала выполнить действия по установке или обновлению до [Azure AD Connect версии 1.5.30.0](https://www.microsoft.com/download/details.aspx?id=47594) или более поздней. Также стоит проверить процесс синхронизации до перехода на второй этап, где будет включена конечная точка версии 2. На сервере Azure AD Connect: 


1. (Необязательно) создайте резервную копию базы данных. 
2. Установите или обновитесь до [Azure AD Connect версии 1.5.30.0](https://www.microsoft.com/download/details.aspx?id=47594) или более поздней.
3. проверка установки 

### <a name="phase-2--enable-the-v2-endpoint"></a>Этап 2 — включение конечной точки версии 2 
Следующим действием будет включение конечной точки версии 2. 

> [!NOTE]
> После включения конечной точки версии 2 для сервера будут наблюдаться некоторые улучшения производительности для имеющейся рабочей нагрузки. Но возможность синхронизировать группы с более чем 50 000 участников пока еще не появится. 

Чтобы переключиться на конечную точку версии 2, выполните следующие действия. 

1. Откройте командную строку PowerShell от имени администратора. 
2. Убедитесь, что никаких операций синхронизации не выполняется и отключите планировщик синхронизации: 
 
 `Set-ADSyncScheduler -SyncCycleEnabled $false`
 
3. Импортируйте новый модуль: 
 
 `Import-Module 'C:\Program Files\Microsoft Azure AD Sync\Extensions\AADConnector.psm1'` 
 
4.  Переключитесь на конечную точку версии 2:

 `Set-ADSyncAADConnectorExportApiVersion 2` 
 
 `Set-ADSyncAADConnectorImportApiVersion 2` 

 ![PowerShell](media/how-to-connect-sync-endpoint-api-v2/endpoint1.png)
 
Теперь конечная точка версии 2 работает на сервере. Подождите некоторое время, чтобы убедиться в отсутствии непредвиденных результатов после включения конечной точки версии 2. Затем переходите к следующему этапу, где увеличивается предельный размер группы. 
>[!NOTE]
>Пути к файлу или модулю могут использовать другую букву диска в зависимости от пути установки, указанного при установке Azure AD Connect. 


### <a name="phase-3--increase-the-group-membership-limit"></a>Этап 3 — увеличение предельного числа членов групп 
Убедившись, что служба работает без непредвиденных результатов, можно приступить к увеличению предельного числа членов групп. Рекомендуется сначала увеличить это число до немного большего значения, например до 75 тысяч членов, чтобы увидеть, как более крупные группы синхронизируются с Azure AD. Если результаты удовлетворительны, вы можете повысить предел далее.  

Максимальное ограничение — 250 000 членов на группу. 

Для увеличения числа членов можно использовать следующие шаги.  

1. Перейдите в Редактор правил синхронизации Open Azure AD. 
2. В редакторе выберите **Исходящее** в качестве направления. 
3. Щелкните правило синхронизации **Отправление в AAD — групповое соединение**. 
4. Нажмите кнопку " **изменить** " на ![ снимке экрана, на котором показан флажок "Просмотреть правила синхронизации и управлять ими", с выбранным параметром "выход в AAD-Group Join".](media/how-to-connect-sync-endpoint-api-v2/endpoint2.png)

6. Нажмите кнопку **Да**, чтобы отключить правило по умолчанию и создать редактируемую копию.
 ![Снимок экрана, показывающий окно "Изменение зарезервированного правила" с выбранной кнопкой "Да".](media/how-to-connect-sync-endpoint-api-v2/endpoint3.png)

7. Во всплывающем окне на странице **Описание** задайте для приоритета доступное значение от 1 до 99 ![ снимок экрана, в котором отображается окно "изменение правила синхронизации исходящей связи" с выделенным параметром "приоритет".](media/how-to-connect-sync-endpoint-api-v2/endpoint4.png)

8. На странице **Преобразование** обновите значение **Источника** для преобразования **член**, заменив "50000" значением от 50 001 до 25 0000. Эта замена приведет к увеличению максимального числа членов в группах, которые будут синхронизироваться с Azure AD. Мы рекомендуем начать с числа 100 тысяч, чтобы выявить влияние синхронизации больших групп на производительность синхронизации. 
 
 **Пример** 
 
 `IIF((ValueCount("member")> 75000),Error("Maximum Group member count exceeded"),IgnoreThisFlow)` 
 
 ![Изменение правила синхронизации](media/how-to-connect-sync-endpoint-api-v2/endpoint5.png)

9. Щелкните Сохранить 
10. Откройте командную строку администратора PowerShell. 
11. Повторно включите планировщик синхронизации. 
 
 `Set-ADSyncScheduler -SyncCycleEnabled $true` 
 
>[!NOTE]
> Если Azure AD Connect Health не включено, измените параметры журнала событий приложений Windows, чтобы архивировать журналы, а не перезаписывать их. Журналы можно использовать для устранения неполадок в будущем. 

>[!NOTE]
> После включения новой конечной точки вы можете увидеть дополнительные ошибки экспорта в соединителе AAD с именем DN-Attributes-Failure. Для каждой ошибки с идентификатором 6949 будет соответствующая запись в журнале событий. Ошибки являются информационными и не указывают на проблему с установкой. Они значат, что процесс синхронизации не может добавить определенных членов в группу в Azure AD, так как сам объект-член не был синхронизирован с Azure AD. 

Новый код конечной точки версии 2 обрабатывает некоторые типы ошибок экспорта немного иначе, чем это делал код v1.  При использовании конечной точки версии 2 могут отображаться дополнительные информационные сообщения об ошибках. 

>[!NOTE]
> При обновлении Azure AD Connect не забудьте выполнить повторно шаги на этапе 2, так как изменения не сохраняются в процессе обновления. 

При последующем увеличении ограничения на число членов группы в правиле синхронизации **Отправление в AAD — групповое соединение** не требуется полная синхронизация, поэтому можно отключить полную синхронизацию, выполнив следующую команду в PowerShell. 

 `Set-ADSyncSchedulerConnectorOverride -FullSyncRequired $false -ConnectorName "<AAD Connector Name>" `
 
>[!NOTE]
> При наличии Microsoft 365 Объединенных групп, имеющих более 50 000 членов, группы будут считываться в Azure AD Connect и если включена обратная запись группы, они будут записаны в локальную службу AD. 

## <a name="rollback"></a>Откат 
Если после включения конечной точки версии 2 необходимо выполнить откат, выполните следующие действия. 

1. На сервере Azure AD Connect: (Необязательно) создайте резервную копию базы данных. 
2. Откройте командную строку администратора PowerShell:
3. Убедитесь, что никаких операций синхронизации не выполняется, и отключите планировщик синхронизации.
 
 `Set-ADSyncScheduler -SyncCycleEnabled $false`

4. Переключитесь на конечную точку версии 1*. 
 
 `Import-Module 'C:\Program Files\Microsoft Azure AD Sync\Extensions\AADConnector.psm1'` 

 `Set-ADSyncAADConnectorExportApiVersion 1`

 `Set-ADSyncAADConnectorImportApiVersion 1`
 
5. Перейдите в Редактор правил синхронизации Open Azure AD. 
6. Удаление редактируемой копии правила синхронизации **Отправление в AAD — групповое соединение** 
7. Включение копии по умолчанию правила синхронизации **Отправление в AAD — групповое соединение** 
8. Откройте командную строку администратора PowerShell. 
9. Повторно включите планировщик синхронизации. 
 
 `Set-ADSyncScheduler -SyncCycleEnabled $true`
 
>[!NOTE]
> При переключении с конечных точек версии 2 на v1 группы, синхронизированные с более чем 50 000 членами, будут удалены после выполнения полной синхронизации, для обеих групп AD, подготовленных в Azure AD, и Microsoft 365 Объединенных групп, подготовленных для AD. 

## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы  
 
**Когда новая конечная точка станет значением по умолчанию для обновлений и новых установок?**  
</br>Мы планируем создать новый выпуск AADConnect, который будет опубликован для загрузки в феврале 2021. В этом выпуске конечная точка v2 будет использоваться по умолчанию и будет включена синхронизация групп размером более 50 000 без дополнительной настройки. Затем этот выпуск будет опубликован для автоматического обновления на соответствующих серверах.
 
## <a name="next-steps"></a>Дальнейшие действия

* [Синхронизация Azure AD Connect: общие сведений о синхронизации и ее настройка](how-to-connect-sync-whatis.md)
* [Интеграция локальных удостоверений с Azure Active Directory](whatis-hybrid-identity.md)
