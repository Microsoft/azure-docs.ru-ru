---
title: 'Синхронизация Azure AD Connect: изменение учетной записи службы ADSync | Документация Майкрософт'
description: В этой статье описывается назначение ключа шифрования и его прерывание после изменения пароля.
services: active-directory
keywords: учетная запись службы синхронизации Azure AD, пароль
documentationcenter: ''
author: billmath
manager: daveba
editor: ''
ms.assetid: 76b19162-8b16-4960-9e22-bd64e6675ecc
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: how-to
ms.date: 05/02/2019
ms.subservice: hybrid
ms.author: billmath
ms.collection: M365-identity-device-management
ms.openlocfilehash: e4dcc7ed6076c3bac723d709f50f1b3ab2ce8f58
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "95996565"
---
# <a name="changing-the-adsync-service-account-password"></a>Изменение пароля учетной записи службы ADSync
Если изменить пароль учетной записи службы ADSync, служба синхронизации не сможет правильно запуститься до тех пор, пока не будет отменен ключ шифрования и не повторно инициализирует пароль учетной записи службы ADSync. 

Azure AD Connect, как часть служб синхронизации, использует ключ шифрования для хранения паролей учетной записи соединителя AD DS и учетной записи службы ADSync.  Эти учетные записи шифруются перед сохранением в базе данных. 

Используемый ключ шифрования защищается с помощью [защиты данных Windows (DPAPI)](/previous-versions/ms995355(v=msdn.10)). DPAPI защищает ключ шифрования с помощью **учетной записи службы ADSync**. 

Если необходимо изменить пароль учетной записи службы, то для этого можно использовать процедуры, описанные в разделе прекращение использования [ключа шифрования учетной записи службы ADSync](#abandoning-the-adsync-service-account-encryption-key) .  Эти процедуры вам пригодятся и в том случае, когда по какой-либо причине вам понадобится сбросить ключ шифрования.

## <a name="issues-that-arise-from-changing-the-password"></a>Проблемы, которые возникают из-за смены пароля
Есть две вещи, которые необходимо выполнить при изменении пароля учетной записи службы.

Во-первых, нужно изменить пароль в диспетчере управления службами Windows.  Пока вы не устраните эту проблему, будут появляться следующие ошибки.


- Если попытаться запустить службу синхронизации, в диспетчере управления службами Windows возникает ошибка "**Windows не может запустить службу синхронизации Microsoft Azure AD на локальном компьютере**". **Ошибка 1069. Служба не запущена из-за ошибки входа в систему**".
- В средстве просмотра событий Windows журнал системных событий содержит ошибку **с идентификатором 7038** и текстом сообщения "**Служба ADSync не может войти в систему с текущим паролем из-за следующей ошибки: неверное указано имя пользователя или пароль**".

Во-вторых, при некоторых условиях служба синхронизации после изменения пароля не может получить ключ шифрования через DPAPI. Без ключа шифрования служба синхронизации не может расшифровать пароли, необходимые для синхронизации между локальным экземпляром AD и Azure AD.
Вы этом случае вы увидите такие ошибки.

- В диспетчере управления службами Windows, если вы попытаетесь запустить службу синхронизации и не можете получить ключ шифрования, произойдет сбой с ошибкой "<strong>Windows не удалось запустить синхронизацию Microsoft Azure AD на локальном компьютере. Дополнительные сведения см. в журнале системных событий. Если это служба, не относящаяся к Майкрософт, обратитесь к поставщику услуг и обратитесь к коду ошибки-21451857952</strong>".
- В Просмотр событий Windows журнал событий приложения содержит ошибку с **идентификатором события 6028** и сообщением об ошибке *"не удается получить доступ к ключу шифрования сервера".*

Чтобы убедиться, что эти ошибки не появляются, выполните процедуры, описанные в разделе прекращение работы [ключа шифрования учетной записи службы ADSync](#abandoning-the-adsync-service-account-encryption-key) при изменении пароля.
 
## <a name="abandoning-the-adsync-service-account-encryption-key"></a>Отменяется ключ шифрования учетной записи службы ADSync
>[!IMPORTANT]
>Следующие процедуры применимы только к Azure AD Connect с номером сборки 1.1.443.0 или более ранних версий. Этот параметр нельзя использовать для новых версий Azure AD Connect, так как при изменении пароля учетной записи службы синхронизации Active Directory служба Azure AD Connect обрабатывает ключ шифрования, поэтому следующие шаги не нужны в новых версиях.   

Используйте следующие процедуры для сброса ключа шифрования.

### <a name="what-to-do-if-you-need-to-abandon-the-encryption-key"></a>Что делать, если нужно сбросить ключ шифрования

Вот как можно сбросить ключ шифрования.

1. [Остановка работы службы синхронизации](#stop-the-synchronization-service)

1. [Сброс существующего ключа шифрования](#abandon-the-existing-encryption-key)

2. [Укажите пароль учетной записи соединителя AD DS.](#provide-the-password-of-the-ad-ds-connector-account)

3. [Повторная инициализация пароля учетной записи службы ADSync](#reinitialize-the-password-of-the-adsync-service-account)

4. [Запуск службы синхронизации](#start-the-synchronization-service)

#### <a name="stop-the-synchronization-service"></a>Остановка работы службы синхронизации
Вы можете остановить службу в диспетчере управления службами Windows.  Но при этом убедитесь, что служба не запущена.  Если служба запущена, дождитесь завершения работы и остановите ее.


1. Перейдите к диспетчеру управления службами Windows ("Пуск" → "Службы").
2. Выберите **службу синхронизации Microsoft Azure AD** и нажмите кнопку "Остановить".

#### <a name="abandon-the-existing-encryption-key"></a>Сброс существующего ключа шифрования
Чтобы создать новый ключ шифрования, нужно сначала сбросить существующий ключ шифрования.

1. Войдите на сервер Azure AD Connect с правами администратора.

2. Запустите сеанс PowerShell.

3. Перейдите в папку `'$env:ProgramFiles\Microsoft Azure AD Sync\bin\'`.

4. Выполните команду `./miiskmu.exe /a`.

![Снимок экрана, показывающий PowerShell после выполнения команды.](./media/how-to-connect-sync-change-serviceacct-pass/key5.png)

#### <a name="provide-the-password-of-the-ad-ds-connector-account"></a>Укажите пароль учетной записи соединителя AD DS.
Поскольку существующие пароли, хранящиеся в базе данных, больше не могут быть расшифрованы, необходимо предоставить службе синхронизации пароль учетной записи AD DS Connector. Служба синхронизации зашифрует пароли, с помощью нового ключа шифрования.

1. Запустите Synchronization Service Manager ("Запуск" → "Служба синхронизации").
</br>![Диспетчер службы синхронизации](./media/how-to-connect-sync-change-serviceacct-pass/startmenu.png)  
2. Перейдите на вкладку **Соединители**.
3. Выберите **соединитель AD**, соответствующий локальному экземпляру AD. Если у вас несколько соединителей AD, выполните перечисленные ниже шаги для каждого из них.
4. В разделе **Действия** выберите **Свойства**.
5. Во всплывающем диалоговом окне выберите **Подключиться к лесу Active Directory**.
6. В текстовом поле **Пароль** введите новый пароль для учетной записи AD DS. Если вы не знаете этот пароль, измените его на известное значение перед выполнением этого шага.
7. Нажмите кнопку **ОК**, чтобы сохранить новый пароль и закрыть всплывающее диалоговое окно.
![Снимок экрана, показывающий страницу "подключение к Active Directory лесу" в окне "Свойства".](./media/how-to-connect-sync-change-serviceacct-pass/key6.png)

#### <a name="reinitialize-the-password-of-the-adsync-service-account"></a>Повторная инициализация пароля учетной записи службы ADSync
Пароль учетной записи службы Azure AD нельзя напрямую передать в службу синхронизации. Вместо этого нужно использовать командлет **Add-ADSyncAADServiceAccount** для повторной инициализации учетной записи службы Azure AD. Этот командлет сбрасывает пароль учетной записи и передает его в службу синхронизации.

1. Запустите новый сеанс PowerShell на сервере Azure AD Connect.
2. Выполните командлет `Add-ADSyncAADServiceAccount`.
3. Во всплывающем диалоговом окне введите учетные данные глобального администратора Azure AD, действующие для вашего клиента Azure AD.
![Служебная программа для ключа шифрования в службе синхронизации Azure AD Connect](./media/how-to-connect-sync-change-serviceacct-pass/key7.png)
4. Если все пройдет успешно, вы увидите командную строку PowerShell.

#### <a name="start-the-synchronization-service"></a>Запуск службы синхронизации
Теперь, когда служба синхронизации получила доступ к ключу шифрования и всем нужным паролям, вы можете перезапустить службы с помощью диспетчера управления службами Windows.


1. Перейдите к диспетчеру управления службами Windows ("Пуск" → "Службы").
2. Выберите **службу синхронизации Microsoft Azure AD** и нажмите кнопку "Перезапустить".

## <a name="next-steps"></a>Дальнейшие действия
**Обзорные статьи**

* [Синхронизация Azure AD Connect: общие сведений о синхронизации и ее настройка](how-to-connect-sync-whatis.md)

* [Интеграция локальных удостоверений с Azure Active Directory](whatis-hybrid-identity.md)
