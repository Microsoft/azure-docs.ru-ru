---
title: 'Azure Active Directory Connect: устранение неполадок с простым единым входом | Документы Майкрософт'
description: В этом разделе описывается устранение неполадок с простым единым входом Azure Active Directory.
services: active-directory
author: billmath
ms.reviewer: swkrish
manager: daveba
ms.assetid: 9f994aca-6088-40f5-b2cc-c753a4f41da7
ms.service: active-directory
ms.workload: identity
ms.topic: troubleshooting
ms.date: 10/07/2019
ms.subservice: hybrid
ms.author: billmath
ms.collection: M365-identity-device-management
ms.openlocfilehash: eef58f6e84fb3b4dec947fa3614b6ec1043ff89e
ms.sourcegitcommit: b4647f06c0953435af3cb24baaf6d15a5a761a9c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/02/2021
ms.locfileid: "101644652"
---
# <a name="troubleshoot-azure-active-directory-seamless-single-sign-on"></a>Устранение неполадок с простым единым входом Azure Active Directory

Эта статья поможет вам найти информацию об устранении распространенных неполадок с простым единым входом Azure Active Directory (Azure AD).

## <a name="known-issues"></a>Известные проблемы

- В некоторых случаях включение простого единого входа может занять до 30 минут.
- Если отключить и повторно включить эффективный единый вход для клиента, пользователи не смогут применять единый вход, пока не истечет срок действия их кэшированных билетов Kerberos (как правило, они действительны в течение 10 часов).
- После успешного единого входа пользователю не предоставляется возможность выбрать вариант **Оставаться в системе**. Из-за такого поведения [сценарии сопоставления SharePoint и OneDrive](https://support.microsoft.com/help/2616712/how-to-configure-and-to-troubleshoot-mapped-network-drives-that-connec) не работают.
- Microsoft 365 Клиенты Win32 (Outlook, Word, Excel и др.) с версиями 16.0.8730. xxxx и более поздних версий поддерживаются с помощью неинтерактивного потока. Другие версии не поддерживаются. В этих версиях для входа в систему пользователи будут вводить свое имя пользователя, но не пароль. Для OneDrive потребуется активировать [функцию автоматической настройки OneDrive](https://techcommunity.microsoft.com/t5/Microsoft-OneDrive-Blog/Previews-for-Silent-Sync-Account-Configuration-and-Bandwidth/ba-p/120894), чтобы включить автоматический вход в систему.
- Простой единый вход не работает в конфиденциальном режиме просмотра в Firefox.
- Простой единый вход не работает в Internet Explorer с включенным режимом повышенной защиты.
- Простой единый вход не работает в частном режиме обзора в Microsoft ребре (прежних версий).
- Простой единый вход не работает в браузерах на мобильных устройствах с iOS и Android.
- Если пользователь входит в состав слишком большого количества групп в Active Directory, скорее всего, билет Kerberos этого пользователя будет слишком большим для обработки, что приведет к сбою простого единого входа. HTTPS-запросы Azure AD могут включать в себя заголовки, максимальный размер которых составляет 50 КБ. Размер билетов Kerberos должен быть меньше, чтобы вместить другие артефакты Azure AD (как правило, он равен 2–5 КБ), такие как файлы cookie. Рекомендуем сократить количество членов в группах и повторить попытку.
- При синхронизации 30 лесов Active Directory или больше простой единый вход через Azure AD Connect включить невозможно. Чтобы избежать этого, можно [вручную включить](#manual-reset-of-the-feature) эту функцию на своем клиенте.
- Добавление URL-адреса службы Azure AD ( `https://autologon.microsoftazuread-sso.com` ) в зону "надежные сайты" вместо зоны "Местная интрасеть" *блокирует вход пользователей*.
- Простой единый вход поддерживает AES256_HMAC_SHA1, AES128_HMAC_SHA1 и RC4_HMAC_MD5 типы шифрования для Kerberos. Рекомендуется, чтобы для учетной записи AzureADSSOAcc $ было задано значение AES256_HMAC_SHA1 или один из типов AES vs. RC4 для дополнительной защиты. Тип шифрования хранится в атрибуте msDS-Суппортеденкриптионтипес учетной записи в Active Directory.  Если для параметра Тип шифрования учетной записи AzureADSSOAcc $ задано значение RC4_HMAC_MD5 и вы хотите изменить его на один из типов шифрования AES, убедитесь, что вы сначала перейдете за ключ расшифровки Kerberos учетной записи AzureADSSOAcc $, как описано в [документе вопросы и ответы](how-to-connect-sso-faq.md) по соответствующему вопросу, в противном случае простой единый вход не будет выполняться.
-  Если у вас есть несколько лесов с доверием лесов, включив единый вход в одном из лесов, включит единый вход во всех доверенных лесах. Если вы включили единый вход в лесу, в котором уже включен единый вход, вы получите сообщение об ошибке, сообщающее, что единый вход уже включен в лесу.

## <a name="check-status-of-feature"></a>Проверка состояния функции

Убедитесь, что функция простого единого входа по-прежнему **включена** в клиенте. Можно проверить состояние, перейдя в область **Azure AD Connect** в [центре администрирования Azure Active Directory](https://aad.portal.azure.com/).

![Центр администрирования Active Directory Azure — область "Azure AD Connect"](./media/tshoot-connect-sso/sso10.png)

С помощью мыши просмотрите все леса AD, которые были настроены для использования простого единого входа.

![Центр администрирования Azure Active Directory — область простого единого входа](./media/tshoot-connect-sso/sso13.png)

## <a name="sign-in-failure-reasons-in-the-azure-active-directory-admin-center-needs-a-premium-license"></a>Причины сбоя единого входа в центре администрирования Azure Active Directory (требуется лицензия Premium)

Если к клиенту привязана лицензия Azure AD Premium, вы можете также изучить [отчет о действиях при входе](../reports-monitoring/concept-sign-ins.md) в [центре администрирования Azure Active Directory](https://aad.portal.azure.com/).

![Центр администрирования Azure Active Directory — отчет о действиях входа](./media/tshoot-connect-sso/sso9.png)

Перейдите к **Azure Active Directory**  >  **входа** в [центр администрирования Azure Active Directory](https://aad.portal.azure.com/), а затем выберите действие входа конкретного пользователя. Найдите поле **КОД ОШИБКИ ВХОДА**. Сопоставьте значение этого поля c причиной сбоя и способом разрешения с помощью следующей таблицы.

|Код ошибки входа|Причина ошибки входа|Решение
| --- | --- | ---
| 81001 | Билет Kerberos пользователя слишком большой. | Сократите список членства пользователя в группах и повторите попытку.
| 81002 | Не удалось проверить билет Kerberos пользователя. | Изучите [контрольный список по устранению неполадок](#troubleshooting-checklist).
| 81003 | Не удалось проверить билет Kerberos пользователя. | Изучите [контрольный список по устранению неполадок](#troubleshooting-checklist).
| 81004 | Проверка подлинности Kerberos завершилась сбоем. | Изучите [контрольный список по устранению неполадок](#troubleshooting-checklist).
| 81008 | Не удалось проверить билет Kerberos пользователя. | Изучите [контрольный список по устранению неполадок](#troubleshooting-checklist).
| 81009 | Не удалось проверить билет Kerberos пользователя. | Изучите [контрольный список по устранению неполадок](#troubleshooting-checklist).
| 81010 | Не удалось выполнить простой единый вход, так как срок действия билета Kerberos пользователя истек или этот билет недопустим. | Пользователю следует войти с устройства, присоединенного к домену, в корпоративной сети.
| 81011 | Не удалось найти объект-пользователь на основе сведений в билете Kerberos пользователя. | Используйте Azure AD Connect для синхронизации сведений о пользователе с Azure AD.
| 81012 | Пользователь, пытающийся выполнить вход в Azure AD, и пользователь устройства отличаются. | Пользователю нужно войти с другого устройства.
| 81013 | Не удалось найти объект-пользователь на основе сведений в билете Kerberos пользователя. |Используйте Azure AD Connect для синхронизации сведений о пользователе с Azure AD. 

## <a name="troubleshooting-checklist"></a>Контрольный список по устранению неполадок

Используйте следующий контрольный список для устранения неполадок простого единого входа.

- Проверьте, включена ли функция простого единого входа в Azure AD Connect. Если функцию не удается включить (например, из-за заблокированного порта), обеспечьте соблюдение всех [предварительных требований](how-to-connect-sso-quick-start.md#step-1-check-the-prerequisites).
- Если вы включили и [присоединение к Azure AD](../devices/overview.md), и эффективный единый вход для клиента, убедитесь, что проблема не связана с присоединением к Azure AD. Единый вход при присоединении Azure AD имеет приоритет над эффективным единым входом, если устройство зарегистрировано в Azure AD и присоединено к домену. При едином входе с присоединением к Azure AD отображается плитка входа с надписью "Подключено к Windows".
- Убедитесь, что URL-адрес Azure AD ( `https://autologon.microsoftazuread-sso.com` ) является частью параметров зоны интрасети пользователя.
- Убедитесь, что корпоративное устройство присоединено к домену Active Directory. Для функционирования простого единого входа устройство _не обязательно_ должно быть [присоединено к Azure AD](../devices/overview.md).
- Убедитесь, что пользователь вошел в систему с этого устройства с помощью доменной учетной записи Active Directory.
- Убедитесь, что учетная запись пользователя относится к лесу Active Directory, в котором настроен простой единый вход.
- Убедитесь, что устройство подключено к корпоративной сети.
- Убедитесь, что время на устройстве синхронизировано с временем в Active Directory и на контроллерах доменов, и что разница между временем на контроллерах домена не превышает пяти минут.
- Убедитесь, что учетная запись компьютера `AZUREADSSOACC` существует и включена в каждом лесу AD, для которого нужно включить простой единый вход. Если учетная запись компьютера удалена или отсутствует, ее можно создать повторно с помощью [командлетов PowerShell](#manual-reset-of-the-feature).
- Выведите список билетов Kerberos на устройстве с помощью команды `klist` из командной строки. Убедитесь в наличии билетов, выданных для учетной записи компьютера `AZUREADSSOACC`. Билеты Kerberos пользователей обычно действительны в течение 10 часов. В Active Directory могут быть заданы другие параметры.
- Если отключить и повторно включить эффективный единый вход для клиента, пользователи не смогут применять единый вход, пока не истечет срок действия их кэшированных билетов Kerberos.
- Удалите имеющиеся билеты Kerberos с устройства с помощью команды `klist purge` и повторите попытку.
- Чтобы определить наличие проблем, связанных с JavaScript, просмотрите журналы консоли из браузера (в разделе **Средства разработчика**).
- Просмотрите [журналы контроллеров домена](#domain-controller-logs).

### <a name="domain-controller-logs"></a>Журналы контроллеров домена

Если на контроллере домена включен аудит успешных попыток, то каждый раз, когда пользователь входит в систему с использованием простого единого входа, в журнал событий заносится запись безопасности. Эти события безопасности можно найти с помощью приведенного ниже запроса. (Найдите событие **4769**, связанное с учетной записью компьютера **AzureADSSOAcc$**.)

```
  <QueryList>
    <Query Id="0" Path="Security">
      <Select Path="Security">*[EventData[Data[@Name='ServiceName'] and (Data='AZUREADSSOACC$')]]</Select>
    </Query>
  </QueryList>
```

## <a name="manual-reset-of-the-feature"></a>Ручной сброс функции

Если устранение неполадок не помогло, можно сбросить вручную эту функцию на клиенте. Выполните следующие действия на локальном сервере, на котором выполняется Azure AD Connect.

### <a name="step-1-import-the-seamless-sso-powershell-module"></a>Шаг 1. Импортируйте модуль PowerShell для простого единого входа

1. Сначала скачайте и установите [Azure PowerShell](/powershell/azure/active-directory/overview).
2. Перейдите в папку `%programfiles%\Microsoft Azure Active Directory Connect`.
3. Импортируйте модуль PowerShell для простого единого входа с помощью следующей команды: `Import-Module .\AzureADSSO.psd1`.

### <a name="step-2-get-the-list-of-active-directory-forests-on-which-seamless-sso-has-been-enabled"></a>Шаг 2. Получение списка лесов Active Directory, для которых включен простой единый вход

1. Откройте сеанс PowerShell от имени администратора. В PowerShell вызовите `New-AzureADSSOAuthenticationContext`. При запросе введите учетные данные глобального администратора своего клиента.
2. Вызовите процедуру `Get-AzureADSSOStatus`. Эта команда выводит список лесов Active Directory (см. список "Домены"), в которых включена эта функция.

### <a name="step-3-disable-seamless-sso-for-each-active-directory-forest-where-youve-set-up-the-feature"></a>Шаг 3. Отключение простого единого входа для каждого леса Active Directory, в котором настроена эта функция

1. Вызовите процедуру `$creds = Get-Credential`. При запросе введите свои учетные данные администратора домена для нужного леса Active Directory.

   > [!NOTE]
   >Имя пользователя администратора домена необходимо вводит в формате имени учетной записи SAM (contoso\johndoe или contoso.com\johndoe). Мы используем доменную часть имени пользователя, чтобы через DNS найти контроллер домена для администратора домена.

   >[!NOTE]
   >Указанная учетная запись не должна входить в группу защищенных пользователей. В противном случае операция завершится ошибкой.

2. Вызовите процедуру `Disable-AzureADSSOForest -OnPremCredentials $creds`. Эта команда удаляет учетную запись компьютера `AZUREADSSOACC` с локального контроллера домена для конкретного леса Active Directory.
3. Повторите предыдущие шаги для каждого леса Active Directory, в котором настроена эта функция.

### <a name="step-4-enable-seamless-sso-for-each-active-directory-forest"></a>Шаг 4. Включение простого единого входа для каждого леса Active Directory

1. Вызовите процедуру `Enable-AzureADSSOForest`. При запросе введите свои учетные данные администратора домена для нужного леса Active Directory.

   > [!NOTE]
   >Имя пользователя администратора домена необходимо вводит в формате имени учетной записи SAM (contoso\johndoe или contoso.com\johndoe). Мы используем доменную часть имени пользователя, чтобы через DNS найти контроллер домена для администратора домена.

   >[!NOTE]
   >Указанная учетная запись не должна входить в группу защищенных пользователей. В противном случае операция завершится ошибкой.

2. Повторите предыдущие шаги для каждого леса Active Directory, в котором должна быть настроена эта функция.

### <a name="step-5-enable-the-feature-on-your-tenant"></a>Шаг 5. Включить функцию в своем клиенте

Чтобы включить эту функцию на клиенте, вызовите `Enable-AzureADSSO -Enable $true`.
