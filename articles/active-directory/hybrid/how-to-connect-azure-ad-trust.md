---
title: Azure AD Connect — управление доверием между AD FS и Azure AD с помощью Azure AD Connect | Документация Майкрософт
description: Операционные сведения о доверии Azure AD, обрабатываемом Azure AD Connect.
keywords: AD FS, ADFS, AD FS management, AAD Connect, Connect, Azure AD, trust, AAD, claim, claim, claim rules, issuance, transform, rules, backup, restore
services: active-directory
documentationcenter: ''
ms.reviewer: anandyadavmsft
manager: daveba
ms.subservice: hybrid
ms.assetid: 2593b6c6-dc3f-46ef-8e02-a8e2dc4e9fb9
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: how-to
ms.date: 07/28/2018
ms.author: billmath
author: billmath
ms.custom: ''
ms.collection: M365-identity-device-management
ms.openlocfilehash: 13d56ec321cd257412c2b0abbe0be655c6cb4dbf
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "85360101"
---
# <a name="manage-ad-fs-trust-with-azure-ad-using-azure-ad-connect"></a>Управление доверием между AD FS и Azure AD с помощью Azure AD Connect

## <a name="overview"></a>Обзор

Azure AD Connect может управлять федерацией между локальными службами федерации Active Directory (AD FS) и Azure AD. В статье представлен обзор следующих аспектов:

* различных параметров, настраиваемых в отношении доверия с помощью Azure AD Connect;
* правил преобразования выдачи (правил утверждения), устанавливаемых Azure AD Connect;
* выполнения резервного копирования и восстановления правил утверждения между обновлениями версии и обновлениями конфигурации. 

## <a name="settings-controlled-by-azure-ad-connect"></a>Параметры, управляемые Azure AD Connect

Azure AD Connect управляет **только** параметрами, связанными с отношением доверия Azure AD. Azure AD Connect не изменяет параметры в отношениях доверия другой проверяющей стороны в AD FS. В следующей таблице указаны параметры, которыми управляет Azure AD Connect.

| Параметр | Описание |
| :--- | :--- |
| Сертификат для подписи маркера | Azure AD Connect можно использовать для сброса и повторного создания доверия с Azure AD. Azure AD Connect выполняет одноразовую мгновенную смену сертификатов для подписи маркера AD FS и обновляет параметры федерации домена Azure AD.|
| Алгоритм для подписи маркеров | Корпорация Майкрософт рекомендует использовать SHA-256 как алгоритм для подписи маркеров. Azure AD Connect может определить, установлено ли для алгоритма подписи маркеров менее безопасное значение, чем SHA-256. Служба обновит параметр до значения SHA-256 в следующей возможной операции настройки. Для использования нового сертификата для подписи маркера необходимо обновить доверие другой проверяющей стороны. |
| Идентификатор отношения доверия Azure AD | Azure AD Connect устанавливает правильное значение идентификатора для отношения доверия Azure AD. AD FS уникально идентифицирует доверие Azure AD, используя значение идентификатора. |
| Конечные точки Azure AD | Azure AD Connect гарантирует, что конечные точки, настроенные для доверия Azure AD, всегда соответствуют последним рекомендуемым значениям отказоустойчивости и производительности. |
| Правила преобразования выдачи | Есть ряд правил утверждений, которые необходимы для оптимальной работы функций Azure AD в федеративной настройке. Azure AD Connect гарантирует, что доверие Azure AD всегда настроено с нужным набором рекомендуемых правил утверждений. |
| Альтернативный идентификатор | Если синхронизация настроена на использование альтернативного идентификатора, Azure AD Connect настраивает AD FS для выполнения проверки подлинности с помощью этого идентификатора. |
| Автоматическое обновление метаданных | Отношение доверия с Azure AD настроено на автоматическое обновление метаданных. AD FS периодически проверяет метаданные отношения доверия Azure AD и поддерживает их актуальность, если они изменяются на стороне Azure AD. |
| Встроенная проверка подлинности Windows (IWA) | Во время операции гибридного присоединения устройств к Azure AD IWA активируется для регистрации устройств, чтобы облегчить такое присоединение для устройств нижнего уровня. |

## <a name="execution-flows-and-federation-settings-configured-by-azure-ad-connect"></a>Потоки выполнения и параметры федерации, настроенные Azure AD Connect

Azure AD Connect не обновляет все параметры для отношения доверия Azure AD во время потоков конфигурации. Измененные параметры зависят от того, какая задача или поток выполняется. В следующей таблице перечислены параметры, задействованные в различных потоках выполнения.

| Поток выполнения | Затронутые параметры |
| :--- | :--- |
| Установка первого цикла (экспресс) | Нет |
| Установка первого цикла (новая ферма AD FS) | Создается ферма AD FS, и отношение доверия с Azure AD формируется с нуля. |
| Установка первого цикла (имеющаяся ферма AD FS, имеющееся отношение доверия Azure AD) | Идентификатор доверия Azure AD, правила преобразования выдачи, конечные точки Azure AD, альтернативный идентификатор (если необходимо), автоматическое обновление метаданных |
| Сброс отношения доверия Azure AD | Сертификат для подписи маркера, алгоритм для подписи маркеров, идентификатор доверия Azure AD, правила преобразования выдачи, конечные точки Azure AD, альтернативный идентификатор (если необходимо), автоматическое обновление метаданных |
| Добавление сервера федерации | Нет |
| Добавление WAP-сервера | Нет |
| Параметры устройств | Правила преобразования выдачи, IWA для регистрации устройств |
| Добавление федеративного домена | Если домен добавляется в первый раз, то есть настройка меняется с федерации единого домена на федерацию нескольких доменов, Azure AD Connect повторно создает отношение доверия с нуля. Если отношение доверия с Azure AD уже настроено для нескольких доменов, изменяются только правила преобразования выдачи |
| Обновление TLS | Нет |

При выполнении любых операций, когда изменяется какой-либо параметр, Azure AD Connect создает резервную копию текущих параметров отношения доверия в **%ProgramData%\AADConnect\ADFS**.

![Страница Azure AD Connect с сообщением об имеющейся резервной копии отношения доверия Azure AD](./media/how-to-connect-azure-ad-trust/backup2.png)

> [!NOTE]
> До выпуска версии 1.1.873.0 резервная копия состояла только из правил преобразования выдачи и находилась в файле журнала трассировки мастера.

## <a name="issuance-transform-rules-set-by-azure-ad-connect"></a>Правила преобразования выдачи, установленные Azure AD Connect

Azure AD Connect гарантирует, что доверие Azure AD всегда настроено с нужным набором рекомендуемых правил утверждений. Корпорация Майкрософт рекомендует использовать Azure AD Connect для управления отношением доверия Azure AD. В этом разделе перечислен набор правил преобразования выдачи и приводится их описание.

| Имя правила | Описание |
| --- | --- |
| Выдача имени участника-пользователя | Это правило запрашивает значение userprincipalname из атрибута, настроенного в параметрах синхронизации для userprincipalname.|
| Запрос objectguid и msdsconsistencyguid для настраиваемого утверждения ImmutableId | Это правило добавляет временное значение в конвейер для значений objectguid и msdsconsistencyguid, если они есть |
| Проверка наличия msdsconsistencyguid | В зависимости от того, есть ли значение для msdsconsistencyguid, мы устанавливаем временный флаг для указания того, что использовать как ImmutableId |
| Выдача msdsconsistencyguid как неизменяемого идентификатора при его наличии | Выдача msdsconsistencyguid как ImmutableId при наличии значения |
| Выдача objectGuidRule, если правила msdsConsistencyGuid не существует | Если значения msdsconsistencyguid нет, значение objectguid будет выдано как ImmutableId |
| Выдача nameidentifier | Это правило выдает значение для утверждения nameidentifier.|
| Выдача accounttype для компьютеров, присоединенных к домену | Если сущность, проходящая проверку подлинности, является подключенным к домену устройством, это правило выдает тип учетной записи как DJ, означающий подключенное к домену устройство |
| Выдача AccountType со значением USER, если это не учетная запись компьютера | Если сущность, проходящая проверку подлинности, является пользователем, это правило выдает тип учетной записи как "Пользователь" |
| Выдача issuerid, если это не учетная запись компьютера | Это правило выдает значение issuerId, если сущность, проходящая проверку подлинности, не является устройством. Это значение создается с помощью регулярного выражения, которое настраивается Azure AD Connect. Регулярное выражение создается после учета всех доменов, объединенных в федерацию с помощью Azure AD Connect. |
| Выдача issuerid для проверки подлинности компьютера DJ | Это правило выдает значение issuerId, если сущность, проходящая проверку подлинности, является устройством |
| Выдача onpremobjectguid для компьютеров, присоединенных к домену | Если сущность, проходящая проверку подлинности, является подключенным к домену устройством, это правило выдает для устройства локальный идентификатор objectguid |
| Проверка с помощью основного идентификатора безопасности | Это правило выдает основной идентификатор безопасности сущности, проходящей проверку подлинности |
| Проверка с помощью утверждения insideCorporateNetwork | Это правило выдает утверждение, которое помогает Azure AD выяснить, происходит ли проверка подлинности внутри корпоративной сети или за ее пределами |
| Проверка с помощью утверждения Psso |   |
| Выдача утверждений в отношении истечения срока действия пароля | Это правило выдает три утверждения для времени истечения срока действия пароля, количества дней до истечения срока действия пароля сущности, проходящей проверку подлинности, и URL-адреса, который следует использовать, чтобы изменить пароль.|
| Проверка с помощью утверждения authnmethodsreferences | Значение в утверждении, выданном в соответствии с этим правилом, указывает, какой тип проверки подлинности был выполнен для сущности |
| Проверка с помощью утверждения multifactorauthenticationinstant | Значение этого утверждения указывает время в формате UTC, когда пользователь в последний раз выполнял многофакторную проверку подлинности. |
| Проверка с помощью утверждения AlternateLoginID | Это правило выдает утверждение AlternateLoginID, если проверка подлинности выполнялась с помощью альтернативного имени пользователя. |

> [!NOTE]
> Правила утверждений для выдачи имени участника-пользователя и идентификатора ImmutableId будут отличаться, если вы используете нестандартный выбор во время настройки Azure AD Connect.

## <a name="restore-issuance-transform-rules"></a>Восстановление правил преобразования выдачи

Azure AD Connect версии 1.1.873.0 или более поздней создает резервную копию параметров отношения доверия Azure AD при каждом их обновлении. Резервная копия параметров отношения доверия Azure AD создается здесь: **%ProgramData%\AADConnect\ADFS**. Имя файла записывается в таком формате: AadTrust-&lt;дата&gt;-&lt;время&gt;.txt, например AadTrust-20180710-150216.txt.

![Снимок экрана примера резервного копирования доверия Azure AD](./media/how-to-connect-azure-ad-trust/backup.png)

Вы можете восстановить правила преобразования выдачи с помощью шагов ниже.

1. Откройте пользовательский интерфейс управления AD FS в диспетчере сервера.
2. Откройте свойства отношения доверия Azure AD, перейдя в **AD FS &gt; Отношения доверия проверяющей стороны &gt; Microsoft Office 365 Identity Platform (Платформа идентификации Microsoft Office 365) &gt; Edit Claims Issuance Policy (Изменить политику выдачи утверждений)**.
3. Щелкните **Добавить правило**.
4. В шаблоне правила утверждений выберите "Отправка утверждений с помощью настраиваемого правила", а затем нажмите кнопку **Далее**.
5. Скопируйте имя правила утверждения из файла резервной копии и вставьте его в поле **Claim rule name** (Имя правила утверждения).
6. Скопируйте правило утверждения из файла резервной копии и вставьте его в текстовое поле **Custom rule** (Настраиваемое правило), а затем нажмите кнопку **Готово**.

> [!NOTE]
> Проверьте отсутствие конфликта между дополнительными правилами и правилами, настроенными с помощью Azure AD Connect.

## <a name="next-steps"></a>Дальнейшие действия
* [Управление службами федерации Active Directory и их настройка с помощью Azure AD Connect](how-to-connect-fed-management.md)
