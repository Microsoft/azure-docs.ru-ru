---
title: Настройка установки Azure Active Directory Connect
description: В этой статье объясняются Параметры выборочной установки для Azure AD Connect. Используйте эти инструкции для установки Active Directory с помощью Azure AD Connect.
services: active-directory
keywords: что такое Azure AD Connect, установка Active Directory, необходимые компоненты для Azure AD
documentationcenter: ''
author: billmath
manager: daveba
ms.assetid: 6d42fb79-d9cf-48da-8445-f482c4c536af
ms.service: active-directory
ms.workload: identity
ms.topic: how-to
ms.date: 09/10/2020
ms.subservice: hybrid
ms.author: billmath
ms.collection: M365-identity-device-management
ms.openlocfilehash: 3afeadff71bd373354b891bd6690d94d28fc0805
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "92096357"
---
# <a name="custom-installation-of-azure-active-directory-connect"></a>Выборочная установка Azure Active Directory Connect
Используйте *пользовательские параметры* в Azure Active Directory (Azure AD) Connect, если вам нужны дополнительные параметры для установки. Используйте эти параметры, например, если у вас несколько лесов или если требуется настроить дополнительные функции. Используйте пользовательские параметры во всех случаях, когда [экспресс установки](how-to-connect-install-express.md) не удовлетворяет требованиям к развертыванию или топологии.

Предварительные требования.
- [Скачать Azure AD Connect](https://go.microsoft.com/fwlink/?LinkId=615771)
- Выполните предварительные шаги в [Azure AD Connect: оборудование и предварительные требования](how-to-connect-install-prerequisites.md). 
- Убедитесь, что у вас есть учетные записи, описанные в разделе [Azure AD Connect учетные записи и разрешения](reference-connect-accounts-permissions.md).

## <a name="custom-installation-settings"></a>Параметры выборочной установки 

Чтобы настроить выборочную установку для Azure AD Connect, просмотрите страницы мастера, описанные в следующих разделах.

### <a name="express-settings"></a>Стандартные параметры
На странице « **быстрые параметры** » выберите **Настройка** , чтобы запустить установку настраиваемых параметров.  В оставшейся части этой статьи описывается процесс выборочной установки. Используйте следующие ссылки для быстрого перехода к сведениям для конкретной страницы:

- [Обязательные компоненты](#install-required-components)
- [Вход пользователя](#user-sign-in)
- [Подключение к Azure AD](#connect-to-azure-ad)
- [Синхронизация](#sync-pages)

### <a name="install-required-components"></a>Установка необходимых компонентов
При установке служб синхронизации можно оставить невыбранным необязательный раздел конфигурации. Azure AD Connect автоматически настраивает все. Он настраивает экземпляр SQL Server 2012 Express LocalDB, создает соответствующие группы и назначает разрешения. Если вы хотите изменить значения по умолчанию, снимите соответствующие флажки.  В следующей таблице перечислены эти параметры и приведены ссылки на дополнительные сведения. 

![Снимок экрана, показывающий необязательные параметры для обязательных компонентов установки в Azure AD Connect.](./media/how-to-connect-install-custom/requiredcomponents2.png)

| Дополнительные настройки | Описание |
| --- | --- |
|Укажите пользовательское расположение установки| Позволяет изменить путь установки по умолчанию для Azure AD Connect.|
| Использование существующего SQL Server |Позволяет указать имя SQL Server и имя экземпляра. Выберите этот параметр, если у вас уже есть сервер базы данных, который вы хотите использовать. В поле **имя экземпляра** введите имя экземпляра, запятую и номер порта, если для экземпляра SQL Server не включен просмотр.  Затем укажите имя базы данных Azure AD Connect.  Ваши привилегии SQL определяют, может ли создаваться новая база данных, или администратор SQL должен создать базу данных заранее.  Если у вас есть разрешения SQL Server Administrator (SA), см. статью [установка Azure AD Connect с помощью существующей базы данных](how-to-connect-install-existing-database.md).  Если у вас есть делегированные разрешения (DBO), см. статью [установка Azure AD Connect с помощью делегированных разрешений администратора SQL](how-to-connect-install-sql-delegation.md). |
| Использование существующей учетной записи службы |По умолчанию Azure AD Connect предоставляет учетную запись виртуальной службы для служб синхронизации. Если используется удаленный экземпляр SQL Server или используется прокси-сервер, требующий проверки подлинности, можно использовать *управляемую учетную запись службы* или защищенную паролем учетную запись службы в домене. В этих случаях введите учетную запись, которую вы хотите использовать. Чтобы запустить установку, необходимо иметь значение SA в SQL, чтобы можно было создать учетные данные для входа в учетную запись службы. Дополнительные сведения см. в разделе [Учетная запись службы синхронизации Azure AD Connect](reference-connect-accounts-permissions.md#adsync-service-account). </br></br>Используя последнюю сборку, администратор SQL теперь может подготавливать базу данных с помощью аппаратного контроллера управления. Затем администратор Azure AD Connect может установить его с правами владельца базы данных.  Дополнительные сведения см. в статье [Установка Azure AD Connect с использованием делегированных разрешений администратора SQL](how-to-connect-install-sql-delegation.md).|
| Указание пользовательских групп синхронизации |По умолчанию при установке служб синхронизации Azure AD Connect создает четыре группы, которые являются локальными для сервера. Эти группы являются администраторами, операторами, обзором и сбросом пароля. Здесь также можно указать собственные группы. Группы должны быть локальными на сервере. Они не могут располагаться в домене. |
|Импорт параметров синхронизации (Предварительная версия)|Позволяет импортировать параметры из других версий Azure AD Connect.  Дополнительные сведения см. в разделе [Импорт и экспорт параметров конфигурации Azure AD Connect](how-to-connect-import-export-config.md).|

### <a name="user-sign-in"></a>Вход пользователя
После установки необходимых компонентов выберите метод единого входа пользователей. В следующей таблице кратко описаны доступные параметры. Полное описание способов входа см. в статье [Параметры входа в Azure AD Connect](plan-connect-user-signin.md).

![Снимок экрана, на котором показана страница "вход пользователя". Выбран параметр "Синхронизация хэша паролей".](./media/how-to-connect-install-custom/usersignin4.png)

| Параметр единого входа | Описание |
| --- | --- |
| Синхронизация хэша паролей |Пользователи могут входить в облачные службы Майкрософт, такие как Microsoft 365, используя тот же пароль, который они используют в локальной сети. Пароли пользователей синхронизируются с Azure AD в качестве хэша пароля. Проверка подлинности выполняется в облаке. Дополнительные сведения см. в статье [Синхронизация хэшей паролей](how-to-connect-password-hash-synchronization.md). |
|Сквозная аутентификация|Пользователи могут входить в облачные службы Майкрософт, такие как Microsoft 365, используя тот же пароль, который они используют в локальной сети.  Пароли пользователей проверяются путем передачи их в локальный Active Directory контроллер домена.
| Федерация с AD FS |Пользователи могут входить в облачные службы Майкрософт, такие как Microsoft 365, используя тот же пароль, который они используют в локальной сети.  Пользователи перенаправляются на локальный экземпляр служб федерации Azure Active Directory (AD FS) для входа. Проверка подлинности выполняется локально. |
| Федерация с PingFederate|Пользователи могут входить в облачные службы Майкрософт, такие как Microsoft 365, используя тот же пароль, который они используют в локальной сети.  Пользователи перенаправляются на локальный экземпляр PingFederate для входа. Проверка подлинности выполняется локально. |
| Не настраивать |Функция входа пользователя не установлена или не настроена. Выберите этот вариант, если у вас уже есть сторонний сервер федерации или другое решение. |
|Доступ с единым входом|Этот параметр доступен как для синхронизации хэша паролей, так и для сквозной проверки подлинности. Он обеспечивает единый вход для настольных пользователей в корпоративных сетях. Дополнительные сведения см. [в разделе единый вход](how-to-connect-sso.md). </br></br>**Примечание.** Для AD FS клиентов этот параметр недоступен. AD FS уже предоставляет одинаковый уровень единого входа.</br>

### <a name="connect-to-azure-ad"></a>Подключение к Azure AD
На странице **Подключение к Azure AD** введите учетную запись глобального администратора и пароль. Если вы выбрали **Федерацию с AD FS** на предыдущей странице, не выполните вход с помощью учетной записи, которая находится в домене, который вы планируете включить для Федерации. 

Может потребоваться использовать учетную запись в домене *onmicrosoft.com* по умолчанию, которая поставляется с клиентом Azure AD. Эта учетная запись используется только для создания учетной записи службы в Azure AD. Оно не используется после завершения установки.
  
![Снимок экрана, показывающий страницу "подключение к Azure AD".](./media/how-to-connect-install-custom/connectaad.png)

Если в вашей учетной записи глобального администратора включена многофакторная проверка подлинности, вы снова предоставляете пароль в окне входа, и вам необходимо выполнить запрос многофакторной проверки подлинности. Проблема может быть кодом проверки или телефонным звонком.  

![Снимок экрана, показывающий страницу "подключение к Azure AD". Поле многофакторной проверки подлинности запрашивает у пользователя код.](./media/how-to-connect-install-custom/connectaadmfa.png)

Для учетной записи глобального администратора также может быть включено [Управление привилегированными](../privileged-identity-management/pim-getting-started.md) пользователями.

Если отображается сообщение об ошибке или проблемы с подключением, см. раздел [Устранение неполадок подключения](tshoot-connect-connectivity.md).

## <a name="sync-pages"></a>Синхронизировать страницы

В следующих разделах описываются страницы в разделе **Синхронизация** .

### <a name="connect-your-directories"></a>Подключение к каталогам
Чтобы подключиться к службам домен Active Directory (Azure AD DS), Azure AD Connect требуется имя леса и учетные данные учетной записи, обладающей достаточными разрешениями.

![Снимок экрана, на котором показана страница "подключение каталогов".](./media/how-to-connect-install-custom/connectdir01.png)

После ввода имени леса и выбора элемента  **Добавить каталог** появится окно. В следующей таблице описаны параметры.

| Параметр | Описание |
| --- | --- |
| Создать учетную запись | Создайте учетную запись Azure AD DS, которая Azure AD Connect требуется для подключения к лесу Active Directory во время синхронизации службы каталогов. После выбора этого параметра введите имя пользователя и пароль для учетной записи администратора предприятия.  Azure AD Connect использует предоставленную учетную запись администратора предприятия для создания необходимой учетной записи AD DS Azure. Доменную часть можно ввести в формате NetBIOS или в формате полного доменного имени. То есть введите *фабрикам\администратор* или *Fabrikam. ком\администратор*. |
| Использовать существующую учетную запись | Укажите существующую учетную запись Azure AD DS, которая Azure AD Connect может использоваться для подключения к лесу Active Directory во время синхронизации службы каталогов. Доменную часть можно ввести в формате NetBIOS или в формате полного доменного имени. То есть введите *фабрикам\синкусер* или *Fabrikam. ком\синкусер*. Эта учетная запись может быть обычной учетной записью пользователя, так как ей требуются только разрешения на чтение по умолчанию. Но в зависимости от сценария может потребоваться больше разрешений. Дополнительные сведения см. в разделе [Учетная запись службы синхронизации Azure AD Connect](reference-connect-accounts-permissions.md#create-the-ad-ds-connector-account). |

![Снимок экрана со страницей "подключение каталога" и окном учетной записи леса D, в котором можно выбрать создание новой учетной записи или использовать существующую.](./media/how-to-connect-install-custom/connectdir02.png)

>[!NOTE]
> Начиная с сборки 1.4.18.0 вы не можете использовать учетную запись администратора предприятия или администраторов домена в качестве учетной записи соединителя Azure AD DS. При выборе вариант **использовать существующую учетную запись** при попытке ввести учетную запись администратора предприятия или учетную запись администратора домена появляется следующее сообщение об ошибке: "использование учетной записи администратора предприятия или домена для учетной записи леса AD запрещено. Позвольте Azure AD Connect создать учетную запись или указать учетную запись синхронизации с правильными разрешениями ".
>

### <a name="azure-ad-sign-in-configuration"></a>Конфигурация входа в Azure AD
На странице **Конфигурация входа в Azure AD** проверьте домены имени участника-пользователя (UPN) в локальном AD DS Azure. Эти домены UPN проверены в Azure AD. На этой странице настраивается атрибут, используемый для userPrincipalName.

![Снимок экрана, показывающий непроверенные домены на странице "Конфигурация входа в Azure A D".](./media/how-to-connect-install-custom/aadsigninconfig2.png)  

Проверьте каждый домен, помеченный как **не добавленный** или **не проверенный**. Убедитесь, что используемые домены проверены в Azure AD. После проверки доменов щелкните значок с круглым обновлением. Дополнительные сведения см. [в разделе Добавление и проверка домена](../fundamentals/add-custom-domain.md).

Пользователи используют атрибут *userPrincipalName* при входе в Azure AD и Microsoft 365. Прежде чем синхронизировать пользователей, Azure AD должна проверить домены, также называемые суффиксом имени участника-пользователя. Корпорация Майкрософт рекомендует хранить атрибут userPrincipalName по умолчанию. 

Если атрибут userPrincipalName не поддерживает маршрутизацию и не может быть проверен, можно выбрать другой атрибут. Например, можно выбрать адрес электронной почты в качестве атрибута, содержащего идентификатор входа. При использовании атрибута, отличного от userPrincipalName, он называется *альтернативным идентификатором*. 

Значение атрибута альтернативного идентификатора должно соответствовать стандарту RFC 822. Можно использовать альтернативный идентификатор с синхронизацией хэша паролей, сквозной аутентификацией и интеграцией. В Active Directory атрибут нельзя определить как многозначный, даже если он содержит только одно значение. Дополнительные сведения об альтернативном ИДЕНТИФИКАТОРе см. в разделе ["сквозная проверка подлинности". часто задаваемые вопросы](./how-to-connect-pta-faq.md#does-pass-through-authentication-support-alternate-id-as-the-username-instead-of-userprincipalname).

>[!NOTE]
> При включении сквозной проверки подлинности необходимо иметь по крайней мере один проверенный домен, чтобы продолжить процесс выборочной установки.

> [!WARNING]
> Альтернативные идентификаторы несовместимы со всеми Microsoft 365 рабочими нагрузками. Дополнительные сведения см. в разделе [Настройка альтернативных идентификаторов входа](/windows-server/identity/ad-fs/operations/configuring-alternate-login-id).
>

### <a name="domain-and-ou-filtering"></a>Фильтрация домена и подразделения
По умолчанию все домены и организационные единицы (OU) синхронизируются. Если вы не хотите синхронизировать некоторые домены или подразделения с Azure AD, можно снять соответствующие флажки.  

![Снимок экрана, показывающий страницу фильтрации в домене и O U.](./media/how-to-connect-install-custom/domainoufiltering.png)  

На этой странице настраивается фильтрация на основе домена и подразделений. Если планируется внести изменения, см. раздел [Фильтрация на основе домена](how-to-connect-sync-configure-filtering.md#domain-based-filtering) и [Фильтрация по подразделениям](how-to-connect-sync-configure-filtering.md#organizational-unitbased-filtering). Некоторые подразделения являются обязательными для функциональности, поэтому их следует оставить выбранными.

При использовании фильтрации на основе подразделений с Azure AD Connectной версией, отличной от 1.1.524.0, новые подразделения синхронизируются по умолчанию. Если вы не хотите синхронизировать новые подразделения, можно изменить поведение по умолчанию после шага [фильтрации по подразделениям](how-to-connect-sync-configure-filtering.md#organizational-unitbased-filtering) . Для Azure AD Connect 1.1.524.0 или более поздней версии можно указать, следует ли синхронизировать новые подразделения.

Если вы планируете использовать [фильтрацию на основе групп](#sync-filtering-based-on-groups), убедитесь, что подразделение с группой включено и не отфильтровано с помощью ФИЛЬТРАЦИИ подразделений. Фильтрация по подразделениям вычисляется до оценки фильтрации на основе групп.

Также возможно, что некоторые домены недостижимы из-за ограничений брандмауэра. Эти домены не выбираются по умолчанию и выводят предупреждение.  

![Снимок экрана, показывающий недостижимые домены.](./media/how-to-connect-install-custom/unreachable.png)  

Если вы видите это предупреждение, убедитесь, что эти домены действительно недоступны и ожидается предупреждение.

### <a name="uniquely-identifying-your-users"></a>Уникальная идентификация пользователей

На странице **Идентификация пользователей** выберите способ определения пользователей в локальных каталогах и способ их идентификации с помощью атрибута sourceAnchor.

#### <a name="select-how-users-should-be-identified-in-your-on-premises-directories"></a>Выбор способа идентификации пользователей в локальных каталогах
С помощью функции *сопоставления в лесах* можно определить, как пользователи из лесов Azure AD DS будут представлены в Azure AD. Пользователь может быть представлен только один раз во всех лесах или может иметь сочетание включенных и отключенных учетных записей. В некоторых лесах пользователь также может быть представлен как контакт.

![Снимок экрана, показывающий страницу, на которой можно однозначно идентифицировать пользователей.](./media/how-to-connect-install-custom/unique2.png)

| Параметр | Описание |
| --- | --- |
| [Пользователи представляются только один раз во всех лесах](plan-connect-topologies.md#multiple-forests-single-azure-ad-tenant) |В Azure AD все пользователи создаются как отдельные объекты. Объекты не присоединены в метавселенной. |
| [Атрибут почты](plan-connect-topologies.md#multiple-forests-single-azure-ad-tenant) |Этот параметр соединяет пользователей и контакты, если атрибут почты имеет то же значение в разных лесах. Используйте этот параметр, если ваши контакты были созданы с помощью GALSync. При выборе этого параметра объекты-пользователи, атрибут почты которых не заполняется, не синхронизируются с Azure AD. |
| [Атрибуты ObjectSID и Мсексчанжемастераккаунтсид/msRTCSIP-OriginatorSID](plan-connect-topologies.md#multiple-forests-single-azure-ad-tenant) |Этот параметр соединяет включенного пользователя в лесу учетной записи с отключенным пользователем в лесу ресурсов. В Exchange такая конфигурация называется связанным почтовым ящиком. Этот параметр можно использовать, если вы используете только Lync, и если Exchange нет в лесу ресурсов. |
| Атрибутов SAMAccountName и MailNickName |Этот параметр объединяет атрибуты, в которых ожидается, что идентификатор входа для пользователя будет найден. |
| Выберите конкретный атрибут |Этот параметр позволяет выбрать собственный атрибут. Если выбран этот параметр, то объекты пользователя, для которых не заполнен атрибут (выбранные), не синхронизируются с Azure AD. **Ограничение:** Для этого параметра доступны только те атрибуты, которые уже находятся в метавселенной. |

#### <a name="select-how-users-should-be-identified-by-using-a-source-anchor"></a>Выбор метода идентификации пользователей с помощью привязки к источнику
Атрибут *sourceAnchor* является неизменяемым в течение времени существования объекта пользователя. Это первичный ключ, связывающий локального пользователя с пользователем в Azure AD.

| Параметр | Описание |
| --- | --- |
| Разрешить Azure управлять привязкой к источнику | Выберите этот параметр, если вы хотите, чтобы среда Azure AD выбирала этот атрибут автоматически. Если выбран этот параметр, Azure AD Connect применяет логику выбора атрибута sourceAnchor, описанную в статье [использование MS-DS-ConsistencyGuid в качестве sourceAnchor](plan-connect-design-concepts.md#using-ms-ds-consistencyguid-as-sourceanchor). После завершения выборочной установки вы увидите, какой атрибут был выбран в качестве атрибута sourceAnchor. |
| Выберите конкретный атрибут | Выберите этот параметр, если необходимо указать существующий атрибут AD в качестве атрибута sourceAnchor. |

Так как атрибут sourceAnchor нельзя изменить, необходимо выбрать соответствующий атрибут. Хорошим кандидатом является objectGUID. Этот атрибут не изменяется, если учетная запись пользователя не перемещена между лесами или доменами. Не выбирайте атрибуты, которые могут изменяться при сочетает или изменении назначений пользователем. 

Нельзя использовать атрибуты, включающие символ @, поэтому нельзя использовать сообщения электронной почты и userPrincipalName. В атрибуте также учитывается регистр, поэтому при перемещении объекта между лесами обязательно сохраните прописные и строчные буквы. Двоичные атрибуты кодируются в формате Base64, но другие типы атрибутов остаются в их незакодированном состоянии. 

В сценариях Федерации и некоторых интерфейсах Azure AD атрибут sourceAnchor также называется *immutableID*. 

Дополнительные сведения об исходной привязке см. в разделе [Основные понятия разработки](plan-connect-design-concepts.md#sourceanchor).

### <a name="sync-filtering-based-on-groups"></a>Фильтрация синхронизации на основе групп
Функция фильтрации по группам позволяет синхронизировать только небольшое подмножество объектов для пилотного развертывания. Чтобы использовать эту функцию, создайте группу для этой цели в локальном экземпляре Active Directory. Затем добавьте пользователей и группы, которые должны синхронизироваться с Azure AD как прямые участники. Позже можно будет добавить пользователей или удалить пользователей из этой группы, чтобы сохранить список объектов, которые должны присутствовать в Azure AD. 

Все объекты, которые требуется синхронизировать, должны быть прямыми членами группы. Пользователи, группы, контакты и компьютеры или устройства должны быть прямыми членами. Членство в вложенной группе не разрешено. При добавлении группы в качестве члена добавляется только сама группа. Его члены не добавляются.

![Снимок экрана, на котором показана страница, на которой можно выбрать способ фильтрации пользователей и устройств.](./media/how-to-connect-install-custom/filter2.png)

> [!WARNING]
> Эта функция предназначена для поддержки только пилотного развертывания. Не используйте его в полном рабочем развертывании.
>

В полном производственном развертывании было бы сложно поддерживать одну группу и все ее объекты для синхронизации. Вместо функции фильтрации по группам используйте один из методов, описанных в разделе [Настройка фильтрации](how-to-connect-sync-configure-filtering.md).

### <a name="optional-features"></a>Дополнительные функции
На следующей странице можно выбрать дополнительные компоненты для своего сценария.

>[!WARNING]
>Azure AD Connect версии 1.0.8641.0 и более ранние используют службу контроля доступа Azure для обратной записи паролей.  Эта служба была снята с 7 ноября 2018 г.  Если вы используете любую из этих версий Azure AD Connect и включили обратную запись паролей, пользователи могут потерять возможность изменять или сбрасывать свои пароли при прекращении использования службы. Эти версии Azure AD Connect не поддерживают обратную запись паролей.
>
>Дополнительные сведения см. [в статье миграция из службы контроля доступа Azure](../azuread-dev/active-directory-acs-migration.md).
>
>Если вы хотите использовать обратную запись паролей, скачайте [последнюю версию Azure AD Connect](https://www.microsoft.com/download/details.aspx?id=47594).

![Снимок экрана, показывающий страницу "дополнительные компоненты".](./media/how-to-connect-install-custom/optional2a.png)

> [!WARNING]
> Если Azure AD Sync или прямая синхронизация (DirSync) активны, не активируйте функции обратной записи в Azure AD Connect.



| Дополнительные функции | Описание |
| --- | --- |
| Гибридное развертывание Exchange |Функция гибридного развертывания Exchange позволяет сосуществование почтовых ящиков Exchange как локально, так и в Microsoft 365. Azure AD Connect синхронизирует конкретный набор [атрибутов](reference-connect-sync-attributes-synchronized.md#exchange-hybrid-writeback) из Azure AD обратно в локальный каталог. |
| Общие папки почты Exchange | Функция общих папок электронной почты Exchange позволяет синхронизировать объекты общих папок с поддержкой электронной почты из локального экземпляра Active Directory с Azure AD. |
| Фильтрации приложений и атрибутов Azure AD |Включив фильтрацию приложений и атрибутов Azure AD, можно настроить набор синхронизированных атрибутов. При установке этого параметра в мастер добавляется две дополнительные страницы конфигурации. Дополнительные сведения см. в разделе [Фильтрации приложений и атрибутов Azure AD](#azure-ad-app-and-attribute-filtering). |
| Синхронизация хэша паролей |Если вы выбрали Федерацию в качестве решения для входа, можно включить синхронизацию хэшей паролей. Затем его можно использовать в качестве параметра резервного копирования.  </br></br>Если выбрана сквозная проверка подлинности, можно включить этот параметр, чтобы обеспечить поддержку устаревших клиентов и предоставить резервную копию.</br></br> Дополнительные сведения см. в статье [Синхронизация хэшей паролей](how-to-connect-password-hash-synchronization.md).|
| Компонент обратной записи паролей |Используйте этот параметр, чтобы гарантировать, что изменения паролей, поступающие в Azure AD, записываются обратно в локальный каталог. Дополнительные сведения см. в статье [Приступая к работе с компонентами управления паролями](../authentication/tutorial-enable-sspr.md). |
| Обратная запись групп |Если вы используете Microsoft 365 группы, то можете представлять группы в локальном экземпляре Active Directory. Этот параметр доступен только при наличии Exchange в локальном экземпляре Active Directory. Дополнительные сведения см. в разделе [Azure AD Connectная запись в группу](how-to-connect-group-writeback.md).|
| Обратная запись устройств |Для сценариев условного доступа Используйте этот параметр для записи объектов устройства в Azure AD в локальный экземпляр Active Directory. Дополнительные сведения см. в статье [Azure AD Connect: включение обратной записи устройств](how-to-connect-device-writeback.md). |
| Синхронизация атрибутов расширения каталога |Выберите этот параметр, чтобы синхронизировать указанные атрибуты с Azure AD. Дополнительные сведения см. в статье о [расширениях каталогов](how-to-connect-sync-feature-directory-extensions.md). |

### <a name="azure-ad-app-and-attribute-filtering"></a>Фильтрации приложений и атрибутов Azure AD
Если вы хотите ограничить атрибуты, которые синхронизируются с Azure AD, начните с выбора используемых служб. При изменении параметров на этой странице необходимо явно выбрать новую службу, выполнив мастер установки.

![Снимок экрана, показывающий дополнительные возможности приложений Azure A D.](./media/how-to-connect-install-custom/azureadapps2.png)

В зависимости от служб, выбранных на предыдущем шаге, на этой странице отображаются все синхронизируемые атрибуты. Этот список представляет собой сочетание всех синхронизируемых типов объектов. Если требуется, чтобы атрибуты оставались несинхронизированными, можно снять выделение с этих атрибутов.

![Снимок экрана, показывающий дополнительные функции атрибутов Azure A D.](./media/how-to-connect-install-custom/azureadattributes2.png)

> [!WARNING]
> Удаление атрибутов может повлиять на функциональность. Рекомендации и рекомендации см. в разделе [атрибуты для синхронизации](reference-connect-sync-attributes-synchronized.md#attributes-to-synchronize).
>

### <a name="directory-extension-attribute-sync"></a>Синхронизация атрибутов расширения каталога
Схему в Azure AD можно расширить с помощью настраиваемых атрибутов, добавленных вашей организацией, или с помощью других атрибутов в Active Directory. Чтобы использовать эту функцию, на странице **Дополнительные компоненты** выберите **синхронизировать атрибут расширения каталога**. На странице **расширения каталогов** можно выбрать дополнительные атрибуты для синхронизации.

>[!NOTE]
>В поле **Доступные атрибуты** учитывается регистр.

![Снимок экрана, показывающий страницу "расширения каталогов".](./media/how-to-connect-install-custom/extension2.png)

Дополнительные сведения см. в статье о [расширениях каталогов](how-to-connect-sync-feature-directory-extensions.md).

### <a name="enabling-single-sign-on"></a>Включение единого входа
На странице **единый вход** настройте единый вход для использования с синхронизацией паролей или сквозной проверкой подлинности. Этот шаг выполняется один раз для каждого леса, который синхронизируется с Azure AD. Конфигурация состоит из двух этапов:

1.  Создайте необходимую учетную запись компьютера в локальном экземпляре Active Directory.
2.  Настройте зону интрасети клиентских компьютеров для поддержки единого входа.

#### <a name="create-the-computer-account-in-active-directory"></a>Создание учетной записи компьютера в Active Directory
Для каждого леса, добавленного в Azure AD Connect, необходимо указать учетные данные администратора домена, чтобы учетная запись компьютера могла быть создана в каждом лесу. Учетные данные используются только для создания учетной записи. Они не хранятся и не используются для любой другой операции. Добавьте учетные данные на странице **Включение единого входа** , как показано на следующем рисунке.

![Снимок экрана, показывающий страницу "Включение единого входа". Добавляются учетные данные леса.](./media/how-to-connect-install-custom/enablesso.png)

>[!NOTE]
>Вы можете пропустить леса, в которых вы не хотите использовать единый вход.

#### <a name="configure-the-intranet-zone-for-client-machines"></a>Настройка зоны интрасети для клиентских компьютеров
Чтобы обеспечить автоматический вход клиента в зоне интрасети, убедитесь, что URL-адрес входит в зону интрасети. Этот шаг гарантирует, что компьютер, присоединенный к домену, автоматически отправит билет Kerberos в Azure AD при подключении к корпоративной сети.

На компьютере, где есть средства управления групповая политика:

1.  Откройте средства управления групповая политика.
2.  Измените групповую политику, которая будет применяться ко всем пользователям. Например, политика домена по умолчанию.
3.  Перейдите в раздел **Конфигурация пользователя**  >  **Административные шаблоны**  >  **компоненты Windows**  >  **Internet Explorer**  >  Страница Безопасность **панели управления Интернет**  >  . Выберите **Список назначений зоны для веб-сайтов**.
4.  Включите политику. Затем в диалоговом окне введите имя `https://autologon.microsoftazuread-sso.com` и значение `1` . Программа установки должна выглядеть, как на следующем рисунке.
  
    ![Снимок экрана, показывающий зоны интрасети.](./media/how-to-connect-install-custom/sitezone.png)

6.  Дважды нажмите кнопку **ОК** .

## <a name="configuring-federation-with-ad-fs"></a>Настройка федерации с AD FS
Вы можете настроить AD FS с Azure AD Connect всего за несколько щелчков мышью. Прежде чем начать, вам потребуется:

* Windows Server 2012 R2 или более поздней версии для сервера федерации. Удаленное управление должно быть включено.
* Windows Server 2012 R2 или более поздней версии для прокси-сервера веб – приложения. Удаленное управление должно быть включено.
* Сертификат TLS/SSL для имени службы федерации, которое вы собираетесь использовать (например, sts.contoso.com).

>[!NOTE]
>Вы можете обновить сертификат TLS/SSL для AD FS фермы с помощью Azure AD Connect даже в том случае, если вы не используете его для управления доверием федерации.

### <a name="ad-fs-configuration-prerequisites"></a>Предварительные требования для настройки AD FS
Чтобы настроить ферму AD FS с помощью Azure AD Connect, убедитесь, что служба WinRM включена на удаленных серверах. Убедитесь, что вы выполнили другие задачи в [предварительных требованиях к Федерации](how-to-connect-install-prerequisites.md#prerequisites-for-federation-installation-and-configuration). Также убедитесь в соблюдении требований к портам, перечисленным в таблице [Azure AD Connect и Федерацию/WAP-серверы](reference-connect-ports.md#table-3---azure-ad-connect-and-ad-fs-federation-serverswap) .

### <a name="create-a-new-ad-fs-farm-or-use-an-existing-ad-fs-farm"></a>Создание новой фермы AD FS или использование существующей фермы AD FS
Можно использовать существующую ферму AD FS или создать новую. Если вы решили создать новый объект, необходимо указать сертификат TLS/SSL. Если сертификат TLS/SSL защищен паролем, вам будет предложено ввести пароль.

![Снимок экрана, показывающий страницу "ферма D F S"](./media/how-to-connect-install-custom/adfs1.png)

Если вы решили использовать существующую ферму AD FS, отобразится страница, на которой можно настроить отношение доверия между AD FS и Azure AD.

>[!NOTE]
>Azure AD Connect можно использовать для управления только одной фермой AD FS. Если у вас есть отношение доверия федерации, где Azure AD настроена в выбранной AD FS ферме, Azure AD Connect повторно создает отношение доверия с нуля.

### <a name="specify-the-ad-fs-servers"></a>Указание серверов AD FS
Укажите серверы, на которых требуется установить AD FS. В зависимости от потребностей в емкости можно добавить один или несколько серверов. Перед настройкой этой конфигурации присоедините все AD FS серверы к Active Directory. Этот шаг не является обязательным для прокси-серверов приложений. 

Мы рекомендуем установить одиночный сервер AD FS для тестовых и пилотных развертываний. После первоначальной настройки можно добавить и развернуть дополнительные серверы в соответствии с потребностями масштабирования, повторно запустив Azure AD Connect.

> [!NOTE]
> Перед настройкой этой конфигурации убедитесь, что все серверы присоединены к домену Azure AD.
>


![Снимок экрана, показывающий страницу "серверы федерации".](./media/how-to-connect-install-custom/adfs2.png)

### <a name="specify-the-web-application-proxy-servers"></a>Указание прокси-серверов веб-приложений
Укажите серверы прокси-службы для веб приложения. Сервер прокси веб-приложения развернут в сети периметра и находится в экстрасети. Он поддерживает запросы проверки подлинности из экстрасети. В зависимости от потребностей в емкости можно добавить один или несколько серверов. 

Корпорация Майкрософт рекомендует установить один прокси-сервер для тестирования и пилотного развертывания. После первоначальной настройки можно добавить и развернуть дополнительные серверы в соответствии с потребностями масштабирования, повторно запустив Azure AD Connect. Для проверки подлинности из интрасети рекомендуется использовать эквивалентное число прокси-серверов.

> [!NOTE]
> - Если используемая учетная запись не является локальным администратором на прокси-серверах веб приложения, вам будет предложено ввести учетные данные администратора.
> - Перед указанием прокси-серверов веб приложения убедитесь в наличии подключения HTTP/HTTPS между сервером Azure AD Connect и прокси-сервером веб – приложения.
> - Убедитесь в наличии подключения HTTP/HTTPS между сервером веб-приложений и сервером AD FS, чтобы разрешить выполнение запросов проверки подлинности.
>


![Снимок экрана со страницей прокси-серверов веб приложения.](./media/how-to-connect-install-custom/adfs3.png)

Вам будет предложено ввести учетные данные, чтобы сервер веб-приложений мог установить безопасное подключение к серверу AD FS. Эти учетные данные должны быть учетной записью локального администратора на AD FS сервере.

![Снимок экрана, показывающий страницу "учетные данные". Учетные данные администратора помещаются в поле Username (имя пользователя) и Password (пароль).](./media/how-to-connect-install-custom/adfs4.png)

### <a name="specify-the-service-account-for-the-ad-fs-service"></a>Укажите учетную запись службы для службы AD FS
Службе AD FS требуется учетная запись службы домена для проверки подлинности пользователей и поиска сведений о пользователях в Active Directory. Поддерживаются два типа учетных записей службы.

* **Групповая управляемая учетная запись службы**. Этот тип учетной записи был введен в AD DS Windows Server 2012. Этот тип учетной записи предоставляет такие службы, как AD FS. Это одна учетная запись, в которой не требуется регулярно обновлять пароль. Используйте этот параметр, если у вас уже есть контроллеры домена Windows Server 2012 в домене, к которому принадлежат серверы AD FS.
* **Учетная запись пользователя домена**. для этого типа учетной записи необходимо указать пароль и регулярно обновлять его по истечении срока действия. Используйте этот параметр, только если у вас нет контроллеров домена Windows Server 2012 в домене, к которому принадлежат серверы AD FS.

Если вы выбрали **создать групповую управляемую учетную запись службы** , и эта функция никогда не использовалась в Active Directory, введите учетные данные администратора предприятия. Эти учетные данные необходимы, чтобы инициировать хранилище ключей и включить эту учетную запись в Active Directory.

> [!NOTE]
> Azure AD Connect проверяет, зарегистрирована ли служба AD FS в домене как имя субъекта-службы (SPN).  AD DS Azure не позволяет регистрировать дублирующиеся имена участников-служб одновременно.  Если найдено повторяющееся имя субъекта-службы, вы не сможете продолжить работу, пока не будет удалено имя субъекта-службы.

![Снимок экрана со страницей "A D F S учетная запись службы".](./media/how-to-connect-install-custom/adfs5.png)

### <a name="select-the-azure-ad-domain-that-you-want-to-federate"></a>Выберите домен Azure AD, который вы хотите включить в Федерацию
Используйте страницу **домена Azure AD** , чтобы настроить отношение федерации между AD FS и Azure AD. Здесь вы настраиваете AD FS для предоставления маркеров безопасности Azure AD. Вы также настроите Azure AD, чтобы доверять токенам от этого AD FS экземпляра. 

На этой странице можно настроить только один домен в первоначальной установке. Позже можно настроить дополнительные домены, запустив Azure AD Connect еще раз.

![Снимок экрана, на котором показана страница "домен Azure A D".](./media/how-to-connect-install-custom/adfs6.png)

### <a name="verify-the-azure-ad-domain-selected-for-federation"></a>Проверка домена Azure AD, выбранного для включения в федерацию
При выборе домена, который необходимо включить в Федерацию, Azure AD Connect предоставляет сведения, которые можно использовать для проверки непроверенного домена. Дополнительные сведения см. [в разделе Добавление и проверка домена](../fundamentals/add-custom-domain.md).

![Снимок экрана, показывающий страницу "домен Azure A D", включая сведения, которые можно использовать для проверки домена.](./media/how-to-connect-install-custom/verifyfeddomain.png)

> [!NOTE]
> Azure AD Connect пытается проверить домен на этапе настройки. Если не добавить необходимые записи службы доменных имен (DNS), настройка не будет завершена.
>


## <a name="configuring-federation-with-pingfederate"></a>Настройка федерации с PingFederate
Вы можете настроить PingFederate с помощью Azure AD Connect всего за несколько щелчков мышью. Ниже перечислены необходимые компоненты.
- PingFederate 8,4 или более поздней версии.  Дополнительные сведения см. в статье [Интеграция PingFederate с Azure Active Directory и Microsoft 365](https://docs.pingidentity.com/bundle/O365IG20_sm_integrationGuide/page/O365IG_c_integrationGuide.html).
- Сертификат TLS/SSL для имени службы федерации, которое вы собираетесь использовать (например, sts.contoso.com).

### <a name="verify-the-domain"></a>Проверка домена
После того как вы решили настроить федерацию с помощью PingFederate, вам будет предложено проверить домен, который необходимо включить в Федерацию.  Выберите домен в раскрывающемся меню.

![Снимок экрана, на котором показана страница "домен Azure A D". Выбран пример домена "contoso.com".](./media/how-to-connect-install-custom/ping1.png)

### <a name="export-the-pingfederate-settings"></a>Экспорт параметров PingFederate


Настройте PingFederate в качестве сервера федерации для каждого федеративного домена Azure.  Выберите **Параметры экспорта** , чтобы поделиться этими сведениями с администратором PingFederate.  Администратор сервера федерации обновляет конфигурацию, а затем предоставляет URL-адрес сервера PingFederate и номер порта, чтобы Azure AD Connect можно было проверить параметры метаданных.  

![Снимок экрана, показывающий страницу "Параметры PingFederate". В верхней части страницы появится кнопка "экспорт параметров".](./media/how-to-connect-install-custom/ping2.png)

Если при проверке возникнут проблемы, обратитесь к администратору PingFederate для их устранения.  На следующем рисунке показаны сведения о сервере PingFederate, который не имеет допустимого отношения доверия с Azure.

![Снимок экрана со сведениями о сервере: обнаружен сервер PingFederate, но подключение к поставщику услуг для Azure отсутствует или отключено.](./media/how-to-connect-install-custom/ping5.png)




### <a name="verify-federation-connectivity"></a>Проверка подключения федерации
Azure AD Connect пытается проверить конечные точки проверки подлинности, извлекаемые из метаданных PingFederate на предыдущем шаге.  Azure AD Connect сначала пытается разрешить конечные точки с помощью локальных DNS-серверов.  Затем он пытается разрешить конечные точки с помощью внешнего поставщика DNS.  Если при проверке возникнут проблемы, обратитесь к администратору PingFederate для их устранения.  

![Снимок экрана, показывающий страницу "Проверка подключения".](./media/how-to-connect-install-custom/ping3.png)

### <a name="verify-federation-sign-in"></a>Проверка входа федерации
Теперь вы можете проверить процесс входа в настроенной федерации, выполнив вход в федеративный домен. Если вход выполнен успешно, то Федерация с PingFederate будет успешно настроена.

![Снимок экрана, показывающий страницу "Проверка федеративного входа". В нижней части сообщения указывается успешный вход в систему.](./media/how-to-connect-install-custom/ping4.png)

## <a name="configure-and-verify-pages"></a>Страницы настройки и проверки
Конфигурация происходит на странице **Настройка** .

> [!NOTE]
> Если вы настроили Федерацию, убедитесь, что вы также настроили [разрешение имен для серверов федерации](how-to-connect-install-prerequisites.md#name-resolution-for-federation-servers) , прежде чем продолжить установку.
>



![Снимок экрана, показывающий страницу "готовность к настройке".](./media/how-to-connect-install-custom/readytoconfigure2.png)

### <a name="use-staging-mode"></a>Использовать промежуточный режим
Новый сервер синхронизации можно настроить параллельно с промежуточным режимом. Если вы хотите использовать эту программу установки, то только один сервер синхронизации может экспортировать в один каталог в облаке. Но если вы хотите переместиться с другого сервера, например с сервера DirSync, можно включить Azure AD Connect в промежуточном режиме. 

При включении промежуточной установки модуль синхронизации импортирует и синхронизирует данные в нормальном режиме. Но не экспортирует данные в Azure AD или Active Directory. В промежуточном режиме функция синхронизации паролей и функция обратной записи паролей отключены.

![Снимок экрана, показывающий параметр "включить промежуточный режим".](./media/how-to-connect-install-custom/stagingmode.png)

В промежуточном режиме можно внести необходимые изменения в модуль синхронизации и проверить, что будет экспортировано. Если вы довольны конфигурацией, снова запустите мастер установки и отключите промежуточный режим. 

Теперь данные экспортируются в Azure AD с сервера. Обязательно отключите другой сервер, чтобы только один сервер активно экспортировал данные.

Дополнительные сведения см. в разделе [Промежуточный режим](how-to-connect-sync-staging-server.md).

### <a name="verify-your-federation-configuration"></a>Проверьте конфигурации федерации
Azure AD Connect проверяет параметры DNS при нажатии кнопки " **проверить** ". Он проверяет следующие параметры:

* **Подключение к интрасети**
    * Разрешение полного доменного имени Федерации: Azure AD Connect проверяет, может ли DNS разрешить полное доменное имя Федерации для обеспечения подключения. Если Azure AD Connect не удается разрешить полное доменное имя, проверка завершится сбоем. Чтобы завершить проверку, убедитесь, что для полного доменного имени службы федерации имеется запись DNS.
    * Запись A DNS. Azure AD Connect проверяет, имеет ли ваша служба федерации запись A. При отсутствии записи A проверка завершается ошибкой. Чтобы завершить проверку, создайте запись A (а не запись CNAME) для своего полного доменного имени Федерации.
* **Подключение к экстрасети**
    * Разрешение полного доменного имени Федерации: Azure AD Connect проверяет, может ли DNS разрешить полное доменное имя Федерации для обеспечения подключения.

      ![Снимок экрана, показывающий страницу "Завершение установки".](./media/how-to-connect-install-custom/completed.png)

      ![Снимок экрана, показывающий страницу "Завершение установки". Сообщение указывает на то, что конфигурация интрасети была проверена.](./media/how-to-connect-install-custom/adfs7.png)

Чтобы проверить сквозную проверку подлинности, вручную выполните один или несколько следующих тестов.

* После завершения синхронизации в Azure AD Connect используйте дополнительную задачу **Проверка федеративного входа** , чтобы проверить подлинность для выбранной локальной учетной записи пользователя.
* С компьютера, присоединенного к домену, в интрасети убедитесь, что вы можете войти в систему из браузера. соединение с https://myapps.microsoft.com; Затем используйте учетную запись для входа, чтобы проверить вход. Встроенная учетная запись администратора AD DS Azure не синхронизирована, и ее нельзя использовать для проверки.
* Убедитесь, что вы можете выполнить вход с устройства в экстрасети. На домашнем компьютере или мобильном устройстве подключитесь к https://myapps.microsoft.com . Затем укажите учетные данные.
* Проверьте возможность входа клиента с расширенными возможностями. соединение с https://testconnectivity.microsoft.com; Затем выберите **Office 365**  >  **Office 365 единый Sign-On Test**.

## <a name="troubleshoot"></a>Диагностика
В этом разделе содержатся сведения об устранении неполадок, которые можно использовать, если при установке Azure AD Connect возникла проблема.

При настройке установки Azure AD Connect на странице **Установка необходимых компонентов** можно выбрать параметр **использовать существующую SQL Server**. Может появиться следующая ошибка: "база данных ADSync уже содержит данные и не может быть перезаписана. Удалите существующую базу данных и повторите попытку ".

![Снимок экрана, на котором показана страница "Установка необходимых компонентов". В нижней части страницы появится сообщение об ошибке.](./media/how-to-connect-install-custom/error1.png)

Вы видите эту ошибку, так как база данных с именем *ADSync* уже существует в указанном экземпляре SQL SQL Server.

Эта ошибка обычно появляется после удаления Azure AD Connect.  База данных не удаляется с компьютера, на котором выполняется SQL Server при удалении Azure AD Connect.

Для устранения этой проблемы:

1. Проверьте базу данных ADSync, которую Azure AD Connect использовать перед удалением. Убедитесь, что база данных больше не используется.

2. Архивируйте базу данных.

3. Удалите базу данных:
    1. Для подключения к экземпляру SQL используйте **Microsoft SQL Server Management Studio** . 
    1. Найдите базу данных **ADSync** и щелкните ее правой кнопкой мыши.
    1. В контекстном меню выберите команду **Удалить**.
    1. Нажмите кнопку **ОК** , чтобы удалить базу данных.

![Снимок экрана, на котором показано Microsoft SQL Server Management Studio. Выбрана синхронизация D.](./media/how-to-connect-install-custom/error2.png)

После удаления базы данных ADSync нажмите кнопку **установить** , чтобы повторить попытку установки.

## <a name="next-steps"></a>Дальнейшие действия
После завершения установки выйдите из Windows. Затем выполните вход еще раз, прежде чем использовать Synchronization Service Manager или редактор правил синхронизации.

После установки Azure AD Connect можно [проверить установку и назначить лицензии](how-to-connect-post-installation.md).

Дополнительные сведения о функциях, включенных во время установки, см. в разделе [предотвращение случайного удаления](how-to-connect-sync-feature-prevent-accidental-deletes.md) и [Azure AD Connect Health](how-to-connect-health-sync.md).

Дополнительные сведения о других распространенных разделах см. в разделах [Azure AD Connect Sync: Scheduler](how-to-connect-sync-feature-scheduler.md) и [интеграция локальных удостоверений с Azure AD](whatis-hybrid-identity.md).
