---
title: Как исправить измененные правила по умолчанию — Azure AD Connect | Документация Майкрософт
description: Узнайте, как исправить измененные правила по умолчанию, которые входят в состав Azure AD Connect.
services: active-directory
author: billmath
manager: daveba
editor: curtand
ms.reviewer: darora10
ms.service: active-directory
ms.workload: identity
ms.topic: how-to
ms.date: 03/21/2019
ms.subservice: hybrid
ms.author: billmath
ms.collection: M365-identity-device-management
ms.openlocfilehash: a0fc1bc3158e04c9b1f677af7ef2375ac3ed2ce7
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "91320053"
---
# <a name="fix-modified-default-rules-in-azure-ad-connect"></a>Исправить измененные правила по умолчанию в Azure AD Connect

Azure Active Directory (Azure AD) Connect использует правила по умолчанию для синхронизации.  К сожалению, эти правила не применяются универсально ко всем организациям. В зависимости от ваших требований может потребоваться изменить их. В этой статье обсуждаются два примера наиболее распространенных настроек и объясняется правильный способ достижения этих настроек.

>[!NOTE] 
> Изменение существующих правил по умолчанию для достижения необходимой настройки не поддерживается. Это не позволит обновить эти правила до последней версии в будущих выпусках. Вы не получите нужные исправления ошибок или новые функции. В этом документе объясняется, как добиться того же результата без изменения существующих правил по умолчанию. 

## <a name="how-to-identify-modified-default-rules"></a>Определение измененных правил по умолчанию
Начиная с версии 1.3.7.0 Azure AD Connect можно легко найти измененное правило по умолчанию. Перейдите в раздел **приложения на рабочем столе** и выберите **Редактор правил синхронизации**.

![Azure AD Connect, с выделенным редактором правил синхронизации](media/how-to-connect-fix-default-rules/default1.png)

В редакторе все измененные правила по умолчанию отображаются с значком предупреждения перед именем.

![Значок предупреждения](media/how-to-connect-fix-default-rules/default2.png)

 Кроме того, отображается отключенное правило с тем же именем (это стандартное правило по умолчанию).

![Редактор правил синхронизации, отображающий стандартное правило по умолчанию и измененное правило по умолчанию](media/how-to-connect-fix-default-rules/default2a.png)

## <a name="common-customizations"></a>Общие настройки
Ниже приведены общие настройки правил по умолчанию.

- Изменение потока атрибутов
- Изменить фильтр области
- Изменение условия объединения

Перед изменением правил выполните следующие действия.

- Отключите Планировщик синхронизации. По умолчанию планировщик запускается каждые 30 минут. Убедитесь, что оно не начинается при внесении изменений и устранении неполадок в новых правилах. Чтобы временно отключить планировщик, запустите PowerShell и выполните команду `Set-ADSyncScheduler -SyncCycleEnabled $false` .
 ![Команды PowerShell для отключения планировщика синхронизации](media/how-to-connect-fix-default-rules/default3.png)

- Изменение в фильтре области может привести к удалению объектов в целевом каталоге. Будьте внимательны, прежде чем вносить изменения в области объектов. Перед внесением изменений на активном сервере рекомендуется внести изменения в промежуточный сервер.
- Выполните предварительный просмотр для одного объекта, как упоминалось в разделе [Проверка правила синхронизации](#validate-sync-rule) после добавления нового правила.
- Выполните полную синхронизацию после добавления нового правила или изменения любого настраиваемого правила синхронизации. Эта синхронизация применяет новые правила ко всем объектам.

## <a name="change-attribute-flow"></a>Изменение потока атрибутов
Существует три разных сценария для изменения потока атрибутов:
- Добавление нового атрибута.
- Переопределение значения существующего атрибута.
- Выбор параметра не синхронизировать существующий атрибут.

Это можно сделать без изменения стандартных правил по умолчанию.

### <a name="add-a-new-attribute"></a>Добавить новый атрибут
Если вы обнаружите, что атрибут не передается из исходного каталога в целевой, используйте [расширения каталогов Azure AD Connect Sync:](how-to-connect-sync-feature-directory-extensions.md) , чтобы устранить эту проблему.

Если расширения не работают, попробуйте добавить два новых правила синхронизации, описанные в следующих разделах.


#### <a name="add-an-inbound-sync-rule"></a>Добавление входящего правила синхронизации
Входящее правило синхронизации означает, что источником атрибута является пространство соединителя, а целевым объектом являются метавселенной. Например, чтобы создать новый поток атрибутов из локальной Active Directory для Azure Active Directory, создайте новое правило синхронизации для входящего трафика. Запустите **Редактор правил синхронизации**, выберите **входящий** в качестве направления и щелкните **Добавить новое правило**. 

 ![Снимок экрана, на котором показан "Редактор правил синхронизации" с выбранным параметром "Входящие" и "добавить новое правило".](media/how-to-connect-fix-default-rules/default3a.png)

Используйте собственное соглашение об именовании, чтобы назвать правило. Здесь мы используем **Custom в из AD-user**. Это означает, что правило является пользовательским правилом и является правилом входящего трафика из пространства Active Directory соединителя в метавселенной.   

 ![Создание правила входящей синхронизации](media/how-to-connect-fix-default-rules/default3b.png)

Укажите собственное описание правила, чтобы дальнейшее обслуживание правила было простым. Например, описание может быть основано на том, что такое правило, и зачем оно требуется.

Выберите необходимые параметры для полей **Подключенная система**, **тип объекта подключенной системы** и **тип объекта метавселенной** .

Укажите значение приоритета от 0 до 99 (чем меньше число, тем выше приоритет). Для полей **тег** **включить синхронизацию паролей** и **Отключить** используйте параметры по умолчанию.

Не отображать **Фильтр области** . Это означает, что правило применяется ко всем объектам, соединяемым между Active Directory подключенной системой и метавселенной.

**Правила сохранения присоединение** пусты. Это означает, что это правило использует условие объединения, определенное в стандартном правиле по умолчанию. Это еще одна причина, по которой не следует отключать или удалять стандартное правило по умолчанию. Если условие объединения отсутствует, атрибут не будет передаваться. 

Добавьте соответствующие преобразования для атрибута. Можно назначить константу, чтобы сделать постоянный поток значения целевым атрибутом. Можно использовать прямое сопоставление между исходным или целевым атрибутом. Или можно использовать выражение для атрибута. Ниже приведены различные [функции выражений](./reference-connect-sync-functions-reference.md) , которые можно использовать.

#### <a name="add-an-outbound-sync-rule"></a>Добавление исходящего правила синхронизации
Чтобы связать атрибут с целевым каталогом, необходимо создать правило исходящего трафика. Это означает, что источником является метавселенной, а целевым объектом является подключенная система. Чтобы создать правило для исходящего трафика, запустите **Редактор правил синхронизации**, измените **направление** на **исходящее** и выберите **Добавить новое правило**. 

![Редактор правил синхронизации](media/how-to-connect-fix-default-rules/default3c.png)

Как и в случае с правилом для входящего трафика, можно использовать собственное соглашение об именовании для присвоения имени правилу. Выберите **подключенную систему** в качестве клиента Azure AD и выберите объект подключенной системы, для которого необходимо задать значение атрибута. Задайте приоритет от 0 до 99. 

![Создание правила исходящей синхронизации](media/how-to-connect-fix-default-rules/default3d.png)

Не заключайте правила **фильтра области** и **объединения** в пустое. Заполните преобразование как константное, прямое или выражение. 

Теперь вы узнаете, как создать новый атрибут для потока пользовательских объектов из Active Directory для Azure Active Directory. Эти шаги можно использовать для отображения любого атрибута из любого объекта в источник и целевой объект. Дополнительные сведения см. в статьях [Создание настраиваемых правил синхронизации](how-to-connect-create-custom-sync-rule.md) и [Подготовка к подготовке пользователей](/office365/enterprise/prepare-for-directory-synchronization).

### <a name="override-the-value-of-an-existing-attribute"></a>Переопределить значение существующего атрибута
Может потребоваться переопределить значение уже сопоставленного атрибута. Например, если вы всегда хотите задать значение NULL для атрибута в Azure AD, просто создайте только правило для входящего трафика. Сделайте постоянное значение, `AuthoritativeNull` — потоком с целевым атрибутом. 

>[!NOTE] 
> Используйте `AuthoritativeNull` вместо `Null` в этом случае. Это связано с тем, что значение, отличное от NULL, заменяет значение null, даже если оно имеет более низкий приоритет (более высокое значение в правиле). `AuthoritativeNull`, с другой стороны, не заменяется на значение, отличное от NULL другими правилами. 

### <a name="dont-sync-existing-attribute"></a>Не синхронизировать существующий атрибут
Если вы хотите исключить атрибут из синхронизации, используйте функцию фильтрации атрибутов, предоставленную в Azure AD Connect. Запустите **Azure AD Connect** на рабочем столе, а затем выберите **настроить параметры синхронизации**.

![Azure AD Connect дополнительных задач](media/how-to-connect-fix-default-rules/default4.png)

 Убедитесь, что выбрано **приложение и фильтрация атрибутов Azure AD** , и нажмите кнопку **Далее**.

![Azure AD Connect дополнительных функций](media/how-to-connect-fix-default-rules/default5.png)

Очистите атрибуты, которые необходимо исключить из синхронизации.

![Атрибуты Azure AD Connect](media/how-to-connect-fix-default-rules/default6a.png)

## <a name="change-scoping-filter"></a>Изменить фильтр области
Azure AD Sync выполняет большинство объектов. Можно уменьшить область объектов и сократить число экспортируемых объектов без изменения стандартных правил синхронизации по умолчанию. 

Чтобы уменьшить область синхронизируемых объектов, используйте один из следующих методов.

- атрибут cloudFiltered
- Фильтрация единиц Организации

Если вы уменьшите область синхронизации пользователей, синхронизация хэша паролей также будет остановлена для отфильтрованных пользователей. Если объекты уже синхронизированы, то после уменьшения области действия отфильтрованные объекты удаляются из целевого каталога. По этой причине необходимо тщательно следить за областью.

>[!IMPORTANT] 
> Не рекомендуется увеличивать область объектов, настроенных Azure AD Connect. Это затрудняет понимание настроек в группе поддержки Майкрософт. Если необходимо увеличить область объектов, измените существующее правило, клонировать его и отключите исходное правило. 

### <a name="cloudfiltered-attribute"></a>атрибут cloudFiltered
Этот атрибут нельзя задать в Active Directory. Задайте значение этого атрибута, добавив новое правило для входящего трафика. Затем можно использовать **Преобразование** и **выражение** для задания этого атрибута в метавселенной. В следующем примере показано, что вы не хотите синхронизировать всех пользователей, чье название отдела начинается с **обнаружения домашней области** (без учета регистра):

`cloudFiltered <= IIF(Left(LCase([department]), 3) = "hrd", True, NULL)`

Сначала мы преобразовали отдел из источника (Active Directory) в нижний регистр. Затем, используя `Left` функцию, мы заняли только первые три символа и сравнивали ее с `hrd` . Если он соответствует, значение устанавливается равным `True` , в противном случае — `NULL` . При установке значения NULL другое правило с более низким приоритетом (более высокое значение) может записываться в него с другим условием. Запустите предварительный просмотр для одного объекта, чтобы проверить правило синхронизации, как упоминалось в разделе [Проверка правила синхронизации](#validate-sync-rule) .

![Параметры создания правила входящей синхронизации](media/how-to-connect-fix-default-rules/default7a.png)

### <a name="organizational-unit-filtering"></a>Фильтрация подразделений
Можно создать одно или несколько подразделений (OU) и переместить объекты, которые не нужно синхронизировать, в эти подразделения. Затем настройте фильтрацию подразделений в Azure AD Connect. Запустите **Azure AD Connect** на рабочем столе и выберите следующие параметры. Кроме того, можно настроить фильтрацию подразделений во время установки Azure AD Connect. 

![Azure AD Connect дополнительных задач](media/how-to-connect-fix-default-rules/default8.png)

Следуйте указаниям мастера и очистите подразделения, которые не нужно синхронизировать.

![Azure AD Connect параметры фильтрации домена и подразделения](media/how-to-connect-fix-default-rules/default9.png)

## <a name="change-join-condition"></a>Изменение условия объединения
Используйте условия JOIN по умолчанию, настроенные Azure AD Connect. Изменение условий объединения по умолчанию затрудняет понимание настроек и поддержки продукта в службе поддержки Майкрософт.

## <a name="validate-sync-rule"></a>Проверка правила синхронизации
Вновь добавленное правило синхронизации можно проверить с помощью функции предварительной версии без запуска цикла полной синхронизации. В Azure AD Connect выберите **Служба синхронизации**.

![Azure AD Connect, с выделенной службой синхронизации](media/how-to-connect-fix-default-rules/default10.png)

Выберите **Поиск метавселенной**. Выберите объект области как **пользователь**, щелкните **Добавить предложение** и укажите условия поиска. Затем выберите **Поиск** и дважды щелкните объект в результатах поиска. Убедитесь, что данные в Azure AD Connect актуальны для этого объекта, выполнив импорт и синхронизацию в лесу перед выполнением этого шага.

![Synchronization Service Manager](media/how-to-connect-fix-default-rules/default11.png)

В **свойствах объекта метавселенной** выберите **соединители**, выберите объект в соответствующем соединителе (лесу) и щелкните **Свойства..**..

![Свойства объекта метавселенной](media/how-to-connect-fix-default-rules/default12.png)

Выберите **Предварительный просмотр...**

![Свойства объекта пространства соединителя](media/how-to-connect-fix-default-rules/default13a.png)

В окне предварительного просмотра выберите **создать предварительный просмотр** и **Импорт потока атрибутов** в левой области.

![Снимок экрана, на котором показано окно "предварительный просмотр" с выбранным параметром "импортировать поток атрибутов" и "создать предварительный просмотр".](media/how-to-connect-fix-default-rules/default14.png)
 
Обратите внимание, что только что добавленное правило выполняется для объекта и присвойте `cloudFiltered` атрибуту значение true.

![Preview (Предварительный просмотр)](media/how-to-connect-fix-default-rules/default15a.png)
 
Чтобы сравнить измененное правило с правилом по умолчанию, экспортируйте оба правила отдельно, как текстовые файлы. Эти правила экспортируются как файл сценария PowerShell. Их можно сравнить с помощью любого средства сравнения файлов (например, WinDiff), чтобы увидеть изменения. 
 
Обратите внимание, что в измененном правиле `msExchMailboxGuid` атрибут изменяется на тип **выражения** , а не на **Direct**. Кроме того, значение изменяется на **null** и параметр **ексекутеонце** . Можно игнорировать идентифицированные и приоритетные различия. 

![выходные данные средства Windiff](media/how-to-connect-fix-default-rules/default17.png)
 
Чтобы изменить правила, чтобы восстановить их значения по умолчанию, удалите измененное правило и включите правило по умолчанию. Убедитесь, что вы не потеряли настройку, которую вы пытаетесь достичь. Когда будете готовы, выполните **полную синхронизацию**.

## <a name="next-steps"></a>Дальнейшие действия
- [Оборудование и предварительные требования](how-to-connect-install-prerequisites.md) 
- [Стандартные параметры](how-to-connect-install-express.md)
- [Настраиваемые параметры](how-to-connect-install-custom.md)