---
title: Руководство по безопасности сквозной аутентификации Azure Active Directory | Документация Майкрософт
description: В этой статье описано, как сквозная аутентификация Azure Active Directory (Azure AD) позволяет защитить локальные учетные записи от атак методом подбора пароля в облаке
services: active-directory
keywords: сквозная проверка подлинности azure ad connect, установка active directory, необходимые компоненты для azure ad, единый вход
documentationcenter: ''
author: billmath
manager: daveba
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: how-to
ms.date: 05/27/2020
ms.subservice: hybrid
ms.author: billmath
ms.collection: M365-identity-device-management
ms.openlocfilehash: 08a73c2b1be4b17136ba19e7efb71c2b21359fdf
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "89280151"
---
# <a name="azure-active-directory-pass-through-authentication-security-deep-dive"></a>Руководство по безопасности сквозной аутентификации Azure Active Directory

В этой статье более подробно описывается, как работает сквозная аутентификация Azure Active Directory (Azure AD). Она посвящена аспектам безопасности данного компонента. Статья предназначена для администраторов безопасности и администраторов ИТ, начальника отдела соответствия и сотрудников службы безопасности, а также других ИТ-специалистов, ответственных за безопасность ИТ-инфраструктуры и ее соответствие требованиям в малых и средних организациях или крупных предприятиях.

Здесь рассматривается следующее:
- Подробные технические сведения об установке и регистрации агентов аутентификации.
- Подробные технические сведения о шифровании паролей при входе пользователя.
- Безопасность каналов между локальными агентами аутентификации и Azure AD.
- Подробные технические сведения об обеспечении операционной безопасности агентов аутентификации.
- Другие темы, связанные с безопасностью.

## <a name="key-security-capabilities"></a>Основные возможности защиты

Ниже приведены основные аспекты безопасности данного компонента.
- Он был основан на безопасной мультитенантной архитектуре, обеспечивающей изоляцию запросов на вход в между клиентами.
- Локальные пароли ни в каком виде не хранятся в облаке.
- Локальные агенты аутентификации, которые ожидают передачи данных и отвечают на запросы на проверку пароля, устанавливают только исходящие подключения в пределах вашей сети. Нет необходимости устанавливать эти агенты аутентификации в сети периметра. Все серверы, на которых запущены агенты аутентификации, рекомендуется считать системами уровня 0 (ознакомьтесь со [справочником](/windows-server/identity/securing-privileged-access/securing-privileged-access-reference-material)).
- Для исходящего трафика агентов аутентификации, передаваемого в Azure AD, используются только стандартные порты (80 и 443). Не требуется открывать входящие порты в брандмауэре. 
  - Для всего прошедшего аутентификацию исходящего трафика используется порт 443.
  - Порт 80 используется только для скачивания списков отзыва сертификатов (CRL). Это позволяет гарантировать, что ни один из сертификатов, используемых функцией, не окажется отозванным.
  - Полный список требований к сети см. в разделе [Azure Active Directory сквозная проверка подлинности: Краткое руководство](how-to-connect-pta-quick-start.md#step-1-check-the-prerequisites).
- Пароли, введенные пользователем во время входа, шифруются в облаке перед приемом локальными агентами аутентификации для проверки в Active Directory.
- Канал HTTPS между Azure AD и локальным агентом аутентификации защищен взаимной аутентификацией.
- Защита учетных записей пользователей благодаря взаимодействию с [политиками условного доступа Azure AD](../conditional-access/overview.md), включая службу Многофакторной идентификацию (MFA), а также [блокированию устаревшей аутентификации](../conditional-access/concept-conditional-access-conditions.md) и [фильтрации атак методом подбора пароля](../authentication/howto-password-smart-lockout.md).

## <a name="components-involved"></a>Участвующие компоненты

Общие сведения о защите операций, служб и данных Azure AD см. в разделе [Центр управления безопасностью](https://azure.microsoft.com/support/trust-center/). При использовании сквозной аутентификации для входа пользователей в систему участвуют следующие компоненты:
- **Azure AD STS**. Служба токенов безопасности без учета состояния (STS), которая обрабатывает запросы на вход и выдает маркеры безопасности для браузеров, клиентов и служб пользователей.
- **Служебная шина Azure**. Обеспечивает обмен данными через облако с корпоративными службами обмена сообщениями и ретрансляции. Такая конфигурация позволяет подключаться к локальным решениям с помощью облака.
- **Агент аутентификации Azure AD Connect**. Локальный компонент, который ожидает передачи данных и отвечает на запросы на проверку пароля.
- **База данных SQL Azure**. Содержит сведения об агентах аутентификации клиента, включая его метаданные и ключи шифрования.
- **Active Directory**. Локальная среда Active Directory, в которой хранятся учетные записи пользователей и их пароли.

## <a name="installation-and-registration-of-the-authentication-agents"></a>Установка и регистрация агентов аутентификации

Агенты аутентификации устанавливаются и регистрируются в Azure AD, если:
   - [Включение сквозной проверки подлинности с помощью Azure AD Connect](./how-to-connect-pta-quick-start.md#step-2-enable-the-feature)
   - [добавить агенты аутентификации для обеспечения высокого уровня доступности запросов на вход](./how-to-connect-pta-quick-start.md#step-4-ensure-high-availability). 
   
Подготовка агента аутентификации к работе делится на три основных этапа:

1. Установка агента аутентификации
2. Регистрация агента аутентификации
3. Инициализация агента аутентификации

В следующих разделах эти этапы рассматриваются подробно.

### <a name="authentication-agent-installation"></a>Установка агента аутентификации

Только глобальные администраторы могут установить агент аутентификации (с использованием Azure AD Connect или в виде изолированного развертывания) на локальном сервере. При установке добавляются две новые записи в список программ  >    >  **и компонентов** панели управления "программы":
- Приложение агента аутентификации. Это приложение работает с привилегиями [NetworkService](/windows/win32/services/networkservice-account).
- Приложение Updater, используемое для автоматического обновления агента аутентификации. Это приложение работает с привилегиями [LocalSystem](/windows/win32/services/localsystem-account).

>[!IMPORTANT]
>С точки зрения безопасности Администраторы должны рассматривать сервер, на котором работает агент PTA, как если бы он был контроллером домена.  Серверы агента PTA должны быть защищены на тех же строках, которые описаны в статьях [Защита контроллеров домена от атак](/windows-server/identity/ad-ds/plan/security-best-practices/securing-domain-controllers-against-attack) .

### <a name="authentication-agent-registration"></a>Регистрация агента аутентификации

После установки агента аутентификации его необходимо зарегистрировать в Azure AD. Для этого Azure AD назначает каждому агенту аутентификации уникальный цифровой сертификат удостоверения, который он может использовать для безопасной связи с Azure AD.

Процедура регистрации также привязывает агент аутентификации к вашему клиенту. Таким образом службе Azure AD известно, что только этому агенту аутентификации разрешено обрабатывать запросы на проверку паролей для вашего клиента. Эта процедура повторяется для каждого нового агента аутентификации, которого вы регистрируете.

Агенты аутентификации используют такие шаги для регистрации в Azure AD:

![Регистрация агента](./media/how-to-connect-pta-security-deep-dive/pta1.png)

1. Сначала Azure AD запрашивает вход глобального администратора в Azure AD с помощью своих учетных данных. Во время входа агент аутентификации получает маркер доступа, который он может использовать от имени глобального администратора.
2. Затем агент аутентификации создает пару ключей: открытый ключ и закрытый ключ.
    - Эта пара ключей создается с использованием стандартного 2048-разрядного шифрования RSA.
    - Закрытый ключ остается на локальном сервере, где находится агент аутентификации.
3. Агент аутентификации выполняет запрос на регистрацию к Azure AD по протоколу HTTPS. Этот запрос содержит следующие компоненты:
    - Маркер доступа, полученный на шаге 1.
    - Открытый ключ, созданный на шаге 2.
    - Запрос на подписывание сертификата (CSR или запрос на сертификат). Это необходимо, чтобы запросить цифровой сертификат удостоверения, центром сертификации (ЦС) которого является Azure AD.
4. Azure AD проверяет маркер доступа в запросе на регистрацию и удостоверяется, что запрос поступил от глобального администратора.
5. Затем Azure AD подписывает и отправляет цифровой сертификат удостоверения агенту аутентификации.
    - Корневой ЦС в Azure AD используется для подписания сертификата. 

      > [!NOTE]
      > Этот ЦС _не_ расположен в хранилище доверенных корневых центров сертификации Windows.
    - Центр сертификации используется только функцией сквозной проверки подлинности. ЦС используется только для подписания представителями отдела обслуживания клиентов во время регистрации агента проверки подлинности.
    -  Другие службы Azure AD не используют этот ЦС.
    - Субъект сертификата (различающееся имя) имеет значение вашего идентификатора клиента. Различающееся имя это уникальный GUID, идентифицирующий ваш клиент. Оно позволяет указать, что сертификат используется только для вашего клиента.
6. Azure AD хранит открытый ключ агента проверки подлинности в базе данных в базе данных SQL Azure, к которой имеет доступ только Azure AD.
7. Сертификат (который был выдан на шаге 5) сохраняется на локальном сервере в хранилище сертификатов Windows (в расположении [CERT_SYSTEM_STORE_LOCAL_MACHINE](/windows/win32/seccrypto/system-store-locations#CERT_SYSTEM_STORE_LOCAL_MACHINE)). Он используется приложениями агента аутентификации и Updater.

### <a name="authentication-agent-initialization"></a>Инициализация агента аутентификации

При запуске агенту аутентификации (в первый раз после регистрации или после перезапуска сервера) нужен способ, позволяющий безопасно взаимодействовать со службой Azure AD и начать принимать запросы на проверку пароля.

![Инициализация агента](./media/how-to-connect-pta-security-deep-dive/pta2.png)

Ниже описывается, как инициализируется агент аутентификации.

1. Агент аутентификации создает исходящий запрос на начальную загрузку к Azure AD. 
    - Этот запрос выполняется через порт 443 и канал HTTPS с взаимной аутентификацией. При этом используется сертификат, выданный при регистрации агента аутентификации.
2. Azure AD отвечает на запрос, передавая в очередь служебной шины Azure ключ доступа, который является уникальным для вашего клиента и определяется идентификатором клиента.
3. Агент аутентификации создает постоянное исходящее HTTPS-подключение (через порт 443) к очереди. 
    - Агент аутентификации теперь готов к получению и обработке запросов на проверку пароля.

Если в клиенте зарегистрировано несколько агентов аутентификации, то процедура инициализации гарантирует, что каждый из них подключается к одной и той же очереди служебной шины. 

## <a name="process-sign-in-requests"></a>Обработка запросов на вход 

На приведенной схеме показано, как обрабатываются запросы на вход пользователей при сквозной аутентификации.

![Обработка входа](./media/how-to-connect-pta-security-deep-dive/pta3.png)

Служба сквозной аутентификации обрабатывает запрос вход пользователя следующим образом. 

1. Пользователь пытается получить доступ к приложению, например, [Outlook Web App](https://outlook.office365.com/owa).
2. Если пользователь еще не выполнил вход, приложение перенаправляет браузер на страницу входа Azure AD.
3. Служба токенов безопасности Azure AD отвечает, предоставляя пользователю страницу **входа** в систему.
4. Пользователь вводит имя пользователя на странице **входа** и нажимает кнопку **Далее**.
5. Пользователь вводит пароль на странице **входа** и нажимает кнопку **Войти**.
6. Имя пользователя и пароль отправляются в службу токенов безопасности Azure AD в HTTPS-запросе POST.
7. Служба STS Azure AD извлекает открытые ключи для всех агентов аутентификации, зарегистрированных в клиенте, из базы данных SQL Azure и шифрует пароль с их помощью.
    - Она создает N значений зашифрованного пароля для N агентов аутентификации, зарегистрированных в клиенте.
8. Служба токенов безопасности Azure AD помещает запрос на проверку пароля, который состоит из имени пользователя и зашифрованного значения пароля, в очередь служебной шины для вашего клиента.
9. Так как инициализированные агенты аутентификации постоянно подключены к очереди служебной шины, один из доступных агентов аутентификации получает запрос на проверку пароля.
10. Он находит зашифрованное значение пароля, относящееся к его открытому ключу, используя идентификатор, и расшифровывает его с помощью своего закрытого ключа.
11. Агент аутентификации пытается проверить имя пользователя и пароль в локальной среде Active Directory с помощью [Win32 LogonUser API](/windows/win32/api/winbase/nf-winbase-logonusera), при этом для параметра **dwLogonType** задано значение **LOGON32_LOGON_NETWORK**. 
    - Этот же API используется службами федерации Active Directory (AD FS) для выполнения входа пользователей в сценарии федеративного входа в систему.
    - Поиск контроллера домена выполняется в рамках от стандартного процесса разрешения в Windows Server.
12. Агент аутентификации получает результат от службы Active Directory: проверка прошла успешно, неправильное имя пользователя или пароль, срок действия пароля истек.

   > [!NOTE]
   > При сбое агента аутентификации во время процесса входа весь запрос на вход отбрасывается. Запросы на вход от одного агента проверки подлинности к локальному агенту проверки подлинности не передаются. Эти агенты взаимодействуют только с облаком, а не друг с другом.
   
13. Агент аутентификации пересылает результат обратно в службу токенов безопасности Azure AD через исходящий канал HTTPS с взаимной аутентификацией, используя порт 443. Для взаимной аутентификации используется сертификат, который был выдан этому агенту аутентификации ранее, во время регистрации.
14. Служба токенов безопасности Azure AD проверяет, соответствует ли этот результат конкретному запросу на вход в клиент.
15. Служба токенов безопасности Azure AD продолжает процедуру входа в соответствии с настройками. Например, при успешной проверке пароля пользователь может перейти к прохождению Многофакторной идентификации или может быть перенаправлен к приложению.

## <a name="operational-security-of-the-authentication-agents"></a>Безопасность операций агентов аутентификации

Для обеспечения операционной безопасности сквозной аутентификации Azure AD периодически обновляет свои сертификаты агентов аутентификации. Azure AD активирует обновления. Эти обновления не управляются агентами аутентификации.

![Операционная безопасность](./media/how-to-connect-pta-security-deep-dive/pta4.png)

Чтобы обновить отношение доверия агента аутентификации с Azure AD:

1. Агент аутентификации периодически проверяет связь с Azure AD каждые несколько часов, чтобы узнать, не пришло ли время обновить сертификат. Сертификат обновляется за 30 дней до истечения его срока действия.
    - Эта проверка выполняется через канал HTTPS со взаимной аутентификацией с помощью сертификата, выданного во время регистрации.
2. Если служба указывает, что пора выполнить обновления, агент аутентификации создает новую пару открытого и закрытого ключей.
    - Эти ключи создаются с использованием стандартного 2048-разрядного шифрования RSA.
    - Закрытый ключ никогда не покидает локальный сервер.
3. Затем агент аутентификации выполняет запрос на обновление сертификата к Azure AD по протоколу HTTPS. Этот запрос содержит следующие компоненты:
    - Существующий сертификат, извлеченный из расположения CERT_SYSTEM_STORE_LOCAL_MACHINE в хранилище сертификатов Windows. В этой процедуре не участвует глобальный администратор, следовательно, для нее не требуется маркер доступа от имени глобального администратора.
    - Открытый ключ, созданный на шаге 2.
    - Запрос на подписывание сертификата (CSR или запрос на сертификат). Это необходимо, чтобы запросить новый цифровой сертификат удостоверения, центром сертификации которого является Azure AD.
4. Azure AD проверяет существующий сертификат в запросе на обновление сертификата. Затем он определяет, поступил ли запрос от агента аутентификации, зарегистрированного в клиенте.
5. Если существующий сертификат все еще действителен, то Azure AD подписывает новый цифровой сертификат удостоверения и выдает его агенту аутентификации. 
6. Если срок действия существующего сертификата истек, Azure AD удаляет агент аутентификации из списка зарегистрированных агентов аутентификации клиента. После этого глобальный администратор должен вручную установить и зарегистрировать новый агент аутентификации.
    - Используйте корневой ЦС Azure AD для подписывания сертификата.
    - Задайте для субъекта сертификата (различающееся имя) значение вашего идентификатора клиента. Это глобальный уникальный идентификатор (GUID), который однозначно идентифицирует ваш клиент. То есть сертификат предназначен только для вашего клиента.
6. Azure AD сохраняет новый открытый ключ агента аутентификации в базе данных SQL Azure, к которой у него есть доступ. Также она проверяет старый открытый ключ, связанный с агентом аутентификации.
7. Новый сертификат (который был выдан на шаге 5) сохраняется на сервере в хранилище сертификатов Windows (в расположении [CERT_SYSTEM_STORE_CURRENT_USER](/windows/win32/seccrypto/system-store-locations#CERT_SYSTEM_STORE_CURRENT_USER)).
    - Так как процедура обновления отношения доверия выполняется не в интерактивном режиме (без участия глобального администратора), агент аутентификации больше не имеет доступа для обновления существующего сертификата в расположении CERT_SYSTEM_STORE_LOCAL_MACHINE. 
    
   > [!NOTE]
   > Эта процедура не удаляет сам сертификат из расположения CERT_SYSTEM_STORE_LOCAL_MACHINE.
8. С этого момента для аутентификации используется новый сертификат. При каждом последующем обновлении сертификат в расположении CERT_SYSTEM_STORE_LOCAL_MACHINE заменяется новым.

## <a name="auto-update-of-the-authentication-agents"></a>Автоматическое обновление агентов аутентификации

Приложение обновления автоматически обновляет агент проверки подлинности при выпуске новой версии (с исправлениями ошибок или улучшением производительности). Приложение обновления не обрабатывает запросы на проверку пароля для вашего клиента.

Azure AD размещает новую версию программного обеспечения как подписанный **пакет установщика Windows (MSI-файл)**. MSI-файл подписывается с помощью [Microsoft Authenticode](/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms537359(v=vs.85)) с использованием алгоритма хэш-кода SHA256. 

![Автоматическое обновление](./media/how-to-connect-pta-security-deep-dive/pta5.png)

Чтобы выполнять автоматическое обновление агентов аутентификации:

1. Приложение Updater проверяет связь с Azure AD каждый час, чтобы узнать, не выпущена ли новая версия агента аутентификации. 
    - Эта проверка выполняется через канал HTTPS со взаимной аутентификацией с помощью сертификата, выданного во время регистрации. Агент аутентификации и Updater совместно используют сертификат, хранимый на сервере.
2. Если доступна новая версия, Azure AD возвращает Updater подписанный MSI-файл.
3. Приложение Updater проверяет, подписан ли этот MSI-файл корпорацией Майкрософт.
4. Затем Updater выполняет данный MSI-файл. При этом выполняются указанные ниже действия.

   > [!NOTE]
   > Updater выполняется с привилегиями [локальной системы](/windows/win32/services/localsystem-account).

    - Служба агента аутентификации останавливается.
    - На сервер устанавливается новая версия агента аутентификации.
    - Служба агента аутентификации перезапускается.

>[!NOTE]
>Если в клиенте зарегистрировано несколько агентов аутентификации, то Azure AD не выполняет одновременное обновление этих агентов или их сертификатов. Вместо этого Azure AD делает это по одной за раз, чтобы обеспечить высокий уровень доступности запросов на вход.
>


## <a name="next-steps"></a>Дальнейшие действия
- [Текущие ограничения](how-to-connect-pta-current-limitations.md). Сведения о том, какие сценарии поддерживаются, а какие нет.
- [Краткое руководство](how-to-connect-pta-quick-start.md). Начало работы с сквозной проверкой подлинности Azure AD.
- [Migrate from AD FS to Pass-through Authentication](https://aka.ms/adfstoptadpdownload) (Переход с AD FS на сквозную проверку подлинности). Подробное руководство по переходу с AD FS (или других технологии федерации) на сквозную проверку подлинности.
- [Интеллектуальная блокировка](../authentication/howto-password-smart-lockout.md). Настройте возможность интеллектуальной блокировки на клиенте для защиты учетных записей пользователей.
- [Принцип работы](how-to-connect-pta-how-it-works.md). Изучите основные принципы работы сквозной аутентификации Azure AD.
- [Часто задаваемые вопросы](how-to-connect-pta-faq.md). Найдите ответы на часто задаваемые вопросы.
- [Устранение неполадок](tshoot-connect-pass-through-authentication.md). Узнайте, как устранять распространенные проблемы со сквозной аутентификации.
- [Простой единый вход Azure Active Directory](how-to-connect-sso.md). Узнайте подробнее об этой дополнительной функции.