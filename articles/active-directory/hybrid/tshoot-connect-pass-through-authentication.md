---
title: 'Azure AD Connect: устранение неполадок в работе сквозной аутентификации | Документация Майкрософт'
description: В этой статье описывается устранение неполадок в работе сквозной аутентификации Azure Active Directory (Azure AD).
services: active-directory
keywords: Устранение неполадок в работе сквозной аутентификации Azure AD Connect, установка Active Directory, необходимые компоненты для Azure AD, единый вход
documentationcenter: ''
author: billmath
manager: daveba
ms.assetid: 9f994aca-6088-40f5-b2cc-c753a4f41da7
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: troubleshooting
ms.date: 01/25/2021
ms.subservice: hybrid
ms.author: billmath
ms.collection: M365-identity-device-management
ms.openlocfilehash: 9a014bd5c8f1edbfb00019b8541cef552271d65b
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "98762847"
---
# <a name="troubleshoot-azure-active-directory-pass-through-authentication"></a>Устранение неполадок в работе сквозной аутентификации Azure Active Directory

В этой статье вы найдете информацию по устранению распространенных неполадок в работе сквозной аутентификации Azure AD.

>[!IMPORTANT]
>Если вы столкнулись с проблемами в работе сквозной аутентификации, которые касаются входа пользователей, не отключайте эту функцию и не удаляйте агенты сквозной аутентификации, если у вас нет облачной учетной записи глобального администратора, на которую можно переключиться. См. дополнительные сведения о [добавлении облачной учетной записи глобального администратора](../fundamentals/add-users-azure-active-directory.md). Этот шаг очень важен для того, чтобы не потерять доступ к клиенту.

## <a name="general-issues"></a>Общие проблемы

### <a name="check-status-of-the-feature-and-authentication-agents"></a>Проверьте состояние компонента и агентов проверки подлинности

Убедитесь, что компонент сквозной проверки подлинности по-прежнему **включен** в клиенте и что для состояния агентов проверки подлинности отображается значение **Active** (Активны), а не **Inactive** (Неактивны). Можно проверить состояние, перейдя в колонку **Azure AD Connect** в [центре администрирования Azure Active Directory](https://aad.portal.azure.com/).

![Центр администрирования Active Directory Azure — колонка "Azure AD Connect"](./media/tshoot-connect-pass-through-authentication/pta7.png)

![Центр администрирования Active Directory Azure — колонка "Сквозная проверка подлинности"](./media/tshoot-connect-pass-through-authentication/pta11.png)

### <a name="user-facing-sign-in-error-messages"></a>Сообщения об ошибках при входе пользователей

Если пользователи не могут выполнить вход с использованием сквозной аутентификации, для них могут отображаться следующие ошибки на экране входа в Azure AD: 

|Ошибка|Описание|Решение
| --- | --- | ---
|AADSTS80001|Не удалось подключиться к Active Directory|Убедитесь, что серверы с агентами являются членами того же леса, что и пользователи, чьи пароли должны быть проверены, и могут подключиться к Active Directory.  
|AADSTS8002|Истекло время ожидания подключения к Active Directory|Убедитесь, что служба Active Directory доступна и отвечает на запросы агентов.
|AADSTS80004|Агенту передано недопустимое имя пользователя|Убедитесь, что пользователь пытается войти в систему с правильным именем пользователя.
|AADSTS80005|При проверке было обнаружено непредсказуемое исключение WebException|Это временная проблема. Повторите запрос. Если проблема не исчезла, обратитесь в службу поддержки Майкрософт.
|AADSTS80007|Произошла ошибка при взаимодействии с Active Directory|Посмотрите дополнительные сведения в журналах агентов и убедитесь, что Active Directory работает должным образом.

### <a name="users-get-invalid-usernamepassword-error"></a>Пользователи получают неверное сообщение об ошибке имени пользователя или пароля 

Это может произойти, если локальное имя участника-пользователя (UPN) отличается от имени UPN пользователя в облаке.

Чтобы убедиться, что это проблема, сначала проверьте, правильно ли работает агент сквозной аутентификации:


1. Создайте тестовую учетную запись.  
2. Импортируйте модуль PowerShell на компьютере агента:

 ```powershell
 Import-Module "C:\Program Files\Microsoft Azure AD Connect Authentication Agent\Modules\PassthroughAuthPSModule\PassthroughAuthPSModule.psd1"
 ```
3. Выполните команду Invoke PowerShell: 

 ```powershell
 Invoke-PassthroughAuthOnPremLogonTroubleshooter 
 ``` 
4. При появлении запроса на ввод учетных данных введите те же имя пользователя и пароль, которые используются для входа в ( https://login.microsoftonline.com) .

Если вы получаете одно и то же сообщение об ошибке имени пользователя и пароля, это означает, что агент сквозной проверки подлинности работает правильно, и проблема может быть в том, что локальный UPN не поддерживает маршрутизацию. Дополнительные сведения см. в разделе [Настройка альтернативного имени пользователя](/windows-server/identity/ad-fs/operations/configuring-alternate-login-id).

> [!IMPORTANT]
> Если Azure AD Connect сервер не присоединен к домену, то необходимо выполнить требования, указанные в [Azure AD Connect: предварительные требования](./how-to-connect-install-prerequisites.md#installation-prerequisites), при возникновении неправильной проблемы с именем пользователя или паролем.

### <a name="sign-in-failure-reasons-on-the-azure-active-directory-admin-center-needs-premium-license"></a>Причины сбоя единого входа в центре администрирования Azure Active Directory (требуется лицензия Premium)

Если к клиенту привязана лицензия Azure AD Premium, вы можете также изучить [отчет о действиях при входе](../reports-monitoring/concept-sign-ins.md) в [центре администрирования Azure Active Directory](https://aad.portal.azure.com/).

![Центр администрирования Azure Active Directory — отчет о действиях входа](./media/tshoot-connect-pass-through-authentication/pta4.png)

Перейдите в раздел **Azure Active Directory**  ->  **входы** в [центр администрирования Azure Active Directory](https://aad.portal.azure.com/) и щелкните действие входа конкретного пользователя. Найдите поле **КОД ОШИБКИ ВХОДА**. Сопоставьте значение этого поля c причиной сбоя и способом разрешения с помощью следующей таблицы:

|Код ошибки входа|Причина ошибки входа|Решение
| --- | --- | ---
| 50144 | Истек срок действия пароля пользователя Active Directory. | Сбросьте пароль пользователя в локальной службе Active Directory.
| 80001 | Агент аутентификации недоступен. | Установите и зарегистрируйте агент аутентификации.
| 80002 | Истекло время ожидания запроса на проверку пароля агента аутентификации. | Проверьте, доступна ли из агента аутентификации служба Active Directory.
| 80003 | Агент аутентификации получил недопустимый ответ. | Если проблема возникает постоянно для многих пользователей, проверьте конфигурацию Active Directory.
| 80004 | В запросе на вход использовано неправильное имя участника-пользователя (UPN). | Попросите пользователя выполнить вход, используя правильное имя пользователя.
| 80005 | Агент аутентификации: произошла ошибка. | Это временная проблема. Повторите попытку позже.
| 80007 | Агенту аутентификации не удалось подключиться к Active Directory. | Проверьте, доступна ли из агента аутентификации служба Active Directory.
| 80010 | Агенту аутентификации не удалось расшифровать пароль. | Если проблема возникает постоянно, установите и зарегистрируйте новый агент аутентификации. Также удалите текущий агент. 
| 80011 | Агенту аутентификации не удается получить ключ расшифровки. | Если проблема возникает постоянно, установите и зарегистрируйте новый агент аутентификации. Также удалите текущий агент.
| 80014 | Запрос на проверку получен после превышения максимального истекшего времени. | Истекло время ожидания агента аутентификации. Чтобы получить дополнительные сведения об этой ошибке, откройте запрос в службу поддержки с кодом ошибки, ИДЕНТИФИКАТОРом корреляции и меткой времени.

>[!IMPORTANT]
>Агенты сквозной аутентификации выполняют проверку подлинности пользователей Azure AD, проверяя имена пользователей и пароли в Active Directory, вызывая [API-интерфейс LogonUser для Win32](/windows/win32/api/winbase/nf-winbase-logonusera). В результате, если вы установили параметр "вход" в Active Directory ограничить доступ к рабочей станции, потребуется добавить серверы, на которых размещены агенты сквозной проверки подлинности, в список "входы на серверы". Если этого не сделать, пользователи не смогут войти в Azure AD.

## <a name="authentication-agent-installation-issues"></a>Проблемы с установкой агента аутентификации

### <a name="an-unexpected-error-occurred"></a>Произошла непредвиденная ошибка

[Соберите журналы агента](#collecting-pass-through-authentication-agent-logs) с сервера и обратитесь в службу поддержки Майкрософт с этой проблемой.

## <a name="authentication-agent-registration-issues"></a>Проблемы с регистрацией агента аутентификации

### <a name="registration-of-the-authentication-agent-failed-due-to-blocked-ports"></a>Зарегистрировать агент аутентификации не удалось из-за заблокированных портов

Убедитесь, что сервер, на котором установлен агент аутентификации, может взаимодействовать с URL-адресами и портами нашей службы, перечисленными [здесь](how-to-connect-pta-quick-start.md#step-1-check-the-prerequisites).

### <a name="registration-of-the-authentication-agent-failed-due-to-token-or-account-authorization-errors"></a>Сбой регистрации агента аутентификации из-за ошибок проверки подлинности учетной записи или токена

Вы должны использовать облачную учетную запись глобального администратора для установки и регистрации изолированного агента аутентификации или Azure AD Connect. Существует известная проблема с учетными записями глобального администратора с поддержкой Многофакторной идентификации. В качестве обходного решения временно отключите Многофакторную идентификацию (только чтобы завершить операции).

### <a name="an-unexpected-error-occurred"></a>Произошла непредвиденная ошибка

[Соберите журналы агента](#collecting-pass-through-authentication-agent-logs) с сервера и обратитесь в службу поддержки Майкрософт с этой проблемой.

## <a name="authentication-agent-uninstallation-issues"></a>Проблемы с удалением агента аутентификации

### <a name="warning-message-when-uninstalling-azure-ad-connect"></a>Предупреждение при удалении Azure AD Connect

Если вы включили сквозную аутентификацию на клиенте и пытаетесь удалить Azure AD Connect, то появится следующее предупреждение: "Пользователи не смогут войти в Azure AD, если на других серверах не установлены другие агенты сквозной аутентификации".

Прежде чем удалять Azure AD Connect, убедитесь, что у вас [высокодоступная](how-to-connect-pta-quick-start.md#step-4-ensure-high-availability) конфигурация, чтобы избежать нарушения входа пользователей.

## <a name="issues-with-enabling-the-feature"></a>Проблемы с включением функции

### <a name="enabling-the-feature-failed-because-there-were-no-authentication-agents-available"></a>Не удалось включить функцию из-за отсутствия доступных агентов аутентификации

Чтобы включить сквозную аутентификацию на клиенте, необходимо иметь хотя бы один активный агент аутентификации. Можно установить агент аутентификации, установив либо Azure AD Connect, либо отдельный агент аутентификации.

### <a name="enabling-the-feature-failed-due-to-blocked-ports"></a>Не удалось включить функцию из-за заблокированных портов

Убедитесь, что сервер, на котором установлена служба Azure AD Connect, может взаимодействовать с URL-адресами и портами нашей службы, перечисленными [здесь](how-to-connect-pta-quick-start.md#step-1-check-the-prerequisites).

### <a name="enabling-the-feature-failed-due-to-token-or-account-authorization-errors"></a>Не удалось включить функцию из-за ошибок проверки подлинности учетной записи или токена

При включении функции вы должны использовать только облачную учетную запись глобального администратора. Существует известная проблема с учетными записями глобального администратора с поддержкой MFA. В качестве обходного решения временно отключите Многофакторную идентификацию (только чтобы завершить операции).

## <a name="collecting-pass-through-authentication-agent-logs"></a>Сбор журналов агента сквозной аутентификации

Журналы агента сквозной аутентификации будут находиться в разных расположениях в зависимости от типа возникшей проблемы.

### <a name="azure-ad-connect-logs"></a>Журналы Azure AD Connect

Ошибки, связанные с установкой, можно проверить в журналах Azure AD Connect здесь: **%ProgramData%\AADConnect\trace-\*.log**.

### <a name="authentication-agent-event-logs"></a>Журналы событий агента аутентификации

Чтобы посмотреть ошибки, связанные с агентом проверки подлинности, откройте на сервере приложение "Просмотр событий" и проверьте расположение **Application and Service Logs\Microsoft\AzureAdConnect\AuthenticationAgent\Admin**.

Для получения подробных сведений включите журнал "Сеанс" (кликните правой кнопкой мыши в приложении "Просмотр событий", чтобы найти этот параметр). Не запускайте агент аутентификации со включенным журналом во время обычной работы. Используйте его только для устранения неполадок. Содержимое этого журнала будет видно только после того, как он снова будет отключен.



### <a name="detailed-trace-logs"></a>Подробные журналы трассировки

Для диагностики и устранения неполадок при входе пользователей найдите журналы трассировки в папке **%ProgramData%\Microsoft\Azure AD Connect Authentication Agent\Trace\\**. В этих журналах содержатся причины сбоев, возникших при входе пользователей с помощью сквозной аутентификации. Эти ошибки также сопоставляются с причинами ошибок входа, показанными в предыдущей таблице причин ошибок входа. Ниже приведен пример записи в журнале.

```
    AzureADConnectAuthenticationAgentService.exe Error: 0 : Passthrough Authentication request failed. RequestId: 'df63f4a4-68b9-44ae-8d81-6ad2d844d84e'. Reason: '1328'.
        ThreadId=5
        DateTime=xxxx-xx-xxTxx:xx:xx.xxxxxxZ
```

Описание ошибки (ее номер — 1328 в приведенном выше примере) можно получить, открыв окно командной строки и выполнив указанную ниже команду. Номер 1328 следует заменить на нужный номер ошибки, который отображается в журналах.

`Net helpmsg 1328`

![Сквозная проверка подлинности](./media/tshoot-connect-pass-through-authentication/pta3.png)

### <a name="domain-controller-logs"></a>Журналы контроллеров домена

Если включено ведение журнала аудита, то дополнительные сведения можно найти в журналах безопасности контроллеров домена. Ниже показан простой способ получения запросов на вход, отправленных агентами сквозной аутентификации.

```
    <QueryList>
    <Query Id="0" Path="Security">
    <Select Path="Security">*[EventData[Data[@Name='ProcessName'] and (Data='C:\Program Files\Microsoft Azure AD Connect Authentication Agent\AzureADConnectAuthenticationAgentService.exe')]]</Select>
    </Query>
    </QueryList>
```

## <a name="performance-monitor-counters"></a>Счетчики системного монитора

Другой способ наблюдения за агентами аутентификации — отслеживание счетчиков системного монитора на каждом сервере, на котором установлен агент аутентификации. Используйте приведенные глобальные счетчики (**# PTA authentications**, **#PTA failed authentications** и **#PTA successful authentications**) и счетчики ошибок (**# PTA authentication errors**).

![Счетчики системного монитора для сквозной аутентификации](./media/tshoot-connect-pass-through-authentication/pta12.png)

>[!IMPORTANT]
>Сквозная аутентификация обеспечивает высокий уровень доступности за счет нескольких агентов аутентификации, но _не_ предоставляет возможности балансировки нагрузки. В зависимости от вашей конфигурации _не_ все агенты аутентификации могут получать примерно _одинаковое_ число запросов. Возможно, какой-либо агент аутентификации вообще не получает трафик.
