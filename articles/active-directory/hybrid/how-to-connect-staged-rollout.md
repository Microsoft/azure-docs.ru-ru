---
title: 'Azure AD Connect выполняет следующие функции: Облачная проверка подлинности с помощью промежуточного развертывания | Документация Майкрософт'
description: Эта статья содержит сведения о переходе из федеративной проверки подлинности на облачную проверку подлинности с помощью промежуточного развертывания.
author: billmath
manager: daveba
ms.service: active-directory
ms.workload: identity
ms.topic: how-to
ms.date: 06/03/2020
ms.subservice: hybrid
ms.author: billmath
ms.collection: M365-identity-device-management
ms.openlocfilehash: 5c7f3de20ea3e86e3b56dc71d698354f7eaf782d
ms.sourcegitcommit: dae6b628a8d57540263a1f2f1cdb10721ed1470d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/29/2021
ms.locfileid: "105709724"
---
# <a name="migrate-to-cloud-authentication-using-staged-rollout-preview"></a>Переход на облачную проверку подлинности с использованием промежуточного развертывания (предварительная версия)

Промежуточное развертывание позволяет выборочно тестировать группы пользователей с помощью облачных возможностей проверки подлинности, таких как многофакторная идентификация Azure AD (MFA), условный доступ, Защита идентификации для потерянных учетных данных, управление удостоверениями и др., прежде чем переключаться между доменами.  В этой статье обсуждается, как выполнить такой переход. Однако перед началом промежуточного развертывания следует принять во внимание последствия, которые могут возникнуть, если выполняется одно или несколько из следующих условий:
    
-  Вы сейчас используете локальный сервер Многофакторной идентификации. 
-  Вы используете смарт-карты для проверки подлинности. 
-  Текущий сервер предлагает определенные возможности, предназначенные только для федерации.

Прежде чем использовать эту возможность, мы рекомендуем ознакомиться с нашим руководством по выбору правильного метода проверки подлинности. Дополнительные сведения см. в таблице "Сравнение методов" статьи [Выбор правильного метода аутентификации для гибридного решения для идентификации Azure Active Directory](./choose-ad-authn.md#comparing-methods).

Общие сведения о возможностях см. в видео "Azure Active Directory. Что такое промежуточное развертывание?"

>[!VIDEO https://www.microsoft.com/videoplayer/embed/RE3inQJ]



## <a name="prerequisites"></a>Предварительные требования

-   Наличие клиента Azure Active Directory (Azure AD) с федеративными доменами.

-   Принято решение об использовании одного из двух вариантов:
    - **Вариант A**  -  *Синхронизация хэшированных паролей (синхронизация)*  +  простой *единый вход (SSO)*.  Дополнительные сведения см. в статье [что такое синхронизация хэша паролей](whatis-phs.md) и [что такое простой единый вход](how-to-connect-sso.md) .
    - **Вариант б**  -  *сквозная проверка подлинности*  +  *простой единый вход*.  Дополнительные сведения см. в статье [что такое сквозная проверка подлинности](how-to-connect-pta.md)  
    
    Несмотря на то, что *простой единый вход* не является обязательным, рекомендуем его включить для автоматического входа пользователей, работающих на компьютерах, присоединенных к домену из корпоративной сети.

-   Вы настроили все символики клиента и политики условного доступа, которые необходимы пользователям, переходящим на облачную проверку подлинности.

-   Если вы планируете использовать многофакторную идентификацию Azure AD, мы рекомендуем использовать [объединенную регистрацию для самостоятельного сброса пароля (SSPR) и многофакторной проверки подлинности](../authentication/concept-registration-mfa-sspr-combined.md) , чтобы пользователи зарегистрировали свои методы проверки подлинности один раз. Примечание. при использовании SSPR для сброса пароля или смены пароля с помощью страницы Мипрофиле во время промежуточного развертывания Azure AD Connect необходимо синхронизировать новый хэш пароля, который может занять до 2 минут после сброса.

-   Чтобы использовать функцию промежуточного развертывания, у вас должны быть права глобального администратора клиента.

-   Чтобы включить *простой единый вход* в определенном лесу доменных служб Active Directory, необходимо быть администратором домена.

-  Если вы развертываете гибридную службу Azure AD или присоединение к Azure AD, необходимо выполнить обновление до Windows 10 1903.


## <a name="supported-scenarios"></a>Поддерживаемые сценарии

Для промежуточного развертывания поддерживаются следующие сценарии. Эта функция работает только для:

- Пользователей, подготовленных для Azure AD с помощью Azure AD Connect. Не применимо для полностью облачных пользователей.

- Трафик входа пользователя в браузерах и клиентах с *современной проверкой подлинности*. Приложения или облачные службы, использующие устаревшую проверку подлинности, будут возвращаться к потокам федеративной проверки подлинности. Примером может быть Exchange Online с отключенной современной проверкой подлинности или Outlook 2010, который не поддерживает современную проверку подлинности.

- В настоящее время размер группы ограничен 50 000 пользователей.  Если у вас есть группы, которые содержат больше 50 000 пользователей, рекомендуется разбить эту группу на несколько для промежуточного развертывания.

- Гибридное подключение Windows 10 или первичный маркер обновления Azure AD присоединяется без линейного представления для сервера федерации для Windows 10 версии 1903 и более новых версий, когда UPN пользователя поддерживает маршрутизацию и доменный суффикс проверяется в Azure AD.

## <a name="unsupported-scenarios"></a>Неподдерживаемые сценарии

Для промежуточного развертывания не поддерживаются следующие сценарии:

- Устаревшие проверки подлинности, такие как POP3 и SMTP, не поддерживаются.

- Некоторые приложения передают параметр запроса domain_hint в Azure AD во время проверки подлинности. Эти потоки будут продолжать работу, а пользователи, для которых включено промежуточное развертывание, будут продолжать использовать федерацию для проверки подлинности.

<!-- -->

- Администраторы могут развернуть облачную проверку подлинности с помощью групп безопасности. Чтобы избежать задержки синхронизации при использовании локальных групп безопасности Active Directory, рекомендуем использовать облачные группы безопасности. Применяются следующие условия:

    - Для каждого компонента можно использовать не более 10 групп. То есть вы можете использовать по 10 групп для *синхронизации хэша паролей*, *сквозной проверки подлинности* и *простого единого входа* соответственно.
    - Вложенные группы *не поддерживаются*. Эта область применима и к общедоступной предварительной версии.
    - Динамические группы *не поддерживаются* для промежуточного развертывания.
    - Объекты контакта внутри группы будут блокировать добавление группы.

- При первом добавлении группы безопасности для промежуточного развертывания вы можете ограничиться 200 пользователей, чтобы избежать времени ожидания пользовательского интерфейса. После добавления группы вы можете добавить дополнительных пользователей, если это необходимо.

- Когда пользователи находятся в промежуточном режиме, когда Енфорцеклаудпассвордполицифорпассвордсинцедусерс включен, для политики срока действия пароля устанавливается значение 90 дней без возможности настройки. 

- Гибридное присоединение к Windows 10 или первичный маркер обновления для Windows 10 версии более 1903. Этот сценарий будет возвращаться к конечной точке WS-Trust сервера федерации, даже если вход пользователя находится в области промежуточного развертывания.

- Гибридное подключение Windows 10 или первичный маркер обновления присоединение к Azure AD для всех версий, если локальный UPN пользователя не поддерживает маршрутизацию. Этот сценарий перейдет в конечную точку WS-Trust в промежуточном режиме, но прекратит работу, когда промежуточная миграция завершится, а вход пользователя больше не будет полагаться на сервер федерации.

  >[!NOTE]
  >Вам все равно нужно выполнить окончательный переход из федеративной проверки подлинности в облачную с помощью Azure AD Connect или PowerShell. Промежуточное развертывание не переключает домены с федеративного на управляемый.  Дополнительные сведения о домене прямую миграцию см. в статье [Миграция из Федерации в синхронизацию хэша паролей](plan-migrate-adfs-password-hash-sync.md#step-3-change-the-sign-in-method-to-password-hash-synchronization-and-enable-seamless-sso) и [Миграция из Федерации в сквозную аутентификацию](plan-migrate-adfs-password-hash-sync.md#step-3-change-the-sign-in-method-to-password-hash-synchronization-and-enable-seamless-sso) .
  
## <a name="get-started-with-staged-rollout"></a>Начало работы с промежуточным развертыванием

Чтобы проверить *синхронизацию хэша паролей* данных для входа с помощью промежуточного развертывания, выполните инструкции для предварительной подготовки, приведенные в следующем разделе.

Сведения о том, какие командлеты PowerShell следует использовать, см. в статье [AzureADPreview](/powershell/module/azuread/?view=azureadps-2.0-preview&preserve-view=true#staged_rollout).

## <a name="pre-work-for-password-hash-sync"></a>Предварительная подготовка для синхронизации хэша паролей

1. Включите *синхронизацию хэша паролей* на странице [дополнительные компоненты](how-to-connect-install-custom.md#optional-features) в Azure AD Connect. 

   ![Снимок экрана страницы "Дополнительные возможности" в Azure Active Directory Connect](media/how-to-connect-staged-rollout/sr1.png)

1. Убедитесь, что весь цикл *синхронизации хэша паролей* был выполнен, чтобы все хэши паролей пользователей были синхронизированы с Azure AD. Чтобы проверить состояние *синхронизации хэша паролей*, можно использовать диагностику PowerShell, описанную в статье [Устранение неполадок синхронизации хэшированных паролей в службе синхронизации Azure AD Connect](tshoot-connect-password-hash-synchronization.md).

   ![Снимок экрана журнала средства устранения неполадок AADConnect](./media/how-to-connect-staged-rollout/sr2.png)

Если вы хотите проверить данные для входа с использованием *сквозной проверки подлинности* с помощью промежуточного развертывания, включите ее, выполнив инструкции для предварительной подготовки, приведенные в следующем разделе.

## <a name="pre-work-for-pass-through-authentication"></a>Предварительная подготовка сквозной проверки подлинности

1. Укажите сервер под управлением Windows Server 2012 R2 или более поздней версии, на котором необходимо запустить агент *сквозной проверки подлинности*. 

   *Не* выбирайте сервер Azure AD Connect.  Убедитесь, что сервер присоединен к домену и может выполнить проверку подлинности выбранных пользователей с помощью Active Directory, а также может взаимодействовать с Azure AD через исходящие порты и URL-адреса. Для дополнительных сведений см. раздел "Шаг 1. Проверка соблюдения предварительных требований" в статье [Краткое руководство. Простой единый вход Azure Active Directory](how-to-connect-sso-quick-start.md).

1. [Скачайте агент проверки подлинности Azure AD Connect](https://aka.ms/getauthagent) и установите его на сервере. 

1. Чтобы включить [высокий уровень доступности](how-to-connect-sso-quick-start.md), установите дополнительные агенты аутентификации на других серверах.

1. Убедитесь, что вы настроили [параметры Smart Lock](../authentication/howto-password-smart-lockout.md) должным образом. Это поможет убедиться, что локальные учетные записи пользователей Active Directory не блокируются недопустимыми субъектами.

Рекомендуем включить *простой единый вход* независимо от метода входа (*синхронизация хэша паролей* или *сквозная проверка подлинности*), выбранного для промежуточного развертывания. Для включения *простого единого входа* следуйте инструкциям по предварительной подготовке в следующем разделе.

## <a name="pre-work-for-seamless-sso"></a>Предварительная подготовка к использованию единого входа

Включите *простой единый вход* в Active Directory лесах с помощью PowerShell. Если у вас несколько Active Directory леса, включите их для каждого леса отдельно. *Простой единый вход* срабатывает только для пользователей, которые выбраны для поэтапного развертывания. Это не влияет на текущую настройку федерации.

Чтобы включить *простой единый вход*, выполните следующие действия:

1. Войдите на сервер Azure AD Connect.

2. Перейдите в папку *% ProgramFiles% \\ Microsoft Azure Active Directory Connect* .

3. Импортируйте модуль PowerShell для *простого единого входа*, выполнив следующую команду: 

   `Import-Module .\AzureADSSO.psd1`

4. Откройте сеанс PowerShell от имени администратора. В PowerShell вызовите `New-AzureADSSOAuthenticationContext`. Откроется область для ввода учетных данных глобального администратора клиента.

5. Вызовите процедуру `Get-AzureADSSOStatus | ConvertFrom-Json`. Эта команда выводит список лесов Active Directory (см. список "Домены"), в которых включена эта функция. По умолчанию на уровне клиента установлено значение false.

   ![Пример выходных данных Windows PowerShell](./media/how-to-connect-staged-rollout/sr3.png)

6. Вызовите процедуру `$creds = Get-Credential`. При запросе введите учетные данные администратора домена для нужного леса Active Directory.

7. Вызовите процедуру `Enable-AzureADSSOForest -OnPremCredentials $creds`. Эта команда создает учетную запись компьютера AZUREADSSOACC с локального контроллера домена для леса Active Directory, необходимого для *простого единого входа*.

8. Для *простого единого входа* требуется, чтобы URL-адреса были в зоне интрасети. Сведения о развертывании этих URL-адресов с помощью групповых политик см. в статье [Краткое руководство. Простой единый вход Azure Active Directory](how-to-connect-sso-quick-start.md#step-3-roll-out-the-feature).

9. Для получения полного пошагового руководства можно также скачать [планы развертывания](https://aka.ms/SeamlessSSODPDownload) для *простого единого входа*.

## <a name="enable-staged-rollout"></a>Включение промежуточного развертывания

Чтобы развернуть конкретный компонент (*сквозная проверка подлинности*, *синхронизация хэша паролей* или *простой единый вход*) для выбранного набора пользователей в группе, следуйте инструкциям в следующих разделах.

### <a name="enable-a-staged-rollout-of-a-specific-feature-on-your-tenant"></a>Включение промежуточного развертывания для определенной функции в клиенте

Вы можете развернуть один из следующих вариантов:

- **Вариант A** - *синхронизация хэша паролей* + *простой единый вход*.
- **Вариант Б** - *сквозная проверка подлинности* + *простой единый вход*.
- **Не поддерживается** - *синхронизация хэша паролей* + *сквозная проверка подлинности* + *простой единый вход*

Выполните следующие действия.

1. Войдите на [портал Azure AD](https://aka.ms/stagedrolloutux) для доступа к предварительной версии пользовательского интерфейса.

2. Выберите ссылку **Включение поэтапного выпуска для управляемого входа пользователей (предварительная версия)** .

   Например, если вы хотите включить *вариант A*, переместите ползунки управления **Синхронизация хэша паролей** и **Простой единый вход** в положение **Вкл.** , как показано на следующих изображениях.

   ![Страница Azure AD Connect](./media/how-to-connect-staged-rollout/sr4.png)

   ![Страница "Включение функций поэтапного выпуска (предварительная версия)"](./media/how-to-connect-staged-rollout/sr5.png)

3. Добавьте группы в компонент, чтобы включить *сквозную проверку подлинности* и *простой единый вход*. Чтобы избежать времени ожидания пользовательского интерфейса, убедитесь, что группы безопасности изначально содержат не более 200 членов.

   ![Страница Manage groups for Password Hash Sync (Preview) (Управление группами для синхронизации хэша паролей (предварительная версия))](./media/how-to-connect-staged-rollout/sr6.png)

   >[!NOTE]
   >Члены в группе автоматически включаются для промежуточного развертывания. Вложенные и динамические группы не поддерживаются для промежуточного развертывания.
   >При добавлении новой группы Пользователи в группе (до 200 пользователей для новой группы) будут обновлены для немедленного использования управляемой проверки подлинности. Изменение группы (Добавление или удаление пользователей) может занять до 24 часов, чтобы изменения вступили в силу.
   >Простой единый вход будет применяться только в том случае, если пользователи находятся в простой группе единого входа, а также в группе PTA или PHS.

## <a name="auditing"></a>Аудит

Мы включили события аудита для различных действий, выполняемых для промежуточного развертывания:

- Событие аудита при включенном промежуточном развертывании для *синхронизации хэша паролей*, *сквозной проверки подлинности* или *простого единого входа*.

  >[!NOTE]
  >Событие аудита регистрируется, если *простой единый вход* включен с помощью промежуточного развертывания.

  ![Область Create rollout policy for feature (Создание политики развертывания для компонента) на вкладке "Действия"](./media/how-to-connect-staged-rollout/sr7.png)

  ![Область Create rollout policy for feature (Создание политики развертывания для компонента) на вкладке "Измененные свойства"](./media/how-to-connect-staged-rollout/sr8.png)

- Событие аудита при добавлении группы к *синхронизации хэша паролей*, *сквозной проверке подлинности* или *простому единому входу*.

  >[!NOTE]
  >Событие аудита регистрируется при добавлении группы к  *синхронизации хэша паролей* для промежуточного развертывания.

  ![Область Add a group to feature rollout (Добавление группы в развертывание компонента) на вкладке "Действия"](./media/how-to-connect-staged-rollout/sr9.png)

  ![Область Add a group to feature rollout (Добавление группы в развертывание компонента) на вкладке "Измененные свойства"](./media/how-to-connect-staged-rollout/sr10.png)

- Событие аудита, если пользователь, который был добавлен в группу, включен для промежуточного развертывания.

  ![Область "Добавление пользователя в развертывание компонента" на вкладке Действия](media/how-to-connect-staged-rollout/sr11.png)

  ![Область Add a group to feature rollout (Добавление группы в развертывание компонента) на вкладке "Цели"](./media/how-to-connect-staged-rollout/sr12.png)

## <a name="validation"></a>Проверка

Чтобы проверить данные для входа с помощью *синхронизации хэша паролей* или *сквозной проверки подлинности* (имя пользователя и пароль для входа), выполните следующие действия:

1. В экстрасети перейдите на [страницу приложений](https://myapps.microsoft.com) в частном сеансе браузера, а затем введите UserPrincipalName (имя субъекта-пользователя) учетной записи пользователя, выбранной для промежуточного развертывания.

   Пользователи, назначенные для промежуточного развертывания, не перенаправляются на вашу страницу федеративного входа. Вместо этого им предлагается войти на страницу входа с фирменной символикой клиента Azure AD.

1. Убедитесь, что информация о входе появилась в [отчете о действиях входа в Azure AD](../reports-monitoring/concept-sign-ins.md), выполнив фильтрацию с помощью UserPrincipalName.

Для проверки входа с помощью *простого единого входа* выполните следующие действия:

1. В интрасети перейдите на [страницу приложений](https://myapps.microsoft.com) в частном сеансе браузера, а затем введите UserPrincipalName (имя субъекта-пользователя) учетной записи пользователя, выбранной для промежуточного развертывания.

   Пользователи, назначенные для промежуточного развертывания *простого единого входа*, получат сообщение "Выполняется попытка входа" перед тем, как они войдут в автоматическом режиме.

1. Убедитесь, что информация о входе появилась в [отчете о действиях входа в Azure AD](../reports-monitoring/concept-sign-ins.md), выполнив фильтрацию с помощью UserPrincipalName.

   Для отслеживания событий входов пользователей, которые по-прежнему происходят в службе федерации Active Directory (AD FS) для выбранных пользователей с промежуточным развертыванием, следуйте инструкциям в разделе [Устранение неполадок в AD FS. События и ведение журнала](/windows-server/identity/ad-fs/troubleshooting/ad-fs-tshoot-logging#types-of-events). Сведения об определении сторонних поставщиков федерации содержатся в документации поставщика.

## <a name="remove-a-user-from-staged-rollout"></a>Удаление пользователя из промежуточного развертывания

Удаление пользователя из группы отключает функцию промежуточного развертывания для этого пользователя. Чтобы отключить функцию промежуточного развертывания, передвиньте ползунок управления обратно в положение **Выкл.**

## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы

**Вопрос. Можно ли использовать эту возможность в рабочей среде?**

A. Да, эту функцию можно использовать в рабочем клиенте, но рекомендуем сначала попробовать ее в тестовом клиенте.

**Вопрос. Можно ли использовать эту функцию на постоянной основе, если некоторые пользователи используют федеративную проверку подлинности, а другие — облачную?**

Ответ. нет, эта функция предназначена для тестирования проверки подлинности в облаке. После успешного тестирования нескольких групп пользователей следует переключиться на проверку подлинности в облаке. Мы не рекомендуем использовать постоянное смешанное состояние, так как этот подход может привести к непредвиденным потокам проверки подлинности.

**Вопрос. Можно ли использовать PowerShell для выполнения промежуточного развертывания?**

A. Да. Сведения об использовании PowerShell для выполнения промежуточного развертывания см. в статье [AzureADPreview](/powershell/module/azuread/?view=azureadps-2.0-preview&preserve-view=true#staged_rollout).

## <a name="next-steps"></a>Дальнейшие действия
- [AzureADPreview](/powershell/module/azuread/?view=azureadps-2.0-preview&preserve-view=true#staged_rollout )
- [Изменение метода входа на синхронизацию хэшей паролей](plan-migrate-adfs-password-hash-sync.md#step-3-change-the-sign-in-method-to-password-hash-synchronization-and-enable-seamless-sso)
- [Изменение метода входа для сквозной проверки подлинности](plan-migrate-adfs-password-hash-sync.md#step-3-change-the-sign-in-method-to-password-hash-synchronization-and-enable-seamless-sso)
