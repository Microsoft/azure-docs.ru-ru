---
title: Установка Azure AD Connect с помощью имеющейся базы данных ADSync | Документация Майкрософт
description: В этой статье описывается, как использовать имеющуюся базу данных ADSync.
services: active-directory
documentationcenter: ''
author: billmath
manager: daveba
editor: ''
ms.reviewer: cychua
ms.assetid: ''
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: how-to
ms.date: 08/30/2017
ms.subservice: hybrid
ms.author: billmath
ms.collection: M365-identity-device-management
ms.openlocfilehash: a8324b82a05d7e78772e0b0b6de3a9bfaa183411
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "91265397"
---
# <a name="install-azure-ad-connect-using-an-existing-adsync-database"></a>Установка Azure AD Connect с помощью имеющейся базы данных ADSync
Azure AD Connect требуется база данных SQL Server для хранения данных. Можно использовать выпуск SQL Server 2012 Express LocalDB по умолчанию, установленный с помощью Azure AD Connect, или полную версию SQL Server. Ранее при установке Azure AD Connect всегда создавалась база данных с именем ADSync. В Azure AD Connect версии 1.1.613.0 (или более поздней) имеется возможность установить Azure AD Connect, указав имеющуюся базу данных ADSync.

## <a name="benefits-of-using-an-existing-adsync-database"></a>Преимущества использования имеющейся базы данных ADSync
Указание имеющейся базы данных ADSync:

- За исключением учетных данных, конфигурация синхронизации, хранимая в базе данных ADSync, (включая пользовательские правила синхронизации, соединители, фильтрацию и конфигурацию дополнительных возможностей) автоматически восстанавливается и используется при установке. Учетные данные, используемые Azure AD Connect для синхронизации изменений с локальной службой AD и Azure AD, зашифрованы, и доступ к ним можно получить только из предыдущего сервера Azure AD Connect.
- Также восстанавливаются все данные идентификации (связанные с пространствами соединителя и метавселенной) и файлы cookie синхронизации, хранимые в базе данных ADSync. Недавно установленный сервер Azure AD Connect может продолжать синхронизацию с места остановки предыдущего сервера Azure AD Connect, не требуя выполнения полной синхронизации.

## <a name="scenarios-where-using-an-existing-adsync-database-is-beneficial"></a>Сценарии, в которых использование имеющейся базы данных ADSync, является целесообразным
Эти преимущества полезны в следующих случаях:


- Если у вас имеется развертывание Azure AD Connect. Имеющийся сервер Azure AD Connect больше не работает, но сервер SQL, на котором содержится база данных ADSync, по-прежнему работает. Можно установить новый сервер Azure AD Connect и указать имеющуюся базу данных ADSync. 
- Если у вас имеется развертывание Azure AD Connect. Сервер SQL, на котором содержится база данных ADSync, больше не работает. Однако у вас есть недавняя резервная копия базы данных. Сначала можно восстановить базу данных ADSync на новом сервере SQL. После чего можно установить новый сервер Azure AD Connect и указать для него восстановленную базу данных ADSync.
- Если имеется развертывание Azure AD Connect, использующее LocalDB. Из-за ограничения в 10 ГБ, наложенного LocalDB, можно использовать полную версию SQL Server. Базу данных ADSync можно архивировать из LocalDB и восстановить на сервере SQL. После чего можно переустановить новый сервер Azure AD Connect и указать для него восстановленную базу данных ADSync.
- Вы пытаетесь настроить промежуточный сервер и хотите убедиться, что его конфигурация соответствует конфигурации текущего активного сервера. Можно архивировать базу данных ADSync и восстановить ее на другом сервере SQL. После чего можно переустановить новый сервер Azure AD Connect и указать для него восстановленную базу данных ADSync.

## <a name="prerequisite-information"></a>Предварительные требования

Прежде чем продолжать, следует обратить внимание на некоторые важные примечания:

- Не забудьте проверить предварительные требования для установки Azure AD Connect на оборудовании, а также учетную запись и разрешения, необходимые для установки Azure AD Connect. Разрешения, необходимые для установки Azure AD Connect с использованием режима "Использовать существующую базу данных", совпадают с разрешениями для выборочной установки.
- Развертывание Azure AD Connect для существующей базы данных ADSync поддерживается только с помощью полнофункциональной платформы SQL. Оно не поддерживается для SQL Express LocalDB. Если у вас есть база данных ADSync в LocalDB, которую вы хотите использовать, необходимо сначала создать резервную копию базы данных ADSync (LocalDB), а затем восстановить ее на полнофункциональную платформу SQL. После чего можно будет развернуть Azure AD Connect для восстановленной базы данных с помощью описанного метода.
- Версия Azure AD Connect, используемая для установки, должна удовлетворять следующие условия:
    - 1.1.613.0 или выше.
    - Такая же или более поздняя, чем версия Azure AD Connect, которая последний раз использовалась с базой данных ADSync. Если версия Azure AD Connect, используемая для установки, выше, чем версия, которая последний раз использовалась с базой данных ADSync, может потребоваться полная синхронизация.  Полная синхронизация необходима, если схема или правило синхронизации отличаются между двумя версиями. 
- Используемая база данных ADSync должна содержать относительно недавнее состояние синхронизации. Последнее действие синхронизации с имеющейся базой данных ADSync должно быть выполнено в течение последних трех недель.
- При установке Azure AD Connect с помощью метода "Использовать существующую базу данных" метод входа, настроенный на предыдущем сервере Azure AD Connect, не сохраняется. Кроме того, настроить метод входа во время установки нельзя. Метод входа можно настроить только после завершения установки.
- Несколько серверов Azure AD Connect не могут совместно использовать одну и ту же базу данных ADSync. Метод "Использовать существующую базу данных" позволяет повторно использовать имеющуюся базу данных ADSync с новым сервером Azure AD Connect. Он не поддерживает совместное использование.

## <a name="steps-to-install-azure-ad-connect-with-use-existing-database-mode"></a>Шаги по установке Azure AD Connect с режимом "Использовать существующую базу данных"
1.  Скачайте установщик Azure AD Connect (AzureADConnect.MSI) на сервер Windows. Дважды щелкните установщик Azure AD Connect, чтобы начать установку Azure AD Connect.
2.  По завершении установки MSI мастер Azure AD Connect запускается с настройкой режима Express. Закройте экран, щелкнув значок "Выход".
![Снимок экрана, на котором показана страница "Добро пожаловать в Azure A D Connect" с "Экспресс-параметрами" в выделенном слева меню.](./media/how-to-connect-install-existing-database/db1.png)
3.  Запустите новую командную строку или сеанс PowerShell. Перейдите в папку "C:\Program Files\Microsoft Azure Active Directory Connect". Выполните команду \AzureADConnect.exe /useexistingdatabase, чтобы запустить мастер Azure AD Connect в режиме установки "Использовать существующую базу данных".

> [!NOTE]
> Используйте параметр **/UseExistingDatabase**, только когда база данных уже содержит данные из предыдущей установки Azure AD Connect. Например, когда вы переходите с локальной базы данных на полную базу данных SQL Server или при перестройке сервера Azure AD Connect, если вы восстановили резервную копию SQL базы данных ADSync из более ранней установки Azure AD Connect. Если база данных пуста, то это не содержит данных из предыдущей Azure AD Connect установки, пропустите этот шаг.

![PowerShell](./media/how-to-connect-install-existing-database/db2.png)
1. Появится экран приветствия Azure AD Connect. После принятия условий лицензии и заявления о конфиденциальности, щелкните **Продолжить**.
   ![Снимок экрана, показывающий страницу "Добро пожаловать в Azure A D Connect"](./media/how-to-connect-install-existing-database/db3.png)
1. На экране **Установить требующиеся компоненты** включен параметр **Использовать существующий SQL Server**. Укажите имя сервера SQL, на котором размещена база данных ADSync. Если экземпляр ядра SQL, используемый для размещения базы данных, не является экземпляром по умолчанию сервера SQL, необходимо указать ядро SQL и имя экземпляра. Кроме того, если просмотр SQL не включен, также необходимо указать номер порта экземпляра ядра SQL. Пример:         
   ![Снимок экрана, на котором показана страница "Установка необходимых компонентов".](./media/how-to-connect-install-existing-database/db4.png)           

1. На экране **Подключение к Azure AD** необходимо предоставить учетные данные глобального администратора для каталога Azure AD. Рекомендуется использовать учетную запись в домене onmicrosoft.com по умолчанию. Эта учетная запись используется только для создания учетной записи службы в Azure AD и не используется после завершения работы мастера.
   ![Подключить](./media/how-to-connect-install-existing-database/db5.png)
 
1. На экране **Подключить каталоги** имеющийся лес AD, настроенный для синхронизации каталогов, помечен красным значком с крестиком. Для синхронизации изменений из локального леса AD необходима учетная запись AD DS. Мастер Azure AD Connect не может извлечь учетные данные учетной записи AD DS, хранимые в базе данных ADSync, так как они зашифрованы и могут быть расшифрованы только предыдущим сервером Azure AD Connect. Щелкните **Изменить учетные данные**, чтобы указать учетную запись AD DS для леса AD.
   ![Directories](./media/how-to-connect-install-existing-database/db6.png)
 
1. Во всплывающем диалоговом окне можно (а) предоставить учетные данные администратора предприятия и позволить Azure AD Connect создать учетную запись AD DS или (б) создать учетную запись AD DS самостоятельно и предоставить ее учетные данные Azure AD Connect. После выбора варианта и предоставления необходимых учетных данных щелкните **ОК**, чтобы закрыть всплывающее диалоговое окно.
   ![Снимок экрана, на котором отображается всплывающее диалоговое окно "учетная запись для леса" с выбранным параметром "создать новую учетную запись D".](./media/how-to-connect-install-existing-database/db7.png)
 
1. После предоставления учетных данных красный значок с крестиком заменяется зеленым значком с галочкой. Щелкните **Далее**.
   ![Снимок экрана, на котором показана страница "подключение каталогов".](./media/how-to-connect-install-existing-database/db8.png)
 
1. На экране **все готово для настройки** нажмите кнопку **установить**.
   ![Добро пожаловать!](./media/how-to-connect-install-existing-database/db9.png)
 
1. По завершении установки сервер Azure AD Connect автоматически включается в промежуточном режиме. Перед отключением промежуточного режима рекомендуется проверить конфигурацию сервера и ожидающие операции экспорта на наличие неожиданных изменений. 

## <a name="post-installation-tasks"></a>Действия после установки
При восстановлении резервной копии базы данных, созданной с помощью Azure AD Connect версии до 1.2.65.0, промежуточный сервер автоматически выбирает метод входа **Не настраивать**. Хотя при этом будут восстановлены настройки синхронизации хэшей паролей и обратной записи паролей, вам придется позднее изменить метод входа в соответствии с политиками, действующими для активного сервера синхронизации.  Невыполнение этих действий приведет к тому, что пользователи не смогут зарегистрироваться, когда этот сервер станет активным.  

Следующая таблица поможет вам выбрать необходимые дополнительные шаги.

|Компонент|Шаги|
|-----|-----|
|Синхронизация хэша паролей| Настройки синхронизации хэша паролей и обратной записи паролей полностью восстанавливаются в Azure AD Connect, начиная с версии 1.2.65.0.  Если восстановление выполняется в более ранней версии Azure AD Connect, проверьте параметры синхронизации для этих функций, чтобы они соответствовали настройкам активного сервера синхронизации.  Никаких других действий по настройке не требуется.|
|Федерация с AD FS|Для проверки подлинности Azure будет и далее использоваться политика AD FS, настроенная для активного сервера синхронизации.  Если вы используете Azure AD Connect для управления фермой AD FS, можете изменить метод входа на федерацию AD FS в процессе подготовки резервного сервера к переключению в режим активного экземпляра синхронизации.   Если на активном сервере синхронизации включены параметры синхронизации, их можно перенести на настраиваемый сервер с помощью задачи "Настройка параметров устройства".|
|Сквозная проверка подлинности и единый вход на рабочий стол|Измените метод входа в соответствии с конфигурацией активного сервера синхронизации.  Если вы не выполните это действие, прежде чем повысить уровень сервера до первичного, сквозная проверка подлинности и простой единый вход будут отключены и ваш клиент не сможет выполнить вход, если не настроена синхронизация паролей как резервный метод входа. Также не забывайте, что при включении сквозной проверки подлинности в промежуточном режиме будет установлен и зарегистрирован новый агент аутентификации, который будет выполняться как агент высокого уровня доступности и принимать запросы на вход.|
|Федерация с PingFederate|Для проверки подлинности Azure будет и далее использоваться политика PingFederate, настроенная для активного сервера синхронизации.  Вы можете изменить метод входа на PingFederate в процессе подготовки резервного сервера к переключению в режим активного экземпляра синхронизации.  Этот шаг можно отложить до того момента, пока вам понадобится добавить в федерацию с PingFederate дополнительные домены.|

## <a name="next-steps"></a>Дальнейшие действия

- После установки Azure AD Connect можно [проверить установку и назначить лицензии](how-to-connect-post-installation.md).
- См. дополнительные сведения о [предотвращении случайного удаления](how-to-connect-sync-feature-prevent-accidental-deletes.md) и [Azure AD Connect Health](how-to-connect-health-sync.md).
- Дополнительные сведения см. в статье [Синхронизация Azure AD Connect: планировщик](how-to-connect-sync-feature-scheduler.md).
- Узнайте больше об [интеграции локальных удостоверений с Azure Active Directory](whatis-hybrid-identity.md).
