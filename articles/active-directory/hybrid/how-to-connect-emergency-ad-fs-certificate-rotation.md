---
title: Аварийное вращение сертификатов AD FS | Документация Майкрософт
description: В этой статье объясняется, как немедленно отозвать и обновить сертификаты AD FS.
services: active-directory
documentationcenter: ''
author: billmath
manager: daveba
ms.service: active-directory
ms.workload: identity
ms.topic: how-to
ms.date: 03/22/2021
ms.subservice: hybrid
ms.author: billmath
ms.openlocfilehash: 9035c0a91bbbd7493437c692540fcbb3136a094e
ms.sourcegitcommit: c94e282a08fcaa36c4e498771b6004f0bfe8fb70
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/26/2021
ms.locfileid: "105613128"
---
# <a name="emergency-rotation-of-the-ad-fs-certificates"></a>Аварийное вращение сертификатов AD FS
В случае немедленного поворота AD FS сертификатов можно выполнить действия, описанные ниже в этом разделе.

> [!IMPORTANT]
> Выполнение описанных ниже действий в AD FSной среде приведет к немедленному отмене старых сертификатов.  Так как это выполняется немедленно, обычно для партнеров Федерации, использующих ваш новый сертификат, разрешено нормальное время. Это может привести к сбою службы, так как доверяет обновлению, чтобы использовать новые сертификаты.  Это необходимо решить после того, как все партнеры Федерации будут иметь новые сертификаты.

> [!NOTE]
> Корпорация Майкрософт настоятельно рекомендует использовать аппаратный модуль безопасности (HSM) для защиты и безопасности сертификатов.
> Дополнительные сведения см. в разделе [модуль безопасности оборудования](https://docs.microsoft.com/windows-server/identity/ad-fs/deployment/best-practices-securing-ad-fs#hardware-security-module-hsm) раздела рекомендации по обеспечению безопасности AD FS.

## <a name="determine-your-token-signing-certificate-thumbprint"></a>Определение отпечатка сертификата для подписи маркера
Чтобы отозвать старый сертификат подписи маркера, который AD FS используется в настоящее время, необходимо определить отпечаток сертификата Token-сигининг.  Для этого выполните следующие действия.

 1. Подключение к Microsoft Online Service `PS C:\>Connect-MsolService`
 2. Задокументируйте как локальный, так и отпечаток сертификата подписи маркера облака и сроки действия.
`PS C:\>Get-MsolFederationProperty -DomainName <domain>` 
 3.  Скопируйте отпечаток.  Он будет использоваться позже для удаления существующих сертификатов.

Отпечаток можно также получить с помощью AD FS управления, перехода к службе или сертификатам, щелчком сертификата правой кнопкой мыши, выбора параметра Просмотр сертификата и выбора сведений. 

## <a name="determine-whether-ad-fs-renews-the-certificates-automatically"></a>Определить, будет ли AD FS автоматически переправлять сертификаты
По умолчанию в AD FS автоматически создаются сертификаты для подписи и расшифровки маркеров, когда выполняется начальная настройка и приближается дата окончания срока действия.

Можно выполнить следующую команду Windows PowerShell: `PS C:\>Get-AdfsProperties | FL AutoCert*, Certificate*` .

Свойство AutoCertificateRollover описывает, настроена AD FS ли настройка для автоматической подписывания маркера и расшифровки сертификатов.  Если для AutoCertificateRollover задано значение TRUE, следуйте инструкциям в разделе [Создание самозаверяющего сертификата, если для AutoCertificateRollover задано значение TRUE].  Если для AutoCertificateRollover задано значение FALSE, следуйте инструкциям в разделе [создание новых сертификатов вручную, если AutoCertificateRollover имеет значение FALSE].


## <a name="generating-new-self-signed-certificate-if-autocertificaterollover-is-set-to-true"></a>Создание нового самозаверяющего сертификата, если для AutoCertificateRollover задано значение TRUE
В этом разделе вы создадите **два** сертификата для подписи маркера.  В первом будет использоваться флаг **-срочно** , который немедленно заменит текущий первичный сертификат.  Второй будет использоваться для вторичного сертификата.  

>[!IMPORTANT]
>Причина, по которой мы создаем два сертификата, заключается в том, что Azure содержит сведения о предыдущем сертификате.  Создав второй, мы принудительно выпустите в Azure сведения о старом сертификате и замените его сведениями о втором сертификате.
>
>Если вы не создадите второй сертификат и не обновите Azure с его помощью, возможно, старый сертификат для подписи токена будет проходить проверку подлинности пользователей.

Чтобы создать новые сертификаты для подписи маркеров, можно выполнить следующие действия.

 1. Убедитесь, что вы вошли на основной сервер AD FS.
 2. Откройте Windows PowerShell от имени администратора. 
 3. Убедитесь, что для AutoCertificateRollover задано значение true.
`PS C:\>Get-AdfsProperties | FL AutoCert*, Certificate*`
 4. Чтобы создать новый сертификат для подписи маркера, выполните следующие действия `Update-ADFSCertificate –CertificateType token-signing -Urgent` .
 5. Проверьте обновление, выполнив следующую команду: `Get-ADFSCertificate –CertificateType token-signing`
 6. Теперь создайте второй сертификат подписи маркера: `Update-ADFSCertificate –CertificateType token-signing` .
 7. Вы можете проверить обновление, выполнив следующую команду еще раз: `Get-ADFSCertificate –CertificateType token-signing`


## <a name="generating-new-certificates-manually-if-autocertificaterollover-is-set-to-false"></a>Создание новых сертификатов вручную, если для AutoCertificateRollover задано значение FALSE
Если вы не используете автоматически формируемые по умолчанию самозаверяющие сертификаты для подписи и расшифровки маркеров, необходимо продлить и настроить эти сертификаты вручную.  Это включает в себя создание двух новых сертификатов для подписи маркера и их импорт.  Затем необходимо повысить уровень до первичной, отозвать старый сертификат и настроить второй сертификат в качестве вторичного сертификата.

Сначала необходимо получить два новых сертификата из центра сертификации и импортировать их в личное хранилище сертификатов локального компьютера на каждом сервере федерации. Инструкции см. в статье [Импорт сертификата](https://technet.microsoft.com/library/cc754489.aspx) .

>[!IMPORTANT]
>Причина, по которой мы создаем два сертификата, заключается в том, что Azure содержит сведения о предыдущем сертификате.  Создав второй, мы принудительно выпустите в Azure сведения о старом сертификате и замените его сведениями о втором сертификате.
>
>Если вы не создадите второй сертификат и не обновите Azure с его помощью, возможно, старый сертификат для подписи токена будет проходить проверку подлинности пользователей.

### <a name="to-configure-a-new-certificate-as-a-secondary-certificate"></a>Настройка нового сертификата в качестве дополнительного сертификата
Затем необходимо настроить один сертификат в качестве вторичного AD FS сертификат подписи или расшифровки маркера, а затем распространить его на основной

1. После импорта сертификата Откройте консоль **управления AD FS** .
2. Разверните узел **Служба** и выберите **Сертификаты**.
3. На панели Действия щелкните **добавить Token-Signing сертификат**.
4. Выберите новый сертификат из списка и нажмите кнопку ОК.

### <a name="to-promote-the-new-certificate-from-secondary-to-primary"></a>Изменение нового сертификата с дополнительного на основной
Теперь, когда новый сертификат был импортирован и настроен в AD FS, необходимо задать в качестве основного сертификата.
1. Откройте консоль **управления AD FS** .
2. Разверните узел **Служба** и выберите **Сертификаты**.
3. Щелкните дополнительный сертификат подписи токена.
4. В области **Действия** щелкните **Использовать как основной**. В запросе подтверждения нажмите кнопку Да.
5. После того как новый сертификат был выдвинут на роль основного, следует удалить старый сертификат, так как он по-прежнему можно использовать. См. раздел [Удаление старых сертификатов](#remove-your-old-certificates) ниже.  

### <a name="to-configure-the-second-certificate-as-a-secondary-certificate"></a>Настройка второго сертификата в качестве дополнительного
Теперь, когда вы добавили первый сертификат и сделали его основным и удалили старый, импортируйте второй сертификат.  Затем необходимо настроить сертификат в качестве дополнительного сертификата для подписи маркера AD FS

1. После импорта сертификата Откройте консоль **управления AD FS** .
2. Разверните узел **Служба** и выберите **Сертификаты**.
3. На панели Действия щелкните **добавить Token-Signing сертификат**.
4. Выберите новый сертификат из списка и нажмите кнопку ОК.

## <a name="update-azure-ad-with-the-new-token-signing-certificate"></a>Обновление Azure AD с помощью нового сертификата для подписи токена
Откройте модуль Microsoft Azure Active Directory для Windows PowerShell. Кроме того, можно открыть Windows PowerShell и выполнить команду. `Import-Module msonline`

Подключитесь к Azure AD, выполнив следующую команду: `Connect-MsolService` , а затем введите учетные данные глобального администратора.

>[!Note]
> Если вы выполняете эти команды на компьютере, который не является основным сервером федерации, сначала введите следующую команду: `Set-MsolADFSContext –Computer <servername>` . Замените на <servername> имя сервера AD FS. После появлении запроса введите учетные данные администратора для AD FS сервера.

При необходимости проверьте, требуется ли обновление, проверив сведения о текущем сертификате в Azure AD. Для этого выполните следующую команду: `Get-MsolFederationProperty` . При появлении запроса введите имя федеративного домена.

Чтобы обновить сведения о сертификате в Azure AD, выполните следующую команду: `Update-MsolFederatedDomain` и введите имя домена при появлении запроса.

>[!Note]
> Если при выполнении этой команды появится сообщение об ошибке, выполните следующую команду: `Update-MsolFederatedDomain –SupportMultipleDomain` , а затем введите имя домена при появлении запроса.

## <a name="replace-ssl-certificates"></a>Замена SSL-сертификатов
В случае, когда необходимо заменить сертификат подписи маркера из-за компрометации, следует также отозвать и заменить SSL-сертификаты для AD FS и серверов WAP.  

Отзыв SSL-сертификатов должен выполняться в центре сертификации (ЦС), который выдал сертификат.  Эти сертификаты часто выдаются сторонними поставщиками, например GoDaddy.  Пример см. в разделе (отзыв сертификата | SSL-сертификаты — GoDaddy Помогите нам).  Дополнительные сведения см. в статье [о том, как работает отзыв сертификатов](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/ee619754(v=ws.10)?redirectedfrom=MSDN).

После того как старый SSL-сертификат был отозван и был выдан новый, можно заменить SSL-сертификаты. Дополнительные сведения см. [в разделе Замена SSL-сертификата для AD FS](https://docs.microsoft.com/windows-server/identity/ad-fs/operations/manage-ssl-certificates-ad-fs-wap#replacing-the-ssl-certificate-for-ad-fs).


## <a name="remove-your-old-certificates"></a>Удаление старых сертификатов
После замены старых сертификатов следует удалить старый сертификат, так как он по-прежнему можно использовать. . Для этого выполните следующие действия:.  Выполните указанные ниже действия:

1. Убедитесь, что вы вошли на основной сервер AD FS.
2. Откройте Windows PowerShell от имени администратора. 
4. Чтобы удалить старый сертификат для подписи маркера: `Remove-ADFSCertificate –CertificateType token-signing -thumbprint <thumbprint>` .

## <a name="updating-federation-partners-who-can-consume-federation-metadata"></a>Обновление партнеров Федерации, которые могут использовать метаданные федерации
Если вы обновили и настроили новый сертификат для подписи маркера или маркера, убедитесь, что все партнеры Федерации (организация ресурсов или партнеры Организации, представленные в AD FS с помощью отношений доверия проверяющей стороны и отношений поставщиков утверждений) получили новые сертификаты.

## <a name="updating-federation-partners-who-can-not-consume-federation-metadata"></a>Обновление партнеров Федерации, которые не могут использовать метаданные федерации
Если ваши партнеры Федерации не могут использовать метаданные федерации, необходимо вручную отправить им открытый ключ нового сертификата для подписи маркера и расшифровки маркера. Отправьте новый открытый ключ сертификата (CER-файл или. p7b, если вы хотите включить всю цепочку) ко всем партнерам по организации ресурсов или организациям Организации (представленных в AD FS с помощью отношений доверия с проверяющей стороной и отношений доверия поставщиков утверждений). Поверьте, что партнеры реализуют изменения на своих сторонах, чтобы доверять новым сертификатам.



## <a name="revoke-refresh-tokens-via-powershell"></a>Отозвать маркеры обновления с помощью PowerShell
Теперь мы хотим отозвать маркеры обновления для пользователей, которые могут иметь их, и заставить их повторно войти в систему и получить новые маркеры.  Это приведет к выходу пользователей из своих телефонов, текущих сеансов веб электронной почты, а также других элементов, использующих маркеры и маркеры обновления.  Информацию можно найти [здесь](https://docs.microsoft.com/powershell/module/azuread/revoke-azureaduserallrefreshtoken?view=azureadps-2.0&preserve-view=true) , и вы также можете обратиться к справке [по отмене доступа пользователей в Azure Active Directory](../../active-directory/enterprise-users/users-revoke-access.md).

## <a name="next-steps"></a>Дальнейшие действия

- [Управление SSL-сертификатами в AD FS и WAP в Windows Server 2016](https://docs.microsoft.com/windows-server/identity/ad-fs/operations/manage-ssl-certificates-ad-fs-wap#replacing-the-ssl-certificate-for-ad-fs)
- [Получение и настройка сертификатов подписи маркеров и расшифровки маркеров для AD FS](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn781426(v=ws.11)#updating-federation-partners)
- [Продлите сертификаты Федерации для Microsoft 365 и Azure Active Directory](how-to-connect-fed-o365-certs.md)



















