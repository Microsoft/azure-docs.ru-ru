---
title: Руководство. Настройка Azure Active Directory для выпуска проверяемых учетных данных (предварительная версия)
description: В этом руководстве описано, как создать среду, необходимую для развертывания проверяемых учетных данных в клиенте
documentationCenter: ''
author: barclayn
manager: daveba
ms.service: identity
ms.topic: tutorial
ms.subservice: verifiable-credentials
ms.date: 04/01/2021
ms.author: barclayn
ms.reviewer: ''
ms.openlocfilehash: cd39f6c484ebe116918611bb1d543c1919a3cb0a
ms.sourcegitcommit: 3f684a803cd0ccd6f0fb1b87744644a45ace750d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/02/2021
ms.locfileid: "106222951"
---
# <a name="tutorial---configure-your-azure-active-directory-to-issue-verifiable-credentials-preview"></a>Руководство. Настройка Azure Active Directory для выпуска проверяемых учетных данных (предварительная версия)

В этом руководстве мы воспользуемся результатами работы, выполненной в рамках статьи [Приступая к работе](get-started-verifiable-credentials.md), и настроим Azure Active Directory (Azure AD) с его собственным [децентрализованным идентификатором](https://www.microsoft.com/security/business/identity-access-management/decentralized-identity-blockchain?rtc=1#:~:text=Decentralized%20identity%20is%20a%20trust,protect%20privacy%20and%20secure%20transactions.) (DID). Мы используем децентрализованный идентификатор для выдачи проверяемых учетных данных с помощью примера приложения и поставщика. Однако в этом руководстве мы по-прежнему используем пример клиента Azure B2C для проверки подлинности.  В следующем руководстве мы выполним дополнительные действия, чтобы настроить приложение для работы с Azure AD.

> [!IMPORTANT]
> В настоящее время проверяемые учетные данные Azure Active Directory доступны в виде предварительной версии.
> Эта предварительная версия предоставляется без соглашения об уровне обслуживания и не рекомендована для использования рабочей среде. Некоторые функции могут не поддерживаться или их возможности могут быть ограничены. Дополнительные сведения см. в статье [Дополнительные условия использования предварительных выпусков Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).

Содержание этой статьи

> [!div class="checklist"]
> * Создание необходимых служб для подключения Azure AD к проверяемым учетным данным 
> * Создание DID
> * Настройка правил и отображаемых файлов
> * Настройка проверяемых учетных данных в Azure AD.


## <a name="prerequisites"></a>Предварительные условия

Перед успешным завершением данного руководства необходимо выполнить следующее:

- Ознакомьтесь с разделом [Начало работы](get-started-verifiable-credentials.md).
- Подготовьте учетную запись Azure с активной подпиской. [Создайте учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F) бесплатно.
- Azure AD с [лицензией](https://azure.microsoft.com/pricing/details/active-directory/) P2. Выполните процедуру в разделе [Создание бесплатной учетной записи разработчика](how-to-create-a-free-developer-account.md), если такой учетной записи у вас нет.
- Экземпляр [Azure Key Vault](../../key-vault/general/overview.md), в котором у вас есть права на создание ключей и секретов.

## <a name="azure-active-directory"></a>Azure Active Directory

Прежде чем начать, нам нужен клиент Azure AD. Если клиент включен для проверяемых учетных данных, ему назначается децентрализованный идентификатор (DID), и он включается службой издателя для выдачи проверяемых учетных данных. Все проверяемые учетные данные выдаются вашим клиентом и его идентификатором DID. DID также используется при проверке проверяемых учетных данных.
Если вы только что создали тестовую подписку Azure, для клиента не нужно заполнять учетные записи пользователей, но для выполнения последующих руководств вам потребуется хотя бы одна тестовая учетная запись пользователя.

## <a name="create-a-key-vault"></a>Создание хранилища ключей

При работе с проверяемыми учетными данными вы можете полностью контролировать и управлять криптографическими ключами, которые ваш клиент использует для цифровой подписи проверяемых учетных данных. Чтобы выдать и проверить учетные данные, необходимо, чтобы Azure AD имела доступ к вашему экземпляру Azure Key Vault.

1. На **домашней странице** или в меню портала Azure выберите команду **Создать ресурс**.
2. В поле поиска введите **Key Vault**.
3. В списке результатов выберите **Key Vault**.
4. В разделе Key Vault выберите **Создать**.
5. В разделе **Создать Key Vault** введите приведенные ниже сведения.
    - **Подписка**: Выберите подписку.
    - В разделе **Группа ресурсов** выберите **Создать** и введите имя группы ресурсов, например **vc-resource-group**. Мы используем одно и то же имя группы ресурсов в разных статьях.
    - **Name** (Имя). Укажите уникальное имя. Мы используем значение **woodgroup-vc-kv**, поэтому введите вместо него свое уникальное имя.
    - В раскрывающемся меню **Расположение** выберите расположение.
    - Для других параметров оставьте значения по умолчанию.
6. После ввода всех этих данных нажмите **Политика доступа**.

    ![страница создания хранилища ключей](media/enable-your-tenant-verifiable-credentials/create-key-vault.png)

7. На экране "Политика доступа" выберите **Добавить политику доступа**.

    >[!NOTE]
    > По умолчанию только эта учетная запись, которая создает хранилище ключей, имеет возможность доступа. Для службы проверяемых учетных данных требуется доступ к хранилищу ключей. Хранилище ключей должно иметь политику доступа, которая позволяет администратору **создавать ключи**, иметь возможность **удалять ключи** в случае вашего отказа и иметь возможность **подписи**, чтобы создавать привязки к домену для проверяемых учетных данных. Если вы используете одну и ту же учетную запись во время тестирования, обязательно измените политику по умолчанию, чтобы предоставить учетной записи право **подписи** в дополнение к разрешениям по умолчанию, предоставленным создателям хранилища.

8. Для администратора убедитесь, что в разделе разрешений для ключа включены операции **Создание**, **Удаление** и **Подпись**. По умолчанию возможность создания и удаления уже включена, а возможность подписания должна быть единственным разрешением для ключа, которое необходимо обновить. 

    ![Разрешения по отношению к хранилищу ключей](media/enable-your-tenant-verifiable-credentials/keyvault-access.png)

9. Выберите **Review + create** (Просмотреть и создать).
10. Нажмите кнопку **Создать**.
11. Перейдите в хранилище и запишите его имя и URI.

Запишите значения двух указанных ниже свойств.

- **Имя хранилища**. В примере используется значение **woodgrove-vc-kv**. Вы будете использовать это имя для выполнения других действий.
- **URI хранилища**. В данном примере используется значение https://woodgrove-vc-kv.vault.azure.net/. Необходимо, чтобы приложения, использующие ваше хранилище через REST API, использовали этот URI.

>[!NOTE]
> Каждая транзакция с хранилищем ключей приводит к дополнительным затратам в подписке Azure. Дополнительные сведения см. на [странице цен на Key Vault](https://azure.microsoft.com/pricing/details/key-vault/).

>[!IMPORTANT]
> В ходе применения предварительной версии проверяемых учетных данных Azure Active Directory ключи и секреты, созданные в хранилище, не должны изменяться после создания. В случае удаления, отключения или обновления ключей и секретов все выданные учетные данные становятся недействительными. Во время использования предварительной версии не изменяйте ключи и секреты.

## <a name="create-a-modified-rules-and-display-file"></a>Создание измененных правил и отображаемого файла

В этом разделе мы используем правила и отображаемые файлы из приложения "Пример издателя" и немного их изменяем, чтобы создать первые проверяемые учетные данные для клиента.

1. Скопируйте правила и отображаемые JSON-файлы во временную папку и переименуйте их **MyFirstVC-display.json** и **MyFirstVC-rules.json**, соответственно. Оба файла находятся в папке **issuer\issuer_config**

   ![отображаемые файлы и правила в каталога примера приложения](media/enable-your-tenant-verifiable-credentials/sample-app-rules-display.png)

   ![отображаемые файлы и правила в папке temp](media/enable-your-tenant-verifiable-credentials/display-rules-files-temp.png)

2. Откройте файл MyFirstVC-rules.json в редакторе кода. 

    ```json
         {
          "attestations": {
            "idTokens": [
              {
                "mapping": {
                  "firstName": { "claim": "given_name" },
                  "lastName": { "claim": "family_name" }
                },
                "configuration": "https://didplayground.b2clogin.com/didplayground.onmicrosoft.com/B2C_1_sisu/v2.0/.well-known/openid-configuration",
                "client_id": "8d5b446e-22b2-4e01-bb2e-9070f6b20c90",
                "redirect_uri": "vcclient://openid/"
              }
            ]
          },
          "validityInterval": 2592000,
          "vc": {
            "type": ["VerifiedCredentialExpert"]
          }
        }
      
    ```

Теперь изменим поле типа на "MyFirstVC". 

  ```json
   "type": ["MyFirstVC"]
  
  ```

Сохраните это изменение.

 >[!NOTE]
   > На данном этапе в этом руководстве мы не изменяем **"configuration"** или **"client_id"** . Мы по-прежнему используем клиент Microsoft B2C, который применяли в разделе [Приступая к работе](get-started-verifiable-credentials.md). В следующем руководстве мы будем использовать Azure AD.

3. Откройте файл MyFirstVC-display.json в редакторе кода.

   ```json
       {
          "default": {
           "locale": "en-US",
           "card": {
             "title": "Verified Credential Expert",
             "issuedBy": "Microsoft",
             "backgroundColor": "#000000",
             "textColor": "#ffffff",
             "logo": {
               "uri": "https://didcustomerplayground.blob.core.windows.net/public/VerifiedCredentialExpert_icon.png",
               "description": "Verified Credential Expert Logo"
             },
             "description": "Use your verified credential to prove to anyone that you know all about verifiable credentials."
           },
           "consent": {
             "title": "Do you want to get your Verified Credential?",
             "instructions": "Sign in with your account to get your card."
           },
           "claims": {
             "vc.credentialSubject.firstName": {
               "type": "String",
               "label": "First name"
             },
             "vc.credentialSubject.lastName": {
               "type": "String",
               "label": "Last name"
             }
           }
         }
      }
   ```

Давайте внесем несколько изменений, чтобы эти проверяемые учетные данные стали заметно отличаться от версии в примере кода. 
    
```json
     "card": {
        "title": "My First VC",
        "issuedBy": "Your Issuer Name",
        "backgroundColor": "#ffffff",
        "textColor": "#000000",
```

Сохраните эти изменения.
## <a name="create-a-storage-account"></a>Создание учетной записи хранения

Перед созданием первых проверяемых учетных данных необходимо создать контейнер хранилища BLOB-объектов, который может содержать наши файлы конфигурации и правил.

1. Создайте учетную запись хранения, используя параметры, показанные ниже. Подробные инструкции см. в разделе [Создание учетной записи хранения](../../storage/common/storage-account-create.md?tabs=azure-portal).

   - **Подписка:** выберите подписку, которую мы используем для этих руководств.
   - **Группа ресурсов:** выберите ту же группу ресурсов, которую мы использовали в предыдущих руководствах (**vc-resource-group**).
   - **Имя**: уникальное имя.
   - **Расположение:** (США) Восточная часть США.
   - **Производительность:** стандартная.
   - **Тип учетной записи:** хранилище версии 2.
   - **Репликация:** локально избыточная.
 
   ![Создание новой учетной записи хранения](media/enable-your-tenant-verifiable-credentials/create-storage-account.png)

2. После создания учетной записи хранения необходимо создать контейнер. Выберите **Контейнеры** в разделе **Хранилище BLOB-объектов** и создайте контейнер, используя приведенные ниже значения.

    - **Имя:** vc-container
    - **Уровень общего доступа:** закрытый (без анонимного доступа)

   ![Создание контейнера](media/enable-your-tenant-verifiable-credentials/new-container.png)

3. Теперь выберите новый контейнер и отправьте новые правила и отображаемые файлы **MyFirstVC-display.json** и **MyFirstVC-rules.json**, созданные ранее.

   ![отправка файла правил](media/enable-your-tenant-verifiable-credentials/blob-storage-upload-rules-display-files.png)

## <a name="assign-blob-role"></a>Назначение роли BLOB-объекта

Перед созданием учетных данных сначала необходимо предоставить пользователю, выполнившему вход, корректное назначение ролей, чтобы он имел доступ к файлам в хранилище BLOB-объектов.

1. Перейдите в раздел **Хранилище** > **Контейнер**.
2. В меню слева выберите **Управление доступом (IAM)** .
3. Выберите **Назначения ролей**.
4. Выберите **Добавить**.
5. В разделе **Роль** выберите **Читатель BLOB-объектов**.
6. В разделе **Назначение доступа для** выберите **Пользователь, группа или субъект служба**.
7. В поле **Выбрать**: выберите учетную запись, которую вы используете для выполнения этих действий.
8. Нажмите кнопку **Сохранить**, чтобы завершить назначение ролей.


   ![Добавление назначения роли](media/enable-your-tenant-verifiable-credentials/role-assignment.png)

  >[!IMPORTANT]
  >По умолчанию создателям контейнеров назначается роль **Владелец**. Роль **Владелец** предоставляет недостаточные права. Для вашей учетной записи требуется роль **Читатель BLOB-объектов**. Дополнительные сведения см. в разделе [Назначение роли RBAC для доступа к большим двоичным объектам и данным очереди с помощью портала Azure](../../storage/common/storage-auth-aad-rbac-portal.md).

## <a name="set-up-verifiable-credentials-preview"></a>Настройка проверяемых учетных данных (предварительная версия)

Теперь необходимо выполнить последнее действие, чтобы настроить клиент для проверяемых учетных данных.

1. На портале Azure выполните поиск по фразе **проверяемые учетные данные**.
2. Выберите **Проверяемые учетные данные (предварительная версия)** .
3. Выберите **Начало работы**
4. Необходимо настроить организацию и указать имя организации, домен и хранилище ключей. Рассмотрим каждое из значений.

      - **название организации**: это имя указывает на то, как вы называете свою компанию в службе проверяемых учетных данных. Это значение не ориентировано на клиента.
      - **Домен:** указанный домен добавляется к конечной точке службы в документе DID. [Microsoft Authenticator](../user-help/user-help-auth-app-download-install.md) и другие кошельки используют эти сведения, чтобы проверить, [связан ли ваш DID с вашим доменом](how-to-dnsbind.md). Если кошелек может проверить DID, он отображает символ "проверено". Если кошельку не удается проверить DID, он информирует пользователя о том, что учетные данные выданы организацией, которую ему не удалось проверить. Домен является привязкой вашего пользователя к какому-то важному факту, о котором пользователь может знать.
      - **Хранилище ключей:** введите имя созданного ранее хранилища Key Vault.
 
   >[!IMPORTANT]
   > Домен не может быть перенаправлением. В противном случае DID и домен нельзя будет связать. Убедитесь, что используется формат https://www.domain.com.
    
5. Выберите **Сохранить и создать учетные данные**.

    ![настройка удостоверения организации](media/enable-your-tenant-verifiable-credentials/save-create.png)

Поздравляем! Теперь ваш клиент поддерживает проверяемые учетные данные (предварительную версию).

## <a name="create-your-vc-in-the-portal"></a>Создание VC на портале

На предыдущем этапе вы находились на странице **Создание новых учетных данных**. 

   ![начало работы с проверяемыми учетными данными](media/enable-your-tenant-verifiable-credentials/create-credential-after-enable-did.png)

1. В разделе "Имя учетных данных" добавьте имя **MyFirstVC**. Это имя используется на портале, чтобы идентифицировать ваши проверяемые учетные данные, и добавляется в контракт на проверяемые учетные данные.
2. В разделе "Отображаемый файл" выберите **Настроить отображаемый файл**.
3. В разделе **Учетные записи хранения** выберите **woodgrovevcstorage**.
4. В списке доступных контейнеров выберите **vc-container**.
5. Выберите файл **MyFirstVC-display.json**, созданный ранее.
6. В разделе **Создание новых учетных данных** в разделе **Файл правил** выберите **Настройка файла правил**.
7. В разделе **Учетные записи хранения** выберите **woodgrovecstorage**.
8. Выберите **vc-container**.
9. Выберите **MyFirstVC-rules.json**
10. На экране **Создание учетных данных** нажмите кнопку **Создать**.

   ![создание новых учетных данных](media/enable-your-tenant-verifiable-credentials/create-my-first-vc.png)

### <a name="credential-url"></a>URL-адрес учетных данных

Теперь, когда у вас есть новые учетные данные, скопируйте URL-адрес учетных данных.

   ![URL-адрес учетных данных для выдачи](media/enable-your-tenant-verifiable-credentials/issue-credential-url.png)

>[!NOTE]
>URL-адрес учетных данных — это комбинация правил и отображаемых файлов. Это URL-адрес, который приложение для проверки подлинности проверяет перед отображением пользователю требований по выдаче проверяемых учетных данных.  

## <a name="update-the-sample-app"></a>Обновление примера приложения

Мы внесли изменения в код издателя примера приложения, чтобы обновить его, используя URL-адрес проверяемых учетных данных. Это позволяет выдавать проверяемые учетные данные с помощью вашего собственного клиента.

1. Перейдите в папку, в которой находятся файлы примера приложения.
2. Откройте папку Issuer, а затем откройте файл app.js в Visual Studio Code.
3. Обновите константу "credential", указав свой новый URL-адрес учетных данных. Задайте для константы credentialType значение "MyFirstVC" и сохраните файл.

    ![изображение visual studio code, где выделены соответствующие области](media/enable-your-tenant-verifiable-credentials/sample-app-vscode.png)

4. Откройте командную строку, а затем папку issuer.
5. Выполните обновленное приложение node.

    ```terminal
    node app.js
    ```

6. Используя другую командную строку, запустите ngrok, чтобы настроить URL-адрес на порт 8081

    ```terminal
    ngrok http 8081
    ```
    
    >[!IMPORTANT]
    > Вы также можете получить предупреждение о том, что это приложение или веб-сайт может быть рискованным. Это сообщение может появиться в данное время, так как мы еще не связали DID с доменом. Чтобы настроить этот параметр, выполните инструкции по [привязке DNS](how-to-dnsbind.md).

    
7. Откройте URL-адрес HTTPS, созданный платформой ngrok.

    ![Конечные точки перенаправления NGROK](media/enable-your-tenant-verifiable-credentials/ngrok-url-screen.png)

8. Выберите **GET CREDENTIAL**
9. В средстве проверки подлинности просканируйте QR-код.
10. В предупреждающем сообщении **Это приложение или веб-сайт может быть рискованным** нажмите **Дополнительно**.

  ![Начальное предупреждение](media/enable-your-tenant-verifiable-credentials/site-warning.png)

11. В сообщении "веб-сайт рискованный" нажмите **Все равно продолжить (небезопасно)** .

  ![Второе предупреждение об издателе](media/enable-your-tenant-verifiable-credentials/site-warning-proceed.png)


12. На экране **Добавление учетных данных** обратите внимание на несколько моментов. 
    1. В верхней части экрана можно увидеть красное сообщение **Не проверено**.
    1. Учетные данные настраиваются на основе изменений, внесенных в отображаемый файл.
    1. Параметр **Вход в учетную запись** указывает на сайт **didplayground.b2clogin.com**.
    
   ![экран добавления учетных данных с предупреждением](media/enable-your-tenant-verifiable-credentials/add-credential-not-verified.png)

13. Нажмите **Вход в учетную запись** и выполните проверку подлинности с помощью учетных данных, введенных в [руководстве по началу работы](get-started-verifiable-credentials.md).
14. После успешной проверки подлинности кнопка **Добавить** больше не является серой. Нажмите **Добавить**.

  ![экрана добавления учетных данных после проверки подлинности](media/enable-your-tenant-verifiable-credentials/add-credential-not-verified-authenticated.png)

Мы выпустили проверяемые учетные данные с помощью нашего клиента, чтобы создать наш vc и по-прежнему использовать наш клиент B2C для проверки подлинности.

  ![vc, выданный платформой azure AD и прошедший проверку подлинности нашим экземпляром Azure B2C](media/enable-your-tenant-verifiable-credentials/my-vc-b2c.png)


## <a name="test-verifying-the-vc-using-the-sample-app"></a>Тестирование проверки VC с помощью примера приложения

Мы выдавали проверенные учетные данные из нашего клиента. Теперь проверим их с помощью нашего примера приложения.

>[!IMPORTANT]
> В ходе тестирования используйте те же адрес электронной почты и пароль, которые использовались в статье [Приступая к работе](get-started-verifiable-credentials.md). Когда клиент выдает vc, входные данные поступают из маркера идентификации, выданного клиентом Microsoft B2C. В руководстве 2 мы переключим выдачу маркера на вашего клиента.

1. Откройте **Параметры** в колонке проверяемых учетных данных на портале Azure. Скопируйте децентрализованный идентификатор (DID).

   ![копирование DID](media/enable-your-tenant-verifiable-credentials/issuer-identifier.png)

2. Теперь откройте папку Verifier, где хранятся файлы примера приложения. Необходимо обновить файл app.js в образце кода средства проверки и внести следующие изменения:

    - **credential**: введите ваш URL-адрес учетных данных
    - **credentialType**: "MyFirstVC"
    - **issuerDid**: скопируйте это значение с портала Azure из раздела Проверяемые учетные данные (Предварительная версия) > Параметры > Децентрализованный идентификатор (DID)
    
   ![обновление константы issuerDid в соответствии с идентификатором издателя](media/enable-your-tenant-verifiable-credentials/editing-verifier.png)

3. Остановите службу ngrok, которая использовалась в качестве издателя учетных данных.

    ```cmd
    control-c
    ```

4. Теперь запустите ngrok с портом 8082 для приложения Verifier.

    ```cmd
    ngrok http 8082
    ```

5. В другом окне терминала перейдите к приложению Verifier и запустите его аналогично тому, как мы запустили приложение Issuer.

    ```cmd
    cd ..
    cd verifier
    node app.js
    ```

6. Откройте URL-адрес ngrok в браузере и просканируйте QR-код с помощью средства проверки подлинности на своем мобильном устройстве.
7. На мобильном устройстве выберите **Разрешить** на экране **запроса нового разрешения**.

    >[!NOTE]
    > Идентификатором DID, подписывающим этот VC, все еще является Microsoft B2C. По-прежнему используется идентификатор DID средства проверки из клиента примера приложения Майкрософт. Так как DID корпорации Майкрософт был связан с доменом, которым мы владеем, вы не получаете предупреждение, которое было получено во время потока выдачи. Это будет обновлено в следующем разделе.
    
   ![запрос нового разрешения](media/enable-your-tenant-verifiable-credentials/new-permission-request.png)

8. Учетные данные успешно проверены.

## <a name="next-steps"></a>Дальнейшие действия

Теперь у вас есть пример кода, который выдает VC из вашего издателя. Можно перейти к следующему разделу, где будет использоваться ваш собственный поставщик удостоверений для проверки подлинности пользователей, пытающихся получить проверяемые учетные данные и использовать ваш DID для подписания запросов на презентацию.

> [!div class="nextstepaction"]
> [Руководство. Выдача и проверка проверяемых учетных данных с помощью клиента](issue-verify-verifiable-credentials-your-tenant.md)


