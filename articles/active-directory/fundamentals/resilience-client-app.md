---
title: Повышение устойчивости проверки подлинности и авторизации в разрабатываемых клиентских приложениях
titleSuffix: Microsoft identity platform
description: Рекомендации по повышению устойчивости проверки подлинности и авторизации в клиентском приложении с использованием платформы идентификации Майкрософт
services: active-directory
ms.service: active-directory
ms.subservice: fundamentals
ms.workload: identity
ms.topic: how-to
author: knicholasa
ms.author: nichola
manager: martinco
ms.date: 11/23/2020
ms.openlocfilehash: bc3b041e44fad66a4edc6ff34c0e534dc423de86
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "99226596"
---
# <a name="increase-the-resilience-of-authentication-and-authorization-in-client-applications-you-develop"></a>Повышение устойчивости проверки подлинности и авторизации в разрабатываемых клиентских приложениях

В этом разделе приводятся рекомендации по созданию устойчивости для клиентских приложений, использующих платформу Microsoft Identity, и Azure Active Directory для входа пользователей и выполнения действий от имени этих пользователей.

## <a name="use-the-microsoft-authentication-library-msal"></a>Использование библиотеки проверки подлинности Майкрософт (MSAL)

[Библиотека проверки подлинности Microsoft (MSAL)](../develop/msal-overview.md) является ключевой частью [платформы Microsoft Identity](../develop/index.yml). Он упрощает и управляет получением, управлением, кэшированием и обновлением маркеров и использует рекомендации по устойчивости. MSAL предназначен для обеспечения безопасного решения без необходимости беспокоиться о реализации.

MSAL кэширует маркеры и использует шаблон получения необъявляемого токена. Он также автоматически сериализует кэш маркеров на платформах, которые изначально обеспечивают безопасное хранение, такое как Windows UWP, iOS и Android. Разработчики могут настроить поведение сериализации при использовании [Microsoft. Identity. Web](https://github.com/AzureAD/microsoft-identity-web/wiki/token-cache-serialization), [MSAL.NET](../develop/msal-net-token-cache-serialization.md), [MSAL для Java](../develop/msal-java-token-cache-serialization.md)и [MSAL для Python](../develop/msal-python-token-cache-serialization.md).

![Изображение устройства с и приложением, использующее MSAL для вызова Microsoft Identity](media/resilience-client-app/resilience-with-microsoft-authentication-library.png)

При использовании MSAL поддержка кэширования маркеров, обновления и автоматического приобретения поддерживается автоматически. Для получения маркеров, необходимых для современной проверки подлинности, можно использовать простые шаблоны. Поддерживается множество языков, и вы можете найти пример, соответствующий вашему языку и сценарию на странице [примеров](../develop/sample-v2-code.md) .

## <a name="c"></a>[C#](#tab/csharp)

```csharp
try
{
    result = await app.AcquireTokenSilent(scopes, account).ExecuteAsync();
}
catch(MsalUiRequiredException ex)
{
    result = await app.AcquireToken(scopes).WithClaims(ex.Claims).ExecuteAsync()
}
```

## <a name="javascript"></a>[Javascript](#tab/javascript)

```javascript
return myMSALObj.acquireTokenSilent(request).catch(error => {
    console.warn("silent token acquisition fails. acquiring token using redirect");
    if (error instanceof msal.InteractionRequiredAuthError) {
        // fallback to interaction when silent call fails
        return myMSALObj.acquireTokenPopup(request).then(tokenResponse => {
            console.log(tokenResponse);

            return tokenResponse;
        }).catch(error => {
            console.error(error);
        });
    } else {
        console.warn(error);
    }
});
```

---

MSAL может в некоторых случаях заранее обновлять маркеры. Когда Microsoft Identity выдает долгосрочный маркер, он может отправить клиенту сведения в течение оптимального времени для обновления маркера ("обновить \_ в"). MSAL будет заранее обновлять маркер на основе этих данных. Приложение продолжит работу, пока Старый токен является допустимым, но в течение длительного времени он будет продолжать получение маркера.

### <a name="stay-up-to-date"></a>Получайте актуальные новости

У разработчиков должен быть процесс обновления до последней версии MSAL. Проверка подлинности является частью безопасности приложений, и ваше приложение должно оставаться актуальным благодаря улучшениям безопасности, содержащимся в новых выпусках MSAL. Как правило, это рекомендуется для библиотек в непрерывной разработке. Это обеспечит актуальность кода в соответствии с устойчивостью приложения. По мере того как Microsoft Identity продолжит внедряться в целях повышения устойчивости приложений, приложения, использующие последнюю MSAL, будут самыми готовыми к созданию этих инноваций.

[Ознакомьтесь с последней версией MSAL.js и заметками о выпуске](https://github.com/AzureAD/microsoft-authentication-library-for-js/releases)

[Ознакомьтесь с последними версиями MSAL и заметками о выпуске .NET](https://github.com/AzureAD/microsoft-authentication-library-for-dotnet/releases)

[Ознакомьтесь с последней версией и заметками о выпуске MSAL Python](https://github.com/AzureAD/microsoft-authentication-library-for-python/releases)

[Ознакомьтесь с последними версиями и заметками о выпуске MSAL Java](https://github.com/AzureAD/microsoft-authentication-library-for-java/releases)

[Ознакомьтесь с последними версиями MSAL iOS и macOS и заметками о выпуске.](https://github.com/AzureAD/microsoft-authentication-library-for-objc/releases)

[Ознакомьтесь с последними версиями Android и заметками о выпуске MSAL](https://github.com/AzureAD/microsoft-authentication-library-for-android/releases)

[Проверьте последнюю версию MSAL и заметки о выпуске.](https://github.com/AzureAD/microsoft-authentication-library-for-js/releases)

[Ознакомьтесь с последней версией Microsoft. Identity. Web и заметками о выпуске.](https://github.com/AzureAD/microsoft-identity-web/releases)

## <a name="use-resilient-patterns-for-token-handling"></a>Использование устойчивых шаблонов для обработки маркеров

Если вы не используете MSAL, эти устойчивые шаблоны можно использовать для обработки маркеров. Эти рекомендации реализуются автоматически с помощью библиотеки MSAL. 

Как правило, приложение, использующее современную проверку подлинности, будет вызывать конечную точку для получения токенов, которые проверяют подлинность пользователя или разрешают приложению вызывать защищенные API. MSAL предназначен для обработки подробностей проверки подлинности и реализует несколько шаблонов для повышения устойчивости этого процесса. Используйте рекомендации в этом разделе, чтобы реализовать рекомендации, если вы решили использовать библиотеку, отличную от MSAL. Если вы используете MSAL, вы получаете все эти рекомендации бесплатно, так как MSAL реализует их автоматически.

### <a name="cache-tokens"></a>Токены кэша

Приложения должны должным образом кэшировать маркеры, полученные от Microsoft Identity. Когда приложение получает токены, HTTP-ответ, содержащий токены, также содержит свойство "expires_in", которое сообщает приложению, как долго кэшировать и повторно использовать маркер. Важно, чтобы приложения использовали свойство "expires_in" для определения срока существования маркера. Приложение не должно пытаться декодировать маркер доступа API.

![Приложение, выполняющее вызов Microsoft Identity, но вызов проходит через кэш маркеров на устройстве, на котором выполняется приложение.](media/resilience-client-app/token-cache.png)

Использование кэшированного маркера предотвращает ненужный трафик между приложением и удостоверением Майкрософт и делает приложение менее уязвимым для сбоев при получении маркера, уменьшая число вызовов получения маркера. Кэшированные токены также улучшают производительность приложения, так как приложение должно блокировать получение маркеров меньше. Пользователь может оставаться в вашем приложении в течение времени существования этого маркера.

### <a name="serialize-and-persist-tokens"></a>Сериализация и сохранение токенов

Приложения должны безопасно сериализовать свой кэш маркеров, чтобы сохранить маркеры между экземплярами приложения. Токены можно использовать повторно, если они находятся в пределах допустимого времени существования. [Маркеры обновления](../develop/v2-oauth2-auth-code-flow.md#refresh-the-access-token), и все больше, [маркеры доступа](../develop/access-tokens.md)выдаются в течение нескольких часов. Это допустимое время может полагаться на пользователя, запускающий приложение много раз. При запуске приложения необходимо проверить наличие допустимого маркера доступа или обновления, который можно использовать. Это повысит устойчивость и производительность приложения, так как позволяет избежать ненужных вызовов Microsoft Identity.

![Приложение, выполняющее вызов Microsoft Identity, но вызов проходит через кэш маркеров, а также хранилище токенов на устройстве, на котором выполняется приложение.](media/resilience-client-app/token-store.png)

Хранилище постоянного токена должно быть контролируемым и зашифрованным для пользователя-владельца или удостоверения процесса. На платформах, таких как Mobile, Windows и Mac, разработчик должен воспользоваться встроенными возможностями для хранения учетных данных.

### <a name="acquire-tokens-silently"></a>Получать токены автоматически

Процесс проверки подлинности пользователя или получения авторизации для вызова API может потребовать несколько шагов в Microsoft Identity. Например, при первом входе пользователя в систему может потребоваться ввести учетные данные и выполнить многофакторную проверку подлинности через текстовое сообщение. Каждый шаг добавляет зависимость от ресурса, предоставляющего эту службу. Наилучшим способом для пользователя и с наименьшими зависимостями является попытка получить маркер без вмешательства пользователя, чтобы избежать этих дополнительных действий перед запросом взаимодействия с пользователем.

![Схема, показывающая различные службы в удостоверении Майкрософт, которые могут потребоваться для завершения процесса проверки подлинности или авторизации пользователя.](media/resilience-client-app/external-dependencies.png)

Автоматическое получение маркера начинается с использования допустимого маркера из кэша маркеров приложения. Если действительный маркер недоступен, приложение должно попытаться получить маркер с помощью маркера обновления, если он доступен, и конечной точки токена. Если ни один из этих параметров недоступен, приложение должно получить маркер, используя параметр "prompt = None". При этом будет использоваться конечная точка авторизации, но пользователь не отобразит пользовательский интерфейс. Если идентификатор Майкрософт может предоставить приложению маркер, не взаимодействуя с пользователем, он будет иметь значение. Если ни один из этих методов не приводит к созданию маркера, пользователю потребуется выполнить повторную проверку подлинности в интерактивном режиме.

> [!NOTE]
> Как правило, приложения должны избегать запросов, таких как "Login" и "согласие", так как они приводят к принудительному взаимодействию с пользователем, даже если взаимодействие не требуется.

## <a name="handle-service-responses-properly"></a>Правильная обработка ответов службы

Хотя приложения должны поддерживать все ответы на ошибки, существуют ответы, которые могут повлиять на устойчивость. Если приложение получает код ответа HTTP 429, а также слишком много запросов, Microsoft Identity выполняет регулирование запросов. Если приложение продолжает создавать слишком много запросов, оно будет по прежнему регулироваться, предотвращая получение маркеров приложением. Приложение не должно попытаться получить маркер еще раз, пока не пройдет время в секундах в поле ответа Retry-After. Получение ответа 429 часто свидетельствует о том, что приложение не кэширует и повторно использует токены правильно. Разработчики должны проанализировать кэширование и повторное использование маркеров в приложении.

Когда приложение получает код ответа HTTP 5xx, приложение не должно входить в цикл быстрого повтора. При наличии приложение должно учитывать ту же обработку Retry-After, что и для ответа 429. Если в ответе не указан заголовок Retry-After, мы рекомендуем реализовать экспоненциальную повторную попытку с первой повторной попыткой по крайней мере через 5 секунд после ответа.

Если время ожидания запроса истекло, повторная попытка выполнения приложения невозможна. Реализовать экспоненциальную повторную попытку с первой повторной попыткой по крайней мере через 5 секунд после ответа.

## <a name="evaluate-options-for-retrieving-authorization-related-information"></a>Вычисление параметров для получения сведений, связанных с авторизацией

Многим приложениям и API-интерфейсам требуются определенные сведения о пользователе для принятия решений об авторизации. Существует несколько способов получения этих сведений приложением. У каждого метода есть свои преимущества и недостатки. Разработчики должны взвесить их, чтобы определить, какая стратегия лучше всего подходит для обеспечения устойчивости в своем приложении.

### <a name="tokens"></a>Токены

Токены идентификаторов и маркеры доступа содержат стандартные утверждения, предоставляющие сведения о субъекте. Они описаны в [статье маркеры идентификации платформы Microsoft Identity](../develop/id-tokens.md) и [маркеры доступа платформы удостоверений Майкрософт](../develop/access-tokens.md). Если сведения, необходимые приложению, уже находятся в маркере, наиболее эффективным способом получения этих данных является использование заявок на маркеры, так как это позволит сохранить перегрузку дополнительного сетевого вызова для получения сведений отдельно. Меньшее число сетевых вызовов означает более высокую общую устойчивость для приложения.

> [!NOTE]
> Некоторые приложения вызывают конечную точку UserInfo для получения утверждений о пользователе, который прошел проверку подлинности. Сведения, доступные в маркере идентификации, который может получить приложение, — это надмножество информации, которую он может получить из конечной точки UserInfo. Приложение должно использовать маркер идентификации для получения сведений о пользователе вместо вызова конечной точки UserInfo.

Разработчик приложения может расширять утверждения стандартных маркеров с [дополнительными утверждениями](../develop/active-directory-optional-claims.md). Одним из распространенных необязательных утверждений являются [группы](../develop/active-directory-optional-claims.md#configuring-groups-optional-claims). Существует несколько способов добавления групповых утверждений. Параметр "Группа приложений" включает только группы, назначенные приложению. Параметры "все" или "группы безопасности" включают группы из всех приложений в одном клиенте, которые могут добавлять в маркер несколько групп. Важно оценить воздействие на ваш случай, так как оно потенциально может негативно отразить эффективность, полученную путем запроса групп в маркере, вызывая чрезмерное увеличение размера маркера и даже требовать дополнительных вызовов для получения полного списка групп.

Вместо использования групп в токене можно использовать и включить роли приложения. Разработчики могут определить [роли приложений](../develop/howto-add-app-roles-in-azure-ad-apps.md) для своих приложений и интерфейсов API, которыми клиент может управлять из своего каталога с помощью портала или API. Затем ИТ-специалисты могут назначать роли различным пользователям и группам для управления доступом к содержимому и функциональным возможностям. При выдаче маркера для приложения или API роли, назначенные пользователю, будут доступны в утверждении Roles в токене. Получение этих сведений непосредственно в токене может привести к сохранению дополнительных вызовов API.

Наконец, ИТ-администраторы могут также добавлять заявки на основе определенной информации в клиенте. Например, предприятие может иметь расширение, чтобы иметь идентификатор конкретного пользователя.

Во всех случаях Добавление сведений из каталога непосредственно в маркер может быть эффективным и повысить устойчивость приложений, уменьшая число зависимостей, которые имеет приложение. С другой стороны, не удается получить маркер из-за проблем с устойчивостью. Добавлять необязательные утверждения следует только для основных сценариев приложения. Если приложению требуются сведения только для административных функций, то приложение должно получить эти сведения только по мере необходимости.

### <a name="microsoft-graph"></a>Microsoft Graph

Microsoft Graph предоставляет единую конечную точку API для доступа к данным Microsoft 365, которые описывают закономерности производительности, идентификации и безопасности в Организации. Приложения, использующие Microsoft Graph, потенциально могут использовать любую информацию в Microsoft 365 для принятия решений об авторизации.

Приложениям требуется только один маркер для доступа ко всем Microsoft 365. Это более устойчиво, чем использование более старых API, характерных для Microsoft 365 компонентов, таких как Microsoft Exchange или Microsoft SharePoint, для которых требуются несколько маркеров.

При использовании Microsoft Graph API мы рекомендуем использовать [пакет SDK для Microsoft Graph](/graph/sdks/sdks-overview). Microsoft Graph пакеты SDK предназначены для упрощения создания высококачественных, эффективных и устойчивых приложений, обращающихся к Microsoft Graph.

Для принятия решений об авторизации разработчики должны учитывать, когда следует использовать утверждения, доступные в маркере, в качестве альтернативы некоторым Microsoft Graphным вызовам. Как упоминалось выше, разработчики могут запрашивать группы, роли приложений и необязательные утверждения в своих маркерах. В плане устойчивости при использовании Microsoft Graph для авторизации требуются дополнительные сетевые вызовы, использующие удостоверение Майкрософт (чтобы получить маркер для доступа к Microsoft Graph), а также Microsoft Graph сам. Однако если приложение уже использует Microsoft Graph в качестве уровня данных, полагаться на диаграмму для авторизации не является дополнительным риском.

## <a name="use-broker-authentication-on-mobile-devices"></a>Использовать проверку подлинности брокера на мобильных устройствах

На мобильных устройствах использование брокера проверки подлинности, например Microsoft Authenticator, повысит устойчивость. Компонент Service Broker добавляет преимущества, предоставляемые другими параметрами, такими как системный браузер или внедренный WebView. Брокер проверки подлинности может использовать [основной маркер обновления](../devices/concept-primary-refresh-token.md) (PRT), который содержит утверждения о пользователе и устройстве и может использоваться для получения маркеров проверки подлинности для доступа к другим приложениям с устройства. Когда PRT используется для запроса доступа к приложению, его устройства и утверждения MFA являются доверенными для Azure AD. Это повышает устойчивость, избегая дополнительных действий для повторной проверки подлинности устройства. Пользователи не будут испытывать проблемы с несколькими запросами MFA на одном устройстве, что повышает устойчивость, уменьшая зависимости от внешних служб и улучшая взаимодействие с пользователем.

![Приложение, выполняющее вызов Microsoft Identity, но вызов проходит через кэш маркеров, а также хранилище токенов и брокер проверки подлинности на устройстве, на котором выполняется приложение.](media/resilience-client-app/authentication-broker.png)

Проверка подлинности компонента Service Broker автоматически поддерживается MSAL. Дополнительные сведения об использовании аутентификации через посредника см. на следующих страницах:

- [Настройка единого входа для macOS и iOS](../develop/single-sign-on-macos-ios.md#sso-through-authentication-broker-on-ios)
- [Как включить единый вход между приложениями в Android с помощью MSAL](../develop/msal-android-single-sign-on.md)

## <a name="adopt-continuous-access-evaluation"></a>Внедрять непрерывный доступ к оценке

[Оценка непрерывного доступа (автоматизированного конструирования)](../conditional-access/concept-continuous-access-evaluation.md) — это недавняя разработка, которая может повысить безопасность и устойчивость приложений с долгосрочными маркерами. АВТОМАТИЗИРОВАННОГО конструирования — это развивающийся промышленный стандарт, разработанный в Рабочей группе OpenID Connect Foundation "Общие сигналы и события". С помощью автоматизированного конструирования маркер доступа можно отозвать на основе [критических событий](../conditional-access/concept-continuous-access-evaluation.md#critical-event-evaluation) и [оценки политики](../conditional-access/concept-continuous-access-evaluation.md#conditional-access-policy-evaluation-preview), а не полагаться на короткое время существования маркера. Для некоторых API-интерфейсов ресурсов, поскольку риск и политика оцениваются в режиме реального времени, автоматизированного конструирования может значительно увеличить время существования маркера до 28 часов. Так как API-интерфейсы ресурсов и приложения принимают автоматизированного конструирования, Microsoft Identity сможет выдавать маркеры доступа, отзывать и допустимые в течение продолжительного периода времени. Эти долгосрочные токены будут заблаговременно обновляться с помощью MSAL.

Хотя автоматизированного конструирования находится на ранних стадиях, можно [разрабатывать клиентские приложения уже сегодня, что выгодно для автоматизированного конструирования,](../develop/app-resilience-continuous-access-evaluation.md) когда ресурсы (API), используемые приложением, используют автоматизированного конструирования. Так как больше ресурсов применяет автоматизированного конструирования, приложение сможет получать маркеры с поддержкой автоматизированного конструирования для этих ресурсов. Microsoft Graph API и [Microsoft Graph пакеты SDK](/graph/sdks/sdks-overview)будут предварительно просматривать возможности автоматизированного конструирования на раннем этапе 2021. Если вы хотите участвовать в общедоступной предварительной версии Microsoft Graph с автоматизированного конструирования, вы можете сообщить нам о том, что вы заинтересованы: [https://aka.ms/GraphCAEPreview](https://aka.ms/GraphCAEPreview) .

При разработке API ресурсов мы рекомендуем принять участие в [общих сигналах и событиях WG](https://openid.net/wg/sse/). Мы работаем над этой группой, чтобы обеспечить общий доступ к событиям безопасности между поставщиками удостоверений и ресурсов Майкрософт.

## <a name="next-steps"></a>Дальнейшие действия

- [Использование интерфейсов API с поддержкой оценки непрерывного доступа в приложениях](../develop/app-resilience-continuous-access-evaluation.md)
- [Отказоустойчивость сборок в управляющих приложениях](resilience-daemon-app.md)
- [Отказоустойчивость сборок в инфраструктуре управления удостоверениями и доступом](resilience-in-infrastructure.md)
- [Устойчивость сборок в CIAM Systems](resilience-b2c.md)
