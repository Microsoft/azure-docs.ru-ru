---
title: Обеспечение устойчивости с помощью рекомендаций для разработчиков, использующих Azure AD B2C | Документация Майкрософт
description: Обеспечение устойчивости с помощью рекомендаций для разработчиков по управлению удостоверениями и доступом клиентов с помощью Azure AD B2C
services: active-directory
ms.service: active-directory
ms.subservice: fundamentals
ms.workload: identity
ms.topic: how-to
author: gargi-sinha
ms.author: gasinh
manager: martinco
ms.reviewer: ''
ms.date: 11/30/2020
ms.custom: it-pro
ms.collection: M365-identity-device-management
ms.openlocfilehash: ff7505e7c47b93f32efd9de60463873026247329
ms.sourcegitcommit: 78ecfbc831405e8d0f932c9aafcdf59589f81978
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/23/2021
ms.locfileid: "98724931"
---
# <a name="resilience-through-developer-best-practices"></a>Обеспечение устойчивости с помощью рекомендаций для разработчиков

В этой статье мы будем использовать некоторые знания, основанные на наших впечатлениях от работы с большими клиентами. Эти рекомендации можно рассматривать в проектировании и реализации служб.

![На рисунке показаны компоненты для разработчиков](media/resilience-b2c-developer-best-practices/developer-best-practices-architecture.png)

## <a name="use-the-microsoft-authentication-library-msal"></a>Использование библиотеки проверки подлинности Майкрософт (MSAL)

[Библиотека проверки подлинности Майкрософт (MSAL)](../develop/msal-overview.md) и [Библиотека веб-аутентификации microsoft Identity для ASP.NET](../develop/reference-v2-libraries.md) упрощают получение, управление, кэширование и обновление маркеров, которые требуются приложению. Эти библиотеки оптимизированы специально для поддержки идентификации Майкрософт, включая функции, повышающие устойчивость приложений.

Разработчики должны внедрять последние выпуски MSAL и оставаться в курсе последних обновлений. Узнайте, [как повысить устойчивость проверки подлинности и авторизации](resilience-app-development-overview.md) в приложениях. Там, где это возможно, Избегайте реализации собственного стека проверки подлинности и используйте хорошо установленные библиотеки.

## <a name="optimize-directory-reads-and-writes"></a>Оптимизация операций чтения и записи в каталог

Служба каталогов Microsoft Azure AD B2C поддерживает миллиарды проверок подлинности в день. Он рассчитан на высокую скорость чтения в секунду. Оптимизируйте операции записи, чтобы уменьшить зависимости и повысить устойчивость.

### <a name="how-to-optimize-directory-reads-and-writes"></a>Оптимизация операций чтения и записи в каталоге

- **Избегайте функций записи в каталог при входе**: никогда не выполняйте запись при входе без предварительного условия (if) в пользовательских политиках. Один вариант использования, требующий записи на вход, — это [JIT-миграция паролей пользователей](https://github.com/azure-ad-b2c/user-migration/tree/master/seamless-account-migration). Избегайте сценариев, требующих записи при каждом входе в систему.

  - [Предварительные условия](../../active-directory-b2c/userjourneys.md) в пути взаимодействия пользователя будут выглядеть следующим образом:

  ``
  <Precondition Type="ClaimEquals" ExecuteActionsIf="true"> 
  <Value>requiresMigration</Value>
  ...
  < Precondition/>
  ``
  - Создавайте сопротивление для [входа с помощью Bot, интегрируя систему с CAPTCHA](https://github.com/azure-ad-b2c/samples/tree/master/policies/captcha-integration).

  - Используйте [Пример нагрузочного тестирования](../../active-directory-b2c/best-practices.md#testing) для имитации регистрации и входа в систему. 

- **Общие сведения о регулировании**. в каталоге реализованы правила регулирования уровня приложения и клиента. Существуют другие ограничения скорости операций чтения, получения, записи, обновления, вставки и удаления, а для каждой операции действуют разные ограничения.

  - Запись на момент входа в систему будет попадать под учет новых пользователей или помещать их для существующих пользователей.

  - Пользовательская политика, которая создает или обновляет пользователя при каждом входе в систему, может повлиять на размещение уровня приложения или предельную скорость передачи. Те же ограничения применяются при обновлении объектов каталога с помощью Azure AD или Microsoft Graph. Аналогичным образом изучите операции чтения, чтобы свести к минимуму количество операций чтения при каждом входе.

  - Оцените пиковую нагрузку, чтобы спрогнозировать частоту операций записи в каталог и избежать регулирования. Оценка пикового трафика должна включать оценки для таких действий, как регистрация, вход и многофакторная идентификация (MFA). Обязательно протестируйте как систему Azure AD B2C, так и ваше приложение для пикового трафика. Возможно, Azure AD B2C может справиться с нагрузкой без регулирования, когда ваши нижестоящие приложения или службы не будут работать.

  - Изучение и планирование временной шкалы миграции. При планировании миграции пользователей на Azure AD B2C с помощью Microsoft Graph учитывайте ограничения приложений и клиентов на вычисление времени, необходимого для завершения миграции пользователей. Если вы разбиваете задание создания пользователя или сценарий с помощью двух приложений, можно использовать ограничение для каждого приложения. Он по-прежнему должен оставаться ниже порогового значения для каждого клиента.

  - Изучите влияние задания миграции на другие приложения. Рассмотрим динамический трафик, обслуживаемый другими проверяющими приложениями, чтобы вы не вызывали регулирования на уровне клиента и нехватке ресурсов для вашего активного приложения. Дополнительные сведения см. в [руководстве по регулированию Microsoft Graph](/graph/throttling).
  
## <a name="extend-token-lifetimes"></a>Продлить время существования токенов

В маловероятном случае, когда службе проверки подлинности Azure AD B2C не удается завершить новые входы и входы в систему, вы по-прежнему можете обеспечить устранение рисков для пользователей, выполнивших вход. С помощью [конфигурации](../../active-directory-b2c/configure-tokens.md)можно разрешить пользователям, которые уже вошли в систему, продолжать использовать приложение без какого-либо воспринимаемого прерывания, пока пользователь не выйдет из приложения или не истечет время ожидания [сеанса](../../active-directory-b2c/session-behavior.md) вследствие неактивности.

Ваши бизнес-требования и удобство работы конечного пользователя зависят от частоты обновления маркеров как для веб-приложений, так и для одностраничного приложения (одностраничные приложения).

### <a name="how-to-extend-token-lifetimes"></a>Расширение времени существования токенов

- **Веб-приложения**. для веб-приложений, где маркер проверки подлинности проверяется в начале входа, приложение зависит от файла cookie сеанса, чтобы продолжить продление срока действия сеанса.

  - Разрешить пользователям оставаться в системе, реализовав время сеанса, которое будет продолжать обновлять сеансы на основе активности пользователей. Если возникает долгосрочный отказ в выдаче маркера, эти времена сеанса можно дополнительно увеличить как конфигурацию OneTime в приложении. Обеспечьте время существования сеанса до максимально допустимого значения.

- **Одностраничные приложения**: Spa может зависеть от маркеров доступа для выполнения вызовов к API. SPA традиционно использует неявный поток, который не приводит к созданию маркера обновления. SPA может использовать скрытый IFRAME для выполнения новых запросов маркера к конечной точке авторизации, если в обозревателе по-прежнему имеется активный сеанс с Azure AD B2C. Для одностраничные приложения доступно несколько вариантов, позволяющих пользователю продолжать использовать приложение.

  - Продлите срок действия маркера доступа в соответствии с бизнес-требованиями.

  - Создайте приложение для использования шлюза API в качестве прокси-сервера проверки подлинности. В этой конфигурации SPA загружается без проверки подлинности, а вызовы API выполняются в шлюзе API. Шлюз API отправляет пользователя через процесс входа с помощью [предоставления кода авторизации](https://oauth.net/2/grant-types/authorization-code/) на основе политики и выполняет проверку подлинности пользователя. Впоследствии сеанс проверки подлинности между шлюзом API и клиентом сохраняется с помощью файла cookie проверки подлинности. API-интерфейсы обслуживаются из шлюза API с помощью маркера, полученного шлюзом API, или другого метода прямой проверки подлинности, такого как сертификаты, учетные данные клиента или ключи API.

  - [Перенос Spa из неявного предоставления](https://developer.microsoft.com/identity/blogs/msal-js-2-0-supports-authorization-code-flow-is-now-generally-available/) в [поток предоставления кода авторизации](../../active-directory-b2c/implicit-flow-single-page-application.md) с помощью ключа проверки подлинности для обмена кодом (PKCE) и поддержки общего доступа к ресурсам в разных источниках (CORS). Перенесите приложение из MSAL.js 1. x в MSAL.js 2. x, чтобы реализовать устойчивость веб-приложений.

  - Для мобильных приложений рекомендуется продлить время существования маркера обновления и доступа.

- **Приложения серверной части или микрослужбы**. так как внутренние приложения (управляющие программы) не являются интерактивными и не находятся в контексте пользователя, потенциальный риск кражи маркеров значительно уменьшается. Рекомендация заключается в обеспечении баланса между безопасностью и временем существования и установления длительного времени существования маркера.

## <a name="configure-single-sign-on"></a>Настройка единого входа

С [единым входом (SSO)](../manage-apps/what-is-single-sign-on.md)пользователи могут войти один раз с одной учетной записью и получить доступ к нескольким приложениям. Приложение может быть веб-приложением, мобильным или одностраничным (SPA), независимо от платформы или имени домена. Когда пользователь изначально входит в приложение, Azure AD B2C сохраняет [сеанс на основе файла cookie](../../active-directory-b2c/session-behavior.md).

При последующих запросах проверки подлинности Azure AD B2C считывает и проверяет сеанс на основе файлов cookie и выдает маркер доступа без запроса пользователя на вход. Если для единого входа настроена ограниченная область действия в политике или приложении, для последующего доступа к другим политикам и приложениям потребуется новая проверка подлинности.

### <a name="how-to-configure-sso"></a>Настройка единого входа

[Настройте единый вход](../hybrid/how-to-connect-sso-quick-start.md) на уровне клиента (по умолчанию), чтобы разрешить нескольким приложениям и потокам пользователей в клиенте совместно использовать один сеанс пользователя. Конфигурация на уровне клиента обеспечивает наиболее устойчивость к новой проверке подлинности.  

## <a name="safe-deployment-practices"></a>Методики безопасного развертывания

Наиболее распространенными сбоями службы являются изменение кода и конфигурации. Внедрение процессов и средств непрерывной интеграции и непрерывной поставки (CICD) обеспечивает быстрое развертывание в крупном масштабе и сокращает количество ошибок, возникающих при тестировании и развертывании в рабочей среде. Внедрять CICD для уменьшения ошибок, эффективности и согласованности. [Azure pipelines](/azure/devops/pipelines/apps/cd/azure/cicd-data-overview) является примером CICD.

## <a name="web-application-firewall"></a>Брандмауэр веб-приложения

Защитите свои приложения от известных уязвимостей, таких как атаки типа "отказ в обслуживании" (от атак DDoS), внедрение SQL, межсайтовые сценарии, удаленное выполнение кода и многие другие, как описано в [OWASP Top 10](https://owasp.org/www-project-top-ten/). Развертывание брандмауэра веб-приложения (WAF) может защитить от распространенных эксплойтов и уязвимостей.

- Используйте Azure [WAF](../../web-application-firewall/overview.md), которая обеспечивает централизованную защиту от атак.

- Используйте WAF с [защитой идентификации Azure AD и условным доступом для обеспечения защиты нескольких слоев](../../active-directory-b2c/conditional-access-identity-protection-overview.md) при использовании Azure AD B2C.  

## <a name="secrets-rotation"></a>Смена секретов

Azure AD B2C использует секреты для приложений, API, политик и шифрования. Секреты безопасной проверки подлинности, внешних взаимодействий и хранилища. Национальный институт стандартов и технологий (NIST) вызывает период времени, в течение которого конкретный ключ авторизован для использования законными сущностями криптопериода. Выберите правильную длину [криптопериода](https://csrc.nist.gov/publications/detail/sp/800-57-part-1/rev-5/final) в соответствии с потребностями бизнеса. Разработчикам необходимо вручную задать срок действия и снова сменить секреты.

### <a name="how-to-implement-secret-rotation"></a>Реализация смены секрета

- Используйте [управляемые удостоверения](../managed-identities-azure-resources/overview.md) для поддерживаемых ресурсов, чтобы пройти проверку подлинности в любой службе, поддерживающей проверку подлинности Azure AD. При использовании управляемых удостоверений можно управлять ресурсами автоматически, в том числе с помощью смены учетных данных.

- Выполните инвентаризацию всех [ключей и сертификатов, настроенных](../../active-directory-b2c/policy-keys-overview.md) в Azure AD B2C. Этот список, скорее всего, включает ключи, используемые в пользовательских политиках, [API](../../active-directory-b2c/secure-rest-api.md), маркере идентификатора подписи и сертификатах для SAML.

- С помощью CICD переворачивайте секреты, срок действия которых скоро истечет в течение двух месяцев с ожидаемого пикового сезона. Рекомендуемый максимум криптопериода закрытых ключей, связанных с сертификатом, — один год.

- Заблаговременно отслеживайте и вращайте учетные данные доступа API, такие как пароли и сертификаты.

## <a name="test-rest-apis"></a>API-интерфейсы других тестов

В контексте устойчивости тестирование API-интерфейсов RESTFUL должно включать проверку кодов HTTP, полезных данных ответа, заголовков и производительности. Тестирование не должно включать только удачные тесты пути, но также проверять, правильно ли API обрабатывает проблемы.

### <a name="how-to-test-apis"></a>Тестирование интерфейсов API

Рекомендуется включить в план тестирования [комплексные тесты API](../../active-directory-b2c/best-practices.md#testing). При планировании предстоящего всплеска нагрузки из-за исходящего или праздничного трафика необходимо пересмотреть нагрузочное тестирование с помощью новых оценок. Проведите нагрузочное тестирование интерфейсов API и сети доставки содержимого (CDN) в среде разработки, а не в производстве.

## <a name="next-steps"></a>Следующие шаги

- [Ресурсы устойчивости для разработчиков Azure AD B2C](resilience-b2c.md)
  - [Устойчивая работа конечного пользователя](resilient-end-user-experience.md)
  - [Устойчивые интерфейсы с внешними процессами](resilient-external-processes.md)
  - [Устойчивость с помощью мониторинга и аналитики](resilience-with-monitoring-alerting.md)
- [Устойчивость к сборке в инфраструктуре проверки подлинности](resilience-in-infrastructure.md)
- [Повышение устойчивости проверки подлинности и авторизации в приложениях](resilience-app-development-overview.md)