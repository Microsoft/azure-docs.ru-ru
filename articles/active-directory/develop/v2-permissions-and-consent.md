---
title: Области платформы Microsoft Identity, разрешения, & согласие
description: Сведения об авторизации в конечной точке платформы идентификации Майкрософт, включая области, разрешения и согласие.
services: active-directory
author: rwike77
manager: CelesteDG
ms.service: active-directory
ms.subservice: develop
ms.workload: identity
ms.topic: conceptual
ms.date: 09/23/2020
ms.author: ryanwi
ms.reviewer: hirsin, jesakowi, jmprieur, marsma
ms.custom: aaddev, fasttrack-edit, contperf-fy21q1, identityplatformtop40
ms.openlocfilehash: 570314bcaedb86cc593846ffc1d6846d1d2fe335
ms.sourcegitcommit: b4e6b2627842a1183fce78bce6c6c7e088d6157b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/30/2021
ms.locfileid: "99090193"
---
# <a name="permissions-and-consent-in-the-microsoft-identity-platform"></a>Разрешения и согласие для платформы удостоверений Майкрософт

Приложения, которые интегрируются с платформой удостоверений Майкрософт, следуют модели авторизации, при которой пользователи и администраторы контролируют доступ к данным. Реализация модели авторизации была обновлена на платформе Microsoft Identity. Он изменяет, как приложение должно взаимодействовать с платформой Microsoft Identity. В этой статье рассматриваются основные понятия этой модели авторизации, включая области, разрешения и согласие на их предоставление.

## <a name="scopes-and-permissions"></a>Области и разрешения

Платформа удостоверений Майкрософт реализует протокол авторизации [OAuth 2.0](active-directory-v2-protocols.md). OAuth 2.0 — это метод, посредством которого стороннее приложение может обращаться к интернет-ресурсам от имени пользователя. Любой ресурс, размещенный в Интернете, который интегрируется с платформой Microsoft Identity, имеет идентификатор ресурса или *URI идентификатора приложения*. 

Ниже приведены некоторые примеры ресурсов, размещенных в Интернете.

* Microsoft Graph: `https://graph.microsoft.com`
* API Microsoft 365 mail: `https://outlook.office.com`
* Azure Key Vault: `https://vault.azure.net`

То же касается любых сторонних ресурсов, интегрированных с платформой удостоверений Майкрософт. Любой из этих ресурсов может также определять набор разрешений, с помощью которых можно разделить функции ресурса на меньшие блоки. Например, в [Microsoft Graph](https://graph.microsoft.com) определены разрешения для выполнения таких задач, как:

* чтение календаря пользователя;
* запись в календарь пользователя;
* отправка сообщений в качестве пользователя.

Из-за этих типов определений разрешений ресурс имеет детализированный контроль над данными и как предоставляются функциональные возможности API. Стороннее приложение может запрашивать эти разрешения у пользователей и администраторов. Они должны подтвердить такой запрос, прежде чем приложение получит доступ к данным или начнет действовать от имени пользователя. 

Когда функциональные возможности ресурса поделяются на небольшие наборы разрешений, сторонние приложения могут быть созданы для запроса только тех разрешений, которые необходимы для выполнения их функций. Пользователи и администраторы могут узнать, к каким данным может получить доступ приложение. И они могут быть уверены в том, что приложение не работает с вредоносными намерениями. Разработчики всегда должны соблюдать принцип наименьших привилегий, запрашивая только те разрешения, которые необходимы им для работы своих приложений.

В OAuth 2,0 эти типы наборов разрешений называются *областями*. Они также часто называются *разрешениями*. В платформе Microsoft Identity, разрешение представлено в виде строкового значения. Для Microsoft Graph примере ниже приведено строковое значение для каждого разрешения:

* чтение календаря пользователя с помощью `Calendars.Read`;
* запись в календарь пользователя с помощью `Calendars.ReadWrite`;
* отправка сообщений в качестве пользователя с помощью `Mail.Send`.

Приложение чаще всего запрашивает эти разрешения, указывая области в запросах авторизации платформы Microsoft Identity. Однако некоторые разрешения с высоким уровнем прав могут предоставляться только через согласие администратора. Их можно запросить или предоставить с помощью [конечной точки предоставления согласия администратора](#admin-restricted-permissions). Продолжите чтение, чтобы узнать больше.

## <a name="permission-types"></a>Типы разрешений

Платформа Microsoft Identity поддерживает два типа разрешений: *делегированные разрешения* и *разрешения приложения*.

* **Делегированные разрешения** используются приложениями с авторизованным пользователем. Для этих приложений либо пользователь, либо администратор предоставил разрешения, запрашиваемые приложением. Приложение является делегированным разрешением на выполнение в качестве пользователя, выполнившего вход, при обращении к целевому ресурсу. 

    Некоторые делегированные разрешения могут быть предоставлены неадминистраторами. Но для некоторых разрешений с высоким уровнем привилегий требуется [согласие администратора](#admin-restricted-permissions). Чтобы узнать, какие роли администратора могут дать согласие на делегированные разрешения, ознакомьтесь с [разрешениями роли администратора в Azure Active Directory (Azure AD)](../roles/permissions-reference.md).

* **Разрешения приложения** используются приложениями, которые выполняются без вошедших в систему пользователей, например приложений, выполняющихся как фоновые службы или управляющие программы. Только [Администратор может дать согласие на](#requesting-consent-for-an-entire-tenant) разрешения приложения.

_Действующие разрешения_ — это разрешения, которые имеет приложение при выполнении запросов к целевому ресурсу. Важно понимать разницу между делегированными разрешениями и разрешениями приложений, предоставляемыми приложением, и действующими разрешениями, предоставляемыми приложением при вызовах целевого ресурса.

- Для делегированных разрешений _действующие разрешения_ приложения являются пересечением делегированных разрешений, предоставленных приложением (по согласию), и привилегий текущего пользователя, выполнившего вход. Приложения не могут иметь больше привилегий, чем авторизованный пользователь. 

   В организациях привилегии пользователя, выполнившего вход, могут определяться политикой или членством в одной или нескольких ролях администратора. Сведения о том, администраторы каких ролей могут предоставлять делегированные разрешения, см. в статье [Разрешения роли администратора в Azure Active Directory](../roles/permissions-reference.md).

   Например, предположим, что вашему приложению предоставлено делегированное разрешение _User.ReadWrite.All_. Это разрешение номинально предоставляет вашему приложению разрешение читать и обновлять профиль каждого пользователя в организации. Если пользователь, выполнивший вход, является глобальным администратором, приложение может обновить профиль каждого пользователя в Организации. Однако если у пользователя, выполнившего вход, нет роли администратора, приложение может обновить только профиль пользователя, выполнившего вход. Он не может обновить профили других пользователей в Организации, так как пользователь, имеющий разрешение на действия от имени, не имеет таких привилегий.

- Для разрешений приложений _действующие разрешения_ приложения — это полный уровень привилегий, подразумеваемых разрешением. Например, приложение, имеющее разрешение _User.ReadWrite.All_, может обновлять профиль каждого пользователя в организации.

## <a name="openid-connect-scopes"></a>Области OpenId Connect

Реализация OpenID Connect Connect платформы Microsoft Identity имеет несколько четко определенных областей, которые также размещаются на Microsoft Graph: `openid` , `email` , `profile` и `offline_access` . `address`Области и `phone` OpenID Connect Connect не поддерживаются.

Если вы запрашиваете области OpenID Connect Connect и маркер, вы получите маркер для вызова [конечной точки UserInfo](userinfo.md).

### <a name="openid"></a>OpenId

Если приложение входит в систему с помощью [OpenID Connect Connect](active-directory-v2-protocols.md), оно должно запросить `openid` область. `openid`Область отображается на странице согласия рабочей учетной записи в качестве **входного** разрешения. На странице согласия личного учетная запись Майкрософт он отображается как **Просмотр профиля и подключение к приложениям и службам с помощью разрешения учетная запись Майкрософт** . 

С помощью этого разрешения приложение может получить уникальный идентификатор для пользователя в виде `sub` утверждения. Разрешение также предоставляет приложению доступ к конечной точке UserInfo. `openid`Область можно использовать в конечной точке токена платформы Microsoft Identity для получения маркеров идентификации. Приложение может использовать эти маркеры для проверки подлинности.

### <a name="email"></a>email

`email`Область может использоваться с `openid` областью действия и с другими областями. Она предоставляет приложению доступ к основному электронному адресу пользователя в виде утверждения `email`. 

`email`Утверждение включается в маркер, только если адрес электронной почты связан с учетной записью пользователя, но это не всегда так. Если приложение использует `email` область, приложение должно иметь возможность обрабатывать случай, в котором `email` утверждение в токене отсутствует.

### <a name="profile"></a>профиль

`profile`Область может использоваться с `openid` областью и любой другой областью. Он предоставляет приложению доступ к большому количеству сведений о пользователе. Информация, к которой он имеет доступ, включает, но не ограничивается именем пользователя, фамилией, предпочитаемым именем пользователя и ИДЕНТИФИКАТОРом объекта. 

Полный список `profile` утверждений, доступных в `id_tokens` параметре для конкретного пользователя, см. в [ `id_tokens` справочнике](id-tokens.md).

### <a name="offline_access"></a>offline_access

Эта [ `offline_access` область](https://openid.net/specs/openid-connect-core-1_0.html#OfflineAccess) предоставляет приложению доступ к ресурсам от имени пользователя в течение длительного времени. На странице согласия эта область отображается так же, как и **доступ к данным, которым вы получили доступ** к этому разрешению. 

Когда пользователь утверждает `offline_access` область, приложение может получить токены обновления из конечной точки маркера платформы идентификации Майкрософт. Маркеры обновления имеют большой срок действия. Приложение может получать новые маркеры доступа после того, как срок действия старых истечет.

> [!NOTE]
> В настоящее время это разрешение отображается на всех страницах согласия, даже для потоков, не предоставляющих маркер обновления (например, [неявный поток](v2-oauth2-implicit-grant-flow.md)). Эта установка предназначена для сценариев, в которых клиент может начать работу в неявном потоке, а затем перейти к потоку кода, в котором ожидается маркер обновления.

На платформе Microsoft Identity (запросы к конечной точке версии 2.0) приложение должно явно запросить `offline_access` область для получения маркеров обновления. Поэтому при активации кода авторизации в [потоке кода авторизации OAuth 2,0](active-directory-v2-protocols.md)вы получаете только маркер доступа из `/token` конечной точки. 

Маркер доступа действителен недолго. Обычно срок действия истекает через один час. В этот момент приложению будет необходимо перенаправить пользователя обратно к конечной точке `/authorize`, чтобы получить новый код авторизации. При этом, в зависимости от типа приложения, пользователю может потребоваться повторно ввести учетные данные или предоставить разрешения.

Дополнительные сведения о том, как получить и использовать маркеры обновления, см. в [справочнике по протоколу платформы удостоверений Microsoft Identity](active-directory-v2-protocols.md).

## <a name="requesting-individual-user-consent"></a>Запрос на получение согласия одного пользователя

В запросе авторизации [OpenID Connect или OAuth 2.0](active-directory-v2-protocols.md) приложение может запросить необходимые разрешения с помощью параметра запроса `scope`. Например, когда пользователь входит в приложение, приложение отправляет запрос, как показано в следующем примере. (Для четкости добавляются разрывы строк.)

```HTTP
GET https://login.microsoftonline.com/common/oauth2/v2.0/authorize?
client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&response_type=code
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F
&response_mode=query
&scope=
https%3A%2F%2Fgraph.microsoft.com%2Fcalendars.read%20
https%3A%2F%2Fgraph.microsoft.com%2Fmail.send
&state=12345
```

Параметр `scope` — это запрашиваемый приложением список делегированных разрешений с разделителями-пробелами. Каждое разрешение указывается путем добавления значения разрешения в идентификатор ресурса (URI идентификатора приложения). В приведенном примере запроса приложению требуется разрешение на чтение календаря пользователя и отправку сообщений от его имени.

После того как пользователь введет свои учетные данные, платформа удостоверений Майкрософт проверяет наличие соответствующей записи *согласия пользователя*. Если пользователь не предоставил никаких прав на какие – либо запрошенные разрешения в прошлом и администратор не предоставил ему разрешения от имени всей Организации, платформа удостоверений Майкрософт попросит пользователя предоставить запрошенные разрешения.

В настоящее время `offline_access` разрешение ("сохранить доступ к данным, доступ к которым предоставляется)" и `user.read` ("вход и чтение профиля") автоматически включается в первоначальное согласие на приложение.  Эти разрешения обычно необходимы для правильной работы приложения. `offline_access`Разрешение предоставляет приложению доступ к маркерам обновления, которые являются критически важными для собственных приложений и веб-приложений. `user.read`Разрешение предоставляет доступ к `sub` утверждению. Это позволяет клиенту или приложению правильно опознать пользователя с течением времени и получить доступ к элементарным сведениям о пользователе.

![Пример снимка экрана, показывающий согласие на использование рабочей учетной записи.](./media/v2-permissions-and-consent/work_account_consent.png)

Когда пользователь утверждает запрос на разрешение, записывается согласие. Пользователю не нужно предоставлять согласие на это при следующем входе в приложение.

## <a name="requesting-consent-for-an-entire-tenant"></a>Запрос на получение согласия для клиента

Когда организация приобретает лицензию или подписку для приложения, Организация часто хочет заранее настроить приложение для использования всеми членами Организации. В ходе этого процесса администратор может предоставить этому приложению разрешение действовать от имени любого пользователя. Если администратор предоставляет согласие для всего клиента, пользователи организации не увидят страницу согласия для приложения.

Чтобы запросить согласие на делегированные разрешения для всех пользователей в клиенте, приложение может использовать конечную точку предоставления согласия администратора.

Кроме того, приложения должны использовать конечную точку предоставления согласия администратора для запроса разрешений приложения.

## <a name="admin-restricted-permissions"></a>Разрешения, предназначенные только для администраторов

Некоторые разрешения с высоким уровнем прав в ресурсах Майкрософт могут быть настроены на доступ с правами *администратора*. Ниже приведены некоторые примеры этих типов разрешений.

* чтение данных полных профилей пользователей с помощью `User.Read.All`;
* запись данных в каталог организации с помощью `Directory.ReadWrite.All`;
* чтение данных всех групп в каталоге организации с помощью `Groups.Read.All`.

Хотя пользователь-потребитель может предоставить приложению доступ к этим данным, пользователи организации не смогут предоставить доступ к одному и тому же набору конфиденциальных данных Организации. Если приложение запрашивает доступ к одному из таких разрешений у корпоративного пользователя, появится сообщение об ошибке со сведениями о том, что этот пользователь не может предоставить разрешения приложению.

Если приложению требуются области для разрешений, ограниченных администратором, администратор Организации должен предоставить согласие на эти области от имени пользователей организации. Чтобы не выводить приглашения пользователям, которые запрашивают согласие на разрешения, которые они не могут предоставить, приложение может использовать конечную точку согласия администратора. В следующем разделе рассматривается конечная точка согласия администратора.

Если приложение запрашивает делегированные разрешения с высоким уровнем прав, а администратор предоставляет эти разрешения через конечную точку предоставления согласия администратора, то согласие предоставляется для всех пользователей в клиенте.

Если приложение запрашивает разрешения приложения, а администратор предоставляет эти разрешения через конечную точку предоставления согласия администратора, это право не выполняется от имени какого-либо конкретного пользователя. а *напрямую* клиентскому приложению. Эти типы разрешений используются только службами управляющей программы и другими неинтерактивными приложениями, выполняемыми в фоновом режиме.

## <a name="using-the-admin-consent-endpoint"></a>Использование конечной точки предоставления согласия администратора

После использования конечной точки согласия администратора для предоставления согласия администратора все готово. Пользователям не нужно предпринимать никаких дальнейших действий. После предоставления согласия администратора пользователи могут получить маркер доступа через типичный поток проверки подлинности. Получившийся маркер доступа имеет разрешения с полномочиями.

Когда глобальный администратор использует ваше приложение и направляется к конечной точке авторизации, платформа Microsoft Identity определяет роль пользователя. Он спрашивает, хочет ли глобальный администратор предоставить согласие от имени всего клиента на запрошенные разрешения. Вместо этого можно использовать выделенную конечную точку согласия администратора, чтобы заранее запросить у администратора разрешение на предоставление разрешения от имени всего клиента. Эта конечная точка также необходима для запроса разрешений приложения. Разрешения приложения не могут быть запрошены с помощью авторизации Endpoint.

Если вы выполните описанные здесь действия, приложение получит возможность запрашивать разрешения для всех пользователей в клиенте, включая области только для администраторов. Эта операция имеет высокую привилегию. Используйте операцию, только если это необходимо для вашего сценария.

Пример кода, который реализует шаги, см. в примере с [ограниченными правами администратора](https://github.com/Azure-Samples/active-directory-dotnet-admin-restricted-scopes-v2) в GitHub.

### <a name="request-the-permissions-in-the-app-registration-portal"></a>Запрос разрешений на портале регистрации приложения

На портале регистрации приложений приложения могут включать в список необходимые разрешения, включая делегированные разрешения и разрешения приложения. Эта настройка позволяет использовать `/.default` область и параметр **предоставления согласия администратора** портал Azure.  

Как правило, разрешения должны быть статически определены для конкретного приложения. Они должны быть расширенными разрешениями, которые приложение будет запрашивать динамически или постепенно.

> [!NOTE]
>Разрешения приложения можно запросить только с помощью [`/.default`](#the-default-scope) . Поэтому, если приложению требуются разрешения приложения, убедитесь, что они перечислены на портале регистрации приложений.

Чтобы настроить список статически запрашиваемых разрешений для приложения, сделайте следующее:

1. Перейдите к своему приложению в кратком руководстве по <a href="https://go.microsoft.com/fwlink/?linkid=2083908" target="_blank">портал Azure регистрация приложений <span class="docon docon-navigate-external x-hidden-focus"></span> </a> .
1. Выберите приложение или [Создайте приложение](quickstart-register-app.md) , если это еще не сделано.
1. На странице **Обзор** приложения в разделе **Управление** выберите **разрешения API**  >  **Добавить разрешение**.
1. Выберите **Microsoft Graph** из списка доступных интерфейсов API. Затем добавьте разрешения, необходимые для приложения.
1. Выберите **Добавить разрешения**.

### <a name="recommended-sign-the-user-in-to-your-app"></a>Выполнение входа пользователя в приложение (рекомендуется)

Как правило, при создании приложения, использующего конечную точку предоставления согласия администратора, для него нужно настроить страницу или представление, в котором администратор может утвердить разрешения приложения. Эта страница может быть следующей:

* Часть процесса регистрации приложения.
* Часть параметров приложения.
* Выделенный поток подключения. 

Во многих случаях приложение должно отображать это представление "Connect" только после того, как пользователь выполнил вход с помощью рабочего учетная запись Майкрософт или учебного учетная запись Майкрософт.

При входе пользователя в приложение можно указать организацию, к которой принадлежит администратор, прежде чем попросите его утвердить необходимые разрешения. Хотя этот шаг не является обязательным, он может помочь в создании более интуитивно понятного интерфейса для пользователей организации. 

Чтобы подписать пользователя в, следуйте [учебникам по протоколу платформы удостоверений Microsoft Identity](active-directory-v2-protocols.md).

### <a name="request-the-permissions-from-a-directory-admin"></a>Запрос разрешений у администратора каталога

Когда вы будете готовы запросить разрешения у администратора вашей организации, вы можете перенаправить пользователя на конечную точку согласия администратора платформы удостоверений Майкрософт.

```HTTP
// Line breaks are for legibility only.
GET https://login.microsoftonline.com/{tenant}/v2.0/adminconsent?
client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&state=12345
&redirect_uri=http://localhost/myapp/permissions
&scope=
https://graph.microsoft.com/calendars.read
https://graph.microsoft.com/mail.send
```


| Параметр        | Условие        | Описание                                                                                |
|:--------------|:--------------|:-----------------------------------------------------------------------------------------|
| `tenant` | Обязательно | Клиент каталога, из которого необходимо запросить разрешение. Его можно указать в GUID или в формате понятного имени. Кроме того, на него можно ссылаться с помощью универсальных организаций, как показано в примере. Не используйте "Common", так как личные учетные записи не могут предоставить согласие администратора, за исключением контекста клиента. Чтобы обеспечить наилучшую совместимость с личными учетными записями, которые управляют клиентами, по возможности используйте идентификатор клиента. |
| `client_id` | Обязательно | Идентификатор приложения (клиента), который [портал Azure — регистрация приложений](https://go.microsoft.com/fwlink/?linkid=2083908) , назначенный приложению. |
| `redirect_uri` | Обязательно |Универсальный код ресурса (URI) перенаправления, на который нужно направлять ответ для обработки в приложении. Он должен в точности соответствовать одному из универсальных кодов ресурсов (URI) перенаправления, зарегистрированных на портале регистрации приложений. |
| `state` | Рекомендуемая | Значение, включаемое в запрос, которое также будет возвращено в ответе с маркером. Это может быть строка любого содержания. Используйте параметр state для кодирования сведений о состоянии пользователя в приложении перед выполнением запроса на аутентификацию. Например, это могут быть сведения об открытой на тот момент странице или представлении. |
|`scope`        | Обязательно        | Определяет набор разрешений, запрашиваемых приложением. Области могут быть либо статическими (с использованием [`/.default`](#the-default-scope) ), либо динамическими.  Этот набор может включать области OpenID Connect Connect ( `openid` , `profile` , `email` ). Если требуются разрешения приложения, необходимо использовать `/.default` для запроса статически настроенного списка разрешений.  |


На этом этапе Azure AD требует, чтобы администратор клиента вошел в систему, чтобы выполнить запрос. Администратору предлагается утвердить все разрешения, запрошенные в `scope` параметре.  Если вы использовали статическое значение ( `/.default` ), оно будет работать как конечная точка согласия администратора версии 1.0 и запросить согласие для всех областей, найденных в необходимых разрешениях для приложения.

#### <a name="successful-response"></a>Успешный ответ

Если администратор утверждает разрешения для приложения, то успешный ответ будет выглядеть следующим образом.

```HTTP
GET http://localhost/myapp/permissions?tenant=a8990e1f-ff32-408a-9f8e-78d3b9139b95&state=state=12345&admin_consent=True
```

| Параметр | Описание |
| --- | --- |
| `tenant` | Клиент каталога, предоставивший приложению запрошенные разрешения, в виде GUID. |
| `state` | Значение, включенное в запрос, которое также возвращается в ответе маркера. Это может быть строка любого содержания. Параметр state используется для кодирования сведений о состоянии пользователя в приложении перед созданием запроса на аутентификацию, например сведений об открытой на тот момент странице или представлении. |
| `admin_consent` | Для этого параметра будет задано значение `True`. |

#### <a name="error-response"></a>Сообщение об ошибке

Если администратор не утверждает разрешения для приложения, неудачный ответ выглядит следующим образом:

```HTTP
GET http://localhost/myapp/permissions?error=permission_denied&error_description=The+admin+canceled+the+request
```

| Параметр | Описание |
| --- | --- |
| `error` | Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок. Его также можно использовать для реагирования на ошибки. |
| `error_description` | Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки. |

После получения успешного ответа от конечной точки предоставления согласия администратора приложение получит запрошенные разрешения. Далее вы можете запросить маркер для ресурса, который вам нужен.

## <a name="using-permissions"></a>Использование разрешений

После того как пользователь отправил разрешения для приложения, приложение может получить маркеры доступа, которые представляют разрешение приложения для доступа к ресурсу в некоторой емкости. Маркер доступа можно использовать только для одного ресурса. Но закодированные внутри маркера доступа — это все разрешения, предоставленные приложению для этого ресурса. Чтобы получить маркер доступа, приложение может выполнить запрос к конечной точке маркера платформы идентификации Майкрософт, например:

```HTTP
POST common/oauth2/v2.0/token HTTP/1.1
Host: https://login.microsoftonline.com
Content-Type: application/json

{
    "grant_type": "authorization_code",
    "client_id": "6731de76-14a6-49ae-97bc-6eba6914391e",
    "scope": "https://outlook.office.com/mail.read https://outlook.office.com/mail.send",
    "code": "AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq..."
    "redirect_uri": "https://localhost/myapp",
    "client_secret": "zc53fwe80980293klaj9823"  // NOTE: Only required for web apps
}
```

Полученный маркер доступа можно использовать в HTTP-запросах к ресурсу. Он надежно указывает ресурсу, что ваше приложение имеет соответствующее разрешение для работы с конкретной задачей.

Дополнительные сведения о протоколе OAuth 2,0 и о получении маркеров доступа см. в [справочнике по протоколу конечной точки платформы Microsoft Identity](active-directory-v2-protocols.md).

## <a name="the-default-scope"></a>Область /.default

Область можно использовать `/.default` для переноса приложений из конечной точки v 1.0 в конечную точку платформы идентификации Майкрософт. `/.default`Область встроена для каждого приложения, которое ссылается на статический список разрешений, настроенных для регистрации приложения. 

`scope`Значение `https://graph.microsoft.com/.default` функционально аналогично значению `resource=https://graph.microsoft.com` в конечной точке v 1.0. Указав `https://graph.microsoft.com/.default` область в запросе, приложение запрашивает маркер доступа, включающий области для каждого Microsoft Graph разрешения, выбранного для приложения на портале регистрации приложений. Область создается с помощью URI ресурса и `/.default` . Поэтому, если URI ресурса — `https://contosoApp.com` , запрошенная область — `https://contosoApp.com/.default` .  В случаях, когда необходимо включить вторую косую черту для правильного запроса маркера, см. [раздел об замыкающих косых чертах](#trailing-slash-and-default).

`/.default`Область может использоваться в любом потоке OAuth 2,0. Но это необходимо в потоке от [имени пользователя](v2-oauth2-on-behalf-of-flow.md) и [потока учетных данных клиента](v2-oauth2-client-creds-grant-flow.md). Он также понадобится при использовании конечной точки предоставления согласия администратора v2 для запроса разрешений приложения.

Клиенты не могут сочетать статическое ( `/.default` ) согласие и динамическое согласие в одном запросе. Поэтому `scope=https://graph.microsoft.com/.default+mail.read` приводит к ошибке, так как она объединяет типы областей.

### <a name="default-and-consent"></a>Область /.default и согласие

Область `/.default` также активирует поведение конечной точки версии 1.0 для `prompt=consent`. Он запрашивает согласие на все разрешения, зарегистрированные приложением, независимо от ресурса. Если он включен как часть запроса, `/.default` область возвращает маркер, который содержит области для запрошенного ресурса.

### <a name="default-when-the-user-has-already-given-consent"></a>Использование области /.default, когда пользователь уже предоставил согласие

`/.default`Область функционально идентична поведению `resource` конечной точки v 1.0. Он также несет разрешение на согласие конечной точки v 1.0. То есть `/.default` активирует запрос согласия, только если пользователь не предоставил никаких разрешений между клиентом и ресурсом. 

Если такое согласие существует, возвращаемый маркер содержит все области, предоставленные пользователем для этого ресурса. Однако если разрешения не предоставлены или `prompt=consent` предоставлен параметр, то для всех областей, зарегистрированных клиентским приложением, отображается запрос на согласие.

#### <a name="example-1-the-user-or-tenant-admin-has-granted-permissions"></a>Пример 1. пользователь или администратор клиента предоставил разрешения

В этом примере пользователь или администратор клиента предоставил `mail.read` `user.read` клиенту разрешения и Microsoft Graph. 

Если клиент запрашивается `scope=https://graph.microsoft.com/.default` , запрос согласия не отображается, независимо от содержимого зарегистрированных разрешений клиентского приложения для Microsoft Graph. Возвращаемый токен содержит области `mail.read` и `user.read` .

#### <a name="example-2-the-user-hasnt-granted-permissions-between-the-client-and-the-resource"></a>Пример 2. пользователь не предоставил разрешения между клиентом и ресурсом

В этом примере пользователь не предоставил согласие между клиентом и Microsoft Graph. Клиент зарегистрирован для разрешений `user.read` и `contacts.read` . Он также зарегистрирован для области Azure Key Vault `https://vault.azure.net/user_impersonation` . 

Когда клиент запрашивает маркер для `scope=https://graph.microsoft.com/.default` , пользователь видит страницу согласия для `user.read` области, `contacts.read` области и Key Vault `user_impersonation` областей. Возвращаемый токен содержит только `user.read` области и `contacts.read` . Его можно использовать только для Microsoft Graph.

#### <a name="example-3-the-user-has-consented-and-the-client-requests-more-scopes"></a>Пример 3. пользователь уже получил запрос, а клиент запрашивает больше областей

В этом примере пользователь уже выполнил предложение для `mail.read` клиента. Клиент зарегистрирован для `contacts.read` области. 

Когда клиент запрашивает маркер, используя `scope=https://graph.microsoft.com/.default` и запрашивает согласие с согласия `prompt=consent` , он видит страницу согласия для всех (и только) разрешений, зарегистрированных приложением. `contacts.read`Область находится на странице согласия, но `mail.read` не является. Возвращенный токен предназначен для Microsoft Graph. Он содержит `mail.read` и `contacts.read` .

### <a name="using-the-default-scope-with-the-client"></a>Использование области /.default с клиентом

В некоторых случаях клиент может запрашивать собственную `/.default` область. Этот сценарий показан в следующем примере.

```HTTP
// Line breaks are for legibility only.

GET https://login.microsoftonline.com/{tenant}/oauth2/v2.0/authorize?
response_type=token            //Code or a hybrid flow is also possible here
&client_id=9ada6f8a-6d83-41bc-b169-a306c21527a5
&scope=9ada6f8a-6d83-41bc-b169-a306c21527a5/.default
&redirect_uri=https%3A%2F%2Flocalhost
&state=1234
```

Этот пример кода создает страницу согласия для всех зарегистрированных разрешений, если предыдущие описания согласия и `/.default` применяются к сценарию. Затем код возвращает `id_token` , а не маркер доступа.  

Это поведение разработано для некоторых устаревших клиентов, которые перемещаются из библиотеки аутентификация Azure AD Library (ADAL) в библиотеку проверки подлинности Майкрософт (MSAL). Эта программа установки не *должна* использоваться новыми клиентами, предназначенными для платформы Microsoft Identity.

### <a name="client-credentials-grant-flow-and-default"></a>Поток предоставления учетных данных клиента и/.дефаулт  

Другое использование функции `/.default` — запрос разрешений приложения (или *ролей*) в неинтерактивном приложении, например управляющее приложение, использующее поток предоставления [учетных данных клиента](v2-oauth2-client-creds-grant-flow.md) для вызова веб-API.

Сведения о создании разрешений приложения (ролей) для веб-API см. [в разделе Добавление ролей приложений в приложение](howto-add-app-roles-in-azure-ad-apps.md).

Запросы учетных данных клиента в клиентском приложении *должны* включать `scope={resource}/.default` . Здесь `{resource}` — это веб-API, который будет вызываться приложением. Отправка запроса учетных данных клиента с помощью отдельных разрешений приложения (роли) *не* поддерживается. Все разрешения приложения (роли), предоставленные для этого веб-API, включены в возвращенный маркер доступа.

Сведения о предоставлении доступа к определенным разрешениям приложения, включая предоставление согласия администратора для приложения, см. в разделе [Настройка клиентского приложения для доступа к веб-API](quickstart-configure-app-access-web-apis.md).

### <a name="trailing-slash-and-default"></a>Замыкающая косая черта и/.дефаулт

Некоторые URI ресурсов имеют замыкающую косую черту, например, в `https://contoso.com/` отличие от `https://contoso.com` . Замыкающая косая черта может вызвать проблемы с проверкой маркера. Проблемы возникают в основном при запросе маркера для Azure Resource Manager ( `https://management.azure.com/` ). В этом случае Замыкающая косая черта в URI ресурса означает, что при запросе маркера должна присутствовать косая черта.  Поэтому при запросе маркера для `https://management.azure.com/` и использования `/.default` необходимо выполнить запрос `https://management.azure.com//.default` (Обратите внимание на двойную косую черту!). Как правило, если вы проверяете, что маркер выдается, и если маркер отклоняется API, который должен принять его, попробуйте добавить вторую косую черту и повторите попытку. 

## <a name="troubleshooting-permissions-and-consent"></a>Устранение неполадок при использовании разрешений и механизма согласия

Инструкции по устранению неполадок см. [в разделе непредвиденная ошибка при выполнении согласия для приложения](../manage-apps/application-sign-in-unexpected-user-consent-error.md).

## <a name="next-steps"></a>Дальнейшие действия

* [Токены идентификации на платформе Microsoft Identity](id-tokens.md)
* [Маркеры доступа на платформе Microsoft Identity](access-tokens.md)
