---
title: Области платформы Microsoft Identity, разрешения и согласие
description: Сведения об авторизации в конечной точке платформы идентификации Майкрософт, включая области, разрешения и согласие.
services: active-directory
author: rwike77
manager: CelesteDG
ms.service: active-directory
ms.subservice: develop
ms.workload: identity
ms.topic: conceptual
ms.date: 09/23/2020
ms.author: ryanwi
ms.reviewer: hirsin, jesakowi, jmprieur, marsma
ms.custom: aaddev, fasttrack-edit, contperf-fy21q1, identityplatformtop40
ms.openlocfilehash: d3edadd4878dbd6e06648f7fb67a0c3e111665d1
ms.sourcegitcommit: c136985b3733640892fee4d7c557d40665a660af
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/13/2021
ms.locfileid: "98178132"
---
# <a name="permissions-and-consent-in-the-microsoft-identity-platform-endpoint"></a>Разрешения и согласие для конечной точки платформы удостоверений Майкрософт

Приложения, которые интегрируются с платформой удостоверений Майкрософт, следуют модели авторизации, при которой пользователи и администраторы контролируют доступ к данным. Реализация модели авторизации была обновлена в конечной точке платформы идентификации Майкрософт, и она изменяет, как приложение должно взаимодействовать с платформой Microsoft Identity. В этой статье рассматриваются основные понятия этой модели авторизации, включая области, разрешения и согласие на их предоставление.

## <a name="scopes-and-permissions"></a>Области и разрешения

Платформа удостоверений Майкрософт реализует протокол авторизации [OAuth 2.0](active-directory-v2-protocols.md). OAuth 2.0 — это метод, посредством которого стороннее приложение может обращаться к интернет-ресурсам от имени пользователя. Любой интернет-ресурс, интегрируемый с платформой удостоверений Майкрософт, имеет идентификатор ресурса или *универсальный код ресурса (URI) идентификатора приложения*. К примеру, ниже приведены некоторые из размещенных в Интернете ресурсов Майкрософт:

* Microsoft Graph: `https://graph.microsoft.com`
* API Microsoft 365 mail: `https://outlook.office.com`
* Azure Key Vault: `https://vault.azure.net`

> [!NOTE]
> Настоятельно рекомендуется использовать Microsoft Graph вместо API Microsoft 365 mail и т. д.

То же касается любых сторонних ресурсов, интегрированных с платформой удостоверений Майкрософт. Любой из этих ресурсов может также определять набор разрешений, с помощью которых можно разделить функции ресурса на меньшие блоки. Например, в [Microsoft Graph](https://graph.microsoft.com) определены разрешения для выполнения таких задач, как:

* чтение календаря пользователя;
* запись в календарь пользователя;
* отправка сообщений в качестве пользователя.

Благодаря определению этих разрешений ресурс получает детализированный контроль над своими данными и предоставлением внешнего доступа к функционалу API. Стороннее приложение может запрашивать эти разрешения у пользователей и администраторов. Они должны подтвердить такой запрос, прежде чем приложение получит доступ к данным или начнет действовать от имени пользователя. Разделяя функции ресурса на меньшие наборы разрешений, приложения сторонних производителей можно настроить таким образом, чтобы они запрашивали только определенные разрешения, необходимые им для выполнения своих задач. Пользователи и администраторы могут точно знать, какие данные имеют доступ к приложению, и они могут быть более достоверными, чтобы они не применялись вредоносным намерением. Разработчики должны всегда придерживаться принципа минимальных прав доступа и запрашивать только те разрешения, которые необходимы для работы приложения.

В OAuth 2.0 разрешения такого типа называются *областями*. Они также часто называются *разрешениями*. На платформе удостоверений Майкрософт они представлены в виде значения строки. Продолжим рассмотрение примера для Microsoft Graph. Значение строки для каждого разрешения следующее:

* чтение календаря пользователя с помощью `Calendars.Read`;
* запись в календарь пользователя с помощью `Calendars.ReadWrite`;
* отправка сообщений в качестве пользователя с помощью `Mail.Send`.

Приложение чаще всего запрашивает эти разрешения, указывая области в запросах авторизации платформы Microsoft Identity. Однако некоторые разрешения с высоким уровнем прав могут предоставляться только через согласие администратора, а запрошенные и предоставленные — с помощью [конечной точки согласия администратора](#admin-restricted-permissions). Ознакомьтесь с дополнительными сведениями, чтобы узнать больше.

## <a name="permission-types"></a>Типы разрешений

Платформа удостоверений Майкрософт поддерживает два типа разрешений: **делегированное разрешение** и **разрешение приложения**.

* **Делегированные разрешения** используются приложениями с авторизованным пользователем. Для этих приложений либо пользователь, либо администратор предоставил разрешения, запрашиваемые приложением, и приложение делегирует разрешение на выполнение в качестве пользователя, выполнившего вход, при выполнении вызовов к целевому ресурсу. Для некоторых делегированных разрешений могут предоставить согласие пользователи без прав администратора, а для других разрешений, с более высоким уровнем прав, необходимо [согласие администратора](#admin-restricted-permissions). Сведения о том, администраторы каких ролей могут предоставлять делегированные разрешения, см. в статье [Разрешения роли администратора в Azure Active Directory](../roles/permissions-reference.md).

* **Разрешения приложений** используются в приложениях, работающих без авторизованного пользователя (например, приложения, работающие как фоновые службы или управляющие программы).  Для таких разрешений согласие предоставляет [только администратор](#requesting-consent-for-an-entire-tenant).

_Действующие разрешения_ — это разрешения, которые есть у приложений при запросе целевого ресурса. Важно понимать разницу между делегированием и разрешениями приложения, предоставляемыми приложением, и его действующими разрешениями при выполнении вызовов к целевому ресурсу.

- Для делегированных разрешений _действующие разрешения_ приложения являются минимальным пересечением делегированных разрешений, предоставленных приложению (с согласия пользователя), и привилегий авторизованного пользователя. Приложения не могут иметь больше привилегий, чем авторизованный пользователь. В рамках организаций привилегии авторизованного пользователя могут определяться политикой или членством в одной или нескольких ролях администратора. Сведения о том, администраторы каких ролей могут предоставлять делегированные разрешения, см. в статье [Разрешения роли администратора в Azure Active Directory](../roles/permissions-reference.md).

   Например, предположим, что вашему приложению предоставлено делегированное разрешение _User.ReadWrite.All_. Это разрешение номинально предоставляет вашему приложению разрешение читать и обновлять профиль каждого пользователя в организации. Если авторизованный пользователь является глобальным администратором, ваше приложение сможет обновлять профиль каждого пользователя в организации. Однако если пользователь, выполнивший вход, не входит в роль администратора, приложение сможет обновить только профиль пользователя, выполнившего вход. Оно не сможет обновлять профили других пользователей в организации, потому что пользователь, от имени которого это приложение действует, не имеет таких привилегий.

- Для разрешений приложений _действующие разрешения_ вашего приложения будут представлять собой полный уровень привилегий, подразумеваемых разрешением. Например, приложение, имеющее разрешение _User.ReadWrite.All_, может обновлять профиль каждого пользователя в организации.

## <a name="openid-connect-scopes"></a>Области OpenId Connect

Реализация OpenID Connect Connect платформы Microsoft Identity имеет несколько четко определенных областей, которые также размещаются в Microsoft Graph: `openid` , `email` , `profile` и `offline_access` . Области OpenID Connect `address` и `phone` не поддерживаются.

При запросе областей OIDC и маркера вы получите маркер для вызова [конечной точки UserInfo](userinfo.md).

### <a name="openid"></a>OpenId

Если приложение выполняет вход с помощью протокола [OpenID Connect](active-directory-v2-protocols.md), оно должно запросить область `openid`. В рабочей учетной записи область `openid` отображается на странице согласия в виде разрешения "Вход", а в личной учетной записи Майкрософт — в виде разрешения "View your profile and connect to apps and services using your Microsoft account" (Просмотр профиля и подключение к приложениям и службам с помощью учетной записи Майкрософт). Это разрешение позволяет приложению получить уникальный идентификатор для пользователя в виде утверждения `sub`. Оно также предоставляет приложению доступ к конечной точке сведений о пользователе. `openid`Область можно использовать на конечной точке токена платформы Microsoft Identity для получения маркеров идентификации, которые могут использоваться приложением для проверки подлинности.

### <a name="email"></a>email

Область `email` можно использовать вместе с областью `openid` и любыми другими областями. Она предоставляет приложению доступ к основному электронному адресу пользователя в виде утверждения `email`. `email`Утверждение включается в маркер, только если адрес электронной почты связан с учетной записью пользователя, но это не всегда так. При использовании области `email` приложение должно быть готово обрабатывать случаи, когда утверждение `email` в маркере отсутствует.

### <a name="profile"></a>профиль

Область `profile` можно использовать вместе с областью `openid` и любыми другими областями. Она предоставляет приложению доступ к существенному объему сведений о пользователе. Информация, к которой он имеет доступ, включает, но не ограничивается именем пользователя, фамилией, предпочитаемым именем пользователя и ИДЕНТИФИКАТОРом объекта. Полный список утверждений профиля, доступных в параметре id_tokens для конкретного пользователя, см. в [ `id_tokens` справочнике](id-tokens.md).

### <a name="offline_access"></a>offline_access

Эта [ `offline_access` область](https://openid.net/specs/openid-connect-core-1_0.html#OfflineAccess) предоставляет приложению доступ к ресурсам от имени пользователя в течение длительного времени. На странице предоставления согласия эта область отображается в виде разрешения "Maintain access to data you have given it access to" (Сохранение доступа к данным, к которым он был предоставлен). Когда пользователь утверждает `offline_access` область, приложение может получить токены обновления из конечной точки маркера платформы идентификации Майкрософт. Маркеры обновления имеют большой срок действия. Приложение может получать новые маркеры доступа после того, как срок действия старых истечет.

> [!NOTE]
> Это разрешение отображается на всех экранах согласия прямо сейчас даже для потоков, не предоставляющих маркер обновления ( [неявный поток](v2-oauth2-implicit-grant-flow.md)). Это относится к сценариям, в которых клиент может начать работу в неявном потоке, а затем перейти к потоку кода, где ожидается маркер обновления.

На платформе Microsoft Identity (запросы к конечной точке версии 2.0) приложение должно явно запросить `offline_access` область для получения маркеров обновления. Это значит, что при использовании кода авторизации в [потоке кода авторизации OAuth 2.0](active-directory-v2-protocols.md) от конечной точки `/token` вы получите только маркер доступа. Маркер доступа действителен недолго. Как правило, его срок действия истекает через один час. В этот момент приложению будет необходимо перенаправить пользователя обратно к конечной точке `/authorize`, чтобы получить новый код авторизации. При этом, в зависимости от типа приложения, пользователю может потребоваться повторно ввести учетные данные или предоставить разрешения.

Дополнительные сведения о том, как получить и использовать маркеры обновления, см. в [справочнике по протоколу платформы удостоверений Microsoft Identity](active-directory-v2-protocols.md).

## <a name="requesting-individual-user-consent"></a>Запрос на получение согласия одного пользователя

В запросе авторизации [OpenID Connect или OAuth 2.0](active-directory-v2-protocols.md) приложение может запросить необходимые разрешения с помощью параметра запроса `scope`. Например, при входе пользователя в приложение оно отправит запрос следующего вида (разрывы строк добавлены для удобства чтения).

```HTTP
GET https://login.microsoftonline.com/common/oauth2/v2.0/authorize?
client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&response_type=code
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F
&response_mode=query
&scope=
https%3A%2F%2Fgraph.microsoft.com%2Fcalendars.read%20
https%3A%2F%2Fgraph.microsoft.com%2Fmail.send
&state=12345
```

Параметр `scope` — это запрашиваемый приложением список делегированных разрешений с разделителями-пробелами. Чтобы указать каждое разрешение, его значение добавляется к идентификатору ресурса (универсальному коду ресурса (URI) идентификатора приложения). В приведенном примере запроса приложению требуется разрешение на чтение календаря пользователя и отправку сообщений от его имени.

После того как пользователь введет свои учетные данные, конечная точка платформы Microsoft Identity проверяет наличие соответствующей записи *согласия пользователя*. Если пользователь не согласились ни с одним из запрошенных разрешений в прошлом, ни администратор не предоставил разрешение на эти разрешения от имени всей Организации, конечная точка платформы идентификации Майкрософт попросит пользователя предоставить запрошенные разрешения.

> [!NOTE]
>В настоящее время разрешения `offline_access` ("Maintain access to data you have given it access to" (Сохранение доступа к данным, к которым он был предоставлен)) и `user.read` ("Sign you in and read your profile" (Вход и чтение профиля)) автоматически добавляются в начальное согласие для приложения.  Обычно эти разрешения необходимы для правильной работы приложения. `offline_access` обеспечивает приложению доступ к маркерам обновления, что крайне важно для собственных приложений и веб-приложений. `user.read` предоставляет доступ к утверждению `sub`, что позволяет клиенту или приложению правильно идентифицировать пользователя на протяжении времени и получать доступ к элементарным сведениям о пользователе.

![Пример снимка экрана, показывающий согласие рабочей учетной записи](./media/v2-permissions-and-consent/work_account_consent.png)

После того как пользователь утвердит разрешение, факт согласия будет записан, чтобы пользователю не пришлось повторно давать его при входе в учетную запись приложения в дальнейшем.

## <a name="requesting-consent-for-an-entire-tenant"></a>Запрос на получение согласия для клиента

Часто, когда организация приобретает лицензию или подписку на приложение, планируется установка приложения для использования всеми сотрудниками. В ходе этого процесса администратор может предоставить этому приложению разрешение действовать от имени любого пользователя. Если администратор предоставляет разрешения для всего клиента, то пользователи организации не увидят страницу согласия для приложения.

Чтобы запросить согласие на делегированные разрешения для всех пользователей в клиенте, приложение может использовать конечную точку предоставления согласия администратора.

Кроме того, конечная точка предоставления согласия администратора понадобится для запроса разрешений приложения.

## <a name="admin-restricted-permissions"></a>Разрешения, предназначенные только для администраторов

Некоторые высокопривилегированные разрешения в экосистеме Майкрософт могут быть помечены как *предназначенные только для администраторов*. Ниже приведены примеры подобных разрешений:

* чтение данных полных профилей пользователей с помощью `User.Read.All`;
* запись данных в каталог организации с помощью `Directory.ReadWrite.All`;
* чтение данных всех групп в каталоге организации с помощью `Groups.Read.All`.

Хотя пользователь, являющийся потребителем, и может предоставить приложению доступ к таким данным, корпоративным пользователям нельзя предоставлять доступ к таким же конфиденциальным данным компании. Если приложение запрашивает доступ к одному из таких разрешений у корпоративного пользователя, появится сообщение об ошибке со сведениями о том, что этот пользователь не может предоставить разрешения приложению.

Если вашему приложению требуется доступ к областям только для администраторов организаций, следует запросить их непосредственно у администратора компании, а также с помощью конечной точки предоставления согласия администратора, как описано ниже.

Если приложение запрашивает высокопривилегированные делегированные разрешения и администратор предоставляет эти разрешения через конечную точку предоставления согласия администратора, согласие получат все пользователи в клиенте.

Если приложение запрашивает разрешения приложения, а администратор предоставляет эти разрешения через конечную точку предоставления согласия администратора, это право не выполняется от имени какого-либо конкретного пользователя. а *напрямую* клиентскому приложению. Эти типы разрешений используются только службами управляющей программы и другими неинтерактивными приложениями, выполняемыми в фоновом режиме.

## <a name="using-the-admin-consent-endpoint"></a>Использование конечной точки предоставления согласия администратора

> [!NOTE]
> Обратите внимание, что после предоставления согласия администратора с помощью конечной точки согласия администратора вы завершили предоставление согласия администратора, и пользователям не нужно выполнять дополнительные действия. После предоставления согласия администратора пользователи могут получить маркер доступа через типичный поток проверки подлинности, а получившийся маркер доступа будет иметь разрешения с согласия пользователя.

Когда администратор компании, используя ваше приложение, переходит к конечной точке авторизации, платформа удостоверений Майкрософт определяет роль пользователя и предлагает ему предоставлять согласие на запрошенные вами разрешения от имени всего клиента. Если вы хотите, чтобы администратор предоставлял разрешения от имени всего клиента, можно использовать выделенную конечную точку предоставления согласия администратора. Использование этой конечной точки также необходимо для запроса разрешений приложения (которые не могут быть запрошены с помощью авторизации Endpoint).

Если вы выполните описанные здесь действия, приложение получит возможность запрашивать разрешения для всех пользователей в клиенте, включая области только для администраторов. Эта операция является высокопривилегированной, поэтому ее следует выполнять, только если это необходимо для вашего сценария.

Пример кода, реализующий эти действия, см. в [примере областей только для администраторов](https://github.com/Azure-Samples/active-directory-dotnet-admin-restricted-scopes-v2).

### <a name="request-the-permissions-in-the-app-registration-portal"></a>Запрос разрешений на портале регистрации приложения

Приложения могут запрашивать, какие разрешения они требуются (делегированные и приложения) на портале регистрации приложений.  Это позволяет использовать `/.default` область и параметр портал Azure "предоставить согласие администратора".  Как правило, рекомендуется убедиться, что разрешения, статически определенные для данного приложения, являются надмножеством разрешений, которые будут запрашиваться динамически или постепенно.

> [!NOTE]
>Разрешения на доступ к приложениям могут запрашиваться только с помощью. [`/.default`](#the-default-scope) Если приложению требуются разрешения приложения, убедитесь, что они перечислены на портале регистрации приложений.

#### <a name="to-configure-the-list-of-statically-requested-permissions-for-an-application"></a>Настройка списка статически запрошенных разрешений для приложения

1. Перейдите к своему приложению в кратком руководстве по <a href="https://go.microsoft.com/fwlink/?linkid=2083908" target="_blank">портал Azure регистрация приложений <span class="docon docon-navigate-external x-hidden-focus"></span> </a> .
1. Выберите приложение или [Создайте приложение](quickstart-register-app.md) , если это еще не сделано.
1. На странице **Обзор** приложения в разделе **Управление** выберите **разрешения API**  >  **Добавить разрешение**.
1. Выберите **Microsoft Graph** из списка доступных интерфейсов API, а затем добавьте разрешения, необходимые для приложения.
1. Выберите **Добавить разрешения**.

### <a name="recommended-sign-the-user-into-your-app"></a>Рекомендуется: подписывать пользователя в приложении

Как правило, при создании приложения, использующего конечную точку предоставления согласия администратора, для него нужно настроить страницу или представление, в котором администратор может утвердить разрешения приложения. Эта страница может быть частью потока регистрации приложения, параметров приложения или выделенного потока подключения. Во многих случаях разумно отображать это представление подключения в приложении только после того, как пользователь выполнил вход с помощью учебной или рабочей учетной записи Майкрософт.

При входе пользователя в приложение можно определить организацию, к которой принадлежит администратор, прежде чем запрашивать у него утверждение необходимых разрешений. Хотя это не обязательно, таким образом можно сделать пользовательский интерфейс более интуитивно понятным для сотрудников организации. Чтобы подписать пользователя в, следуйте нашим [руководствам по протоколу платформы идентификации Майкрософт](active-directory-v2-protocols.md).

### <a name="request-the-permissions-from-a-directory-admin"></a>Запрос разрешений у администратора каталога

Когда вы будете готовы запросить разрешения у администратора вашей организации, вы можете перенаправить пользователя на *конечную точку согласия администратора* платформы удостоверений Майкрософт.

```HTTP
// Line breaks are for legibility only.
GET https://login.microsoftonline.com/{tenant}/v2.0/adminconsent?
client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&state=12345
&redirect_uri=http://localhost/myapp/permissions
&scope=
https://graph.microsoft.com/calendars.read
https://graph.microsoft.com/mail.send
```


| Параметр        | Условие        | Описание                                                                                |
|:--------------|:--------------|:-----------------------------------------------------------------------------------------|
| `tenant` | Обязательно | Клиент каталога, из которого необходимо запросить разрешение. Может предоставляться в формате GUID или понятном имени, а также в универсальных ссылках на организации, как показано в примере. Не используйте "Common", так как личные учетные записи не могут предоставить согласие администратора, за исключением контекста клиента. Чтобы обеспечить лучшую совместимость с личными учетными записями, которые управляют клиентами, по возможности используйте идентификатор клиента. |
| `client_id` | Обязательно | **Идентификатор приложения (клиента)** , назначенный вашему приложению функцией [Регистрация приложений портала Azure](https://go.microsoft.com/fwlink/?linkid=2083908). |
| `redirect_uri` | Обязательно |Универсальный код ресурса (URI) перенаправления, на который нужно направлять ответ для обработки в приложении. Он должен в точности соответствовать одному из универсальных кодов ресурсов (URI) перенаправления, зарегистрированных на портале регистрации приложений. |
| `state` | Рекомендуется | Значение, включаемое в запрос, которое также будет возвращено в ответе с маркером. Это может быть строка любого содержания. Используйте параметр state для кодирования сведений о состоянии пользователя в приложении перед выполнением запроса на аутентификацию. Например, это могут быть сведения об открытой на тот момент странице или представлении. |
|`scope`        | Обязательно        | Определяет набор разрешений, запрашиваемых приложением. Это могут быть либо статические (с использованием [`/.default`](#the-default-scope) ), либо динамические области.  Это могут быть области OIDC ( `openid` , `profile` , `email` ). Если требуются разрешения приложения, необходимо использовать `/.default` для запроса статически настроенного списка разрешений.  |


На этом этапе Azure AD требует, чтобы администратор клиента вошел в систему, чтобы выполнить запрос. Администратору предлагается утвердить все разрешения, запрошенные в `scope` параметре.  Если вы использовали статическое `/.default` значение (), оно будет работать как конечная точка согласия администратора версии 1.0 и запросить согласие для всех областей, найденных в необходимых разрешениях для приложения.

#### <a name="successful-response"></a>Успешный ответ

Если администратор утверждает разрешения для приложения, то успешный ответ будет выглядеть следующим образом.

```HTTP
GET http://localhost/myapp/permissions?tenant=a8990e1f-ff32-408a-9f8e-78d3b9139b95&state=state=12345&admin_consent=True
```

| Параметр | Описание |
| --- | --- |
| `tenant` | Клиент каталога, предоставивший приложению запрошенные разрешения, в виде GUID. |
| `state` | Значение, включенное в запрос, которое также возвращается в ответе маркера. Это может быть строка любого содержания. Параметр state используется для кодирования сведений о состоянии пользователя в приложении перед созданием запроса на аутентификацию, например сведений об открытой на тот момент странице или представлении. |
| `admin_consent` | Для этого параметра будет задано значение `True`. |

#### <a name="error-response"></a>Сообщение об ошибке

Если администратор не утверждает разрешения для приложения, то сообщение о неудачном выполнении будет выглядеть следующим образом.

```HTTP
GET http://localhost/myapp/permissions?error=permission_denied&error_description=The+admin+canceled+the+request
```

| Параметр | Описание |
| --- | --- |
| `error` | Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| `error_description` | Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки. |

После получения успешного ответа от конечной точки предоставления согласия администратора приложение получит запрошенные разрешения. Далее вы можете запросить маркер для ресурса, который вам нужен.

## <a name="using-permissions"></a>Использование разрешений

После того как пользователь предоставит разрешения для приложения, оно может получать маркеры доступа, представляющие разрешение приложения на определенный уровень доступа к ресурсу. Маркер доступа можно использовать только для отдельного ресурса, но в этом маркере закодированы все разрешения, предоставленные приложению для данного ресурса. Чтобы получить маркер доступа, приложение может выполнить запрос к конечной точке маркера платформы идентификации Майкрософт, например:

```HTTP
POST common/oauth2/v2.0/token HTTP/1.1
Host: https://login.microsoftonline.com
Content-Type: application/json

{
    "grant_type": "authorization_code",
    "client_id": "6731de76-14a6-49ae-97bc-6eba6914391e",
    "scope": "https://outlook.office.com/mail.read https://outlook.office.com/mail.send",
    "code": "AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq..."
    "redirect_uri": "https://localhost/myapp",
    "client_secret": "zc53fwe80980293klaj9823"  // NOTE: Only required for web apps
}
```

Полученный маркер доступа можно использовать в HTTP-запросах к ресурсу. Он достоверно указывает ресурсу, что у приложения имеется необходимое разрешение для выполнения определенной задачи.

Дополнительные сведения о протоколе OAuth 2,0 и о получении маркеров доступа см. в [справочнике по протоколу конечной точки платформы Microsoft Identity](active-directory-v2-protocols.md).

## <a name="the-default-scope"></a>Область /.default

Область можно использовать `/.default` для переноса приложений из конечной точки v 1.0 в конечную точку платформы идентификации Майкрософт. Это встроенная область для каждого приложения, которая ссылается на статический список разрешений, настроенных в регистрации приложения. Значение `scope` параметра `https://graph.microsoft.com/.default` обеспечивает те же функции, что и параметр`resource=https://graph.microsoft.com` конечных точек версии 1.0: запрашивается маркер с областями в Microsoft Graph, зарегистрированными для приложения на портале Azure.  Он создается с использованием URI ресурса + `/.default` (например, если URI ресурса — `https://contosoApp.com` , запрошенная область будет `https://contosoApp.com/.default` ).  См. [раздел с символами косой черты в](#trailing-slash-and-default) случае, когда необходимо включить вторую косую черту для правильного запроса маркера.

Область/.дефаулт может использоваться в любом потоке OAuth 2,0, но это необходимо в потоке от [имени пользователя](v2-oauth2-on-behalf-of-flow.md) и [потока учетных данных клиента](v2-oauth2-client-creds-grant-flow.md), а также при использовании конечной точки согласия администратора v2 для запроса разрешений приложения.

> [!NOTE]
> Клиенты не могут объединять статическое ( `/.default` ) и динамическое согласие в одном запросе. Поэтому `scope=https://graph.microsoft.com/.default+mail.read` приведет к ошибке из-за объединения типов области.

### <a name="default-and-consent"></a>Область /.default и согласие

Область `/.default` также активирует поведение конечной точки версии 1.0 для `prompt=consent`. Она запрашивает согласие для всех разрешений, зарегистрированных для приложения, вне зависимости от ресурса. При включении в состав запроса `/.default` область возвращает маркер, который содержит области для запрошенного ресурса.

### <a name="default-when-the-user-has-already-given-consent"></a>Использование области /.default, когда пользователь уже предоставил согласие

Так как область `/.default` функционально идентична конечной точке версии 1.0 на основе `resource`, она также использует механизм согласия конечной точки версии 1.0. А именно, `/.default` активирует запрос на продолжение, только если пользователь не предоставил разрешение между клиентом и ресурсом. Если же согласие существует, будет возвращен маркер, содержащий все области, предоставленные пользователем для этого ресурса. Тем не менее, если разрешение не было предоставлено или был указан параметр `prompt=consent`, будет отображен запрос на продолжение для всех областей, зарегистрированных клиентским приложением.

#### <a name="example-1-the-user-or-tenant-admin-has-granted-permissions"></a>Пример 1. пользователь или администратор клиента предоставил разрешения

В этом примере пользователь (или администратор клиента) предоставил клиенту разрешения Microsoft Graph `mail.read` и `user.read` . Если клиент запрашивает `scope=https://graph.microsoft.com/.default`, запрос на продолжение не отобразится независимо от содержимого зарегистрированных разрешений клиентских приложений для Microsoft Graph. Будет возвращен маркер с областями `mail.read` и `user.read`.

#### <a name="example-2-the-user-hasnt-granted-permissions-between-the-client-and-the-resource"></a>Пример 2. пользователь не предоставил разрешения между клиентом и ресурсом

В этом примере не существует согласия пользователя между клиентом и Microsoft Graph. Для клиента зарегистрированы разрешения `user.read` и `contacts.read`, а также область Azure Key Vault `https://vault.azure.net/user_impersonation`. Когда клиент запросит маркер для `scope=https://graph.microsoft.com/.default`, пользователь увидит экран предоставления согласия для областей `user.read`, `contacts.read` и области Key Vault `user_impersonation`. Возвращаемый токен будет иметь только `user.read` области и, `contacts.read` и его можно использовать только для Microsoft Graph.

#### <a name="example-3-the-user-has-consented-and-the-client-requests-additional-scopes"></a>Пример 3. пользователь с запросом на отправку и клиент запрашивает дополнительные области

В этом примере пользователь уже выполнил предложение для `mail.read` клиента. Клиент зарегистрировал область `contacts.read` в своей регистрации. Когда клиент выполняет запрос маркера с помощью `scope=https://graph.microsoft.com/.default` и запрашивает согласие через `prompt=consent` , пользователь увидит экран согласия для всех (и только) разрешений, зарегистрированных приложением. Разрешение `contacts.read` будет представлено на экране предоставления согласия, а разрешение `mail.read` — нет. Будет возвращен маркер для Microsoft Graph, содержащий `mail.read` и `contacts.read`.

### <a name="using-the-default-scope-with-the-client"></a>Использование области /.default с клиентом

Особым случаем области `/.default` является ситуация, когда клиент запрашивает собственную область `/.default`. Этот сценарий показан в следующем примере.

```HTTP
// Line breaks are for legibility only.

GET https://login.microsoftonline.com/{tenant}/oauth2/v2.0/authorize?
response_type=token            //code or a hybrid flow is also possible here
&client_id=9ada6f8a-6d83-41bc-b169-a306c21527a5
&scope=9ada6f8a-6d83-41bc-b169-a306c21527a5/.default
&redirect_uri=https%3A%2F%2Flocalhost
&state=1234
```

В результате отображается экран предоставления согласия для всех зарегистрированных разрешений (если применимо в соответствии с приведенным выше описанием согласия и `/.default`), а затем возвращается маркер id_token, а не маркер доступа.  Это поведение существует для некоторых устаревших клиентов, переходящих из ADAL в MSAL, и **не должно** использоваться новыми клиентами, предназначенными для конечной точки платформы Microsoft Identity.

### <a name="client-credentials-grant-flow-and-default"></a>Поток предоставления учетных данных клиента и/.дефаулт

Другое использование `/.default` — при запросе разрешений приложения (или *ролей*) в неинтерактивном приложении, например в управляющем приложении, которое использует поток предоставления [учетных данных клиента](v2-oauth2-client-creds-grant-flow.md) для вызова веб-API.

Сведения о создании разрешений приложения (ролей) для веб-API см. в разделе [как добавить роли приложения в приложение](howto-add-app-roles-in-azure-ad-apps.md).

Запросы учетных данных клиента в клиентском приложении **должны** включать `scope={resource}/.default` , где `{resource}` — это веб-API, который будет вызываться приложением. Отправка запроса учетных данных клиента с индивидуальными разрешениями приложения (роли) **не** поддерживается. Все разрешения приложения (роли), предоставленные для этого веб-API, будут включаться в возвращенный маркер доступа.

Сведения о предоставлении доступа к определенным разрешениям приложения, включая предоставление согласия администратора для приложения, см. в разделе [Краткое руководство. Настройка клиентского приложения для доступа к веб-API](quickstart-configure-app-access-web-apis.md).

### <a name="trailing-slash-and-default"></a>Замыкающая косая черта и/.дефаулт

Некоторые URI ресурсов имеют замыкающую косую черту ( `https://contoso.com/` в отличие от `https://contoso.com` ), что может вызвать проблемы с проверкой маркеров.  Это может произойти в основном при запросе маркера для управления ресурсами Azure ( `https://management.azure.com/` ), в котором есть косая черта в URI ресурса, и он должен присутствовать при запросе маркера.  Поэтому при запросе маркера для `https://management.azure.com/` и использования необходимо `/.default` запрашивать `https://management.azure.com//.default` -заметку с двойной косой чертой!

Как правило, если вы проверили, что маркер выдается, а маркер отклоняется API, который должен принять его, попробуйте добавить вторую косую черту и повторите попытку. Это происходит потому, что сервер входа создает маркер с аудиторией, соответствующей URI в `scope` параметре, с `/.default` удалением из конца.  Если это приведет к удалению замыкающей косой черты, сервер входа по-прежнему обрабатывает запрос и проверяет его на соответствие URI ресурса, несмотря на то, что они больше не совпадают — это не является стандартным и не должно полагаться на приложение.

## <a name="troubleshooting-permissions-and-consent"></a>Устранение неполадок при использовании разрешений и механизма согласия

Если во время принятия согласия у пользователей вашего приложения возникли непредвиденные ошибки, см. инструкции по устранению неполадок в этой статье: [непредвиденная ошибка при выполнении согласия для приложения](../manage-apps/application-sign-in-unexpected-user-consent-error.md).

## <a name="next-steps"></a>Дальнейшие действия

* [Маркеры ID | Платформа Microsoft Identity](id-tokens.md)
* [Маркеры доступа | Платформа Microsoft Identity](access-tokens.md)
