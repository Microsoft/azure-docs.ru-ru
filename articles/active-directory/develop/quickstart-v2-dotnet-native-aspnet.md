---
title: Краткое руководство. Вызов веб-API ASP.NET, защищенного с помощью платформы удостоверений Майкрософт | Azure
titleSuffix: Microsoft identity platform
description: Из этого краткого руководства вы узнаете, как вызвать веб-API ASP.NET, защищенный с помощью платформы удостоверений Майкрософт, из приложения Windows Desktop (WPF).
services: active-directory
author: jmprieur
manager: CelesteDG
ms.service: active-directory
ms.subservice: develop
ms.topic: quickstart
ms.workload: identity
ms.date: 10/05/2020
ms.author: jmprieur
ms.custom: devx-track-csharp, aaddev, identityplatformtop40, scenarios:getting-started, languages:ASP.NET
ms.openlocfilehash: 2967476d06b8f6f88b740f811a94c5fdb4284b4d
ms.sourcegitcommit: 42a4d0e8fa84609bec0f6c241abe1c20036b9575
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "98011872"
---
# <a name="quickstart-call-an-aspnet-web-api-thats-protected-by-microsoft-identity-platform"></a>Краткое руководство. Вызов веб-API ASP.NET, защищенного с помощью платформы удостоверений Майкрософт

При работе с этим кратким руководством вы скачаете и выполните пример кода. Такой пример кода демонстрирует, как защитить веб-API ASP.NET, разрешив доступ к его ресурсам только авторизованным учетным записям. Пример поддерживает авторизацию личных учетных записей Майкрософт и учетных записей в любой организации Azure Active Directory (Azure AD).

В статье также описано использование приложения Windows Presentation Foundation (WPF) для демонстрации того, как можно запросить маркер доступа к веб-API.

## <a name="prerequisites"></a>Предварительные требования

* Учетная запись Azure с активной подпиской. [Создайте учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F) бесплатно.
* Visual Studio 2017 или 2019. Скачайте [Visual Studio бесплатно](https://www.visualstudio.com/downloads/).

## <a name="clone-or-download-the-sample"></a>Клонирование или скачивание примера

Пример можно получить одним из двух способов:

* Клонировать его из оболочки или командной строки:
   ```console
   git clone https://github.com/AzureADQuickStarts/AppModelv2-NativeClient-DotNet.git
   ```
* [Скачать его в виде ZIP-файла](https://github.com/AzureADQuickStarts/AppModelv2-NativeClient-DotNet/archive/complete.zip).

## <a name="register-your-web-api"></a>Регистрация веб-API

В этом разделе описано, как зарегистрировать веб-API в разделе **Регистрация приложений** на портале Azure.

### <a name="choose-your-azure-ad-tenant"></a>Выбор арендатора Azure AD

Чтобы зарегистрировать приложения вручную, выберите арендатор Azure Active Directory (Azure AD), в котором вы хотите создать приложения.

1. Войдите на <a href="https://portal.azure.com/" target="_blank">портал Azure<span class="docon docon-navigate-external x-hidden-focus"></span></a> с личной учетной записью Майкрософт либо рабочей или учебной учетной записью.
1. Если ваша учетная запись принадлежит к нескольким арендаторам Azure AD, выберите профиль в правом верхнем углу, а затем **переключите каталог**.
1. Смените сеанс портала на арендатор Azure AD, который необходимо использовать.

### <a name="register-the-todolistservice-app"></a>Регистрация приложения TodoListService

1. Войдите на <a href="https://portal.azure.com/" target="_blank">портал Azure<span class="docon docon-navigate-external x-hidden-focus"></span></a>.
1. Если у вас есть доступ к нескольким клиентам, в верхнем меню используйте фильтр **Каталог и подписка** :::image type="icon" source="./media/common/portal-directory-subscription-filter.png" border="false":::, чтобы выбрать клиент, в котором следует зарегистрировать приложение.
1. Найдите и выберите **Azure Active Directory**.
1. В разделе **Управление** выберите **Регистрация приложений** > **Новая регистрация**.
1. Введите **имя** приложения, например `AppModelv2-NativeClient-DotNet-TodoListService`. Пользователи приложения могут видеть это имя. Вы можете изменить его позже.
1. Для параметра **Поддерживаемые типы учетных записей** выберите **Учетные записи в любом каталоге организации**.
1. Выберите **Зарегистрировать**, чтобы создать приложение.
1. На странице приложения **Обзор** найдите **идентификатор приложения (клиента)** и запишите его, чтобы использовать позже. Он понадобится для настройки файла конфигурации Visual Studio для этого проекта (то есть, `ClientId` в файле *TodoListService\Web.config*).
1. В разделе **Управление** выберите **Предоставление API** > **Добавить группу**. Примите предложенный код URI идентификатора приложения (`api://{clientId}`), выбрав **Сохранить и продолжить**, а затем введите следующие сведения:

    1. В поле **Имя области** введите `access_as_user`.
    1. Убедитесь, что для параметра **Кто может давать согласие** выбран вариант **Admins and users** (Администраторы и пользователи).
    1. В поле **Отображаемое имя согласия администратора** введите `Access TodoListService as a user` (Доступ к TodoListService в качестве пользователя).
    1. В поле **Описание согласия администратора** введите `Accesses the TodoListService web API as a user` (Доступ к веб-API TodoListService в качестве пользователя).
    1. В поле **Отображаемое имя согласия пользователя** введите `Access TodoListService as a user` (Доступ к TodoListService в качестве пользователя).
    1. В поле **Описание согласия пользователя** введите `Accesses the TodoListService web API as a user` (Доступ к веб-API TodoListService в качестве пользователя).
    1. Для параметра **Состояние** оставьте значение **Включено**.
1. Выберите **Добавить область**.

### <a name="configure-the-service-project"></a>Настройка проекта службы

Настройте проект службы в соответствии с зарегистрированным веб-API, выполнив следующие действия.

1. Откройте решение в Visual Studio, а затем откройте файл *Web.config* в корневом каталоге проекта TodoListService.

1. Замените значение параметра `ida:ClientId` на значение идентификатора клиента (идентификатор приложения) из приложения, которое вы только что зарегистрировали на портале **Регистрация приложений**.

### <a name="add-the-new-scope-to-the-appconfig-file"></a>Добавление новой области в файл app.config

Чтобы добавить новую область в файл *app.config* проекта TodoListClient, выполните следующие действия.

1. В корневой папке проекта TodoListClient откройте файл *app.config*.

1. Вставьте идентификатор приложения из приложения, которое вы только что зарегистрировали для проекта TodoListService, в параметр `TodoListServiceScope`, заменив строку `{Enter the Application ID of your TodoListService from the app registration portal}`.

  > [!NOTE]
  > Идентификатор приложения должен быть задан в следующем формате: `api://{TodoListService-Application-ID}/access_as_user` (где `{TodoListService-Application-ID}` — это GUID, представляющий идентификатор приложения для TodoListService).

## <a name="register-the-todolistclient-client-app"></a>Регистрация клиентского приложения TodoListClient

В этом разделе описано, как зарегистрировать приложение TodoListClient в разделе **Регистрация приложений** на портале Azure, а затем настроить код в проекте TodoListClient. Если клиент и сервер считаются *одним и тем же приложением*, вы можете повторно использовать приложение, зарегистрированное на шаге 2. Если вы хотите, чтобы пользователи могли выполнять вход с помощью личных учетных записей Майкрософт, используйте то же приложение.

### <a name="register-the-app"></a>Регистрация приложения

Чтобы зарегистрировать приложение TodoListClient, выполните следующие действия.

1. Перейдите на портал [Регистрация приложений](https://go.microsoft.com/fwlink/?linkid=2083908) платформы удостоверений Майкрософт для разработчиков.
1. Выберите **Новая регистрация**.
1. Когда откроется страница **Регистрация приложения**, введите сведения о регистрации приложения.

    1. В разделе **Имя** введите понятное имя приложения, которое будет отображаться пользователям приложения (например, **NativeClient-DotNet-TodoListClient**).
    1. Для параметра **Поддерживаемые типы учетных записей** выберите **Учетные записи в любом каталоге организации**.
    1. Выберите **Зарегистрировать**, чтобы создать приложение.

   > [!NOTE]
   > В файле *app.config* проекта TodoListClient в качестве значения по умолчанию для `ida:Tenant` задано `common`. Допустимые значения:
   > - `common`. Вы можете войти с помощью рабочей или учебной учетной записи или личной учетной записи Майкрософт (так как на шаге 3 вы выбрали параметр **Учетные записи в любом каталоге организации**).
   > - `organizations`. Вы можете войти с помощью рабочей или учебной учетной записи.
   > - `consumers`. Вы можете войти только с помощью личной учетной записи Майкрософт.

1. На странице **Обзор** выберите **Проверка подлинности** и выполните следующие действия.

    1. В разделе **Конфигурации платформ** нажмите кнопку **Добавить платформу**.
    1. Для параметра **Мобильные и классические приложения** выберите значение **Мобильные и классические приложения**.
    1. Для параметра **URI перенаправления** установите флажок **https://login.microsoftonline.com/common/oauth2/nativeclient** .
    1. Нажмите кнопку **Настроить**.

1. Выберите **Разрешения API**, а затем выполните следующие действия.

    1. Нажмите кнопку **Add a permission** (Добавить разрешение).
    1. Выберите вкладку **Мои API**.
    1. В списке интерфейсов API выберите **ppModelv2-NativeClient-DotNet-TodoListService API** или имя, введенное для веб-API.
    1. Установите флажок для разрешения **access_as_user**, если он еще не установлен. При необходимости используйте поле поиска.
    1. Нажмите кнопку **Add permissions** (Добавить разрешения).

### <a name="configure-your-project"></a>Настройка проекта

Чтобы настроить проект TodoListClient, выполните следующие действия.

1. На портале **Регистрация приложений** на странице **Обзор** скопируйте значение **идентификатора приложения (клиента)** .

1. В корневой папке проекта TodoListClient откройте файл *app.config* и вставьте значение идентификатора приложения в параметр `ida:ClientId`.

## <a name="run-your-todolistclient-project"></a>Запуск проекта TodoListClient

Чтобы запустить проект TodoListClient, выполните следующие действия.

1. Нажмите клавишу F5, чтобы открыть проект TodoListClient. Должна открыться страница проекта.

1. В верхнем правом углу выберите **Войти** и выполните вход с помощью тех же учетных данных, которые использовались для регистрации приложения, или войдите от имени пользователя в том же каталоге.

   Если вы впервые входите в систему, вам может быть предложено дать согласие на использование веб-API TodoListService.

   Для удобства доступа к веб-API TodoListService и работы со списком *задач* при входе также запрашивается маркер доступа к области *access_as_user*.

## <a name="pre-authorize-your-client-application"></a>Предварительная авторизация клиентского приложения

Пользователям из других каталогов можно предоставить доступ к веб-API различными способами. Один из них — предварительная авторизация клиентского приложения для доступа к веб-API. Это можно сделать, добавив идентификатор приложения из клиентского приложения в список предварительно авторизованных приложений для веб-API. Добавив предварительно авторизованный клиент, вы разрешаете пользователям получать доступ к веб-API без предоставления согласия. Для обеспечения предварительной авторизации клиентского приложения, выполните следующие действия.

1. На портале **Регистрация приложений** откройте свойства приложения TodoListService.
1. В разделе **Предоставление API** в подразделе **Авторизованные клиентские приложения** выберите **Добавить клиентское приложение**.
1. В поле **Идентификатор клиента** вставьте идентификатор приложения TodoListClient.
1. В разделе **Авторизованные области** выберите область для веб-API `api://<Application ID>/access_as_user`.
1. Щелкните **Добавить приложение**.

### <a name="run-your-project"></a>Запуск проекта

1. Нажмите клавишу F5 для запуска проекта. Должно открыться приложение TodoListClient.
1. В правом верхнем углу выберите **Войти**, а затем войдите в систему с помощью личной учетной записи Майкрософт, например live.com или hotmail.com, рабочей или учебной учетной записи.

## <a name="optional-limit-sign-in-access-to-certain-users"></a>Необязательно. Ограничение доступа для входа определенными кругом пользователей

По умолчанию после выполнения предыдущих шагов все личные учетные записи, такие как outlook.com или live.com, а также рабочие или учебные учетные записи из организаций, интегрированных с Azure AD, могут запрашивать маркеры и получать доступ к веб-API.

Чтобы указать круг пользователей, которые могут входить в приложение, используйте один из следующих вариантов:

### <a name="option-1-limit-access-to-a-single-organization-single-tenant"></a>Вариант 1. Ограничение доступа одной организацией (один арендатор)

Вы можете ограничить доступ на вход в приложение, разрешив его только для тех учетных записей пользователей, которые находятся в одном арендаторе Azure AD, в том числе для *гостевых учетных записей* этого арендатора. Это распространенный сценарий для *бизнес-приложений*.

1. Откройте файл *App_Start\Startup.Auth*, а затем измените значение конечной точки метаданных, передаваемое в `OpenIdConnectSecurityTokenProvider`, на `"https://login.microsoftonline.com/{Tenant ID}/v2.0/.well-known/openid-configuration"`. Можно также использовать имя арендатора, например `contoso.onmicrosoft.com`.
2. В том же файле задайте для свойства `ValidIssuer` в `TokenValidationParameters` значение `"https://sts.windows.net/{Tenant ID}/"`, а для аргумента `ValidateIssuer` укажите значение `true`.

### <a name="option-2-use-a-custom-method-to-validate-issuers"></a>Вариант 2. Используйте пользовательский метод для проверки издателей

Пользовательский метод можно реализовать для проверки издателей с помощью параметра `IssuerValidator`. Дополнительные сведения об этом параметре, представлены в описании класса [TokenValidationParameters](/dotnet/api/microsoft.identitymodel.tokens.tokenvalidationparameters?view=azure-dotnet&preserve-view=true).

[!INCLUDE [Help and support](../../../includes/active-directory-develop-help-support-include.md)]

## <a name="next-steps"></a>Дальнейшие действия
Дополнительные сведения о сценарии защищенного веб-API, который поддерживается платформой удостоверений Microsoft:
> [!div class="nextstepaction"]
> [Scenario: Protected web API](scenario-protected-web-api-overview.md) (Сценарий: защищенный веб-API)
