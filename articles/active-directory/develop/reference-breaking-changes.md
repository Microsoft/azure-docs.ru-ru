---
title: Справочник по критическим изменениям Azure Active Directory
description: Дополнительные сведения об изменениях, внесенных в протоколы Azure AD, которые могут повлиять на приложение.
services: active-directory
author: rwike77
manager: CelesteDG
ms.service: active-directory
ms.subservice: develop
ms.workload: identity
ms.topic: reference
ms.date: 2/22/2021
ms.author: ryanwi
ms.reviewer: hirsin
ms.custom: aaddev
ms.openlocfilehash: c5e7f556f37a1d6d53e0a938490f1099a7be776a
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "101647427"
---
# <a name="whats-new-for-authentication"></a>Новые возможности для проверки подлинности.

> Получите уведомления об обновлениях этой страницы, вставляя этот URL-адрес в модуль чтения RSS.<br/>`https://docs.microsoft.com/api/search/rss?search=%22whats%20new%20for%20authentication%22&locale=en-us`

Система проверки подлинности изменяет и добавляет функции на постоянной основе для безопасности и соответствия стандартам. Чтобы оставаться в курсе последних разработок, в этой статье содержатся сведения о следующих деталях.

- Новые возможности
- Известные проблемы
- Изменения протокола
- Нерекомендуемые функции

> [!TIP]
> Эта страница обновляется регулярно, поэтому нужно часто пересматривать ее. Если иное не указано, эти изменения вводятся только для приложений, зарегистрированных после вступления в силу соответствующих изменений.

## <a name="upcoming-changes"></a>Предстоящие изменения

### <a name="conditional-access-will-only-trigger-for-explicitly-requested-scopes"></a>Условный доступ будет срабатывать только для явно запрошенных областей

**Дата вступления в силу**: 2021 марта

**Затронутые конечные точки**: v 2.0

**Затронутый протокол**: все потоки, использующие [динамическое согласие](v2-permissions-and-consent.md#requesting-individual-user-consent)

В настоящее время приложения, использующие динамическое согласие, получают все разрешения, для которых они имеют согласие, даже если они не были запрошены в `scope` параметре по имени.  Это может привести к тому, что приложение, запрашивающее `user.read` , например, только, но с согласия `files.read` , будет вынуждено передать условный доступ, назначенный данному `files.read` разрешению. 

Чтобы сократить количество ненужных запросов условного доступа, Azure AD изменяет способ, которым незапрошенные области предоставляются приложениям, чтобы только явно запрошенные области активировали условный доступ. Это изменение может привести к тому, что приложения, зависящие от предыдущего поведения в Azure AD (а именно, предоставляя все разрешения, даже если они не были запрошены), будут прерываться, так как у запрашиваемых токенов отсутствуют разрешения.

Приложения теперь получают маркеры доступа с набором разрешений в этом запросе, а также те, у которых они имеют согласие на это, не требующие запросов условного доступа.  Области маркера доступа отражаются в параметре ответа токена `scope` . 

**Примеры**

Приложение имеет согласие на `user.read` , `files.readwrite` и `tasks.read` . `files.readwrite` к этому применены политики условного доступа, а другие два — нет. Если приложение выполняет запрос маркера `scope=user.read` , а текущий пользователь, выполнивший вход, не прошел какие-либо политики условного доступа, полученный маркер будет иметь `user.read` `tasks.read` разрешения и. `tasks.read` включен, так как приложение имеет согласие на это, и для него не требуется применение политики условного доступа. 

Если приложение запрашивает `scope=files.readwrite` , активируется условный доступ, требуемый клиентом, что позволяет приложению отображать интерактивную запрос проверки подлинности, где может быть удовлетворена политика условного доступа.  Возвращенный токен будет содержать все три области. 

Если после этого приложение выполняет один последний запрос для любой из трех областей (скажем, `scope=tasks.read` ), Azure AD увидит, что пользователь уже выполнил политики условного доступа, необходимые для `files.readwrite` , и снова выдаст маркер со всеми тремя разрешениями. 


## <a name="may-2020"></a>Май 2020 г.

### <a name="azure-government-endpoints-are-changing"></a>Изменения конечных точек Azure для государственных организаций

**Дата вступления в силу**: 5 мая (окончание июня 2020) 

**Затронутые конечные точки**: все

**Затронутый протокол**: все потоки

В 1 июня 2018 г. Официальный центр Azure Active Directory (AAD) для государственных организаций Azure изменился с `https://login-us.microsoftonline.com` на `https://login.microsoftonline.us` . Это изменение также применяется к Microsoft 365 GCC High и DoD, в которых службы Azure для государственных организаций AAD также являются службами. Если вы владеете приложением в клиенте правительства США, необходимо обновить приложение для входа пользователей в учетную `.us` точку.  

Начиная с 5 мая, Azure AD начнет принудительно изменять конечную точку, блокируя правительственные пользователи для входа в приложения, размещенные в клиентах для государственных организаций США, с помощью общедоступной конечной точки ( `microsoftonline.com` ).  Затронутые приложения будут видеть ошибку `AADSTS900439`  -  `USGClientNotSupportedOnPublicEndpoint` . Эта ошибка означает, что приложение пытается войти в систему для государственных организаций США в конечной точке общедоступного облака. Если приложение находится в общедоступном облачном клиенте и предназначено для поддержки пользователей государственных организаций США, необходимо [обновить приложение для их поддержки явным образом](./authentication-national-cloud.md). Для этого может потребоваться создать регистрацию приложения в облаке для государственных организаций США. 

Принудительное применение этого изменения будет выполняться с помощью постепенного развертывания на основе того, как часто пользователи из облака правительства США подписываются в приложения для государственных организаций США. в первую очередь будет рассмотрено принудительное применение, и приложения, часто используемые пользователями правительства США, будут иметь возможность применить принудительное применение. Мы планируем обеспечить выполнение принудительного применения во всех приложениях в июне 2020. 

Дополнительные сведения см. в записи [блога Azure для государственных организаций по этой миграции](https://devblogs.microsoft.com/azuregov/azure-government-aad-authority-endpoint-update/). 

## <a name="march-2020"></a>Март 2020 г.

### <a name="user-passwords-will-be-restricted-to-256-characters"></a>Пароли пользователей будут ограничены 256 символами.

**Дата вступления в силу** 13 марта 2020 г.

**Затронутые конечные точки**: все

**Затронутый протокол**: все потоки пользователя.

Пользователи с паролями длиннее 256 символов, которые входят непосредственно в Azure AD (в отличие от федеративных IDP, таких как ADFS), не смогут войти в систему с 13 марта 2020 и запросят сбросить пароль.  Администраторы могут получить запросы, чтобы помочь сбросить пароль пользователя.

Ошибка в журналах входа будет ААДСТС 50052: Инвалидпассвордексцеедсмаксленгс

Сообщение: `The password entered exceeds the maximum length of 256. Please reach out to your admin to reset the password.`

Исправление.

Пользователю не удается выполнить вход, так как длина его пароля превышает максимально допустимую. Они должны обратиться к администратору, чтобы сбросить пароль. Если для клиента включен SSPR, они могут сбросить свой пароль, следуя ссылке "Забыли пароль".



## <a name="february-2020"></a>Февраль 2020 г.

### <a name="empty-fragments-will-be-appended-to-every-http-redirect-from-the-login-endpoint"></a>К каждому перенаправлению HTTP из конечной точки входа будут добавлены пустые фрагменты.

**Дата вступления в силу** 8 февраля 2020 г.

**Затронутые конечные точки**: версии 1.0 и 2.0.

**Затронутый протокол**: в потоках OAuth и OIDC, использующих response_type = Query, в некоторых случаях используется [поток кода авторизации](v2-oauth2-auth-code-flow.md) и [неявный поток](v2-oauth2-implicit-grant-flow.md).

Когда ответ на проверку подлинности отправляется из login.microsoftonline.com в приложение через перенаправление HTTP, служба Добавляет пустой фрагмент в URL-адрес ответа.  Это не позволяет классу атак перенаправления, гарантируя, что браузер очищает любой существующий фрагмент в запросе проверки подлинности.  Никакие приложения не должны иметь зависимости от этого поведения.


## <a name="august-2019"></a>Август 2019 г.

### <a name="post-form-semantics-will-be-enforced-more-strictly---spaces-and-quotes-will-be-ignored"></a>Семантика отправки формы будет требовать более строгого пробела, а кавычки будут пропущены.

**Дата вступления в силу** 2 сентября 2019 г.

**Затронутые конечные точки**: версии 1.0 и 2.0.

**Затронутый протокол**: используется повсеместная запись ([учетные данные клиента](./v2-oauth2-client-creds-grant-flow.md), [код авторизации активации](./v2-oauth2-auth-code-flow.md), [ропк](./v2-oauth-ropc.md), [OBO](./v2-oauth2-on-behalf-of-flow.md)и активация [токена обновления](./v2-oauth2-auth-code-flow.md#refresh-the-access-token)).

Начиная с 9/2 недели, запросы проверки подлинности, использующие метод POST, будут проверены с использованием более длинных стандартов HTTP.  В частности, пробелы и двойные кавычки (") больше не будут удаляться из значений формы запроса. Эти изменения не приводят к нарушению работы существующих клиентов и гарантируют, что запросы, отправляемые в Azure AD, будут надежно обрабатываться каждый раз. В будущем (см. выше) мы планируем дополнительно отклонить дублирующиеся параметры и игнорировать СПЕЦИФИКАЦИю в запросах.

Пример

В настоящее время `?e=    "f"&g=h` синтаксический анализ выполняется так же, как `?e=f&g=h` и `e`  ==  `f` .  После этого изменения он будет проанализирован таким образом, что `e`  ==  `    "f"` это вряд ли будет допустимым аргументом, и запрос теперь завершится ошибкой.


## <a name="july-2019"></a>Июль 2019 г.

### <a name="app-only-tokens-for-single-tenant-applications-are-only-issued-if-the-client-app-exists-in-the-resource-tenant"></a>Маркеры только для приложения для приложений с одним клиентом выдаются только в том случае, если клиентское приложение существует в клиенте ресурса.

**Дата вступления в силу** 26 июля 2019 г.

**Затронутые конечные точки**: [v 1.0](../azuread-dev/v1-oauth2-client-creds-grant-flow.md) и [v 2.0](./v2-oauth2-client-creds-grant-flow.md)

**Затронутый протокол**: [учетные данные клиента (токены только для приложения)](../azuread-dev/v1-oauth2-client-creds-grant-flow.md)

Изменена безопасность, 26th июля, которая изменяет способ выдачи маркеров, доступных только для приложений (через предоставление учетных данных клиента). Ранее приложениям было разрешено получать маркеры для вызова любого другого приложения независимо от наличия в клиенте или ролях, которые были предоставлены для этого приложения.  Это поведение было обновлено таким образом, чтобы для ресурсов (иногда называемых веб-интерфейсами API) был установлен режим "один клиент" (по умолчанию), клиентское приложение должно существовать в клиенте ресурса.  Обратите внимание, что существующее согласие между клиентом и API по-прежнему не требуется, и приложения должны выполнять собственные проверки авторизации, чтобы убедиться в `roles` наличии утверждения и содержать ожидаемое значение для API.

В настоящее время сообщение об ошибке для этого сценария указывает на следующее:

`The service principal named <appName> was not found in the tenant named <tenant_name>. This can happen if the application has not been installed by the administrator of the tenant.`

Чтобы устранить эту проблему, используйте интерфейс предоставления согласия администратора для создания субъекта-службы клиентского приложения в клиенте или создайте его вручную.  Это требование гарантирует, что клиент предоставил приложению разрешение на работу в клиенте.

#### <a name="example-request"></a>Пример запроса

`https://login.microsoftonline.com/contoso.com/oauth2/authorize?resource=https://gateway.contoso.com/api&response_type=token&client_id=14c88eee-b3e2-4bb0-9233-f5e3053b3a28&...` В этом примере клиент ресурсов (центр) — это contoso.com, а приложение ресурсов — это приложение с одним клиентом, которое вызывается `gateway.contoso.com/api` для клиента Contoso, а клиентское приложение — `14c88eee-b3e2-4bb0-9233-f5e3053b3a28` .  Если у клиентского приложения есть субъект-служба в Contoso.com, этот запрос может быть продолжен.  Однако если это не так, запрос завершится с ошибкой, описанной выше.

Однако если приложение шлюза Contoso было приложением с несколькими клиентами, то запрос будет продолжать работать независимо от клиентского приложения с субъектом-службой в Contoso.com.

### <a name="redirect-uris-can-now-contain-query-string-parameters"></a>URI перенаправления теперь могут содержать параметры строки запроса

**Дата вступления в силу** 22 июля 2019 г.

**Затронутые конечные точки**: версии 1.0 и 2.0.

**Затронутый протокол**: все потоки

В соответствии с [RFC 6749](https://tools.ietf.org/html/rfc6749#section-3.1.2)приложения Azure AD теперь могут регистрировать и использовать URI перенаправления (ответ) со статическими параметрами запроса (например, `https://contoso.com/oauth2?idp=microsoft` ) для запросов OAuth 2,0.  Динамические URI перенаправления по-прежнему запрещены, так как они представляют угрозу безопасности, и не могут использоваться для сохранения сведений о состоянии в запросе на проверку подлинности. для этого используется `state` параметр.

Параметр статического запроса подлежит совпадению строк для URI перенаправления, как и любая другая часть URI перенаправления. Если ни одна строка не зарегистрирована, соответствующая декодированной redirect_uri URI, запрос будет отклонен.  Если URI найден в регистрации приложения, то для перенаправления пользователя будет использоваться вся строка, включая параметр статического запроса.

Обратите внимание, что в настоящее время (окончание июля 2019) пользовательский интерфейс регистрации приложений в портал Azure все еще блокирует параметры запроса.  Однако можно изменить манифест приложения вручную, чтобы добавить параметры запроса и проверить это в приложении.


## <a name="march-2019"></a>Март 2019 г.

### <a name="looping-clients-will-be-interrupted"></a>Циклическое выполнение клиентов будет прервано

**Дата вступления в силу** 25 марта 2019 г.

**Затронутые конечные точки**: версии 1.0 и 2.0.

**Затронутый протокол**: все потоки

Иногда клиентские приложения могут вести себя некорректно, выдавая сотни одинаковых запросов на вход в течение короткого периода времени.  Эти запросы могут быть неуспешными, но все они способствуют снижению пользовательского интерфейса и повышенной рабочей нагрузке для IDP, увеличению задержки для всех пользователей и уменьшению доступности IDP.  Эти приложения работают вне границ обычного использования и должны быть обновлены для правильной работы.

Клиенты, которые выдают дублирующиеся запросы несколько раз, будут отправлять `invalid_grant` сообщение об ошибке: `AADSTS50196: The server terminated an operation because it encountered a loop while processing a request` .

Большинству клиентов не нужно изменять поведение, чтобы избежать этой ошибки.  Эта ошибка может повлиять только на неправильно настроенные клиенты (без кэширования маркеров или с помощью таких циклов запросов).  Клиенты отправляются локально (через файл cookie) на основе каждого экземпляра по следующим факторам:

* Подсказка пользователя, если таковая имеется

* Области или запрашиваемый ресурс

* Идентификатор клиента

* URI перенаправления

* Тип и режим ответа

Приложения, выполняющие несколько запросов (более 15) в течение короткого периода времени (5 минут), получат `invalid_grant` сообщение об ошибке, объясняющее, что они находятся в цикле.  Запрашиваемые токены имеют достаточно длительное время существования (по умолчанию 10 минут, 60 минут), поэтому повторяющиеся запросы за этот период времени не нужны.

Все приложения должны работать `invalid_grant` , отображая Интерактивные запросы, а не запрашивать маркер автоматически.  Чтобы избежать этой ошибки, клиенты должны убедиться в том, что они правильно кэшируют маркеры, которые они получают.


## <a name="october-2018"></a>Октябрь 2018 г.

### <a name="authorization-codes-can-no-longer-be-reused"></a>Коды авторизации больше нельзя использовать повторно

**Дата вступления в силу**: 15 ноября 2018 г.

**Затронутые конечные точки**: версии 1.0 и 2.0.

**Затронутый протокол**: [поток кода](v2-oauth2-auth-code-flow.md).

С 15 ноября 2018 г. в Azure AD прекращается поддержка использованных кодов аутентификации для приложений. Это изменение системы безопасности помогает Azure AD соответствовать спецификации OAuth и будет применяться для конечных точек версии 1 и 2.

Если ваше приложение повторно использует коды проверки подлинности для получения маркеров для нескольких ресурсов, мы рекомендуем использовать код для получения маркера обновления, а затем использовать этот маркер для получения дополнительных маркеров для других ресурсов. Коды проверки подлинности можно использовать только один раз, однако маркеры обновления можно использовать несколько раз для нескольких ресурсов. Любое новое приложение, которое пытается повторно использовать код проверки подлинности во время потока кода OAuth, получит ошибку invalid_grant.

Дополнительные сведения о маркерах обновления см. в статье [Обновление маркеров доступа](v2-oauth2-auth-code-flow.md#refresh-the-access-token).  При использовании ADAL или MSAL обработку выполняет библиотека — замените второй экземпляр AcquireTokenByAuthorizationCodeAsync на AcquireTokenSilentAsync.

## <a name="may-2018"></a>Май 2018 г.

### <a name="id-tokens-cannot-be-used-for-the-obo-flow"></a>Для потока OBO нельзя использовать маркеры идентификации

**Дата**: 1 мая 2018 г.

**Затронутые конечные точки**: версии 1.0 и 2.0.

**Затронутые протоколы**: неявный поток и поток "от [имени](v2-oauth2-on-behalf-of-flow.md) "

Начиная с 1 мая 2018 г. новые приложения не могут использовать маркеры id_token в качестве утверждения в потоке OBO. Вместо этого следует использовать маркеры доступа для защиты API, даже между клиентом и средним уровнем того же приложения. Приложения, зарегистрированные до 1 мая 2018 г., будут дальше работать с возможностью замены маркеров id_token на маркеры доступа, но это нерекомендуемый подход.

Чтобы обойти это изменение, можно сделать следующее.

1. Создайте веб-API для приложения с одной или несколькими областями. Такая явная точка входа позволит обеспечить более точный контроль и защиту.
1. В манифесте вашего приложения, на [портале Azure](https://portal.azure.com) или [портале регистрации приложений](https://apps.dev.microsoft.com), убедитесь, что приложению разрешено выдавать маркеры доступа через неявный поток. Это определяется с помощью ключа `oauth2AllowImplicitFlow`.
1. Когда клиентское приложение запрашивает id_token через `response_type=id_token` , также запросите маркер доступа ( `response_type=token` ) для созданного ранее веб-API. Таким образом при использовании конечной точки версии 2.0 параметр `scope` должен выглядеть примерно так: `api://GUID/SCOPE`. В конечной точке версии 1.0 параметр `resource` должен быть универсальным кодом ресурса (URI) приложения веб-API.
1. Передайте этот маркер доступа на средний уровень вместо id_token.
