---
title: Как включить единый вход между приложениями в Android с помощью MSAL | Службы
titleSuffix: Microsoft identity platform
description: Использование библиотеки проверки подлинности Майкрософт (MSAL) для Android для включения единого входа в приложениях.
services: active-directory
author: hamiltonha
manager: CelesteDG
ms.service: active-directory
ms.subservice: develop
ms.workload: identity
ms.tgt_pltfrm: android
ms.devlang: java
ms.topic: how-to
ms.date: 10/15/2020
ms.author: hahamil
ms.reviewer: marsma
ms.openlocfilehash: c4c98ad377100c35b0c364607bfd3803d07a95a7
ms.sourcegitcommit: 42a4d0e8fa84609bec0f6c241abe1c20036b9575
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "98015935"
---
# <a name="how-to-enable-cross-app-sso-on-android-using-msal"></a>Как включить единый вход между приложениями в Android с помощью MSAL

Единый вход (SSO) позволяет пользователям вводить учетные данные только один раз, и эти учетные данные автоматически работают в разных приложениях.

[Платформа удостоверений Майкрософт](./index.yml) и библиотека проверки подлинности Майкрософт (MSAL) помогают включить единый вход в своем наборе приложений. Используя возможности брокера и приложения проверки подлинности, вы можете расширить единый вход на всем устройстве.

В этом пошаговом окне вы узнаете, как настроить пакеты SDK, используемые приложением для предоставления единого входа клиентам.

## <a name="prerequisites"></a>Предварительные требования

В этом способе предполагается, что вы умеете:

- Подготавливаете приложение с помощью портал Azure. Дополнительные сведения по этой теме см. в руководстве по созданию приложения в [учебнике по Android](./tutorial-v2-android.md#create-a-project) .
- Интегрируйте приложение с помощью [библиотеки проверки подлинности Майкрософт для Android](https://github.com/AzureAD/microsoft-authentication-library-for-android).

## <a name="methods-for-single-sign-on"></a>Методы единого входа

Существует два способа применения единого входа для приложений, использующих MSAL для Android:

* Через [приложение брокера](#sso-through-brokered-authentication)
* Через [системный браузер](#sso-through-system-browser)


   Рекомендуется использовать приложение брокера для таких преимуществ, как единый вход на уровне устройства, Управление учетными записями и условный доступ. Однако для этого требуется, чтобы пользователи загружали дополнительные приложения.

## <a name="sso-through-brokered-authentication"></a>Единый вход с помощью проверки подлинности через посредника

Мы рекомендуем использовать один из брокеров проверки подлинности Майкрософт для участия в программе единого входа (SSO) на уровне устройства и в соответствии с политиками условного доступа Организации. Интеграция с брокером обеспечивает следующие преимущества:

- Единый вход устройства
- Условный доступ для:
  - Защита приложений Intune
  - Регистрация устройства (Workplace Join)
  - Управление мобильными устройствами
- Управление учетными записями на уровне устройства
  -  через Android AccountManager & параметры учетной записи
  - "Рабочая учетная запись" — настраиваемый тип учетной записи

В Android брокер проверки подлинности (Майкрософт) является компонентом, включенным в [Microsoft Authenticator](https://play.google.com/store/apps/details?id=com.azure.authenticator) и [Корпоративный портал Intune](https://play.google.com/store/apps/details?id=com.microsoft.windowsintune.companyportal) приложения.

На следующей схеме показана связь между приложением, библиотекой проверки подлинности Майкрософт (MSAL) и брокерами проверки подлинности Майкрософт.

![Схема, на которой показано, как приложение связывается с MSAL, приложениями брокера и диспетчером учетных записей Android.](./media/brokered-auth/brokered-deployment-diagram.png)

### <a name="installing-apps-that-host-a-broker"></a>Установка приложений, на которых размещается брокер

Приложения, размещенные в брокере, могут быть установлены владельцем устройства из своего магазина приложений (обычно Google Play Маркет) в любое время. Однако некоторые интерфейсы API (Resources) защищены политиками условного доступа, для которых требуется, чтобы устройства были:

- Зарегистрировано (присоединено к рабочему месту) и (или)
- Зарегистрировано в управлении устройствами или
- Зарегистрировано в Защита приложений Intune

Если на устройстве еще не установлено приложение брокера, MSAL предписывает пользователю установить его, как только приложение попытается получить маркер в интерактивном режиме. После этого приложение потребует от пользователя выполнить шаги, чтобы сделать устройство совместимым с требуемой политикой.

### <a name="effects-of-installing-and-uninstalling-a-broker"></a>Последствия установки и удаления брокера

#### <a name="when-a-broker-is-installed"></a>При установке брокера

При установке брокера на устройстве все последующие запросы интерактивных маркеров (вызовы `acquireToken()` ) обрабатываются брокером, а не локально с помощью MSAL. Любое состояние SSO, ранее доступное MSAL, недоступно брокеру. В результате пользователь должен снова пройти проверку подлинности или выбрать учетную запись из существующего списка учетных записей, известных устройству.

Установка брокера не требует от пользователя повторного входа. Только когда пользователь должен разрешить, `MsalUiRequiredException` будет отправлен следующий запрос к брокеру. `MsalUiRequiredException` может вызываться по нескольким причинам и должно быть разрешено в интерактивном режиме. Пример:

- Пользователь изменил пароль, связанный с учетной записью.
- Учетная запись пользователя больше не соответствует политике условного доступа.
- Пользователь отозвал согласие на то, что приложение будет связано с учетной записью.

**Несколько посредников** . Если на устройстве установлено несколько брокеров, брокер, который был установлен первым, всегда является активным брокером. На устройстве может быть активным только один компонент Service Broker.

#### <a name="when-a-broker-is-uninstalled"></a>При удалении брокера

Если установлено только одно приложение размещения брокера и оно удаляется, пользователю потребуется снова войти в систему. При удалении активного брокера учетная запись и связанные с ним токены удаляются с устройства.

Если Корпоративный портал Intune установлен и работает как активный брокер, а Microsoft Authenticator также установлен, то при удалении Корпоративный портал Intune (Active Broker) пользователю потребуется снова войти в систему. После повторного входа в приложение Microsoft Authenticator станет активным брокером.

### <a name="integrating-with-a-broker"></a>Интеграция с брокером

#### <a name="generate-a-redirect-uri-for-a-broker"></a>Создание URI перенаправления для брокера

Необходимо зарегистрировать URI перенаправления, совместимый с брокером. URI перенаправления для брокера должен включать имя пакета приложения и представление подписи приложения в кодировке Base64.

Формат URI перенаправления: `msauth://<yourpackagename>/<base64urlencodedsignature>`

Вы можете использовать [keytool](https://manpages.debian.org/buster/openjdk-11-jre-headless/keytool.1.en.html) для создания хэша подписи в кодировке Base64 с помощью ключей подписывания приложения, а затем использовать портал Azure для создания URI перенаправления с помощью этого хэша.

Linux и macOS:

```bash
keytool -exportcert -alias androiddebugkey -keystore ~/.android/debug.keystore | openssl sha1 -binary | openssl base64
```

Windows:

```powershell
keytool -exportcert -alias androiddebugkey -keystore %HOMEPATH%\.android\debug.keystore | openssl sha1 -binary | openssl base64
```

После создания хэша подписи с помощью *keytool* используйте портал Azure, чтобы создать URI перенаправления:

1. Войдите в <a href="https://portal.azure.com/" target="_blank">портал Azure <span class="docon docon-navigate-external x-hidden-focus"></span></a> и выберите приложение Android в **Регистрация приложений**.
1. Выберите **Проверка подлинности**  >  **Добавить платформу**  >  **Android**.
1. В открывшейся области **Настройка приложения Android** введите созданный ранее **хэш подписи** и **имя пакета**.
1. Нажмите кнопку **настроить** .

Портал Azure создает URI перенаправления и отображает его в поле **URI перенаправления** в области **конфигурации Android** .

Дополнительные сведения о подписывании приложения см. в разделе [Знакомство](https://developer.android.com/studio/publish/app-signing) с приложением Android Studio пользователя.

> [!IMPORTANT]
> Используйте рабочий ключ подписывания для рабочей версии приложения.

#### <a name="configure-msal-to-use-a-broker"></a>Настройка MSAL для использования брокера

Чтобы использовать брокер в приложении, необходимо подтвердить, что вы настроили перенаправление брокера. Например, включите оба URI перенаправления с включенным брокером и укажите, что вы зарегистрировали его, включив в файл конфигурации MSAL следующие параметры:

```json
"redirect_uri" : "<yourbrokerredirecturi>",
"broker_redirect_uri_registered": true
```

#### <a name="broker-related-exceptions"></a>Исключения, связанные с брокером

MSAL взаимодействует с брокером двумя способами:

- Служба, привязанная к брокеру
- AccountManager Android

Сначала MSAL использует привязанную к брокеру службу, так как для вызова этой службы не требуются разрешения Android. При сбое привязки к привязанной службе MSAL будет использовать API AccountManager для Android. MSAL делает это только в том случае, если приложению уже предоставлено `"READ_CONTACTS"` разрешение.

Если получен `MsalClientException` код ошибки `"BROKER_BIND_FAILURE"` , есть два варианта:

- Попросите пользователя отключить Энергосбережение для приложения Microsoft Authenticator и Корпоративный портал Intune.
- Попросите пользователя предоставить `"READ_CONTACTS"` разрешение

### <a name="verify-broker-integration"></a>Проверка интеграции брокера

Возможно, не будет немедленно ясно, что интеграция компонента Service Broker работает, но можно выполнить следующие действия для проверки:

1. На устройстве Android выполните запрос с помощью брокера.
1. В параметрах на устройстве Android найдите только что созданную учетную запись, соответствующую учетной записи, с помощью которой была выполнена проверка подлинности. Учетная запись должна иметь тип " *Рабочая учетная запись*".

Вы можете удалить учетную запись из параметров, если хотите повторить тест.

## <a name="sso-through-system-browser"></a>Единый вход через браузер системы

Приложения Android позволяют использовать WebView, системный браузер или пользовательские вкладки Chrome для проверки подлинности пользователей. Если приложение не использует аутентификацию через посредника, для обеспечения единого входа необходимо использовать системный браузер, а не собственный WebView.

### <a name="authorization-agents"></a>Агенты авторизации

Выбор конкретной стратегии для агентов авторизации является необязательным и представляет дополнительные функциональные возможности, которые могут быть настроены для приложений. Большинство приложений будут использовать значения по умолчанию MSAL (см. раздел [Знакомство с файлом конфигурации Android MSAL](msal-configuration.md) для просмотра различных значений по умолчанию).

MSAL поддерживает авторизацию с помощью `WebView` или системного браузера.  На рисунке ниже показано, как он выглядит с помощью `WebView` , или системного браузера с кустомтабс или без кустомтабс:

![Примеры входа в MSAL](./media/authorization-agents/sign-in-ui.jpg)

### <a name="single-sign-on-implications"></a>Последствия единого входа

По умолчанию приложения, интегрированные с MSAL, используют пользовательские вкладки системного браузера для авторизации. В отличие от веб-представлений, пользовательские вкладки совместно используют файл cookie с системным браузером по умолчанию, что позволяет сократить число входов в систему или другие собственные приложения, интегрированные с пользовательскими вкладками.

Если приложение использует `WebView` стратегию без интеграции Microsoft Authenticator или корпоративный портал поддержки в свое приложение, пользователи не смогут использовать единый вход на устройстве или между собственными приложениями и веб-приложениями.

Если приложение использует MSAL с брокером, например Microsoft Authenticator или Корпоративный портал Intune, то пользователи могут иметь возможность единого входа в приложениях, если у них есть активный вход с одним из приложений.

### <a name="webview"></a>WebView

Чтобы использовать WebView в приложении, добавьте следующую строку в JSON-конфигурацию приложения, которая передается в MSAL:

```json
"authorization_user_agent" : "WEBVIEW"
```

При использовании в приложении `WebView` пользователь входит непосредственно в приложение. Токены хранятся в песочнице приложения и не доступны вне JAR-файла приложения. В результате у пользователя не может быть единого входа в приложениях, если только приложения не интегрируются с приложением проверки подлинности или корпоративный портал.

Однако `WebView` предоставляет возможность настройки внешнего вида и поведения пользовательского интерфейса входа. Дополнительные сведения о том, как выполнить эту настройку, см. в статье о [просмотре в Android](https://developer.android.com/reference/android/webkit/WebView) .

### <a name="default-browser-plus-custom-tabs"></a>Браузер по умолчанию плюс пользовательские вкладки

По умолчанию MSAL использует браузер и [настраиваемую стратегию вкладок](https://developer.chrome.com/multidevice/android/customtabs) . Можно явно указать эту стратегию, чтобы предотвратить изменения в будущих выпусках с `DEFAULT` помощью следующей конфигурации JSON в файле настраиваемой конфигурации:

```json
"authorization_user_agent" : "BROWSER"
```

Используйте этот подход для предоставления единого входа через браузер устройства. MSAL использует общий JAR-файл файла cookie, который позволяет другим собственным приложениям или веб приложениям достигать единого входа на устройстве с помощью файла cookie хранимого сеанса, установленного MSAL.

### <a name="browser-selection-heuristic"></a>Эвристика выбора браузера

Так как MSAL не может указать точный пакет браузера для использования на каждом из широкого спектра телефонов Android, MSAL реализует эвристику выбора браузера, которая пытается предоставить лучшее единый вход между устройствами.

MSAL в основном извлекает браузер по умолчанию из диспетчера пакетов и проверяет, находится ли он в проверенном списке безнадежных браузеров. В противном случае MSAL перейдет к использованию WebView вместо того, чтобы запускать другой браузер, отличный от используемого по умолчанию, из списка надежных. Браузер по умолчанию будет выбран независимо от того, поддерживает ли он пользовательские вкладки. Если браузер поддерживает пользовательские вкладки, MSAL запустит пользовательскую вкладку. пользовательские вкладки выглядят ближе к приложению в приложении `WebView` и позволяют выполнять базовую настройку пользовательского интерфейса. Дополнительные сведения см. в статье [пользовательские вкладки в Android](https://developer.chrome.com/multidevice/android/customtabs) .

Если на устройстве нет пакетов браузера, MSAL использует в приложении `WebView` . Если параметр устройства по умолчанию не изменяется, для каждого входа необходимо запустить тот же браузер, чтобы обеспечить единый вход.

#### <a name="tested-browsers"></a>Протестированные браузеры

Следующие браузеры протестировали, чтобы убедиться, что они правильно перенаправлены к `"redirect_uri"` указанному в файле конфигурации:

| Устройство | Встроенный браузер | Chrome | Opera  | Microsoft Edge | Браузер UC | Firefox |
| -- |:-------------:| -----:|-----:|-----:|-----:|-----:|
| Хранилища 4 (API 17) | pass | pass |Неприменимо |Неприменимо |Неприменимо |Неприменимо |
| Samsung S7 (API 25) | <sup>1</sup> проход | pass | pass | pass | fail |pass |
| Huawei (API 26) |<sup>2</sup> прохода | pass | fail | pass | pass |pass |
| VIVO (API 26) |pass|pass|pass|pass|pass|fail|
| Пиксель 2 (API 26) |pass | pass | pass | pass | fail |pass |
| Oppo | pass | не применимо<sup>3</sup>|Неприменимо  |Неприменимо |Неприменимо | Неприменимо|
| Онеплус (API 25) |pass | pass | pass | pass | fail |pass |
| Хранилища (API 28) |pass | pass | pass | pass | fail |pass |
|MI | pass | pass | pass | pass | fail |pass |

<sup>1</sup> Встроенным браузером Samsung является Samsung Internet.<br/>
<sup>2</sup> Встроенным браузером Huawei является браузер Huawei.<br/>
<sup>3</sup> Браузер по умолчанию нельзя изменить в параметре устройства Oppo.

## <a name="next-steps"></a>Дальнейшие действия

[Режим общего устройства для устройств Android](msal-android-shared-devices.md) позволяет настроить устройство Android таким образом, чтобы его можно было легко предоставить нескольким сотрудникам.