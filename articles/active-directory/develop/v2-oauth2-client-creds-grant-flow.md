---
title: Поток учетных данных клиента OAuth 2,0 на платформе Microsoft Identity | Службы
description: Создавайте веб-приложения с помощью реализации протокола проверки подлинности OAuth 2,0 на платформе Microsoft Identity.
services: active-directory
author: hpsin
manager: CelesteDG
ms.service: active-directory
ms.subservice: develop
ms.workload: identity
ms.topic: conceptual
ms.date: 10/2/2020
ms.author: hirsin
ms.reviewer: hirsin
ms.custom: aaddev, identityplatformtop40
ms.openlocfilehash: 96f7d7c94ce908d953a6941bfa237fe8da1dc482
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "98752663"
---
# <a name="microsoft-identity-platform-and-the-oauth-20-client-credentials-flow"></a>Платформа удостоверений Майкрософт и поток учетных данных клиента OAuth 2,0

[Предоставление учетных данных клиента OAuth 2.0](https://tools.ietf.org/html/rfc6749#section-4.4), указанное в спецификации RFC 6749, которое иногда называют также *двусторонним OAuth*, можно использовать для доступа к интернет-ресурсам с помощью удостоверения приложения. Этот тип предоставления разрешения часто используется для взаимодействия между серверами, которое должно выполняться в фоновом режиме без непосредственного взаимодействия с пользователем. Эти типы приложений часто называются *управляющими* программами или *учетными записями служб*.

В этой статье описывается, как программировать непосредственно в протокол в приложении. По возможности рекомендуется использовать поддерживаемые библиотеки проверки подлинности Майкрософт (MSAL) вместо [получения маркеров и вызова защищенных веб-API](authentication-flows-app-scenarios.md#scenarios-and-supported-authentication-flows).  Также ознакомьтесь с [примерами приложений, которые используют MSAL](sample-v2-code.md).

Поток предоставления учетных данных клиента OAuth 2.0 позволяет веб-службе (конфиденциальному клиенту) при вызове другой веб-службы проходить проверку подлинности с собственными учетными данными, а не олицетворять пользователя. В этом сценарии клиентом обычно является веб-служба среднего уровня, служба управляющей программы или веб-сайт. Для большей надежности платформа удостоверений Майкрософт также позволяет вызывающей службе использовать в качестве учетных данных сертификат (вместо общего секрета).

В потоке учетных данных клиента разрешения предоставляются администратором непосредственно для самого приложения. Когда приложение представляет маркер для ресурса, ресурс применяет к нему разрешение на выполнение действий, так как пользователь не участвует в проверке подлинности.  В этой статье описаны шаги, необходимые для [авторизации приложения для вызова API](#application-permissions), а также [способы получения маркеров, необходимых для вызова этого API](#get-a-token).

## <a name="protocol-diagram"></a>Схема протокола

Весь поток учетных данных клиента аналогичен приведенному на следующей схеме. Каждый из этих шагов мы опишем далее в этой статье.

![Схема, показывающая поток учетных данных клиента](./media/v2-oauth2-client-creds-grant-flow/convergence-scenarios-client-creds.svg)

## <a name="get-direct-authorization"></a>Получение прямой авторизации

Как правило, приложение получает прямую авторизацию на доступ к ресурсу двумя способами:

* [через список управления доступом (ACL) в ресурсе;](#access-control-lists)
* [путем назначения разрешений приложению в Azure AD.](#application-permissions)

Эти два метода являются самыми распространенными в Azure AD, и их рекомендуется использовать для клиентов и ресурсов, применяющих поток учетных данных клиента. Ресурс также может выбрать другой способ авторизации клиентов. Каждый сервер ресурсов может выбрать метод, являющийся наиболее оптимальным для приложения.

### <a name="access-control-lists"></a>Доступ к спискам управления

Поставщик ресурсов может принудительно применять проверку авторизации на основе списка известных идентификаторов приложений (клиента), а также предоставлять определенный уровень доступа на основе этих идентификаторов. Когда ресурс получает токен от платформы Microsoft Identity, он может декодировать маркер и извлечь идентификатор приложения клиента из `appid` `iss` утверждений и. Затем он проверяет наличие приложения в действующем списке управления доступом. Детализация и методы использования списка управления доступом для разных ресурсов могут значительно отличаться.

Нередко список управления доступом используется для выполнения тестов веб-приложения или веб-API. Веб-API может предоставить определенному клиенту только ограниченный набор прав доступа. Чтобы выполнить сквозные тесты в API, создайте тестового клиента, который получает маркеры от платформы Microsoft Identity, а затем отправляет их в API. Затем API может проверить идентификатор приложения тестового клиента с помощью списка управления доступом для предоставления доступа ко всем возможностям API. При использовании такого списка управления доступом нужно не только проверить значение `appid` вызывающей стороны, но и убедиться в надежности значения `iss` маркера.

Данный тип авторизации часто используется в управляющих программах и учетных записях служб, которым требуется доступ к данным пользователей, являющихся потребителями с личной учетной записью Майкрософт. Необходимую авторизацию для доступа к корпоративным данным рекомендуется получать с помощью разрешений приложения.

#### <a name="controlling-tokens-without-the-roles-claim"></a>Управление маркерами без `roles` утверждения

Чтобы включить этот шаблон авторизации на основе ACL, Azure AD не требует, чтобы приложения были авторизованы для получения маркеров для другого приложения. Таким словами, токены только для приложений могут быть выданы без `roles` утверждения. Приложения, которые предоставляют API, должны реализовывать проверки разрешений для принятия маркеров.

Если вы хотите запретить приложениям получать в приложении маркеры доступа только для приложений без ролей, [Убедитесь, что для приложения включены требования к назначению пользователей](../manage-apps/assign-user-or-group-access-portal.md#configure-an-application-to-require-user-assignment). Это позволит пользователям и приложениям без назначенных ролей получить маркер для этого приложения. 

### <a name="application-permissions"></a>Разрешения приложения

Вместо использования списков ACL можно использовать интерфейсы API для предоставления набора **разрешений приложения**. Администратор организации предоставляет приложению разрешения, которые можно использовать только для доступа к данным, принадлежащим этой организации и ее сотрудникам. Например, Microsoft Graph предоставляет несколько разрешений приложений для следующих действий:

* чтение почты во всех почтовых ящиках;
* чтение и запись почты во всех почтовых ящиках;
* отправка почты любым пользователем;
* Чтение данных каталога

Чтобы использовать разрешения приложения с собственным API (в отличие от Microsoft Graph), необходимо сначала [предоставить API](quickstart-configure-app-expose-web-apis.md) , определив области в регистрации приложения API в портал Azure. Затем [Настройте доступ к API](quickstart-configure-app-access-web-apis.md) , выбрав эти разрешения в регистрации приложения клиентского приложения. Если вы не предоставили какие-либо области в регистрации приложения API, вы не сможете указать разрешения приложения для этого API в регистрации приложения клиентского приложения в портал Azure.

При проверке подлинности в качестве приложения (в отличие от пользователя) нельзя использовать *делегированные разрешения* — области, предоставленные пользователем. Необходимо использовать разрешения приложения, также известные как роли, которые предоставляются администратором для приложения или посредством предварительной авторизации веб-API.

Дополнительные сведения о разрешениях приложений см. в разделе [разрешения и согласие](v2-permissions-and-consent.md#permission-types).

#### <a name="recommended-sign-the-user-into-your-app"></a>Рекомендуется: подписывать пользователя в приложении

Обычно при создании приложения, использующего разрешения, для него нужно настроить страницу или представление, в котором администратор может утвердить разрешения приложения. Эта страница может быть частью потока входа в приложение, параметров приложения или выделенного потока подключения. Во многих случаях разумно отображать это представление подключения в приложении только после того, как пользователь выполнил вход с помощью учебной или рабочей учетной записи Майкрософт.

При входе пользователя в приложение можно указать организацию, к которой принадлежит пользователь, прежде чем попросить пользователя подтвердить разрешения приложения. Хотя это не обязательно, таким образом можно сделать пользовательский интерфейс более интуитивно понятным. Чтобы подписать пользователя в, следуйте [учебникам по протоколу платформы удостоверений Microsoft Identity](active-directory-v2-protocols.md).

#### <a name="request-the-permissions-from-a-directory-admin"></a>Запрос разрешений у администратора каталога

Когда вы будете готовы запросить разрешения у администратора организации, вы можете перенаправить пользователя на *конечную точку согласия администратора* платформы удостоверений Майкрософт.

> [!TIP]
> Попытайтесь выполнить этот запрос в Postman. (Для получения лучших результатов используйте собственный идентификатор приложения. приложение Tutorial не запрашивает полезные разрешения.) [ ![ Попробуйте выполнить этот запрос в Post](./media/v2-oauth2-auth-code-flow/runInPostman.png)](https://app.getpostman.com/run-collection/f77994d794bab767596d)

```HTTP
// Line breaks are for legibility only.

GET https://login.microsoftonline.com/{tenant}/adminconsent?
client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&state=12345
&redirect_uri=http://localhost/myapp/permissions
```

Совет по Pro: попробуйте выполнить следующий запрос в браузере.

```
https://login.microsoftonline.com/common/adminconsent?client_id=6731de76-14a6-49ae-97bc-6eba6914391e&state=12345&redirect_uri=http://localhost/myapp/permissions
```

| Параметр | Условие | Описание |
| --- | --- | --- |
| `tenant` | Обязательно | Клиент каталога, из которого необходимо запросить разрешение. Его можно указать в виде GUID или понятного имени. Если неизвестно, какому клиенту относится пользователь, и нужно обеспечить его вход с помощью любого клиента, используйте `common`. |
| `client_id` | Обязательно | **Идентификатор приложения (клиента)** , назначенный вашему приложению функцией [Регистрация приложений портала Azure](https://go.microsoft.com/fwlink/?linkid=2083908). |
| `redirect_uri` | Обязательно | Универсальный код ресурса (URI) перенаправления, на который нужно направлять ответ для обработки в приложении. Он должен в точности соответствовать одному из универсальных кодов ресурсов (URI) перенаправления, зарегистрированных на портале, но иметь вид URL-адреса. Он может содержать дополнительные сегменты пути. |
| `state` | Рекомендуемая | Значение, включенное в запрос, которое также возвращается в ответе маркера. Это может быть строка любого контента. Параметр state используется для кодирования сведений о состоянии пользователя в приложении перед созданием запроса на аутентификацию, например сведений об открытой на тот момент странице или представлении. |

На этом этапе Azure AD применяет, чтобы только администратор клиента мог выполнить запрос. Администратору будет предложено утвердить все непосредственные разрешения, запрошенные для приложения на портале регистрации приложений.

##### <a name="successful-response"></a>Успешный ответ

Если администратор утверждает разрешения для приложения, успешный ответ будет выглядеть следующим образом.

```HTTP
GET http://localhost/myapp/permissions?tenant=a8990e1f-ff32-408a-9f8e-78d3b9139b95&state=state=12345&admin_consent=True
```

| Параметр | Описание |
| --- | --- |
| `tenant` | Клиент каталога, предоставивший приложению запрошенные разрешения в формате GUID. |
| `state` | Значение, добавленное в запрос, которое также возвращается в ответе маркера. Это может быть строка любого контента. Параметр state используется для кодирования сведений о состоянии пользователя в приложении перед созданием запроса на аутентификацию, например сведений об открытой на тот момент странице или представлении. |
| `admin_consent` | Задайте значение **true**. |

##### <a name="error-response"></a>Сообщение об ошибке

Если администратор не утверждает разрешения для приложения, сообщение о неудачном выполнении будет выглядеть следующим образом.

```HTTP
GET http://localhost/myapp/permissions?error=permission_denied&error_description=The+admin+canceled+the+request
```

| Параметр | Описание |
| --- | --- |
| `error` | Строка кода ошибки, которую можно использовать для классификации типов ошибок и реагирования на ошибки. |
| `error_description` | Конкретное сообщение об ошибке, с помощью которого можно определить первопричину возникновения ошибки. |

После получения успешного ответа от конечной точки подготовки приложения приложение получило запрошенные непосредственные разрешения. Теперь вы можете запросить маркер для ресурса, который вам нужен.

## <a name="get-a-token"></a>Получение маркера

Авторизовав приложение, можно переходить к получению маркеров доступа для интерфейсов API. Чтобы получить маркер с помощью предоставления учетных данных клиента, отправьте запрос POST на `/token` платформу Microsoft Identity.

> [!TIP]
> Попытайтесь выполнить этот запрос в Postman. (Для получения лучших результатов используйте собственный идентификатор приложения. приложение Tutorial не запрашивает полезные разрешения.) [ ![ Попробуйте выполнить этот запрос в Post](./media/v2-oauth2-auth-code-flow/runInPostman.png)](https://app.getpostman.com/run-collection/f77994d794bab767596d)

### <a name="first-case-access-token-request-with-a-shared-secret"></a>Первый пример. Запрос маркера доступа по общему секрету

```HTTP
POST /{tenant}/oauth2/v2.0/token HTTP/1.1           //Line breaks for clarity
Host: login.microsoftonline.com
Content-Type: application/x-www-form-urlencoded

client_id=535fb089-9ff3-47b6-9bfb-4f1264799865
&scope=https%3A%2F%2Fgraph.microsoft.com%2F.default
&client_secret=qWgdYAmab0YSkuL1qKv5bPX
&grant_type=client_credentials
```

```Bash
# Replace {tenant} with your tenant!
curl -X POST -H "Content-Type: application/x-www-form-urlencoded" -d 'client_id=535fb089-9ff3-47b6-9bfb-4f1264799865&scope=https%3A%2F%2Fgraph.microsoft.com%2F.default&client_secret=qWgdYAmab0YSkuL1qKv5bPX&grant_type=client_credentials' 'https://login.microsoftonline.com/{tenant}/oauth2/v2.0/token'
```

| Параметр | Условие | Описание |
| --- | --- | --- |
| `tenant` | Обязательно | Клиент каталога, который будет использовать приложение, в формате GUID или доменного имени. |
| `client_id` | Обязательно | Идентификатор приложения, назначенный приложению. Эти сведения можно найти на портале, где вы зарегистрировали свое приложение. |
| `scope` | Обязательно | Значение, передаваемое для параметра `scope` в этом запросе, должно быть идентификатором требуемого ресурса (универсальным кодом ресурса (URI) идентификатора приложения) с суффиксом `.default`. В примере Microsoft Graph используется значение `https://graph.microsoft.com/.default`. <br/>Это значение указывает платформе Microsoft Identity, которая содержит все разрешения, настроенные для приложения, конечная точка должна выдавать маркер для тех, которые связаны с ресурсом, который вы хотите использовать. Дополнительные сведения об области `/.default` можно найти в документации о согласии [здесь](v2-permissions-and-consent.md#the-default-scope). |
| `client_secret` | Обязательно | Секрет клиента, который вы создали для приложения на портале регистрации приложений. Секрет клиента должен быть закодирован в формат URL-адреса перед отправкой. |
| `grant_type` | Обязательно | Нужно задать значение `client_credentials`. |

### <a name="second-case-access-token-request-with-a-certificate"></a>Второй пример. Запрос маркера доступа по сертификату

```HTTP
POST /{tenant}/oauth2/v2.0/token HTTP/1.1               // Line breaks for clarity
Host: login.microsoftonline.com
Content-Type: application/x-www-form-urlencoded

scope=https%3A%2F%2Fgraph.microsoft.com%2F.default
&client_id=97e0a5b7-d745-40b6-94fe-5f77d35c6e05
&client_assertion_type=urn%3Aietf%3Aparams%3Aoauth%3Aclient-assertion-type%3Ajwt-bearer
&client_assertion=eyJhbGciOiJSUzI1NiIsIng1dCI6Imd4OHRHeXN5amNScUtqRlBuZDdSRnd2d1pJMCJ9.eyJ{a lot of characters here}M8U3bSUKKJDEg
&grant_type=client_credentials
```

| Параметр | Условие | Описание |
| --- | --- | --- |
| `tenant` | Обязательно | Клиент каталога, который будет использовать приложение, в формате GUID или доменного имени. |
| `client_id` | Обязательно |Идентификатор приложения (клиента), который назначен приложению. |
| `scope` | Обязательно | Значение, передаваемое для параметра `scope` в этом запросе, должно быть идентификатором требуемого ресурса (универсальным кодом ресурса (URI) идентификатора приложения) с суффиксом `.default`. В примере Microsoft Graph используется значение `https://graph.microsoft.com/.default`. <br/>Это значение информирует платформу Microsoft Identity о том, что все непосредственные разрешения приложений, настроенные для вашего приложения, должны выдать маркер для тех, которые связаны с ресурсом, который вы хотите использовать. Дополнительные сведения об области `/.default` можно найти в документации о согласии [здесь](v2-permissions-and-consent.md#the-default-scope). |
| `client_assertion_type` | Обязательно | Его значением должно быть `urn:ietf:params:oauth:client-assertion-type:jwt-bearer`. |
| `client_assertion` | Обязательно | Утверждение (JSON Web Token), которое необходимо создать и подписать с помощью сертификата, зарегистрированного как учетные данные для приложения. Ознакомьтесь с информацией об [учетных данных сертификата](active-directory-certificate-credentials.md), чтобы узнать, как зарегистрировать сертификат и задать формат утверждения.|
| `grant_type` | Обязательно | Нужно задать значение `client_credentials`. |

Обратите внимание на то, что параметры являются почти такими же, как и при использовании запроса с помощью общего секрета, за исключением параметра client_secret, который заменяется двумя параметрами: client_assertion_type и client_assertion.

### <a name="successful-response"></a>Успешный ответ

Успешный ответ выглядит следующим образом.

```json
{
  "token_type": "Bearer",
  "expires_in": 3599,
  "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik1uQ19WWmNBVGZNNXBP..."
}
```

| Параметр | Описание |
| --- | --- |
| `access_token` | Запрашиваемый маркер доступа. Приложение может использовать этот маркер для проверки подлинности в защищенном ресурсе, например в веб-API. |
| `token_type` | Указывает значение типа маркера. Единственным типом, поддерживаемым платформой Microsoft Identity, является `bearer` . |
| `expires_in` | Срок действия маркера доступа (в секундах). |

### <a name="error-response"></a>Сообщение об ошибке

Сообщение об ошибке выглядит следующим образом.

```json
{
  "error": "invalid_scope",
  "error_description": "AADSTS70011: The provided value for the input parameter 'scope' is not valid. The scope https://foo.microsoft.com/.default is not valid.\r\nTrace ID: 255d1aef-8c98-452f-ac51-23d051240864\r\nCorrelation ID: fb3d2015-bc17-4bb9-bb85-30c5cf1aaaa7\r\nTimestamp: 2016-01-09 02:02:12Z",
  "error_codes": [
    70011
  ],
  "timestamp": "2016-01-09 02:02:12Z",
  "trace_id": "255d1aef-8c98-452f-ac51-23d051240864",
  "correlation_id": "fb3d2015-bc17-4bb9-bb85-30c5cf1aaaa7"
}
```

| Параметр | Описание |
| --- | --- |
| `error` | Строка кода ошибки, которую можно использовать для классификации типов возникших ошибок и реагирования на них. |
| `error_description` | Конкретное сообщение об ошибке, с помощью которого можно определить первопричину возникновения ошибки аутентификации. |
| `error_codes` | Список кодов ошибок, характерных для службы маркеров безопасности, которые могут помочь при диагностике. |
| `timestamp` | Время, когда произошла ошибка. |
| `trace_id` | Уникальный идентификатор для запроса, который помогает при диагностике. |
| `correlation_id` | Уникальный идентификатор для запроса, который помогает при диагностике компонентов. |

## <a name="use-a-token"></a>Использование маркера

Теперь, когда вы получили маркер, примените его для выполнения запросов к ресурсу. По истечении срока действия маркера повторно отправьте запрос к конечной точке `/token`, чтобы получить новый маркер доступа.

```HTTP
GET /v1.0/me/messages
Host: https://graph.microsoft.com
Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...
```

```bash
# Pro tip: Try the following command! (Replace the token with your own.)

curl -X GET -H "Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbG...." 'https://graph.microsoft.com/v1.0/me/messages'
```

## <a name="code-samples-and-other-documentation"></a>Примеры кода и другая документация

Чтобы получить дополнительные сведения об учетных данных клиента, прочтите [эту статью](https://aka.ms/msal-net-client-credentials) из библиотеки проверки подлинности Майкрософт.

| Образец | Платформа |Описание |
|--------|----------|------------|
|[active-directory-dotnetcore-daemon-v2](https://github.com/Azure-Samples/active-directory-dotnetcore-daemon-v2) | Консоль .NET Core 2.1 | Простое приложение .NET Core, которое отображает пользователей клиента, которые делают запрос в Microsoft Graph не от имени пользователя, а используя удостоверение приложения. В примере также показаны различные варианты проверки подлинности с помощью сертификатов. |
|[active-directory-dotnet-daemon-v2](https://github.com/Azure-Samples/active-directory-dotnet-daemon-v2)|ASP.NET MVC 3 | Веб-приложение, которое синхронизирует данные из Microsoft Graph на основе удостоверения приложения, а не имени пользователя. |
