---
title: Регистрация приложения защищенного веб-API | Службы
titleSuffix: Microsoft identity platform
description: Узнайте, как создать защищенный веб-API и сведения, необходимые для регистрации приложения.
services: active-directory
author: jmprieur
manager: CelesteDG
ms.service: active-directory
ms.subservice: develop
ms.topic: conceptual
ms.workload: identity
ms.date: 07/15/2020
ms.author: jmprieur
ms.custom: aaddev
ms.openlocfilehash: 5d93df0b6d59e013c22e138942ab4651784421ae
ms.sourcegitcommit: 2817d7e0ab8d9354338d860de878dd6024e93c66
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/05/2021
ms.locfileid: "99584386"
---
# <a name="protected-web-api-app-registration"></a>Защищенный веб-API: регистрация приложения

В этой статье объясняются особенности регистрации приложений для защищенного веб-API.

Общие инструкции по регистрации приложения см. в разделе [Краткое руководство. Регистрация приложения на платформе Microsoft Identity](quickstart-register-app.md).

## <a name="accepted-token-version"></a>Принятая версия токена

Платформа Microsoft Identity может выдавать маркеры версии 1.0 и токены версии 2.0. Дополнительные сведения об этих токенах см. в разделе [маркеры доступа](access-tokens.md).

Версия токена, которую ваш API может принять, зависит от выбора **поддерживаемых типов учетных записей** при создании регистрации приложения веб-API в портал Azure.

- Если значения **поддерживаемых типов учетных записей** являются **учетными записями в любом каталоге Организации и личных учетных записях Майкрософт (например, Skype, Xbox, Outlook.com)**, принятая версия токена должна быть версии 2.0.
- В противном случае принятая версия токена может быть версии 1.0.

После создания приложения можно определить или изменить принятую версию токена, выполнив следующие действия.

1. В портал Azure выберите свое приложение и щелкните **Манифест**.
1. Найдите свойство **акцесстокенакцептедверсион** в манифесте.
1. Значение указывает Azure Active Directory (Azure AD), какую версию токена принимает веб-API.
    - Если значение равно 2, веб-API принимает токены версии 2.0.
    - Если значение равно **null**, веб-API принимает токены версии 1.0.
1. Если вы изменили версию токена, нажмите кнопку **сохранить**.

> [!NOTE]
> Веб-API указывает, какую версию токена он принимает. Когда клиент запрашивает маркер для веб-API на платформе Microsoft Identity, клиент получает маркер, указывающий, какая версия токена принимает веб-API.

## <a name="no-redirect-uri"></a>Без URI перенаправления

Веб-API не нужно регистрировать URI перенаправления, так как никто из пользователей не вошел в интерактивный вход.

## <a name="exposed-api"></a>Предоставляемый API

Другими параметрами, специфичными для веб-API, являются предоставляемые API и предоставленные области или роли приложений.

### <a name="application-id-uri-and-scopes"></a>URI и области идентификатора приложения

Области обычно имеют форму `resourceURI/scopeName` . Для Microsoft Graph области имеют ярлыки. Например, `User.Read` является ярлыком для `https://graph.microsoft.com/user.read` .

Во время регистрации приложения определите следующие параметры:

- URI ресурса
- Одна или несколько областей
- Одна или несколько ролей приложений

По умолчанию портал регистрации приложений рекомендует использовать универсальный код ресурса (URI) `api://{clientId}` . Этот URI уникален, но не читается человеком. При изменении универсального кода ресурса убедитесь, что новое значение уникально. Портал регистрации приложений обеспечит использование [настроенного домена издателя](howto-configure-publisher-domain.md).

Для клиентских приложений области отображаются как *делегированные разрешения* и роли приложений отображаются как *разрешения приложений* для веб-API.

Области также отображаются в окне согласия, которое отображается для пользователей приложения. Таким образом, предоставьте соответствующие строки, описывающие область:

- Как видно пользователем.
- Как видно администратором клиента, который может предоставить согласие администратора.

Пользователь не может передать роли приложения пользователю (так как они используются приложением, вызывающим веб-API от имени самого себя). Администратор клиента должен согласиться с вашими клиентскими приложениями веб-API, предоставляя роли приложения. Дополнительные сведения см. в разделе [согласие администратора](v2-admin-consent.md) .

### <a name="exposing-delegated-permissions-scopes"></a>Предоставление делегированных разрешений (области)

1. Выберите **ПРЕДОСТАВЛЯТЬ API** в регистрации приложения.
1. Нажмите **Добавить группу**.
1. При появлении запроса примите предложенный URI идентификатора приложения ( `api://{clientId}` ), выбрав **сохранить и продолжить**.
1. Укажите следующие значения:
    - Выберите **имя области** и введите **access_as_user**.
    - Выберите **пользователей, которым разрешено согласие** , и убедитесь, что выбраны **Администраторы и пользователи** .
    - Выберите **административное имя согласия администратора** и введите **Access TodoListService в качестве пользователя**.
    - Выберите **"Описание согласия администратора"** и введите **доступ к веб-API TodoListService в качестве пользователя**.
    - Выберите **Отображаемое имя согласия пользователя** и введите **Access TodoListService в качестве пользователя**.
    - Выберите **Описание согласия пользователя** и введите **доступ к веб-API TodoListService в качестве пользователя**.
    - Установите для параметра **состояние** значение **включено**.
 1. Выберите **Добавить область**.

### <a name="if-your-web-api-is-called-by-a-daemon-app"></a>Если веб-API вызывается приложением управляющей программы

В этом разделе вы узнаете, как зарегистрировать защищенный веб-API, чтобы приложения управляющей программы могли безопасно его вызывать.

- Вы объявляете и предоставляете только *разрешения приложения* , так как управляющие приложения не взаимодействуют с пользователями. Делегированные разрешения не имеют смысла.
- Администраторы клиента могут потребовать, чтобы Azure AD выдавал токены веб-API только для приложений, зарегистрированных для доступа к одному из разрешений приложения API.

#### <a name="exposing-application-permissions-app-roles"></a>Предоставление разрешений приложению (роли приложений)

Чтобы предоставить разрешения приложения, измените манифест.

1. В приложении регистрация приложения выберите **Манифест**.
1. Чтобы изменить манифест, найдите `appRoles` параметр и добавьте роли приложения. Определения ролей приведены в следующем примере блока JSON.
1. Оставьте `allowedMemberTypes` значение `"Application"` только.
1. Убедитесь, что `id` это уникальный идентификатор GUID.
1. Убедитесь `displayName` , что `value` не содержат пробелы.
1. Сохраните манифест.

В следующем примере показано содержимое `appRoles` , где значение `id` может быть любым уникальным идентификатором GUID.

```json
"appRoles": [
    {
    "allowedMemberTypes": [ "Application" ],
    "description": "Accesses the TodoListService-Cert as an application.",
    "displayName": "access_as_application",
    "id": "ccf784a6-fd0c-45f2-9c08-2f9d162a0628",
    "isEnabled": true,
    "lang": null,
    "origin": "Application",
    "value": "access_as_application"
    }
],
```

#### <a name="ensuring-that-azure-ad-issues-tokens-for-your-web-api-to-only-allowed-clients"></a>Обеспечение того, что Azure AD выдает токены для веб-API только разрешенным клиентам

Веб-API проверяет роль приложения. Эта роль позволяет разработчику программного обеспечения предоставлять разрешения приложения. Вы также можете настроить Azure AD для выпуска маркеров API только для приложений, утвержденных администратором клиента для доступа к API.

Чтобы добавить эту повышенную безопасность:

1. Перейдите на страницу **обзора** приложения для регистрации приложения.
1. В разделе **управляемое приложение в локальном каталоге** выберите ссылку с именем своего приложения. Метка для этого выбора может быть усечена. Например, **управляемое приложение может отображаться в...**

   > [!NOTE]
   >
   > При выборе этой ссылки вы переходите на страницу **Обзор корпоративного приложения** . Эта страница связана с субъектом-службой для вашего приложения в клиенте, где он был создан. Вы можете перейти на страницу регистрации приложения, нажав кнопку "назад" в браузере.

1. Выберите страницу **Свойства** в разделе **Управление** страниц корпоративных приложений.
1. Если вы хотите, чтобы Azure AD разрешит доступ к веб-API только определенным клиентам, задайте для параметра **Назначение пользователей** значение **Да**.

   > [!IMPORTANT]
   >
   > Если вы настроили **Назначение пользователя?** в качестве значения **Да**, Azure AD проверяет назначение роли приложения клиента при запросе маркера доступа к веб-API. Если клиент не назначен ни одной роли приложения, Azure AD возвратит сообщение об ошибке "invalid_client: AADSTS501051: приложение \<application name\> не назначено роли для \<web API\> ".
   >
   > Если требуется указать **Назначение пользователя?** служба Azure AD **не будет** проверять назначения ролей приложения, когда клиент запрашивает маркер доступа для веб-API. Любой клиент управляющей программы, то есть любой клиент, использующий поток учетных данных клиента, может получить маркер доступа для API, просто указав его аудиторию. Любое приложение может получить доступ к API без необходимости запрашивать разрешения для него.
   >
   > Но, как описано в предыдущем разделе, веб-API всегда может проверить, имеет ли приложение правильную роль, которая является полномочным администратором клиента. API выполняет эту проверку, проверяя наличие у маркера доступа утверждения ролей и правильность значения для этого утверждения. В предыдущем примере JSON значение равно `access_as_application` .

1. Щелкните **Сохранить**.

## <a name="next-steps"></a>Дальнейшие действия

Перейдите к следующей статье в этом сценарии: [Конфигурация кода приложения](scenario-protected-web-api-app-configuration.md).
