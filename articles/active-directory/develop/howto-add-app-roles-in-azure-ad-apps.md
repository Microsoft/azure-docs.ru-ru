---
title: Добавление ролей приложения и получение их из токена | Azure
titleSuffix: Microsoft identity platform
description: Узнайте, как добавлять роли приложения в приложение, зарегистрированное в Azure Active Directory, назначать эти роли пользователям и группам и получать их в утверждении "roles" в токене.
services: active-directory
author: kalyankrishna1
manager: CelesteDG
ms.service: active-directory
ms.subservice: develop
ms.workload: identity
ms.topic: how-to
ms.date: 11/13/2020
ms.author: kkrishna
ms.reviewer: marsma, kkrishna, jmprieur
ms.custom: aaddev
ms.openlocfilehash: b2ac90334ade52d68c775d9db5a84545774f3844
ms.sourcegitcommit: 42a4d0e8fa84609bec0f6c241abe1c20036b9575
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "98013708"
---
# <a name="how-to-add-app-roles-to-your-application-and-receive-them-in-the-token"></a>Как добавить роли приложения в приложение и получить их в токене

Управление доступом на основе ролей (RBAC) — это популярный механизм для принудительного применения авторизации в приложениях. При использовании RBAC администратор предоставляет разрешения ролям, а не отдельным пользователям или группам. Затем администратор может назначить роли для различных пользователей и групп, чтобы контролировать доступ к соответствующему содержимому и функциональным возможностям.

С помощью RBAC с ролями приложений и утверждениями ролей разработчики могут безопасно применять авторизацию в своих приложениях с меньшими усилиями.

Другой подход заключается в использовании групп и заявок групп Azure AD, как показано в примере кода [Active-Directory-aspnetcore-webapp-openidconnect-v2](https://aka.ms/groupssample) на сайте GitHub. Группы Azure AD и роли приложений не являются взаимоисключающими. их можно использовать совместно, чтобы обеспечить еще более детализированный контроль доступа.

## <a name="declare-roles-for-an-application"></a>Объявление ролей для приложения

Вы определяете роли приложения с помощью [портал Azure](https://portal.azure.com). Роли приложений обычно определяются в регистрации приложения, представляющей службу, приложение или API. Когда пользователь входит в приложение, Azure AD выдает `roles` заявку для каждой роли, которую пользователь или субъект-служба предоставили пользователю по отдельности и от их членства в группе. Это можно использовать для реализации авторизации на основе утверждений. Роли приложения могут быть назначены [пользователю или группе пользователей](../manage-apps/add-application-portal-assign-users.md#assign-users-to-an-app). Роли приложения также могут быть назначены субъекту-службе для другого приложения или [субъекту-службе для управляемого удостоверения](../managed-identities-azure-resources/how-to-assign-app-role-managed-identity-powershell.md).

> [!IMPORTANT]
> В настоящее время, если вы добавите субъект-службу в группу, а затем назначите роль приложения этой группе, Azure AD не добавит `roles` утверждение в маркеры, которые он выдает.

Существует два способа объявления ролей приложения с помощью портал Azure.

* [Пользовательский интерфейс ролей приложений](#app-roles-ui--preview) | Предварительный просмотр
* [Редактор манифеста приложения](#app-manifest-editor)

Число добавляемых ролей ограничивается ограничениями на манифест приложения, которые принудительно применяются Azure Active Directory. Дополнительные сведения об этих ограничениях см. в разделе  [ограничения манифеста](./reference-app-manifest.md#manifest-limits) в [справочнике по Azure Active Directory манифесте приложения](reference-app-manifest.md).

### <a name="app-roles-ui--preview"></a>Пользовательский интерфейс ролей приложений | Предварительный просмотр

> [!IMPORTANT]
> Функция пользовательского интерфейса портала ролей приложения [!INCLUDE [PREVIEW BOILERPLATE](../../../includes/active-directory-develop-preview.md)]

Чтобы создать роль приложения с помощью пользовательского интерфейса портал Azure, выполните следующие действия.

1. Войдите в <a href="https://portal.azure.com/" target="_blank">портал Azure <span class="docon docon-navigate-external x-hidden-focus"></span> </a>.
1. Выберите фильтр **каталог и подписка** в верхнем меню, а затем выберите клиент Azure Active Directory, содержащий регистрацию приложения, в которую нужно добавить роль приложения.
1. Найдите и выберите **Azure Active Directory**.
1. В разделе **Управление** выберите **Регистрация приложений**, а затем выберите приложение, в котором нужно определить роли приложения.
1. Выбор **ролей приложения | Предварительная версия**, а затем выберите **создать роль приложения**.

   :::image type="content" source="media/howto-add-app-roles-in-azure-ad-apps/app-roles-overview-pane.png" alt-text="Область &quot;роли приложения регистрации приложения&quot; в портал Azure":::
1. В области **Создание роли приложения** введите параметры роли. В таблице, следующей за изображением, описывается каждый параметр и их параметры.

    :::image type="content" source="media/howto-add-app-roles-in-azure-ad-apps/app-roles-create-context-pane.png" alt-text="Область контекста создания ролей приложения регистрации приложения в портал Azure":::

    | Поле | Описание | Пример |
    |-------|-------------|---------|
    | **Отображаемое имя** | Отображаемое имя роли приложения, которое отображается в интерфейсе согласия администратора и назначения приложения. Это значение может содержать пробелы. | `Survey Writer` |
    | **Разрешенные типы элементов** | Указывает, может ли эта роль приложения назначаться пользователям, приложениям или обоим.<br/><br/>При доступности `applications` роли приложения отображаются как разрешения приложения в разделе **Управление** регистрации приложения > **разрешения API > добавить разрешение > мои интерфейсы api > выберите API > приложения**. | `Users/Groups` |
    | **Значение** | Указывает значение утверждения ролей, ожидаемое приложением в токене. Значение должно точно совпадать со строкой, на которую ссылается код приложения. Значение не может содержать пробелы. | `Survey.Create` |
    | **Описание** | Более подробное описание роли приложения, отображаемое во время назначения и согласия приложения администратора. | `Writers can create surveys.` |
    | **Вы хотите включить эту роль приложения?** | Указывает, включена ли роль приложения. Чтобы удалить роль приложения, снимите этот флажок и примените изменения, прежде чем пытаться выполнить операцию удаления. | *Флажок установлен* |

1. Щелкните **Применить**, чтобы сохранить изменения.

### <a name="app-manifest-editor"></a>Редактор манифеста приложения

Чтобы добавить роли путем непосредственного редактирования манифеста:

1. Войдите в <a href="https://portal.azure.com/" target="_blank">портал Azure <span class="docon docon-navigate-external x-hidden-focus"></span> </a>.
1. Выберите фильтр **каталог и подписка** в верхнем меню, а затем выберите клиент Azure Active Directory, содержащий регистрацию приложения, в которую нужно добавить роль приложения.
1. Найдите и выберите **Azure Active Directory**.
1. В разделе **Управление** выберите **Регистрация приложений**, а затем выберите приложение, в котором нужно определить роли приложения.
1. В разделе **Управление** щелкните **Манифест**.
1. Измените манифест приложения, найдя `appRoles` параметр и добавив роли приложения. Можно определить роли приложений, предназначенные для `users` , `applications` или. В следующих фрагментах кода JSON показаны примеры обоих типов.
1. Сохраните манифест.

Каждое определение роли приложения в манифесте должно иметь уникальный идентификатор GUID для своего `id` значения.

Свойство `value` каждого определения роли приложения должно точно соответствовать строкам, используемым в коде приложения. Свойство `value` не может содержать пробелы. Если содержит, при сохранении манифеста появится сообщение об ошибке.

#### <a name="example-user-app-role"></a>Пример: роль приложения пользователя

В этом примере определяется роль приложения с именем `Writer` , которую можно назначить `User` :

```json
"appId": "8763f1c4-0000-0000-0000-158e9ef97d6a",
"appRoles": [
    {
      "allowedMemberTypes": [
        "User"
      ],
      "displayName": "Writer",
      "id": "d1c2ade8-0000-0000-0000-6d06b947c66f",
      "isEnabled": true,
      "description": "Writers Have the ability to create tasks.",
      "value": "Writer"
    }
  ],
"availableToOtherTenants": false,
```

#### <a name="example-application-app-role"></a>Пример: роль приложения приложений

При доступности `applications` роли приложения отображаются как разрешения приложения в разделе **Управление** регистрации приложения > **разрешения API > добавить разрешение > мои интерфейсы api > выберите API > приложения**.

В этом примере показана роль приложения, предназначенная для `Application` :

```json
"appId": "8763f1c4-0000-0000-0000-158e9ef97d6a",
"appRoles": [
    {
      "allowedMemberTypes": [
        "Application"
      ],
      "displayName": "ConsumerApps",
      "id": "47fbb575-0000-0000-0000-0f7a6c30beac",
      "isEnabled": true,
      "description": "Consumer apps have access to the consumer data.",
      "value": "Consumer"
    }
  ],
"availableToOtherTenants": false,
```

## <a name="assign-users-and-groups-to-roles"></a>Назначение ролей для пользователей и групп

После добавления ролей приложений в приложение можно назначить роли пользователям и группам. Назначение пользователей и групп ролям можно выполнить через пользовательский интерфейс на портале или программным путем, используя [Microsoft Graph](/graph/api/user-post-approleassignments). Когда пользователи, назначенные различным ролям приложений, входят в приложение, их маркеры будут иметь назначенные им роли в `roles` утверждении.

Чтобы назначить пользователей и группы ролям с помощью портал Azure:

1. Войдите в <a href="https://portal.azure.com/" target="_blank">портал Azure <span class="docon docon-navigate-external x-hidden-focus"></span> </a>.
1. В **Azure Active Directory** выберите **корпоративные приложения** в меню навигации слева.
1. Щелкните **Все приложения**, чтобы просмотреть полный список приложений. Если приложение не отображается в списке, используйте фильтры в верхней части списка **все приложения** , чтобы ограничить список, или прокрутите список вниз, чтобы выбрать приложение.
1. Выберите приложение, в котором для ролей необходимо назначить пользователей или группы безопасности.
1. В разделе **Управление** выберите **Пользователи и группы**.
1. Щелкните **Добавить пользователя** , чтобы открыть область **добавить назначение** .
1. В области **Добавление назначения** щелкните **Пользователи и группы**. Отобразится список пользователей и групп безопасности. Можно выполнить поиск определенного пользователя или группы, а также выбрать несколько пользователей и групп, которые отображаются в списке.
1. Выбрав пользователей и группы, нажмите кнопку **выбрать** для продолжения.
1. Выберите **выбрать роль** на панели **Добавление назначения** . Отобразятся все роли, определенные для приложения.
1. Выберите роль и нажмите кнопку **выбрать** .
1. Нажмите кнопку **назначить** , чтобы завершить назначение пользователей и групп приложению.

Убедитесь, что добавленные пользователи и группы отображаются в списке **Пользователи и группы** .

## <a name="assign-app-roles-to-applications"></a>Назначение ролей приложения приложениям

После добавления ролей приложения в приложение можно назначить роль приложения клиентскому приложению с помощью портал Azure или программно с помощью [Microsoft Graph](/graph/api/user-post-approleassignments).

При назначении ролей приложений для приложения создаются *разрешения приложения*. Разрешения приложения обычно используются управляющими приложениями или серверными службами, которые должны пройти проверку подлинности и сделать полномочные вызовы API собственными, без взаимодействия с пользователем.

Чтобы назначить роли приложения для приложения с помощью портал Azure:

1. Войдите в <a href="https://portal.azure.com/" target="_blank">портал Azure <span class="docon docon-navigate-external x-hidden-focus"></span> </a>.
1. В **Azure Active Directory** в меню навигации слева выберите **Регистрация приложений** .
1. Щелкните **Все приложения**, чтобы просмотреть полный список приложений. Если приложение не отображается в списке, используйте фильтры в верхней части списка **все приложения** , чтобы ограничить список, или прокрутите список вниз, чтобы выбрать приложение.
1. Выберите приложение, которому требуется назначить роль приложения.
1. Выберите **Разрешения API** > **Добавить разрешение**.
1. Перейдите на вкладку **Мои API** и выберите приложение, для которого вы определили роли приложения.
1. Выберите **Разрешения приложений**.
1. Выберите роли, которые необходимо назначить.
1. Нажмите кнопку **Добавить разрешения** , чтобы завершить добавление ролей.

Вновь добавленные роли должны появиться в области **разрешений API** регистрации приложения.

#### <a name="grant-admin-consent"></a>Предоставление согласия администратора

Поскольку это *разрешения приложения*, а не делегированные разрешения, администратор должен предоставить согласие на использование ролей приложения, назначенных приложению.

1. В области **разрешений API** регистрации приложения выберите **предоставить согласие администратора для \<tenant name\>**.
1. Выберите **Да** при появлении запроса на предоставление согласия для запрошенных разрешений.

Столбец **Status (состояние** ) должен отражать, что согласие **предоставлено для \<tenant name\>**.

## <a name="use-app-roles-in-your-web-api"></a>Использование ролей приложений в веб-API

После определения ролей приложений и назначения их пользователю, группе или приложению необходимо добавить код в веб-API, который проверяет эти роли при вызове API. Это значит, что когда клиентское приложение запрашивает операцию API, которую вы решили требует авторизации, код API должен проверить области в маркере доступа, представленном в вызове клиентского приложения.

Чтобы узнать, как добавить авторизацию в веб-API, см. раздел [защищенный веб-API: Проверка областей и ролей приложений](scenario-protected-web-api-verification-scope-app-roles.md).

## <a name="app-roles-vs-groups"></a>Роли приложений и группы

Несмотря на то, что для авторизации можно использовать роли или группы приложений, основные различия между ними могут повлиять на то, что вы решите использовать в сценарии.

| Роли приложений                                                                          | Группы                                                      |
|------------------------------------------------------------------------------------|-------------------------------------------------------------|
| Они относятся к приложению и определяются в регистрации приложения. Они перемещаются вместе с приложением. | Они не относятся к приложению, а к клиенту Azure AD. |
| Роли приложений удаляются при удалении регистрации приложения.                      | Группы остаются неизменными, даже если приложение удалено.            |
| Указывается в `roles` утверждении.                                                     | Предоставляется в `groups` заявке.                                 |

Разработчики могут использовать роли приложения для управления тем, может ли пользователь входить в приложение, или приложение может получить маркер доступа для веб-API. Чтобы расширить этот элемент управления безопасностью до групп, разработчики и администраторы могут также назначать группы безопасности ролям приложений.

Разработчики предпочитают использовать роли приложений, когда им нужно описывать и контролировать параметры авторизации в своих приложениях. Например, приложение, использующее группы для авторизации, будет прерываться в следующем клиенте, так как идентификатор группы и имя могут отличаться. Приложение, использующее роли приложения, остается безнадежным. По сути, назначение групп ролям приложений является популярным в приложениях SaaS по тем же причинам.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о ролях приложений см. в следующих ресурсах.

* Примеры кода в GitHub
  * [Добавление авторизации с помощью групп и групповых утверждений в веб-приложение ASP.NET Core](https://aka.ms/groupssample)
  * [Радиальное одностраничное приложение (SPA) вызов веб-API .NET Core и использование ролей приложения и групп безопасности](https://github.com/Azure-Samples/ms-identity-javascript-angular-spa-dotnetcore-webapi-roles-groups/blob/master/README.md)
* Справочная документация
  * [Манифест приложения Azure AD](./reference-app-manifest.md)
  * [Маркеры доступа Azure AD](access-tokens.md)
  * [Токены ИДЕНТИФИКАТОРов Azure AD](id-tokens.md)
  * [Предоставление приложению дополнительных утверждений](active-directory-optional-claims.md)
* Видео. [Реализация авторизации в приложениях с помощью платформы Microsoft Identity Platform](https://www.youtube.com/watch?v=LRoc-na27l0) (1:01:15)
