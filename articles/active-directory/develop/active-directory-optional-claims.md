---
title: Предоставление дополнительных утверждений для приложений Azure AD
titleSuffix: Microsoft identity platform
description: Добавление настраиваемых или дополнительных утверждений в токены SAML 2,0 и JSON Web tokens (JWT), выданные платформой Microsoft Identity.
author: rwike77
manager: CelesteDG
ms.service: active-directory
ms.subservice: develop
ms.topic: how-to
ms.workload: identity
ms.date: 1/05/2021
ms.author: ryanwi
ms.reviewer: paulgarn, hirsin, keyam
ms.custom: aaddev
ms.openlocfilehash: 4674fe41a0e3d63ef0cadc6ad55eca02fc69618e
ms.sourcegitcommit: 2aa52d30e7b733616d6d92633436e499fbe8b069
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/06/2021
ms.locfileid: "97935909"
---
# <a name="how-to-provide-optional-claims-to-your-app"></a>Как предоставить приложению необязательные утверждения

Разработчики приложений могут использовать дополнительные утверждения в своих приложениях Azure AD, чтобы указать утверждения, которые нужно поместить в токены, отправляемые в приложение.

Необязательные утверждения можно использовать, чтобы:

- выбрать дополнительные утверждения для включения в токены для приложения;
- Изменение поведения определенных утверждений, которые платформа Microsoft Identity возвращает в токенах.
- добавлять пользовательские утверждения для приложения и обращаться к ним.

Список стандартных утверждений см. в документации по утверждениям [маркера доступа](access-tokens.md) и [id_token](id-tokens.md).

Несмотря на то, что необязательные утверждения поддерживаются в маркерах формата версии 1.0 и 2.0, а также в маркерах SAML, большую ценность они предоставляют при переходе с версии 1.0 на версию 2.0. Одна из целей [конечной точки платформы удостоверений Майкрософт версии 2.0](./v2-overview.md) — уменьшение размеров маркеров для обеспечения оптимальной производительности для клиентов. В результате нескольких утверждений, ранее включенных в маркеры доступа и идентификаторов, больше нет в токенах версии 2.0 и их нужно запрашивать специально для каждого приложения.

**Таблица 1. Применимость**

| Тип учетной записи               | маркеры версии 1.0; | маркеры версии 2.0. |
|----------------------------|-------------|-------------|
| Личная учетная запись Майкрософт | Недоступно         | Поддерживается   |
| Учетная запись Azure AD           | Поддерживается   | Поддерживается   |

## <a name="v10-and-v20-optional-claims-set"></a>Набор необязательных утверждений версий 1.0 и 2.0

Набор необязательных утверждений доступен по умолчанию для использования приложениями, перечисленными ниже. Чтобы добавить настраиваемые необязательные утверждения для приложения, ознакомьтесь с разделом [Расширения каталога](#configuring-directory-extension-optional-claims) ниже. При добавлении утверждений в **маркер доступа** утверждения применяются к маркерам доступа, запрошенным *для* приложения (веб-API), а не к утверждениям, запрошенным *самим* приложением. Независимо от того, получил ли клиент доступ к вашему API, в маркере доступа, используемом при аутентификации с помощью API, будут присутствовать правильные данные.

> [!NOTE]
> Большую часть этих утверждений можно включить в JWT для токенов версии 1.0 и 2.0, кроме токенов SAML, за исключением оговоренных в столбце типов токенов. Учетные записи пользователей-получателей поддерживают подмножество этих утверждений, отмеченных в столбце "Тип пользователя".  Многие из перечисленных утверждений не применяются к пользователям-получателям (у них нет клиента, поэтому `tenant_ctry` не имеет значения).

**Таблица 2. Набор необязательных утверждений версий 1.0 и 2.0**

| Имя                       |  Описание   | Тип маркера | Тип пользователя | Примечания  |
|----------------------------|----------------|------------|-----------|--------|
| `auth_time`                | Время, когда пользователь последний раз проходил аутентификацию. Ознакомьтесь со спецификацией OpenID Connect.| JWT        |           |  |
| `tenant_region_scope`      | Регион клиента ресурса | JWT        |           | |
| `sid`                      | ИД сеанса, используемый для выхода пользователя из конкретного сеанса. | JWT        |  Личные учетные записи и учетные записи Azure AD.   |         |
| `verified_primary_email`   | Источник: PrimaryAuthoritativeEmail пользователя      | JWT        |           |         |
| `verified_secondary_email` | Источник: SecondaryAuthoritativeEmail пользователя   | JWT        |           |        |
| `vnet`                     | Сведения об описателе виртуальной сети. | JWT        |           |      |
| `fwd`                      | IP-адрес.| JWT    |   | Добавляет исходный IPv4-адрес запрашивающего клиента (при использовании внутри виртуальной сети) |
| `ctry`                     | Страна/регион пользователя | JWT |  | Azure AD возвращает `ctry` необязательное утверждение, если оно имеется, а значение этого поля — Стандартный двухбуквенный код страны или региона, например fr, JP, SZ и т. д. |
| `tenant_ctry`              | Страна клиента ресурса | JWT | | То же, что и `ctry` , кроме SET на уровне клиента администратором.  Также должно быть стандартным значением из двух букв. |
| `xms_pdl`             | Предпочтительное расположение данных   | JWT | | Для клиентов с несколькими регионами предпочтительным расположением данных является трехбуквенный код, показывающий, в каком географическом регионе находится пользователь. Дополнительные сведения см. в [документации по Azure AD Connect, посвященной предпочтительному расположению данных](../hybrid/how-to-connect-sync-feature-preferreddatalocation.md).<br/>Например: `APC` для Азиатско-Тихоокеанского региона. |
| `xms_pl`                   | Предпочитаемый язык пользователя  | JWT ||Предпочитаемый язык пользователя, если задан. Источник: домашний клиент пользователя в сценариях гостевого доступа. Формат: ЯЯ-СС ("en-us"). |
| `xms_tpl`                  | Предпочитаемый язык клиента| JWT | | Предпочитаемый язык клиента ресурса, если задан. Формат: ЯЯ ("en"). |
| `ztdid`                    | Идентификатор развертывания без участия пользователя | JWT | | Идентификатор устройства, используемый для [Windows AutoPilot](/windows/deployment/windows-autopilot/windows-10-autopilot) |
| `email`                    | Доступный адрес электронной почты для этого пользователя (если имеется).  | JWT, SAML | MSA, Azure AD | Это значение добавляется по умолчанию, если пользователь является гостем в клиенте.  Для управляемых пользователей (в клиенте) это значение должно запрашиваться посредством необязательного утверждения или, в версии 2.0, с использованием области OpenID.  Адреса электронной почты для управляемых пользователей должны быть заданы на [портале администрирования Office](https://portal.office.com/adminportal/home#/users).|
| `acct`                | Состояние учетной записи пользователей в клиенте | JWT, SAML | | Если пользователь является членом клиента, это значение равно `0`. Если он является гостем, это значение равно `1`. |
| `groups`| Необязательный формат для утверждений групп |JWT, SAML| |Используется с параметром GroupMembershipClaims в [манифесте приложения](reference-app-manifest.md), который также должен быть установлен. Дополнительные сведения см. в разделе [утверждения групп](#configuring-groups-optional-claims) ниже. Дополнительные сведения об утверждениях групп см. в разделе [Настройка утверждений групп.](../hybrid/how-to-connect-fed-group-claims.md)
| `upn`                      | UserPrincipalName | JWT, SAML  |           | Идентификатор пользователя, который можно использовать с параметром username_hint.  Не является устойчивым идентификатором для пользователя и не должен использоваться для уникальной идентификации сведений о пользователе (например, в качестве ключа базы данных). Вместо этого используйте в `oid` качестве ключа базы данных идентификатор объекта пользователя (). Пользователи, которые входят с [альтернативным идентификатором входа](../authentication/howto-authentication-use-email-signin.md) , не должны отображаться в имени участника-пользователя (UPN). Вместо этого используйте следующие утверждения маркера идентификатора для отображения состояния входа пользователю: `preferred_username` или `unique_name` для токенов v1 и `preferred_username` для токенов v2. Несмотря на то, что это утверждение автоматически включается, можно указать его в качестве необязательного утверждения для присоединения дополнительных свойств, чтобы изменить его поведение в варианте использования гостевым пользователем.  |
| `idtyp`                    | Тип токена   | Маркеры доступа JWT | Специальный: только в маркерах доступа "только приложение" |  Значение, `app` Если маркер является маркером только для приложения. Это наиболее точный способ, с помощью которого API определяет, является ли маркер маркером приложения или маркером приложения и пользователя.|

## <a name="v20-specific-optional-claims-set"></a>Набор необязательных утверждений для версии 2.0

Эти утверждения всегда включаются в маркеры Azure AD версии 1.0, но не включаются в маркеры версии 2.0, если они не запрошены. Эти утверждения применяются только для JWT (маркеры идентификации и маркер доступа).

**Таблица 3. Необязательные утверждения, предназначенные только для версии 2.0**

| Утверждение JWT     | Имя                            | Описание                                | Примечания |
|---------------|---------------------------------|-------------|-------|
| `ipaddr`      | IP-адрес                      | IP-адрес, с которого клиент вошел в систему.   |       |
| `onprem_sid`  | Локальный идентификатор безопасности |                                             |       |
| `pwd_exp`     | Срок действия пароля        | Дата и время истечения срока действия пароля. |       |
| `pwd_url`     | Изменить URL-адрес пароля             | URL-адрес, перейдя по которому пользователь может изменить свой пароль.   |   |
| `in_corp`     | В корпоративной сети        | Посылает сигнал, если клиент входит в корпоративную сеть. В противном случае это утверждение не добавляется.   |  На основе параметров [надежных IP-адресов](../authentication/howto-mfa-mfasettings.md#trusted-ips) в MFA.    |
| `family_name` | Фамилия                       | Предоставляет фамилию пользователя, как определено в объекте пользователя. <br>"family_name":"Miller" | Поддерживается в MSA и Azure AD. Требуется область `profile`.   |
| `given_name`  | Имя                      | Указывает личное имя пользователя, которое задано в объекте пользователя.<br>"given_name": "Frank"                   | Поддерживается в MSA и Azure AD.  Требуется область `profile`. |
| `upn`         | Имя участника-пользователя | Идентификатор пользователя, который можно использовать с параметром username_hint.  Не является устойчивым идентификатором для пользователя и не должен использоваться для уникальной идентификации сведений о пользователе (например, в качестве ключа базы данных). Вместо этого используйте в `oid` качестве ключа базы данных идентификатор объекта пользователя (). Пользователи, которые входят с [альтернативным идентификатором входа](../authentication/howto-authentication-use-email-signin.md) , не должны отображаться в имени участника-пользователя (UPN). Вместо этого используйте следующее `preferred_username` утверждение для отображения состояния входа пользователю. | См. в разделе [Дополнительные свойства необязательных утверждений](#additional-properties-of-optional-claims) указанном ниже для конфигурации утверждения. Требуется область `profile`.|


**Таблица 4. v 1.0 — только необязательные утверждения**

Некоторые улучшения формата маркера v2 доступны для приложений, использующих формат токенов v1, так как они помогают повысить безопасность и надежность. Они не вступят в силу для маркеров идентификации, запрошенных из конечной точки v2, и маркеров доступа для API, которые используют формат токена v2. 

| Утверждение JWT     | Имя                            | Описание | Примечания |
|---------------|---------------------------------|-------------|-------|
|`aud`          | Аудитория | Всегда содержится в JWT, но в маркерах доступа v1 его можно создавать различными способами — любым URI appID, с косой чертой или без нее, а также ИДЕНТИФИКАТОРом клиента ресурса. Этот случай может быть трудно программировать в коде при проверке маркера.  Используйте [Дополнительные свойства для этого утверждения](#additional-properties-of-optional-claims) , чтобы убедиться, что для него всегда задан идентификатор клиента в маркерах доступа v1. | только маркеры доступа JWT v1|
|`preferred_username` | Предпочитаемое имя пользователя        | Предоставляет предпочтительное утверждение имени пользователя в маркерах v1. Это упрощает для приложений предоставление подсказок имени пользователя и отображение отображаемых понятных имен, независимо от типа маркера.  Рекомендуется использовать это необязательное утверждение, а не использовать, например, `upn` или `unique_name` . | токены идентификации и маркеры доступа v1 |

### <a name="additional-properties-of-optional-claims"></a>Дополнительные свойства необязательных утверждений

Некоторые необязательные утверждения можно настроить так, чтобы изменить способ возврата утверждения. Эти дополнительные свойства в основном используются для упрощения миграции локальных приложений с различными ожиданиями данных. Например, `include_externally_authenticated_upn_without_hash` помогает клиентам, которые не могут обменяться знаками решетки ( `#` ) в имени участника-пользователя.

**Таблица 4. Значения для настройки необязательных утверждений**

| Имя свойства  | Имя дополнительного свойства | Описание |
|----------------|--------------------------|-------------|
| `upn`          |                          | Может использоваться для ответов SAML и JWT и для токенов v1.0 и v2.0. |
|                | `include_externally_authenticated_upn`  | Включает гостевое имя участника-пользователя, сохраненное в клиенте ресурса. Например `foo_hometenant.com#EXT#@resourcetenant.com`. |
|                | `include_externally_authenticated_upn_without_hash` | Аналогично предыдущему примеру, за исключением того, что метки хэширования (`#`) будут заменены символами нижнего подчеркивания (`_`), например `foo_hometenant.com_EXT_@resourcetenant.com`|
| `aud`          |                          | В маркерах доступа v1 этот параметр используется для изменения формата `aud` утверждения.  Это не оказывает влияния на токены v2 или ни на одну из маркеров идентификации версии, где `aud` утверждение всегда является идентификатором клиента. Используйте эту конфигурацию, чтобы обеспечить более простой способ проверки аудитории API. Как и все необязательные утверждения, влияющие на маркер доступа, ресурс в запросе должен установить это необязательное утверждение, так как ресурсы владеют маркером доступа.|
|                | `use_guid`               | Выдает идентификатор клиента (API) в формате GUID в качестве `aud` утверждения всегда, а не зависит от среды выполнения. Например, если ресурс задает этот флаг, а идентификатор клиента — `bb0a297b-6a42-4a55-ac40-09a501456577` , любое приложение, запрашивающее маркер доступа для этого ресурса, получит маркер доступа со `aud` следующим: `bb0a297b-6a42-4a55-ac40-09a501456577` . </br></br> Если это утверждение не задано, API может получить токены с `aud` утверждением `api://MyApi.com` , `api://MyApi.com/` `api://myapi.com/AdditionalRegisteredField` или любым другим значением, установленным в качестве URI идентификатора приложения для этого API, а также идентификатором клиента ресурса. |

#### <a name="additional-properties-example"></a>Пример дополнительных свойств:

```json
"optionalClaims": {
    "idToken": [
        {
            "name": "upn",
            "essential": false,
            "additionalProperties": [
                "include_externally_authenticated_upn"
            ]
        }
    ]
}
```

Этот объект OptionalClaims приводит к тому, что маркер идентификатора, возвращенный клиенту, включает `upn` утверждение с дополнительными сведениями о домашнем клиенте и клиенте ресурса. Он может изменить утверждение `upn` в маркере, только если пользователь является гостем в клиенте (который использует другой поставщик удостоверений для проверки подлинности).

## <a name="configuring-optional-claims"></a>Настройка необязательных утверждений

> [!IMPORTANT]
> Маркеры доступа **всегда** создаются с помощью манифеста ресурса, а не клиента.  Поэтому в запросе `...scope=https://graph.microsoft.com/user.read...` ресурсом является API Microsoft Graph.  Таким же маркер доступа создается с помощью манифеста API Microsoft Graph, а не манифеста клиента.  Изменение манифеста для приложения никогда не приведет к тому, что маркеры для API Microsoft Graph будут выглядеть иначе.  Чтобы проверить, применяются ли изменения в `accessToken`, запросите маркер для своего приложения, а не для другого приложения.

Настроить необязательные утверждения для приложения можно с помощью пользовательского интерфейса или манифеста приложения.

1. Перейдите на [портал Azure](https://portal.azure.com). 
1. Найдите и выберите **Azure Active Directory**.
1. В разделе **Управление** выберите **Регистрация приложений**.
1. Выберите в списке приложение, для которого нужно настроить необязательные утверждения.

**Настройка необязательных утверждений с помощью пользовательского интерфейса**

[![Настройка необязательных утверждений в пользовательском интерфейсе](./media/active-directory-optional-claims/token-configuration.png)](./media/active-directory-optional-claims/token-configuration.png)

1. В разделе **Управление** выберите пункт **Конфигурация токена**.
1. Выберите **Добавить необязательное утверждение**.
1. Выберите тип токена, который нужно настроить.
1. Выберите необязательные утверждения для добавления.
1. Выберите **Добавить**.

> [!NOTE]
> В настоящее время колонка **Конфигурация токена** параметра пользовательского интерфейса недоступна для приложений, зарегистрированных в клиенте Azure AD B2C. Для приложений, зарегистрированных в клиенте B2C, необязательные утверждения можно настроить, изменив манифест приложения. Дополнительные сведения см. [в разделе Добавление утверждений и настройка пользовательского ввода с помощью пользовательских политик в Azure Active Directory B2C](../../active-directory-b2c/configure-user-input.md) 

**Настройка необязательных утверждений с помощью манифеста приложения**

[![Настройка необязательных утверждений с помощью манифеста приложения](./media/active-directory-optional-claims/app-manifest.png)](./media/active-directory-optional-claims/app-manifest.png)

1. В разделе **Управление** выберите **Манифест**. Откроется веб-редактор манифеста, в котором можно изменить манифест. При необходимости можно выбрать **Скачать** и изменить манифест локально, а затем повторно применить его для приложения с помощью команды **Отправить**. Дополнительные сведения о манифесте приложения см. в статье [Манифест приложения Azure Active Directory](reference-app-manifest.md).

    Следующая запись в манифесте приложения добавляет дополнительные утверждения auth_time, ipaddr и upn в маркеры идентификации, доступа и SAML.

    ```json
    "optionalClaims": {
        "idToken": [
            {
                "name": "auth_time",
                "essential": false
            }
        ],
        "accessToken": [
            {
                "name": "ipaddr",
                "essential": false
            }
        ],
        "saml2Token": [
            {
                "name": "upn",
                "essential": false
            },
            {
                "name": "extension_ab603c56068041afb2f6832e2a17e237_skypeId",
                "source": "user",
                "essential": false
            }
        ]
    }
    ```

2. По завершении нажмите **Сохранить**. Теперь указанные необязательные утверждения будут включаться в маркеры для вашего приложения.


### <a name="optionalclaims-type"></a>Тип OptionalClaims

Объявляет необязательные утверждения, запрошенные приложением. Приложение может настроить необязательные утверждения, возвращаемые в каждом из трех типов токенов (маркер идентификатора, маркер доступа, токен SAML 2), который может быть получен из службы маркеров безопасности. Приложение может настроить различные наборы необязательных утверждений, которые будут возвращаться в каждый тип токена. Свойство optionalClaims сущности приложения — это объект optionalClaims.

**Таблица 5. Свойства типа OptionalClaims**

| Имя          | Тип                       | Описание                                           |
|---------------|----------------------------|-------------------------------------------------------|
| `idToken`     | Коллекция (OptionalClaim) | Необязательные утверждения, возвращаемые в токен идентификации JWT.     |
| `accessToken` | Коллекция (OptionalClaim) | Необязательные утверждения, возвращаемые в маркер доступа JWT. |
| `saml2Token`  | Коллекция (OptionalClaim) | Необязательные утверждения, возвращаемые в токен SAML.       |

### <a name="optionalclaim-type"></a>Тип OptionalClaim

Содержит необязательное утверждение, связанное с приложением или субъект-службой. Свойства idToken, accessToken и saml2Token типа [OptionalClaims](/graph/api/resources/optionalclaims) являются коллекцией OptionalClaim.
С помощью поля AdditionalProperties можно изменить поведение OptionalClaim, если это поддерживается определенным утверждением.

**Таблица 6. Свойства типа OptionalClaims**

| Имя                   | Тип                    | Описание                                                                                                                                                                                                                                                                                                   |
|------------------------|-------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `name`                 | Edm.String              | Имя необязательного утверждения.                                                                                                                                                                                                                                                                               |
| `source`               | Edm.String              | Источник утверждения (объект каталога). Существуют стандартные утверждения и определяемые пользователем утверждения из свойств расширения. Если исходное значение равно null, утверждение будет являться предопределенным необязательным утверждением. Если исходное значение — user, значение в имени свойства будет свойством расширения из объекта пользователя. |
| `essential`            | Edm.Boolean             | Если значение равно true, утверждение, указанное клиентом, необходимо для обеспечения плавной авторизации конкретной задачи, запрашиваемой пользователем. Значение по умолчанию — false.                                                                                                                 |
| `additionalProperties` | Коллекция (Edm.String) | Дополнительные свойства утверждений. Если свойство существует в коллекции, оно изменяет поведение дополнительного утверждения, указанного в свойстве имени.                                                                                                                                                   |

## <a name="configuring-directory-extension-optional-claims"></a>Настройка необязательных утверждений для расширения каталога

Помимо стандартного набора необязательных утверждений, маркеры также можно настроить для включения расширений. Дополнительные сведения см. в [документации по Microsoft Graph extensionProperty](/graph/api/resources/extensionproperty).

Схемы и открытые расширения не поддерживаются необязательными утверждениями, а только расширениями каталогов в стиле AAD-Graph. Эта возможность полезна при присоединении дополнительных сведений о пользователях, которые может использовать приложение, например, дополнительный идентификатор или важный параметр конфигурации, заданный пользователем. Пример см. внизу этой страницы.

> [!NOTE]
> Расширения схемы каталога — это возможность, предназначенная только для Azure AD, поэтому если ваш манифест приложения запрашивает пользовательское расширение, а пользователь MSA регистрируется в вашем приложении, эти расширения не будут возвращены.

### <a name="directory-extension-formatting"></a>Форматирование расширения каталога

При настройке дополнительных утверждений для расширения каталога с помощью манифеста приложения используйте полное имя расширения (в формате: `extension_<appid>_<attributename>`). `<appid>` должен совпадать с идентификатором приложения, запрашивающего утверждение.

В рамках JWT эти утверждения будут передаваться с помощью следующего формата имени: `extn.<attributename>`.

В рамках токенов SAML эти утверждения будут передаваться с помощью следующего формата URI: `http://schemas.microsoft.com/identity/claims/extn.<attributename>`

## <a name="configuring-groups-optional-claims"></a>Настройка необязательных утверждений групп

Далее описываются параметры конфигурации в разделе необязательных утверждений для изменения атрибутов группы, используемых в утверждениях группы, из группы по умолчанию для атрибутов, синхронизированных из локальной Active Directory Windows. Настроить необязательные утверждения групп для приложения можно с помощью пользовательского интерфейса или манифеста приложения.

> [!IMPORTANT]
> Дополнительные сведения, включая важные предостережения для групповых утверждений из локальных атрибутов, см. в статье [Настройка групповых утверждений для приложений с помощью Azure AD](../hybrid/how-to-connect-fed-group-claims.md).

**Настройка необязательных утверждений групп с помощью пользовательского интерфейса**

1. Войдите на [портал Azure](https://portal.azure.com).
1. Пройдя аутентификацию, выберите клиент Azure AD, щелкнув его в правом верхнем углу страницы.
1. Найдите и выберите **Azure Active Directory**.
1. В разделе **Управление** выберите **Регистрация приложений**.
1. Выберите в списке приложение, для которого нужно настроить необязательные утверждения.
1. В разделе **Управление** выберите пункт **Конфигурация токена**.
1. Выберите пункт **Добавить утверждение групп**.
1. Выберите типы групп для возврата (**группы безопасности** или **роли каталогов**, **все группы** и **группы, назначенные приложению**). **Группы, назначенные** параметру приложения, включают только группы, назначенные приложению. Параметр **все группы** включает в себя **SecurityGroup**, **DirectoryRole** и **Дистрибутионлист**, но не **назначенные приложению группы**. 
1. Необязательно. Выберите свойства определенного типа токена, чтобы изменить значение утверждения групп, чтобы оно содержало атрибуты локальной группы, или изменить тип утверждения на роль.
1. Щелкните **Сохранить**.

**Настройка необязательных утверждений групп с помощью манифеста приложения.**

1. Войдите на [портал Azure](https://portal.azure.com).
1. Пройдя аутентификацию, выберите клиент Azure AD, щелкнув его в правом верхнем углу страницы.
1. Найдите и выберите **Azure Active Directory**.
1. Выберите в списке приложение, для которого нужно настроить необязательные утверждения.
1. В разделе **Управление** выберите **Манифест**.
1. Добавьте следующую запись с помощью редактора манифеста:

   Допустимые значения:

   - "Все" (этот параметр включает SecurityGroup, DirectoryRole и DistributionList)
   - "SecurityGroup"
   - "DirectoryRole"
   - "ApplicationGroup" (этот параметр включает только группы, назначенные приложению)

   Пример:

    ```json
    "groupMembershipClaims": "SecurityGroup"
    ```

   По умолчанию группы ObjectID будут выдаваться в значении утверждения группы.  Чтобы изменить значение утверждения в соответствии с атрибутами локальной группы или изменить тип утверждения на роль, используйте конфигурацию OptionalClaims следующим образом.

1. Задайте необязательные утверждения для конфигурации имени группы.

   Если требуется, чтобы группы в токене содержали атрибуты on локальной группы AD в разделе необязательные утверждения, укажите, к какому типу токена следует применить обязательное утверждение, имя запрошенного необязательного утверждения и дополнительные свойства.  В списке можно указать несколько типов маркеров:

   - idToken для маркера идентификатора OIDC;
   - accessToken для маркера доступа OAuth;
   - Saml2Token для маркеров SAML.

   > [!NOTE]
   > Тип Saml2Token применяется к маркерам формата SAML 1.1 и SAML 2.0.

   Для каждого соответствующего типа токена измените утверждение групп, чтобы в манифесте использовался раздел OptionalClaims. Схема OptionalClaims выглядит следующим образом:

    ```json
    {
        "name": "groups",
        "source": null,
        "essential": false,
        "additionalProperties": []
    }
    ```

   | Схема необязательного утверждения | Значение |
   |----------|-------------|
   | **name:** | Должно быть "groups" |
   | **source:** | Не используется. Пропустите или укажите "null" |
   | **essential:** | Не используется. Пропустите или укажите "false" |
   | **additionalProperties:** | Список дополнительных свойств.  Допустимые значения: "sam_account_name", "dns_domain_and_sam_account_name", "netbios_domain_and_sam_account_name", "emit_as_roles". |

   В additionalProperties требуется только один из них: "sam_account_name", "dns_domain_and_sam_account_name", "netbios_domain_and_sam_account_name".  Если указано более одного, используется первый, а остальные игнорируются.

   Некоторым приложениям требуются сведения о группе пользователя в утверждении роли.  Чтобы изменить тип утверждения с утверждения группы на утверждение роли, добавьте "emit_as_roles" к дополнительным свойствам.  Значения группы будут выдаваться в утверждении роли.

   > [!NOTE]
   > Если используется параметр "emit_as_roles", все роли приложения, настроенные для назначения этого пользователя, не будут отображаться в заявке роли.

**Примеры:**

1) Выдача групп в качестве имен групп в маркерах доступа OAuth в формате dnsDomainName\sAMAccountName.

    **Настройка с помощью пользовательского интерфейса.**

    [![Настройка необязательных утверждений](./media/active-directory-optional-claims/groups-example-1.png)](./media/active-directory-optional-claims/groups-example-1.png)

    **Запись в манифесте приложения.**

    ```json
    "optionalClaims": {
        "accessToken": [
            {
                "name": "groups",
                "additionalProperties": [
                    "dns_domain_and_sam_account_name"
                ]
            }
        ]
    }
    ```

2) Выдача имен групп в формате netbiosDomain\sAMAccountName в качестве утверждения роли в маркерах SAML и маркерах идентификатора OIDC.

    **Настройка с помощью пользовательского интерфейса.**

    [![Необязательные утверждения в манифесте](./media/active-directory-optional-claims/groups-example-2.png)](./media/active-directory-optional-claims/groups-example-2.png)

    **Запись в манифесте приложения.**

    ```json
    "optionalClaims": {
        "saml2Token": [
            {
                "name": "groups",
                "additionalProperties": [
                    "netbios_name_and_sam_account_name",
                    "emit_as_roles"
                ]
            }
        ],
        "idToken": [
            {
                "name": "groups",
                "additionalProperties": [
                    "netbios_name_and_sam_account_name",
                    "emit_as_roles"
                ]
            }
        ]
    }
    ```

## <a name="optional-claims-example"></a>Пример необязательного утверждения

В этом разделе можно пошагово выполнить сценарий, чтобы узнать, как можно использовать возможность необязательных утверждений для приложения.
Есть несколько доступных вариантов обновления свойств в конфигурации удостоверения приложения, позволяющих включить и настроить необязательные утверждения.

- Можно использовать **пользовательский интерфейс** (см. пример ниже).
- Можно использовать **манифест** (см. пример ниже). Ознакомьтесь со статьей [Манифест приложения Azure Active Directory](./reference-app-manifest.md), чтобы получить общие сведения о манифесте.
- Вы также можете написать приложение, в котором для обновления используется [API Microsoft Graph](/graph/use-the-api). При настройке необязательных утверждений могут помочь сведения о типе [OptionalClaims](/graph/api/resources/optionalclaims) в справочнике по API Graph.

**Пример**.

В приведенном ниже примере вы будете использовать **пользовательский интерфейс** и **манифест** для добавления необязательных утверждений в маркеры доступа, идентификации и SAML, предназначенные для вашего приложения. Различные необязательные утверждения будут добавлены к каждому типу токена, который может получить приложение.

- Теперь токены идентификации содержат имена участников-пользователей федеративных пользователей в полной форме (`<upn>_<homedomain>#EXT#@<resourcedomain>`).
- Маркеры доступа, запрашиваемые для этого приложения другими клиентами, будут включены в утверждение auth_time.
- Токен SAML будет содержать расширение схемы каталога skypeId (в этом примере идентификатор этого приложения — ab603c56068041afb2f6832e2a17e237). Токен SAML представит идентификатор Skype как `extension_skypeId`.

**Настройка с помощью пользовательского интерфейса.**

1. Войдите на [портал Azure](https://portal.azure.com).
1. Пройдя аутентификацию, выберите клиент Azure AD, щелкнув его в правом верхнем углу страницы.

1. Найдите и выберите **Azure Active Directory**.

1. В разделе **Управление** выберите **Регистрация приложений**.

1. Найдите в списке приложение, для которого нужно настроить необязательные утверждения, и выберите его.

1. В разделе **Управление** выберите пункт **Конфигурация токена**.

1. Выберите **Добавить необязательное утверждение**, тип маркера **ИД**, в списке утверждений выберите **upn**, а затем нажмите **Добавить**.

1. Выберите **Добавить необязательное утверждение**, тип маркера **Доступ**, в списке утверждений выберите **auth_time**, а затем нажмите **Добавить**.

1. На странице общих сведений о конфигурации маркера щелкните значок карандаша рядом с утверждением **upn**, установите переключатель **Внешняя проверка подлинности** и нажмите **Сохранить**.

1. Выберите **Добавить необязательное утверждение**, выберите тип маркера **SAML**, в списке утверждений выберите **extn.skypeID** (применимо только в том случае, если вы создали объект пользователя Azure AD с именем skypeID), а затем нажмите **Добавить**.

    [![Необязательные утверждения для токена SAML](./media/active-directory-optional-claims/token-config-example.png)](./media/active-directory-optional-claims/token-config-example.png)

**Настройка с помощью манифеста.**

1. Войдите на [портал Azure](https://portal.azure.com).
1. Пройдя аутентификацию, выберите клиент Azure AD, щелкнув его в правом верхнем углу страницы.
1. Найдите и выберите **Azure Active Directory**.
1. Найдите в списке приложение, для которого нужно настроить необязательные утверждения, и выберите его.
1. В разделе **Управление** выберите **Манифест** , чтобы открыть встроенный редактор манифеста.
1. Можно напрямую изменить манифест с помощью этого редактора. Манифест соответствует схеме для [сущности приложения](./reference-app-manifest.md) и автоматически форматирует манифест после сохранения. В свойство `OptionalClaims` будут добавлены новые элементы.

    ```json
    "optionalClaims": {
        "idToken": [
            {
                "name": "upn",
                "essential": false,
                "additionalProperties": [
                    "include_externally_authenticated_upn"
                ]
            }
        ],
        "accessToken": [
            {
                "name": "auth_time",
                "essential": false
            }
        ],
        "saml2Token": [
            {
                "name": "extension_ab603c56068041afb2f6832e2a17e237_skypeId",
                "source": "user",
                "essential": true
            }
        ]
    }
    ```

1. Завершив изменение манифеста, нажмите **Сохранить**, чтобы сохранить его.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о стандартных утверждениях, предоставляемых Azure AD, см. в следующих статьях.

- [Маркеры идентификации](id-tokens.md)
- [Маркеры доступа в Azure Active Directory](access-tokens.md)
