---
title: Поток кода авторизации OAuth 2.0 и платформа удостоверений Майкрософт | Azure
titleSuffix: Microsoft identity platform
description: Создание веб-приложений с использованием реализации платформы удостоверений Майкрософт с протоколом проверки подлинности OAuth 2.0.
services: active-directory
author: hpsin
manager: CelesteDG
ms.service: active-directory
ms.subservice: develop
ms.workload: identity
ms.topic: conceptual
ms.date: 01/11/2021
ms.author: hirsin
ms.reviewer: hirsin
ms.custom: aaddev, identityplatformtop40
ms.openlocfilehash: a313633c6c1799136b8b8911ae780ca13be5d2c3
ms.sourcegitcommit: 5cdd0b378d6377b98af71ec8e886098a504f7c33
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/25/2021
ms.locfileid: "98756116"
---
# <a name="microsoft-identity-platform-and-oauth-20-authorization-code-flow"></a>Поток кода авторизации OAuth 2.0 и платформа удостоверений Майкрософт

Код авторизации OAuth 2.0 может использоваться в приложениях, установленных на устройстве, для получения доступа к защищенным ресурсам, таким как веб-API. Используя реализацию OAuth 0.2 платформы удостоверений Майкрософт, в мобильные и классические приложения можно добавить возможности входа и доступа к API.

В этой статье описывается, как программировать непосредственно протокол в приложении с помощью любого языка.  По возможности рекомендуется использовать поддерживаемые библиотеки проверки подлинности Майкрософт (MSAL) вместо [получения маркеров и вызова защищенных веб-API](authentication-flows-app-scenarios.md#scenarios-and-supported-authentication-flows).  Также ознакомьтесь с [примерами приложений, которые используют MSAL](sample-v2-code.md).

Описание потока кода авторизации OAuth 2.0 см. в [разделе 4.1 спецификации OAuth 2.0](https://tools.ietf.org/html/rfc6749). Он используется для проверки подлинности и авторизации большинства типов приложений, в том числе [одностраничных приложений](v2-app-types.md#single-page-apps-javascript), [веб-приложений](v2-app-types.md#web-apps) и [собственных приложений](v2-app-types.md#mobile-and-native-apps). Поток позволяет приложениям безопасно получать access_tokens, которые можно использовать для доступа к ресурсам, защищенным платформой Microsoft Identity, а также обновлять маркеры для получения дополнительных access_tokens и маркеров идентификации для пользователя, выполнившего вход.

## <a name="protocol-diagram"></a>Схема протокола

В общих чертах весь поток проверки подлинности для приложений можно представить следующим образом.

![Поток кода проверки подлинности OAuth](./media/v2-oauth2-auth-code-flow/convergence-scenarios-native.svg)

## <a name="redirect-uri-setup-required-for-single-page-apps"></a>Для одностраничных приложений требуется настройка URI перенаправления

Поток кода авторизации для одностраничных приложений требует некоторой дополнительной настройки.  Следуйте инструкциям по [созданию одностраничного приложения](scenario-spa-app-registration.md#redirect-uri-msaljs-20-with-auth-code-flow) , чтобы правильно ПОметить URI перенаправления как включенный для CORS. Чтобы обновить существующий URI перенаправления, чтобы включить CORS, откройте редактор манифеста и задайте `type` поле для URI перенаправления `spa` в `replyUrlsWithType` разделе. Можно также щелкнуть URI перенаправления в разделе "веб" на вкладке "Проверка подлинности" и выбрать URI, на которые требуется выполнить миграцию, с помощью потока кода авторизации.

`spa`Тип перенаправления обратно совместим с неявным потоком. Приложения, в настоящее время использующие неявный поток для получения токенов, могут переноситься в `spa` тип URI перенаправления без проблем и продолжать использовать неявный поток.

Если при попытке использовать поток кода авторизации отображается следующая ошибка:

`access to XMLHttpRequest at 'https://login.microsoftonline.com/common/v2.0/oauth2/token' from origin 'yourApp.com' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource.`

Вам необходимо перейти к регистрации приложения и обновить URI перенаправления для приложения на тип `spa`.

## <a name="request-an-authorization-code"></a>Запрос кода авторизации

Поток кода авторизации начинается с того, что клиент направляет пользователя к конечной точке `/authorize` . В этом запросе клиент запрашивает у пользователя разрешения `openid`, `offline_access` и `https://graph.microsoft.com/mail.read `.  Некоторые разрешения имеют только администраторы, например запись данных в каталог организации с помощью `Directory.ReadWrite.All`. Если приложение запрашивает доступ к одному из таких разрешений у корпоративного пользователя, появится сообщение об ошибке со сведениями о том, что этот пользователь не может предоставить разрешения приложению. Чтобы запросить доступ к областям только для администраторов, необходимо запросить их непосредственно у администратора компании.  Дополнительные сведения см. в статье [Разрешения, предназначенные только для администраторов](v2-permissions-and-consent.md#admin-restricted-permissions).

```
// Line breaks for legibility only

https://login.microsoftonline.com/{tenant}/oauth2/v2.0/authorize?
client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&response_type=code
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F
&response_mode=query
&scope=https%3A%2F%2Fgraph.microsoft.com%2Fmail.read%20api%3A%2F%2F
&state=12345
&code_challenge=YTFjNjI1OWYzMzA3MTI4ZDY2Njg5M2RkNmVjNDE5YmEyZGRhOGYyM2IzNjdmZWFhMTQ1ODg3NDcxY2Nl
&code_challenge_method=S256
```

> [!TIP]
> Чтобы выполнить этот запрос, щелкните ссылку ниже! После входа браузер будет перенаправлен по адресу `https://localhost/myapp/`, при этом в адресной строке будет указано `code`.
> <a href="https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=6731de76-14a6-49ae-97bc-6eba6914391e&response_type=code&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F&response_mode=query&scope=openid%20offline_access%20https%3A%2F%2Fgraph.microsoft.com%2Fmail.read&state=12345" target="_blank">https://login.microsoftonline.com/common/oauth2/v2.0/authorize...</a>

| Параметр    | Обязательный или необязательный | Описание |
|--------------|-------------|--------------|
| `tenant`    | обязательно    | Значение `{tenant}` в пути запроса можно использовать для того, чтобы контролировать, кто может входить в приложение. Допустимые значения: `common`, `organizations`, `consumers`, а также идентификаторы клиента. Дополнительные сведения см. в [описании протоколов](active-directory-v2-protocols.md#endpoints).  |
| `client_id`   | обязательно    | **Идентификатор приложения (клиента)** , назначенный вашему приложению функцией [Регистрация приложений портала Azure](https://go.microsoft.com/fwlink/?linkid=2083908).  |
| `response_type` | обязательно    | Должен содержать `code` для потока кода авторизации. Может также включать `id_token` или `token` при использовании [гибридного потока](#request-an-id-token-as-well-hybrid-flow). |
| `redirect_uri`  | обязательно | URI перенаправления приложения, на который можно отправлять ответы проверки подлинности для их получения приложением. Он должен в точности соответствовать одному из URI перенаправления, зарегистрированных на портале, но иметь форму закодированного URL-адреса. Для собственных и мобильных приложений следует использовать значение `https://login.microsoftonline.com/common/oauth2/nativeclient` по умолчанию.   |
| `scope`  | обязательно    | Разделенный пробелами список [областей](v2-permissions-and-consent.md) , для которого необходимо согласие пользователя.  Для части `/authorize` запроса это может охватывать несколько ресурсов, позволяя приложению получить согласие на несколько веб-интерфейсов API, которые требуется вызвать. |
| `response_mode`   | рекомендуется | Указывает метод, с помощью которого результирующий маркер будет отправлен приложению. Может применяться один из перечисленных ниже типов.<br/><br/>- `query`<br/>- `fragment`<br/>- `form_post`<br/><br/>`query` предоставляет код в качестве параметра строки запроса в URI перенаправления. Если с помощью неявного потока запрашивается маркер идентификации, использовать `query` нельзя (как описано в [спецификациях OpenID](https://openid.net/specs/oauth-v2-multiple-response-types-1_0.html#Combinations)). Если запрашивается только код, можно использовать `query`, `fragment` или `form_post`. `form_post` выполняет запрос POST, который содержит код для URI перенаправления. |
| `state`                 | рекомендуется | Значение, включенное в запрос, которое также возвращается в ответе маркера. Это может быть строка любого контента. Как правило, для [предотвращения подделки межсайтовых запросов](https://tools.ietf.org/html/rfc6749#section-10.12)используется генерируемое случайным образом уникальное значение. Также в этом значении кодируются сведения о состоянии пользователя в приложении перед выполнением запроса на аутентификацию. Например, это могут быть сведения об открытой на тот момент странице или представлении. |
| `prompt`  | необязательный    | Указывает требуемый тип взаимодействия с пользователем. На текущий момент единственные допустимые значения — `login`, `none` и `consent`.<br/><br/>При значении - `prompt=login` пользователю придется вводить учетные данные по запросу. Единый вход не сработает.<br/>Значение - `prompt=none` является противоположным — оно гарантирует, что интерактивные запросы не будут выводиться ни при каких обстоятельствах. Если запрос не может быть выполнен автоматически с помощью единого входа, платформа Microsoft Identity возвратит `interaction_required` ошибку.<br/>Если установить значение - `prompt=consent`, то после входа пользователь увидит диалоговое окно согласия OAuth с запросом на предоставление разрешений приложению.<br/>- `prompt=select_account` приведет к прерыванию единого входа, предоставляя возможность выбора учетной записи из списка всех учетных записей в сеансе или любой сохраненной учетной записи, или возможность использовать совершенно другую учетную запись.<br/> |
| `login_hint`  | необязательный    | Можно применять для предварительного заполнения поля имени пользователя или адреса электронной почты на странице входа пользователя (если имя пользователя известно заранее). Зачастую этот параметр используется в приложениях при повторной проверке подлинности. При этом имя пользователя извлекается во время предыдущего входа с помощью утверждения `preferred_username`.   |
| `domain_hint`  | необязательный    | Если указан этот параметр, пропускается процесс обнаружения на основе электронной почты, который нужно проходить на странице входа в приложение версии 2.0. Это несколько упрощает взаимодействие с пользователем (например, отправляя их к поставщику федеративных удостоверений.) Обычно этот параметр применяется в приложениях при повторной аутентификации. Для этого значение утверждения `tid` извлекается из предыдущего сеанса входа. Если значение утверждения `tid` — `9188040d-6c67-4c5b-b112-36a304b66dad`, следует использовать `domain_hint=consumers`. Или используйте `domain_hint=organizations`.  |
| `code_challenge`  | рекомендованный/обязательный | Используется, чтобы защитить разрешения кода авторизации с помощью ключа проверки для обмена кодом (PKCE). Является обязательным, если указан параметр `code_challenge_method`. Дополнительные сведения см. в описании [PKCE RFC](https://tools.ietf.org/html/rfc7636). Теперь это рекомендуется для всех типов приложений — собственных приложений, одностраничных приложений и конфиденциальных клиентов, таких как веб-приложения. |
| `code_challenge_method` | рекомендованный/обязательный | Метод, используемый для кодирования `code_verifier` в параметре `code_challenge`. Это *должно* быть `S256` , но спецификация позволяет использовать, `plain` Если по какой бы причине клиент не поддерживает SHA256. <br/><br/>Если этот параметр не указан, для `code_challenge` принимается формат открытого текста, если задано значение `code_challenge`. Платформа Microsoft Identity поддерживает `plain` и, и `S256` . Дополнительные сведения см. в описании [PKCE RFC](https://tools.ietf.org/html/rfc7636). Это необходимо для [одностраничных приложений, использующих поток кода авторизации](reference-third-party-cookies-spas.md).|


На текущем этапе пользователю придется ввести учетные данные и завершить проверку подлинности. Платформа Microsoft Identity также обеспечит, чтобы пользователь предоставил разрешения, указанные в `scope` параметре запроса. Если пользователь не предоставил какие-либо из этих разрешений, конечная точка запросит их у пользователя. Подробные сведения о [разрешениях, согласии на предоставление и мультитенантных приложениях можно найти здесь](v2-permissions-and-consent.md).

После того как пользователь пройдет проверку подлинности и предоставит согласие, платформа Microsoft Identity возвратит ответ на ваше приложение в указанном `redirect_uri` виде с помощью метода, указанного в `response_mode` параметре.

#### <a name="successful-response"></a>Успешный ответ

Успешный ответ с использованием метода `response_mode=query` выглядит следующим образом:

```HTTP
GET https://login.microsoftonline.com/common/oauth2/nativeclient?
code=AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq...
&state=12345
```

| Параметр | Описание  |
|-----------|--------------|
| `code` | Запрашиваемый приложением код авторизации. Приложение может использовать код авторизации для запроса маркера доступа для целевого ресурса. Срок действия кодов авторизации очень мал и обычно истекает по прошествии порядка 10 минут. |
| `state` | Если запрос содержит параметр "state", в ответе должно отображаться то же значение. Приложение должно проверять идентичность значений состояния в запросе и ответе. |

Вы также можете получить маркер идентификации, если вы запрашиваете его, и в регистрации приложения включено неявное предоставление.  Иногда это называется [гибридным потоком](#request-an-id-token-as-well-hybrid-flow)и используется такими платформами, как ASP.NET.

#### <a name="error-response"></a>Сообщение об ошибке

Сообщения об ошибках также можно отправлять на `redirect_uri` , чтобы приложение обрабатывало их должным образом:

```HTTP
GET https://login.microsoftonline.com/common/oauth2/nativeclient?
error=access_denied
&error_description=the+user+canceled+the+authentication
```

| Параметр | Описание  |
|----------|------------------|
| `error`  | Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| `error_description` | Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки проверки подлинности. |

#### <a name="error-codes-for-authorization-endpoint-errors"></a>Коды ошибок конечной точки авторизации

В таблице ниже описаны различные коды ошибок, которые могут возвращаться в параметре `error` ответа с ошибкой.

| Код ошибки  | Описание    | Действие клиента   |
|-------------|----------------|-----------------|
| `invalid_request` | Ошибка протокола, например отсутствует обязательный параметр. | Исправьте запрос и отправьте его повторно. Это ошибка разработки, которая обычно определяется во время первоначального тестирования. |
| `unauthorized_client` | Клиентскому приложению не разрешено запрашивать код авторизации. | Как правило, эта ошибка возникает, если клиентское приложение не зарегистрировано в Azure AD или не добавлено в клиент Azure AD пользователя. Приложение может отобразить пользователю запрос с инструкцией по установке приложения и его добавлению в Azure AD. |
| `access_denied`  | Владелец ресурса отказал в использовании  | Клиентское приложение может уведомить пользователя, что для продолжения работы необходимо согласие пользователя. |
| `unsupported_response_type` | Сервер авторизации не поддерживает тип ответа в запросе. | Исправьте запрос и отправьте его повторно. Это ошибка разработки, которая обычно определяется во время первоначального тестирования. При отображении в [гибридном потоке](#request-an-id-token-as-well-hybrid-flow)сигнализирует, что необходимо включить параметр неявного предоставления маркера идентификации для регистрации клиентского приложения. |
| `server_error`  | Сервер обнаружил непредвиденную ошибку.| Повторите запрос. Эти ошибки могут возникать в связи с временными условиями. Из клиентского приложения может поступить сообщение о том, что его ответ задерживается из-за временной ошибки. |
| `temporarily_unavailable`   | Сервер временно занят и не может обработать запрос. | Повторите запрос. Из клиентского приложения может поступить сообщение о том, что его ответ задерживается из-за временного состояния. |
| `invalid_resource`  | Целевой ресурс недопустим, так как он не существует. Azure AD не удается найти ресурс, или он настроен неправильно. | Это означает, что ресурс не существует или не настроен в клиенте. Приложение может отобразить пользователю запрос с инструкцией по установке приложения и его добавлению в Azure AD. |
| `login_required` | Слишком много пользователей или пользователи не найдены | Клиент запросил автоматическую аутентификацию (`prompt=none`), но одного пользователя не удалось найти. Это может означать, что в сеансе активно несколько пользователей или пользователи отсутствуют. При этом учитывается выбранный клиент (например, если активны две учетные записи Azure AD и одна учетная запись Майкрософт и выбран параметр `consumers`, то автоматическая проверка подлинности будет работать). |
| `interaction_required` | Для запроса требуется взаимодействие с пользователем. | Требуется дополнительный шаг аутентификации или предоставление согласия. Повторите запрос без `prompt=none`. |

### <a name="request-an-id-token-as-well-hybrid-flow"></a>Также запросите маркер идентификатора (гибридный поток)

Чтобы узнать, кто из пользователей прежде, чем активировать код авторизации, часто приложение также запрашивает маркер идентификации при запросе кода авторизации. Это называется *гибридным потоком* , так как он смешивает неявное предоставление с потоком кода авторизации. Гибридный поток обычно используется в веб-приложениях, которые хотят отображать страницу для пользователя без блокировки при активации кода, особенно [ASP.NET](quickstart-v2-aspnet-core-webapp.md). Как одностраничные приложения, так и традиционные веб-приложения получают преимущества от снижения задержки в этой модели.

Гибридный поток аналогичен потоку кода авторизации, описанному ранее, но с тремя дополнениями, необходимыми для запроса маркера идентификации: новые области, новый response_type и новый `nonce` параметр запроса.

```
// Line breaks for legibility only

https://login.microsoftonline.com/{tenant}/oauth2/v2.0/authorize?
client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&response_type=code%20id_token
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F
&response_mode=fragment
&scope=openid%20offline_access%20https%3A%2F%2Fgraph.microsoft.com%2Fuser.read
&state=12345
&nonce=abcde
&code_challenge=YTFjNjI1OWYzMzA3MTI4ZDY2Njg5M2RkNmVjNDE5YmEyZGRhOGYyM2IzNjdmZWFhMTQ1ODg3NDcxY2Nl
&code_challenge_method=S256
```

| Обновленный параметр | Обязательный или необязательный | Описание |
|---------------|-------------|--------------|
|`response_type`| Обязательный | Добавление `id_token` указывает серверу, что приложение должно иметь маркер идентификации в ответе от `/authorize` конечной точки.  |
|`scope`| Обязательный | Для токенов ID необходимо обновить, чтобы включить области токенов ИДЕНТИФИКАТОРов `openid` , и при необходимости `profile` и `email` . |
|`nonce`| Обязательный|     Значение, включаемое в создаваемый приложением запрос, которое будет использоваться как утверждение в получаемом значении id_token. Приложение может проверять это значение, чтобы устранить атаки с воспроизведением маркеров. Значение обычно представляет собой случайным образом полученную уникальную строку, которую можно использовать для идентификации источника запроса. |
|`response_mode`| Рекомендуемая | Определяет метод, который следует использовать для отправки созданного маркера запрашивающему приложению. По умолчанию принимает значение `query` только для кода авторизации, но `fragment` Если запрос содержит id_token `response_type` .|

Использование `fragment` в качестве режима реагирования может вызвать проблемы с веб-приложениями, считывающими код из перенаправления, так как браузеры не передают фрагмент на веб-сервер.  В таких ситуациях рекомендуется использовать `form_post` режим ответа, чтобы обеспечить отправку всех данных на сервер. 

#### <a name="successful-response"></a>Успешный ответ

Успешный ответ с использованием метода `response_mode=fragment` выглядит следующим образом:

```HTTP
GET https://login.microsoftonline.com/common/oauth2/nativeclient#
code=AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq...
&id_token=eYj...
&state=12345
```

| Параметр | Описание  |
|-----------|--------------|
| `code` | Запрашиваемый приложением код авторизации. Приложение может использовать код авторизации для запроса маркера доступа для целевого ресурса. Коды авторизации имеют небольшой срок существования, обычно истекает через 10 минут. |
| `id_token` | Маркер идентификации для пользователя, выданного через *неявное предоставление*. Содержит специальное `c_hash` утверждение, которое является хэш-кодом в том `code` же запросе. |
| `state` | Если в запрос включен этот параметр состояния, идентичное значение должно содержаться и в ответе на этот запрос. Приложение должно проверять идентичность значений состояния в запросе и ответе. |

## <a name="request-an-access-token"></a>Запрос маркера доступа

После получения кода авторизации и разрешения от пользователя вы можете применить `code` для получения `access_token` к требуемому ресурсу. Для этого отправьте запрос `POST` к конечной точке `/token`:

```HTTP
// Line breaks for legibility only

POST /{tenant}/oauth2/v2.0/token HTTP/1.1
Host: https://login.microsoftonline.com
Content-Type: application/x-www-form-urlencoded

client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&scope=https%3A%2F%2Fgraph.microsoft.com%2Fmail.read
&code=OAAABAAAAiL9Kn2Z27UubvWFPbm0gLWQJVzCTE9UkP3pSx1aXxUjq3n8b2JRLk4OxVXr...
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F
&grant_type=authorization_code
&code_verifier=ThisIsntRandomButItNeedsToBe43CharactersLong 
&client_secret=JqQX2PNo9bpM0uEihUPzyrh    // NOTE: Only required for web apps. This secret needs to be URL-Encoded.
```

> [!TIP]
> Попытайтесь выполнить этот запрос в Postman. (Не забудьте заменить `code`.) [![Попробуйте выполнить этот запрос в Postman](./media/v2-oauth2-auth-code-flow/runInPostman.png)](https://app.getpostman.com/run-collection/f77994d794bab767596d).

| Параметр  | Обязательный или необязательный | Описание     |
|------------|-------------------|----------------|
| `tenant`   | обязательно   | Значение `{tenant}` в пути запроса можно использовать для того, чтобы контролировать, кто может входить в приложение. Допустимые значения: `common`, `organizations`, `consumers`, а также идентификаторы клиента. Дополнительные сведения см. в [описании протоколов](active-directory-v2-protocols.md#endpoints).  |
| `client_id` | обязательно  | Идентификатор приложения (клиента), назначенный вашему приложению на странице [регистрации приложений на портале Azure](https://go.microsoft.com/fwlink/?linkid=2083908). |
| `grant_type` | обязательно   | Должен быть `authorization_code` для потока кода авторизации.   |
| `scope`      | необязательно   | Список областей с разделителями-пробелами. Все области должны быть из одного ресурса, а также с областями OIDC (`profile`, `openid`, `email`). Более подробное описание областей можно найти в разделе, посвященном [разрешениям, согласию на их предоставление и областям](v2-permissions-and-consent.md). Это расширение Майкрософт для потока кода авторизации, предназначенное для того, чтобы разрешить приложениям объявлять ресурсы, на которые они хотят получить маркер во время активации токена.|
| `code`          | обязательно  | Код авторизации, полученный на первом участке потока. |
| `redirect_uri`  | обязательно  | Значение redirect_uri, которое использовалось для получения кода authorization_code. |
| `client_secret` | обязательный для конфиденциальных веб-приложений | Секрет приложения, созданный на портале регистрации для приложения. Не следует использовать секрет приложения в собственном приложении или одностраничном приложении, поскольку секреты клиента невозможно надежно сохранить на устройствах или на веб-страницах. Этот секрет требуется для веб-приложений и веб-API с возможностью безопасного хранения секрета клиента на сервере.  Как и все описанные здесь параметры, секрет клиента должен быть закодирован в виде URL-адреса перед отправкой, что обычно выполняется с помощью пакета SDK. Дополнительные сведения о кодировке URI см. в разделе [Спецификация универсального синтаксиса URI](https://tools.ietf.org/html/rfc3986#page-12). |
| `code_verifier` | рекомендуется  | Это тот же параметр code_verifier, который использовался для получения кода авторизации (authorization_code). Является обязательным, если в запросе на код авторизации использовался PKCE. Дополнительные сведения см. в описании [PKCE RFC](https://tools.ietf.org/html/rfc7636). |

### <a name="successful-response"></a>Успешный ответ

Успешный ответ на запрос маркера будет выглядеть следующим образом:

```json
{
    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...",
    "token_type": "Bearer",
    "expires_in": 3599,
    "scope": "https%3A%2F%2Fgraph.microsoft.com%2Fmail.read",
    "refresh_token": "AwABAAAAvPM1KaPlrEqdFSBzjqfTGAMxZGUTdM0t4B4...",
    "id_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJub25lIn0.eyJhdWQiOiIyZDRkMTFhMi1mODE0LTQ2YTctOD...",
}
```

| Параметр     | Описание   |
|---------------|------------------------------|
| `access_token`  | Запрашиваемый маркер доступа. Приложение может использовать этот маркер для аутентификации в защищенном ресурсе, таком как веб-API.  |
| `token_type`    | Указывает значение типа маркера. Единственный тип, поддерживаемый Azure AD, — носитель |
| `expires_in`    | Срок действия маркера доступа (в секундах). |
| `scope`         | Области, для которых действителен маркер доступа. Необязательно. Этот параметр не является стандартным, и если он опущен, маркер будет использоваться для областей, запрошенных на начальном участке последовательности. |
| `refresh_token` | Маркер обновления OAuth 2.0. Приложение может использовать этот маркер для получения дополнительных маркеров доступа после истечения срока действия текущего маркера доступа. Токены обновления действуют в течение долгого времени. Их можно использовать для длительного сохранения доступа к ресурсам. См. дополнительные сведения об [обновлении маркеров доступа](#refresh-the-access-token). <br> **Примечание.** Предоставляется, только если подан запрос на область `offline_access`. |
| `id_token`      | A JSON Web Token (JWT). Приложение может декодировать сегменты этого токена, чтобы запрашивать сведения о пользователе, выполнившем вход. Приложение может кэшировать значения и отображать их, а конфиденциальные клиенты могут использовать его для авторизации. См. дополнительные сведения о маркерах id_token: [`id_token reference`](id-tokens.md). <br> **Примечание.** Предоставляется, только если подан запрос на область `openid`. |

### <a name="error-response"></a>Сообщение об ошибке

Сообщения об ошибках выглядят следующим образом:

```json
{
  "error": "invalid_scope",
  "error_description": "AADSTS70011: The provided value for the input parameter 'scope' is not valid. The scope https://foo.microsoft.com/mail.read is not valid.\r\nTrace ID: 255d1aef-8c98-452f-ac51-23d051240864\r\nCorrelation ID: fb3d2015-bc17-4bb9-bb85-30c5cf1aaaa7\r\nTimestamp: 2016-01-09 02:02:12Z",
  "error_codes": [
    70011
  ],
  "timestamp": "2016-01-09 02:02:12Z",
  "trace_id": "255d1aef-8c98-452f-ac51-23d051240864",
  "correlation_id": "fb3d2015-bc17-4bb9-bb85-30c5cf1aaaa7"
}
```

| Параметр         | Описание    |
|-------------------|----------------|
| `error`       | Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| `error_description` | Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки проверки подлинности. |
| `error_codes` | Список кодов ошибок, характерных для службы маркеров безопасности, которые могут помочь при диагностике.  |
| `timestamp`   | Время возникновения ошибки. |
| `trace_id`    | Уникальный идентификатор для запроса, который может помочь при диагностике. |
| `correlation_id` | Уникальный идентификатор для запроса, который может помочь при диагностике нескольких компонентов. |

### <a name="error-codes-for-token-endpoint-errors"></a>Коды ошибок конечных точек токенов

| Код ошибки         | Описание        | Действие клиента    |
|--------------------|--------------------|------------------|
| `invalid_request`  | Ошибка протокола, например отсутствует обязательный параметр. | Исправьте регистрацию запроса или приложения и отправьте запрос повторно.   |
| `invalid_grant`    | Недопустимый или устаревший код авторизации или средство проверки PKCE. | Повторите запрос к конечной точке `/authorize` и убедитесь, что параметр code_verifier указан правильно.  |
| `unauthorized_client` | У клиента, прошедшего проверку подлинности, нет прав на использование этого типа предоставления разрешения проверки подлинности. | Как правило, это происходит, если клиентское приложение не зарегистрировано в Azure AD или не добавлено в клиент Azure AD пользователя. Приложение может отобразить пользователю запрос с инструкцией по установке приложения и его добавлению в Azure AD. |
| `invalid_client` | Сбой проверки подлинности клиента.  | Недопустимые учетные данные клиента. Чтобы устранить проблему, администратору приложения необходимо обновить учетные данные.   |
| `unsupported_grant_type` | Сервер авторизации не поддерживает тип предоставления авторизации. | Измените тип предоставления в запросе. Ошибка этого типа должна происходить только во время разработки, и ее должны обнаружить при первоначальном тестировании. |
| `invalid_resource` | Целевой ресурс недопустим, так как он не существует. Azure AD не удается найти ресурс, или он настроен неправильно. | Это означает, что ресурс, если он существует, не настроен в клиенте. Приложение может отобразить пользователю запрос с инструкцией по установке приложения и его добавлению в Azure AD.  |
| `interaction_required` | Не является стандартным, так как спецификация OIDC вызывает только для этой `/authorize` конечной точки. Для запроса требуется вмешательство пользователя. К примеру, требуется дополнительный шаг проверки подлинности. | Повторите `/authorize` запрос с теми же областями. |
| `temporarily_unavailable` | Сервер временно занят и не может обработать запрос. | Повторите запрос через небольшую задержку. Из клиентского приложения может поступить сообщение о том, что его ответ задерживается из-за временного состояния. |
|`consent_required` | Для запроса требуется согласие пользователя. Эта ошибка не является стандартной, так как обычно она возвращается только в отношении `/authorize` конечной точки на каждую спецификацию OIDC. Возвращается при `scope` использовании параметра в потоке возврата кода, который у клиентского приложения отсутствует разрешение на запрос.  | Клиент должен отправить пользователю обратно в `/authorize` конечную точку с правильной областью, чтобы активировать согласие. |
|`invalid_scope` | Приложение запросило недопустимую область.  | Измените значение параметра области в запросе на проверку подлинности на допустимое значение. |

> [!NOTE]
> В одностраничных приложениях может отображаться ошибка `invalid_request`, указывающая на то, что активация токена между источниками разрешена только для клиентов типа "Одностраничное приложение".  Это означает, что URI перенаправления, используемый для запроса маркера, не был отмечен как URI перенаправления `spa`.  Дополнительные сведения о том, как включить этот поток, см. в [действиях по регистрации приложений](#redirect-uri-setup-required-for-single-page-apps).

## <a name="use-the-access-token"></a>Использование маркера доступа

Успешно получив `access_token`, вы можете использовать этот маркер в запросах к веб-API, включая его в заголовок `Authorization`.

> [!TIP]
> Выполните этот запрос в Postman. (Сначала замените заголовок `Authorization`.) [![Попробуйте выполнить этот запрос в Postman](./media/v2-oauth2-auth-code-flow/runInPostman.png)](https://app.getpostman.com/run-collection/f77994d794bab767596d).

```HTTP
GET /v1.0/me/messages
Host: https://graph.microsoft.com
Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...
```

## <a name="refresh-the-access-token"></a>Обновление маркера доступа

Срок действия маркеров доступа весьма ограничен, поэтому их нужно обновлять после его истечения, чтобы продолжить пользоваться запросами. Для этого можно отправить еще один запрос `POST` на конечную точку `/token`, прибегнув к `refresh_token` вместо `code`.  Маркеры обновления действуют для всех разрешений, на которые ваш клиент уже получил согласия, например, маркер обновления выданный по запросу для `scope=mail.read` может использоваться для запроса нового маркера доступа для `scope=api://contoso.com/api/UseResource`.

Для маркеров обновления для веб-приложений и собственных приложений не указано время существования. Обычно у маркеров обновления относительно продолжительное время существования. Но в некоторых случаях маркер обновления оказывается устаревшим или отозванным или не имеет достаточных привилегий для требуемого действия. Ваше приложение должно ожидать и правильно обрабатывать [ошибки, возвращаемые конечной точкой выдачи маркера](#error-codes-for-token-endpoint-errors). Однако одностраничные приложения получают маркер с временем жизни 24 часа, что требует новой проверки подлинности каждый день.  Это можно сделать в окне IFRAME без вмешательства пользователя, если включены сторонние файлы cookie, но они должны выполняться в рамках фрейма верхнего уровня (полная навигация по страницам или всплывающее окно) в браузерах без сторонних файлов cookie, таких как Safari.

Несмотря на то, что маркеры обновления не отзываются, когда используются для получения новых маркеров доступа, вы должны самостоятельно удалить старый маркер обновления. В [спецификации OAuth 2.0](https://tools.ietf.org/html/rfc6749#section-6) указано следующее: "Сервер авторизации может выдать новый маркер обновления. В этом случае клиент должен удалить старый маркер обновления и заменить его новым маркером обновления. Сервер авторизации может отозвать старый маркер обновления после выпуска нового маркера обновления для клиента".

>[!IMPORTANT]
> Для маркеров обновления, отправленных в URI перенаправления, зарегистрированного как `spa`, срок действия маркера обновления истечет через 24 часа. Дополнительные маркеры обновления, полученные с помощью начального маркера обновления, будут наследовать этот срок действия, поэтому приложения следует подготовить к повторному выполнению потока кода проверки подлинности с помощью интерактивной проверки подлинности, чтобы получить новый маркер обновления каждые 24 часа. Пользователям не нужно вводить свои учетные данные и, как правило, не будет отображаться ни одного UX, просто приложение будет перезагружаться, однако браузер должен посетить страницу входа во фрейме верхнего уровня, чтобы увидеть сеанс входа.  Это обусловлено [функциями обеспечения конфиденциальности в браузерах, блокирующих сторонние файлы cookie](reference-third-party-cookies-spas.md).

```HTTP

// Line breaks for legibility only

POST /{tenant}/oauth2/v2.0/token HTTP/1.1
Host: https://login.microsoftonline.com
Content-Type: application/x-www-form-urlencoded

client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&scope=https%3A%2F%2Fgraph.microsoft.com%2Fmail.read
&refresh_token=OAAABAAAAiL9Kn2Z27UubvWFPbm0gLWQJVzCTE9UkP3pSx1aXxUjq...
&grant_type=refresh_token
&client_secret=JqQX2PNo9bpM0uEihUPzyrh      // NOTE: Only required for web apps. This secret needs to be URL-Encoded
```

> [!TIP]
> Попытайтесь выполнить этот запрос в Postman. (Не забудьте заменить `refresh_token`.) [![Попробуйте выполнить этот запрос в Postman](./media/v2-oauth2-auth-code-flow/runInPostman.png)](https://app.getpostman.com/run-collection/f77994d794bab767596d).
>

| Параметр     | Тип           | Описание        |
|---------------|----------------|--------------------|
| `tenant`        | обязательно     | Значение `{tenant}` в пути запроса можно использовать для того, чтобы контролировать, кто может входить в приложение. Допустимые значения: `common`, `organizations`, `consumers`, а также идентификаторы клиента. Дополнительные сведения см. в [описании протоколов](active-directory-v2-protocols.md#endpoints).   |
| `client_id`     | обязательно    | **Идентификатор приложения (клиента)** , назначенный вашему приложению функцией [Регистрация приложений портала Azure](https://go.microsoft.com/fwlink/?linkid=2083908). |
| `grant_type`    | обязательно    | Должен быть `refresh_token` для этого участка потока кода авторизации. |
| `scope`         | обязательно    | Список областей с разделителями-пробелами. Области, запрашиваемые на этом участке, должны быть эквивалентны областям, запрашиваемым на исходном участке запроса кода авторизации, или являться их подмножеством. Если области, указанные в этом запросе, охватывают несколько серверов ресурсов, платформа Microsoft Identity возвратит маркер для ресурса, указанного в первой области. Более подробное описание областей можно найти в разделе, посвященном [разрешениям, согласию на их предоставление и областям](v2-permissions-and-consent.md). |
| `refresh_token` | обязательно    | Токен обновления, полученный на втором участке потока. |
| `client_secret` | необходим для веб-приложений | Секрет приложения, созданный на портале регистрации для приложения. Его не следует использовать в собственном приложении, поскольку невозможно обеспечить полную безопасность секретов клиентов при их хранении на устройствах. Этот секрет требуется для веб-приложений и веб-API с возможностью безопасного хранения секрета клиента на сервере. Этот секрет должен быть закодирован в виде URL-адреса. Дополнительные сведения см. в разделе [Спецификация универсального синтаксиса URI](https://tools.ietf.org/html/rfc3986#page-12). |

#### <a name="successful-response"></a>Успешный ответ

Успешный ответ на запрос маркера будет выглядеть следующим образом:

```json
{
    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...",
    "token_type": "Bearer",
    "expires_in": 3599,
    "scope": "https%3A%2F%2Fgraph.microsoft.com%2Fmail.read",
    "refresh_token": "AwABAAAAvPM1KaPlrEqdFSBzjqfTGAMxZGUTdM0t4B4...",
    "id_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJub25lIn0.eyJhdWQiOiIyZDRkMTFhMi1mODE0LTQ2YTctOD...",
}
```

| Параметр     | Описание         |
|---------------|-------------------------------------------------------------|
| `access_token`  | Запрашиваемый маркер доступа. Приложение может использовать этот маркер для аутентификации в защищенном ресурсе, таком как веб-API. |
| `token_type`    | Указывает значение типа маркера. Единственный тип, поддерживаемый Azure AD, — носитель |
| `expires_in`    | Срок действия маркера доступа (в секундах).   |
| `scope`         | Области, для которых действителен маркер доступа.    |
| `refresh_token` | Новый токен обновления OAuth 2.0. Вам следует заменить старый токен обновления вновь полученным, чтобы обеспечить максимальный срок действия токенов обновления. <br> **Примечание.** Предоставляется, только если подан запрос на область `offline_access`.|
| `id_token`      | Неподписанный веб-маркер JSON (JWT). Приложение может декодировать сегменты этого токена, чтобы запрашивать сведения о пользователе, выполнившем вход. Приложение может кэшировать и отображать значения, но оно не должно полагаться на них при авторизации или в целях безопасности. См. дополнительные сведения о маркерах id_token: [`id_token reference`](id-tokens.md). <br> **Примечание.** Предоставляется, только если подан запрос на область `openid`. |

#### <a name="error-response"></a>Сообщение об ошибке

```json
{
  "error": "invalid_scope",
  "error_description": "AADSTS70011: The provided value for the input parameter 'scope' is not valid. The scope https://foo.microsoft.com/mail.read is not valid.\r\nTrace ID: 255d1aef-8c98-452f-ac51-23d051240864\r\nCorrelation ID: fb3d2015-bc17-4bb9-bb85-30c5cf1aaaa7\r\nTimestamp: 2016-01-09 02:02:12Z",
  "error_codes": [
    70011
  ],
  "timestamp": "2016-01-09 02:02:12Z",
  "trace_id": "255d1aef-8c98-452f-ac51-23d051240864",
  "correlation_id": "fb3d2015-bc17-4bb9-bb85-30c5cf1aaaa7"
}
```

| Параметр         | Описание                                                                                        |
|-------------------|----------------------------------------------------------------------------------------------------|
| `error`           | Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| `error_description` | Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки проверки подлинности.           |
| `error_codes` |Список кодов ошибок, характерных для службы маркеров безопасности, которые могут помочь при диагностике. |
| `timestamp` | Время возникновения ошибки. |
| `trace_id` | Уникальный идентификатор для запроса, который может помочь при диагностике. |
| `correlation_id` | Уникальный идентификатор для запроса, который может помочь при диагностике нескольких компонентов. |

Описание кодов ошибок и рекомендуемых действий в клиенте см. в разделе [Коды ошибок конечных точек токенов](#error-codes-for-token-endpoint-errors).
