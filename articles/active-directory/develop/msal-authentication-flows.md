---
title: Потоки проверки подлинности MSAL | Azure
titleSuffix: Microsoft identity platform
description: Сведения о потоках проверки подлинности и предоставлении разрешений, используемых библиотекой проверки подлинности Майкрософт (MSAL).
services: active-directory
author: mmacy
manager: CelesteDG
ms.service: active-directory
ms.subservice: develop
ms.topic: conceptual
ms.workload: identity
ms.date: 01/25/2021
ms.author: marsma
ms.reviewer: saeeda
ms.openlocfilehash: 78932e5852453fe996e26a278f8a1859a8ecf546
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "98755018"
---
# <a name="authentication-flows"></a>Потоки проверки подлинности

Библиотека проверки подлинности Майкрософт (MSAL) поддерживает несколько потоков проверки подлинности для использования в различных сценариях приложений.

| Поток | Описание | Используется в |
|--|--|--|
| [Код авторизации](#authorization-code) | Используется в приложениях, установленных на устройстве, для получения доступа к защищенным ресурсам, таким как веб-API. Позволяет добавлять функции входа и доступа через API к мобильным и классическим приложениям. | [Классические приложения](scenario-desktop-overview.md), [мобильные приложения](scenario-mobile-overview.md), [веб-приложения](scenario-web-app-call-api-overview.md) |
| [Учетные данные клиента](#client-credentials) | Позволяет получить доступ к ресурсам, размещенным в Интернете, с помощью удостоверения приложения. Часто используется для взаимодействия между серверами, которое должно выполняться в фоновом режиме без непосредственного взаимодействия с пользователем. | [Управляющие программы](scenario-daemon-overview.md) |
| [Код устройства](#device-code) | Позволяет пользователям входить на устройства с ограничениями ввода, например устройство типа Smart TV, устройство Интернета вещей или принтер. | [Классические и мобильные приложения](scenario-desktop-acquire-token.md#command-line-tool-without-a-web-browser) |
| [Неявное разрешение](#implicit-grant) | Позволяет приложению получать маркеры без обмена учетными данными в серверной части. Позволяет приложению входить в систему пользователя, поддерживать сеанс и получать маркеры для других веб-API, в коде JavaScript клиента. | [Одностраничные приложения (SPA)](scenario-spa-overview.md) |
| [On-behalf-of](#on-behalf-of) | Приложение вызывает службу или веб-API, который, в свою очередь, должен вызывать другую службу или веб-API. Идея состоит в том, чтобы распространить делегированное удостоверение пользователя и разрешения с помощью цепочки запросов. | [Интерфейсы веб-API](scenario-web-api-call-api-overview.md) |
| [Имя пользователя и пароль](#usernamepassword) | Позволяет приложению войти в систему, напрямую обрабатывая пароль. Этот поток не рекомендуется. | [Классические и мобильные приложения](scenario-desktop-acquire-token.md#username-and-password) |
| [Встроенная аутентификация Windows](#integrated-windows-authentication) | Позволяет приложениям на компьютерах, подключенных к домену или Azure Active Directory (Azure AD), получать маркер автоматически (без взаимодействия с пользовательским интерфейсом). | [Классические и мобильные приложения](scenario-desktop-acquire-token.md#integrated-windows-authentication) |

## <a name="how-each-flow-emits-tokens-and-codes"></a>Как каждый поток выдает маркеры и коды

В зависимости от того, как создается клиентское приложение, оно может использовать один или несколько потоков проверки подлинности, поддерживаемых платформой Microsoft Identity. Эти потоки могут создавать несколько типов токенов, а также коды авторизации, и для их работы требуются разные токены.

| Поток                                                                               | Требования            | id_token | Twitter, | маркер обновления | Код авторизации |
|------------------------------------------------------------------------------------|:-------------------:|:--------:|:------------:|:-------------:|:------------------:|
| [Поток кода авторизации](v2-oauth2-auth-code-flow.md)                             |                     | x        | x            | x             | x                  |
| [Учетные данные клиента](v2-oauth2-client-creds-grant-flow.md)                         |                     |          | x (только для приложений) |               |                    |
| [Поток кода устройства](v2-oauth2-device-code.md)                                       |                     | x        | x            | x             |                    |
| [Неявный поток](v2-oauth2-implicit-grant-flow.md)                                  |                     | x        | x            |               |                    |
| [Поток On-Behalf-Of](v2-oauth2-on-behalf-of-flow.md)                                | Twitter,        | x        | x            | x             |                    |
| [Имя пользователя и пароль](v2-oauth-ropc.md) (ропк)                                       | имя пользователя & пароль | x        | x            | x             |                    |
| [Гибридный поток OIDC](v2-protocols-oidc.md#protocol-diagram-access-token-acquisition) |                     | x        |              |               | x                  |
| [Активация маркера обновления](v2-oauth2-auth-code-flow.md#refresh-the-access-token)   | маркер обновления       | x        | x            | x             |                    |

### <a name="interactive-and-non-interactive-authentication"></a>Интерактивная и Неинтерактивная проверка подлинности

Некоторые из этих потоков поддерживают как интерактивное, так и неинтерактивное получение маркера.

  - **Интерактивное** означает, что пользователю может быть предложено ввести. Например, пользователю предлагается войти в систему, выполнить многофакторную проверку подлинности (MFA) или предоставить дополнительное согласие на доступ к ресурсам.
  - **Неинтерактивный** или *Автоматический* режим проверки подлинности пытается получить маркер таким образом, чтобы сервер входа *не смог* запросить дополнительные сведения у пользователя.

Приложение на основе MSAL должно сначала попытаться получить маркер *автоматически*, а затем в интерактивном режиме только в случае сбоя неинтерактивного метода. Дополнительные сведения об этом шаблоне см. [в разделе Получение и кэширование маркеров с помощью библиотеки проверки подлинности Майкрософт (MSAL)](msal-acquire-cache-tokens.md).

## <a name="authorization-code"></a>Код авторизации

[Предоставление кода авторизации OAuth 2](v2-oauth2-auth-code-flow.md) может быть использовано в приложениях, установленных на устройстве, для получения доступа к защищенным ресурсам, таким как веб-API. Это позволяет вам добавить доступ к мобильным и классическим приложениям с помощью функции входа и API.

При входе пользователей в веб-приложения (веб-сайты) веб-приложение получает код авторизации. Код авторизации активируется для получения маркера для вызова веб-API.

![Схема потока кода авторизации](media/msal-authentication-flows/authorization-code.png)

На предыдущей схеме приложение:

1. запрашивает код авторизации, который активируется для маркера доступа;
2. использует маркер доступа для вызова веб-API.

### <a name="considerations"></a>Рекомендации

- Код авторизации можно использовать только один раз для активации маркера. Не пытайтесь получить маркер несколько раз с одним и тем же кодом авторизации, так как он явно запрещен спецификацией протокола Standard. Если вы активируете код несколько раз, как намеренно, так и из-за того, что вы не знаете, что платформа также делает это за вас, вы получаете следующее сообщение об ошибке:

    `AADSTS70002: Error validating credentials. AADSTS54005: OAuth2 Authorization code was already redeemed, please retry with a new valid code or use an existing refresh token.`

## <a name="client-credentials"></a>Учетные данные клиента

[Поток учетных данных клиента OAuth 2](v2-oauth2-client-creds-grant-flow.md) позволяет получить доступ к ресурсам, размещенным в Интернете, с помощью удостоверения приложения. Этот тип предоставления разрешения часто используется для взаимодействия между серверами, которое должно выполняться в фоновом режиме без непосредственного взаимодействия с пользователем. Такие типы приложений часто называют управляющими программами или учетными записями служб.

Процесс предоставления учетных данных клиента позволяет веб-службе (конфиденциальный клиент) вместо олицетворения пользователя использовать свои собственные учетные данные для проверки подлинности при вызове другой веб-службы. В этом сценарии клиент обычно является веб-службой среднего уровня, службой управляющей программы или веб-сайтом. Для большей надежности платформа удостоверений Майкрософт также позволяет вызывающей службе использовать в качестве учетных данных сертификат (вместо общего секрета).

> [!NOTE]
> Конфиденциальный поток клиента недоступен на мобильных платформах, таких как UWP, Xamarin. iOS и Xamarin. Android, так как они поддерживают только общедоступные клиентские приложения. Общедоступные клиентские приложения не узнают, как подтвердить удостоверение приложения для поставщика удостоверений. Безопасное подключение может быть достигнуто на веб-приложении или серверной стороне веб-API путем развертывания сертификата.

### <a name="application-secrets"></a>Секреты приложений

![Схема конфиденциального клиента с паролем](media/msal-authentication-flows/confidential-client-password.png)

На предыдущей схеме приложение:

1. получает маркер с помощью секрета приложения или учетных данных пароля;
2. использует маркер для выполнения запросов к ресурсу.

### <a name="certificates"></a>Сертификаты

![Схема конфиденциального клиента с сертификатом](media/msal-authentication-flows/confidential-client-certificate.png)

На предыдущей схеме приложение:

1. получает маркер с помощью учетных данных сертификата;
2. использует маркер для выполнения запросов к ресурсу.

Эти учетные данные клиента должны быть:

- зарегистрированы в Azure AD.
- Передается при создании объекта конфиденциального клиентского приложения в коде.

## <a name="device-code"></a>Код устройства

[Поток кода устройства OAuth 2](v2-oauth2-device-code.md) позволяет пользователям входить на устройства с ограниченным входом, например Интеллектуальные телевизоры, устройства IOT и принтеры. Для интерактивной проверки подлинности в Azure AD требуется веб-браузер. Если устройство или операционная система не предоставляет веб-браузер, поток кода устройства позволяет пользователю использовать другое устройство, например компьютер или мобильный телефон, для входа в интерактивном режиме.

С помощью потока кода устройства приложение получает маркеры через двухэтапный процесс, предназначенный для этих устройств и операционных систем. К примерам таких приложений относятся те, которые работают на устройствах Интернета вещей и в средстве интерфейса командной строки (CLI).

![Схема потока кода устройства](media/msal-authentication-flows/device-code.png)

На предыдущей схеме показано следующее.

1. Каждый раз, когда требуется проверка подлинности пользователя, приложение предоставляет код и запрашивает у пользователя использование другого устройства, например подключенного к Интернету смартфона, для посещения URL-адреса (например, `https://microsoft.com/devicelogin` ). После этого пользователю будет предложено ввести код и перейти к обычной проверке подлинности, включая запросы согласия и [многофакторную проверку подлинности](../authentication/concept-mfa-howitworks.md), если это необходимо.
1. После успешной проверки подлинности приложение командной строки получает необходимые маркеры через канал обратного вызова и использует их для выполнения необходимых вызовов веб-API.

### <a name="constraints"></a>Ограничения

- Поток кода устройства доступен только в общедоступных клиентских приложениях.
- При создании общедоступного клиентского приложения необходим один из следующих центров.
  - Клиентский, в форме, `https://login.microsoftonline.com/{tenant}/,` где `{tenant}` — это идентификатор GUID, представляющий идентификатор клиента или имя домена, связанное с клиентом.
  - Для рабочих и учебных учетных записей в форме `https://login.microsoftonline.com/organizations/` .

## <a name="implicit-grant"></a>Неявное разрешение

[Неявный поток предоставления OAuth 2](v2-oauth2-implicit-grant-flow.md) позволяет приложению получать маркеры от платформы Microsoft Identity, не выполняя обмен учетными данными сервера. Эта последовательность позволяет приложению входить в систему пользователя, обслуживать сеанс и получать маркеры для других веб-API, в коде JavaScript клиента.

![Схема потока неявного предоставления разрешений](media/msal-authentication-flows/implicit-grant.svg)

Многие современные веб-приложения создаются как клиентские, одностраничные приложения (SPA), написанные на JavaScript или в защищенной среде (например, угловой, Vue.js и React.js). Эти приложения работают в веб-браузере и имеют характеристики проверки подлинности, отличные от традиционных серверных веб-приложений. Платформа удостоверений Microsoft позволяет одностраничным приложениям поддерживать вход пользователей, а также получать маркеры для доступа к внутренним службам или веб-API, используя поток неявного предоставления разрешения. Неявный поток позволяет приложению получать маркеры идентификаторов для представления пользователя, прошедшего проверку подлинности, а также маркеры, необходимые для вызова защищенных API.

Этот поток проверки подлинности не включает сценарии приложений, в которых используются межплатформенные платформы JavaScript, такие как электронное или React-Native, поскольку для них требуются дополнительные возможности для взаимодействия с собственными платформами.

Токены, выданные через режим неявного потока, имеют **ограничение длины** , так как они возвращаются браузеру по URL-адресу (где `response_mode` — `query` или `fragment` ). Некоторые браузеры ограничивают длину URL-адреса на панели браузера и завершаются ошибкой, если он слишком длинный. Таким образом, эти неявные маркеры потока не содержат или не являются `groups` `wids` утверждениями.

## <a name="on-behalf-of"></a>On-behalf-of

Поток [проверки подлинности OAuth 2 от имени пользователя](v2-oauth2-on-behalf-of-flow.md) используется, когда приложение вызывает службу или веб-API, которые, в свою очередь, должны вызывать другую службу или веб-API. Идея состоит в том, чтобы передать по цепочке запросов делегированное удостоверение пользователя и соответствующие разрешения. Чтобы служба среднего уровня выполняла запросы с проверкой подлинности к подчиненной службе, ей необходимо защитить маркер доступа от платформы Microsoft Identity от *имени* пользователя.

![Схема потока On-Behalf-Of](media/msal-authentication-flows/on-behalf-of.png)

На предыдущей схеме показано следующее.

1. Приложение получает маркер доступа для веб-API.
2. Клиент (веб-, классическое, мобильное или одностраничное приложение) вызывает защищенный веб-API, добавляя маркер доступа в качестве маркера носителя в заголовок проверки подлинности HTTP-запроса. Веб-API выполняет проверку подлинности пользователя.
3. Когда клиент вызывает веб-API, веб-API запрашивает другой маркер от имени пользователя.
4. Защищенный веб-API использует этот маркер для вызова нижестоящего веб-API от имени пользователя. Веб-API также может запрашивать маркеры для других нижестоящих API (но по-прежнему от имени одного и того же пользователя).

## <a name="usernamepassword"></a>Имя пользователя и пароль

Предоставление [учетных данных для пароля владельца ресурса OAuth 2](v2-oauth-ropc.md) (ропк) позволяет приложению выполнять вход пользователя путем непосредственной обработки пароля. В классическом приложении можно использовать поток имени пользователя и пароля для автоматического получения маркера. При использовании приложения не нужен пользовательский интерфейс.

![Схема потока имени пользователя и пароля](media/msal-authentication-flows/username-password.png)

На предыдущей схеме приложение:

1. получает маркер, отправляя имя пользователя и пароль поставщику удостоверений;
2. вызывает веб-API с помощью маркера.

> [!WARNING]
> Этот поток не рекомендуется. Для этого требуется высокая степень доверия и предоставление учетных данных. Этот поток следует использовать, *только* если нельзя использовать более безопасные потоки. Дополнительные сведения см. в разделе [Как решить насущную проблему паролей?](https://news.microsoft.com/features/whats-solution-growing-problem-passwords-says-microsoft/).

Предпочтительным потоком для автоматического получения маркера на компьютерах, присоединенных к домену Windows, является [встроенная проверка подлинности Windows](#integrated-windows-authentication). В других случаях используйте [поток кода устройства](#device-code).

Хотя поток имени пользователя и пароля может быть полезен в некоторых сценариях, таких как DevOps, Избегайте этого, если вы хотите использовать имя пользователя и пароль в интерактивных сценариях, где вы предоставляете собственный пользовательский интерфейс.

По имени пользователя и паролю.

- Пользователи, которым требуется выполнять многофакторную проверку подлинности, не смогут войти в систему из-за отсутствия взаимодействия.
- Пользователи не смогут выполнять единый вход.

### <a name="constraints"></a>Ограничения

Помимо [ограничений встроенной проверки подлинности Windows](#integrated-windows-authentication), также применяются следующие ограничения.

- Поток имени пользователя и пароля несовместим с условным доступом и многофакторной проверкой подлинности. Как следствие, если приложение выполняется в клиенте Azure AD, где администратор клиента требует многофакторную проверку подлинности, вы не сможете использовать этот поток. Так поступают многие организации.
- РОПК работает только для рабочих и учебных учетных записей. Нельзя использовать РОПК для учетных записей Майкрософт (MSA).
- Поток доступен для классических приложений .NET и .NET Core, но не для универсальной платформы Windows.
- В Azure AD B2C поток РОПК работает только для локальных учетных записей. Сведения о РОПК в MSAL.NET и Azure AD B2C см. в разделе [Использование ропк с Azure AD B2C](msal-net-aad-b2c-considerations.md#resource-owner-password-credentials-ropc).

## <a name="integrated-windows-authentication"></a>Встроенная проверка подлинности Windows

MSAL поддерживает встроенную проверку подлинности Windows (IWA) для настольных и мобильных приложений, работающих на присоединенном к домену компьютере Windows или присоединенном к Azure AD. С помощью IWA эти приложения могут получать маркер без вмешательства пользователя, не требуя взаимодействия с пользовательским ИНТЕРФЕЙСом.

![Схема встроенной проверки подлинности Windows](media/msal-authentication-flows/integrated-windows-authentication.png)

На предыдущей схеме приложение:

1. получает маркер с использованием встроенной проверки подлинности Windows;
2. использует маркер для выполнения запросов к ресурсу.

### <a name="constraints"></a>Ограничения

Встроенная проверка подлинности Windows (IWA) поддерживает *только* Федеративные пользователи — пользователи, созданные в Active Directory и поддерживающие Azure AD. Пользователи, созданные непосредственно в Azure AD без Active Directoryного резервного копирования (управляемые пользователи), не могут использовать этот поток проверки подлинности. Это ограничение не влияет на [поток имени пользователя и пароля](#usernamepassword).

IWA предназначен для платформа .NET Framework, .NET Core и универсальная платформа Windows приложений.

IWA не обходит многофакторную проверку подлинности. Если настроена многофакторная проверка подлинности, IWA может завершиться ошибкой, когда требуется запрос многофакторной проверки подлинности. Многофакторная проверка подлинности требует взаимодействия с пользователем.

Вы не контролируете, когда поставщик удостоверений запрашивает двухфакторную проверку подлинности. Этим занимается администратор клиента. Обычно двухфакторная проверка подлинности требуется при входе из другой страны или региона, если вы не подключены через VPN к корпоративной сети, и иногда даже при подключении через VPN. Azure AD использует искусственный интеллект для непрерывного изучения необходимости двухфакторной проверки подлинности. В случае сбоя IWA необходимо вернуться к [интерактивному приглашению пользователя](#interactive-and-non-interactive-authentication).

При создании общедоступного клиентского приложения центр должен иметь одно из следующих данных:

- Клиентский, в форме, `https://login.microsoftonline.com/{tenant}/,` где `{tenant}` — это идентификатор GUID, представляющий идентификатор клиента или имя домена, связанное с клиентом.
- Для всех рабочих и учебных учетных записей (`https://login.microsoftonline.com/organizations/`). Личные учетные записи Майкрософт (MSA) не поддерживаются; Вы не можете использовать `/common` или `/consumers` клиенты.

Так как IWA является автоматическим потоком, необходимо выполнить одно из следующих условий.

- Пользователь приложения должен быть предварительно одобрен, чтобы использовать приложение.
- Администратор клиента должен предварительно одобрить всех пользователей в клиенте для использования приложения.

Это означает, что выполняется одно из следующих условий.

- Вы как разработчик выбрали **Grant** в портал Azure самостоятельно.
- Администратор клиента выбрал **разрешение GRANT/REVOKE администратора для {домен клиента}** на вкладке **разрешения API** регистрации приложения в портал Azure (см. раздел [Добавление разрешений для доступа к веб-API](quickstart-configure-app-access-web-apis.md#add-permissions-to-access-your-web-api)).
- Вы указали способ предоставления пользователям согласия на приложение; см. раздел [запрос согласия отдельного пользователя](v2-permissions-and-consent.md#requesting-individual-user-consent).
- Вы указали способ предоставления администратору клиента согласия для приложения; см. раздел [согласие администратора](v2-permissions-and-consent.md#requesting-consent-for-an-entire-tenant).

Поток IWA включен для классических приложений .NET, приложений .NET Core и универсальной платформы Windows.

Дополнительные сведения о согласии см. в разделе [разрешения и согласия в версии 2.0](v2-permissions-and-consent.md).

## <a name="next-steps"></a>Дальнейшие действия

Теперь, когда вы проверили потоки проверки подлинности, поддерживаемые библиотекой проверки подлинности Майкрософт (MSAL), Узнайте о получении и кэшировании маркеров, используемых в этих потоках:

[Получение и кэширование маркеров с помощью библиотеки проверки подлинности Майкрософт (MSAL)](msal-acquire-cache-tokens.md)
