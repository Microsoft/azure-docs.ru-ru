---
title: Руководство. Пилотная облачная синхронизация с помощью Azure AD Connect для существующего синхронизированного леса AD
description: Узнайте о пилотной синхронизации облака для тестового леса Active Directory, который уже синхронизирован с использованием службы синхронизации Azure Active Directory (Azure AD) Connect.
services: active-directory
author: billmath
manager: daveba
ms.service: active-directory
ms.workload: identity
ms.topic: tutorial
ms.date: 03/22/2021
ms.subservice: hybrid
ms.author: billmath
ms.collection: M365-identity-device-management
ms.openlocfilehash: 50eac71203a94ffb5c7dddc8995b56980c3f8815
ms.sourcegitcommit: ba3a4d58a17021a922f763095ddc3cf768b11336
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/23/2021
ms.locfileid: "104798720"
---
# <a name="pilot-cloud-sync-for-an-existing-synced-ad-forest"></a>Пилотная облачная синхронизация для существующего синхронизированного леса AD 

В этом руководстве описывается пилотная облачная синхронизация для тестового леса Active Directory, который уже синхронизирован с использованием службы синхронизации Azure Active Directory (Azure AD) Connect.

![Создание](media/tutorial-migrate-aadc-aadccp/diagram-2.png)

## <a name="considerations"></a>Рекомендации
Прежде чем начать работу с этим руководством, примите во внимание следующее:
1. Вы должны быть знакомы с основами синхронизации облачных сред. 
2. Убедитесь, что вы используете службу синхронизации Azure AD Connect версии 1.4.32.0 или более поздней и настроили правила синхронизации, как указано в документации. При пилотном развертывании вы удалите тестовое подразделение или группу из области синхронизации Azure AD Connect. Перемещение объектов за пределы области действия приводит к удалению этих объектов из Azure AD. Объекты пользователя в Azure AD удаляются обратимо, то есть их можно восстановить. Объекты групп в Azure AD удаляются необратимо, то есть их невозможно восстановить. В службе синхронизации Azure AD Connect появился новый тип ссылки, который предотвращает удаление в случае пилотного сценария. 
3. Убедитесь, что для объектов в области пилотного развертывания заполнен параметр ms-ds-consistencyGUID, чтобы при синхронизации облачных служб выполнялось строгое сопоставление этих объектов. 

   > [!NOTE]
   > Служба синхронизации Azure AD Connect по умолчанию не заполняет *ms-ds-consistencyGUID* для групповых объектов.

4. Это расширенный сценарий. Следите за тем, чтобы в точности выполнять действия, описанные в этом учебнике.

## <a name="prerequisites"></a>Предварительные требования
Для работы с этим учебником требуется следующее:
- Тестовая среда со службой синхронизации Azure AD Connect версии 1.4.32.0 или более поздней.
- Подразделение или группа, которые находятся в области синхронизации и могут использоваться в пилотной среде. Мы советуем начинать с небольшого набора объектов.
- Сервер под управлением Windows Server 2012 R2 или более поздней версии, на котором будет размещен агент подготовки.  Это не может быть тот же сервере, где размещается Azure AD Connect.
- Привязка к источнику для службы синхронизации Azure AD Connect должна быть либо в виде *objectGuid*, либо в виде *MS-DS-consistencyGUID*.

## <a name="update-azure-ad-connect"></a>Обновление Azure AD Connect

Версия службы [Azure AD Connect](https://www.microsoft.com/download/details.aspx?id=47594) не должна быть ниже 1.4.32.0. Чтобы обновить службу синхронизации Azure AD Connect, выполните шаги из статьи [Azure AD Connect: обновление до последней версии](../hybrid/how-to-upgrade-previous-version.md).  

## <a name="stop-the-scheduler"></a>Остановка планировщика
Служба синхронизации Azure AD Connect синхронизирует изменения в вашем локальном каталоге, используя планировщик. Если нужно изменить и добавить пользовательские правила, отключите этот планировщик, чтобы операции синхронизации не выполнялись одновременно с вашей работой.  Выполните указанные ниже действия.

1.  На сервере, где выполняется служба синхронизации Azure AD Connect, откройте PowerShell с правами администратора.
2.  Выполните `Stop-ADSyncSyncCycle`.  Нажмите клавишу ВВОД.
3.  Выполните `Set-ADSyncScheduler -SyncCycleEnabled $false`.

>[!NOTE] 
>Если вы используете собственный настраиваемый планировщик для синхронизации Azure AD Connect, отключите его. 

## <a name="create-custom-user-inbound-rule"></a>Создание пользовательского правила для входящего трафика пользователя

 1. Запустите редактор синхронизации из меню приложений на рабочем столе, как показано ниже:</br>
 ![Редактор правил синхронизации в списке меню](media/tutorial-migrate-aadc-aadccp/user-8.png)</br>
 
 2. Выберите **Входящие** из раскрывающегося списка в поле "Направление" и щелкните **Добавить новое правило**.
 ![Снимок экрана: окно View and manage your synchronization rules (Просмотр правил синхронизации и управление ими) с выбранными кнопками "Входящие" и "Добавить новое правило".](media/tutorial-migrate-aadc-aadccp/user-1.png)</br>
 
 3. На странице **Описание** задайте следующие параметры и щелкните **Далее**.

    **Имя.** Присвойте правилу понятное имя.<br>
    **Описание.** Введите информативное описание.<br>
    **Connected System** (Подключенная система). Выберите соединитель AD, для которого записывается пользовательское правило синхронизации.<br>
    **Connected System Object Type** (Тип объекта подключенной системы). Пользователь<br>
    **Metaverse Object Type** (Тип объекта метавселенной). Модель Person<br>
    **Тип связи**. Join<br>
    **Приоритет**. Укажите уникальное в системе значение.<br>
    **Тег**. Оставьте это поле пустым.<br>
    ![Снимок экрана: страница Create inbound synchronization rule - Description (Создание правила входящей синхронизации. Описание) с введенными значениями.](media/tutorial-migrate-aadc-aadccp/user-2.png)</br>
 
 4. На странице **Scoping filter** (Фильтр области) введите имя подразделения или группы безопасности, на которых должен быть основан пилотный проект.  Чтобы отфильтровать по подразделению, добавьте часть, которая отвечает за название подразделения, в различающемся имени. Это правило будет применяться ко всем пользователям, которые относятся к этому подразделению.  Таким образом, если различающееся имя завершается строкой "OU=CPUsers,DC=contoso,DC=com", вы добавите такой фильтр.  Затем нажмите кнопку **Далее**. 

    |Правило|attribute|Оператор|Значение|
    |-----|----|----|-----|
    |Подразделение для определения области|DN|ENDSWITH|Различающееся имя подразделения.|
    |Группа для определения области||ISMEMBEROF|Различающееся имя группы безопасности.|

    ![Снимок экрана: страница Create inbound synchronization rule - Scoping filter (Создание правила входящей синхронизации. Фильтр области действия) с введенным значением фильтра области.](media/tutorial-migrate-aadc-aadccp/user-3.png)</br>
 
 5. На странице **Join rules** (Правила объединения) щелкните **Далее**.
 6. На странице **Преобразования** добавьте преобразование константы, чтобы значение True передавалось в атрибут cloudNoFlow. Нажмите кнопку **Добавить**.
 ![Снимок экрана: страница Create inbound synchronization rule - Transformations (Создание правила входящей синхронизации. Преобразования) с добавленным потоком Constant transformation (Преобразование константы).](media/tutorial-migrate-aadc-aadccp/user-4.png)</br>

Эти же действия необходимо выполнить для объектов всех типов (пользователей, групп и контактов). Повторите шаги для каждого настроенного соединителя AD или каждого леса AD. 

## <a name="create-custom-user-outbound-rule"></a>Создание пользовательского правила для исходящего трафика пользователя

 1. Выберите **Исходящие** из раскрывающегося списка в поле "Направление" и щелкните **Добавить правило**.
 ![Снимок экрана: выбранный параметр "Исходящие" для поля "Направление" и выделенная кнопка "Добавить новое правило".](media/tutorial-migrate-aadc-aadccp/user-5.png)</br>
 
 2. На странице **Описание** задайте следующие параметры и щелкните **Далее**.

    **Имя.** Присвойте правилу понятное имя.<br>
    **Описание.** Введите информативное описание.<br>
    **Connected System** (Подключенная система). Выберите соединитель Azure AD, для которого записывается пользовательское правило синхронизации.<br>
    **Connected System Object Type** (Тип объекта подключенной системы). Пользователь<br>
    **Metaverse Object Type** (Тип объекта метавселенной). Модель Person<br>
    **Тип связи**. JoinNoFlow<br>
    **Приоритет**. Укажите уникальное в системе значение.<br>
    **Тег**. Оставьте это поле пустым.<br>
    
    ![Снимок экрана: страница "Описание" с введенными свойствами.](media/tutorial-migrate-aadc-aadccp/user-6.png)</br>
 
 3. На странице **Фильтр области** выберите "**cloudNoFlow** равно **true**". Затем нажмите кнопку **Далее**.
 ![Пользовательское правило](media/tutorial-migrate-aadc-aadccp/user-7.png)</br>
 
 4. На странице **Join rules** (Правила объединения) щелкните **Далее**.
 5. На странице **Преобразования** щелкните **Добавить**.

Эти же действия необходимо выполнить для объектов всех типов (пользователей, групп и контактов).

## <a name="install-the-azure-ad-connect-provisioning-agent"></a>Установка агента подготовки Azure AD Connect
1. Войдите на сервер, который будет использоваться с разрешениями администратора организации.  Если вы используете учебник [по созданию базовой среды AD и Azure](tutorial-basic-ad-azure.md), это будет CP1.
2. Скачайте агент подготовки облака Azure AD Connect, выполнив описанную [здесь](how-to-install.md#install-the-agent) процедуру.
3. Запустите облачную синхронизацию Azure AD Connect (AADConnectProvisioningAgent.Installer).
3. На экране-заставке **примите** условия лицензионного соглашения и щелкните **Установить**.</br>
![Снимок экрана: экран-заставка Microsoft Azure AD Connect Provisioning Agent (Агент подготовки Microsoft Azure AD Connect).](media/how-to-install/install-1.png)</br>

4. После завершения этой операции откроется мастер настройки.  Войдите с учетной записью глобального администратора Azure AD.
5. На экране **Connect Active Directory** (Подключение Active Directory) щелкните **Добавить каталог** и выполните вход с учетной записью администратора Active Directory.  Эта операция добавляет локальный каталог.  Щелкните **Далее**.</br>
![Снимок экрана: экран Connect Active Directory (Подключение Active Directory) с введенным значением каталога.](media/how-to-install/install-3a.png)</br>

6. На странице **Конфигурация завершена** щелкните **Подтвердить**.  Эта операция регистрирует и перезапускает агент.</br>
![Снимок экрана: экран "Конфигурация завершена" с выбранной кнопкой "Подтвердить".](media/how-to-install/install-4a.png)</br>

7. После завершения операции появится сообщение **Your was successfully verified** (Вас успешно проверили).  Здесь можно щелкнуть **Выйти**.</br>
![Экран приветствия](media/how-to-install/install-5.png)</br>
8. Если вы по-прежнему видите начальный экран-заставку, щелкните **Закрыть**.

## <a name="verify-agent-installation"></a>Проверка установки агента
Проверка агента выполняется на портале Azure и на локальном сервере, где выполняется агент.

### <a name="azure-portal-agent-verification"></a>Проверка агента на портале Azure
Чтобы проверить, что агент доступен в Azure, сделайте следующее:

1. Войдите на портал Azure.
2. Слева выберите **Azure Active Directory**, щелкните **Azure AD Connect** и в центре выберите **Manage cloud sync** (Управление облачной синхронизацией).</br>
![Портал Azure](media/how-to-install/install-6.png)</br>

3.  На экране **Azure AD Connect cloud sync** (Синхронизация с облаком Azure AD Connect) щелкните **Просмотр всех агентов**.
![Подготовка Azure AD](media/how-to-install/install-7.png)</br>
 
4. На экране **локальных агентов подготовки** вы увидите установленные агенты.  Убедитесь, что нужный агент присутствует в этом списке с пометкой **Disabled** (Отключено).  По умолчанию агент подготовки отключен. ![Агенты подготовки](media/how-to-install/verify-1.png)</br>

### <a name="on-the-local-server"></a>На локальном сервере
Чтобы убедиться, что агент выполняется, сделайте следующее.

1.  Войдите на сервер с учетной записью администратора.
2.  Откройте страницу **Службы**, перейдя к ней в интерфейсе или выполнив команду Services.msc в строке запуска из меню "Пуск".
3.  В разделе **Службы** убедитесь, что **агент обновления Microsoft Azure AD Connect** и **агент подготовки Microsoft Azure AD Connect** присутствуют в списке и имеют состояние **Выполняется**.
![Службы](media/how-to-install/troubleshoot-1.png)

## <a name="configure-azure-ad-connect-cloud-sync"></a>Настройка синхронизации с облаком Azure AD Connect
Чтобы настроить процесс подготовки, выполните следующие действия.

 1. Войдите на портал Azure.
 2. В меню **Azure Active Directory**
 3. Щелкните **Azure AD Connect**.
 4. Выберите **Manage cloud sync** (Управление синхронизацией с облаком)
 ![Снимок экрана: со ссылкой Manage cloud sync (Управление облачной синхронизацией).](media/how-to-configure/manage-1.png)</br>
 5.  Выберите элемент **Новая конфигурация**
 ![Снимок экрана: облачная синхронизация Azure AD Connect, выделена ссылка "Новая конфигурация".](media/tutorial-single-forest/configure-1.png)</br>
 6.  На экране конфигурации перейдите к разделу **Сообщение электронной почты с уведомлением**, переместите селектор в положение **Включить** и щелкните **Сохранить**.
 ![Снимок экрана "Настройка" с указанным адресом электронной почты для уведомлений и переключателем, установленным в положение "Включить".](media/tutorial-single-forest/configure-2.png)</br>
 7. В разделе **Настройка** выберите **Все пользователи**, чтобы изменить область действия правила конфигурации.
 ![Снимок экрана настройки: рядом с параметром "Пользователи в области" выделен элемент "Все пользователи"](media/how-to-configure/scope-2.png)</br>
 8. Справа измените область, включив в нее только что созданное подразделение: "OU=CPUsers,DC=contoso,DC=com".
 ![Снимок экрана: раздел "Пользователи в области", в котором показано, что область изменена на только что созданное подразделение](media/tutorial-existing-forest/scope-2.png)</br>
 9.  Щелкните **Готово** и **Сохранить**.
 10. Теперь область будет включать одно подразделение. 
 ![Снимок экрана настройки: рядом с параметром "Пользователи в области" выделен элемент "1 подразделение"](media/tutorial-existing-forest/scope-3.png)</br>
 

## <a name="verify-users-are-provisioned-by-cloud-sync"></a>Проверка подготовки пользователей с помощью облачной синхронизации
Теперь вы проверите, были ли пользователи из локального каталога синхронизированы и добавлены в клиент Azure AD.  Имейте в виду, что эта операция может занять несколько часов.  Чтобы проверить подготовку пользователей с помощью облачной синхронизации, выполните следующие шаги.

1. Перейдите на [портал Azure](https://portal.azure.com) и выполните вход с учетной записью, имеющей подписку Azure.
2. Слева выберите **Azure Active Directory**.
3. Щелкните **Azure AD Connect**.
4. Щелкните **Управление облачной синхронизацией**.
5. Нажмите кнопку **Журналы**.
6. Выполните поиск по имени пользователя, чтобы убедиться в том, что этот пользователь подготовлен с помощью облачной синхронизации.

Кроме того, можно проверить существование пользователя и группы в Azure AD.

## <a name="start-the-scheduler"></a>Запуск планировщика
Служба синхронизации Azure AD Connect синхронизирует изменения в вашем локальном каталоге, используя планировщик. Итак, вы завершили изменение правил и теперь можете перезапустить планировщик.  Выполните указанные ниже действия.

1.  На сервере, где выполняется служба синхронизации Azure AD Connect, откройте PowerShell с правами администратора.
2.  Выполните `Set-ADSyncScheduler -SyncCycleEnabled $true`.
3.  Выполните `Start-ADSyncSyncCycle`.  Нажмите клавишу ВВОД.  

>[!NOTE] 
>Если вы используете собственный настраиваемый планировщик для синхронизации Azure AD Connect, включите его. 

После включения планировщика Azure AD Connect будет прерывать экспорт любых изменений в объектах с `cloudNoFlow=true` в метавселенной, если не будет обновлен какой-либо атрибут ссылки (например, manager). Если для объекта выполнено обновление ссылочного атрибута, Azure AD Connect будет игнорировать сигнал `cloudNoFlow` и экспортировать все обновления для объекта.

## <a name="something-went-wrong"></a>Если что-то пошло не так
Если пилотный проект не работает должным образом, вы можете вернуться к настройке службы синхронизации Azure AD Connect, выполнив следующие шаги.
1.  Отключите конфигурацию автоматической подготовки на портале Azure. 
2.  С помощью редактора правил синхронизации отключите все настраиваемые правила синхронизации, созданные для подготовки облака. При таком отключении должна запуститься полная синхронизация для всех соединителей.



## <a name="next-steps"></a>Дальнейшие действия 

- [Что собой представляет подготовка?](what-is-provisioning.md)
- [Что представляет собой облачная синхронизация Azure AD Connect?](what-is-cloud-sync.md)

