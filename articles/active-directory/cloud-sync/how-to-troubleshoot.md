---
title: Устранение неполадок синхронизации Azure AD Connect Cloud
description: В этой статье описывается, как устранять неполадки, которые могут возникнуть при работе с агентом подготовки облака.
author: billmath
ms.author: billmath
manager: daveba
ms.date: 01/19/2021
ms.topic: how-to
ms.prod: windows-server-threshold
ms.technology: identity-adfs
ms.openlocfilehash: 33af92c1987d9cd0c88e689dd7bafccadd60cb06
ms.sourcegitcommit: 8a74ab1beba4522367aef8cb39c92c1147d5ec13
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/20/2021
ms.locfileid: "98614060"
---
# <a name="cloud-sync-troubleshooting"></a>Устранение неполадок синхронизации в облаке

Облачная синхронизация касается многих различных аспектов и имеет множество различных зависимостей. Эта широкая область может выдавать различные проблемы. Эта статья поможет вам устранить эти проблемы. В нем представлены типичные области, позволяющие сосредоточиться, как собирать дополнительные сведения, и различные методы, которые можно использовать для выявления проблем.


## <a name="common-troubleshooting-areas"></a>Распространенные области устранения неполадок

|Имя|Описание|
|-----|-----|
|[Проблемы с агентом](#agent-problems)|Убедитесь, что агент установлен правильно и взаимодействует с Azure Active Directory (Azure AD).|
|[Проблемы синхронизации объектов](#object-synchronization-problems)|Используйте журналы подготовки для устранения неполадок синхронизации объектов.|
|[Подготовка проблем, связанных с карантином](#provisioning-quarantined-problems)|Сведения о подготовке к работе в карантине и способах их устранения.|


## <a name="agent-problems"></a>Проблемы с агентом
Вот некоторые из первых вещей, которые необходимо проверить с помощью агента:

-  Установлен ли он?
-  Агент запущен локально?
-  Является ли агент на портале?
-  Помечен ли агент как работоспособный?

Эти элементы можно проверить в портал Azure и на локальном сервере, на котором выполняется агент.

### <a name="azure-portal-agent-verification"></a>Проверка агента на портале Azure

Чтобы убедиться, что агент отображается в Azure и является работоспособным, выполните следующие действия.

1. Войдите на портал Azure.
1. Слева щелкните **Azure Active Directory** > **Azure AD Connect**. В центре выберите **Управление синхронизацией**.
1. На экране **Azure AD Connect Cloud Synchronization (синхронизация с облаком** ) выберите **проверить все агенты**.

   ![Проверка всех агентов](media/how-to-install/install-7.png)</br>
 
1. На экране " **локальные агенты подготовки** " вы увидите установленные агенты. Убедитесь, что рассматриваемый агент есть и помечен как *работоспособный*.

   ![Экран локальных агентов подготовки](media/how-to-install/install-8.png)</br>

### <a name="verify-the-port"></a>Проверка порта

Убедитесь, что Azure прослушивает порт 443 и что агент может обмениваться данными с ним. 

Этот тест проверяет, могут ли агенты обмениваться данными с Azure через порт 443. Откройте браузер и перейдите к предыдущему URL-адресу с сервера, на котором установлен агент.

![Проверка достижимости порта](media/how-to-install/verify-2.png)

### <a name="on-the-local-server"></a>На локальном сервере

Чтобы убедиться, что агент выполняется, сделайте следующее.

1. На сервере с установленным агентом откройте **службы** , перейдя к нему или перейдя к запуску   >    >  **Services. msc**.
1. В разделе **Службы** убедитесь, что **агент обновления Microsoft Azure AD Connect** и **агент подготовки Microsoft Azure AD Connect** присутствуют в списке и имеют состояние *Выполняется*.

   ![Экран служб](media/how-to-troubleshoot/troubleshoot-1.png)

### <a name="common-agent-installation-problems"></a>Распространенные проблемы при установке агента

В следующих разделах описаны некоторые распространенные проблемы с установкой агентов и типичные способы их устранения.

#### <a name="agent-failed-to-start"></a>Не удалось запустить агент

Может появиться сообщение об ошибке, в котором говорится:

**Не удалось запустить службу "Microsoft Azure AD подключить агент подготовки". Убедитесь, что у вас есть необходимые привилегии для запуска системных служб.** 

Эта проблема обычно вызвана групповой политикой, которая не позволила применить разрешения к локальной учетной записи NT Service log-on, созданной установщиком (NT Сервице\аадконнектпровисионингажент). Эти разрешения необходимы для запуска службы.

Чтобы устранить эту проблему, выполните следующие действия.

1. Войдите на сервер, используя учетную запись администратора.
1. Перейдите на страницу **Службы** или откройте ее, последовательно выбрав **Пуск** > **Выполнить** > **Services.msc**.
1. В разделе " **службы**" дважды щелкните **Microsoft Azure AD подключить агент подготовки**.
1. На вкладке **Вход в** систему измените **эту учетную запись** на администратор домена. Затем перезапустите службу. 

   ![Вкладка "вход в систему"](media/how-to-troubleshoot/troubleshoot-3.png)

#### <a name="agent-times-out-or-certificate-is-invalid"></a>Истекло время ожидания агента, или сертификат недействителен

При попытке зарегистрировать агент может появиться следующее сообщение об ошибке.

![Сообщение об ошибке времени ожидания](media/how-to-troubleshoot/troubleshoot-4.png)

Обычно эта проблема связана с тем, что агент не может подключиться к гибридной службе удостоверений и требует настройки прокси-сервера HTTP. Чтобы устранить эту проблему, настройте исходящий прокси-сервер. 

Агент подготовки поддерживает использование исходящего прокси-сервера. Его можно настроить, изменив файл конфигурации агента *C:\Program Files\Microsoft Azure AD Connect подготовки Agent\AADConnectProvisioningAgent.exe.config*. Добавьте в него следующие строки в конец файла непосредственно перед закрывающим `</configuration>` тегом.
Замените переменные `[proxy-server]` и `[proxy-port]` значениями имени прокси-сервера и порта.

```xml
    <system.net>
        <defaultProxy enabled="true" useDefaultCredentials="true">
            <proxy
                usesystemdefault="true"
                proxyaddress="http://[proxy-server]:[proxy-port]"
                bypassonlocal="true"
            />
        </defaultProxy>
    </system.net>
```

#### <a name="agent-registration-fails-with-security-error"></a>Сбой регистрации агента с ошибкой безопасности

При установке агента подготовки облака может появиться сообщение об ошибке.

Эта проблема обычно вызвана тем, что агенту не удается выполнить сценарии регистрации PowerShell из-за локальных политик выполнения PowerShell.

Чтобы устранить эту проблему, измените политики выполнения PowerShell на сервере. Необходимо, чтобы политики компьютера и пользователя были заданы как *неопределенные* или *RemoteSigned*. Если они заданы как *неограниченные*, вы увидите эту ошибку. Дополнительные сведения см. в разделе [политики выполнения PowerShell](/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-6). 

### <a name="log-files"></a>Файлы журнала

По умолчанию агент выдает минимальные сообщения об ошибках и сведения о трассировке стека. Эти журналы трассировки можно найти в папке **К:\ПРОГРАМДАТА\МИКРОСОФТ\АЗУРЕ AD Connect подготовка Agent\Trace**.

Чтобы собрать дополнительные сведения для устранения неполадок, связанных с агентом, выполните следующие действия.

1.  Установите модуль PowerShell Аадклаудсинктулс, как описано [здесь](reference-powershell.md#install-the-aadcloudsynctools-powershell-module).
2. Используйте `Export-AADCloudSyncToolsLogs` командлет PowerShell для сбора данных.  Для точной настройки сбора данных можно использовать следующие параметры.
      - Скипвербосетраце экспортировать только текущие журналы без записи подробного журнала (значение по умолчанию — false)
      - ТраЦингдуратионминс, чтобы указать другую длительность записи (по умолчанию — 3 минуты)
      - OutputPath для указания другого выходного пути (по умолчанию — документы пользователя)


## <a name="object-synchronization-problems"></a>Проблемы синхронизации объектов

В следующем разделе содержатся сведения об устранении неполадок синхронизации объектов.

### <a name="provisioning-logs"></a>Подготовка журналов

В портал Azure журналы подготовки можно использовать для выявления и устранения проблем синхронизации объектов. Чтобы просмотреть журналы, выберите **журналы**.

![Кнопка "Журналы"](media/how-to-troubleshoot/log-1.png)

Журналы подготовки предоставляют обширную информацию о состоянии объектов, синхронизируемых между локальной средой Active Directory и Azure.

![Экран "журналы подготовки"](media/how-to-troubleshoot/log-2.png)

С помощью раскрывающихся списков в верхней части страницы можно отфильтровать представление в соответствии с конкретными проблемами, например датами. Дважды щелкните отдельное событие, чтобы просмотреть дополнительные сведения.

![Сведения из раскрывающегося списка журналов подготовки](media/how-to-troubleshoot/log-3.png)

Эти сведения содержат подробные инструкции и место возникновения проблемы синхронизации. Таким образом можно точно определить точное место проблемы.


## <a name="provisioning-quarantined-problems"></a>Подготовка проблем, связанных с карантином

Синхронизация в облаке отслеживает работоспособность вашей конфигурации и помещает неработоспособные объекты в состояние карантина. Если большинство или все вызовы, выполненные для целевой системы, постоянно завершаются сбоем из-за ошибки, например недопустимых учетных данных администратора, задание синхронизации помечается как помещенное в карантин.

![Состояние карантина](media/how-to-troubleshoot/quarantine-1.png)

Выбрав состояние, можно просмотреть дополнительные сведения о карантине. Также можно получить код ошибки и сообщение.

![Сведения о состоянии карантина](media/how-to-troubleshoot/quarantine-2.png)

При щелчке состояния правой кнопкой мыши отображаются дополнительные параметры:
    
   - Просмотр журналов подготовки
   - Просмотреть агент
   - Очистить карантин

![Сведения о состоянии карантина](media/how-to-troubleshoot/quarantine-4.png)


### <a name="resolve-a-quarantine"></a>Разрешение карантина
Существует два разных способа разрешения карантина.  К ним относятся:

  - Очистить карантин — очищает водяной знак и выполняет разностную синхронизацию
  - перезапуск задания подготовки — очищает водяной знак и запускает начальную синхронизацию.

#### <a name="clear-quarantine"></a>Очистить карантин
Чтобы очистить водяной знак и выполнить разностную синхронизацию для задания подготовки после его проверки, просто щелкните правой кнопкой мыши состояние и выберите **Очистить карантин**.

Вы увидите уведомление о том, что карантин очищен.

![Сведения о состоянии карантина](media/how-to-troubleshoot/quarantine-5.png)

После этого состояние агента должно отображаться как работоспособное.

![Сведения о состоянии карантина](media/how-to-troubleshoot/quarantine-6.png)

#### <a name="restart-the-provisioning-job"></a>Перезапуск задания подготовки
Используйте портал Azure, чтобы перезапустить задание подготовки. На странице Конфигурация агента выберите **перезапустить подготовку**.

  ![Перезапустить подготовку](media/how-to-troubleshoot/quarantine-3.png)

- Используйте Microsoft Graph, чтобы [перезапустить задание подготовки](/graph/api/synchronization-synchronizationjob-restart?tabs=http&view=graph-rest-beta). Вы получите полный контроль над перезапусками. Вы можете выбрать следующие флажки:
  - Для перезапуска счетчика депонирования, который начисляется в направлении карантина.
  - Карантин, чтобы удалить приложение из карантина.
  - Водяные знаки. 
  
  Используйте следующий запрос:
 
  `POST /servicePrincipals/{id}/synchronization/jobs/{jobId}/restart`

## <a name="repairing-the-the-cloud-sync-service-account"></a>Восстановление учетной записи облачной службы синхронизации
Если вам нужно восстановить учетную запись облачной службы синхронизации, можно использовать `Repair-AADCloudSyncToolsAccount` .  


   1.  Выполните действия по установке, описанные [здесь](reference-powershell.md#install-the-aadcloudsynctools-powershell-module) , чтобы начать и продолжить выполнение оставшихся действий.
   2.  В сеансе Windows PowerShell с правами администратора введите или скопируйте и вставьте следующий текст: 
    ```
    Connect-AADCloudSyncTools
    ```  
   3. Введите учетные данные глобального администратора Azure AD
   4. Введите или скопируйте и вставьте следующий текст: 
    ```
    Repair-AADCloudSyncToolsAccount
    ```  
   5. После завершения этого процесса должно быть указано, что учетная запись успешно исправлена.

## <a name="next-steps"></a>Дальнейшие действия 

- [Известные ограничения](how-to-prerequisites.md#known-limitations)
- [Коды ошибок](reference-error-codes.md)
