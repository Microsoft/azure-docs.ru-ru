---
title: Azure AD Connect облачной синхронизации — как это работает
description: В этом разделе содержатся подробные сведения о принципах синхронизации в облаке.
services: active-directory
author: billmath
manager: daveba
ms.service: active-directory
ms.workload: identity
ms.topic: conceptual
ms.date: 12/05/2019
ms.subservice: hybrid
ms.author: billmath
ms.collection: M365-identity-device-management
ms.openlocfilehash: 0e1079ab4a523fbbc99c1e9190aef960b3f0723f
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "98614317"
---
# <a name="cloud-sync-deep-dive---how-it-works"></a>Облачная синхронизация — принцип работы

## <a name="overview-of-components"></a>Общие сведения о компонентах

![Принцип работы](media/concept-how-it-works/how-1.png)

Облачная синхронизация построена на основе служб Azure AD и состоит из двух ключевых компонентов:

- **Агент подготовки**. Azure AD Connect агент подготовки облака — это тот же агент, что и Workday, входящий и основанный на той же серверной технологии, что и прокси приложения, и сквозная проверка подлинности. Он требует и исходящих подключений, и агенты обновляются с автозаменой. 
- **Служба подготовки**: та же служба подготовки, что и исходящая подготовка исходящей передачи и подготовка входящего трафика Workday, которая использует модель на основе планировщика. В случае облачной синхронизации изменения подготавливаются каждые 2 минуты.


## <a name="initial-setup"></a>Начальная настройка
Во время начальной настройки выполняется несколько действий, которые делают синхронизацию в облаке.  А именно: 

- **Во время установки агента**: вы настраиваете агент для доменов AD, из которых вы хотите выполнить инициализацию.  Эта конфигурация регистрирует домены в службе гибридной идентификации и устанавливает исходящее подключение к служебной шине, слушающей запросы.
- **При включении подготовки**: вы выбираете домен AD и включаете подготовку, которая выполняется каждые 2 минуты. При необходимости можно отменить синхронизацию хэша паролей и определить электронное письмо с уведомлением. Также можно управлять преобразованием атрибутов с помощью Microsoft Graph API.


## <a name="agent-installation"></a>Установка агента
Ниже приведено пошаговое описание того, что происходит при установке агента подготовки облака.

- Во-первых, установщик устанавливает двоичные файлы агента и службу агента, работающую под учетной записью виртуальной службы (NETWORK Сервице\аадпровисионингажент).  Учетная запись виртуальной службы — особый тип учетной записи, которая не имеет пароля и управляется ОС Windows.
- Затем программа установки запускает мастер.
- Мастер предложит ввести учетные данные Azure AD, будет выполнять проверку подлинности и получить маркер.
- Затем мастер запрашивает учетные данные администратора домена текущего компьютера.
- Используя эти учетные данные, можно создать или найти общую управляемую учетную запись службы агента (GMSA) для этого домена, если она уже существует.
- Служба агента теперь перенастроена для запуска в GMSA.
- Теперь мастер запрашивает конфигурацию домена вместе с учетной записью администратора предприятия (EA)/Domain Admin (DA) для каждого домена, который должен обслуживать агент.
- Затем учетная запись GMSA обновляется с разрешениями, которые обеспечивают доступ к каждому домену, указанному выше.
- Затем мастер запускает регистрацию агента.
- Агент создает сертификат и использует маркер Azure AD, регистрирует себя и сертификат со службой регистрации гибридной службы удостоверений ().
- Мастер запускает вызов Ажентресаурцеграупинг. Этот вызов к службе администратора заключается в назначении агента одному или нескольким доменам AD в своей конфигурации.
- Теперь мастер перезапускает службу агента.
- Агент вызывает службу начальной загрузки при перезапуске (а затем каждые 10 минут) для проверки наличия обновлений конфигурации.  Служба начальной загрузки проверяет удостоверение агента.  Он также обновляет время последней загрузки.  Это важно, поскольку если агенты не загружаются, они не получают обновленные конечные точки служебной шины и не могут получать запросы. 


## <a name="what-is-system-for-cross-domain-identity-management-scim"></a>Что такое System for Cross-domain Identity Management (SCIM)?

[Спецификация scim](https://tools.ietf.org/html/draft-scim-core-schema-01) — это стандарт, который используется для автоматизации обмена идентификационными данными пользователя или группы между доменами удостоверений, такими как Azure AD. SCIM становится де-факто стандартом для подготовки и при использовании в сочетании со стандартами федерации, такими как SAML или OpenID Connect, предоставляет администраторам комплексное стандартизированное решение для управления доступом.

Azure AD Connect агент подготовки облака использует SCIM с Azure AD для подготовки и отмены подготовки пользователей и групп.

## <a name="synchronization-flow"></a>Поток синхронизации
![Подготовка ](media/concept-how-it-works/provisioning-4.png) после установки агента и включения подготовки, выполняется следующая последовательность.

1.  После настройки Служба подготовки Azure AD вызывает гибридную службу Azure AD для добавления запроса в служебную шину. Агент постоянно поддерживает исходящее подключение к служебной шине, слушающую запросы, и немедленно выбирает систему для запроса на управление удостоверениями (SCIM). 
2.  Агент разбивает запрос на отдельные запросы на основе типа объекта. 
3.  AD возвращает результат агенту, а агент фильтрует эти данные перед их отправкой в Azure AD.  
4.  Агент возвращает ответ SCIM в Azure AD.  Эти ответы основываются на фильтрации, которая произошла в агенте.  Агент использует области для фильтрации результатов. 
5.  Служба подготовки записывает изменения в Azure AD.
6. Если это разностная синхронизация, а не полная синхронизация, то используется файл cookie/водяной знак. Новые запросы будут получать изменения из этого файла cookie или водяного знака в обратном порядке.

## <a name="supported-scenarios"></a>Поддерживаемые сценарии:
Для облачной синхронизации поддерживаются следующие сценарии.


- **Существующий гибридный клиент с новым лесом**: для основных лесов используется синхронизация Azure AD Connect. Облачная Синхронизация используется для подготовки из леса AD (включая отключенные). Дополнительные сведения [см. в этом руководстве](tutorial-existing-forest.md).

 ![Существующая гибридная среда](media/tutorial-existing-forest/existing-forest-new-forest-2.png)
- **Новый гибридный клиент**: Синхронизация Azure AD Connect не используется. Облачная Синхронизация используется для подготовки из леса AD.  Дополнительные сведения [см. в этом руководстве](tutorial-single-forest.md).
 
 ![Новые клиенты](media/tutorial-single-forest/diagram-2.png)

- **Существующий гибридный клиент**: для основных лесов используется синхронизация Azure AD Connect. Облачная Синхронизация предназначена для небольшого набора пользователей в [основных лесах.](tutorial-existing-forest.md)

 ![Существующий пилотный проект](media/tutorial-migrate-aadc-aadccp/diagram-2.png)

Дополнительные сведения см. в разделе [Поддерживаемые топологии](plan-cloud-sync-topologies.md).



## <a name="next-steps"></a>Дальнейшие действия 

- [Что собой представляет подготовка?](what-is-provisioning.md)
- [Что представляет собой облачная синхронизация Azure AD Connect?](what-is-cloud-sync.md)
