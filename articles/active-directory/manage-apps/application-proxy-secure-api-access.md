---
title: Доступ к локальным API с помощью Azure AD Application Proxy
description: Прокси приложения Azure Active Directory позволяет собственным приложениям безопасно обращаться к API и бизнес-логике, размещенным локально или на облачных виртуальных машинах.
services: active-directory
author: kenwith
manager: daveba
ms.service: active-directory
ms.subservice: app-mgmt
ms.workload: identity
ms.topic: how-to
ms.date: 02/12/2020
ms.author: kenwith
ms.reviewer: japere
ms.openlocfilehash: 9341646f32f6a2e05397b072d3f63186964fbd88
ms.sourcegitcommit: d49bd223e44ade094264b4c58f7192a57729bada
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/02/2021
ms.locfileid: "99258988"
---
# <a name="secure-access-to-on-premises-apis-with-azure-ad-application-proxy"></a>Безопасный доступ к локальным API с помощью Azure AD Application Proxy

У вас могут быть интерфейсы API бизнес-логики, работающие в локальной среде или размещенные на виртуальных машинах в облаке. Собственные приложения Android, iOS, Mac или Windows должны взаимодействовать с конечными точками API, чтобы использовать данные или обеспечивать взаимодействие с пользователем. Azure AD Application Proxy и [Библиотека проверки подлинности Майкрософт (MSAL)](../azuread-dev/active-directory-authentication-libraries.md) позволяют собственным приложениям безопасно получать доступ к локальным API. Azure Active Directory Application Proxy — это более быстрое и безопасное решение, чем открытие портов брандмауэра и управление проверкой подлинности и авторизацией на уровне приложения.

В этой статье описывается настройка решения Azure AD Application Proxy для размещения службы веб-API, к которой могут обращаться собственные приложения.

## <a name="overview"></a>Обзор

На следующей схеме показан традиционный способ публикации локальных интерфейсов API. Этот подход требует открытия входящих портов 80 и 443.

![Традиционный доступ к API](./media/application-proxy-secure-api-access/overview-publish-api-open-ports.png)

На следующей схеме показано, как можно использовать AD Application Proxy Azure для безопасной публикации API-интерфейсов без открытия входящих портов.

![Доступ к Azure AD Application Proxy API](./media/application-proxy-secure-api-access/overview-publish-api-app-proxy.png)

AD Application Proxy Azure формирует основу решения, работает как общедоступную конечную точку для доступа через API и обеспечивает проверку подлинности и авторизацию. Доступ к API-интерфейсам можно получить из огромного массива платформ с помощью библиотек [библиотеки проверки подлинности Майкрософт (MSAL)](../azuread-dev/active-directory-authentication-libraries.md) .

Так как проверка подлинности и авторизация Azure AD Application Proxy созданы на основе Azure AD, вы можете использовать условный доступ Azure AD, чтобы предоставить доступ к API, опубликованным через прокси приложения, только доверенным устройствам. Используйте присоединение к Azure AD или гибридное подключение Azure AD для настольных компьютеров и Intune, управляемых для устройств. Вы также можете воспользоваться преимуществами Azure Active Directory Premiumных функций, таких как многофакторная идентификация Azure AD, и защитой с помощью машинного обучения [защиты идентификации Azure](../identity-protection/overview-identity-protection.md).

## <a name="prerequisites"></a>предварительные требования

Для выполнения этого пошагового руководства необходимо следующее:

- Административный доступ к каталогу Azure с учетной записью, которая может создавать и регистрировать приложения
- Пример веб-API и собственные клиентские приложения из [https://github.com/jeevanbisht/API-NativeApp-ADAL-SampleApp](https://github.com/jeevanbisht/API-NativeApp-ADAL-SampleApp)

## <a name="publish-the-api-through-application-proxy"></a>Публикация API через прокси приложения

Чтобы опубликовать API за пределами интрасети через прокси приложения, следуйте той же схеме, что и для публикации веб-приложений. Дополнительные сведения см. [в разделе Учебник. Добавление локального приложения для удаленного доступа через прокси приложения в Azure Active Directory](application-proxy-add-on-premises-application.md).

Чтобы опубликовать веб-API Секретапи через прокси приложения, выполните следующие действия.

1. Создайте и опубликуйте пример проекта Секретапи как веб-приложение ASP.NET на локальном компьютере или в интрасети. Убедитесь, что веб-приложение можно использовать локально.

1. На [портале Azure](https://portal.azure.com)выберите **Azure Active Directory**. Затем выберите **корпоративные приложения**.

1. В верхней части страницы **корпоративные приложения — все приложения** выберите пункт **новое приложение**.

1. На странице **Добавление приложения** выберите **локальные приложения**. Откроется страница **Добавить собственное локальное приложение** .

1. Если соединитель прокси приложения не установлен, вам будет предложено установить его. Выберите **скачать соединитель прокси приложения** , чтобы скачать и установить соединитель.

1. После установки соединителя прокси приложения на странице **Добавление локального приложения** выполните следующие действия.

   1. Рядом с **именем** введите *секретапи*.

   1. В поле **внутренний URL-адрес** введите URL-адрес, используемый для доступа к API из интрасети.

   1. Убедитесь, что **Предварительная проверка подлинности** имеет значение **Azure Active Directory**.

   1. Выберите **Добавить** в верхней части страницы и дождитесь создания приложения.

   ![Добавить приложение API](./media/application-proxy-secure-api-access/3-add-api-app.png)

1. На странице **корпоративные приложения — все приложения** выберите приложение **секретапи** .

1. На странице **секретапи-Overview (обзор** ) выберите **свойства** в области навигации слева.

1. Вы не хотите, чтобы интерфейсы API были доступны конечным пользователям на панели " **MyApps** ", поэтому установите для параметра **видимые пользователи** значение **нет** в нижней части страницы **Свойства** , а затем нажмите кнопку **сохранить**.

   ![Не отображается для пользователей](./media/application-proxy-secure-api-access/5-not-visible-to-users.png)

Вы опубликовали веб-API с помощью Azure AD Application Proxy. Теперь добавьте пользователей, которые имеют доступ к приложению.

1. На странице **секретапи-Overview (обзор** ) выберите **Пользователи и группы** в левой области навигации.

1. На странице **Пользователи и группы** выберите **Добавить пользователя**.

1. На странице **Добавление назначения** выберите **Пользователи и группы**.

1. На странице **Пользователи и группы** найдите и выберите пользователей, которые имеют доступ к приложению, включая по крайней мере. Выбрав все пользователи, нажмите **кнопку Выбрать**.

   ![Выбор и назначение пользователя](./media/application-proxy-secure-api-access/7-select-admin-user.png)

1. Вернитесь на страницу **Добавление назначения** и выберите **назначить**.

> [!NOTE]
> Для API, использующих встроенную проверку подлинности Windows, могут потребоваться [Дополнительные действия](./application-proxy-configure-single-sign-on-with-kcd.md).

## <a name="register-the-native-app-and-grant-access-to-the-api"></a>Регистрация собственного приложения и предоставление доступа к API

Собственные приложения — это программы, разработанные для использования на определенной платформе или устройстве. Прежде чем ваше собственное приложение сможет подключиться к API и получить к нему доступ, его необходимо зарегистрировать в Azure AD. В следующих шагах показано, как зарегистрировать собственное приложение и предоставить ему доступ к веб-API, опубликованному через прокси приложения.

Чтобы зарегистрировать собственное приложение Апппроксинативеаппсампле, выполните следующие действия.

1. На странице **обзор** Azure Active Directory выберите **Регистрация приложений** и в верхней части области **Регистрация приложений** выберите пункт **Новая регистрация**.

1. На странице **Регистрация приложения** сделайте следующее:

   1. В поле **имя** введите *апппроксинативеаппсампле*.

   1. В разделе **Поддерживаемые типы учетных записей** выберите **Accounts in any organizational directory and personal Microsoft accounts** (Учетные записи в любом каталоге организации и личные учетные записи Майкрософт).

   1. В разделе **URL-адрес перенаправления** раскрывающийся список и выберите **общедоступный клиент (мобильный & Desktop)**, а затем введите *https://login.microsoftonline.com/common/oauth2/nativeclient* .

   1. Выберите **зарегистрировать** и подождите, пока приложение будет успешно зарегистрировано.

      ![Регистрация нового приложения](./media/application-proxy-secure-api-access/8-create-reg-ga.png)

Теперь вы зарегистрировали приложение Апппроксинативеаппсампле в Azure Active Directory. Чтобы предоставить собственному приложению доступ к веб-API Секретапи, выполните следующие действия.

1. На странице Azure Active Directory **Обзор**  >  **регистраций приложений** выберите приложение **апппроксинативеаппсампле** .

1. На странице **апппроксинативеаппсампле** выберите **разрешения API** в левой области навигации.

1. На странице **разрешения API** выберите **Добавить разрешение**.

1. На странице **разрешения API первого запроса** выберите **API-интерфейсы, используемые моей организацией** , а затем найдите и выберите **секретапи**.

1. На странице следующие **разрешения API запроса** установите флажок рядом с **user_impersonation**, а затем выберите **Добавить разрешения**.

    ![Выбор API](./media/application-proxy-secure-api-access/10-secretapi-added.png)

1. На странице **разрешения API** можно выбрать параметр **предоставить согласие администратора для Contoso** , чтобы запретить другим пользователям индивидуальное согласие на доступ к приложению.

## <a name="configure-the-native-app-code"></a>Настройка кода собственного приложения

Последним шагом является настройка собственного приложения. В следующем фрагменте кода из файла *Form1.CS* в примере приложения NATIVECLIENT библиотека MSAL получает маркер для запроса вызова API и присоединяет его как носитель к заголовку приложения.

   ```
   // Acquire Access Token from AAD for Proxy Application
 IPublicClientApplication clientApp = PublicClientApplicationBuilder
.Create(<App ID of the Native app>)
.WithDefaultRedirectUri() // will automatically use the default Uri for native app
.WithAuthority("https://login.microsoftonline.com/{<Tenant ID>}")
.Build();

AuthenticationResult authResult = null;
var accounts = await clientApp.GetAccountsAsync();
IAccount account = accounts.FirstOrDefault();

IEnumerable<string> scopes = new string[] {"<Scope>"};

try
 {
    authResult = await clientApp.AcquireTokenSilent(scopes, account).ExecuteAsync();
 }
    catch (MsalUiRequiredException ex)
 {
     authResult = await clientApp.AcquireTokenInteractive(scopes).ExecuteAsync();                
 }
 
if (authResult != null)
 {
  //Use the Access Token to access the Proxy Application
  
  HttpClient httpClient = new HttpClient();
  HttpClient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", authResult.AccessToken);
  HttpResponseMessage response = await httpClient.GetAsync("<Proxy App Url>");
 }
```

Чтобы настроить собственное приложение для подключения к Azure Active Directory и вызова прокси приложения API, обновите значения заполнителей в файле *App.config* примера приложения NativeClient, указав значения из Azure AD:

- Вставьте в поле **идентификатор каталога (клиента)** `<add key="ida:Tenant" value="" />` . Это значение (GUID) можно найти и скопировать на странице **Обзор** любого из ваших приложений.

- Вставьте в поле **идентификатор приложения (клиента)** апппроксинативеаппсампле `<add key="ida:ClientId" value="" />` . Это значение (GUID) можно найти и скопировать на странице **обзора** апппроксинативеаппсампле.

- Вставьте **URI перенаправления** апппроксинативеаппсампле в `<add key="ida:RedirectUri" value="" />` поле. Это значение (URI) можно найти и скопировать на странице **проверки подлинности** апппроксинативеаппсампле.

- Вставьте **URI идентификатора приложения** секретапи в `<add key="todo:TodoListResourceId" value="" />` поле. Это значение (URI) можно найти и скопировать в Секретапи **предоставить страницу API** .

- Вставьте **URL-адрес домашней страницы** секретапи в `<add key="todo:TodoListBaseAddress" value="" />` поле. Это значение (URL-адрес) можно найти и скопировать на странице **фирменной символики** секретапи.

После настройки параметров выполните сборку и запустите собственное приложение. При нажатии кнопки **входа** приложение позволяет войти в систему, а затем отображает экран успешного завершения, чтобы убедиться, что он успешно подключен к секретапи.

![На снимке экрана показан секрет сообщения «P I успешно» и кнопка «ОК».](./media/application-proxy-secure-api-access/success.png)

## <a name="next-steps"></a>Дальнейшие действия

- [Руководство по Добавление локального приложения для удаленного доступа через Application Proxy в Azure Active Directory](application-proxy-add-on-premises-application.md)
- [Краткое руководство. Настройка клиентского приложения для доступа к веб-API](../develop/quickstart-configure-app-access-web-apis.md)
- [Включение собственных клиентских приложений для взаимодействия с приложениями прокси](application-proxy-configure-native-client-application.md)