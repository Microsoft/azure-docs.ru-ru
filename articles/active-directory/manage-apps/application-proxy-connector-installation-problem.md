---
title: Проблема при установке соединителя агента прокси приложения
description: Устранение неполадок, которые могут возникнуть при установке соединителя агента прокси приложения для Azure Active Directory.
services: active-directory
author: kenwith
manager: celestedg
ms.service: active-directory
ms.subservice: app-mgmt
ms.workload: identity
ms.topic: troubleshooting
ms.date: 01/28/2021
ms.author: kenwith
ms.reviewer: japere
ms.openlocfilehash: 04c26609b046f7525c513796622be74633a20e91
ms.sourcegitcommit: 04297f0706b200af15d6d97bc6fc47788785950f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/28/2021
ms.locfileid: "98986774"
---
# <a name="problem-installing-the-application-proxy-agent-connector"></a>Проблема при установке соединителя агента прокси приложения

Соединитель прокси приложения Microsoft Azure Active Directory — это внутренний компонент домена, использующий исходящие подключения для установления подключения из конечной точки, доступной в облаке, к внутреннему домену.

## <a name="general-problem-areas-with-connector-installation"></a>Общие проблемные области при установке соединителя

При сбое установки соединителя основная причина обычно является одной из следующих областей. **В качестве основы при устранении неполадок обязательно перезагрузите соединитель.**

1.  **Подключение** — для успешной установки новому соединителю нужно зарегистрироваться и установить свойства доверия. Это делается путем подключения к Azure Active Directory Application Proxy облачной службе.

2.  **Установление отношений доверия** — новый соединитель создает самозаверяющий сертификат и регистрируется в облачной службе.

3.  **Проверка подлинности администратора** — для завершения установки соединителя пользователю нужно предоставить учетные данные администратора.

> [!NOTE]
> Журналы установки соединителя находятся в папке% TEMP%. они могут помочь в предоставлении дополнительных сведений о причинах сбоя установки.

## <a name="verify-connectivity-to-the-cloud-application-proxy-service-and-microsoft-login-page"></a>Проверка подключения к прокси-службе облачного приложения и странице входа Майкрософт

**Цель:** Убедитесь, что компьютер соединителя может подключаться к конечной точке регистрации прокси приложения, а также к странице входа Майкрософт.

1.  На сервере соединителя выполните проверку порта с помощью [Telnet](/windows-server/administration/windows-commands/telnet) или другого средства тестирования портов, чтобы убедиться, что порты 443 и 80 открыты.

2.  Если какой-либо из этих портов не прошел успешно, убедитесь, что брандмауэр или серверный прокси имеет доступ к нужным доменам и портам, а затем [Подготовьте локальную среду](application-proxy-add-on-premises-application.md#prepare-your-on-premises-environment).

3.  Откройте браузер (отдельную вкладку), перейдите к веб-странице `https://login.microsoftonline.com` и убедитесь, что можете войти на эту страницу.

## <a name="verify-machine-and-backend-components-support-for-application-proxy-trust-certificate"></a>Проверка поддержки компьютеров и серверных компонентов для сертификата доверия прокси приложения

**Цель:** Убедитесь, что компьютер соединителя, внутренний прокси-сервер и брандмауэр могут поддерживать сертификат, созданный соединителем для будущего доверия, и что сертификат действителен.

>[!NOTE]
>Соединитель пытается создать сертификат SHA512, поддерживаемый TLS1.2. Если компьютер или серверный брандмауэр и прокси-сервер не поддерживают TLS 1.2, установка завершается сбоем.
>
>

**Ознакомьтесь с необходимыми предварительными требованиями:**

1.  Убедитесь, что компьютер поддерживает TLS1.2. Для этого требуется версия Windows после 2012 R2. Если на компьютере соединителя используется версия 2012 R2 или более ранняя, убедитесь, что на нем установлены следующие пакеты обновления: <https://support.microsoft.com/help/2973337/sha512-is-disabled-in-windows-when-you-use-tls-1.2>

2.  Обратитесь к администратору сети и попросите убедиться, что внутренний прокси-сервер и брандмауэр не блокируют SHA512 для исходящего трафика.

**Чтобы проверить сертификат клиента, выполните следующие действия.**

Проверьте отпечаток текущего сертификата клиента. Хранилище сертификатов можно найти в `%ProgramData%\microsoft\Microsoft AAD Application Proxy Connector\Config\TrustSettings.xml` .

```
<?xml version="1.0" encoding="utf-8"?>
<ConnectorTrustSettingsFile xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <CloudProxyTrust>
    <Thumbprint>4905CC64B2D81BBED60962ECC5DCF63F643CCD55</Thumbprint>
    <IsInUserStore>false</IsInUserStore>
  </CloudProxyTrust>
</ConnectorTrustSettingsFile>
```

Возможные значения **исинусерсторе** : **true** и **false**. Значение **true** означает, что автоматически обновленный сертификат хранится в личном контейнере в хранилище сертификатов пользователя сетевой службы. Значение **false** означает, что сертификат клиента был создан во время установки или регистрации, инициированного Register-AppProxyConnectorной командой, и хранится в личном контейнере в хранилище сертификатов на локальном компьютере.

Если значение равно **true**, выполните следующие действия для проверки сертификата:
1. Скачать [PsTools.zip](/sysinternals/downloads/pstools)
2. Извлеките [PsExec](/sysinternals/downloads/psexec) из пакета и выполните команду **PsExec-i-u "NT authority\network Service" cmd.exe** из командной строки с повышенными привилегиями.
3. Запустите **CertMgr. msc** в вновь появившийся командной строке.
4. В консоли управления разверните личный контейнер и щелкните Сертификаты.
5. Определение местонахождения сертификата, выданного **connectorregistrationca.msappproxy.NET**

Если значение равно **false**, выполните следующие действия для проверки сертификата:
1. Запуск **certlm. msc**
2. В консоли управления разверните личный контейнер и щелкните Сертификаты.
3. Определение местонахождения сертификата, выданного **connectorregistrationca.msappproxy.NET**

**Чтобы продлить сертификат клиента, выполните следующие действия.**

Если соединитель несколько месяцев не подключается к службе, возможно, его сертификаты устарели. Сбой обновления сертификата приводит к просроченному сертификату. Это позволит службе соединителя перестать работать. Событие 1000 регистрируется в журнале администратора соединителя:

"Сбой повторной регистрации соединителя: срок действия сертификата доверия соединителя истек. Выполните командлет PowerShell Register-AppProxyConnector на компьютере, на котором запущен соединитель, чтобы повторно зарегистрировать соединитель. "

В этом случае удалите и переустановите соединитель для активации регистрации или выполните следующие команды PowerShell:

```
Import-module AppProxyPSModule
Register-AppProxyConnector
```

Дополнительные сведения о команде Register-AppProxyConnector см. в статье [Создание сценария автоматической установки для соединителя AD application proxy Azure](./application-proxy-register-connector-powershell.md) .

## <a name="verify-admin-is-used-to-install-the-connector"></a>Проверка прав администратора у пользователя, устанавливающего соединитель

**Цель:** убедитесь, что пользователь, пытающийся установить соединитель, является администратором с подходящими учетными данными. В настоящее время для успешности установки пользователь должен быть по крайней мере администратором приложения.

**Проверка правильности учетных данных:**

Подключитесь к `https://login.microsoftonline.com` и используйте те же учетные данные. Убедитесь, что вход прошел успешно. Чтобы проверить роль пользователя, перейдите в **Azure Active Directory**  - &gt; **Пользователи и группы**  - &gt; **все пользователи**. 

Выберите учетную запись пользователя, а затем "роль каталога" в итоговом меню. Убедитесь, что выбрана роль "Администратор приложения". Если вам не удается открыть какие-либо страницы при выполнении описанных действий, у вас нет нужной роли.

## <a name="next-steps"></a>Дальнейшие действия
[Сведения о соединителях прокси приложения Azure AD](application-proxy-connectors.md)
