---
title: Использование ограничений клиентов для управления доступом к приложениям SaaS в Azure AD
description: Сведения об использовании ограничений клиентов для управления доступом пользователей к приложениям на основе их клиента Azure AD.
services: active-directory
author: kenwith
manager: daveba
ms.service: active-directory
ms.subservice: app-mgmt
ms.workload: identity
ms.topic: conceptual
ms.date: 10/26/2020
ms.author: kenwith
ms.reviewer: hpsin
ms.collection: M365-identity-device-management
ms.openlocfilehash: f605b2bb48855d70ea305dcda194b26da71ee9ec
ms.sourcegitcommit: d49bd223e44ade094264b4c58f7192a57729bada
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/02/2021
ms.locfileid: "99252480"
---
# <a name="use-tenant-restrictions-to-manage-access-to-saas-cloud-applications"></a>Использование ограничений клиентов для управления доступом к облачным приложениям SaaS

Крупные организации, которые подчеркивают безопасность, хотят перейти на облачные службы, такие как Microsoft 365, но должны знать, что их пользователи имеют доступ только к утвержденным ресурсам. В большинстве случаев для управления доступом компании ограничивают доменные имена или IP-адреса. Такой подход не работает в среде, в которой приложения программного обеспечения как услуги (или SaaS) размещены в общедоступном облаке, выполняющемся на общих доменных именах, таких как [outlook.office.com](https://outlook.office.com/) и [login.microsoftonline.com](https://login.microsoftonline.com/). Блокирование этих адресов полностью запретит пользователям интернет-доступ к Outlook, а не просто ограничит его в соответствии с утвержденными удостоверениями и ресурсами.

Решением, которое Azure Active Directory (Azure AD) предлагает для этой задачи, является функция, называемая ограничением клиентов. Ограничение клиентов позволяет организациям управлять доступом к облачным приложениям SaaS на основе клиента Azure AD, используемого приложениями для единого входа. Например, может потребоваться разрешить доступ к приложениям Microsoft 365 вашей организации, одновременно запретив доступ к экземплярам этих же приложений других организаций.  

Ограничение клиентов дает организациям возможность указать список клиентов, доступ к которым разрешен пользователям. После этого Azure AD только предоставляет доступ к этим разрешенным клиентам.

В этой статье рассматриваются ограничения клиента для Microsoft 365, но функция должна работать с любым облачным приложением SaaS, использующим современные протоколы проверки подлинности с Azure AD для единого входа. Если вы используете приложения SaaS с другим клиентом Azure AD из клиента, используемого Microsoft 365, убедитесь, что разрешены все необходимые клиенты. Дополнительные сведения об облачных приложениях SaaS см. на сайте [Active Directory Marketplace](https://azuremarketplace.microsoft.com/marketplace/apps/Microsoft.AzureActiveDirectory).

## <a name="how-it-works"></a>Принцип работы

В общих чертах решение состоит из следующих компонентов.

1. **Azure AD**. Если `Restrict-Access-To-Tenants: <permitted tenant list>` заголовок имеется, Azure AD выдает только маркеры безопасности для разрешенных клиентов.

2. **Инфраструктура локального прокси-сервера**. Эта инфраструктура является прокси-сервером, поддерживающим проверку по протоколу TLS. Вам необходимо настроить прокси-сервер для вставки заголовка, содержащего список разрешенных клиентов, в трафик, предназначенный для Azure AD.

3. **Клиентское программное обеспечение**. Для поддержки ограничения клиентов клиентское программное обеспечение должно запрашивать маркеры непосредственно из Azure AD, чтобы трафик мог быть перехвачен инфраструктурой прокси-сервера. Приложения Microsoft 365 на основе браузера в настоящее время поддерживают ограничения клиентов, так же как и клиенты Office, использующие современную проверку подлинности (например, OAuth 2,0).

4. **Современная проверка подлинности**. Облачные службы должны применять современные протоколы аутентификации, чтобы использовать ограничение и блокировать доступ для всех запрещенных клиентов. Для использования современных протоколов проверки подлинности по умолчанию необходимо настроить Microsoft 365 облачные службы. Последние сведения о Microsoft 365 поддержки современной проверки подлинности см. в статье [обновленная современная проверка подлинности Office 365](https://www.microsoft.com/en-us/microsoft-365/blog/2015/03/23/office-2013-modern-authentication-public-preview-announced/).

На следующей схеме показан общий маршрут прохождения трафика. Ограничения клиента требуют проверки TLS только для трафика в Azure AD, а не Microsoft 365 облачных служб. Это различие очень важно, так как объем трафика для аутентификации в Azure AD обычно гораздо меньше, чем объем трафика к приложениям SaaS, например Exchange Online и SharePoint Online.

![Схема движения трафика при использовании ограничения клиентов](./media/tenant-restrictions/traffic-flow.png)

## <a name="set-up-tenant-restrictions"></a>Настройка ограничения клиентов

Чтобы приступить к работе с ограничением клиентов, нужно выполнить два шага. Первый — убедиться, что ваши клиенты могут подключиться к соответствующим адресам. Второй — настроить инфраструктуру прокси-сервера.

### <a name="urls-and-ip-addresses"></a>URL-адреса и IP-адреса

Чтобы использовать ограничение клиентов, ваши клиенты должны иметь возможность подключаться к следующим URL-адресам Azure AD для прохождения аутентификации: [login.microsoftonline.com](https://login.microsoftonline.com/), [login.microsoft.com](https://login.microsoft.com/), и [login.windows.net](https://login.windows.net/). Кроме того, для доступа к Office 365 клиенты также должны подключаться к полным доменным именам (FQDN), URL-адресам и IP-адресам, определенным на странице [URL-адреса и диапазоны IP-адресов Office 365](https://support.office.com/article/Office-365-URLs-and-IP-address-ranges-8548a211-3fe7-47cb-abb1-355ea5aa88a2). 

### <a name="proxy-configuration-and-requirements"></a>Конфигурация и требования прокси-сервера

Для применения ограничения клиентов с помощью инфраструктуры прокси-сервера требуется следующая конфигурация. Данное руководство является универсальным, поэтому за определенными инструкциями по реализации следует обратиться к документации поставщика вашего прокси-сервера.

#### <a name="prerequisites"></a>Предварительные требования

- Прокси-сервер должен поддерживать перехват TLS, вставку заголовка HTTP и фильтрацию назначения с использованием FQDN или URL-адресов.

- Клиенты должны доверять цепочке сертификатов, представляемой прокси-сервером для взаимодействия по протоколу TLS. Например, если используются сертификаты из внутренней [инфраструктуры открытых ключей (PKI)](/windows/desktop/seccertenroll/public-key-infrastructure), то сертификаты, выдаваемые внутренним корневым центром сертификации, должны быть доверенными.

- Для использования ограничений клиента требуются Azure AD Premium 1 лицензии. 

#### <a name="configuration"></a>Конфигурация

Для каждого входящего запроса к login.microsoftonline.com login.microsoft.com и login.windows.net следует вставлять два заголовка HTTP: *Restrict-Access-To-Tenants* и *Restrict-Access-Context*.

> [!NOTE]
> При настройке перехвата SSL и внедрения заголовка убедитесь, что трафик, который следует https://device.login.microsoftonline.com исключить, исключен. Этот URL-адрес используется для проверки подлинности устройства и выполнения проверки подлинности TLS, что может вызвать проблемы с регистрацией устройств и условным доступом на основе устройств.



Эти заголовки должен содержать следующие элементы.

- Для *ограничения-доступа к клиентам* используйте значение \<permitted tenant list\> , которое представляет собой разделенный запятыми список клиентов, к которым требуется предоставить доступ пользователям. Любой домен, зарегистрированный в клиенте, можно использовать для идентификации клиента в этом списке, а также для самого идентификатора каталога. В качестве примера всех трех способов описания клиента пара "имя-значение", разрешающая Contoso, Fabrikam и Майкрософт, выглядит следующим образом: `Restrict-Access-To-Tenants: contoso.com,fabrikam.onmicrosoft.com,72f988bf-86f1-41af-91ab-2d7cd011db47`

- Для *Restrict-Access-Context* используйте значение отдельного идентификатора каталога, объявляющего, какой клиент устанавливает ограничение клиентов. Например, чтобы объявить Contoso в качестве клиента, который задает политику ограничений клиента, пара "имя-значение" выглядит следующим образом: `Restrict-Access-Context: 456ff232-35l2-5h23-b3b3-3236w0826f3d` .  В этом месте **необходимо** использовать собственный идентификатор каталога.

> [!TIP]
> Идентификатор каталога вы можете найти на [портале Azure Active Directory](https://aad.portal.azure.com/). Войдите в качестве администратора, выберите **Azure Active Directory** слева, затем выберите **Свойства**. 
>
> Чтобы проверить, что идентификатор каталога или имя домена относятся к одному и тому же клиенту, используйте этот идентификатор или домен вместо <tenant> в этом URL-адресе: `https://login.microsoftonline.com/<tenant>/v2.0/.well-known/openid-configuration` .  Если результаты с доменом и ИДЕНТИФИКАТОРом совпадают, они ссылаются на один и тот же клиент. 

Чтобы запретить пользователям вставлять собственный заголовок HTTP с помощью неутвержденных клиентов, прокси-сервер должен заменять заголовок *Restrict-Access-To-Tenants*, если он уже существует во входящем запросе.

Клиенты должны принудительно использовать прокси-сервер для всех запросов к login.microsoftonline.com, login.microsoft.com и login.windows.net. Например, если для указания клиентам использовать прокси-сервер применяются PAC-файлы, то пользователи не должны иметь возможности изменить или отключить эти файлы.

> [!NOTE]
> Не включайте поддомены в папке *. login.microsoftonline.com в конфигурации прокси-сервера. Это приведет к включению device.login.microsoftonline.com и может помешать проверке подлинности на основе сертификата клиента, которая используется в регистрации устройств и сценариях условного доступа на базе устройств. Настройте прокси-сервер, чтобы исключить device.login.microsoftonline.com из TLS-проверки и внедрения заголовка.

## <a name="the-user-experience"></a>Взаимодействие с пользователями

В этом разделе описано взаимодействие с пользователями и администраторами.

### <a name="end-user-experience"></a>Возможности для пользователей

Например, пользователь находится в сети компании Contoso, но пытается получить доступ к экземпляру Fabrikam такого общего приложения SaaS, как Outlook в Интернете. Если Fabrikam является неразрешенным клиентом для экземпляра Contoso, пользователь увидит сообщение об отказе в доступе, в котором говорится о попытке получить доступ к ресурсу, принадлежащему организации, неутвержденной вашим ИТ-отделом.

### <a name="admin-experience"></a>Возможности для администраторов

Хотя настройка ограничения клиентов выполняется в корпоративной инфраструктуре прокси-сервера, администраторы могут просмотреть отчеты по ограничению клиентов непосредственно на портале Azure. Для просмотра отчетов выполните следующие действия:

1. Войдите на [портал Azure Active Directory](https://aad.portal.azure.com/). Откроется панель мониторинга **центра администрирования Azure Active Directory**.

2. В области слева выберите **Azure Active Directory**. Появится страница с общими сведениями об Azure Active Directory.

3. На странице Обзор выберите **ограничения клиента**.

Администратор клиента, для которого задан контекст Restricted-Access-Context, может использовать этот отчет, чтобы просматривать попытки входа, заблокированные из-за политики ограничения клиентов, включая использованное удостоверение и идентификатор целевого каталога. Входы отображаются, если на клиенте установлено соответствующее ограничение для клиента пользователя или ресурса.

> [!NOTE]
> Отчет может содержать ограниченные сведения, например идентификатор целевого каталога, при входе в систему пользователя, который находится в клиенте, отличном от Restricted-Access-Context. В этом случае идентификационные данные пользователя, такие как имя и имя участника-пользователя, замаскированы для защиты данных пользователей в других клиентах (" 00000000-0000-0000-0000-00000000@domain.com "). 

Как и в других отчетах на портале Azure, можно использовать фильтры, чтобы задать определенную область. Вы можете настроить фильтр по определенному интервалу времени, пользователю, приложению, клиенту или состоянию. При нажатии кнопки **Столбцы** можно выбрать отображение данных с любым сочетанием следующих полей:

- **Пользователь**
- **Приложение**
- **Состояние**
- **Дата**
- **Дата (UTC)** (где UTC — всемирное скоординированное время)
- **Способ многофакторной идентификации** (метод многофакторной проверки подлинности)
- **Сведения о многофакторной идентификации** (сведения о многофакторной проверке подлинности)
- **Результат MFA**;
- **IP-адрес**;
- **Клиент**
- **Имя пользователя**
- **Расположение**
- **ИД целевого клиента**.

## <a name="microsoft-365-support"></a>Поддержка Microsoft 365

Microsoft 365 приложения должны отвечать двум критериям, чтобы полностью поддерживать ограничения клиентов:

1. Используемый клиент должен поддерживать современную аутентификацию.
2. Современная аутентификация должна использоваться по умолчанию для облачной службы.

Ознакомьтесь со статьей [Updated Office 365 modern authentication](https://www.microsoft.com/en-us/microsoft-365/blog/2015/03/23/office-2013-modern-authentication-public-preview-announced/) (Обновление поддержи современной аутентификации в Office 365), чтобы получить последние сведения о том, какие клиенты Office сейчас поддерживают современную аутентификацию. На этой странице также указаны ссылки на инструкции по включению современной аутентификации для конкретных клиентов Exchange Online и Skype для бизнеса Online. Современная аутентификация уже включена по умолчанию в SharePoint Online.

Microsoft 365 приложения на основе браузера (портал Office, Yammer, сайты SharePoint, Outlook в Интернете и др.) в настоящее время поддерживают ограничения клиентов. Толстые клиенты (Outlook, Skype для бизнеса, Word, Excel, PowerPoint и др.) могут применять ограничения клиента только при использовании современной проверки подлинности.  

Клиенты Outlook и Skype для бизнеса, которые поддерживают современную аутентификацию, по-прежнему могут использовать устаревшие протоколы для клиентов, не поддерживающих современную аутентификацию, эффективно обходя политику ограничения клиентов. Приложения, использующие устаревшие протоколы, могут быть заблокированы из-за ограничения клиентов, если при аутентификации приложения подключаются к URL-адресам login.microsoftonline.com, login.microsoft.com или login.windows.net.

Для Outlook в Windows клиенты могут добавить ограничения, запрещающие пользователям добавлять неутвержденые учетные записи почты в свои профили. Вы можете ознакомиться с примером настройки групповой политики, который [запрещает добавление нестандартных учетных записей Exchange](https://gpsearch.azurewebsites.net/default.aspx?ref=1).

## <a name="testing"></a>Тестирование

Если вы хотите опробовать политику ограничения клиентов перед ее внедрением во всей организации, существует два варианта: подход на основе узлов с использованием такого инструмента, как Fiddler, или поэтапное развертывание параметров прокси-сервера.

### <a name="fiddler-for-a-host-based-approach"></a>Использование Fiddler для подхода на основе узлов

Fiddler — бесплатный прокси-сервер веб-отладки, который может использоваться для записи и изменения трафика HTTP и HTTPS, включая вставку заголовков HTTP. Чтобы настроить Fiddler для проверки ограничения клиентов, выполните следующие действия:

1. [Скачайте и установите Fiddler](https://www.telerik.com/fiddler).

2. Настройте Fiddler для расшифровки трафика HTTPS, как описано в [справочной документации Fiddler](https://docs.telerik.com/fiddler/Configure-Fiddler/Tasks/DecryptHTTPS).

3. Настройте Fiddler для вставки заголовков *Restrict-Access-To-Tenants* и *Restrict-Access-Context* с помощью настраиваемых правил.

   1. В инструменте Fiddler Web Debugger выберите меню **Rules** (Правила) и щелкните **Customize Rules…** (Настройка правил…), чтобы открыть файл CustomRules.

   2. Добавьте в начало функции `OnBeforeRequest` следующие строки кода. Замените на \<tenant domain\> домен, зарегистрированный в клиенте (например, `contoso.onmicrosoft.com` ). Замените \<directory ID\> идентификатором GUID Azure AD клиента.

      ```JScript.NET
      if (
          oSession.HostnameIs("login.microsoftonline.com") ||
          oSession.HostnameIs("login.microsoft.com") ||
          oSession.HostnameIs("login.windows.net")
      )
      {
          oSession.oRequest["Restrict-Access-To-Tenants"] = "<tenant domain>";
          oSession.oRequest["Restrict-Access-Context"] = "<directory ID>";
      }
      ```

      Если необходимо разрешить несколько клиентов, используйте запятые для разделения их имен. Пример:

      `oSession.oRequest["Restrict-Access-To-Tenants"] = "contoso.onmicrosoft.com,fabrikam.onmicrosoft.com";`

4. Сохраните и закройте файл CustomRules.

После настройки Fiddler можно начать записывать трафик, перейдя в меню **File** (Файл) и выбрав **Capture Traffic** (Запись трафика).

### <a name="staged-rollout-of-proxy-settings"></a>Поэтапное развертывание параметров прокси-сервера

В зависимости от возможностей инфраструктуры прокси-сервера можно выполнить поэтапное развертывание параметров для пользователей. Ниже приведено несколько общих способов, которые вы можете рассмотреть.

1. Используйте PAC-файлы, чтобы направить тестовых пользователей в тестовую инфраструктуру прокси-сервера, а обычные пользователи пусть продолжат использовать рабочую инфраструктуру прокси-сервера.
2. Некоторые прокси-серверы могут поддерживать различные конфигурации с использованием групп.

Обратитесь к документации по вашему прокси-серверу, чтобы получить подробную информацию.

## <a name="next-steps"></a>Дальнейшие действия

- Ознакомьтесь со статьей [Updated Office 365 modern authentication](https://www.microsoft.com/en-us/microsoft-365/blog/2015/03/23/office-2013-modern-authentication-public-preview-announced/) (Обновление поддержи современной аутентификации в Office 365).
- Прочтите статью [URL-адреса и диапазоны IP-адресов Office 365](https://support.office.com/article/Office-365-URLs-and-IP-address-ranges-8548a211-3fe7-47cb-abb1-355ea5aa88a2).
