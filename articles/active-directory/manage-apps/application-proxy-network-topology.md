---
title: Рекомендации по топологии сети для Azure Active Directory Application Proxy
description: Рассматриваются вопросы топологии сети при использовании Azure Active Directory Application Proxy.
services: active-directory
author: kenwith
manager: daveba
ms.service: active-directory
ms.subservice: app-mgmt
ms.workload: identity
ms.topic: conceptual
ms.date: 02/22/2021
ms.author: kenwith
ms.reviewer: japere
ms.openlocfilehash: 2873bd9668bfba887ad9add061e68f36a747d5b8
ms.sourcegitcommit: 4bda786435578ec7d6d94c72ca8642ce47ac628a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/16/2021
ms.locfileid: "103492325"
---
# <a name="optimize-traffic-flow-with-azure-active-directory-application-proxy"></a>Оптимизация потока трафика с помощью Azure Active Directory Application Proxy

В этой статье объясняется, как оптимизировать поток трафика и учитывать топологию сети при использовании прокси приложения Azure Active Directory (Azure AD) для удаленной публикации и доступа к приложениям.

## <a name="traffic-flow"></a>Поток трафика

При публикации приложения через прокси приложения Azure AD весь трафик, передаваемый от пользователей к приложениям, проходит через три следующих подключения:

1. Пользователь подключается к общедоступной конечной точке службы прокси приложения Azure AD в Azure.
1. Служба прокси приложения подключается к соединителю прокси приложения.
1. Соединитель прокси приложения подключается к целевому приложению.

:::image type="content" source="./media/application-proxy-network-topology/application-proxy-three-hops.png" alt-text="Схема, показывающая поток трафика от пользователя к целевому приложению." lightbox="./media/application-proxy-network-topology/application-proxy-three-hops.png":::

## <a name="optimize-connector-groups-to-use-closest-application-proxy-cloud-service-preview"></a>Оптимизация групп соединителей для использования ближайшей облачной службы прокси приложения (Предварительная версия)

При регистрации в клиенте Azure AD регион клиента определяется указанной страной или регионом. При включении прокси приложения экземпляры облачной службы прокси приложения **по умолчанию** выбираются в том же регионе, что и клиент Azure AD, или в ближайшем для него регионе.

Например, если страна или регион вашего клиента Azure AD является Соединенным Королевством, все соединители прокси приложения **по умолчанию** будут назначены для использования экземпляров службы в европейских центрах обработки данных. Когда пользователи обращаются к опубликованным приложениям, их трафик проходит через экземпляры облачной службы прокси приложения в этом расположении.

Если соединители установлены в регионах, отличающихся от региона по умолчанию, может быть полезно изменить регион, в котором оптимизирована группа соединителей для повышения производительности доступа к этим приложениям. После указания региона для группы соединителей он будет подключаться к облачным службам прокси приложения в указанном регионе.

Чтобы оптимизировать поток трафика и сократить задержку в группе соединителей, назначьте группу соединителей ближайшему региону. Чтобы назначить регион, сделайте следующее:

> [!IMPORTANT]
> Для использования этой возможности соединители должны использовать по меньшей мере версию 1.5.1975.0.

1. Войдите на [портал Azure](https://portal.azure.com/) как администратор приложения каталога, который использует прокси приложения. Например, если домен клиента contoso.com, администратором должен быть пользователь admin@contoso.com или другой псевдоним администратора в этом домене.
1. В правом верхнем углу выберите свое имя пользователя. Убедитесь, что вы вошли в каталог, который использует Application Proxy. Если необходимо изменить каталоги, щелкните **Переключение каталога** и выберите каталог, который использует Application Proxy.
1. В области навигации слева выберите **Azure Active Directory**.
1. В разделе **Управление** выберите **Прокси приложения**.
1. Выберите **создать группу соединителей**, укажите **имя** для группы соединителей.
1. Затем в разделе **Дополнительные параметры** выберите раскрывающийся список оптимизировать для определенного региона и выберите ближайший к соединителю.
1. Нажмите кнопку **создания**.
    
    :::image type="content" source="./media/application-proxy-network-topology/geo-routing.png" alt-text="Настройте новую группу соединителей." lightbox="./media/application-proxy-network-topology/geo-routing.png":::

1. После создания новой группы соединителей можно выбрать, какие соединители будут назначены этой группе соединителей. 
   - Соединители можно перемещать только в группу соединителей, если она входит в группу соединителей, использующих регион по умолчанию. Наилучший подход заключается в том, чтобы всегда начинать с соединителей, помещенных в группу по умолчанию, а затем перемещать их в соответствующую группу соединителей.
   - Вы можете изменить область группы соединителей, если ей **не** назначены соединители или приложения.
1. Затем назначьте группе соединителей приложения. При доступе к приложениям теперь трафик должен переходить в облачную службу прокси приложения в регионе, для которого оптимизирована группа соединителей.

## <a name="considerations-for-reducing-latency"></a>Рекомендации по уменьшению задержки

Любые решения прокси увеличивают задержку сетевого подключения. Независимо от того, какое решение прокси или VPN используется для удаленного доступа, любое из них содержит набор серверов для подключения к корпоративной сети.

Организации обычно размещают серверные конечные точки в сети периметра. Однако при использовании прокси приложения Azure AD трафик проходит через прокси-службу в облаке, а соединители находятся в корпоративной сети. Сеть периметра не требуется.

В следующих разделах приведены дополнительные рекомендации по сокращению задержки. 

### <a name="connector-placement"></a>Расположение соединителя

Служба прокси приложения автоматически выбирает расположение экземпляров, исходя из расположения клиента. Тем не менее вам следует выбрать место установки соединителя, и от него будут зависеть характеристики задержки сетевого трафика.

Настраивая службу прокси приложения, задайте себе следующие вопросы:

- Где расположено приложение?
- Где находится больше всего пользователей, обращающихся к приложению?
- Где находится экземпляр прокси приложения?
- Есть ли у вас выделенное сетевое подключение к центрам обработки данных Azure (например, Azure ExpressRoute или аналогичное VPN-подключение)?

Соединитель должен взаимодействовать с Azure и приложениями (шаги 2 и 3 на схеме потока трафика), поэтому расположение соединителя влияет на задержку этих двух подключений. При выборе расположения для соединителя учитывайте следующее.

- Если вы хотите использовать ограниченное делегирование Kerberos (KCD) для единого входа, то соединителю нужен "канал прямой видимости" к центру обработки данных. Кроме того, сервер соединителя должен быть присоединен к домену.  
- Если вы сомневаетесь, установите соединитель ближе к приложению.

### <a name="general-approach-to-minimize-latency"></a>Общий подход к уменьшению задержки

Вы можете уменьшить задержку сквозного трафика, оптимизировав каждое из сетевых подключений. Каждое подключение можно оптимизировать следующим образом:

- уменьшить расстояние между двумя конечными точками прыжка;
- выбрать нужную сеть для прохода (например, проход частной сети, а не общедоступного Интернета, может выполняться быстрее из-за выделенных каналов связи).

Можно использовать выделенный канал связи VPN или ExpressRoute между Azure и корпоративной сетью, если он у вас есть.

## <a name="focus-your-optimization-strategy"></a>Направление стратегии оптимизации

Мало что можно сделать для управления подключением между пользователями и службой прокси приложения. Пользователи могут получить доступ к вашим приложениям из домашней сети, кафе или другой страны или региона. Вместо этого можно оптимизировать подключения между службой прокси приложения, соединителями прокси приложения и приложениями. Рекомендуется реализовать в вашей среде указанные ниже шаблоны.

### <a name="pattern-1-put-the-connector-close-to-the-application"></a>Шаблон 1. Поместите соединитель ближе к приложению.

Расположите соединитель близко к целевому приложению в сети клиента. Эта конфигурация позволяет свести к минимуму влияние шага 3 на схеме топографии, так как соединитель и приложение расположены рядом.

Если соединитель должен быть в непосредственной видимости контроллера домена, то этот шаблон является предпочтительным. Большая часть наших клиентов использует этот шаблон, так как он хорошо подходит для большинства сценариев. Этот шаблон можно также совместить с шаблоном 2, чтобы оптимизировать трафик между службой и соединителем.

### <a name="pattern-2-take-advantage-of-expressroute-with-microsoft-peering"></a>Шаблон 2. Использование возможностей ExpressRoute с пирингом Майкрософт

Если ExpressRoute настроен с пирингом Майкрософт, быстрое подключение ExpressRoute можно использовать для передачи трафика между прокси приложением и соединителем. Соединитель по-прежнему располагается в сети и вблизи от приложения.

### <a name="pattern-3-take-advantage-of-expressroute-with-private-peering"></a>Шаблон 3. Использование подключения ExpressRoute с частным пирингом

Если у вас есть выделенное подключение VPN или ExpressRoute с частным пирингом между Azure и корпоративной сетью, можно использовать другой вариант. В этой конфигурации виртуальная сеть в Azure обычно рассматривается как расширение корпоративной сети. Это означает, что вы можете установить соединитель в центре обработки данных Azure, сохраняя низкую задержку для подключения соединителя к приложению.

Задержка не увеличивается, так как трафик передается через выделенное подключение. Кроме того, улучшается задержка между соединителем и службой прокси приложения, так как соединитель устанавливается в центре обработки данных Azure, рядом с расположением клиента Azure AD.

:::image type="content" source="./media/application-proxy-network-topology/application-proxy-expressroute-private.png" alt-text="Схема, демонстрирующая установку соединителя в центре обработки данных Azure" lightbox="./media/application-proxy-network-topology/application-proxy-expressroute-private.png":::

### <a name="other-approaches"></a>Другие подходы

Эта статья посвящена выбору расположения для соединителя, но для улучшения характеристик задержки вы можете также переместить само приложение.

Все больше организаций перемещают сети в размещенные среды. В этой ситуации приложения также могут мигрировать в размещенную среду, оставаясь в пределах корпоративной сети и домена. В шаблонах, которые описаны в предыдущем разделе, можно учесть новое расположение приложения. Если вы рассматриваете этот вариант, перейдите на страницу [Доменные службы Azure Active Directory](../../active-directory-domain-services/overview.md).

Кроме того, рассмотрите возможность использования [групп соединителей](application-proxy-connector-groups.md) для целевых приложений, находящихся в разных расположениях и сетях.

## <a name="common-use-cases"></a>Распространенные варианты использования

В этом разделе рассматриваются несколько распространенных сценариев. Предполагается, что клиент Azure AD (а значит, и конечная точка службы прокси) находится в США. Все аспекты, рассмотренные в описанных вариантах, применимы и к другим регионам мира.

В этих сценариях мы называем соединения "прыжками" и присваиваем им номера:

- **Прыжок 1**: от пользователя к службе прокси приложения.
- **Прыжок 2**: от службы прокси приложения к соединителю прокси приложения.
- **Прыжок 3**: от соединителя прокси приложения к целевому приложению. 

### <a name="use-case-1"></a>Вариант использования 1

**Сценарий**: приложение находится в корпоративной сети в США, там же расположены и пользователи. Отсутствуют подключения ExpressRoute или VPN между контроллером домена Azure и корпоративной сетью.

**Рекомендация:** примените шаблон 1, как описано в предыдущем разделе. Если необходимо уменьшить задержку, рассмотрите возможность создать подключение ExpressRoute.

Это простой шаблон. Вы оптимизируете прыжок 3, располагая соединитель рядом с приложением. Это самый естественный вариант, поскольку соединителю требуется "прямая видимость" приложения и центра обработки данных, чтобы выполнять операции ограниченного делегирования Kerberos.

:::image type="content" source="./media/application-proxy-network-topology/application-proxy-pattern1.png" alt-text="На схеме показаны пользователи, прокси-сервер, соединитель и приложение в США." lightbox="./media/application-proxy-network-topology/application-proxy-pattern1.png":::

### <a name="use-case-2"></a>Вариант использования 2

**Сценарий**: приложение находится в корпоративной сети в США, а пользователи распределены по всему миру. Отсутствуют подключения ExpressRoute или VPN между контроллером домена Azure и корпоративной сетью.

**Рекомендация:** примените шаблон 1, как описано в предыдущем разделе.

Здесь снова наиболее применима оптимизация прыжка 3 за счет размещения соединителя рядом с приложением. Обычно прыжок 3 не будет дорогим, если он полностью проходит в одном регионе. Но прыжок 1 может оказаться намного дороже в зависимости от расположения пользователя, так как пользователи со всего мира обращаются к одному экземпляру прокси приложения, размещенному в США. Следует отметить, что в случае глобального распределения пользователя любые решения прокси будет иметь сходные характеристики.

:::image type="content" source="./media/application-proxy-network-topology/application-proxy-pattern2.png" alt-text="Пользователи распределяются глобально, но все остальное находится в США." lightbox="./media/application-proxy-network-topology/application-proxy-pattern2.png":::

### <a name="use-case-3"></a>Вариант использования 3

**Сценарий**: приложение находится в корпоративной сети клиента на территории США. Между Azure и корпоративной сетью существует ExpressRoute и корпоративная сеть.

**Рекомендация**. Примените шаблоны 1 и 2, как описано в предыдущем разделе.

Сначала разместите соединитель как можно ближе к приложению. Тогда система автоматически использует ExpressRoute для прыжка 2.

Если ссылка ExpressRoute использует пиринг Майкрософт, трафик между прокси и соединителем будет проходить через эту ссылку. Задержка для прыжка 2 будет оптимизирована.

:::image type="content" source="./media/application-proxy-network-topology/application-proxy-pattern3.png" alt-text="Схема, показывающая ExpressRoute между прокси и соединителем" lightbox="./media/application-proxy-network-topology/application-proxy-pattern3.png":::

### <a name="use-case-4"></a>Вариант использования 4

**Сценарий**: приложение находится в корпоративной сети клиента на территории США. Между Azure и корпоративной сетью установлено подключение ExpressRoute с частным пирингом.

**Рекомендация**. Примените шаблон 3, как описано в предыдущем разделе.

Разместите соединитель в центре обработки данных Azure, который подключен к корпоративной сети через частный пиринг ExpressRoute.

Соединитель можно разместить в центре обработки данных Azure. Так как соединитель по-прежнему имеет "прямую видимость" приложения и центра обработки данных через частную сеть, прыжок 3 остается оптимизированным. Кроме того, теперь оптимизирован и прыжок 2.

:::image type="content" source="./media/application-proxy-network-topology/application-proxy-pattern4.png" alt-text="Соединитель в центре обработки данных Azure, ExpressRoute между соединителем и приложением" lightbox="./media/application-proxy-network-topology/application-proxy-pattern4.png":::

### <a name="use-case-5"></a>Вариант использования 5

**Сценарий:** Приложение находится в сети Организации в Европе, регион клиента по умолчанию — US, а большинство пользователей — в Европе.

**Рекомендация:** разместите соединитель рядом с приложением. Обновите группу соединителей, чтобы она была оптимизирована для использования экземпляров прокси-службы приложения Европы. Шаги см. [в разделе Оптимизация групп соединителей для использования ближайшей облачной службы прокси приложения](application-proxy-network-topology.md#optimize-connector-groups-to-use-closest-application-proxy-cloud-service-preview).

Поскольку пользователи в Европе обращаются к экземпляру прокси приложения, который находится в том же регионе, прыжок 1 не является дорогостоящим. Прыжок 3 оптимизирован. Рекомендуется использовать ExpressRoute для оптимизации прыжка 2.

### <a name="use-case-6"></a>Вариант использования 6

**Сценарий:** Приложение находится в сети Организации в Европе, регион клиента по умолчанию — US, и большинство пользователей в США.

**Рекомендация:** разместите соединитель рядом с приложением. Обновите группу соединителей, чтобы она была оптимизирована для использования экземпляров прокси-службы приложения Европы. Шаги см. [в разделе Оптимизация групп соединителей для использования ближайшей облачной службы прокси приложения](application-proxy-network-topology.md#optimize-connector-groups-to-use-closest-application-proxy-cloud-service-preview). Прыжок 1 может быть более затратным, так как все пользователи должны получить доступ к экземпляру прокси приложения в Европе.

Также в этой ситуации можно применить еще один вариант. Если большинство пользователей организации находятся в США, возможно ваша сеть уже "расширена" в этот регион. Поместите соединитель в США, продолжайте использовать регион США по умолчанию для групп соединителей и используйте выделенную внутреннюю сеть корпоративной сети для приложения в Европе. Этот позволит оптимизировать прыжки 2 и 3.

:::image type="content" source="./media/application-proxy-network-topology/application-proxy-pattern5c.png" alt-text="На схеме показаны пользователи, прокси-сервер и соединитель в США, приложение в Европе." lightbox="./media/application-proxy-network-topology/application-proxy-pattern5c.png":::

## <a name="next-steps"></a>Дальнейшие действия

- [Включение прокси приложения](application-proxy-add-on-premises-application.md)
- [Включение единого входа](application-proxy-configure-single-sign-on-with-kcd.md)
- [Включить условный доступ](application-proxy-integrate-with-sharepoint-server.md)
- [Устранение неполадок с прокси приложения](application-proxy-troubleshoot.md)
