---
title: Перемещение проверки подлинности приложения из AD FS в Azure Active Directory
description: Узнайте, как использовать Azure Active Directory для замены службы федерации Active Directory (AD FS) (AD FS), предоставляя пользователям единый вход для всех приложений.
services: active-directory
author: kenwith
manager: daveba
ms.service: active-directory
ms.subservice: app-mgmt
ms.topic: how-to
ms.workload: identity
ms.date: 03/01/2021
ms.author: kenwith
ms.reviewer: baselden
ms.openlocfilehash: ee1d863ccb974b30213179a1aba9e27d5a3a2bda
ms.sourcegitcommit: df1930c9fa3d8f6592f812c42ec611043e817b3b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/13/2021
ms.locfileid: "103418467"
---
# <a name="moving-application-authentication-from-active-directory-federation-services-to-azure-active-directory"></a>Перенос проверки подлинности приложения из службы федерации Active Directory (AD FS) в Azure Active Directory

[Azure Active Directory (Azure AD)](../fundamentals/active-directory-whatis.md) предлагает универсальную платформу идентификации, которая предоставляет своим сотрудникам, партнерам и клиентам единое удостоверение для доступа к приложениям и совместной работы с любой платформой и устройством. В Azure AD есть [полный набор возможностей управления удостоверениями](../fundamentals/active-directory-whatis.md). Стандартизация проверки подлинности и авторизации приложения в Azure AD обеспечивает эти преимущества.

> [!TIP]
> Эта статья написана для аудитории разработчика. Руководители проектов и администраторы, планирующие Перемещение приложения в Azure AD, должны ознакомиться [с переносом проверки подлинности приложения в Azure AD](migrate-application-authentication-to-azure-active-directory.md).

## <a name="azure-ad-benefits"></a>Преимущества Azure AD

Если у вас есть локальный каталог, содержащий учетные записи пользователей, то, скорее всего, у вас есть множество приложений, для которых пользователи проходят проверку подлинности. Каждое из этих приложений настроено для доступа пользователей с использованием их удостоверений.

Пользователи также могут пройти проверку подлинности непосредственно в локальной Active Directory. Службы федерации Active Directory (AD FS) (AD FS) — это локальная служба идентификации на основе стандартов. Она расширяет возможность использования функций единого входа (SSO) между доверенными бизнес-партнерами, чтобы пользователям не требовалось входить отдельно для каждого приложения. Это называется федеративной идентификацией.

Многие организации имеют программное обеспечение как услуга (SaaS) или пользовательские бизнес-приложения, Федеративные непосредственно в AD FS, а также Microsoft 365 и приложения на основе Azure AD.

  ![Приложения, подключенные непосредственно в локальной среде](media/migrate-adfs-apps-to-azure/app-integration-before-migration-1.png)

> [!Important]
> Чтобы повысить безопасность приложений, ваша цель состоит в наличии единого набора элементов управления доступом и политик в локальных и облачных средах.

  ![Приложения, подключенные через Azure AD](media/migrate-adfs-apps-to-azure/app-integration-after-migration-1.png)

## <a name="types-of-apps-to-migrate"></a>Типы переносимых приложений

Миграция всей проверки подлинности приложения в Azure AD является оптимальной, так как она предоставляет единую плоскость управления для управления удостоверениями и доступом.

Приложения могут использовать современные или устаревшие протоколы для проверки подлинности. При планировании миграции в Azure AD рекомендуется сначала перенести приложения, использующие современные протоколы проверки подлинности (например, SAML и Open ID Connect). Эти приложения можно перенастроить для проверки подлинности в Azure AD с помощью встроенного соединителя из коллекции приложений Azure или путем регистрации приложения в Azure AD. Приложения, использующие старые протоколы, можно интегрировать с помощью прокси приложения.

Дополнительные сведения см. в разделе:

* [Использование AD application proxy Azure для публикации локальных приложений для удаленных пользователей](what-is-application-proxy.md).
* [Что такое управление приложениями?](what-is-application-management.md)
* [AD FS отчет о действиях приложений для переноса приложений в Azure AD](migrate-adfs-application-activity.md).
* [Мониторинг AD FS с помощью Azure AD Connect Health](../hybrid/how-to-connect-health-adfs.md).

### <a name="the-migration-process"></a>Процесс миграции

В процессе переноса проверки подлинности приложения в Azure AD Протестируйте свои приложения и конфигурацию. Рекомендуется продолжать использовать существующие тестовые среды для тестирования миграции при переходе в рабочую среду. Если тестовая среда в настоящее время недоступна, вы можете настроить ее с помощью [службы приложений Azure](https://azure.microsoft.com/services/app-service/) или [виртуальных машин Azure](https://azure.microsoft.com/free/virtual-machines/search/?OCID=AID2000128_SEM_lHAVAxZC&MarinID=lHAVAxZC_79233574796345_azure%20virtual%20machines_be_c__1267736956991399_kwd-79233582895903%3Aloc-190&lnkd=Bing_Azure_Brand&msclkid=df6ac75ba7b612854c4299397f6ab5b0&ef_id=XmAptQAAAJXRb3S4%3A20200306231230%3As&dclid=CjkKEQiAhojzBRDg5ZfomsvdiaABEiQABCU7XjfdCUtsl-Abe1RAtAT35kOyI5YKzpxRD6eJS2NM97zw_wcB)в зависимости от архитектуры приложения.

Вы можете настроить отдельный тестовый клиент Azure AD, на котором будут разрабатываться конфигурации приложений.

Процесс миграции может выглядеть следующим образом:

#### <a name="stage-1--current-state-the-production-app-authenticates-with-ad-fs"></a>Этап 1 — текущее состояние: в рабочем приложении выполняется проверка подлинности с помощью AD FS

  ![Этап миграции 1 ](media/migrate-adfs-apps-to-azure/stage1.jpg)

#### <a name="stage-2--optional-point-a-test-instance-of-the-app-to-the-test-azure-ad-tenant"></a>Этап 2 — (необязательно). Указание тестового экземпляра приложения на тестовый клиент Azure AD

Обновите конфигурацию, чтобы указать тестовый экземпляр приложения на тестовый клиент Azure AD, и внесите необходимые изменения. Приложение можно протестировать для пользователей в тестовом клиенте Azure AD. В процессе разработки можно использовать такие средства, как [Fiddler](https://www.telerik.com/fiddler) , для сравнения и проверки запросов и ответов.

Если вы не хотите настраивать отдельный тестовый клиент, пропустите этот этап и укажите тестовый экземпляр приложения в рабочем клиенте Azure AD, как описано в шаге 3 ниже.

  ![Стадия миграции 2 ](media/migrate-adfs-apps-to-azure/stage2.jpg)

#### <a name="stage-3--point-a-test-instance-of-the-app-to-the-production-azure-ad-tenant"></a>Этап 3. Указание тестового экземпляра приложения в рабочем клиенте Azure AD

Обновите конфигурацию, чтобы указать тестовый экземпляр приложения в рабочем клиенте Azure AD. Теперь можно протестировать пользователей в рабочем клиенте. При необходимости изучите раздел этой статьи, посвященный переходу пользователей.

  ![Этап миграции 3 ](media/migrate-adfs-apps-to-azure/stage3.jpg)

#### <a name="stage-4--point-the-production-app-to-the-production-azure-ad-tenant"></a>Этап 4. Наведите рабочее приложение на рабочий клиент Azure AD.

Обновите конфигурацию рабочего приложения, чтобы она указывала на рабочий клиент Azure AD.

  ![Этап миграции 4 ](media/migrate-adfs-apps-to-azure/stage4.jpg)

 Приложения, которые проходят проверку подлинности с помощью AD FS, могут использовать группы Active Directory для разрешений. Используйте [синхронизацию Azure AD Connect](../hybrid/how-to-connect-sync-whatis.md) , чтобы синхронизировать данные удостоверений между локальной средой и Azure AD перед началом миграции. Прежде чем выполнять миграцию, проверьте эти группы и членство, чтобы предоставить доступ тем же пользователям при миграции приложения.

### <a name="line-of-business-apps"></a>Бизнес-приложения

Бизнес-приложения — это те, которые разрабатывались вашей организацией или представляют собой стандартный пакетный продукт. Примеры включают приложения, созданные на основе Windows Identity Foundation и приложений SharePoint (не SharePoint Online).

Бизнес-приложения, использующие OAuth 2,0, OpenID Connect Connect или WS-Federation, можно интегрировать с Azure AD в качестве [регистрации приложений](../develop/quickstart-register-app.md). Интегрируйте пользовательские приложения, использующие SAML 2,0 или WS-Federation как [приложения не из коллекции](add-application-portal.md) , на странице корпоративные приложения в [портал Azure](https://portal.azure.com/).

## <a name="saml-based-single-sign-on"></a>Единый вход на основе SAML

Приложения, использующие SAML 2,0 для проверки подлинности, можно настроить для [единого входа на основе SAML](what-is-single-sign-on.md) . С помощью единого входа на основе SAML можно сопоставлять пользователей с определенными ролями приложений на основе правил, определенных в заявках SAML.

Сведения о настройке приложения SaaS для единого входа на основе SAML см. в разделе [Краткое руководство. Настройка единого входа на основе SAML](add-application-portal-setup-sso.md).

  ![Снимки экрана единого входа SAML User ](media/migrate-adfs-apps-to-azure/sso-saml-user-attributes-claims.png)

Многие приложения SaaS имеют [руководство по конкретным приложениям](../saas-apps/tutorial-list.md) , в котором описывается настройка единого входа на основе SAML.

  ![Руководство по приложениям](media/migrate-adfs-apps-to-azure/app-tutorial.png)

Некоторые приложения можно переместить без проблем. Приложениям с более сложными требованиями, например пользовательскими утверждениями, может потребоваться дополнительная настройка в Azure AD и (или) Azure AD Connect. Сведения о поддерживаемых сопоставлениях утверждений см. в разделе [как настроить утверждения, созданные в токенах для конкретного приложения в клиенте (Предварительная версия)](../develop/active-directory-claims-mapping.md).

При сопоставлении атрибутов учитывайте следующие ограничения.

* Не все атрибуты, которые могут быть выданы в AD FS, отображаются в Azure AD в качестве атрибутов для порождения в токены SAML, даже если эти атрибуты синхронизированы. При изменении атрибута в раскрывающемся списке **значение** отображаются различные атрибуты, доступные в Azure AD. Проверьте [Azure AD Connect синхронизацию разделов](../hybrid/how-to-connect-sync-whatis.md) Настройка, чтобы убедиться, что необходимый атрибут, например **SamAccountName**, синхронизирован с Azure AD. Атрибуты расширения можно использовать для отправки любых утверждений, которые не входят в стандартную схему пользователя в Azure AD.
* В большинстве случаев приложению требуются только утверждение **NameId** и другие распространенные утверждения идентификатора пользователя. Чтобы определить, требуются ли какие либо дополнительные утверждения, изучите, какие утверждения вы выдаете AD FS.
* Не все утверждения могут быть выданы, так как некоторые утверждения защищены в Azure AD.
* Возможность использования зашифрованных токенов SAML теперь доступна в предварительной версии. См. раздел [как настроить утверждения, выданные в токене SAML для корпоративных приложений](../develop/active-directory-saml-claims-customization.md).

### <a name="software-as-a-service-saas-apps"></a>Приложения SaaS (программное обеспечение как услуга)

Если пользователи входят в приложения SaaS, такие как Salesforce, ServiceNow или Workday, интегрированные с AD FS, вы используете федеративный вход для приложений SaaS.

Большинство приложений SaaS можно настроить в Azure AD. У Майкрософт есть множество предварительно настроенных подключений к приложениям SaaS в  [коллекции приложений Azure AD](https://azuremarketplace.microsoft.com/marketplace/apps/category/azure-active-directory-apps), что упрощает переход. Приложения SAML 2,0 можно интегрировать с Azure AD через коллекцию приложений Azure AD или как приложения, [не связанные с коллекцией](add-application-portal.md).

Приложения, использующие OAuth 2,0 или OpenID Connect Connect, могут быть аналогично интегрированы с Azure AD в качестве [регистрации приложений](../develop/quickstart-register-app.md). Приложения, использующие устаревшие протоколы, могут использовать [AD application proxy Azure](application-proxy.md) для проверки подлинности в Azure AD.

При возникновении проблем с подключением приложений SaaS можно обратиться в [службу поддержки интеграции приложений SaaS](mailto:SaaSApplicationIntegrations@service.microsoft.com).

### <a name="saml-signing-certificates-for-sso"></a>Сертификаты для подписи SAML для единого входа

Сертификаты подписи являются важной частью любого развертывания единого входа. Azure AD создает сертификаты для подписи, чтобы установить федеративный единый вход на основе SAML для приложений SaaS. После добавления коллекций или приложений, не являющихся коллекциями, вы настроите добавленное приложение, используя параметр федеративного единого входа. См. раздел [Управление сертификатами для федеративного единого входа в Azure Active Directory](manage-certificates-for-federated-single-sign-on.md).

### <a name="saml-token-encryption"></a>Шифрование токена SAML

Как AD FS, так и Azure AD обеспечивают шифрование маркеров — возможность шифровать утверждения безопасности SAML, которые переходят в приложения. Утверждения шифруются с помощью открытого ключа и расшифровываются получающим приложением с соответствующим закрытым ключом. При настройке шифрования маркеров вы отправляете файлы сертификата X. 509 для предоставления открытых ключей.

Дополнительные сведения о шифровании маркеров SAML в Azure AD и о том, как его настроить, см. [в статье Настройка шифрования маркеров SAML в Azure AD](howto-saml-token-encryption.md).  

> [!NOTE]
> Шифрование токенов — это функция уровня "Премиум" в Azure Active Directory (Azure AD). Дополнительные сведения о выпусках, функциях и ценах на Azure AD см. на странице [цен на Azure AD](https://azure.microsoft.com/pricing/details/active-directory/).

### <a name="apps-and-configurations-that-can-be-moved-today"></a>Приложения и конфигурации, которые можно переместить сегодня

На сегодняшний день можно легко переместить приложения SAML 2.0, использующие стандартный набор элементов и утверждений конфигурации. Эти стандартные элементы:

* Имя участника-пользователя
* Адрес электронной почты
* Имя
* Surname
* Альтернативный атрибут, такой как **NameID** SAML, включая атрибуты электронной почты Azure AD, префикса электронной почты, идентификатор сотрудника и расширения 1–15, или локальный атрибут **SamAccountName**. Дополнительные сведения см. в статье [Настройка утверждений, выпущенных в токене SAML для корпоративных приложений в Azure Active Directory](../develop/active-directory-saml-claims-customization.md).
* Пользовательские утверждения.

Для миграции в Azure AD необходимо выполнить следующие дополнительные действия по настройке:

* Настраиваемые правила авторизации или многофакторной идентификации (MFA) в AD FS. Их можно настроить с помощью функции [условного доступа Azure AD](../conditional-access/overview.md) .
* Приложения с несколькими конечными точками URL-адреса ответа. Их можно настроить в Azure AD с помощью PowerShell или интерфейса портал Azure.
* Приложения WS-Federation, например приложения SharePoint, которым требуются токены SAML версии 1.1. Их можно настроить вручную с помощью PowerShell. Вы также можете добавить предварительно интегрированный универсальный шаблон для приложений SharePoint и SAML 1,1 из коллекции. Мы поддерживаем протокол SAML 2,0.
* Правила преобразования выдачи сложных утверждений. Сведения о поддерживаемых сопоставлениях утверждений см. в следующих статьях:
   *  [Сопоставление утверждений в Azure Active Directory](../develop/active-directory-claims-mapping.md).
   * [Настройка утверждений, выданных в токене SAML для корпоративных приложений в Azure Active Directory](../develop/active-directory-saml-claims-customization.md).

### <a name="apps-and-configurations-not-supported-in-azure-ad-today"></a>Приложения и конфигурации, неподдерживаемые в Azure AD на сегодняшний день

Приложения, которым требуются определенные возможности, не могут быть перенесены сегодня.

#### <a name="protocol-capabilities"></a>Возможности протокола

Приложения, которым требуются следующие возможности протокола, нельзя перенести сегодня:

* Поддержка шаблона WS-Trust ActAs
* Разрешение артефактов SAML.
* Проверка подписи подписанных запросов SAML
  > [!Note]
  > Подписанные запросы принимаются, но подпись не проверяется.

  Учитывая, что Azure AD возвращает маркер только для конечных точек, предварительно настроенных в приложении, проверка подписи, скорее всего, в большинстве случаев не требуется.

#### <a name="claims-in-token-capabilities"></a>Утверждения в возможностях токенов

Приложения, которым требуются следующие утверждения в функциях маркеров, нельзя перенести сегодня.

* Утверждения из хранилищ атрибутов, отличных от каталога Azure AD, если эти данные не синхронизируются с Azure AD. Дополнительные сведения см. в [обзоре API синхронизации Azure AD](/graph/api/resources/synchronization-overview?view=graph-rest-beta).
* Выдача атрибутов с несколькими значениями каталога. Например, в настоящее время мы не можем выпустить многозначное утверждение для адресов прокси.

## <a name="map-app-settings-from-ad-fs-to-azure-ad"></a>Сопоставьте параметры приложения с AD FS в Azure AD

Миграция требует оценки того, как приложение настроено в локальной среде, а затем сопоставляет эту конфигурацию с Azure AD. Службы AD FS и Azure AD работают похожим образом, поэтому понятия настройки отношения доверия, URL-адресов входа и выхода, а также идентификаторов можно применить для двух служб. Задокументируйте параметры конфигурации AD FS приложений, чтобы их можно было легко настроить в Azure AD.

### <a name="map-app-configuration-settings"></a>Параметры конфигурации приложения Map

В следующей таблице описаны некоторые из наиболее распространенных сопоставлений параметров между отношением доверия с проверяющей стороной AD FS с приложением Azure AD.

* AD FS — найдите параметр в AD FS списке отношения доверия с проверяющей стороной для приложения. Щелкните проверяющую сторону правой кнопкой мыши и выберите пункт Свойства.
* Azure AD — параметр настраивается в [портал Azure](https://portal.azure.com/) в свойствах единого входа каждого приложения.

| Параметр конфигурации| AD FS| Настройка в Azure AD| Токен SAML |
| - | - | - | - |
| **URL-адрес входа приложения** <p>URL-адрес пользователя для входа в приложение в потоке SAML, инициированном поставщиком служб (SP).| н/д| Открытие базовой конфигурации SAML с входом на основе SAML| н/д |
| **URL-адрес ответа приложения** <p>URL-адрес приложения с точки зрения поставщика удостоверений (IdP). IdP отправляет пользователя и токен после того, как пользователь выполнил вход в IdP.  Это также называется **конечной точкой потребителя утверждений SAML**.| Выберите вкладку **конечные точки** .| Открытие базовой конфигурации SAML с входом на основе SAML| Элемент Destination в токене SAML. Пример значения: `https://contoso.my.salesforce.com` |
| **URL-адрес выхода приложения** <p>Это URL-адрес, на который отправляются запросы очистки выхода, когда пользователь выходит из приложения. IdP отправляет запрос на выход пользователя из всех других приложений.| Выберите вкладку **конечные точки** .| Открытие базовой конфигурации SAML с входом на основе SAML| н/д |
| **Идентификатор приложения** <p>Это идентификатор приложения с точки зрения IdP. Значение URL-адреса входа часто (но не всегда) используется для идентификатора.  Иногда приложение вызывает этот идентификатор сущности.| Выберите вкладку **идентификаторы** .|Открытие базовой конфигурации SAML с входом на основе SAML| Сопоставляется элементу **аудитории** в токене SAML. |
| **Метаданные федерации приложений** <p>Это расположение метаданных федерации приложения. Поставщик удостоверений использует его для автоматического обновления определенных настроек конфигурации, например конечных точек или сертификатов шифрования.| Перейдите на вкладку **мониторинг** .| Недоступно Azure AD не поддерживает использование метаданных федерации приложений напрямую. Метаданные федерации можно импортировать вручную.| н/д |
| **Идентификатор пользователя или имя** <p>Атрибут для уникального определения идентификатора пользователя из Azure AD или AD FS при входе в приложение.  Обычно этот атрибут является либо UPN, либо адресом электронной почты пользователя.| Правила утверждений. В большинстве случаев правило утверждения выдает утверждение с типом, который заканчивается на **nameidentifier**.| Идентификатор можно найти в заголовке **пользовательские атрибуты и утверждения**. По умолчанию используется имя участника-пользователя.| Сопоставляется с элементом **NameID** в токене SAML. |
| **Другие утверждения** <p>Примеры других сведений о заявках, которые обычно отправляются из IdP в приложение, включают имя, фамилию, адрес электронной почты и членство в группе.| В AD FS этот элемент может представлять собой другие правила утверждения проверяющей стороны.| Идентификатор можно найти в **атрибутах пользователя заголовка & утверждения**. Выберите **Просмотр** и измените все другие атрибуты пользователя.| н/д |

### <a name="map-identity-provider-idp-settings"></a>Параметры поставщика удостоверений (IdP)

Настройте приложения так, чтобы они указывали на Azure AD, а AD FS для единого входа. Здесь мы сосредоточены на приложениях SaaS, использующих протокол SAML. Однако эта концепция также распространяется на пользовательские бизнес-приложения.

> [!NOTE]
> Значения конфигурации для Azure AD следуют шаблону, в котором идентификатор клиента Azure заменяет {ИД клиента}, а идентификатор приложения заменяет {Application-ID}. Эти сведения можно найти в [портал Azure](https://portal.azure.com/) в разделе **Свойства > Azure Active Directory**.

* Выберите идентификатор каталога, чтобы просмотреть идентификатор клиента.
* Выберите идентификатор приложения, чтобы просмотреть идентификатор приложения.

 На высоком уровне Сопоставьте следующие ключевые элементы конфигурации SaaS-приложений с Azure AD.

| Элемент| Значение конфигурации |
| - | - |
| Издатель поставщика удостоверений| HTTPS: \/ /СТС.Виндовс.нет/{тенант-ИД}/ |
| URL-адрес входа поставщика удостоверений| [https://login.microsoftonline.com/{tenant-id}/saml2](https://login.microsoftonline.com/{tenant-id}/saml2) |
| URL-адрес выхода поставщика удостоверений| [https://login.microsoftonline.com/{tenant-id}/saml2](https://login.microsoftonline.com/{tenant-id}/saml2) |
| Расположение метаданных федерации| [https://login.windows.net/{tenant-id}/federationmetadata/2007-06/federationmetadata.xml?appid={application-id}](https://login.windows.net/{tenant-id}/federationmetadata/2007-06/federationmetadata.xml?appid={application-id}) |

### <a name="map-sso-settings-for-saas-apps"></a>Параметры единого входа для приложений SaaS

Приложениям SaaS необходимо знать, куда отправляются запросы проверки подлинности, и как проверить полученные токены. В следующей таблице описаны элементы для настройки параметров единого входа в приложении, а также их значения или расположения в AD FS и Azure AD.

| Параметр конфигурации| AD FS| Настройка в Azure AD |
| - | - | - |
| **URL-адрес входа IdP** <p>URL-адрес входа для IdP с точки зрения приложения (где пользователь перенаправляется для входа).| AD FS URL-адрес входа — это AD FS имя службы федерации, за которым следует "/адфс/ЛС/." <p>Пример: `https://fs.contoso.com/adfs/ls/`| Замените {ИД клиента} ИДЕНТИФИКАТОРом клиента. <p> Для приложений, использующих протокол SAML-P: [https://login.microsoftonline.com/{tenant-id}/saml2](https://login.microsoftonline.com/{tenant-id}/saml2) <p>Для приложений, использующих протокол WS-Federation: [https://login.microsoftonline.com/{tenant-id}/wsfed](https://login.microsoftonline.com/{tenant-id}/wsfed) |
| **URL-адрес выхода IdP**<p>URL-адрес выхода IdP с точки зрения приложения (где пользователь перенаправляется при выходе из приложения).| URL-адрес выхода совпадает с URL-адресом входа или с добавленным URL-адресом "WA = wsignout 1.0". Пример: `https://fs.contoso.com/adfs/ls/?wa=wsignout1.0`| Замените {ИД клиента} ИДЕНТИФИКАТОРом клиента.<p>Для приложений, использующих протокол SAML-P:<p>[https://login.microsoftonline.com/{tenant-id}/saml2](https://login.microsoftonline.com/{tenant-id}/saml2) <p> Для приложений, использующих протокол WS-Federation: [https://login.microsoftonline.com/common/wsfederation?wa=wsignout1.0](https://login.microsoftonline.com/common/wsfederation?wa=wsignout1.0) |
| **Сертификат для подписи токена**<p>IdP использует закрытый ключ сертификата для подписывания выданных маркеров. Он проверяет, поступил ли токен от того же поставщика удостоверений, с которым у приложения настроено отношение доверия.| Сертификат для подписи маркера AD FS находится в управлении AD FS в разделе **Сертификаты**.| Найдите его в портал Azure в **свойствах единого входа** приложения под заголовком **сертификат подписи SAML**. Здесь можно загрузить сертификат для передачи приложению.  <p>Если приложение содержит более одного сертификата, все сертификаты можно найти в XML-файле метаданных федерации. |
| **Идентификатор/"Issuer"**<p>Идентификатор IdP с точки зрения приложения (иногда называется "идентификатор издателя").<p>В токене SAML значение отображается как элемент Issuer.| Идентификатор AD FS обычно является идентификатором службы федерации в AD FS управления в разделе **сервис > изменить служба федерации свойства**. Пример: `http://fs.contoso.com/adfs/services/trust`| Замените {ИД клиента} ИДЕНТИФИКАТОРом клиента.<p>HTTPS: \/ /СТС.Виндовс.нет/{тенант-ИД}/ |
| **Метаданные федерации IdP**<p>Расположение общедоступной версии метаданных федерации IdP. (Некоторые приложения используют метаданные федерации как альтернативу отдельной настройке администратора URL-адресов, идентификатору и сертификату для подписи маркера.)| Найдите URL-адрес метаданных федерации AD FS в разделе Управление AD FSми в **> конечные точки службы > метаданные тип >: метаданные федерации**. Пример: `https://fs.contoso.com/FederationMetadata/2007-06/FederationMetadata.xml`| Соответствующее значение для Azure AD соответствует шаблону [https://login.microsoftonline.com/{TenantDomainName}/FederationMetadata/2007-06/FederationMetadata.xml](https://login.microsoftonline.com/{TenantDomainName}/FederationMetadata/2007-06/FederationMetadata.xml) . Замените {TenantDomainName} именем своего клиента в формате "contoso.onmicrosoft.com".   <p>Дополнительные сведения см. в статье [Метаданные федерации](../azuread-dev/azure-ad-federation-metadata.md). |

## <a name="represent-ad-fs-security-policies-in-azure-ad"></a>Представление политик безопасности AD FS в Azure AD

При переносе проверки подлинности приложения в Azure AD создайте сопоставления существующих политик безопасности с их эквивалентами или альтернативными вариантами, доступными в Azure AD. Проверка того, что эти сопоставления могут быть выполнены, а стандарты безопасности, необходимые владельцам приложений, значительно упрощают миграцию всех приложений.

Для каждого примера правила мы покажем, как выглядит правило в AD FS, AD FS код, эквивалентный языку правил, и как это сопоставляется с Azure AD.

### <a name="map-authorization-rules"></a>Сопоставьте правила авторизации

Ниже приведены примеры различных типов правил авторизации в AD FS и способы их отображения в Azure AD.

#### <a name="example-1-permit-access-to-all-users"></a>Пример 1. разрешение доступа для всех пользователей

Разрешение доступа для всех пользователей в AD FS:

  ![На снимке экрана показано диалоговое окно Настройка одного Sign-On с помощью SAML.](media/migrate-adfs-apps-to-azure/permit-access-to-all-users-1.png)

Это сопоставляется с Azure AD одним из следующих способов:

1. Для параметра **Назначение пользователей требуется** значение **нет**.

    ![изменение политики контроля доступа для приложений SaaS ](media/migrate-adfs-apps-to-azure/permit-access-to-all-users-2.png)

    > [!Note]
    > Для **назначения пользователю** значения **"Да"** требуется, чтобы пользователи были назначены приложению для получения доступа. Если задано значение **нет**, у всех пользователей есть доступ. Этот параметр не контролирует, что видят пользователи в интерфейсе " **Мои приложения** ".

1. На **вкладке Пользователи и группы** назначьте свое приложение автоматической группе **все пользователи** . Чтобы группа " **все пользователи** " по умолчанию была доступна, необходимо [включить динамические группы](../enterprise-users/groups-create-rule.md) в клиенте Azure AD.

    ![Мои приложения SaaS в Azure AD ](media/migrate-adfs-apps-to-azure/permit-access-to-all-users-3.png)

#### <a name="example-2-allow-a-group-explicitly"></a>Пример 2. явное разрешение группы

Явная авторизация группы в AD FS:

  ![На снимке экрана показано диалоговое окно Изменение правила для правила утверждения разрешений для администраторов домена.](media/migrate-adfs-apps-to-azure/allow-a-group-explicitly-1.png)

Чтобы связать это правило с Azure AD, выполните следующие действия.

1. В [портал Azure](https://portal.azure.com/) [Создайте группу пользователей](../fundamentals/active-directory-groups-create-azure-portal.md) , соответствующую группе пользователей из AD FS.
1. Назначьте разрешения приложения для группы:

    ![Добавить назначение ](media/migrate-adfs-apps-to-azure/allow-a-group-explicitly-2.png)

#### <a name="example-3-authorize-a-specific-user"></a>Пример 3. Авторизация конкретного пользователя

Явная авторизация пользователя в AD FS:

  ![На снимке экрана показано диалоговое окно Изменение правила для параметра разрешить конкретное утверждение пользователя с типом входящего утверждения PRIMARY S D.](media/migrate-adfs-apps-to-azure/authorize-a-specific-user-1.png)

Чтобы связать это правило с Azure AD, выполните следующие действия.

* В [портал Azure](https://portal.azure.com/)добавьте пользователя в приложение с помощью вкладки Добавление назначения приложения, как показано ниже.

    ![Мои приложения SaaS в Azure ](media/migrate-adfs-apps-to-azure/authorize-a-specific-user-2.png)

### <a name="map-multi-factor-authentication-rules"></a>Сопоставьте правила многофакторной идентификации

Локальное развертывание [многофакторной идентификации (MFA)](../authentication/concept-mfa-howitworks.md) и AD FS по-прежнему работает после миграции, так как вы выполняете Федеративные действия с AD FS. Однако рассмотрите возможность перехода на встроенные в Azure возможности MFA, которые связаны с рабочими процессами условного доступа Azure AD.

Ниже приведены примеры типов правил MFA в AD FS, а также способы их отображения в Azure AD на основе различных условий.

Параметры правил MFA в AD FS:

  ![На снимке экрана показаны условия для Azure A D в портал Azure.](media/migrate-adfs-apps-to-azure/mfa-settings-common-for-all-examples.png)

#### <a name="example-1-enforce-mfa-based-on-usersgroups"></a>Пример 1. применение MFA на основе пользователей и групп

Селектор пользователей и групп — это правило, которое позволяет применять MFA для каждой группы (SID группы) или для каждого пользователя (первичного SID). Помимо назначений "пользователи/группы", все дополнительные флажки в пользовательском интерфейсе конфигурации AD FS MFA в качестве дополнительных правил, которые оцениваются после применения правила "пользователи/группы".

Укажите правила MFA для пользователя или группы в Azure AD:

1. Создайте [новую политику условного доступа](../authentication/tutorial-enable-azure-mfa.md?bc=%2fazure%2factive-directory%2fconditional-access%2fbreadcrumb%2ftoc.json&toc=%2fazure%2factive-directory%2fconditional-access%2ftoc.json).
1. Выберите **Назначения**. Добавьте пользователей или группы, для которых необходимо применить MFA.
1. Настройте параметры **управления доступом** , как показано ниже.

    ‎![На снимке экрана показана панель "предоставление доступа", на которой можно предоставить доступ.](media/migrate-adfs-apps-to-azure/mfa-users-groups.png)

 #### <a name="example-2-enforce-mfa-for-unregistered-devices"></a>Пример 2. применение MFA для незарегистрированных устройств

Укажите правила MFA для незарегистрированных устройств в Azure AD:

1. Создайте [новую политику условного доступа](../authentication/tutorial-enable-azure-mfa.md?bc=%2fazure%2factive-directory%2fconditional-access%2fbreadcrumb%2ftoc.json&toc=%2fazure%2factive-directory%2fconditional-access%2ftoc.json).
1. Установите **назначения** для **всех пользователей**.
1. Настройте параметры **управления доступом** , как показано ниже.

    ![На снимке экрана показана панель "предоставление доступа", где можно предоставить доступ и указать другие ограничения.](media/migrate-adfs-apps-to-azure/mfa-unregistered-devices.png)

Если для параметра **для нескольких элементов управления** требуется указать **один из выбранных элементов управления**, это означает, что пользователь получает доступ к приложению, если какое-либо из условий, заданных этим флажком, будет выполняться пользователем.

#### <a name="example-3-enforce-mfa-based-on-location"></a>Пример 3. применение MFA на основе расположения

Укажите правила MFA на основе расположения пользователя в Azure AD:

1. Создайте [новую политику условного доступа](../authentication/tutorial-enable-azure-mfa.md?bc=%2fazure%2factive-directory%2fconditional-access%2fbreadcrumb%2ftoc.json&toc=%2fazure%2factive-directory%2fconditional-access%2ftoc.json).
1. Установите **назначения** для **всех пользователей**.
1. [Настройка именованных расположений в Azure AD](../reports-monitoring/quickstart-configure-named-locations.md). В противном случае Федерация из корпоративной сети является доверенной.
1. Настройте **правила условий** , чтобы указать расположения, для которых необходимо применить mfa.

    ![На снимке экрана показана панель расположения для правил условий.](media/migrate-adfs-apps-to-azure/mfa-location-1.png)

1. Настройте параметры **управления доступом** , как показано ниже.

    ![Соответствие политик управления доступом](media/migrate-adfs-apps-to-azure/mfa-location-2.png)

### <a name="map-emit-attributes-as-claims-rule"></a>Отобразить атрибуты выпуска как правило утверждений

Выдавать атрибуты в качестве правила утверждений в AD FS:

  ![На снимке экрана показано диалоговое окно Изменение правила для выдачи атрибутов в качестве утверждений.](media/migrate-adfs-apps-to-azure/map-emit-attributes-as-claims-rule-1.png)

Чтобы связать правило с Azure AD, выполните следующие действия.

1. В [портал Azure](https://portal.azure.com/)выберите **корпоративные приложения** , а затем — **единый вход** , чтобы просмотреть конфигурацию входа на основе SAML:

    ![На снимке экрана показана страница единого входа для корпоративного приложения.](media/migrate-adfs-apps-to-azure/map-emit-attributes-as-claims-rule-2.png)

1. Выберите **изменить** (выделено), чтобы изменить атрибуты:

    ![На этой странице можно изменить атрибуты и утверждения пользователя.](media/migrate-adfs-apps-to-azure/map-emit-attributes-as-claims-rule-3.png)

### <a name="map-built-in-access-control-policies"></a>Сопоставьте встроенные политики управления доступом

Встроенные политики управления доступом в AD FS 2016:

  ![Встроенная служба контроля доступа Azure AD](media/migrate-adfs-apps-to-azure/map-built-in-access-control-policies-1.png)

Чтобы реализовать встроенные политики в Azure AD, используйте [новую политику условного доступа](../authentication/tutorial-enable-azure-mfa.md?bc=%2fazure%2factive-directory%2fconditional-access%2fbreadcrumb%2ftoc.json&toc=%2fazure%2factive-directory%2fconditional-access%2ftoc.json) и настройте элементы управления доступом или используйте пользовательский конструктор политик в AD FS 2016, чтобы настроить политики управления доступом. Редактор правил имеет исчерпывающий список разрешений и, кроме параметров, которые могут помочь в внесении всех типов перестановок.

  ![Политики контроля доступа Azure AD](media/migrate-adfs-apps-to-azure/map-built-in-access-control-policies-2.png)

В этой таблице мы рассмотрели некоторые полезные параметры разрешения и, кроме, а также способы их соответствия с Azure AD.

| Параметр | Как настроить параметр разрешения в Azure AD?| Как настроить параметр Except в Azure AD? |
| - | - | - |
| Из определенной сети| Сопоставляется [с именованным расположением](../reports-monitoring/quickstart-configure-named-locations.md) в Azure AD| Использование параметра " **исключить** " для [надежных расположений](../conditional-access/location-condition.md) |
| Из конкретных групп| [Задание назначения пользователей или групп](assign-user-or-group-access-portal.md)| Использование параметра " **исключить** " в группе "пользователи и группы" |
| С устройств с указанным уровнем доверия| Задайте это значение из элемента управления **состоянием устройства** в разделе назначения — > условия.| Используйте параметр **исключить** в разделе условие состояния устройства и включите **все устройства** . |
| С конкретными утверждениями в запросе| Этот параметр не может быть перенесен| Этот параметр не может быть перенесен |

Ниже приведен пример настройки параметра Exclude для надежных расположений в портал Azure.

  ![Снимок экрана: сопоставление политик управления доступом](media/migrate-adfs-apps-to-azure/map-built-in-access-control-policies-3.png)

## <a name="transition-users-from-ad-fs-to-azure-ad"></a>Переход пользователей из AD FS в Azure AD

### <a name="sync-ad-fs-groups-in-azure-ad"></a>Синхронизация групп AD FS в Azure AD

При сопоставлении правил авторизации приложения, которые проходят проверку подлинности с помощью AD FS, могут использовать группы Active Directory для разрешений. В этом случае используйте [Azure AD Connect](https://go.microsoft.com/fwlink/?LinkId=615771) для синхронизации этих групп с Azure AD перед переносом приложений. Убедитесь, что вы проверите эти группы и членство перед миграцией, чтобы вы могли предоставить доступ тем же пользователям при миграции приложения.

Дополнительные сведения см. [в разделе Предварительные требования для использования атрибутов группы, синхронизированных из Active Directory](../hybrid/how-to-connect-fed-group-claims.md).

### <a name="set-up-user-self-provisioning"></a>Настройка самостоятельной подготовки пользователей

Некоторые приложения SaaS поддерживают возможность самостоятельной инициализации пользователей при первом входе в приложение. В Azure AD подготовка приложений подразумевает автоматическое создание удостоверений пользователей и ролей в облачных приложениях ([SaaS](https://azure.microsoft.com/overview/what-is-saas/)), к которым пользователям требуется доступ. У перенесенных пользователей уже есть учетная запись в приложении SaaS. Все новые пользователи, добавленные после миграции, должны быть подготовлены. Протестируйте [подготовку приложения SaaS](../app-provisioning/user-provisioning.md) после переноса приложения.

### <a name="sync-external-users-in-azure-ad"></a>Синхронизация внешних пользователей в Azure AD

Существующие внешние пользователи можно настроить двумя способами в AD FS.

* **Внешние пользователи с локальной учетной записью в Организации**— вы продолжаете использовать эти учетные записи так же, как и внутренние учетные записи пользователей. Эти учетные записи внешних пользователей имеют имя участника в Организации, хотя электронная почта учетной записи может указываться извне. По мере выполнения миграции вы можете воспользоваться преимуществами предложений [Azure AD B2B](../external-identities/what-is-b2b.md) , перенесите этих пользователей на использование собственного корпоративного удостоверения, если такое удостоверение доступно. Это упрощает процесс входа для пользователей, так как они часто входят в систему с собственным корпоративным входом. Администрирование Организации упрощается и не требует управления учетными записями для внешних пользователей.
* **Федеративные внешние удостоверения**. Если вы в настоящее время участвуете в интеграции с внешней организацией, есть несколько подходов:
  * [Добавьте Azure Active Directory пользователей службы совместной работы B2B в портал Azure](../external-identities/add-users-administrator.md). Вы можете заранее отправить приглашения в службу совместной работы B2B с портала администрирования Azure AD в партнерскую организацию для того, чтобы по-прежнему использовать приложения и активы, к которым они применяются.
  * [Создайте рабочий процесс регистрации для самообслуживания B2B](../external-identities/self-service-portal.md) , который создает запрос для отдельных пользователей в партнерской организации с помощью API приглашения B2B.

Независимо от того, как настроены существующие внешние пользователи, они, скорее всего, имеют разрешения, связанные с их учетной записью, как членство в группе, так и определенные разрешения. Оцените, должны ли эти разрешения быть перенесены или очищены. Учетные записи в Организации, представляющие внешнего пользователя, необходимо отключить после миграции пользователя на внешнее удостоверение. Процесс миграции следует обсудить с бизнес-партнерами, так как может возникнуть перерыв в их возможности подключаться к вашим ресурсам.

## <a name="migrate-and-test-your-apps"></a>Перенос и тестирование приложений

Выполните процесс миграции, описанный в этой статье. Затем перейдите к [портал Azure](https://aad.portal.azure.com/) , чтобы проверить успешность миграции.

Следуйте указаниям, приведенным ниже:

1. Выберите **корпоративные приложения**  >  **все приложения** и найдите свое приложение в списке.
1. Выберите пункт **Управление**  >  **пользователями и группами** , чтобы назначить приложению хотя бы одного пользователя или группу.
1. Выберите **Управление**  >  **условным доступом**. Проверьте список политик и убедитесь, что вы не блокируете доступ к приложению с помощью [политики условного доступа](../conditional-access/overview.md).

В зависимости от настройки приложения убедитесь, что единый вход работает правильно.

| Authentication type (Тип проверки подлинности)| Тестирование |
| :- | :- |
| Подключение OAuth или OpenID Connect| Выберите **корпоративные приложения > разрешения** и убедитесь, что вы согласились с приложением в параметрах пользователя для вашего приложения.|
| Единый вход на основе SAML | Используйте кнопку [Проверка параметров SAML](debug-saml-sso-issues.md) в разделе **единый вход**. |
| Password-Based ЕДИНЫЙ ВХОД |  Скачайте и установите расширение для [безопасного входа в MyApp](../user-help/my-apps-portal-end-user-access.md) [-](../user-help/my-apps-portal-end-user-access.md) [](../user-help/my-apps-portal-end-user-access.md). Это расширение позволяет запускать любые облачные приложения вашей организации, требующие использования единого входа. |
| Прокси приложения | Убедитесь, что соединитель работает и назначен вашему приложению. За дополнительной помощью обратитесь к [руководству по устранению неполадок прокси приложения](application-proxy-troubleshoot.md) . |

> [!NOTE]
> Файлы cookie из старой среды AD FS сохраняются на пользовательских компьютерах. Эти файлы cookie могут вызвать проблемы с миграцией, так как пользователи могут направляться в старую среду входа в систему AD FS в сравнении с новым именем входа Azure AD. Может потребоваться очистить файлы cookie браузера пользователя вручную или с помощью скрипта. Можно также использовать System Center Configuration Manager или аналогичную платформу.

### <a name="troubleshoot"></a>Диагностика

Если при тестировании перенесенных приложений возникли ошибки, то устранение неполадок может быть первым шагом перед возвратом к существующим AD FS проверяющим сторонам. См. раздел [Отладка единого входа на основе SAML в приложения в Azure Active Directory](debug-saml-sso-issues.md).

### <a name="rollback-migration"></a>Откат миграции

В случае сбоя миграции рекомендуется оставить существующие проверяющие стороны на AD FS серверах и удалить доступ к проверяющим сторонам. Это позволяет быстро выполнять откат при необходимости во время развертывания.

### <a name="employee-communication"></a>Взаимодействие с сотрудниками

В то время как окно планового отключения может быть минимальным, вы все равно должны запланировать интерактивное взаимодействие с сотрудниками при переключении с AD FS в Azure AD. Убедитесь, что у вас есть кнопка отзыва или ссылки на службу технической поддержки.

После завершения развертывания можно сообщить пользователям об успешном развертывании и напомнить о необходимых шагах.

* Попросите пользователей использовать [Мои приложения](https://myapps.microsoft.com) для доступа ко всем перенесенным приложениям.
* Напомним пользователям, что им может потребоваться обновить параметры MFA.
* При развертывании Self-Service сброса пароля пользователям может потребоваться обновить или проверить методы проверки подлинности. См. раздел [MFA](https://aka.ms/mfatemplates) и шаблоны связи для конечных пользователей [SSPR](https://aka.ms/ssprtemplates) .

### <a name="external-user-communication"></a>Взаимодействие внешних пользователей

Эта группа пользователей, как правило, наиболее важна в случае возникновения проблем. Это особенно верно, если уровень безопасности определяет другой набор правил условного доступа или профилей риска для внешних партнеров. Убедитесь, что внешние партнеры знают о расписании миграции в облаке и имеют период времени, в течение которого им рекомендуется участвовать в пилотном развертывании, который тестирует все потоки, уникальные для внешней совместной работы. Наконец, убедитесь, что у них есть способ доступа к службе поддержки в случае возникновения проблем.

## <a name="next-steps"></a>Дальнейшие действия

* Чтение  [миграции проверки подлинности приложения в Azure AD](https://aka.ms/migrateapps/whitepaper).
* Настройте [Условный доступ](../conditional-access/overview.md) и [MFA](../authentication/concept-mfa-howitworks.md).
* Попробуйте пример кода с пошаговыми инструкциями:[AD FS в сборник тренировочных заданий миграции приложений Azure AD для разработчиков](https://aka.ms/adfsplaybook).
