---
title: Настройка автоматического ускорения входа с помощью обнаружения домашней области
description: Узнайте, как настроить политику обнаружения домашней области для проверки подлинности Azure Active Directory для федеративных пользователей, включая автоматическое ускорение и указания доменов.
services: active-directory
documentationcenter: ''
author: kenwith
manager: daveba
ms.service: active-directory
ms.subservice: app-mgmt
ms.workload: infrastructure-services
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: how-to
ms.date: 02/12/2021
ms.author: kenwith
ms.custom: seoapril2019
ms.collection: M365-identity-device-management
ms.openlocfilehash: 8a21b6f5e7d2976bda0efd37577b7cca90469aea
ms.sourcegitcommit: c27a20b278f2ac758447418ea4c8c61e27927d6a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/03/2021
ms.locfileid: "101686450"
---
# <a name="configure-azure-active-directory-sign-in-behavior-for-an-application-by-using-a-home-realm-discovery-policy"></a>Настройка поведения при входе в Azure Active Directory для приложения с помощью политики обнаружения домашней области

В этой статье содержатся общие сведения о настройке Azure Active Directory проверки подлинности для федеративных пользователей с помощью политики обнаружения домашних областей (обнаружения домашней области).  В нем описывается использование автоматического ускорения для пропуска экрана записи имени пользователя и автоматического пересылки пользователей в Федеративные конечные точки входа.  Корпорация Майкрософт не рекомендует больше времени на автоматическое ускорение, так как она может препятствовать использованию более надежных методов проверки подлинности, таких как FIDO, и мешает совместной работе.

## <a name="home-realm-discovery"></a>Обнаружение домашней области

Обнаружение домашней области (обнаружения домашней области) — это процесс, который позволяет Azure Active Directory (Azure AD) определить, какой поставщик удостоверений ("IdP") пользователь должен пройти проверку подлинности во время входа.  При входе в клиент Azure AD для доступа к ресурсу или на общую страницу входа Azure AD пользователь вводит имя пользователя (имя участника-пользователя). Azure AD использует его для обнаружения областей, где пользователь должен выполнить вход.

Пользователь будет передаваться одному из следующих поставщиков удостоверений для проверки подлинности:

- Домашний клиент пользователя (может использоваться тот же, которому принадлежит ресурс, к которому пользователь пытается получить доступ).

- Учетную запись Майкрософт.  Пользователь является гостевым в клиенте ресурсов, который использует для проверки подлинности учетную запись потребителя.

- Локальный поставщик удостоверений, например службы федерации Active Directory (AD FS).

- Другой поставщик удостоверений, включенный в федерацию с клиентом Azure AD.

## <a name="auto-acceleration"></a>Автоматическое ускорение

Для проверки подлинности пользователя некоторые организации настраивают домены в своих клиентах Azure Active Directory, чтобы выполнить объединение с другим поставщиком удостоверений, например с AD FS.  

Когда пользователь входит в систему в приложении, он сначала попадает на страницу входа в Azure AD. После того как он введет свое имя участника-пользователя (если оно есть в федеративном домене), он попадает на страницу входа поставщика удостоверений, обслуживающего этот домен. При определенных обстоятельствах у администраторов может возникнуть необходимость направлять пользователей на страницу входа, когда они пытаются войти в определенные приложения.

В результате пользователь может пропустить начальную страницу Azure Active Directory. Этот процесс называется автоматическим ускорением входа.

В случаях, когда клиент является федеративным в отношении другого поставщика удостоверений для входа, автоматическое ускорение позволяет упростить вход пользователей.  Автоматическое ускорение входа можно настроить для отдельных приложений.

>[!NOTE]
>Если настроить приложение для автоматического ускорения, пользователи не смогут использовать управляемые учетные данные (например, FIDO), а гостевые пользователи не смогут войти в систему. Когда пользователь будет перенаправлен непосредственно к федеративному поставщику удостоверений для аутентификации, он больше не сможет вернуться на страницу входа Azure Active Directory. Гостевые пользователи, которых требуется направить в другие клиенты или внешние поставщики удостоверений, например учетную запись Майкрософт, не смогут выполнить вход в это приложение, так как шаг обнаружения домашней области пропускается.  

Существует три способа управления автоускорением для федеративного IdP:

- Используйте [Указание домена](#domain-hints) при запросах проверки подлинности для приложения.
- Настройте политику обнаружения домашней области для [принудительного автоматического ускорения](#home-realm-discovery-policy-for-auto-acceleration).
- Настройте политику обнаружения домашней области, чтобы [игнорировать указания домена](prevent-domain-hints-with-home-realm-discovery.md) для определенных приложений или для определенных доменов.

### <a name="domain-hints"></a>Указания домена

Указания домена представляют собой директивы, включенные в запрос на аутентификацию из приложения. Их можно использовать для ускорения входа пользователя на страницу входа федеративного поставщика удостоверений. Или они могут использоваться мультитенантным приложением, чтобы ускорить для клиента вход пользователя непосредственно на страницу входа Azure AD с фирменной символикой.  

Например, приложение largeapp.com дает возможность клиентам получить доступ к приложению с помощью пользовательского URL-адреса contoso.largeapp.com. Приложение может также включать указание домена contoso.com в запрос на аутентификацию.

Синтаксис указания домена может быть разным в зависимости от используемого протокола и обычно настраивается в приложении.

**WS-Federation**: емкость = contoso. com в строке запроса.

**SAML**: либо запрос на аутентификацию SAML, содержащий указание домена, либо строка запроса whr=contoso.com.

**Open ID Connect**: строка запроса domain_hint = contoso. com.

По умолчанию Azure AD пытается перенаправить вход в IdP, настроенный для домена, если выполняются **оба** следующих условия.

- Указание домена включается в запрос проверки подлинности из приложения **и**
- Клиент является федеративным с этим доменом.

Если указание домена не ссылается на проверенный федеративный домен, оно игнорируется.

Дополнительные сведения об автоматическом ускорении с помощью указаний домена, поддерживаемых службой Azure Active Directory, см. в блоге [Enterprise Mobility + Security](https://cloudblogs.microsoft.com/enterprisemobility/2015/02/11/using-azure-ad-to-land-users-on-their-custom-login-page-from-within-your-app/).

>[!NOTE]
>Если указание домена включено в запрос проверки подлинности и [должно быть соблюдаться](#home-realm-discovery-policy-to-prevent-auto-acceleration), его присутствие переопределяет автоматическое ускорение, установленное для приложения в политике обнаружения домашней области.

### <a name="home-realm-discovery-policy-for-auto-acceleration"></a>Политика обнаружения домашней области для автоматического ускорения входа

Некоторые приложения не предоставляют возможность настроить выдаваемый ими запрос на аутентификацию. В таких случаях невозможно использовать указания домена для управления автоматическим ускорением. Автоматическое ускорение можно настроить с помощью политики обнаружения домашних областей, чтобы добиться того же поведения.  

### <a name="home-realm-discovery-policy-to-prevent-auto-acceleration"></a>Политика обнаружения домашней области для предотвращения автоматического ускорения

Некоторые приложения Майкрософт и SaaS автоматически включают domain_hints (например, `https://outlook.com/contoso.com` выдает запрос на вход с `&domain_hint=contoso.com` добавлением), что может привести к нарушению работы управляемых учетных данных, таких как Fido.  Вы можете использовать [политику обнаружения домашней области](https://docs.microsoft.com/graph/api/resources/homeRealmDiscoveryPolicy) , чтобы игнорировать указания домена для определенных приложений или для определенных доменов во время развертывания управляемых учетных данных.  

## <a name="enable-direct-ropc-authentication-of-federated-users-for-legacy-applications"></a>Включение прямой проверки подлинности РОПК для федеративных пользователей для устаревших приложений

Рекомендации для приложений заключаются в использовании библиотек AAD и интерактивного входа для проверки подлинности пользователей. Библиотеки обеспечивают работу потоков федеративных пользователей.  Иногда устаревшие приложения, особенно те, которые используют РОПК Grants, передают имя пользователя и пароль непосредственно в Azure AD и не пишут для понимания Федерации. Они не выполняют обнаружение домашней области и не взаимодействуют с правильной федеративной конечной точкой для проверки подлинности пользователя. Если вы решили, то можете использовать политику обнаружения домашней области, чтобы включить определенные устаревшие приложения, которые передают учетные данные пользователя и пароля, используя РОПК Grant для проверки подлинности непосредственно с Azure Active Directory. У вас должна быть включена функция синхронизации хэша паролей.

> [!IMPORTANT]
> Если у вас включена функция синхронизации хэша паролей и вы знаете, что можно выполнять проверку подлинности этого приложения без использования политик, реализованных локальным поставщиком удостоверений, то достаточно включить только прямую проверку подлинности. Если по какой-либо причине вы отключите синхронизацию хэша паролей или синхронизацию каталогов с помощью AD Connect, вам следует удалить эту политику, чтобы не допустить возможность прямой проверки подлинности с использованием устаревшего хэша пароля.

## <a name="set-hrd-policy"></a>Задание политики обнаружения домашней области (HRD)

Настройка политики обнаружения домашней области в приложении для автоматического ускорения федеративного входа или для непосредственных облачных приложений включает три указанных ниже этапа.

1. Создание политики обнаружения домашней области.

2. Поиск субъекта-службы, к которому будет применена эта политика.

3. Применение политики к субъекту-службе.

Политики вступают в силу для определенного приложения, только если они применены к субъекту-службе.

В любой момент времени для субъекта-службы может быть активна только одна политика обнаружения домашней области.  

Для создания политики обнаружения домашней области и управления ею можно использовать командлеты PowerShell Azure Active Directory.

Ниже приведен пример определения политики обнаружения домашней области.

 ```JSON
   {  
    "HomeRealmDiscoveryPolicy":
    {  
    "AccelerateToFederatedDomain":true,
    "PreferredDomain":"federated.example.edu",
    "AllowCloudPasswordValidation":false,    
    }
   }
```

Тип политики — "[HomeRealmDiscoveryPolicy](https://docs.microsoft.com/graph/api/resources/homeRealmDiscoveryPolicy)".

Параметр **AccelerateToFederatedDomain** — необязательный. Если параметр **AccelerateToFederatedDomain** имеет значение False (Ложь), то политика не влияет на автоматическое ускорение входа. Если параметр **AccelerateToFederatedDomain** имеет значение True (Истина), и в клиенте имеется только один проверенный федеративный домен, то система будет сразу переводить пользователей на федеративный поставщик удостоверений для входа в систему. Если этот параметр имеет значение True (Истина), и в клиенте имеется несколько проверенных доменов, необходимо задать значение для параметра **PreferredDomain**.

Параметр **PreferredDomain** — необязательный. В параметре **PreferredDomain** следует указать домен, вход на который требуется ускорить. Его можно опустить, если клиент использует только один федеративный домен.  Если его не указать, но при этом имеется более одного проверенного федеративного домена, политика не будет действовать.

 Если указан параметр **PreferredDomain**, он должен соответствовать проверенному федеративному домену для клиента. Все пользователи приложения должны иметь возможность входа в этот домен — пользователи, которые не могут войти в федеративный домен, будут перехвачены и не смогут завершить вход.

Параметр **AllowCloudPasswordValidation** — необязательный. Если параметр **AllowCloudPasswordValidation** имеет значение True (Истина), это значит, что приложению разрешено выполнять проверку подлинности федеративного пользователя путем предоставления учетных данных в формате "имя пользователя и пароль" непосредственно в конечную точку маркера Azure Active Directory. Этот способ работает, только если включена синхронизация хэша паролей.

Кроме того, существуют два варианта обнаружения домашней области на уровне клиента, которые не показаны выше:

- **Алтернатеидлогин** является необязательным.  Если этот параметр включен, [пользователи смогут выполнять вход с использованием адресов электронной почты вместо имени участника-пользователя](../authentication/howto-authentication-use-email-signin.md) на странице входа в Azure AD.  Альтернативные идентификаторы полагаются на то, что пользователь не имеет автоматического ускорения до федеративного IDP.

- **Домаинхинтполици** — это необязательный сложный объект, который [ *не позволяет* подсказкам домена от автоматического ускорения пользователей в федеративные домены](prevent-domain-hints-with-home-realm-discovery.md). Этот параметр на уровне клиента используется, чтобы гарантировать, что приложения, отправляющие доменные указания, не препятствуют входу пользователей с помощью учетных данных, управляемых в облаке.

### <a name="priority-and-evaluation-of-hrd-policies"></a>Приоритетность и оценка политик HRD

Вы можете создать политики HRD, а затем назначить их отдельным организациям и субъектам-службам. Это означает, что несколько политик могут применяться к конкретному приложению, поэтому Azure AD должен решить, какой из них имеет приоритет. Набор правил определяет, какая политика обнаружения домашней области (из множества применений) вступает в силу:

- Если в запросе проверки подлинности указана подсказка домена, то проверяется политика обнаружения домашней области для клиента (политика, установленная в качестве клиента по умолчанию), чтобы определить, [следует ли игнорировать указания домена](prevent-domain-hints-with-home-realm-discovery.md). Если разрешены указания домена, используется поведение, заданное указанием домена.

- В противном случае, если политика явно назначена субъекту-службе, применяется именно она.

- Если отсутствует указание домена и нет политики, явно назначенной субъекту-службе, применяется политика, явно назначенная родительской организации субъекта-службы.

- Если отсутствует указание домена и нет политики, назначенной субъекту-службе или организации, используется стандартное поведение HRD.

## <a name="tutorial-for-setting-hrd-policy-on-an-application"></a>Руководство по настройке политики обнаружения домашней области в приложении

Мы будем использовать командлеты PowerShell для Azure AD, чтобы изучить несколько сценариев, включая:

- настройку политики обнаружения домашней области для выполнения автоматического ускорения входа для приложения в клиенте с одним федеративным доменом;

- настройку политики обнаружения домашней области для выполнения автоматического ускорения входа для приложения для одного из нескольких доменов, проверенных для вашего клиента;

- настройку политики обнаружения домашней области для разрешения приложениям прежних версий выполнять прямую проверку подлинности с использованием имени пользователя и пароля в Azure Active Directory для федеративного пользователя;

- получение списка приложений, для которых настроена политика.

### <a name="prerequisites"></a>Предварительные требования

В примерах ниже создаются, обновляются, связываются и удаляются политики для субъектов-служб приложения в Azure AD.

1. Чтобы начать, скачайте последнюю предварительную версию командлетов PowerShell для Azure AD.

2. После этого выполните команду Connect для входа в Azure AD с помощью учетной записи администратора.

    ``` powershell
    Connect-AzureAD -Confirm
    ```

3. Выполните следующую команду для просмотра всех политик в организации.

    ``` powershell
    Get-AzureADPolicy
    ```

Если результат не возвращается, в клиенте нет созданных политик.

### <a name="example-set-an-hrd-policy-for-an-application"></a>Пример. Задание политики обнаружения домашней области для приложения

В этом примере показано, как создать политику, которая при назначении ее приложению выполняет одно из указанных ниже действий.

- Выполняет автоматическое ускорение входа пользователей и переводит их на экран входа AD FS (когда они выполняют вход в систему в приложении), если в клиенте имеется один домен.
- Выполняет автоматическое ускорение входа пользователей и переводит их на экран входа AD FS, если в клиенте имеется несколько федеративных доменов.
- Разрешает неинтерактивный вход с использованием имени пользователя и пароля непосредственно в Azure Active Directory для федеративных пользователей для приложений, которым назначена политика.

#### <a name="step-1-create-an-hrd-policy"></a>Шаг 1. Создание политики обнаружения домашней области

Указанная ниже политика выполняет автоматическое ускорение входа пользователей и переводит их на экран входа AD FS (когда они выполняют вход в систему в приложении), если в клиенте имеется один домен.

``` powershell
New-AzureADPolicy -Definition @("{`"HomeRealmDiscoveryPolicy`":{`"AccelerateToFederatedDomain`":true}}") -DisplayName BasicAutoAccelerationPolicy -Type HomeRealmDiscoveryPolicy
```

Указанная ниже политика выполняет автоматическое ускорение входа пользователей и переводит их на экран входа AD FS, если в клиенте имеется несколько федеративных доменов. Если у вас несколько федеративных доменов, выполняющих проверку подлинности пользователей для приложений, вам потребуется указать домен, для которого необходимо использовать автоматическое ускорение входа.

``` powershell
New-AzureADPolicy -Definition @("{`"HomeRealmDiscoveryPolicy`":{`"AccelerateToFederatedDomain`":true, `"PreferredDomain`":`"federated.example.edu`"}}") -DisplayName MultiDomainAutoAccelerationPolicy -Type HomeRealmDiscoveryPolicy
```

Чтобы создать политику, разрешающую проверку подлинности с использованием имени пользователя и пароля для федеративных пользователей непосредственно в Azure Active Directory для определенных приложений, выполните следующую команду:

``` powershell
New-AzureADPolicy -Definition @("{`"HomeRealmDiscoveryPolicy`":{`"AllowCloudPasswordValidation`":true}}") -DisplayName EnableDirectAuthPolicy -Type HomeRealmDiscoveryPolicy
```

Чтобы просмотреть новую политику и получить ее **ObjectID**, выполните следующую команду:

``` powershell
Get-AzureADPolicy
```

Чтобы применить политику обнаружения домашней области после ее создания, можно назначить ее нескольким субъектам-службам приложения.

#### <a name="step-2-locate-the-service-principal-to-which-to-assign-the-policy"></a>Шаг 2. Поиск субъекта-службы для назначения политики

Чтобы назначить политику субъектам-службам, необходимо знать их идентификаторы **ObjectID**. Существует несколько способов получения идентификатора **ObjectID** субъектов-служб.

Можно использовать портал или отправить запрос к [Microsoft Graph](/graph/api/resources/serviceprincipal?view=graph-rest-beta). Можно также открыть [Graph Explorer Tool](https://developer.microsoft.com/graph/graph-explorer) и войти в учетную запись Azure AD, чтобы просмотреть список всех субъектов-служб в своей организации.

Так как вы используете PowerShell, вы можете использовать следующий командлет, чтобы получить список субъектов-служб и их идентификаторов.

``` powershell
Get-AzureADServicePrincipal
```

#### <a name="step-3-assign-the-policy-to-your-service-principal"></a>Шаг 3. Назначение политики для субъекта-службы

Получив идентификатор **ObjectID** субъекта-службы приложения, для которого требуется настроить автоматическое ускорение, выполните следующую команду. Эта команда привязывает политику обнаружения домашней области, созданную на шаге 1, к субъекту-службе, определенному на шаге 2.

``` powershell
Add-AzureADServicePrincipalPolicy -Id <ObjectID of the Service Principal> -RefObjectId <ObjectId of the Policy>
```

Эту команду можно повторить для каждого субъекта-службы, для которого необходимо добавить политику.

Если приложению уже назначена политика HomeRealmDiscovery, вам не удастся назначить ему еще одну такую политику.  В этом случае измените определение политики обнаружения домашней области, которая назначена приложению, чтобы добавить дополнительные параметры.

#### <a name="step-4-check-which-application-service-principals-your-hrd-policy-is-assigned-to"></a>Шаг 4. Проверка субъектов-служб приложения, которым назначена политика обнаружения домашней области

Чтобы проверить, для каких приложений настроена политика обнаружения домашней области, воспользуйтесь командлетом **Get-AzureADPolicyAppliedObject**. Передайте в него идентификатор **ObjectID** политики, которую нужно проверить.

``` powershell
Get-AzureADPolicyAppliedObject -id <ObjectId of the Policy>
```

#### <a name="step-5-youre-done"></a>Шаг 5. Готово!

Испытайте приложение, чтобы проверить новую политику в действии.

### <a name="example-list-the-applications-for-which-hrd-policy-is-configured"></a>Пример: получение списка приложений, для которых настроена политика обнаружения домашней области

#### <a name="step-1-list-all-policies-that-were-created-in-your-organization"></a>Шаг 1. Получение списка всех политик, созданных в организации

``` powershell
Get-AzureADPolicy
```

Запишите идентификатор **ObjectID** политики, для которой вы хотите получить список назначений.

#### <a name="step-2-list-the-service-principals-to-which-the-policy-is-assigned"></a>Шаг 2. Получение списка субъектов-служб, которым назначена политика  

``` powershell
Get-AzureADPolicyAppliedObject -id <ObjectId of the Policy>
```

### <a name="example-remove-an-hrd-policy-from-an-application"></a>Пример. Удаление политики обнаружения домашней области из приложения

#### <a name="step-1-get-the-objectid"></a>Шаг 1. Получение идентификатора ObjectID

Используйте предыдущий пример, чтобы получить идентификатор **ObjectID** политики, а также идентификатор ObjectID субъекта-службы приложения, из которого нужно удалить эту политику.

#### <a name="step-2-remove-the-policy-assignment-from-the-application-service-principal"></a>Шаг 2. Удаление назначения политики из субъекта-службы приложения  

``` powershell
Remove-AzureADServicePrincipalPolicy -id <ObjectId of the Service Principal>  -PolicyId <ObjectId of the policy>
```

#### <a name="step-3-check-removal-by-listing-the-service-principals-to-which-the-policy-is-assigned"></a>Шаг 3. Проверка удаления путем получения списка субъектов-служб, которым назначена политика

``` powershell
Get-AzureADPolicyAppliedObject -id <ObjectId of the Policy>
```

## <a name="next-steps"></a>Дальнейшие действия

- Дополнительные сведения о принципах работы аутентификации в Azure AD см. в статье [Сценарии аутентификации в Azure Active Directory](../develop/authentication-vs-authorization.md).
- Дополнительные сведения о единый вход пользователей см. в статье [единый вход в приложения в Azure Active Directory](what-is-single-sign-on.md).
- Обзор всего содержимого, связанного с разработчиками, см. на веб- [платформе Microsoft Identity](../develop/v2-overview.md) .
