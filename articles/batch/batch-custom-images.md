---
title: Использование управляемого образа для создания пользовательского пула образов
description: Создайте пул настраиваемых образов пакетной службы из управляемого образа, чтобы подготавливать на них ресурсы, содержащие программное обеспечение и данные для вашего приложения.
ms.topic: conceptual
ms.date: 11/18/2020
ms.openlocfilehash: 9baa65c0f1c1844ea10e3d5b4f0b48924912d233
ms.sourcegitcommit: a8ff4f9f69332eef9c75093fd56a9aae2fe65122
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/24/2021
ms.locfileid: "105023883"
---
# <a name="use-a-managed-image-to-create-a-custom-image-pool"></a>Использование управляемого образа для создания пользовательского пула образов

Чтобы создать пользовательский пул образов для виртуальных машин пула пакетной службы, можно использовать управляемый образ для создания [образа общей коллекции образов](batch-sig-images.md). Также поддерживается использование только управляемого образа, но только для версий API до 2019-08-01 включительно.

> [!IMPORTANT]
> В большинстве случаев пользовательские образы следует создавать с помощью Общей коллекции образов. С помощью Общей коллекции образов можно быстрее подготавливать пулы, масштабировать большее число виртуальных машин и повышать надежность при подготовке виртуальных машин. Дополнительные сведения см. в [Использование Общей коллекции образов для создания пользовательского пула](batch-sig-images.md).

В этом разделе объясняется, как создать пользовательский пул образов, используя только управляемый образ.

## <a name="prerequisites"></a>Предварительные требования

- **Ресурс управляемого образа**. Чтобы создать пул виртуальных машин с помощью пользовательского образа, необходимо иметь или создать ресурс управляемого образа в той же подписке и в том же регионе Azure, к которым принадлежит учетная запись пакетной службы. Образ должен быть создан на основе моментального снимка дисков ОС виртуальной машины и при необходимости ее подключенных дисков данных.
  - Используйте уникальный пользовательский образ для каждого создаваемого пула.
  - Чтобы создать пул на основе образа с помощью API пакетной службы, укажите **идентификатор ресурса** в формате `/subscriptions/xxxx-xxxxxx-xxxxx-xxxxxx/resourceGroups/myResourceGroup/providers/Microsoft.Compute/images/myImage`.
  - Ресурс управляемого образа должен существовать в течение всего времени существования пула, чтобы обеспечивать возможность масштабирования. Ресурс можно удалить после удаления пула.

- **Проверка подлинности через Azure Active Directory (Azure AD)** . API клиента пакетной службы должен использовать проверку подлинности Azure AD. Поддержка Azure AD пакетной службой Azure описана в статье [Аутентификация решений пакетной службы с помощью Active Directory](batch-aad-auth.md).

## <a name="prepare-a-managed-image"></a>Подготовка управляемого образа

В Azure можно подготовить управляемый образ из:

- моментальных снимков ОС и дисков данных виртуальной машины Azure;
- обобщенной виртуальной машины Azure с управляемыми дисками;
- обобщенного локального виртуального жесткого диска, отправленного в облако.

Чтобы пулы пакетной службы на основе управляемого образа масштабировались надежно, рекомендуется создавать управляемый образ *только* с помощью первого метода с использованием моментальных снимков дисков виртуальной машины. Ниже приведены действия по подготовке виртуальной машины, созданию моментального снимка и созданию управляемого образа на основе моментального снимка.

### <a name="prepare-a-vm"></a>Подготовка виртуальной машины

Если для образа создается новая виртуальная машина, для управляемого образа в качестве базового можно использовать собственный образ из Azure Marketplace, поддерживаемый пакетной службой. В качестве базового образа можно использовать только собственные образы Azure Marketplace. Чтобы вывести полный список ссылок на образы из Azure Marketplace, поддерживаемые пакетной службой Azure, см. команду из раздела о [получении списка номеров SKU агента узла](/java/api/com.microsoft.azure.batch.protocol.accounts.listnodeagentskus).

> [!NOTE]
> В качестве базового образа нельзя использовать образы сторонних производителей, для которых предусматриваются дополнительные условия покупки и лицензия. Сведения об этих образах Marketplace см. в руководстве для виртуальных машин [Linux](../virtual-machines/linux/cli-ps-findimage.md#check-the-purchase-plan-information) или [Windows](../virtual-machines/windows/cli-ps-findimage.md#view-purchase-plan-properties).

- Убедитесь, что виртуальная машина создается с управляемым диском. Это параметр хранилища по умолчанию при создании виртуальной машины.
- На виртуальной машине не следует устанавливать расширения Azure, например расширение пользовательских скриптов. Если образ содержит предварительно установленное расширение, в Azure могут возникнуть проблемы при развертывании пула пакетной службы.
- При использовании подключенных дисков данных необходимо подключить и отформатировать диски в виртуальной машине, чтобы использовать их.
- Убедитесь, что предоставленный базовый образ операционной системы использует этот временный диск по умолчанию. Сейчас агент узла пакетной службы ожидает этот диск.
- Убедитесь, что диск ОС не зашифрован.
- После запуска виртуальной машины подключитесь к ней с помощью RDP (для Windows) или SSH (для Linux). Установите все необходимое программное обеспечение или скопируйте необходимые данные.  

### <a name="create-a-vm-snapshot"></a>Создание моментального снимка виртуальной машины

Моментальный снимок — это полная копия виртуального жесткого диска, доступная только для чтения. Чтобы создать моментальный снимок дисков ОС или дисков данных виртуальной машины, можно использовать портал Azure или средства командной строки. Описание действий и параметров, используемых для создания моментального снимка, см. в руководстве по виртуальным машинам [Linux](../virtual-machines/linux/snapshot-copy-managed-disk.md) или [Windows](../virtual-machines/windows/snapshot-copy-managed-disk.md).

### <a name="create-an-image-from-one-or-more-snapshots"></a>Создание образа на основе одного или нескольких моментальных снимков

Чтобы создать управляемый образ на основе моментального снимка, используйте средства командной строки Azure, такие как команда [az image create](/cli/azure/image). Можно создать образ, указав моментальный снимок диска ОС и при необходимости один или несколько моментальных снимков дисков данных.

## <a name="create-a-pool-from-a-managed-image"></a>Создание пула из управляемого образа

Найдя идентификатор ресурса управляемого образа, создайте пользовательский пул образов из этого образа. Ниже показано, как создать пользовательский пул образов с помощью пакетной службы или функции управления пакетной службой.

> [!NOTE]
> Убедитесь, что удостоверение, используемое для проверки подлинности Azure AD, имеет разрешения на доступ к ресурсу образа. Дополнительные сведения см. в статье [Аутентификация решений пакетной службы с помощью Active Directory](batch-aad-auth.md).
>
> Ресурс для управляемого образа должен существовать в течение времени существования пула. При удалении базового ресурса невозможно масштабировать пул.

### <a name="batch-service-net-sdk"></a>Пакет SDK для .NET пакетной службы

```csharp
private static VirtualMachineConfiguration CreateVirtualMachineConfiguration(ImageReference imageReference)
{
    return new VirtualMachineConfiguration(
        imageReference: imageReference,
        nodeAgentSkuId: "batch.node.windows amd64");
}

private static ImageReference CreateImageReference()
{
    return new ImageReference(
        virtualMachineImageId: "/subscriptions/{sub id}/resourceGroups/{resource group name}/providers/Microsoft.Compute/images/{image definition name}");
}

private static void CreateBatchPool(BatchClient batchClient, VirtualMachineConfiguration vmConfiguration)
{
    try
    {
        CloudPool pool = batchClient.PoolOperations.CreatePool(
            poolId: PoolId,
            targetDedicatedComputeNodes: PoolNodeCount,
            virtualMachineSize: PoolVMSize,
            virtualMachineConfiguration: vmConfiguration);

        pool.Commit();
    }
```

### <a name="batch-management-rest-api"></a>REST API для управления пакетной службой

Универсальный код ресурса (URI) REST API

```http
 PUT https://management.azure.com/subscriptions/{sub id}/resourceGroups/{resource group name}/providers/Microsoft.Batch/batchAccounts/{account name}/pools/{pool name}?api-version=2020-03-01
```

Текст запроса

```json
 {
   "properties": {
     "vmSize": "{VM size}",
     "deploymentConfiguration": {
       "virtualMachineConfiguration": {
         "imageReference": {
           "id": "/subscriptions/{sub id}/resourceGroups/{resource group name}/providers/Microsoft.Compute/images/{image name}"
         },
         "nodeAgentSkuId": "{Node Agent SKU ID}"
       }
     }
   }
 }
```

## <a name="considerations-for-large-pools"></a>Рекомендации по созданию крупных пулов

Если вы планируете создать пул с сотнями виртуальных машин на основе пользовательского образа, нужно обязательно следовать изложенным выше рекомендациям и использовать образ, созданный на основе моментального снимка виртуальной машины.

Также обратите внимание на следующие моменты.

- **Максимально допустимые размеры**. Размер пула в пакетной службе ограничивается 2500 выделенными вычислительными узлами или 1000 низкоприоритетными узлами, если используется пользовательский образ.

  Если вы используете один образ (или несколько образов, созданных на основе одного базового моментального снимка) для создания нескольких пулов, общее количество вычислительных узлов в пулах не может превышать указанные выше ограничения. Не рекомендуется использовать один образ или его базовый моментальный снимок для более чем одного пула.

  Максимально допустимые размеры пула могут быть меньше, если пул настраивается как [пул NAT для входящего трафика](pool-endpoint-configuration.md).

- **Время ожидания для изменения размера**. Если пул содержит фиксированное количество узлов (автомасштабирование не выполняется), увеличьте свойство resizeTimeout пула до значения 20–30 минут. Если пулу не удается достичь целевого размера в течение времени ожидания, выполните еще одну [операцию по изменению размера](/rest/api/batchservice/pool/resize).

  Если пул имеет более чем 300 вычислительных узлов, может потребоваться изменить размер пула несколько раз, чтобы достичь целевого размера.
  
С помощью [Общей коллекция образов](batch-sig-images.md) можно создавать большие пулы с настроенными образами вместе с другими репликами общих образов. Используя общие образы, можно сократить время, необходимое пулу для достижения стабильного состояния, на 25 %, а задержку простоя виртуальной машины на 30 %.

## <a name="considerations-for-using-packer"></a>Рекомендации по использованию Packer

Создание ресурса управляемого образа непосредственно с помощью Packer можно выполнять только с учетными записями Пакетной службы в режиме пользовательской подписки. Для учетных записей в режиме Пакетной службы необходимо сначала создать виртуальный жесткий диск, а затем импортировать его в ресурс управляемого образа. В зависимости от режима распределения пула (подписка пользователя или Пакетная служба) действия по созданию ресурса управляемого образа будут отличаться.

Убедитесь, что ресурс, используемый для создания управляемого образа, существует все время существования любых пулов, ссылающихся на пользовательский образ. Несоблюдение этого правила может привести к сбоям при выделении пула и (или) изменении его размера.

При удалении образа или базового ресурса может появиться сообщение об ошибке следующего вида: `There was an error encountered while performing the last resize on the pool. Please try resizing the pool again. Code: AllocationFailed`. При возникновении этой ошибки убедитесь, что базовый ресурс не был удален.

Дополнительные сведения о создании виртуальной машины с помощью средства Packer см. в статье [Сборка образа Linux с помощью Packer](../virtual-machines/linux/build-image-with-packer.md) или [Сборка образа Windows с помощью Packer](../virtual-machines/windows/build-image-with-packer.md).

## <a name="next-steps"></a>Дальнейшие действия

- Узнайте, как использовать [Общую коллекцию образов](batch-sig-images.md) для создания пользовательского пула.
- Подробные сведения о пакетной службе см. в статье [Рабочий процесс и ресурсы пакетной службы](batch-service-workflow-features.md).
