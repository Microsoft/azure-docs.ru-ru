---
title: Метрики, оповещения и журналы диагностики
description: Запись и анализ событий журнала диагностики для ресурсов учетной записи пакетной службы Azure, таких как пулы и задачи.
ms.topic: how-to
ms.date: 03/25/2021
ms.custom: seodec18
ms.openlocfilehash: 22fdf00b6e144e022f955aed6fd24b7a6bcb7300
ms.sourcegitcommit: 73d80a95e28618f5dfd719647ff37a8ab157a668
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/26/2021
ms.locfileid: "105606034"
---
# <a name="batch-metrics-alerts-and-logs-for-diagnostic-evaluation-and-monitoring"></a>Метрики, оповещения и журналы пакетной службы для диагностики и мониторинга

Azure Monitor собирает [метрики](../azure-monitor/essentials/data-platform-metrics.md) и [журналы диагностики](../azure-monitor/essentials/platform-logs-overview.md) для ресурсов в учетной записи пакетной службы Azure.

Вы можете получать и использовать эти данные различными способами для мониторинга учетной записи пакетной службы и диагностики проблем. Вы также можете настроить [метрики оповещений](../azure-monitor/alerts/alerts-overview.md), чтобы получать уведомления о достижении определенных значений.

## <a name="batch-metrics"></a>Метрики пакетной службы

[Метрики](../azure-monitor/essentials/data-platform-metrics.md)  — это данные телеметрии Azure (также называемые счетчиками производительности), которые создаются ресурсами Azure и потребляются службой Azure Monitor. Примерами метрик в учетной записи пакетной службы являются события создания пула, Low-Priority число узлов и события завершения задач. Эти метрики позволяют определить тенденции и использовать их для анализа данных.

См. [полный список поддерживаемых метрик для пакетной службы](../azure-monitor/essentials/metrics-supported.md#microsoftbatchbatchaccounts).

Метрики:

- по умолчанию включены для всех учетных записей пакетной службы и не требуют настройки;
- создаются каждую минуту;
- не сохраняются автоматически, но доступны в течение 30 дней в обновляемом журнале. Метрики действий можно сохранять в журнале ведения диагностики.

## <a name="view-batch-metrics"></a>Просмотр метрик пакетной службы

В портал Azure на странице **обзора** учетной записи пакетной службы будут показаны метрики основных узлов, ядер и задач по умолчанию.

Чтобы просмотреть дополнительные метрики для учетной записи пакетной службы, выполните следующие действия.

1. В портал Azure выберите **все службы**  >  **учетные записи пакета** служб, а затем выберите имя учетной записи пакета.
1. В разделе **Мониторинг** выберите **Метрики**.
1. Выберите **Добавить метрику** , а затем выберите метрику из раскрывающегося списка.
1. Выберите параметр **статистической обработки** для метрики. Для метрик на основе количества (например, "число выделенных ядер" или "число узлов с низким приоритетом") используйте функцию **AVG** агрегат. Для метрик на основе событий (например, "события изменения размера пула") используйте статистическое выражение **Count**. Избегайте использования агрегата **Sum** , который суммирует значения всех точек данных, полученных за период диаграммы.
1. Чтобы добавить дополнительные метрики, повторите шаги 3 и 4.

Метрики также можно получить программно с помощью Azure Monitor API. Пример см. в разделе [Получение метрик Azure Monitor с помощью .NET](/samples/azure-samples/monitor-dotnet-metrics-api/monitor-dotnet-metrics-api/).

> [!NOTE]
> Метрики, созданные за последние 3 минуты, по-прежнему могут быть агрегированными, так что в течение этого времени могут выводиться значения. Доставка метрик не гарантируется, и на нее может повлиять неупорядоченная доставка, потери данных или дублирование.

## <a name="batch-metric-alerts"></a>Оповещения на основе метрик пакетной службы

Вы можете настроить оповещения на основе метрик практически в реальном времени, которые активируются, когда значение указанной метрики выходит за пределы назначенного порога. Оповещение формирует уведомление, когда переходит в активное состояние (т. е. когда значение метрики выходит за пределы порога и выполнены условия оповещения) и когда переходит в разрешенное состояние (т. е. когда значение метрики снова соответствует порогу и условие больше не выполняется).

Поскольку доставка метрик может подвергаться несогласованности, таким как неупорядоченная доставка, потери данных или дублирование, рекомендуется избегать оповещений, которые инициируются на одной точке данных. Вместо этого используйте пороговые значения для учета любых несоответствий, таких как неупорядоченная доставка, потери данных и дублирование за определенный период времени.

Например, вы можете настроить оповещение метрики, срабатывающее при снижении числа ядер с низким приоритетом ниже определенного уровня, чтобы управлять составом пулов. Для получения лучших результатов задайте период в 10 или более минут, где будет срабатывать предупреждение, если среднее число ядер с низким приоритетом становится ниже порогового значения для всего периода. Это позволяет выполнять статистическую обработку метрик, чтобы получить более точные результаты.

Чтобы настроить оповещение метрики в портал Azure:

1. Выберите **Все службы** > **Учетные записи пакетной службы** и щелкните имя учетной записи пакетной службы.
1. В разделе **мониторинг** выберите **оповещения**, а затем выберите **новое правило генерации оповещений**.
1. Выберите **Добавить условие**, а затем выберите метрику.
1. Выберите нужные значения для параметров **период диаграммы**, **пороговое значение**, **оператор** и **тип агрегирования**.
1. Введите **пороговое значение** и выберите **единицу** для порогового значения.  Затем выберите **Готово**.
1. Добавьте [группу действий](../azure-monitor/alerts/action-groups.md) в оповещение, выбрав существующую группу действий или создав новую группу действий.
1. В разделе **сведения о правиле оповещения** введите имя и **Описание** **правила генерации оповещений** . Если вы хотите, чтобы предупреждение было включено немедленно, убедитесь, что установлен флажок **включить правило генерации оповещений при создании** .
1. Выберите **Создать правило генерации оповещений**.

Дополнительные сведения о создании оповещений метрик см. [в статьях понимание принципов работы оповещений метрик в Azure Monitor](../azure-monitor/alerts/alerts-metric-overview.md) и [Создание, Просмотр оповещений метрик и управление ими с помощью Azure Monitor](../azure-monitor/alerts/alerts-metric.md).

Вы также можете настроить оповещение практически в реальном времени с помощью [Azure Monitor REST API](/rest/api/monitor/). Дополнительные сведения см. [в разделе Обзор оповещений в Microsoft Azure](../azure-monitor/alerts/alerts-overview.md). Чтобы включить в оповещения сведения о задании, задаче или пуле, см. раздел [реагирование на события с помощью оповещений Azure Monitor](../azure-monitor/alerts/tutorial-response.md).

## <a name="batch-diagnostics"></a>Диагностика пакетной службы

[Журналы диагностики](../azure-monitor/essentials/platform-logs-overview.md) содержат сведения, созданные ресурсами Azure, которые описывают работу каждого ресурса. Для пакетной службы можно собирать следующие журналы:

- **Сервицелог**: [события, созданные пакетной службой](#service-log-events) в течение времени существования отдельного ресурса, такого как пул или задача.
- **Аллметрикс**: метрики на уровне учетной записи пакетной службы.

Необходимо явно включить параметры диагностики для каждой учетной записи пакетной службы, которую необходимо отслеживать.

### <a name="log-destination-options"></a>Параметры места назначения журнала

Обычно в целевого расположения для журналов используется учетная запись хранения Azure. Чтобы сохранять журналы в хранилище Azure, создайте учетную запись перед включением сбора журналов. Если у вас уже есть учетная запись хранения, связанная с учетной записью пакетной службы, вы можете выбрать ее в качестве целевого расположения для журналов.

Кроме того, можно:

- Потоковая передача событий журнала диагностики пакетной службы в [концентратор событий Azure](../event-hubs/event-hubs-about.md). Центры событий способны принимать миллионы событий в секунду, позволяя преобразовать и сохранять их с помощью любого поставщика аналитики в реальном времени.
- Отправьте журналы диагностики в [журналы Azure Monitor](../azure-monitor/logs/log-query-overview.md), где вы сможете проанализировать их или экспортировать для анализа в Power BI или Excel.

> [!NOTE]
> Хранение и (или) обработка данных журнала диагностики в службах Azure может повлечь дополнительные расходы.

### <a name="enable-collection-of-batch-diagnostic-logs"></a>Включение сбора журналов диагностики пакетной службы

Чтобы создать новый параметр диагностики в портал Azure, выполните следующие действия.

1. В портал Azure выберите **все службы**  >  **учетные записи пакета** служб, а затем выберите имя учетной записи пакета.
2. В разделе **Мониторинг** выберите **Параметры диагностики**.
3. В окне **параметры диагностики** выберите **Добавить параметр диагностики**.
4. Введите имя параметра.
5. Выберите назначение: **отправка log Analytics**, **Архивация в учетную запись хранения** или **поток в концентратор событий**. При выборе учетной записи хранения можно дополнительно указать количество дней, в течение которых будут храниться данные для каждого журнала. Если вы не укажете число дней для хранения, данные будут храниться в течение всего срока существования учетной записи хранения.
6. Выберите **сервицелог**, **аллметрикс** или оба.
7. Выберите **сохранить** , чтобы создать параметр диагностики.

Вы также можете включить сбор журналов, [создав параметры диагностики в портал Azure](../azure-monitor/essentials/diagnostic-settings.md), используя [шаблон диспетчер ресурсов](../azure-monitor/essentials/resource-manager-diagnostic-settings.md)или используя Azure PowerShell или Azure CLI. Дополнительные сведения см. в статье Общие сведения о [журналах платформы Azure](../azure-monitor/essentials/platform-logs-overview.md).

### <a name="access-diagnostics-logs-in-storage"></a>Доступ к журналам диагностики в хранилище

Если вы [архивирует журналы диагностики пакетной службы в учетной записи хранения](../azure-monitor/essentials/resource-logs.md#send-to-azure-storage), в учетной записи хранения создается контейнер хранилища, как только происходит соответствующее событие. Созданным BLOB-объектам присваиваются имена в соответствии со следующим шаблоном именования:

```json
insights-{log category name}/resourceId=/SUBSCRIPTIONS/{subscription ID}/
RESOURCEGROUPS/{resource group name}/PROVIDERS/MICROSOFT.BATCH/
BATCHACCOUNTS/{Batch account name}/y={four-digit numeric year}/
m={two-digit numeric month}/d={two-digit numeric day}/
h={two-digit 24-hour clock hour}/m=00/PT1H.json
```

Например:

```json
insights-metrics-pt1m/resourceId=/SUBSCRIPTIONS/XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX/
RESOURCEGROUPS/MYRESOURCEGROUP/PROVIDERS/MICROSOFT.BATCH/
BATCHACCOUNTS/MYBATCHACCOUNT/y=2018/m=03/d=05/h=22/m=00/PT1H.json
```

Каждый файл BLOB-объекта `PT1H.json` содержит большой двоичный объект в формате JSON с событиями, произошедшими в течение часа, как указано в URL-адресе этого объекта (например, `h=12`). В течение заданного часа события добавляются в файл `PT1H.json` по мере возникновения. Значение минуты (`m=00`) всегда равно `00`, так как события журнала диагностики разбиваются на отдельные большие двоичные объекты каждый час. (Все значения времени указаны в формате UTC.)

Ниже приведен пример записи `PoolResizeCompleteEvent` в файле журнала `PT1H.json`. Она содержит сведения о текущем и целевом количестве выделенных узлов и узлов с низким приоритетом, а также времени начала и окончания операции:

```json
{ "Tenant": "65298bc2729a4c93b11c00ad7e660501", "time": "2019-08-22T20:59:13.5698778Z", "resourceId": "/SUBSCRIPTIONS/XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX/RESOURCEGROUPS/MYRESOURCEGROUP/PROVIDERS/MICROSOFT.BATCH/BATCHACCOUNTS/MYBATCHACCOUNT/", "category": "ServiceLog", "operationName": "PoolResizeCompleteEvent", "operationVersion": "2017-06-01", "properties": {"id":"MYPOOLID","nodeDeallocationOption":"Requeue","currentDedicatedNodes":10,"targetDedicatedNodes":100,"currentLowPriorityNodes":0,"targetLowPriorityNodes":0,"enableAutoScale":false,"isAutoPool":false,"startTime":"2019-08-22 20:50:59.522","endTime":"2019-08-22 20:59:12.489","resultCode":"Success","resultMessage":"The operation succeeded"}}
```

Для программного доступа к журналам в учетной записи хранения используйте API-интерфейсы хранилища.

### <a name="service-log-events"></a>События журнала службы

Журналы пакетной службы Azure содержат события, генерируемые пакетной службой в течение времени существования отдельного ресурса пакетной службы, например пула или задачи. Каждое событие, генерируемое пакетной службой, сохраняется в журнал в формате JSON. Например, так выглядит текст **события создания пула**:

```json
{
    "poolId": "myPool1",
    "displayName": "Production Pool",
    "vmSize": "Small",
    "cloudServiceConfiguration": {
        "osFamily": "5",
        "targetOsVersion": "*"
    },
    "networkConfiguration": {
        "subnetId": " "
    },
    "resizeTimeout": "300000",
    "targetDedicatedComputeNodes": 2,
    "taskSlotsPerNode": 1,
    "vmFillType": "Spread",
    "enableAutoscale": false,
    "enableInterNodeCommunication": false,
    "isAutoPool": false
}
```

События журнала службы, созданные пакетной службой, включают следующее:

- [Создание пула](batch-pool-create-event.md)
- [Начало удаления пула](batch-pool-delete-start-event.md)
- [Завершение удаления пула](batch-pool-delete-complete-event.md)
- [Начало изменения размера пула](batch-pool-resize-start-event.md)
- [Завершение изменения размера пула](batch-pool-resize-complete-event.md)
- [Автомасштабирование пула](batch-pool-autoscale-event.md)
- [Начало выполнения задачи](batch-task-start-event.md)
- [Завершение выполнения задачи](batch-task-complete-event.md)
- [Сбой выполнения задачи](batch-task-fail-event.md)
- [Сбой расписания задачи](batch-task-schedule-fail-event.md)

## <a name="next-steps"></a>Дальнейшие действия

- См. дополнительные сведения об [API-интерфейсах и средствах пакетной службы](batch-apis-tools.md) для сборки решений пакетной службы.
- См. дополнительные сведения о [мониторинге решений пакетной службы](monitoring-overview.md).
