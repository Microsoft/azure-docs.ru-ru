---
title: Обработка и обнаружение ошибок в пакетной службе Azure
description: Получите представление об обработке ошибок в рабочих процессах пакетной службы с точки зрения разработчика.
ms.topic: article
ms.date: 05/15/2020
ms.openlocfilehash: 3bd460598dae08fa18415e1c9865249f3ca4c9c2
ms.sourcegitcommit: f28ebb95ae9aaaff3f87d8388a09b41e0b3445b5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/29/2021
ms.locfileid: "85964283"
---
# <a name="error-handling-and-detection-in-azure-batch"></a>Обработка и обнаружение ошибок в пакетной службе Azure

Иногда в решении пакетной службы бывает необходимо обрабатывать как ошибки задач, так и ошибки приложений. В этой статье рассказывается о различных типах ошибок и о том, как их устранять.

## <a name="error-codes"></a>Коды ошибок

Основные типы ошибок

- Сбои в работе сети, когда запросы не достигают пакетной службы или когда ответы пакетной службы не поступают клиенту вовремя.
- Внутренние ошибки сервера (стандартный HTTP-ответ с кодом состояния 5xx).
- Ошибки, связанные с регулированием полосы пропускания или количества запросов, например HTTP-ответы с кодом состояния 429 или 503 и заголовком Retry-After.
- Ошибки с кодом 4xx, например AlreadyExists и InvalidOperation. Это означает, что текущее состояние ресурса не позволяет осуществить переход между состояниями.

Подробные сведения о конкретных кодах ошибок, включая коды ошибок REST API, пакетной службы, задач или их планирования см. в разделе [Коды состояний и ошибок пакетной службы](/rest/api/batchservice/batch-status-and-error-codes).

## <a name="application-failures"></a>Ошибки приложений

Во время выполнения приложение может создавать диагностические данные, которые помогут устранить неполадки. Как упоминалось в разделе [Файлы и каталоги](files-and-directories.md), пакетная служба записывает содержимое стандартных потоков вывода и ошибок в файлы `stdout.txt` и `stderr.txt` соответственно, расположенные в каталоге задач на вычислительном узле.

Чтобы получить эти файлы, можно использовать портал Azure или один из пакетов SDK пакетной службы. Например, вы можете получить эти и другие файлы для устранения неполадок, используя методы [ComputeNode.GetNodeFile](/dotnet/api/microsoft.azure.batch.computenode) и [CloudTask.GetNodeFile](/dotnet/api/microsoft.azure.batch.cloudtask) библиотеки .NET для пакетной службы.

## <a name="task-errors"></a>Ошибки задач

Ошибки задач делятся на несколько категорий.

### <a name="pre-processing-errors"></a>Ошибки предварительной обработки

Если не удается запустить задачу, для нее устанавливается ошибка предварительной обработки.  

Ошибки предварительной обработки могут возникать, если файлы ресурсов задачи перемещены, учетная запись хранения недоступна или не удалось выполнить копирование файлов на узел из-за другой проблемы.

### <a name="file-upload-errors"></a>Ошибки передачи файлов

Если по какой-либо причине происходит сбой передачи файлов, указанных для задачи, для нее устанавливается ошибка передачи файлов.

Ошибки передачи файлов могут возникать, если подписанный URL-адрес, указанный для доступа к службе хранилища Azure, недействителен или не предоставляет разрешения на запись, учетная запись хранения недоступна либо произошла другая ошибка, которая не позволяет скопировать файлы с узла.

### <a name="application-errors"></a>Ошибки приложений

Процесс, указанный в командной строке задачи, также может завершиться ошибкой. Если процесс, который выполняет задача, возвращает ненулевой код завершения, считается, что такой процесс завершился ошибкой (см. подраздел *Код завершения задач* в следующем разделе).

Вы можете настроить пакетную службу так, чтобы в случае ошибки приложения она автоматически повторяла задачу, а также указать максимальное количество таких попыток.

### <a name="constraint-errors"></a>Ошибки ограничений

Вы можете установить ограничение на максимальное время выполнения задания или задачи с помощью параметра *maxWallClockTime*. Это полезно для завершения задач, переставших отвечать на запросы.

Если превышено максимальное время выполнения, задача отмечается как *завершенная*, но с кодом выхода `0xC000013A`. При этом поле *schedulingError* будет иметь значение `{ category:"ServerError", code="TaskEnded"}`.

## <a name="task-exit-codes"></a>Коды завершения задач

Как упоминалось выше, пакетная служба помечает задачу как завершившуюся сбоем, если процесс, выполняемый задачей, возвращает ненулевой код завершения. Когда задача выполняет процесс, пакетная служба заполняет свойство кода завершения задачи кодом возврата процесса.

Следует отметить, что код завершения задачи определяется не пакетной службой. Код завершения задачи определяется самим процессом или операционной системой, в которой он выполняется.

## <a name="task-failures-or-interruptions"></a>Сбои и прерывания задач

Задачи могут иногда завершаться ошибками или прерываться. Например, может завершиться ошибкой приложение задачи или узел, на котором выполняется задача, может быть перезапущен. Кроме того, узел может быть удален из пула при изменении размера, если установленная политика отмены выделения предусматривает немедленное удаление узла без ожидания завершения задачи. Во всех случаях пакетная служба может автоматически поставить задачу в очередь на повторное выполнение на другом узле.

Задача может также зависнуть или выполняться слишком долго из-за кратковременного сбоя. Для задачи можно установить максимальный интервал выполнения. В случае его превышения пакетная служба прерывает выполнение приложения задачи.

## <a name="connect-to-compute-nodes"></a>Подключение к вычислительным узлам

Дополнительные возможности для отладки и устранения неполадок можно получить, выполнив вход на вычислительный узел удаленно. Вы можете использовать портал Azure, чтобы скачать RDP-файл для узлов Windows и получить сведения о подключении SSH для узлов Linux. Это также можно сделать с помощью API пакетной службы, например с помощью [Batch .NET](/dotnet/api/microsoft.azure.batch.computenode) или [Batch Python](batch-linux-nodes.md#connect-to-linux-nodes-using-ssh).

> [!IMPORTANT]
> Чтобы подключиться к узлу по протоколу RDP или SSH, на узле нужно создать пользователя. Для этого можно использовать портал Azure, [добавить учетную запись пользователя на узел](/rest/api/batchservice/computenode/adduser) с помощью REST API пакетной службы, вызвать метод [ComputeNode.CreateComputeNodeUser](/dotnet/api/microsoft.azure.batch.computenode) в .NET API пакетной службы или метод [add_user](batch-linux-nodes.md#connect-to-linux-nodes-using-ssh) в модуле Python пакетной службы.

Если необходимо ограничить или отключить доступ к вычислительным узлам по RDP или SSH, см. руководство по [настройке или отключению удаленного доступа к вычислительным узлам в пуле пакетной службы Azure](pool-endpoint-configuration.md).

## <a name="troubleshoot-problem-nodes"></a>Устранение неполадок с узлами

В ситуациях, когда при выполнении некоторых задач происходит сбой, пакетное клиентское приложение или служба может проверить метаданные неудачных задач для определения узла, который плохо работает. Каждому узлу в пуле присваивается уникальный идентификатор, а сведения об узле, на котором выполняется задача, включены в метаданные задачи. Определив проблемный узел, вы можете предпринять некоторые действия:

- **Перезапустить узел** ([REST](/rest/api/batchservice/computenode/reboot) | [.NET](/dotnet/api/microsoft.azure.batch.computenode.reboot))

    В некоторых случаях перезапуск узла может устранить некоторые скрытые проблемы, например задержки и сбои при выполнении процессов. Если пул использует начальную задачу или задание использует задачу подготовки задания, они будут выполнены при перезапуске узла.
- **Пересоздать образ узла** ([REST](/rest/api/batchservice/computenode/reimage) | [.NET](/dotnet/api/microsoft.azure.batch.computenode.reimage))

    Это обеспечит переустановку операционной системы на узле. Как и в случае перезагрузки узла, задачи запуска и задачи подготовки заданий будут повторно выполнены после повторного создания образа узла.
- **Удалить узел из пула** ([REST](/rest/api/batchservice/pool/removenodes) | [.NET](/dotnet/api/microsoft.azure.batch.pooloperations))

    Иногда бывает необходимо полностью удалить узел из пула.
- **Отключить планирование задач на узле** ([REST](/rest/api/batchservice/computenode/disablescheduling) | [.NET](/dotnet/api/microsoft.azure.batch.computenode.disablescheduling))

    Это эффективно переключит узел в "автономный режим", чтобы ему не назначались дальнейшие задачи, но сохранялась возможность продолжать выполнять текущие задачи, оставаясь в пуле. Благодаря этому вы сможете продолжить поиск причины сбоев без потери данных невыполненной задачи и без сбоев при выполнении дополнительных задач на узле. Например, можно отключить планирование задач на узле, а затем выполнить удаленный вход на узел для анализа журналов событий или устранения других неполадок. Проанализировав проблемы, вы сможете снова подключить узел к сети, включив планирование задач ([REST](/rest/api/batchservice/computenode/enablescheduling) | [.NET](/dotnet/api/microsoft.azure.batch.computenode.enablescheduling)) или выполнив одно из указанных выше действий.

> [!IMPORTANT]
> С помощью описанных выше действий можно указать, как задачи, выполняемые в данный момент на узле, будут обрабатываться при выполнении действия. Например, при отключении планирования задач на узле с помощью клиентской библиотеки .NET для пакетной службы вы можете задать значение перечисления [DisableComputeNodeSchedulingOption](/dotnet/api/microsoft.azure.batch.common.disablecomputenodeschedulingoption), чтобы указать, что нужно сделать до выполнения действия (**TaskCompletion**): **прекратить выполнение** текущих задач, **повторно поставить их в очередь** для планирования выполнения на других узлах или разрешить их завершение.

## <a name="retry-after-errors"></a>Повторный запуск после устранения ошибок

При возникновении сбоя API-интерфейсы пакетной службы выдают соответствующее уведомление. Все задачи можно повторить, и для этой цели они все содержат глобальный обработчик повторных запусков. Лучше всего использовать именно этот встроенный механизм.

После сбоя следует подождать некоторое время (несколько секунд), прежде чем повторять запуск. При слишком частых или быстрых повторных попытках обработчик будет регулировать производительность.

## <a name="next-steps"></a>Дальнейшие действия

- Узнайте, как [проверить наличие ошибок в пуле и на узле](batch-pool-node-error-checking.md).
- Узнайте, как [проверить наличие ошибок заданий и задач](batch-job-task-error-checking.md).
- Ознакомьтесь со списком [кодов состояний и ошибок пакетной службы](/rest/api/batchservice/batch-status-and-error-codes).
