---
title: Настройка ключей, управляемых клиентом, для учетной записи пакетной службы Azure с помощью Azure Key Vault и управляемого удостоверения
description: Узнайте, как шифровать данные пакетной службы с помощью управляемых клиентом ключей.
author: pkshultz
ms.topic: how-to
ms.date: 01/25/2021
ms.author: peshultz
ms.openlocfilehash: 01dc21f067b03ad8e07a05a18aa6312ed7f7189e
ms.sourcegitcommit: a055089dd6195fde2555b27a84ae052b668a18c7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/26/2021
ms.locfileid: "98789419"
---
# <a name="configure-customer-managed-keys-for-your-azure-batch-account-with-azure-key-vault-and-managed-identity"></a>Настройка ключей, управляемых клиентом, для учетной записи пакетной службы Azure с помощью Azure Key Vault и управляемого удостоверения

По умолчанию Пакетная служба Azure использует ключи, управляемые платформой, для шифрования всех данных клиента, хранящихся в пакетной службе Azure, таких как сертификаты, задания и метаданные задач. При необходимости можно использовать собственные ключи, например управляемые клиентом ключи, для шифрования данных, хранящихся в пакетной службе Azure.

Предоставленные ключи должны быть созданы в [Azure Key Vault](../key-vault/general/basic-concepts.md), и к ним должны обращаться [управляемые удостоверения для ресурсов Azure](../active-directory/managed-identities-azure-resources/overview.md).

Существует два типа управляемых удостоверений: [ *назначенные системой* и *назначенные пользователем*](../active-directory/managed-identities-azure-resources/overview.md#managed-identity-types).

Вы можете создать учетную запись пакетной службы с управляемым удостоверением, назначенным системой, или создать отдельное управляемое удостоверение, назначаемое пользователем, которое будет иметь доступ к ключам, управляемым клиентом. Просмотрите [таблицу сравнения](../active-directory/managed-identities-azure-resources/overview.md#managed-identity-types) , чтобы понять различия и определить, какой вариант лучше подходит для вашего решения. Например, если вы хотите использовать одно и то же управляемое удостоверение для доступа к нескольким ресурсам Azure, потребуется назначенное пользователем управляемое удостоверение. В противном случае может быть достаточно управляемого системой удостоверения, связанного с учетной записью пакетной службы. Использование управляемого удостоверения, назначенного пользователем, также дает возможность принудительно применять управляемые клиентом ключи при создании учетной записи пакетной службы, как показано [в примере ниже](#create-a-batch-account-with-user-assigned-managed-identity-and-customer-managed-keys).

> [!IMPORTANT]
> Поддержка управляемых клиентом ключей в пакетной службе Azure в настоящее время находится в общедоступной предварительной версии для Западной Европы, Северной Европы, Северная Швейцария, центральной части США, юго-центральной части США, западной части US, Восточной, Восточной, восток США 2, Запад США 2, а также US Gov (Вирджиния) и US Gov (Аризона) регионов.
> Эта предварительная версия предоставляется без соглашения об уровне обслуживания и не рекомендована для использования рабочей среде. Некоторые функции могут не поддерживаться или их возможности могут быть ограничены.
> Дополнительные сведения см. в статье [Дополнительные условия использования предварительных выпусков Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).

## <a name="create-a-batch-account-with-system-assigned-managed-identity"></a>Создание учетной записи пакетной службы с управляемым удостоверением, назначенным системой

Если не требуется отдельно назначаемое пользователем управляемое удостоверение, при создании учетной записи пакетной службы можно включить управляемое удостоверение, назначенное системой.

### <a name="azure-portal"></a>Портал Azure

В [портал Azure](https://portal.azure.com/)при создании учетных записей пакетной службы выберите **система назначена** в поле Тип удостоверения на вкладке **Дополнительно** .

![Снимок экрана новой учетной записи пакетной службы с назначенным системой типом удостоверения.](./media/batch-customer-managed-key/create-batch-account.png)

После создания учетной записи можно найти уникальный идентификатор GUID в поле **идентификатор участника идентификации** в разделе **свойства** . Будет показан **тип удостоверения** `System assigned` .

![Снимок экрана, показывающий уникальный идентификатор GUID в поле идентификатора субъекта идентификации.](./media/batch-customer-managed-key/linked-batch-principal.png)

Это значение потребуется для предоставления этой учетной записи пакетной службы доступа к Key Vault.

### <a name="azure-cli"></a>Azure CLI

При создании новой учетной записи пакетной службы укажите `SystemAssigned` для `--identity` параметра значение.

```azurecli
resourceGroupName='myResourceGroup'
accountName='mybatchaccount'

az batch account create \
    -n $accountName \
    -g $resourceGroupName \
    --locations regionName='West US 2' \
    --identity 'SystemAssigned'
```

После создания учетной записи можно проверить, что назначенное системой удостоверение включено для этой учетной записи. Не забудьте отметить `PrincipalId` , так как это значение потребуется для предоставления этой учетной записи пакетной службы доступа к Key Vault.

```azurecli
az batch account show \
    -n $accountName \
    -g $resourceGroupName \
    --query identity
```

> [!NOTE]
> Управляемое системой удостоверение, созданное в учетной записи пакетной службы, используется только для получения ключей, управляемых клиентом, из Key Vault. Это удостоверение недоступно для пулов пакетной службы.

## <a name="create-a-user-assigned-managed-identity"></a>Создание управляемого удостоверения, назначаемого пользователем

При желании можно [создать управляемое пользователем удостоверение](../active-directory/managed-identities-azure-resources/how-to-manage-ua-identity-portal.md#create-a-user-assigned-managed-identity) , которое можно использовать для доступа к ключам, управляемым клиентом.

Чтобы получить доступ к Key Vault, потребуется значение **идентификатора клиента** этого удостоверения.

## <a name="configure-your-azure-key-vault-instance"></a>Настройка экземпляра Azure Key Vault

Azure Key Vault, в котором будут создаваться ключи, должны быть созданы в том же клиенте, что и учетная запись пакетной службы. Она не обязательно должна находиться в той же группе ресурсов или даже в той же подписке.

### <a name="create-an-azure-key-vault"></a>создать Azure Key Vault;

При [создании экземпляра Azure Key Vault](../key-vault/general/quick-create-portal.md) с управляемыми клиентом ключами для пакетной службы Azure убедитесь, что включена защита **обратимого удаления** и **очистки** .

![Снимок экрана с экраном создания Key Vault.](./media/batch-customer-managed-key/create-key-vault.png)

### <a name="add-an-access-policy-to-your-azure-key-vault-instance"></a>Добавление политики доступа к экземпляру Azure Key Vault

В портал Azure после создания Key Vault в **политике доступа** в разделе " **Настройка**" добавьте доступ к учетной записи пакетной службы с помощью управляемого удостоверения. В разделе **ключевые разрешения** выберите **получить**, **переносить ключ** и **разносить ключ**.

![Скриншов, на котором отображается экран Добавление политики доступа.](./media/batch-customer-managed-key/key-permissions.png)

В поле **Выбор** в разделе **участник** укажите одно из следующих данных:

- Для управляемого удостоверения, назначенного системой: введите `principalId` ранее полученное значение или имя учетной записи пакетной службы.
- Для назначаемого пользователем управляемого удостоверения: введите ранее полученный **идентификатор клиента** или имя управляемого удостоверения, назначенного пользователем.

![Снимок экрана основного экрана.](./media/batch-customer-managed-key/principal-id.png)

### <a name="generate-a-key-in-azure-key-vault"></a>Создание нового ключа в Azure Key Vault

В портал Azure перейдите к экземпляру Key Vault в разделе **ключ** и выберите **создать/импортировать**. Выберите **тип ключа** , `RSA` а **Размер ключа RSA** — по крайней мере в `2048` битах. `EC` в настоящее время типы ключей не поддерживаются в качестве ключа, управляемого клиентом, в учетной записи пакетной службы.

![Создание ключа](./media/batch-customer-managed-key/create-key.png)

После создания ключа щелкните только что созданный ключ и текущую версию, скопируйте **идентификатор ключа** в разделе **свойства** .  Убедитесь, что в разделе **Разрешенные операции** установлены флажки Включить **и разносить** **ключ** .

## <a name="enable-customer-managed-keys-on-a-batch-account"></a>Включение управляемых клиентом ключей в учетной записи пакетной службы

После выполнения описанных выше действий можно включить управляемые клиентом ключи в учетной записи пакетной службы.

### <a name="azure-portal"></a>Портал Azure

В [портал Azure](https://portal.azure.com/)перейдите на страницу учетной записи пакетной службы. В разделе **Шифрование** включите ключ, **управляемый клиентом**. Можно напрямую использовать идентификатор ключа или выбрать хранилище ключей, а затем щелкнуть **выбрать хранилище ключей и ключ**.

![Снимок экрана, показывающий раздел "шифрование" и параметр для включения управляемого клиентом ключа](./media/batch-customer-managed-key/encryption-page.png)

### <a name="azure-cli"></a>Azure CLI

После создания учетной записи пакетной службы с управляемым удостоверением, назначенным системой, и доступа к Key Vault Обновите учетную запись пакетной службы, указав `{Key Identifier}` URL-адрес в `keyVaultProperties` параметре. Также задайте **encryption_key_source** как `Microsoft.KeyVault` .

```azurecli
az batch account set \
    -n $accountName \
    -g $resourceGroupName \
    --encryption_key_source Microsoft.KeyVault \
    --encryption_key_identifier {YourKeyIdentifier} 
```

## <a name="create-a-batch-account-with-user-assigned-managed-identity-and-customer-managed-keys"></a>Создание учетной записи пакетной службы с управляемым пользователем удостоверением и управляемыми клиентом ключами

С помощью клиента .NET для управления пакетной службой можно создать учетную запись пакетной службы, которой будут назначены управляемое пользователем удостоверение и управляемые клиентом ключи.

```c#
EncryptionProperties encryptionProperties = new EncryptionProperties()
{
    KeySource = KeySource.MicrosoftKeyVault,
    KeyVaultProperties = new KeyVaultProperties()
    {
        KeyIdentifier = "Your Key Azure Resource Manager Resource ID"
    }
};

BatchAccountIdentity identity = new BatchAccountIdentity()
{
    Type = ResourceIdentityType.UserAssigned,
    UserAssignedIdentities = new Dictionary<string, BatchAccountIdentityUserAssignedIdentitiesValue>
    {
            ["Your Identity Azure Resource Manager ResourceId"] = new BatchAccountIdentityUserAssignedIdentitiesValue()
    }
};
var parameters = new BatchAccountCreateParameters(TestConfiguration.ManagementRegion, encryption:encryptionProperties, identity: identity);

var account = await batchManagementClient.Account.CreateAsync("MyResourceGroup",
    "mynewaccount", parameters); 
```

## <a name="update-the-customer-managed-key-version"></a>Обновление версии ключа, управляемого клиентом

При создании новой версии ключа Обновите учетную запись пакетной службы, чтобы она использовала новую версию. Выполните следующие действия.

1. Перейдите к учетной записи пакетной службы в портал Azure и отобразите параметры шифрования.
2. Введите универсальный код ресурса (URI) для новой версии ключа. Кроме того, можно выбрать Key Vault и ключ еще раз, чтобы обновить версию.
3. Сохраните изменения.

Для обновления версии также можно использовать Azure CLI.

```azurecli
az batch account set \
    -n $accountName \
    -g $resourceGroupName \
    --encryption_key_identifier {YourKeyIdentifierWithNewVersion} 
```

## <a name="use-a-different-key-for-batch-encryption"></a>Использовать другой ключ для шифрования пакетов

Чтобы изменить ключ, используемый для пакетного шифрования, выполните следующие действия.

1. Перейдите к учетной записи пакетной службы и отобразите параметры шифрования.
2. Введите универсальный код ресурса (URI) для нового ключа. Кроме того, можно выбрать Key Vault и выбрать новый ключ.
3. Сохраните изменения.

Для использования другого ключа можно также использовать Azure CLI.

```azurecli
az batch account set \
    -n $accountName \
    -g $resourceGroupName \
    --encryption_key_identifier {YourNewKeyIdentifier} 
```

## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы

- **Поддерживаются ли ключи, управляемые клиентом, для существующих учетных записей пакетной службы?** Нет. Ключи, управляемые клиентом, поддерживаются только для новых учетных записей пакетной службы.
- **Можно ли выбрать размер ключа RSA, превышающий 2048 бит?** Да, `3072` `4096` также поддерживаются размеры ключей и бит RSA.
- **Какие операции доступны после отзыва управляемого клиентом ключа?** Единственной операцией может быть удаление учетной записи, если пакетная служба теряет доступ к ключу, управляемому клиентом.
- **Как восстановить доступ к учетной записи пакетной службы при случайном удалении ключа Key Vault?** Поскольку включена защита от очистки и обратимое удаление, можно восстановить существующие ключи. Дополнительные сведения см. [в статье восстановление Azure Key Vault](../key-vault/general/key-vault-recovery.md).
- **Можно ли отключить управляемые клиентом ключи?** В любое время можно установить тип шифрования учетной записи пакетной службы в значение «Microsoft Managed Key». После этого вы можете удалить или изменить ключ.
- **Как можно поворачивать ключи?** Ключи, управляемые клиентом, не поворачиваются автоматически. Чтобы повернуть ключ, обновите идентификатор ключа, с которым связана учетная запись.
- **Сколько времени потребуется для повторной работы учетной записи пакетной службы после восстановления доступа?** После восстановления доступа учетную запись можно будет снова получить до 10 минут.
- **Хотя учетная запись пакетной службы недоступна, что происходит с ресурсами?** Все пулы, которые выполняются при потере пакетного доступа к ключам, управляемым клиентом, будут продолжать работать. Тем не менее узлы переходят в недоступное состояние, и выполнение задач перестанет выполняться (и будет снова поставлено в очередь). После восстановления доступа узлы снова становятся доступными, а задачи будут перезапущены.
- **Применяется ли этот механизм шифрования к дискам виртуальных машин в пуле пакетной службы?** Нет. Для пулов конфигурации облачной службы шифрование не применяется к операционной системе и временному диску. Для пулов конфигурации виртуальных машин операционная система и все указанные диски данных будут зашифрованы с помощью управляемого платформой Майкрософт ключа по умолчанию. В настоящее время нельзя указать собственный ключ для этих дисков. Чтобы зашифровать временный диск для пула пакетной службы с управляемым платформенным ключом Майкрософт, необходимо включить свойство [дискенкриптионконфигуратион](/rest/api/batchservice/pool/add#diskencryptionconfiguration) в пуле [конфигурации виртуальной машины](/rest/api/batchservice/pool/add#virtualmachineconfiguration) . Для строго конфиденциальных сред рекомендуется включить временное шифрование дисков и избежать хранения конфиденциальных данных на дисках операционной системы и данных. Дополнительные сведения см. [в разделе Создание пула с включенным шифрованием дисков](./disk-encryption.md) .
- **Назначено ли системой управляемое удостоверение учетной записи пакетной службы, доступной на этих узлах?** Нет. Управляемое системой удостоверение в настоящее время используется только для доступа к Azure Key Vault для ключа, управляемого клиентом.

## <a name="next-steps"></a>Дальнейшие действия

- Дополнительные сведения о [рекомендациях по обеспечению безопасности в пакетной службе Azure](security-best-practices.md).
- Дополнительные сведения о[Azure Key Vault](../key-vault/general/basic-concepts.md).
