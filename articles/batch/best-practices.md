---
title: Рекомендации
description: Ознакомьтесь с рекомендациями и полезными советами по разработке решений пакетной службы Azure.
ms.date: 03/11/2020
ms.topic: conceptual
ms.openlocfilehash: 7ef94b07a5131726c42a94088fd3ee1f413dbec7
ms.sourcegitcommit: ba3a4d58a17021a922f763095ddc3cf768b11336
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/23/2021
ms.locfileid: "104802358"
---
# <a name="azure-batch-best-practices"></a>Рекомендации для пакетной службы Azure

В этой статье рассматривается набор рекомендаций и полезные советы по эффективному использованию пакетной службы Azure в зависимости от реального опыта работы с пакетной службой. Эти советы помогут повысить производительность и избежать ошибок проектирования в решениях пакетной службы Azure.

> [!TIP]
> Рекомендации по обеспечению безопасности в пакетной службе Azure см. в статье рекомендации по [обеспечению безопасности и соответствию пакетной](security-best-practices.md)службы.

## <a name="pools"></a>Пулы

[Пулы](nodes-and-pools.md#pools) являются ресурсами вычислений для выполнения заданий в пакетной службе. В следующих разделах приводятся рекомендации по работе с пулами пакетной службы.

### <a name="pool-configuration-and-naming"></a>Настройка пулов и присвоение им имен

- **Режим распределения пула:** При создании учетной записи пакетной службы можно выбрать один из двух режимов распределения пула: **Пакетная служба** или **Пользовательская подписка**. В большинстве случаев следует использовать стандартный режим "Пакетная служба". В нем пулы автоматически выделяются в подписках, управляемых пакетной службой. В альтернативном режиме "Пользовательская подписка" виртуальные машины пакетной службы и другие ресурсы создаются непосредственно в подписке пользователя при создании пула. Учетные записи пользовательской подписки в основном используются для обеспечения работы важного, но небольшого подмножества сценариев. Дополнительные сведения о режиме пользовательской подписки см. в статье [Дополнительная настройка для режима пользовательской подписки](batch-account-create-portal.md#additional-configuration-for-user-subscription-mode).

- **"virtualMachineConfiguration" или "cloudServiceConfiguration":** Хотя в настоящее время вы можете создавать пулы с помощью любой конфигурации, новые пулы следует настроить с помощью "virtualMachineConfiguration", а не "cloudServiceConfiguration". Все текущие и новые функции пакетной службы будут поддерживаться пулами конфигурации виртуальных машин. Пулы конфигурации облачных служб не поддерживают все функции, и новые возможности не планируются. Вы не сможете создавать новые пулы "cloudServiceConfiguration" или добавлять новые узлы в существующие пулы [после 29 февраля 2024 г](https://azure.microsoft.com/updates/azure-batch-cloudserviceconfiguration-pools-will-be-retired-on-29-february-2024/). Дополнительные сведения см. в статье [Перенос конфигурации пула пакетной службы из облачных служб в виртуальную машину](batch-pool-cloud-service-to-virtual-machine-configuration.md).

- **Рассмотрите время выполнения задания и задачи при определении сопоставления заданий и пулов.** Если у вас есть задания, которые выполняются в основном из-за кратковременных задач, а ожидаемые суммарные числа задач невелики, то общее ожидаемое время выполнения задания не будет выделять новый пул для каждого задания. Время выделения узлов уменьшит время выполнения задания.

- **Пулы должны иметь более одного вычислений:** Доступ к отдельным узлам всегда не гарантируется. В редких случаях сбои оборудования, обновления операционной системы и другие проблемы могут привести к отключению отдельных узлов. Если для рабочей нагрузки пакетной службы требуется детерминированный, гарантированный ход выполнения, необходимо выделить пулы с несколькими узлами.

- **Не используйте образы с ожидаемыми датами окончания срока жизни (конца строки).**
    Настоятельно рекомендуется избегать образов с ожидающими окончаниями срока службы поддержки пакетов (конца строки). Эти даты можно обнаружить с помощью [ `ListSupportedImages` API](https://docs.microsoft.com/rest/api/batchservice/account/listsupportedimages), [PowerShell](https://docs.microsoft.com/powershell/module/az.batch/get-azbatchsupportedimage)или [Azure CLI](https://docs.microsoft.com/cli/azure/batch/pool/supported-images). Вы обязаны периодически обновлять представление конца строки дат, отличных от пулов, и переносить рабочие нагрузки до наступления даты конца строки. Если вы используете пользовательский образ с указанным агентом узла, необходимо убедиться в том, что вы следите за сроком службы пакетной поддержки для образа, для которого пользовательское изображение является производным или согласованным.

- **Не используйте повторно имена ресурсов.**
    Ресурсы пакетной службы (задания, пулы и т. д.) часто бывают временными. Например, вы можете создать пул в понедельник, удалить его во вторник, а затем создать другой пул в четверг. Каждому новому создаваемому ресурсу следует присваивать уникальное имя, которое раньше не использовалось. Это можно сделать, используя идентификатор GUID (как полное имя ресурса или как часть такого имени) или внедряя время создания ресурса в имя ресурса. Пакетная служба поддерживает [DisplayName](/dotnet/api/microsoft.azure.batch.jobspecification.displayname), который можно использовать для предоставления ресурсу понятного человеку имени, даже если фактический идентификатор ресурса понятным не является. Использование уникальных имен упрощает выявление действий, выполненных определенным ресурсом, в журналах и метриках. Это также устраняет неоднозначность, если когда-либо придется заполнять обращение в службу поддержки ресурса.


- **Непрерывность при обслуживании и сбое пула:** Лучше использовать пулы динамически. Если задания используют один и тот же пул для всего, существует вероятность того, что задания не будут выполняться, если что-то окажется не так с пулом. Это особенно важно для срочных рабочих нагрузок. Чтобы устранить эту проблему, пул следует выбирать или создавать динамически при планировании каждого задания. Либо должен иметься способ переопределения имени пула, чтобы можно было обойти неработоспособный пул.

- **Непрерывность бизнес-процессов во время обслуживания и сбоя пула:** Существует множество причин, по которым пул может не расти до требуемого размера, например внутренние ошибки, ограничения емкости и т. д. По этой причине вы должны быть готовы к перенаправлению заданий в другой пул (возможно, с другим размером виртуальной машины — пакет поддерживает это через [упдатежоб](/dotnet/api/microsoft.azure.batch.protocol.joboperationsextensions.update)) при необходимости. Избегайте использования статического идентификатора пула и предположений, что он никогда не будет удален и никогда не изменится.

### <a name="pool-lifetime-and-billing"></a>Время существования пула и выставление счетов

Время существования пула может различаться в зависимости от метода выделения и параметров, применяемых к конфигурации пула. Пулы могут иметь произвольное время существования и разное количество вычислительных узлов в пуле в любой момент времени. Вы отвечаете за управление вычисленными узлами в пуле явным образом или через функции, предоставляемые службой ([Автомасштабирование](nodes-and-pools.md#automatic-scaling-policy) или [автопул](nodes-and-pools.md#autopools)).

- **Обеспечьте актуальность пулов:** Измените размер пулов на ноль каждые несколько месяцев, чтобы получить [последние обновления агента узла и исправления ошибок](https://github.com/Azure/Batch/blob/master/changelogs/nodeagent/CHANGELOG.md). Пул не будет принимать обновления агентов узлов, если он не создан повторно или его размер не приведен к 0 узлов вычислений. Перед повторным созданием или изменением размера пула рекомендуется скачать все журналы агентов узлов для отладки, как описано в разделе [Узлы](#nodes).

- **Повторное создание пула:** В подобной заметке не рекомендуется ежедневно удалять и повторно создавать пулы. Вместо этого создайте новый пул и обновите существующие задания, чтобы они указывали на новый пул. Когда все задачи будут перемещены в новый пул, удалите старый пул.

- **Эффективность и выставление счетов для пула:** Сам пакет не требует дополнительной оплаты, но плата за использование ресурсов вычислений взимается. Плата взимается за каждый вычислительный узел в пуле независимо от состояния, в котором он находится. Сюда входят все расходы, необходимые для работы узла, такие как затраты на хранение данных и сеть. Дополнительные рекомендации см. в разделе [Анализ затрат и бюджеты для пакетной службы Azure](budget.md).

### <a name="pool-allocation-failures"></a>Сбои выделения пулов

Сбои при выделении пулов могут происходить в любой момент во время первого выделения памяти или при последующих изменениях размеров. Это может быть вызвано временной нехваткой в регионе или сбоях в других службах Azure, на которые полагается пакетная служба. Ваша базовая квота является не гарантией, а ограничением.

### <a name="unplanned-downtime"></a>Незапланированный простой

Пулы пакетной службы могут сталкиваться с событиями простоя в Azure. Помните об этом при планировании и разработке сценария или рабочего процесса для пакетной службы.

В случае сбоя узла пакетная службы автоматически пытается восстановить эти вычислительные узлы от вашего имени. Это может вызвать перепланирование любой выполняемой задачи на восстанавливаемом узле. Дополнительные сведения о прерванных задачах см. в разделе [Проектирование для повторных попыток](#design-for-retries-and-re-execution).

### <a name="custom-image-pools"></a>Пользовательские пулы образов

При создании пула в пакетной службе Azure с помощью конфигурации виртуальной машины необходимо указать образ виртуальной машины, предоставляющий операционную систему, для каждого вычислительного узла в пуле. Вы можете создать пул с поддерживаемым образом Azure Marketplace или [создать пользовательский образ с общим изображением из коллекции образов](batch-sig-images.md). Вы также можете использовать [управляемый образ](batch-custom-images.md) для создания пользовательского пула образов. при возможности рекомендуется создавать пользовательские образы с помощью коллекции общих образов. С помощью коллекции общих образов можно быстрее подготавливать пулы, масштабировать большие объемы виртуальных машин и повышать надежность при подготовке виртуальных машин.

### <a name="third-party-images"></a>Сторонние образы

Пулы можно создавать с помощью сторонних образов, опубликованных в Azure Marketplace. При использовании учетных записей пакетной службы в режиме пользовательской подписки может появиться сообщение об ошибке "сбой выделения из-за проверки допустимости покупки Marketplace" при создании пула с определенными сторонними образами. Чтобы устранить эту ошибку, примите условия, заданные издателем образа. Это можно сделать с помощью [Azure PowerShell](/powershell/module/azurerm.marketplaceordering/set-azurermmarketplaceterms) или [Azure CLI](/cli/azure/vm/image/terms).

### <a name="azure-region-dependency"></a>Зависимость от региона Azure

Вы не должны полагаться на один регион Azure, если у вас есть учетная или рабочая нагрузка, учитывающая время. Хотя и редко, случаются проблемы, которые могут повлиять на весь регион. Например, если обработка должна начаться в определенное время, рассмотрите возможность увеличения пула в основном регионе, *заранее и с хорошим запасом времени*. Если масштабирование пула завершается сбоем, можно вернуться к масштабированию пула в резервном регионе (или регионах). Пулы, распределенные по нескольким учетным записям в разных регионах, обеспечивают готовый и легкодоступный резерв, если что-то пошло не так с другим пулом. Дополнительные сведения см. в статье [Обеспечение высокого уровня доступности при проектировании приложения](high-availability-disaster-recovery.md).

## <a name="jobs"></a>Задания

[Задание](jobs-and-tasks.md#jobs) — это контейнер, предназначенный для хранения сотен, тысяч или даже миллионов задач. При создании заданий следуйте этим рекомендациям.

### <a name="fewer-jobs-more-tasks"></a>Меньше заданий, больше задач

Использовать задание для выполнения одной задачи — неэффективно. Например, более эффективно использовать одно задание, содержащее 1000 задач, вместо создания 100 заданий, содержащих 10 задач. Выполнение заданий 1000 с одной задачей — это наименее эффективный, самый медленный и наиболее ресурсоемкий подход.

Поэтому не следует проектировать пакетные решения, требующие тысяч одновременно активных заданий. Для задач нет квоты, поэтому выполнение множества задач внутри минимально возможного числа заданиями позволит эффективно использовать [задания и квоты расписания заданий](batch-quota-limit.md#resource-quotas).

### <a name="job-lifetime"></a>Время существования задания

В пакетной службе задание имеет неопределенное время существования до его удаления из системы. Его состояние определяет, может ли оно принимать больше задач для планирования или нет.

Задание не переходит автоматически в завершенное состояние, пока оно не завершено явным образом. Это может выполняться автоматически с помощью свойства [onAllTasksComplete](/dotnet/api/microsoft.azure.batch.common.onalltaskscomplete) или [maxWallClockTime](/rest/api/batchservice/job/add#jobconstraints).

Существуют [квоты по умолчанию для активных заданий и расписаний заданий](batch-quota-limit.md#resource-quotas). Задания и расписания заданий в завершенном состоянии не учитываются в этой квоте.

## <a name="tasks"></a>Задания

[Задачи](jobs-and-tasks.md#tasks) — это отдельные единицы работы, составляющие задание. Задачи отправляются пользователем и планируются пакетной службой на вычислительных узлах. При создании и выполнении задач необходимо учитывать несколько аспектов проектирования. В следующих разделах описываются распространенные сценарии и способы проектирования задач, позволяющие обеспечить решение проблем и эффективную работу.

### <a name="save-task-data"></a>Сохранение данных задачи

Вычислительные узлы по своей природе являются временными. Существует множество функций в пакетной службе, таких как [автопул](nodes-and-pools.md#autopools) и [Автомасштабирование](nodes-and-pools.md#automatic-scaling-policy) , которые позволяют легко исчезать узлы. Когда узлы оставляют пул (из-за изменения размера или удаления пула), все файлы на этих узлах также удаляются. По этой причине задача должна переместить выходные данные с узла, на котором она выполняется, в устойчивое хранилище перед своим завершением. Аналогично, если задача завершается ошибкой, необходимо переместить журналы, необходимые для диагностики сбоя, в устойчивое хранилище.

В пакетную службу интегрирована поддержка службы хранилища Azure для отправки данных с помощью [OutputFiles](batch-task-output-files.md), а также различных общих файловых систем. Отправку также можно выполнять самостоятельно в своих задачах.

### <a name="manage-task-lifetime"></a>Управление временем существования задачи

Удаляйте задачи, когда они больше не нужны, или задавайте ограничение задач [retentionTime](/dotnet/api/microsoft.azure.batch.taskconstraints.retentiontime). Если задано `retentionTime`, пакетная служба автоматически очищает дисковое пространство, используемое задачей, по истечении `retentionTime`.

Удаление задач достигает двух целей. Оно гарантирует, что в задании не будет накапливаться задач, что может усложнить запрос/поиск интересующей вас задачи (из-за необходимости отфильтровывать завершенные задачи). Оно также очищает соответствующие данные задачи на узле (предоставленный `retentionTime` еще не был достигнут). Это помогает гарантировать, что узлы не заполняются данными задач и у них не заканчивается место на диске.

### <a name="submit-large-numbers-of-tasks-in-collection"></a>Отправка большого количества задач в коллекции

Задачи можно отправлять отдельно или в коллекциях. Отправляйте задачи в [коллекциях](/rest/api/batchservice/task/addcollection), до 100 за раз, при выполнении групповой отправки задач для снижения издержек и времени отправки.

### <a name="set-max-tasks-per-node-appropriately"></a>Задавайте адекватное максимальное число задач на узле

Пакетная служба поддерживает подписку на избыточное число задач на узлах (выполнение большего числа задач, чем у узла имеется ядер). Вам самим нужно проверять, что ваши задачи "помещаются" на узлы в пуле. Например, может возникнуть снижение производительности при планировании восьми задач, каждая из которых потребляет 25 % загрузки ЦП, на одном узле (в пуле с `taskSlotsPerNode = 8`).

### <a name="design-for-retries-and-re-execution"></a>Проектирование для повторных попыток и повторного выполнения

Задачи могут автоматически повторяться пакетной службой. Существует два типа повторных попыток: управляемый пользователем и внутренний. Повторные попытки, управляемые пользователем, задаются [maxTaskRetryCount](/dotnet/api/microsoft.azure.batch.taskconstraints.maxtaskretrycount) задачи. Когда программа, указанная в задаче, завершается с ненулевым кодом выхода, задача повторяется число раз, равное значению `maxTaskRetryCount`.

Иногда задача может быть повторно выполнена внутренне из-за сбоя на вычислительном узле, например неспособности обновить внутреннее состояние или сбоя узла во время выполнения задачи. Задача будет повторяться на том же вычислительном узле, если это возможно, пока не достигнут внутренний предел попыток повтора. Потом она будет отсрочена, и пакетная служба заново запланирует ее выполнение, возможно, на другом вычислительном узле.

Выполнение задач на выделенных узлах и узлах с низким приоритетом проектируется одинаково. Упреждена ли задача при выполнении на узле с низким приоритетом или прервана из-за сбоя на выделенном узле, в обеих ситуациях проблему можно исправить, проектируя задачу так, чтобы она могла выдержать сбой.

### <a name="build-durable-tasks"></a>Создание устойчивых задач

Задачи должны быть рассчитаны на сбой и допускать повторные попытки. Это особенно важно для задач с длительным выполнением. Для этого убедитесь, что задачи выдают один и тот же результат, даже если они выполняются более одного раза. Один из способов добиться этого — сделать задачи "ищущими цель". Другой способ — убедиться в том, что задачи идемпотентны (задачи будут выдавать тот же результат, независимо от того, сколько раз они выполняются).

Распространенным примером является задача копирования файлов на вычислительный узел. Простой подход тут — задача, которая копирует все указанные файлы при каждом запуске, что неэффективно и не устойчиво к сбоям. Вместо этого создайте задачу, проверяющую, находятся ли файлы на вычислительном узле. То есть задачу, которая не копирует уже существующие файлы. Таким образом, задача сможет продолжить оттуда, где она была прервана.

### <a name="avoid-short-execution-time"></a>Избегайте короткого времени выполнения

Задачи, которые выполняются только в течение одной или двух секунд, не идеальны. Попробуйте выполнить значительный объем работы в отдельной задаче (не менее 10 секунд, а затем — до часов или дней). Если выполнение каждой задачи занимают минуту (или более), то планирование задач не будет занимать большой доли от общего времени вычислений.

### <a name="use-pool-scope-for-short-tasks-on-windows-nodes"></a>Использование области пула для коротких задач на узлах Windows

При планировании задачи на узлах пакетной службы можно выбрать, следует ли запускать ее с областью задач или областью пула. Если задача будет выполняться только в течение короткого времени, область задач может оказаться неэффективной из-за ресурсов, необходимых для создания автоматической учетной записи пользователя для этой задачи. Для повышения эффективности рекомендуется задать для этих задач область пула. Дополнительные сведения см. в разделе [выполнение задачи как автоматического пользователя с областью пула](batch-user-accounts.md#run-a-task-as-an-auto-user-with-pool-scope).

## <a name="nodes"></a>Узлы

[Вычислительный узел](nodes-and-pools.md#nodes) — это виртуальная машина Azure или облачной службы, назначенная для обработки определенной рабочей нагрузки вашего приложения. При работе с узлами следуйте приведенным ниже рекомендациям.

### <a name="idempotent-start-tasks"></a>Идемпотентные задачи запуска

Как и в случае с другими задачами, [задачи запуска](jobs-and-tasks.md#start-task) узла должны быть идемпотентными, так как они будут повторно выполняться при каждом запуске узла. Идемпотентная задача — это просто задача, которая выдает одинаковые результаты при многократном выполнении.

### <a name="isolated-nodes"></a>Изолированные узлы

Рассмотрите возможность использования изолированных размеров виртуальных машин для рабочих нагрузок с соблюдением требований или нормативными требованиями. Поддерживаемые изолированные размеры в режиме конфигурации виртуальной машины: `Standard_E80ids_v4` , `Standard_M128ms` ,,, `Standard_F72s_v2` `Standard_G5` `Standard_GS5` и `Standard_E64i_v3` . Дополнительные сведения о размерах изолированных виртуальных машин см. [в статье изоляция виртуальных машин в Azure](../virtual-machines/isolation.md).

### <a name="manage-long-running-services-via-the-operating-system-services-interface"></a>Управление долго работающими службами с помощью интерфейса служб операционной системы

Иногда требуется запустить другой агент вместе с агентом пакетной службы в узле. Например, может потребоваться собрать данные из узла и сообщить о них. Рекомендуется развертывать такие агенты, как службы операционной системы, скажем, служба Windows или служба `systemd` Linux.

Во время работы этих служб они не должны принимать блокировки файлов для любых файлов в каталогах, управляемых пакетной службой на узле, так как в противном случае пакетная служба не сможет удалить эти каталоги из-за блокировки файлов. Например, при установке службы Windows в задаче запуска, вместо запуска службы непосредственно из рабочего каталога задачи запуска, скопируйте файлы в другое место (если файлы там уже существуют, просто пропустите копирование). Затем установите службу из этого расположения. Когда пакетная служба повторно выполняет задачу запуска, она удаляет рабочий каталог задачи запуска и создает его снова. Это работает потому, что служба имеет блокировки файлов в другом каталоге, а не в рабочем каталоге задачи запуска.

### <a name="avoid-creating-directory-junctions-in-windows"></a>Избегайте создания соединений каталогов в Windows

Соединения каталогов, иногда называемые жесткими связями каталогов, создают сложности при очистке задач и заданий. Используйте символические ссылки (мягкие связи), а не жесткие связи.

### <a name="collect-the-batch-agent-logs"></a>Сбор журналов агента пакетной службы

Если замечена проблема, связанная с поведением узла или задач, выполняемых на узле, соберите журналы агента пакетной службы перед отменой выделения этого узла. Журналы агента пакетной службы можно собирать с помощью API отправки журналов пакетной службы. Эти журналы можно предоставить корпорации Майкрософт как часть запроса в службу поддержки, что поможет устранить неполадки и решить проблемы.

### <a name="manage-os-upgrades"></a>Управление обновлениями ОС

Для учетных записей пакетной службы в режиме пользовательской подписки автоматическое обновление ОС может прерывать ход выполнения задач, особенно если задачи долго выполняются. [Создание задач идемпотентными](#build-durable-tasks) помогает сократить количество ошибок, вызванных этими перерывами. Также рекомендуется [планировать обновление образов ОС в течение времени, когда задачи не выполняются](../virtual-machine-scale-sets/virtual-machine-scale-sets-automatic-upgrade.md#manually-trigger-os-image-upgrades).

Для пулов Windows `enableAutomaticUpdates` `true` по умолчанию имеет значение. Рекомендуется разрешить автоматическое обновление, но это значение можно задать, если необходимо `false` убедиться, что обновление ОС не происходит неожиданно.

## <a name="isolation-security"></a>Защита путем изоляции

В целях изоляции, если в сценарии требуется изолировать задания друг от друга, делайте это, помещая их в отдельные пулы. Пул — это граница изоляции безопасности в пакетной службе. По умолчанию два пула не видны друг другу и не могут взаимодействовать друг с другом. Избегайте использования отдельных учетных записей пакетной службы в качестве средства изоляции.

## <a name="moving-batch-accounts-across-regions"></a>Перемещение учетных записей пакетной службы между регионами

Существуют сценарии, в которых может быть полезно переместить существующую учетную запись пакетной службы из одного региона в другой. Например, может потребоваться перейти в другой регион в рамках планирования аварийного восстановления.

Учетные записи пакетной службы Azure нельзя напрямую перемещать из одного региона в другой. Однако можно использовать шаблон Azure Resource Manager для экспорта существующей конфигурации учетной записи пакетной службы. Затем можно разместить ресурс в другом регионе, экспортировав учетную запись пакетной службы в шаблон, изменив параметры в соответствии с регионом назначения и развернув шаблон в новом регионе.

После отправки шаблона в новый регион потребуется повторное создание сертификатов, расписаний заданий и пакетов приложений. Чтобы сохранить изменения и завершить перемещение учетной записи пакетной службы, не забудьте удалить исходную учетную запись пакетной службы или группу ресурсов.

Дополнительные сведения о Resource Manager и шаблонах см. в [Кратком руководстве по созданию и развертыванию шаблонов Azure Resource Manager с помощью портала Azure](../azure-resource-manager/templates/quickstart-create-templates-use-the-portal.md).

## <a name="connectivity"></a>Соединение

Ознакомьтесь со следующими рекомендациями, связанными с подключением в пакетных решениях.

### <a name="network-security-groups-nsgs-and-user-defined-routes-udrs"></a>Группы безопасности сети (NSG) и определяемые пользователем маршруты (UDR)

При подготовке [пулов пакетной службы в виртуальной сети](batch-virtual-network.md) убедитесь, что тщательно следуете рекомендациям по использованию тега `BatchNodeManagement`, портов, протоколов и направления правила. Вместо использования базового IP-адреса пакетной службы настоятельно рекомендуется использовать тег службы. Дело в том, что IP-адреса могут меняться со временем. Использование IP-адресов пакетной службы напрямую может привести к нестабильной работе, перерывам или простоям пулов пакетной службы.

Для определяемых пользователем маршрутов (UDR) убедитесь, что существует процесс периодического обновления IP-адресов пакетной службы в таблице маршрутов, так как эти адреса меняются со временем. Чтобы узнать, как получить список IP-адресов пакетной службы, см. статью [Теги служб в локальной среде](../virtual-network/service-tags-overview.md). IP-адреса пакетной службы будут связаны с тегом службы `BatchNodeManagement` (или региональным вариантом, который соответствует региону учетной записи пакетной службы).

### <a name="honoring-dns"></a>Учет DNS

Убедитесь, что ваши системы учитывают срок жизни (TTL) DNS для URL-адреса учетной записи пакетной службы. Кроме того, убедитесь, что клиенты пакетной службы и другие механизмы подключения к пакетной службе не полагаются на IP-адреса (или [Создайте пул со статическими общедоступными IP-адресами](create-pool-public-ip.md) , как описано ниже).

Если запросы получают HTTP-ответы уровня 5xx и в ответе есть заголовок Connection: close, клиент пакетной службы должен следовать рекомендациям, закрыв существующее подключение, повторно выполнив разрешение имен DNS для URL-адреса учетной записи пакетной службы и попытавшись выполнить следующие запросы на новом соединении.

### <a name="retry-requests-automatically"></a>Повторные запросы автоматически

Убедитесь, что клиенты пакетной службы имеют соответствующие политики повтора, чтобы автоматически повторять запросы, даже во время нормальной работы, а не только во время периодов обслуживания службы. Эти политики повтора должны охватывать интервал не менее 5 минут. Возможности автоматического повтора попыток предоставляются с помощью различных пакетов SDK пакетной службы, таких как [класс .NET RetryPolicyProvider](/dotnet/api/microsoft.azure.batch.retrypolicyprovider).

### <a name="static-public-ip-addresses"></a>Статические общедоступные IP-адреса

Как правило, доступ к виртуальным машинам в пуле пакетной службы осуществляется через общедоступные IP-адреса, которые могут измениться в течение всего времени существования пула. Это может усложнить взаимодействие с базой данных или другой внешней службой, которая ограничивает доступ к определенным IP-адресам. Чтобы обеспечить непредвиденное изменение общедоступных IP-адресов в пуле, можно создать пул с помощью набора статических общедоступных IP-адресов, которыми вы управляете. Дополнительные сведения см. в статье [Создание пула пакетной службы Azure с указанными общедоступными IP-адресами](create-pool-public-ip.md).

### <a name="testing-connectivity-with-cloud-services-configuration"></a>Проверка подключения с помощью конфигурации облачных служб

Нельзя использовать стандартный протокол "ping"/ИКМП для облачных служб, так как протокол ICMP не разрешен в подсистеме балансировки нагрузки Azure. Дополнительные сведения см. в статье [подключение и сеть для облачных служб Azure](../cloud-services/cloud-services-connectivity-and-networking-faq.md#can-i-ping-a-cloud-service).

## <a name="batch-node-underlying-dependencies"></a>Базовые зависимости узла пакетной службы

При проектировании решений пакетной службы учитывайте следующие зависимости и ограничения.

### <a name="system-created-resources"></a>Ресурсы, созданные системой

Пакетная служба Azure создает набор пользователей и групп на виртуальной машине, который не следует изменять, и управляет этим набором. Вот они:

Windows:

- Пользователь с именем **PoolNonAdmin**.
- Группа пользователей с именем **WATaskCommon**.

Linux:

- Пользователь с именем **_azbatch**.

### <a name="file-cleanup"></a>Очистка файлов

Пакетная служба активно пытается очищать рабочий каталог, в котором выполняются задачи, по истечении срока их хранения. Ответственность за очистку диска от всех файлов, записанных за пределами этого каталога во избежание заполнения дискового пространства, [лежит на вас](#manage-task-lifetime).

Автоматическая очистка рабочего каталога будет заблокирована при запуске службы в Windows из рабочего каталога startTask, так как при этом папка будет продолжать использоваться. Это приведет к снижению производительности. Чтобы исправить это, замените каталог этой службы на отдельный каталог, не управляемый пакетной службой.

## <a name="next-steps"></a>Дальнейшие действия

- Узнайте подробнее о [рабочем процессе и основных ресурсах пакетной службы](batch-service-workflow-features.md), таких как пулы, узлы, задания и задачи.
- Сведения о [квотах, ограничениях и ограничениях пакетной службы Azure по умолчанию, а так же о том, как запросить увеличение квоты](batch-quota-limit.md).
- Узнайте, как [обнаруживать и предотвращать сбои в фоновых операциях пула и узла ](batch-pool-node-error-checking.md).
