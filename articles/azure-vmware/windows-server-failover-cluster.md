---
title: Отказоустойчивый кластер Windows Server в решении VMware для Azure vSAN с собственными общими дисками
description: Настройте отказоустойчивый кластер Windows Server (WSFC) в решении VMware для Azure и воспользуйтесь преимуществами решений, которые требуют возможности WSFC.
ms.topic: how-to
ms.date: 03/09/2021
ms.openlocfilehash: d667eef00fcad0e3f5243c6ab580e2e8371c6793
ms.sourcegitcommit: 956dec4650e551bdede45d96507c95ecd7a01ec9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/09/2021
ms.locfileid: "102518999"
---
# <a name="windows-server-failover-cluster-on-azure-vmware-solution-vsan-with-native-shared-disks"></a>Отказоустойчивый кластер Windows Server в решении VMware для Azure vSAN с собственными общими дисками

В этой статье мы рассмотрим настройку отказоустойчивого кластера Windows Server в решении VMware для Azure. Реализация в этой статье предназначена для подтверждения концепции и пилотных целей. Рекомендуется использовать конфигурацию "кластер в виде" (ЦИБ), пока не будут доступны политики размещения.

Отказоустойчивый кластер Windows Server (WSFC), ранее известный как служба Microsoft Service Cluster Service (MSCS), является компонентом операционной системы Windows Server (ОС). WSFC является важнейшим для бизнеса компонентом, и для многих приложений требуется. Например, WSFC требуется для следующих конфигураций:

- SQL Server настроен как:
  - Always On экземпляр отказоустойчивого кластера (FCI) для обеспечения высокого уровня доступности на уровне экземпляра.
  - Группа доступности Always On для обеспечения высокой доступности уровня базы данных.
- Файловые службы Windows:
  - Общий файловый ресурс, выполняющийся на активном узле кластера.
  - Scale-Out файловый сервер (SOFS), в котором хранятся файлы в общих томах кластера (CSV).
  - Локальные дисковые пространства (S2D); локальные диски, используемые для создания пулов носителей на разных узлах кластера.

Кластер WSFC можно разместить в различных экземплярах решения Azure VMware, называемых Cluster-in-Box (CAB). Кластер WSFC можно также разместить на одном узле решения Azure VMware. Эта конфигурация называется "кластер в виде" (ЦИБ). Мы не рекомендуем использовать ЦИБ решение для реализации в рабочей среде. Был ли один узел решения Azure VMware неудачен, все узлы кластера WSFC будут отключены, и приложение будет испытывать время простоя. Для решения VMware Azure требуется как минимум три узла в кластере частного облака.

Важно развернуть поддерживаемую конфигурацию WSFC. Вы хотите, чтобы ваше решение поддерживалось в vSphere и с помощью решения VMware для Azure. VMware предоставляет подробный документ о WSFC в vSphere 6,7, [программу установки для отказоустойчивой кластеризации и службу кластеров Майкрософт](https://docs.vmware.com/en/VMware-vSphere/6.7/vsphere-esxi-vcenter-server-67-setup-mscs.pdf).

Эта статья посвящена WSFC в Windows Server 2016 и Windows Server 2019. Более старые версии Windows Server не имеют [основной поддержки](https://support.microsoft.com/lifecycle/search?alpha=windows%20server) , поэтому мы не будем их рассматривать.

Сначала необходимо [создать кластер WSFC](https://docs.microsoft.com/windows-server/failover-clustering/create-failover-cluster). Дополнительные сведения о кластере WSFC см. [в разделе отказоустойчивая кластеризация в Windows Server](https://docs.microsoft.com/windows-server/failover-clustering/failover-clustering-overview). Используйте сведения, приведенные в этой статье, для конкретных особенностей развертывания WSFC в решении Azure VMware.

## <a name="prerequisites"></a>Предварительные условия

- Среда решения Azure VMware
- Установочный носитель Microsoft Windows Server

## <a name="reference-architecture"></a>Эталонная архитектура

Решение Azure VMware обеспечивает собственную поддержку виртуализованных кластеров WSFC. Он поддерживает постоянные резервирования SCSI-3 (SCSI3PR) на уровне виртуального диска. Эта поддержка необходима кластеру WSFC для арбитража доступа к общему диску между узлами. Поддержка SCSI3PRs позволяет настроить WSFC с ресурсом диска, совместно используемым виртуальными машинами в хранилищах данных vSAN.

На следующей схеме показана архитектура виртуальных узлов WSFC в частном облаке решения Azure VMware. Здесь показано, где находится решение Azure VMware, включая виртуальные серверы WSFC (красный прямоугольник), относительно более широкой платформы Azure. На этой схеме показана типичная архитектура концентратора, но аналогичная настройка возможна при использовании виртуальной глобальной сети Azure. Оба предложения предлагают все преимущества, которые могут принести другие службы Azure.

[![Схема, демонстрирующая архитектуру виртуальных узлов WSFC в частном облаке решения Azure VMware.](media/windows-server-failover-cluster/windows-server-failover-architecture.png)](media/windows-server-failover-cluster/windows-server-failover-architecture.png#lightbox)

## <a name="supported-configurations"></a>Поддерживаемые конфигурации

В настоящее время поддерживаются следующие конфигурации:

- Microsoft Windows Server 2012 или более поздней версии.
- До пяти узлов отказоустойчивой кластеризации на один кластер.
- До четырех адаптеров PVSCSI на виртуальную машину.
- До 64 дисков на адаптер PVSCSI.

## <a name="virtual-machine-configuration-requirements"></a>Требования к конфигурации виртуальной машины

### <a name="wsfc-node-configuration-parameters"></a>Параметры конфигурации узла WSFC

- Установите новейшие средства VMware на каждом узле WSFC.
- Смешивание общих дисков без общего доступа на одном виртуальном SCSI-адаптере не поддерживается. Например, если системный диск (диск C:) присоединен к SCSI0:0, первый общий диск будет присоединен к SCSI1:0. Узел виртуальной машины кластера WSFC имеет тот же максимум виртуальных SCSI-контроллеров, что и обычная виртуальная машина — до четырех (4) виртуальных контроллеров SCSI.
- Идентификаторы SCSI виртуальных дисков должны быть согласованы между всеми виртуальными машинами, на которых размещены узлы одного кластера WSFC.

| **Компонент** | **Requirements** |
| --- | --- |
| Версия оборудования виртуальной машины | 11 или выше для поддержки динамического vMotion. |
| Виртуальный сетевой адаптер | VMXNET3 виртуализированный сетевой интерфейсный адаптер (NIC); Включите в виртуальном сетевом адаптере функцию масштабирования на стороне приема для гостевых систем Windows (RSS). |
| Память | Используйте полную память резервирования виртуальных машин для узлов в кластере WSFC. |
| Увеличьте время ожидания ввода-вывода для каждого узла WSFC. | Измените \_ значение hKey Local \_ мачине\систем\куррентконтролсет\сервицес\диск\тимеаутвалуесет на 60 секунд или более. (При повторном создании кластера это значение может быть восстановлено по умолчанию, поэтому его необходимо изменить.) |
| Мониторинг работоспособности кластера Windows | Значение параметра Самесубнетсрешолд мониторинга работоспособности кластера Windows должно быть изменено, чтобы разрешить не менее 10 пропущенных пакетов пульса. Это значение [по умолчанию в Windows Server 2016](https://techcommunity.microsoft.com/t5/failover-clustering/tuning-failover-cluster-network-thresholds/ba-p/371834). Эта рекомендация относится ко всем приложениям, использующим WSFC, в том числе к общим и не общим дискам. |

### <a name="wsfc-node---boot-disks-configuration-parameters"></a>Узел WSFC — параметры конфигурации загрузочных дисков


| **Компонент** | **Requirements** |
| --- | --- |
| Тип контроллера SCSI | SAS LSI Logic |
| Режим диска | Виртуальная |
| Совместное использование шины SCSI | Нет |
| Измените дополнительные параметры виртуального контроллера SCSI, на котором размещено загрузочное устройство. | Добавьте следующие дополнительные параметры в каждый узел WSFC:<br /> Сксикс. Ретурнноконнектдурингапд = "TRUE"<br />Сксикс. Ретурнбусйонноконнектстатус = "FALSE"<br />Где X — это ИДЕНТИФИКАЦИОНный номер контроллера шины SCSI устройства загрузки. По умолчанию для параметра X задано значение 0. |

### <a name="wsfc-node---shared-disks-configuration-parameters"></a>Узлы WSFC — параметры конфигурации общих дисков


| **Компонент** | **Requirements** |
| --- | --- |
| Тип контроллера SCSI | Виртуализация VMware (PVSCSI) |
| Режим диска | Независимый — постоянный (шаг 2 на рисунке ниже). Используя этот параметр, вы гарантируете, что все диски будут исключены из моментальных снимков. Моментальные снимки не поддерживаются для виртуальных машин на основе WSFC. |
| Совместное использование шины SCSI | Физический (шаг 1 на рисунке ниже) |
| Флаг множественного записи | Не используется |
| Формат диска | Плотная подготовка. (В vSAN не требуется безотлагательно-плотная (ЕЗТ).) |

:::image type="content" source="media/windows-server-failover-cluster/edit-settings-virtual-hardware.png" alt-text="Снимок экрана, показывающий страницу &quot;изменение параметров&quot; для виртуального оборудования.":::

## <a name="non-supported-scenarios"></a>Неподдерживаемые сценарии

Следующие функции не поддерживаются для кластеров WSFC в Azure VMware:

- Хранилища данных NFS
- Дисковые пространства
- vSAN с использованием службы iSCSI
- Растянутый кластер vSAN
- Улучшенная совместимость с vMotion (EVC)
- Отказоустойчивость vSphere (FT)
- Моментальные снимки
- Динамическое хранилище (в сети) (vMotion)
- N — виртуализация ИДЕНТИФИКАТОРов портов (NPIV)

При неактивном изменении оборудования виртуальной машины может нарушиться период пульса между узлами WSFC.

Следующие действия не поддерживаются и могут привести к отработке отказа узла WSFC:

- Оперативное добавление памяти
- Горячая установка ЦП
- Использование моментальных снимков
- Увеличение размера общего диска
- Приостановка и возобновление состояния виртуальной машины
- Переход от ESXi к памяти или выноски памяти виртуальной машины
- Горячий расширение локального VMDK-файла, даже если он не связан с контроллером общего доступа к шине SCSI

## <a name="configure-wsfc-with-shared-disks-on-azure-vmware-solution-vsan"></a>Настройка кластера WSFC с общими дисками в vSAN решения Azure VMware

1. Убедитесь, что среда Active Directory доступна.
2. Создайте виртуальные машины (ВМ) в хранилище данных vSAN.
3. Включите питание на всех виртуальных машинах, настройте имя узла, IP-адреса, присоедините все виртуальные машины к домену Active Directory и установите последние доступные обновления ОС.
4. Установите новейшие средства VMware.
5. Включите и настройте компонент отказоустойчивого кластера Windows Server на каждой виртуальной машине.
6. Настройте следящий сервер кластера для кворума (файловый ресурс-свидетель прекрасно работает).
7. Выключите все узлы кластера WSFC.
8. Добавьте один или несколько виртуальных SCSI-контроллеров (до четырех) в каждую часть виртуальной машины WSFC. Используйте параметры в соответствии со всеми предыдущими абзацами.
9. На первом узле кластера добавьте все необходимые общие диски с помощью команды **Добавить новый**  >  **жесткий диск** устройства. Общий доступ к диску должен быть не **указан** (по умолчанию), а режим диска **— как независимый — постоянный**. Подключите его к контроллерам, созданным на предыдущих шагах.
10. Продолжайте работу с оставшимися узлами WSFC. Добавьте диски, созданные на предыдущем шаге, выбрав **Добавить новое устройство**  >  **существующий жесткий диск**. Не забудьте сохранить один и тот же идентификатор диска SCSI на всех узлах WSFC.
11. Включите первый узел WSFC; Войдите в систему и откройте консоль управления дисками (MMC). Убедитесь, что добавленные общие диски могут управляться операционной системой и инициализированы. Отформатируйте диски и назначьте букву диска.
12. Включите другие узлы WSFC.
13. Добавьте диск в кластер WSFC с помощью **мастера добавления дисков** и добавьте их в общий том кластера.
14. Протестируйте отработку отказа с помощью **мастера перемещения диска** и убедитесь, что кластер WSFC с общими дисками работает правильно.
15. Запустите **Мастер проверки кластера** , чтобы убедиться, что кластер и его узлы работают правильно.

    Важно учитывать следующие элементы в проверочном тесте кластера:

       - **Проверка постоянного резервирования дисковых пространств**. Если вы не используете дисковые пространства в кластере (например, в Azure VMware vSAN), этот тест неприменим. Вы можете игнорировать любые результаты проверки постоянного резервирования, включая это предупреждение. Чтобы избежать предупреждений, можно исключить этот тест.
        
      - **Проверьте сетевое взаимодействие**. При проверке кластера будет выдано предупреждение о том, что доступен только один сетевой интерфейс на узел кластера. Это предупреждение можно игнорировать. Решение VMware для Azure обеспечивает необходимую доступность и производительность, так как узлы подключены к одному из сегментов НСКС-T. Тем не менее, не заключайте этот элемент в тест проверки кластера, так как он проверяет другие аспекты сетевого взаимодействия.

16. Создайте правило DRS для размещения виртуальных машин WSFC на тех же узлах решения Azure VMware. Для этого требуется правило сходства "узел — Виртуальная машина". Таким образом узлы кластера будут работать на одном узле решения Azure VMware. Опять же, это предназначено для пилотных целей, пока не будут доступны политики размещения.

    >[!NOTE]
    > Для этого вам нужно создать запрос в службу поддержки. Ваша организация поддержки Azure сможет помочь вам в этом.

## <a name="related-information"></a>Дополнительные сведения

- [Отказоустойчивая кластеризация в Windows Server](https://docs.microsoft.com/windows-server/failover-clustering/failover-clustering-overview)
- [Рекомендации по кластеризации Майкрософт в vSphere (1037959) (vmware.com)](https://kb.vmware.com/s/article/1037959)
- [Сведения о настройке отказоустойчивой кластеризации и службы кластеров Майкрософт (vmware.com)](https://docs.vmware.com/en/VMware-vSphere/6.7/com.vmware.vsphere.mscs.doc/GUID-1A2476C0-CA66-4B80-B6F9-8421B6983808.html)
- [vSAN 6,7 U3-WSFC с общими дисками &amp; SCSI-3 постоянные резервирования (VMware.com)](https://blogs.vmware.com/virtualblocks/2019/08/23/vsan67-u3-wsfc-shared-disksupport/)
- [Ограничения решения Azure VMware](../azure-resource-manager/management/azure-subscription-service-limits.md#azure-vmware-solution-limits)

## <a name="next-steps"></a>Дальнейшие действия

Теперь, когда вы настроили кластер WSFC в решении Azure VMware, вам может потребоваться изучить следующее:

- Настройка нового кластера WSFC путем добавления дополнительных приложений, требующих возможности WSFC. Например, SQL Server и SAP ASCS.
- Настройка решения для резервного копирования.
  - [Настройка Azure Backup Server для решения Azure VMware](https://docs.microsoft.com/azure/azure-vmware/set-up-backup-server-for-azure-vmware-solution)
  - [Решения резервного копирования для виртуальных машин Azure VMware](https://docs.microsoft.com/azure/azure-vmware/ecosystem-back-up-vms)
