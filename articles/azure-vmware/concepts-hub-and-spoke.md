---
title: Концепция. Интеграция развертывания решения Azure VMware в центральную и периферийную архитектуру
description: Узнайте, как интегрировать развертывание решения Azure VMware в центральную и лучевую архитектуру в Azure.
ms.topic: conceptual
ms.date: 10/26/2020
ms.openlocfilehash: bfc442e569572349b1323500fbd0b2f912ebbc62
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "99062751"
---
# <a name="integrate-azure-vmware-solution-in-a-hub-and-spoke-architecture"></a>Интеграция решения Azure VMware в центральную и периферийную архитектуру

В этой статье приводятся рекомендации по интеграции развертывания решения Azure VMware в существующую или новую [центральную и лучевую архитектуру](/azure/architecture/reference-architectures/hybrid-networking/#hub-spoke-network-topology) в Azure. 


В сценарии "звезда" и "звезда" предполагается Гибридная облачная среда с рабочими нагрузками:

* Собственные Azure с использованием служб IaaS или PaaS
* Решение Azure VMware 
* vSphere в локальной среде

## <a name="architecture"></a>Архитектура

*Центр* — это виртуальная сеть Azure, которая выступает в качестве центральной точки подключения к локальному и частному облаку решения Azure VMware. *Периферийные серверы* — это виртуальные сети, подключенные к концентратору для обеспечения взаимодействия между виртуальными сетями.

Трафик между локальным центром обработки данных, частным облаком решения Azure VMware и концентратором проходит через подключения Azure ExpressRoute. Резервные виртуальные сети обычно содержат рабочие нагрузки на основе IaaS, но могут иметь службы PaaS, такие как [Среда службы приложений](../app-service/environment/intro.md), которые имеют прямую интеграцию с виртуальной сетью или другие службы PaaS с включенной [частной связью Azure](../private-link/index.yml) .

>[!IMPORTANT]
>Для подключения к Решению Azure VMware можно использовать существующий шлюз ExpressRoute, если он не превышает ограничение в четыре канала ExpressRoute на виртуальную сеть.  Но для доступа к Решению Azure VMware из локальной среды через ExpressRoute требуется служба ExpressRoute Global Reach, так как шлюз ExpressRoute не обеспечивает транзитивную маршрутизацию между подключенными каналами.

На схеме показан пример развертывания на основе концентратора и периферийного сервера в Azure, подключенного к локальной среде и решению VMware для Azure с помощью ExpressRoute Global Reach.

:::image type="content" source="./media/hub-spoke/azure-vmware-solution-hub-and-spoke-deployment.png" alt-text="Развертывание в центре решений Azure VMware и в периферийном развертывании" border="false" lightbox="./media/hub-spoke/azure-vmware-solution-hub-and-spoke-deployment.png":::

Архитектура имеет следующие основные компоненты:

- **Локальный сайт:** Локальные центры данных клиента, подключенные к Azure через подключение ExpressRoute.

- **Частное облако решения VMware для Azure:** Решение Azure VMware в SDDC, сформированное одним или несколькими кластерами vSphere, каждый из которых имеет максимум 16 узлов.

- **Шлюз ExpressRoute:** Обеспечивает взаимодействие между частным облаком решения Azure VMware, общими службами в Центральной виртуальной сети и рабочими нагрузками, работающими в периферийных виртуальных сетях.

- **Global REACH ExpressRoute:** Обеспечивает подключение между локальной средой и частным облаком решения VMware для Azure. Подключение между решением Azure VMware и структурой Azure осуществляется только с помощью ExpressRoute Global Reach. Нельзя выбрать любой параметр, кроме быстрого пути ExpressRoute.  Функция ExpressRoute Direct не поддерживается.


- **Рекомендации по VPN-подключениям S2S:** Для рабочих развертываний Azure VMware в рабочей среде VPN-подключение Azure S2S не поддерживается из-за требований к сети для VMware ХККС. Однако его можно использовать для развертывания подтверждения концепции.


- **Виртуальная сеть концентратора:** Действует как Центральная точка подключения к локальной сети и частное облако решения VMware для Azure.

- **Периферийная виртуальная сеть**

    - **Резервная звезда IaaS:** В узле IaaS хранятся рабочие нагрузки на основе Azure IaaS, в том числе группы доступности виртуальных машин и масштабируемые наборы виртуальной машины, а также соответствующие сетевые компоненты.

    - **PaaS, сектор:** Платформа PaaS размещает службы PaaS Azure с использованием частной адресации благодаря [закрытой конечной точке](../private-link/private-endpoint-overview.md) и [частной ссылке](../private-link/private-link-overview.md).

- **Брандмауэр Azure:** Выступает в качестве центральной части для сегментирования трафика между периферийными серверами и решениями Azure VMware.

- **Шлюз приложений:** Предоставляет и защищает веб-приложения, которые выполняются в Azure IaaS, PaaS или виртуальных машинах Azure VMware (ВМ). Она интегрируется с другими службами, такими как управление API.

## <a name="network-and-security-considerations"></a>Вопросы, касающиеся сети и безопасности

Подключения ExpressRoute позволяют передавать трафик между локальной средой, решением VMware Azure и структурой сети Azure. Для реализации этого подключения в решении Azure VMware используется [Global REACH ExpressRoute](../expressroute/expressroute-global-reach.md) .

Так как шлюз ExpressRoute не обеспечивает транзитную маршрутизацию между подключенными цепями, локальное подключение также должно использовать ExpressRoute Global Reach для обмена данными между локальной средой vSphere и решением VMware Azure. 

* **Поток трафика решения "из локальной среды в Azure VMware"**

  :::image type="content" source="./media/hub-spoke/on-premises-azure-vmware-solution-traffic-flow.png" alt-text="Поток трафика решения &quot;из локальной среды в Azure VMware&quot;" border="false" lightbox="./media/hub-spoke/on-premises-azure-vmware-solution-traffic-flow.png":::


* **Поток трафика виртуальной сети Azure VMware к концентратору**

  :::image type="content" source="./media/hub-spoke/azure-vmware-solution-hub-vnet-traffic-flow.png" alt-text="Поток трафика виртуальной сети Azure VMware к концентратору" border="false" lightbox="./media/hub-spoke/azure-vmware-solution-hub-vnet-traffic-flow.png":::


Дополнительные сведения о сетях и концепциях подключения для решения VMware в Azure см. в [документации по продукту VMware для Azure](./concepts-networking.md).

### <a name="traffic-segmentation"></a>Сегментация трафика

[Брандмауэр Azure](../firewall/index.yml) — Центральная часть топологии концентратора и звезды, развернутая в виртуальной сети концентратора. Используйте брандмауэр Azure или другой поддерживаемый сетевой виртуальный модуль Azure, чтобы установить правила трафика и сегментировать обмен данными между разными периферийными и рабочими нагрузками решения Azure VMware.

Создайте таблицы маршрутов для направления трафика в брандмауэр Azure.  Для периферийных виртуальных сетей создайте маршрут, который задает маршрут по умолчанию для внутреннего интерфейса брандмауэра Azure. Таким образом, когда рабочей нагрузке в виртуальной сети необходимо достичь адресного пространства решения Azure VMware, брандмауэр может оценить его и применить соответствующее правило трафика, чтобы разрешить или отклонить его.  

:::image type="content" source="media/hub-spoke/create-route-table-to-direct-traffic.png" alt-text="Создание таблиц маршрутов для направления трафика в брандмауэр Azure" lightbox="media/hub-spoke/create-route-table-to-direct-traffic.png":::


> [!IMPORTANT]
> Маршрут с префиксом адреса 0.0.0.0/0 для параметра **GatewaySubnet** не поддерживается.

Задайте маршруты для конкретных сетей в соответствующей таблице маршрутов. Например, маршруты позволяют получить префиксы IP-адресов для управления решениями и рабочих нагрузок Azure VMware на периферийных рабочих нагрузках и наоборот.

:::image type="content" source="media/hub-spoke/specify-gateway-subnet-for-route-table.png" alt-text="Установка маршрутов для конкретных сетей в соответствующей таблице маршрутов" lightbox="media/hub-spoke/specify-gateway-subnet-for-route-table.png":::

Второй уровень сегментации трафика с помощью групп безопасности сети в периферийных зонах и концентратора для создания более детализированной политики трафика.

> [!NOTE]
> **Трафик из локальной среды в решение VMware для Azure:** Трафик между локальными рабочими нагрузками, vSphere или другими, включается Global Reach, но трафик не проходит через брандмауэр Azure на концентраторе. В этом сценарии необходимо реализовать механизмы сегментации трафика, как локально, так и в решении Azure VMware.

### <a name="application-gateway"></a>Шлюз приложений

Шлюзы приложений Azure версии v1 и v2 были протестированы с веб-приложениями, которые работают на виртуальных машинах Azure VMware в качестве серверного пула. Шлюз приложений в настоящее время является единственным поддерживаемым методом предоставления веб-приложений, выполняющихся на виртуальных машинах Azure VMware в Интернете. Он также может безопасно предоставлять приложения внутренним пользователям.

Дополнительные сведения см. в статье о решении Azure VMware в разделе [шлюз приложений](./protect-azure-vmware-solution-with-application-gateway.md).

:::image type="content" source="media/hub-spoke/azure-vmware-solution-second-level-traffic-segmentation.png" alt-text="Второй уровень сегментации трафика с помощью групп безопасности сети" border="false":::


### <a name="jump-box-and-azure-bastion"></a>Поле перехода и Azure бастиона

Доступ к среде решения Azure VMware с помощью поля перехода, которое представляет собой виртуальную машину Windows 10 или Windows Server, развернутую в подсети общей службы в виртуальной сети концентратора.

>[!IMPORTANT]
>Azure бастиона — это служба, рекомендуемая для подключения к полю перехода, чтобы предотвратить предоставление доступа к решению VMware для Azure через Интернет. Вы не можете использовать Azure бастиона для подключения к виртуальным машинам Azure VMware, так как они не являются объектами Azure IaaS.  

В целях безопасности рекомендуется развертывать [Microsoft Azure службу бастиона](../bastion/index.yml) в виртуальной сети Hub. Azure бастиона обеспечивает простой доступ по протоколу RDP и SSH к виртуальным машинам, развернутым в Azure, без необходимости подготавливать общедоступные IP-адреса к этим ресурсам. После подготовки службы бастиона Azure вы сможете получить доступ к выбранной виртуальной машине из портал Azure. После установления подключения откроется новая вкладка, в которой отображается окно переходов Рабочий стол, а с этого рабочего стола — доступ к плоскости управления частного облака решения VMware для Azure.

> [!IMPORTANT]
> Не предоставляйте общедоступный IP-адрес виртуальной машине с полем перехода или предоставляйте доступ через Интернет к порту 3389/TCP. 


:::image type="content" source="media/hub-spoke/azure-bastion-hub-vnet.png" alt-text="Виртуальная сеть центра бастиона Azure" border="false":::


## <a name="azure-dns-resolution-considerations"></a>Рекомендации по разрешению Azure DNS

Для Azure DNS разрешения можно использовать два варианта:

-   Используйте контроллеры домена, развернутые в концентраторе (см. [рекомендации по удостоверению](#identity-considerations)), в качестве серверов имен.

-   Развертывание и настройка частной зоны Azure DNS.

Наилучший подход состоит в том, чтобы обеспечить надежное разрешение имен для решения Azure VMware, локальной среды и Azure.

В качестве общей рекомендации по проектированию используйте существующую инфраструктуру Azure DNS (в нашем примере это Active Directory интегрированной службы DNS), развернутую по крайней мере на двух виртуальных машинах Azure, развернутых в виртуальной сети концентратора и настроенных в периферийных виртуальных сетях, чтобы использовать эти Azure DNS серверы в параметрах DNS.

Вы можете использовать Частная зона DNS Azure, где зона Частная зона DNS Azure ссылается на виртуальную сеть.  DNS-серверы используются в качестве гибридных арбитров конфликтов с условным перенаправлением в локальную среду или решение Azure VMware с использованием DNS-инфраструктуры клиента Azure Частная зона DNS. 

Чтобы автоматически управлять жизненным циклом записей DNS для виртуальных машин, развернутых в периферийных виртуальных сетях, включите автоматическую регистрацию. Если этот параметр включен, максимальное число частных зон DNS равно одному. Если этот параметр отключен, то максимальное число равно 1000.

Локальные и серверы решений VMware Azure можно настроить с помощью условных серверов пересылки для виртуальных машин сопоставителя в Azure для зоны Частная зона DNS Azure.

## <a name="identity-considerations"></a>Вопросы относительно удостоверений

В целях идентификации лучшим подходом является развертывание по крайней мере одного контроллера домена в концентраторе. Используйте две подсети общих служб в распределенной зоне или группе доступности виртуальных машин. Дополнительные сведения о расширении локального домена Active Directory (AD) в Azure см. в разделе [центр архитектуры Azure](/azure/architecture/reference-architectures/identity/adds-extend-domain).

Кроме того, разверните другой контроллер домена на стороне решения VMware Azure, чтобы он работал в качестве удостоверения и источника DNS в среде vSphere.

Рекомендуется интегрировать [домен AD с Azure Active Directory](/azure/architecture/reference-architectures/identity/azure-ad)в качестве рекомендуемых рекомендаций.

<!-- LINKS - external -->
[Azure Architecture Center]: /azure/architecture/

[Hub & Spoke topology]: /azure/architecture/reference-architectures/hybrid-networking/hub-spoke

[Azure networking documentation]: ../networking/index.yml

<!-- LINKS - internal -->
