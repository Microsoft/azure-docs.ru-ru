---
title: Управление исходящим IP-адресом Функций Azure с помощью шлюза NAT виртуальной сети Azure
description: Пошаговое руководство, в котором показано, как настроить NAT для функции, подключенной к виртуальной сети Azure.
ms.topic: tutorial
ms.author: kyburns
ms.date: 2/26/2021
ms.openlocfilehash: 5bb491e367ed813f09197a193745c231261c88c7
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "104658244"
---
# <a name="tutorial-control-azure-functions-outbound-ip-with-an-azure-virtual-network-nat-gateway"></a>Учебник. Управление исходящим IP-адресом Функций Azure с помощью шлюза NAT виртуальной сети Azure

Преобразование сетевых адресов виртуальной сети (NAT) упрощает возможность исходящего интернет-подключения для виртуальных сетей. При настройке NAT в подсети все исходящие подключения используют указанные статические общедоступные IP-адреса. NAT может быть полезен для Функций Azure или веб-приложений, которым необходимо использовать стороннюю службу, которая применяет список разрешенных IP-адресов в качестве меры безопасности. Дополнительные сведения см. в статье [Что такое NAT виртуальной сети?](../virtual-network/nat-overview.md).

В этом учебнике показано, как использовать NAT виртуальной сети для маршрутизации исходящего трафика от функции, активируемой по протоколу HTTP. Эта функция позволяет проверить свой исходящий IP-адрес. В рамках учебника вы выполните следующие действия:

> [!div class="checklist"]
> * Создание виртуальной сети
> * Создание приложения-функции в плане "Премиум".
> * Создание общедоступного IP-адреса
> * Создание шлюза NAT.
> * Настройка приложения-функции для маршрутизации исходящего трафика через шлюз NAT.

## <a name="topology"></a>Топология

На следующей схеме показана архитектура создаваемого решения.

![Интерфейс для интеграции шлюза NAT](./media/functions-how-to-use-nat-gateway/topology.png)

Функции, выполняемые в плане "Премиум", имеют те же возможности размещения, что и веб-приложения в Службе приложений Azure, включая функцию интеграции с виртуальной сетью. Дополнительные сведения об интеграции виртуальной сети, включая устранение неполадок и расширенную конфигурацию, см. в статье [Интеграция приложения с виртуальной сетью Azure](../app-service/web-sites-integrate-with-vnet.md).

## <a name="prerequisites"></a>Предварительные требования

Для работы с этим руководством важно понимать принципы назначения IP-адресов и определения подсети. Вы можете начать с [этой статьи, в которой изложены основы назначения адресов и определения подсети](https://support.microsoft.com/help/164015/understanding-tcp-ip-addressing-and-subnetting-basics). В Интернете доступно множество других статей и видеоматериалов по этой теме.

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

Если вы выполнили инструкции из учебника по [интеграции Функций с виртуальной сетью Azure](./functions-create-vnet.md), можно перейти к разделу [Создание функции триггера HTTP](#create-function).

## <a name="create-a-virtual-network"></a>Создание виртуальной сети

1. В меню портала Azure выберите **Создать ресурс**. В Azure Marketplace выберите **Сети** > **Виртуальная сеть**.

1. В окне **Создание виртуальной сети** введите или выберите параметры, указанные в следующей таблице:

    | Параметр | Значение |
    | ------- | ----- |
    | Подписка | Выберите свою подписку.|
    | Группа ресурсов | Выберите **Создать**, а затем введите *myResourceGroup* и нажмите кнопку **ОК**. |
    | Имя | Введите *myResourceGroup-vnet* |
    | Расположение | Выберите **Восточная часть США**.|

1. Выберите **Далее: IP-адреса** и для параметра **Диапазон IPv4-адресов** введите *10.10.0.0/16*.

1. Выберите **Добавление подсети**, а затем введите *Tutorial-Net* для **имени подсети** и *10.10.1.0/24* для параметра **Диапазон адресов подсети**.

    ![Вкладка "IP-адреса" для создания виртуальной сети](./media/functions-how-to-use-nat-gateway/create-vnet-2-ip-space.png)

1. Выберите **Добавить**, а затем выберите **Проверить и создать**. Оставьте без изменений значения остальных параметров и выберите **Создать**.

1. В разделе **Создание виртуальной сети** нажмите **Создать**.

Затем создайте приложение-функцию в [плане "Премиум"](functions-premium-plan.md). Этот план обеспечивает бессерверное масштабирование при поддержке интеграции с виртуальной сетью.

## <a name="create-a-function-app-in-a-premium-plan"></a>Создание приложения-функции в плане "Премиум"

> [!NOTE]  
> Для оптимальной работы с этим учебником выберите .NET в качестве стека времени выполнения и Windows в качестве операционной системы. Кроме того, создайте приложение-функцию в регионе виртуальной сети.

[!INCLUDE [functions-premium-create](../../includes/functions-premium-create.md)]  

## <a name="connect-your-function-app-to-the-virtual-network"></a>Подключение приложения-функции к виртуальной сети

Теперь можно подключить приложение-функцию к виртуальной сети.

1. В приложении-функции в меню слева выберите **Сетевые подключения**, а затем в разделе **Интеграция виртуальной сети** выберите **Щелкните здесь для настройки**.

    :::image type="content" source="./media/functions-how-to-use-nat-gateway/networking-0.png" alt-text="Выбор сети в приложении-функции":::

1. На странице **Интеграция виртуальной сети** выберите **Добавить виртуальную сеть**.

1. В разделе **Состояние компонента сети** задайте параметры, указанные в таблице под изображением.

    ![Определение виртуальной сети приложения-функции](./media/functions-how-to-use-nat-gateway/networking-3.png)

    | Параметр      | Рекомендуемое значение  | Описание      |
    | ------------ | ---------------- | ---------------- |
    | **Виртуальная сеть** | MyResourceGroup-vnet | Это созданная ранее виртуальная сеть. |
    | **Подсеть** | Создание подсети | Создайте подсеть в виртуальной сети для использования приложением-функцией. Интеграцию виртуальной сети необходимо настроить для использования пустой подсети. |
    | **Имя подсети** | Function-Net | Имя новой подсети. |
    | **Блок адресов виртуальной сети** | 10.10.0.0/16 | Необходимо определить лишь один блок адресов. |
    | **блок адресов подсети;** | 10.10.2.0/24   | Размер подсети позволяет ограничивать общее число экземпляров, на которые может масштабироваться приложение-функция плана "Премиум". В этом примере используется подсеть `/24` с 254 доступными адресами узлов. Эта подсеть не подготовлена, но ее легко вычислить. |

1. Щелкните **OK**, чтобы добавить подсеть. Закройте страницы **Интеграция виртуальной сети** и **Состояние компонентов сети**, чтобы вернуться на страницу приложения-функции.

Теперь приложение-функция может получить доступ к виртуальной сети. Затем добавьте функцию, активируемую по протоколу HTTP, в приложение-функцию.

## <a name="create-an-http-trigger-function"></a><a name="create-function"></a>Создание функции, активируемой HTTP

1. В меню слева в окне **Функции** выберите **Функции**, а затем в верхнем меню выберите **Добавить**. 
 
1. В окне **Новая функция** выберите элемент **Триггер HTTP**, а для пункта **Новая функция** оставьте имя по умолчанию или введите новое имя. 

1. В разделе **Code + Test** (Код + тестирование) замените созданный шаблоном код C# (CSX) следующим кодом: 

    ```csharp
    #r "Newtonsoft.Json"
    
    using System.Net;
    using Microsoft.AspNetCore.Mvc;
    using Microsoft.Extensions.Primitives;
    using Newtonsoft.Json;
    
    public static async Task<IActionResult> Run(HttpRequest req, ILogger log)
    {
        log.LogInformation("C# HTTP trigger function processed a request.");
    
        var client = new HttpClient();
        var response = await client.GetAsync(@"https://ifconfig.me");
        var responseMessage = await response.Content.ReadAsStringAsync();
    
        return new OkObjectResult(responseMessage);
    }
    ```

    Этот код вызывает внешний веб-сайт, который возвращает IP-адрес вызывающего объекта, который в данном случае является этой функцией. Этот метод позволяет легко определить исходящий IP-адрес, используемый приложением-функцией.

Теперь все готово для запуска функции и проверки текущих исходящих IP-адресов.

## <a name="verify-current-outbound-ips"></a>Проверка текущих исходящих IP-адресов

Теперь можно запустить функцию. Но сначала перейдите на портал и посмотрите, какие исходящие IP-адреса используются приложением-функцией.  

1. В приложении-функции выберите **Свойства** и просмотрите поле **Исходящие IP-адреса**.

    ![Просмотр IP-адресов для исходящего трафика приложения-функции](./media/functions-how-to-use-nat-gateway/function-properties-ip.png)

1. Теперь вернитесь к функции триггера HTTP, выберите **Code + Test** (Код + тестирование), а затем — **Test/Run** (Тестировать/выполнить).

    ![Тестирование функции](./media/functions-how-to-use-nat-gateway/function-code-test.png)

1. Щелкните **Выполнить**, чтобы выполнить функцию, а затем переключитесь на вкладку **Выходные данные**. 

    ![Выходные данные функции тестирования](./media/functions-how-to-use-nat-gateway/function-test-1-output.png)

1. Убедитесь, что IP-адрес в тексте ответа HTTP является одним из значений исходящих IP-адресов, которые вы просматривали ранее.

Теперь можно создать общедоступный IP-адрес и использовать шлюз NAT для изменения этого исходящего IP-адреса.

## <a name="create-public-ip"></a>Создание общедоступного IP-адреса

1. В группе ресурсов щелкните **Добавить**, перейдите в раздел **Общедоступный IP-адрес** в Azure Marketplace и нажмите кнопку **Создать**. Затем используйте настройки из таблицы под изображением.

    ![Создание общедоступного IP-адреса](./media/functions-how-to-use-nat-gateway/create-public-ip.png)

    | Параметр      | Рекомендуемое значение  |
    | ------------ | ---------------- |
    | **Версия IP-адреса** | IPv4 |
    | **SKU** | Standard |
    | **Уровень** | Региональный |
    | **имя**; | Outbound-IP |
    | **Подписка** | Убедитесь, что отображается ваша подписка | 
    | **Группа ресурсов** | myResourceGroup (или имя, назначенное группе ресурсов) |
    | **Расположение** | Восточная часть США (или расположение, назначенное другим ресурсам) |
    | **Availability Zone** (Зона доступности) | Нет зоны |

1. Нажмите кнопку **Создать**, чтобы начать развертывание.

1. После завершения развертывания перейдите к созданному ресурсу общедоступного IP-адреса и просмотрите IP-адрес на вкладке **Обзор**.

    ![Просмотр общедоступного IP-адреса](./media/functions-how-to-use-nat-gateway/public-ip-overview.png)

## <a name="create-nat-gateway"></a>Создание шлюза NAT

Теперь давайте создадим шлюз NAT. При работе с предыдущим руководством по работе с [виртуальными сетями](functions-create-vnet.md) было предложено имя подсети `Function-Net`, а`MyResourceGroup-vnet` — в качестве имени виртуальной сети в этом руководстве.

1. В группе ресурсов щелкните **Добавить**, перейдите к разделу **шлюз NAT** в Azure Marketplace и нажмите кнопку **Создать**. Затем используйте параметры из таблицы под изображением, чтобы заполнить вкладку **Основные**.

    ![Создание шлюза NAT](./media/functions-how-to-use-nat-gateway/create-nat-1-basics.png)

    | Параметр      | Рекомендуемое значение  |
    | ------------ | ---------------- |  
    | **Подписка** | Ваша подписка | 
    | **Группа ресурсов** | myResourceGroup (или имя, назначенное группе ресурсов) |
    | **Имя шлюза NAT** | myNATgateway |
    | **Регион** | Восточная часть США (или расположение, назначенное другим ресурсам) |
    | **Availability Zone** (Зона доступности) | Нет |

1. Выберите **Далее: Исходящий IP-адрес** внизу страницы. В поле **Общедоступные IP-адреса** выберите ранее созданный общедоступный IP-адрес. Не выбирайте **префиксы общедоступных IP-адресов**.

1. Выберите **Далее: Подсеть**. Выберите ресурс *myResourceGroup-vnet* в поле **Виртуальная сеть** и подсеть *Function-NET*.

    ![Выбор подсети](./media/functions-how-to-use-nat-gateway/create-nat-3-subnet.png)

1. Выберите **Просмотр и создание**, а затем нажмите кнопку **Создать** для завершения развертывания.

После завершения развертывания шлюз NAT будет готов маршрутизировать трафик из подсети приложения-функции в Интернет.

## <a name="update-function-configuration"></a>Обновление конфигурации функции

Теперь добавьте параметр приложения `WEBSITE_VNET_ROUTE_ALL`, для которого задайте значение `1`.  При использовании этого параметра исходящий трафик направляется через виртуальную сеть и связанный с ним шлюз NAT. Без этого параметра интернет-трафик не будет направляться через интегрированную виртуальную сеть, и вы увидите одни и те же исходящие IP-адреса. 

1. Перейдите к приложению-функции на портале Azure и выберите пункт **Конфигурация** в меню слева.

1. В разделе **Параметры приложения** выберите **+ Новый параметр приложения** и заполните поля, используя следующие значения:

    |Имя поля  |Значение |
    |---|---|
    |**имя**;    |WEBSITE_VNET_ROUTE_ALL|
    |**Значение**   |1|

1. Нажмите кнопку **ОК**, чтобы закрыть диалоговое окно новых параметров приложения.

1. Нажмите кнопку **Сохранить**, а затем выберите **Продолжить**, чтобы применить параметры.

Теперь приложение-функция настроено для маршрутизации трафика через связанную с ним виртуальную сеть.

## <a name="verify-new-outbound-ips"></a>Проверка новых исходящих IP-адресов

Повторите [действия, описанные выше](#verify-current-outbound-ips), чтобы снова запустить функцию. Теперь в выходных данных функции отобразится исходящий IP-адрес, настроенный в NAT.

## <a name="clean-up-resources"></a>Очистка ресурсов

Выполняя описанные в этом учебнике действия, вы создавали ресурсы. За них вам могут быть выставлены счета в зависимости от [состояния учетной записи](https://azure.microsoft.com/account/) и [цен на службы](https://azure.microsoft.com/pricing/). Чтобы избежать лишних затрат, удалите ресурсы, если они больше не нужны. 

[!INCLUDE [functions-quickstart-cleanup-inner](../../includes/functions-quickstart-cleanup-inner.md)]

## <a name="next-steps"></a>Дальнейшие действия

> [!div class="nextstepaction"]
> [Параметры сети для Функций Azure](functions-networking-options.md)
