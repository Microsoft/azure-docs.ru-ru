---
title: Защита Функций Azure
description: Узнайте, как улучшить защиту кода функций, выполняемых в Azure, от распространенных атак.
ms.date: 4/13/2020
ms.topic: conceptual
ms.openlocfilehash: 351bdca7ff94b6c058b5ab62fd9c16d707e7dc78
ms.sourcegitcommit: d4734bc680ea221ea80fdea67859d6d32241aefc
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/14/2021
ms.locfileid: "100368495"
---
# <a name="securing-azure-functions"></a>Защита Функций Azure

Планирование безопасной разработки, развертывания и работы бессерверных функций во многом выполняется практически так же, как и для размещенных облачных и веб-приложений. [Служба приложений Azure](../app-service/index.yml) предоставляет инфраструктуру размещения для приложений-функций. В этой статье приводятся стратегии обеспечения безопасности для выполнения кода функций и сведения о том, как Служба приложений может помочь в их защите. 

[!INCLUDE [app-service-security-intro](../../includes/app-service-security-intro.md)]

Набор рекомендаций по безопасности, составленных на основе данных об [эталоне безопасности Azure](../security/benchmarks/overview.md), см. в статье [Базовый план обеспечения безопасности Azure для Функций Azure](security-baseline.md).

## <a name="secure-operation"></a>Безопасная работа 

В этом разделе рассказывается о том, как максимально безопасно настроить и запустить приложение-функцию. 

### <a name="security-center"></a>Центр безопасности

Центр безопасности интегрируется с приложением-функцией на портале. Он бесплатно предоставляет быструю оценку возможных уязвимостей в конфигурации. За отдельную плату для приложений-функций, выполняющихся в выделенном плане, можно также использовать возможности защиты Центра безопасности в режиме реального времени. Дополнительные сведения см. в статье [Защита веб-приложений и API Службы приложений Azure](../security-center/defender-for-app-service-introduction.md). 

### <a name="log-and-monitor"></a>Ведение журнала и мониторинг

Одним из способов обнаружения атак является действие мониторинг действий и анализ ведения журналов. Функции интегрируются с Application Insights для сбора данных журнала, а также сведений о производительности и ошибках для приложения-функции. Application Insights автоматически обнаруживает аномалии в производительности и содержит мощные аналитические средства, которые помогают диагностировать проблемы и анализировать использование функций. Дополнительные сведения см. в статье [Мониторинг Функций Azure](functions-monitoring.md).

Функции также интегрируются с журналами Azure Monitor, что позволяет консолидировать журналы приложений-функций с системными событиями для упрощения анализа. С помощью параметров диагностики можно настроить для ваших функций потоковый экспорт журналов и метрик платформы в выбранное место назначения, например в рабочую область Logs Analytics. Дополнительные сведения см. в статье [Мониторинг Функций Azure с помощью журналов Azure Monitor](functions-monitor-log-analytics.md). 

Для обнаружения угроз и автоматизации реагирования на уровне предприятия можно выполнить потоковую передачу журналов и событий в рабочую область Logs Analytics. Затем к этой рабочей области можно подключить Azure Sentinel. Дополнительные сведения см. в статье [Что собой представляет Azure Sentinel](../sentinel/overview.md).  

Дополнительные рекомендации по безопасности, связанные с обеспечением наблюдаемости, см. в статье [Базовый план безопасности Azure для Функций Azure](security-baseline.md#logging-and-monitoring). 

### <a name="require-https"></a>Требование использовать HTTPS

По умолчанию клиенты могут подключаться к конечным точкам функции по протоколу HTTP или HTTPS. Запросы HTTP необходимо перенаправлять на HTTPs, так как HTTPS использует протокол SSL/TLS для обеспечения безопасного подключения, которое в этом случае шифруется и требует прохождения проверки подлинности. Сведения о том, как это сделать, см. в разделе [Принудительное использование HTTPS](../app-service/configure-ssl-bindings.md#enforce-https).

Если протокол HTTPS обязателен, необходимо также требовать, чтобы использовалась последняя версия TLS. Сведения о том, как это сделать, см. в разделе [Принудительное применение версий TLS](../app-service/configure-ssl-bindings.md#enforce-tls-versions).

Дополнительные сведения см. в разделе о [безопасных подключениях (TSL)](../app-service/overview-security.md#https-and-certificates).

### <a name="function-access-keys"></a>Ключи доступа к функции

[!INCLUDE [functions-authorization-keys](../../includes/functions-authorization-keys.md)]

#### <a name="system-key"></a>Системные ключи 

Для доступа к конечным точкам веб-перехватчика для определенных расширений может потребоваться управляемый системой ключ. Системные ключи предназначены для конечных точек функций определенных расширений, которые вызываются внутренними компонентами. Например, для [триггера Сетки событий](functions-bindings-event-grid-trigger.md) требуется, чтобы при вызове его конечной точки в подписке использовался системный ключ. Устойчивые Функции также используют системные ключи для вызова [API-интерфейсов расширений устойчивых задач](durable/durable-functions-http-api.md). 

Область системных ключей определяется расширением, но обычно применяется ко всему приложению-функции. Системные ключи могут создаваться только конкретными расширениями, и вы не можете явно задавать их значения. Как и в случае с другими ключами, новое значение такого ключа можно создать на портале или с помощью API-интерфейсов ключей.

#### <a name="keys-comparison"></a>Сравнение ключей

В следующей таблице сравниваются варианты использования различных типов ключей доступа.

| Действие                                        | Область                    | Допустимые ключи         |
|-----------------------------------------------|--------------------------|--------------------|
| Выполнение функции                            | Конкретная функция        | Компонент           |
| Выполнение функции                            | Любая функция             | Функция или узел   |
| Вызов конечной точки администрирования                        | Приложение-функция             | Узел (только основной) |
| Вызов API-интерфейсов расширений устойчивых задач              | Приложение-функция<sup>1</sup> | Система<sup>2</sup> |
| Вызов веб-перехватчика для конкретного расширения (внутренний) | Приложение-функция<sup>1</sup> | Система<sup>2</sup> |

<sup>1</sup>Область определяется расширением.  
<sup>2</sup>Конкретные имена задаются расширением.

Дополнительные сведения о ключах доступа см. в статье о [привязке триггера HTTP](functions-bindings-http-webhook-trigger.md#obtaining-keys).


#### <a name="secret-repositories"></a>Секретные репозитории

По умолчанию ключи хранятся в контейнере хранилища BLOB-объектов в учетной записи, предоставляемой `AzureWebJobsStorage` параметром. Вы можете использовать определенные параметры приложения, чтобы переопределить это поведение и сохранить ключи в другом расположении.

|Расположение  |Параметр | Значение | Описание  |
|---------|---------|---------|---------|
|Другая учетная запись хранения     |  `AzureWebJobsSecretStorageSas`       | `<BLOB_SAS_URL` | Сохраняет ключи в хранилище BLOB-объектов второй учетной записи хранения на основе предоставленного URL-адреса SAS. Ключи шифруются перед сохранением с использованием секрета, уникального для приложения-функции. |
|Файловая система   | `AzureWebJobsSecretStorageType`   |  `files`       | Ключи сохраняются в файловой системе, зашифрованные перед хранилищем, с использованием секрета, уникального для вашего приложения-функции. |
|Azure Key Vault  | `AzureWebJobsSecretStorageType`<br/>`AzureWebJobsSecretStorageKeyVaultName` | `keyvault`<br/>`<VAULT_NAME>` | Хранилище должно иметь политику доступа, соответствующую управляемому системой удостоверению ресурса размещения. Политика доступа должна предоставить удостоверению следующие разрешения секрета: `Get` , `Set` , `List` и `Delete` . <br/>При локальном запуске используется удостоверение разработчика, а параметры должны находиться в [local.settings.jsв файле](functions-run-local.md#local-settings-file). | 
|Секреты Kubernetes  |`AzureWebJobsSecretStorageType`<br/>Среда `AzureWebJobsKubernetesSecretName` (необязательно) | `kubernetes`<br/>`<SECRETS_RESOURCE>` | Поддерживается только при выполнении среды выполнения функций в Kubernetes. Если `AzureWebJobsKubernetesSecretName` параметр не установлен, репозиторий считается доступен только для чтения. В этом случае перед развертыванием необходимо создать значения. Azure Functions Core Tools автоматически создает значения при развертывании в Kubernetes.|

### <a name="authenticationauthorization"></a>Проверка подлинности и авторизация

Хотя ключи функций могут в определенной мере ограничить нежелательный доступ, единственный способ обеспечить полноценную защиту конечных точек функций — реализовать положительную проверку подлинности клиентов, у которых есть доступ к этим функциям. После этого решения об авторизации можно принимать на основе удостоверения.  

[!INCLUDE [functions-enable-auth](../../includes/functions-enable-auth.md)]

### <a name="permissions"></a>Разрешения

Как и в случае любого другого приложения или службы, приложение-функцию следует по возможности запускать с минимальными разрешениями. 

#### <a name="user-management-permissions"></a>Разрешения на управление пользователями

Функции поддерживают встроенные возможности [управления доступом на основе ролей в Azure (Azure RBAC)](../role-based-access-control/overview.md). Роли Azure, поддерживаемые функциями, — это [участник](../role-based-access-control/built-in-roles.md#contributor), [владелец](../role-based-access-control/built-in-roles.md#owner)и [читатель](../role-based-access-control/built-in-roles.md#owner). 

Разрешения действуют на уровне приложения-функции. Для выполнения большинства задач на уровне приложения необходима роль участника. Удалить приложение-функцию можно только с ролью владельца. 

#### <a name="organize-functions-by-privilege"></a>Упорядочивание функций по привилегиям 

Строки подключения и другие учетные данные, хранящиеся в параметрах приложения, предоставляют всем функциям в приложении-функции одинаковый набор разрешений в связанном ресурсе. Рекомендуется свести к минимуму количество функций с доступом к определенным учетным данным, переместив те из них, которые не используют такие учетные данные, в отдельное приложение-функцию. Для передачи данных между функциями в различных приложениях-функциях всегда можно использовать такие методы, как [связывание функций](/learn/modules/chain-azure-functions-data-using-bindings/).  

#### <a name="managed-identities"></a>Управляемые удостоверения

[!INCLUDE [app-service-managed-identities](../../includes/app-service-managed-identities.md)]

Управляемые удостоверения можно использовать вместо секретов для подключений из некоторых триггеров и привязок. См. раздел [подключения на основе удостоверений](#identity-based-connections).

Дополнительные сведения см. в статье [Использование управляемых удостоверений в Службе приложений и Функциях Azure](../app-service/overview-managed-identity.md?toc=%2fazure%2fazure-functions%2ftoc.json).

#### <a name="restrict-cors-access"></a>Ограничение доступа CORS

[Общий доступ к ресурсам независимо от источника (CORS)](https://en.wikipedia.org/wiki/Cross-origin_resource_sharing) позволяет разрешить веб-приложениям, запущенным в другом домене, отправлять запросы конечным точкам вашего триггера HTTP. Служба приложений предоставляет встроенную поддержку передачи требуемых заголовков CORS в HTTP-запросах. Правила CORS определяются на уровне приложения-функции.  

Несмотря на все удобство использования подстановочных знаков, которые позволяют всем сайтам получать доступ к конечной точке, такой подход сводит на нет преимущества технологии CORS, цель которой — предотвратить атаки с использованием межсайтовых сценариев. Вместо этого добавьте отдельную запись CORS для домена каждого веб-приложения, у которого должен быть доступ к конечной точке. 

### <a name="managing-secrets"></a>управление секретами; 

Чтобы иметь возможность подключаться к различным службам и ресурсам, необходимым для выполнения кода, приложениям-функциям требуется доступ к секретам, например строкам подключения и ключам служб. В этом разделе описывается хранение необходимых для функций секретов.

Никогда не храните секреты в коде функции. 

#### <a name="application-settings"></a>Параметры приложения

По умолчанию строки подключения и секреты, используемые приложением-функцией и привязками, хранятся в виде параметров приложения. Это делает такие учетные данные доступными как для кода функции, так и для различных привязок, которые она использует. Для получения фактического значения, которое является секретом, используется имя параметра приложения (ключа). 

Например, для каждого приложения-функции требуется связанная учетная запись хранения, которая используется средой выполнения. По умолчанию данные о подключении к этой учетной записи хранения хранятся в параметре приложения с именем `AzureWebJobsStorage`.

Параметры приложения и строки подключения хранятся в зашифрованном виде в Azure. Они расшифровываются только перед внедрением в память процесса приложения при запуске приложения. Ключи шифрования регулярно меняются. Если вы предпочитаете организовать безопасное хранение секретов, параметр приложения вместо этого должен ссылаться на Azure Key Vault. 

Можно также зашифровать параметры по умолчанию в local.settings.jsв файле при разработке функций на локальном компьютере. Дополнительные сведения см. в описании `IsEncrypted` свойства в [файле локальных параметров](functions-run-local.md#local-settings-file).  

#### <a name="key-vault-references"></a>Ссылки на Key Vault

Хотя параметров приложения достаточно для большинства функций, иногда одни и те же секреты требуется совместно использовать в нескольких службах. В этом случае избыточное хранение секретов приводит к появлению дополнительных потенциальных уязвимостей. Более безопасный подход — использовать централизованную службу хранения секретов и ссылаться на нее, а не на сами секреты.      

Служба [Azure Key Vault](../key-vault/general/overview.md) обеспечивает централизованное управление секретами и полный контроль над политиками доступа и журналами аудита. Ссылку на Key Vault можно использовать вместо строки подключения или ключа в параметрах приложения. Дополнительные сведения см. в статье [Использование ссылок на Key Vault в Службе приложений и Функциях Azure](../app-service/app-service-key-vault-references.md?toc=%2fazure%2fazure-functions%2ftoc.json).

### <a name="identity-based-connections"></a>Подключения на основе удостоверений

Удостоверения могут использоваться вместо секретов для подключения к некоторым ресурсам. Это имеет преимущество не требует управления секретом и обеспечивает более детализированное управление доступом и аудит. 

При написании кода, который создает подключение к [службам Azure, поддерживающим проверку подлинности Azure AD](../active-directory/managed-identities-azure-resources/services-support-managed-identities.md#azure-services-that-support-azure-ad-authentication), можно использовать удостоверение вместо секрета или строки подключения. Сведения о обоих методах подключения описаны в документации по каждой службе.

Некоторые расширения триггеров и привязок функций Azure можно настроить с помощью подключения на основе удостоверений. В настоящее время сюда входят расширения [больших двоичных объектов Azure](./functions-bindings-storage-blob.md) и [очередей Azure](./functions-bindings-storage-queue.md) . Сведения о том, как настроить эти расширения для использования удостоверения, см. [в статье Использование подключений на основе удостоверений в функциях Azure](./functions-reference.md#configure-an-identity-based-connection).

### <a name="set-usage-quotas"></a>Настройка квот на использование

Рекомендуем установить квоты на использование для функций, выполняемых в плане потребления. Если установить суточное ограничение на объем данных за единицу времени (ГБ/с) для выполнения всех функций в целом в приложении-функции, выполнение останавливается по достижении предельного значения. Это потенциально может помочь предотвратить выполнение функций вредоносным кодом. Сведения о том, как оценить потребление функций, см. в статье [Оценка затрат на план потребления](functions-consumption-costs.md). 

### <a name="data-validation"></a>Проверка данных

Триггеры и привязки, используемые вашими функциями, не предоставляют дополнительную проверку данных. Код должен проверять любые данные, полученные от триггера или входной привязки. На случай компрометации вышестоящей службы следует позаботиться о том, чтобы через функцию не проходили непроверенные входящие данные. Например, если функция хранит данные из очереди службы хранилища Azure в реляционной базе данных, необходимо проверить данные и параметризовать команды, чтобы избежать атак путем внедрения кода SQL. 

Не следует рассчитывать на то, что данные, поступающие в функцию, уже проверены или очищены. Кроме того, рекомендуется проверять допустимость данных, записываемых в выходные привязки. 

### <a name="handle-errors"></a>Обработка ошибок

Хотя это и очевидно, не лишним будет напомнить о важности хорошей обработки ошибок в функциях. Необработанные ошибки всплывают на узле и обрабатываются средой выполнения. Различные привязки выполняют обработку ошибок по-разному. Дополнительные сведения см. в статье [Обработка ошибок в решении "Функции Azure"](functions-bindings-error-pages.md).

### <a name="disable-remote-debugging"></a>Отключение удаленной отладки

Убедитесь, что удаленная отладка отключена все время, за исключением периода активной отладки функций. Вы можете отключить удаленную отладку на портале в разделе **Конфигурация** приложения-функции на вкладке **Общие параметры**. 

### <a name="restrict-cors-access"></a>Ограничение доступа CORS

[!INCLUDE [functions-cors](../../includes/functions-cors.md)]

Не используйте подстановочные знаки в списке разрешенных источников. Вместо этого следует перечислить конкретные домены, из которых предполагается получать запросы.

### <a name="store-data-encrypted"></a>Хранение данных в зашифрованном виде

[!INCLUDE [functions-storage-encryption](../../includes/functions-storage-encryption.md)]

## <a name="secure-deployment"></a>Безопасное развертывание

С помощью набора средств решения "Функции Azure" можно легко опубликовать код проекта локальной функции в Azure. При учете вопросов безопасности в топологии Функций Azure важно понимать, как работает развертывание.   

### <a name="deployment-credentials"></a>Учетные данные развертывания

Для развертываний Службы приложений требуется набор учетных данных развертывания. Эти учетные данные развертывания используются для защиты развертываний приложения-функции. Учетными данными развертывания управляет платформа Службы приложений. Когда они неактивны, то хранятся в зашифрованном виде. 

Существует два вида учетных данных развертывания.

[!INCLUDE [app-service-deploy-credentials](../../includes/app-service-deploy-credentials.md)]

В настоящее время Key Vault не поддерживается для учетных данных развертывания. Дополнительные сведения об управлении учетными данными развертывания см. в статье [Настройка учетных данных развертывания Службы приложений Azure](../app-service/deploy-configure-credentials.md).

### <a name="disable-ftp"></a>Отключение FTP

По умолчанию для каждого приложения-функции включена конечная точка FTP. Доступ к конечной точке FTP осуществляется с помощью учетных данных развертывания. 

При этом использовать FTP для развертывания кода функции не рекомендуется. Развертывания через FTP выполняются вручную, и для них требуется синхронизация триггеров. Дополнительные сведения см. в разделе о [развертывании по FTP](functions-deployment-technologies.md#ftp). 

Если вы не планируете использовать протокол FTP, следует отключить его на портале. Если вы решите использовать FTP, следует [принудительно применять FTPS](../app-service/deploy-ftp.md#enforce-ftps).

### <a name="secure-the-scm-endpoint"></a>Защита конечной точки scm

У каждого приложения-функции есть соответствующая конечная точка службы `scm`, которая используется в службе дополнительных инструментов (Kudu) для развертываний и других [расширений сайта](https://github.com/projectkudu/kudu/wiki/Azure-Site-Extensions) Службы приложений. Конечная точка scm для приложения-функции всегда является URL-адресом в форме `https://<FUNCTION_APP_NAME.scm.azurewebsites.net>`. При использовании сетевой изоляции для защиты функций необходимо также учитывать эту конечную точку. 

Используя отдельную конечную точку scm, вы можете управлять развертываниями и другими функциями дополнительных инструментов для приложения-функции, которые изолированы или запущены в виртуальной сети. Конечная точка scm поддерживает как обычную проверку подлинности (с использованием учетных данных развертывания), так и единый вход с использованием учетных данных портала Azure. Дополнительные сведения см. в статье о [доступе к службе Kudu](https://github.com/projectkudu/kudu/wiki/Accessing-the-kudu-service). 

### <a name="continuous-security-validation"></a>Непрерывная проверка безопасности

Поскольку вопросы безопасности должны учитываться на каждом этапе процесса разработки, имеет смысл также реализовать проверки безопасности в среде непрерывного развертывания. Иногда этот способ называется DevSecOps. Использование Azure DevOps для конвейера развертывания позволяет интегрировать проверку в процесс развертывания. Дополнительные сведения см. в статье о том, [как добавить непрерывную проверку безопасности в конвейер CI/CD](/azure/devops/migrate/security-validation-cicd-pipeline).  

## <a name="network-security"></a>Безопасность сети

Ограничение сетевого доступа к приложению-функции позволяет контролировать доступ пользователей к конечным точкам функций. Решение "Функции" использует инфраструктуру Службы приложений, чтобы предоставить функциям доступ к ресурсам без использования адресов, маршрутизируемых через Интернет, или ограничения доступа через Интернет к конечной точке функции. Дополнительные сведения об этих сетевых параметрах см. в статье [Параметры сети для Функций Azure](functions-networking-options.md).

### <a name="set-access-restrictions"></a>Настройка ограничений доступа

Ограничения доступа позволяют определять списки правил разрешения и запрета для управления трафиком приложения. Правила применяются в порядке приоритета. Если правила не определены, приложение будет принимать трафик с любого адреса. Дополнительные сведения см. в статье [Ограничения доступа для Службы приложений Azure](../app-service/app-service-ip-restrictions.md?toc=%2fazure%2fazure-functions%2ftoc.json).

### <a name="private-site-access"></a>доступ к частным сайтам;

[!INCLUDE [functions-private-site-access](../../includes/functions-private-site-access.md)]

### <a name="deploy-your-function-app-in-isolation"></a>Развертывание приложения-функции в изолированной среде

[!INCLUDE [functions-deploy-isolation](../../includes/functions-deploy-isolation.md)]

### <a name="use-a-gateway-service"></a>Использование службы шлюза

Службы шлюза, например [Шлюз приложений Azure](../application-gateway/overview.md) и [Azure Front Door,](../frontdoor/front-door-overview.md) позволяют настроить брандмауэр веб-приложения (WAF). Правила WAF используются для отслеживания или блокирования обнаруженных атак, что обеспечивает дополнительный уровень защиты функций. Чтобы настроить WAF, приложение-функция должно выполняться в ASE или использовать частные конечные точки (предварительная версия). Дополнительные сведения см. в статье [Использование частных конечных точек](../app-service/networking/private-endpoint.md).    

## <a name="next-steps"></a>Дальнейшие действия

+ [Реализация базового плана безопасности Azure для Функций Azure](security-baseline.md)
+ [Диагностика Функций Azure](functions-diagnostics.md)
