---
title: Создание первой устойчивой функции в службе "Функции Azure" с помощью PowerShell
description: Создание и публикация устойчивой функции в службе "Функции Azure" с помощью PowerShell, используя Visual Studio Code.
author: anthonychu
ms.topic: quickstart
ms.date: 08/10/2020
ms.reviewer: azfuncdf, antchu
ms.openlocfilehash: edd02085abe63b124082255247362f096248ba82
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "91317265"
---
# <a name="create-your-first-durable-function-in-powershell"></a>Создание устойчивой функции в PowerShell

*Устойчивые функции* — это расширение [Функций Azure](../functions-overview.md), которое позволяет писать функции с отслеживанием состояния в беcсерверной среде. Расширение автоматически управляет состоянием, создает контрольные точки и перезагружается.

В этой статье описано, как использовать расширение Функций Azure в Visual Studio Code, чтобы локально создать и тестировать устойчивую функцию hello world.  Эта функция будет организовывать и объединять в цепочку вызовы других функций. Затем вы опубликуете код функции в Azure.

![Выполнение устойчивых функций в Azure](./media/quickstart-js-vscode/functions-vs-code-complete.png)

## <a name="prerequisites"></a>Предварительные требования

Для работы с этим руководством сделайте следующее:

* Установите [Visual Studio Code](https://code.visualstudio.com/download).

* Установите расширение [Функции Azure](https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-azurefunctions) для VS Code.

* Убедитесь, что используется последняя версия [Azure Functions Core Tools](../functions-run-local.md).

* Для работы Устойчивых функций требуется учетная запись хранения Azure. Вам понадобится подписка Azure.

[!INCLUDE [quickstarts-free-trial-note](../../../includes/quickstarts-free-trial-note.md)]

## <a name="create-your-local-project"></a><a name="create-an-azure-functions-project"></a>Создание локального проекта 

В этом разделе вы используете Visual Studio Code. чтобы создать локальный проект Функций Azure. 

1. В Visual Studio Code нажмите клавишу F1 (или Ctrl/Cmd+Shift+P), чтобы открыть палитру команд. В палитре команд найдите и щелкните `Azure Functions: Create New Project...`.

    ![Создание функции](media/quickstart-js-vscode/functions-create-project.png)

1. Выберите расположение пустой папки для проекта и нажмите кнопку **Выбрать**.

1. Следуя инструкциям, введите следующие сведения:

    | prompt | Значение | Описание |
    | ------ | ----- | ----------- |
    | Select a language for your function app project (Выберите язык для проекта приложения-функции) | PowerShell | Создание локального проекта службы "Функции" в PowerShell. |
    | Выбор версии | Функции Azure версии 3 | Этот параметр отображается, только если вы еще не установили Core Tools. В этом случае Core Tools устанавливается при первом запуске приложения. |
    | Select a template for your project's first function (Выберите шаблон для первой функции вашего проекта) | Пропустить | |
    | Select how you would like to open your project (Выберите, как вы хотели бы открыть свой проект) | Открыть в текущем окне | Повторно открывает VS Code в выбранной папке. |

При необходимости Visual Studio Code устанавливает Azure Functions Core Tools. Кроме того, создается проект приложения-функции в папке. Проект будет содержать файлы конфигурации [host.json](../functions-host-json.md) и [local.settings.json](../functions-run-local.md#local-settings-file).

В корневой папке также создается файл package.json.

### <a name="configure-function-app-to-use-powershell-7"></a>Настройка приложения функции для использования PowerShell 7

Откройте файл *local.settings.json* и убедитесь, что для параметра с именем `FUNCTIONS_WORKER_RUNTIME_VERSION` задано значение `~7`. Если он отсутствует или отличается, обновите содержимое файла.

```json
{
  "IsEncrypted": false,
  "Values": {
    "AzureWebJobsStorage": "",
    "FUNCTIONS_WORKER_RUNTIME": "powershell",
    "FUNCTIONS_WORKER_RUNTIME_VERSION" : "~7"
  }
}
```

## <a name="create-your-functions"></a>Создание функций

В самом простом приложении Устойчивых функций есть три функции:

* *функция оркестратора* — описывает рабочий процесс и координирует другие функции;
* *функция действия* — вызывается функцией оркестратора, выполняет работу и при необходимости возвращает значение;
* *функция клиента* — обычная функция Azure, которая запускает функцию оркестратора. В этом примере используется функция, активируемая по HTTP.

### <a name="orchestrator-function"></a>Функция оркестратора

Для создания кода устойчивой функции в проекте используется шаблон.

1. В палитре команд найдите и щелкните `Azure Functions: Create Function...`.

1. Следуя инструкциям, введите следующие сведения:

    | prompt | Значение | Описание |
    | ------ | ----- | ----------- |
    | Выбор шаблона для функции | Оркестратор устойчивых функций (предварительная версия) | Создание оркестрации Устойчивых функций |
    | Provide a function name (Укажите имя функции) | HelloOrchestrator | Имя устойчивой функции |

Итак, вы добавили оркестратор для координации функций действия. Откройте файл *HelloOrchestrator/run.ps1*, чтобы ознакомиться с функцией оркестратора. Каждый вызов командлета `Invoke-ActivityFunction` приводит к вызову функции действия с именем `Hello`.

Теперь нужно добавить функцию действия `Hello`, на которую ведет эта ссылка.

### <a name="activity-function"></a>Функция действия

1. В палитре команд найдите и щелкните `Azure Functions: Create Function...`.

1. Следуя инструкциям, введите следующие сведения:

    | prompt | Значение | Описание |
    | ------ | ----- | ----------- |
    | Выбор шаблона для функции | Действие Устойчивых функций (предварительная версия) | Создание функции действия |
    | Provide a function name (Укажите имя функции) | Привет | Имя функции действия |

Теперь вы добавили функцию действия `Hello`, которая вызывается оркестратором. Откройте файл *Hello/run.ps1* и убедитесь, что эта функция принимает имя в качестве входных данных и возвращает приветствие. Функция действия отвечает за все реальные действия, включая обращение к базе данных и выполнение вычислений.

Наконец, нужно добавить активируемую вызовом HTTP функцию, которая запускает оркестратор.

### <a name="client-function-http-starter"></a>Функция клиента (начальный объект HTTP)

1. В палитре команд найдите и щелкните `Azure Functions: Create Function...`.

1. Следуя инструкциям, введите следующие сведения:

    | prompt | Значение | Описание |
    | ------ | ----- | ----------- |
    | Выбор шаблона для функции | Начальный объект HTTP Устойчивых функций (предварительная версия) | Создание функции начального объекта HTTP |
    | Provide a function name (Укажите имя функции) | HttpStart | Имя функции действия |
    | Уровень авторизации | Анонимные | Для примера разрешите вызывать функцию без проверки подлинности. |

Итак, вы добавили активируемую вызовом HTTP функцию, которая запускает оркестратор. Откройте *HttpStart/run.ps1* и убедитесь, что для запуска новой операции оркестрации в нем используется командлет `Start-NewOrchestration`. Затем он использует командлет `New-OrchestrationCheckStatusResponse`, чтобы вернуть ответ HTTP с URL-адресами, которые позволяют отслеживать новую оркестрацию и управлять ею.

Теперь у вас есть готовое приложение Устойчивых функций, которое можно выполнить локально и развернуть в Azure.

## <a name="test-the-function-locally"></a>Локальное тестирование функции

Основные инструменты службы "Функции Azure" позволяют запускать проекты функций Azure на локальном компьютере разработчика. Вам будет предложено установить эти инструменты при первом запуске приложения-функции из Visual Studio Code.

1. Чтобы протестировать созданную функцию, установите точку останова в коде функции действия `Hello` (файл *Hello/run.ps1*). Нажмите клавишу F5 или выберите действие `Debug: Start Debugging` на палитре команд, чтобы запустить проект приложения-функции. Выходные данные основных инструментов отображаются на панели **Terminal** (Терминал).

    > [!NOTE]
    > См. сведения об отладке в руководстве по [диагностике Устойчивых функций](durable-functions-diagnostics.md#debugging).

1. Для выполнения Устойчивых функций требуется учетная запись хранения Azure. Когда VS Code предложит выбрать учетную запись хранения, щелкните **Выбрать учетную запись хранения**.

    ![Создание учетной записи хранения](media/quickstart-js-vscode/functions-select-storage.png)

1. Следуя инструкциям, укажите следующие сведения, чтобы создать новую учетную запись хранения в Azure.

    | prompt | Значение | Описание |
    | ------ | ----- | ----------- |
    | Выбор подписки | *имя вашей подписки* | Выбор подписки Azure |
    | Выбор учетной записи хранения | Создание новой учетной записи хранения |  |
    | Ввод имени новой учетной записи хранения | *уникальное имя* | Имя учетной записи хранения для создания |
    | Выбор группы ресурсов | *уникальное имя* | Имя создаваемой группы ресурсов |
    | Выберите расположение | *region* | Выбор ближайшего региона |

1. На панели **Terminal** (Терминал) скопируйте URL-адрес конечной точки функции, активируемой HTTP-запросом.

    ![Локальные выходные данные в Azure](media/quickstart-js-vscode/functions-f5.png)

1. Отправьте запрос HTTP POST к конечной точке URL-адреса, используя браузер или средства наподобие [Postman](https://www.getpostman.com/) или [cURL](https://curl.haxx.se/). Последний сегмент замените именем функции оркестратора (`HelloOrchestrator` в нашем примере). URL-адрес должен выглядеть приблизительно так: `http://localhost:7071/api/orchestrators/HelloOrchestrator`.

   Полученный ответ является начальным результатом функции HTTP, который сообщает об успешном начале работы устойчивой оркестрации. Он еще не конечный результат оркестрации. Ответ включает несколько полезных URL-адреса. Теперь запросите состояние оркестрации.

1. Скопируйте значение URL-адреса для `statusQueryGetUri`, вставьте его в адресную строку панели браузера и выполните запрос. Кроме того, вы можете воспользоваться Postman для выдачи запроса GET.

   Запрос будет запрашивать экземпляр оркестрации для состояния. Вам нужно получить итоговый ответ, который показывает, что экземпляр выполнен и содержит выходные данные или результаты устойчивой функции. Он выглядит следующим образом: 

    ```json
    {
        "name": "HelloOrchestrator",
        "instanceId": "9a528a9e926f4b46b7d3deaa134b7e8a",
        "runtimeStatus": "Completed",
        "input": null,
        "customStatus": null,
        "output": [
            "Hello Tokyo!",
            "Hello Seattle!",
            "Hello London!"
        ],
        "createdTime": "2020-03-18T21:54:49Z",
        "lastUpdatedTime": "2020-03-18T21:54:54Z"
    }
    ```

1. В VS Code нажмите клавиши **Shift + F5**, чтобы остановить отладку.

Убедившись, что функция выполняется правильно на локальном компьютере, опубликуйте проект в Azure.

[!INCLUDE [functions-create-function-app-vs-code](../../../includes/functions-sign-in-vs-code.md)]

## <a name="publish-the-project-to-azure"></a>Публикация проекта в Azure

В этом разделе показано создание приложения-функции и сопутствующих ресурсов в подписке Azure и последующее развертывание кода. 

> [!IMPORTANT]
> Публикация в существующее приложение-функцию перезаписывает содержимое этого приложения в Azure. 


1. Щелкните значок Azure на панели действий, а затем в области **Azure: Функции** выберите кнопку **Deploy to function app...** (Развертывание в приложение-функцию).

    ![Публикация проекта в Azure](../../../includes/media/functions-publish-project-vscode/function-app-publish-project.png)

1. Введите следующие сведения по соответствующим запросам:

    + **Выбор папки**. Выберите папку из рабочей области или перейдите к папке, содержащей приложение-функцию. Этот элемент не отобразится, если вы уже открыли допустимое приложение-функцию.

    + **Выбрать подписку**. Выберите подписку, которую нужно использовать. Если у вас только одна подписка, вы не увидите этот параметр.

    + **Select Function App in Azure** (Выбор приложения-функции в Azure). Выберите `+ Create new Function App`. (Не выбирайте параметр `Advanced`, так как он не рассматривается в этой статье.)
      
    + **Enter a globally unique name for the function app** (Ввод глобально уникального имени для приложения-функции). Введите имя, допустимое в пути URL-адреса. Имя, которое вы вводите, проверяется, чтобы убедиться, что оно уникально в функциях Azure. 

    + **Select a runtime** (Выбор среды выполнения). Выберите версию PowerShell, которая запускалась локально. Вы можете использовать команду `pwsh -version`, чтобы проверить установленную версию.

        > [!NOTE]
        > Возможно, расширение VS Code службы "Функции Azure" еще не поддерживает PowerShell 7. Если среда PowerShell 7 недоступна в качестве варианта, выберите пока PowerShell 6.x и [обновите версию вручную](#update-function-app-ps7) после создания приложения-функции.

    + **Select a location for new resources** (Выбор расположения для новых ресурсов).  Для повышения производительности выберите [регион](https://azure.microsoft.com/regions/) рядом с вами. 
    
1.  После завершения в вашей подписке создаются следующие ресурсы Azure с именами, производными от имени приложения-функции:
    
    + группу ресурсов — логический контейнер связанных ресурсов;
    + Стандартная учетная запись хранения Azure для сохранения состояния и других сведений о проектах.
    + План потребления, который определяет базовый узел для бессерверного приложения-функции; 
    + приложение-функцию — среду для выполнения кода функции. Приложение-функция позволяет группировать функции в логические единицы и упростить развертывание, масштабирование и совместное использование ресурсов, а также управление ими в рамках единого плана размещения.
    + Экземпляр Application Insights, подключенный к приложению-функции, который отслеживает использование бессерверной функции.

    После создания приложения-функции и применения пакета развертывания отобразится уведомление.

1. <a name="update-function-app-ps7"></a>Если вы не смогли выбрать *PowerShell 7* ранее при создании приложения-функции, нажмите клавишу F1 (или сочетание клавиш Ctrl/Cmd+Shift+P), чтобы открыть палитру команд. В палитре команд найдите и щелкните `Azure Functions: Upload Local Settings...`. Следуйте инструкциям на экране, чтобы выбрать созданное приложение-функцию. Если будет предложено перезаписать существующие параметры, выберите *Нет для всех*.
    
1. Выберите **View Output** (Просмотреть выходные данные) в уведомлении, чтобы просмотреть результаты создания и развертывания ресурсов Azure. Если вы пропустили уведомление, щелкните значок колокольчика в правом нижнем углу, чтобы снова просмотреть его.

    ![Создание уведомления о завершении](../../../includes/media/functions-publish-project-vscode/function-create-notifications.png)


## <a name="test-your-function-in-azure"></a>Тестирование функции в Azure

1. Скопируйте URL-адрес HTTP-триггера на панели **Output** (Выходные данные). URL-адрес для вызова функции, активируемой HTTP-запросом, должен быть указан в таком формате: `http://<functionappname>.azurewebsites.net/api/orchestrators/HelloOrchestrator`

2. Вставьте этот URL-адрес HTTP-запроса в адресную строку браузера. При использовании опубликованного приложения ответ состояния должен быть таким же, как и ранее.

## <a name="next-steps"></a>Дальнейшие действия

Вы создали и опубликовали устойчивое приложение-функцию PowerShell с помощью Visual Studio Code.

> [!div class="nextstepaction"]
> [Дополнительные сведения о распространенных шаблонах устойчивых функций](durable-functions-overview.md#application-patterns)
