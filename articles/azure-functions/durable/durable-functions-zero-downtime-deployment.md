---
title: Развертывание без простоя для Устойчивые функции
description: Узнайте, как включить согласование Устойчивые функции для развертываний без простоя.
author: tsushi
ms.topic: conceptual
ms.date: 10/10/2019
ms.author: azfuncdf
ms.custom: fasttrack-edit
ms.openlocfilehash: 707d624c47c536e00e98910a8902772703733515
ms.sourcegitcommit: 7edadd4bf8f354abca0b253b3af98836212edd93
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/10/2021
ms.locfileid: "102558769"
---
# <a name="zero-downtime-deployment-for-durable-functions"></a>Развертывание без простоя для Устойчивые функции

[Надежная модель выполнения](./durable-functions-orchestrations.md) устойчивые функции требует, чтобы согласованность была детерминированной, что создает дополнительную задачу, которую следует учитывать при развертывании обновлений. Если в развертывании содержатся изменения в сигнатурах функций действий или логике Orchestrator, то экземпляры оркестрации в полете будут завершаться сбоем. Эта ситуация особенно связана с проблемами для экземпляров долгосрочных оркестрации, которые могут представлять часы или дни работы.

Чтобы предотвратить эти сбои, у вас есть два варианта: 
- Отложите развертывание до завершения всех выполняющихся экземпляров оркестрации.
- Убедитесь, что все выполняющиеся экземпляры оркестрации используют существующие версии функций. 

На следующей диаграмме сравниваются три основные стратегии для реализации развертывания без простоя для Устойчивые функции: 

| Стратегия |  Назначение | Плюсы | Минусы |
| -------- | ------------ | ---- | ---- |
| [Управление версиями](#versioning) |  Приложения, которые не сталкиваются с частыми [критическими изменениями.](durable-functions-versioning.md) | Простота реализации. |  Увеличение размера приложения функции в памяти и числе функций.<br/>Дублирование кода. |
| [Проверка состояния с слотом](#status-check-with-slot) | Система, которая не имеет длительно выполняющихся оркестрации, использующих более 24 часов или часто перекрывающихся согласований. | Простая база кода.<br/>Не требует дополнительного управления приложениями функций. | Требуется дополнительная учетная запись хранения или управление концентратором задач.<br/>Требует периодов времени, когда согласования не выполняются. |
| [Маршрутизация приложений](#application-routing) | Система, которая не имеет периодов времени, когда управляемые процессы не выполняются, например периоды времени с согласованиями за последние 24 часа или с часто перекрытием согласований. | Обрабатывает новые версии систем с постоянно работающими оркестрации, которые имеют критически важные изменения. | Требуется интеллектуальный маршрутизатор приложений.<br/>Максимально допустимое количество приложений функций, разрешенных вашей подпиской. Значение по умолчанию — 100. |

## <a name="versioning"></a>Управление версиями

Определите новые версии функций и оставьте старые версии в приложении функции. Как можно увидеть на схеме, версия функции станет частью ее имени. Так как сохраняются предыдущие версии функций, экземпляры оркестрации в рейсе могут продолжать ссылаться на них. В то же время запросы для новых экземпляров оркестрации вызывают последнюю версию, на которую Клиентская функция оркестрации может ссылаться из параметра приложения.

![Стратегия управления версиями](media/durable-functions-zero-downtime-deployment/versioning-strategy.png)

В этой стратегии необходимо скопировать каждую функцию, а ссылки на другие функции должны быть обновлены. Вы можете сделать это проще, написав сценарий. Ниже приведен [Пример проекта](https://github.com/TsuyoshiUshio/DurableVersioning) с скриптом миграции.

>[!NOTE]
>Эта стратегия использует слоты развертывания, чтобы избежать простоев во время развертывания. Более подробные сведения о создании и использовании новых слотов развертывания см. в разделе [слоты развертывания функций Azure](../functions-deployment-slots.md).

## <a name="status-check-with-slot"></a>Проверка состояния с слотом

Пока текущая версия приложения-функции выполняется в рабочем слоте, разверните новую версию приложения-функции в промежуточном слоте. Перед переключением рабочих и промежуточных слотов проверьте, есть ли в наличии выполняющиеся экземпляры оркестрации. После завершения всех экземпляров оркестрации можно выполнить переключение. Эта стратегия работает при наличии предсказуемых периодов, когда экземпляры оркестрации не находятся в полете. Это наилучший подход, когда согласование не выполняется долго и когда выполнение оркестрации часто не перекрывается.

### <a name="function-app-configuration"></a>Конфигурация приложения функции

Для настройки этого сценария используйте следующую процедуру.

1. [Добавьте слоты развертывания](../functions-deployment-slots.md#add-a-slot) в приложение функции для промежуточного хранения и рабочей среды.

1. Для каждого слота задайте [параметру приложения AzureWebJobsStorage](../functions-app-settings.md#azurewebjobsstorage) строку подключения общей учетной записи хранения. Эта строка подключения учетной записи хранения используется средой выполнения функций Azure. Эта учетная запись используется средой выполнения функций Azure и управляет ключами функции.

1. Для каждого слота создайте новый параметр приложения, например `DurableManagementStorage` . Задайте в качестве значения строку подключения различных учетных записей хранения. Эти учетные записи хранения используются расширением Устойчивые функции для [надежного выполнения](./durable-functions-orchestrations.md). Используйте отдельную учетную запись хранения для каждого слота. Не отмечайте этот параметр как параметр слота развертывания.

1. В [host.jsфайла](durable-functions-bindings.md#hostjson-settings)в приложении-функции укажите `connectionStringName` (устойчивое имя 2. x) или `azureStorageConnectionStringName` (устойчивое к 1. x) в качестве имени параметра приложения, созданного на шаге 3.

На следующей схеме показана описанная конфигурация слотов развертывания и учетных записей хранения. В этом случае возможный сценарий предварительного развертывания версии 2 приложения-функции выполняется в рабочем слоте, а версия 1 остается в промежуточном слоте.

![Слоты развертывания и учетные записи хранения](media/durable-functions-zero-downtime-deployment/deployment-slot.png)

### <a name="hostjson-examples"></a>host.jsпримеры

Следующие фрагменты JSON являются примерами параметра строки подключения в *host.js* в файле.

#### <a name="functions-20"></a>Функции 2,0

```json
{
  "version": 2.0,
  "extensions": {
    "durableTask": {
      "hubName": "MyTaskHub",
      "storageProvider": {
        "connectionStringName": "DurableManagementStorage"
      }
    }
  }
}
```

#### <a name="functions-1x"></a>Функции 1.x

```json
{
  "durableTask": {
    "azureStorageConnectionStringName": "DurableManagementStorage"
  }
}
```

### <a name="cicd-pipeline-configuration"></a>Конфигурация конвейера CI/CD

Настройте конвейер CI/CD для развертывания, только если приложение-функция не имеет ожидающих или выполняющих экземпляров оркестрации. При использовании Azure Pipelines можно создать функцию, которая проверяет эти условия, как показано в следующем примере:

```csharp
[FunctionName("StatusCheck")]
public static async Task<IActionResult> StatusCheck(
    [HttpTrigger(AuthorizationLevel.Function, "get", "post")] HttpRequestMessage req,
    [DurableClient] IDurableOrchestrationClient client,
    ILogger log)
{
    var runtimeStatus = new List<OrchestrationRuntimeStatus>();

    runtimeStatus.Add(OrchestrationRuntimeStatus.Pending);
    runtimeStatus.Add(OrchestrationRuntimeStatus.Running);

    var result = await client.ListInstancesAsync(new OrchestrationStatusQueryCondition() { RuntimeStatus = runtimeStatus }, CancellationToken.None);
    return (ActionResult)new OkObjectResult(new { HasRunning = result.DurableOrchestrationState.Any() });
}
```

Затем настройте промежуточный шлюз на ожидание, пока не будут выполняться согласования. Дополнительные сведения см. в разделе [выпуски Управление развертыванием с помощью шлюзов](/azure/devops/pipelines/release/approvals/gates) .

![Шлюз развертывания](media/durable-functions-zero-downtime-deployment/deployment-gate.png)

Azure Pipelines проверяет приложение функции на выполнение экземпляров оркестрации до начала развертывания.

![Шлюз развертывания (работает)](media/durable-functions-zero-downtime-deployment/deployment-gate-2.png)

Теперь новая версия приложения функции должна быть развернута в промежуточном слоте.

![Промежуточный слот](media/durable-functions-zero-downtime-deployment/deployment-slot-2.png)

Наконец, замените слоты. 

Параметры приложения, которые не отмечены как параметры слота развертывания, также меняются, поэтому приложение версии 2 хранит ссылку на учетную запись хранения а. Так как состояние оркестрации учитывается в учетной записи хранения, все взаимодействия, запущенные в приложении версии 2, продолжают работать в новом слоте без прерывания.

![Слот развертывания](media/durable-functions-zero-downtime-deployment/deployment-slot-3.png)

Чтобы использовать одну и ту же учетную запись хранения для обоих слотов, можно изменить имена центров задач. В этом случае необходимо управлять состоянием слотов и параметрами HubName приложения. Дополнительные сведения см. [в разделе концентраторы задач в устойчивые функции](durable-functions-task-hubs.md).

## <a name="application-routing"></a>Маршрутизация приложений

Эта стратегия является наиболее сложной. Однако его можно использовать для приложений функций, у которых нет времени между выполнением согласований.

Для этой стратегии необходимо создать *маршрутизатор приложения* перед устойчивые функции. Этот маршрутизатор можно реализовать с помощью Устойчивые функции. Маршрутизатор отвечает за следующие действия:

* Разверните приложение функции.
* Управление версией Устойчивые функции. 
* Перенаправление запросов оркестрации в приложения функций.

При первом получении запроса оркестрации маршрутизатор выполняет следующие задачи:

1. Создает новое приложение-функцию в Azure.
2. Развертывает код приложения функции в новом приложении функции в Azure.
3. Перенаправляет запрос оркестрации в новое приложение.

Маршрутизатор управляет состоянием версии кода приложения, на котором развернуто приложение-функция в Azure.

![Маршрутизация приложений (первый раз)](media/durable-functions-zero-downtime-deployment/application-routing.png)

Маршрутизатор направляет запросы на развертывание и оркестрации соответствующему приложению функции на основе версии, отправленной с запросом. Она не учитывает версию исправления.

При развертывании новой версии приложения без критического изменения можно увеличить версию исправления. Маршрутизатор развертывается в существующем приложении функции и отправляет запросы для старой и новой версий кода, которые направляются в одно и то же приложение функции.

![Маршрутизация приложений (без критических изменений)](media/durable-functions-zero-downtime-deployment/application-routing-2.png)

При развертывании новой версии приложения с критическим изменением можно увеличить основную или дополнительную версию. Затем маршрутизатор приложений создает в Azure новое приложение-функцию, развертывает его и направляет запросы к новой версии приложения. На следующей схеме выполнение согласований в версии 1.0.1 приложения продолжает выполняться, но запросы к версии 1.1.0 направляются в новое приложение функции.

![Маршрутизация приложений (критическое изменение)](media/durable-functions-zero-downtime-deployment/application-routing-3.png)

Маршрутизатор отслеживает состояние согласований в версии 1.0.1 и удаляет приложения после завершения всех согласований. 

### <a name="tracking-store-settings"></a>Параметры хранилища отслеживания

Каждое приложение функции должно использовать отдельные очереди планирования, возможно, в отдельных учетных записях хранения. Если вы хотите запросить все экземпляры оркестрации во всех версиях приложения, вы можете совместно использовать таблицы экземпляров и журналов в приложениях функций. Вы можете предоставить общий доступ к таблицам, настроив `trackingStoreConnectionStringName` `trackingStoreNamePrefix` Параметры и в файле [host.json Settings](durable-functions-bindings.md#host-json) , чтобы они использовали одинаковые значения.

Дополнительные сведения см. в статье [Управление экземплярами в устойчивые функции в Azure](durable-functions-instance-management.md).

![Параметры хранилища отслеживания](media/durable-functions-zero-downtime-deployment/tracking-store-settings.png)

## <a name="next-steps"></a>Дальнейшие действия

> [!div class="nextstepaction"]
> [Устойчивые функции управления версиями](durable-functions-versioning.md)
