---
title: Установка закрытого доступа к сайту к Функциям Azure
description: Сведения о настройке закрытого доступа к сайту для Функций Azure в виртуальной сети Azure.
author: craigshoemaker
ms.author: cshoe
ms.service: azure-functions
ms.topic: tutorial
ms.date: 06/17/2020
ms.openlocfilehash: 766ad12daeb6d2763f7ed5fe026cd4a0021eaf33
ms.sourcegitcommit: 2aa52d30e7b733616d6d92633436e499fbe8b069
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/06/2021
ms.locfileid: "97937048"
---
# <a name="tutorial-establish-azure-functions-private-site-access"></a>Руководство по установке закрытого доступа к сайту для Функций Azure

В этом руководстве показано, как включить [закрытый доступ к сайту](./functions-networking-options.md#private-endpoint-connections) с Функциями Azure. Используя закрытый доступ к сайту, можно потребовать, чтобы код функции запускался только из определенной виртуальной сети.

Закрытый доступ к сайту удобен в ситуациях, когда доступ к приложению-функции необходимо ограничить конкретной виртуальной сетью. Например, приложение-функция может быть применимо только для сотрудников определенной организации или служб, находящихся в заданной виртуальной сети (например, это может быть другая функция Azure, виртуальная машина Azure или кластер AKS).

Если приложению-функции требуется доступ к ресурсам Azure в виртуальной сети или подключение осуществляется через [конечные точки службы](../virtual-network/virtual-network-service-endpoints-overview.md), требуется [интеграция виртуальной сети](./functions-create-vnet.md).

Из этого руководства вы узнаете, как настроить частный доступ к сайту для приложения-функции.

> [!div class="checklist"]
> * Создание виртуальной машины
> * Создание службы "Бастион Azure"
> * Создание приложения Функций Azure
> * Настройка конечной точки службы в виртуальной сети
> * Создание и развертывание функции Azure
> * Вызов функции изнутри и извне виртуальной сети

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

## <a name="topology"></a>Топология

На следующей схеме показана архитектура создаваемого решения.

![Общая схема архитектуры решения для частного доступа к сайту](./media/functions-create-private-site-access/topology.png)

## <a name="prerequisites"></a>Предварительные требования

Для работы с этим руководством важно понимать принципы назначения IP-адресов и определения подсети. Вы можете начать с [этой статьи, в которой изложены основы назначения адресов и определения подсети](https://support.microsoft.com/help/164015/understanding-tcp-ip-addressing-and-subnetting-basics). В Интернете доступно множество других статей и видеоматериалов по этой теме.

## <a name="sign-in-to-azure-portal"></a>Вход на портал Azure

Войдите на [портал Azure](https://portal.azure.com).

## <a name="create-a-virtual-machine"></a>Создание виртуальной машины

Согласно данному руководству, первое, что необходимо сделать, — создать новую виртуальную машину в виртуальной сети.  Виртуальная машина будет использоваться для доступа к функции после того, как она (из-за ограничения доступа) станет доступна только в виртуальной сети.

1. Нажмите кнопку **Создать ресурс**.

1. В поле поиска введите **Windows Server** и выберите **Windows Server** в результатах поиска.

1. Выберите **Windows Server 2019 Datacenter** из списка вариантов Windows Server и нажмите кнопку **Создать**.

1. На вкладке _Основные сведения_ задайте параметры виртуальной машины, указанные в таблице под этим изображением.

    >[!div class="mx-imgBorder"]
    >![Вкладка "Основные сведения" для новой виртуальной машины Windows](./media/functions-create-private-site-access/create-vm-3.png)

    | Параметр      | Рекомендуемое значение  | Описание      |
    | ------------ | ---------------- | ---------------- |
    | _Подписка_ | Ваша подписка | Подписка, в рамках которой создан ресурс. |
    | [_Группа ресурсов_](../azure-resource-manager/management/overview.md) | myResourceGroup | Выберите группу ресурсов, которая будет содержать ресурсы для работы с этим руководством.  Использование одной и той же группы ресурсов упрощает задачу очистки ресурсов после завершения работы с этим руководством. |
    | _Имя виртуальной машины_ | myVM | Имя виртуальной машины должно быть уникальным в группе ресурсов. |
    | [_Регион_](https://azure.microsoft.com/regions/) | Центрально-северная часть США (США) | Выберите регион, ближайший к вам или к месту расположения функций, к которым будет осуществляться доступ. |
    | _Общедоступные входящие порты_ | None | Выберите **отсутствует**, чтобы гарантировать отсутствие входящего подключения к виртуальной машине из Интернета. Удаленный доступ к виртуальной машине будет настроен с помощью службы "Бастион Azure". |

1. Перейдите на вкладку _Сетевые подключения_ и выберите **Создать**, чтобы настроить новую виртуальную сеть.

    >[!div class="mx-imgBorder"]
    >![Снимок экрана: вкладка "Сетевые подключения" с выделенной командой "Создать" в разделе "Виртуальная сеть"](./media/functions-create-private-site-access/create-vm-networking.png)

1. В разделе _Создание виртуальной сети_ задайте параметры, указанные в таблице под изображением.

    >[!div class="mx-imgBorder"]
    >![Создание новой виртуальной сети для новой виртуальной машины](./media/functions-create-private-site-access/create-vm-vnet-1.png)

    | Параметр      | Рекомендуемое значение  | Описание      |
    | ------------ | ---------------- | ---------------- |
    | _имя_; | myResourceGroup-vnet | Вы можете использовать имя по умолчанию, созданное для виртуальной сети. |
    | _Диапазон адресов_ | 10.10.0.0/16 | Используйте один диапазон адресов для виртуальной сети. |
    | _Имя подсети_ | Учебник | Имя подсети. |
    | _Диапазон адресов_ (подсеть) | 10.10.1.0/24 | От размера подсети зависит, сколько интерфейсов можно в нее добавить. Эта подсеть используется виртуальной машиной. Подсеть /24 предоставляет 254 адреса узлов. |

1. Нажмите кнопку **ОК**, чтобы создать виртуальную сеть.
1. Вернитесь на вкладку _Сетевые подключения_ убедитесь, что для параметра _Общедоступный IP-адрес_ выбрано значение **отсутствует**.
1. Перейдите на вкладку _Управление_, а затем в разделе _Diagnostic storage account_ (Учетная запись хранения диагностики) выберите **Создать**, чтобы создать новую учетную запись хранения.
1. Оставьте значения по умолчанию в разделах _Идентификатор_, _Автозавершение работы_ и _Резервное копирование_.
1. Выберите _Review + create_ (Просмотреть и создать). После завершения проверки щелкните **Создать**. Процесс создания виртуальной машины займет несколько минут.

## <a name="configure-azure-bastion"></a>Настройка Бастиона Azure

[Бастион Azure](https://azure.microsoft.com/services/azure-bastion/) — это полностью управляемая служба Azure, которая обеспечивает безопасный доступ к виртуальным машинам по протоколам RDP и SSH непосредственно с портала Azure. Использование службы "Бастион Azure" избавляет от необходимости настройки параметров сети, связанных с доступом по протоколу RDP.

1. На портале в верхней части представления группы ресурсов выберите **Добавить**.
1. В поле поиска введите **Бастион**.
1. В результатах поиска выберите **Бастион**.
1. Выберите **Создать**, чтобы начать процесс создания нового ресурса типа "Бастион Azure". В разделе _Виртуальная сеть_ отобразится сообщение об ошибке, так как подсети AzureBastionSubnet еще нет. Подсеть создается на следующих этапах. Затем используйте настройки из таблицы под изображением.

    >[!div class="mx-imgBorder"]
    >![Начало создания Бастиона Azure](./media/functions-create-private-site-access/create-bastion-basics-1.png)

    | Параметр      | Рекомендуемое значение  | Описание      |
    | ------------ | ---------------- | ---------------- |
    | _имя_; | myBastion | Имя нового ресурса типа "Бастион". |
    | _Регион_ | Центрально-северная часть США | Выберите ближайший [регион](https://azure.microsoft.com/regions/) или регион рядом с другими службами, к которому получают доступ ваши функции. |
    | _Виртуальная сеть_ | myResourceGroup-vnet | Виртуальная сеть, в которой будет создан ресурс типа "Бастион". |
    | _Подсеть_ | AzureBastionSubnet | Подсеть в виртуальной сети, в которой будет развернут новый ресурс типа "Узел-бастион". Необходимо создать подсеть, используя в качестве имени значение **AzureBastionSubnet**. По этому значению Azure сможет определить, в какую подсеть следует развертывать ресурсы типа "Бастион". Следует использовать подсеть размером не менее **/27** (/27, /26 и т. д.). |

    > [!NOTE]
    > Подробное пошаговое руководство по созданию ресурса типа "Бастион Azure" см. в учебнике [Создание узла-бастиона Azure](../bastion/tutorial-create-host-portal.md).

1. Создайте подсеть, в которой Azure может подготовить узел-бастион Azure. При выборе элемента **Управление конфигурацией подсети** откроется новая область, в которой можно определить новую подсеть.  Выберите **+ Подсеть** для создания новой подсети.
1. Подсеть должна иметь имя **AzureBastionSubnet**, а длина префикса подсети должна быть не менее **/27**.  Нажмите кнопку **ОК**, чтобы создать подсеть.

    >[!div class="mx-imgBorder"]
    >![Создание подсети для узла-бастиона Azure](./media/functions-create-private-site-access/create-bastion-subnet-2.png)

1. На странице _Создание бастиона_ выберите только что созданную подсеть **AzureBastionSubnet** из списка доступных подсетей.

    >[!div class="mx-imgBorder"]
    >![Создание узла-бастиона Azure с определенной подсетью](./media/functions-create-private-site-access/create-bastion-basics-2.png)

1. Выберите **Просмотреть и создать**. По завершении проверки выберите **Создать**. Создание ресурса типа "Бастион Azure" займет несколько минут.

## <a name="create-an-azure-functions-app"></a>Создание приложения Функций Azure

Следующий этап — создание приложения-функции в Azure с использованием [плана потребления](consumption-plan.md). Развертывание кода функции в этом ресурсе описано далее в этом руководстве.

1. На портале в верхней части представления группы ресурсов выберите **Добавить**.
1. Выберите **Среда выполнения приложений > Приложение-функция**.
1. В разделе _Основные сведения_ используйте параметры приложения-функции как указано в таблице ниже.

    | Параметр      | Рекомендуемое значение  | Описание      |
    | ------------ | ---------------- | ---------------- |
    | _Группа ресурсов_ | myResourceGroup | Выберите группу ресурсов, которая будет содержать ресурсы для работы с этим руководством.  Использование одной и той же группы ресурсов для приложения-функции и виртуальной машины упрощает задачу очистки ресурсов после завершения работы с этим руководством. |
    | _Имя приложения-функции_ | Глобально уникальное имя | Имя, которое идентифицирует ваше новое приложение-функцию. Допустимые символы: a–z (без учета регистра), 0–9 и -. |
    | _Опубликовать_ | Код | Параметр для публикации файлов кода или контейнера Docker. |
    | _Стек среды выполнения_ | Предпочитаемый язык | Выберите среду выполнения, которая поддерживает нужный функциональный язык программирования. |
    | _Регион_ | Центрально-северная часть США | Выберите ближайший [регион](https://azure.microsoft.com/regions/) или регион рядом с другими службами, к которому получают доступ ваши функции. |

    Нажмите кнопку **Далее: размещение >** .
1. В разделе _Размещение_ выберите соответствующие значения для параметров _Учетная запись хранения_, _Операционная система_ и _План_, как описано в следующей таблице.

    | Параметр      | Рекомендуемое значение  | Описание      |
    | ------------ | ---------------- | ---------------- |
    | _Учетная запись хранения_ | Глобально уникальное имя | Создайте учетную запись хранения для использования приложением-функцией. Имя учетной записи хранения должно содержать от 3 до 24 символов и состоять только из цифр и строчных букв. Можно также использовать существующую учетную запись при условии, что она соответствует [требованиям учетной записи хранилища](storage-considerations.md#storage-account-requirements). |
    | _Операционная система_ | Предпочтительная операционная система | Операционная система предварительно выбирается с учетом выбранного стека среды выполнения, но при необходимости ее можно изменить. |
    | _План_ | Потребление | От [плана размещения](./functions-scale.md) зависит, как масштабируется приложение-функция и какие ресурсы доступны для каждого экземпляра. |
1. Выберите **Просмотр и создание** , чтобы просмотреть выбранные параметры конфигурации приложения.
1. Выберите **Создать**, чтобы подготовить и развернуть приложение-функцию.

## <a name="configure-access-restrictions"></a>Настройка ограничений доступа

Следующий этап — настройка таких [ограничений доступа](../app-service/app-service-ip-restrictions.md), при которых вызывать функцию смогут только ресурсы в виртуальной сети.

[Закрытый доступ к сайту](functions-networking-options.md#private-endpoint-connections) включается при создании [конечной точки службы](../virtual-network/virtual-network-service-endpoints-overview.md) виртуальной сети Azure между приложением-функцией и указанной виртуальной сетью. Ограничения доступа реализуются через конечные точки службы. Конечные точки службы гарантируют, что только трафик, исходящий из указанной виртуальной сети, может получить доступ к назначенному ресурсу. В данном случае назначенным ресурсом является функция Azure.

1. В приложении-функции под заголовком раздела _Параметры_ выберите ссылку **Сетевые подключения**.
1. Страница _Сетевые подключения_ является отправной точкой для настройки Azure Front Door, Azure CDN, а также ограничений доступа.
1. Выберите **Настройка ограничений доступа** для настройки закрытого доступа к сайту.
1. На странице _Ограничения доступа_ отображается только ограничение по умолчанию. Ограничения на доступ к приложению-функции по умолчанию не устанавливаются.  Выберите **Добавить правило**, чтобы создать конфигурацию ограничения для закрытого доступа к сайту.
1. В области _Добавление ограничения доступа_ заполните для нового правила поля _Имя_, _Приоритет_ и _Описание_.
1. Выберите в раскрывающемся списке _Тип_ значение **Виртуальная сеть**, выберите созданную ранее виртуальную сеть, а затем — подсеть для этого **учебника**. 
    > [!NOTE]
    > Включение конечной точки службы может занять несколько минут.
1. Теперь на странице _Ограничения доступа_ отображается новое ограничение. Для изменения значения _Состояние конечной точки_ с "Отключено" на "Подготовка", а затем — "Включено" может потребоваться несколько секунд.

    >[!IMPORTANT]
    > У каждого приложения-функции есть [сайт расширенного инструмента (Kudu)](../app-service/app-service-ip-restrictions.md#restrict-access-to-an-scm-site), который используется для управления развертываниями приложений-функций. Для доступа к этому сайту используется URL-адрес, например `<FUNCTION_APP_NAME>.scm.azurewebsites.net`. Включение ограничений доступа на сайте Kudu препятствует развертыванию кода проекта с локальной рабочей станции разработчика. В этом случае для выполнения развертывания в виртуальной сети требуется агент.

## <a name="access-the-functions-app"></a>Доступ к приложению-функции

1. Вернитесь к ранее созданному приложению-функции.  В разделе _Обзор_ скопируйте URL-адрес.

    >[!div class="mx-imgBorder"]
    >![Получение URL-адреса приложения-функции](./media/functions-create-private-site-access/access-function-overview.png)

    Если вы теперь попытаетесь получить доступ к приложению-функции с компьютера, находящегося за пределами виртуальной сети, вы получите страницу HTTP 403, указывающую, что доступ запрещен.
1. Вернитесь в группу ресурсов и выберите созданную ранее виртуальную машину. Чтобы получить доступ к сайту из виртуальной машины, необходимо подключиться к ней через службу "Бастион Azure".
1. Выберите **Подключить**, а затем — **Бастион**.
1. Укажите необходимые имя пользователя и пароль для входа на виртуальную машину.
1. Выберите **Подключиться**. Появится новое окно браузера, позволяющее взаимодействовать с виртуальной машиной.
Доступ к сайту можно получить из веб-браузера на виртуальной машине, так как виртуальная машина обращается к нему через виртуальную сеть.  Хотя сайт доступен только в назначенной виртуальной сети, общедоступная запись DNS остается.

## <a name="create-a-function"></a>Создание функции

Следующий этап в этом руководстве — создание функции Azure, активируемой по HTTP. Вызов функции с помощью метода HTTP GET или POST должен приводить к отправке ответа "Hello, {имя}".  

1. Выполните указания в одном из следующих кратких руководств, чтобы создать и развернуть приложение Функций Azure.

    * [Visual Studio Code](./create-first-function-vs-code-csharp.md)
    * [Visual Studio](./functions-create-your-first-function-visual-studio.md)
    * [Командная строка](./create-first-function-cli-csharp.md)
    * [Maven (Java)](./create-first-function-cli-java.md?tabs=bash,browser)

1. При публикации проекта Функций Azure выберите ресурс типа "Приложение-функция", созданный ранее в этом руководстве.
1. Убедитесь, что функция развернута.

    >[!div class="mx-imgBorder"]
    >![Развернутая функция в списке функций](./media/functions-create-private-site-access/verify-deployed-function.png)

## <a name="invoke-the-function-directly"></a>Непосредственный вызов функции

1. Чтобы проверить доступ к функции, необходимо скопировать ее URL-адрес. Выберите развернутую функцию, а затем — **Получить URL-адрес функции**. Затем нажмите кнопку **Копировать**, чтобы скопировать URL-адрес в буфер обмена.

    >[!div class="mx-imgBorder"]
    >![Копирование URL-адреса функции](./media/functions-create-private-site-access/get-function-url.png)

1. Вставьте URL-адрес в веб-браузер. Если вы теперь попытаетесь получить доступ к приложению-функции с компьютера, находящегося за пределами виртуальной сети, вы получите ответ HTTP 403, указывающий, что доступ к приложению запрещен.

## <a name="invoke-the-function-from-the-virtual-network"></a>Вызов функции из виртуальной сети

Доступ к функции через веб-браузер (с помощью службы "Бастион Azure") на настроенной виртуальной машине в виртуальной сети успешно получен.

>[!div class="mx-imgBorder"]
>![Доступ к функции Azure через Бастион Azure](./media/functions-create-private-site-access/access-function-via-bastion-final.png)

[!INCLUDE [clean-up-section-portal](../../includes/clean-up-section-portal.md)]

## <a name="next-steps"></a>Дальнейшие действия


> [!div class="nextstepaction"]
> [Дополнительные сведения о параметрах сети в Функциях](./functions-networking-options.md)