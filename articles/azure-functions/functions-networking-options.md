---
title: Параметры сети для Функций Azure
description: Обзор всех параметров сети, доступных в Функциях Azure.
author: cachai2
ms.topic: conceptual
ms.date: 1/21/2021
ms.author: cachai
ms.openlocfilehash: ceef827f7406f8915d205349372a43626c917e4b
ms.sourcegitcommit: c27a20b278f2ac758447418ea4c8c61e27927d6a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/03/2021
ms.locfileid: "101729238"
---
# <a name="azure-functions-networking-options"></a>Параметры сети для Функций Azure

В этой статье описываются сетевые возможности, доступные в различных вариантах размещения для Функций Azure. Все перечисленные ниже параметры сети предоставляют некоторую возможность доступа к ресурсам, не используя адресов с маршрутизацией через Интернет или ограничения доступа к Интернету для приложения-функции.

Для моделей размещения доступны разные уровни сетевой изоляции. Выбор правильного варианта поможет соответствовать требованиям к сетевой изоляции.

Размещать приложения-функции можно двумя способами:

* Можно выбрать из параметров плана, которые выполняются в инфраструктуре с несколькими клиентами, с различными уровнями возможностей подключения и масштабирования виртуальной сети:
    * [План потребления](consumption-plan.md) динамически масштабируется в ответ на загрузку и предлагает минимальные параметры сетевой изоляции.
    * [План категории "Премиум"](functions-premium-plan.md) также динамически масштабируется и предоставляет более широкие возможности сетевой изоляции.
    * [План служб приложений](dedicated-plan.md) Azure работает в фиксированном масштабе и обеспечивает такую же сетевую изоляцию, как в плане категории "Премиум".
* Вы можете запускать функции в параметре [Среда службы приложений](../app-service/environment/intro.md). Этот метод развертывает функцию в виртуальной сети и обеспечивает полный сетевой контроль и изоляцию.

## <a name="matrix-of-networking-features"></a>Таблица функций сети

[!INCLUDE [functions-networking-features](../../includes/functions-networking-features.md)]

## <a name="inbound-access-restrictions"></a>Ограничения входящего доступа

С помощью ограничений доступа можно определить упорядоченный по приоритету список IP-адресов, которым разрешен или запрещен доступ к приложению. Список может включать адреса IPv4 и IPv6 или определенные подсети виртуальной сети с помощью [конечных точек службы](#use-service-endpoints). Если он содержит одну или несколько записей, то в конце списка действует неявный запрет на все адреса. Ограничения IP-адресов работают со всеми вариантами размещения функций.

Ограничения доступа доступны в службе " [премиум](functions-premium-plan.md)", " [потребление](consumption-plan.md)" и " [служба приложений](dedicated-plan.md)".

> [!NOTE]
> При наличии ограничений сети можно развернуть только из виртуальной сети или указать IP-адрес компьютера, который вы используете для доступа к портал Azure в списке Надежные получатели. Тем не менее вы по-прежнему можете управлять этой функцией с помощью портала.

Дополнительные сведения см. в статье [Azure App Service static access restrictions](../app-service/app-service-ip-restrictions.md) (Ограничения статического доступа для Службы приложений Azure).

### <a name="use-service-endpoints"></a>Использование конечных точек служб

С помощью конечных точек службы можно ограничить доступ к выбранным подсетям виртуальной сети Azure. Чтобы ограничить доступ к определенной подсети, создайте правило ограничения с типом **виртуальной сети** . Затем можно выбрать подписку, виртуальную сеть и подсеть, к которым вы хотите разрешить или запретить доступ. 

Если конечные точки службы не включены в Microsoft. Web для выбранной подсети, они будут включены автоматически, если не установлен флажок **игнорировать отсутствующие конечные точки Microsoft. Web Service** . Сценарий, в котором может потребоваться включить конечные точки службы в приложении, но не подсеть, зависит главным образом от наличия разрешений на их включение в подсети. 

Если требуется, чтобы другие пользователи включили конечные точки службы в подсети, установите флажок **игнорировать отсутствующие конечные точки Microsoft. Web Service** . Приложение будет настроено для конечных точек службы, чтобы они были включены позже в подсети. 

![Снимок экрана: панель "Добавление ограничения IP-адресов" с выбранным типом виртуальной сети.](../app-service/media/app-service-ip-restrictions/access-restrictions-vnet-add.png)

Конечные точки службы нельзя использовать для ограничения доступа к приложениям, выполняемым в Среда службы приложений. Когда приложение находится в Среда службы приложений, вы можете управлять доступом к нему, применяя правила IP-доступа. 

Чтобы узнать, как настроить конечные точки службы, см. раздел [Установка функций Azure для доступа к частным сайтам](functions-create-private-site-access.md).

## <a name="private-endpoint-connections"></a>Подключения к частным конечным точкам

[!INCLUDE [functions-private-site-access](../../includes/functions-private-site-access.md)]

Чтобы вызвать другие службы, имеющие подключение к частной конечной точке, например хранилище или служебную шину, обязательно настройте приложение для выполнения [исходящих вызовов к частным конечным точкам](#private-endpoints).

## <a name="virtual-network-integration"></a>Интеграция виртуальной сети

Интеграция виртуальной сети позволяет приложению-функции получить доступ к ресурсам внутри виртуальной сети.
Функции Azure поддерживают два вида интеграции виртуальной сети:

[!INCLUDE [app-service-web-vnet-types](../../includes/app-service-web-vnet-types.md)]

Интеграция виртуальной сети в Функциях Azure использует общую инфраструктуру с веб-приложениями Службы приложений. Дополнительные сведения о двух типах интеграции виртуальной сети см. в следующих статьях:

* [Интеграция региональной виртуальной сети](../app-service/web-sites-integrate-with-vnet.md#regional-vnet-integration)
* [Интеграция виртуальной сети, необходимой шлюзу](../app-service/web-sites-integrate-with-vnet.md#gateway-required-vnet-integration)

Сведения о настройке интеграции виртуальной сети см. в статье [Integrate a function app with an Azure virtual network](functions-create-vnet.md) (Интеграция приложения-функции с виртуальной сетью Azure).

## <a name="regional-virtual-network-integration"></a>Интеграция региональной виртуальной сети

[!INCLUDE [app-service-web-vnet-types](../../includes/app-service-web-vnet-regional.md)]

## <a name="connect-to-service-endpoint-secured-resources"></a>Подключитесь к защищенным ресурсам конечной точки службы

Чтобы обеспечить более высокий уровень безопасности, можно ограничить число служб Azure для виртуальной сети, используя конечные точки служб. Затем необходимо интегрировать приложение-функцию с этой виртуальной сетью, чтобы получить доступ к ресурсу. Эта конфигурация поддерживается во всех планах, которые поддерживают интеграцию виртуальной сети.

Дополнительные сведения см. в статье [Конечные точки служб для виртуальной сети](../virtual-network/virtual-network-service-endpoints-overview.md).

## <a name="restrict-your-storage-account-to-a-virtual-network"></a>Ограничьте учетную запись хранения виртуальной сети 

Когда вы создаете приложения-функции, необходимо создать или привязать учетную запись хранения Azure общего назначения, поддерживающую хранилища BLOB-объектов, очередей и таблиц.  Эту учетную запись хранения можно заменить на ту, которая защищена конечными точками службы или частной конечной точкой.  В настоящее время эта функция работает только для всех номеров SKU, поддерживаемых в виртуальной сети, включая "Стандартный" и "Премиум", за исключением отметок гибкости, в которых виртуальная сеть доступна только для SKU Чтобы настроить функцию с учетной записью хранения, которая ограничена частной сетью, выполните следующие действия.

1. Создайте функцию с учетной записью хранения, в которой не включены конечные точки службы.
1. Настройте функцию для подключения к виртуальной сети.
1. Создайте или настройте другую учетную запись хранения.  Это будет учетная запись хранения, защищенная с помощью конечных точек службы, и подключается к нашей функции.
1. [Создайте общую папку](../storage/files/storage-how-to-create-file-share.md#create-file-share) в защищенной учетной записи хранения.
1. Включите конечные точки службы или закрытую конечную точку для учетной записи хранения.  
    * При использовании подключений к частным конечным точкам учетной записи хранения потребуется частная конечная точка для `file` и `blob` подресурсов.  При использовании определенных возможностей, таких как Устойчивые функции, также требуются `queue` и `table` доступны через подключение частной конечной точки.
    * При использовании конечных точек службы включите подсеть, выделенную для приложений функций для учетных записей хранения.
1. Используемых Скопируйте файл и содержимое большого двоичного объекта из учетной записи хранения приложения-функции в защищенную учетную запись хранения и общую папку.
1. Скопируйте строку подключения для этой учетной записи хранения.
1. Обновите **Параметры приложения** в разделе **Конфигурация** для приложения функции следующим образом:
    - `AzureWebJobsStorage` в строку подключения для защищенной учетной записи хранения.
    - `WEBSITE_CONTENTAZUREFILECONNECTIONSTRING` в строку подключения для защищенной учетной записи хранения.
    - `WEBSITE_CONTENTSHARE` в имя общей папки, созданной в защищенной учетной записи хранения.
    - Создайте новый параметр с именем `WEBSITE_CONTENTOVERVNET` и значением `1` .
    - Если учетная запись хранения использует подключения частной конечной точки, проверьте или добавьте следующие параметры.
        - `WEBSITE_VNET_ROUTE_ALL` со значением `1` .
        - `WEBSITE_DNS_SERVER` со значением `168.63.129.16` 
1. Сохраните параметры приложения.  

Приложение-функция будет перезапущено и теперь будет подключено к защищенной учетной записи хранения.

## <a name="use-key-vault-references"></a>Использование возможностей Key Vault

Вы можете использовать возможности Azure Key Vault, чтобы извлекать секреты из Azure Key Vault в приложении Функций Azure без каких-либо изменений кода. Azure Key Vault — это служба, которая обеспечивает централизованное управление секретами и полный контроль над политиками доступа и журналами аудита.

В настоящее время [возможности Key Vault](../app-service/app-service-key-vault-references.md) не будут работать, если хранилище ключей защищено с помощью конечных точек службы. Чтобы подключиться к хранилищу ключей, используя интеграцию с виртуальной сетью, необходимо вызвать Key Vault в коде приложения.

## <a name="virtual-network-triggers-non-http"></a>Триггеры виртуальной сети (без HTTP)

В настоящее время вы можете использовать функции триггеров, отличных от HTTP, из виртуальной сети одним из двух способов:

+ Запустите приложение-функцию в плане категории "Премиум" и включите поддержку триггеров виртуальной сети.
+ Запустите ваше приложение-функцию в плане службы приложений или в среде службы приложений.

### <a name="premium-plan-with-virtual-network-triggers"></a>План категории "Премиум" с триггерами виртуальной сети

При запуске плана категории "Премиум" можно подключать функции триггеров, отличных от HTTP, к службам, выполняемым внутри виртуальной сети. Для этого необходимо включить поддержку триггеров виртуальной сети для приложения-функции. Параметр **мониторинга масштаба среды выполнения** находится в [портал Azure](https://portal.azure.com) в разделе   >  **Параметры среды выполнения функции** конфигурации.

:::image type="content" source="media/functions-networking-options/virtual-network-trigger-toggle.png" alt-text="VNETToggle":::

Также можно включить триггеры виртуальной сети, используя следующую команду Azure CLI:

```azurecli-interactive
az resource update -g <resource_group> -n <function_app_name>/config/web --set properties.functionsRuntimeScaleMonitoringEnabled=1 --resource-type Microsoft.Web/sites
```

> [!TIP]
> Включение триггеров виртуальной сети может оказать влияние на производительность приложения, так как экземпляры плана службы приложений должны отслеживать триггеры, чтобы определить, когда следует масштабировать. Это воздействие, скорее всего, будет очень небольшим.

Триггеры виртуальной сети поддерживаются в версии 2. x и более поздних версиях среды выполнения Функций. Поддерживаются следующие типы триггеров, отличных от HTTP.

| Расширение | Минимальная версия |
|-----------|---------| 
|[Microsoft.Azure.WebJobs.Extensions.Storage](https://www.nuget.org/packages/Microsoft.Azure.WebJobs.Extensions.Storage/) | 3.0.10 или новее |
|[Microsoft.Azure.WebJobs.Extensions.EventHubs](https://www.nuget.org/packages/Microsoft.Azure.WebJobs.Extensions.EventHubs)| 4.1.0 или новее|
|[Microsoft.Azure.WebJobs.Extensions.ServiceBus](https://www.nuget.org/packages/Microsoft.Azure.WebJobs.Extensions.ServiceBus)| 3.2.0 или новее|
|[Microsoft.Azure.WebJobs.Extensions.CosmosDB](https://www.nuget.org/packages/Microsoft.Azure.WebJobs.Extensions.CosmosDB)| 3.0.5 или новее|
|[Microsoft.Azure.WebJobs.Extensions.DurableTask](https://www.nuget.org/packages/Microsoft.Azure.WebJobs.Extensions.DurableTask)| 2.0.0 или новее|

> [!IMPORTANT]
> Когда вы подключаете поддержку триггеров виртуальной сети, с приложением динамично масштабируются только те виды триггеров, которые показаны в предыдущей таблице. Вы по-прежнему можете использовать триггеры, которых нет в таблице, но они не масштабируются за пределы предварительных чисел экземпляров. Полный список триггеров см. в разделе [Триггеры и привязки](./functions-triggers-bindings.md#supported-bindings).

### <a name="app-service-plan-and-app-service-environment-with-virtual-network-triggers"></a>План службы приложений и среда службы приложений с триггерами виртуальной сети

При запуске приложения-функции в плане службы приложений или Среде службы приложений можно использовать функции триггера, отличного от HTTP. Для правильной активации функций, вам необходимо подключение к виртуальной сети с доступом к ресурсу, определенному в подключении триггера.

Например, предположим, что вам нужно настроить Azure Cosmos DB для приема трафика только из виртуальной сети. В этом случае приложение-функцию необходимо развернуть в плане службы приложений, который обеспечивает интеграцию виртуальной сети с этой виртуальной сетью. Интеграция включает функцию, чтобы она была активирована через ресурс Azure Cosmos DB.

## <a name="hybrid-connections"></a>Гибридные подключения

[Гибридные подключения](../azure-relay/relay-hybrid-connections-protocol.md) — это функция Azure Relay, которую можно использовать для доступа к ресурсам приложения в других сетях. Они обеспечивают доступ из вашего приложения к конечной точке приложения. Она не может быть использована для доступа к приложению. Гибридные подключения доступны для функций, которые везде работают в Windows, кроме плана потребления.

При использовании в Функциях Azure каждое гибридное подключение коррелирует с одной комбинацией узла TCP и TCP-порта. Это означает, что конечная точка гибридного подключения может быть размещена в любой операционной системе и приложении, пока вы предоставляете доступ к TCP-порту прослушивания. Гибридным подключениям не важен используемый протокол приложения или ресурсы, к которым вы обращаетесь. Они просто предоставляют доступ к сети.

Дополнительные сведения см. в [App Service documentation for Hybrid Connections](../app-service/app-service-hybrid-connections.md) (Документация по Службе приложений для гибридных подключений). Эти же шаги конфигурации поддерживают Функции Azure.

>[!IMPORTANT]
> Гибридные подключения поддерживаются только в планах Windows. ОС Linux не поддерживается.

## <a name="outbound-ip-restrictions"></a>Ограничения исходящих IP-адресов

Ограничения исходящих IP-адресов доступны в плане категории "Премиум", в плане службы приложений или Среде службы приложений. Вы можете настроить ограничения исходящего трафика для виртуальной сети, в которой развернута Среда службы приложений.

При интеграции приложения-функции в плане категории "Премиум" или плане службы приложений с виртуальной сетью приложение по умолчанию может выполнять исходящие вызовы через Интернет. Добавив параметр приложения `WEBSITE_VNET_ROUTE_ALL=1`, вы принудительно передаете весь исходящий трафик в виртуальную сеть, где могут использоваться правила группы безопасности сети для ограничения трафика.

## <a name="automation"></a>Служба автоматизации
Следующие API позволяют программно управлять региональной интеграцией виртуальной сети.

+ **Azure CLI**. Используйте [`az functionapp vnet-integration`](/cli/azure/functionapp/vnet-integration) команды для добавления, перечисления или удаления региональной интеграции виртуальной сети.  
+ **Шаблоны ARM**. интеграция региональной виртуальной сети можно включить с помощью шаблона Azure Resource Manager. Полный пример см. в разделе [шаблон](https://azure.microsoft.com/resources/templates/101-function-premium-vnet-integration/)быстрого запуска функций.

## <a name="troubleshooting"></a>Устранение неполадок

[!INCLUDE [app-service-web-vnet-troubleshooting](../../includes/app-service-web-vnet-troubleshooting.md)]

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о сети и Функциях Azure:

* [Следуйте руководству по началу работы с интеграцией виртуальной сети](./functions-create-vnet.md)
* [Прочтите часто задаваемые вопросы по функциям сети](./functions-networking-faq.md)
* [Узнайте больше об интеграции приложения виртуальной сети со Службой приложений и Функциями](../app-service/web-sites-integrate-with-vnet.md)
* [Узнайте больше о виртуальных сетях в Azure](../virtual-network/virtual-networks-overview.md)
* [Общие сведения о функциях сети и Средах службы приложений](../app-service/environment/intro.md)
* [Подключитесь к индивидуальным локальным ресурсам без изменений в брандмауэре, используя гибридные подключения](../app-service/app-service-hybrid-connections.md)
