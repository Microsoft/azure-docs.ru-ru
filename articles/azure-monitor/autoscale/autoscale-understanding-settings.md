---
title: Общие сведения о параметрах автомасштабирования в Azure Monitor
description: 'Подробный разбор настроек автомасштабирования и принципов их работы. Эта статья касается таких служб: Виртуальные машины , Облачные службы и Веб-приложения.'
ms.topic: conceptual
ms.date: 12/18/2017
ms.subservice: autoscale
ms.openlocfilehash: a914f6d71c013acea8dfde0f6578985bc009bb26
ms.sourcegitcommit: e559daa1f7115d703bfa1b87da1cf267bf6ae9e8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/17/2021
ms.locfileid: "100623808"
---
# <a name="understand-autoscale-settings"></a>Основные сведения о параметрах автомасштабирования
С помощью параметров автомасштабирования можно настроить объем ресурсов, необходимый для управления колеблющейся нагрузкой приложения. Вы можете настроить активацию параметров автомасштабирования при достижении метрик нагрузки или производительности или запланировать дату и время активации. В этой статье подробно описывается настройка автомасштабирования. В начале статьи предоставлены схема и свойства параметров, а затем — различные типы профилей, которые можно настроить. В этой статье также рассматривается, как функция автоматического масштабирования в Azure вычисляет профиль, который необходимо выполнить в заданное время.

## <a name="autoscale-setting-schema"></a>Схема настройки автомасштабирования
Чтобы показать схему настройки, используются следующие параметры автомасштабирования. Важно, что у этих параметров:
- Один профиль. 
- В этом профиле два правила метрик. Одно правило задает горизонтальное масштабирование, а другое — уменьшение масштаба.
  - Правило горизонтального масштабирования применяется, когда среднее значение метрики "Загрузка ЦП" для масштабируемого набора виртуальных машин превышает 85 процентов на протяжении 10 минут.
  - Правило уменьшения масштаба действует, когда этот параметр меньше 60 процентов на протяжении одной минуты.

> [!NOTE]
> У каждого параметра может быть несколько профилей. Дополнительные сведения см. в разделе [Автомасштабирование профилей](#autoscale-profiles). Для профиля также может быть определено несколько правил горизонтального масштабирования и уменьшения масштаба. Способ их оценки см. в разделе [Оценка автомасштабирования](#autoscale-evaluation).

```JSON
{
  "id": "/subscriptions/s1/resourceGroups/rg1/providers/microsoft.insights/autoscalesettings/setting1",
  "name": "setting1",
  "type": "Microsoft.Insights/autoscaleSettings",
  "location": "East US",
  "properties": {
    "enabled": true,
    "targetResourceUri": "/subscriptions/s1/resourceGroups/rg1/providers/Microsoft.Compute/virtualMachineScaleSets/vmss1",
    "profiles": [
      {
        "name": "mainProfile",
        "capacity": {
          "minimum": "1",
          "maximum": "4",
          "default": "1"
        },
        "rules": [
          {
            "metricTrigger": {
              "metricName": "Percentage CPU",
              "metricResourceUri": "/subscriptions/s1/resourceGroups/rg1/providers/Microsoft.Compute/virtualMachineScaleSets/vmss1",
              "timeGrain": "PT1M",
              "statistic": "Average",
              "timeWindow": "PT10M",
              "timeAggregation": "Average",
              "operator": "GreaterThan",
              "threshold": 85
            },
            "scaleAction": {
              "direction": "Increase",
              "type": "ChangeCount",
              "value": "1",
              "cooldown": "PT5M"
            }
          },
          {
            "metricTrigger": {
              "metricName": "Percentage CPU",
              "metricResourceUri": "/subscriptions/s1/resourceGroups/rg1/providers/Microsoft.Compute/virtualMachineScaleSets/vmss1",
              "timeGrain": "PT1M",
              "statistic": "Average",
              "timeWindow": "PT10M",
              "timeAggregation": "Average",
              "operator": "LessThan",
              "threshold": 60
            },
            "scaleAction": {
              "direction": "Decrease",
              "type": "ChangeCount",
              "value": "1",
              "cooldown": "PT5M"
            }
          }
        ]
      }
    ]
  }
}
```

| Section | Имя элемента | Описание |
| --- | --- | --- |
| Параметр | ID | Идентификатор ресурса параметров автомасштабирования. Параметры автомасштабирования относятся к ресурсам Azure Resource Manager. |
| Параметр | name | Имя параметра автомасштабирования. |
| Параметр | location | Расположение параметра автомасштабирования. Оно может отличаться от расположения масштабируемого ресурса. |
| properties | targetResourceUri | Идентификатор масштабируемого ресурса. У одного ресурса может быть только один раздел параметров автомасштабирования. |
| properties | profiles | Параметры автомасштабирования включают в себя один или несколько профилей. При каждом запуске система автомасштабирования выполняет один профиль. |
| профиль | name | Имя профиля. Для него можно указать любое имя, позволяющее отличить профиль от других. |
| профиль | Capacity.maximum | Максимальный разрешенный объем. Обеспечивает, чтобы во время автомасштабирования при выполнении этого профиля объем ресурса не превышал это число. |
| профиль | Capacity.minimum | Минимальный разрешенный объем. Обеспечивает, чтобы во время автомасштабирования при выполнении этого профиля объем ресурса не снижался ниже этого числа. |
| профиль | Capacity.default | Если возникнут проблемы чтения метрик ресурсов (в этом случае — ЦП "vmss1") и текущий объем будет меньше, чем по умолчанию, механизм автомасштабирования выполнит масштабирование до значения по умолчанию. Это необходимо, чтобы обеспечить доступность ресурса. Если текущий объем превышает значение по умолчанию, количество экземпляров автомасштабирования не уменьшается. |
| профиль | правила | Механизм автомасштабирования автоматически уменьшает и увеличивает емкость путем использования правил в профиле. В профиле может быть несколько правил. Обычно имеется два правила: одно применяется, когда необходимо горизонтальное масштабирование, а другое — когда нужно уменьшить масштаб. |
| правило | metricTrigger | Определяет условие метрики для правила. |
| metricTrigger | metricName | Имя метрики. |
| metricTrigger |  metricResourceUri | Идентификатор ресурса, выдающего эту метрику. В большинстве случаев он совпадает с именем масштабируемого ресурса. Иногда имя и идентификатор отличаются. Например, когда нужно масштабировать набор виртуальных машин по количеству сообщений в очереди хранилища. |
| metricTrigger | timeGrain | Продолжительность выборки метрик. Например, **TimeGrain = "PT1M"** означает, что метрики будут агрегироваться каждую минуту с помощью метода, указанного в элементе statistic. |
| metricTrigger | statistic | Метод агрегирования, используемый в течение периода timeGrain. Например, **statistic = "Average"** и **TimeGrain = "PT1M"** означают, что метрики будут агрегироваться каждую минуту путем определения среднего значения. Это свойство определяет порядок выборки метрики. |
| metricTrigger | timeWindow | Время для ретроспективного поиска метрик. Например, **timeWindow = "PT10M"** означает, что при каждом запуске механизм автомасштабирования будет запрашивать метрики за последние 10 минут. Этот временной интервал позволяет нормализовать метрики и избежать реакций на переходные всплески. |
| metricTrigger | timeAggregation | Метод агрегирования метрик выборки. Например, **TimeAggregation = "Average"** значит, что метрика будет агрегироваться путем определения среднего значения. В предыдущем примере выполнены 10 выборок по 1 минуте, а затем определено их среднее значение. |
| правило | scaleAction | Действие, выполняемое при активации параметра metricTrigger правила. |
| scaleAction | direction | "Increase" — для горизонтального масштабирования, а "Decrease" — для уменьшения масштаба.|
| scaleAction | value | Емкость, до которой нужно увеличить или уменьшить ресурс. |
| scaleAction | cooldown | Время ожидания следующего масштабирования после аналогичной операции. К примеру, если применяется свойство **cooldown = "PT10M"**, то задание автомасштабирования не будет пытаться выполнить операцию масштабирования 10 минут. Свойство cooldown предназначено для стабилизации метрик после добавления или удаления экземпляров. |

## <a name="autoscale-profiles"></a>Профили автомасштабирования

Есть три типа профилей автомасштабирования:

- **Регулярный профиль.** Самый распространенный. Регулярный профиль можно использовать, если не нужно масштабировать ресурс по дню недели или определенному дню. Этот профиль можно настроить, используя правила метрик, определяющие, когда масштабировать ресурс горизонтально, а когда уменьшать масштаб. Регулярный профиль должен быть только один.

    Пример профиля, приведенный ранее в этой статье, принадлежит к регулярному типу. Обратите внимание, что в профиле также можно задать масштабирование до количества статических экземпляров в ресурсе.

- **Профиль с фиксированной датой.** Предназначен для особых случаев. Например, предположим, что на 26 декабря 2017 г. (по тихоокеанскому времени) вы запланировали важное событие. Требуется, чтобы в этот день минимальная и максимальная емкость ресурса отличались, но масштабирование производилось на основе тех же метрик. В таком случае вам необходимо добавить профиль с фиксированной датой в список параметров профиля. Такой профиль настраивают только для выполнения в день события. В остальные дни для автомасштабирования будет использоваться регулярный профиль.

    ```json
    "profiles": [
        {
            "name": " regularProfile",
            "capacity": {
                ...
            },
            "rules": [
                {
                ...
                },
                {
                ...
                }
            ]
        },
        {
            "name": "eventProfile",
            "capacity": {
            ...
            },
            "rules": [
                {
                ...
                }, 
                {
                ...
                }
            ],
            "fixedDate": {
                "timeZone": "Pacific Standard Time",
                "start": "2017-12-26T00:00:00",
                "end": "2017-12-26T23:59:00"
            }
        }
    ]
    ```
    
- **Профиль повторения.** Профиль этого типа позволяет вам настроить выполнение всегда в определенный день недели. Для профилей повторения задается только время начала. Они выполняются до тех пор, пока следующий профиль повторения или профиль с фиксированной датой не будет настроен для запуска. Параметры автомасштабирования только с одним профилем повторения выполняют этот профиль, даже если в них определен регулярный профиль. В следующих двух примерах показано, как используется этот профиль.

    **Пример 1. Рабочие и выходные дни**
    
    Предположим, что по выходным максимальная емкость должна быть 4. Предполагается, что нагрузка будет большей в рабочие дни, поэтому для них максимальная емкость должна быть 10. Тогда нужно, чтобы в настройках было два профиля повторения: один, запускаемый по выходным, а другой — по рабочим дням.
    Параметры выглядят следующим образом.

    ``` JSON
    "profiles": [
    {
    "name": "weekdayProfile",
    "capacity": {
        ...
    },
    "rules": [{
        ...
    }],
    "recurrence": {
        "frequency": "Week",
        "schedule": {
            "timeZone": "Pacific Standard Time",
            "days": [
                "Monday"
            ],
            "hours": [
                0
            ],
            "minutes": [
                0
            ]
        }
    }}
    },
    {
    "name": "weekendProfile",
    "capacity": {
        ...
    },
    "rules": [{
        ...
    }]
    "recurrence": {
        "frequency": "Week",
        "schedule": {
            "timeZone": "Pacific Standard Time",
            "days": [
                "Saturday"
            ],
            "hours": [
                0
            ],
            "minutes": [
                0
            ]
        }
    }
    }]
    ```

    В предыдущих параметрах показано, что для каждого профиля повторения имеется расписание, в котором определено время выполнения профиля. Выполнение профиля останавливается, когда наступает время запуска другого профиля.

    Например, в предыдущих параметрах профиль weekdayProfile настроен для запуска в понедельник в 00:00. Это означает, что этот профиль начнет выполняться в понедельник в 00:00 и будет выполняться до 00:00 субботы (времени, настроенного для запуска weekendProfile).

    **Пример 2. Рабочие часы**
    
    Предположим, что вы хотите использовать одно пороговое значение метрики в рабочие часы (с 9:00 до 17:00), и другое — в нерабочее время. Параметры будут выглядеть так:
    
    ``` JSON
    "profiles": [
    {
    "name": "businessHoursProfile",
    "capacity": {
        ...
    },
    "rules": [{
        ...
    }],
    "recurrence": {
        "frequency": "Week",
        "schedule": {
            "timeZone": "Pacific Standard Time",
            "days": [
                "Monday", “Tuesday”, “Wednesday”, “Thursday”, “Friday”
            ],
            "hours": [
                9
            ],
            "minutes": [
                0
            ]
        }
    }
    },
    {
    "name": "nonBusinessHoursProfile",
    "capacity": {
        ...
    },
    "rules": [{
        ...
    }]
    "recurrence": {
        "frequency": "Week",
        "schedule": {
            "timeZone": "Pacific Standard Time",
            "days": [
                "Monday", “Tuesday”, “Wednesday”, “Thursday”, “Friday”
            ],
            "hours": [
                17
            ],
            "minutes": [
                0
            ]
        }
    }
    }]
    ```
    
    В предыдущих параметрах показано, что businessHoursProfile выполняется в понедельник с 9:00 до 17:00. Именно в это время начинается выполнение nonBusinessHoursProfile. nonBusinessHoursProfile выполняется до 9:00 вторника, а затем начинается выполнение businessHoursProfile. Этот процесс завершается в 17:00 в пятницу. На этом этапе nonBusinessHoursProfile выполняется до 9:00 понедельника.
    
> [!Note]
> Автомасштабирование пользовательского интерфейса на портале Azure предусматривает время принудительного завершения для профилей повторения, после чего между ними выполняется профиль параметров автомасштабирования по умолчанию.
    
## <a name="autoscale-evaluation"></a>Оценка автомасштабирования
В параметрах автомасштабирования может быть несколько профилей, в каждом из которых может содержаться несколько правил метрик, поэтому важно понимать, как оцениваются параметры. Каждое выполнение задания автомасштабирования начинается с выбора профиля, к которому оно применимо. Затем механизм автомасштабирования вычисляет минимальное и максимальное значения и правила метрик в профиле, а затем решает, требуется ли масштабирование.

### <a name="which-profile-will-autoscale-pick"></a>Какой профиль выберет механизм автомасштабирования

Для выбора профиля задание автомасштабирования использует следующую последовательность.
1. Вначале выполняется поиск профиля с фиксированной датой, выполнение которого запланировано на данное время. Если такой имеется, начинается его выполнение. Если имеется несколько профилей, подлежащих выполнению, механизм автомасштабирования выбирает первый.
2. При отсутствии профиля с фиксированной датой выполняется поиск профилей повторения. И если такой профиль имеется, он будет выполнен.
3. Если нет профилей с фиксированной датой или профилей повторения, при автомасштабировании будет выполняться регулярный профиль.

### <a name="how-does-autoscale-evaluate-multiple-rules"></a>Как оцениваются несколько правил при автомасштабировании

После определения нужного профиля начинается оценка всех правил горизонтального масштабирования в нем (это правила с параметром **direction = "Increase"**).

При активации одного или нескольких правил горизонтального масштабирования механизм автомасштабирования вычисляет новое значение емкости, определенное с помощью параметра **scaleAction** в каждом из этих правил. Затем происходит максимальное горизонтальное масштабирование емкости, чтобы обеспечить доступность службы.

Например, предположим, что имеется масштабируемый набор виртуальных машин с текущим размером 10. Имеется два правила горизонтального масштабирования: одно — для увеличения емкости на 10 процентов, а другое — в 3 раза. После применения первого правила новое значение объема будет равно 11, а после второго — 13. Чтобы убедиться в доступности службы, механизм автомасштабирования выберет действие, которое максимально увеличит объем, что соответствует второму правилу.

Если правила горизонтального масштабирования не будут активированы, система автомасштабирования оценит все правила уменьшения масштаба (правила с параметром **direction = "Decrease"**). При автомасштабировании действие уменьшения объема выполняется, только если активированы все правила уменьшения масштаба.

Механизм автомасштабирования вычисляет новое значение емкости, определенное с помощью параметра **scaleAction** в каждом из этих правил. Затем он выбирает действие масштабирования, максимально увеличивающее емкость, чтобы обеспечить доступность службы.

Например, предположим, что имеется масштабируемый набор виртуальных машин с текущим размером 10. Имеется два правила уменьшения масштаба: одно снижает емкость на 50 процентов, а другое — в 3 раза. После применения первого правила новое значение объема будет равно 5, а после второго — 7. Чтобы убедиться в доступности службы, механизм автомасштабирования выберет действие, которое максимально увеличит объем, что соответствует второму правилу.

## <a name="next-steps"></a>Дальнейшие шаги
Дополнительные сведения об автомасштабировании см. в следующих статьях:

* [Обзор автомасштабирования](./autoscale-overview.md)
* [Общие метрики автомасштабирования Azure Monitor](./autoscale-common-metrics.md)
* [Рекомендации по автомасштабированию в Azure Monitor](./autoscale-best-practices.md)
* [Использование действий автомасштабирования для отправки электронной почты и уведомлений об оповещениях веб-перехватчика в Azure Insights](./autoscale-webhook-email.md)
* [Create or update an autoscale setting in Azure Insights REST API (Создание и изменение параметров автомасштабирования в REST API Azure Insights)](/rest/api/monitor/autoscalesettings)

