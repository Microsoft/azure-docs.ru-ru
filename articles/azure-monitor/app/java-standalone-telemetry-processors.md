---
title: Обработчики данных телеметрии (Предварительная версия) — Azure Monitor Application Insights для Java
description: Настройка обработчиков данных телеметрии в Azure Monitor Application Insights для Java
ms.topic: conceptual
ms.date: 10/29/2020
author: kryalama
ms.custom: devx-track-java
ms.author: kryalama
ms.openlocfilehash: ba4e6b8b5e9db494ab4c0c372c2086087a2d58cb
ms.sourcegitcommit: 431bf5709b433bb12ab1f2e591f1f61f6d87f66c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/12/2021
ms.locfileid: "98133180"
---
# <a name="telemetry-processors-preview---azure-monitor-application-insights-for-java"></a>Обработчики данных телеметрии (Предварительная версия) — Azure Monitor Application Insights для Java

> [!NOTE]
> Эта функция по-прежнему находится в предварительной версии.

Агент Java 3,0 для Application Insights теперь имеет возможности обработки данных телеметрии перед экспортом данных.

Ниже приведены некоторые случаи использования обработчиков данных телеметрии.
 * Маскирование конфиденциальных данных
 * Условно добавить пользовательские измерения
 * Обновление имени телеметрии, используемого для агрегирования и вывода
 * Удаление или фильтрация атрибутов span для управления стоимостью приема

## <a name="terminology"></a>Терминология

Прежде чем перейти к обработчикам телеметрии, важно понять, что такое трассировка и охват.

### <a name="traces"></a>Трассировки

Трассировки отслеживают ход выполнения одного запроса, называемого `trace` , так как он обрабатывается службами, которые составляют приложение. Запрос может быть инициирован пользователем или приложением. Каждая единица работы в вызывается `trace` как a `span` ; а `trace` — это дерево диапазонов. `trace`Состоит из единственного корневого диапазона и любого количества дочерних диапазонов.

### <a name="span"></a>Размещать

Диапазоны — это объекты, представляющие работу, выполняемую отдельными службами или компонентами, вовлеченными в запрос по мере их последовательного выполнения в системе. Объект `span` содержит объект `span context` , который представляет собой набор глобальных уникальных идентификаторов, представляющих уникальный запрос, частью которого является каждый диапазон. 

Диапазоны инкапсулируют:

* Имя диапазона
* Неизменяемое выражение `SpanContext` , однозначно идентифицирующее диапазон
* Родительский диапазон в форме `Span` , `SpanContext` или null
* `SpanKind`
* Метка времени начала
* Метка времени окончания
* [`Attributes`](#attributes)
* Список событий с отметкой времени
* Объект `Status`.

Как правило, жизненный цикл диапазона выглядит следующим образом:

* Запрос получен службой. Контекст span извлекается из заголовков запроса, если он существует.
* Новый диапазон создается как дочерний для извлеченного контекста span; Если не существует, создается новый корневой диапазон.
* Служба обрабатывает запрос. К диапазону добавляются дополнительные атрибуты и события, которые полезны для понимания контекста запроса, например имя узла компьютера, обрабатывающего запрос, или идентификаторы клиентов.
* Для представления работы, выполняемой подкомпонентами службы, можно создать новые диапазоны.
* Когда служба выполняет удаленный вызов другой службы, контекст текущего диапазона сериализуется и пересылается следующей службе путем добавления контекста span в заголовки или конверт сообщения.
* Работа, выполняемая службой, завершается успешно или нет. Состояние span устанавливается соответствующим образом, и диапазон отмечается как завершенный.

### <a name="attributes"></a>Атрибуты

`Attributes` список из нуля или более пар "ключ-значение", инкапсулированных в `span` . Атрибут должен иметь следующие свойства:

Ключ атрибута, который должен быть не пустой строкой и содержать непустые строки.
Значение атрибута, которое может иметь одно из следующих значений:
* Тип-примитив: String, Boolean, float с плавающей запятой (IEEE 754-1985) или 64 разрядного целого числа со знаком.
* Массив значений типа-примитива. Массив должен быть однородным, т. е. он не должен содержать значения различных типов. Для протоколов, которые изначально не поддерживают значения массивов, такие значения должны быть представлены в виде строк JSON.

## <a name="supported-processors"></a>Поддерживаемые процессоры:
 * Обработчик атрибутов
 * Охват процессора

## <a name="to-get-started"></a>Начало работы

Создайте файл конфигурации с именем `applicationinsights.json` и поместите его в тот же каталог, что и в `applicationinsights-agent-***.jar` следующем шаблоне.

```json
{
  "connectionString": "InstrumentationKey=00000000-0000-0000-0000-000000000000",
  "preview": {
    "processors": [
      {
        "type": "attribute",
        ...
      },
      {
        "type": "attribute",
        ...
      },
      {
        "type": "span",
        ...
      }
    ]
  }
}
```

## <a name="includeexclude-spans"></a>Включить или исключить диапазоны

Обработчик атрибутов и процессор span предоставляют возможность предоставить набор свойств диапазона для сопоставления, чтобы определить, следует ли включать или исключать диапазон из обработчика данных телеметрии. Чтобы настроить этот параметр, `include` необходимо указать и (или `exclude` ) хотя бы один, `matchType` а также один из параметров `spanNames` или `attributes` . Конфигурация включения и исключения поддерживается для нескольких указанных условий. Все указанные условия должны иметь значение true, чтобы сопоставление было выполнено. 

**Обязательное поле**: 
* `matchType` управляет `spanNames` интерпретацией элементов в `attributes` массивах и. Возможные значения: `regexp` или `strict`. 

**Необязательные поля**: 
* `spanNames` должен совпадать по крайней мере с одним из элементов. 
* `attributes` Задает список атрибутов для сопоставления. Все эти атрибуты должны совпадать в точности для совпадений.

> [!NOTE]
> Если `include` указаны и `exclude` , и, `include` свойства проверяются перед `exclude` свойствами.

#### <a name="sample-usage"></a>Пример использования

```json

"processors": [
  {
    "type": "attribute",
    "include": {
      "matchType": "strict",
      "spanNames": [
        "spanA",
        "spanB"
      ]
    },
    "exclude": {
      "matchType": "strict",
      "attributes": [
        {
          "key": "redact_trace",
          "value": "false"
        }
      ]
    },
    "actions": [
      {
        "key": "credit_card",
        "action": "delete"
      },
      {
        "key": "duplicate_key",
        "action": "delete"
      }
    ]
  }
]
```
Дополнительные сведения см. в документации по [примерам обработчика телеметрии](./java-standalone-telemetry-processors-examples.md) .

## <a name="attribute-processor"></a>Обработчик атрибутов 

Обработчик атрибутов изменяет атрибуты диапазона. При необходимости она поддерживает возможность включения и исключения диапазонов. Он принимает список действий, которые выполняются в порядке, указанном в файле конфигурации. Поддерживаются следующие действия:

### `insert`

Вставляет новый атрибут в диапазоны, где ключ еще не существует.   

```json
"processors": [
  {
    "type": "attribute",
    "actions": [
      {
        "key": "attribute1",
        "value": "value1",
        "action": "insert"
      },
    ]
  }
]
```
Для `insert` действия требуется следующее.
  * `key`
  * один из `value` или `fromAttribute`
  * `action`:`insert`

### `update`

Обновляет атрибут в диапазоне, где существует ключ

```json
"processors": [
  {
    "type": "attribute",
    "actions": [
      {
        "key": "attribute1",
        "value": "newValue",
        "action": "update"
      },
    ]
  }
]
```
Для `update` действия требуется следующее.
  * `key`
  * один из `value` или `fromAttribute`
  * `action`:`update`


### `delete` 

Удаляет атрибут из диапазона.

```json
"processors": [
  {
    "type": "attribute",
    "actions": [
      {
        "key": "attribute1",
        "action": "delete"
      },
    ]
  }
]
```
Для `delete` действия требуется следующее.
  * `key`
  * `action`: `delete`

### `hash`

Хэши (SHA1) существующего значения атрибута

```json
"processors": [
  {
    "type": "attribute",
    "actions": [
      {
        "key": "attribute1",
        "action": "hash"
      },
    ]
  }
]
```
Для `hash` действия требуется следующее.
* `key`
* `action` : `hash`

### `extract`

> [!NOTE]
> Эта функция доступна только в 3.0.1 и более поздних версиях

Извлекает значения с помощью правила регулярного выражения из входного ключа в целевые ключи, указанные в правиле. Если целевой ключ уже существует, он будет переопределен. Он ведет себя аналогично параметру [Processor span](#extract-attributes-from-span-name) `toAttributes` с существующим атрибутом в качестве источника.

```json
"processors": [
  {
    "type": "attribute",
    "actions": [
      {
        "key": "attribute1",
        "pattern": "<regular pattern with named matchers>",
        "action": "extract"
      },
    ]
  }
]
```
Для `extract` действия требуется следующее.
* `key`
* `pattern`
* `action` : `extract`

Дополнительные сведения см. в документации по [примерам обработчика телеметрии](./java-standalone-telemetry-processors-examples.md) .

## <a name="span-processors"></a>Охват процессоров

Процессор span изменяет либо имя или атрибуты диапазона, исходя из имени диапазона. При необходимости она поддерживает возможность включения и исключения диапазонов.

### <a name="name-a-span"></a>Назовите диапазон

В разделе имени требуется следующий параметр:

* `fromAttributes`: Значение атрибута для ключей используется для создания нового имени в порядке, указанном в конфигурации. Все ключи атрибутов должны быть указаны в диапазоне процессора для его переименования.

При необходимости можно настроить следующий параметр:

* `separator`: Строка, которая указана, будет использоваться для разделения значений
> [!NOTE]
> Если переименование зависит от атрибутов, изменяемых обработчиком атрибутов, убедитесь, что процессор span указан после обработчика атрибутов в спецификации конвейера.

```json
"processors": [
  {
    "type": "span",
    "name": {
      "fromAttributes": [
        "attributeKey1",
        "attributeKey2",
      ],
      "separator": "::"
    }
  }
] 
```

### <a name="extract-attributes-from-span-name"></a>Извлечь атрибуты из имени диапазона

Принимает список регулярных выражений, чтобы соответствовать имени диапазона и извлекать из него атрибуты на основе части выражения. Должен быть указан в `toAttributes` разделе.

Требуются следующие параметры.

`rules` : Список правил для извлечения значений атрибутов из имени диапазона. Значения в имени диапазона заменяются извлеченными именами атрибутов. Каждое правило в списке является строкой шаблона регулярного выражения. Имя диапазона проверяется по регулярному выражению. Если регулярное выражение соответствует, все именованные части выражения Regex извлекаются как атрибуты и добавляются в диапазон. Каждое имя части выражения преобразуется в имя атрибута и сопоставленная часть выражения, которая преобразуется в значение атрибута. Сопоставленная часть в имени диапазона заменяется извлеченным именем атрибута. Если атрибуты уже существуют в диапазоне, они будут перезаписаны. Процесс повторяется для всех правил в том порядке, в котором они указаны. Каждое последующее правило работает с именем диапазона, которое является выходным результатом после обработки предыдущего правила.

```json

"processors": [
  {
    "type": "span",
    "name": {
      "toAttributes": {
        "rules": [
          "rule1",
          "rule2",
          "rule3"
        ]
      }
    }
  }
]

```

## <a name="list-of-attributes"></a>Список атрибутов

Ниже приведен список некоторых общих атрибутов span, которые можно использовать в обработчиках данных телеметрии.

### <a name="http-spans"></a>Диапазоны HTTP

| attribute  | Тип | Описание | 
|---|---|---|
| `http.method` | строка | Метод HTTP-запроса.|
| `http.url` | строка | Полный URL-адрес запроса HTTP в форме `scheme://host[:port]/path?query[#fragment]` . Обычно фрагмент не передается по протоколу HTTP, но если он известен, он должен быть включен.|
| `http.status_code` | number | [Код состояния ответа HTTP](https://tools.ietf.org/html/rfc7231#section-6).|
| `http.flavor` | строка | Тип используемого протокола HTTP |
| `http.user_agent` | строка | Значение заголовка [HTTP-агента пользователя](https://tools.ietf.org/html/rfc7231#section-5.5.3) , отправленное клиентом. |

### <a name="jdbc-spans"></a>Диапазоны JDBC

| attribute  | Тип | Описание  |
|---|---|---|
| `db.system` | строка | Идентификатор используемого продукта системы управления базами данных (СУБД). |
| `db.connection_string` | строка | Строка подключения, используемая для подключения к базе данных. Рекомендуется удалить внедренные учетные данные.|
| `db.user` | строка | Имя пользователя для доступа к базе данных. |
| `db.name` | строка | Этот атрибут используется для сообщения имени базы данных, к которой осуществляется доступ. Для команд, которые переключают базу данных, следует задать для нее целевую базу данных (даже если команда завершается ошибкой).|
| `db.statement` | строка | Выполняемая инструкция базы данных.|