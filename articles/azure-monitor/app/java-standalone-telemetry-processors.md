---
title: Обработчики данных телеметрии (Предварительная версия) — Azure Monitor Application Insights для Java
description: Настройка обработчиков данных телеметрии в Azure Monitor Application Insights для Java
ms.topic: conceptual
ms.date: 10/29/2020
author: kryalama
ms.custom: devx-track-java
ms.author: kryalama
ms.openlocfilehash: 39897e490e4653fbaad7a64ecc0b33f161d1264b
ms.sourcegitcommit: 16887168729120399e6ffb6f53a92fde17889451
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/13/2021
ms.locfileid: "98165796"
---
# <a name="telemetry-processors-preview---azure-monitor-application-insights-for-java"></a>Обработчики данных телеметрии (Предварительная версия) — Azure Monitor Application Insights для Java

> [!NOTE]
> Эта функция по-прежнему находится в предварительной версии.

Агент Java 3,0 для Application Insights теперь имеет возможности обработки данных телеметрии перед экспортом данных.

Ниже приведены некоторые случаи использования обработчиков данных телеметрии.
 * Маскирование конфиденциальных данных
 * Условно добавить пользовательские измерения
 * Обновите имя, используемое для агрегирования и вывода в портал Azure
 * Удаление атрибутов span для управления стоимостью приема

## <a name="terminology"></a>Терминология

Прежде чем перейти к обработчикам данных телеметрии, важно понять, к чему относится диапазон терминов.

Диапазон — это общий термин для любого из трех элементов:

* Входящий запрос
* Исходящая зависимость (например, удаленный вызов к другой службе);
* Внутрипроцессный набор зависимостей (например, работа, выполняемая подкомпонентами службы)

Для обработчиков телеметрии важны следующие компоненты диапазона:

* Имя
* Атрибуты

Имя диапазона является основным отображением, используемым для запросов и зависимостей в портал Azure.

Атрибуты span представляют стандартные и пользовательские свойства заданного запроса или зависимости.

## <a name="telemetry-processor-types"></a>Типы обработчиков данных телеметрии

В настоящее время существует два типа обработчиков данных телеметрии.

#### <a name="attribute-processor"></a>Обработчик атрибутов

Обработчик атрибутов имеет возможность вставлять, обновлять, удалять или создавать хэш-атрибуты.
Он также может извлекать (через регулярное выражение) один или несколько новых атрибутов из существующего атрибута.

#### <a name="span-processor"></a>Охват процессора

Обработчик span имеет возможность обновить имя телеметрии.
Он также может извлекать (через регулярное выражение) один или несколько новых атрибутов из имени диапазона.

> [!NOTE]
> Обратите внимание, что в настоящее время обработчики данных телеметрии обрабатывают только атрибуты строкового типа и не обрабатывают атрибуты типа Boolean или Number.

## <a name="getting-started"></a>Начало работы

Создайте файл конфигурации с именем `applicationinsights.json` и поместите его в тот же каталог, что и в `applicationinsights-agent-*.jar` следующем шаблоне.

```json
{
  "connectionString": "InstrumentationKey=00000000-0000-0000-0000-000000000000",
  "preview": {
    "processors": [
      {
        "type": "attribute",
        ...
      },
      {
        "type": "attribute",
        ...
      },
      {
        "type": "span",
        ...
      }
    ]
  }
}
```

## <a name="includeexclude-criteria"></a>Условия включения и исключения

Оба обработчика атрибутов и процессоров охватов поддерживают необязательные `include` `exclude` критерии и.
Процессор будет применен только к тем диапазонам, которые соответствуют его `include` критериям (если они предоставлены) _и_ не соответствуют его `exclude` критериям (если они предоставлены).

Чтобы настроить этот параметр, `include` необходимо указать и (или `exclude` ) хотя бы один, `matchType` а также один из параметров `spanNames` или `attributes` .
Конфигурация включения и исключения поддерживается для нескольких указанных условий.
Все указанные условия должны иметь значение true, чтобы сопоставление было выполнено. 

**Обязательное поле**: 
* `matchType` управляет `spanNames` интерпретацией элементов в `attributes` массивах и. Возможные значения: `regexp` или `strict`. 

**Необязательные поля**: 
* `spanNames` должен совпадать по крайней мере с одним из элементов. 
* `attributes` Задает список атрибутов для сопоставления. Все эти атрибуты должны совпадать в точности для совпадений.

> [!NOTE]
> Если `include` указаны и `exclude` , и, `include` свойства проверяются перед `exclude` свойствами.

#### <a name="sample-usage"></a>Пример использования

```json

"processors": [
  {
    "type": "attribute",
    "include": {
      "matchType": "strict",
      "spanNames": [
        "spanA",
        "spanB"
      ]
    },
    "exclude": {
      "matchType": "strict",
      "attributes": [
        {
          "key": "redact_trace",
          "value": "false"
        }
      ]
    },
    "actions": [
      {
        "key": "credit_card",
        "action": "delete"
      },
      {
        "key": "duplicate_key",
        "action": "delete"
      }
    ]
  }
]
```
Дополнительные сведения см. в документации по [примерам обработчика телеметрии](./java-standalone-telemetry-processors-examples.md) .

## <a name="attribute-processor"></a>Обработчик атрибутов

Обработчик атрибутов изменяет атрибуты диапазона. При необходимости она поддерживает возможность включения и исключения диапазонов. Он принимает список действий, которые выполняются в порядке, указанном в файле конфигурации. Поддерживаются следующие действия:

### `insert`

Вставляет новый атрибут в диапазоны, где ключ еще не существует.   

```json
"processors": [
  {
    "type": "attribute",
    "actions": [
      {
        "key": "attribute1",
        "value": "value1",
        "action": "insert"
      }
    ]
  }
]
```
Для `insert` действия требуется следующее.
  * `key`
  * один из `value` или `fromAttribute`
  * `action`:`insert`

### `update`

Обновляет атрибут в диапазоне, где существует ключ

```json
"processors": [
  {
    "type": "attribute",
    "actions": [
      {
        "key": "attribute1",
        "value": "newValue",
        "action": "update"
      }
    ]
  }
]
```
Для `update` действия требуется следующее.
  * `key`
  * один из `value` или `fromAttribute`
  * `action`:`update`


### `delete` 

Удаляет атрибут из диапазона.

```json
"processors": [
  {
    "type": "attribute",
    "actions": [
      {
        "key": "attribute1",
        "action": "delete"
      }
    ]
  }
]
```
Для `delete` действия требуется следующее.
  * `key`
  * `action`: `delete`

### `hash`

Хэши (SHA1) существующего значения атрибута

```json
"processors": [
  {
    "type": "attribute",
    "actions": [
      {
        "key": "attribute1",
        "action": "hash"
      }
    ]
  }
]
```
Для `hash` действия требуется следующее.
* `key`
* `action` : `hash`

### `extract`

> [!NOTE]
> Эта функция доступна только в 3.0.1 и более поздних версиях

Извлекает значения с помощью правила регулярного выражения из входного ключа в целевые ключи, указанные в правиле. Если целевой ключ уже существует, он будет переопределен. Он ведет себя аналогично параметру [Processor span](#extract-attributes-from-span-name) `toAttributes` с существующим атрибутом в качестве источника.

```json
"processors": [
  {
    "type": "attribute",
    "actions": [
      {
        "key": "attribute1",
        "pattern": "<regular pattern with named matchers>",
        "action": "extract"
      }
    ]
  }
]
```
Для `extract` действия требуется следующее.
* `key`
* `pattern`
* `action` : `extract`

Дополнительные сведения см. в документации по [примерам обработчика телеметрии](./java-standalone-telemetry-processors-examples.md) .

## <a name="span-processor"></a>Охват процессора

Процессор span изменяет либо имя или атрибуты диапазона, исходя из имени диапазона. При необходимости она поддерживает возможность включения и исключения диапазонов.

### <a name="name-a-span"></a>Назовите диапазон

В разделе имени требуется следующий параметр:

* `fromAttributes`: Значение атрибута для ключей используется для создания нового имени в порядке, указанном в конфигурации. Все ключи атрибутов должны быть указаны в диапазоне процессора для его переименования.

При необходимости можно настроить следующий параметр:

* `separator`: Строка, которая указана, будет использоваться для разделения значений
> [!NOTE]
> Если переименование зависит от атрибутов, изменяемых обработчиком атрибутов, убедитесь, что процессор span указан после обработчика атрибутов в спецификации конвейера.

```json
"processors": [
  {
    "type": "span",
    "name": {
      "fromAttributes": [
        "attributeKey1",
        "attributeKey2",
      ],
      "separator": "::"
    }
  }
] 
```

### <a name="extract-attributes-from-span-name"></a>Извлечь атрибуты из имени диапазона

Принимает список регулярных выражений, чтобы соответствовать имени диапазона и извлекать из него атрибуты на основе части выражения. Должен быть указан в `toAttributes` разделе.

Требуются следующие параметры.

`rules` : Список правил для извлечения значений атрибутов из имени диапазона. Значения в имени диапазона заменяются извлеченными именами атрибутов. Каждое правило в списке является строкой шаблона регулярного выражения. Имя диапазона проверяется по регулярному выражению. Если регулярное выражение соответствует, все именованные части выражения Regex извлекаются как атрибуты и добавляются в диапазон. Каждое имя части выражения преобразуется в имя атрибута и сопоставленная часть выражения, которая преобразуется в значение атрибута. Сопоставленная часть в имени диапазона заменяется извлеченным именем атрибута. Если атрибуты уже существуют в диапазоне, они будут перезаписаны. Процесс повторяется для всех правил в том порядке, в котором они указаны. Каждое последующее правило работает с именем диапазона, которое является выходным результатом после обработки предыдущего правила.

```json

"processors": [
  {
    "type": "span",
    "name": {
      "toAttributes": {
        "rules": [
          "rule1",
          "rule2",
          "rule3"
        ]
      }
    }
  }
]

```

## <a name="list-of-attributes"></a>Список атрибутов

Ниже приведен список некоторых общих атрибутов span, которые можно использовать в обработчиках данных телеметрии.

### <a name="http-spans"></a>Диапазоны HTTP

| attribute  | Тип | Описание | 
|---|---|---|
| `http.method` | строка | Метод HTTP-запроса.|
| `http.url` | строка | Полный URL-адрес запроса HTTP в форме `scheme://host[:port]/path?query[#fragment]` . Обычно фрагмент не передается по протоколу HTTP, но если он известен, он должен быть включен.|
| `http.status_code` | number | [Код состояния ответа HTTP](https://tools.ietf.org/html/rfc7231#section-6).|
| `http.flavor` | строка | Тип используемого протокола HTTP |
| `http.user_agent` | строка | Значение заголовка [HTTP-агента пользователя](https://tools.ietf.org/html/rfc7231#section-5.5.3) , отправленное клиентом. |

### <a name="jdbc-spans"></a>Диапазоны JDBC

| attribute  | Тип | Описание  |
|---|---|---|
| `db.system` | строка | Идентификатор используемого продукта системы управления базами данных (СУБД). |
| `db.connection_string` | строка | Строка подключения, используемая для подключения к базе данных. Рекомендуется удалить внедренные учетные данные.|
| `db.user` | строка | Имя пользователя для доступа к базе данных. |
| `db.name` | строка | Этот атрибут используется для сообщения имени базы данных, к которой осуществляется доступ. Для команд, которые переключают базу данных, следует задать для нее целевую базу данных (даже если команда завершается ошибкой).|
| `db.statement` | строка | Выполняемая инструкция базы данных.|
