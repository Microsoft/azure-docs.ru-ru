---
title: Параметры конфигурации — Application Insights Azure Monitor для Java
description: Настройка Application Insights Azure Monitor для Java
ms.topic: conceptual
ms.date: 11/04/2020
author: MS-jgol
ms.custom: devx-track-java
ms.author: jgol
ms.openlocfilehash: 3806578f5d1af61329e2e32fa3e8eceb9afa4d42
ms.sourcegitcommit: c27a20b278f2ac758447418ea4c8c61e27927d6a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/03/2021
ms.locfileid: "101713972"
---
# <a name="configuration-options---azure-monitor-application-insights-for-java"></a>Параметры конфигурации — Application Insights Azure Monitor для Java

> [!WARNING]
> **При обновлении с предварительной версии 3,0**
>
> Внимательно изучите все приведенные ниже параметры конфигурации, так как структура JSON полностью изменена, а также само имя файла, которое было в нижнем регистре.

## <a name="connection-string-and-role-name"></a>Строка подключения и имя роли

Строка подключения и имя роли — это наиболее распространенные параметры, необходимые для начала работы.

```json
{
  "connectionString": "InstrumentationKey=...",
  "role": {
    "name": "my cloud role name"
  }
}
```

Строка подключения является обязательной, и имя роли важно каждый раз при отправке данных из разных приложений в один и тот же ресурс Application Insights.

Дополнительные сведения и дополнительные параметры конфигурации см. ниже.

## <a name="configuration-file-path"></a>Путь к файлу конфигурации

По умолчанию Application Insights Java 3,0 ждет, что файл конфигурации будет называться `applicationinsights.json` и находиться в том же каталоге, что и `applicationinsights-agent-3.0.2.jar` .

Можно указать собственный путь к файлу конфигурации, используя либо

* `APPLICATIONINSIGHTS_CONFIGURATION_FILE` переменная среды или
* `applicationinsights.configuration.file` Системное свойство Java

Если указан относительный путь, он будет разрешаться относительно каталога, в котором находится `applicationinsights-agent-3.0.2.jar` .

## <a name="connection-string"></a>строку подключения.

Требуется строка подключения. Строку подключения можно найти в ресурсе Application Insights:

:::image type="content" source="media/java-ipa/connection-string.png" alt-text="Строка подключения Application Insights":::


```json
{
  "connectionString": "InstrumentationKey=..."
}
```

Можно также задать строку подключения с помощью переменной среды `APPLICATIONINSIGHTS_CONNECTION_STRING` .

Если не задать строку подключения, агент Java будет отключен.

## <a name="cloud-role-name"></a>Имя облачной роли

Имя облачной роли используется для обозначения компонента на схеме приложения.

Если вы хотите задать имя роли облака:

```json
{
  "role": {   
    "name": "my cloud role name"
  }
}
```

Если имя роли облака не задано, имя ресурса Application Insights будет использоваться для обозначения компонента на схеме приложения.

Вы также можете задать имя роли облака с помощью переменной среды `APPLICATIONINSIGHTS_ROLE_NAME` .

## <a name="cloud-role-instance"></a>Экземпляр облачной роли

По умолчанию экземпляр облачной роли имеет имя компьютера.

Если вы хотите задать для экземпляра роли облака нечто другое, а не имя компьютера:

```json
{
  "role": {
    "name": "my cloud role name",
    "instance": "my cloud role instance"
  }
}
```

Вы также можете задать экземпляр роли облака с помощью переменной среды `APPLICATIONINSIGHTS_ROLE_INSTANCE` .

## <a name="sampling"></a>Выборка

Выборка полезна, если необходимо снизить затраты.
Выборка выполняется в качестве функции для идентификатора операции (также известного как идентификатор трассировки), поэтому один и тот же идентификатор операции всегда будет принимать одно и то же решение выборки. Это гарантирует, что вы не будете получать части распределенной транзакции, выборке в, в то время как другие ее части.

Например, если выбрать для выборки значение 10%, будут отображены только 10% транзакций, но каждый из этих 10% будет иметь полные сведения о транзакциях.

Ниже приведен пример того, как задать выборку для записи приблизительно **1/3 из всех транзакций** . Убедитесь, что задана частота выборки, правильная для вашего варианта использования:

```json
{
  "sampling": {
    "percentage": 33.333
  }
}
```

Можно также задать процент выборки с помощью переменной среды `APPLICATIONINSIGHTS_SAMPLING_PERCENTAGE` .

> [!NOTE]
> В качестве процента выборки выберите значение в процентах, близкое к 100/N, где N — это целое число. В настоящее время выборка не поддерживает другие значения.

## <a name="jmx-metrics"></a>Метрики JMX

Если вы хотите получить дополнительные метрики JMX:

```json
{
  "jmxMetrics": [
    {
      "name": "JVM uptime (millis)",
      "objectName": "java.lang:type=Runtime",
      "attribute": "Uptime"
    },
    {
      "name": "MetaSpace Used",
      "objectName": "java.lang:type=MemoryPool,name=Metaspace",
      "attribute": "Usage.used"
    }
  ]
}
```

`name` имя метрики, которое будет назначено этой метрике JMX (может быть любым).

`objectName` — [имя объекта](https://docs.oracle.com/javase/8/docs/api/javax/management/ObjectName.html) MBean-компонента JMX, который требуется получить.

`attribute` имя атрибута внутри MBean-компонента JMX, который требуется получить.

Поддерживаются числовые и логические значения метрик JMX. Метрики логического JMX сопоставлены с `0` false, а `1` значение true.

[//]: # "Примечание. не Задокументируйте APPLICATIONINSIGHTS_JMX_METRICS здесь"
[//]: # "JSON, внедренный в env, является запутанным, и его следует задокументировать только для сценария подключения с некодированным кодом"

## <a name="custom-dimensions"></a>Пользовательские измерения

Если вы хотите добавить пользовательские измерения ко всем данным телеметрии:

```json
{
  "customDimensions": {
    "mytag": "my value",
    "anothertag": "${ANOTHER_VALUE}"
  }
}
```

`${...}` может использоваться для считывания значения из указанной переменной среды при запуске.

> [!NOTE]
> Начиная с версии 3.0.2, если добавить пользовательское измерение с именем `service.version` , оно будет сохранено в `application_Version` столбце таблицы Application Insights Logs, а не в виде пользовательского измерения.

## <a name="telemetry-processors-preview"></a>Обработчики данных телеметрии (Предварительная версия)

Эта функция предоставляется в предварительной версии.

Он позволяет настроить правила, которые будут применяться к телеметрии запросов, зависимостей и трассировки, например:
 * Маскирование конфиденциальных данных
 * Условно добавить пользовательские измерения
 * Обновление имени телеметрии, используемого для агрегирования и вывода

Дополнительные сведения см. в документации по [обработчику данных телеметрии](./java-standalone-telemetry-processors.md) .

## <a name="auto-collected-logging"></a>Автоматическое собираемое ведение журнала

Log4j, Logback и Java. util. Logging устанавливаются в автоматическом инструментировании. ведение журнала выполняется с помощью этих платформ ведения журналов.

Ведение журнала захватывается только в том случае, если оно сначала соответствует заданному пороговому значению платформ ведения журналов, а вторая также соответствует пороговому значению Application Insights.

Пороговое значение Application Insights по умолчанию — `INFO` . Если вы хотите изменить этот уровень:

```json
{
  "instrumentation": {
    "logging": {
      "level": "WARN"
    }
  }
}
```

Можно также задать пороговое значение с помощью переменной среды `APPLICATIONINSIGHTS_INSTRUMENTATION_LOGGING_LEVEL` .

Это допустимые `level` значения, которые можно указать в `applicationinsights.json` файле и их соответствие уровням ведения журнала в разных платформах ведения журналов.

| уровень             | Log4j  | Logback | ИЮЛ     |
|-------------------|--------|---------|---------|
| OFF               | OFF    | OFF     | OFF     |
| АВАРИЙ             | АВАРИЙ  | ошибка   | SEVERE  |
| Ошибка (или СЕРЬЕЗная) | ошибка  | ошибка   | SEVERE  |
| ПРЕДУПРЕЖДАть (или ПРЕДУПРЕЖДАть) | ДАТЬ   | ДАТЬ    | ПРЕДУПРЕЖДЕНИЕ |
| ИНФОРМАЦИЯ              | ИНФОРМАЦИЯ   | ИНФОРМАЦИЯ    | ИНФОРМАЦИЯ    |
| CONFIG            | DEBUG  | DEBUG   | CONFIG  |
| ОТЛАДКа (или Точная)   | DEBUG  | DEBUG   | FINE    |
| FINER             | DEBUG  | DEBUG   | FINER   |
| TRACE (или FINEST) | TRACE  | TRACE   | FINEST  |
| ALL               | ALL    | ALL     | ALL     |

> [!NOTE]
> Если в средство ведения журнала передается исключение, то сообщение журнала (и исключение) будет отображаться в портал Azure в `exceptions` таблице, а не в `traces` таблице.

## <a name="auto-collected-micrometer-metrics-including-spring-boot-actuator-metrics"></a>Автособираемые метрики Микрометер (включая метрики загрузчика пружины)

Если приложение использует [микрометер](https://micrometer.io), то метрики, отправляемые в глобальный реестр микрометер, будут собираться в автоматическом виде.

Кроме того, если приложение использует [пружинный выключатель загрузки](https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-features.html), то метрики, настроенные с помощью пружинного выключателя, также будут собираться в автоматическом виде.

Чтобы отключить автоматическую коллекцию метрик Микрометер (включая метрики выключателя пружины), выполните следующие действия.

> [!NOTE]
> Плата за настраиваемые метрики взимается отдельно и может привести к дополнительным затратам. Обязательно ознакомьтесь с подробными [сведениями о ценах](https://azure.microsoft.com/pricing/details/monitor/). Чтобы отключить метрики Микрометер и пружины, добавьте приведенную ниже конфигурацию в файл конфигурации.

```json
{
  "instrumentation": {
    "micrometer": {
      "enabled": false
    }
  }
}
```

## <a name="suppressing-specific-auto-collected-telemetry"></a>Подавление конкретных автособираемых данных телеметрии

Начиная с версии 3.0.2, конкретные автоматические собранные телеметрические данные можно отключить с помощью следующих параметров конфигурации:

```json
{
  "instrumentation": {
    "cassandra": {
      "enabled": false
    },
    "jdbc": {
      "enabled": false
    },
    "kafka": {
      "enabled": false
    },
    "micrometer": {
      "enabled": false
    },
    "mongo": {
      "enabled": false
    },
    "redis": {
      "enabled": false
    }
  }
}
```

## <a name="heartbeat"></a>Пульс

По умолчанию Application Insights Java 3,0 отправляет метрику пульса каждые 15 минут. Если вы используете метрику пульса для активации оповещений, можно увеличить частоту этого пульса:

```json
{
  "heartbeat": {
    "intervalSeconds": 60
  }
}
```

> [!NOTE]
> Вы не можете уменьшить частоту пульса, так как данные пульса также используются для мониторинга Application Insights использования.

## <a name="http-proxy"></a>Прокси-сервер HTTP

Если приложение находится за брандмауэром и не может напрямую подключаться к Application Insights (см. [IP-адреса, используемые Application Insights](./ip-addresses.md)), можно настроить Application Insights Java 3,0 для использования прокси-сервера http:

```json
{
  "proxy": {
    "host": "myproxy",
    "port": 8080
  }
}
```

Application Insights Java 3,0 также учитывает глобальные и, `-Dhttps.proxyHost` `-Dhttps.proxyPort` если они заданы.

[//]: # "Примечание. Поддержка Опентелеметри предоставляется в частном предварительной версии, пока API Опентелеметри не достигнет 1,0"

[//]: # "Поддержка # # для предварительных выпусков API Опентелеметри в 1,0"

[//]: # "Поддержка предварительно 1,0 версий API Опентелеметри является явной, так как API Опентелеметри еще не является стабильным."
[//]: # "и поэтому каждая версия агента поддерживает только определенные версии API Опентелеметри, предшествующие 1,0."
[//]: # "(это ограничение не будет применяться после выпуска API Опентелеметри 1,0)."

[//]: # "JSON"
[//]: # "{"
[//]: # "  \"Предварительный просмотр \" : {"
[//]: # "    \"Опентелеметряписуппорт \" : true"
[//]: # "  }"
[//]: # "}"
[//]: # "```"

## <a name="self-diagnostics"></a>Самостоятельная диагностика

"Самодиагностика" относится к внутреннему журналу Application Insights Java 3,0.

Эта функция может оказаться полезной для обнаружения и диагностики проблем с Application Insights.

По умолчанию Application Insights Java 3,0 записывает в журнал на уровне `INFO` как для файла `applicationinsights.log` , так и для консоли, соответствующей этой конфигурации:

```json
{
  "selfDiagnostics": {
    "destination": "file+console",
    "level": "INFO",
    "file": {
      "path": "applicationinsights.log",
      "maxSizeMb": 5,
      "maxHistory": 1
    }
  }
}
```

`destination` может быть одним из `file` , `console` или `file+console` .

`level` может быть одним из `OFF` , `ERROR` , `WARN` , `INFO` , `DEBUG` или `TRACE` .

`path` может быть абсолютным или относительным путем. Относительные пути разрешаются в каталоге, где находится `applicationinsights-agent-3.0.2.jar` .

`maxSizeMb` максимальный размер файла журнала до его перебора.

`maxHistory` число файлов журнала, которые были включены в сохраняемые файлы журналов (помимо текущего файла журнала).

Начиная с версии 3.0.2, можно также задать самодиагностику `level` с помощью переменной среды `APPLICATIONINSIGHTS_SELF_DIAGNOSTICS_LEVEL` .

## <a name="an-example"></a>Пример

Это лишь пример, показывающий, как выглядит файл конфигурации с несколькими компонентами.
Настройте конкретные параметры в зависимости от ваших потребностей.

```json
{
  "connectionString": "InstrumentationKey=...",
  "role": {
    "name": "my cloud role name"
  },
  "sampling": {
    "percentage": 100
  },
  "jmxMetrics": [
  ],
  "customDimensions": {
  },
  "instrumentation": {
    "logging": {
      "level": "INFO"
    },
    "micrometer": {
      "enabled": true
    }
  },
  "proxy": {
  },
  "preview": {
    "processors": [
    ]
  },
  "selfDiagnostics": {
    "destination": "file+console",
    "level": "INFO",
    "file": {
      "path": "applicationinsights.log",
      "maxSizeMb": 5,
      "maxHistory": 1
    }
  }
}
```
