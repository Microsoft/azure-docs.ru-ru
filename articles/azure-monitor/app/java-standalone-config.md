---
title: Параметры конфигурации — Application Insights Azure Monitor для Java
description: Настройка Application Insights Azure Monitor для Java
ms.topic: conceptual
ms.date: 11/04/2020
author: MS-jgol
ms.custom: devx-track-java
ms.author: jgol
ms.openlocfilehash: f349d260fff32427712442615cabf6d3958468ac
ms.sourcegitcommit: c8b50a8aa8d9596ee3d4f3905bde94c984fc8aa2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2021
ms.locfileid: "105640035"
---
# <a name="configuration-options---azure-monitor-application-insights-for-java"></a>Параметры конфигурации — Application Insights Azure Monitor для Java

> [!WARNING]
> **При обновлении с предварительной версии 3,0**
>
> Внимательно изучите все приведенные ниже параметры конфигурации, так как структура JSON полностью изменена, а также само имя файла, которое было в нижнем регистре.

## <a name="connection-string-and-role-name"></a>Строка подключения и имя роли

Строка подключения и имя роли — это наиболее распространенные параметры, необходимые для начала работы.

```json
{
  "connectionString": "InstrumentationKey=...",
  "role": {
    "name": "my cloud role name"
  }
}
```

Строка подключения является обязательной, и имя роли важно каждый раз при отправке данных из разных приложений в один и тот же ресурс Application Insights.

Дополнительные сведения и дополнительные параметры конфигурации см. ниже.

## <a name="configuration-file-path"></a>Путь к файлу конфигурации

По умолчанию Application Insights Java 3,0 ждет, что файл конфигурации будет называться `applicationinsights.json` и находиться в том же каталоге, что и `applicationinsights-agent-3.0.2.jar` .

Можно указать собственный путь к файлу конфигурации, используя либо

* `APPLICATIONINSIGHTS_CONFIGURATION_FILE` переменная среды или
* `applicationinsights.configuration.file` Системное свойство Java

Если указан относительный путь, он будет разрешаться относительно каталога, в котором находится `applicationinsights-agent-3.0.2.jar` .

## <a name="connection-string"></a>Строка подключения

Требуется строка подключения. Строку подключения можно найти в ресурсе Application Insights:

:::image type="content" source="media/java-ipa/connection-string.png" alt-text="Строка подключения Application Insights":::


```json
{
  "connectionString": "InstrumentationKey=..."
}
```

Можно также задать строку подключения с помощью переменной среды `APPLICATIONINSIGHTS_CONNECTION_STRING` (которая затем будет иметь приоритет, если строка подключения также указана в конфигурации JSON).

Если не задать строку подключения, агент Java будет отключен.

## <a name="cloud-role-name"></a>Имя облачной роли

Имя облачной роли используется для обозначения компонента на схеме приложения.

Если вы хотите задать имя роли облака:

```json
{
  "role": {   
    "name": "my cloud role name"
  }
}
```

Если имя роли облака не задано, имя ресурса Application Insights будет использоваться для обозначения компонента на схеме приложения.

Можно также задать имя роли облака, используя переменную среды `APPLICATIONINSIGHTS_ROLE_NAME` (которая затем будет иметь приоритет, если имя облачной роли также указано в конфигурации JSON).

## <a name="cloud-role-instance"></a>Экземпляр облачной роли

По умолчанию экземпляр облачной роли имеет имя компьютера.

Если вы хотите задать для экземпляра роли облака нечто другое, а не имя компьютера:

```json
{
  "role": {
    "name": "my cloud role name",
    "instance": "my cloud role instance"
  }
}
```

Вы также можете задать экземпляр роли облака, используя переменную среды `APPLICATIONINSIGHTS_ROLE_INSTANCE` (которая затем будет иметь приоритет, если экземпляр роли облака также указан в конфигурации JSON).

## <a name="sampling"></a>Дискретизация

Выборка полезна, если необходимо снизить затраты.
Выборка выполняется в качестве функции для идентификатора операции (также известного как идентификатор трассировки), поэтому один и тот же идентификатор операции всегда будет принимать одно и то же решение выборки. Это гарантирует, что вы не будете получать части распределенной транзакции, выборке в, в то время как другие ее части.

Например, если выбрать для выборки значение 10%, будут отображены только 10% транзакций, но каждый из этих 10% будет иметь полные сведения о транзакциях.

Ниже приведен пример того, как задать выборку для записи приблизительно **1/3 из всех транзакций** . Убедитесь, что задана частота выборки, правильная для вашего варианта использования:

```json
{
  "sampling": {
    "percentage": 33.333
  }
}
```

Можно также задать процент выборки с помощью переменной среды `APPLICATIONINSIGHTS_SAMPLING_PERCENTAGE` (которая будет иметь приоритет, если в конфигурации JSON также указан процент выборки).

> [!NOTE]
> В качестве процента выборки выберите значение в процентах, близкое к 100/N, где N — это целое число. В настоящее время выборка не поддерживает другие значения.

## <a name="sampling-overrides-preview"></a>Переопределения выборки (Предварительная версия)

Эта функция доступна в предварительной версии, начиная с версии 3.0.3-BETA. 2.

Переопределения выборки позволяют переопределить [Процент выборки по умолчанию](#sampling), например:
* Установите процент выборки равным 0 (или небольшому значению) для проверки работоспособности.
* Установите процент выборки равным 0 (или небольшому значению) для вызовов бесшумных зависимостей.
* Установите в процентах выборки значение 100 для важного типа запроса (например, `/login` ), даже если выборка по умолчанию настроена на что-то более низкое.

Дополнительные сведения см. в документации по [переопределениям выборки](./java-standalone-sampling-overrides.md) .

## <a name="jmx-metrics"></a>Метрики JMX

Если вы хотите получить дополнительные метрики JMX:

```json
{
  "jmxMetrics": [
    {
      "name": "JVM uptime (millis)",
      "objectName": "java.lang:type=Runtime",
      "attribute": "Uptime"
    },
    {
      "name": "MetaSpace Used",
      "objectName": "java.lang:type=MemoryPool,name=Metaspace",
      "attribute": "Usage.used"
    }
  ]
}
```

`name` имя метрики, которое будет назначено этой метрике JMX (может быть любым).

`objectName` — [имя объекта](https://docs.oracle.com/javase/8/docs/api/javax/management/ObjectName.html) MBean-компонента JMX, который требуется получить.

`attribute` имя атрибута внутри MBean-компонента JMX, который требуется получить.

Поддерживаются числовые и логические значения метрик JMX. Метрики логического JMX сопоставлены с `0` false, а `1` значение true.

## <a name="custom-dimensions"></a>Пользовательские измерения

Если вы хотите добавить пользовательские измерения ко всем данным телеметрии:

```json
{
  "customDimensions": {
    "mytag": "my value",
    "anothertag": "${ANOTHER_VALUE}"
  }
}
```

`${...}` может использоваться для считывания значения из указанной переменной среды при запуске.

> [!NOTE]
> Начиная с версии 3.0.2, если добавить пользовательское измерение с именем `service.version` , оно будет сохранено в `application_Version` столбце таблицы Application Insights Logs, а не в виде пользовательского измерения.

## <a name="telemetry-processors-preview"></a>Обработчики данных телеметрии (Предварительная версия)

Эта функция предоставляется в предварительной версии.

Он позволяет настроить правила, которые будут применяться к телеметрии запросов, зависимостей и трассировки, например:
 * Маскирование конфиденциальных данных
 * Условно добавить пользовательские измерения
 * Обновите имя диапазона, которое используется для агрегирования сходных данных телеметрии в портал Azure.
 * Удалите определенные атрибуты span, чтобы контролировать стоимость приема.

Дополнительные сведения см. в документации по [обработчику данных телеметрии](./java-standalone-telemetry-processors.md) .

> [!NOTE]
> Если вы хотите удалить определенные (целые) диапазоны для управления стоимостью приема, см. раздел [переопределения выборки](./java-standalone-sampling-overrides.md).

## <a name="auto-collected-logging"></a>Автоматическое собираемое ведение журнала

Log4j, Logback и Java. util. Logging устанавливаются в автоматическом инструментировании. ведение журнала выполняется с помощью этих платформ ведения журналов.

Ведение журнала захватывается только в том случае, если оно сначала соответствует уровню, настроенному для платформы ведения журнала, и, во-вторых, также соответствует уровню, настроенному для Application Insights.

Например, если ваша платформа ведения журналов настроена для ведения журнала `WARN` (и выше) из пакета `com.example` , а Application Insights настроена для записи `INFO` (и более поздних версий), Application Insights будет записывать только `WARN` (и выше) из пакета `com.example` .

Уровень по умолчанию, настроенный для Application Insights, — `INFO` . Если вы хотите изменить этот уровень:

```json
{
  "instrumentation": {
    "logging": {
      "level": "WARN"
    }
  }
}
```

Можно также задать уровень с помощью переменной среды `APPLICATIONINSIGHTS_INSTRUMENTATION_LOGGING_LEVEL` (которая затем будет иметь приоритет, если уровень также указан в конфигурации JSON).

Это допустимые `level` значения, которые можно указать в `applicationinsights.json` файле и их соответствие уровням ведения журнала в разных платформах ведения журналов.

| уровень             | Log4j  | Logback | ИЮЛ     |
|-------------------|--------|---------|---------|
| OFF               | OFF    | OFF     | OFF     |
| АВАРИЙ             | АВАРИЙ  | ОШИБКА   | SEVERE  |
| Ошибка (или СЕРЬЕЗная) | ОШИБКА  | ОШИБКА   | SEVERE  |
| ПРЕДУПРЕЖДАть (или ПРЕДУПРЕЖДАть) | ДАТЬ   | ДАТЬ    | ПРЕДУПРЕЖДЕНИЕ |
| ИНФОРМАЦИЯ              | ИНФОРМАЦИЯ   | ИНФОРМАЦИЯ    | ИНФОРМАЦИЯ    |
| CONFIG            | DEBUG  | DEBUG   | CONFIG  |
| ОТЛАДКа (или Точная)   | DEBUG  | DEBUG   | FINE    |
| FINER             | DEBUG  | DEBUG   | FINER   |
| TRACE (или FINEST) | TRACE  | TRACE   | FINEST  |
| ALL               | ALL    | ALL     | ALL     |

> [!NOTE]
> Если объект исключения передается в средство ведения журнала, то сообщение журнала (и сведения об объекте исключения) будет отображаться в портал Azure в таблице, `exceptions` а не в `traces` таблице.

## <a name="auto-collected-micrometer-metrics-including-spring-boot-actuator-metrics"></a>Автособираемые метрики Микрометер (включая метрики загрузчика пружины)

Если приложение использует [микрометер](https://micrometer.io), то метрики, отправляемые в глобальный реестр микрометер, будут собираться в автоматическом виде.

Кроме того, если приложение использует [пружинный выключатель загрузки](https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-features.html), то метрики, настроенные с помощью пружинного выключателя, также будут собираться в автоматическом виде.

Чтобы отключить автоматическую коллекцию метрик Микрометер (включая метрики выключателя пружины), выполните следующие действия.

> [!NOTE]
> Плата за настраиваемые метрики взимается отдельно и может привести к дополнительным затратам. Обязательно ознакомьтесь с подробными [сведениями о ценах](https://azure.microsoft.com/pricing/details/monitor/). Чтобы отключить метрики Микрометер и пружины, добавьте приведенную ниже конфигурацию в файл конфигурации.

```json
{
  "instrumentation": {
    "micrometer": {
      "enabled": false
    }
  }
}
```

## <a name="suppressing-specific-auto-collected-telemetry"></a>Подавление конкретных автособираемых данных телеметрии

Начиная с версии 3.0.2, конкретные автоматические собранные телеметрические данные можно отключить с помощью следующих параметров конфигурации:

```json
{
  "instrumentation": {
    "cassandra": {
      "enabled": false
    },
    "jdbc": {
      "enabled": false
    },
    "kafka": {
      "enabled": false
    },
    "micrometer": {
      "enabled": false
    },
    "mongo": {
      "enabled": false
    },
    "redis": {
      "enabled": false
    }
  }
}
```

> Примечание. Если вы ищете более детализированный элемент управления, например, чтобы подавлять некоторые вызовы Redis, но не все вызовы Redis, см. раздел [переопределения выборки](./java-standalone-sampling-overrides.md).


## <a name="heartbeat"></a>Пульс

По умолчанию Application Insights Java 3,0 отправляет метрику пульса каждые 15 минут. Если вы используете метрику пульса для активации оповещений, можно увеличить частоту этого пульса:

```json
{
  "heartbeat": {
    "intervalSeconds": 60
  }
}
```

> [!NOTE]
> Вы не можете увеличить интервал более чем на 15 минут, так как данные пульса также используются для мониторинга Application Insights использования.

## <a name="http-proxy"></a>Прокси-сервер HTTP

Если приложение находится за брандмауэром и не может напрямую подключаться к Application Insights (см. [IP-адреса, используемые Application Insights](./ip-addresses.md)), можно настроить Application Insights Java 3,0 для использования прокси-сервера http:

```json
{
  "proxy": {
    "host": "myproxy",
    "port": 8080
  }
}
```

Application Insights Java 3,0 также учитывает глобальные и, `-Dhttps.proxyHost` `-Dhttps.proxyPort` если они заданы.

## <a name="metric-interval"></a>Интервал метрики

Эта функция предоставляется в предварительной версии.

По умолчанию метрики фиксируются каждые 60 секунд.

Начиная с версии 3.0.3-BETA, вы можете изменить этот интервал:

```json
{
  "preview": {
    "metricIntervalSeconds": 300
  }
}
```

Параметр применяется ко всем этим метрикам:

* Счетчики производительности по умолчанию, например ЦП и память
* Пользовательские метрики по умолчанию, например время сборки мусора
* Настроенные метрики JMX ([см. выше](#jmx-metrics))
* Метрики микрометер ([см. выше](#auto-collected-micrometer-metrics-including-spring-boot-actuator-metrics))


[//]: # "Примечание. Поддержка Опентелеметри предоставляется в частном предварительной версии, пока API Опентелеметри не достигнет 1,0"

[//]: # "Поддержка # # для предварительных выпусков API Опентелеметри в 1,0"

[//]: # "Поддержка предварительно 1,0 версий API Опентелеметри является явной, так как API Опентелеметри еще не является стабильным."
[//]: # "и поэтому каждая версия агента поддерживает только определенные версии API Опентелеметри, предшествующие 1,0."
[//]: # "(это ограничение не будет применяться после выпуска API Опентелеметри 1,0)."

[//]: # "JSON"
[//]: # "{"
[//]: # "  \"Предварительный просмотр \" : {"
[//]: # "    \"Опентелеметряписуппорт \" : true"
[//]: # "  }"
[//]: # "}"
[//]: # "```"

## <a name="self-diagnostics"></a>Самостоятельная диагностика

"Самодиагностика" относится к внутреннему журналу Application Insights Java 3,0.

Эта функция может оказаться полезной для обнаружения и диагностики проблем с Application Insights.

По умолчанию Application Insights Java 3,0 записывает в журнал на уровне `INFO` как для файла `applicationinsights.log` , так и для консоли, соответствующей этой конфигурации:

```json
{
  "selfDiagnostics": {
    "destination": "file+console",
    "level": "INFO",
    "file": {
      "path": "applicationinsights.log",
      "maxSizeMb": 5,
      "maxHistory": 1
    }
  }
}
```

`destination` может быть одним из `file` , `console` или `file+console` .

`level` может быть одним из `OFF` , `ERROR` , `WARN` , `INFO` , `DEBUG` или `TRACE` .

`path` может быть абсолютным или относительным путем. Относительные пути разрешаются в каталоге, где находится `applicationinsights-agent-3.0.2.jar` .

`maxSizeMb` максимальный размер файла журнала до его перебора.

`maxHistory` число файлов журнала, которые были включены в сохраняемые файлы журналов (помимо текущего файла журнала).

Начиная с версии 3.0.2, можно также задать самодиагностику `level` с помощью переменной среды `APPLICATIONINSIGHTS_SELF_DIAGNOSTICS_LEVEL` (которая затем будет иметь приоритет, если в `level` конфигурации JSON также указана самодиагностика).

## <a name="an-example"></a>Пример

Это лишь пример, показывающий, как выглядит файл конфигурации с несколькими компонентами.
Настройте конкретные параметры в зависимости от ваших потребностей.

```json
{
  "connectionString": "InstrumentationKey=...",
  "role": {
    "name": "my cloud role name"
  },
  "sampling": {
    "percentage": 100
  },
  "jmxMetrics": [
  ],
  "customDimensions": {
  },
  "instrumentation": {
    "logging": {
      "level": "INFO"
    },
    "micrometer": {
      "enabled": true
    }
  },
  "proxy": {
  },
  "preview": {
    "processors": [
    ]
  },
  "selfDiagnostics": {
    "destination": "file+console",
    "level": "INFO",
    "file": {
      "path": "applicationinsights.log",
      "maxSizeMb": 5,
      "maxHistory": 1
    }
  }
}
```
