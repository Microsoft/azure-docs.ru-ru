---
title: Переопределения выборки (Предварительная версия) — Azure Monitor Application Insights для Java
description: Узнайте, как настроить переопределения выборки в Azure Monitor Application Insights для Java.
ms.topic: conceptual
ms.date: 03/22/2021
author: trask
ms.custom: devx-track-java
ms.author: trstalna
ms.openlocfilehash: 03d3093f14d97b2cc64d91e0d1b7adf34204a021
ms.sourcegitcommit: ac035293291c3d2962cee270b33fca3628432fac
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/24/2021
ms.locfileid: "104962600"
---
# <a name="sampling-overrides-preview---azure-monitor-application-insights-for-java"></a>Переопределения выборки (Предварительная версия) — Azure Monitor Application Insights для Java

> [!NOTE]
> Функция переопределения выборки доступна в предварительной версии.

Ниже приведены некоторые варианты использования переопределений выборки.
 * Отключить сбор данных телеметрии для проверок работоспособности.
 * Отключить сбор данных телеметрии для вызовов бесшумных зависимостей.
 * Сократите шум от проверок работоспособности или бесшумного вызова зависимости, не отключая их полностью.
 * Сбор данных телеметрии 100% для важного типа запроса (например, `/login` ), хотя выборка по умолчанию настроена на что-то более низкое.

## <a name="terminology"></a>Терминология

Прежде чем приступить к изучению переопределений выборки, вы должны понимать *диапазон* терминов. Диапазон — это общий термин для:

* Входящий запрос.
* Исходящая зависимость (например, удаленный вызов другой службы).
* Внутрипроцессный набор зависимостей (например, работа, выполняемая подкомпонентами службы).

Для переопределений выборки эти компоненты охватывают следующие значения:

* Атрибуты

Атрибуты span представляют стандартные и пользовательские свойства заданного запроса или зависимости.

## <a name="getting-started"></a>Начало работы

Для начала создайте файл конфигурации с именем *applicationinsights.jsв*. Сохраните его в том же каталоге, что и *applicationinsights-Agent- \* . jar*. Используйте следующий шаблон.

```json
{
  "connectionString": "InstrumentationKey=00000000-0000-0000-0000-000000000000",
  "sampling": {
    "percentage": 10
  },
  "preview": {
    "sampling": {
      "overrides": [
        {
          "attributes": [
            ...
          ],
          "percentage": 0
        },
        {
          "attributes": [
            ...
          ],
          "percentage": 100
        }
      ]
    }
  }
}
```

## <a name="how-it-works"></a>Принцип работы

При запуске интервала атрибуты, находящиеся в области в это время, используются для проверки совпадения переопределений выборки.

Если одна из выборок переопределяет соответствие, то для определения того, следует ли выбирать диапазон, используется процент выборки.

Используется только первое переопределение выборки, соответствующее условиям.

Если выборки не соответствуют переопределениям:

* Если это первый диапазон в трассировке, используется [Обычная выборка в процентах](./java-standalone-config.md#sampling) .
* Если это не первый диапазон в трассировке, используется решение родительской выборки.

> [!IMPORTANT]
> Если было принято решение не собирать диапазон, то все нисходящие диапазоны также не будут собираться, даже если имеются переопределения выборки, соответствующие нисходящим диапазонам.
> Это поведение необходимо, так как в противном случае неработающие трассировки приведут к сбору нисходящих диапазонов, а родительские — к охвату, который не был собран.

> [!NOTE]
> Решение выборки основывается на хэшировании traceId (также известной как идентификатор операции) в число от 0 до 100, а затем этот хэш сравнивается с процентом выборки.
> Так как все диапазоны в данной трассировке будут иметь одинаковые traceId, они будут иметь одинаковый хэш, поэтому решение выборки будет согласовано по всей трассировке.

## <a name="example-suppress-collecting-telemetry-for-health-checks"></a>Пример. Отключение сбора данных телеметрии для проверок работоспособности

Это приведет к подавлению сбора данных телеметрии для всех запросов к `/health-checks` .

Это также приведет к отключению сбора всех нисходящих диапазонов (зависимостей), которые обычно собираются в `/health-checks` .

```json
{
  "connectionString": "InstrumentationKey=00000000-0000-0000-0000-000000000000",
  "preview": {
    "sampling": {
      "overrides": [
        {
          "attributes": [
            {
              "key": "http.url",
              "value": "https?://[^/]+/health-check",
              "matchType": "regexp"
            }
          ],
          "percentage": 0
        }
      ]
    }
  }
}
```

## <a name="example-suppress-collecting-telemetry-for-a-noisy-dependency-call"></a>Пример. Отключение сбора данных телеметрии для вызова бесшумных зависимостей

Это приведет к подавлению сбора данных телеметрии для всех `GET my-noisy-key` вызовов Redis.

```json
{
  "connectionString": "InstrumentationKey=00000000-0000-0000-0000-000000000000",
  "preview": {
    "sampling": {
      "overrides": [
        {
          "attributes": [
            {
              "key": "db.system",
              "value": "redis",
              "matchType": "strict"
            },
            {
              "key": "db.statement",
              "value": "GET my-noisy-key",
              "matchType": "strict"
            }
          ],
          "percentage": 0
        }
      ]
    }
  }
}
```

## <a name="example-collect-100-of-telemetry-for-an-important-request-type"></a>Пример: сбор данных телеметрии 100% для важного типа запроса

Будет собираются 100% телеметрии для `/login` .

Так как нисходящие диапазоны (зависимости) учитывают решение выборки для родителя (отсутствие переопределения выборки для этого нисходящиго диапазона), они также будут собираться для всех запросов "/Login".

```json
{
  "connectionString": "InstrumentationKey=00000000-0000-0000-0000-000000000000",
  "sampling": {
    "percentage": 10
  },
  "preview": {
    "sampling": {
      "overrides": [
        {
          "attributes": [
            {
              "key": "http.url",
              "value": "https?://[^/]+/login",
              "matchType": "regexp"
            }
          ],
          "percentage": 100
        }
      ]
    }
  }
}
```

## <a name="common-span-attributes"></a>Общие атрибуты span

В этом разделе перечислены некоторые общие атрибуты span, которые могут использоваться переопределениями выборки.

### <a name="http-spans"></a>Диапазоны HTTP

| attribute  | Тип | Описание | 
|---|---|---|
| `http.method` | строка | Метод HTTP-запроса.|
| `http.url` | string | Полный URL-адрес запроса HTTP в форме `scheme://host[:port]/path?query[#fragment]` . Этот фрагмент обычно не передается по протоколу HTTP. Но если фрагмент известен, он должен быть включен.|
| `http.status_code` | number | [Код состояния ответа HTTP](https://tools.ietf.org/html/rfc7231#section-6).|
| `http.flavor` | string | Тип протокола HTTP. |
| `http.user_agent` | string | Значение заголовка [HTTP-агента пользователя](https://tools.ietf.org/html/rfc7231#section-5.5.3) , отправленное клиентом. |

### <a name="jdbc-spans"></a>Диапазоны JDBC

| attribute  | Тип | Описание  |
|---|---|---|
| `db.system` | строка | Идентификатор используемого продукта системы управления базами данных (СУБД). |
| `db.connection_string` | string | Строка подключения, используемая для подключения к базе данных. Рекомендуется удалить внедренные учетные данные.|
| `db.user` | string | Имя пользователя для доступа к базе данных. |
| `db.name` | string | Строка, используемая для сообщения имени базы данных, к которой осуществляется доступ. Для команд, которые переключают базу данных, этой строке следует присвоить значение целевой базе данных, даже если команда завершается с ошибкой.|
| `db.statement` | string | Выполняемая инструкция базы данных.|
