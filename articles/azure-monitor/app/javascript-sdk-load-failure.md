---
title: Устранение неполадок при загрузке пакета SDK для веб-приложений JavaScript — Azure Application Insights
description: Устранение ошибки загрузки пакета SDK для веб-приложений JavaScript
ms.topic: conceptual
author: MSNev
ms.author: newylie
ms.date: 06/05/2020
ms.custom: devx-track-js
ms.openlocfilehash: 6295a56abbf3466c68b968c935936dbc10e22fb5
ms.sourcegitcommit: c27a20b278f2ac758447418ea4c8c61e27927d6a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/03/2021
ms.locfileid: "101711422"
---
# <a name="troubleshooting-sdk-load-failure-for-javascript-web-apps"></a>Устранение неполадок при загрузке пакета SDK для веб-приложений JavaScript

<!-- 
Editor Note: This link name above "SDK Load Failure" has a direct references by https://go.microsoft.com/fwlink/?linkid=2128109 which is embedded in the snippet and from the JavaScript Page. If you change this text you MUST also update these references.
-->

Исключение "сбой загрузки пакета SDK" создается и сообщается фрагменту кода JavaScript (V3 или более поздней версии), если он обнаруживает, что не удалось загрузить или инициализировать скрипт пакета SDK. В упрощенном клиенте (браузер) конечных пользователей не удалось скачать пакет SDK для Application Insights или инициализировать с указанной страницы размещения, поэтому данные телеметрии или события не будут выводиться.

![Обзор сбоев портал Azure браузера](./media/javascript-sdk-load-failure/overview.png)

> [!NOTE]
> Это исключение поддерживается во всех основных браузерах, поддерживающих API fetch () или XMLHttpRequest. Это исключает IE 8 и более ранних версий, поэтому в этих браузерах не будет получено исключение такого типа (если в вашей среде не предусмотрена выборке с помощью Fill).

![сведения об исключении браузера](./media/javascript-sdk-load-failure/exception.png)

Сведения о стеке включают основные сведения с URL-адресами, используемыми конечным пользователем.

| Имя                      | Описание                                                                                                  |
|---------------------------|--------------------------------------------------------------------------------------------------------------|
| &lt;&nbsp;Конечная точка CDN&gt; | URL-адрес, который был использован (и не пройден) для загрузки пакета SDK.                                                      |
| &lt;Ссылка на справку &nbsp;&gt;    | URL-адрес, ссылающийся на документацию по устранению неполадок (на этой странице).                                              |
| &lt;&nbsp;URL-адрес узла&gt;     | Полный URL-адрес страницы, используемой конечным пользователем.                                                    |
| &lt;&nbsp;URL-адрес конечной точки&gt; | URL-адрес, который использовался для сообщения об исключении. это значение может быть полезным при определении того, была ли доступ к странице размещения предоставлен из общедоступного Интернета или частного облака.

Наиболее распространенные причины возникновения этого исключения:

- Сбой периодического подключения к сети.
- Application Insights сбоя CDN.
- Не удалось инициализировать пакет SDK после загрузки скрипта.
- Application Insights JavaScript CDN заблокирован.

Неустранимая [Ошибка сетевого подключения](#intermittent-network-connectivity-failure) является наиболее распространенной причиной для этого исключения, особенно в сценариях роуминга для мобильных устройств, когда пользователи теряют сетевые подключения периодически.

В следующих разделах описывается, как устранять возможные причины этой ошибки.

> [!NOTE]
> В некоторых действиях по устранению неполадок предполагается, что ваше приложение имеет прямой контроль над &lt; сценарием или тегом фрагмента кода &gt; и его конфигурацией, возвращаемых в СОСТАВе HTML-страницы размещения. Если этого не делать, указанные действия не будут применяться к вашему сценарию.

## <a name="intermittent-network-connectivity-failure"></a>Сбой периодического подключения к сети

**Если у пользователя возникают временные сбои при подключении к сети, то существует меньшее количество решений, и они, как правило, разрешают себя в течение короткого периода времени.** Например, если пользователь перезагружает сайт (обновляет страницу), файлы (в конечном итоге) будут загружены и кэшированы локально до выпуска обновленной версии.

> [!NOTE]
> Если это исключение является устойчивым и возникает для многих пользователей (диагностика которых сообщается по быстрому и устойчивому уровню этого исключения) вместе с сокращением обычной телеметрии клиента, то временные проблемы с сетевым подключением, _скорее всего, не_ являются действительной причиной проблемы, и следует продолжить диагностику с другими известными возможными проблемами.

В такой ситуации, когда пакет SDK будет размещаться в вашей сети CDN, он не сможет предоставить или уменьшить вероятность возникновения этого исключения, так как эта проблема повлияет на вашу собственную сеть CDN.

То же самое справедливо и при использовании пакета SDK через решение NPM Packages. Однако с точки зрения конечных пользователей, когда это происходит, приложению не удается загрузиться или инициализироваться (а не _только_ пакет SDK для телеметрии, который не отображается визуально), поэтому они, скорее всего, будут обновлять сайт до тех пор, пока не загрузится полностью.

Вы также можете попытаться использовать [пакеты NPM](#use-npm-packages-to-embed-the-application-insight-sdk) для внедрения пакета SDK Application Insights.

Чтобы избежать периодического сбоя сетевого подключения, мы реализовали Cache-Control заголовков для всех файлов CDN, так что после того, как браузер конечного пользователя загрузит текущую версию пакета SDK, его не потребуется загружать повторно, и браузер будет использовать ранее полученную копию (см. раздел [как работает кэширование](../../cdn/cdn-how-caching-works.md)). Если проверка кэширования завершается ошибкой или имеется новый выпуск, то браузеру конечного пользователя потребуется загрузить обновленную версию. Поэтому в сценарии сбоя проверки или во временном пиках в случае, когда новый выпуск становится общедоступным (развернутым в CDN), может отображаться фоновый уровень _шума_ .
 
## <a name="application-insights-cdn-outage"></a>Сбой Application Insights CDN

Вы можете убедиться в отсутствии Application Insights CDN, пытаясь получить доступ к конечной точке CDN непосредственно из браузера (например, https://az416426.vo.msecnd.net/scripts/b/ai.2.min.js или https://js.monitor.azure.com/scripts/b/ai.2.min.js) из расположения, отличного от конечного пользователя, вероятного на вашем компьютере разработки (предполагая, что ваша организация не блокирует этот домен).

Если вы подтвердите сбой, можно [создать новый запрос в службу поддержки](https://azure.microsoft.com/support/create-ticket/) или попробовать изменить URL-адрес, используемый для загрузки пакета SDK.

### <a name="change-the-cdn-endpoint"></a>Изменение конечной точки CDN
  
Так как фрагмент и его конфигурация возвращаются приложением как часть каждой создаваемой страницы, можно изменить конфигурацию фрагмента, `src` чтобы использовать другой URL-адрес для пакета SDK. Используя этот подход, можно обойти проблему заблокированной сети CDN, так как новый URL-адрес не должен блокироваться.

Текущие Application Insights конечных точек CDN пакета SDK для JavaScript
- `https://az416426.vo.msecnd.net/scripts/b/ai.2.min.js`
- `https://js.monitor.azure.com/scripts/b/ai.2.min.js`

> [!NOTE]
> `https://js.monitor.azure.com/`Конечная точка — это псевдоним, позволяющий переключаться между поставщиками CDN в течение приблизительно 5 минут без необходимости изменять конфигурацию. Это позволит нам быстрее устранять обнаруженные проблемы, связанные с CDN, если поставщик CDN имеет свои региональные или глобальные проблемы, не требуя от пользователя настраивать параметры.

## <a name="sdk-failed-to-initialize-after-loading-the-script"></a>Не удалось инициализировать пакет SDK после загрузки скрипта

Если не удалось инициализировать пакет SDK, &lt; сценарий или &gt; был успешно СКАЧАН из CDN, но во время инициализации произошел сбой. Это может быть вызвано отсутствием или недопустимыми зависимостями или какой-либо формой исключения JavaScript.

Первое, что нужно проверить: был ли успешно скачан пакет SDK, если сценарий не был загружен, это __не__ является причиной возникновения ошибки загрузки пакета SDK.

Быстрая проверка. используя браузер, поддерживающий средства разработчика (F12), проверьте на вкладке "сеть", что скрипт, определенный в ```src``` конфигурации фрагмента, был скачан с кодом ответа 200 (успешно) или 304 (не изменен). Для просмотра сетевого трафика можно также использовать такой инструмент, как Fiddler.

В следующих разделах содержатся различные варианты создания отчетов, поэтому рекомендуется либо создать запрос в службу поддержки, либо поднять ошибку на GitHub.

 Основные правила отчетности:

- Если эта ошибка влияет только на небольшое количество пользователей и на конкретные или подмножество версий браузера (см. подробные сведения о сообщении об исключении), то, скорее всего, будет выдаваться только конечному пользователю или среде, что, скорее всего, потребует от вашего приложения предоставить дополнительные `polyfill` реализации. Для этого [Задайте вопрос на GitHub](https://github.com/Microsoft/ApplicationInsights-JS/issues).
- Если эта проблема затрагивает все приложение и все пользователи, возможно, проблема связана с выпуском, поэтому следует [создать новый запрос в службу поддержки](https://azure.microsoft.com/support/create-ticket/).

### <a name="javascript-exceptions"></a>Исключения JavaScript

Сначала можно проверить наличие исключений JavaScript, используя браузер, поддерживающий средства разработчика (F12), загрузить страницу и проверить, возникли ли какие-либо исключения.

Если в скрипте пакета SDK передаются исключения (например ai.2.min.js), это может означать, что конфигурация, переданная в пакет SDK, содержит непредвиденную или отсутствующую требуемую конфигурацию либо в CDN развернут сбойный выпуск.

Чтобы проверить конфигурацию с ошибками, измените конфигурацию, переданную в фрагмент (если это еще не сделано), чтобы он включал в себя только ключ инструментирования в виде строкового значения.

> src: " https://js.monitor.azure.com/scripts/b/ai.2.min.js ",<br />
> CFG: {<br />
> instrumentationKey: "INSTRUMENTATION_KEY"<br />
> }});<br />

Если при использовании минимальной конфигурации вы по-прежнему видите исключение JavaScript в сценарии пакета SDK, [Создайте новый запрос в службу поддержки](https://azure.microsoft.com/support/create-ticket/) , так как это потребует отката неисправной сборки, так как она, вероятно, является проблемой с новой развернутой версией.

Если исключение исчезнет, то, скорее всего, причиной проблемы является несоответствие типов или непредвиденное значение. Начните добавлять параметры конфигурации обратно в одну и ту же проверку, пока не возникнет исключение. Затем проверьте документацию по элементу, вызвавшему ошибку. Если документация непонятна или вам нужна помощь, обратитесь к [вопросу на GitHub](https://github.com/Microsoft/ApplicationInsights-JS/issues).

Если конфигурация была ранее развернута и работала, но только что начали сообщать об этом исключении, это может быть вызвано проблемой с новой развернутой версией, проверять, влияет ли она только на небольшое число пользователей или браузеров, и как либо задействовать [на GitHub](https://github.com/Microsoft/ApplicationInsights-JS/issues) , либо  [создать новый запрос в службу поддержки](https://azure.microsoft.com/support/create-ticket/).

### <a name="enable-console-debugging"></a>Включить отладку консоли

При условии, что исключения не возникают, следующий шаг заключается в включении отладки консоли путем добавления `loggingLevelConsole` параметра в конфигурацию, при этом все ошибки инициализации и предупреждения будут отправлены в консоль браузеров (обычно доступны через средства разработчика (F12)). Все сообщения об ошибках должны быть понятны, и если вам требуется дополнительная помощь, обратитесь [к файлу на сайте GitHub](https://github.com/Microsoft/ApplicationInsights-JS/issues).

> CFG: {<br />
> instrumentationKey: "INSTRUMENTATION_KEY",<br />
> Логгинглевелконсоле: 2<br />
> }});<br />

> [!NOTE]
> Во время инициализации пакет SDK выполняет некоторые основные проверки для известных основных зависимостей. Если они не предоставляются текущей средой выполнения, они будут сообщать о сбоях в консоль, но только в том случае, если значение `loggingLevelConsole` больше нуля.

Если инициализация по-прежнему не удается, попробуйте включить ```enableDebug``` параметр конфигурации. Это приведет к тому, что все внутренние ошибки будут выдаваться как исключение (что приведет к потере данных телеметрии). Так как это только разработчик, тем не исключено, что при выполнении некоторых внутренних проверок необходимо будет проанализировать каждое исключение, чтобы определить причину сбоя пакета SDK. Используйте неминифицированные версию скрипта (Обратите внимание на расширение ниже, ". js", а не ".min.js") в противном случае исключения будут недоступны для чтения.

> [!WARNING]
> Этот параметр предназначен только для разработчиков и никогда не должен включаться в полной рабочей среде, так как данные телеметрии будут потеряны.

> src: " https://js.monitor.azure.com/scripts/b/ai.2.min.js ",<br />
> CFG: {<br />
> instrumentationKey: "INSTRUMENTATION_KEY",<br />
> Енабледебуг: true<br />
> }});<br />

Если это по-прежнему не предоставляет никаких ценных сведений, следует [создать сообщение о проблемах в GitHub](https://github.com/Microsoft/ApplicationInsights-JS/issues) с подробными сведениями и примером сайта, если он есть. Чтобы определить причину проблемы, включите сведения о версии обозревателя, операционной системе и JS Framework.

## <a name="the-application-insights-javascript-cdn-has-been-blocked"></a>Application Insights CDN JavaScript заблокирован

Заблокированная сеть CDN возможна, если в качестве конечной точки CDN пакета SDK для Application Insights JavaScript передана и (или) определена как ненадежная. В этом случае конечная точка будет публично заблокирована, и потребители этих списков будут блокировать весь доступ.

Чтобы устранить эту проблему, необходимо, чтобы владелец конечной точки CDN работал с сущностью списка блокировок, которая помечает конечную точку как ненадежную, чтобы ее можно было удалить из соответствующего списка.

Проверьте, определена ли конечная точка CDN как ненадежная.
- [Отчет о прозрачности Google](https://transparencyreport.google.com/safe-browsing/search)
- [вирустотал](https://www.virustotal.com/gui/home/url)
- [Сукури Ситечекк](https://sitecheck.sucuri.net/)

В зависимости от частоты обновления локальных копий этих списков приложением, брандмауэром или средой для конечных пользователей или корпоративных ИТ-отделов может потребоваться дополнительное время и (или) требуется вмешательство вручную для принудительного обновления или явного разрешения конечных точек CDN для устранения проблемы.

Если конечная точка CDN определена как ненадежная, создайте запрос в [службу поддержки](https://azure.microsoft.com/support/create-ticket/) , чтобы убедиться, что проблема решена как можно скорее.

Для более *быстрого обхода этой* проблемы можно [изменить КОНЕЧНУЮ точку CDN пакета SDK](#change-the-cdn-endpoint).

### <a name="application-insights-javascript-cdn-is-blocked-by-end-user---blocked-by-browser-installed-blocker-personal-firewall"></a>Application Insights JavaScript CDN заблокирован (пользователем, заблокированным браузером; установленный блокированный, персональный брандмауэр)

Проверьте, есть ли у конечных пользователей:

- Установлен подключаемый модуль браузера (обычно это некоторые формы AD, вредоносных программ или блокирования всплывающих окон).
- Заблокированные (или запрещенные) конечные точки CDN Application Insights в браузере или прокси.
- Настроено правило брандмауэра, вызывающее блокировку домена CDN для пакета SDK (или запись DNS, которую не удается разрешить).

Если эти параметры настроены, необходимо будет работать с ними (или предоставить документацию), чтобы разрешить конечные точки CDN.

Возможно, что подключаемый модуль, на котором они установлены, использует общедоступный списка блокировки. Если это не так, скорее всего, это может быть другое настроенное вручную решение или используется частный домен списка блокировки.

#### <a name="add-exceptions-for-cdn-endpoints"></a>Добавление исключений для конечных точек CDN

Обратитесь к конечным пользователям или сообщите им о том, что они должны разрешать загрузку скриптов из конечных точек Application Insights CDN, включая их в списке исключений подключаемого модуля или правила брандмауэра (зависит от среды пользователя).

Ниже приведен пример настройки [Chrome для разрешения или блокировки доступа к веб-сайтам.](https://support.google.com/chrome/a/answer/7532419?hl=en)

### <a name="application-insights-cdn-is-blocked-by-corporate-firewall"></a>Application Insights CDN заблокирован (по корпоративному брандмауэру)

Если конечные пользователи находятся в корпоративной сети, скорее всего, это решение брандмауэра и ИТ-отдел реализовали некоторую форму системы фильтрации в Интернете. В этом случае вам потребуется работать с ними, чтобы обеспечить необходимые правила для конечных пользователей.

#### <a name="add-exceptions-for-cdn-endpoints-for-corporations"></a>Добавление исключений для конечных точек CDN для организаций

  Это похоже на [Добавление исключений для конечных пользователей](#add-exceptions-for-cdn-endpoints), но вам придется работать с ИТ-отделом компании, чтобы они настроили Application Insights конечные точки CDN для загрузки, включая (или удаляя) их в любом домене.

  > [!WARNING]
  > Если ваш корпоративный пользователь использует [Частное облако](https://azure.microsoft.com/overview/what-is-a-private-cloud/) и не может предоставить какой-либо форме исключения для предоставления их внутренним пользователям общего доступа к конечным ТОЧКАм CDN, необходимо использовать [Application Insights пакеты NPM](https://www.npmjs.com/package/applicationinsights) или разместить пакет SDK для Application Insights в своей сети CDN.  

### <a name="additional-troubleshooting-for-blocked-cdn"></a>Дополнительные устранение неполадок для заблокированной сети CDN

> [!NOTE]
> Если пользователи используют [Частное облако](https://azure.microsoft.com/overview/what-is-a-private-cloud/) и не имеют доступа к общедоступному Интернету, вам потребуется разместить пакет SDK в своей сети CDN или использовать пакеты NPM.

#### <a name="host-the-sdk-on-your-own-cdn"></a>Размещение пакета SDK в сети CDN

 Вместо того чтобы конечные пользователи загрузили пакет SDK для Application Insights из общедоступной сети CDN, можно разместить Application Insights SDK из собственной конечной точки CDN. Рекомендуется использовать определенную версию (AI. 2. #. # .min.js), чтобы облегчить поиск используемой версии. Также регулярно обновляйте его до текущей версии (ai.2.min.js), чтобы можно было использовать исправления ошибок и новые функции, которые станут доступными.

#### <a name="use-npm-packages-to-embed-the-application-insight-sdk"></a>Использование пакетов NPM для внедрения пакета SDK для Application Insights

Вместо использования фрагментов кода и общедоступных конечных точек CDN можно использовать [пакеты NPM](https://www.npmjs.com/package/applicationinsights) , чтобы включить пакет SDK как часть собственных файлов JavaScript. Пакет SDK станет просто другим пакетом в собственных сценариях.

> [!NOTE]
> При использовании пакетов NPM рекомендуется также использовать некоторую форму [комплекта JavaScript](https://www.bing.com/search?q=javascript+bundler) для помощи с разделением кода и минификации.

Как и в случае с фрагментом, также возможно, что ваши собственные скрипты (с использованием пакетов SDK NPM или без них) могут быть затронуты теми же проблемами блокировки, которые перечислены здесь, поэтому в зависимости от приложения, пользователей и вашей инфраструктуры может потребоваться реализовать нечто вроде логики в фрагменте для обнаружения и сообщения этих проблем.


## <a name="next-steps"></a>Дальнейшие действия 
- [Получение дополнительной справки за счет регистрации проблемы на GitHub](https://github.com/Microsoft/ApplicationInsights-JS/issues)
- [Отслеживать использование веб-страниц](javascript.md)
