---
title: Использование анализа изменений приложений в Azure Monitor для поиска проблем с веб-приложениями | Документация Майкрософт
description: Используйте анализ изменений приложений в Azure Monitor для устранения проблем с приложениями на активных веб-сайтах в службе приложений Azure.
ms.topic: conceptual
author: cawams
ms.author: cawa
ms.date: 05/04/2020
ms.openlocfilehash: 728fd8f4705d24f719b6dd47ba88d89fb399fd5a
ms.sourcegitcommit: 2bd0a039be8126c969a795cea3b60ce8e4ce64fc
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/14/2021
ms.locfileid: "98195880"
---
# <a name="use-application-change-analysis-preview-in-azure-monitor"></a>Использование анализа изменений приложений (Предварительная версия) в Azure Monitor

При возникновении проблем на рабочем сайте или в случае сбоя быстро определить основную причину очень важно. Стандартные решения для мониторинга могут сообщить о проблеме. Они могут даже указывать, какой компонент не работает. Но это предупреждение не всегда немедленно объясняет причину сбоя. Вы уверены, что ваш сайт работал пять минут назад, и теперь он нарушен. Что изменилось за последние пять минут? Это вопрос, что анализ изменений приложения предназначен для ответа в Azure Monitor.

Основываясь на возможностях [графа ресурсов Azure](../../governance/resource-graph/overview.md), анализ изменений позволяет получить ценные сведения об изменениях в приложении Azure, чтобы увеличить наблюдаемость и сократить MTTR (среднее время ремонта).

> [!IMPORTANT]
> Анализ изменений сейчас находится на этапе предварительной версии. Эта предварительная версия предоставляется без соглашения об уровне обслуживания. Эта версия не рекомендуется для рабочих нагрузок в рабочей среде. Некоторые функции могут не поддерживаться или иметь ограниченные возможности. Дополнительные сведения см. в статье [Дополнительные условия использования Предварительных версий Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).

## <a name="overview"></a>Общие сведения

Средство анализа изменений обнаруживает различные типы изменений, от уровня инфраструктуры до развертывания приложений. Это поставщик ресурсов Azure уровня подписки, который проверяет изменения ресурсов в подписке. Анализ изменений предоставляет данные для различных диагностических средств, которые помогают пользователям понять, какие изменения могут вызвать проблемы.

На следующей схеме показана архитектура анализа изменений.

![Схема архитектуры, с которой средство анализа изменений получает данные об изменениях и предоставляет их клиентским средствам](./media/change-analysis/overview.png)

## <a name="data-sources"></a>Источники данных

Запросы на анализ изменений приложений для Azure Resource Manager отслеживанию свойств, прокси-конфигураций и изменений в гостевых приложениях. Кроме того, служба отслеживает изменения зависимостей ресурсов для диагностики и отслеживания комплексного приложения.

### <a name="azure-resource-manager-tracked-properties-changes"></a>Изменения Azure Resource Managerных отслеживаний свойств

С помощью [графа ресурсов Azure](../../governance/resource-graph/overview.md)анализ изменений позволяет вести историю того, как ресурсы Azure, на которых размещены приложения, изменились с течением времени. Могут быть обнаружены такие параметры, как управляемые удостоверения, обновление ОС платформы и имена узлов.

### <a name="azure-resource-manager-proxied-setting-changes"></a>Изменения параметров Azure Resource Manager прокси-сервера

Такие параметры, как правило IP-конфигурации, параметры TLS и версии расширений, пока недоступны в графе ресурсов Azure, поэтому запросы на анализ изменений и повторное вычисление этих изменений позволяют получить дополнительные сведения о том, что изменилось в приложении.

### <a name="changes-in-web-app-deployment-and-configuration-in-guest-changes"></a>Изменения в развертывании и настройке веб-приложения (изменения в гостевой системе)

Анализ изменений отслеживает развертывание и состояние конфигурации приложения каждые 4 часа. Это может обнаружить, например, изменения в переменных среды приложения. Средство вычислит различия и повлечет за собой изменения. В отличие от диспетчер ресурсов изменения, сведения об изменении развертывания кода могут быть недоступны сразу же в средстве. Чтобы просмотреть последние изменения в анализе изменений, выберите **Обновить**.

![Снимок экрана: кнопка "проверить изменения сейчас"](./media/change-analysis/scan-changes.png)

### <a name="dependency-changes"></a>Изменения зависимостей

Изменения зависимостей ресурсов также могут вызвать проблемы в веб-приложении. Например, если веб-приложение вызывает кэш Redis, номер SKU кэша Redis может повлиять на производительность веб-приложения. Для обнаружения изменений в зависимостях анализ изменений проверяет запись DNS веб-приложения. Таким образом, он определяет изменения во всех компонентах приложений, которые могут вызвать проблемы.
В настоящее время поддерживаются следующие зависимости:
- Веб-приложения
- Хранилище Azure
- Azure SQL

## <a name="application-change-analysis-service"></a>Служба анализа изменений приложений

Служба анализа изменений приложений вычисляет и объединяет данные изменений из источников данных, упомянутых выше. Он предоставляет набор аналитиков для пользователей, позволяющих легко перемещаться по всем изменениям ресурсов и определить, какие изменения важны в контексте устранения неполадок или мониторинга.
Поставщик ресурсов Microsoft. Чанжеаналисис должен быть зарегистрирован в подписке для Azure Resource Manager отслеживанию свойств и изменение параметров прокси-сервера для доступа к данным. При вводе средства "Диагностика и устранение неполадок" веб-приложения или на автономной вкладке "анализ изменений" Этот поставщик ресурсов регистрируется автоматически. В ней нет никаких реализаций производительности или затрат для вашей подписки. При включении анализа изменений для веб-приложений (или включении средства "Диагностика и устранение проблем") это приведет к незначительному снижению производительности веб-приложения и стоимости выставления счетов.
Для изменений в гостевом веб-приложении требуется отдельное включение для сканирования файлов кода в веб-приложении. Дополнительные сведения см. в разделе [анализ изменений в средстве "Диагностика и устранение проблем"](#application-change-analysis-in-the-diagnose-and-solve-problems-tool) далее в этой статье.

## <a name="visualizations-for-application-change-analysis"></a>Визуализации для анализа изменений приложений

### <a name="standalone-ui"></a>Автономный пользовательский интерфейс

В Azure Monitor имеется изолированная панель для анализа изменений, позволяющая просматривать все изменения, содержащие сведения о зависимостях и ресурсах приложений.

Выполните поиск по запросу анализ изменений в строке поиска на портал Azure, чтобы запустить интерфейс.

![Снимок экрана: Поиск изменений в портал Azure](./media/change-analysis/search-change-analysis.png)

Все ресурсы в выбранной подписке отображаются с изменениями за последние 24 часа. Для оптимизации производительности загрузки страницы Служба отображает 10 ресурсов за раз. Щелкните следующие страницы, чтобы просмотреть дополнительные ресурсы. Мы работаем над удалением этого ограничения.

![Снимок экрана: колонка "анализ изменений" в портал Azure](./media/change-analysis/change-analysis-standalone-blade.png)

Щелкнув ресурс, можно просмотреть все его изменения. При необходимости выполните детализацию, чтобы просмотреть подробные сведения об изменениях в формате JSON и аналитику.

![Снимок экрана с сведениями об изменении](./media/change-analysis/change-details.png)

Для получения отзывов используйте кнопку Отправить отзыв в колонке или электронном письме changeanalysisteam@microsoft.com .

![Снимок экрана: кнопка "Отзывы" в колонке "анализ изменений"](./media/change-analysis/change-analysis-feedback.png)

### <a name="web-app-diagnose-and-solve-problems"></a>Диагностика и устранение проблем веб-приложений

В Azure Monitor анализ изменений также встроен в самостоятельную **диагностику и решение проблем** . Доступ к этому интерфейсу осуществляется со страницы **Обзор** приложения службы приложений.

![Снимок экрана с кнопкой "Обзор" и кнопкой "Диагностика и устранение проблем"](./media/change-analysis/change-analysis.png)

### <a name="application-change-analysis-in-the-diagnose-and-solve-problems-tool"></a>Анализ изменений приложений в средстве "Диагностика и устранение проблем"

Анализ изменений приложений — это автономное средство обнаружения в средствах диагностики и устранения неполадок веб-приложений. Кроме того, она обрабатывается в **сбоях приложений** и при **обнаружении веб-приложений**. При вводе средства "Диагностика и устранение проблем" поставщик ресурсов **Microsoft. чанжеаналисис** будет зарегистрирован автоматически. Выполните эти инструкции, чтобы включить отслеживание изменений в гостевом веб-приложении.

1. Выберите **доступность и производительность**.

    ![Снимок экрана с параметрами устранения неполадок "доступность и производительность"](./media/change-analysis/availability-and-performance.png)

2. Выберите **изменения приложения**. Эта функция также доступна в случае **сбоев приложений**.

   ![Снимок экрана: кнопка "сбои приложения"](./media/change-analysis/application-changes.png)

3. Ссылка ведет к пользовательскому интерфейсу Аалисис изменения приложения, ограниченному веб-приложением. Если не включено отслеживание изменений для веб-приложения в гостевой системе, следуйте указаниям баннера, чтобы получить изменения в параметрах файлов и приложений.

   ![Снимок экрана: параметры "сбои приложений"](./media/change-analysis/enable-changeanalysis.png)

4. Включите **анализ изменений** и нажмите кнопку **сохранить**. Средство отображает все веб-приложения в рамках плана службы приложений. Чтобы включить анализ изменений для всех веб-приложений в рамках плана, можно использовать параметр уровень плана.

    ![Снимок экрана: Пользовательский интерфейс "Включение анализа изменений"](./media/change-analysis/change-analysis-on.png)

5. Данные изменений также доступны в окне Выбор **веб-приложения** и обнаружение **сбоев приложений** . Вы увидите граф, который суммирует тип изменений со временем, а также сведения об этих изменениях. По умолчанию за последние 24 часа отображаются изменения, которые помогут устранить немедленные проблемы.

     ![Снимок экрана представления "изменение инструмента сравнения"](./media/change-analysis/change-view.png)



### <a name="virtual-machine-diagnose-and-solve-problems"></a>Диагностика и устранение проблем виртуальной машины

Перейдите к средству диагностика и устранение проблем для виртуальной машины.  Перейдите в раздел **средства устранения неполадок**, перейдите на страницу и выберите **Анализ недавних изменений** , чтобы просмотреть изменения на виртуальной машине.

![Снимок экрана: диагностика и устранение проблем виртуальной машины](./media/change-analysis/vm-dnsp-troubleshootingtools.png)

![Изменение анализатора в средствах устранения неполадок](./media/change-analysis/analyze-recent-changes.png)

### <a name="activity-log-change-history"></a>Журнал изменений журнала действий
Функция [просмотра журнала изменений](../platform/activity-log.md#view-change-history) в журнале действий вызывает функцию изменения серверной части службы анализа для получения изменений, связанных с операцией. **Журнал изменений** , используемый для непосредственного вызова [графа ресурсов Azure](../../governance/resource-graph/overview.md) , но с переключением серверной части на вызов анализа изменений приложения, поэтому возвращаемые изменения будут включать изменения уровня ресурса из [графа ресурсов Azure](../../governance/resource-graph/overview.md), свойства ресурсов из [Azure Resource Manager](../../azure-resource-manager/management/overview.md)и изменения в гостевой службе из служб PaaS, таких как веб-приложение служб приложений. Чтобы служба анализа изменений приложений могла проверять изменения в подписках пользователей, необходимо зарегистрировать поставщик ресурсов. При первом входе на вкладку **Журнал изменений** средство автоматически запустит регистрацию поставщика ресурсов **Microsoft. чанжеаналисис** . После регистрации изменения в **графе ресурсов Azure** будут доступны немедленно и охватывают последние 14 дней. Изменения из других источников будут доступны через ~ 4 часа после подключения подписки.

![Интеграция журнала изменений журнала действий](./media/change-analysis/activity-log-change-history.png)

### <a name="vm-insights-integration"></a>Интеграция VM Insights
Пользователи с включенной [аналитикой ВМ](../insights/vminsights-overview.md) могут просматривать изменения в виртуальных машинах, которые могут привести к возникновению пиковых нагрузок в диаграмме метрик, таких как ЦП или память, и интересно, что привело к этому. Данные об изменениях интегрированы в панель навигации на стороне VM Insights. Пользователь может просматривать изменения, произошедшие на виртуальной машине, и нажать кнопку **исследовать изменения** , чтобы просмотреть сведения об изменениях в ИЗОЛИРОВАННОМ пользовательском интерфейсе анализа изменений приложений.

[![Интеграция VM Insights](./media/change-analysis/vm-insights.png)](./media/change-analysis/vm-insights.png#lightbox)



## <a name="enable-change-analysis-at-scale"></a>Включить анализ изменений в масштабе

Если ваша подписка включает множество веб-приложений, включение службы на уровне веб-приложения будет неэффективным. Выполните следующий скрипт, чтобы включить все веб-приложения в подписке.

Предварительные требования:

- Модуль PowerShell AZ. Следуйте инструкциям по [установке модуля Azure PowerShell](/powershell/azure/install-az-ps)

Выполните следующий скрипт:

```PowerShell
# Log in to your Azure subscription
Connect-AzAccount

# Get subscription Id
$SubscriptionId = Read-Host -Prompt 'Input your subscription Id'

# Make Feature Flag visible to the subscription
Set-AzContext -SubscriptionId $SubscriptionId

# Register resource provider
Register-AzResourceProvider -ProviderNamespace "Microsoft.ChangeAnalysis"

# Enable each web app
$webapp_list = Get-AzWebApp | Where-Object {$_.kind -eq 'app'}
foreach ($webapp in $webapp_list)
{
    $tags = $webapp.Tags
    $tags[“hidden-related:diagnostics/changeAnalysisScanEnabled”]=$true
    Set-AzResource -ResourceId $webapp.Id -Tag $tags -Force
}

```

## <a name="troubleshoot"></a>Устранение неполадок

### <a name="having-trouble-registering-microsoftchange-analysis-resource-provider-from-change-history-tab"></a>Возникли проблемы при регистрации Microsoft. поставщик ресурсов для анализа изменений на вкладке журнала изменений
Если вы впервые просматриваете журнал изменений после его интеграции с анализом изменений приложений, вы увидите, что он автоматически регистрирует поставщик ресурсов **Microsoft. чанжеаналисис**. В редких случаях может произойти сбой по следующим причинам:

- У **вас недостаточно разрешений для регистрации поставщика ресурсов Microsoft. чанжеаналисис**. Это сообщение об ошибке означает, что с вашей ролью в текущей подписке не связана область действия **Microsoft. support, Register или Action** . Это может произойти, если вы не являетесь владельцем подписки и получили разрешения на общий доступ с коллегами. т. е. Просмотр доступа к группе ресурсов. Чтобы устранить эту проблему, обратитесь к владельцу подписки, чтобы зарегистрировать поставщик ресурсов **Microsoft. чанжеаналисис** . Это можно сделать в портал Azure с помощью **подписок | Поставщики ресурсов** ```Microsoft.ChangeAnalysis``` , Поиск и регистрация в пользовательском интерфейсе или с помощью Azure PowerShell или Azure CLI.

    Регистрация поставщика ресурсов с помощью PowerShell: 
    ```PowerShell
    # Register resource provider
    Register-AzResourceProvider -ProviderNamespace "Microsoft.ChangeAnalysis"
    ```

- **Не удалось зарегистрировать поставщик ресурсов Microsoft. чанжеаналисис**. Это сообщение означает, что что-то не удалось выполнить немедленно, так как пользовательский интерфейс отправил запрос на регистрацию поставщика ресурсов и не связан с проблемами с разрешениями. Вероятно, это может быть временным вопросом с подключением к Интернету. Попробуйте обновить страницу и проверить подключение к Интернету. Если ошибка не исчезнет, обратитесь к changeanalysishelp@microsoft.com

- **Это занимает больше времени, чем ожидалось**. Это сообщение означает, что регистрация занимает больше 2 минут. Это необычное, но не обязательно означает, что что-то пошло не так. Можно переходить к **подпискам | Поставщик ресурсов** для проверки состояния регистрации поставщика ресурсов **Microsoft. чанжеаналисис** . Вы можете попытаться использовать пользовательский интерфейс для отмены регистрации, повторной регистрации или обновления, чтобы узнать, помогает ли он. Если проблема сохраняется, обратитесь changeanalysishelp@microsoft.com за поддержкой.
    ![Диагностика регистрации RP занимает слишком много времени](./media/change-analysis/troubleshoot-registration-taking-too-long.png)

![Снимок экрана средства диагностики и устранения проблем для виртуальной машины с выбранными инструментами устранения неполадок.](./media/change-analysis/vm-dnsp-troubleshootingtools.png)

![Снимок экрана с плиткой для средства анализа устранения недавних изменений для виртуальной машины.](./media/change-analysis/analyze-recent-changes.png)

### <a name="azure-lighthouse-subscription-is-not-supported"></a>Подписка Azure Лигхсаусе не поддерживается

- **Не удалось выполнить запрос к поставщику ресурсов Microsoft. чанжеаналисис** *, так как подписка Azure лигхсаусе не поддерживается, изменения доступны только в домашнем клиенте подписки*. Сейчас существует ограничение на регистрацию поставщика ресурсов анализа изменений в подписке Azure Лигхсаусе для пользователей, не находящегося в домашнем клиенте. Мы планируем, чтобы это ограничение было решено в ближайшем будущем. Если проблема связана с блокировкой, существует обходной путь, включающий в себя создание субъекта-службы и явное назначение роли для разрешения доступа.  Для получения дополнительных сведений обратитесь к changeanalysishelp@microsoft.com этой службе.

### <a name="an-error-occurred-while-getting-changes-please-refresh-this-page-or-come-back-later-to-view-changes"></a>Произошла ошибка при получении изменений. Обновите эту страницу или вернитесь позже, чтобы просмотреть изменения

Это общее сообщение об ошибке, представленное службой анализа изменений приложений, когда не удалось загрузить изменения. Существует несколько известных причин.
- Ошибка подключения к Интернету с клиентского устройства
- Служба анализа изменений временно недоступна. обновление страницы через несколько минут обычно устраняет эту проблему. Если ошибка не исчезнет, обратитесь к changeanalysishelp@micorosoft.com

### <a name="you-dont-have-enough-permissions-to-view-some-changes-contact-your-azure-subscription-administrator"></a>У вас недостаточно разрешений для просмотра некоторых изменений. Обратитесь к администратору подписки Azure.

Это общее несанкционированное сообщение об ошибке, объясняющее, что текущий пользователь не имеет достаточных разрешений для просмотра изменений. Для просмотра изменений инфраструктуры, возвращенных графиком ресурсов Azure и Azure Resource Manager, требуется по крайней мере доступ для чтения на ресурсе. Для изменений файлов в гостевом веб-приложении и изменений конфигурации требуется по крайней мере роль участника.

### <a name="failed-to-register-microsoftchangeanalysis-resource-provider"></a>Не удалось зарегистрировать поставщик ресурсов Microsoft. Чанжеаналисис
Это сообщение означает, что что-то не удалось выполнить немедленно, так как пользовательский интерфейс отправил запрос на регистрацию поставщика ресурсов и не связан с проблемами с разрешениями. Вероятно, это может быть временным вопросом с подключением к Интернету. Попробуйте обновить страницу и проверить подключение к Интернету. Если ошибка не исчезнет, обратитесь к changeanalysishelp@microsoft.com
 
### <a name="you-dont-have-enough-permissions-to-register-microsoftchangeanalysis-resource-provider-contact-your-azure-subscription-administrator"></a>У вас недостаточно разрешений для регистрации поставщика ресурсов Microsoft. Чанжеаналисис. Обратитесь к администратору подписки Azure.
Это сообщение об ошибке означает, что с вашей ролью в текущей подписке не связана область действия **Microsoft. support, Register или Action** . Это может произойти, если вы не являетесь владельцем подписки и получили разрешения на общий доступ с коллегами. т. е. Просмотр доступа к группе ресурсов. Чтобы устранить эту проблему, обратитесь к владельцу подписки, чтобы зарегистрировать поставщик ресурсов **Microsoft. чанжеаналисис** . Это можно сделать в портал Azure с помощью **подписок | Поставщики ресурсов** ```Microsoft.ChangeAnalysis``` , Поиск и регистрация в пользовательском интерфейсе или с помощью Azure PowerShell или Azure CLI.

Регистрация поставщика ресурсов с помощью PowerShell: 

```PowerShell
# Register resource provider
Register-AzResourceProvider -ProviderNamespace "Microsoft.ChangeAnalysis"
```

## <a name="next-steps"></a>Дальнейшие действия

- Включите Application Insights для [приложений служб приложений Azure](azure-web-apps.md).
- Включите Application Insights для [виртуальных машин Azure и масштабируемых наборов виртуальной машины Azure, размещенных в IIS](azure-vm-vmss-apps.md).
- Узнайте больше о [графе ресурсов Azure](../../governance/resource-graph/overview.md), который помогает анализировать изменения в Power On.