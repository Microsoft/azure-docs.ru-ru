---
title: Интеллектуальное обнаружение аномальных сбоев в Application Insights | Документация Майкрософт
description: Оповещает о необычных изменениях в частоте неудачных запросов для веб-приложения, а также выполняет диагностический анализ. Настройка не требуется.
ms.topic: conceptual
ms.date: 12/18/2018
ms.reviewer: yalavi
ms.openlocfilehash: 0f4de3aaba4acf86df37048134089326196e87ff
ms.sourcegitcommit: e559daa1f7115d703bfa1b87da1cf267bf6ae9e8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/17/2021
ms.locfileid: "100587541"
---
# <a name="smart-detection---failure-anomalies"></a>Интеллектуальное обнаружение аномальных сбоев
[Application Insights](./app-insights-overview.md) автоматически уведомляет вас (почти в реальном времени), если работа веб-приложения сопровождается чрезмерно частыми неудачными запросами. Эта служба обнаруживает необычное увеличение числа невыполненных HTTP-запросов или вызовов зависимостей. Невыполненными обычно считаются запросы с кодом ответа 400 или больше. Чтобы вам было проще рассмотреть и диагностировать проблему, в подробностях оповещения приводится анализ характеристик сбоев и важные данные приложения. Кроме того, даются ссылки на портал Application Insights для дальнейшей диагностики. Эта функция не требует настройки, так как использует алгоритмы машинного обучения для прогнозирования нормальной частоты невыполненных запросов.

Эта функция работает для любого веб-приложения, размещенного в облаке или на собственных серверах, которые создают запросы к приложению или данные, от которых оно зависит (например, при наличии рабочей роли, вызывающей [TrackRequest()](./api-custom-events-metrics.md#trackrequest) или [TrackDependency()](./api-custom-events-metrics.md#trackdependency)).

Если пакет [Application Insights настроен для вашего проекта](./app-insights-overview.md), а ваше приложение создает некоторый минимально необходимый объем данных, системе интеллектуального обнаружения аномальных сбоев потребуется 24 часа, чтобы изучить нормальное поведение приложения. После этого система включается и готова отправлять оповещения.

Вот пример оповещения:

:::image type="content" source="./media/proactive-failure-diagnostics/013.png" alt-text="Пример предупреждения интеллектуального обнаружения, показывающего анализ кластера в случае сбоя." lightbox="./media/proactive-failure-diagnostics/013.png":::

Колонка подробностей содержит следующие данные:

* Количество сбоев по сравнению с обычным поведением приложения.
* Количество затронутых пользователей, чтобы вы знали, насколько все серьезно.
* Шаблон характеристик, связанный с ошибками. В этом примере указаны конкретный код ошибки, имя запроса (операция) и версия приложения. Это позволяет сразу же определить фрагмент кода, с которого следует начать поиск. К другим возможностям может относиться определенный тип браузера или клиентской операционной системы.
* Исключения, трассировки журналов и сбои в зависимостях (базах данных или других внешних компонентах), которые могут быть связаны с описанными ошибками.
* Прямые ссылки на соответствующие поиски по данным в Application Insights.

## <a name="benefits-of-smart-detection"></a>Преимущества интеллектуального обнаружения
Обычные [оповещения метрик](../alerts/alerts-log.md) сообщают о возможном наличии проблемы. Но система интеллектуального обнаружения автоматически запускает диагностику, выполняя примерно такой же анализ, который вы проводили бы самостоятельно. Вы получаете тщательно подобранные результаты, что помогает быстро выявить первопричину проблемы.

## <a name="how-it-works"></a>Принцип работы
Система интеллектуального обнаружения отслеживает поступающие из вашего приложения данные, в особенности частоту сбоев. Это правило подсчитывает число запросов, для которых свойство `Successful request` имеет значение false, и количество вызовов зависимостей, для которых свойство `Successful call` имеет значение false. По умолчанию для запросов `Successful request == (resultCode < 400)` (если вы не написали пользовательский код для [фильтрации](./api-filtering-sampling.md#filtering) или создания собственных вызовов [TrackRequest](./api-custom-events-metrics.md#trackrequest)). 

Производительность вашего приложения демонстрирует типичный шаблон поведения. Одни запросы или вызовы зависимостей будут более подвержены сбоям, чем другие, а общий процент сбоев может возрастать при увеличении нагрузки. Для выявления таких аномалий система интеллектуального обнаружения использует машинное обучение.

По мере поступления в Application Insights данных из веб-приложения система интеллектуального обнаружения сравнивает текущее поведение с шаблонами, зарегистрированными за последние несколько дней. Если по сравнению с предыдущими показателями производительности наблюдается чрезмерное увеличение частоты отказов, запускается анализ.

При запуске анализа служба анализирует кластер по неудачному запросу, чтобы попытаться определить шаблон значений, который характеризует отказы. 

В приведенном выше примере анализ обнаружил, что большинство сбоев связаны с конкретным кодом ошибки, именем запроса, URL-адресом сервера и экземпляром роли. 

Когда служба получает сведения об этих вызовах, анализатор пытается определить исключение и ошибку зависимости, связанные с запросами в идентифицированном кластере, а также найти примеры журналов трассировки, связанных с такими запросами.

Результат анализа отправляется в виде оповещения, если в настройках не указан иной способ.

Как и для [предупреждений, заданных вручную](../alerts/alerts-log.md), в них можно проверить состояние предупреждения и устранить его, если исходная проблема решена. Настройте правила генерации оповещений на странице "Оповещения" для ресурса Application Insights. В отличие от других оповещений, здесь не требуется настройка интеллектуального обнаружения. При желании адреса электронной почты для отправки оповещений можно отключить или изменить.

### <a name="alert-logic-details"></a>Сведения о логике оповещений

Оповещения запускаются нашим собственным алгоритмом машинного обучения, поэтому мы не можем предоставить точные сведения о реализации. Однако мы понимаем, что иногда пользователям требуется более глубокое представление о работе базовой логики. Ниже приводятся основные факторы, учитываемые при определении необходимости запуска оповещения. 

* Анализ процента неудачных запросов и зависимостей в скользящем временном окне, составляющем 20 минут.
* Сравнение процента сбоев за последние 20 минут с коэффициентом за последние 40 минут и последние семь дней и определение существенных отклонений, которые в несколько раз превышают стандартное отклонение.
* Использование адаптивного ограничения для минимального процента сбоев, который зависит от объема запросов и зависимостей приложения.
* Существует логика автоматического устранения оповещений, созданных по условиям мониторинга, если проблема больше не проявляется в течение 8–24 часов.
  Примечание. в текущем проекте. уведомление или действие не будут отправляться при разрешении оповещения Smart Detection. Вы можете проверить, разрешено ли предупреждение интеллектуального обнаружения в портал Azure.

## <a name="configure-alerts"></a>Настройка оповещений

Правило генерации оповещений интеллектуального обнаружения можно отключить на портале или с помощью Azure Resource Manager ([см. пример шаблона](./proactive-arm-config.md)).

Это правило генерации оповещений создается с помощью связанной [группы действий](../alerts/action-groups.md) с именем "Application Insights Smart Detection", которая содержит действия электронной почты и веб-перехватчика и может быть расширена для активации дополнительных действий при срабатывании оповещения.

> [!NOTE]
> Уведомления по электронной почте из этого правила генерации оповещений теперь по умолчанию отправляются пользователям, связанным с ролями "Читатель данных мониторинга " и "Участник мониторинга" в подписке. Дополнительные сведения об этом можно найти [здесь](./proactive-email-notification.md).
> Уведомления, отправленные из этого правила генерации оповещения, соответствуют [общей схеме оповещений](../alerts/alerts-common-schema.md).
>

Откройте страницу "Оповещения". Правила генерации оповещений по аномальным сбоям включаются в общий список оповещений, которые вы настроили вручную. Здесь можно увидеть его текущее состояние.

:::image type="content" source="./media/proactive-failure-diagnostics/021.png" alt-text="На странице ресурсов Application Insights щелкните элемент оповещения, а затем — Управление правилами оповещений." lightbox="./media/proactive-failure-diagnostics/021.png":::

Щелкните оповещение, чтобы его настроить.

:::image type="content" source="./media/proactive-failure-diagnostics/032.png" alt-text="Экран настройки правила." lightbox="./media/proactive-failure-diagnostics/032.png":::

Обратите внимание, что вы можете отключить или удалить правило генерации оповещений по аномальным сбоям, но не можете создать другое для того же ресурса Application Insights.

## <a name="example-of-failure-anomalies-alert-webhook-payload"></a>Пример полезных данных веб-перехватчика для оповещения об аномальных сбоях

```json
{
    "properties": {
        "essentials": {
            "severity": "Sev3",
            "signalType": "Log",
            "alertState": "New",
            "monitorCondition": "Resolved",
            "monitorService": "Smart Detector",
            "targetResource": "/subscriptions/4f9b81be-fa32-4f96-aeb3-fc5c3f678df9/resourcegroups/test-group/providers/microsoft.insights/components/test-rule",
            "targetResourceName": "test-rule",
            "targetResourceGroup": "test-group",
            "targetResourceType": "microsoft.insights/components",
            "sourceCreatedId": "1a0a5b6436a9b2a13377f5c89a3477855276f8208982e0f167697a2b45fcbb3e",
            "alertRule": "/subscriptions/4f9b81be-fa32-4f96-aeb3-fc5c3f678df9/resourcegroups/test-group/providers/microsoft.alertsmanagement/smartdetectoralertrules/failure anomalies - test-rule",
            "startDateTime": "2019-10-30T17:52:32.5802978Z",
            "lastModifiedDateTime": "2019-10-30T18:25:23.1072443Z",
            "monitorConditionResolvedDateTime": "2019-10-30T18:25:26.4440603Z",
            "lastModifiedUserName": "System",
            "actionStatus": {
                "isSuppressed": false
            },
            "description": "Failure Anomalies notifies you of an unusual rise in the rate of failed HTTP requests or dependency calls."
        },
        "context": {
            "DetectionSummary": "An abnormal rise in failed request rate",
            "FormattedOccurenceTime": "2019-10-30T17:50:00Z",
            "DetectedFailureRate": "50.0% (200/400 requests)",
            "NormalFailureRate": "0.0% (over the last 30 minutes)",
            "FailureRateChart": [
                [
                    "2019-10-30T05:20:00Z",
                    0
                ],
                [
                    "2019-10-30T05:40:00Z",
                    100
                ],
                [
                    "2019-10-30T06:00:00Z",
                    0
                ],
                [
                    "2019-10-30T06:20:00Z",
                    0
                ],
                [
                    "2019-10-30T06:40:00Z",
                    100
                ],
                [
                    "2019-10-30T07:00:00Z",
                    0
                ],
                [
                    "2019-10-30T07:20:00Z",
                    0
                ],
                [
                    "2019-10-30T07:40:00Z",
                    100
                ],
                [
                    "2019-10-30T08:00:00Z",
                    0
                ],
                [
                    "2019-10-30T08:20:00Z",
                    0
                ],
                [
                    "2019-10-30T08:40:00Z",
                    100
                ],
                [
                    "2019-10-30T17:00:00Z",
                    0
                ],
                [
                    "2019-10-30T17:20:00Z",
                    0
                ],
                [
                    "2019-10-30T09:00:00Z",
                    0
                ],
                [
                    "2019-10-30T09:20:00Z",
                    0
                ],
                [
                    "2019-10-30T09:40:00Z",
                    100
                ],
                [
                    "2019-10-30T10:00:00Z",
                    0
                ],
                [
                    "2019-10-30T10:20:00Z",
                    0
                ],
                [
                    "2019-10-30T10:40:00Z",
                    100
                ],
                [
                    "2019-10-30T11:00:00Z",
                    0
                ],
                [
                    "2019-10-30T11:20:00Z",
                    0
                ],
                [
                    "2019-10-30T11:40:00Z",
                    100
                ],
                [
                    "2019-10-30T12:00:00Z",
                    0
                ],
                [
                    "2019-10-30T12:20:00Z",
                    0
                ],
                [
                    "2019-10-30T12:40:00Z",
                    100
                ],
                [
                    "2019-10-30T13:00:00Z",
                    0
                ],
                [
                    "2019-10-30T13:20:00Z",
                    0
                ],
                [
                    "2019-10-30T13:40:00Z",
                    100
                ],
                [
                    "2019-10-30T14:00:00Z",
                    0
                ],
                [
                    "2019-10-30T14:20:00Z",
                    0
                ],
                [
                    "2019-10-30T14:40:00Z",
                    100
                ],
                [
                    "2019-10-30T15:00:00Z",
                    0
                ],
                [
                    "2019-10-30T15:20:00Z",
                    0
                ],
                [
                    "2019-10-30T15:40:00Z",
                    100
                ],
                [
                    "2019-10-30T16:00:00Z",
                    0
                ],
                [
                    "2019-10-30T16:20:00Z",
                    0
                ],
                [
                    "2019-10-30T16:40:00Z",
                    100
                ],
                [
                    "2019-10-30T17:30:00Z",
                    50
                ]
            ],
            "ArmSystemEventsRequest": "/subscriptions/4f9b81be-fa32-4f96-aeb3-fc5c3f678df9/resourceGroups/test-group/providers/microsoft.insights/components/test-rule/query?query=%0d%0a++++++++++++++++systemEvents%0d%0a++++++++++++++++%7c+where+timestamp+%3e%3d+datetime(%272019-10-30T17%3a20%3a00.0000000Z%27)+%0d%0a++++++++++++++++%7c+where+itemType+%3d%3d+%27systemEvent%27+and+name+%3d%3d+%27ProactiveDetectionInsight%27+%0d%0a++++++++++++++++%7c+where+dimensions.InsightType+in+(%275%27%2c+%277%27)+%0d%0a++++++++++++++++%7c+where+dimensions.InsightDocumentId+%3d%3d+%27718fb0c3-425b-4185-be33-4311dfb4deeb%27+%0d%0a++++++++++++++++%7c+project+dimensions.InsightOneClassTable%2c+%0d%0a++++++++++++++++++++++++++dimensions.InsightExceptionCorrelationTable%2c+%0d%0a++++++++++++++++++++++++++dimensions.InsightDependencyCorrelationTable%2c+%0d%0a++++++++++++++++++++++++++dimensions.InsightRequestCorrelationTable%2c+%0d%0a++++++++++++++++++++++++++dimensions.InsightTraceCorrelationTable%0d%0a++++++++++++&api-version=2018-04-20",
            "LinksTable": [
                {
                    "Link": "<a href=\"https://portal.azure.com/#blade/AppInsightsExtension/ProactiveDetectionFeedBlade/ComponentId/{\"SubscriptionId\":\"4f9b81be-fa32-4f96-aeb3-fc5c3f678df9\",\"ResourceGroup\":\"test-group\",\"Name\":\"test-rule\"}/SelectedItemGroup/718fb0c3-425b-4185-be33-4311dfb4deeb/SelectedItemTime/2019-10-30T17:50:00Z/InsightType/5\" target=\"_blank\">View full details in Application Insights</a>"
                }
            ],
            "SmartDetectorId": "FailureAnomaliesDetector",
            "SmartDetectorName": "Failure Anomalies",
            "AnalysisTimestamp": "2019-10-30T17:52:32.5802978Z"
        },
        "egressConfig": {
            "displayConfig": [
                {
                    "rootJsonNode": null,
                    "sectionName": null,
                    "displayControls": [
                        {
                            "property": "DetectionSummary",
                            "displayName": "What was detected?",
                            "type": "Text",
                            "isOptional": false,
                            "isPropertySerialized": false
                        },
                        {
                            "property": "FormattedOccurenceTime",
                            "displayName": "When did this occur?",
                            "type": "Text",
                            "isOptional": false,
                            "isPropertySerialized": false
                        },
                        {
                            "property": "DetectedFailureRate",
                            "displayName": "Detected failure rate",
                            "type": "Text",
                            "isOptional": false,
                            "isPropertySerialized": false
                        },
                        {
                            "property": "NormalFailureRate",
                            "displayName": "Normal failure rate",
                            "type": "Text",
                            "isOptional": false,
                            "isPropertySerialized": false
                        },
                        {
                            "chartType": "Line",
                            "xAxisType": "Date",
                            "yAxisType": "Percentage",
                            "xAxisName": "",
                            "yAxisName": "",
                            "property": "FailureRateChart",
                            "displayName": "Failure rate over last 12 hours",
                            "type": "Chart",
                            "isOptional": false,
                            "isPropertySerialized": false
                        },
                        {
                            "defaultLoad": true,
                            "displayConfig": [
                                {
                                    "rootJsonNode": null,
                                    "sectionName": null,
                                    "displayControls": [
                                        {
                                            "showHeader": false,
                                            "columns": [
                                                {
                                                    "property": "Name",
                                                    "displayName": "Name"
                                                },
                                                {
                                                    "property": "Value",
                                                    "displayName": "Value"
                                                }
                                            ],
                                            "property": "tables[0].rows[0][0]",
                                            "displayName": "All of the failed requests had these characteristics:",
                                            "type": "Table",
                                            "isOptional": false,
                                            "isPropertySerialized": true
                                        }
                                    ]
                                }
                            ],
                            "property": "ArmSystemEventsRequest",
                            "displayName": "",
                            "type": "ARMRequest",
                            "isOptional": false,
                            "isPropertySerialized": false
                        },
                        {
                            "showHeader": false,
                            "columns": [
                                {
                                    "property": "Link",
                                    "displayName": "Link"
                                }
                            ],
                            "property": "LinksTable",
                            "displayName": "Links",
                            "type": "Table",
                            "isOptional": false,
                            "isPropertySerialized": false
                        }
                    ]
                }
            ]
        }
    },
    "id": "/subscriptions/4f9b81be-fa32-4f96-aeb3-fc5c3f678df9/resourcegroups/test-group/providers/microsoft.insights/components/test-rule/providers/Microsoft.AlertsManagement/alerts/7daf8739-ca8a-4562-b69a-ff28db4ba0a5",
    "type": "Microsoft.AlertsManagement/alerts",
    "name": "Failure Anomalies - test-rule"
}
```

## <a name="triage-and-diagnose-an-alert"></a>Рассмотрение и диагностика проблемы

Оповещение означает, что обнаружен чрезмерный рост частоты невыполненных запросов. Скорее всего, проблема возникла в приложении или его среде.

Для дальнейшего изучения щелкните View full details in Application Insights (Просмотреть полные сведения в Application Insights). Ссылки на этой странице открывают [страницу поиска](./diagnostic-search.md) с настроенным фильтром по соответствующим запросам, исключениям, зависимостям или трассировкам. 

Вы также можете открыть [портал Azure](https://portal.azure.com), перейти к ресурсу Application Insights для приложения и открыть страницу "Сбои".

Щелкнув "Диагностика сбоев", вы увидите дополнительные сведения, которые помогут вам устранить проблему.

:::image type="content" source="./media/proactive-failure-diagnostics/051.png" alt-text="Поиск по журналу диагностики." lightbox="./media/proactive-failure-diagnostics/051.png#lightbox":::

В зависимости от процента запросов и числа вовлеченных пользователей вы можете решить, насколько срочно необходимо решить проблему. В приведенном выше примере доля невыполненных запросов (78,5 %) сравнивается с нормальным показателем (2,2 %), что явно указывает на наличие проблемы. С другой стороны, она затронула только 46 пользователей. Для своего приложения вы сможете быстро понять, насколько это серьезно.

Зачастую проблему можно быстро диагностировать по имени запроса, исключениям, сбоям зависимостей и другим данным трассировки.

В этом примере произошло исключение из базы данных SQL из-за достижения лимита запросов.

:::image type="content" source="./media/proactive-failure-diagnostics/052.png" alt-text="Сведения о неудачном запросе." lightbox="./media/proactive-failure-diagnostics/052.png":::

## <a name="review-recent-alerts"></a>Просмотр последних оповещений

Щелкните **Оповещения** на странице ресурсов Application Insights, чтобы получить последние сработавшие оповещения.

:::image type="content" source="./media/proactive-failure-diagnostics/070.png" alt-text="Сводка оповещений." lightbox="./media/proactive-failure-diagnostics/070.png":::

## <a name="whats-the-difference-"></a>В чем разница?
Интеллектуальное обнаружение аномальных сбоев дополняет другие похожие компоненты Application Insights.

* [оповещения метрик](../alerts/alerts-log.md) задаются вами и могут отслеживать широкий спектр метрик, таких как производительность ЦП, частота запросов, время загрузки страниц и т. д. Их можно использовать, например, для того, чтобы добавить ресурсы. А интеллектуальное обнаружение аномальных сбоев, напротив, охватывает небольшой диапазон критически важных метрик (сейчас — только частоту неудачно выполненных запросов), почти в реальном времени оповещая вас о том, что частота неудачно выполненных запросов к веб-приложению превышает нормальный для веб-приложения уровень. В отличие от оповещений метрик, интеллектуальное обнаружение автоматически устанавливает и обновляет пороговые значения в ответ на изменения в поведении приложений. Также интеллектуальное обнаружение автоматически запускает диагностику, экономя ваше время при решении проблем.

* [Система интеллектуального обнаружение аномалий производительности](proactive-performance-diagnostics.md) использует искусственный интеллект для обнаружения необычного поведения ваших метрик без необходимости в настройке. В отличие от интеллектуального обнаружения аномальных сбоев, эта функция предназначена для поиска плохо обслуживаемых сегментов вашей системы (например, определенных страниц в определенном типе браузера). Анализ выполняется ежедневно, и обнаруженные результаты обычно не требуют таких срочных действий, как оповещения. Анализ аномальных сбоев, напротив, выполняется непрерывно на основе всех поступающих данных приложения. Если частота сбоев сервера превысит ожидаемое значение, вы получите оповещение в течение нескольких минут.

## <a name="if-you-receive-a-smart-detection-alert"></a>При возникновении оповещения интеллектуального обнаружения
*Почему мне направлено это предупреждение?*

* Мы обнаружили аномальное увеличение количества неудачных запросов по сравнению с обычными показателями за предыдущий период. После анализа сбоев и данных приложения мы предполагаем, что возникла проблема, которую необходимо решить.

*Уведомление означает, что определенно возникла какая-то неполадка?*

* Мы оповещать о нарушении или ухудшении работы приложения, однако только вы имеете полное представление о семантике и влиянии на приложение или пользователей.

*Так что же, вы просматриваете данные моего приложения?*

* Нет. Служба работает полностью в автоматическом режиме. Уведомления получаете только вы. Ваши данные остаются [конфиденциальными](./data-retention-privacy.md).

*Нужно ли мне подписаться на это оповещение?*

* Нет. У каждого приложения, которое отправляет данные запросов, имеется правило генерации оповещений интеллектуального обнаружения.

*Можно отменить подписку или настроить пересылку уведомлений моим коллегам?*

* Да, в области "Правила генерации оповещений" щелкните правило интеллектуального обнаружения, чтобы настроить его. Вы можете отключить это оповещение или изменить его получателей.

*Не могу найти письмо. Где найти уведомления на портале?*

* В журналах действий. В Azure откройте ресурс Application Insights для своего приложения и выберите "Журналы действий".

*Некоторые оповещения относятся к известным проблемам, и я не хочу получать их.*

* Можно использовать функцию подавления для [правила действий оповещения](../alerts/alerts-action-rules.md).

## <a name="next-steps"></a>Дальнейшие действия
Эти диагностические средства позволяют проверять данные, поступающие из приложения:

* [Обозреватель метрик](../essentials/metrics-charts.md)
* [Обозреватель поиска](./diagnostic-search.md)
* [Аналитика, мощный язык запросов](../logs/log-analytics-tutorial.md)

Интеллектуальное обнаружение действует автоматически. но, возможно, вам потребуется настроить некоторые дополнительные оповещения.

* [Настройка оповещений в Application Insights](../alerts/alerts-log.md)
* [Доступность веб-тестов](./monitor-web-app-availability.md)