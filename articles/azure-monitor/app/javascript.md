---
title: Application Insights Azure для веб-приложений JavaScript
description: Получение количества просмотров страниц и сеансов, данных веб-клиента, одностраничных приложений (SPA) и отслеживании закономерностей использования. Выявляйте исключения и проблемы с производительностью на веб-страницах JavaScript.
ms.topic: conceptual
ms.date: 08/06/2020
ms.custom: devx-track-js
ms.openlocfilehash: 60b3e9229adb93ce32c97c2822a465f7f629d47d
ms.sourcegitcommit: c7153bb48ce003a158e83a1174e1ee7e4b1a5461
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/15/2021
ms.locfileid: "98234364"
---
# <a name="application-insights-for-web-pages"></a>Application Insights для веб-страниц

Узнайте о производительности и использовании своей веб-страницы или приложения. При добавлении [Application Insights](app-insights-overview.md) в скрипт страницы вы получаете время загрузки страниц и вызовов AJAX, количество и сведения об исключениях браузера и ошибках AJAX, а также о количестве пользователей и сеансов. Все эти данные можно разбить по страницам, версии клиентской ОС и браузера, географическому расположению и другим показателям. Можно также настроить оповещения для определенного количества сбоев или медленной загрузки страниц. Кроме того, вставив вызовы трассировки в код JavaScript, вы можете отслеживать использование различных функций приложения веб-страницы.

Application Insights можно использовать с любыми веб-страницами — просто добавьте небольшой фрагмент кода JavaScript. Если веб-служба — [Java](java-get-started.md) или [ASP.NET](asp-net.md), вы можете использовать пакеты SDK на стороне сервера в сочетании с клиентским пакетом JavaScript SDK, чтобы получить полное представление о производительности приложения.

## <a name="adding-the-javascript-sdk"></a>Добавление пакета SDK для JavaScript

> [!IMPORTANT]
> Новые регионы Azure **должны** использовать строки подключения вместо ключей инструментирования. [Строка подключения](./sdk-connection-string.md?tabs=js) определяет ресурс, с которым необходимо связать данные телеметрии. Она также позволяет изменить конечные точки, которые ресурс будет использовать в качестве назначения для данных телеметрии. Необходимо скопировать строку подключения и добавить ее в код приложения или переменную среды.

1. Сначала требуется ресурс Application Insights. Если у вас еще нет ресурса и ключа инструментирования, следуйте инструкциям в разделе [Создание новых ресурсов](create-new-resource.md).
2. Скопируйте _ключ инструментирования_ (также известный как "iKey") или [строку подключения](#connection-string-setup) для ресурса, в который необходимо отправить данные телеметрии JavaScript (на шаге 1). Он будет добавлен в `instrumentationKey` параметр или для `connectionString` Application Insights пакета SDK для JavaScript.
3. Добавьте Application Insights пакет SDK для JavaScript на веб-страницу или в приложение одним из следующих двух вариантов:
    * [Установка NPM](#npm-based-setup)
    * [Фрагмент кода JavaScript](#snippet-based-setup)

> [!IMPORTANT]
> Для добавления пакета SDK для JavaScript в приложение используйте только один метод. Если вы используете программу установки NPM, не используйте фрагмент и наоборот.

> [!NOTE]
> Программа установки NPM устанавливает пакет SDK для JavaScript как зависимость от проекта, позволяя использовать IntelliSense, в то время как фрагмент кода извлекает пакет SDK во время выполнения. Обе поддерживают одни и те же функции. Однако разработчики, которым требуется больше пользовательских событий и конфигурации, обычно заNPM настройку, тогда как пользователи хотят быстро включить готовый веб-анализ.

### <a name="npm-based-setup"></a>Установка на основе NPM

Установите через NPM.

```sh
npm i --save @microsoft/applicationinsights-web
```

> [!Note]
> **В этот пакет включены такие вводы**, поэтому **не** нужно устанавливать отдельный пакет типов.
    
```js
import { ApplicationInsights } from '@microsoft/applicationinsights-web'

const appInsights = new ApplicationInsights({ config: {
  instrumentationKey: 'YOUR_INSTRUMENTATION_KEY_GOES_HERE'
  /* ...Other Configuration Options... */
} });
appInsights.loadAppInsights();
appInsights.trackPageView(); // Manually call trackPageView to establish the current user/session/pageview
```

### <a name="snippet-based-setup"></a>Настройка на основе фрагментов кода

Если приложение не использует NPM, вы можете напрямую инструментировать веб-страницы с помощью Application Insights, вставляя этот фрагмент в верхней части каждой страницы. Желательно, чтобы он был первым сценарием в `<head>` разделе, чтобы он мог отслеживать любые потенциальные проблемы со всеми зависимостями и при необходимости ошибки JavaScript. Если вы используете серверное приложение Блазор, добавьте фрагмент в начало файла `_Host.cshtml` в `<head>` разделе.

Для облегчения отслеживания версии фрагмента кода, используемого приложением, начиная с версии 2.5.5 в событии просмотра страницы будет включен новый тег AI. internal. snippet, который будет содержать определенную версию фрагмента кода.

Текущий фрагмент кода (приведенный ниже) будет определяться как версия "3".

```html
<script type="text/javascript">
!function(T,l,y){var S=T.location,u="script",k="instrumentationKey",D="ingestionendpoint",C="disableExceptionTracking",E="ai.device.",I="toLowerCase",b="crossOrigin",w="POST",e="appInsightsSDK",t=y.name||"appInsights";(y.name||T[e])&&(T[e]=t);var n=T[t]||function(d){var g=!1,f=!1,m={initialize:!0,queue:[],sv:"4",version:2,config:d};function v(e,t){var n={},a="Browser";return n[E+"id"]=a[I](),n[E+"type"]=a,n["ai.operation.name"]=S&&S.pathname||"_unknown_",n["ai.internal.sdkVersion"]="javascript:snippet_"+(m.sv||m.version),{time:function(){var e=new Date;function t(e){var t=""+e;return 1===t.length&&(t="0"+t),t}return e.getUTCFullYear()+"-"+t(1+e.getUTCMonth())+"-"+t(e.getUTCDate())+"T"+t(e.getUTCHours())+":"+t(e.getUTCMinutes())+":"+t(e.getUTCSeconds())+"."+((e.getUTCMilliseconds()/1e3).toFixed(3)+"").slice(2,5)+"Z"}(),iKey:e,name:"Microsoft.ApplicationInsights."+e.replace(/-/g,"")+"."+t,sampleRate:100,tags:n,data:{baseData:{ver:2}}}}var h=d.url||y.src;if(h){function a(e){var t,n,a,i,r,o,s,c,p,l,u;g=!0,m.queue=[],f||(f=!0,t=h,s=function(){var e={},t=d.connectionString;if(t)for(var n=t.split(";"),a=0;a<n.length;a++){var i=n[a].split("=");2===i.length&&(e[i[0][I]()]=i[1])}if(!e[D]){var r=e.endpointsuffix,o=r?e.location:null;e[D]="https://"+(o?o+".":"")+"dc."+(r||"services.visualstudio.com")}return e}(),c=s[k]||d[k]||"",p=s[D],l=p?p+"/v2/track":config.endpointUrl,(u=[]).push((n="SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details)",a=t,i=l,(o=(r=v(c,"Exception")).data).baseType="ExceptionData",o.baseData.exceptions=[{typeName:"SDKLoadFailed",message:n.replace(/\./g,"-"),hasFullStack:!1,stack:n+"\nSnippet failed to load ["+a+"] -- Telemetry is disabled\nHelp Link: https://go.microsoft.com/fwlink/?linkid=2128109\nHost: "+(S&&S.pathname||"_unknown_")+"\nEndpoint: "+i,parsedStack:[]}],r)),u.push(function(e,t,n,a){var i=v(c,"Message"),r=i.data;r.baseType="MessageData";var o=r.baseData;return o.message='AI (Internal): 99 message:"'+("SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details) ("+n+")").replace(/\"/g,"")+'"',o.properties={endpoint:a},i}(0,0,t,l)),function(e,t){if(JSON){var n=T.fetch;if(n&&!y.useXhr)n(t,{method:w,body:JSON.stringify(e),mode:"cors"});else if(XMLHttpRequest){var a=new XMLHttpRequest;a.open(w,t),a.setRequestHeader("Content-type","application/json"),a.send(JSON.stringify(e))}}}(u,l))}function i(e,t){f||setTimeout(function(){!t&&m.core||a()},500)}var e=function(){var n=l.createElement(u);n.src=h;var e=y[b];return!e&&""!==e||"undefined"==n[b]||(n[b]=e),n.onload=i,n.onerror=a,n.onreadystatechange=function(e,t){"loaded"!==n.readyState&&"complete"!==n.readyState||i(0,t)},n}();y.ld<0?l.getElementsByTagName("head")[0].appendChild(e):setTimeout(function(){l.getElementsByTagName(u)[0].parentNode.appendChild(e)},y.ld||0)}try{m.cookie=l.cookie}catch(p){}function t(e){for(;e.length;)!function(t){m[t]=function(){var e=arguments;g||m.queue.push(function(){m[t].apply(m,e)})}}(e.pop())}var n="track",r="TrackPage",o="TrackEvent";t([n+"Event",n+"PageView",n+"Exception",n+"Trace",n+"DependencyData",n+"Metric",n+"PageViewPerformance","start"+r,"stop"+r,"start"+o,"stop"+o,"addTelemetryInitializer","setAuthenticatedUserContext","clearAuthenticatedUserContext","flush"]),m.SeverityLevel={Verbose:0,Information:1,Warning:2,Error:3,Critical:4};var s=(d.extensionConfig||{}).ApplicationInsightsAnalytics||{};if(!0!==d[C]&&!0!==s[C]){method="onerror",t(["_"+method]);var c=T[method];T[method]=function(e,t,n,a,i){var r=c&&c(e,t,n,a,i);return!0!==r&&m["_"+method]({message:e,url:t,lineNumber:n,columnNumber:a,error:i}),r},d.autoExceptionInstrumented=!0}return m}(y.cfg);(T[t]=n).queue&&0===n.queue.length&&n.trackPageView({})}(window,document,{
src: "https://az416426.vo.msecnd.net/scripts/b/ai.2.min.js", // The SDK URL Source
//name: "appInsights", // Global SDK Instance name defaults to "appInsights" when not supplied
//ld: 0, // Defines the load delay (in ms) before attempting to load the sdk. -1 = block page load and add to head. (default) = 0ms load after timeout,
//useXhr: 1, // Use XHR instead of fetch to report failures (if available),
//crossOrigin: "anonymous", // When supplied this will add the provided value as the cross origin attribute on the script tag 
cfg: { // Application Insights Configuration
    instrumentationKey: "YOUR_INSTRUMENTATION_KEY_GOES_HERE"
    /* ...Other Configuration Options... */
}});
</script>
```

> [!NOTE]
> Для удобства чтения и сокращения возможных ошибок JavaScript все возможные варианты настройки перечислены в новой строке в коде фрагмента кода выше, если вы не хотите изменять значение строки с комментарием, ее можно удалить.


#### <a name="reporting-script-load-failures"></a>Отчеты о сбоях загрузки скрипта

Эта версия фрагмента кода обнаруживает и сообщает об ошибках при загрузке пакета SDK из сети CDN в качестве исключения на портале Azure Monitor (в &gt; обозревателе исключений "ошибки &gt; ") это исключение предоставляет сведения о сбоях этого типа, чтобы вы могли знать, что приложение не передает данные телеметрии (или другие исключения), как ожидалось. Этот сигнал является важным фактором, позволяющим понять, что вы потеряли данные телеметрии, так как пакет SDK не загружался или не инициализируется, что может привести к следующим проблемам:
- В разделе — Отчеты о том, как пользователи используют (или пытаются использовать) ваш сайт;
- Отсутствуют данные телеметрии о том, как конечные пользователи используют ваш сайт;
- Отсутствуют ошибки JavaScript, которые потенциально могут заблокировать конечные пользователи для успешного использования сайта.

Дополнительные сведения об этом исключении см. на странице устранения неполадок [при загрузке пакета SDK](javascript-sdk-load-failure.md) .

Отчет об этом сбое в качестве исключения на портале не использует параметр конфигурации ```disableExceptionTracking``` из конфигурации Application Insights, поэтому при возникновении этого сбоя он всегда будет передан во фрагмент, даже если поддержка Window. OnError отключена.

Отчеты о сбоях загрузки пакета SDK специально не поддерживаются в IE 8 (или менее). Это помогает уменьшить размер минифицированные фрагмента, предполагая, что большинство сред не имеют исключительно IE 8 или меньше. Если у вас есть это требование и вы хотите получать эти исключения, необходимо либо включить выборку поли Fill, либо создать собственную версию фрагмента кода, которая использует ```XDomainRequest``` вместо ```XMLHttpRequest``` , поэтому рекомендуется использовать [предоставленный исходный код фрагмента](https://github.com/microsoft/ApplicationInsights-JS/blob/master/AISKU/snippet/snippet.js) в качестве отправной точки.

> [!NOTE]
> Если вы используете предыдущую версию фрагмента кода, настоятельно рекомендуется выполнить обновление до последней версии, чтобы получить эти ранее недокументированные проблемы.

#### <a name="snippet-configuration-options"></a>Параметры конфигурации фрагментов

Все параметры конфигурации теперь были перемещены в конец сценария, чтобы избежать случайного введения ошибок JavaScript, которые не приведут к сбою загрузки пакета SDK, но также отключают отчеты об ошибках.

Каждый параметр конфигурации показан выше на новой строке. Если вы не хотите переопределять значение по умолчанию для элемента, указанного как [необязательно], эту строку можно удалить, чтобы максимально ограничить размер возвращаемой страницы.

Доступные параметры конфигурации

| Имя | Тип | Описание
|------|------|----------------
| src | String **[обязательный]** | Полный URL-адрес для загрузки пакета SDK из. Это значение используется для атрибута src динамически добавляемого &lt; скрипта или &gt; тега. Вы можете использовать общедоступное расположение CDN или свое личное размещение.
| name | String *[необязательно]* | Глобальное имя для инициализированного пакета SDK по умолчанию равно `appInsights` . Таким образом, это ```window.appInsights``` будет ссылка на инициализированный экземпляр. Примечание. Если указать значение имени или предыдущий экземпляр будет назначен (с помощью глобального имени Аппинсигхтссдк), то это значение будет также определено в глобальном пространстве имен как ```window.appInsightsSDK=<name value>``` , это требуется для кода инициализации пакета SDK, чтобы обеспечить инициализацию и обновление правильного каркаса фрагмента и прокси-методов.
| LD | число в МС *[необязательно]* | Определяет задержку загрузки для ожидания перед попыткой загрузки пакета SDK. Значение по умолчанию — 0 мс, а любое отрицательное значение сразу же добавит тег скрипта в &lt; головной &gt; регион страницы, который затем заблокирует событие загрузки страницы до тех пор, пока не будет загружен (или не завершится) сценарий.
| усексхр | Boolean *[необязательно]* | Этот параметр используется только для ошибок загрузки пакета SDK для отчетов. При создании отчетов сначала будет предпринята попытка использовать fetch (), если он доступен, а затем переходить на XHR, установив это значение равным true, просто обходит проверку выборки. Это значение необходимо использовать только в том случае, если приложение используется в среде, где при выборке не удалось отправить события сбоя.
| кроссоригин | String *[необязательно]* | Если этот параметр включен, добавленный к пакету SDK тег скрипта будет содержать атрибут Кроссоригин со строковым значением. Если не определено (по умолчанию), атрибут Кроссоригин не добавляется. Рекомендуемые значения не определены (по умолчанию); ""; или "Anonymous" (для всех допустимых значений см [. атрибут `crossorigin` HTML:](https://developer.mozilla.org/en-US/docs/Web/HTML/Attributes/crossorigin) документация)
| cfg | Object **[обязательный]** | Конфигурация, переданная в пакет SDK для Application Insights во время инициализации.

### <a name="connection-string-setup"></a>Настройка строки подключения

Для настройки NPM или Snippet можно также настроить экземпляр Application Insights с помощью строки подключения. Просто замените `instrumentationKey` поле `connectionString` полем.
```js
import { ApplicationInsights } from '@microsoft/applicationinsights-web'

const appInsights = new ApplicationInsights({ config: {
  connectionString: 'YOUR_CONNECTION_STRING_GOES_HERE'
  /* ...Other Configuration Options... */
} });
appInsights.loadAppInsights();
appInsights.trackPageView();
```

### <a name="sending-telemetry-to-the-azure-portal"></a>Отправка данных телеметрии в портал Azure

По умолчанию в Application Insights SDK для JavaScript выполняется Автосбор нескольких элементов телеметрии, которые полезны для определения работоспособности приложения и базового интерфейса пользователя. К ним относятся следующие:

- **Неперехваченные исключения** в приложении, включая сведения о
    - Трассировка стека
    - Сведения об исключении и сообщение, сопровождающее ошибку
    - Номер строки & столбца с ошибкой
    - URL-адрес, где возникла ошибка
- **Запросы зависимостей сети** , выполняемые **XHR** и **извлечением** приложения (получение коллекции отключено по умолчанию), включение информации о
    - URL-адрес источника зависимостей
    - Метод & Command, используемый для запроса зависимости
    - Длительность запроса
    - Код результата и состояние успеха запроса
    - Идентификатор (если есть) пользователя, выполняющего запрос
    - Контекст корреляции (если есть), где выполняется запрос
- **Сведения о пользователе** (например, расположение, сеть, IP-адрес)
- **Сведения об устройстве** (например, "браузер", "ОС", "версия", "язык", "модель")
- **Сведения о сеансе**

### <a name="telemetry-initializers"></a>Инициализаторы телеметрии
Инициализаторы телеметрии используются для изменения содержимого собранных данных телеметрии перед их отправкой из браузера пользователя. Они также могут использоваться для предотвращения отправки определенных данных телеметрии путем возврата `false` . К экземпляру Application Insights можно добавить несколько инициализаторов телеметрии и они выполняются в порядке их добавления.

Входной аргумент для `addTelemetryInitializer` является обратным вызовом, который принимает в [`ITelemetryItem`](https://github.com/microsoft/ApplicationInsights-JS/blob/master/API-reference.md#addTelemetryInitializer) качестве аргумента и возвращает `boolean` или `void` . При возврате `false` элемент телеметрии не отправляется, в противном случае переходит к следующему инициализатору телеметрии, если таковой имеется или отправляется в конечную точку коллекции телеметрии.

Пример использования инициализаторов телеметрии:
```ts
var telemetryInitializer = (envelope) => {
  envelope.data.someField = 'This item passed through my telemetry initializer';
};
appInsights.addTelemetryInitializer(telemetryInitializer);
appInsights.trackTrace({message: 'This message will use a telemetry initializer'});

appInsights.addTelemetryInitializer(() => false); // Nothing is sent after this is executed
appInsights.trackTrace({message: 'this message will not be sent'}); // Not sent
```

## <a name="configuration"></a>Конфигурация
Большинство полей конфигурации называются так, чтобы их можно было по умолчанию иметь значение false. Все поля являются необязательными, за исключением `instrumentationKey` .

| Имя | По умолчанию | Описание |
|------|---------|-------------|
| instrumentationKey | null | **Обязательно**<br>Ключ инструментирования, полученный из портал Azure. |
| accountId | null | Необязательный идентификатор учетной записи, если приложение группирует пользователей в учетные записи. Без пробелов, запятых, точек с запятой, знаков равенства или вертикальных линий |
| сессионреневалмс | 1800000 | Сеанс регистрируется, если пользователь неактивен в течение этого периода времени в миллисекундах. Значение по умолчанию — 30 минут. |
| сессионекспиратионмс | 86400000 | Сеанс заносится в журнал, если он продолжался в течение этого времени (в миллисекундах). По умолчанию — 24 часа |
| максбатчсизеинбитес | 10000 | Максимальный размер пакета телеметрии. Если пакет превышает это ограничение, он немедленно отправляется и запускается новый пакет |
| максбатчинтервал | 15 000 | Время пакетной передачи данных перед отправкой (в миллисекундах) |
| дисабликсцептионтраккинг | false | Если значение — true, исключения не собираются. Значение по умолчанию — false. |
| дисаблетелеметри | false | Если значение — true, данные телеметрии не собираются и не отправляются. Значение по умолчанию — false. |
| енабледебуг | false | Если значение — true, **внутренние** данные отладки создаются как исключение, **а не** заносятся в журнал, независимо от параметров ведения журнала пакета SDK. Значение по умолчанию — false. <br>**_Примечание._* _ Включение этого параметра приведет к потере телеметрии при возникновении внутренней ошибки. Это может быть полезно для быстрого выявления проблем с конфигурацией или использованием пакета SDK. Если вы не хотите терять данные телеметрии во время отладки, попробуйте использовать `consoleLoggingLevel` или `telemetryLoggingLevel` вместо `enableDebug` . |
| логгинглевелконсоле | 0 | Журналы _ *internal** Application Insights ошибок в консоли. <br>0: выкл., <br>1: только критические ошибки, <br>2: все (ошибки & предупреждения) |
| логгинглевелтелеметри | 1 | Отправляет **внутренние** ошибки Application Insights как данные телеметрии. <br>0: выкл., <br>1: только критические ошибки, <br>2: все (ошибки & предупреждения) |
| диагностиклогинтервал | 10000 | внутрикластерных Интервал опроса (в мс) для внутренней очереди ведения журнала |
| самплингперцентаже | 100 | Процент событий, которые будут отправлены. Значение по умолчанию — 100, то есть отправляются все события. Установите этот параметр, если хотите сохранить ограничения на данные для крупномасштабных приложений. |
| аутотраккпажевиситтиме | false | Если значение равно true, то время просмотра предыдущей инструментированной страницы отсылается и отправляется в виде данных телеметрии, а для текущего pageview запускается новый таймер. Значение по умолчанию — false. |
| дисаблеажакстраккинг | false | Если значение равно true, вызовы AJAX не собираются. Значение по умолчанию — false. |
| дисаблефетчтраккинг | Да | Если значение — true, запросы на выборку не собираются. Значение по умолчанию — true. |
| оверридепажевиевдуратион | false | Если значение — true, поведение по умолчанию trackPageView изменяется для записи окончания интервала длительности просмотра страницы при вызове trackPageView. Если для trackPageView не задано значение false и пользовательская длительность не предоставлена, то производительность просмотра страницы вычисляется с помощью API времени навигации. Значение по умолчанию — false. |
| максажакскаллспервиев | 500 | По умолчанию 500 — определяет, сколько вызовов AJAX будет отслеживаться каждым представлением страницы. Задайте значение-1, чтобы отслеживать все неограниченные вызовы AJAX на странице. |
| дисабледаталоссаналисис | Да | Если значение равно false, внутренние буферы отправителя телеметрии будут проверяться при запуске для элементов, которые еще не были отправлены. |
| дисаблекоррелатионхеадерс | false | Если значение равно false, пакет SDK добавит два заголовка ("Request-ID" и "Request-context") во все запросы зависимости, чтобы сопоставить их с соответствующими запросами на стороне сервера. Значение по умолчанию — false. |
| коррелатионхеадерексклудеддомаинс |  | Отключение заголовков корреляции для конкретных доменов |
| коррелатионхеадердомаинс |  | Включение заголовков корреляции для конкретных доменов |
| дисаблефлушонбефореунлоад | false | Значение по умолчанию — false. Если значение равно true, метод Flush не будет вызываться при триггерах событий Онбефореунлоад |
| енаблесессионсторажебуффер | Да | Значение по умолчанию — true. Если значение — true, буфер со всеми неотправленными данными телеметрии хранится в хранилище сеанса. Буфер восстанавливается при загрузке страницы |
| искукиеуседисаблед | false | Значение по умолчанию — false. Если значение — true, пакет SDK не будет хранить или считывать данные из файлов cookie. Обратите внимание, что это отключает файлы cookie пользователя и сеанса, а также подготавливает к просмотру лопасти использования и возможности. |
| кукиедомаин | null | Пользовательский домен cookie. Это полезно, если требуется предоставить общий доступ к Application Insights файлам cookie между поддоменами. |
| исретридисаблед | false | Значение по умолчанию — false. Если задано значение false, повторите попытку в 206 (частичное успешное завершение), 408 (timeout), 429 (слишком много запросов), 500 (внутренняя ошибка сервера), 503 (служба недоступна) и 0 (вне сети, только если обнаружено) |
| иссторажеуседисаблед | false | Если задано значение true, пакет SDK не будет хранить или считывать данные из локального хранилища и в хранилище сеанса. Значение по умолчанию — false. |
| исбеаконапидисаблед | Да | Если значение равно false, пакет SDK будет отсылать все данные телеметрии с помощью [API маяка](https://www.w3.org/TR/beacon) . |
| онунлоаддисаблебеакон | false | Значение по умолчанию — false. Когда вкладка закрывается, пакет SDK будет передавать все оставшиеся данные телеметрии с помощью [API маяка](https://www.w3.org/TR/beacon) . |
| сдкекстенсион | null | Задает имя расширения пакета SDK. Допускаются только буквы. Имя расширения добавляется в качестве префикса к тегу "AI. internal. Сдкверсион" (например, "ext_javascript: 2.0.0"). Значением по умолчанию является NULL. |
| исбровсерлинктраккинженаблед | false | Значение по умолчанию — false. Если значение — true, пакет SDK будет отслеживанием всех запросов на [компоновку браузера](/aspnet/core/client-side/using-browserlink) . |
| appId | null | AppId используется для корреляции между зависимостями AJAX, происходящими на стороне клиента, с запросами на стороне сервера. Если API маяка включен, он не может использоваться автоматически, но может быть задан вручную в конфигурации. Значение по умолчанию равно null |
| енаблекорскоррелатион | false | Если значение — true, пакет SDK добавит два заголовка ("Request-ID" и "Request-context") во все запросы CORS для корреляции исходящих зависимостей AJAX с соответствующими запросами на стороне сервера. Значение по умолчанию — false. |
| namePrefix | неопределенный | Необязательное значение, которое будет использоваться в качестве постфикса имени для localStorage и имени файла cookie.
| енаблеаутораутетраккинг | false | Автоматическая регистрация изменений маршрута в одностраничных приложениях (SPA). Если значение — true, каждое изменение маршрута будет отсылать новый pageview Application Insights. Изменения хэш-маршрута ( `example.com/foo#bar` ) также записываются в виде новых просмотров страниц.
| енаблерекуессеадертраккинг | false | Если значение равно true, заголовки запроса AJAX & FETCH отписываются, по умолчанию — false.
| енаблереспонсехеадертраккинг | false | Если значение равно true, то заголовки ответа на запрос AJAX & FETCH отписываются, по умолчанию — false.
| дистрибутедтраЦингмоде | `DistributedTracingModes.AI` | Задает режим распределенной трассировки. Если задан режим AI_AND_W3C или W3C, заголовки контекста трассировки W3C (трацепарент/трацестате) будут формироваться и включаться во все исходящие запросы. AI_AND_W3C предоставляется для обеспечения обратной совместимости с любыми устаревшими службами, Application Insights инструментированные. См. пример [здесь](./correlation.md#enable-w3c-distributed-tracing-support-for-web-apps).
| енаблеажаксеррорстатустекст | false | Значение по умолчанию — false. Значение true показывает, что текст данных об ошибке ответа содержится в событии зависимостей при неудачных запросах AJAX.
| енаблеажаксперфтраккинг | false | Значение по умолчанию — false. Флаг, позволяющий выполнять поиск и включение дополнительного окна браузера. время производительности в сообщаемых `ajax` (XHR и выборке) метриках.
| максажаксперфлукупаттемптс | 3 | Значение по умолчанию — 3. Максимальное количество попыток поиска в окне. время производительности (если доступно). это необходимо, так как не все браузеры заполняют окно. производительность перед созданием отчета о конце запроса XHR и о запросах на выборку добавляется после завершения.
| ажаксперфлукупделай | 25 | Значение по умолчанию — 25 мс. Время ожидания перед повторной попыткой поиска окон. `ajax` время, необходимое для запроса, равно времени в миллисекундах и передается непосредственно в setTimeout ().
| енаблеунхандледпромисережектионтраккинг | false | Если задано значение true, необработанные отклонения в обещании будут собираются и сообщаются как ошибка JavaScript. Если Дисабликсцептионтраккинг имеет значение true (не записывать исключения), значение конфигурации будет проигнорировано, а необработанные отклонения обещаний не будут выводиться.

## <a name="enable-time-on-page-tracking"></a>Включение отслеживания времени на странице

С помощью параметра `autoTrackPageVisitTime: true` время, затрачиваемое пользователем на каждую страницу, будет отслеживаниь. На каждом новом PageView время, которое пользователь тратил на *предыдущей* странице, отправляется как [Пользовательская метрика](../platform/metrics-custom-overview.md) с именем `PageVisitTime` . Эта пользовательская метрика отображается в [Обозреватель метрик](../platform/metrics-getting-started.md) как "Метрика на основе журнала".

## <a name="enable-correlation"></a>Включить корреляцию

Корреляция создает и отправляет данные, обеспечивающие распределенную трассировку и включающую [схему приложения](../app/app-map.md), [представление сквозных транзакций](../app/app-map.md#go-to-details)и другие средства диагностики.

В следующем примере показаны все возможные конфигурации, необходимые для включения корреляции, с примечаниями для конкретного сценария ниже.

```javascript
// excerpt of the config section of the JavaScript SDK snippet with correlation
// between client-side AJAX and server requests enabled.
cfg: { // Application Insights Configuration
    instrumentationKey: "YOUR_INSTRUMENTATION_KEY_GOES_HERE"
    disableFetchTracking: false,
    enableCorsCorrelation: true,
    enableRequestHeaderTracking: true,
    enableResponseHeaderTracking: true,
    correlationHeaderExcludedDomains: ['myapp.azurewebsites.net', '*.queue.core.windows.net']
    /* ...Other Configuration Options... */
}});
</script>

``` 

Если какой-либо из сторонних серверов, с которыми взаимодействует клиент, не может принять `Request-Id` `Request-Context` заголовки и, и вы не можете обновить их конфигурацию, их необходимо разместить в списке исключений через `correlationHeaderExcludeDomains` свойство конфигурации. Это свойство поддерживает подстановочные знаки.

На стороне сервера должна быть возможность принимать соединения с этими заголовками. В зависимости от `Access-Control-Allow-Headers` конфигурации на стороне сервера часто требуется расширить список на стороне сервера, вручную добавив `Request-Id` и `Request-Context` .

Access-Control-Allow-Headers: `Request-Id` , `Request-Context` , `<your header>`

> [!NOTE]
> Если вы используете Опентелемтри или Application Insights пакеты SDK, выпущенные в 2020 или более поздней версии, рекомендуется использовать [WC3 трацеконтекст](https://www.w3.org/TR/trace-context/). См [. Руководство](../app/correlation.md#enable-w3c-distributed-tracing-support-for-web-apps)по настройке конфигурации.

## <a name="single-page-applications"></a>Одностраничные приложения

По умолчанию этот пакет SDK **не** будет управлять изменением маршрута на основе состояния, которое происходит в одностраничных приложениях. Чтобы включить автоматическое отслеживание изменений маршрута для одностраничного приложения, можно добавить `enableAutoRouteTracking: true` в конфигурацию установки.

В настоящее время мы предлагаем отдельный [подключаемый модуль реагирования](javascript-react-plugin.md), который можно инициализировать с помощью этого пакета SDK. Кроме того, будет осуществляться отслеживание изменений маршрута, а также собраны другие данные телеметрии, связанные с реагированием.
> [!NOTE]
> Используйте `enableAutoRouteTracking: true` , только если **не** используется подключаемый модуль "реагирующий". Оба варианта могут отправлять новые PageViews при изменении маршрута. Если оба этих флажка включены, может быть отправлен дубликат PageViews.

## <a name="extensions"></a>Модули

| Модули |
|---------------|
| [React](javascript-react-plugin.md)|
| [React Native](javascript-react-native-plugin.md)|
| [Angular](javascript-angular-plugin.md)|
| [Щелкните Автосбор в аналитике](javascript-click-analytics-plugin.md)|

## <a name="explore-browserclient-side-data"></a>Изучение данных в браузере и на стороне клиента

Для просмотра данных в браузере и на стороне клиента можно перейти к **метрикам** и добавить отдельные метрики, которые вас интересуют:

![Снимок экрана: страница "метрики" в Application Insights показывающая графическое отображение данных метрик для веб-приложения.](./media/javascript/page-view-load-time.png)

Вы также можете просмотреть данные из пакета SDK для JavaScript, используя интерфейс браузера на портале.

Выберите **браузер** , а затем выберите **сбои** или **производительность**.

![Снимок экрана страницы браузера в Application Insights показывает, как добавить сбои браузера или производительность браузера в метрики, которые можно просмотреть для веб-приложения.](./media/javascript/browser.png)

### <a name="performance"></a>Производительность

![Снимок экрана со страницей "производительность" в Application Insights отображение графических показателей операций для веб-приложения.](./media/javascript/performance-operations.png)

### <a name="dependencies"></a>Зависимости

![Снимок экрана со страницей "производительность" в Application Insights отображение графики метрик зависимости для веб-приложения.](./media/javascript/performance-dependencies.png)

### <a name="analytics"></a>Аналитика

Чтобы запросить данные телеметрии, собранные с помощью пакета SDK для JavaScript, нажмите кнопку **Просмотр в журналах (аналитика)** . Добавив `where` оператор `client_Type == "Browser"` , вы увидите только данные из пакета SDK для JavaScript, и все телеметрии на стороне сервера, собранные другими пакетами SDK, будут исключены.
 
```kusto
// average pageView duration by name
let timeGrain=5m;
let dataset=pageViews
// additional filters can be applied here
| where timestamp > ago(1d)
| where client_Type == "Browser" ;
// calculate average pageView duration for all pageViews
dataset
| summarize avg(duration) by bin(timestamp, timeGrain)
| extend pageView='Overall'
// render result in a chart
| render timechart
```

### <a name="source-map-support"></a>Поддержка исходной схемы

Стек вызовов минифицированные для телеметрии исключений может быть унминифиед в портал Azure. Все существующие интеграции на панели сведений об исключении будут работать с вновь унминифиед стека вызовов.

#### <a name="link-to-blob-storage-account"></a>Ссылка на учетную запись хранения BLOB-объектов

Вы можете связать ресурс Application Insights с контейнером хранилища BLOB-объектов Azure, чтобы автоматически деминификацию стеки вызовов. Чтобы приступить к работе, см. раздел [Автоматическая поддержка карт исходного кода](./source-map-support.md).

### <a name="drag-and-drop"></a>Перетаскивание

1. Выберите элемент телеметрии исключения в портал Azure, чтобы просмотреть сведения о сквозной транзакции.
2. Определяет, какие исходные карты соответствуют этому стеку вызовов. Исходная таблица должна соответствовать исходному файлу кадра стека, но с суффиксом `.map`
3. Перетащите карты источника в стек вызовов в портал Azure ![ анимированное изображение, показывающее, как перетаскивать файлы сопоставления исходного кода из папки сборки в окно стека вызовов в портал Azure.](https://i.imgur.com/Efue9nU.gif)

### <a name="application-insights-web-basic"></a>Application Insights Web Basic

Для упрощения работы можно вместо этого установить базовую версию Application Insights
```
npm i --save @microsoft/applicationinsights-web-basic
```
Эта версия поставляется с минимальным числом функций и функциональных возможностей и зависит от того, как вы видите. Например, он не выполняет Автосбор (неперехваченные исключения, AJAX и т. д.). API-интерфейсы для отправки определенных типов телеметрии, например `trackTrace` , и `trackException` т. д., не включены в эту версию, поэтому необходимо предоставить собственную оболочку. Единственный доступный API — `track` . [Пример](https://github.com/Azure-Samples/applicationinsights-web-sample1/blob/master/testlightsku.html) находится здесь.

## <a name="examples"></a>Примеры

Примеры готовности к запуску см. в разделе [Application Insights примеров SDK для JavaScript](https://github.com/Azure-Samples?q=applicationinsights-js-demo).

## <a name="upgrading-from-the-old-version-of-application-insights"></a>Обновление старой версии Application Insights

Критические изменения в версии пакета SDK v2:
- Чтобы обеспечить лучшую сигнатуру API, некоторые вызовы API, такие как trackPageView и trackException, были обновлены. Запуск в Internet Explorer 8 и более ранних версиях браузера не поддерживается.
- В связи с обновлением схемы данных в конверте телеметрии изменились имя и структура поля.
- Перемещено `context.operation` в `context.telemetryTrace` . Некоторые поля были также изменены ( `operation.id`  -->  `telemetryTrace.traceID` ).
  - Чтобы вручную обновить текущий идентификатор pageview (например, в приложениях SPA), используйте `appInsights.properties.context.telemetryTrace.traceID = Microsoft.ApplicationInsights.Telemetry.Util.generateW3CId()` .
    > [!NOTE]
    > Чтобы идентификатор трассировки был уникальным, где ранее использовался `Util.newId()` , теперь используйте `Util.generateW3CId()` . Как и в конечном итоге, это идентификатор операции.

Если вы используете текущий пакет SDK Application Insights (1.0.20) и хотите узнать, работает ли новый пакет SDK в среде выполнения, обновите URL-адрес в зависимости от текущего сценария загрузки пакета SDK.

- Загрузка с помощью сценария CDN. Обновите фрагмент кода, который сейчас используется для указания следующего URL-адреса:
   ```
   "https://az416426.vo.msecnd.net/scripts/b/ai.2.min.js"
   ```

- сценарий NPM. вызовите, `downloadAndSetup` чтобы скачать полный скрипт ApplicationInsights из CDN и инициализировать его с помощью ключа инструментирования:

   ```ts
   appInsights.downloadAndSetup({
     instrumentationKey: "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxx",
     url: "https://az416426.vo.msecnd.net/scripts/b/ai.2.min.js"
     });
   ```

Протестируйте во внутренней среде, чтобы убедиться, что данные телеметрии мониторинга работают должным образом. Если все работает, обновите сигнатуры API в соответствии с версией пакета SDK версии 2 и выполните развертывание в рабочих средах.

## <a name="sdk-performanceoverhead"></a>Производительность и затраты на пакет SDK

Только в 36 КБ со сжатием gzip и при инициализации только ~ 15 мс Application Insights добавляет незначительное количество лоадтиме на веб-сайт. С помощью фрагмента кода можно быстро загрузить минимальные компоненты библиотеки. В то же время полный скрипт загружается в фоновом режиме.

Хотя скрипт скачивается из CDN, все отслеживание вашей страницы помещается в очередь. Когда загруженный скрипт завершает асинхронную инициализацию, отправляются все события, которые были поставлены в очередь. В результате все данные телеметрии не будут потеряны в течение всего жизненного цикла страницы. Этот процесс установки обеспечивает полную систему анализа, невидимую для пользователей.

> Сводка:
> - ![Версия NPM](https://badge.fury.io/js/%40microsoft%2Fapplicationinsights-web.svg)
> - ![Сжатый размер gzip](https://img.badgesize.io/https://js.monitor.azure.com/scripts/b/ai.2.min.js.svg?compression=gzip)
> - **15 мс** общее время инициализации
> - **Нулевое** отслеживание, пропущенное во время жизненного цикла страницы

## <a name="browser-support"></a>Поддержка браузеров

![Chrome](https://raw.githubusercontent.com/alrra/browser-logos/master/src/chrome/chrome_48x48.png) | ![Firefox](https://raw.githubusercontent.com/alrra/browser-logos/master/src/firefox/firefox_48x48.png) | ![IE](https://raw.githubusercontent.com/alrra/browser-logos/master/src/edge/edge_48x48.png) | ![Opera](https://raw.githubusercontent.com/alrra/browser-logos/master/src/opera/opera_48x48.png) | ![Safari](https://raw.githubusercontent.com/alrra/browser-logos/master/src/safari/safari_48x48.png)
--- | --- | --- | --- | --- |
Последняя ✔ Chrome |  Последние ✔ Firefox | Internet Explorer 9 + & пограничных ✔<br>IE 8 — совместимо | ✔ Opera последней версии | Самый последний ✔ Safari |

## <a name="es3ie8-compatibility"></a>Совместимость ES3 и IE8

В качестве пакета SDK существует множество пользователей, которые не могут управлять браузерами, используемыми клиентами. Поэтому необходимо убедиться, что этот пакет SDK переходит в рабочее состояние и не нарушает выполнение JS при загрузке в более старом браузере. Несмотря на то, что лучше не поддерживать браузеры IE8 и более ранних версий (ES3), существует множество крупных клиентов и пользователей, которые по-прежнему требуют для работы страниц, и, как отмечалось, может или не может контролировать, какой браузер следует использовать для их конечных пользователей.

Это не значит, что мы будем поддерживать только самый низкий распространенный набор функций, только если нам нужно поддерживать совместимость кода ES3 и при добавлении новых функций их потребуется добавить способом, который не нарушает синтаксический анализ ES3 JavaScript и не добавляется в качестве дополнительной функции.

[Полные сведения о поддержке IE8 см. в GitHub.](https://github.com/Microsoft/ApplicationInsights-JS#es3ie8-compatibility)

## <a name="open-source-sdk"></a>Пакет SDK с открытым исходным кодом

Application Insights SDK JavaScript является открытым кодом для просмотра исходного кода или для участия в проекте посетите [официальный репозиторий GitHub](https://github.com/Microsoft/ApplicationInsights-JS). 

Последние обновления и исправления ошибок см. [в заметках о выпуске](./release-notes.md).

## <a name="next-steps"></a><a name="next"></a> Дальнейшие действия
* [Отслеживание использования](usage-overview.md)
* [Пользовательские события и метрики](api-custom-events-metrics.md)
* [Сборка, измерение и обучение](usage-overview.md)
* [Устранение неполадок при загрузке пакета SDK](javascript-sdk-load-failure.md)
