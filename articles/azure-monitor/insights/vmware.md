---
title: Мониторинг VMware решение в Azure Monitor | Документация Майкрософт
description: Узнайте о том, как решение для мониторинга VMware помогает управлять журналами событий и отслеживать узлы ESXi.
ms.topic: conceptual
author: bwren
ms.author: bwren
ms.date: 05/04/2018
ms.openlocfilehash: 9ade5a51e2251669daee6fbaca9aa4c50f7e9bfc
ms.sourcegitcommit: c27a20b278f2ac758447418ea4c8c61e27927d6a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/03/2021
ms.locfileid: "101704367"
---
# <a name="vmware-monitoring-deprecated-solution-in-azure-monitor"></a>Мониторинг VMware (не рекомендуется) решение в Azure Monitor

![Символ VMware](./media/vmware/vmware-symbol.png)

> [!NOTE]
> Решение для мониторинга VMware больше не поддерживается.  Пользователи, установившие его, могут продолжать работать с ним, но это решение нельзя добавить в новые рабочие области.

Решение Мониторинг VMware в Azure Monitor — это решение, которое помогает создать централизованный подход к ведению журналов и мониторинга для крупных журналов VMware. В статье описано, как с помощью этого решения централизованно устранять неполадки, связанные с узлами ESXi, а также регистрировать их и управлять ими. В решении можно увидеть подробные данные для всех узлов ESXi в одном расположении. В журналах узла ESXi вы можете просматривать счетчики основных событий, а также состояния и тенденции ВМ и узлов ESXi. Вы также можете устранять неполадки, просматривая централизованные журналы узлов ESXi и выполняя поиск в них. И наоборот, можно создавать оповещения на основе поисковых запросов по журналам.

В решении для отправки данных на целевую виртуальную машину, где установлен агент Log Analytics, используются встроенные функции системного журнала узла ESXi. Однако решение не предусматривает запись файлов в системный журнал целевой виртуальной машины. Агент Log Analytics открывает порт 1514 и прослушивает его. После получения данных агент Log Analytics отправляет данные в Azure Monitor.

## <a name="install-and-configure-the-solution"></a>Установка и настройка решения
Для установки и настройки решений используйте указанные ниже данные.

* Добавьте решение для мониторинга VMware в подписку, используя процесс, описанный в разделе [Установка решения по мониторингу](./solutions.md#install-a-monitoring-solution).

#### <a name="supported-vmware-esxi-hosts"></a>Поддерживаемые узлы VMware ESXi
vSphere ESXi Host версий 5.5, 6.0 и 6.5

#### <a name="prepare-a-linux-server"></a>Подготовка сервера под управлением Linux
Создайте ВМ с ОС Linux, чтобы получать все данные системных журналов от узлов ESXi. [Агент Log Analytics для Linux](../vm/quick-collect-linux-computer.md) — это точка сбора всех данных системных журналов узлов ESXi. Можно использовать несколько узлов ESXi для пересылки журналов на отдельный сервер под управлением Linux, как показано в следующем примере.

[!INCLUDE [log-analytics-agent-note](../../../includes/log-analytics-agent-note.md)]  

   ![Поток данных системных журналов](./media/vmware/diagram.png)

### <a name="configure-syslog-collection"></a>Настройка сбора системных журналов
1. Настройте пересылку системных журналов для VSphere. Подробные сведения о настройке пересылки системных журналов в ESXi 5.0 и более поздних версиях см. [здесь](https://kb.vmware.com/selfservice/microsites/search.do?language=en_US&cmd=displayKC&externalId=2003322). Последовательно выберите **Конфигурация узла ESXi**  >  **программное обеспечение**  >  **Advanced Settings**  >  **syslog**.
   ![vsphereconfig](./media/vmware/vsphere1.png)  
1. В поле *Syslog.global.logHost* укажите сервер Linux и номер порта *1514*. Например, `tcp://hostname:1514` или `tcp://123.456.789.101:1514`
1. Откройте брандмауэр узла ESXi для системного журнала. **Конфигурация**  >  узла ESXi **Программное обеспечение**  >  **Профиль безопасности**  >  **Брандмауэр** и открыть **свойства**.  

    ![vspherefw](./media/vmware/vsphere2.png)  

    ![vspherefwproperties](./media/vmware/vsphere3.png)  
1. Проверьте консоль vSphere, чтобы удостовериться в правильной настройке системного журнала. Подтвердите на узле ESXI, что этот порт **1514** настроен.
1. Скачайте и установите агент Log Analytics для Linux на сервере Linux. Дополнительные сведения см. в [документации по агенту Log Analytics для Linux](https://github.com/Microsoft/OMS-Agent-for-Linux).
1. Установив агент Log Analytics для Linux, перейдите в каталог /etc/opt/microsoft/omsagent/sysconf/omsagent.d и скопируйте файл vmware_esxi.conf в каталог /etc/opt/microsoft/omsagent/conf/omsagent.d. Измените владельца или группу и разрешения для файла. Пример.

    ```
    sudo cp /etc/opt/microsoft/omsagent/sysconf/omsagent.d/vmware_esxi.conf /etc/opt/microsoft/omsagent/conf/omsagent.d
   sudo chown omsagent:omiusers /etc/opt/microsoft/omsagent/conf/omsagent.d/vmware_esxi.conf
    ```
1. Перезапустите агент Log Analytics для Linux, выполнив `sudo /opt/microsoft/omsagent/bin/service_control restart`.
1. Проверьте подключение между сервером Linux и узлом ESXi, выполнив команду `nc` на узле ESXi. Пример.

    ```
    [root@ESXiHost:~] nc -z 123.456.789.101 1514
    Connection to 123.456.789.101 1514 port [tcp/*] succeeded!
    ```

1. В портал Azure выполните запрос журнала для `VMware_CL` . Когда Azure Monitor собирает данные системного журнала, он сохраняет формат системного журнала. На портале регистрируются некоторые поля, включая *Hostname* и *ProcessName*.  

    ![На снимке экрана показан запрос журнала для типа = VMware_CL с результатом с меткой времени.](./media/vmware/type.png)  

    Если представление с результатами поиска по журналам похоже на изображенное выше, это значит, что панель мониторинга для соответствующего решения для мониторинга VMware настроена.  

## <a name="vmware-data-collection-details"></a>Сведения о сборе данных VMware
Решение для мониторинга VMware собирает разные метрики производительности и данные журналов на узлах ESXi с помощью включенных агентов Log Analytics для Linux.

В следующей таблице содержатся методы сбора данных и другие связанные сведения.

| platform | Агент Log Analytics для Linux | Агент System Center Operations Manager | Хранилище Azure | Нужен ли Operations Manager? | Отправка данных агента Operations Manager через группу управления | Частота сбора |
| --- | --- | --- | --- | --- | --- | --- |
| Linux |&#8226; |  |  |  |  |Каждые 3 минуты |

В следующей таблице приведены примеры типов данных, собираемых решением для мониторинга VMware.

| Имя поля | description; |
| --- | --- |
| Device_s |Запоминающие устройства VMware |
| ESXIFailure_s |Типы сбоев |
| EventTime_t |Время возникновения события |
| HostName_s |Имя узла ESXi |
| Operation_s |Создание или удаление ВМ |
| ProcessName_s |Имя события |
| ResourceId_s |Имя узла VMware |
| ResourceLocation_s |VMware |
| ResourceName_s |VMware |
| ResourceType_s |Hyper-V |
| SCSIStatus_s |Состояние VMware SCSI |
| SyslogMessage_s |Данные системного журнала |
| UserName_s |Пользователь, создавший или удаливший ВМ |
| VMName_s |имя виртуальной машины; |
| Компьютер |Главный компьютер |
| TimeGenerated |Время создания данных |
| DataCenter_s |Центр обработки данных VMware |
| StorageLatency_s |Задержка хранилища (мс) |

## <a name="vmware-monitoring-solution-overview"></a>Обзор решения для мониторинга VMware
Элемент "VMware" отображается в рабочей области Log Analytics. Решение отображает обобщенное представление ошибок. Щелкнув плитку, вы перейдете в представление панели мониторинга.

![На снимке экрана показана плитка VMware, отображающая девять сбоев.](./media/vmware/tile.png)

#### <a name="navigate-the-dashboard-view"></a>Навигация в представлении панели мониторинга
В представлении панели мониторинга **VMware** колонки упорядочены по следующим категориям:

* число состояний сбоя;
* основной узел по счетчикам событий;
* счетчики основных событий;
* действия виртуальной машины;
* события диска узла ESXi.

![Решение 1](./media/vmware/solutionview1-1.png)

![Решение 2](./media/vmware/solutionview1-2.png)

Щелкните любую колонку, чтобы открыть область поиска Log Analytics с соответствующими подробными сведениями.

Здесь можно изменить запрос журнала, чтобы изменить его для чего-либо конкретного. Дополнительные сведения о создании запросов журналов см. [в разделе Поиск данных с помощью запросов журналов в Azure Monitor](../logs/log-query-overview.md).

#### <a name="find-esxi-host-events"></a>Поиск событий узлов ESXi
Для одного узла ESXi создается несколько журналов на основе выполняющихся процессов. Решение для мониторинга VMware объединяет их, суммируя счетчики событий. Это централизованное представление помогает понять, на каком узле ESXi происходит больше всего событий и какие именно события происходят в вашей среде чаще всего.

![event](./media/vmware/events.png)

Чтобы просмотреть дополнительные сведения, щелкните узел ESXi или тип события.

Щелкнув имя узла ESXi, вы сможете просмотреть сведения, связанные с этим узлом ESXi. Чтобы отфильтровать результаты по типу события, добавьте `“ProcessName_s=EVENT TYPE”` в поисковом запросе. Можно выбрать **ProcessName** в фильтре поиска. Это поможет ограничить поиск.

![Снимок экрана ESXi узла с числом событий и разбивкой по типам событий в представлении панели мониторинга Мониторинг VMware.](./media/vmware/eventhostdrilldown.png)

#### <a name="find-high-vm-activities"></a>Поиск активных действий ВМ
Виртуальные машины могут создаваться и удаляться на любом узле ESXi. Администраторам часто требуется знать, сколько ВМ создается узлом ESXi. Это помогает оценить производительность и рассчитать использование ресурсов. При управлении средой очень важно отслеживать события действий ВМ.

![Снимок экрана: колонка "действия виртуальной машины" на панели мониторинга Мониторинг VMware, в которой показан график создания и удаления виртуальных машин узлом ESXi.](./media/vmware/vmactivities1.png)

Чтобы просмотреть дополнительные данные о создании ВМ узлом ESXi, щелкните имя узла ESXi.

![Снимок экрана панели Мониторинг VMware панели мониторинга, показывающей таблицу со строкой данных для каждого создания виртуальной машины узлом ESXi.](./media/vmware/createvm.png)

#### <a name="common-log-queries"></a>Общие запросы журналов
Решение включает и другие полезные запросы, которые помогают управлять узлами ESXi узлов. Сюда входят запросы к данным о переполнении дискового пространства, задержках хранилища и сбоях пути.

![На снимке экрана показаны рекомендуемые ПОИСКовые запросы, которые полезны для хранения запросов.](./media/vmware/queries.png)


#### <a name="save-queries"></a>Сохранение запросов
Сохранение запросов журнала — это стандартная функция в Azure Monitor и может помочь в сохранении любых полезных запросов. Создав запрос, который вы считаете полезным, сохраните его, щелкнув **Избранное**. Сохранение запроса позволяет без труда использовать его позже на странице [Моя панель мониторинга](../visualize/tutorial-logs-dashboards.md), где вы можете создавать собственные настраиваемые панели мониторинга.

![На снимке экрана показана часть пользовательской панели мониторинга с метками Поиск по журналам со значками для отмены, экспорта, оповещения, сохранения, избранного и журнала.](./media/vmware/dockerdashboardview.png)

#### <a name="create-alerts-from-queries"></a>Создание оповещений из запросов
Созданные запросы можно использовать для оповещения при возникновении определенных событий. Подробные сведения о создании оповещений см. в статье [Оповещения в Log Analytics](../alerts/alerts-overview.md). Примеры оповещающих и других запросов см. в записи блога [Monitor VMware using OMS Log Analytics](/archive/blogs/msoms/monitor-vmware-using-oms-log-analytics) (Мониторинг VMware с помощью OMS Log Analytics).

## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы
### <a name="what-do-i-need-to-do-on-the-esxi-host-setting-what-impact-will-it-have-on-my-current-environment"></a>Что нужно настраивать для узла ESXi? Какое влияние это окажет на мою текущую среду?
В решении используется встроенный механизм перенаправления системного журнала узла ESXi. Для ведения журналов на узле ESXi не нужно устанавливать дополнительное программное обеспечение Майкрософт. Существенное влияние на имеющуюся среду не оказывается. Тем не менее необходимо настроить перенаправление системного журнала, что является функцией ESXi.

### <a name="do-i-need-to-restart-my-esxi-host"></a>Нужно ли перезапускать узел ESXi?
Нет. Для этого процесса перезапуск не требуется. В некоторых случаях vSphere не обновляет системный журнал надлежащим образом. В таком случае войдите на узел ESXi и перезагрузите системный журнал. Опять же, узел перезапускать не нужно, поэтому этот процесс не нарушает работу в среде.

### <a name="can-i-increase-or-decrease-the-volume-of-log-data-sent-to-log-analytics"></a>Можно ли увеличить или уменьшить объем данных журнала, отправляемых в Log Analytics?
Да, можно. В vSphere можно использовать параметры уровня ведения журнала узла ESXi. Сбор данных журналов основан на уровне *info*. Таким образом, если нужно выполнить аудит создания или удаления виртуальной машины, необходимо задать уровень *info* для Hostd. Дополнительные сведения см. в [базе знаний VMware](https://kb.vmware.com/selfservice/microsites/search.do?&cmd=displayKC&externalId=1017658).

### <a name="why-is-hostd-not-providing-data-to-log-analytics-my-log-setting-is-set-to-info"></a>Почему Hostd не предоставляет данные в Log Analytics? Для моего параметра журнала установлено значение info.
Произошла ошибка узла ESXi, касающаяся метки времени системного журнала. Дополнительные сведения см. в [базе знаний VMware](https://kb.vmware.com/selfservice/microsites/search.do?language=en_US&cmd=displayKC&externalId=2111202). После применения обходного решения Hostd должен работать нормально.

### <a name="can-i-have-multiple-esxi-hosts-forwarding-syslog-data-to-a-single-vm-with-omsagent"></a>Можно ли иметь несколько узлов ESXi, которые пересылают данные системного журнала на одну виртуальную машину с агентом OMS?
Да. Вы можете иметь несколько узлов ESXi, которые пересылают данные системного журнала в одну виртуальную машину с агентом OMS.

### <a name="why-dont-i-see-data-flowing-into-log-analytics"></a>Почему не отображается поступление данных в Log Analytics?
Это может быть вызвано несколькими причинами.

* Узел ESXi неправильно передает данные на виртуальную машину под управлением агента OMS. Чтобы проверить это, сделайте следующее:

  1. Войдите на узел ESXi с помощью SSH и выполните следующую команду: `nc -z ipaddressofVM 1514`

      Если команда завершится ошибкой, скорее всего, параметры vSphere в расширенной конфигурации настроены неправильно. Сведения о том, как настроить узел ESXi для перенаправления системного журнала, см. в разделе [Настройка сбора системных журналов](#configure-syslog-collection).
  1. Если подключение к порту системного журнала выполнено успешно, но данные не отображаются, перезагрузите системный журнал на узле ESXi с помощью SSH и выполните следующую команду: `esxcli system syslog reload`
* Виртуальная машина с агентом Log Analytics настроена неправильно. Чтобы проверить это, сделайте следующее:

  1. Log Analytics ожидает передачи данных через порт 1514. Чтобы проверить, что он открыт, выполните следующую команду: `netstat -a | grep 1514`
  1. Вы увидите, что порт `1514/tcp` открыт. В противном случае проверьте, правильно ли установлен агент OMS. Если сведения о порте не отображаются, порт системного журнала не открыт на виртуальной машине.

    а. Убедитесь, что агент Log Analytics запущен, с помощью `ps -ef | grep oms`. Если это не так, запустите его, выполнив команду `sudo /opt/microsoft/omsagent/bin/service_control start`

     b. Откройте файл `/etc/opt/microsoft/omsagent/conf/omsagent.d/vmware_esxi.conf`.

     c. Убедитесь, что настройки пользователей и группы допустимы. Они должны выглядеть следующим образом: `-rw-r--r-- 1 omsagent omiusers 677 Sep 20 16:46 vmware_esxi.conf`

     d. Если файл не существует или настройки пользователя и группы неправильны, выполните действия по исправлению, приведенные в разделе [Подготовка сервера под управлением Linux](#prepare-a-linux-server).

## <a name="next-steps"></a>Дальнейшие действия
* Используйте [запросы журналов в Log Analytics](../logs/log-query-overview.md) для просмотра подробных данных об узле VMware.
* [Создавайте собственные панели мониторинга](../visualize/tutorial-logs-dashboards.md), отображающие данные об узле VMware.
* [Создавайте оповещения](../alerts/alerts-overview.md), информирующие о возникновении определенных событий узла VMware.

