---
title: Мониторинг затрат на Azure Monitor для контейнеров | Документация Майкрософт
description: В этой статье описываются затраты на мониторинг метрик & данных инвентаризации, собираемых Azure Monitor для контейнеров, которые помогают клиентам управлять их использованием и связанными затратами.
ms.topic: conceptual
ms.date: 05/29/2020
ms.openlocfilehash: 81a20f564af68c3da6d63394e4cffe7caed91b46
ms.sourcegitcommit: de98cb7b98eaab1b92aa6a378436d9d513494404
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/17/2021
ms.locfileid: "100561594"
---
# <a name="understand-monitoring-costs-for-azure-monitor-for-containers"></a>Затраты на мониторинг контейнеров с помощью Azure Monitor

В этой статье содержатся рекомендации по использованию Azure Monitor для контейнеров, которые помогут вам понять следующее:

* Оценка затрат перед включением этого анализа

* Как измерять затраты после Azure Monitor для контейнеров включено для одного или нескольких контейнеров

* Управление сбором данных и снижение затрат

Azure Monitor журналы собирает, индексирует и сохраняет данные, созданные кластером Kubernetes. 

Модель ценообразования Azure Monitor в основном зависит от объема данных, принимаемых в гигабайтах в день в рабочую область Log Analytics. Стоимость Log Analytics рабочей области не зависит только от объема собираемых данных, он также зависит от выбранного плана и от того, сколько времени выбрано для хранения данных, созданных из кластеров.

>[!NOTE]
>Все размеры и цены предназначены только для оценки образца. Дополнительные сведения о ценах на Azure Monitor Log Analytics и регионе Azure см. на странице [цен](https://azure.microsoft.com/pricing/details/monitor/) на Azure Monitor.

Ниже приведена сводка по типам данных, собираемых из кластера Kubernetes, с Azure Monitor для контейнеров, которые влияют на затраты и могут быть настроены в зависимости от использования.

- Stdout, stderr журналы контейнеров из каждого отслеживаемого контейнера в каждом пространстве имен Kubernetes в кластере

- Переменные среды контейнера из каждого отслеживаемого контейнера в кластере

- Завершенные задания Kubernetes или модули Pod в кластере, для которых не требуется наблюдение

- Активные отходы метрик Prometheus

- [Сбор журналов диагностики](../../aks/view-master-logs.md) журналов главного узла Kubernetes в кластере AKS для анализа данных журнала, созданных основными компонентами, такими как *KUBE-аписервер* и *KUBE-Controller-Manager*.

## <a name="what-is-collected-from-kubernetes-clusters"></a>Что собирается из кластеров Kubernetes

Azure Monitor для контейнеров включает предопределенный набор метрик и собираемых элементов инвентаризации, которые записываются как данные журнала в рабочую область Log Analytics. Все перечисленные ниже метрики собираются по умолчанию каждые одну минуту.

### <a name="node-metrics-collected"></a>Собранные метрики узлов

Ниже приведен список 24 метрик на каждый узел, которые собираются:

- кпуусаженанокорес
- кпукапаЦитинанокорес
- кпуаллокатабленанокорес
- меморирссбитес
- мемориворкингсетбитес
- меморикапаЦитибитес
- меморяллокатаблебитес
- рестарттимипоч
- используется (диск)
- Free (диск)
- used_percent (диск)
- io_time (дискио)
- операций записи (дискио)
- операции чтения (дискио)
- write_bytes (дискио)
- write_time (дискио)
- iops_in_progress (дискио)
- read_bytes (дискио)
- read_time (дискио)
- err_in (NET)
- err_out (NET)
- bytes_recv (NET)
- bytes_sent (NET)
- Kubelet_docker_operations (Kubelet)

### <a name="container-metrics"></a>Метрики контейнеров

Ниже перечислены восемь метрик на собираемый контейнер:

- кпуусаженанокорес
- кпурекуестнанокорес
- кпулимитнанокорес
- меморирссбитес
- мемориворкингсетбитес
- меморирекуестбитес
- меморилимитбитес
- рестарттимипоч

### <a name="cluster-inventory"></a>Инвентаризация кластера

Ниже приведен список данных инвентаризации кластера, собираемых по умолчанию.

- Кубеподинвентори – 1 в минуту на контейнер
- Кубенодеинвентори – 1 на узел в минуту
- Кубесервицес – 1 на службу в минуту
- Контаинеринвентори – 1 на контейнер в минуту

## <a name="estimating-costs-to-monitor-your-aks-cluster"></a>Оценка затрат на мониторинг кластера AKS

Приведенная ниже оценка основана на кластере Azure Kubernetes Service (AKS) со следующим примером изменения размера. Кроме того, оценка применяется только для собираемых метрик и данных инвентаризации. Для журналов контейнеров (stdout, stderr и переменных среды) он зависит от размера журнала, создаваемого рабочей нагрузкой, и исключается из нашей оценки.

Если вы включили мониторинг кластера AKS, настроенного следующим образом,

- Три узла
- Два диска на узел
- Один сетевой интерфейс на узел
- 20 модулей (один контейнер в каждом Pod = 20 контейнеров в общем)
- Два пространства имен Kubernetes
- Пять Kubernetes Services (в том числе системные модули KUBE, службы и пространство имен)
- Частота сбора = 60 сек (по умолчанию)

В назначенной рабочей области Log Analytics можно просмотреть таблицы и объем данных, создаваемых за час. Дополнительные сведения о каждой из этих таблиц см. в разделе [записи контейнера](container-insights-log-search.md#container-records).

|Таблица | Оценка размера (МБ/час) |
|------|---------------|
|Perf | 12,9 |
|InsightsMetrics | 11,3 |
|KubePodInventory | 1.5 |
|KubeNodeInventory | 0,75 |
|KubeServices | 0.13 |
|ContainerInventory | 3,6 |
|KubeHealth | 0.1 |
|KubeMonAgentEvents |0,005 |

Total = 31 МБ в час = 23,1 ГБ/месяц (один месяц = 31 день)

Используя [цены](https://azure.microsoft.com/pricing/details/monitor/) по умолчанию для log Analytics, которая является моделью оплаты по мере использования, можно оценить Azure Monitorную стоимость в месяц. После включения резервирования емкости цена будет выше в месяц в зависимости от выбранного резервирования.

## <a name="controlling-ingestion-to-reduce-cost"></a>Контроль приема для снижения затрат

Рассмотрим ситуацию, в которой различные организационные ресурсы подразделения Организации Kubernetes инфраструктуру и рабочую область Log Analytics. Для каждого подразделения, разделенного пространством имен Kubernetes. Вы можете визуализировать объем данных, принимаемых в каждой рабочей области, с помощью модуля Runbook " **использование данных** ", доступного в раскрывающемся списке " **Просмотр книг** ".

[![Просмотр раскрывающегося списка книг](media/container-insights-cost/workbooks-dropdown.png)](media/container-insights-cost/workbooks-dropdown.png#lightbox)


Эта книга поможет вам визуализировать источник данных без необходимости создавать собственную библиотеку запросов, предоставляемую в нашей документации. В этой книге есть диаграммы, с помощью которых можно просматривать оплачиваемые данные с таких перспектив, как:

- Общие оплачиваемые данные, полученные в ГБ по решению
- Оплачиваемые данные, полученные журналами контейнеров (журналы приложений)
- Оплачиваемые контейнеры данные журналов, принимаемые по пространству имен Kubernetes
- Оплачиваемые контейнеры данные журналов, разделенные по имени кластера
- Оплачиваемые данные журнала контейнеров, принимаемые записью логсаурце
- Оплачиваемые диагностические данные, принимаемые журналами главного узла диагностики

[![Книга использования данных](media/container-insights-cost/data-usage-workbook.png)](media/container-insights-cost/data-usage-workbook.png#lightbox)

Чтобы узнать об управлении правами и разрешениями для книги, проверьте [Контроль доступа](../platform/workbooks-access-control.md).

После завершения анализа, чтобы определить источник или источники, которые создают наибольшее количество данных или больше данных, превышающих ваши требования, можно перенастроить сбор данных. Сведения о настройке коллекции stdout, stderr и переменных среды описаны в статье [Настройка параметров сбора данных для агента](container-insights-agent-config.md) .

Ниже приведены примеры изменений, которые можно применить к кластеру путем изменения файла ConfigMap в целях управления затратами.

1. Отключите журналы stdout во всех пространствах имен в кластере, изменив следующую команду в файле ConfigMap:

    ```
    [log_collection_settings]       
       [log_collection_settings.stdout]          
          enabled = false
    ```

2. Отключите сбор журналов stderr из пространства имен разработки (например, **dev-test**) и продолжите сбор журналов stderr из других пространств имен (например, " **произв** ." "и" **по умолчанию**"), изменив следующее в файле ConfigMap:

    >[!NOTE]
    >По умолчанию сбор журналов KUBE-System отключен. Параметр по умолчанию сохраняется, добавление пространства имен **dev-test** в список пространств имен исключений применяется к коллекции журналов stderr.

    ```
    [log_collection_settings.stderr]          
       enabled = true          
          exclude_namespaces = ["kube-system", "dev-test"]
    ```

3. Отключите коллекцию переменных среды в пределах кластера, изменив следующие файлы в файле ConfigMap. Это применимо ко всем контейнерам в каждом пространстве имен Kubernetes. 

    ```
    [log_collection_settings.env_var]
        enabled = false
    ```

4. Чтобы очистить завершенные задания, укажите политику очистки в определении задания, изменив следующую команду в файле ConfigMap:

    ```
    apiVersion: batch/v1
    kind: Job
    metadata:
      name: pi-with-ttl
    spec:
      ttlSecondsAfterFinished: 100
    ```

После применения одного или нескольких этих изменений к Конфигмапс см. раздел [применение обновленных ConfigMap](container-insights-prometheus-integration.md#applying-updated-configmap) для применения к кластеру.

### <a name="prometheus-metrics-scraping"></a>Отходы метрик Prometheus

Если вы используете [отходы метрик Prometheus](container-insights-prometheus-integration.md), убедитесь, что для ограничения количества метрик, собранных из кластера, необходимо учитывать следующее:

- Убедитесь, что частота брака/отхода задана оптимально (значение по умолчанию — 60 секунд). Хотя вы можете увеличить частоту до 15 секунд, необходимо убедиться, что метрики, которые вы используете, публикуются по этой частоте. В противном случае несколько повторяющихся метрик будут отосланы и отправлены в рабочую область Log Analytics с дополнительными затратами на прием и хранение данных, но имеют меньшую ценность. 

- Azure Monitor для контейнеров поддерживает исключения & списки включения по имени метрики. Например, если вы передаете метрики **кубеднс** в кластере, то могут быть сотни из них, которые по умолчанию отбракованы, но, скорее всего, вас интересует только подмножество. Подтвердите, что вы указали список метрик, которые должны быть списаны, или исключите другие, кроме нескольких, для сохранения на томе приема данных. Можно легко включить отходы и не использовать многие из этих метрик, что приведет к добавлению только дополнительных расходов на Log Analytics счет.

- При отбраке в заметках Pod убедитесь, что вы фильтруете по пространству имен, чтобы исключить отходы метрик Pod из пространств имен, которые не используются (например, пространство имен **dev-test** ).

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о том, что, скорее всего, зависит от последних моделей использования данных, собранных с помощью Azure Monitor для контейнеров. см. статью [Управление использованием и оценкой затрат](../platform/manage-cost-storage.md).