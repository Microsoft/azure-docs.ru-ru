---
title: Оптимизация среды Active Directory с помощью Azure Monitor | Документация Майкрософт
description: Решение проверки работоспособности Active Directory можно использовать для регулярной оценки риска и состояния среды.
ms.topic: conceptual
author: bwren
ms.author: bwren
ms.date: 09/10/2019
ms.openlocfilehash: bff61ec9dfcb985ea0111ca58bfd58273e1fe432
ms.sourcegitcommit: c27a20b278f2ac758447418ea4c8c61e27927d6a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/03/2021
ms.locfileid: "101723254"
---
# <a name="optimize-your-active-directory-environment-with-the-active-directory-health-check-solution-in-azure-monitor"></a>Оптимизация среды Active Directory с помощью решения проверки работоспособности Active Directory в Azure Monitor

![Символ проверки работоспособности AD](./media/ad-assessment/ad-assessment-symbol.png)

[!INCLUDE [azure-monitor-log-analytics-rebrand](../../../includes/azure-monitor-log-analytics-rebrand.md)]

Решение проверки работоспособности Active Directory можно использовать для периодичной оценки риска и состояния серверной среды. Эта статья поможет вам установить и использовать это решение таким образом, чтобы в случае проблем вы могли выполнить корректирующие действия.

Это решение предоставляет приоритетный список рекомендаций, относящихся к развернутой серверной инфраструктуре. Рекомендации сгруппированы в четыре приоритетные области, помогающие быстро оценить риски и принять меры.

В основу предлагаемых рекомендаций положены знания и опыт, приобретенные специалистами Майкрософт в результате многочисленных посещений клиентов. Каждая рекомендация является определенным руководством, поясняющим важность проблемы и приводящим действия по реализации предложенных изменений.

Можно выбрать приоритетные области, наиболее важные для организации, и отслеживать выполнение задач по формированию работоспособной и свободной от рисков среды.

После добавления решения и завершения проверки сводная информация по приоритетным областям отображается на панели мониторинга **Проверка работоспособности AD** для инфраструктуры среды. В следующих разделах описано, как использовать информацию на панели мониторинга **Проверка работоспособности AD**. На этой панели можно просмотреть рекомендации и выполнить действия для вашей серверной инфраструктуры Active Directory.  

![Изображение плитки "Проверка работоспособности AD"](./media/ad-assessment/ad-healthcheck-summary-tile.png)

![Изображение панели мониторинга "Проверка работоспособности AD"](./media/ad-assessment/ad-healthcheck-dashboard-01.png)

## <a name="prerequisites"></a>Предварительные требования

* Для решения проверки работоспособности Active Directory на каждом компьютере с агентом Log Analytics для Windows (также известном как Microsoft Monitoring Agent (MMA)) должна быть установлена поддерживаемая платформа .NET Framework 4.6.2 или более поздней версии.  Этот агент используется решением System Center 2016 Operations Manager и Operations Manager 2012 R2, а также Azure Monitor.
* Решение поддерживает контроллеры домена под управлением Windows Server 2008 и 2008 R2, Windows Server 2012 и 2012 R2, Windows Server 2016, а также Windows Server 2019.
* Рабочая область Log Analytics для добавления решения проверки работоспособности Active Directory в Azure Marketplace на портале Azure. Дополнительные настройки для этого не требуются.

  > [!NOTE]
  > После добавления решения на серверы с агентами добавляется файл AdvisorAssessment.exe. Данные конфигурации считываются и отправляются на обработку в Azure Monitor в облаке. К полученным данным применяется логика и облачная служба записывает данные.
  >
  >

Чтобы проверить работоспособность контроллеров, которые являются компонентами оцениваемого домена, каждому контроллеру в этом домене требуется агент и подключение к Azure Monitor с помощью одного из следующих поддерживаемых методов.

1. Установка [агента Log Analytics для Windows](../agents/agent-windows.md), если контроллер домена уже не отслеживается с помощью решения System Center 2016 Operations Manager или Operations Manager 2012 R2.
2. Если сервер отслеживается решением System Center 2016 Operations Manager или Operations Manager 2012 R2 и группа управления не интегрирована с Azure Monitor, контроллер домена может использоваться как многосетевой. С помощью Azure Monitor данные будут собираться и пересылаться в службу, а контроллер домена по-прежнему будет отслеживаться решением Operations Manager.  
3. Если группа управления Operations Manager интегрирована со службой, после включения решения в рабочей области добавьте контроллеры домена для сбора данных службой. Для этого выполните инструкции по [добавлению компьютеров под управлением агентов](../agents/om-agents.md#connecting-operations-manager-to-azure-monitor).  

Агент в контроллере домена, который отправляет отчеты в группу управления Operations Manager, собирает данные, перенаправляет их на назначенный сервер управления, а затем отправляет их с сервера управления непосредственно в Azure Monitor.  Данные не записываются в базы данных Operations Manager.  

## <a name="active-directory-health-check-data-collection-details"></a>Сведения о сборе данных для проверки работоспособности Active Directory

Для проверки работоспособности Active Directory данные собираются из следующих источников с помощью включенных агентов:

- Реестр
- LDAP
- .NET Framework
- Журнал событий
- Интерфейс ADSI
- Windows PowerShell
- данные файлов;
- Инструментарий управления Windows (WMI)
- API инструмента DCDIAG
- API службы репликации файлов (NTFRS)
- Пользовательский код C#

Данные собираются на сервере контроллера домена и перенаправляются в Azure Monitor каждые семь дней.  

## <a name="understanding-how-recommendations-are-prioritized"></a>Основные сведения о приоритизации рекомендаций

Каждая рекомендация получает взвешенное значение, определяющее относительную важность рекомендаций. Отображаются только 10 наиболее важных рекомендаций.

### <a name="how-weights-are-calculated"></a>Процесс вычисления взвешенного значения

Взвешенные значения являются статистическими значениями, основанными на трех ключевых факторах.

* *Вероятность* возникновения проблем. Более высокие значения вероятности приравниваются к более высокой общей оценке для рекомендации.
* *Влияние* на работу организации, если она является причиной проблемы. Более высокая степень влияния приравнивается к более высокой общей оценке для рекомендации.
* *Усилия* , необходимые для реализации рекомендации. Более высокое значение усилий приравнивается к меньшей общей оценке рекомендации.

Взвешенное значение для каждой рекомендации выражается в процентах от общей оценки, доступной для каждой приоритетной области. Например, если рекомендация в области обеспечения безопасности и соответствия требованиям имеет показатель 5 %, реализация этой рекомендации увеличит общую оценку в этой области на 5 %.

### <a name="focus-areas"></a>Приоритетные области

**Безопасность и соответствие требованиям**. В этой области содержатся рекомендации в отношении возможных угроз, нарушений безопасности и корпоративных политик, а также технические, юридические и нормативные требования.

**Доступность и непрерывность бизнес-процессов**. Эта область содержит рекомендации в отношении доступности служб, устойчивости инфраструктуры и защиты бизнеса.

**Производительность и масштабируемость**. В этой области содержатся рекомендации, которые помогут ИТ-инфраструктуре вашей организации расти, обеспечат соответствие ИТ-среды текущим требованиям к производительности и позволят ей адаптироваться к новым требованиям к инфраструктуре.

**Обновление, миграция и развертывание**. Эта область содержит рекомендации, которые помогут вам обновить, перенести или развернуть Active Directory в существующую инфраструктуру.

### <a name="should-you-aim-to-score-100-in-every-focus-area"></a>Следует ли стремиться к показателю 100 % в каждой приоритетной области?

Не обязательно. В основу предлагаемых рекомендаций положены знания и опыт, приобретенные специалистами Майкрософт в результате многочисленных посещений клиентов. Однако не существует двух одинаковых серверных инфраструктур, и конкретные рекомендации могут быть применимы к вам в большей или меньшей степени. Например, некоторые рекомендации по обеспечению безопасности могут быть менее значимыми, если виртуальные машины в организации не подключены к Интернету. Некоторые рекомендации о доступности могут иметь менее важное значение для служб, которые обеспечивают сбор низкоприоритетных данных. Проблемы, которые важны для зрелой организации, могут быть не так важны для начинающей компании. Можно определить приоритетные области и затем отследить изменение оценок с течением времени.

В каждой рекомендации указано, почему она важна. Их следует использовать, чтобы определить целесообразность реализации рекомендации с учетом характера ИТ-служб и бизнес-потребностей организации.

## <a name="use-health-check-focus-area-recommendations"></a>Рекомендации по использованию приоритетной области проверки работоспособности

Когда решение будет установлено, вы сможете просматривать сводные рекомендации с помощью плитки "Проверка работоспособности" на странице решения на портале Azure.

Вы можете посматривать сводку оценок соответствия для инфраструктуры, а затем глубже изучить рекомендации.

### <a name="to-view-recommendations-for-a-focus-area-and-take-corrective-action"></a>Просмотр рекомендаций для приоритетной области и выполнение действий по исправлению

[!INCLUDE [azure-monitor-solutions-overview-page](../../../includes/azure-monitor-solutions-overview-page.md)]

1. На странице **Обзор** щелкните плитку **Проверка работоспособности Active Directory**.

2. На странице **Проверка работоспособности** просмотрите сводные данные в одной из колонок приоритетной области, а затем щелкните ее, чтобы ознакомиться с рекомендациями для этой приоритетной области.

3. На всех страницах интересующей области можно просматривать приоритетные рекомендации для вашей среды. Щелкните рекомендацию в разделе **Затронутые объекты** , чтобы просмотреть сведения о причинах возникновения этой рекомендации.

    ![Изображение рекомендаций по проверке работоспособности](./media/ad-assessment/ad-healthcheck-dashboard-02.png)

4. В разделе **Предложенные действия** представлены действия по исправлению, которые вы можете предпринять. Когда проблема с этим элементом будет устранена, последующие оценки будут указывать, что рекомендованные действия были выполнены, и тогда оценка соответствия возрастет. Исправленные элементы отображаются как **Прошедшие проверку объекты**.

## <a name="ignore-recommendations"></a>Игнорирование рекомендаций

Если нужно проигнорировать определенные рекомендации, создайте текстовый файл, при помощи которого рекомендации будут удалены из результатов оценки в Azure Monitor.

### <a name="to-identify-recommendations-that-you-will-ignore"></a>Указание рекомендаций, которые нужно проигнорировать

[!INCLUDE [azure-monitor-log-queries](../../../includes/azure-monitor-log-queries.md)]

Выполните следующий запрос, чтобы получить список рекомендаций, не выполненных на компьютерах в вашей среде.

```
ADAssessmentRecommendation | where RecommendationResult == "Failed" | sort by Computer asc | project Computer, RecommendationId, Recommendation
```

Ниже указан снимок экрана с запросом по журналам:<

![невыполненные рекомендации](media/ad-assessment/ad-failed-recommendations.png)

Выберите рекомендации, которые нужно проигнорировать. Эти значения будут использоваться для параметра RecommendationId в следующей процедуре.

### <a name="to-create-and-use-an-ignorerecommendationstxt-text-file"></a>Создание и использование текстового файла IgnoreRecommendations.txt

1. Создайте файл с именем IgnoreRecommendations.txt.

2. Вставьте или введите значение RecommendationId для каждой рекомендации, которую служба Azure Monitor должна игнорировать, в отдельной строке, а затем сохраните и закройте файл.

3. Поместите файл в следующую папку на каждом компьютере, где служба Azure Monitor должна игнорировать указанные ниже рекомендации.

   * На компьютерах с Microsoft Monitoring Agent (подключенных напрямую или через Operations Manager): *системный диск*:\Program Files\Microsoft Monitoring Agent\Agent.
   * На сервере управления Operations Manager 2012 R2: *системный диск*:\Program Files\Microsoft System Center 2012 R2\Operations Manager\Server.
   * На сервере управления Operations Manager 2016 — *системный диск*:\Program Files\Microsoft System Center 2016\Operations Manager\Server.

### <a name="to-verify-that-recommendations-are-ignored"></a>Контроль игнорирования рекомендаций

После следующей плановой проверки работоспособности (по умолчанию выполняется раз в семь дней) указанные рекомендации отмечаются как *игнорируемые* и больше не отображаются на панели мониторинга.

1. Для получения списка всех игнорируемых рекомендаций можете использовать следующие запросы по журналам.

    ```
    ADAssessmentRecommendation | where RecommendationResult == "Ignored" | sort by Computer asc | project Computer, RecommendationId, Recommendation
    ```

2. Если вы решите позже просмотреть игнорируемые рекомендации, удалите все файлы IgnoreRecommendations.txt или RecommendationIDs можно удалить из них.

## <a name="ad-health-check-solutions-faq"></a>Вопросы и ответы по решению "Проверка работоспособности AD"

*Какие проверки выполняет решение по оценке AD?*

* В следующем запросе показано описание всех проверок, которые выполняются в настоящее время:

```Kusto
ADAssessmentRecommendation
| distinct RecommendationId, FocusArea, ActionArea, Recommendation, Description
| sort by FocusArea,ActionArea, Recommendation
```
Результаты можно экспортировать в Excel для дальнейшего анализа.

*Как часто выполняется проверка работоспособности?*

* Проверка выполняется каждые семь дней.

*Можно ли настроить частоту проверки работоспособности?*

* На данный момент нет.

*Если добавлено решение проверки работоспособности, а затем обнаружен другой сервер, будет ли он проверяться?*

* Да, после обнаружения он проверяется каждые 7 дней.

*Если сервер выведен из эксплуатации, будет ли он удален из решения проверки работоспособности?*

* Если сервер не отправляет данные в течение 3 недель, то он удаляется.

*Как называется процесс, который собирает данные?*

* AdvisorAssessment.exe

*Сколько времени требуется для сбора данных?*

* Время сбора данных на сервере занимает примерно 1 час. На серверах, которые имеют большое количество серверов Active Directory, процесс сбора может занять больше времени.

*Можно ли настроить время сбора данных?*

* На данный момент нет.

*Почему отображаются только первые 10 рекомендаций?*

* Вместо отображения полного списка задач мы рекомендуем сконцентрироваться на приоритетных рекомендациях. После этого станут доступны дополнительные рекомендации. Если вы хотите просмотреть весь список, используйте запрос по журналам.

*Можно ли игнорировать рекомендации?*

* Да. См. раздел [Игнорирование рекомендаций](#ignore-recommendations) выше в этой статье.

## <a name="next-steps"></a>Дальнейшие действия

Чтобы научиться анализировать подробные данные и рекомендации для проверки работоспособности AD, см. статью [Анализ данных Log Analytics в Azure Monitor](../logs/log-query-overview.md).

