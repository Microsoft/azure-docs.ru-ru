---
title: Решение "Аналитика DNS" в Azure Monitor | Документация Майкрософт
description: Узнайте, как настроить и использовать решение "Аналитика DNS" в Azure Monitor, чтобы собрать сведения об инфраструктуре DNS по безопасности, производительности и операциях.
ms.topic: conceptual
author: bwren
ms.author: bwren
ms.date: 03/20/2018
ms.openlocfilehash: df9efef1000ab6a824c869e6684ab1424e8462f4
ms.sourcegitcommit: c27a20b278f2ac758447418ea4c8c61e27927d6a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/03/2021
ms.locfileid: "101708107"
---
# <a name="gather-insights-about-your-dns-infrastructure-with-the-dns-analytics-preview-solution"></a>Сбор сведений об инфраструктуре DNS с помощью решения аналитики DNS (предварительной версии)

![Символ "Аналитика DNS"](./media/dns-analytics/dns-analytics-symbol.png)

В этой статье описывается, как настроить и использовать решение Аналитики DNS Azure в службе Azure Monitor, чтобы собрать сведения об инфраструктуре DNS по безопасности, производительности и операциях.

Решение аналитики DNS помогает выполнить следующие задачи:

- определить клиенты, которые пытаются разрешить вредоносные доменные имена;
- определить устаревшие записи ресурсов;
- определить часто запрашиваемые доменные имена и "разговорчивые" DNS-клиенты;
- просмотреть нагрузку запросов на DNS-серверы;
- просмотреть ошибки при регистрации динамических DNS.

Это решение собирает, анализирует и сопоставляет данные журналов аналитики и аудита Windows DNS, а также другие связанные данные с DNS-серверов.

## <a name="connected-sources"></a>Подключенные источники

В следующей таблице описаны подключенные источники, поддерживаемые этим решением.

| **Подключенный источник** | **Поддержка** | **Описание** |
| --- | --- | --- |
| [Агенты Windows](../agents/agent-windows.md) | Да | Решение собирает сведения о DNS из агентов Windows. |
| [Агенты Linux](../vm/quick-collect-linux-computer.md) | Нет | Решение не собирает сведения о DNS из прямых агентов Linux. |
| [Группа управления System Center Operations Manager](../agents/om-agents.md) | Да | Решение собирает сведения о DNS из агентов в подключенной группе управления Operations Manager. Прямое подключение агента Operations Manager к Azure Monitor не требуется. Данные пересылаются из группы управления в рабочую область Log Analytics. |
| [Учетная запись хранения Azure](../essentials/resource-logs.md#send-to-log-analytics-workspace) | Нет | Решение не использует службу хранилища Azure. |

### <a name="data-collection-details"></a>Сведения о сборе данных

Решение собирает данные, связанные с инвентаризацией и событиями DNS, с DNS-серверов, на которых установлен агент Log Analytics. Затем эти данные передаются в службу Azure Monitor и отображаются на панели мониторинга решения. Данные, связанные с инвентаризацией, такие как количество DNS-серверов, зон и записей ресурсов, собираются с помощью командлетов PowerShell для DNS. Эти данные обновляются каждые два дня. Данные, связанные с событиями, собираются практически в реальном времени из [журналов аналитики и аудита](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn800669(v=ws.11)#enhanc), которые обеспечиваются расширенными функциями диагностики и ведения журнала DNS в Windows Server 2012 R2.

## <a name="configuration"></a>Конфигурация

Для настройки решения используйте указанные ниже данные.

- Агент [Windows](../agents/agent-windows.md) или [Operations Manager](../agents/om-agents.md) должен быть установлен на каждом DNS-сервере, который вы хотите отслеживать.
- Решение "Аналитика DNS" можно добавить в рабочую область Log Analytics из [Azure Marketplace](https://aka.ms/dnsanalyticsazuremarketplace). Вы также можете использовать процесс, описанный в статье [Решения мониторинга в Azure Monitor](solutions.md).

Чтобы решение начало сбор данных, никакие дополнительные настройки не требуются. Однако можно использовать описанные ниже действия, чтобы настроить процесс сбора данных.

### <a name="configure-the-solution"></a>Настройка решения

На панели мониторинга решения щелкните **Конфигурация**, чтобы открыть страницу "Конфигурация аналитики DNS". В конфигурацию можно внести два типа изменений:

- **Алловлистед доменные имена**. Это решение не обрабатывает все запросы поиска. Он поддерживает разрешенных суффиксов доменных имен. Запросы поиска, которые разрешаются в доменных именах, соответствующих суффиксам доменных имен в этом разрешенных, не обрабатываются решением. Отсутствие обработки доменных имен алловлистед помогает оптимизировать данные, отправляемые в Azure Monitor. Разрешенных по умолчанию включает популярные имена общедоступных доменов, такие как www.google.com и www.facebook.com. Используя полосу прокрутки, можно просмотреть полный список по умолчанию.

  Вы можете изменить этот список, добавив любые суффиксы доменных имен, для которых необходимо просмотреть сведения о поиске. Вы также можете удалить любые суффиксы доменных имен, если не хотите просматривать сведения о поиске.

- **Порог на "разговорчивых" клиентов**. DNS-клиенты, которые превышают пороговое значение для числа запросов поиска, будут выделены в колонке **DNS-клиенты**. Пороговое значение по умолчанию — 1000. Это значение можно изменить.

    ![Доменные имена алловлистед](./media/dns-analytics/dns-config.png)

## <a name="management-packs"></a>Пакеты управления

Если для подключения к рабочей области Log Analytics используется Microsoft Monitoring Agent, то устанавливается следующий пакет управления:

- Пакет сбора данных Microsoft DNS (Microsoft.IntelligencePacks.Dns)

Если группа управления Operations Manager подключена к рабочей области Log Analytics, при добавлении этого решения в Operations Manager будут установлены следующие пакеты. Для этих пакетов управления не требуется никакая настройка или обслуживание:

- Пакет сбора данных Microsoft DNS (Microsoft.IntelligencePacks.Dns)
- Конфигурация аналитики DNS для Microsoft System Center Advisor (Microsoft.IntelligencePack.Dns.Configuration)

Дополнительные сведения об обновлении пакетов управления для решений см. в статье [Подключение Operations Manager к Log Analytics](../agents/om-agents.md).

## <a name="use-the-dns-analytics-solution"></a>Использование решения аналитики DNS

[!INCLUDE [azure-monitor-solutions-overview-page](../../../includes/azure-monitor-solutions-overview-page.md)]


На фрагменте DNS изображено количество DNS-серверов, с которых собираются данные. а также количество запросов, выполненных за последние 24 часа клиентами для разрешения вредоносных доменов. Щелкните плитку, чтобы открылась панель мониторинга решения.

![Элемент "Аналитика DNS"](./media/dns-analytics/dns-tile.png)

### <a name="solution-dashboard"></a>Панель мониторинга решения

На панели мониторинга решения отображаются сводные данные для различных компонентов решения. Здесь также есть ссылки на подробное представление для ретроспективного анализа и диагностики. По умолчанию данные отображаются за последние семь дней. Вы можете изменить диапазон дат и времени с помощью **элемента управления для выбора даты и времени**, как показано на изображении ниже.

![Элемент управления для выбора времени](./media/dns-analytics/dns-time.png)

На панели мониторинга решения отображаются следующие колонки:

**Безопасность DNS**. Сообщает о DNS-клиентах, которые пытаются обмениваться данными с вредоносными доменами. Используя каналы корпорации Майкрософт для аналитики угроз, решение аналитики DNS может обнаруживать IP-адреса клиентов, которые пытаются получить доступ к вредоносным доменам. Во многих случаях устройства, инфицированные вредоносными программами, "дозваниваются" в центр "команд и управления" вредоносного домена, разрешая вредоносное доменное имя.

![Колонка "Безопасность DNS"](./media/dns-analytics/dns-security-blade.png)

При выборе IP-адреса клиента из списка откроется колонка поиска по журналу, в которой отобразятся сведения о соответствующем запросе поиска. В следующем примере Аналитика DNS обнаружил, что обмен данными выполнялся с помощью [IRCbot](https://www.microsoft.com/en-us/wdsi/threats/malware-encyclopedia-description?Name=Backdoor:Win32/IRCbot&threatId=2621):

![Результаты поиска по журналу, показывающие ircbot](./media/dns-analytics/ircbot.png)

Эти сведения помогут вам определить следующее:

- IP-адрес клиента, инициировавший обмен данными;
- доменное имя, разрешающееся во вредоносный IP-адрес;
- IP-адреса, в которые разрешается доменное имя;
- вредоносный IP-адрес;
- степень серьезности проблемы;
- Причина Добавление вредоносного IP-адреса.
- время обнаружения.

**Запрошенные домены**. Отображает доменные имена, которые чаще всего запрашиваются DNS-клиентами в вашей среде. Вы можете просмотреть список всех запрошенных доменных имен. Вы также можете детальнее просмотреть сведения о запросе поиска конкретного доменного имени в поиске по журналу.

![колонка "Запрошенные домены"](./media/dns-analytics/domains-queried-blade.png)

**DNS-клиенты**. Сообщает о клиентах, которые *превышают пороговое значение* для числа запросов в указанный период времени. Список всех DNS-клиентов и сведения о запросах, выполненных ими, можно просмотреть в колонке "Поиск по журналу".

![Колонка "DNS-клиенты"](./media/dns-analytics/dns-clients-blade.png)

**Динамические регистрации DNS**. Сообщает об ошибках при регистрации имени. В этой колонке выделяются все ошибки регистрации [записей ресурсов](https://en.wikipedia.org/wiki/List_of_DNS_record_types) адресов (типов A и AAAA), а также IP-адреса клиентов, выполнившие эти запросы на регистрацию. Эти сведения затем можно использовать для поиска основной причины сбоя регистрации:

1. Найдите зону, заслуживающую доверия для имени, которое клиент пытается обновить.

1. Используйте решение для проверки данных инвентаризации из этой зоны.

1. Убедитесь, что для этой зоны включено динамическое обновление.

1. Проверьте, настроена ли зона для выполнения безопасного динамического обновления.

    ![Колонка "Динамические регистрации DNS"](./media/dns-analytics/dynamic-dns-reg-blade.png)

**Запросы на регистрацию имени**. В верхнем элементе отображается линия тренда, демонстрирующая число успешных и невыполненных запросов на динамическое обновление DNS. В нижнем элементе отображается список первых 10 клиентов с наибольшим числом невыполненных запросов на обновление DNS, отправленных на DNS-серверы. Клиенты отсортированы по числу ошибок.

![Колонка "Запросы на регистрацию имени"](./media/dns-analytics/name-reg-req-blade.png)

**Примеры запросов аналитики DDI**. Содержит список наиболее распространенных поисковых запросов, которые напрямую извлекают необработанные данные аналитики.


![Примеры запросов](./media/dns-analytics/queries.png)

Эти запросы можно использовать как отправную точку для создания собственных запросов для настраиваемых отчетов. Эти запросы открывают страницу поиска по журналам аналитики DNS, где отображаются следующие результаты:

- **Список DNS-серверов**. Отображает список всех DNS-серверов со связанными с ними полным доменным именем (FQDN), доменным именем, именем леса и IP-адресами серверов.
- **Список зон DNS**. Отображает список всех зон DNS со связанными с ними именем зоны, состоянием динамического обновления, серверами имен и состоянием подписания DNSSEC.
- **Записи неиспользованных ресурсов**. Отображает список всех неиспользованных или устаревших записей ресурсов. Этот список содержит имя записи ресурса, тип записи ресурса, связанный DNS-сервер, время создания записи и имя зоны. С помощью этого списка можно определить записи ресурсов DNS, которые больше не используются. Затем на основании этой информации вы можете удалить эти записи с DNS-серверов.
- **Нагрузка от запросов на DNS-серверы**. Позволяет просмотреть нагрузку DNS на DNS-серверы в перспективе. Учитывая эти сведения, вы можете правильно спланировать емкость серверов. Вы можете перейти на вкладку **метрик**, чтобы изменить представление на графическую визуализацию. Это представление позволяет лучше понять, как нагрузка DNS распределяется между DNS-серверами. Для каждого сервера показаны тенденции изменения числа запросов DNS.

    ![Запросы к DNS-серверам: результаты поиска по журналу](./media/dns-analytics/dns-servers-query-load.png)

- **Нагрузка от запросов на зоны DNS**. Показывает статистику количества запросов в секунду для всех зон DNS на DNS-серверах, управляемых решением. Щелкните вкладку **Метрики**, чтобы заменить представление подробных записей графической визуализацией.
- **События настройки**. Показывает все события изменения конфигурации DNS и связанные сообщения. Затем эти события можно отфильтровать по времени события, идентификатору события, DNS-серверу или категории задачи. С помощью этих данных можно отслеживать изменения, внесенные на определенных DNS-серверах в определенное время.
- **Журнал аналитики по DNS**. Показывает все события аналитики на всех DNS-серверах, управляемых решением. Затем эти события можно отфильтровать по времени события, идентификатору события, DNS-серверу, IP-адресу клиента, выполнившему запрос поиска, а также запросить категорию задачи типа. События аналитики DNS-сервера позволяют отслеживать действия на DNS-сервере. Событие аналитики записывается в журнал каждый раз, когда сервер отправляет или получает сведения о DNS.

### <a name="search-by-using-dns-analytics-log-search"></a>Поиск с помощью поиска по журналам аналитики DNS

На странице поиска по журналам можно создать запрос. Результаты поиска можно фильтровать с помощью элементов управления аспектами. Можно создать сложные запросы для преобразования и фильтрации результатов, а также для формирования соответствующих отчетов. Начните с помощью следующих запросов:

1. В **поле поискового запроса** введите `DnsEvents`, чтобы просмотреть все события DNS, создаваемые DNS-серверами под управлением решения. В результатах отобразятся данные журнала для всех событий, связанных с запросами поиска, динамическими регистрациями и изменениями конфигурации.

    ![Поиск по журналу событий DNS](./media/dns-analytics/log-search-dnsevents.png)  

    а. Чтобы просмотреть данные журнала о запросах поиска, отфильтруйте **подтип** по значению **LookUpQuery**, используя элемент управления в левой части экрана. Отобразится таблица, содержащая все события запросов поиска за выбранный период времени.

    b. Чтобы просмотреть данные журнала о динамических регистрациях, отфильтруйте **подтип** по значению **DynamicRegistration**, используя элемент управления в левой части экрана. Отобразится таблица, содержащая все события динамической регистрации за выбранный период времени.

    c. Чтобы просмотреть данные журнала об изменениях конфигурации, отфильтруйте **подтип** по значению **ConfigurationChange**, используя элемент управления в левой части экрана. Отобразится таблица, содержащая все события изменения конфигурации за выбранный период времени.

1. В **поле поискового запроса** введите `DnsInventory`, чтобы просмотреть все данные, относящиеся к инвентаризации DNS, для DNS-серверов под управлением решения. В списке результатов отобразятся данные журнала о DNS-серверах, зонах DNS и записях ресурсов.

    ![Поиск по журналу инвентаризации DNS](./media/dns-analytics/log-search-dnsinventory.png)
    
## <a name="troubleshooting"></a>Устранение неполадок

Общие действия по устранению неполадок:

1. Отсутствующие данные поиска DNS. чтобы устранить эту проблему, попробуйте сбросить настройки конфигурации или просто загрузить страницу конфигурации на портале. Для сброса параметров просто измените значение параметра на другое, затем снова измените его на исходное значение и сохраните файл конфигурации.

## <a name="suggestions"></a>Предложения

Чтобы отправить отзыв, посетите [страницу log Analytics UserVoice](https://aka.ms/dnsanalyticsuservoice) , чтобы опубликовать идеи для работы с аналитика DNS функциями. 

## <a name="next-steps"></a>Дальнейшие действия

Чтобы получить дополнительные сведения о записях журнала DNS, см. статью [Analyze log data in Azure Monitor](../logs/log-query-overview.md) (Анализ данных журналов в Azure Monitor).
