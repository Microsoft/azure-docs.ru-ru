---
title: Настройка мониторинга в работоспособности гостевых виртуальных машин в Azure Monitor с помощью правил сбора данных (предварительная версия)
description: В этой статье описывается, как изменить мониторинг по умолчанию в Azure Monitor для виртуальных машин работоспособности гостевых систем при масштабировании с помощью шаблонов диспетчер ресурсов.
ms.subservice: ''
ms.topic: conceptual
author: bwren
ms.author: bwren
ms.date: 10/15/2020
ms.openlocfilehash: 2001fece40267ca2e3256e699d2dc253ceb10f0c
ms.sourcegitcommit: e559daa1f7115d703bfa1b87da1cf267bf6ae9e8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/17/2021
ms.locfileid: "100625626"
---
# <a name="configure-monitoring-in-azure-monitor-for-vms-guest-health-using-data-collection-rules-preview"></a>Настройка мониторинга в работоспособности гостевых виртуальных машин в Azure Monitor с помощью правил сбора данных (предварительная версия)
[Azure Monitor для виртуальных машин работоспособности гостевых систем](vminsights-health-overview.md) позволяет просматривать работоспособность виртуальной машины в соответствии с набором измерений производительности, которые вычисляются с регулярным интервалом. В этой статье описывается, как можно изменить мониторинг по умолчанию на нескольких виртуальных машинах с помощью правил сбора данных.


## <a name="monitors"></a>Мониторы
Состояние работоспособности виртуальной машины определяется [сводкой состояния работоспособности](vminsights-health-overview.md#health-rollup-policy) каждого из ее мониторов. В Azure Monitor для виртуальных машин работоспособности гостевой системы существует два типа мониторов, как показано в следующей таблице.

| Монитор | Описание |
|:---|:---|
| Монитор модуля | Измеряет определенный аспект ресурса или приложения. Это может быть проверка счетчика производительности для определения производительности ресурса или его доступности. |
| Составной монитор | Группирует несколько мониторов, чтобы предоставить сведения о едином агрегированном состоянии работоспособности. Составной монитор может содержать один или несколько базовых мониторов и другие составные мониторы. |

Набор мониторов, используемый Azure Monitor для виртуальных машин гостевой работоспособности и их конфигурацию, нельзя изменить напрямую. Вы можете создавать [переопределения](#overrides) , когда изменяете поведение конфигурации по умолчанию. Переопределения определяются в правилах сбора данных. Можно создать несколько правил сбора данных, каждый из которых содержит несколько переопределений для достижения требуемой конфигурации мониторинга.

## <a name="monitor-properties"></a>Свойства монитора
В следующей таблице описаны свойства, которые можно настроить на каждом мониторе.

| Свойство | Мониторы | Описание |
|:---|:---|:---|
| Активировано | Статистическое<br>Unit | Если значение — true, монитор состояния вычисляется и влияет на работоспособность виртуальной машины. Он может активировать оповещение о включении предупреждений. |
| Оповещение | Статистическое<br>Unit | Если задано значение true, то при переходе в неработоспособное состояние для монитора запускается оповещение. Если задано значение false, состояние монитора будет по-прежнему влиять на работоспособность виртуальной машины, что может вызвать оповещение. |
| Предупреждение | Unit | Критерии для состояния предупреждения. Если нет, то монитор никогда не введет состояние предупреждения. |
| Критически важно | Unit | Критерии для критического состояния. Если нет, то монитор никогда не будет переходить в критическое состояние. |
| Периодичность оценки | Unit | Частота оценки состояния работоспособности. |
| лукбакк | Unit | Размер окна лукбакк в секундах. Подробное описание см. в [элементе мониторконфигуратион](#monitorconfiguration-element) . |
| Тип оценки | Unit | Определяет, какое значение следует использовать из набора выборки. Подробное описание см. в [элементе мониторконфигуратион](#monitorconfiguration-element) . |
| Пример min | Unit | Минимальное число значений, используемых для вычисления значения. |
| Пример Max | Unit | Максимальное число значений, которое будет использоваться для вычисления значения. |


## <a name="default-configuration"></a>Конфигурация по умолчанию
В следующей таблице перечислены конфигурации по умолчанию для каждого монитора. Эту конфигурацию по умолчанию нельзя изменить напрямую, но можно определить [переопределения](#overrides) , которые будут изменять конфигурацию монитора для определенных виртуальных машин.


| Монитор | Активировано | Оповещение | Предупреждение | Критически важно | Периодичность оценки | лукбакк | Тип оценки | Пример min | Максимальное число выборок |
|:---|:---|:---|:---|:---|:---|:---|:---|:---|:---|
| загрузка ЦП;  | Верно | Неверно | None | \> 90%    | 60 с | 240 с | Min | 2 | 3 |
| Объем доступной памяти | Верно | Неверно | None | \< 100 МБ | 60 с | 240 с | Max | 2 | 3 |
| Файловая система      | Верно | Неверно | None | \< 100 МБ | 60 с | 120 с | Max | 1 | 1 |


## <a name="overrides"></a>Переопределения
*Переопределение* изменяет один или несколько свойств монитора. Например, переопределение может отключить монитор, включенный по умолчанию, определить условия предупреждений для монитора или изменить критическое пороговое значение монитора. 

Переопределения определяются в [правиле сбора данных (ДКР)](../agents/data-collection-rule-overview.md). Вы можете создать несколько DCR с разными наборами переопределений и применить их к нескольким виртуальным машинам. Вы применяете ДКР к виртуальной машине, создав Ассоциацию, как описано в разделе [Настройка сбора данных для агента Azure Monitor (Предварительная версия)](../agents/data-collection-rule-azure-monitor-agent.md#data-collection-rule-associations).


## <a name="multiple-overrides"></a>Несколько переопределений

Один монитор может иметь несколько переопределений. Если переопределения определяют различные свойства, то Результирующая конфигурация будет сочетанием всех переопределений.

Например, `memory|available` монитор не задает порог предупреждения или включает предупреждения по умолчанию. Рассмотрим следующие переопределения, примененные к этому монитору:

- Переопределение 1 определяет `alertConfiguration.isEnabled` значение свойства как `true`
- Переопределение 2 определяет `monitorConfiguration.warningCondition` с условием порога `< 250` .

Результирующая конфигурация — это монитор, который переходит в состояние "предупреждение", если доступно менее 250 МБ памяти, и создает оповещение о серьезности 2, а также переходит в состояние "критическое", если доступно менее 100 МБ доступной памяти, и создает серьезность предупреждения 1 (или изменяет существующее оповещение с серьезности 2 на 1, если оно уже существовало).

Если два переопределения определяют одно и то же свойство для одного и того же монитора, то один из значений будет иметь приоритет. Переопределения будут применены на основе их [области действия](#scopes-element), от наиболее общего до наиболее конкретного. Это означает, что наиболее специфичные переопределения придают наибольшую вероятность применения. Ниже приведен конкретный порядок.

1. Глобальный 
2. Подписка
3. Группа ресурсов
4. виртуальную машину; 

Если несколько переопределений на одном уровне области определяют одно и то же свойство на одном мониторе, они применяются в том порядке, в котором они отображаются в ДКР. Если переопределения находятся в разных DCR, они применяются в алфавитном порядке идентификаторов ресурсов ДКР.


## <a name="data-collection-rule-configuration"></a>Конфигурация правила сбора данных
Элементы JSON в правиле сбора данных, определяющие переопределения, описаны в следующих разделах. Полный пример представлен в [примере правила сбора данных](#sample-data-collection-rule).

## <a name="extensions-structure"></a>Структура расширений
Работоспособность гостя реализуется как расширение агента Azure Monitor, поэтому переопределения определяются в `extensions` элементе правила сбора данных. 

```json
"extensions": [
    {
        "name": "Microsoft-VMInsights-Health",
        "streams": [
            "Microsoft-HealthStateChange"
        ],
        "extensionName": "HealthExtension",
        "extensionSettings": {   }
    }
]
```

| Элемент | Обязательно | Описание |
|:---|:---|:---|
| `name` | Да | Определяемая пользователем строка для расширения. |
| `streams` | Да | Список потоков, в которые будут отправляться гостевые данные о работоспособности. Он должен включать **Microsoft-хеалсстатечанже**.  |
| `extensionName` | Да | Имя расширения. Это должен быть **хеалсекстенсион**. |
| `extensionSettings` | Да | Массив `healthRuleOverride` элементов, применяемых к конфигурации по умолчанию. |


## <a name="extensionsettings-element"></a>extensionSettings, элемент
Содержит параметры для расширения.

```json
"extensionSettings": {
    "schemaVersion": "1.0",
    "contentVersion": "",
    "healthRuleOverrides": [ ]
}
```

| Элемент | Обязательно | Описание |
|:---|:---|:---|
| `schemaVersion` | Да | Строка, определенная корпорацией Майкрософт для представления ожидаемой схемы элемента. В настоящее время необходимо задать значение 1,0 |
| `contentVersion` | Нет | Строка, определяемая пользователем для трассировки различных версий конфигурации работоспособности, если это необходимо. |
| `healthRuleOverrides` | Да | Массив `healthRuleOverride` элементов, применяемых к конфигурации по умолчанию. |

## <a name="healthrulesoverrides-element"></a>Хеалсрулесоверридес, элемент
Содержит один или несколько `healthRuleOverride` элементов, каждый из которых определяет переопределение.

```json
"healthRuleOverrides": [
    {
        "scopes": [ ],
        "monitors": [ ],
        "monitorConfiguration": { },
        "alertConfiguration": {  },
        "isEnabled": true|false
    }
]
```

| Элемент | Обязательно | Описание |
|:---|:---|:---|
| `scopes` | Да | Список из одной или нескольких областей, указывающих виртуальные машины, к которым применимо это переопределение. Несмотря на то, что ДКР связан с виртуальной машиной, виртуальная машина должна находиться в пределах области применения переопределения. |
| `monitors` | Да | Список из одной или нескольких строк, которые определяют, какие мониторы получат это переопределение.  |
| `monitorConfiguration` | Нет | Конфигурация монитора, включая состояния работоспособности и их вычисление. |
| `alertConfiguration` | Нет | Конфигурация предупреждений для монитора. |
| `isEnabled` | Нет | Определяет, включен ли монитор. Отключенный монитор переключается на особые *Отключенные* состояния работоспособности и состояния, если не включено повторно. Если этот параметр не указан, монитор наследует свое состояние от родительского монитора в иерархии. |


## <a name="scopes-element"></a>область видимости элемента
Каждое переопределение имеет одну или несколько областей, определяющих, к каким виртуальным машинам следует применить переопределение. Областью может быть подписка, Группа ресурсов или одна виртуальная машина. Даже если переопределение находится в ДКР, связанном с определенной виртуальной машиной, оно применяется только к этой виртуальной машине, если виртуальная машина находится в одной из областей переопределения. Это позволяет широко сопоставлять меньшее количество DCR с набором виртуальных машин, но обеспечивает детальный контроль над назначением каждого переопределения в самом ДКР. Вы можете создать небольшой набор DCR и связать их с набором виртуальных машин с помощью политики, одновременно указав переопределения монитора исправности для разных подмножеств этих виртуальных машин, использующих элемент областей.

В следующей таблице приведены примеры различных областей.

| Область | Пример |
|:---|:---|
| Одна виртуальная машина | `/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/rg-name/providers/Microsoft.Compute/virutalMachines/my-vm` |
| Все виртуальные машины в группе ресурсов | `/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/rg-name` |
| Все виртуальные машины в подписке | `/subscriptions/00000000-0000-0000-0000-000000000000/` |
| Все виртуальные машины, с которыми связано правило сбора данных | `*` |


## <a name="monitors-element"></a>наблюдает за элементом
Список из одной или нескольких строк, которые определяют, какие мониторы в иерархии работоспособности получат это переопределение. Каждый элемент может быть именем монитора или именем типа, совпадающим с одним или несколькими мониторами, которые будут получать это переопределение. 

```json
"monitors": [
    "<monitor name>"
 ],
```



В следующей таблице перечислены текущие доступные имена мониторов.

| Имя типа | Имя | Описание |
|:---|:---|:---|
| корневой | корневой | Монитор верхнего уровня, представляющий работоспособность виртуальной машины. | |
| Использование ЦП | Использование ЦП | Монитор использования ЦП. | |
| логические диски | логические диски | Составной монитор для состояния работоспособности всех отслеживаемых дисков на виртуальной машине Windows. | |
| логические диски\|* | логические диски \| C:<br>логические диски \| D: | Составной монитор отслеживает работоспособность данного диска на виртуальной машине Windows. | 
| \| * \| свободное место на логических дисках | логические диски \| C: \| свободное место<br>логические диски \| D: \| свободное место | Монитор свободного места на диске виртуальной машины Windows. |
| filesystems | filesystems | Составной монитор для работоспособности всех файловых систем на виртуальной машине Linux. |
| файловые системы\|* | файловые системы\|/<br>/mnt Filesystems \| | Составной монитор отслеживания работоспособности файловой системы виртуальной машины Linux. | filesystems|/вар/лог |
| \| * \| свободное место в файловой системе | \| / \| свободное место в файловой системе<br>файловые \| \| системы/mnt свободное место | Монитор свободного места на диске в файловой системе виртуальных машин Linux. | 
| Память | Память | Составной монитор для работоспособности памяти виртуальной машины. | |
| \|доступная память| \|доступная память | Отслеживает объем доступной памяти на виртуальной машине. | |


## <a name="alertconfiguration-element"></a>Алертконфигуратион, элемент
Указывает, должно ли создаваться предупреждение из монитора.

```json
"alertConfiguration": {
    "isEnabled": true|false
}
```

| Элемент | Обязательный | Описание | 
|:---|:---|:---|
| `isEnabled` | Нет | Если задано значение true, монитор выдает предупреждение при переключении на критическое или состояние предупреждения и разрешает оповещение при возврате в работоспособное состояние. Если задано значение false или опущено, предупреждение не создается.  |


## <a name="monitorconfiguration-element"></a>Мониторконфигуратион, элемент
Применяется только к базовым мониторам. Определяет конфигурацию для монитора, включая состояния работоспособности и их вычисление.

Параметры определяют алгоритм вычисления значения метрики для сравнения с пороговыми значениями. Вместо того чтобы работать с одним образцом данных из базовой метрики, монитор оценивает несколько выборок метрик, полученных в окне, из времени оценки и `lookbackSec` назад. Считается, что все выборки, полученные в течение этого промежутка времени, учитываются, и если количество выборок больше `maxSamples` , то предыдущие вышеуказанные примеры `maxSamples` не учитываются. 

Если число выборок в интервале лукбакк меньше `minSamples` , монитор переключается на *неизвестное* состояние работоспособности, указывая на недостаточность данных для принятия информированного решения о работоспособности базовых метрик. Если затем доступно большее число выборок `minSamples` , функция статистической обработки, указанная параметром евалуатионтипе, выполняет поверх набора для вычисления одного значения.


```json
"monitorConfiguration": {
        "evaluationType" : "<type-of-evaluation>",
        "lookbackSecs": <lookback-number-of-seconds>,
        "evaluationFrequencySecs": <evaluation-frequency-number-of-seconds>,
        "minSamples": <minimum-samples>,
        "maxSamples": <maximum-samples>,
        "warningCondition": {  },
        "criticalCondition": {  }
    }
}
```

| Элемент | Обязательный | Описание | 
|:---|:---|:---|
| `evaluationFrequencySecs` | Нет | Определяет частоту оценки состояния работоспособности. Каждый монитор оценивается во время запуска агента и через обычный интервал, определенный этим параметром. |
| `lookbackSecs`   | Нет | Размер окна лукбакк в секундах. |
| `evaluationType` | Нет | `min` — получение минимального значения из всего набора выборки<br>`max` -получить максимальное значение из всего набора выборок<br>`avg` — получение среднего значения набора выборок<br>`all` — Сравнение каждого отдельного значения в наборе с пороговыми значениями. Монитор переключает состояние только в том случае, если все образцы в условии Set удовлетворяет порогу. |
| `minSamples`     | Нет | Минимальное число значений, используемых для вычисления значения. |
| `maxSamples`     | Нет | Максимальное число значений, которое будет использоваться для вычисления значения. |
| `warningCondition`  | Нет | Пороговое значение и логика сравнения для условия предупреждения. |
| `criticalCondition` | Нет | Пороговое значение и логику сравнения для критического условия. |


## <a name="warningcondition-element"></a>Варнингкондитион, элемент
Определяет пороговое значение и логику сравнения для условия предупреждения. Если этот элемент не указан, монитор никогда не переключается на состояние состояния "предупреждение".

```json
"warningCondition": {
    "isEnabled": true|false,
    "operator": "<comparison-operator>",
    "threshold": <threshold-value>
},
```

| Свойство | Обязательный | Описание | 
|:---|:---|:---|
| `isEnabled` | Нет | Указывает, включено ли условие. Если задано значение **false**, условие отключено, несмотря на то, что можно задать свойства порога и оператора. |
| `threshold` | Нет | Определяет пороговое значение для сравнения вычисленного значения. |
| `operator`  | Нет | Определяет оператор сравнения для использования в выражении порогового значения. Возможные значения: >, <, >=, <=, = =. |


## <a name="criticalcondition-element"></a>Критикалкондитион, элемент
Определяет логику порога и сравнения для критического условия. Если этот элемент не указан, монитор никогда не переключается на состояние критической работоспособности.

```json
"criticalCondition": {
    "isEnabled": true|false,
    "operator": "<comparison-operator>",
    "threshold": <threshold-value>
},
```

| Свойство | Обязательный | Описание | 
|:---|:---|:---|
| `isEnabled` | Нет | Указывает, включено ли условие. Если задано значение **false**, условие отключено, несмотря на то, что можно задать свойства порога и оператора. |
| `threshold` | Нет | Определяет пороговое значение для сравнения вычисленного значения. |
| `operator`  | Нет | Определяет оператор сравнения для использования в выражении порогового значения. Возможные значения: >, <, >=, <=, = =. |

## <a name="sample-data-collection-rule"></a>Правило сбора образцов данных
Пример правила сбора данных, включающего гостевой мониторинг, см. в статье [Включение виртуальной машины с помощью шаблона диспетчер ресурсов](vminsights-health-enable.md#enable-a-virtual-machine-using-resource-manager-template).


## <a name="next-steps"></a>Дальнейшие шаги

- Узнайте больше о [правилах сбора данных](../agents/data-collection-rule-overview.md).