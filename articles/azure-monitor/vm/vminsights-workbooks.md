---
title: Создание интерактивных отчетов VM Insights с помощью книг
description: Упростите составление отчетов с помощью предопределенных и настраиваемых параметризованных книг для аналитики ВМ.
ms.topic: conceptual
author: bwren
ms.author: bwren
ms.date: 03/12/2020
ms.openlocfilehash: bebe9424df24792f7450620657c5e2da5f08196a
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "102046522"
---
# <a name="create-interactive-reports-vm-insights-with-workbooks"></a>Создание интерактивных отчетов VM Insights с помощью книг

Книги объединяют текст, [заносить в журнал запросы](/azure/data-explorer/kusto/query/), метрики и параметры в расширенные Интерактивные отчеты. Книги может редактировать любой другой член группы, у которого есть доступ к тем же ресурсам Azure.

Книги полезны в следующих сценариях:

* Изучите использование виртуальной машины, если вам не известны интересующие вас метрики: использование ЦП, место на диске, память, зависимости сети и т. д. В отличие от других средств аналитики использования, книги позволяют объединять несколько видов визуализаций и анализа, делая их отличными для такого рода просмотра свободной формы.
* Вы узнаете команде о том, как выполняется недавно подготовленная виртуальная машина, отображая метрики для ключевых счетчиков и других событий журнала.
* Совместное использование результатов эксперимента с изменением размера виртуальной машины с другими участниками команды. Вы можете объяснить цели эксперимента с текстом, а затем отобразить каждый показатель использования и аналитические запросы, используемые для вычисления эксперимента, а также четкие вызовы для того, была ли каждая метрика выше или ниже целевой.
* Создание отчетов о влиянии сбоя на использование виртуальной машины, объединение данных, текстовое описание и обсуждение дальнейших действий по предотвращению простоев в будущем.

В следующей таблице перечислены книги, которые включает Эта аналитика VM для начала работы.

| Книга | Описание | Область |
|----------|-------------|-------|
| Производительность | Предоставляет настраиваемую версию нашего представления списка N списков и диаграмм в одной книге, которая использует все включенные счетчики производительности Log Analytics.| В большом масштабе |
| Счетчики производительности | Представление с N верхними диаграммами по широкому набору счетчиков производительности. | В большом масштабе |
| Соединения | Подключения предоставляют подробные сведения о входящих и исходящих подключениях с отслеживаемых виртуальных машин. | В большом масштабе |
| Активные порты | Список процессов, привязанных к портам на отслеживаемых виртуальных машинах, и их действия в выбранном периоде. | В большом масштабе |
| Открытие портов | Число портов, открытых на отслеживаемых виртуальных машинах, и сведения об этих открытых портах. | В большом масштабе |
| Неудачные подключения | Отображение числа неудачных подключений на отслеживаемых виртуальных машинах, тренда сбоев и в случае увеличения процента сбоев со временем. | В большом масштабе |
| Безопасность и аудит | Анализ трафика TCP/IP, который сообщает об общих подключениях, вредоносных подключениях, где конечные точки IP находятся глобально.  Чтобы включить все компоненты, необходимо включить обнаружение безопасности. | В большом масштабе |
| Трафик TCP | Ранжированный отчет для наблюдаемых виртуальных машин и их отправки, получения и общего сетевого трафика в сетке и отображаются в виде линии тренда. | В большом масштабе |
| Сравнение трафика | Эти книги позволяют сравнивать тенденции сетевого трафика для одного компьютера или группы компьютеров. | В большом масштабе |
| Производительность | Предоставляет настраиваемую версию представления производительности, которая использует все включенные счетчики производительности Log Analytics. | Одиночная виртуальная машина | 
| Соединения | Подключения предоставляют подробные сведения о входящих и исходящих подключениях к виртуальной машине. | Одиночная виртуальная машина |
 
## <a name="creating-a-new-workbook"></a>Создание новой книги

Книга составлена из разделов, состоящих из отдельно редактируемых диаграмм, таблиц, текста и элементов управления для ввода. Чтобы лучше понять книги, начнем с открытия шаблона и пошагового создания пользовательской книги. 

1. Войдите на [портал Azure](https://portal.azure.com).

2. Выберите **виртуальные машины**.

3. Выберите виртуальную машину из списка.

4. На странице Виртуальная машина в разделе **мониторинг** выберите **аналитика**.

5. На странице VM Insights выберите вкладку **производительность** или **карты** , а затем на странице щелкните ссылку **Просмотреть книги** . В раскрывающемся списке выберите **Перейти к коллекции**.

    ![Снимок экрана: раскрывающийся список книги](media/vminsights-workbooks/workbook-dropdown-gallery-01.png)

    Откроется коллекция книг с набором готовых книг, которые помогут приступить к работе.

7. Создайте новую книгу, выбрав **создать**.

    ![Снимок экрана с коллекцией книг приложения](media/vminsights-workbooks/workbook-gallery-01.png)

## <a name="editing-workbook-sections"></a>Editing workbook sections (Правка разделов книги)

Книги могут работать в двух режимах: **режиме редактирования** и **режиме чтения**. При первом запуске новой книги она открывается в **режиме редактирования**. В нем отображается все содержимое книги, включая все шаги и параметры, которые в противном случае скрыты. **Режим чтения** представляет упрощенный стиль отчета. Режим чтения позволяет отказаться от сложностей, которые приходили к созданию отчета и по-прежнему имеют базовую механику лишь нескольких щелчков мышью при необходимости для изменения.

![Снимок экрана: раздел книги "виртуальные машины" в Azure Monitor отображение новой книги в режиме редактирования с выделенными элементами управления для редактирования.](media/vminsights-workbooks/workbook-new-workbook-editor-01.png)

1. Завершив редактирование раздела, нажмите кнопку **done Edit (Готово** ) в нижнем левом углу раздела.

2. Чтобы создать копию раздела, щелкните значок **Clone this section** (Клонировать этот раздел). Создание повторяющихся разделов — это отличный способ для выполнения итерации по запросу без потери предыдущих итераций.

3. Чтобы перейти к следующему или к предыдущему разделу в книге, щелкните значок **Вверх** или **Вниз**.

4. Чтобы окончательно удалить раздел, щелкните значок **Удалить**.

## <a name="adding-text-and-markdown-sections"></a>Добавление текста и разделы разметки Markdown

Добавление заголовков, объяснений и комментариев в Workbooks позволяет превратить набор таблиц и диаграмм в описание. Разделы текста в книгах поддерживают [синтаксис разметки Markdown](https://daringfireball.net/projects/markdown/) для форматирования текста, например заголовков, полужирного шрифта, курсива и маркированных списков.

Чтобы добавить раздел текста в книгу, используйте кнопку **Добавить текст** в нижней части книги, либо в нижней части любого раздела.

## <a name="adding-query-sections"></a>Добавление разделов запроса

![Раздел "Запрос" в Workbooks](media/vminsights-workbooks/005-workbook-query-section.png)

Чтобы добавить раздел запроса в книгу, используйте кнопку **Добавить запрос** в нижней части книги либо в нижней части любого раздела.

Разделы запросов очень гибки и позволяют отвечать на вопросы наподобие следующих:

* Как использование ЦП в течение того же периода времени, что и увеличение сетевого трафика?
* Какова тенденция свободного места на диске за прошлый месяц?
* Сколько сбоев сетевого подключения было в моей работе виртуальной машины за последние две недели? 

Кроме того, не ограничиваются запросы из контекста виртуальной машины, из которой была запущена книга. Вы можете выполнять запросы к нескольким виртуальным машинам, а также Log Analytics рабочим областям при условии, что у вас есть разрешение на доступ к этим ресурсам.

Для включения данных из других Log Analytics рабочих областей или из определенного Application Insights приложения с использованием идентификатора **рабочей области** . Дополнительные сведения о запросах между ресурсами см. в [официальном руководстве](../logs/cross-workspace-query.md).

### <a name="advanced-analytic-query-settings"></a>Расширенные параметры запросов аналитики

Каждый раздел имеет свои собственные дополнительные параметры, доступ к которым можно получить с помощью ![ значка "Параметры" в разделе "Редактирование элементов управления ](media/vminsights-workbooks/006-settings.png) ", расположенного справа от кнопки " **Добавить параметры** ".

![Снимок экрана: диалоговое окно "Дополнительные параметры" в разделе "книга виртуальных машин" Azure Monitor. Значок, открывающий диалоговое окно, выделяется.](media/vminsights-workbooks/007-settings-expanded.png)

|         |          |
| ---------------- |:-----|
| **Настраиваемая ширина**    | Делает элемент произвольным размером, поэтому вы можете разместить множество элементов в одной строке, что позволит лучше организовывать диаграммы и таблицы в многофункциональные отчеты.  |
| **Условная видимость** | Укажите, чтобы скрыть шаги на основе параметра в режиме чтения. |
| **Экспорт параметра**| Разрешение выбранной строки в сетке или диаграмме приводит к появлению последующих действий по изменению значений или к отображению.  |
| **Отображать запрос, когда он не редактируется** | Отображает запрос над диаграммой или таблицей, даже если в режиме чтения.
| **Показать кнопку "Открыть в службе аналитики", если редактирование не ведется** | Добавляет значок синей аналитики в правый угол диаграммы, чтобы разрешить доступ одним щелчком.|

Большинство из этих параметров довольно очевидны, но для понимания того, как работает **Экспорт параметра**, лучше изучить книгу, использующую эту функцию.

Один из готовых книг — TCP- **трафик**, предоставляющий сведения о метриках подключения виртуальной машины.

Первый раздел книги основан на данных запроса журнала. Второй раздел также основан на данных запроса журнала, но выбор строки в первой таблице будет интерактивно обновлять содержимое диаграмм:

![Снимок экрана: раздел "виртуальные машины" в Azure Monitor с отображением предварительно созданного TCP-трафика.](media/vminsights-workbooks/008-workbook-tcp-traffic.png)

Поведение можно выполнить с помощью параметра **при выборе элемента, экспортировать** дополнительные параметры, которые включены в запросе журнала таблицы.

![Снимок экрана: диалоговое окно "Дополнительные параметры" для книги виртуальных машин с выбранным параметром "при выборе элемента, экспортировать параметр".](media/vminsights-workbooks/009-settings-export.png)

Затем второй запрос к журналу использует экспортированные значения при выборе строки для создания набора значений, которые затем используются в заголовках и диаграммах раздела. Если ни одна строка не выбрана, она скрывает заголовок раздела и диаграммы. 

Например, скрытый параметр во втором разделе использует следующую ссылку из строки, выбранной в сетке:

```
VMConnection
| where TimeGenerated {TimeRange}
| where Computer in ("{ComputerName}") or '*' in ("{ComputerName}") 
| summarize Sent = sum(BytesSent), Received = sum(BytesReceived) by bin(TimeGenerated, {TimeRange:grain})
```

## <a name="adding-metrics-sections"></a>Добавление разделов метрики

Разделы метрики дают вам полный доступ для включения данных метрик Azure Monitor в интерактивные отчеты. В "аналитике ВМ" предварительно созданные книги обычно содержат аналитические данные запросов, а не данные метрик.  Вы можете создавать книги с данными метрик, позволяя использовать все преимущества обоих функций в одном месте. Также есть возможность извлечения данных метрики из ресурсов любой из подписок, к которым у вас есть доступ.

Ниже приведен пример данных виртуальной машины, которые можно извлечь в книгу, чтобы обеспечить визуализацию производительности ЦП в виде сетки:

![Снимок экрана с разделом метрик в книге виртуальной машины в Azure Monitor. Производительность ЦП для каждой виртуальной машины отображается графически.](media/vminsights-workbooks/010-metrics-grid.png)

## <a name="adding-parameter-sections"></a>Добавление разделов параметров

Параметры книги позволяют изменять значения в книге без ручного редактирования в разделах запросов или текста. Это устраняет необходимость изучения базового языка запросов аналитики и значительно расширяет возможности потенциальной аудитории отчетов на основе книг.

Значения параметров подставляются в запросы, текст или в другие разделы параметров; для этого поместите имя параметра в фигурные скобки, например ``{parameterName}``. Имена параметров ограничены аналогичными правилами в качестве идентификаторов JavaScript, букв или знаков подчеркивания, за которыми следуют буквы, цифры и символы подчеркивания. Так, **a1** разрешено, но **1a** не допускается.

Параметры являются линейными, начиная с верхней части книги и до последующих шагов.  Параметры, объявленные далее в книге, могут переопределять параметры, объявленные ранее. Это также позволяет параметрам, которые используют запросы для доступа к значениям из параметров, определенных ранее. В пределах самого шага параметров параметры также линейны и идут слева направо; параметры справа могут зависеть от параметра, объявленного ранее на этом же шаге.
 
Существует четыре разных типа параметров, которые в настоящее время поддерживаются:

|                  |      |
| ---------------- |:-----|
| **Text**    | Позволяет пользователю редактировать текстовое поле. при необходимости можно указать запрос для заполнения значения по умолчанию. |
| **Раскрывающийся список** | Позволяет пользователю выбирать из набора значений. |
| **Выбор диапазона времени**| Позволяет пользователю выбирать из предопределенного набора значений диапазона времени или выбирать из настраиваемого диапазона времени.|
| **Средство выбора ресурсов** | Позволяет пользователю выбрать ресурсы, выбранные для книги.|

### <a name="using-a-text-parameter"></a>Использование текстового параметра

Значение, которое пользователь вводит в текстовое поле, заменяется непосредственно в запросе без экранирования или заключения в кавычки. Если нужное значение — строка, параметр в запросе должен быть заключен в кавычки (например, **'{parameter}'**).

Параметр Text позволяет использовать значение в текстовом поле в любом месте. Это может быть имя таблицы, имя столбца, имя функции, оператор и т. д.  Тип параметра Text имеет параметр **получить значение по умолчанию из аналитического запроса**, что позволяет автору книги использовать запрос для заполнения значения по умолчанию для этого текстового поля.

При использовании значения по умолчанию из запроса к журналу в качестве значения по умолчанию используется только первое значение первой строки (строка 0, столбец 0). Поэтому рекомендуется ограничить запрос, чтобы он возвращал только одну строку и один столбец. Любые другие данные, возвращаемые запросом, не учитываются. 

Какое бы значение ни вернул запрос, оно будет подставлено напрямую без экранирования или заключения в кавычки. Если запрос не возвращает строки, результат параметра будет пустой строкой (если параметр не является обязательным) или не определен (если параметр является обязательным).

### <a name="using-a-drop-down"></a>Использование раскрывающегося списка

Тип параметра dropdown позволяет создать раскрывающийся список, позволяющий выбрать одно или несколько значений.

Раскрывающийся список заполняется запросом журнала или JSON. Если запрос возвращает один столбец, то значения в этом столбце являются как значениями, так и метками в раскрывающемся элементе управления. Если запрос возвращает два столбца, первый столбец — это значение, а второй столбец — это метка, отображаемая в раскрывающемся списке. Если запрос возвращает три столбца, третий столбец используется для указания выбора по умолчанию в этом раскрывающемся списке. Этот столбец может быть любого типа, но проще всего использовать логические или числовые типы, где 0 — ложь, а 1 — истина.

Если столбец имеет строковый тип, пустая строка рассматривается как ложное значение, а любое другое значение считается истинным. Для раскрывающегося списка с одним выбором в качестве выбора по умолчанию используется первое значение со значением true.  Для раскрывающегося списка с множественным выделением все значения со значением true используются в качестве выбранного набора по умолчанию. Элементы раскрывающегося списка отображаются в любом порядке, в котором запрос вернул строки. 

Рассмотрим параметры, представленные в отчете Обзор подключений. Щелкните значок Изменить рядом с пунктом **направление**.

![Снимок экрана, посвященный добавлению и изменению параметров отчета в Azure Monitor. Выбран значок редактирования для параметра Direction.](media/vminsights-workbooks/011-workbook-using-dropdown.png)

Запустится пункт меню **изменить параметр** .

![Снимок экрана диалогового окна "изменение параметра". Имя параметра — Direction, тип параметра — раскрывающийся список и выбран параметр получить данные из JSON.](media/vminsights-workbooks/012-workbook-edit-parameter.png)

JSON позволяет создать произвольную таблицу, заполненную содержимым. Например, следующий код JSON создает два значения в раскрывающемся списке:

```
[
    { "value": "inbound", "label": "Inbound"},
    { "value": "outbound", "label": "Outbound"}
]
```

Более подходящий пример — использование раскрывающегося списка для выбора из набора счетчиков производительности по имени:

```
Perf
| summarize by CounterName, ObjectName
| order by ObjectName asc, CounterName asc
| project Counter = pack('counter', CounterName, 'object', ObjectName), CounterName, group = ObjectName
```

Запрос выводит результаты так:

![Раскрывающийся список счетчика производительности](media/vminsights-workbooks/013-workbook-edit-parameter-perf-counters.png)

Раскрывающиеся меню — это невероятно мощные средства для настройки и создания интерактивных отчетов.

### <a name="time-range-parameters"></a>Параметры диапазонов времени

Хотя вы можете создать собственный параметр с настраиваемыми диапазонами времени, используя тип параметра раскрывающегося списка, можно применить готовый тип параметра диапазона времени, если гибкость настройки не так важна. 

В типе параметров с диапазонами времени есть 15 диапазонов по умолчанию: от пяти минут до последних 90 дней. Есть также возможность разрешить выбор настраиваемого диапазона времени, который позволяет явно задать в отчете начальное и конечное значения для диапазона времени.

### <a name="resource-picker"></a>Средство выбора ресурсов

Тип параметра со средством выбора ресурсов дает возможность ограничить отчет определенными типами ресурсов. Примером предварительно созданной книги, использующей тип выбора ресурсов, является книга **производительности** .

![Раскрывающийся список рабочих областей](media/vminsights-workbooks/014-workbook-edit-parameter-workspaces.png)

## <a name="saving-and-sharing-workbooks-with-your-team"></a>Сохранение и совместное использование книг с коллегами

Книги сохраняются в рабочей области Log Analytics или ресурсе виртуальной машины в зависимости от способа доступа к коллекции книг. Книгу можно сохранить в разделе **Мои отчеты** , который является частным для вас, или в разделе **Общие отчеты** , который доступен всем пользователям с доступом к ресурсу. Для просмотра всех книг в ресурсе нажмите кнопку **Открыть** на панели действий.

Чтобы опубликовать книгу, которая находится в разделе **Мои отчеты**, сделайте следующее:

1. На панели действий щелкните **Сохранить**.
2. Нажмите кнопку "..." рядом с книгой, к которой необходимо предоставить доступ.
3. Щелкните **Move to Shared Reports** (Переместить в общие отчеты).

Чтобы опубликовать книгу с помощью ссылки или по электронной почте, нажмите кнопку **Поделиться** в области действия. Имейте в виду, что получателю ссылки потребуется доступ к этому ресурсу на портале Azure, чтобы просмотреть книгу. Чтобы внести изменения, получателям потребуется по крайней мере разрешения участника ресурса.

Чтобы закрепить ссылку на книгу на панели мониторинга Azure, сделайте следующее:

1. На панели действий щелкните **Сохранить**.
2. Нажмите кнопку "..." рядом с книгой, которую требуется закрепить.
3. Щелкните **Закрепить на панели мониторинга**.

## <a name="next-steps"></a>Дальнейшие действия

- Чтобы определить ограничения и общую производительность виртуальной машины, см. статью [Просмотр производительности виртуальной машины Azure](vminsights-performance.md).

- Дополнительные сведения об обнаруженных зависимостях приложений см. в разделе [Просмотр схемы VM Insights](vminsights-maps.md).