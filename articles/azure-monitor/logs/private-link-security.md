---
title: Использование Приватного канала Azure для безопасного подключения сетей к Azure Monitor
description: Использование Приватного канала Azure для безопасного подключения сетей к Azure Monitor
author: noakup
ms.author: noakuper
ms.topic: conceptual
ms.date: 10/05/2020
ms.subservice: ''
ms.openlocfilehash: e9431aac203b831a0ffe22b835acf4677061780c
ms.sourcegitcommit: c27a20b278f2ac758447418ea4c8c61e27927d6a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/03/2021
ms.locfileid: "101707791"
---
# <a name="use-azure-private-link-to-securely-connect-networks-to-azure-monitor"></a>Использование Приватного канала Azure для безопасного подключения сетей к Azure Monitor

[Приватный канал Azure](../../private-link/private-link-overview.md) позволяет безопасно связать службы Azure PaaS с виртуальной сетью с помощью частных конечных точек. Для многих служб достаточно настроить конечную точку для каждого ресурса. Однако Azure Monitor — это совокупность различных взаимосвязанных служб, которые работают вместе для отслеживания рабочих нагрузок. В результате мы создали ресурс, именуемый Azure Monitor областью действия "Частная ссылка" (АМПЛС). АМПЛС позволяет определить границы сети мониторинга и подключиться к виртуальной сети. В этой статье описано, когда использовать и как настроить область Приватного канала Azure Monitor.

## <a name="advantages"></a>Преимущества

Приватный канал предоставляет следующие возможности:

- Частное подключение к Azure Monitor без открытия доступа к общедоступной сети
- Обеспечение доступа к данным мониторинга только через разрешенные частные сети
- Предотвращение кражи данных из частных сетей путем определения конкретных Azure Monitor ресурсов, подключающихся через вашу частную конечную точку
- Безопасное подключение частной локальной сети к Azure Monitor с помощью ExpressRoute и Приватного канала
- Удержание всего трафика внутри магистральной сети Microsoft Azure

Дополнительные сведения см. в разделе [Основные преимущества Приватного канала](../../private-link/private-link-overview.md#key-benefits).

## <a name="how-it-works"></a>Принцип работы

Azure Monitor областью действия "Частная ссылка" (АМПЛС) соединяет частные конечные точки (и виртуальных сетей их) с одним или несколькими Azure Monitor ресурсами Log Analytics рабочих областей и компонентов Application Insights.

![Схема топологии основных ресурсов](./media/private-link-security/private-link-basic-topology.png)

* Частная конечная точка в виртуальной сети позволяет ИТ-подсетям получить доступ к Azure Monitor конечным точкам через частные IP-адреса из пула сети, а не использовать их для общедоступных IP-адресов этих конечных точек. Это позволяет использовать ресурсы Azure Monitor, не открывая виртуальную сеть для ненужного исходящего трафика. 
* Трафик от частной конечной точки к ресурсам Azure Monitor будет передаваться по Microsoft Azure магистральной магистрали, а не к общедоступным сетям. 
* Вы можете настроить каждую из рабочих областей или компонентов, чтобы разрешить или запретить прием и запросы из общедоступных сетей. Это обеспечивает защиту на уровне ресурсов, что позволяет управлять трафиком к конкретным ресурсам.

> [!NOTE]
> Один ресурс Azure Monitor может принадлежать нескольким областям AMPLS, но одну виртуальную сеть невозможно подключить к нескольким AMPLS. 

## <a name="planning-your-private-link-setup"></a>Планирование настройки частной связи

Перед настройкой Azure Monitor установки закрытой ссылки следует учесть топологию сети и, в частности, топологию маршрутизации DNS. 

### <a name="the-issue-of-dns-overrides"></a>Выдача переопределений DNS
Некоторые службы Azure Monitor используют глобальные конечные точки. Это означает, что они служат для обработки запросов, предназначенных для любой рабочей области или компонента. Несколько примеров — это конечная точка приема Application Insights, а также конечная точка запроса как Application Insights, так и Log Analytics.

При настройке подключения к частной ссылке DNS-сервер обновляется, чтобы сопоставлять конечные точки Azure Monitor с частными IP-адресами из диапазона IP-адресов виртуальной сети. Это изменение переопределяет все предыдущие сопоставления этих конечных точек, которые могут иметь осмысленные последствия, рассмотренные ниже. 

### <a name="azure-monitor-private-link-applies-to-all-azure-monitor-resources---its-all-or-nothing"></a>Azure Monitor частная ссылка применяется ко всем ресурсам Azure Monitor — это все или ничего.
Так как некоторые конечные точки Azure Monitor являются глобальными, невозможно создать подключение к частной ссылке для определенного компонента или рабочей области. Вместо этого при настройке частной ссылки на один компонент Application Insights записи DNS обновляются для **всех** компонентов Application Insights. Любая попытка приема или запроса компонента будет проходить через частную ссылку и, возможно, завершится ошибкой. Аналогичным образом, Настройка частной ссылки на одну рабочую область приведет к тому, что все Log Analytics запросы будут проходить по конечной точке запроса закрытой ссылки (но не к запросам на прием, у которых есть конечные точки, относящиеся к конкретной рабочей области).

![Схема переопределений DNS в одной виртуальной сети](./media/private-link-security/dns-overrides-single-vnet.png)

Это справедливо не только для конкретной виртуальной сети, но и для всех виртуальных сетей, использующих один и тот же DNS-сервер (см. [вопрос о выпуске переопределений DNS](#the-issue-of-dns-overrides)). Например, запрос на прием журналов для любого Application Insights компонента всегда будет отправляться через маршрут частного канала. Компоненты, которые не связаны с АМПЛС, не будут работать с проверкой закрытой связи и не проходят проверку.

> [!NOTE]
> Для завершения: после настройки подключения частного канала к одному ресурсу оно применяется ко всем Azure Monitor ресурсам в вашей сети — это все или ничего. Это означает, что следует добавить все ресурсы Azure Monitor в сети в АМПЛС или ни один из них.

### <a name="azure-monitor-private-link-applies-to-your-entire-network"></a>Azure Monitor частная ссылка применяется ко всей сети
Некоторые сети состоят из нескольких виртуальных сетей. Если виртуальных сетей использует один и тот же DNS-сервер, они будут переопределять сопоставления DNS-имен друг друга и, возможно, нарушают связь друг с Azure Monitor (см. [вопрос о выпуске переопределений DNS](#the-issue-of-dns-overrides)). В конечном счете, только последняя виртуальная сеть сможет взаимодействовать с Azure Monitor, так как DNS будет сопоставлять конечные точки Azure Monitor с частными IP-адресами из этого диапазона виртуальных сетей (что может быть недоступно из других виртуальных сетей).

![Схема переопределений DNS в нескольких виртуальных сетей](./media/private-link-security/dns-overrides-multiple-vnets.png)

На приведенной выше схеме сначала виртуальная сеть 10.0.1. x подключается к AMPLS1 и сопоставляет Azure Monitor глобальные конечные точки с IP-адресами из своего диапазона. Позже виртуальная сеть 10.0.2. x подключается к AMPLS2 и переопределяет сопоставление DNS тех *же глобальных конечных точек* с IP-адресами из своего диапазона. Так как эти виртуальных сетей не являются равноправными, первая виртуальная сеть теперь не сможет достичь этих конечных точек.

> [!NOTE]
> В заключение: АМПЛС Setup влияет на все сети, использующие одни и те же зоны DNS. Чтобы избежать переопределения сопоставлений конечных точек DNS других клиентов, лучше настроить одну частную конечную точку в одноранговой сети (например, в виртуальной сети концентратора) или отделить сети на уровне DNS (например, предложенное с помощью DNS-серверов пересылки или отдельно на отдельных DNS-серверах).

### <a name="hub-spoke-networks"></a>Периферийные сети
Топологии типа "звезда" могут избежать проблемы с переопределениями DNS, установив частную связь в Центральной виртуальной сети (основной), а не настроив частную связь для каждой виртуальной сети отдельно. Эта настройка имеет смысл, особенно если Azure Monitor ресурсы, используемые периферийными виртуальных сетей, являются общими. 

![Hub-and-лучевой-Single-PE](./media/private-link-security/hub-and-spoke-with-single-private-endpoint.png)

> [!NOTE]
> Вы можете намеренно создать отдельные частные ссылки для периферийной виртуальных сетей, например, чтобы разрешить каждой виртуальной сети доступ к ограниченному набору ресурсов мониторинга. В таких случаях можно создать выделенную частную конечную точку и АМПЛС для каждой виртуальной сети, но также необходимо убедиться, что они не используют одни и те же зоны DNS, чтобы избежать переопределений DNS.


### <a name="consider-limits"></a>Рассмотрите ограничения

Как указано в [ограничениях и](#restrictions-and-limitations)ограничениях, объект амплс имеет ряд ограничений, показанных в топологии ниже:
* Каждая виртуальная сеть подключается только к **одному** объекту амплс.
* АМПЛС B подключен к частным конечным точкам двух виртуальных сетей (VNet2 и VNet3), используя 2 из 10 возможных подключений к частным конечным точкам.
* АМПЛС A подключается к двум рабочим областям и одному компоненту Application Insights, используя 3 из 50 возможных подключений к ресурсам Azure Monitor.
* Workspace2 подключается к АМПЛС A и АМПЛС B, используя 2 из 5 возможных АМПЛС подключений.

![Схема ограничений АМПЛС](./media/private-link-security/ampls-limits.png)


## <a name="example-connection"></a>Пример подключения

Начните с создания ресурса области Приватного канала Azure Monitor.

1. Перейдите в раздел **Создание ресурса** на портале Azure и выполните поиск фразы **область Приватного канала Azure Monitor**.

   ![Поиск Azure Monitor области частной ссылки](./media/private-link-security/ampls-find-1c.png)

2. Нажмите кнопку **Создать**.
3. Выберите подписку и группу ресурсов.
4. Присвойте области AMPLS имя. Лучше использовать понятное и понятное имя, например "Аппсерверпродтелем".
5. Выберите **Review + Create** (Просмотреть и создать). 

   ![Создание Azure Monitor области частной ссылки](./media/private-link-security/ampls-create-1d.png)

6. Разрешите этап проверки, а затем нажмите кнопку **создать**.

### <a name="connect-azure-monitor-resources"></a>Подключение к ресурсам Azure Monitor

Подключите Azure Monitor ресурсы (рабочие области Log Analytics и компоненты Application Insights) к АМПЛС.

1. В области Azure Monitor частная Ссылка выберите **Azure Monitor ресурсы** в меню слева. Нажмите кнопку **Добавить**.
2. Добавьте рабочую область или компонент. При нажатии кнопки **Добавить** открывается диалоговое окно, в котором можно выбрать Azure Monitor ресурсы. Вы можете просмотреть свои подписки и группы ресурсов, а также ввести их имя для фильтрации. Выберите рабочую область или компонент и нажмите кнопку **Применить** , чтобы добавить их в область.

    ![Снимок экрана: выбор области взаимодействия с пользователем](./media/private-link-security/ampls-select-2.png)

> [!NOTE]
> Для удаления ресурсов Azure Monitor необходимо сначала отключить их от всех объектов АМПЛС, к которым они подключены. Невозможно удалить ресурсы, подключенные к АМПЛС.

### <a name="connect-to-a-private-endpoint"></a>Подключение к частной конечной точке

Теперь, когда у вас есть ресурсы, подключенные к AMPLS, создайте частную конечную точку для подключения к нашей сети. Эту задачу можно выполнить в [центре Приватных каналов на портале Azure](https://portal.azure.com/#blade/Microsoft_Azure_Network/PrivateLinkCenterBlade/privateendpoints) или внутри области Приватного канала Azure Monitor, как это сделано в данном примере.

1. В ресурсе области выберите **подключения частной конечной точки** в меню ресурсов слева. Выберите **частную конечную точку** , чтобы запустить процесс создания конечной точки. Вы также можете утверждать подключения, которые были запущены в частном центре ссылок, выбрав их и выбрав **утвердить**.

    ![Снимок экрана: интерфейс частных конечных точек](./media/private-link-security/ampls-select-private-endpoint-connect-3.png)

2. Выберите подписку, группу ресурсов и имя конечной точки, а также регион, в котором она должна находиться. Регион должен находиться в том же регионе, что и виртуальная сеть, к которой вы подключаетесь.

3. По завершении выберите **Next: Ресурс**. 

4. На экране ресурса

   а. Выберите **подписку**, которая содержит ресурс частной области Azure Monitor. 

   b. Для **типа ресурсов** выберите **Microsoft.insights/privateLinkScopes**. 

   c. В раскрывающемся списке **ресурсов** выберите созданную ранее область Приватного канала. 

   d. Нажмите кнопку **Далее: >конфигурации**.
      ![Снимок экрана: выбор параметра "Создать частную конечную точку"](./media/private-link-security/ampls-select-private-endpoint-create-4.png)

5. В области конфигурации

   а.    Выберите **виртуальную сеть** и **подсеть**, которые нужно подключить к ресурсам Azure Monitor. 
 
   b.    Выберите **Да** для параметра **Интеграция с частной зоной DNS** и позвольте системе автоматически создать новую частную зону DNS. Фактические зоны DNS могут отличаться от тех, которые показаны на снимке экрана ниже. 
   > [!NOTE]
   > Если вы выберете " **нет** " и предпочитаете управлять записями DNS вручную, сначала завершите настройку частной ссылки, включая эту частную конечную точку и конфигурацию амплс. Затем настройте DNS в соответствии с инструкциями в статье о [конфигурации DNS для частной конечной точки Azure](../../private-link/private-endpoint-dns.md). Не создавайте пустые записи при подготовке к настройке Приватного канала. Создаваемые записи DNS могут переопределить имеющиеся параметры и повлиять на подключение к Azure Monitor.
 
   c.    Выберите **Review + create** (Просмотреть и создать).
 
   d.    Дождитесь завершения проверки. 
 
   д)    Нажмите кнопку **создания**. 

    ![Снимок экрана: сведения о выборе закрытой конечной точки.](./media/private-link-security/ampls-select-private-endpoint-create-5.png)

Теперь вы создали новую закрытую конечную точку, подключенную к этому АМПЛС.

## <a name="review-and-validate-your-private-link-setup"></a>Проверка и проверка настройки частной связи

### <a name="reviewing-your-endpoints-dns-settings"></a>Проверка параметров DNS конечной точки
У созданной частной конечной точки теперь должна быть настроена четыре зоны DNS:

[![Снимок экрана зон DNS частной конечной точки.](./media/private-link-security/private-endpoint-dns-zones.png)](./media/private-link-security/private-endpoint-dns-zones-expanded.png#lightbox)

* привателинк-Monitor-Azure-com
* привателинк-OMS-opinsights-Azure-com
* привателинк-ODS-opinsights-Azure-com
* привателинк-agentsvc-Azure-Automation-NET

Каждая из этих зон сопоставляет конкретные конечные точки Azure Monitor с частными IP-адресами из пула IP-адресов виртуальной сети частной конечной точки.

#### <a name="privatelink-monitor-azure-com"></a>Привателинк-Monitor-Azure-com
Эта зона охватывает глобальные конечные точки, используемые Azure Monitor. Это означает, что эти конечные точки выполняют запросы, в которых рассматриваются все ресурсы, а не конкретный. В этой зоне должны сопоставлены конечные точки для:
* `in.ai` -(Application Insightsная конечная точка приема, вы увидите глобальную и региональную запись.
* `api` -Application Insights и Log Analytics конечная точка API
* `live` — Application Insights конечная точка динамических метрик
* `profiler` -Application Insights конечную точку профилировщика
* `snapshot`Снимок экрана конечной точки моментальных снимков Application Insights [ ![ в мониторе зоны частная зона DNS-Azure-com.](./media/private-link-security/dns-zone-privatelink-monitor-azure-com.png)](./media/private-link-security/dns-zone-privatelink-monitor-azure-com-expanded.png#lightbox)

#### <a name="privatelink-oms-opinsights-azure-com"></a>привателинк-OMS-opinsights-Azure-com
Эта зона охватывает сопоставление конкретных рабочих областей с конечными точками OMS. Вы должны увидеть запись для каждой рабочей области, связанной с АМПЛС, подключенной к этой частной конечной точке.
[![Снимок экрана Частная зона DNS Zone OMS-opinsights-Azure-com.](./media/private-link-security/dns-zone-privatelink-oms-opinsights-azure-com.png)](./media/private-link-security/dns-zone-privatelink-oms-opinsights-azure-com-expanded.png#lightbox)

#### <a name="privatelink-ods-opinsights-azure-com"></a>привателинк-ODS-opinsights-Azure-com
Эта зона охватывает сопоставление конкретных рабочих областей с конечными точками ODS — конечная точка приема Log Analytics. Вы должны увидеть запись для каждой рабочей области, связанной с АМПЛС, подключенной к этой частной конечной точке.
[![Снимок экрана Частная зона DNS Zone ODS-opinsights-Azure-com.](./media/private-link-security/dns-zone-privatelink-ods-opinsights-azure-com.png)](./media/private-link-security/dns-zone-privatelink-ods-opinsights-azure-com-expanded.png#lightbox)

#### <a name="privatelink-agentsvc-azure-automation-net"></a>привателинк-agentsvc-Azure-Automation-NET
Эта зона охватывает сопоставление конкретных рабочих областей с конечными точками автоматизации службы агента. Вы должны увидеть запись для каждой рабочей области, связанной с АМПЛС, подключенной к этой частной конечной точке.
[![Снимок экрана агента зоны Частная зона DNS SVC-Azure-Automation-NET.](./media/private-link-security/dns-zone-privatelink-agentsvc-azure-automation-net.png)](./media/private-link-security/dns-zone-privatelink-agentsvc-azure-automation-net-expanded.png#lightbox)

### <a name="validating-you-are-communicating-over-a-private-link"></a>Идет проверка связи с закрытой ссылкой
* Чтобы проверить, что запросы теперь отправляются через закрытую конечную точку и в закрытые, сопоставленные с IP-адресами конечные точки, их можно просмотреть с помощью сетевого отслеживания в средствах или даже в браузере. Например, при попытке отправить запрос к рабочей области или приложению убедитесь, что запрос отправлен на частный IP-адрес, сопоставленный с конечной точкой API, в данном примере это *172.17.0.9*.

    Примечание. Некоторые браузеры могут использовать другие параметры DNS (см. раздел [параметры DNS в браузере](#browser-dns-settings)). Убедитесь, что параметры DNS применяются.

* Чтобы убедиться, что ваша рабочая область или компонент не получают запросы из общедоступных сетей (не подключенных через АМПЛС), задайте для флага общего приема и запроса ресурса значение *нет* , как описано в разделах [Управление доступом из областей закрытых ссылок](#manage-access-from-outside-of-private-links-scopes).

* С клиента в защищенной сети используйте `nslookup` для любой из конечных точек, перечисленных в зонах DNS. Он должен быть разрешен сервером DNS на сопоставленные частные IP-адреса вместо общедоступных IP-адресов, используемых по умолчанию.


## <a name="configure-log-analytics"></a>Настройка Log Analytics

Перейдите на портал Azure. В меню ресурсов рабочей области Log Analytics в левой части находится элемент с именем **Сетевая изоляция** . Из этого меню можно управлять двумя разными состояниями.

![Сетевая изоляция Log Analytics](./media/private-link-security/ampls-log-analytics-lan-network-isolation-6.png)

### <a name="connected-azure-monitor-private-link-scopes"></a>Подключенные Azure Monitor области закрытых ссылок
На этом экране отображаются все области, подключенные к рабочей области. Подключение к областям (Амплсс) позволяет получить сетевой трафик из виртуальной сети, подключенной к каждому АМПЛС, чтобы достичь этой рабочей области. Создание подключения с помощью этой оснастки дает тот же результат, что и настройка в области, так же как и при [подключении Azure Monitorных ресурсов](#connect-azure-monitor-resources). Чтобы добавить новое подключение, нажмите кнопку **Добавить** и выберите область Azure Monitor закрытая ссылка. Нажмите кнопку **Применить** , чтобы подключить его. Обратите внимание, что Рабочая область может подключаться к 5 объектам АМПЛС, как упоминалось в [ограничениях](#restrictions-and-limitations). 

### <a name="manage-access-from-outside-of-private-links-scopes"></a>Управление доступом за пределами областей частных ссылок
Параметры в нижней части этой страницы контролируют доступ из общедоступных сетей, что означает сети, не подключенные через указанные выше области. Параметр **Разрешить доступ к общедоступной сети для приема** **не** блокирует прием журналов от компьютеров, которые находятся за пределами подключенных областей. Параметр **Разрешить доступ к общедоступной сети для запросов** **не** блокирует запросы, поступающие с компьютеров за пределами области. Это включает запросы, выполняемые через книги, панели мониторинга, клиентские интерфейсы на основе API, аналитические сведения в портал Azure и многое другое. Возможности, выполняемые за пределами портал Azure, и запрос Log Analytics данных также должны выполняться в частной связанной виртуальной сети.

### <a name="exceptions"></a>Исключения
Ограничение доступа, описанное выше, не применяется к Azure Resource Manager и, следовательно, имеет следующие ограничения.
* Доступ к данным. в то время как блокирование или разрешение запросов из общедоступных сетей к большинству Log Analytics, некоторые возможности запроса данных с помощью Azure Resource Manager и, следовательно, не смогут запрашивать данные, если в диспетчер ресурсов также не применяются параметры закрытой связи (ожидается компонент). К ним относятся, например, Azure Monitor решения, книги и аналитические сведения, а также соединитель LogicApp.
* Управление рабочими областями. изменение параметров рабочей области и конфигурации (включая включение и отключение этих параметров доступа) осуществляется с помощью Azure Resource Manager. Ограничьте доступ к управлению рабочими областями, используя соответствующие роли, разрешения, сетевые элементы управления и аудит. Дополнительные сведения см. в разделе [Роли, разрешения и безопасность Azure Monitor](../roles-permissions-security.md).

> [!NOTE]
> Журналы и метрики, отправленные в рабочую область с помощью функции [Параметры диагностики](../essentials/diagnostic-settings.md), передаются по защищенному частному каналу Майкрософт и не регулируются этими параметрами.

### <a name="log-analytics-solution-packs-download"></a>Загрузка пакетов решений Log Analytics

Чтобы разрешить агенту Log Analytics скачивать пакеты решений, добавьте соответствующие полные доменные имена в список разрешений брандмауэра. 


| Облачная среда | Ресурс агента | порты; | Направление |
|:--|:--|:--|:--|
|Azure Public     | scadvisorcontent.blob.core.windows.net         | 443 | Исходящие
|Azure для государственных организаций | usbn1oicore.blob.core.usgovcloudapi.net | 443 |  Исходящие
|Azure China 21Vianet      | mceast2oicore.blob.core.chinacloudapi.cn| 443 | Исходящие

## <a name="configure-application-insights"></a>Настройка Application Insights

Перейдите на портал Azure. В ресурсе компонента Azure Monitor Application Insights является **сетевой изоляцией** пункта меню в левой части. Из этого меню можно управлять двумя разными состояниями.

![Сетевая изоляция Application Insights](./media/private-link-security/ampls-application-insights-lan-network-isolation-6.png)

Сначала можно подключить этот ресурс Application Insights к областям Приватного канала Azure Monitor, к которым у вас есть доступ. Выберите **Добавить** и выберите **область Azure Monitor закрытая ссылка**. Нажмите кнопку Применить, чтобы подключить его. На этом экране отображаются все подключенные области. Такое подключение позволяет сетевому трафику в подключенных виртуальных сетях достигать этого компонента и действует так же, как и подключение из области, как и при [подключении Azure Monitorных ресурсов](#connect-azure-monitor-resources). 

Во-вторых, вы можете контролировать, как к этому ресурсу можно получить доступ за пределами областей закрытых ссылок (АМПЛС), перечисленных ранее. Если задать для параметра **Разрешить доступ к общедоступной сети для приема** значение **нет**, то компьютеры или пакеты SDK за пределами подключенных областей не смогут отправлять данные в этот компонент. Если задать для параметра **Разрешить доступ к общедоступной сети для запросов** значение **нет**, компьютеры за пределами областей не смогут получить доступ к данным в этом Application Insights ресурсе. Эти данные включают доступ к журналам APM, метрикам и Live Metrics Stream, а также основанным на них процедурам, таким как книги, панели мониторинга, клиентские процедуры на основе API запросов, аналитика на портале Azure и многое другое. 

> [!NOTE]
> Кроме того, в частной связанной виртуальной сети, которая включает отслеживаемые рабочие нагрузки, также должен выполняться интерфейс, не связанный с использованием портала.

Вам потребуется добавить ресурсы, содержащие отслеживаемые рабочие нагрузки, в Приватный канал. [Здесь](../../app-service/networking/private-endpoint.md) приведена документация о том, как это сделать для служб приложений.

Подобное ограничение доступа применяется только к данным в ресурсе Application Insights. Однако изменения конфигурации, включая включение и отключение этих параметров доступа, управляются Azure Resource Manager. Поэтому следует ограничить доступ к диспетчер ресурсов с помощью соответствующих ролей, разрешений, сетевых элементов управления и аудита. Дополнительные сведения см. в разделе [Роли, разрешения и безопасность Azure Monitor](../roles-permissions-security.md).

> [!NOTE]
> Чтобы полностью защитить Application Insights на основе рабочих областей, необходимо заблокировать доступ к ресурсу Application Insights, а также к базовой рабочей области Log Analytics.
>
> Диагностика на уровне кода (профилировщик или отладчик) требуют предоставления собственной учетной записи хранения для поддержки частной ссылки. Ниже приведена [Документация](../app/profiler-bring-your-own-storage.md) по этому способу.

### <a name="handling-the-all-or-nothing-nature-of-private-links"></a>Обработка частных ссылок "все-или ничего"
Как описано в разделах [Планирование настройки частной связи](#planning-your-private-link-setup), Настройка частной ссылки, даже для одного ресурса, влияет на все ресурсы Azure Monitor в этих сетях, а также в других сетях, использующих одну и ту же службу DNS. Это может усложнить процесс адаптации. Следуйте приведенным ниже рекомендациям.

* Все в — самый простой и наиболее безопасный подход — добавить все компоненты Application Insights в АМПЛС. Для компонентов, к которым вы хотите получить доступ из других сетей, оставьте так, чтобы флаги "разрешить общий доступ к Интернету для приема и запросов" были установлены в значение Да (по умолчанию).
* Изоляция сетей. Если вы (или можете выполнить сопоставление) с помощью виртуальных сетей-лучевой зоны, следуйте указаниям в [топологии сети Hub в Azure](/azure/architecture/reference-architectures/hybrid-networking/hub-spoke). Затем настройте отдельные параметры частной связи в соответствующем периферийном виртуальных сетей. Кроме того, следует разделять зоны DNS, так как совместное использование зон DNS с другими периферийными сетями приведет к переопределению [DNS](#the-issue-of-dns-overrides).
* Используйте пользовательские зоны DNS для конкретных приложений. это решение позволяет получить доступ к выбранным компонентам Application Insights по частной ссылке, сохраняя при этом весь остальной трафик через общедоступные маршруты.
    - Настройте [собственную закрытую зону DNS](../../private-link/private-endpoint-dns.md)и присвойте ей уникальное имя, например internal.Monitor.Azure.com.
    - Создайте АМПЛС и закрытую конечную точку и выберите **не** выполнять автоматическую интеграцию с частным DNS.
    - Перейдите в раздел Частная конечная точка — > конфигурацию DNS и проверьте предлагаемое сопоставление полных доменных имен.
    - Выберите Добавление конфигурации и выбор только что созданной зоны internal.monitor.azure.com.
    - Добавление записей для указанного выше ![ снимка экрана настроенной зоны DNS](./media/private-link-security/private-endpoint-global-dns-zone.png)
    - Перейдите к компоненту Application Insights и скопируйте его [строку подключения](../app/sdk-connection-string.md).
    - Приложения или скрипты, которые должны вызывать этот компонент по закрытой ссылке, должны использовать строку подключения с параметром EndpointSuffix = internal. Monitor. Azure. com.
* Сопоставьте конечные точки через файлы hosts вместо DNS, чтобы иметь доступ к частной ссылке только с определенного компьютера или виртуальной машины в сети:
    - Настройка АМПЛС и частной конечной точки, а также **Отключение** автоматической интеграции с частным DNS 
    - Настройте указанные выше записи A на компьютере, на котором выполняется приложение, в файле hosts.


## <a name="use-apis-and-command-line"></a>Использование API и командной строки

Процесс, описанный выше, можно автоматизировать с помощью Azure Resource Manager шаблонов, функции RESTFUL и интерфейсов командной строки.

Чтобы создать области частной связи и управлять ими, используйте [REST API](/rest/api/monitor/private%20link%20scopes%20(preview)) или [Azure CLI (AZ отслеживать частную ссылку на область)](/cli/azure/monitor/private-link-scope).

Для управления доступом к сети используйте флаги `[--ingestion-access {Disabled, Enabled}]` и `[--query-access {Disabled, Enabled}]` в [рабочих областях Log Analytics](/cli/azure/monitor/log-analytics/workspace) или [компонентах Application Insights](/cli/azure/ext/application-insights/monitor/app-insights/component).

## <a name="collect-custom-logs-and-iis-log-over-private-link"></a>Собирайте пользовательские журналы и запись журнала IIS по частной ссылке

Учетные записи хранения используются в процессе приема пользовательских журналов. По умолчанию используются учетные записи хранения, управляемые службой. Однако для приема пользовательских журналов через приватные каналы необходимо использовать собственные учетные записи хранения и связать их с рабочими областями Log Analytics. Дополнительные сведения о настройке таких учетных записей см. в разделе об [использовании командной строки](/cli/azure/monitor/log-analytics/workspace/linked-storage).

Дополнительные сведения об использовании собственной учетной записи хранения см. в разделе [Принадлежащие заказчику учетные записи хранения для приема журналов](private-storage.md).

## <a name="restrictions-and-limitations"></a>Ограничения

### <a name="ampls"></a>амплс
Объект АМПЛС имеет ряд ограничений, которые следует учитывать при планировании настройки частного канала.

* Виртуальная сеть может подключаться только к одному объекту АМПЛС. Это означает, что объект АМПЛС должен предоставлять доступ ко всем ресурсам Azure Monitor, к которым виртуальная сеть должна иметь доступ.
* Ресурс Azure Monitor (Рабочая область или компонент Application Insights) может подключиться не более чем к 5 Амплсс.
* Объект АМПЛС может подключаться к ресурсам 50 Azure Monitor.
* В большинстве случаев объект АМПЛС может подключаться к 10 частным конечным точкам.

См. раздел [ограничения](#consider-limits) для более глубокого анализа этих ограничений.

### <a name="agents"></a>Агенты

Для поддержки безопасного приема данных в Log Analytics рабочих областях необходимо использовать последние версии агентов Windows и Linux. Более старые версии не могут передавать данные мониторинга по частной сети.

**Агент Log Analytics для Windows**

Используйте Log Analytics агента версии 10.20.18038.0 или более поздней.

**Агент Log Analytics для Linux**

Используйте агент версии 1.12.25 или более поздней. Если вы не можете, выполните следующие команды на виртуальной машине.

```cmd
$ sudo /opt/microsoft/omsagent/bin/omsadmin.sh -X
$ sudo /opt/microsoft/omsagent/bin/omsadmin.sh -w <workspace id> -s <workspace key>
```

### <a name="azure-portal"></a>Портал Azure

Чтобы использовать такие функции на портале Azure Monitor, как Application Insights и Log Analytics, необходимо разрешить доступ к порталу Azure и расширениям Azure Monitor в частных сетях. Добавьте теги **AzureActiveDirectory**, **AzureResourceManager**, **азурефронтдур. фирстпарти** и **Азурефронтдур. интерфейсной** [службы](../../firewall/service-tags.md) в группу безопасности сети.

### <a name="querying-data"></a>Запрос данных
[ `externaldata` Оператор](/azure/data-explorer/kusto/query/externaldata-operator?pivots=azuremonitor) не поддерживается по закрытой ссылке, так как считывает данные из учетных записей хранения, но не гарантирует, что доступ к хранилищу осуществляется в частном порядке.

### <a name="programmatic-access"></a>Программный доступ

Чтобы использовать REST API, [CLI](/cli/azure/monitor) или PowerShell с Azure Monitor в частных сетях, добавьте [теги службы](../../virtual-network/service-tags-overview.md)  **AzureActiveDirectory** и **AzureResourceManager** в брандмауэр.

### <a name="application-insights-sdk-downloads-from-a-content-delivery-network"></a>Скачивание пакета SDK Application Insights из сети доставки содержимого

Упакуйте код JavaScript в скрипт, чтобы браузер не пытался скачать код из CDN. Пример приведен на сайте [GitHub](https://github.com/microsoft/ApplicationInsights-JS#npm-setup-ignore-if-using-snippet-setup)

### <a name="browser-dns-settings"></a>Параметры DNS браузера

Если вы подключаетесь к ресурсам Azure Monitor по частной ссылке, трафик к этим ресурсам должен проходить через закрытую конечную точку, настроенную в сети. Чтобы включить частную конечную точку, обновите параметры DNS, как описано в [подсоединении к частной конечной точке](#connect-to-a-private-endpoint). Некоторые браузеры используют собственные параметры DNS вместо заданных. Браузер может попытаться подключиться к Azure Monitor общедоступным конечным точкам и полностью обойти частную ссылку. Убедитесь, что параметры браузера не переопределяют или кэшируют старые параметры DNS. 

## <a name="next-steps"></a>Дальнейшие действия

- Сведения о [закрытом хранилище](private-storage.md)