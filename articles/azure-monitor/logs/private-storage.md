---
title: Использование управляемых клиентом учетных записей хранения в Azure Monitor Log Analytics
description: Использование собственной учетной записи хранения для Log Analytics сценариев
ms.topic: conceptual
author: noakup
ms.author: noakuper
ms.date: 09/03/2020
ms.openlocfilehash: 69b5927c73dac14c76b94a4ee5bbb21449f8ec98
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "102047459"
---
# <a name="using-customer-managed-storage-accounts-in-azure-monitor-log-analytics"></a>Использование управляемых клиентом учетных записей хранения в Azure Monitor Log Analytics

Log Analytics полагается на хранилище Azure в различных сценариях. Это обычно управляется автоматически. Однако в некоторых случаях требуется предоставить собственную учетную запись хранения и управлять ею, которая также называется управляемой клиентом учетной записью хранения. В этом документе рассматривается использование управляемого клиентом хранилища для журналов WAD/LAD, частной связи и шифрования ключа, управляемого клиентом (CMK). 

> [!NOTE]
> Не рекомендуется зависеть от содержимого, Log Analytics отправки в управляемое клиентом хранилище, учитывая, что форматирование и содержимое могут измениться.

## <a name="ingesting-azure-diagnostics-extension-logs-wadlad"></a>Прием журналов расширений система диагностики Azure (WAD/LAD)
Агенты расширения система диагностики Azure (также называемые WAD и LAD для агентов Windows и Linux соответственно) собираются различные журналы операционной системы и сохраняют их в управляемой пользователем учетной записи хранения. Затем эти журналы можно принять в Log Analytics для их анализа и анализа.
### <a name="how-to-collect-azure-diagnostics-extension-logs-from-your-storage-account"></a>Как получить журналы расширений система диагностики Azure из учетной записи хранения
Подключите учетную запись хранения к рабочей области Log Analytics в качестве источника данных хранилища с помощью [портал Azure](../agents/diagnostics-extension-logs.md#collect-logs-from-azure-storage) или путем вызова [API Storage Insights](/rest/api/loganalytics/storage%20insights/createorupdate).

Поддерживаемые типы данных:
* Системный журнал
* События Windows
* Service Fabric
* События ETW
* Журналы IIS

## <a name="using-private-links"></a>Использование частных ссылок
Управляемые клиентами учетные записи хранения используются для приема пользовательских журналов или журналов IIS, когда для подключения к Azure Monitor ресурсам используются частные ссылки. Процесс приема этих типов данных сначала передает журналы в промежуточную учетную запись хранения Azure, а затем принимает их только в рабочую область. 

### <a name="using-a-customer-managed-storage-account-over-a-private-link"></a>Использование управляемой клиентом учетной записи хранения по частной ссылке
#### <a name="workspace-requirements"></a>Требования к рабочей области
При подключении к Azure Monitor через частную ссылку агенты Log Analytics могут отправить журналы только в рабочие области, доступные по частному каналу. Это требование означает, что следует:
* Настройка Azure Monitor объекта области закрытых ссылок (АМПЛС)
* Подключение к рабочим областям
* Подключите АМПЛС к сети по частной ссылке. 

Дополнительные сведения о процедуре настройки АМПЛС см. в статье [Использование частной связи Azure для безопасного подключения сетей к Azure Monitor](./private-link-security.md). 

#### <a name="storage-account-requirements"></a>Требования к учетной записи хранения
Чтобы учетная запись хранения была успешно подключена к частной ссылке, она должна:
* Они должны находиться в виртуальной сети или в одноранговых сетях и подключаться к виртуальной сети по частной ссылке.
* Находиться в том же регионе, что и Рабочая область, с которой он связан.
* Разрешить Azure Monitor доступ к учетной записи хранения. Если вы решили разрешить доступ к учетной записи хранения только для выбранных сетей, следует выбрать исключение: "разрешить доверенным службам Майкрософт доступ к этой учетной записи хранения".
![Изображение доверенных служб MS для учетной записи хранения](./media/private-storage/storage-trust.png)
* Если Рабочая область обрабатывает трафик из других сетей, необходимо настроить учетную запись хранения, чтобы разрешить входящий трафик, исходящий из соответствующих сетей и Интернета.
* Координировать версию TLS между агентами и учетной записью хранения. рекомендуется отправить данные в Log Analytics с помощью TLS 1,2 или более поздней версии. Ознакомьтесь [с рекомендациями для конкретной платформы](https://docs.microsoft.com/azure/azure-monitor/logs/data-security#sending-data-securely-using-tls-12)и при необходимости [Настройте агенты для использования TLS 1,2](https://docs.microsoft.com/azure/azure-monitor/agents/agent-windows#configure-agent-to-use-tls-12). Если по какой именно причинам это невозможно, настройте учетную запись хранения для приема TLS 1,0.

### <a name="using-a-customer-managed-storage-account-for-cmk-data-encryption"></a>Использование управляемой клиентом учетной записи хранения для шифрования данных CMK
Служба хранилища Azure шифрует все неактивных данных в учетной записи хранения. По умолчанию для шифрования данных используются ключи, управляемые корпорацией Майкрософт (ММК). Однако служба хранилища Azure также позволяет использовать CMK из хранилища ключей Azure для шифрования данных хранилища. Вы можете либо импортировать собственные ключи в Azure Key Vault, либо использовать Azure Key Vault API для создания ключей.
#### <a name="cmk-scenarios-that-require-a-customer-managed-storage-account"></a>Сценарии CMK, для которых требуется управляемая клиентом учетная запись хранения
* Шифрование запросов оповещений журнала с помощью CMK
* Шифрование сохраненных запросов с помощью CMK

#### <a name="how-to-apply-cmk-to-customer-managed-storage-accounts"></a>Как применить CMK к учетным записям хранения, управляемым клиентом
##### <a name="storage-account-requirements"></a>Требования к учетной записи хранения
Учетная запись хранения и Key Vault должны быть расположены в одном регионе, но могут находиться в разных подписках. Дополнительные сведения о шифровании службы хранилища Azure и управлении ключами см. [в статье шифрование службы хранилища Azure для неактивных данных](../../storage/common/storage-service-encryption.md).

##### <a name="apply-cmk-to-your-storage-accounts"></a>Применение CMK к учетным записям хранения
Чтобы настроить учетную запись хранения Azure для использования CMK с Azure Key Vault, используйте [портал Azure](../../storage/common/customer-managed-keys-configure-key-vault.md?toc=%252fazure%252fstorage%252fblobs%252ftoc.json), [PowerShell](../../storage/common/customer-managed-keys-configure-key-vault.md?toc=%252fazure%252fstorage%252fblobs%252ftoc.json)или [CLI](../../storage/common/customer-managed-keys-configure-key-vault.md?toc=%252fazure%252fstorage%252fblobs%252ftoc.json). 

## <a name="link-storage-accounts-to-your-log-analytics-workspace"></a>Связывание учетных записей хранения с рабочей областью Log Analytics
### <a name="using-the-azure-portal"></a>Использование портала Azure
В портал Azure откройте меню рабочей области и выберите *связанные учетные записи хранения*. Откроется колонка, в которой отображаются связанные учетные записи хранения по приведенным выше вариантам использования (прием по закрытой ссылке, применение CMK к сохраненным запросам или оповещениям).
![Изображение колонки "связанные учетные записи хранения" ](./media/private-storage/all-linked-storage-accounts.png) при выборе элемента в таблице будут открыты сведения об учетной записи хранения, где можно задать или обновить связанную учетную запись хранения для этого типа. 
![Связывание образа колонки учетной записи хранения ](./media/private-storage/link-a-storage-account-blade.png) . при желании вы можете использовать одну и ту же учетную запись для различных вариантов использования.

### <a name="using-the-azure-cli-or-rest-api"></a>Использование Azure CLI или REST API
Вы также можете связать учетную запись хранения с рабочей областью с помощью [Azure CLI](/cli/azure/monitor/log-analytics/workspace/linked-storage) или [REST API](/rest/api/loganalytics/linkedstorageaccounts).

Применимые значения dataSourceType:
* CustomLogs — использование учетной записи хранения для пользовательских журналов и приема журналов IIS
* Запрос: использовать учетную запись хранения для хранения сохраненных запросов (требуется для шифрования CMK)
* Оповещения. Используйте учетную запись хранения для хранения оповещений на основе журнала (требуется для шифрования CMK).


## <a name="managing-linked-storage-accounts"></a>Управление связанными учетными записями хранения

### <a name="create-or-modify-a-link"></a>Создание или изменение ссылки
При связывании учетной записи хранения с рабочей областью Log Analytics начнет использовать ее вместо учетной записи хранения, которой владеет служба. Вы можете выполнить следующие действия: 
* Регистрация нескольких учетных записей хранения для распределения нагрузки журналов между ними
* Повторно использовать одну и ту же учетную запись хранения для нескольких рабочих областей

### <a name="unlink-a-storage-account"></a>Удаление привязки учетной записи хранения
Чтобы отменить использование учетной записи хранения, отключите связь хранилища с рабочей областью. Отмена связи всех учетных записей хранения с рабочей областью означает, Log Analytics будет пытаться полагаться на учетные записи хранения, управляемые службой. Если сеть имеет ограниченный доступ к Интернету, эти хранилища могут быть недоступны, и в любом сценарии, использующем хранилище, произойдет сбой.

### <a name="replace-a-storage-account"></a>Замена учетной записи хранения
Чтобы заменить учетную запись хранения, используемую для приема,
1.  **Создайте ссылку на новую учетную запись хранения.** Агенты ведения журнала получают обновленную конфигурацию и начинают отправлять данные в новое хранилище. Процесс может занять несколько минут.
2.  **Затем удалите связь со старой учетной записью хранения, чтобы агенты не перестанут записывать в удаленную учетную запись.** Процесс приема данных позволяет считывать данные из этой учетной записи до тех пор, пока все они не будут приняты. Не удаляйте учетную запись хранения, пока не будут приняты данные всех журналов.

### <a name="maintaining-storage-accounts"></a>Обслуживание учетных записей хранения
#### <a name="manage-log-retention"></a>Управление хранением журнала
При использовании собственной учетной записи хранения срок хранения не ограничен. Log Analytics не удаляет журналы, хранящиеся в частном хранилище. Вместо этого следует настроить политику для выполнения загрузки в соответствии с вашими предпочтениями.

#### <a name="consider-load"></a>Рассмотрите возможность загрузки
Учетные записи хранения могут выполнять определенную нагрузку на запросы на чтение и запись перед началом запросов на регулирование (Дополнительные сведения см. в разделе [целевые показатели масштабируемости и производительности для хранилища BLOB-объектов](../../storage/common/scalability-targets-standard-account.md)). Регулирование влияет на время, необходимое для приема журналов. Если ваша учетная запись хранения перегружена, зарегистрируйте дополнительную учетную запись хранения, чтобы распределить нагрузку между ними. Чтобы отслеживать емкость и производительность учетной записи хранения, проверьте ее [в портал Azure]( https://docs.microsoft.com/azure/azure-monitor/insights/storage-insights-overview).

### <a name="related-charges"></a>Связанные расходы
На учетные записи хранения начисляются объем хранимых данных, тип хранилища и тип избыточности. Дополнительные сведения см. в статьях [Цены на хранение блочных BLOB-объектов](https://azure.microsoft.com/pricing/details/storage/blobs) и [Цены на хранилище таблиц Azure](https://azure.microsoft.com/pricing/details/storage/tables).


## <a name="next-steps"></a>Следующие шаги

- Узнайте [, как использовать частную ссылку Azure для безопасного подключения сетей к Azure Monitor](private-link-security.md)
- Дополнительные сведения о [Azure Monitor управляемых клиентом ключах](../logs/customer-managed-keys.md)
