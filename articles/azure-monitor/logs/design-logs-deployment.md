---
title: Разработка развертывания журналов Azure Monitor | Документация Майкрософт
description: В этой статье описываются вопросы и рекомендации для клиентов, которые подготавливают развертывание рабочей области в Azure Monitor.
ms.subservice: ''
ms.topic: conceptual
author: bwren
ms.author: bwren
ms.date: 09/20/2019
ms.openlocfilehash: 482a0ba4051fb8b5d1705e0f951a9e075f40bbdb
ms.sourcegitcommit: e559daa1f7115d703bfa1b87da1cf267bf6ae9e8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/17/2021
ms.locfileid: "100621690"
---
# <a name="designing-your-azure-monitor-logs-deployment"></a>Проектирование развертывания журналов Azure Monitor

Azure Monitor хранит данные [журнала](data-platform-logs.md) в log Analytics рабочей области, которая является ресурсом Azure, и контейнером, в котором данные собираются, объединяются и служат административной границей. Хотя вы можете развернуть одну или несколько рабочих областей в подписке Azure, необходимо понимать несколько аспектов, чтобы убедиться в том, что первоначальное развертывание будет соблюдено с учетом экономичных, управляемых и масштабируемых развертываний, отвечающих потребностям вашей организации.

Данные в рабочей области организованы в таблицы, каждый из которых хранит различные виды данных и имеет собственный уникальный набор свойств на основе ресурса, создающего данные. Большинство источников данных будут записывать данные в собственные таблицы в Log Analytics рабочей области.

![Пример модели данных рабочей области](./media/design-logs-deployment/logs-data-model-01.png)

Рабочая область Log Analytics предоставляет следующие преимущества:

* Географическое расположение хранилища данных.
* Изоляция данных за счет предоставления различным пользователям прав доступа, следующих за одной из наших рекомендуемых стратегий проектирования.
* Область для настройки параметров, например [ценовой категории](../platform/manage-cost-storage.md#changing-pricing-tier), [удержания](../platform/manage-cost-storage.md#change-the-data-retention-period)и [ограниченного выделения данных](../platform/manage-cost-storage.md#manage-your-maximum-daily-data-volume).

Рабочие области размещаются в физических кластерах. По умолчанию система создает эти кластеры и управляет ими. Клиенты, которые получают больше 4 ТБ/день, должны создавать собственные выделенные кластеры для своих рабочих областей. Это позволяет лучше управлять и повысить скорость приема.

В этой статье приводятся подробные сведения о вопросах проектирования и миграции, обзоре управления доступом и понимании реализаций, которые мы рекомендуем использовать для ИТ-организации.



## <a name="important-considerations-for-an-access-control-strategy"></a>Важные рекомендации по стратегии управления доступом

Определение необходимого количества рабочих областей зависит от одного или нескольких из следующих требований:

* Вы являетесь глобальной компанией, и по причинам конфиденциальности или в соответствии с нормативными требованиями вам необходимо хранить данные журнала в определенных регионах.
* Вы используете Azure и хотите избежать расходов на передачу исходящих данных, создав рабочую область в том же регионе, где находятся ресурсы Azure, которыми она управляет.
* Вы управляете несколькими подразделениями или бизнес-группами и хотите, чтобы они могли видеть свои данные, но не данные других пользователей. Кроме того, не существует бизнес-требований для объединенного представления между организациями или бизнес-группами.

Сегодня ИТ-организации моделируются как централизованные, децентрализованные, так и встроенные гибридные структуры обеих структур. В результате для соответствия одной из этих организационных структур часто использовались следующие модели развертывания рабочей области:

* **Централизованное**: все журналы хранятся в Центральной рабочей области и управляются одной командой, при этом Azure Monitor предоставляет дифференцированный доступ для каждой команды. В этом сценарии легко управлять, выполнять поиск по ресурсам и перекрестно сопоставлять журналы. Рабочая область может значительно расти в зависимости от объема данных, собираемых из нескольких ресурсов в подписке, с дополнительными административными издержками для поддержки контроля доступа для разных пользователей. Эта модель называется "Центральная и лучевая".
* **Децентрализованное**: каждая группа имеет собственную рабочую область, созданную в группе ресурсов, которыми они владеют и которыми они управляют, а данные журнала разделяются по ресурсам. В этом сценарии Рабочая область может быть защищена, а Управление доступом согласуется с доступом к ресурсам, но при этом трудно перекрестно сопоставить журналы. Пользователи, которым требуется широкое представление многих ресурсов, не могут анализировать данные осмысленным образом.
* **Гибридность**. требования к соответствию аудита безопасности дополнительно усложняют этот сценарий, так как многие организации реализуют обе модели развертывания в параллельном режиме. Это обычно приводит к сложной, дорогостоящей и жесткой поддержке конфигурации с пропуском в журнале.

При использовании агентов Log Analytics для получения данных, чтобы спланировать развертывание агента, вам необходимо знать следующее:

* для получения данных от агентов Windows можно [настроить каждый агент для отправки отчетов в одну или несколько рабочих областей](./../agents/agent-windows.md) даже если отчет передается в группу управления System Center Operations Manager; агент Windows может отправлять отчеты вплоть до четырех рабочих областей;
* агент Linux может отправлять отчет только в одну рабочую область;

Если вы используете System Center Operations Manager 2012 R2 и более поздние версии:

* каждая группа управления Operations Manager может быть [подключена только к одной рабочей области](../agents/om-agents.md); 
* компьютеры Linux, передающие данные в группу управления, должны быть настроены для отправки отчетов непосредственно в рабочую область Log Analytics; если компьютеры Linux уже отправляют отчеты непосредственно в рабочую область и вы хотите отслеживать их с помощью Operations Manager, следуйте этим указаниям, чтобы [отправлять отчеты в группу управления Operations Manager](../agents/agent-manage.md#configure-agent-to-report-to-an-operations-manager-management-group); 
* вы можете установить агент Log Analytics Windows на компьютере Windows и настроить его таким образом, чтобы агент отправлял отчеты как в рабочую область, связанную с Operations Manager, так и в другую рабочую область.

## <a name="access-control-overview"></a>Общие сведения о контроле доступа

С помощью управления доступом на основе ролей Azure (Azure RBAC) можно предоставлять пользователям и группам доступ только к тем ресурсам, которые необходимы им для работы с данными мониторинга в рабочей области. Это позволяет использовать рабочую модель ИТ-организации с использованием одной рабочей области для хранения собранных данных, включенных для всех ресурсов. Например, вы предоставляете доступ к группе, ответственной за службы инфраструктуры, размещенные на виртуальных машинах Azure, и в результате получают доступ только к журналам, созданным виртуальными машинами. Это следует за нашей новой моделью журнала контекста ресурсов. Базис для этой модели предназначен для каждой записи журнала, создаваемой ресурсом Azure, которая автоматически связывается с этим ресурсом. Журналы перенаправляются в центральную рабочую область, которая учитывает области и Azure RBAC на основе ресурсов.

Данные, к которым пользователь имеет доступ, определяются сочетанием факторов, которые перечислены в следующей таблице. Каждый из них описан в следующих разделах.

| Фактор | Описание |
|:---|:---|
| [Режим доступа](#access-mode) | Метод, используемый пользователем для доступа к рабочей области.  Определяет область действия доступных данных и применяемый режим управления доступом. |
| [Режим контроля доступа](#access-control-mode) | Параметр в рабочей области, который определяет, применяются ли разрешения на уровне рабочей области или ресурса. |
| [Разрешения](../platform/manage-access.md) | Разрешения, применяемые к отдельным пользователям или группам пользователей для рабочей области или ресурса. Определяет, к каким данным пользователь будет иметь доступ. |
| [Azure RBAC уровня таблицы](../platform/manage-access.md#table-level-azure-rbac) | Необязательные детализированные разрешения, которые применяются ко всем пользователям независимо от режима доступа или режима управления доступом. Определяет, к каким типам данных имеет доступ пользователь. |

## <a name="access-mode"></a>Режим доступа

*Режим доступа* означает, как пользователь обращается к рабочей области log Analytics и определяет область данных, к которым они имеют доступ. 

У пользователей есть два варианта доступа к данным:

* **Рабочая область — контекст**. Вы можете просмотреть все журналы в рабочей области, к которой у вас есть разрешение. Запросы в этом режиме ограничены всеми данными во всех таблицах рабочей области. Это режим доступа, используемый при обращении к журналам с рабочей областью в качестве области, например при выборе **журналов** в меню **Azure Monitor** в портал Azure.

    ![Контекст Log Analytics из рабочей области](./media/design-logs-deployment/query-from-workspace.png)

* **Контекст ресурса**. при доступе к рабочей области для определенного ресурса, группы ресурсов или подписки, например при выборе **журналов** из меню ресурсов в портал Azure, можно просматривать журналы только для ресурсов во всех таблицах, к которым у вас есть доступ. Запросы в этом режиме ограничены данными, связанными с этим ресурсом. Этот режим также позволяет детально реализовать Azure RBAC.

    ![Контекст Log Analytics из ресурса](./media/design-logs-deployment/query-from-resource.png)

    > [!NOTE]
    > Журналы доступны для запросов контекста ресурсов, только если они должным образом связаны с соответствующим ресурсом. В настоящее время следующие ресурсы имеют ограничения.
    > - Компьютеры за пределами Azure
    > - Service Fabric
    > - Application Insights
    >
    > Вы можете проверить, правильно ли связаны журналы с их ресурсами, выполнив запрос и проверив интересующие вас записи. Если правильный идентификатор ресурса находится в свойстве [_ResourceId](../platform/log-standard-columns.md#_resourceid) , данные доступны для запросов, ориентированных на ресурсы.

Azure Monitor автоматически определяет правильный режим в зависимости от контекста, из которого выполняется поиск по журналам. Область всегда представлена в левом верхнем углу Log Analytics.

### <a name="comparing-access-modes"></a>Сравнение режимов доступа

В следующей таблице перечислены режимы доступа.

| Проблема | В контексте рабочей области | В контексте ресурса |
|:---|:---|:---|
| Для кого предназначена каждая модель? | Центр администрирования. Администраторы, которым необходимо настроить сбор данных и пользователей, которым необходим доступ к широкому спектру ресурсов. Кроме того, в настоящее время требуется для пользователей, которым требуется доступ к журналам для ресурсов за пределами Azure. | Группы приложений. Администраторы ресурсов Azure, которые отслеживаются. |
| Что требуется пользователю для просмотра журналов? | Разрешения для рабочей области. См. раздел **разрешения рабочей области** в разделе [Управление доступом с помощью разрешений рабочей области](../platform/manage-access.md#manage-access-using-workspace-permissions). | Доступ для чтения к ресурсу. См. раздел **разрешения ресурсов** в разделе [Управление доступом с помощью разрешений Azure](../platform/manage-access.md#manage-access-using-azure-permissions). Разрешения могут наследоваться (например, из содержащей их группы ресурсов) или напрямую назначаться ресурсу. Разрешение на доступ к журналам для ресурса будет автоматически назначено. |
| Каковы области разрешений? | Рабочей области. Пользователи с доступом к рабочей области могут запрашивать все журналы в рабочей области из таблиц, к которым у них есть разрешения. См. раздел [Управление доступом к таблицам](../platform/manage-access.md#table-level-azure-rbac) . | Ресурс Azure. Пользователь может запрашивать журналы для конкретных ресурсов, групп ресурсов или подписки, к которым у них есть доступ из любой рабочей области, но не может запрашивать журналы для других ресурсов. |
| Как можно использовать журналы доступа пользователей? | <ul><li>Запустите **журналы** из меню **Azure Monitor** .</li></ul> <ul><li>Запуск **журналов** из **рабочих областей log Analytics**.</li></ul> <ul><li>Из Azure Monitor [книг](../visualizations.md#workbooks).</li></ul> | <ul><li>Запуск **журналов** из меню для ресурса Azure</li></ul> <ul><li>Запустите **журналы** из меню **Azure Monitor** .</li></ul> <ul><li>Запуск **журналов** из **рабочих областей log Analytics**.</li></ul> <ul><li>Из Azure Monitor [книг](../visualizations.md#workbooks).</li></ul> |

## <a name="access-control-mode"></a>Режим контроля доступа

*Режим управления доступом* — это параметр в каждой рабочей области, который определяет, как разрешения определяются для рабочей области.

* **Требовать разрешения рабочей области**: этот режим управления не разрешает детальный доступ к Azure RBAC. Чтобы пользователь получил доступ к рабочей области, ему должны быть предоставлены разрешения для рабочей области или для конкретных таблиц.

    Если пользователь обращается к рабочей области в режиме контекста рабочей области, он имеет доступ ко всем данным в любой таблице, к которой им предоставлен доступ. Если пользователь обращается к рабочей области после режима контекста ресурсов, он получает доступ только к данным этого ресурса в любой таблице, к которой им предоставлен доступ.

    Это значение по умолчанию для всех рабочих областей, созданных до марта 2019.

* **Использовать разрешения для ресурсов или рабочих областей**. Этот режим управления позволяет выполнять детализированный доступ к Azure RBAC. Пользователям можно предоставить доступ только к данным, связанным с ресурсами, которые они могут просматривать, назначая `read` разрешение Azure. 

    Когда пользователь обращается к рабочей области в режиме контекста рабочей области, применяются разрешения рабочей области. Когда пользователь обращается к рабочей области в режиме контекста ресурсов, проверяются только разрешения на ресурсы, а разрешения рабочей области игнорируются. Включите для пользователя Azure RBAC, удалив его из разрешений рабочей области и разрешив распознавание разрешений на доступ к ресурсам.

    Это значение по умолчанию для всех рабочих областей, созданных после марта 2019.

    > [!NOTE]
    > Если у пользователя есть только разрешения на доступ к рабочему пространству, он сможет только обращаться к рабочей области, используя режим контекста ресурсов, предполагая, что режим доступа к рабочей области настроен на **Использование разрешений ресурсов или рабочих областей**.

Чтобы узнать, как изменить режим управления доступом на портале с помощью PowerShell или шаблона диспетчер ресурсов, см. раздел [Настройка режима управления доступом](../platform/manage-access.md#configure-access-control-mode).

## <a name="scale-and-ingestion-volume-rate-limit"></a>Ограничение скорости тома для масштабирования и приема

Azure Monitor — это высокомасштабируемый сервис данных, который обслуживает тысячи клиентов, отправляющих петабайтов данных каждый месяц в растущем темпе. Рабочие области не ограничены в своем пространстве для хранения и могут увеличиваться до петабайтов данных. Не нужно разбивать рабочие области, так как они масштабируются.

Для защиты и изоляции клиентов Azure Monitor и их серверной инфраструктуры существует ограничение скорости приема по умолчанию, предназначенное для защиты от пиковых нагрузок и переполнений. По умолчанию предел скорости составляет около **6 ГБ в минуту** и предназначен для обычного приема. Дополнительные сведения об измерении лимита объема приема см. в разделе [ограничения службы Azure Monitor](../service-limits.md#data-ingestion-volume-rate).

Клиенты, принимающие менее 4 ТБ/день, обычно не соответствуют этим ограничениям. Клиенты, принимающие большие объемы томов или имеющие пиковые значения в рамках обычных операций, рассматривайте переход на [выделенные кластеры](../log-query/logs-dedicated-clusters.md) , в которых может быть вызвано ограничение скорости приема.

При активации предельного значения скорости приема или до 80% от порога в таблицу *операций* в рабочей области добавляется событие. Рекомендуется отслеживать его и создавать оповещения. Дополнительные сведения см. в разделе [скорость приема данных](../service-limits.md#data-ingestion-volume-rate).


## <a name="recommendations"></a>Рекомендации

![Пример проектирования контекста ресурса](./media/design-logs-deployment/workspace-design-resource-context-01.png)

В этом сценарии рассматривается одна рабочая область в подписке ИТ-организации, не ограниченная независимостиом данных или соответствием нормативным требованиям, или она должна сопоставляться с регионами, в которых развернуты ресурсы. Она позволяет группам безопасности и ИТ администратора вашей организации использовать улучшенную интеграцию с управлением доступом Azure и более безопасное управление доступом.

Все ресурсы, решения для мониторинга и аналитические сведения, такие как Application Insights и Azure Monitor для виртуальных машин, поддерживающие инфраструктуру и приложения, обслуживаемые различными командами, настроены на пересылку собранных данных журналов в централизованную общую рабочую область ИТ-организации. Пользователям каждой команды предоставляется доступ к журналам для ресурсов, к которым им предоставлен доступ.

После развертывания архитектуры рабочей области вы можете применить ее к ресурсам Azure с помощью [политики Azure](../../governance/policy/overview.md). Он предоставляет способ определения политик и обеспечения соответствия ресурсов Azure, чтобы они отправляли все журналы ресурсов в определенную рабочую область. Например, с помощью виртуальных машин Azure или масштабируемых наборов виртуальных машин можно использовать существующие политики, оценивающие соответствие рабочей области и результаты отчетов, или настроить для исправления несоответствия.  

## <a name="workspace-consolidation-migration-strategy"></a>Стратегия миграции для консолидации рабочей области

Для клиентов, которые уже развернули несколько рабочих областей и заинтересованы в консолидации с моделью доступа к контексту ресурсов, мы рекомендуем использовать добавочный подход к переходу на рекомендуемую модель доступа, и вы не будете пытаться добиться этого быстро или агрессивно. Следуя поэтапному подходу к планированию, миграции, проверке и прекращению работы после разумной временной шкалы, вы сможете избежать незапланированных инцидентов или непредвиденных последствий в работе облачных операций. Если у вас нет политики хранения данных для соответствия или бизнес-причин, необходимо оценить соответствующий период времени, чтобы хранить данные в рабочей области, из которой выполняется миграция. При перенастройке ресурсов для передачи отчетов в общую рабочую область вы по-прежнему можете анализировать данные в исходной рабочей области по мере необходимости. Когда миграция будет завершена, если вы собираетесь хранить данные в исходной рабочей области до окончания срока хранения, не удаляйте их.

При планировании перехода на эту модель учитывайте следующее.

* Узнайте, какие отраслевые нормы и внутренние политики в отношении хранения данных необходимо соблюдать.
* Убедитесь, что группы приложений могут работать в существующих функциях контекста ресурсов.
* Выявление доступа к ресурсам для групп приложений и их тестирование в среде разработки перед внедрением в рабочую среду.
* Настройте рабочую область, чтобы включить **разрешения на использование ресурсов или рабочих областей**.
* Удаление разрешений группы приложений для чтения и запроса рабочей области.
* Включите и настройте любые решения мониторинга, такие как Azure Monitor для контейнеров и (или) Azure Monitor для виртуальных машин, учетные записи службы автоматизации и решения по управлению, такие как Управление обновлениями, запуск и завершение виртуальных машин и т. д., которые были развернуты в исходной рабочей области.

## <a name="next-steps"></a>Дальнейшие шаги

Чтобы реализовать разрешения и элементы управления безопасности, Рекомендуемые в этом пошаговом окне, ознакомьтесь с разработкой [Управление доступом к журналам](../platform/manage-access.md).
