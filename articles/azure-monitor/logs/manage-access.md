---
title: Управление рабочими областями Log Analytics в Azure Monitor | Документация Майкрософт
description: Вы можете управлять доступом к данным, хранящимся в Log Analytics рабочей области, в Azure Monitor с помощью ресурсов, рабочей области или разрешений уровня таблицы. В этой статье подробно описано, как выполнить.
ms.subservice: logs
ms.topic: conceptual
author: bwren
ms.author: bwren
ms.date: 04/10/2019
ms.openlocfilehash: 184d5c98b2b434c87e112c569ff4e8ab347344c5
ms.sourcegitcommit: e559daa1f7115d703bfa1b87da1cf267bf6ae9e8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/17/2021
ms.locfileid: "100621642"
---
# <a name="manage-access-to-log-data-and-workspaces-in-azure-monitor"></a>Управление доступом к данным журнала и рабочим областям в Azure Monitor

Azure Monitor хранят данные [журнала](../logs/data-platform-logs.md) в рабочей области log Analytics. Рабочей областью называется контейнер, который содержит данные и сведения о конфигурации. Для управления доступом к данным журнала выполняются различные задачи администрирования, связанные с рабочей областью.

В этой статье объясняется, как управлять доступом к журналам и администрировать рабочие области, содержащие их, включая предоставление доступа к: 

* Рабочая область, использующая разрешения рабочей области.
* Пользователи, которым необходим доступ к данным журнала из конкретных ресурсов с помощью управления доступом на основе ролей Azure (Azure RBAC), также называются [контекстом ресурса](../logs/design-logs-deployment.md#access-mode) .
* Пользователи, которым необходим доступ к данным журнала в определенной таблице в рабочей области с помощью Azure RBAC.

Сведения об основных понятиях журналов, связанных с Azure RBAC и стратегиями доступа, см. в статье [Разработка развертывания журналов Azure Monitor](../logs/design-logs-deployment.md) .

## <a name="configure-access-control-mode"></a>Настройка режима управления доступом

[Режим управления доступом](../logs/design-logs-deployment.md) , настроенный в рабочей области, можно просмотреть в портал Azure или с помощью Azure PowerShell.  Этот параметр можно изменить с помощью одного из следующих поддерживаемых методов.

* Портал Azure

* Azure PowerShell

* Шаблон Azure Resource Manager

### <a name="from-the-azure-portal"></a>на портале Azure;

Текущий режим управления доступом к рабочей области можно просмотреть на странице **Обзор** рабочей области в меню **log Analytics Рабочая область** .

![Просмотр режима управления доступом к рабочей области](media/manage-access/view-access-control-mode.png)

1. Войдите на портал Azure по адресу [https://portal.azure.com](https://portal.azure.com).
1. В портал Azure выберите Log Analytics рабочие области > рабочей области.

Этот параметр можно изменить на странице **свойств** рабочей области. Изменение параметра будет отключено, если у вас нет разрешений на настройку рабочей области.

![Изменение режима доступа к рабочей области](media/manage-access/change-access-control-mode.png)

### <a name="using-powershell"></a>Использование PowerShell

Чтобы проверить режим управления доступом для всех рабочих областей в подписке, используйте следующую команду:

```powershell
Get-AzResource -ResourceType Microsoft.OperationalInsights/workspaces -ExpandProperties | foreach {$_.Name + ": " + $_.Properties.features.enableLogAccessUsingOnlyResourcePermissions}
```

Результат должен выглядеть так:

```
DefaultWorkspace38917: True
DefaultWorkspace21532: False
```

Значение `False` означает, что Рабочая область настроена с режимом доступа контекст рабочей области.  Значение `True` означает, что Рабочая область настроена с режимом доступа к контексту ресурса.

> [!NOTE]
> Если Рабочая область возвращается без логического значения и пуста, это также соответствует результатам `False` значения.
>

Используйте следующий скрипт, чтобы настроить режим управления доступом для конкретной рабочей области на разрешение контекста ресурса:

```powershell
$WSName = "my-workspace"
$Workspace = Get-AzResource -Name $WSName -ExpandProperties
if ($Workspace.Properties.features.enableLogAccessUsingOnlyResourcePermissions -eq $null)
    { $Workspace.Properties.features | Add-Member enableLogAccessUsingOnlyResourcePermissions $true -Force }
else
    { $Workspace.Properties.features.enableLogAccessUsingOnlyResourcePermissions = $true }
Set-AzResource -ResourceId $Workspace.ResourceId -Properties $Workspace.Properties -Force
```

Используйте следующий скрипт, чтобы настроить режим управления доступом для всех рабочих областей в подписке на разрешение контекста ресурса:

```powershell
Get-AzResource -ResourceType Microsoft.OperationalInsights/workspaces -ExpandProperties | foreach {
if ($_.Properties.features.enableLogAccessUsingOnlyResourcePermissions -eq $null)
    { $_.Properties.features | Add-Member enableLogAccessUsingOnlyResourcePermissions $true -Force }
else
    { $_.Properties.features.enableLogAccessUsingOnlyResourcePermissions = $true }
Set-AzResource -ResourceId $_.ResourceId -Properties $_.Properties -Force
}
```

### <a name="using-a-resource-manager-template"></a>Использование шаблона Resource Manager

Чтобы настроить режим доступа в шаблоне Azure Resource Manager, задайте для флага компонента **енаблелогакцессусингонлиресаурцепермиссионс** в рабочей области одно из следующих значений.

* **false**: задайте для рабочей области разрешения контекста рабочей области. Это значение по умолчанию, если флаг не установлен.
* **true**: задайте для рабочей области разрешения контекста ресурса.

## <a name="manage-access-using-workspace-permissions"></a>Управление доступом с помощью разрешений рабочей области

Каждая рабочая область может включать учетных записей, каждая из которых может иметь доступ к нескольким рабочим областям. Управление доступом осуществляется с помощью [управления доступом на основе ролей Azure (Azure RBAC)](../../role-based-access-control/role-assignments-portal.md).

Разрешения Azure также требуются для следующих действий:

|Действие |Требуются разрешения Azure |Примечания |
|-------|-------------------------|------|
| Добавление и удаление решений для мониторинга | `Microsoft.Resources/deployments/*` <br> `Microsoft.OperationalInsights/*` <br> `Microsoft.OperationsManagement/*` <br> `Microsoft.Automation/*` <br> `Microsoft.Resources/deployments/*/write` | Эти разрешения нужно предоставить на уровне группы ресурсов или подписки. |
| Изменение ценовой категории | `Microsoft.OperationalInsights/workspaces/*/write` | |
| Просмотр данных на плитках *службы архивации* и *службы Site Recovery* | Администратор или соадминистратор | Имеет доступ к ресурсам, развернутым с использованием классической модели развертывания |
| Создание рабочей области на портале Azure | `Microsoft.Resources/deployments/*` <br> `Microsoft.OperationalInsights/workspaces/*` ||
| Просмотр основных свойств рабочей области и ввод колонки рабочей области на портале | `Microsoft.OperationalInsights/workspaces/read` ||
| Выполнение запросов к журналам с помощью любого интерфейса | `Microsoft.OperationalInsights/workspaces/query/read` ||
| Доступ ко всем типам журналов с помощью запросов | `Microsoft.OperationalInsights/workspaces/query/*/read` ||
| Доступ к определенной таблице журнала | `Microsoft.OperationalInsights/workspaces/query/<table_name>/read` ||
| Чтение ключей рабочей области, чтобы разрешить отправку журналов в эту рабочую область | `Microsoft.OperationalInsights/workspaces/sharedKeys/action` ||

## <a name="manage-access-using-azure-permissions"></a>Управление доступом с помощью разрешений Azure

Чтобы предоставить доступ к рабочей области Log Analytics с помощью разрешений Azure, следуйте указаниям в статье [Использование назначений ролей для управления доступом к ресурсам в подписке Azure](../../role-based-access-control/role-assignments-portal.md). Примеры пользовательских ролей см. в разделе [примеры пользовательских ролей](#custom-role-examples) .

В Azure доступны две встроенные роли пользователя для рабочих областей Log Analytics:

* читатель Log Analytics;
* участник Log Analytics.

Членам роли *Читатель Log Analytics* доступны следующие действия:

* просмотр и поиск всех данных мониторинга;
* просмотр параметров мониторинга, в том числе просмотр конфигурации диагностики Azure на всех ресурсах Azure.

Роль читателя Log Analytics включает следующие действия Azure:

| Type    | Разрешение | Описание |
| ------- | ---------- | ----------- |
| Действие | `*/read`   | Возможность просматривать все ресурсы Azure и их конфигурацию. Включает просмотр следующих данных: <br> состояние расширения виртуальной машины; <br> конфигурация диагностики Azure на ресурсах; <br> Все свойства и параметры всех ресурсов. <br> Для рабочих областей это позволяет иметь полные неограниченные разрешения на чтение параметров рабочей области и выполнение запросов к данным. Ознакомьтесь с более детализированными параметрами выше. |
| Действие | `Microsoft.OperationalInsights/workspaces/analytics/query/action` | Не рекомендуется, назначать их пользователям не требуется. |
| Действие | `Microsoft.OperationalInsights/workspaces/search/action` | Не рекомендуется, назначать их пользователям не требуется. |
| Действие | `Microsoft.Support/*` | Возможность создавать обращения в службу поддержки. |
|Запрет действия | `Microsoft.OperationalInsights/workspaces/sharedKeys/read` | Запрет на чтение ключа рабочей области, необходимого для использования API сбора данных и для установки агентов. Это предотвращает добавление новых ресурсов в рабочую область |

Членам роли *Участник Log Analytics* доступны следующие действия:

* Включает все привилегии *роли читателя log Analytics*, позволяя пользователю читать все данные мониторинга.
* Создание и Настройка учетных записей службы автоматизации
* Добавление и удаление решений по управлению.

    > [!NOTE]
    > Чтобы выполнять последние два действия, нужно предоставить разрешение на уровне группы ресурсов или подписки.

* Чтение ключей учетной записи хранения
* Настройка сбора журналов из службы хранилища Azure
* изменение параметров мониторинга ресурсов Azure, в том числе:
  * добавление расширения виртуальных машин на виртуальные машины;
  * настройка диагностики Azure на всех ресурсах Azure.

> [!NOTE]
> Можно добавить расширение виртуальной машины на виртуальную машину, чтобы получить полный контроль над ней.

Роль участника Log Analytics включает следующие действия Azure:

| Разрешение | Описание |
| ---------- | ----------- |
| `*/read`     | Возможность просматривать все ресурсы и конфигурацию ресурсов. Включает просмотр следующих данных: <br> состояние расширения виртуальной машины; <br> конфигурация диагностики Azure на ресурсах; <br> Все свойства и параметры всех ресурсов. <br> Для рабочих областей это позволяет всем неограниченным разрешениям читать параметр рабочей области и выполнять запросы к данным. Ознакомьтесь с более детализированными параметрами выше. |
| `Microsoft.Automation/automationAccounts/*` | Возможность создания и настройки учетных записей службы автоматизации Azure, в том числе добавление и изменение модулей Runbook. |
| `Microsoft.ClassicCompute/virtualMachines/extensions/*` <br> `Microsoft.Compute/virtualMachines/extensions/*` | Добавление, обновление и удаление расширений виртуальных машин, в том числе расширения Microsoft Monitoring Agent и агента OMS для расширения Linux. |
| `Microsoft.ClassicStorage/storageAccounts/listKeys/action` <br> `Microsoft.Storage/storageAccounts/listKeys/action` | Просмотр ключа учетной записи хранения. Эта возможность необходима для настройки в Log Analytics чтения журналов из учетных записей хранения Azure. |
| `Microsoft.Insights/alertRules/*` | Добавление, обновление и удаление правил генерации оповещений. |
| `Microsoft.Insights/diagnosticSettings/*` | Добавление, обновление и удаление параметров диагностики в ресурсах Azure. |
| `Microsoft.OperationalInsights/*` | Добавление, обновление и удаление конфигурации для рабочих областей Log Analytics. Для изменения дополнительных параметров рабочей области, потребностей пользователей `Microsoft.OperationalInsights/workspaces/write` . |
| `Microsoft.OperationsManagement/*` | Добавление и удаление решений по управлению. |
| `Microsoft.Resources/deployments/*` | Создание и удаление развертываний. Требуется для добавления и удаления решений, рабочих областей и учетных записей службы автоматизации. |
| `Microsoft.Resources/subscriptions/resourcegroups/deployments/*` | Создание и удаление развертываний. Требуется для добавления и удаления решений, рабочих областей и учетных записей службы автоматизации. |

Чтобы добавить пользователей в роль или удалить их из нее, требуются разрешения `Microsoft.Authorization/*/Delete` и `Microsoft.Authorization/*/Write`.

С помощью этих ролей можно предоставлять пользователям доступ к различным областям:

* Подписка — доступ ко всем рабочим областям в подписке.
* Группа ресурсов — доступ ко всем рабочим областям в группе ресурсов.
* Ресурс — доступ к только указанной рабочей области.

Рекомендуется выполнять назначения на уровне ресурсов (рабочей области), чтобы обеспечить точную контроль доступа. Используйте [пользовательские роли](../../role-based-access-control/custom-roles.md) для создания ролей с определенными разрешениями.

### <a name="resource-permissions"></a>Разрешения для ресурсов

Когда пользователи запрашивают журналы из рабочей области с помощью доступа к контексту ресурсов, у них будут следующие разрешения на ресурс:

| Разрешение | Описание |
| ---------- | ----------- |
| `Microsoft.Insights/logs/<tableName>/read`<br><br>Примеры:<br>`Microsoft.Insights/logs/*/read`<br>`Microsoft.Insights/logs/Heartbeat/read` | Возможность просмотра всех данных журнала для ресурса.  |
| `Microsoft.Insights/diagnosticSettings/write` | Возможность настроить параметр диагностики, чтобы разрешить настройку журналов для этого ресурса. |

`/read`разрешение обычно предоставляется из роли, которая включает _\* /Реад или_ _\*_ разрешения, такие как встроенные роли [читателя](../../role-based-access-control/built-in-roles.md#reader) и [участника](../../role-based-access-control/built-in-roles.md#contributor) . Пользовательские роли, включающие определенные действия или выделенные встроенные роли, могут не включать это разрешение.

Дополнительные сведения о создании различных элементов управления доступом для разных таблиц см. в разделе [Определение управления доступом на уровне таблицы](#table-level-azure-rbac) ниже.

## <a name="custom-role-examples"></a>Примеры пользовательских ролей

1. Чтобы предоставить пользователю доступ к данным журнала из своих ресурсов, выполните следующие действия.

    * Настройка режима управления доступом к рабочей области для **использования разрешений рабочей области или ресурса**

    * Предоставьте пользователям `*/read` или `Microsoft.Insights/logs/*/read` разрешениям доступ к своим ресурсам. Если им уже назначена роль [модуля чтения log Analytics](../../role-based-access-control/built-in-roles.md#reader) в рабочей области, это достаточно.

2. Чтобы предоставить пользователю доступ к данным журнала из своих ресурсов и настроить их ресурсы для отправки журналов в рабочую область, выполните следующие действия.

    * Настройка режима управления доступом к рабочей области для **использования разрешений рабочей области или ресурса**

    * Предоставьте пользователям следующие разрешения в рабочей области: `Microsoft.OperationalInsights/workspaces/read` и `Microsoft.OperationalInsights/workspaces/sharedKeys/action` . С этими разрешениями пользователи не могут выполнять запросы на уровне рабочей области. Они могут перечислять только рабочую область и использовать ее в качестве места назначения для параметров диагностики или конфигурации агента.

    * Предоставьте пользователям следующие разрешения для своих ресурсов: `Microsoft.Insights/logs/*/read` и `Microsoft.Insights/diagnosticSettings/write` . Если им уже назначена роль [участника log Analytics](../../role-based-access-control/built-in-roles.md#contributor) , ей назначена роль читателя или предоставлены `*/read` разрешения на этот ресурс, это достаточно.

3. Чтобы предоставить пользователю доступ к данным журнала из своих ресурсов без возможности чтения событий безопасности и отправки данных, выполните следующие действия.

    * Настройка режима управления доступом к рабочей области для **использования разрешений рабочей области или ресурса**

    * Предоставьте пользователям следующие разрешения для своих ресурсов: `Microsoft.Insights/logs/*/read` .

    * Добавьте следующее Недействие, чтобы запретить пользователям чтение типа SecurityEvent: `Microsoft.Insights/logs/SecurityEvent/read` . Недействие должно быть в той же пользовательской роли, что и действие, предоставляющее разрешение на чтение ( `Microsoft.Insights/logs/*/read` ). Если пользователь применяет действие чтения из другой роли, назначенной этому ресурсу, либо к подписке или группе ресурсов, они смогут считывать все типы журналов. Это также верно, если они наследуют `*/read` , например, с ролью читателя или участника.

4. Чтобы предоставить пользователю доступ к данным журнала из своих ресурсов и прочитать все данные журнала Управление обновленияминого решения в Azure AD и прочитать их из рабочей области, выполните следующие действия.

    * Настройка режима управления доступом к рабочей области для **использования разрешений рабочей области или ресурса**

    * Предоставьте пользователям следующие разрешения в рабочей области: 

        * `Microsoft.OperationalInsights/workspaces/read` — требуется, чтобы пользователь мог перечислить рабочую область и открыть колонку рабочей области в портал Azure
        * `Microsoft.OperationalInsights/workspaces/query/read` — требуется для каждого пользователя, который может выполнять запросы.
        * `Microsoft.OperationalInsights/workspaces/query/SigninLogs/read` — чтобы иметь возможность читать журналы входа в Azure AD.
        * `Microsoft.OperationalInsights/workspaces/query/Update/read` — чтобы иметь возможность читать журналы решений Управление обновлениями
        * `Microsoft.OperationalInsights/workspaces/query/UpdateRunProgress/read` — чтобы иметь возможность читать журналы решений Управление обновлениями
        * `Microsoft.OperationalInsights/workspaces/query/UpdateSummary/read` — чтобы иметь возможность читать журналы управления обновлениями.
        * `Microsoft.OperationalInsights/workspaces/query/Heartbeat/read` — требуется для использования решения Управление обновлениями
        * `Microsoft.OperationalInsights/workspaces/query/ComputerGroup/read` — требуется для использования решения Управление обновлениями

    * Предоставьте пользователям следующие разрешения для своих ресурсов: `*/read` , назначенные роли читателя или `Microsoft.Insights/logs/*/read` . 

## <a name="table-level-azure-rbac"></a>Azure RBAC уровня таблицы

**Azure RBAC на уровне таблицы** позволяет определять более детализированный контроль над данными в log Analytics рабочей области в дополнение к другим разрешениям. Этот элемент управления позволяет определять конкретные типы данных, доступные только для определенного набора пользователей.

Вы реализуете управление доступом к таблицам с помощью [настраиваемых ролей Azure](../../role-based-access-control/custom-roles.md) , чтобы предоставить доступ к конкретным [таблицам](../logs/data-platform-logs.md) в рабочей области. Эти роли применяются к рабочим областям с [режимами управления доступом к](../logs/design-logs-deployment.md#access-control-mode) рабочей области или контекстом ресурсов независимо от [режима доступа](../logs/design-logs-deployment.md#access-mode)пользователя.

Создайте [пользовательскую роль](../../role-based-access-control/custom-roles.md) со следующими действиями, чтобы определить доступ к управлению доступом к таблицам.

* Чтобы предоставить доступ к таблице, включите ее в раздел **действия** определения роли. Чтобы вычесть доступ из разрешенных **действий**, включите его в раздел " **без изменений** ".
* Для указания всех таблиц используйте Microsoft. OperationalInsights/workspaces/Query/*.

Например, чтобы создать роль с доступом к таблицам _пульса_ и _AzureActivity_ , создайте настраиваемую роль, выполнив следующие действия.

```
"Actions":  [
    "Microsoft.OperationalInsights/workspaces/read",
    "Microsoft.OperationalInsights/workspaces/query/read",
    "Microsoft.OperationalInsights/workspaces/query/Heartbeat/read",
    "Microsoft.OperationalInsights/workspaces/query/AzureActivity/read"
  ],
```

Чтобы создать роль с доступом только к таблице _SecurityBaseline_ , создайте настраиваемую роль, выполнив следующие действия.

```
"Actions":  [
    "Microsoft.OperationalInsights/workspaces/read",
    "Microsoft.OperationalInsights/workspaces/query/read",
    "Microsoft.OperationalInsights/workspaces/query/SecurityBaseline/read"
],
```
В приведенных выше примерах определяется список разрешенных таблиц. В этом примере показано блокированное определение списка, когда пользователь может получить доступ ко всем таблицам, но таблице _секуритялерт_ :

```
"Actions":  [
    "Microsoft.OperationalInsights/workspaces/read",
    "Microsoft.OperationalInsights/workspaces/query/read",
    "Microsoft.OperationalInsights/workspaces/query/*/read"
],
"notActions":  [
    "Microsoft.OperationalInsights/workspaces/query/SecurityAlert/read"
],
```

### <a name="custom-logs"></a>Пользовательские журналы

 Пользовательские журналы создаются из источников данных, таких как пользовательские журналы и API сборщика данных HTTP. Самый простой способ узнать тип журнала — проверить таблицы, перечисленные в разделе [пользовательские журналы в схеме журнала](../log-query/log-analytics-tutorial.md#table-schema).

 Вы не можете предоставить доступ к отдельным пользовательским журналам, но можете предоставить доступ ко всем настраиваемым журналам. Чтобы создать роль с доступом ко всем настраиваемым журналам, создайте настраиваемую роль, выполнив следующие действия.

```
"Actions":  [
    "Microsoft.OperationalInsights/workspaces/read",
    "Microsoft.OperationalInsights/workspaces/query/read",
    "Microsoft.OperationalInsights/workspaces/query/Tables.Custom/read"
],
```
Альтернативный подход к управлению доступом к настраиваемым журналам — назначение им ресурса Azure и управление доступом с помощью парадигмы контекста ресурсов. Чтобы использовать этот метод, необходимо включить идентификатор ресурса, указав его в заголовке [x-MS-азурересаурцеид](../logs/data-collector-api.md#request-headers) , когда данные принимаются для log Analytics через [API сборщика данных HTTP](../logs/data-collector-api.md). Идентификатор ресурса должен быть допустимым и иметь примененные к нему правила доступа. После приема журналов они становятся доступными для доступа на чтение к ресурсу, как описано здесь.

Иногда пользовательские журналы берутся из источников, которые не связаны напрямую с конкретным ресурсом. В этом случае создайте группу ресурсов только для управления доступом к этим журналам. Группа ресурсов не несет никаких затрат, но предоставляет допустимый идентификатор ресурса для управления доступом к пользовательским журналам. Например, если конкретный брандмауэр отправляет пользовательские журналы, создайте группу ресурсов с именем "Мифиревалллогс" и убедитесь, что запросы API содержат идентификатор ресурса "Мифиревалллогс". Затем записи журнала брандмауэра доступны только пользователям, которым был предоставлен доступ к Мифиревалллогс или к ним с полным доступом к рабочей области.          

### <a name="considerations"></a>Рекомендации

* Если пользователю предоставлено глобальное разрешение на чтение со стандартной ролью читателя или участника, включающим действие _\* /Реад_ , он переопределит управление доступом на уровне таблицы и предоставит им доступ ко всем данным журнала.
* Если пользователю предоставлен доступ к таблице, но нет других разрешений, он сможет получить доступ к данным журнала из API, но не из портал Azure. Чтобы предоставить доступ из портал Azure, используйте модуль чтения Log Analytics в качестве своей базовой роли.
* Администраторы и владельцы подписки будут иметь доступ ко всем типам данных независимо от других параметров разрешений.
* Владельцы рабочих областей рассматриваются как другие пользователи для управления доступом на основе таблиц.
* Рекомендуется назначать роли группам безопасности, а не отдельным пользователям, чтобы сократить количество назначений. Это также позволит использовать существующие средства управления группами для настройки и проверки доступа.

## <a name="next-steps"></a>Дальнейшие шаги

* Сведения о сборе данных с компьютеров в центре обработки данных или в другой облачной среде см в статье об [агенте Log Analytics](../agents/log-analytics-agent.md).

* Сведения о настройке сбора данных из виртуальных машин Azure см. в статье [сбор данных о виртуальных машинах Azure](../learn/quick-collect-azurevm.md) .