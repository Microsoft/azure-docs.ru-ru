---
title: Аудит запросов в Azure Monitor запросов журналов
description: Сведения журналов аудита запросов журнала, которые предоставляют данные телеметрии о выполнении запросов журнала в Azure Monitor.
ms.topic: conceptual
author: bwren
ms.author: bwren
ms.date: 09/03/2020
ms.openlocfilehash: 28dfac7de8e73adf577b0a13e5fbd8740b1e3b06
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "102047423"
---
# <a name="audit-queries-in-azure-monitor-logs-preview"></a>Аудит запросов в журналах Azure Monitor (Предварительная версия)
Журналы аудита запросов предоставляют данные телеметрии о выполнении запросов журнала в Azure Monitor. Сюда входят такие сведения, как время выполнения запроса, его выполнение, использование инструмента, текст запроса и статистика производительности, описывающая выполнение запроса.


## <a name="configure-query-auditing"></a>Настройка аудита запросов
Аудит запросов включается с [параметром диагностики](../essentials/diagnostic-settings.md) в рабочей области log Analytics. Это позволяет отправить данные аудита в текущую рабочую область или любую другую рабочую область в подписке, в концентраторы событий Azure для отправки за пределы Azure или в службу хранилища Azure для архивации. 

### <a name="azure-portal"></a>Портал Azure
Получите доступ к параметру диагностики для Log Analytics рабочей области в портал Azure в любом из следующих расположений:

- В меню **Azure Monitor** выберите **параметры диагностики**, а затем найдите и выберите рабочую область.

    [![Azure Monitor ](media/query-audit/diagnostic-setting-monitor.png) параметров диагностики ](media/query-audit/diagnostic-setting-monitor.png#lightbox) 

- В меню **log Analytics рабочие области** выберите рабочую область, а затем выберите **параметры диагностики**.

    [![Параметры диагностики Log Analytics рабочей области ](media/query-audit/diagnostic-setting-workspace.png)](media/query-audit/diagnostic-setting-workspace.png#lightbox) 

### <a name="resource-manager-template"></a>Шаблон Resource Manager
Пример диспетчер ресурсов шаблона можно получить из [параметра диагностики для log Analytics рабочей области](../essentials/resource-manager-diagnostic-settings.md#diagnostic-setting-for-log-analytics-workspace).

## <a name="audit-data"></a>Данные аудита
Запись аудита создается каждый раз при выполнении запроса. Если данные отправляются в рабочую область Log Analytics, они хранятся в таблице с именем *лакуерилогс*. В следующей таблице описаны свойства каждой записи данных аудита.

| Поле | Описание |
|:---|:---|
| TimeGenerated         | Время отправки запроса в формате UTC. |
| CorrelationId         | Уникальный идентификатор для идентификации запроса. Может использоваться в сценариях устранения неполадок при обращении в корпорацию Майкрософт за помощью. |
| AADObjectId           | Azure Active Directory идентификатор учетной записи пользователя, запустившего запрос.  |
| AADTenantId           | Идентификатор клиента учетной записи пользователя, запустившего запрос.  |
| аадемаил              | Электронная почта клиента учетной записи пользователя, запустившего запрос.  |
| аадклиентид           | ИДЕНТИФИКАТОР и разрешенное имя приложения, используемого для запуска запроса. |
| рекуестклиентапп      | Разрешенное имя приложения, используемое для запуска запроса. |
| куеритимеранжестарт   | Начало диапазона времени, выбранного для запроса. Это может быть не заполнено в определенных сценариях, например при запуске запроса с Log Analytics, а диапазон времени указывается в запросе, а не в средстве выбора времени. |
| куеритимеранжеенд     | Конец диапазона времени, выбранного для запроса. Это может быть не заполнено в определенных сценариях, например при запуске запроса с Log Analytics, а диапазон времени указывается в запросе, а не в средстве выбора времени.  |
| QueryText             | Текст запроса, который был запущен. |
| рекуесттаржет         | URL-адрес API был использован для отправки запроса.  |
| RequestContext        | Список ресурсов, для которых был запрошен запрос. Содержит до трех массивов строк: рабочих областей, приложений и ресурсов. Подписка или группа ресурсов. целевые запросы будут отображаться как *ресурсы*. Включает целевой объект, подразумеваемый Рекуесттаржет.<br>Идентификатор ресурса для каждого ресурса будет добавлен, если его можно разрешить. Возможно, он не удастся разрешить, если в доступе к ресурсу возвращается ошибка. В этом случае будет использоваться конкретный текст из запроса.<br>Если в запросе используется неоднозначное имя, например имя рабочей области, существующее в нескольких подписках, будет использоваться это неоднозначное имя. |
| рекуестконтекстфилтерс | Набор фильтров, заданных как часть вызова запроса. Включает до трех возможных массивов строк:<br>-Ресаурцетипес — тип ресурса, ограничивающий область запроса.<br>-Workspaces — список рабочих областей, для которых необходимо ограничить запрос.<br>-Воркспацерегионс — список регионов рабочей области для ограничения запроса. |
| ResponseCode          | Код ответа HTTP, возвращаемый при отправке запроса. |
| респонседуратионмс    | Время возврата ответа.  |
| респонсеровкаунт     | Общее число строк, возвращаемых запросом. |
| статскпутимемс       | Общее время вычислений, используемое для вычисления, анализа и выборки данных. Заполняется, только если запрос возвращает код состояния 200. |
| статсдатапроцесседкб | Объем данных, к которым осуществлялся доступ для обработки запроса. Зависит от размера целевой таблицы, используемого диапазона времени, примененных фильтров и количества столбцов, на которые имеются ссылки. Заполняется, только если запрос возвращает код состояния 200. |
| статсдатапроцесседстарт | Время самых старых данных, к которым осуществлялся доступ для обработки запроса. На это влияет запрос на явное время и применение фильтров. Это может быть больше, чем явный период времени из-за секционирования данных. Заполняется, только если запрос возвращает код состояния 200. |
| статсдатапроцесседенд  |Время новых данных, к которым осуществлялся доступ для обработки запроса. На это влияет запрос на явное время и применение фильтров. Это может быть больше, чем явный период времени из-за секционирования данных. Заполняется, только если запрос возвращает код состояния 200. |
| статсворкспацекаунт | Число рабочих областей, к которым обращается запрос. Заполняется, только если запрос возвращает код состояния 200. |
| статсрегионкаунт | Число регионов, к которым обращается запрос. Заполняется, только если запрос возвращает код состояния 200. |

## <a name="considerations"></a>Рекомендации

- Запросы регистрируются только при выполнении в контексте пользователя. Служба в Azure не будет зарегистрирована. Два основных набора запросов, которые включает это исключение, — это расчеты счетов и автоматические предупреждения. В случае с предупреждениями только сам плановый запрос на оповещение не будет регистрироваться. начальное выполнение предупреждения на экране создания предупреждения выполняется в контексте пользователя и будет доступно для целей аудита. 
- Статистика производительности недоступна для запросов, поступающих от прокси-сервера Azure обозреватель данных. Все остальные данные для этих запросов будут по-прежнему заполнены.
- Указание *h* для строк, которые [закрывают строковые литералы](/azure/data-explorer/kusto/query/scalar-data-types/string#obfuscated-string-literals) , не влияет на журналы аудита запросов. Запросы будут собираться точно так же, как и отправленные, без маскировки строки. Необходимо убедиться, что только пользователи с правами на соответствие для просмотра этих данных могут сделать это с помощью различных режимов Kubernetes RBAC или Azure RBAC, доступных в Log Analytics рабочих областях.
- Для запросов, которые содержат данные из нескольких рабочих областей, запрос будет отслеживаться только в тех рабочих областях, к которым у пользователя есть доступ.

## <a name="costs"></a>Затраты  
Плата за расширение "Диагностика Azure" не взимается, но, возможно, вам придется оплатить получение данных. На странице [Цены на Azure Monitor](https://azure.microsoft.com/pricing/details/monitor/) указаны назначения для сбора данных.

## <a name="next-steps"></a>Следующие шаги

- Дополнительные сведения о [параметрах диагностики](../essentials/diagnostic-settings.md).
- Дополнительные сведения об [оптимизации запросов журналов](query-optimization.md).
