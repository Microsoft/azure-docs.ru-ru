---
title: Общие сведения о миграции для Azure Monitor оповещений
description: Узнайте, как работает миграция оповещений и устранение неполадок.
ms.topic: conceptual
ms.date: 02/14/2021
ms.author: yalavi
author: yalavi
ms.subservice: alerts
ms.openlocfilehash: fdac8015cf87ffa0a25a8558668329a8cd82327f
ms.sourcegitcommit: c27a20b278f2ac758447418ea4c8c61e27927d6a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/03/2021
ms.locfileid: "101737194"
---
# <a name="understand-migration-options-to-newer-alerts"></a>Общие сведения о вариантах миграции для новых оповещений

Классические оповещения выпускают [для пользователей](./monitoring-classic-retirement.md) общедоступных облаков, но в ограниченном объеме использования до **31 мая 2021**. Классические оповещения для облачных служб Azure для государственных организаций и Azure для Китая, истечение **29 февраля 2024**.

В этой статье объясняется, как работает средство миграции вручную и Добровольная миграция, которые будут использоваться для переноса оставшихся правил генерации оповещений. Здесь также описываются решения некоторых распространенных проблем.

> [!IMPORTANT]
> Миграция не влияет на оповещения журнала действий (включая оповещения о работоспособности службы) и оповещения журнала. Миграция применяется только к классическим правилам генерации оповещений, описанным [здесь](./monitoring-classic-retirement.md#retirement-of-classic-monitoring-and-alerting-platform).

> [!NOTE]
> Если классические правила генерации оповещений недопустимы, т. е. они находятся в [нерекомендуемых метриках](#classic-alert-rules-on-deprecated-metrics) или ресурсах, которые были удалены, они не будут перенесены и станут недоступны после прекращения использования службы.

## <a name="manually-migrating-classic-alerts-to-newer-alerts"></a>Ручная миграция классических оповещений в новые предупреждения

Клиенты, заинтересованные в ручном переносе своих оставшихся оповещений, уже могут сделать это с помощью следующих разделов. Он также включает устаревшие метрики, которые не могут быть перенесены напрямую.

### <a name="guest-metrics-on-virtual-machines"></a>Метрики гостя на виртуальных машинах

Прежде чем создавать новые оповещения метрики для гостевых метрик, необходимо отправить метрики гостя в хранилище журналов Azure Monitor. Чтобы создать оповещения, выполните следующие инструкции:

- [Включение сбора гостевых метрик в log Analytics](../agents/agent-data-sources.md)
- [Создание оповещений журнала в Azure Monitor](./alerts-log.md)

Дополнительные параметры для сбора метрик гостевого компьютера и оповещения о них см. в этой [статье](../agents/agents-overview.md).

### <a name="storage-and-classic-storage-account-metrics"></a>Метрики хранилища и классических учетных записей хранения

Все классические оповещения в учетных записях хранения можно перенести, за исключением предупреждений по этим метрикам:

- PercentAuthorizationError
- PercentClientOtherError
- PercentNetworkError
- PercentServerOtherError
- PercentSuccess
- PercentThrottlingError
- PercentTimeoutError
- AnonymousThrottlingError
- SASThrottlingError
- ThrottlingError

Классические правила генерации оповещений для метрик процента должны быть перенесены на основе [сопоставления старых и новых метрик хранилища](../../storage/common/storage-metrics-migration.md#metrics-mapping-between-old-metrics-and-new-metrics). Необходимо соответствующим образом изменить пороговые значения, так как новая метрика станет абсолютной.

Классические правила генерации оповещений для Анонимауссроттлинжеррор, Сассроттлинжеррор и Сроттлинжеррор должны быть разделены на два новых оповещения, поскольку не существует Объединенных метрик, предоставляющая те же функциональные возможности. Пороговые значения потребуется адаптировать соответствующим образом.

### <a name="cosmos-db-metrics"></a>Метрики Cosmos DB

Все классические оповещения о метриках Cosmos DB можно перенести, за исключением предупреждений по этим метрикам:

- Среднее число запросов в секунду
- Уровень согласованности
- HTTP 2xx
- HTTP 3xx:
- Максимальное количество использованных РУПМ в минуту
- Максимальное число получателей в секунду
- Mongo другая плата за запросы
- Mongo другая частота запросов
- Наблюдаемая задержка чтения
- Наблюдаемая задержка записи
- Доступность службы
- Емкость хранилища

Среднее число запросов в секунду, уровень согласованности, максимальное число РУПМ, потребляемых в минуту, Макс. в секунду, наблюдаемая задержка чтения, задержка записи, а также емкость хранилища сейчас недоступны в [новой системе](../essentials/metrics-supported.md#microsoftdocumentdbdatabaseaccounts).

Оповещения о метриках запросов, таких как HTTP 2xx, HTTP 3xx и доступность службы, не переносятся, так как запросы между классическими метриками и новыми метриками различны. Оповещения на основе этих метрик потребуется вручную создать повторно с скорректированными пороговыми значениями.

### <a name="classic-alert-rules-on-deprecated-metrics"></a>Классические правила генерации оповещений на устаревших метриках

Ниже приведены классические правила генерации оповещений о метриках, которые ранее поддерживались, но в конечном итоге являются устаревшими. Небольшой процент от клиента может иметь недопустимые классические правила генерации оповещений для таких метрик. Так как эти правила оповещений являются недопустимыми, они не будут перенесены.

| Тип ресурса| Устаревшие метрики |
|-------------|----------------- |
| Microsoft.DBforMySQL/servers | compute_consumption_percent, compute_limit |
| Microsoft.DBforPostgreSQL/servers | compute_consumption_percent, compute_limit |
| Microsoft.Network/publicIPAddresses | дефаултддостригжеррате |
| Microsoft.SQL/servers/databases | service_level_objective, storage_limit, storage_used, регулирование, dtu_consumption_percent, storage_used |
| Microsoft. Web/hostingEnvironments/мултиролепулс | аверажемемориворкингсет |
| Microsoft. Web/hostingEnvironments/внешнего размещения | битесрецеивед, хттпкуеуеленгс |

## <a name="how-equivalent-new-alert-rules-and-action-groups-are-created"></a>Как создаются эквивалентные новые правила генерации оповещений и группы действий

Средство миграции преобразует классические правила генерации оповещений в эквивалентные новые правила генерации оповещений и группы действий. Для большинства классических правил генерации оповещений эквивалентные новые правила генерации оповещений находятся в одной и той же метрике с такими же свойствами, как `windowSize` и `aggregationType` . Однако некоторые классические правила генерации оповещений относятся к метрикам, имеющим разные эквивалентные метрики в новой системе. Следующие принципы применяются к переносу классических оповещений, если они не указаны в разделе ниже.

- **Frequency**: определяет, как часто будет проверяться наличие в классическом или новом правиле генерации оповещений для условия. `frequency`В классических правилах оповещений не было настроено пользователем и всегда было 5 минут для всех типов ресурсов. Частота эквивалентных правил также равна 5 минутам.
- **Тип статистической обработки**: определяет, как Статистическая обработка метрики осуществляется по интересующему окну. `aggregationType`Кроме того, между классическими предупреждениями и новыми оповещениями для большинства метрик. В некоторых случаях, поскольку метрика отличается между классическими предупреждениями и новыми оповещениями, `aggregationType` используется эквивалент или, `primary Aggregation Type` определенный для метрики.
- **Units**: свойство метрики, для которой создается оповещение. Некоторые эквивалентные метрики имеют разные единицы измерения. При необходимости пороговое значение корректируется соответствующим образом. Например, если исходная метрика содержит секунды как единицы, но эквивалентная новая метрика имеет миллисекунды как единицы, то исходное пороговое значение умножается на 1000 для обеспечения того же поведения.
- **Размер окна**: определяет окно, по которому объединяются данные метрики для сравнения с пороговым значением. Для стандартных `windowSize` значений, таких как 5 минут, 15 минут, 30 минут, 1 час, 3 часа, 6 часов, 12 часов, 1 день, нет изменений, внесенных в эквивалентное новое правило генерации оповещений. Для других значений используется ближайшее к нему значение `windowSize` . Большинство клиентов не влияют на это изменение. Для небольшого количества клиентов может потребоваться настроить пороговое значение, чтобы добиться точно такого же поведения.

В следующих разделах мы подробно рассмотрим метрики, имеющие другую эквивалентную метрику в новой системе. Все метрики, которые остаются неизменными для классических и новые правила генерации оповещений, не указаны. Список метрик, поддерживаемых в новой системе, можно найти [здесь](../essentials/metrics-supported.md).

### <a name="microsoftstoragestorageaccounts-and-microsoftclassicstoragestorageaccounts"></a>Microsoft. Storage/storageAccounts и Microsoft. Классикстораже/storageAccounts

Для служб учетных записей хранения, таких как BLOB-объекты, таблицы, файлы и очереди, следующие метрики сопоставляются с эквивалентными метриками, как показано ниже.

| Метрика в классических оповещениях | Эквивалентная метрика в новых предупреждениях | Комментарии|
|--------------------------|---------------------------------|---------|
| AnonymousAuthorizationError| Метрика транзакций с измерениями «ResponseType» = «AuthorizationError» и «Authentication» = «Anonymous»| |
| AnonymousClientOtherError | Метрика транзакций с измерениями «ResponseType» = «Клиентосереррор» и «Authentication» = «Anonymous» | |
| анонимаусклиенттимеаутеррор| Метрика транзакций с измерениями «ResponseType» = «ClientTimeOutError» и «Authentication» = «Anonymous» | |
| AnonymousNetworkError | Метрика транзакций с измерениями «ResponseType» = «NetworkError» и «Authentication» = «Anonymous» | |
| AnonymousServerOtherError | Метрика транзакций с измерениями «ResponseType» = «Серверосереррор» и «Authentication» = «Anonymous» | |
| анонимауссервертимеаутеррор | Метрика транзакций с измерениями «ResponseType» = «ServerTimeOutError» и «Authentication» = «Anonymous» | |
| AnonymousSuccess | Метрика транзакций с измерениями «ResponseType» = «Success» и «Authentication» = «Anonymous» | |
| AuthorizationError | Метрика транзакций с измерениями "ResponseType" = "AuthorizationError" | |
| AverageE2ELatency | SuccessE2ELatency | |
| AverageServerLatency | SuccessServerLatency | |
| Capacity | BlobCapacity | Используйте `aggregationType` "Average" вместо "Last". Метрика применяется только к службам BLOB-объектов |
| ClientOtherError | Метрика транзакций с измерениями "ResponseType" = "Клиентосереррор"  | |
| ClientTimeoutError | Метрика транзакций с измерениями "ResponseType" = "ClientTimeOutError" | |
| ContainerCount | ContainerCount | Используйте `aggregationType` "Average" вместо "Last". Метрика применяется только к службам BLOB-объектов |
| NetworkError | Метрика транзакций с измерениями "ResponseType" = "NetworkError" | |
| ObjectCount | BlobCount| Используйте `aggregationType` "Average" вместо "Last". Метрика применяется только к службам BLOB-объектов |
| SASAuthorizationError | Метрика транзакций с измерениями "ResponseType" = "AuthorizationError" и "Authentication" = "SAS" | |
| SASClientOtherError | Метрика транзакций с измерениями "ResponseType" = "Клиентосереррор" и "Authentication" = "SAS" | |
| сасклиенттимеаутеррор | Метрика транзакций с измерениями "ResponseType" = "ClientTimeOutError" и "Authentication" = "SAS" | |
| SASNetworkError | Метрика транзакций с измерениями "ResponseType" = "NetworkError" и "Authentication" = "SAS" | |
| SASServerOtherError | Метрика транзакций с измерениями "ResponseType" = "Серверосереррор" и "Authentication" = "SAS" | |
| сассервертимеаутеррор | Метрика транзакций с измерениями "ResponseType" = "ServerTimeOutError" и "Authentication" = "SAS" | |
| SASSuccess | Метрика транзакций с измерениями "ResponseType" = "Success" и "Authentication" = "SAS" | |
| ServerOtherError | Метрика транзакций с измерениями "ResponseType" = "Серверосереррор" | |
| ServerTimeOutError | Метрика транзакций с измерениями "ResponseType" = "ServerTimeOutError"  | |
| Успешное завершение | Метрика транзакций с измерениями "ResponseType" = "Success" | |
| TotalBillableRequests| Transactions | |
| TotalEgress | Исходящие | |
| TotalIngress | Входящий трафик | |
| TotalRequests | Transactions | |

### <a name="microsoftdocumentdbdatabaseaccounts"></a>Microsoft.DocumentDB/databaseAccounts

Для Cosmos DB эквивалентными метриками могут быть, как показано ниже:

| Метрика в классических оповещениях | Эквивалентная метрика в новых предупреждениях | Комментарии|
|--------------------------|---------------------------------|---------|
| AvailableStorage | AvailableStorage||
| Размер данных | DataUsage| |
| Число документов | DocumentCount||
| Размер индексов | IndexUsage||
| Служба недоступна | ServiceAvailability||
| TotalRequestUnits | TotalRequestUnits||
| Регулируемые запросы | TotalRequests с измерением "StatusCode" = "429"| Тип агрегата "Average" исправлен на "Count"|
| Внутренние ошибки сервера | TotalRequests с измерением "StatusCode" = "500"}| Тип агрегата "Average" исправлен на "Count"|
| HTTP 401: | TotalRequests с измерением "StatusCode" = "401"| Тип агрегата "Average" исправлен на "Count"|
| HTTP 400 | TotalRequests с измерением "StatusCode" = "400"| Тип агрегата "Average" исправлен на "Count"|
| Общее количество запросов | TotalRequests| Тип агрегата "Max" исправлен на "Count"|
| Плата за Mongo число запросов| Монгорекуестчарже с измерением "CommandName" = "Count"||
| Частота запросов Mongo Count | Монгорекуестскаунт с измерением "CommandName" = "Count"||
| Плата за запрос на удаление Mongo | Монгорекуестчарже с измерением "CommandName" = "Delete"||
| Частота запросов Mongo на удаление | Монгорекуестскаунт с измерением "CommandName" = "Delete"||
| Плата за запрос вставки Mongo | Монгорекуестчарже с измерением "CommandName" = "Insert"||
| Частота запросов Mongo на вставку | Монгорекуестскаунт с измерением "CommandName" = "Insert"||
| Плата за запрос Mongo запросов | Монгорекуестчарже с измерением "CommandName" = "Find"||
| Частота запросов Mongo на чтение | Монгорекуестскаунт с измерением "CommandName" = "Find"||
| Плата за запрос на обновление Mongo | Монгорекуестчарже с измерением "CommandName" = "Update"||
| Mongo неудачных запросов вставки | Монгорекуесткаунт с измерениями "CommandName" = "Insert" и "Status" = "Failed"| Тип агрегата "Average" исправлен на "Count"|
| Запросы с ошибками запросов Mongo | Монгорекуесткаунт с измерениями "CommandName" = "Query" и "Status" = "Failed"| Тип агрегата "Average" исправлен на "Count"|
| Количество неудачных запросов Mongo | Монгорекуесткаунт с измерениями "CommandName" = "Count" и "Status" = "Failed"| Тип агрегата "Average" исправлен на "Count"|
| Неудачных запросов на обновление Mongo | Монгорекуесткаунт с измерениями "CommandName" = "Update" и "Status" = "Failed"| Тип агрегата "Average" исправлен на "Count"|
| Mongo другие неудачные запросы | Монгорекуесткаунт с измерениями "CommandName" = "Other" и "Status" = "Failed"| Тип агрегата "Average" исправлен на "Count"|
| Mongo неудачные запросы на удаление | Монгорекуесткаунт с измерениями "CommandName" = "Delete" и "Status" = "Failed"| Тип агрегата "Average" исправлен на "Count"|

### <a name="how-equivalent-action-groups-are-created"></a>Как создаются эквивалентные группы действий

Классические правила генерации оповещений имеют электронное письмо, веб-перехватчик, приложение логики и действия Runbook, привязанные к самому правилу оповещения. Новые правила генерации оповещений используют группы действий, которые можно повторно использовать в нескольких правилах генерации оповещений. Средство миграции создает одну группу действий для одних и тех же действий независимо от того, сколько правил генерации оповещений использует действие. Группы действий, созданные средством миграции, используют формат именования "Migrated_AG *".

> [!NOTE]
> Классические оповещения отправляли локализованные сообщения электронной почты на основе локали классического администратора при использовании для уведомления ролей классического администратора. Новые сообщения электронной почты с оповещениями отправляются через группы действий и доступны только на английском языке.

## <a name="rollout-phases"></a>Этапы выпуска

Средство миграции выполняется поэтапно для клиентов, использующих классические правила генерации оповещений. Владельцы подписки получат сообщение электронной почты, когда подписка будет готова к миграции с помощью средства.

> [!NOTE]
> Так как средство выходит за этапы, вы можете заметить, что некоторые подписки еще не готовы к переносу на ранних этапах.

Большинство подписок в настоящий момент помечены как готовые к миграции. Все подписки с классическими оповещениями для следующих типов ресурсов все еще не готовы к миграции.

- Microsoft. classicCompute/имя_домена/слоты/роли
- Microsoft. Insights/компоненты

## <a name="who-can-trigger-the-migration"></a>Кто может активировать миграцию?

Любой пользователь, имеющий встроенную роль участника мониторинга на уровне подписки, может запустить миграцию. Пользователи, имеющие пользовательскую роль со следующими разрешениями, также могут активировать миграцию:

- */чтение
- Microsoft.Insights/actiongroups/*
- Microsoft.Insights/AlertRules/*
- Microsoft.Insights/metricAlerts/*
- Microsoft.AlertsManagement/smartDetectorAlertRules/*

> [!NOTE]
> Кроме указанных выше разрешений, подписка должна быть дополнительно зарегистрирована в поставщике ресурсов Microsoft. Алертсманажемент. Это необходимо для успешной миграции предупреждений об аномалиях сбоя на Application Insights. 

## <a name="common-problems-and-remedies"></a>Распространенные проблемы и способы их устранения

После [активации миграции](alerts-using-migration-tool.md)вы получите электронное сообщение по указанным адресам, чтобы уведомить вас о завершении миграции или о необходимости каких-либо действий. В этом разделе описаны некоторые распространенные проблемы и способы их решения.

### <a name="validation-failed"></a>Проверка завершена с ошибкой

Из-за последних изменений в классических правилах генерации оповещений в подписке невозможно перенести подписку. Эта проблема является временной. Вы можете перезапустить миграцию после того, как миграция перейдет в состояние **готовности к миграции** через несколько дней.

### <a name="scope-lock-preventing-us-from-migrating-your-rules"></a>Блокировка области не позволила перенести правила

В рамках миграции будут созданы новые оповещения о метриках и новые группы действий, а затем классические правила генерации оповещений будут удалены. Однако блокировка области может препятствовать созданию и удалению ресурсов. В зависимости от блокировки области некоторые или все правила не удалось перенести. Эту проблему можно устранить, удалив блокировку области для подписки, группы ресурсов или ресурса, которая указана в [средстве миграции](https://portal.azure.com/#blade/Microsoft_Azure_Monitoring/MigrationBladeViewModel), и снова запустите миграцию. Блокировка области не может быть отключена и должна быть удалена в процессе миграции. Дополнительные [сведения об управлении блокировками областей](../../azure-resource-manager/management/lock-resources.md#portal).

### <a name="policy-with-deny-effect-preventing-us-from-migrating-your-rules"></a>Политика с результатом "deny" не позволила перенести ваши правила

В рамках миграции будут созданы новые оповещения о метриках и новые группы действий, а затем классические правила генерации оповещений будут удалены. Однако назначение [политики Azure](../../governance/policy/index.yml) может не позволить нам создавать ресурсы. В зависимости от назначения политики не удалось перенести некоторые или все правила. Назначения политики, блокирующие процесс, перечислены в [средстве миграции](https://portal.azure.com/#blade/Microsoft_Azure_Monitoring/MigrationBladeViewModel). Устраните эту проблему одним из следующих причин:

- Исключение подписок, групп ресурсов или отдельных ресурсов во время процесса миграции из назначения политики. Дополнительные [сведения об управлении областями исключения политики](../../governance/policy/tutorials/create-and-manage.md#remove-a-non-compliant-or-denied-resource-from-the-scope-with-an-exclusion).
- Установите для параметра "режим принудительного применения" значение **отключено** для назначения политики. Дополнительные [сведения о свойстве енфорцементмоде назначения политики](../../governance/policy/concepts/assignment-structure.md#enforcement-mode).
- Настройте исключение политики Azure (Предварительная версия) для подписок, групп ресурсов или отдельных ресурсов для назначения политики. Дополнительные [сведения о структуре исключения в политике Azure](../../governance/policy/concepts/exemption-structure.md).
- Удаление или изменение влияния на "Disabled", "Audit", "Append" или "Modify" (например, может решить проблемы, связанные с отсутствующими тегами). Дополнительные [сведения об управлении эффектами политики](../../governance/policy/concepts/definition-structure.md#policy-rule).

## <a name="next-steps"></a>Дальнейшие действия

- [Как использовать средство миграции](alerts-using-migration-tool.md)
- [Подготовка к переносу](alerts-prepare-migration.md)