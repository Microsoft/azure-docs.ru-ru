---
title: Правила действий для оповещений Azure Monitor
description: Общие сведения о правилах действий в Azure Monitor и настройке их и управлении ими.
ms.topic: conceptual
ms.date: 04/25/2019
ms.subservice: alerts
ms.openlocfilehash: 1a837ac9aa94effa021d5395fb4856d1d5df2e90
ms.sourcegitcommit: c27a20b278f2ac758447418ea4c8c61e27927d6a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/03/2021
ms.locfileid: "101718154"
---
# <a name="action-rules-preview"></a>Правила действий (Предварительная версия)

Правила действий помогают определить или отключить действия в любой области Azure Resource Manager (подписка Azure, Группа ресурсов или целевой ресурс). Они имеют различные фильтры, помогающие сократить конкретное подмножество экземпляров предупреждений, с которыми вы хотите работать.

> [!VIDEO https://www.microsoft.com/en-us/videoplayer/embed/RE4rBZ2]

## <a name="why-and-when-should-you-use-action-rules"></a>Зачем и когда следует использовать правила действий?

### <a name="suppression-of-alerts"></a>Подавление предупреждений

Существует множество сценариев, в которых полезно подавлять уведомления, создаваемые предупреждениями. Эти сценарии заключаются в диапазоне от подавления во время планового периода обслуживания до подавления в нерабочее время. Например, группа, ответственная за  **ContosoVM** , хочет отключить уведомления об оповещениях на ближайшие выходные дни, так как **ContosoVM** выполняет плановое обслуживание.

Несмотря на то, что группа может отключить каждое правило генерации оповещений, настроенное на **ContosoVM** вручную (и включить его снова после обслуживания), это не просто процесс. Правила действий помогают определить подавление предупреждений в масштабе с возможностью гибкой настройки периода подавления. В предыдущем примере группа может определить одно правило действия в **ContosoVM** , которое подавляет все уведомления о предупреждениях в выходные дни.

### <a name="actions-at-scale"></a>Действия в масштабе

Несмотря на то, что правила генерации оповещений помогают определить группу действий, которая активируется при создании оповещения, клиенты часто имеют общую группу действий в области операций. Например, группа, ответственная за группу ресурсов **ContosoRG** , скорее всего, определит ту же группу действий для всех правил генерации оповещений, определенных в **ContosoRG**.

Правила действий позволяют упростить этот процесс. Определяя действия в масштабе, можно активировать группу действий для любого оповещения, созданного в настроенной области. В предыдущем примере команда может определить одно правило действия на **ContosoRG** , которое будет запускать одну и ту же группу действий для всех созданных в ней предупреждений.

> [!NOTE]
> Правила действий в настоящее время не применяются к оповещениям о работоспособности служб Azure.

## <a name="configuring-an-action-rule"></a>Настройка правила действия

### <a name="portal"></a>[Портал](#tab/portal)

Чтобы получить доступ к функции, выберите **Управление действиями** на странице " **оповещения** " в Azure Monitor. Затем выберите **правила действий (Предварительная версия)**. Чтобы получить доступ к правилам, выберите **правила действий (Предварительная версия)** на панели мониторинга целевой страницы для оповещений.

![Правила действий с целевой страницы Azure Monitor](media/alerts-action-rules/action-rules-landing-page.png)

Выберите **+ новое правило действия**.

![На снимке экрана показана страница "Управление действиями" с выделенной кнопкой "новое правило действия".](media/alerts-action-rules/action-rules-new-rule.png)

Кроме того, можно создать правило действия во время настройки правила генерации оповещений.

![На снимке экрана показана страница Создание правила с выделенной кнопкой Создать правило действия.](media/alerts-action-rules/action-rules-alert-rule.png)

Теперь должна отобразиться страница Flow для создания правил действий. Настройте следующие элементы:

![Последовательность создания нового правила действий](media/alerts-action-rules/action-rules-new-rule-creation-flow.png)

### <a name="scope"></a>Область

Сначала выберите область (подписка Azure, Группа ресурсов или целевой ресурс). Можно также выбрать несколько областей в одной подписке.

![Область действия правила](media/alerts-action-rules/action-rules-new-rule-creation-flow-scope.png)

### <a name="filter-criteria"></a>Критерии фильтра

Кроме того, можно определить фильтры, чтобы сократить их до определенного подмножества предупреждений.

Доступны следующие фильтры:

* **Серьезность**: возможность выбора одного или нескольких серьезности оповещений. **Severity = Sev1** означает, что правило действия применимо ко всем предупреждениям, установленным в Sev1.
* **Мониторинг службы**: фильтр, основанный на исходной службе мониторинга. Этот фильтр также является множественным выделением. Например, **Monitor Service = "Application Insights"** означает, что правило действия применимо ко всем оповещениям на основе Application Insights.
* **Тип ресурса**: фильтр, основанный на определенном типе ресурсов. Этот фильтр также является множественным выделением. Например, **тип ресурса = "виртуальные машины"** означает, что правило действия применимо ко всем виртуальным машинам.
* **Идентификатор правила генерации** оповещений: параметр фильтрации для конкретных правил генерации оповещений с использованием идентификатора диспетчер ресурсов для правила генерации оповещений.
* **Состояние монитора**: фильтр для экземпляров предупреждений, которые либо **активировали** , либо **разрешаются** в качестве условия монитора.
* **Описание**: сопоставление регулярного выражения (регулярное выражение), которое определяет строковое совпадение с описанием, определенным как часть правила генерации оповещений. Например, **Описание содержит "произ** ." будет соответствовать всем предупреждениям, содержащим строку "произв." в их описаниях.
* **Контекст предупреждения (полезные данные)**: соответствие регулярного выражения, которое определяет строковое совпадение с полями контекста предупреждения полезных данных оповещения. Например, **Контекст предупреждения (полезные данные) содержит "Computer-01"** , который будет соответствовать всем предупреждениям, полезные данные которых содержат строку "Computer-01".

Эти фильтры применяются в сочетании друг с другом. Например, если задать **тип ресурса "= виртуальные машины** и **серьезность" = Sev0**, то будут отфильтрованы все **Sev0** оповещения только для ваших виртуальных машин.

![Фильтры правил действий](media/alerts-action-rules/action-rules-new-rule-creation-flow-filters.png)

### <a name="suppression-or-action-group-configuration"></a>Конфигурация подавления или группы действий

Затем настройте правило действия для поддержки подавления предупреждений или групп действий. Вы не можете выбрать оба варианта. Конфигурация действует для всех экземпляров предупреждений, соответствующих ранее определенной области и фильтрам.

#### <a name="suppression"></a>Подавление

Если выбрано **подавление**, настройте продолжительность подавления действий и уведомлений. Выберите один из следующих параметров.
* **От Now (всегда)**: подавляет все уведомления бессрочно.
* **В запланированное время**: подавляет уведомления в пределах ограниченной длительности.
* **С повторением**: подавляет уведомления о повторяющемся ежедневном, еженедельном или ежемесячном расписании.

![Подавление правил действий](media/alerts-action-rules/action-rules-new-rule-creation-flow-suppression.png)

#### <a name="action-group"></a>Группа действий

Если в переключателе выбран пункт **Группа действий** , добавьте существующую группу действий или создайте новую.

> [!NOTE]
> Можно связать только одну группу действий с правилом действий.

![Добавление или создание нового правила действия путем выбора группы действий](media/alerts-action-rules/action-rules-new-rule-creation-flow-action-group.png)

### <a name="action-rule-details"></a>Сведения о правиле действия

Наконец, настройте следующие сведения для правила действия.
* Имя
* Группа ресурсов, в которой он сохранен
* Описание

### <a name="azure-cli"></a>[Azure CLI](#tab/azure-cli)

Правила действий можно создать с Azure CLI помощью команды [AZ Monitor действие-правило Create](/cli/azure/ext/alertsmanagement/monitor/action-rule#ext-alertsmanagement-az-monitor-action-rule-create) .  `az monitor action-rule`Ссылка — это лишь одна из многих [Azure CLI ссылок для Azure Monitor](/cli/azure/azure-cli-reference-for-monitor).

### <a name="prepare-your-environment"></a>Подготовка среды

1. [Установка Azure CLI](/cli/azure/install-azure-cli)

   При желании можно также использовать Azure Cloud Shell для выполнения действий, описанных в этой статье.  Azure Cloud Shell — это интерактивная оболочка среды, с которой можно работать в браузере.  Запустите Cloud Shell с помощью одного из этих методов:

   - Откройте Cloud Shell, перейдя по ссылке: [https://shell.azure.com](https://shell.azure.com)

   - Нажмите кнопку **Cloud Shell** в строке меню в правом верхнем углу окна [портала Azure](https://portal.azure.com).

1. Войдите.

   Если вы используете локальную установку CLI, выполните вход с помощью команды [AZ login](/cli/azure/reference-index#az-login) .  Выполните аутентификацию, следуя инструкциям в окне терминала.

    ```azurecli
    az login
    ```

1. Установка расширения `alertsmanagement`

   `az monitor action-rule`Команда является экспериментальным расширением основного Azure CLI. Дополнительные сведения о расширениях см. в статье [Использование расширения с Azure CLI](/cli/azure/azure-cli-extensions-overview?).

   ```azurecli
   az extension add --name alertsmanagement
   ```

   Ожидается следующее предупреждение.

   ```output
   The installed extension `alertsmanagement` is experimental and not covered by customer support.  Please use with discretion.
   ```

### <a name="create-action-rules-with-the-azure-cli"></a>Создание правил действий с помощью Azure CLI

Дополнительные сведения о обязательных и необязательных параметрах см. в Azure CLI справочные материалы по команде [AZ Monitor действие — правило Create](/cli/azure/ext/alertsmanagement/monitor/action-rule#ext-alertsmanagement-az-monitor-action-rule-create) .

Создайте правило действия для подавления уведомлений в группе ресурсов.

```azurecli
az monitor action-rule create --resource-group MyResourceGroupName \
                              --name MyNewActionRuleName \
                              --location Global \
                              --status Enabled \
                              --rule-type Suppression \
                              --scope-type ResourceGroup \
                              --scope /subscriptions/0b1f6471-1bf0-4dda-aec3-cb9272f09590/resourceGroups/MyResourceGroupName \
                              --suppression-recurrence-type Always \
                              --alert-context Contains Computer-01 \
                               --monitor-service Equals "Log Analytics"
```

Создайте правило действия, чтобы подавлять уведомления для всех Sev4 оповещений на всех виртуальных машинах в подписке каждый выходной день.

```azurecli
az monitor action-rule create --resource-group MyResourceGroupName \
                              --name MyNewActionRuleName \
                              --location Global \
                              --status Enabled \
                              --rule-type Suppression \
                              --severity Equals Sev4 \
                              --target-resource-type Equals Microsoft.Compute/VirtualMachines \
                              --suppression-recurrence-type Weekly \
                              --suppression-recurrence 0 6 \
                              --suppression-start-date 12/09/2018 \
                              --suppression-end-date 12/18/2018 \
                              --suppression-start-time 06:00:00 \
                              --suppression-end-time 14:00:00

```

* * *

## <a name="example-scenarios"></a>Примеры сценариев

### <a name="scenario-1-suppression-of-alerts-based-on-severity"></a>Сценарий 1. запрет предупреждений на основе серьезности

Contoso хочет отключить уведомления для всех Sev4 оповещений на всех виртуальных машинах в подписке **контососуб** каждый выходной день.

**Решение:** Создайте правило действия с помощью:
* Scope = **контососуб**
* Фильтры
    * Уровень серьезности = **Sev4**
    * Тип ресурса = **виртуальные машины**
* Подавление с установленным повторением по неделям, **Суббота** и **воскресенье**

### <a name="scenario-2-suppression-of-alerts-based-on-alert-context-payload"></a>Сценарий 2. запрет оповещений на основе контекста предупреждения (полезные данные)

Компания Contoso хочет отключить уведомления обо всех предупреждениях журналов, созданных для **компьютера-01** в **контососуб** в течение неограниченного времени, так как он проходит обслуживание.

**Решение:** Создайте правило действия с помощью:
* Scope = **контососуб**
* Фильтры
    * Служба мониторинга = **log Analytics**
    * Контекст предупреждения (полезные данные) содержит **компьютер-01**
* Для подавления задано значение **"сейчас" (всегда)**

### <a name="scenario-3-action-group-defined-at-a-resource-group"></a>Сценарий 3. Группа действий, определенная в группе ресурсов

Компания Contoso определила [оповещение метрики на уровне подписки](./alerts-metric-overview.md#monitoring-at-scale-using-metric-alerts-in-azure-monitor). Но необходимо определить действия, которые запускаются специально для предупреждений, созданных в группе ресурсов **ContosoRG**.

**Решение:** Создайте правило действия с помощью:
* Scope = **ContosoRG**
* Нет фильтров
* Для группы действий задано значение **контосоактионграуп**

> [!NOTE]
> *Группы действий, определенные в правилах действий и правилах генерации оповещений, работают независимо друг от друга без дедупликации.* В описанном выше сценарии, если группа действий определена для правила генерации оповещений, она активируется в сочетании с группой действий, определенной в правиле действия.

## <a name="managing-your-action-rules"></a>Управление правилами действий

### <a name="portal"></a>[Портал](#tab/portal)

Вы можете просматривать правила действий и управлять ими из представления списка:

![Представление списка правил действий](media/alerts-action-rules/action-rules-list-view.png)

Здесь можно включить, отключить или удалить правила действий в масштабе, установив флажок рядом с ним. При выборе правила действия открывается страница его конфигурации. Страница помогает обновить определение правила действия и включить или отключить его.

### <a name="azure-cli"></a>[Azure CLI](#tab/azure-cli)

Вы можете просматривать правила действий и управлять ими с помощью команды [AZ Monitor Action-Rule](/cli/azure/ext/alertsmanagement/monitor) из Azure CLI.

Прежде чем приступать к управлению правилами действий с Azure CLI, подготовьте среду с помощью инструкций, приведенных в разделе [Настройка правила действий](#configuring-an-action-rule).

```azurecli
# List all action rules for a subscription
az monitor action-rule list

# Get details of an action rule
az monitor action-rule show --resource-group MyResourceGroupName --name MyActionRuleName

# Update an action rule.
az monitor action-rule update --resource-group MyResourceGroupName --name MyActionRuleName --status Disabled

# Delete an action rule.
az monitor action-rule delete --resource-group MyResourceGroupName --name MyActionRuleName
```

* * *

## <a name="best-practices"></a>Рекомендации

Оповещения журнала, создаваемые с помощью параметра [Количество результатов](./alerts-unified-log.md) , создают один экземпляр предупреждения, используя весь результат поиска (который может охватывать несколько компьютеров). В этом случае, если правило действия использует фильтр **контекста предупреждения (полезные данные)** , он действует на экземпляр предупреждения, если имеется совпадение. В сценарии 2, описанном выше, если результаты поиска для созданного предупреждения журнала содержат как **Computer-01** , так и **компьютер-02**, все уведомления подавляются. Уведомления, созданные для **компьютера-02** , отсутствуют.

![На схеме показаны правила действий и оповещения журнала с выделенным одним экземпляром предупреждения.](media/alerts-action-rules/action-rules-log-alert-number-of-results.png)

Чтобы лучше использовать оповещения журнала с правилами действий, создайте оповещения журнала с помощью параметра [измерения метрик](./alerts-unified-log.md) . Отдельные экземпляры предупреждений создаются этим параметром на основе определенного поля группы. Затем, в сценарии 2, создаются отдельные экземпляры предупреждений для **компьютеров-01** и 2 **-02**. В соответствии с правилом действий, описанным в сценарии, подавляется только уведомление для **компьютера 01** . Уведомление для **компьютера-02** продолжит срабатывать в нормальном режиме.

![Правила действий и оповещения журнала (число результатов)](media/alerts-action-rules/action-rules-log-alert-metric-measurement.png)

## <a name="faq"></a>ВОПРОСЫ И ОТВЕТЫ

### <a name="while-im-configuring-an-action-rule-id-like-to-see-all-the-possible-overlapping-action-rules-so-that-i-avoid-duplicate-notifications-is-it-possible-to-do-that"></a>Хотя я Настраивая правило действия, я хочу увидеть все возможные перекрывающиеся правила действий, чтобы избежать дублирования уведомлений. Возможно ли это сделать?

После определения области при настройке правила действия можно просмотреть список правил действий, которые перекрывают ту же область (если она есть). Перекрытие может быть одним из следующих вариантов:

* Точное соответствие: например, правило действия, которое вы определяете, и перекрывающиеся правила действий находятся в одной подписке.
* Подмножество: например, определяемое вами правило действия находится в подписке, а перекрывающая правило — в группе ресурсов в подписке.
* Надмножество: например, определяемое вами правило действия находится в группе ресурсов, а перекрывающая правило — в подписке, содержащей группу ресурсов.
* Пересечением: например, определяемое вами правило действия находится в **VM1** и **VM2**, а перекрытие правила действия — на **VM2** и **VM3**.

![На снимке экрана показана страница нового правила действий с перекрывающимися правилами действий, отображаемыми в правилах действий, определенных в том же окне области.](media/alerts-action-rules/action-rules-overlapping.png)

### <a name="while-im-configuring-an-alert-rule-is-it-possible-to-know-if-there-are-already-action-rules-defined-that-might-act-on-the-alert-rule-im-defining"></a>Хотя я Настраивая правило генерации оповещений, можно ли определить, есть ли уже определенные правила действий, которые могут действовать в правиле генерации оповещений, которое я определяю?

Определив целевой ресурс для правила генерации оповещений, можно просмотреть список правил действий, которые действуют в той же области (если таковые имеются), выбрав **Просмотреть настроенные действия** в разделе **действия** . Этот список заполняется в соответствии со следующими сценариями для области:

* Точное соответствие: например, правило оповещения, которое вы определяете, и правило действия находятся в одной подписке.
* Подмножество: например, определяемое вами правило генерации оповещений находится в подписке, а правило — в группе ресурсов в подписке.
* Надмножество: например, определяемое вами правило генерации оповещений находится в группе ресурсов, а правило — в подписке, содержащей группу ресурсов.
* Пересечением: например, определяемое вами правило генерации оповещений находится в **VM1** и **VM2**, а правило действия — в **VM2** и **VM3**.

![Перекрывающиеся правила действий](media/alerts-action-rules/action-rules-alert-rule-overlapping.png)

### <a name="can-i-see-the-alerts-that-have-been-suppressed-by-an-action-rule"></a>Можно ли видеть предупреждения, подавленные правилом действий?

На [странице список оповещений](./alerts-managing-alert-instances.md)можно выбрать дополнительный столбец с именем " **состояние подавления**". Если уведомление для экземпляра предупреждения было подавлено, оно покажет это состояние в списке.

![Подавленные экземпляры предупреждений](media/alerts-action-rules/action-rules-suppressed-alerts.png)

### <a name="if-theres-an-action-rule-with-an-action-group-and-another-with-suppression-active-on-the-same-scope-what-happens"></a>Что произойдет, если имеется правило действия с группой действий и другое с подавлением, активным в той же области.

Подавление всегда имеет приоритет над одной и той же областью.

### <a name="what-happens-if-i-have-a-resource-thats-monitored-in-two-separate-action-rules-do-i-get-one-or-two-notifications-for-example-vm2-in-the-following-scenario"></a>Что произойдет, если у меня есть ресурс, который отслеживается в двух отдельных правилах действий? Я получаю одно или два уведомления? Например, **VM2** в следующем сценарии:

   `action rule AR1 defined for VM1 and VM2 with action group AG1`

   `action rule AR2 defined for VM2 and VM3 with action group AG1`

Для каждого оповещения в VM1 и VM3 группа действий AG1 будет активирована один раз. Для каждого оповещения в **VM2** группа действий AG1 будет вызываться дважды, так как правила действий не будут выполнять дублирование действий.

### <a name="what-happens-if-i-have-a-resource-monitored-in-two-separate-action-rules-and-one-calls-for-action-while-another-for-suppression-for-example-vm2-in-the-following-scenario"></a>Что произойдет, если ресурс отслеживается в двух отдельных правилах действий и один вызов действия, а другой — для подавления? Например, **VM2** в следующем сценарии:

   `action rule AR1 defined for VM1 and VM2 with action group AG1`

   `action rule AR2 defined for VM2 and VM3 with suppression`

Для каждого оповещения в VM1 группа действий AG1 будет активирована один раз. Действия и уведомления для каждого предупреждения в VM2 и VM3 будут подавлены.

### <a name="what-happens-if-i-have-an-alert-rule-and-an-action-rule-defined-for-the-same-resource-calling-different-action-groups-for-example-vm1-in-the-following-scenario"></a>Что произойдет, если у меня есть правило генерации оповещений и правило действий, определенное для того же ресурса, вызывающего различные группы действий? Например, **VM1** в следующем сценарии:

   `alert rule rule1 on VM1 with action group AG2`

   `action rule AR1 defined for VM1 with action group AG1`

Для каждого оповещения в VM1 группа действий AG1 будет активирована один раз. Каждый раз, когда срабатывает правило генерации оповещений "Rule1", оно также будет запускать ГД2 дополнительно. Группы действий, определенные в правилах действий и правилах генерации оповещений, работают независимо друг от друга без дедупликации.

## <a name="next-steps"></a>Дальнейшие действия

- [Дополнительные сведения об оповещениях в Azure](./alerts-overview.md)