---
title: Установка агента Log Analytics на компьютерах Linux
description: В этой статье описывается подключение компьютеров Linux, размещенных в других облаках или в локальной среде, к Azure Monitor с помощью агента Log Analytics для Linux.
ms.subservice: logs
ms.topic: conceptual
author: bwren
ms.author: bwren
ms.date: 08/21/2020
ms.openlocfilehash: 06b59aa1fe6b51bf237c0cd64117166ca4ece10b
ms.sourcegitcommit: c27a20b278f2ac758447418ea4c8c61e27927d6a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/03/2021
ms.locfileid: "101734933"
---
# <a name="install-log-analytics-agent-on-linux-computers"></a>Установка агента Log Analytics на компьютерах Linux
В этой статье содержатся сведения об установке агента Log Analytics на компьютерах Linux с помощью следующих методов.

* [Установите агент для Linux с помощью скрипта-оболочки,](#install-the-agent-using-wrapper-script) размещенного на GitHub. Этот метод рекомендуется использовать для установки и обновления агента, если компьютер подключен к Интернету напрямую или через прокси-сервер.
* [Скачайте и установите агент вручную](#install-the-agent-manually) . Это необходимо, если компьютер Linux не имеет доступа к Интернету и будет взаимодействовать с Azure Monitor или службой автоматизации Azure через [шлюз log Analytics](./gateway.md). 

>[!IMPORTANT]
> Методы установки, описанные в этой статье, обычно используются для виртуальных машин в локальной среде или в других облаках. Дополнительные параметры, которые можно использовать для виртуальных машин Azure, см. в статье [варианты установки](./log-analytics-agent.md#installation-options) .



## <a name="supported-operating-systems"></a>Поддерживаемые операционные системы

Список дистрибутивов Linux, поддерживаемых агентом Log Analytics, см. в [обзоре Azure Monitor агентов](agents-overview.md#supported-operating-systems) .

>[!NOTE]
>OpenSSL 1.1.0 поддерживается только на платформах x86_x64 (64-разрядная версия), а OpenSSL версии более ранней, чем 1.x, не поддерживается ни на каких платформах.

>[!NOTE]
>Запуск агента Log Analytics Linux в контейнерах не поддерживается. Если вам нужно отслеживать контейнеры, используйте решение для [мониторинга контейнеров](../containers/containers.md) для узлов DOCKER или [Container Insights](../containers/container-insights-overview.md) для Kubernetes.

Начиная с версий, выпущенных после августа 2018 года, мы вносим следующие изменения в свою модель поддержки:  

* Поддерживаются только версии серверов, а не клиентов.  
* Сосредоточьтесь на любом из [поддерживаемых дистрибутивов Azure Linux](../../virtual-machines/linux/endorsed-distros.md). Обратите внимание, что между новыми дистрибутивом или версией, поддерживаемой Azure Linux, и агентом Log Analytics Linux может возникнуть задержка.
* Все вспомогательные версии поддерживаются для каждого основного номера версии в списке.
* Версии, для которых прошла дата окончания поддержки производителем, не поддерживаются.
* Поддерживаются только образы виртуальных машин. контейнеры, даже производные от официальных изображений дистрибутив Publishers, не поддерживаются.
* Новые версии AMI не поддерживаются.  
* Поддерживаются только версии, работающие с SSL 1.x по умолчанию.

>[!NOTE]
>Если вы используете дистрибутив или версию, которые в настоящее время не поддерживаются и не соответствуют нашей модели поддержки, мы рекомендуем вам сделать вилку этого репозитория, согласившись, что специалисты службы поддержки Майкрософт не будут предоставлять помощь при работе с версиями разветвленных агентов.

### <a name="python-requirement"></a>Требование к Python

Начиная с версии агента 1.13.27, агент Linux будет поддерживать Python 2 и 3. Мы всегда советуем использовать последнюю версию агента. 

Если вы используете более старую версию агента, то по умолчанию виртуальная машина должна использовать Python 2. Если ваша виртуальная машина использует дистрибутив, которая по умолчанию не включает Python 2, ее необходимо установить. Приведенные ниже примеры команд будут устанавливать Python 2 на разных дистрибутивов.

 - Red Hat, CentOS, Oracle: `yum install -y python2`
 - Ubuntu, Debian: `apt-get install -y python2`
 - SUSE: `zypper install -y python2`

Исполняемый файл python2 должен иметь псевдоним для *Python*. Ниже приведен один метод, который можно использовать для задания этого псевдонима:

1. Выполните следующую команду, чтобы удалить все существующие псевдонимы.
 
    ```
    sudo update-alternatives --remove-all python
    ```

2. Выполните следующую команду, чтобы создать псевдоним.

    ```
    sudo update-alternatives --install /usr/bin/python python /usr/bin/python2 1
    ```

## <a name="supported-linux-hardening"></a>Поддерживаемые усиление защиты Linux
Агент OMS имеет ограниченную поддержку настройки для Linux. 

В настоящее время поддерживаются следующие действия: 
- Стандарт

Следующие вопросы рассмотрены, но пока не поддерживаются:
- СОСТОЯНИИ
- SELINUX

Другие методы усиления защиты и настройки не поддерживаются и не планируются для агента OMS.  

## <a name="agent-prerequisites"></a>Предварительные требования к агенту

В следующей таблице перечислены пакеты, необходимые для [поддерживаемых дистрибутивов Linux](#supported-operating-systems) , на которых будет установлен агент.

|Требуемый пакет |Описание |Минимальная версия |
|-----------------|------------|----------------|
|Glibc |    Библиотека C GNU | 2.5-12 
|Openssl    | Библиотеки OpenSSL | 1.0. x или 1.1. x |
|Curl | Веб-клиент cURL | 7.15.5 |
|Python | | 2.6 + или 3.3 +
|Python-ctypes | | 
|PAM | Подключаемые модули аутентификации | | 

>[!NOTE]
>Для сбора сообщений системного журнала требуется rsyslog или syslog-ng. Управляющая программа syslog по умолчанию не поддерживается для сбора событий системного журнала в Red Hat Enterprise Linux версии 5, CentOS и Oracle Linux (sysklog). Чтобы собирать данные системного журнала из дистрибутивов этих версий, требуется установить и настроить управляющую программу rsyslog, которая заменит sysklog.

## <a name="network-requirements"></a>Требования к сети
Требования к сети для агента Linux см. в разделе [Обзор агента log Analytics](./log-analytics-agent.md#network-requirements) .

## <a name="agent-install-package"></a>Пакет установки агента

Агент Log Analytics для Linux состоит из нескольких пакетов. Файл выпуска содержит следующие пакеты, доступные для запуска пакета оболочки с `--extract` параметром:

**Пакет** | **Версия** | **Описание**
----------- | ----------- | --------------
omsagent | 1.13.9 | Агент Log Analytics для Linux
omsconfig | 1.1.1 | Агент конфигурации для агента Log Analytics
omi | 1.6.4 | Открытая инфраструктура управления (OMI) — Облегченный сервер CIM. *Обратите внимание, что OMI требует наличия корневого доступа для выполнения задания cron, необходимого для функционирования службы.*
scx | 1.6.4 | Поставщики OMI CIM для метрик производительности операционной системы
apache-cimprov | 1.0.1 | Поставщик мониторинга производительности сервера Apache HTTP Server для OMI. Устанавливается только при обнаружении сервера Apache HTTP Server
mysql-cimprov | 1.0.1 | Поставщик мониторинга производительности сервера MySQL для OMI. Устанавливается только при обнаружении сервера MySQL или MariaDB
docker-cimprov | 1.0.0 | Поставщик Docker для OMI. Устанавливается только при обнаружении Docker

### <a name="agent-installation-details"></a>Сведения об установке агента

После установки агента Log Analytics для пакетов Linux применяются следующие дополнительные изменения конфигурации на уровне системы. Эти артефакты удаляются после удаления пакета omsagent.

* Создается непривилегированный пользователь с именем `omsagent` . Управляющая программа запускается с этими учетными данными. 
* Файл, *включаемый* в файлы sudo, создается в `/etc/sudoers.d/omsagent` . Это разрешает `omsagent` перезапустить управляющие программы syslog и omsagent. Если в установленной версии sudo не поддерживаются директивы sudo *include* , эти записи будут записаны в `/etc/sudoers` .
* Конфигурация системного журнала настраивается для перенаправления подмножества событий агенту. Дополнительные сведения см. в разделе [Настройка сбора данных системного журнала](data-sources-syslog.md).

На отслеживаемом компьютере Linux агент указан как `omsagent` . `omsconfig` Агент Log Analytics агента конфигурации Linux, который выполняет поиск новой конфигурации на стороне портала каждые 5 минут. Новая и обновленная конфигурация применяется к файлам конфигурации агента, расположенным в папке `/etc/opt/microsoft/omsagent/conf/omsagent.conf` .

## <a name="install-the-agent-using-wrapper-script"></a>Установка агента с помощью скрипта-оболочки

Ниже описано, как настроить установку агента для Log Analytics в Azure для государственных организаций Azure с помощью скрипта оболочки для компьютеров Linux, которые могут обмениваться данными напрямую или через прокси-сервер для загрузки агента, размещенного на GitHub, и установки агента.  

Если компьютер Linux должен взаимодействовать через прокси-сервер для Log Analytics, эту конфигурацию можно указать в командной строке, включив `-p [protocol://][user:password@]proxyhost[:port]` . Свойство *Protocol* принимает значение `http` или `https` , а свойство *проксихост* принимает полное доменное имя или IP-адрес прокси-сервера. 

Например: `https://proxy01.contoso.com:30443`

Если в любом случае требуется проверка подлинности, необходимо указать имя пользователя и пароль. Например: `https://user01:password@proxy01.contoso.com:30443`

1. Чтобы настроить компьютер Linux для подключения к рабочей области Log Analytics, выполните следующую команду, указав идентификатор рабочей области и первичный ключ. Следующая команда скачивает агент, проверяет его контрольную сумму и устанавливает его.
    
    ```
    wget https://raw.githubusercontent.com/Microsoft/OMS-Agent-for-Linux/master/installer/scripts/onboard_agent.sh && sh onboard_agent.sh -w <YOUR WORKSPACE ID> -s <YOUR WORKSPACE PRIMARY KEY>
    ```

    Следующая команда включает параметр `-p` прокси-сервера и пример синтаксиса, если для прокси-сервера требуется проверка подлинности.

   ```
    wget https://raw.githubusercontent.com/Microsoft/OMS-Agent-for-Linux/master/installer/scripts/onboard_agent.sh && sh onboard_agent.sh -p [protocol://]<proxy user>:<proxy password>@<proxyhost>[:port] -w <YOUR WORKSPACE ID> -s <YOUR WORKSPACE PRIMARY KEY>
    ```

2. Чтобы настроить компьютер Linux для подключения к рабочей области Log Analytics в облаке Azure для государственных организаций, выполните следующую команду, указав идентификатор рабочей области и первичный ключ, скопированные ранее. Следующая команда скачивает агент, проверяет его контрольную сумму и устанавливает его. 

    ```
    wget https://raw.githubusercontent.com/Microsoft/OMS-Agent-for-Linux/master/installer/scripts/onboard_agent.sh && sh onboard_agent.sh -w <YOUR WORKSPACE ID> -s <YOUR WORKSPACE PRIMARY KEY> -d opinsights.azure.us
    ``` 

    Следующая команда включает параметр `-p` прокси-сервера и пример синтаксиса, если для прокси-сервера требуется проверка подлинности.

   ```
    wget https://raw.githubusercontent.com/Microsoft/OMS-Agent-for-Linux/master/installer/scripts/onboard_agent.sh && sh onboard_agent.sh -p [protocol://]<proxy user>:<proxy password>@<proxyhost>[:port] -w <YOUR WORKSPACE ID> -s <YOUR WORKSPACE PRIMARY KEY> -d opinsights.azure.us
    ```
2. Перезапустите агент, выполнив следующую команду. 

    ```
    sudo /opt/microsoft/omsagent/bin/service_control restart [<workspace id>]
    ``` 


## <a name="install-the-agent-manually"></a>Установка агента вручную

Агент Log Analytics для Linux предоставляется в виде самораспаковывающегося и устанавливаемого пакета сценариев оболочки. Этот пакет содержит пакеты Debian и RPM для каждого из компонентов агента. Его можно установить непосредственно или извлечь отдельные пакеты. Один пакет предоставляется для архитектуры x64 и One для архитектур x86. 

> [!NOTE]
> Для виртуальных машин Azure рекомендуется установить агент на них с помощью [расширения виртуальной машины azure log Analytics](../../virtual-machines/extensions/oms-linux.md) для Linux. 

1. [Скачайте](https://github.com/microsoft/OMS-Agent-for-Linux#azure-install-guide) и перенесите соответствующий пакет (x64 или x86) на виртуальную машину Linux или физический компьютер с помощью SCP или SFTP.

2. Установите пакет с помощью `--install` аргумента. Чтобы подключить рабочую область Log Analytics во время установки, укажите `-w <WorkspaceID>` Параметры и, `-s <workspaceKey>` скопированные ранее.

    >[!NOTE]
    >Этот аргумент необходимо использовать, `--upgrade` Если установлены зависимые пакеты, такие как OMI, SCX, omsconfig или их старые версии, как в случае, если агент System Center Operations Manager для Linux уже установлен. 

    ```
    sudo sh ./omsagent-*.universal.x64.sh --install -w <workspace id> -s <shared key>
    ```

3. Чтобы настроить агент Linux для установки и подключения к рабочей области Log Analytics через шлюз Log Analytics, выполните следующую команду, указав параметры прокси-сервера, идентификатора рабочей области и ключа рабочей области. Эту конфигурацию можно указать в командной строке, включив `-p [protocol://][user:password@]proxyhost[:port]` . Свойство *проксихост* принимает полное доменное имя или IP-адрес сервера шлюза log Analytics.  

    ```
    sudo sh ./omsagent-*.universal.x64.sh --upgrade -p https://<proxy address>:<proxy port> -w <workspace id> -s <shared key>
    ```

    Если требуется проверка подлинности, необходимо указать имя пользователя и пароль. Пример. 
    
    ```
    sudo sh ./omsagent-*.universal.x64.sh --upgrade -p https://<proxy user>:<proxy password>@<proxy address>:<proxy port> -w <workspace id> -s <shared key>
    ```

4. Чтобы настроить компьютер Linux для подключения к рабочей области Log Analytics в облаке Azure для государственных организаций, выполните следующую команду, указав идентификатор рабочей области и первичный ключ, скопированные ранее.

    ```
    sudo sh ./omsagent-*.universal.x64.sh --upgrade -w <workspace id> -s <shared key> -d opinsights.azure.us
    ```

Если вы хотите установить пакеты агента и настроить его для передачи в определенную рабочую область Log Analytics позже, выполните следующую команду:

```
sudo sh ./omsagent-*.universal.x64.sh --upgrade
```

Если требуется извлечь пакеты агента из пакета, не устанавливая агент, выполните следующую команду:

```
sudo sh ./omsagent-*.universal.x64.sh --extract
```

## <a name="upgrade-from-a-previous-release"></a>Обновление предыдущей версии

Обновление с предыдущей версии, начиная с версии 1.0.0-47, поддерживается в каждом выпуске. Выполните установку с `--upgrade` параметром, чтобы обновить все компоненты агента до последней версии.

## <a name="cache-information"></a>Сведения о кэше
Данные агента Log Analytics для Linux кэшируются на локальном компьютере в *% STATE_DIR_WS%/out_oms_common*. buffer * перед отправкой на Azure Monitor. Пользовательские данные журнала помещаются в буфер *% STATE_DIR_WS%/out_oms_blob*. buffer *. Для некоторых [решений и типов данных](https://github.com/microsoft/OMS-Agent-for-Linux/search?utf8=%E2%9C%93&q=+buffer_path&type=)путь может отличаться.

Агент пытается отправить каждые 20 секунд. В случае сбоя он будет ожидать экспоненциального увеличения длительности времени, пока не завершится успешно: 30 секунд до второй попытки, 60 секунд до третьего, 120 секунд... и не более 16 минут между повторными попытками до успешного подключения. Агент будет повторять попытку до 6 раз для заданного фрагмента данных, прежде чем отпустить и перейти к следующему. Это будет продолжаться до тех пор, пока агент не будет успешно отправлен. Это означает, что данные могут быть помещены в буфер до приблизительно 30 минут, прежде чем они будут удалены.

Размер кэша по умолчанию составляет 10 МБ, но его можно изменить в [файле omsagent. conf](https://github.com/microsoft/OMS-Agent-for-Linux/blob/e2239a0714ae5ab5feddcc48aa7a4c4f971417d4/installer/conf/omsagent.conf).


## <a name="next-steps"></a>Дальнейшие действия

- Дополнительные сведения о перенастройке, обновлении или удалении агента из виртуальной машины см. в статье [Обслуживание агента Log Analytics для Windows и Linux и управление им](agent-manage.md).

- Если во время установки или настройки агента возникают какие-либо проблемы, см. статью об [устранении неполадок с агентом Linux для Log Analytics](agent-linux-troubleshoot.md).