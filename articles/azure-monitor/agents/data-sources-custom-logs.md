---
title: Сбор пользовательских журналов с помощью агента Log Analytics в Azure Monitor
description: Azure Monitor может собирать события из текстовых файлов на компьютерах Windows и Linux.  В этой статье описано, как определить новый настраиваемый журнал и сведения для записей, которые он создает в службе Azure Monitor.
ms.topic: conceptual
author: bwren
ms.author: bwren
ms.date: 10/21/2020
ms.openlocfilehash: b66011ff41e1dd4a7439105862ca61355a95bd71
ms.sourcegitcommit: f3ec73fb5f8de72fe483995bd4bbad9b74a9cc9f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/04/2021
ms.locfileid: "102042714"
---
# <a name="collect-custom-logs-with-log-analytics-agent-in-azure-monitor"></a>Сбор пользовательских журналов с помощью агента Log Analytics в Azure Monitor

Источник данных пользовательских журналов для агента Log Analytics в Azure Monitor позволяет получать события из текстовых файлов на компьютерах Windows и Linux. Во многих приложениях вместо стандартной службы ведения журнала, например журнала событий Windows или системного журнала, данные журналов записываются в текстовые файлы. Вы можете проанализировать собранные данные с разделением на отдельные поля в ваших запросах или во время сбора извлечь данные в отдельные поля.

> [!IMPORTANT]
> В этой статье рассматривается сбор пользовательских журналов с помощью [агента log Analytics](./log-analytics-agent.md) , который является одним из агентов, используемых Azure Monitor. Другие агенты собираются разные данные и настраиваются по-разному. Список доступных агентов и данных, которые они могут собираются, см. в разделе [Обзор агентов Azure Monitor](../agents/agents-overview.md) .

![Сбор данных из настраиваемых журналов](media/data-sources-custom-logs/overview.png)

Собираемые файлы журнала должны соответствовать следующим условиям:

- В каждой строке журнала должна содержаться одна запись либо в начале каждой строки должна быть временная метка в одном из следующих форматов:

    ГГГГ-ММ-ДД ЧЧ:ММ:СС; <br>М/Д/ГГГГ ЧЧ:ММ:СС AM/PM (12-часовой формат);<br>М ДД ГГГГ ЧЧ:ММ:СС;<br />ггммдд чч:мм:сс;<br />ддммгг чч:мм:сс;<br />ммм д чч:мм:сс;<br />дд/ммм/гг чч:мм:сс;<br />гггг-ММ-ддTчч:мм:сс.

- В части файла журнала, где будут добавляться новые записи, не должны выполняться циклическое ведение журнала или чередования журналов.
- В файле журнала должна использоваться кодировка ASCII или UTF-8.  Другие форматы, например UTF-16, не поддерживаются.
- В Linux Преобразование часовых поясов не поддерживается для меток времени в журналах.

>[!NOTE]
> Если в файле журнала есть повторяющиеся записи, Azure Monitor будет собирать их. Тем не менее результаты запроса будут несогласованы, если после применения фильтра будет показано больше событий, чем самих результатов. Будет важно проверить журнал, чтобы определить, вызвано ли это поведение приложением, которое его создает, и устранить проблему, если это возможно, перед созданием определения сбора настраиваемого журнала.  
>

>[!NOTE]
> Рабочая область Log Analytics поддерживает следующие ограничения.
> 
> * Вы можете создать только 500 пользовательских журналов.
> * Таблица поддерживает до 500 столбцов. 
> * Имя столбца не может содержать более 500 символов. 
>

>[!IMPORTANT]
>Для пользовательского сбора журналов требуется, чтобы приложение, записывающее файл журнала, заводило на диск, периодически сбрасывать содержимое журнала. Это обусловлено тем, что пользовательская коллекция журналов использует уведомления об изменении файловой системы для отслеживаемого файла журнала.

## <a name="defining-a-custom-log"></a>Определение настраиваемого журнала
Ниже описана процедура определения файла настраиваемого журнала.  В конце этой статьи содержится пошаговое руководство по добавлению настраиваемого журнала.

### <a name="step-1-open-the-custom-log-wizard"></a>Шаг 1. Открытие мастера настраиваемого журнала
Мастер настраиваемых журналов на портале Azure позволяет определить новый настраиваемый журнал для сбора данных.

1. На портале Azure щелкните **Рабочие области Log Analytics**, выберите свою рабочую область, а затем — **Дополнительные параметры**.
2. Щелкните   >  **пользовательские журналы** данных.
3. По умолчанию все изменения конфигурации автоматически отправляются во все агенты. Файл конфигурации агентов Linux отправляется в сборщик данных Fluentd.
4. Щелкните **Add+** (Добавить+), чтобы открыть мастер настраиваемого журнала.

### <a name="step-2-upload-and-parse-a-sample-log"></a>Шаг 2. Загрузка и преобразование примера журнала
Сначала необходимо загрузить пример настраиваемого журнала.  Затем мастер выполнит преобразование и отобразит записи в этом файле, чтобы вы смогли их проверить.  Azure Monitor будет использовать указанный вами разделитель для определения каждой записи.

**Новая строка** — тип разделителя по умолчанию, который используется для файлов журнала с одной записью в строке.  Если строка начинается с даты и времени в одном из доступных форматов, то можно указать тип разделителя **Метка времени** , который поддерживает записи, охватывающие несколько строк.

Если в качестве разделителя используется метка времени, свойство TimeGenerated каждой записи в Azure Monitor заполняется датой и временем, указанными для этой записи в файле журнала.  Если в качестве разделителя используется новая строка, свойство TimeGenerated заполняется датой и временем сбора этой записи в Azure Monitor.

1. Нажмите кнопку **Обзор** , чтобы перейти к примеру файла.  Обратите внимание, что в некоторых браузерах эта кнопка может называться **Выбрать файл** .
2. Щелкните **Далее**.
3. Мастер настраиваемого журнала загрузит файл и выведет список определяемых записей.
4. Измените разделитель, который используется для определения новой записи, и выберите разделитель, который подходит для записей в файле журнала.
5. Щелкните **Далее**.

### <a name="step-3-add-log-collection-paths"></a>Шаг 3. Добавление пути к файлам журнала
Для агента необходимо определить один или несколько путей, по которым будет расположен настраиваемый журнал.  Вы можете указать конкретный путь и имя файла журнала или путь с подстановочным знаком вместо имени. Это подходит для приложений, в которых каждый день создается новый файл, или когда один файл достигает определенного размера. Вы также можете указать несколько путей для одного файла журнала.

Например, приложение может каждый день создавать файл журнала, добавляя в имя дату, например log20100316.txt. Шаблоном для такого журнала может быть *log\*.txt*, который будет применяться к любому файлу журнала в соответствии со схемой именования приложения.

Ниже приведены примеры допустимых шаблонов для указания различных файлов журналов.

| Описание | Путь |
|:--- |:--- |
| Все файлы агента Windows в папке *C:\Logs* с расширением .txt |C:\Logs\\\*.txt |
| Все файлы агента Windows в папке *C:\Logs* с расширением .txt и именем, начинающимся со слова log |C:\Logs\log\*.txt |
| Все файлы агента Linux в папке */var/log/audits* с расширением .txt |/var/log/audit/*.txt |
| Все файлы агента Linux в папке */var/log/audit* с расширением .txt и именем, начинающимся со слова log |/var/log/Audit/log\*.txt |

1. Выберите Windows или Linux, чтобы указать, какой формат пути добавляется.
2. Введите путь и нажмите кнопку **+** .
3. Повторите эту процедуру для всех других путей.

### <a name="step-4-provide-a-name-and-description-for-the-log"></a>Шаг 4. Указание имени и описания журнала
Указываемое вами имя будет использоваться для типа журнала, как описано выше.  Это имя всегда будет заканчиваться на _CL, чтобы обозначить, что это настраиваемый журнал.

1. Введите имя для журнала.  Суффикс **\_ CL** предоставляется автоматически.
2. При необходимости введите **описание**.
3. Нажмите кнопку **Далее** , чтобы сохранить определения настраиваемого журнала.

### <a name="step-5-validate-that-the-custom-logs-are-being-collected"></a>Шаг 5. Проверка того, собираются ли данные настраиваемых журналов
Чтобы начальные данные из нового настраиваемого журнала появились в Azure Monitor, может потребоваться около часа.  Из журналов, расположенных по пути, который вы указали, будут собираться записи, добавленные после определения настраиваемого журнала.  Служба Log Analytics не будет сохранять записи, загруженные во время создания настраиваемого журнала, но она будет собирать уже существующие записи в найденных файлах журнала.

Как только Azure Monitor начнет собирать записи из настраиваемого журнала, их можно будет найти, используя запрос по журналу.  В качестве **типа** запроса следует использовать имя, присвоенное настраиваемому журналу.

> [!NOTE]
> Если в разделе запроса отсутствует свойство RawData, закройте и откройте браузер снова.

### <a name="step-6-parse-the-custom-log-entries"></a>Шаг 6. Преобразование записей настраиваемого журнала
Вся запись журнала будет сохранена в свойстве **RawData**.  Скорее всего, вам потребуется разделить различные сведения в каждой записи между отдельными свойствами для каждой записи. Сведения о параметрах для анализа **RawData** с разделением на несколько свойств см. в статье об [анализе текстовых данных в Azure Monitor](../logs/parse-text.md).

## <a name="removing-a-custom-log"></a>Удаление настраиваемого журнала
Чтобы удалить определенный ранее настраиваемый журнал, выполните приведенные ниже действия на портале Azure.

1. В меню **Данные** в **дополнительных параметрах** рабочей области выберите **Настраиваемые журналы**, чтобы получить список всех настраиваемых журналов.
2. Нажмите кнопку **Удалить** рядом с нужным настраиваемым журналом.

## <a name="data-collection"></a>Сбор данных
Azure Monitor собирает новые записи из каждого настраиваемого журнала примерно каждые 5 минут.  Агент фиксирует место сбора в каждом отслеживаемом файле журнала.  Если агент на некоторое время перейдет в автономный режим, Azure Monitor будет собирать записи, начиная с места остановки, даже если эти записи были созданы, пока агент был отключен.

Все содержимое записи журнала записывается в свойство **RawData**.  Методы для анализа каждой импортированной записи журнала с разделением на несколько свойств см. в статье об [анализе текстовых данных в Azure Monitor](../logs/parse-text.md).

## <a name="custom-log-record-properties"></a>Свойства записей настраиваемого журнала
Записи настраиваемого журнала имеют тип на основе указанного имени журнала и указанные ниже свойства.

| Свойство | Описание |
|:--- |:--- |
| TimeGenerated |Дата и время сбора записи службой Azure Monitor.  Если журнал использует разделитель на основе времени, это время, взятое из записи. |
| SourceSystem |Тип агента, из которого собрана запись. <br> OpsManager — агент Windows, подключенный напрямую или управляемый с помощью System Center Operations Manager. <br> Linux — все агенты Linux |
| RawData |Полный текст собранной записи. Скорее всего, вам потребуется [проанализировать эти данные с разделением на отдельные свойства](../logs/parse-text.md). |
| ManagementGroupName |Имя группы управления для агентов System Center Operations Manager.  Для других агентов это AOI-\<workspace ID\>. |


## <a name="sample-walkthrough-of-adding-a-custom-log"></a>Пошаговое руководство по добавлению настраиваемого журнала
В этом разделе описывается процедура создания настраиваемого журнала.  В каждой строке примера журнала, из которого собираются данные, содержится одна запись, начинающаяся с даты и времени, после которых идут поля для кода, состояния и сообщения, разделенные запятыми.  Ниже приведены некоторые примеры записей.

```output
2019-08-27 01:34:36 207,Success,Client 05a26a97-272a-4bc9-8f64-269d154b0e39 connected
2019-08-27 01:33:33 208,Warning,Client ec53d95c-1c88-41ae-8174-92104212de5d disconnected
2019-08-27 01:35:44 209,Success,Transaction 10d65890-b003-48f8-9cfc-9c74b51189c8 succeeded
2019-08-27 01:38:22 302,Error,Application could not connect to database
2019-08-27 01:31:34 303,Error,Application lost connection to database
```

### <a name="upload-and-parse-a-sample-log"></a>Загрузка и преобразование примера журнала
Мы откроем один из файлов журнала, чтобы увидеть события, которые он будет собирать.  В этом случае достаточно использовать в качестве разделителя новую строку.  Если одна запись в журнале может занимать несколько строк, то потребуется использовать в качестве разделителя метку времени.

![Загрузка и преобразование примера журнала](media/data-sources-custom-logs/delimiter.png)

### <a name="add-log-collection-paths"></a>Добавление пути к файлам журнала
Файлы журналов будут храниться в каталоге *C:\MyApp\Logs*.  Каждый день создается файл с именем, которое включает в себя дату, в формате *приложение_ГГГГММДД.log*.  Для этого журнала достаточно шаблона *к:\мяпп\логс \\ \* . log*.

![Путь к файлам журнала](media/data-sources-custom-logs/collection-path.png)

### <a name="provide-a-name-and-description-for-the-log"></a>Указание имени и описания журнала
Мы введем имя *MyApp_CL* и текст **описания**.

![Имя журнала](media/data-sources-custom-logs/log-name.png)

### <a name="validate-that-the-custom-logs-are-being-collected"></a>Проверка того, собираются ли данные настраиваемых журналов
Для возврата всех записей из собранного журнала используется простой запрос *MyApp_CL* .

![Запрос к журналу без настраиваемых полей](media/data-sources-custom-logs/query-01.png)


## <a name="alternatives-to-custom-logs"></a>Альтернативные варианты настройки журналов
Хотя пользовательские журналы полезны, если данные удовлетворяют указанным выше критериям, в некоторых случаях требуется другая стратегия:

- Данные не соответствуют требуемой структуре, например, метка времени представлена в другом формате.
- Файл журнала не соответствует требованиям, например, кодирование файла или неподдерживаемая структура папки.
- Данные требуют предварительной обработки или фильтрации перед сбором. 

В тех случаях, когда настраиваемые журналы не могут собрать данные, рассмотрите следующие альтернативные стратегии.

- Используйте настраиваемый сценарий или другой метод для записи данных в [События Windows](data-sources-windows-events.md) или [Syslog](data-sources-syslog.md), которые собираются с помощью службы Azure Monitor. 
- Отправьте данные непосредственно в Azure Monitor с помощью [API сборщика данных HTTP](../logs/data-collector-api.md). 

## <a name="next-steps"></a>Дальнейшие действия
* Методы для анализа каждой импортированной записи журнала с разделением на несколько свойств см. в статье об [анализе текстовых данных в Azure Monitor](../logs/parse-text.md).
* Узнайте больше о [запросах журнала](../logs/log-query-overview.md), которые можно применять для анализа данных, собираемых из источников данных и решений.