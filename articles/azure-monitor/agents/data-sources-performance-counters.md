---
title: Собирайте источники данных производительности Windows и Linux с помощью агента Log Analytics в Azure Monitor
description: Счетчики производительности собираются службой Azure Monitor для анализа производительности в агентах Windows и Linux.  В этой статье описывается настройка коллекции счетчиков производительности для агентов Windows и Linux, сведения об этих счетчиках, которые хранятся в рабочей области, и их анализ на портале Azure.
ms.topic: conceptual
author: bwren
ms.author: bwren
ms.date: 02/26/2021
ms.openlocfilehash: f4bddc1666d1165d6a1e4c749fdbc96ede37747a
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "102036791"
---
# <a name="collect-windows-and-linux-performance-data-sources-with-log-analytics-agent"></a>Получение источников данных производительности Windows и Linux с помощью агента Log Analytics
Счетчики производительности в Windows и Linux позволяют получить представление о производительности компонентов оборудования, операционных систем и приложений.  Azure Monitor может получать счетчики производительности от агентов Log Analytics с частыми интервалами для анализа практически в реальном времени (ПРЕВЕНТИВНОЙ), помимо агрегирования данных производительности для более долгосрочного анализа и отчетности.

> [!IMPORTANT]
> В этой статье рассматривается сбор данных о производительности с помощью [агента log Analytics](./log-analytics-agent.md) , который является одним из агентов, используемых Azure Monitor. Другие агенты собираются разные данные и настраиваются по-разному. Список доступных агентов и данных, которые они могут собираются, см. в разделе [Обзор агентов Azure Monitor](../agents/agents-overview.md) .

![Счетчики производительности](media/data-sources-performance-counters/overview.png)

## <a name="configuring-performance-counters"></a>Настройка счетчиков производительности
Настройте счетчики производительности из [меню конфигурации агентов](../agents/agent-data-sources.md#configuring-data-sources) для рабочей области log Analytics.

При первой настройке счетчиков производительности Windows или Linux для новой рабочей области вы можете быстро создать несколько распространенных счетчиков.  Рядом с каждым счетчиком в списке есть флажок.  Отметьте все счетчики, которые нужно создать изначально, и щелкните ссылку **Добавить выбранные счетчики производительности**.

Для каждого счетчика производительности Windows можно выбрать конкретный экземпляр. В случае счетчиков производительности Linux экземпляр выбранного счетчика применяется ко всем дочерним счетчикам родительского счетчика. В следующей таблице представлены распространенные экземпляры для счетчиков производительности Linux и Windows.

| Имя экземпляра | Описание |
| --- | --- |
| \_Total |Общее количество всех экземпляров |
| \* |Все экземпляры |
| (/&#124;/var) |Сопоставление экземпляров с именем / или/var |

### <a name="windows-performance-counters"></a>Счетчики производительности Windows

[![Настройка счетчиков производительности Windows](media/data-sources-performance-counters/configure-windows.png)](media/data-sources-performance-counters/configure-windows.png#lightbox)

Чтобы добавить новый счетчик производительности Windows для сбора данных, выполните описанные ниже действия. Обратите внимание, что счетчики производительности Windows версии 2 не поддерживаются.

1. Щелкните **добавить счетчик производительности**.
2. Введите в текстовое поле имя счетчика в формате *объект(экземпляр)\счетчик*.  По мере ввода вы увидите соответствующий список распространенных счетчиков.  Выберите счетчик из списка или введите собственный.  Кроме того, вы можете получить все экземпляры определенного счетчика, указав *объект\счетчик*.  

    При сборе данных счетчиков производительности SQL Server из именованных экземпляров имена всех этих счетчиков начинаются с *MSSQL$*, после чего следует имя экземпляра.  Например, чтобы собрать показатели счетчика "Коэффициент попаданий в кэш журнала" для всех баз данных из объекта производительности базы данных для экземпляра SQL (INST2), укажите `MSSQL$INST2:Databases(*)\Log Cache Hit Ratio`.

4. При добавлении счетчика по умолчанию устанавливается **интервал выборки** 10 секунд.  Вы можете увеличить это значение до 1800 секунд (30 минут), уменьшив таким образом объем собираемых данных по производительности.
5. Завершив добавление счетчиков, нажмите кнопку **Применить** в верхней части экрана, чтобы сохранить конфигурацию.

### <a name="linux-performance-counters"></a>Счетчики производительности Linux

[![Настройка счетчиков производительности Linux](media/data-sources-performance-counters/configure-linux.png)](media/data-sources-performance-counters/configure-linux.png#lightbox)

Чтобы добавить новый счетчик производительности Linux для сбора данных, выполните описанные ниже действия.

1. Щелкните **добавить счетчик производительности**.
1. Введите в текстовое поле имя счетчика в формате *объект(экземпляр)\счетчик*.  По мере ввода вы увидите соответствующий список распространенных счетчиков.  Выберите счетчик из списка или введите собственный.  
1. Для всех счетчиков объекта используется один и тот же **интервал выборки**.  Значение по умолчанию — 10 секунд.  Вы можете увеличить значение интервала вплоть до 1800 секунд (30 минут), что позволит снизить для хранилища требования к собираемым данным о производительности.
1. Завершив добавление счетчиков, нажмите кнопку **Применить** в верхней части экрана, чтобы сохранить конфигурацию.

#### <a name="configure-linux-performance-counters-in-configuration-file"></a>Настройка счетчиков производительности Linux в файле конфигурации
Вместо настройки счетчиков производительности Linux с помощью портала Azure можно отредактировать файлы конфигурации в агенте Linux.  Метрики производительности для сбора контролируются конфигурацией в **/etc/opt/Microsoft/omsagent/ \<workspace id\> /conf/omsagent.conf**.

Каждый объект или категорию метрики производительности для сбора следует определить в файле конфигурации в качестве одного элемента `<source>` . Синтаксис соответствует шаблону ниже.

```xml
<source>
    type oms_omi  
    object_name "Processor"
    instance_regex ".*"
    counter_name_regex ".*"
    interval 30s
</source>
```


В следующей таблице описаны параметры, используемые в этом элементе.

| Параметры | Описание |
|:--|:--|
| object\_name | Имя объекта в коллекции. |
| instance\_regex |  *Регулярное выражение*, определяющее экземпляры, которые следует собирать. Значение `.*` указывает все экземпляры. Для сбора метрик процессора только для экземпляра \_Total можно указать `_Total`. Для сбора метрик обработки только для экземпляра crond или sshd можно указать `(crond\|sshd)`. |
| counter\_name\_regex | *Регулярное выражение*, определяющее счетчики (для объекта), которые следует собирать. Для сбора всех счетчиков для объекта укажите `.*`. Для сбора только счетчиков области подкачки для объекта памяти, например, можно указать: `.+Swap.+` |
| interval | Частота сбора счетчиков объекта. |


В следующей таблице перечислены объекты и счетчики, которые можно указать в файле конфигурации.  Для определенных приложений доступны дополнительные счетчики, как описано в статье [Сбор данных производительности приложений Linux в Log Analytics](data-sources-linux-applications.md).

| Имени объекта | Имя счетчика |
|:--|:--|
| Logical Disk (Логический диск) | Процент свободных индексных дескрипторов |
| Logical Disk (Логический диск) | Процент свободного места |
| Logical Disk (Логический диск) | Процент используемых индексных дескрипторов |
| Logical Disk (Логический диск) | Процент используемого места |
| Logical Disk (Логический диск) | Скорость чтения с диска (байт/с) |
| Logical Disk (Логический диск) | Операций чтения с диска в секунду |
| Logical Disk (Логический диск) | Обращений к диску в секунду |
| Logical Disk (Логический диск) | Скорость записи на диск (байт/с) |
| Logical Disk (Логический диск) | Операций записи на диск в секунду |
| Logical Disk (Логический диск) | Свободно мегабайт |
| Logical Disk (Логический диск) | Скорость обмена с логическим диском (байт/с) |
| Память | Процент доступной памяти |
| Память | Процент доступной области подкачки |
| Память | Процент используемой памяти |
| Память | Процент используемой области подкачки |
| Память | Доступный объем памяти в МБ |
| Память | Доступный объем подкачки в МБ |
| Память | Операций чтения со страницы в секунду |
| Память | Операций записи на страницу в секунду |
| Память | Страниц в секунду |
| Память | Используемая области подкачки в МБ |
| Память | Используемый объем памяти в МБ |
| Сеть | Всего передано байт |
| Сеть | Всего получено байт |
| Сеть | Всего байт |
| Сеть | Всего передано пакетов |
| Сеть | Всего получено пакетов |
| Сеть | Всего ошибок Rx |
| Сеть | Всего ошибок Tx |
| Сеть | Всего конфликтов |
| Физический диск | Среднее время чтения с диска (с) |
| Физический диск | Среднее время обращения к диску (с) |
| Физический диск | Среднее время записи на диск (с) |
| Физический диск | Скорость обмена с физическим диском (байт/с) |
| Процесс | Процент времени работы в привилегированном режиме |
| Процесс | Процент времени пользователя |
| Процесс | Используемая память в КБ |
| Процесс | Виртуальная общая память |
| Процессор | Процент времени DPC |
| Процессор | Процент времени простоя |
| Процессор | Процент времени прерывания |
| Процессор | Процент времени ожидания ввода-вывода |
| Процессор | Процент времени работы с низким приоритетом |
| Процессор | Процент времени работы в привилегированном режиме |
| Процессор | % загруженности процессора |
| Процессор | Процент времени пользователя |
| Система | Объем свободной физической памяти |
| Система | Объем свободного места в файлах подкачки |
| Система | Объем свободной виртуальной памяти |
| Система | Процессы |
| Система | Объем, сохраненный в файлах подкачки |
| Система | Время доступности |
| Система | Пользователи |


Ниже показана конфигурация по умолчанию для метрик производительности.

```xml
<source>
    type oms_omi
    object_name "Physical Disk"
    instance_regex ".*"
    counter_name_regex ".*"
    interval 5m
</source>

<source>
    type oms_omi
    object_name "Logical Disk"
    instance_regex ".*"
    counter_name_regex ".*"
    interval 5m
</source>

<source>
    type oms_omi
    object_name "Processor"
    instance_regex ".*"
    counter_name_regex ".*"
    interval 30s
</source>

<source>
    type oms_omi
    object_name "Memory"
    instance_regex ".*"
    counter_name_regex ".*"
    interval 30s
</source>
```

## <a name="data-collection"></a>Сбор данных
Служба Azure Monitor будет собирать данные со всех указанных счетчиков производительности с заданным для них интервалом выборки во всех агентах, в которых установлен счетчик.  Данные не суммируются, а необработанные данные доступны во всех представлениях запросов журналов в течение времени, указанного в рабочей области log Analytics.

## <a name="performance-record-properties"></a>Свойства записи о производительности
Записи о производительности имеют тип **Perf** и свойства, описанные в приведенной ниже таблице.

| Свойство. | Описание |
|:--- |:--- |
| Компьютер |Компьютер, с которого было получено событие. |
| CounterName |Имя счетчика производительности. |
| CounterPath |Полный путь к счетчику в \\ \\ \<Computer> \\ счетчике объекта формы (экземпляр) \\ . |
| CounterValue |Числовое значение счетчика. |
| InstanceName |Имя экземпляра события.  Если экземпляра нет, используется пустое значение. |
| ObjectName |Имя объекта производительности. |
| SourceSystem |Тип агента, из которого были получены данные. <br><br>OpsManager — агент Windows, подключенный напрямую или через SCOM <br> Linux — все агенты Linux  <br>  AzureStorage – диагностика Azure |
| TimeGenerated |Дата и время выборки данных. |

## <a name="sizing-estimates"></a>Оценки размера
 Сбор данных для одного счетчика с 10-секундным интервалом генерирует около 1 МБ данных в день на каждый экземпляр.  Оценить требования конкретного счетчика к объему памяти можно по указанной ниже формуле.

> 1 МБ x (число счетчиков) x (число агентов) x (число экземпляров)

## <a name="log-queries-with-performance-records"></a>Запросы по журналам с записями о производительности
Ниже приведены различные примеры запросов по журналу, которые извлекают записи о производительности.

| Запрос | Описание |
|:--- |:--- |
| Perf |Все данные о производительности. |
| Perf &#124; where Computer == "MyComputer" |Все данные о производительности с определенного компьютера |
| Perf &#124; where CounterName == "Current Disk Queue Length" |Все данные о производительности с определенного счетчика |
| &#124; производительности, где ObjectName = = "процессор" и CounterName = = "% загруженности процессора" и InstanceName = = "_Total" &#124; обобщить АВГКПУ = AVG (CounterValue) по компьютерам |Средний объем использования ЦП на всех компьютерах |
| &#124; производительности, где CounterName = = "% загруженности процессора" &#124; суммировать AggregatedValue = Max (CounterValue) by Computer |Максимальный объем использования ЦП на всех компьютерах |
| &#124; производительности, где ObjectName = = "LogicalDisk" и CounterName = = "Текущая длина очереди диска" и Computer = = "Микомпутернаме" &#124; суммировать AggregatedValue = AVG (CounterValue) по InstanceName |Средняя длина текущей дисковой очереди по всем экземплярам заданного компьютера |
| &#124; производительности, где CounterName = = "передача с диска/с" &#124; суммировать AggregatedValue = процентиль (CounterValue, 95) по компьютерам |95-й процентиль для обращений к диску/с на всех компьютерах |
| Perf &#124; where CounterName == "% Processor Time" and InstanceName == "_Total" &#124; summarize AggregatedValue = avg(CounterValue) by bin(TimeGenerated, 1h), Computer |Средняя почасовая нагрузка на ЦП по всем компьютерам |
| Perf &#124; where Computer == "MyComputer" and CounterName startswith_cs "%" and InstanceName == "_Total" &#124; summarize AggregatedValue = percentile(CounterValue, 70) by bin(TimeGenerated, 1h), CounterName | Почасовые 70-е процентили по каждому процентному счетчику для конкретного компьютера |
| Perf &#124; where CounterName == "% Processor Time" and InstanceName == "_Total" and Computer == "MyComputer" &#124; summarize ["min(CounterValue)"] = min(CounterValue), ["avg(CounterValue)"] = avg(CounterValue), ["percentile75(CounterValue)"] = percentile(CounterValue, 75), ["max(CounterValue)"] = max(CounterValue) by bin(TimeGenerated, 1h), Computer |Почасовые средние, минимальные, максимальные значения и 75-е процентили по загрузке ЦП для конкретного компьютера |
| Perf &#124; where ObjectName == "MSSQL$INST2:Databases" and InstanceName == "master" | Все данные производительности из объекта производительности базы данных master именованного экземпляра SQL Server (INST2).  




## <a name="next-steps"></a>Следующие шаги
* [Сбор данных счетчиков производительности из приложений Linux](data-sources-linux-applications.md), включая MySQL и сервер HTTP Apache.
* Узнайте больше о [запросах журнала](../logs/log-query-overview.md), которые можно применять для анализа данных, собираемых из источников данных и решений.  
* Экспортируйте собранные данные в [Power BI](../visualize/powerbi.md) для дополнительной визуализации и анализа.