---
title: Устранение неполадок с агентом Log Analytics для Windows
description: Опишите признаки, причины и способы устранения наиболее распространенных проблем с агентом Log Analytics для Windows в Azure Monitor.
ms.topic: conceptual
author: bwren
ms.author: bwren
ms.date: 11/21/2019
ms.openlocfilehash: 4e2531d511193586ef4605cc3732968b6db28d9f
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "100613517"
---
# <a name="how-to-troubleshoot-issues-with-the-log-analytics-agent-for-windows"></a>How to troubleshoot issues with the Log Analytics agent for Windows (Устранение проблем с агентом Log Analytics для Windows) 

В этой статье содержатся сведения об устранении ошибок, которые могут возникнуть при работе с агентом Log Analytics для Windows в Azure Monitor и предлагаются возможные решения для их устранения.

Если ни одна из рекомендаций не поможет устранить проблему, вы можете использовать следующие каналы поддержки:

* Клиенты с поддержкой Premier могут открыть запрос на поддержку на странице [Premier](https://premier.microsoft.com/).
* Клиенты с соглашением на поддержку Azure могут открыть запрос на поддержку на [портале Azure](https://manage.windowsazure.com/?getsupport=true).
* Посетите страницу Log Analytics отзывы, чтобы просмотреть отправленные идеи и ошибки [https://aka.ms/opinsightsfeedback](https://aka.ms/opinsightsfeedback) или создать новый файл. 

## <a name="log-analytics-troubleshooting-tool"></a>Средство устранения неполадок Log Analytics

Средство устранения неполадок в Windows Log Analytics Agent — это набор сценариев PowerShell, предназначенных для поиска и диагностики проблем с агентом Log Analytics. Он автоматически включается в агент при установке. Запуск этого средства должен быть первым шагом в диагностике проблемы.

### <a name="how-to-use"></a>Использование
1. Откройте командную строку PowerShell от имени администратора на компьютере, где установлен агент Log Analytics.
1. Перейдите в каталог, в котором находится средство.
   * `cd "C:\Program Files\Microsoft Monitoring Agent\Agent\Troubleshooter"`
1. Выполните основной скрипт с помощью следующей команды:
   * `.\GetAgentInfo.ps1`
1. Выберите сценарий устранения неполадок.
1. Следуйте инструкциям на консоли. (Примечание. для выполнения действий в журналах трассировки требуется ручное вмешательство для отмены сбора журналов. В зависимости от воспроизводимость проблемы подождите в течение времени и нажмите кнопку ", чтобы завершить сбор журналов и перейти к следующему шагу).

   Расположение файла результатов заносится в журнал после завершения и открывается новое окно обозревателя.

### <a name="installation"></a>Установка
Средство устранения неполадок автоматически включается при установке Log Analytics агента сборки 10.20.18053.0 и выше.

### <a name="scenarios-covered"></a>Рассматриваемые сценарии
Ниже приведен список сценариев, проверенных средством устранения неполадок.

- Агент не сообщает данные или не содержит данные пульса
- Сбой развертывания расширения агента
- Сбой агента
- Агент потребляет большой объем ресурсов ЦП и памяти
- Сбои при установке и удалении
- Проблемы с пользовательскими журналами
- Проблемы с шлюзом OMS
- Проблемы со счетчиками производительности
- Получение всех журналов

>[!NOTE]
>При возникновении проблемы запустите средство устранения неполадок. Когда вы открываете билет, первоначальное использование журналов значительно поможет нашей группе поддержки быстрее устранить проблему.

## <a name="important-troubleshooting-sources"></a>Важные источники устранения неполадок

 Для помощи в устранении неполадок, связанных с Log Analytics агентом для Windows, агент регистрирует события в журнале событий Windows, в частности, в разделе *Application and Сервицес\оператионс Manager*.  

## <a name="connectivity-issues"></a>Проблемы, связанные с подключением

Если агент обменивается данными через прокси-сервер или брандмауэр, возможны ограничения, препятствующие обмену данными с исходного компьютера и службы Azure Monitor. Если обмен данными заблокирован, в связи с неудачной настройкой регистрация в рабочей области может завершиться ошибкой при попытке установить агент или настроить агент после установки для отправки отчета в дополнительную рабочую область. После успешной регистрации может произойти сбой связи с агентом. В этом разделе описываются методы устранения неполадок, связанных с этим типом, с агентом Windows.

Проверьте, что брандмауэр или прокси-сервер настроен на разрешение следующих портов и URL-адресов, описанных в следующей таблице. Также убедитесь, что проверка HTTP не включена для веб-трафика, так как она может помешать безопасному каналу TLS между агентом и Azure Monitor.  

|Ресурс агента|порты; |Направление |Обход проверки HTTPS|
|------|---------|--------|--------|   
|*.ods.opinsights.azure.com |Порт 443 |Исходящие|Да |  
|*.oms.opinsights.azure.com |Порт 443 |Исходящие|Да |  
|*.blob.core.windows.net |Порт 443 |Исходящие|Да |  
|*. agentsvc.azure-automation.net |Порт 443 |Исходящие|Да |  

Сведения о брандмауэре, необходимые для управления Azure для государственных организаций, см. в [здесь](../../azure-government/compare-azure-government-global-azure.md#azure-monitor). Если планируется использование Azure Automation Hybrid Runbook Worker для подключения к службе автоматизации и регистрации в ней, чтобы применить runbook или решения для управления в вашей среде, они должны иметь доступ к номеру порта и URL-адресам, описанным в разделе [Настройка сети для Hybrid Runbook Worker](../../automation/automation-hybrid-runbook-worker.md#network-planning). 

Существует несколько способов проверить, успешно ли агент взаимодействует с Azure Monitor.

- Включите [оценку работоспособность агентов Azure log Analytics](../insights/solution-agenthealth.md) в рабочей области. На панели мониторинга Работоспособность агентов просмотрите столбец **Счетчик неактивных агентов** , чтобы быстро увидеть, присутствует ли агент.  

- Выполните следующий запрос, чтобы убедиться, что агент отправляет пульс в рабочую область, для которой настроен отчет. Замените на `<ComputerName>` фактическое имя компьютера.

    ```
    Heartbeat 
    | where Computer like "<ComputerName>"
    | summarize arg_max(TimeGenerated, * ) by Computer 
    ```

    Если компьютер успешно взаимодействует со службой, запрос должен вернуть результат. Если запрос не вернул результата, сначала убедитесь, что агент настроен для передачи в нужную рабочую область. Если она настроена правильно, перейдите к шагу 3 и выполните поиск в журнале событий Windows, чтобы определить, регистрирует ли агент какие проблемы, которые могут препятствовать взаимодействию с Azure Monitor.

- Другим способом для обнаружения проблемы с подключением является запуск средства **тестклаудконнективити** . Средство устанавливается по умолчанию с агентом в папке *%Системрут%\програм Files\Microsoft Monitoring agent\agent.*. В командной строке с повышенными привилегиями перейдите в папку и запустите средство. Средство возвращает результаты и особенности, на которых произошел сбой теста (например, если он был связан с определенным портом или URL-адресом, который был заблокирован). 

    ![Результаты выполнения средства Тестклаудконнектион](./media/agent-windows-troubleshoot/output-testcloudconnection-tool-01.png)

- Отфильтруйте *Operations Manager* журнал событий по **источникам событий**  -  *Служба работоспособности modules*, *HealthService* и *Service Connector* и выполните фильтрацию по *предупреждениям* и *ошибкам* на **уровне событий** , чтобы подтвердить, что они записали события из следующей таблицы. Если это так, ознакомьтесь с действиями по устранению, которые включены для каждого возможного события.

    |Идентификатор события |Источник |Описание |Решение |
    |---------|-------|------------|-----------|
    |2133 & 2129 |Служба работоспособности |Не удалось подключиться к службе из агента |Эта ошибка может возникать, когда агент не может напрямую обмениваться данными или через брандмауэр или прокси-сервер к службе Azure Monitor. Проверьте параметры прокси-сервера агента или убедитесь, что сетевой брандмауэр или прокси-сервер разрешает трафик TCP от компьютера к службе.|
    |2138 |Модули службы работоспособности |Прокси-сервер требует проверки подлинности |Настройте параметры прокси-сервера агента и укажите имя пользователя и пароль, необходимые для проверки подлинности на прокси-сервере. |
    |2129 |Модули службы работоспособности |Неудачное соединение или сбой согласования TLS |Проверьте параметры TCP/IP сетевого адаптера и параметры прокси-сервера агента.|
    |2127 |Модули службы работоспособности |Ошибка при отправке данных с кодом ошибки |Если это происходит только периодически в течение дня, это может быть случайная аномалия, которую можно игнорировать. Отслеживайте, как часто происходит это случается. Если это происходит часто в течение дня, сначала проверьте конфигурацию сети и параметры прокси-сервера. Если описание включает код ошибки HTTP 404, и при первом запуске агент пытается отправить данные в службу, он будет содержать ошибку 500 с кодом внутренней ошибки 404. 404 — не найдено, что означает, что область хранилища для новой рабочей области все еще находится в процессе подготовки. При следующей попытке данные будут успешно записаны в рабочую область, как и ожидалось. Ошибка HTTP 403 может указывать на ошибку разрешения или учетных данных. Дополнительные сведения см. в описании ошибки 403 для устранения проблемы.|
    |4000 |Соединитель служб |Сбой разрешения DNS-имени |Компьютеру не удалось разрешить адрес в Интернете, используемый при отправке данных в службу. Это может быть параметры сопоставителя DNS на компьютере, неверные параметры прокси-сервера или временная ошибка DNS поставщика. Если это происходит периодически, это может быть вызвано временной проблемой, связанной с сетью.|
    |4001 |Соединитель служб |Не удалось подключиться к службе. |Эта ошибка может возникать, когда агент не может напрямую обмениваться данными или через брандмауэр или прокси-сервер к службе Azure Monitor. Проверьте параметры прокси-сервера агента или убедитесь, что сетевой брандмауэр или прокси-сервер разрешает трафик TCP от компьютера к службе.|
    |4002 |Соединитель служб |Служба вернула код состояния HTTP 403 в ответ на запрос. Обратитесь к администратору службы за работоспособностью службы. Повторная попытка запроса будет выполнена позже. |Эта ошибка записывается на этапе начальной регистрации агента, и вы увидите URL-адрес следующего вида: *https:// \<workspaceID> . OMS.opinsights.Azure.com/AgentService.svc/AgentTopologyRequest*. Код ошибки 403 означает, что она запрещена и может быть вызвана неправильными ИДЕНТИФИКАТОРом или ключом рабочей области, или неверными данными и временем на компьютере. Если время отличается от текущего на 15 минут, подключение завершится сбоем. Чтобы исправить это, обновите дату и/или часовой пояс компьютера Windows.|

## <a name="data-collection-issues"></a>Проблемы с сбором данных

После установки агента и отправки отчетов в настроенную рабочую область или рабочие области он может перестает получать конфигурацию, собирать или пересылать производительность, журналы или другие данные в службу в зависимости от того, что включено и предназначено для компьютера. Необходимо определить следующее:

- Это конкретный тип данных или все данные, недоступные в рабочей области?
- Тип данных, указанный решением или заданный в составе конфигурации сбора данных рабочей области?
- Сколько компьютеров? Является ли это один или несколько компьютеров, передающих в рабочую область?
- Была ли она работала, и она была остановлена в определенное время дня или когда она никогда не собралась? 
- Используется ли синтаксически правильная синтаксическая Настройка запроса поиска по журналам? 
- Был ли агент получал свою конфигурацию от Azure Monitor?

Первым шагом в устранении неполадок является определение того, отправляет ли компьютер событие пульса.

```
Heartbeat 
    | where Computer like "<ComputerName>"
    | summarize arg_max(TimeGenerated, * ) by Computer
```

Если запрос возвращает результаты, необходимо определить, не собираются ли данные определенного типа и не пересылаются в службу. Это может быть вызвано тем, что агент не получал обновленную конфигурацию от службы или некоторые другие признаки, препятствующие нормальной работе агента. Чтобы устранить неполадки, выполните следующие действия.

1. Откройте командную строку с повышенными привилегиями на компьютере и перезапустите службу агента, введя `net stop healthservice && net start healthservice` .
2. Откройте журнал событий *Operations Manager* и выполните поиск по **идентификаторам событий** *7023, 7024, 7025, 7028* и *1210* из **источника событий** *HealthService*.  Эти события указывают на то, что агент успешно получает конфигурацию от Azure Monitor и активно отслеживает компьютер. Описание события с ИДЕНТИФИКАТОРом 1210 также будет указываться в последней строке всех решений и аналитических сведений, включенных в область наблюдения за агентом.  

    ![Описание события с кодом 1210](./media/agent-windows-troubleshoot/event-id-1210-healthservice-01.png)

3. Если через несколько минут ожидаемые данные не отображаются в результатах запроса или визуализации, в зависимости от того, просматриваются ли данные из решения или из журнала событий *Operations Manager* , выполните поиск по **источникам событий** *HealthService* и *Служба работоспособности модулей* и отфильтруйте по *предупреждениям* и *ошибкам* на **уровне событий** , чтобы подтвердить, что события были записаны из следующей таблицы.

    |Идентификатор события |Источник |Описание |Решение |
    |---------|-------|------------|
    |8000 |Служба работоспособности |Это событие указывает, может ли рабочий процесс, связанный с производительностью, событием или другим собранным типом данных, не пересылаться в службу для приема в рабочую область. | Событие с ИДЕНТИФИКАТОРом 2136 из источника HealthService записывается вместе с этим событием и может означать, что агент не может связаться со службой, возможно, из-за неверной настройки параметров прокси-сервера и проверки подлинности, сбоя сети или сетевого брандмауэра или прокси-сервера, который не разрешает трафик TCP от компьютера к службе.| 
    |10102 и 10103 |Модули службы работоспособности |Рабочему процессу не удалось разрешить источник данных. |Это может произойти, если указанный счетчик производительности или экземпляр не существует на компьютере или неправильно определен в параметрах данных рабочей области. Если это [Счетчик производительности](data-sources-performance-counters.md#configuring-performance-counters), указанный пользователем, убедитесь, что указанная информация имеет правильный формат и существует на целевых компьютерах. |
    |26002 |Модули службы работоспособности |Рабочему процессу не удалось разрешить источник данных. |Это может произойти, если указанный журнал событий Windows не существует на компьютере. Эту ошибку можно спокойно игнорировать, если для компьютера не зарегистрирован этот журнал событий. в противном случае, если это заданный пользователем [журнал событий](data-sources-windows-events.md#configuring-windows-event-logs), убедитесь, что указана правильная информация. |
