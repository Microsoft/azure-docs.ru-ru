---
title: Настройка сбора данных для агента Azure Monitor (Предварительная версия)
description: Описание создания правила сбора данных для сбора данных из виртуальных машин с помощью агента Azure Monitor.
ms.topic: conceptual
author: bwren
ms.author: bwren
ms.date: 03/16/2021
ms.openlocfilehash: 73f7ab83ea15d223b76b9f71fde2f8a6a37bdacf
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "104586375"
---
# <a name="configure-data-collection-for-the-azure-monitor-agent-preview"></a>Настройка сбора данных для агента Azure Monitor (Предварительная версия)

Правила сбора данных (ДКР) определяют данные, поступающие в Azure Monitor, и указывают, куда они должны отправляться. В этой статье описывается создание правила сбора данных для сбора данных из виртуальных машин с помощью агента Azure Monitor.

Полное описание правил сбора данных см. [в разделе правила сбора данных в Azure Monitor (Предварительная версия)](data-collection-rule-overview.md).

> [!NOTE]
> В этой статье описывается, как настроить данные для виртуальных машин с помощью агента Azure Monitor, который в настоящее время находится на этапе предварительной версии. Описание агентов, которые являются общедоступными и как использовать их для получения данных, см. в разделе [Общие сведения об агентах Azure Monitor](agents-overview.md) .

## <a name="data-collection-rule-associations"></a>Связи правил сбора данных

Чтобы применить ДКР к виртуальной машине, создайте ассоциацию для виртуальной машины. Виртуальная машина может иметь связь с несколькими DCR, и у ДКР может быть несколько виртуальных машин, связанных с ней. Это позволяет определить набор DCR, каждый из которых соответствует определенному требованию, и применить их только к виртуальным машинам, в которых они применяются. 

Например, рассмотрим среду с набором виртуальных машин, на которых работает бизнес-приложение и другие, работающие SQL Server. Возможно, имеется одно правило сбора данных по умолчанию, которое применяется ко всем виртуальным машинам, а также к отдельным правилам сбора данных, которые собираются данные, предназначенные специально для бизнес-приложения и для SQL Server. Связи для виртуальных машин с правилами сбора данных будут выглядеть примерно так, как показано на следующей схеме.

![На схеме показаны виртуальные машины, на которых размещается бизнес-приложение, и SQL Server связанные с правилами сбора данных, которые называются "Центрально-я t-по умолчанию" и "бизнес-приложение для бизнеса", а также Центрально-я t-по умолчанию и s q l для SQL Server.](media/data-collection-rule-azure-monitor-agent/associations.png)



## <a name="create-rule-and-association-in-azure-portal"></a>Создание правила и ассоциации в портал Azure

Вы можете использовать портал Azure для создания правила сбора данных и связывания виртуальных машин в подписке с этим правилом. Агент Azure Monitor будет автоматически установлен и управляемое удостоверение, созданное для всех виртуальных машин, на которых он еще не установлен.

> [!IMPORTANT]
> В настоящее время существует известная ошибка, когда правило сбора данных создает управляемое удостоверение на виртуальной машине, для которой уже назначено управляемое удостоверение, назначенное пользователем удостоверение отключено.

В меню **Azure Monitor** в портал Azure выберите **правила сбора данных** в разделе **Параметры** . Нажмите кнопку **Добавить** , чтобы добавить новое правило и назначение сбора данных.

[![Правила сбора данных](media/data-collection-rule-azure-monitor-agent/data-collection-rules.png)](media/data-collection-rule-azure-monitor-agent/data-collection-rules.png#lightbox)

Нажмите кнопку **Добавить** , чтобы создать новое правило и набор ассоциаций. Укажите **имя правила** и укажите **подписку** и **группу ресурсов**. Указывает, где будет создан ДКР. Виртуальные машины и их ассоциации могут находиться в любой подписке или группе ресурсов в клиенте.

[![Основные сведения о правилах сбора данных](media/data-collection-rule-azure-monitor-agent/data-collection-rule-basics.png)](media/data-collection-rule-azure-monitor-agent/data-collection-rule-basics.png#lightbox)

На вкладке **виртуальные машины** добавьте виртуальные машины, для которых необходимо применить правило сбора данных. Должны быть перечислены как виртуальные машины Azure, так и серверы с поддержкой дуги Azure в вашей среде. Агент Azure Monitor будет установлен на виртуальных машинах, на которых он еще не установлен.

[![Виртуальные машины правил сбора данных](media/data-collection-rule-azure-monitor-agent/data-collection-rule-virtual-machines.png)](media/data-collection-rule-azure-monitor-agent/data-collection-rule-virtual-machines.png#lightbox)

На вкладке " **Получение и доставка** " щелкните **Добавить источник данных** , чтобы добавить источник данных и набор назначения. Выберите **тип источника данных**, и отобразятся соответствующие сведения для выбора. Для счетчиков производительности можно выбрать предопределенный набор объектов и частоту выборки. Для событий можно выбрать один из наборов журналов или средств и уровень серьезности. 

[![Базовый источник данных](media/data-collection-rule-azure-monitor-agent/data-collection-rule-data-source-basic.png)](media/data-collection-rule-azure-monitor-agent/data-collection-rule-data-source-basic.png#lightbox)


Чтобы указать другие журналы и счетчики производительности из [текущих поддерживаемых источников данных](azure-monitor-agent-overview.md#data-sources-and-destinations) или отфильтровать события с помощью запросов XPath, выберите **Пользовательский**. Затем можно указать [XPath ](https://www.w3schools.com/xml/xpath_syntax.asp) для всех конкретных значений, которые необходимо получить. Примеры см. в разделе [Sample ДКР](data-collection-rule-overview.md#sample-data-collection-rule) .

[![Пользовательский источник данных](media/data-collection-rule-azure-monitor-agent/data-collection-rule-data-source-custom.png)](media/data-collection-rule-azure-monitor-agent/data-collection-rule-data-source-custom.png#lightbox)

На вкладке **назначение** добавьте одно или несколько назначений для источника данных. Источники данных о событиях и системных журналах Windows могут отсылаться только в журналы Azure Monitor. Счетчики производительности могут отсылать как Azure Monitor метрики, так и журналы Azure Monitor.

[![Назначение](media/data-collection-rule-azure-monitor-agent/data-collection-rule-destination.png)](media/data-collection-rule-azure-monitor-agent/data-collection-rule-destination.png#lightbox)

Щелкните **Добавить источник данных** , а затем — **Обзор и создать** , чтобы проверить сведения о правиле сбора данных и сопоставлении с набором виртуальных машин. Нажмите кнопку **создать** , чтобы создать его.

> [!NOTE]
> После создания правила сбора данных и связей может потребоваться до 5 минут для отправки данных в назначения.

## <a name="limit-data-collection-with-custom-xpath-queries"></a>Ограничение сбора данных с помощью настраиваемых запросов XPath
Поскольку вы платите за любые данные, собранные в Log Analytics рабочей области, следует собирать только необходимые данные. Используя базовую конфигурацию в портал Azure, вы можете только иметь ограниченную возможность фильтровать события для собраний. Для журналов приложений и систем это все журналы с определенным уровнем серьезности. Для журналов безопасности это все успех аудита или все журналы сбоев аудита.

Чтобы указать дополнительные фильтры, необходимо использовать пользовательскую конфигурацию и указать XPath, который отфильтровывает ненужные события. Записи XPath записываются в форме `LogName!XPathQuery` . Например, может потребоваться возвратить только события из журнала событий приложения с ИДЕНТИФИКАТОРом события 1035. Методом xpathquery для этих событий — `*[System[EventID=1035]]` . Так как вы хотите получить события из журнала событий приложения, XPath будет выглядеть так: `Application!*[System[EventID=1035]]`

> [!TIP]
> Используйте командлет PowerShell `Get-WinEvent` с `FilterXPath` параметром для проверки допустимости методом xpathquery. В следующем сценарии показан пример.
> 
> ```powershell
> $XPath = '*[System[EventID=1035]]'
> Get-WinEvent -LogName 'Application' -FilterXPath $XPath
> ```
>
> - Если возвращаются события, запрос является допустимым.
> - При появлении сообщения *не найдены события, соответствующие указанным критериям выбора.* запрос может быть допустимым, но на локальном компьютере нет соответствующих событий.
> - Если получено сообщение о том, *что указанный запрос является недопустимым* , синтаксис запроса является недопустимым. 

В следующей таблице приведены примеры фильтрации событий с помощью пользовательского XPath.

| Описание |  XPath |
|:---|:---|
| Собираются только системные события с ИД события = 4648 |  `System!*[System[EventID=4648]]`
| Собирайте только системные события с ИД события = 4648 и именем процесса consent.exe |  `System!*[System[(EventID=4648) and (EventData[@Name='ProcessName']='C:\Windows\System32\consent.exe')]]`
| Собирайте все критические, ошибки, предупреждения и информационные события из журнала системных событий, за исключением события с ИД = 6 (загружен драйвер) |  `System!*[System[(Level=1 or Level=2 or Level=3) and (EventID != 6)]]` |
| Собирайте все события безопасности "успешно" и "сбой", за исключением события с ИДЕНТИФИКАТОРом 4624 (успешный вход) |  `Security!*[System[(band(Keywords,13510798882111488)) and (EventID != 4624)]]` |


## <a name="create-rule-and-association-using-rest-api"></a>Создание правила и ассоциации с помощью REST API

Выполните следующие действия, чтобы создать правило сбора данных и связи с помощью REST API.

1. Вручную создайте файл ДКР, используя формат JSON, показанный в [примере ДКР](data-collection-rule-overview.md#sample-data-collection-rule).

2. Создайте правило с помощью [REST API](/rest/api/monitor/datacollectionrules/create#examples).

3. Создайте ассоциацию для каждой виртуальной машины в правиле сбора данных с помощью [REST API](/rest/api/monitor/datacollectionruleassociations/create#examples).


## <a name="create-association-using-resource-manager-template"></a>Создание связи с помощью шаблона диспетчер ресурсов

Невозможно создать правило сбора данных с помощью шаблона диспетчер ресурсов, но можно создать связь между виртуальной машиной Azure или сервером с поддержкой ARC в Azure с помощью шаблона диспетчер ресурсов. Примеры шаблонов см. [в разделе Образцы шаблонов диспетчер ресурсов для правил сбора данных в Azure Monitor](./resource-manager-data-collection-rules.md) .



## <a name="next-steps"></a>Дальнейшие действия

- Дополнительные сведения об [агенте Azure Monitor](azure-monitor-agent-overview.md).
- Дополнительные сведения о [правилах сбора данных](data-collection-rule-overview.md).