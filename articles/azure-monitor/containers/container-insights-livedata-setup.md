---
title: Настройка динамических данных Container Insights (Предварительная версия) | Документация Майкрософт
description: В этой статье описывается, как настроить представление журналов контейнеров (stdout/stderr) и событий в режиме реального времени без использования kubectl с контейнером Insights.
ms.topic: conceptual
ms.date: 01/08/2020
ms.custom: references_regions
ms.openlocfilehash: 4302bdbb3d71c890f7fb0cfb82ab5f8d5aecbd43
ms.sourcegitcommit: c27a20b278f2ac758447418ea4c8c61e27927d6a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/03/2021
ms.locfileid: "101713785"
---
# <a name="how-to-set-up-the-live-data-preview-feature"></a>Настройка функции "Интерактивные данные (Предварительная версия)"

Чтобы просмотреть данные в режиме реального времени (Предварительная версия) со службой аналитики контейнеров из кластеров Azure Kubernetes Service (AKS), необходимо настроить проверку подлинности, чтобы предоставить разрешение на доступ к данным Kubernetes. Эта настройка безопасности обеспечивает доступ к данным в режиме реального времени через API Kubernetes непосредственно в портал Azure.

Эта функция поддерживает следующие методы управления доступом к журналам, событиям и метрикам.

- AKS без включенной авторизации Kubernetes RBAC;
- AKS со включенной авторизацией Kubernetes RBAC;
    - AKS, настроенный с привязкой к роли кластера **[клустермониторингусер](/rest/api/aks/managedclusters/listclustermonitoringusercredentials)**
- AKS с поддержкой единого входа Azure Active Directory (AD) на основе SAML

Для этих инструкций требуется административный доступ к кластеру Kubernetes, а при настройке на использование Azure Active Directory (AD) для проверки подлинности пользователей — административный доступ к Azure AD.

В этой статье объясняется, как настроить проверку подлинности для управления доступом к функции "Интерактивные данные (Предварительная версия)" из кластера.

- Kubernetes управления доступом на основе ролей (Kubernetes RBAC) с включенным кластером AKS
- Azure Active Directory интегрированный кластер AKS.


## <a name="authentication-model"></a>Модель проверки подлинности

Функции интерактивных данных (Предварительная версия) используют API Kubernetes, идентичный `kubectl` средству командной строки. Конечные точки API Kubernetes используют самозаверяющий сертификат, который браузер не сможет проверить. Эта функция использует внутренний прокси-сервер для проверки сертификата со службой AKS, гарантируя, что трафик является доверенным.

Портал Azure предложит проверить учетные данные входа для Azure Active Directory кластера и перенаправить вас на настройку регистрации клиента во время создания кластера (и повторно настроить в этой статье). Такое поведение аналогично процессу проверки подлинности, требуемому `kubectl` .

>[!NOTE]
>Авторизация в кластере управляется Kubernetes и моделью безопасности, с помощью которой она настроена. Пользователям, обращающимся к этой функции, требуется разрешение на загрузку конфигурации Kubernetes (*kubeconfig*), аналогичное запуску `az aks get-credentials -n {your cluster name} -g {your resource group}` . Этот файл конфигурации содержит маркер авторизации и проверки подлинности для **роли пользователя кластера Azure Kubernetes Service** в случае кластеров с поддержкой RBAC и AKS без включения авторизации Kubernetes RBAC. Он содержит сведения об Azure AD и сведения о регистрации клиента, когда AKS включается с помощью единого входа на основе SAML Azure Active Directory (AD).

>[!IMPORTANT]
>Пользователям этих функций требуется [роль пользователя кластера Azure Kubernetes](../../role-based-access-control/built-in-roles.md) в кластере, чтобы скачать `kubeconfig` и использовать эту функцию. Пользователям **не** требуется доступ участника к кластеру для использования этой функции.

## <a name="using-clustermonitoringuser-with-kubernetes-rbac-enabled-clusters"></a>Использование Клустермониторингусер с кластерами с поддержкой Kubernetes RBAC

Чтобы исключить необходимость применения дополнительных изменений конфигурации, чтобы разрешить привязку роли пользователя Kubernetes **клустерусер** доступ к функции интерактивных данных (Предварительная версия) после [включения авторизации RBAC Kubernetes](#configure-kubernetes-rbac-authorization) , AKS добавил новую привязку роли кластера Kubernetes с именем **клустермониторингусер**. Эта привязка роли кластера имеет все необходимые разрешения для доступа к API Kubernetes и конечные точки для использования функции интерактивных данных (Предварительная версия).

Чтобы использовать функцию интерактивных данных (Предварительная версия) с этим новым пользователем, необходимо быть членом роли пользователя или [участника](../../role-based-access-control/built-in-roles.md#contributor) [кластера службы Azure Kubernetes](../../role-based-access-control/built-in-roles.md#azure-kubernetes-service-cluster-user-role) в ресурсе кластера AKS. Аналитика контейнера, если она включена, настроена для проверки подлинности с использованием Клустермониторингусер по умолчанию. Если привязка роли Клустермониторингусер не существует в кластере, вместо нее используется **клустерусер** для проверки подлинности. Участник предоставляет доступ к Клустермониторингусер (если он существует) и пользователь кластера службы Куберенетес Azure предоставляет доступ к Клустерусер. Любая из этих двух ролей предоставляет достаточный доступ для использования этой функции.

AKS выпустил эту новую привязку роли в январе 2020, поэтому кластеры, созданные до 2020 января, не имеют. При наличии кластера, созданного до 2020 января, новый **клустермониторингусер** можно добавить в существующий кластер, выполнив операцию размещения в кластере или выполнив любую другую операцию в кластере, которая ВЫПОЛНЯЕТ операцию размещения в кластере, например обновление версии кластера.

## <a name="kubernetes-cluster-without-kubernetes-rbac-enabled"></a>Кластер Kubernetes без включения Kubernetes RBAC

Если для кластера Kubernetes не настроена авторизация Kubernetes RBAC или он не интегрирован с единым входом Azure AD, вам не нужно выполнять следующие действия. Это связано с тем, что у вас есть административные разрешения по умолчанию в конфигурации без RBAC.

## <a name="configure-kubernetes-rbac-authorization"></a>Настройка авторизации RBAC Kubernetes

При включении авторизации Kubernetes RBAC используются два пользователя: **клустерусер** и **клустерадмин** для доступа к API Kubernetes. Это похоже на выполнение `az aks get-credentials -n {cluster_name} -g {rg_name}` без административного параметра. Это означает, что **клустерусер** должен предоставить доступ к конечным точкам в API Kubernetes.

Ниже приведены шаги по настройке привязки роли кластера на основе этого YAML-файла с шаблоном конфигурации.

1. Скопируйте и вставьте YAML-файл, а затем сохраните его как LogReaderRBAC.yaml.

    ```
    apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRole
    metadata:
       name: containerHealth-log-reader
    rules:
        - apiGroups: ["", "metrics.k8s.io", "extensions", "apps"]
          resources:
             - "pods/log"
             - "events"
             - "nodes"
             - "pods"
             - "deployments"
             - "replicasets"
          verbs: ["get", "list"]
    ---
    apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRoleBinding
    metadata:
       name: containerHealth-read-logs-global
    roleRef:
       kind: ClusterRole
       name: containerHealth-log-reader
       apiGroup: rbac.authorization.k8s.io
    subjects:
    - kind: User
      name: clusterUser
      apiGroup: rbac.authorization.k8s.io
    ```

2. Чтобы обновить конфигурацию, выполните следующую команду: `kubectl apply -f LogReaderRBAC.yaml` .

>[!NOTE]
> Если вы применили предыдущую версию `LogReaderRBAC.yaml` файла к кластеру, обновите ее, скопировав и вставляя новый код, показанный на шаге 1 выше, а затем выполните команду, показанную на шаге 2, чтобы применить ее к кластеру.

## <a name="configure-ad-integrated-authentication"></a>Настройка встроенной проверки подлинности Active Directory

В кластере AKS, настроенном для использования Azure Active Directory (AD) для проверки подлинности пользователей, используются учетные данные для входа пользователя, обращающегося к этой функции. В этой конфигурации вы можете войти в кластер AKS с помощью токена проверки подлинности Azure AD.

Чтобы разрешить портал Azure перенаправить страницы авторизации в качестве доверенного URL-адреса перенаправления, необходимо повторно настроить регистрацию клиента Azure AD. Пользователи из Azure AD получают доступ непосредственно к тем же конечным точкам API Kubernetes через **клустерролес** и **клустерролебиндингс**.

Дополнительные сведения о настройке расширенной безопасности в Kubernetes см. в [документации по Kubernetes](https://kubernetes.io/docs/reference/access-authn-authz/rbac/).

>[!NOTE]
>Если вы создаете новый кластер с поддержкой Kubernetes RBAC, см. статью [интеграция Azure Active Directory со службой Kubernetes Azure](../../aks/azure-ad-integration-cli.md) и выполните действия по настройке проверки подлинности Azure AD. В ходе действий по созданию клиентского приложения Обратите внимание на два URL-адреса перенаправления, которые необходимо создать для аналитики контейнеров, совпадающие с указанными в шаге 3 ниже.

### <a name="client-registration-reconfiguration"></a>Перенастройка регистрации клиента

1. Выберите регистрацию клиента для кластера Kubernetes в Azure AD в разделе **Azure Active Directory > регистрация приложений** в портал Azure.

2. На панели слева выберите **Проверка подлинности** .

3. Добавьте два URL-адреса перенаправления в этот список в качестве типов **веб-** приложений. Первый базовый URL-адрес должен иметь значение `https://afd.hosting.portal.azure.net/monitoring/Content/iframe/infrainsights.app/web/base-libs/auth/auth.html` , а второй базовый URL-адрес должен иметь значение `https://monitoring.hosting.portal.azure.net/monitoring/Content/iframe/infrainsights.app/web/base-libs/auth/auth.html` .

    >[!NOTE]
    >Если вы используете эту функцию в Azure для Китая, то первым базовым URL-адресом должно быть, `https://afd.hosting.azureportal.chinaloudapi.cn/monitoring/Content/iframe/infrainsights.app/web/base-libs/auth/auth.html` а со вторым базовым URL-адресом должно быть `https://monitoring.hosting.azureportal.chinaloudapi.cn/monitoring/Content/iframe/infrainsights.app/web/base-libs/auth/auth.html` .

4. После регистрации URL-адресов перенаправления в разделе **неявное предоставление** выберите параметры **маркеры доступа** и **маркеры идентификации** , а затем сохраните изменения.

>[!NOTE]
>Настройка проверки подлинности с помощью Azure Active Directory для единого входа может быть выполнена только во время первоначального развертывания нового кластера AKS. Настроить единый вход для кластера AKS, который уже развернут, невозможно.

>[!IMPORTANT]
>Если вы настроили Azure AD для проверки подлинности пользователя с помощью обновленного URI, очистите кэш браузера, чтобы убедиться, что обновленный маркер проверки подлинности скачан и применен.

## <a name="grant-permission"></a>Предоставление разрешения

Каждой учетной записи Azure AD должно быть предоставлено разрешение на доступ к соответствующим API-интерфейсам в Kubernetes для доступа к функции интерактивных данных (Предварительная версия). Действия по предоставлению учетной записи Azure Active Directory похожи на шаги, описанные в разделе [Проверка подлинности KUBERNETES RBAC](#configure-kubernetes-rbac-authorization) . Перед применением шаблона конфигурации YAML к кластеру замените **клустерусер** в **клустерролебиндинг** на нужного пользователя.

>[!IMPORTANT]
>Если пользователь, которому вы предоставляете привязку Kubernetes RBAC для, находится в том же клиенте Azure AD, назначьте разрешения на основе userPrincipalName. Если пользователь находится в другом клиенте Azure AD, запросите и используйте свойство objectId.

Дополнительные сведения о настройке **клустерролебиндинг** кластера AKS см. в статье [Создание привязки RBAC Kubernetes](../../aks/azure-ad-integration-cli.md#create-kubernetes-rbac-binding).

## <a name="next-steps"></a>Дальнейшие действия

Теперь, когда вы настроили проверку подлинности, вы можете просматривать в кластере [метрики](container-insights-livedata-metrics.md), [развертывания](container-insights-livedata-deployments.md), [события и журналы](container-insights-livedata-overview.md) в реальном времени.
