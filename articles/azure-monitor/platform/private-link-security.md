---
title: Использование Приватного канала Azure для безопасного подключения сетей к Azure Monitor
description: Использование Приватного канала Azure для безопасного подключения сетей к Azure Monitor
author: noakup
ms.author: noakuper
ms.topic: conceptual
ms.date: 10/05/2020
ms.subservice: ''
ms.openlocfilehash: 637e66956eadf57199d2e5191368d6355e2cd118
ms.sourcegitcommit: 2f9f306fa5224595fa5f8ec6af498a0df4de08a8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/28/2021
ms.locfileid: "98941896"
---
# <a name="use-azure-private-link-to-securely-connect-networks-to-azure-monitor"></a>Использование Приватного канала Azure для безопасного подключения сетей к Azure Monitor

[Приватный канал Azure](../../private-link/private-link-overview.md) позволяет безопасно связать службы Azure PaaS с виртуальной сетью с помощью частных конечных точек. Для многих служб достаточно настроить конечную точку для каждого ресурса. Однако Azure Monitor — это совокупность различных взаимосвязанных служб, которые работают вместе для отслеживания рабочих нагрузок. В результате мы создали ресурс, называемый областью Приватного канала Azure Monitor (AMPLS), который позволяет определить границы сети мониторинга и подключиться к виртуальной сети. В этой статье описано, когда использовать и как настроить область Приватного канала Azure Monitor.

## <a name="advantages"></a>Преимущества

Приватный канал предоставляет следующие возможности:

- Частное подключение к Azure Monitor без открытия доступа к общедоступной сети
- Обеспечение доступа к данным мониторинга только через разрешенные частные сети
- Предотвращение кражи данных из частных сетей путем определения конкретных Azure Monitor ресурсов, подключающихся через вашу частную конечную точку
- Безопасное подключение частной локальной сети к Azure Monitor с помощью ExpressRoute и Приватного канала
- Удержание всего трафика внутри магистральной сети Microsoft Azure

Дополнительные сведения см. в разделе [Основные преимущества Приватного канала](../../private-link/private-link-overview.md#key-benefits).

## <a name="how-it-works"></a>Принцип работы

Область Приватного канала Azure Monitor представляет собой ресурс группирования для подключения одной или нескольких частных конечных точек (и, следовательно, виртуальных сетей, в которых они содержатся) к одному или нескольким ресурсам Azure Monitor. Эти ресурсы включают рабочие области Log Analytics и компоненты Application Insights.

![Схема топологии ресурсов](./media/private-link-security/private-link-topology-1.png)

> [!NOTE]
> Один ресурс Azure Monitor может принадлежать нескольким областям AMPLS, но одну виртуальную сеть невозможно подключить к нескольким AMPLS. 

## <a name="planning-based-on-your-network"></a>Планирование с учетом сети

Перед настройкой ресурсов AMPLS примите во внимание требования к изоляции сети. Оцените доступ виртуальных сетей к общедоступному Интернету и ограничения доступа для каждого из ресурсов Azure Monitor (то есть компонентов Application Insights и рабочих областей Log Analytics).

> [!NOTE]
> Сети периферийных серверов или любая другая топология одноранговых сетей могут настроить частную связь между внутренней виртуальной сетью (основной) и соответствующими Azure Monitor ресурсами вместо настройки частной связи для каждой виртуальной сети. Это имеет смысл, особенно если Azure Monitor ресурсы, используемые этими сетями, являются общими. Однако если вы хотите разрешить каждой виртуальной сети доступ к отдельному набору ресурсов мониторинга, создайте закрытую ссылку на выделенный АМПЛС для каждой сети.

### <a name="evaluate-which-virtual-networks-should-connect-to-a-private-link"></a>Оценка того, какие виртуальные сети должны подключаться к Приватному каналу

Начните с оценки того, какие из ваших виртуальных сетей имеют ограниченный доступ к Интернету. Виртуальные сети со свободным доступом в Интернет могут не нуждаться в Приватном канале для доступа к ресурсам Azure Monitor. Ресурсы мониторинга, к которым подключаются виртуальные сети, могут ограничивать входящий трафик и требовать подключение через Приватный канал (для приема журнала или запроса). В таких случаях даже виртуальная сеть, имеющая доступ к общедоступному Интернету, должна подключаться к этим ресурсам через Приватный канал и область AMPLS.

### <a name="evaluate-which-azure-monitor-resources-should-have-a-private-link"></a>Оценка того, какие ресурсы Azure Monitor должны иметь Приватный канал

Изучите каждый из ресурсов Azure Monitor:

- Должен ли ресурс разрешать прием журналов из ресурсов, расположенных только в конкретных виртуальных сетях?
- Должны ли ресурсы запрашиваться только клиентами, расположенными в конкретных виртуальных сетях?

Если ответ на любой из этих вопросов является положительным, задайте ограничения, как описано в разделах [Настройка рабочих областей Log Analytics](#configure-log-analytics) и [Настройка компонентов Application Insights](#configure-application-insights), и свяжите эти ресурсы с одной или несколькими AMPLS. Виртуальным сетям, которые должны обращаться к этим ресурсам мониторинга, необходима частная конечная точка, которая подключается к соответствующей AMPLS.
Помните, что вы можете подключить одни и те же рабочие области или приложения к нескольким AMPLS, чтобы обеспечить их доступность для различных сетей.

### <a name="group-together-monitoring-resources-by-network-accessibility"></a>Группировка ресурсов мониторинга по доступности сети

Так как каждая виртуальная сеть может подключаться только к одному ресурсу AMPLS, необходимо сгруппировать все ресурсы мониторинга, которые должны быть доступны для одних и тех же сетей. Самый простой способ управлять такой группировкой — создать по одной AMPLS на виртуальную сеть и выбрать ресурсы для подключения к этой сети. Однако для сокращения ресурсов и улучшения управляемости может потребоваться повторное использование AMPLS для сетей.

Например, если внутренние виртуальные сети "VNet1" и "VNet2" должны подключаться к рабочим областям "Workspace1" и "Workspace2" и компоненту Application Insights "Application Insights 3", свяжите все три ресурса с одной AMPLS. Если "VNet3" должна обращаться только к "Workspace1", создайте другой ресурс AMPLS, свяжите с ним "Workspace1" и подключите "VNet3", как показано на следующих схемах:

![Схема топологии AMPLS A](./media/private-link-security/ampls-topology-a-1.png)

![Схема топологии AMPLS B](./media/private-link-security/ampls-topology-b-1.png)

### <a name="consider-limits"></a>Рассмотрите ограничения

При планировании настройки частного канала следует учитывать ряд ограничений.

* Виртуальная сеть может подключаться только к одному объекту АМПЛС. Это означает, что объект АМПЛС должен предоставлять доступ ко всем ресурсам Azure Monitor, к которым виртуальная сеть должна иметь доступ.
* Ресурс Azure Monitor (Рабочая область или компонент Application Insights) может подключиться не более чем к 5 Амплсс.
* Объект АМПЛС может подключаться к ресурсам 50 Azure Monitor.
* В большинстве случаев объект АМПЛС может подключаться к 10 частным конечным точкам.

В следующей топологии:
* Каждая виртуальная сеть подключается только к **одному** объекту амплс.
* АМПЛС B подключен к частным конечным точкам двух виртуальных сетей (VNet2 и VNet3) с использованием 2/10 (20%) возможных подключений к частным конечным точкам.
* АМПЛС A подключается к двум рабочим областям и одному компоненту Application Insights, используя 3/50 (6%) возможных Azure Monitorных подключений.
* Workspace2 подключается к АМПЛС A и АМПЛС B с помощью 2/5 (40%) из возможных АМПЛС соединений.

![Схема ограничений АМПЛС](./media/private-link-security/ampls-limits.png)

> [!NOTE]
> В некоторых сетевых топологиях (в основном на основе концентратора) вы можете быстро достичь 10 виртуальных сетей ограничения для одного АМПЛС. В таких случаях рекомендуется использовать соединение общего частного соединения вместо отдельных. Создайте одну частную конечную точку в сети концентратора, свяжите ее с АМПЛС и одноранговыми соответствующими сетями с сетью концентратора.

![Hub-and-лучевой-Single-PE](./media/private-link-security/hub-and-spoke-with-single-private-endpoint.png)

## <a name="example-connection"></a>Пример подключения

Начните с создания ресурса области Приватного канала Azure Monitor.

1. Перейдите в раздел **Создание ресурса** на портале Azure и выполните поиск фразы **область Приватного канала Azure Monitor**.

   ![Поиск Azure Monitor области частной ссылки](./media/private-link-security/ampls-find-1c.png)

2. Щелкните **Create** (Создать).
3. Выберите подписку и группу ресурсов.
4. Присвойте области AMPLS имя. Лучше использовать такое имя, которое ясно показывает, какое назначение и границы безопасности будет иметь область, чтобы пользователь случайно не нарушил границы безопасности сети. Например, "AppServerProdTelem".
5. Щелкните **Просмотр и создание**. 

   ![Создание Azure Monitor области частной ссылки](./media/private-link-security/ampls-create-1d.png)

6. Дождитесь окончания проверки, а затем щелкните **Создать**.

### <a name="connect-azure-monitor-resources"></a>Подключение к ресурсам Azure Monitor

Подключите Azure Monitor ресурсы (рабочие области Log Analytics и компоненты Application Insights) к АМПЛС.

1. В области Приватного канала Azure Monitor щелкните **Ресурсы Azure Monitor** в меню слева. Нажмите кнопку **Добавить**.
2. Добавьте рабочую область или компонент. При нажатии кнопки **Добавить** открывается диалоговое окно, где можно выбрать ресурсы Azure Monitor. Вы можете просмотреть свои подписки и группы ресурсов, а также ввести их имя для фильтрации. Выберите рабочую область или компонент и нажмите кнопку **Применить**, чтобы добавить их в область.

    ![Снимок экрана: выбор области взаимодействия с пользователем](./media/private-link-security/ampls-select-2.png)

> [!NOTE]
> Для удаления ресурсов Azure Monitor необходимо сначала отключить их от всех объектов АМПЛС, к которым они подключены. Невозможно удалить ресурсы, подключенные к АМПЛС.

### <a name="connect-to-a-private-endpoint"></a>Подключение к частной конечной точке

Теперь, когда у вас есть ресурсы, подключенные к AMPLS, создайте частную конечную точку для подключения к нашей сети. Эту задачу можно выполнить в [центре Приватных каналов на портале Azure](https://portal.azure.com/#blade/Microsoft_Azure_Network/PrivateLinkCenterBlade/privateendpoints) или внутри области Приватного канала Azure Monitor, как это сделано в данном примере.

1. В ресурсе области щелкните **Подключения к частной конечной точке** в меню ресурсов слева. Щелкните **Частная конечная точка**, чтобы запустить процесс создания конечной точки. Здесь вы также можете утверждать подключения, которые были запущены в центре Приватных каналов, выбрав их и щелкнув **Утвердить**.

    ![Снимок экрана: интерфейс частных конечных точек](./media/private-link-security/ampls-select-private-endpoint-connect-3.png)

2. Выберите подписку, группу ресурсов и имя конечной точки, а также регион, в котором она должна находиться. Регион должен быть тем же регионом, где находится виртуальная сеть, к которой вы будете осуществлять подключение.

3. Щелкните **Далее: Ресурс**. 

4. На экране ресурса

   а. Выберите **подписку**, которая содержит ресурс частной области Azure Monitor. 

   b. Для **типа ресурсов** выберите **Microsoft.insights/privateLinkScopes**. 

   c. В раскрывающемся списке **ресурсов** выберите созданную ранее область Приватного канала. 

   d. Щелкните **Далее: Конфигурация >** .
      ![Снимок экрана: выбор параметра "Создать частную конечную точку"](./media/private-link-security/ampls-select-private-endpoint-create-4.png)

5. В области конфигурации

   а.    Выберите **виртуальную сеть** и **подсеть**, которые нужно подключить к ресурсам Azure Monitor. 
 
   b.    Выберите **Да** для параметра **Интеграция с частной зоной DNS** и позвольте системе автоматически создать новую частную зону DNS. Фактические зоны DNS могут отличаться от тех, которые показаны на снимке экрана ниже. 
   > [!NOTE]
   > Если вы выберете " **нет** " и предпочитаете управлять записями DNS вручную, сначала завершите настройку частной ссылки, включая эту частную конечную точку и конфигурацию амплс. Затем настройте DNS в соответствии с инструкциями в статье о [конфигурации DNS для частной конечной точки Azure](../../private-link/private-endpoint-dns.md). Не создавайте пустые записи при подготовке к настройке Приватного канала. Создаваемые записи DNS могут переопределить имеющиеся параметры и повлиять на подключение к Azure Monitor.
 
   c.    Щелкните **Review + create** (Просмотреть и создать).
 
   d.    Дождитесь завершения проверки. 
 
   д)    Нажмите кнопку **Создать**. 

    ![Снимок экрана: выбор параметра "Создать частную конечную точку"](./media/private-link-security/ampls-select-private-endpoint-create-5.png)

Вы создали частную конечную точку, подключенную к этой области Приватного канала Azure Monitor.

## <a name="configure-log-analytics"></a>Настройка Log Analytics

Перейдите на портал Azure. В ресурсе рабочей области Log Analytics в левой части элемента меню находится **Сетевая изоляция** . Из этого меню можно управлять двумя разными состояниями.

![Сетевая изоляция Log Analytics](./media/private-link-security/ampls-log-analytics-lan-network-isolation-6.png)

### <a name="connected-azure-monitor-private-link-scopes"></a>Подключенные Azure Monitor области закрытых ссылок
На этом экране отображаются все области, подключенные к этой рабочей области. Подключение к областям (Амплсс) позволяет получить сетевой трафик из виртуальной сети, подключенной к каждому АМПЛС, чтобы достичь этой рабочей области. Создание подключения с помощью этой оснастки дает тот же результат, что и настройка в области, так же как и при [подключении Azure Monitorных ресурсов](#connect-azure-monitor-resources). Чтобы добавить новое соединение, нажмите кнопку **Добавить** и выберите область Azure Monitor закрытая ссылка. Нажмите кнопку **Применить** для подключения. Обратите внимание, что Рабочая область может подключаться к 5 объектам АМПЛС, как описано в разделах [ограничения](#consider-limits). 

### <a name="access-from-outside-of-private-links-scopes"></a>Доступ за пределами областей закрытых ссылок
Параметры в нижней части этой страницы контролируют доступ из общедоступных сетей, что означает сети, не подключенные через указанные выше области. Если задать значение **Нет** для параметра **Allow public network access for ingestion** (Разрешить доступ из общедоступных сетей для приема), то компьютеры за пределами подключенных областей не смогут отправлять данные в эту рабочую область. Если задать для параметра **Разрешить доступ к общедоступной сети для запросов** значение **нет**, компьютеры за пределами областей не смогут получить доступ к данным в этой рабочей области, то есть не смогут запрашивать данные рабочей области. Это включает запросы в книгах, панели мониторинга, интерфейсы клиентов на основе API, аналитические сведения в портал Azure и многое другое. Возможности, выполняемые за пределами портал Azure, и запрос Log Analytics данных также должны выполняться в частной связанной виртуальной сети.

### <a name="exceptions"></a>Исключения
Ограничение доступа, описанное выше, не применяется к Azure Resource Manager и, следовательно, имеет следующие ограничения.
* Доступ к данным. в то время как блокирование или разрешение запросов из общедоступных сетей к большинству Log Analytics, некоторые возможности запроса данных с помощью Azure Resource Manager и, следовательно, не смогут запрашивать данные, если в диспетчер ресурсов также не применяются параметры закрытой связи (ожидается компонент). К ним относятся, например, Azure Monitor решения, книги и аналитические сведения, а также соединитель LogicApp.
* Управление рабочими областями. изменение параметров рабочей области и конфигурации (включая включение и отключение этих параметров доступа) осуществляется с помощью Azure Resource Manager. Ограничьте доступ к управлению рабочими областями, используя соответствующие роли, разрешения, сетевые элементы управления и аудит. Дополнительные сведения см. в разделе [Роли, разрешения и безопасность Azure Monitor](roles-permissions-security.md).

> [!NOTE]
> Журналы и метрики, отправленные в рабочую область с помощью функции [Параметры диагностики](diagnostic-settings.md), передаются по защищенному частному каналу Майкрософт и не регулируются этими параметрами.

### <a name="log-analytics-solution-packs-download"></a>Загрузка пакетов решений Log Analytics

Чтобы разрешить агенту Log Analytics скачивать пакеты решений, добавьте соответствующие полные доменные имена в список разрешений брандмауэра. 


| Облачная среда | Ресурс агента | порты; | Направление |
|:--|:--|:--|:--|
|Azure Public     | scadvisorcontent.blob.core.windows.net         | 443 | Исходящие
|Azure для государственных организаций | usbn1oicore.blob.core.usgovcloudapi.net | 443 |  Исходящие
|Azure China 21Vianet      | mceast2oicore.blob.core.chinacloudapi.cn| 443 | Исходящие

## <a name="configure-application-insights"></a>Настройка Application Insights

Перейдите на портал Azure. В ресурсе компонента Application Insights Azure Monitor слева находится пункт меню **Сетевая изоляция**. Из этого меню можно управлять двумя разными состояниями.

![Сетевая изоляция Application Insights](./media/private-link-security/ampls-application-insights-lan-network-isolation-6.png)

Сначала можно подключить этот ресурс Application Insights к областям Приватного канала Azure Monitor, к которым у вас есть доступ. Нажмите кнопку **Добавить** и выберите **область Приватного канала Azure Monitor**. Нажмите кнопку "Применить" для подключения. На этом экране отображаются все подключенные области. Установка этого подключения позволяет сетевому трафику в подключенных виртуальных сетях достигать этого компонента. Такое подключение дает тот же результат, что и подключение из области, как было сделано в разделе [Подключение к ресурсам Azure Monitor](#connect-azure-monitor-resources). 

Во-вторых, вы можете управлять доступом к этому ресурсу извне перечисленных выше областей Приватного канала. Если задать значение **Нет** для параметра **Allow public network access for ingestion** (Разрешить доступ из общедоступных сетей для приема), то компьютеры или пакеты SDK за пределами подключенных областей не смогут отправлять данные в этот компонент. Если задать значение **Нет** для параметра **Allow public network access for queries** (Разрешить доступ из общедоступных сетей для запросов), то компьютеры за пределами областей не смогут обращаться к данным в этом ресурсе Application Insights. Эти данные включают доступ к журналам APM, метрикам и Live Metrics Stream, а также основанным на них процедурам, таким как книги, панели мониторинга, клиентские процедуры на основе API запросов, аналитика на портале Azure и многое другое. 

Обратите внимание, что процедуры, не использующие портал, также должны выполняться в виртуальной сети с Приватным каналом, включающей отслеживаемые рабочие нагрузки. 

Вам потребуется добавить ресурсы, содержащие отслеживаемые рабочие нагрузки, в Приватный канал. [Здесь](../../app-service/networking/private-endpoint.md) приведена документация о том, как это сделать для служб приложений.

Подобное ограничение доступа применяется только к данным в ресурсе Application Insights. Изменения конфигурации, включая включение и отключение этих параметров доступа, управляются Azure Resource Manager. Вместо этого ограничьте доступ к Resource Manager с помощью соответствующих ролей, разрешений, сетевых элементов управления и аудита. Дополнительные сведения см. в разделе [Роли, разрешения и безопасность Azure Monitor](roles-permissions-security.md).

> [!NOTE]
> Чтобы полностью защитить Application Insights на основе рабочих областей, необходимо заблокировать доступ к ресурсу Application Insights, а также к базовой рабочей области Log Analytics.
>
> Диагностика на уровне кода (профилировщик или отладчик) требуют предоставления собственной учетной записи хранения для поддержки частной ссылки. Ниже приведена [Документация](../app/profiler-bring-your-own-storage.md) по этому способу.

## <a name="use-apis-and-command-line"></a>Использование API и командной строки

Процесс, описанный выше, можно автоматизировать с помощью шаблонов Azure Resource Manager, интерфейсов RESTFUL и командной строки.

Чтобы создать области частной связи и управлять ими, используйте [REST API](/rest/api/monitor/private%20link%20scopes%20(preview)) или [Azure CLI (AZ отслеживать частную ссылку на область)](/cli/azure/monitor/private-link-scope).

Для управления доступом к сети используйте флаги `[--ingestion-access {Disabled, Enabled}]` и `[--query-access {Disabled, Enabled}]` в [рабочих областях Log Analytics](/cli/azure/monitor/log-analytics/workspace) или [компонентах Application Insights](/cli/azure/ext/application-insights/monitor/app-insights/component).

## <a name="collect-custom-logs-over-private-link"></a>Получение пользовательских журналов по частной ссылке

Учетные записи хранения используются в процессе приема пользовательских журналов. По умолчанию используются учетные записи хранения, управляемые службой. Однако для приема пользовательских журналов через приватные каналы необходимо использовать собственные учетные записи хранения и связать их с рабочими областями Log Analytics. Дополнительные сведения о настройке таких учетных записей см. в разделе об [использовании командной строки](/cli/azure/monitor/log-analytics/workspace/linked-storage).

Дополнительные сведения об использовании собственной учетной записи хранения см. в разделе [Принадлежащие заказчику учетные записи хранения для приема журналов](private-storage.md).

## <a name="restrictions-and-limitations"></a>Ограничения

### <a name="agents"></a>Агенты

Последние версии агентов Windows и Linux должны использоваться в частных сетях для обеспечения безопасного приема данных в Log Analytics рабочих областях. Более старые версии не могут отправлять данные мониторинга в частную сеть.

**Агент Log Analytics для Windows**

Используйте Log Analytics агента версии 10.20.18038.0 или более поздней.

**Агент Log Analytics для Linux**

Используйте агент версии 1.12.25 или более поздней. Если вы не можете сделать это, выполните на виртуальной машине приведенные ниже команды.

```cmd
$ sudo /opt/microsoft/omsagent/bin/omsadmin.sh -X
$ sudo /opt/microsoft/omsagent/bin/omsadmin.sh -w <workspace id> -s <workspace key>
```

### <a name="azure-portal"></a>Портал Azure

Чтобы использовать такие функции на портале Azure Monitor, как Application Insights и Log Analytics, необходимо разрешить доступ к порталу Azure и расширениям Azure Monitor в частных сетях. Добавьте теги **AzureActiveDirectory**, **AzureResourceManager**, **азурефронтдур. фирстпарти** и **Азурефронтдур. интерфейсной** [службы](../../firewall/service-tags.md) в группу безопасности сети.

### <a name="programmatic-access"></a>Программный доступ

Чтобы использовать REST API, [CLI](/cli/azure/monitor) или PowerShell с Azure Monitor в частных сетях, добавьте в свой брандмауэр [теги службы](../../virtual-network/service-tags-overview.md) **AzureActiveDirectory** и **AzureResourceManager**.

Добавление этих тегов позволяет выполнять такие действия, как запрос данных журнала, создание рабочих областей Log Analytics и компонентов искусственного интеллекта и управление ими.

### <a name="application-insights-sdk-downloads-from-a-content-delivery-network"></a>Скачивание пакета SDK Application Insights из сети доставки содержимого

Упакуйте код JavaScript в сценарий, чтобы браузер не пытался скачать код из CDN. Пример приведен на сайте [GitHub](https://github.com/microsoft/ApplicationInsights-JS#npm-setup-ignore-if-using-snippet-setup)

### <a name="browser-dns-settings"></a>Параметры DNS браузера

Если вы подключаетесь к ресурсам Azure Monitor по частной ссылке, трафик к этому ресурсу должен пройти через закрытую конечную точку, настроенную в сети. Чтобы включить частную конечную точку, обновите параметры DNS, как описано в [подсоединении к частной конечной точке](#connect-to-a-private-endpoint). Некоторые браузеры используют собственные параметры DNS вместо заданных. Браузер может попытаться подключиться к Azure Monitor общедоступным конечным точкам и полностью обойти частную ссылку. Убедитесь, что параметры браузера не переопределяют или кэшируют старые параметры DNS. 

## <a name="next-steps"></a>Дальнейшие действия

- Сведения о [закрытом хранилище](private-storage.md)
