---
title: Создание параметров диагностики для отправки журналов платформы и метрик в различные места назначения
description: Отправляйте Azure Monitor метрики платформы и журналы для Azure Monitor журналов, службы хранилища Azure или концентраторов событий Azure с помощью параметра диагностики.
author: bwren
ms.author: bwren
services: azure-monitor
ms.topic: conceptual
ms.date: 04/27/2020
ms.subservice: logs
ms.openlocfilehash: a6f8e681f68fb53d7cf88582b4bf4416efc11c86
ms.sourcegitcommit: 2501fe97400e16f4008449abd1dd6e000973a174
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/08/2021
ms.locfileid: "99820557"
---
# <a name="create-diagnostic-settings-to-send-platform-logs-and-metrics-to-different-destinations"></a>Создание параметров диагностики для отправки журналов платформы и метрик в различные места назначения
[Журналы платформы](platform-logs-overview.md) в Azure, в том числе журнал действий Azure и журналы ресурсов, предоставляют подробные сведения о диагностике и аудите для ресурсов Azure и платформы Azure, от которых они зависят. [Метрики платформы](data-platform-metrics.md) собираются по умолчанию и обычно хранятся в базе данных метрик Azure Monitor. В этой статье приведены сведения о создании и настройке параметров диагностики для отправки метрик и журналов платформы в разные назначения.

> [!IMPORTANT]
> Перед созданием параметра диагностики для журнала действий необходимо сначала отключить все устаревшие конфигурации. Дополнительные сведения см. в разделе [устаревшие методы сбора](activity-log.md#legacy-collection-methods) .

Для каждого ресурса Azure требуется собственный параметр диагностики, который определяет следующие критерии:

- Категории журналов и данных метрики, отправляемых по назначениям, указанным в параметре. Доступные категории будут отличаться для разных типов ресурсов.
- Одно или несколько назначений для отправки журналов. Текущие назначения включают в себя рабочую область Log Analytics, Центры событий и службу хранилища Azure.

Один параметр диагностики может определять не более одного из этих назначений. Если необходимо отправить данные в места назначения нескольких типов (например, в две разные рабочие области Log Analytics), создайте несколько параметров. Каждый ресурс может иметь до 5 параметров диагностики.

В следующем видео описано, как выполнить маршрутизацию журналов платформы с помощью параметров диагностики.
> [!VIDEO https://www.microsoft.com/en-us/videoplayer/embed/RE4AvVO]

> [!NOTE]
> [Метрики платформы](metrics-supported.md) отправляются автоматически [Azure Monitor метриках](data-platform-metrics.md). Параметры диагностики можно использовать для отправки метрик для определенных служб Azure в журналы Azure Monitor для анализа с другими данными мониторинга с помощью [запросов журнала](../log-query/log-query-overview.md) с определенными ограничениями. 
>  
>  
> Отправка многомерных метрик с помощью параметров диагностики сейчас не поддерживается. Метрики с измерениями экспортируются как преобразованные в плоскую структуру одномерные метрики, агрегированные по значениям измерений. *Например*, метрику "иореадбитес" на блокчейн можно исследовать и распланировать на уровне каждого узла. Однако при экспорте с помощью параметров диагностики метрика экспорта представляется как все считанные байты для всех узлов. Кроме того, из-за внутренних ограничений не все метрики можно экспортировать в Azure Monitor журналы и Log Analytics. Дополнительные сведения см. в [списке метрик, которые вы экспортируете](metrics-supported-export-diagnostic-settings.md). 
>  
>  
> Чтобы обойти эти ограничения для конкретных метрик, мы рекомендуем вручную извлечь их с помощью [метрик REST API](/rest/api/monitor/metrics/list) и импортировать их в журналы Azure Monitor с помощью [Azure Monitor API сборщика данных](data-collector-api.md).  


## <a name="destinations"></a>Места назначения
Журналы и метрики платформы могут быть отправлены в назначения, приведенные в следующей таблице. 

| Назначение | Описание |
|:---|:---|
| [Рабочая область Log Analytics](design-logs-deployment.md) | Отправка журналов и метрик в Log Analytics рабочую область позволяет анализировать их с помощью других данных мониторинга, собираемых Azure Monitor используя мощные запросы журналов, а также использовать другие функции Azure Monitor, такие как оповещения и визуализации. |
| [Центры событий](../../event-hubs/index.yml) | Отправка журналов и метрик в концентраторы событий позволяет передавать данные в внешние системы, такие как сторонние решения Siem и другие решения log Analytics.  |
| [Учетная запись хранения Azure](../../storage/blobs/index.yml) | Архивирование журналов и метрик в учетную запись хранения Azure полезно для аудита, статического анализа или резервного копирования. По сравнению с журналами Azure Monitor и Log Analytics рабочей областью Служба хранилища Azure менее затратна, а журналы могут храниться в неопределенном сроке.  |


### <a name="destination-requirements"></a>Требования к месту назначения

Перед созданием параметров диагностики необходимо создать все назначения для параметра диагностики. Назначение не обязательно должно находиться в той же подписке, что и журнал, отправляющий журналы, если пользователь, который настраивает этот параметр, имеет соответствующий доступ к обеим подпискам в Azure RBAC. В следующей таблице приведены уникальные требования к каждому назначению, включая региональные ограничения.

| Назначение | Требования |
|:---|:---|
| Рабочая область Log Analytics | Рабочая область не обязательно должна находиться в том же регионе, что и отслеживаемый ресурс.|
| Центры событий | Политика общего доступа для пространства имен определяет разрешения, которые использует механизм потоковой передачи. Потоковая передача в концентраторы событий требует разрешений на управление, отправку и прослушивание. Чтобы обновить параметр диагностики для включения потоковой передачи, необходимо иметь разрешение ListKey для этого правила авторизации концентраторов событий.<br><br>Пространство имен концентратора событий должно находиться в том же регионе, что и отслеживаемый ресурс, если ресурс является региональным. |
| Учетная запись хранения Azure. | Не следует использовать существующую учетную запись хранения, в которой хранятся другие данные, не относящиеся к мониторингу, чтобы лучше управлять доступом к данным. Если вы выполняете архивацию журналов действий и журналов ресурсов, вы можете использовать одну и ту же учетную запись хранения для централизованного хранения всех данных мониторинга.<br><br>Чтобы отправить данные в неизменяемое хранилище, задайте неизменяемую политику для учетной записи хранения, как описано в статье [Настройка политик неизменности для хранилища BLOB-объектов и управление ими](../../storage/blobs/storage-blob-immutability-policies-manage.md). Необходимо выполнить все действия, описанные в этой статье, включая включение защищенных операций добавочного добавления BLOB-объектов.<br><br>Учетная запись хранения должна находиться в том же регионе, что и отслеживаемый ресурс, если ресурс является региональным. |

> [!NOTE]
> Учетные записи Azure Data Lake Storage 2-го поколения в настоящее время не поддерживаются в качестве назначения для параметров диагностики, хотя они могут быть указаны на портале Azure в качестве допустимого параметра.

> [!NOTE]
> Azure Monitor (параметры диагностики) не могут получить доступ к ресурсам концентраторов событий, если включены виртуальные сети. Необходимо включить параметр разрешить доверенным службам Майкрософт обход этого параметра брандмауэра в концентраторе событий, чтобы служба Azure Monitor (параметры диагностики) предоставила доступ к ресурсам концентраторов событий. 


## <a name="create-in-azure-portal"></a>Создание на портале Azure

Параметры диагностики можно настроить в портал Azure в меню Azure Monitor или в меню для ресурса.

1. Настройка параметров диагностики в портал Azure зависит от ресурса.

   - Для одного ресурса щелкните **параметры диагностики** в разделе **монитор** в меню ресурса.

        ![Снимок экрана: раздел "Мониторинг" меню ресурсов в портал Azure с выделенными параметрами диагностики.](media/diagnostic-settings/menu-resource.png)

   - Для одного или нескольких ресурсов щелкните **параметры диагностики** в разделе **параметры** в меню Azure Monitor, а затем щелкните ресурс.

        ![Снимок экрана: раздел параметров в меню Azure Monitor с выделенными параметрами диагностики.](media/diagnostic-settings/menu-monitor.png)

   - Для журнала действий щелкните **Журнал действий** в меню **Azure Monitor** , а затем **параметры диагностики**. Убедитесь, что отключены все устаревшие конфигурации для журнала действий. Дополнительные сведения см. в разделе [Отключение существующих параметров](./activity-log.md#legacy-collection-methods) .

        ![Снимок экрана: меню Azure Monitor с выбранным журналом действий и параметрами диагностики, выделенными в строке меню журнала Monitor-Activity.](media/diagnostic-settings/menu-activity-log.png)

2. Если параметров для выбранного ресурса не существует, вам будет предложено создать параметр. Щелкните **Добавить параметр диагностики**.

   ![Добавление параметра диагностики — имеющиеся параметры отсутствуют](media/diagnostic-settings/add-setting.png)

   Если в ресурсе есть параметры, отобразится список уже настроенных параметров. Нажмите кнопку **Добавить параметр диагностики** , чтобы добавить новый параметр или **изменить параметр** , чтобы изменить существующий. Каждый параметр может иметь не более одного из целевых типов.

   ![Добавление параметра диагностики — имеющиеся параметры](media/diagnostic-settings/edit-setting.png)

3. Присвойте параметру имя, если его еще нет.

    ![Добавление параметра диагностики](media/diagnostic-settings/setting-new-blank.png)

4. **Сведения о категории (что нужно маршрутизировать)** . Установите флажок для каждой категории данных, которые вы хотите отправить в назначения позже. Список категорий различается для каждой службы Azure.

     - **Аллметрикс** направляет метрики платформы ресурса в хранилище журналов Azure, но в форме журнала. Эти метрики обычно отправляются только в базу данных временных рядов метрик Azure Monitor. Отправляя их в хранилище журналов Azure Monitor (которое доступно с помощью Log Analytics), вы также помогаете интегрировать их в запросы, которые выполняют поиск в других журналах. Этот параметр может быть недоступен для всех типов ресурсов. Если она поддерживается, [Azure Monitor поддерживаемые метрики](metrics-supported.md) указывают, какие метрики собираются для типов ресурсов.

       > [!NOTE]
       > См. раздел ограничение для метрик маршрутизации, чтобы Azure Monitor журналы ранее в этой статье.  


     - В **журналах** перечислены различные категории, доступные в зависимости от типа ресурса. Проверьте все категории, которые вы хотите перенаправить в назначение.

5. **Сведения о назначении** . Установите флажок для каждого назначения. При установке каждого флажка отображаются параметры, позволяющие добавлять дополнительные сведения.

      ![Отправка в Log Analytics или концентраторы событий](media/diagnostic-settings/send-to-log-analytics-event-hubs.png)

    1. **Log Analytics** введите подписку и рабочую область.  Если у вас нет рабочей области, необходимо создать ее, [прежде чем продолжать работу](../learn/quick-create-workspace.md).

    1. **Концентраторы событий** — укажите следующие критерии.
       - Подписка, частью которой является концентратор событий
       - Пространство имен концентратора событий. Если вы еще не создали его, необходимо [создать его](../../event-hubs/event-hubs-create.md) .
       - Имя концентратора событий (необязательно) для отправки всех данных. Если имя не указано, для каждой категории журнала создается концентратор событий. При отправке нескольких категорий может потребоваться указать имя, чтобы ограничить число создаваемых концентраторов событий. Дополнительные сведения см. в статье [квоты и ограничения концентраторов событий Azure](../../event-hubs/event-hubs-quotas.md) .
       - Политика концентратора событий (необязательно) определяет разрешения, которые использует механизм потоковой передачи. Дополнительные сведения см. в разделе [event-Hubs-Features](../../event-hubs/event-hubs-features.md#publisher-policy).

    1. **Хранилище** — выберите подписку, учетную запись хранения и политику хранения.

        ![Отправить в хранилище](media/diagnostic-settings/storage-settings-new.png)

        > [!TIP]
        > Попробуйте задать для политики хранения значение 0 и вручную удалить данные из хранилища с помощью запланированного задания, чтобы избежать возможной путаницы в будущем.
        >
        > Во – первых, если вы используете хранилище для архивирования, обычно требуется, чтобы данные сохранятся более 365 дней. Во-вторых, при выборе политики хранения, которая больше 0, Дата окончания срока действия прикрепляется к журналам во время хранения. Вы не можете изменить дату этих журналов после их сохранения.
        >
        > Например, если установить политику хранения для *WorkflowRuntime* в 180 дней, а затем на 24 часа позднее задать значение 365 дней, журналы, хранящиеся в течение первых 24 часов, будут автоматически удалены через 180 дней, а все последующие журналы этого типа будут автоматически удалены по истечении 365 дней. Изменение политики хранения в дальнейшем не приводит к появления первых 24 часов журналов в течение 365 дней.

6. Щелкните **Save** (Сохранить).

Через несколько секунд новый параметр появится в списке параметров для этого ресурса, а журналы будут передаваться в указанное место назначения по мере создания данных о событиях. При порождении события и его [появлении в log Analytics рабочей области](data-ingestion-time.md)может потребоваться до 15 минут.

## <a name="create-using-powershell"></a>Создание с помощью PowerShell

Используйте командлет [Set-аздиагностиксеттинг](/powershell/module/az.monitor/set-azdiagnosticsetting) , чтобы создать параметр диагностики с [Azure PowerShell](../samples/powershell-samples.md). Описание его параметров см. в документации по этому командлету.

> [!IMPORTANT]
> Этот метод нельзя использовать для журнала действий Azure. Вместо этого используйте [параметр создать диагностику в Azure Monitor используя шаблон диспетчер ресурсов](../samples/resource-manager-diagnostic-settings.md) , чтобы создать шаблон диспетчер ресурсов и развернуть его с помощью PowerShell.

Ниже приведен пример командлета PowerShell для создания параметра диагностики с использованием всех трех назначений.

```powershell
Set-AzDiagnosticSetting -Name KeyVault-Diagnostics -ResourceId /subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/myresourcegroup/providers/Microsoft.KeyVault/vaults/mykeyvault -Category AuditEvent -MetricCategory AllMetrics -Enabled $true -StorageAccountId /subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/myresourcegroup/providers/Microsoft.Storage/storageAccounts/mystorageaccount -WorkspaceId /subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourcegroups/oi-default-east-us/providers/microsoft.operationalinsights/workspaces/myworkspace  -EventHubAuthorizationRuleId /subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/myresourcegroup/providers/Microsoft.EventHub/namespaces/myeventhub/authorizationrules/RootManageSharedAccessKey
```

## <a name="create-using-azure-cli"></a>Создание с помощью Azure CLI

Используйте команду [AZ Monitor диагностики-Settings Create](/cli/azure/monitor/diagnostic-settings#az-monitor-diagnostic-settings-create) , чтобы создать параметр диагностики с [Azure CLI](/cli/azure/monitor). Описание параметров см. в документации по этой команде.

> [!IMPORTANT]
> Этот метод нельзя использовать для журнала действий Azure. Вместо этого используйте [параметр создать диагностику в Azure Monitor используя шаблон диспетчер ресурсов](../samples/resource-manager-diagnostic-settings.md) , чтобы создать шаблон диспетчер ресурсов и развернуть его с помощью интерфейса командной строки.

Ниже приведен пример команды CLI для создания параметра диагностики с использованием всех трех назначений.

```azurecli
az monitor diagnostic-settings create  \
--name KeyVault-Diagnostics \
--resource /subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/myresourcegroup/providers/Microsoft.KeyVault/vaults/mykeyvault \
--logs    '[{"category": "AuditEvent","enabled": true}]' \
--metrics '[{"category": "AllMetrics","enabled": true}]' \
--storage-account /subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/myresourcegroup/providers/Microsoft.Storage/storageAccounts/mystorageaccount \
--workspace /subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourcegroups/oi-default-east-us/providers/microsoft.operationalinsights/workspaces/myworkspace \
--event-hub-rule /subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/myresourcegroup/providers/Microsoft.EventHub/namespaces/myeventhub/authorizationrules/RootManageSharedAccessKey
```

## <a name="create-using-resource-manager-template"></a>Создание с помощью шаблона диспетчер ресурсов
В разделе [примеры шаблонов диспетчер ресурсов для параметров диагностики в Azure Monitor](../samples/resource-manager-diagnostic-settings.md) , чтобы создать или обновить параметры диагностики с помощью шаблона диспетчер ресурсов.

## <a name="create-using-rest-api"></a>Создание с помощью REST API
Сведения о создании или обновлении параметров диагностики с помощью [REST API Azure Monitor](/rest/api/monitor/)см. в разделе [параметры диагностики](/rest/api/monitor/diagnosticsettings) .

## <a name="create-using-azure-policy"></a>Создание с помощью политики Azure
Так как для каждого ресурса Azure необходимо создать параметр диагностики, можно использовать политику Azure, чтобы автоматически создать параметр диагностики при создании каждого ресурса. Дополнительные сведения см. [в статье развертывание Azure Monitor в масштабе с помощью политики Azure](../deploy-scale.md) .

## <a name="metric-category-is-not-supported-error"></a>Категория метрик не поддерживается.
При развертывании параметра диагностики появляется следующее сообщение об ошибке:

   "Категория метрик *XXXX*" не поддерживается ".

Пример: 

   "Категория метрик" Актионсфаилед "не поддерживается".

где ранее было установлено развертывание. 

Проблема возникает при использовании шаблона диспетчер ресурсов, параметров диагностики REST API, Azure CLI или Azure PowerShell. Параметры диагностики, созданные с помощью портал Azure, не затрагиваются, так как отображаются только поддерживаемые имена категорий.

Проблема вызвана недавним изменением в базовом API. Категории метрик, отличные от "Аллметрикс", не поддерживаются и никогда не использовались только в особых сценариях списка разрешений IP. В прошлом имена других категорий были пропущены при развертывании параметра диагностики. Серверная часть Azure Monitor просто перенаправляет эти категории в "Аллметрикс".  По состоянию на февраль 2021 Серверная часть обновлена, чтобы специально убедиться, что указанная категория метрики является точной. Это изменение привело к сбою некоторых развертываний.

При возникновении этой ошибки обновите развертывания, чтобы заменить все имена категорий метрик на "Аллметрикс", чтобы устранить проблему. Если развертывание ранее было добавлено несколько категорий, необходимо сохранить только один из них со ссылкой "Аллметрикс". Если проблема сохранится, обратитесь в службу поддержки Azure через портал Azure. 



## <a name="next-steps"></a>Следующие шаги

- [Подробнее о журналах платформы Azure](platform-logs-overview.md)
