---
title: Ключ Azure Monitor, управляемый клиентом
description: Сведения и действия по настройке ключа, управляемого клиентом, для шифрования данных в рабочих областях Log Analytics с помощью ключа Azure Key Vault.
ms.subservice: logs
ms.topic: conceptual
author: yossi-y
ms.author: yossiy
ms.date: 01/10/2021
ms.openlocfilehash: 07562167131d1839bc0827c74fae09c683302c08
ms.sourcegitcommit: aacbf77e4e40266e497b6073679642d97d110cda
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/12/2021
ms.locfileid: "98118614"
---
# <a name="azure-monitor-customer-managed-key"></a>Ключ Azure Monitor, управляемый клиентом 

Данные в Azure Monitor шифруются с помощью ключей, управляемых корпорацией Майкрософт. Вы можете использовать собственный ключ шифрования для защиты данных и сохранения запросов в рабочих областях. При указании ключа, управляемого клиентом, этот ключ используется для защиты и контроля доступа к данным и после настройки. любые данные, отправляемые в рабочие области, шифруются с помощью ключа Azure Key Vault. Ключи CMK обеспечивают большую гибкость при администрировании операций управления доступом.

Перед настройкой рекомендуется ознакомиться с разделом [Пределы и ограничения](#limitationsandconstraints) ниже.

## <a name="customer-managed-key-overview"></a>Обзор ключа, управляемого клиентом

[Шифрование неактивных](../../security/fundamentals/encryption-atrest.md) данных — это общие требования к конфиденциальности и безопасности в организациях. Вы можете полностью управлять шифрованием в Azure, в то время как у вас есть различные варианты для тесного управления ключами шифрования и шифрования.

Azure Monitor гарантирует, что все данные и сохраненные запросы шифруются при хранении с помощью ключей, управляемых корпорацией Майкрософт (ММК). Azure Monitor также предоставляет возможность шифрования с помощью собственного ключа, хранящегося в [Azure Key Vault](../../key-vault/general/overview.md), что позволяет элементу управления отменять доступ к данным в любое время. Azure Monitor использование шифрования идентично тому, как работает [Шифрование службы хранилища Azure](../../storage/common/storage-service-encryption.md#about-azure-storage-encryption) .

Ключ, управляемый клиентом, доставляется в [выделенные кластеры](../log-query/logs-dedicated-clusters.md) , обеспечивая более высокий уровень защиты и контроль. Данные, принимаемые в выделенные кластеры, шифруются дважды — один раз на уровне службы с помощью ключей, управляемых корпорацией Майкрософт или управляемыми клиентом ключами, и один раз на уровне инфраструктуры с использованием двух разных алгоритмов шифрования и двух разных ключей. [Двойное шифрование](../../storage/common/storage-service-encryption.md#doubly-encrypt-data-with-infrastructure-encryption) защищает от ситуации, когда один из алгоритмов или ключей шифрования может быть скомпрометирован. В этом случае дополнительный уровень шифрования продолжит защищать ваши данные. Выделенный кластер также позволяет защищать данные с помощью элемента управления [защищенным хранилищем](#customer-lockbox-preview) .

Данные, полученные за последние 14 дней, также хранятся в кэше горячего уровня доступа (с поддержкой SSD) для эффективной работы обработчика запросов. Эти данные остаются зашифрованными с помощью ключей Майкрософт независимо от управляемой клиентом конфигурации ключа, но контроль над данными SSD соответствует [отзыву ключа](#key-revocation). Мы работаем над тем, чтобы данные SSD были зашифрованы с помощью ключа, управляемого клиентом, в первой половине 2021.

В Log Analytics выделенных кластерах используется [модель ценообразования](../log-query/logs-dedicated-clusters.md#cluster-pricing-model) резервирования емкости, начиная с 1000 ГБ в день.

> [!IMPORTANT]
> В связи с временными ограничениями емкости перед созданием кластера необходимо предварительно зарегистрироваться в. Используйте свои контакты в Майкрософт или откройте запрос в службу поддержки, чтобы зарегистрировать идентификаторы подписок.

## <a name="how-customer-managed-key-works-in-azure-monitor"></a>Как работает ключ, управляемый клиентом, в Azure Monitor

Azure Monitor использует управляемое удостоверение для предоставления доступа к Azure Key Vault. Удостоверение кластера Log Analytics поддерживается на уровне кластера. Чтобы обеспечить защиту ключей, управляемую клиентом, в нескольких рабочих областях, новый ресурс *кластера* log Analytics выполняет в качестве промежуточного подключения между Key Vaultом и рабочими областями log Analytics. Хранилище кластера использует управляемое удостоверение, \' связанное с ресурсом *кластера* , для проверки подлинности Azure Key Vault с помощью Azure Active Directory. 

После настройки ключа, управляемого клиентом, новые полученные данные в рабочие области, связанные с выделенным кластером, шифруются с помощью ключа. Вы можете удалить связь рабочих областей из кластера в любое время. Новые данные затем принимаются в хранилище Log Analytics и шифруются с помощью ключа Microsoft, тогда как можно легко запросить новые и старые данные.

> [!IMPORTANT]
> Управляемая клиентом функция ключа — региональный. Azure Key Vault, кластер и связанные рабочие области Log Analytics должны находиться в одном регионе, но они могут находиться в разных подписках.

![Обзор ключа, управляемого клиентом](media/customer-managed-keys/cmk-overview.png)

1. Key Vault
2. Ресурс *Кластер* Log Analytics, имеющий управляемое удостоверение с разрешениями на Key Vault. Удостоверение распространяется на подчиненное выделенное хранилище кластера Log Analytics.
3. Выделенный кластер Log Analytics.
4. Рабочие области, связанные с ресурсом *кластера* 

### <a name="encryption-keys-operation"></a>Операция с ключами шифрования

Существует 3 типа ключей, участвующих в шифровании данных службы хранилища:

- Ключ шифрования **KEK** -Key (управляемый клиентом ключ)
- **AEK** — ключ шифрования учетной записи
- **DEK** — ключ шифрования данных

Применяются следующие правила.

- Log Analytics учетные записи хранения кластера создают уникальный ключ шифрования для каждой учетной записи хранения, который называется АЕК.
- АЕК используется для получения DEK, которые являются ключами, используемыми для шифрования каждого блока данных, записываемых на диск.
- Когда вы настраиваете ключ в Key Vault и ссылаетсяе на него в кластере, служба хранилища Azure отправляет запросы в Azure Key Vault для переноса и распаковки АЕК для выполнения операций шифрования и расшифровки данных.
- KEK никогда не покидает ваш Key Vault и в случае ключа HSM он никогда не покидает оборудование.
- Служба хранилища Azure использует управляемое удостоверение, связанное с ресурсом *кластера* , для проверки подлинности и доступа к Azure Key Vault через Azure Active Directory.

### <a name="customer-managed-key-provisioning-steps"></a>Customer-Managed действия по подготовке ключа

1. Регистрация подписки для разрешения создания кластера
1. Создание Azure Key Vault и ключа хранилища.
1. Создание кластера
1. Предоставление разрешений для вашего Key Vault.
1. Обновление кластера с подробными сведениями об идентификаторе ключа
1. Связывание рабочих областей Log Analytics

Конфигурация ключа, управляемого клиентом, не поддерживается в портал Azure в настоящее время ее можно выполнить с помощью [PowerShell](/powershell/module/az.operationalinsights/), [CLI](/cli/azure/monitor/log-analytics) или запросов [RESTful](/rest/api/loganalytics/) .

### <a name="asynchronous-operations-and-status-check"></a>Асинхронные операции и проверка состояния

Некоторые этапы настройки выполняются асинхронно, так как они не могут быть завершены быстро. `status`В ответе может быть одно из следующих: "выполняется", "обновление", "удаление", "успешно" или "сбой" с кодом ошибки.

# <a name="azure-portal"></a>[Портал Azure](#tab/portal)

Недоступно

# <a name="azure-cli"></a>[Azure CLI](#tab/azure-cli);

Недоступно

# <a name="powershell"></a>[PowerShell](#tab/powershell)

Недоступно

# <a name="rest"></a>[REST](#tab/rest)

При использовании функции остальное ответ сначала возвращает код состояния HTTP 200 (ОК) и заголовок с помощью свойства *Azure-AsyncOperation* , если оно принято:
```json
"Azure-AsyncOperation": "https://management.azure.com/subscriptions/subscription-id/providers/Microsoft.OperationalInsights/locations/region-name/operationStatuses/operation-id?api-version=2020-08-01"
```

Вы можете проверить состояние асинхронной операции, отправив запрос GET в конечную точку в заголовке *Azure-AsyncOperation* :
```rst
GET https://management.azure.com/subscriptions/subscription-id/providers/microsoft.operationalInsights/locations/region-name/operationstatuses/operation-id?api-version=2020-08-01
Authorization: Bearer <token>
```

---

### <a name="allowing-subscription"></a>Разрешение подписки

Используйте свои контакты в Майкрософт или откройте запрос в службу поддержки в Log Analytics, чтобы указать идентификаторы подписок.

## <a name="storing-encryption-key-kek"></a>Хранение ключа шифрования (KEK)

Создайте или используйте решение Azure Key Vault, которое вы должны были уже создать, или импортируйте ключ, который будет использоваться для шифрования данных. Для Azure Key Vault нужно настроить возможность восстановления, чтобы обезопасить ключи и доступ к данным в Azure Monitor. Вы можете проверить эту конфигурацию в свойствах вашего Key Vault. Следует включить пункты *Обратимое удаление* и *Защита от очистки*.

![Параметры обратимого удаления и защиты от очистки](media/customer-managed-keys/soft-purge-protection.png)

Эти параметры можно обновить в Key Vault с помощью интерфейса командной строки и PowerShell:

- [обратимое удаление](../../key-vault/general/soft-delete-overview.md)
- [Защита от очистки](../../key-vault/general/soft-delete-overview.md#purge-protection) защищает секрет и данные хранилища от принудительного удаления даже после обратимого удаления.

## <a name="create-cluster"></a>Создание кластера

> [!NOTE]
> Кластеры поддерживают два [управляемых типа удостоверений](../../active-directory/managed-identities-azure-resources/overview.md#managed-identity-types): назначенные системой и назначенные пользователем, которые можно использовать на основе вашего сценария. Управляемое системой удостоверение управляется автоматически с помощью создания кластера, когда вы настраиваете удостоверение `type` как `SystemAssigned` — это удостоверение можно использовать позже для предоставления доступа к Key Vault. Если необходимо создать кластер с конфигурацией ключа, управляемой клиентом при создании, необходимо заранее определить ключ и назначить ему Key Vault удостоверение, а затем создать кластер с удостоверением с `type` `UserAssigned` `UserAssignedIdentities` идентификатором ресурса и сведениями об удостоверении и ключах в `keyVaultProperties` .

> [!IMPORTANT]
> В настоящее время вы не можете определить управляемый клиентом ключ с управляемым удостоверением, если Key Vault находится в Private-Link (vNet). Это ограничение не применяется к управляемому удостоверению, назначенному системой.

Выполните процедуру, показанную в [статье выделенные кластеры](../log-query/logs-dedicated-clusters.md#creating-a-cluster). 

## <a name="grant-key-vault-permissions"></a>Предоставление разрешений Key Vault

Создайте политику доступа в Key Vault, чтобы предоставить разрешения для кластера. Эти разрешения используются хранилищем Azure Monitor ундерлай. Откройте Key Vault в портал Azure и щелкните *"политики доступа"* , а затем *"+ добавить политику доступа"* , чтобы создать политику с этими параметрами:

- Основные разрешения: выберите *"Get"*, *"обернуть ключ"* и *"расобернуть ключ"*.
- Выбор участника: в зависимости от типа удостоверения, используемого в кластере (управляемое удостоверение системы или пользователя), введите имя кластера или идентификатор субъекта кластера для управляемого удостоверения, назначенного системой, или имя управляемого удостоверения, назначенное пользователем.

![предоставление разрешений Key Vault](media/customer-managed-keys/grant-key-vault-permissions-8bit.png)

Разрешение *Получение* необходимо, чтобы убедиться, что Key Vault настроено как восстанавливаемое для защиты ключа и доступа к данным Azure Monitor.

## <a name="update-cluster-with-key-identifier-details"></a>Обновление кластера с подробными сведениями об идентификаторе ключа

Для всех операций в кластере требуется `Microsoft.OperationalInsights/clusters/write` разрешение Action. Это разрешение можно предоставить с помощью владельца или участника, который содержит `*/write` действие, или с помощью роли участника log Analytics, которая содержит `Microsoft.OperationalInsights/*` действие.

На этом шаге Azure Monitor хранилище обновляется ключом и версией, которые будут использоваться для шифрования данных. При обновлении новый ключ используется для упаковки и распаковки ключа хранилища (АЕК).

Выберите текущую версию ключа в Azure Key Vault, чтобы получить сведения об идентификаторе ключа.

![Предоставление разрешений Key Vault](media/customer-managed-keys/key-identifier-8bit.png)

Обновите Кэйваултпропертиес в кластере, используя сведения об идентификаторе ключа.

Операция является асинхронной и может занять некоторое время.

# <a name="azure-portal"></a>[Портал Azure](#tab/portal)

Недоступно

# <a name="azure-cli"></a>[Azure CLI](#tab/azure-cli)

```azurecli
az monitor log-analytics cluster update --name "cluster-name" --resource-group "resource-group-name" --key-name "key-name" --key-vault-uri "key-uri" --key-version "key-version"
```
# <a name="powershell"></a>[PowerShell](#tab/powershell)

```powershell
Update-AzOperationalInsightsCluster -ResourceGroupName "resource-group-name" -ClusterName "cluster-name" -KeyVaultUri "key-uri" -KeyName "key-name" -KeyVersion "key-version"
```

# <a name="rest"></a>[REST](#tab/rest)

```rst
PATCH https://management.azure.com/subscriptions/<subscription-id>/resourcegroups/<resource-group-name>/providers/Microsoft.OperationalInsights/clusters/cluster-name?api-version=2020-08-01
Authorization: Bearer <token> 
Content-type: application/json
 
{
  "properties": {
    "keyVaultProperties": {
      "keyVaultUri": "https://key-vault-name.vault.azure.net",
      "kyName": "key-name",
      "keyVersion": "current-version"
  },
  "sku": {
    "name": "CapacityReservation",
    "capacity": 1000
  }
}
```

**Ответ**

Он занимается распространением ключа через несколько минут. Проверить состояние обновления можно двумя способами.
1. Скопируйте значение URL-адреса Azure-AsyncOperation из ответа и выполните [проверку состояния асинхронных операций](#asynchronous-operations-and-status-check).
2. Отправьте запрос GET в кластер и просмотрите свойства *кэйваултпропертиес* . Недавно обновленный ключ должен вернуть ответ.

Ответ на запрос GET должен выглядеть следующим образом после завершения обновления ключа: 200 ОК и заголовок
```json
{
  "identity": {
    "type": "SystemAssigned",
    "tenantId": "tenant-id",
    "principalId": "principle-id"
    },
  "sku": {
    "name": "capacityReservation",
    "capacity": 1000,
    "lastSkuUpdate": "Sun, 22 Mar 2020 15:39:29 GMT"
    },
  "properties": {
    "keyVaultProperties": {
      "keyVaultUri": "https://key-vault-name.vault.azure.net",
      "kyName": "key-name",
      "keyVersion": "current-version"
      },
    "provisioningState": "Succeeded",
    "billingType": "cluster",
    "clusterId": "cluster-id"
  },
  "id": "/subscriptions/subscription-id/resourceGroups/resource-group-name/providers/Microsoft.OperationalInsights/clusters/cluster-name",
  "name": "cluster-name",
  "type": "Microsoft.OperationalInsights/clusters",
  "location": "region-name"
}
```

---

## <a name="link-workspace-to-cluster"></a>Связывание рабочей области с кластером

> [!IMPORTANT]
> Этот шаг следует выполнить только после завершения подготовки кластера Log Analytics. Если вы связываете рабочие области и принимаете данные до подготовки, полученные данные будут удалены и не будут восстановлены.

Для выполнения этой операции необходимы разрешения "запись" для рабочей области и кластера, в том числе `Microsoft.OperationalInsights/workspaces/write` и `Microsoft.OperationalInsights/clusters/write` .

Выполните процедуру, показанную в [статье выделенные кластеры](../log-query/logs-dedicated-clusters.md#link-a-workspace-to-cluster).

## <a name="key-revocation"></a>Отзыв ключа

Вы можете отозвать доступ к данным, отключив ключ или удалив политику доступа кластера в Key Vault. 

> [!IMPORTANT]
> - Если в кластере настроено управляемое удостоверение, назначенное пользователем, параметр `UserAssignedIdentities` с `None` приостанавливает работу кластера и предотвращает доступ к данным, но вы не сможете отменить отзыв и активировать кластер, не открывая запрос на поддержку. Это ограничение не применяется к управляемому удостоверению, назначенному системой.
> - Рекомендуемое действие отзыва ключа заключается в отключении ключа в Key Vault.

Хранилище кластера всегда будет учитывать изменения ключевых разрешений в течение часа или раньше, и хранилище станет недоступным. Все новые данные, принимаемые в рабочие области, связанные с вашим кластером, будут удалены и не будут восстановлены, данные станут недоступными, а запросы в этих рабочих областях завершатся неудачей. Ранее полученные данные остаются в хранилище, пока кластер и ваши рабочие области не удаляются. Недоступные данные управляются политикой хранения данных и очищаются при достижении окончания срока хранения. Полученные данные за последние 14 дней также хранятся в кэше горячего уровня доступа (с поддержкой SSD) для эффективной работы обработчика запросов. Эта операция удаляется из операции отзыва ключа и становится недоступной.

Хранилище кластера периодически опрашивает Key Vault, чтобы попытаться расшифровать ключ шифрования и получить доступ к нему, а затем продолжить прием данных и выполнить запрос в течение 30 минут.

## <a name="key-rotation"></a>Смена ключей

Для смены ключа, управляемого клиентом, требуется явное обновление кластера с новой версией ключа в Azure Key Vault. [Обновите кластер с подробными сведениями об идентификаторе ключа](#update-cluster-with-key-identifier-details). Если вы не обновите новую версию ключа в кластере, Log Analytics хранилище кластера будет использовать предыдущий ключ для шифрования. Если вы отключаете или удаляете старый ключ перед обновлением нового ключа в кластере, вы получите состояние [отзыва ключа](#key-revocation) .

После операции смены ключа все данные остаются доступными, так как данные всегда шифруются с помощью ключа шифрования учетной записи (АЕК), а АЕК теперь зашифрован с помощью новой версии ключа шифрования ключей (KEK) в Key Vault.

## <a name="customer-managed-key-for-queries"></a>Ключ, управляемый клиентом для запросов

Язык запросов, используемый в Log Analytics, является выразительным и может содержать конфиденциальные сведения в комментариях, добавляемых к запросам или в синтаксисе запросов. Некоторым организациям требуется, чтобы такая информация была защищена в рамках политики с управляемым клиентом ключом, и вам нужно сохранить запросы, зашифрованные с помощью ключа. Azure Monitor позволяет хранить запросы, *сохраненные для поиска* и *оповещения журналов* , зашифрованные с помощью ключа в вашей учетной записи хранения при подключении к рабочей области. 

> [!NOTE]
> Log Analytics запросы можно сохранять в различных хранилищах в зависимости от используемого сценария. Запросы остаются зашифрованными с помощью ключа Microsoft Key (ММК) в следующих сценариях: книги в Azure Monitor, панели мониторинга Azure, Azure Logic App, записные книжки Azure и модули Runbook службы автоматизации.

Когда вы перейдете в собственное хранилище (BYOS) и свяжете его с рабочей областью, служба загрузит *Сохраненные операции поиска* и *оповещения журналов* в вашу учетную запись хранения. Это означает, что вы управляете учетной записью хранения и [политикой шифрования неактивных](../../storage/common/customer-managed-keys-overview.md) данных с помощью того же ключа, который используется для шифрования log Analytics кластера или другого ключа. При этом вы несете ответственность за затраты, связанные с этой учетной записью хранения. 

**Рекомендации по настройке ключа, управляемого клиентом, для запросов**
* У вас должны быть разрешения на запись в рабочую область и в учетную запись хранения.
* Не забудьте создать учетную запись хранения в том же регионе, в котором находится рабочая область Log Analytics
* *Сохранение поиска* в хранилище считается артефактами службы, и их формат может измениться.
* Существующие операции *поиска с сохранением* удаляются из рабочей области. При этом копируются и *сохраняются результаты поиска* , которые необходимы перед настройкой. Вы можете просмотреть *сохраненные и поисковые запросы* с помощью [PowerShell](/powershell/module/az.operationalinsights/get-azoperationalinsightssavedsearch) .
* Журнал запросов не поддерживается, и вы не сможете просматривать запущенные запросы.
* Вы можете связать одну учетную запись хранения с рабочей областью для сохранения запросов, но можно использовать из как *сохраненные-поисковые* запросы, так и *оповещения журнала* .
* Закрепление на панели мониторинга не поддерживается

**Настройка BYOS для сохраненных запросов поиска**

Связывание учетной записи хранения для *запроса* к рабочей области — запросы, *сохраненные для поиска* , сохраняются в учетной записи хранения. 

# <a name="azure-portal"></a>[Портал Azure](#tab/portal)

Недоступно

# <a name="azure-cli"></a>[Azure CLI](#tab/azure-cli)

```azurecli
$storageAccountId = '/subscriptions/<subscription-id>/resourceGroups/<resource-group-name>/providers/Microsoft.Storage/storageAccounts/<storage name>'
az monitor log-analytics workspace linked-storage create --type Query --resource-group "resource-group-name" --workspace-name "workspace-name" --storage-accounts $storageAccountId
```

# <a name="powershell"></a>[PowerShell](#tab/powershell)

```powershell
$storageAccount.Id = Get-AzStorageAccount -ResourceGroupName "resource-group-name" -Name "storage-account-name"
New-AzOperationalInsightsLinkedStorageAccount -ResourceGroupName "resource-group-name" -WorkspaceName "workspace-name" -DataSourceType Query -StorageAccountIds $storageAccount.Id
```

# <a name="rest"></a>[REST](#tab/rest)

```rst
PUT https://management.azure.com/subscriptions/<subscription-id>/resourcegroups/<resource-group-name>/providers/Microsoft.OperationalInsights/workspaces/<workspace-name>/linkedStorageAccounts/Query?api-version=2020-08-01
Authorization: Bearer <token> 
Content-type: application/json
 
{
  "properties": {
    "dataSourceType": "Query", 
    "storageAccountIds": 
    [
      "/subscriptions/<subscription-id>/resourceGroups/<resource-group-name>/providers/Microsoft.Storage/storageAccounts/<storage-account-name>"
    ]
  }
}
```

---

После настройки любой новый *сохраненный поисковый* запрос будет сохранен в хранилище.

**Настройка BYOS для запросов оповещений журнала**

Свяжите учетную запись хранения с *оповещениями* в рабочей области — запросы на *оповещения журнала* сохраняются в учетной записи хранения. 

# <a name="azure-portal"></a>[Портал Azure](#tab/portal)

Недоступно

# <a name="azure-cli"></a>[Azure CLI](#tab/azure-cli)

```azurecli
$storageAccountId = '/subscriptions/<subscription-id>/resourceGroups/<resource-group-name>/providers/Microsoft.Storage/storageAccounts/<storage name>'
az monitor log-analytics workspace linked-storage create --type ALerts --resource-group "resource-group-name" --workspace-name "workspace-name" --storage-accounts $storageAccountId
```

# <a name="powershell"></a>[PowerShell](#tab/powershell)

```powershell
$storageAccount.Id = Get-AzStorageAccount -ResourceGroupName "resource-group-name" -Name "storage-account-name"
New-AzOperationalInsightsLinkedStorageAccount -ResourceGroupName "resource-group-name" -WorkspaceName "workspace-name" -DataSourceType Alerts -StorageAccountIds $storageAccount.Id
```

# <a name="rest"></a>[REST](#tab/rest)

```rst
PUT https://management.azure.com/subscriptions/<subscription-id>/resourcegroups/<resource-group-name>/providers/Microsoft.OperationalInsights/workspaces/<workspace-name>/linkedStorageAccounts/Alerts?api-version=2020-08-01
Authorization: Bearer <token> 
Content-type: application/json
 
{
  "properties": {
    "dataSourceType": "Alerts", 
    "storageAccountIds": 
    [
      "/subscriptions/<subscription-id>/resourceGroups/<resource-group-name>/providers/Microsoft.Storage/storageAccounts/<storage-account-name>"
    ]
  }
}
```

---

После настройки любой новый запрос на оповещение будет сохранен в хранилище.

## <a name="customer-lockbox-preview"></a>Защищенное хранилище (Предварительная версия)

Защищенное хранилище предоставляет элементу управления возможность утверждать или отклонять запросы инженера Майкрософт на доступ к данным во время запроса на поддержку.

В Azure Monitor Вы можете управлять данными в рабочих областях, связанных с выделенным кластером Log Analytics. Элемент управления защищенного хранилища применяется к данным, хранящимся в Log Analytics выделенном кластере, где он хранится в учетных записях хранения кластера в защищенной подписке вашего абонента.  

Дополнительные сведения о [защищенное хранилище для Microsoft Azure](../../security/fundamentals/customer-lockbox-overview.md)

## <a name="customer-managed-key-operations"></a>Операции с ключами Customer-Managed

Customer-Managed ключ предоставляется в выделенном кластере, и эти операции упоминаются в [статье выделенный кластер](../log-query/logs-dedicated-clusters.md#change-cluster-properties) .

- Получение всех кластеров в группе ресурсов  
- Получить все кластеры в подписке
- Обновление *резервирования емкости* в кластере
- Обновление *биллингтипе* в кластере
- Отмена связи рабочей области с кластером
- Удаление кластера

## <a name="limitations-and-constraints"></a>Пределы и ограничения

- Ключ, управляемый клиентом, поддерживается в выделенном кластере Log Analytics и подходит для клиентов, отправляющих 1 ТБ в день или более.

- Максимальное число кластеров на регион и подписку равно 2

- Максимальное число связанных рабочих областей в кластере — 1000

- Вы можете связать рабочую область с кластером, а затем удалить ее связь. Число операций ссылок на рабочую область в конкретной рабочей области ограничено 2 в течение 30 дней.

- Ссылка на рабочую область кластера должна быть выполнена только после того, как была выполнена проверка завершения подготовки кластера Log Analytics.  Данные, отправляемые в рабочую область до завершения, будут удалены и не подлежат восстановлению.

- Шифрование ключа, управляемого клиентом, применяется к вновь принятым данным после времени настройки. Данные, которые были приняты до настройки, остаются зашифрованными с помощью ключа Microsoft Key. Вы можете легко запрашивать данные, полученные до и после настройки ключа, управляемого клиентом.

- Azure Key Vault должны быть настроены как восстанавливаемые. Эти свойства не включены по умолчанию и должны быть настроены с помощью интерфейса командной строки или PowerShell:<br>
  - [обратимое удаление](../../key-vault/general/soft-delete-overview.md)
  - Чтобы защититься от принудительного удаления секрета или хранилища даже после обратимого удаления, следует включить [защиту](../../key-vault/general/soft-delete-overview.md#purge-protection) от удаления.

- Перемещение кластера в другую группу ресурсов или подписку сейчас не поддерживается.

- Azure Key Vault, кластер и связанные рабочие области должны находиться в одном и том же регионе и в одном клиенте Azure Active Directory (Azure AD), но они могут находиться в разных подписках.

- Ссылка на рабочую область кластера завершится ошибкой, если она связана с другим кластером.

- В настоящее время защищенное хранилище недоступно в Китае. 

- [Двойное шифрование](../../storage/common/storage-service-encryption.md#doubly-encrypt-data-with-infrastructure-encryption) настраивается автоматически для кластеров, созданных с 2020 октября в поддерживаемых регионах. Вы можете проверить, настроено ли для кластера двойное шифрование с помощью запроса GET в кластере, и наблюдать за `"isDoubleEncryptionEnabled"` значением свойства — `true` для кластеров с включенным двойным шифрованием. 
  - При создании кластера и получении сообщения об ошибке "<имя региона> не поддерживает двойное шифрование для кластеров", вы по-прежнему можете создать кластер без двойного шифрования. Добавьте `"properties": {"isDoubleEncryptionEnabled": false}` свойство в текст запроса остальной части.
  - Параметр двойного шифрования нельзя изменить после создания кластера.

  - Если в кластере настроено управляемое удостоверение, назначенное пользователем, параметр `UserAssignedIdentities` с `None` приостанавливает работу кластера и предотвращает доступ к данным, но вы не сможете отменить отзыв и активировать кластер, не открывая запрос на поддержку. Это ограничение относится к управляемому удостоверению, назначенному системой.

  - В настоящее время вы не можете определить управляемый клиентом ключ с управляемым удостоверением, если Key Vault находится в Private-Link (vNet). Это ограничение не применяется к управляемому удостоверению, назначенному системой.

## <a name="troubleshooting"></a>Устранение неполадок

- Поведение при доступности Key Vault:
  - При нормальных операциях. Служба хранилища кэширует АЕК в течение короткого периода времени и возвращается к Key Vault для периодического разворачивания.
    
  - Нерегулярные ошибки подключений. Служба хранилища обрабатывает нерегулярные ошибки (время ожидания, сбои подключений, проблемы DNS), позволяя ключам оставаться в кэше в течение короткого промежутка времени, что приводит к небольшому перебою в доступности. Возможность создавать запросы и принимать данные не прерывается.
    
  - Действующий сайт. Недоступность в течение 30 минут приведет к тому, что учетная запись хранения станет недоступной. Создание запросов недоступно, а полученные данные кэшируются в течение нескольких часов с помощью ключа Майкрософт, чтобы избежать потери данных. При восстановлении доступа к Key Vault запрос становится доступным, а временные кэшированные данные принимаются в хранилище данных и шифруются с помощью ключа, управляемого клиентом.

  - Частота доступа Key Vault. Частота, с которой Azure Monitor получает доступ к хранилищу Key Vault для операций упаковки и распаковки, составляет от 6 до 60 секунд.

- Если вы создадите кластер и сразу укажете Кэйваултпропертиес, операция может завершиться ошибкой, так как политика доступа не может быть определена, пока кластер не будет назначен системному удостоверению.

- Если вы обновляете существующий кластер с помощью Кэйваултпропертиес и в Key Vault отсутствует политика доступа к ключам "Get", операция завершится ошибкой.

- Если при создании кластера возникает ошибка конфликта, возможно, вы удалили кластер за последние 14 дней и в течение периода обратимого удаления. Имя кластера остается зарезервированным в течение периода обратимого удаления, и вы не можете создать новый кластер с таким именем. Имя освобождается после периода обратимого удаления, когда кластер окончательно удаляется.

- Если вы обновляете кластер во время выполнения операции, операция завершится ошибкой.

- Если вы не развернете кластер, убедитесь, что Azure Key Vault, кластер и связанные рабочие области Log Analytics находятся в одном регионе. Они могут находиться в разных подписках.

- Если вы обновляете версию ключа в Key Vault и не обновляете новые сведения об идентификаторе ключа в кластере, Log Analytics кластер будет использовать предыдущий ключ, и ваши данные станут недоступными. Обновите сведения о новом идентификаторе ключа в кластере, чтобы возобновить прием данных и возможность запрашивать данные.

- Некоторые операции являются длительными и могут занять некоторое время — это создание кластера, обновление ключа кластера и удаление кластера. Проверить состояние операции можно двумя способами.
  1. При использовании функции "ОСТАВШАЯся" скопируйте значение Azure-AsyncOperation URL-адрес из ответа и выполните [проверку состояния асинхронных операций](#asynchronous-operations-and-status-check).
  2. Отправьте запрос GET в кластер или рабочую область и просмотрите ответ. Например, несвязанная Рабочая область не будет иметь *клустерресаурцеид* в разделе " *компоненты*".

- Сообщения об ошибках
  
  **Создание кластера**
  -  400--недопустимое имя кластера. Имя кластера может содержать символы a – z, A – Z, 0-9 и длину 3-63.
  -  400--текст запроса имеет значение null или имеет неправильный формат.
  -  400--недопустимое имя SKU. Задайте для номера SKU имя КапаЦитиресерватион.
  -  400--Емкость предоставлена, но SKU не КапаЦитиресерватион. Задайте для номера SKU имя КапаЦитиресерватион.
  -  400--отсутствует емкость в номере SKU. Задайте для параметра емкость значение 1000 или выше на шаге 100 (ГБ).
  -  400--Емкость SKU не входит в диапазон. Должно быть не менее 1000 и не больше максимальной допустимой емкости, доступной в разделе "использование и оценочная стоимость" в рабочей области.
  -  400--Емкость заблокирована в течение 30 дней. Уменьшение емкости разрешено через 30 дней после обновления.
  -  400--номер SKU не задан. Задайте для номера SKU значение КапаЦитиресерватион и Capacity, равное 1000 или выше, на шаге 100 (ГБ).
  -  400--Identity имеет значение null или пусто. Задайте удостоверение с типом systemAssigned.
  -  400--Кэйваултпропертиес устанавливаются при создании. Обновление Кэйваултпропертиес после создания кластера.
  -  400--невозможно выполнить операцию сейчас. Асинхронная операция находится в состоянии, отличном от "завершено". Перед выполнением операции обновления кластер должен завершить свою операцию.

  **Обновление кластера**
  -  400--кластер находится в состоянии удаления. Асинхронная операция выполняется. Перед выполнением операции обновления кластер должен завершить свою операцию.
  -  400--Кэйваултпропертиес не является пустым, но имеет неправильный формат. См. [раздел об обновлении идентификатора ключа](../platform/customer-managed-keys.md#update-cluster-with-key-identifier-details).
  -  400--не удалось проверить ключ в Key Vault. Возможно, из-за отсутствия разрешений или если ключ не существует. Убедитесь, что [Политика ключа и доступа задана](../platform/customer-managed-keys.md#grant-key-vault-permissions) в Key Vault.
  -  400-ключ не может быть восстановлен. Для Key Vault должно быть задано обратимое удаление и защита от удаления. См. [документацию по Key Vault](../../key-vault/general/soft-delete-overview.md)
  -  400--невозможно выполнить операцию сейчас. Дождитесь завершения асинхронной операции и повторите попытку.
  -  400--кластер находится в состоянии удаления. Дождитесь завершения асинхронной операции и повторите попытку.

  **Получение кластера**
    -  404--кластер не найден, возможно, кластер удален. Если вы попытаетесь создать кластер с этим именем и получить конфликт, кластер будет обратимо удален в течение 14 дней. Вы можете обратиться в службу поддержки, чтобы восстановить ее, или использовать другое имя для создания нового кластера. 

  **Удаление кластера**
    -  409--не удается удалить кластер в состоянии подготовки. Дождитесь завершения асинхронной операции и повторите попытку.

  **Ссылка на рабочую область**
  -  404--Рабочая область не найдена. Указанная Рабочая область не существует или была удалена.
  -  409--ссылка на рабочую область или отмена связи в процессе.
  -  400--кластер не найден, указанный кластер не существует или был удален. Если вы попытаетесь создать кластер с этим именем и получить конфликт, кластер будет обратимо удален в течение 14 дней. Вы можете обратиться в службу поддержки, чтобы восстановить ее.

  **Удалить связь рабочей области**
  -  404--Рабочая область не найдена. Указанная Рабочая область не существует или была удалена.
  -  409--ссылка на рабочую область или отмена связи в процессе.
## <a name="next-steps"></a>Дальнейшие действия

- Дополнительные сведения о [log Analytics выставлении счетов за выделенный кластер](../platform/manage-cost-storage.md#log-analytics-dedicated-clusters)
- Сведения о [правильном проектировании рабочих областей log Analytics](../platform/design-logs-deployment.md)