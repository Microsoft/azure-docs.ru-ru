---
title: Устранение неполадок с оповещениями журнала в Azure Monitor | Документация Майкрософт
description: Распространенные проблемы, ошибки и способы их устранения для правил генерации оповещений журнала в Azure.
author: yanivlavi
ms.author: yalavi
ms.topic: conceptual
ms.subservice: alerts
ms.date: 09/22/2020
ms.openlocfilehash: 06deb9a736998cf32a33d7c4ad08340cf4846b7c
ms.sourcegitcommit: 5a999764e98bd71653ad12918c09def7ecd92cf6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/16/2021
ms.locfileid: "100547797"
---
# <a name="troubleshoot-log-alerts-in-azure-monitor"></a>Устранение неполадок с оповещениями журнала в Azure Monitor  

В этой статье показано, как устранить распространенные проблемы с оповещениями журнала в Azure Monitor. Он также предоставляет решения распространенных проблем, связанных с функциональностью и конфигурацией оповещений журнала.

Оповещения журнала позволяют пользователям использовать [log Analytics](../log-query/log-analytics-tutorial.md) запрос для проверки журнала ресурсов каждые заданные частоты и запуска предупреждения на основе результатов. Правила могут запускать одно или несколько действий с помощью [групп действий](./action-groups.md). [Дополнительные сведения о функциональности и терминологии оповещений журнала](alerts-unified-log.md).

> [!NOTE]
> В этой статье не рассматриваются случаи, когда в портал Azure показано срабатывание правила генерации оповещений, а уведомление не выполняется связанной группой действий. В таких случаях дополнительные сведения об устранении неполадок см. [здесь](./alerts-troubleshoot.md#action-or-notification-on-my-alert-did-not-work-as-expected).

## <a name="log-alert-didnt-fire"></a>Оповещение журналов не срабатывает

### <a name="data-ingestion-time-for-logs"></a>Время приема данных для журналов

Azure Monitor обрабатывает терабайты журналов клиентов по всему миру, что может привести к [задержке приема журналов](./data-ingestion-time.md).

Журналы представляют собой частично структурированные данные и, по сути, более скрытые, чем метрики. Если в запущенных оповещениях используется более 4 минут задержки, следует рассмотреть возможность использования [оповещений метрик](alerts-metric-overview.md). Вы можете отправить данные в хранилище метрик из журналов с помощью [оповещений метрик для журналов](alerts-metric-logs.md).

Система повторяет оценку предупреждения несколько раз, чтобы снизить задержку. Когда данные поступают, выдается предупреждение, которое в большинстве случаев не равно времени записи журнала.

### <a name="incorrect-query-time-range-configured"></a>Настроен недопустимый диапазон времени запроса

Диапазон времени запроса задается в определении условия правила. Это поле называется **период** для рабочих областей и Application Insights и называется **диапазоном времени запроса переопределения** для всех остальных типов ресурсов. Как и в log Analytics, диапазон времени ограничивает данные запроса до указанного периода. Даже если в запросе используется команда **назад** , диапазон времени будет применен. 

Например, запрос сканирует 60 минут, если диапазон времени равен 60 минутам, даже если текст содержит **назад (1d)**. Диапазон времени и фильтрация времени запроса должны совпадать. В этом примере, если изменить   /  **диапазон времени запроса переопределения** периода на один день, будет работать должным образом.

![Период времени](media/alert-log-troubleshoot/LogAlertTimePeriod.png)

### <a name="actions-are-muted-in-the-alert-rule"></a>Действия отключены в правиле генерации оповещений

Оповещения журнала предоставляют возможность отключить срабатывание оповещений в течение заданного периода времени. Это поле называется **подавлять оповещения** в рабочих областях и Application Insights. Во всех остальных типах ресурсов это называется « **звуковые действия**». 

Распространенной проблемой является то, что предупреждение не активировало действия из-за проблемы со службой. Даже сложная ИТ была отключена конфигурацией правила.

![Отменить вывод оповещений](media/alert-log-troubleshoot/LogAlertSuppress.png)

### <a name="metric-measurement-alert-rule-with-splitting-using-the-legacy-log-analytics-api"></a>Правило генерации оповещений измерения метрик с разделением с помощью API Log Analytics прежних версий

[Измерение метрик](alerts-unified-log.md#calculation-of-measure-based-on-a-numeric-column-such-as-cpu-counter-value) — это тип оповещения журнала, основанный на сводных результатах временных рядов. Эти правила разрешают группирование по столбцам для [разбиения предупреждений](alerts-unified-log.md#split-by-alert-dimensions). Если вы используете устаревший Log Analytics API, разделение будет работать не так, как ожидалось. Выбор группировки в устаревшем API не поддерживается.

Текущий API Счедуледкуерирулес позволяет задать **статистическое выражение on** в правилах [измерения метрик](alerts-unified-log.md#calculation-of-measure-based-on-a-numeric-column-such-as-cpu-counter-value) , которые будут работать должным образом. Дополнительные [сведения о переключении на текущий API счедуледкуерирулес](alerts-log-api-switch.md).

## <a name="log-alert-fired-unnecessarily"></a>Оповещение журналов срабатывает без необходимости

Настроенное [правило генерации оповещений журнала в Azure Monitor](./alerts-log.md) может быть вызвано непредвиденным образом. В следующих разделах описываются некоторые распространенные причины.

### <a name="alert-triggered-by-partial-data"></a>Предупреждение активируется по частичным данным

Azure Monitor обрабатывает терабайты журналов клиентов по всему миру, что может привести к [задержке приема журналов](./data-ingestion-time.md).

Журналы представляют собой частично структурированные данные и, по сути, более скрытые, чем метрики. Если в запущенных оповещениях возникает много некорректностей, следует рассмотреть возможность использования [оповещений метрик](alerts-metric-overview.md). Вы можете отправить данные в хранилище метрик из журналов с помощью [оповещений метрик для журналов](alerts-metric-logs.md).

Оповещения журнала работают наилучшим образом при попытке обнаружить данные в журналах. При попытке обнаружить недостаток данных в журналах он будет работать менее эффективно. Например, оповещение о пульсе виртуальной машины. 

Хотя существуют встроенные возможности для предотвращения ложных оповещений, они по-прежнему могут возникать в очень скрытых данных (свыше 30 минут) и данных с пиковыми задержками.

### <a name="query-optimization-issues"></a>Проблемы оптимизации запросов

Служба предупреждений изменяет запрос в целях оптимизации для снижения нагрузки и предупреждений. Поток предупреждений был создан для преобразования результатов, указывающих на ошибку в предупреждении. Например, в случае запроса:

``` Kusto
SecurityEvent
| where EventID == 4624
```

Если предполагается, что пользователь получит предупреждение, то при возникновении этого события логика предупреждений добавляется `count` к запросу. Будет выполнен запрос:

``` Kusto
SecurityEvent
| where EventID == 4624
| count
```

Нет необходимости добавлять в запрос логику предупреждений, и это может вызвать проблемы. В приведенном выше примере, если включить `count` в запрос, всегда будет получено значение 1, так как служба оповещений будет делать `count` `count` .

Оптимизированный запрос — это то, что работает служба оповещений журнала. Вы можете запустить измененный запрос на Log Analytics [портале](../log-query/log-query-overview.md) или [API](/rest/api/loganalytics/).

Для рабочих областей и Application Insights он называется **запросом для выполнения** на панели условие. Во всех остальных типах ресурсов выберите **Просмотреть окончательный запрос предупреждения** на вкладке условие.

![Выполняемый запрос](media/alert-log-troubleshoot/LogAlertPreview.png)

## <a name="log-alert-was-disabled"></a>Оповещение журнала отключено

В следующих разделах перечислены некоторые причины, по которым Azure Monitor может отключить правило генерации оповещений журнала. Мы также включили [пример журнала действий, который отправляется, когда правило отключено](#activity-log-example-when-rule-is-disabled).

### <a name="alert-scope-no-longer-exists-or-was-moved"></a>Область оповещений больше не существует или была перемещена

Если ресурсы области действия правила генерации оповещений больше не действительны, выполнение правила завершается ошибкой. В этом случае выставление счетов также останавливается.

Azure Monitor отключит оповещение журнала через неделю, если оно постоянно завершается сбоем.

### <a name="query-used-in-a-log-alert-isnt-valid"></a>Недопустимый запрос, используемый в предупреждении журнала

При создании правила генерации оповещений в журнале запрос проверяется на правильность синтаксиса. Но иногда запрос, указанный в правиле оповещения журнала, может начаться с ошибкой. Ниже перечислены некоторые распространенные причины.

- Правила были созданы через API, и проверка была пропущена пользователем.
- Запрос [выполняется на нескольких ресурсах](../log-query/cross-workspace-query.md) , и один или несколько ресурсов были удалены или перемещены.
- [Запрос завершается ошибкой](https://dev.loganalytics.io/documentation/Using-the-API/Errors) по следующим причинам:
    - Решение для ведения журнала не [развернуто в рабочей области](../insights/solutions.md#install-a-monitoring-solution), поэтому таблицы не создаются.
    - Данные перестали передаются в таблицу в запросе более 30 дней.
    - [Таблицы пользовательских журналов](data-sources-custom-logs.md) еще не созданы, так как поток данных не был запущен.
- Изменения в [языке запросов](/azure/kusto/query/) включают в себя измененный формат команд и функций. Поэтому запрос, указанный ранее, больше не является допустимым.

[Помощник Azure](../../advisor/advisor-overview.md) предупредит об этом поведении. Он добавляет рекомендации по применению правила оповещения журнала. Используемая Категория — "высокий уровень доступности" с средним влиянием и описанием "восстановление правила оповещения журнала для обеспечения мониторинга".

## <a name="alert-rule-quota-was-reached"></a>Достигнута квота на правило генерации оповещений

Количество правил генерации оповещений поиска для подписки и ресурса зависит от квоты, описанной [здесь](../service-limits.md).

### <a name="recommended-steps"></a>Рекомендуемые действия
    
Если вы достигли предельной квоты, следующие шаги могут помочь устранить проблему.

1. Попробуйте удалить или отключить правила генерации оповещений поиска по журналам, которые больше не используются.
1. Попробуйте использовать [разделение предупреждений по измерениям](alerts-unified-log.md#split-by-alert-dimensions) для сокращения числа правил. Эти правила могут отслеживать множество ресурсов и вариантов обнаружения.
1. Если требуется увеличить квоту, продолжайте открывать запрос в службу поддержки и предоставляет следующие сведения:

    - Идентификаторы и идентификаторы ресурсов подписок, для которых необходимо увеличить квоту.
    - Причина увеличения квоты.
    - Тип ресурса для увеличения квоты: **log Analytics**, **Application Insights** и т. д.
    - Запрошенная квота.


### <a name="to-check-the-current-usage-of-new-log-alert-rules"></a>Проверка текущего использования новых правил генерации оповещений журнала
    
#### <a name="from-the-azure-portal"></a>на портале Azure;

1. Откройте экран *оповещения* и выберите *Управление правилами оповещений* .
2. Выберите соответствующую подписку с помощью раскрывающегося списка *Подписки*.
3. НЕ следует выполнять фильтрацию по определенной группе ресурсов, типу ресурса или ресурсу.
4. В раскрывающемся списке *Тип сигнала* выберите "Поиск по журналам".
5. Убедитесь, что в раскрывающемся списке *Состояние* установлено значение "Включено".
6. Общее число правил генерации оповещений поиска по журналам отобразится над списком правил.

#### <a name="from-api"></a>Из API

- PowerShell- [Get-азсчедуледкуерируле](/powershell/module/az.monitor/get-azscheduledqueryrule)
- REST API: [выведите список по подписке](/rest/api/monitor/scheduledqueryrules/listbysubscription).

## <a name="activity-log-example-when-rule-is-disabled"></a>Пример журнала действий, когда правило отключено

Если в течение семи дней происходит сбой запроса, Azure Monitor отключит оповещение журнала и прекращает выставление счетов за правило. Вы можете узнать точное время, когда Azure Monitor отключило оповещение журнала в [журнале действий Azure](../../azure-resource-manager/management/view-activity-logs.md). См. Следующий пример:

```json
{
    "caller": "Microsoft.Insights/ScheduledQueryRules",
    "channels": "Operation",
    "claims": {
        "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/spn": "Microsoft.Insights/ScheduledQueryRules"
    },
    "correlationId": "abcdefg-4d12-1234-4256-21233554aff",
    "description": "Alert: test-bad-alerts is disabled by the System due to : Alert has been failing consistently with the same exception for the past week",
    "eventDataId": "f123e07-bf45-1234-4565-123a123455b",
    "eventName": {
        "value": "",
        "localizedValue": ""
    },
    "category": {
        "value": "Administrative",
        "localizedValue": "Administrative"
    },
    "eventTimestamp": "2019-03-22T04:18:22.8569543Z",
    "id": "/SUBSCRIPTIONS/<subscriptionId>/RESOURCEGROUPS/<ResourceGroup>/PROVIDERS/MICROSOFT.INSIGHTS/SCHEDULEDQUERYRULES/TEST-BAD-ALERTS",
    "level": "Informational",
    "operationId": "",
    "operationName": {
        "value": "Microsoft.Insights/ScheduledQueryRules/disable/action",
        "localizedValue": "Microsoft.Insights/ScheduledQueryRules/disable/action"
    },
    "resourceGroupName": "<Resource Group>",
    "resourceProviderName": {
        "value": "MICROSOFT.INSIGHTS",
        "localizedValue": "Microsoft Insights"
    },
    "resourceType": {
        "value": "MICROSOFT.INSIGHTS/scheduledqueryrules",
        "localizedValue": "MICROSOFT.INSIGHTS/scheduledqueryrules"
    },
    "resourceId": "/SUBSCRIPTIONS/<subscriptionId>/RESOURCEGROUPS/<ResourceGroup>/PROVIDERS/MICROSOFT.INSIGHTS/SCHEDULEDQUERYRULES/TEST-BAD-ALERTS",
    "status": {
        "value": "Succeeded",
        "localizedValue": "Succeeded"
    },
    "subStatus": {
        "value": "",
        "localizedValue": ""
    },
    "submissionTimestamp": "2019-03-22T04:18:22.8569543Z",
    "subscriptionId": "<SubscriptionId>",
    "properties": {
        "resourceId": "/SUBSCRIPTIONS/<subscriptionId>/RESOURCEGROUPS/<ResourceGroup>/PROVIDERS/MICROSOFT.INSIGHTS/SCHEDULEDQUERYRULES/TEST-BAD-ALERTS",
        "subscriptionId": "<SubscriptionId>",
        "resourceGroup": "<ResourceGroup>",
        "eventDataId": "12e12345-12dd-1234-8e3e-12345b7a1234",
        "eventTimeStamp": "03/22/2019 04:18:22",
        "issueStartTime": "03/22/2019 04:18:22",
        "operationName": "Microsoft.Insights/ScheduledQueryRules/disable/action",
        "status": "Succeeded",
        "reason": "Alert has been failing consistently with the same exception for the past week"
    },
    "relatedEvents": []
}
```

## <a name="next-steps"></a>Дальнейшие шаги

- Ознакомьтесь со сведениями об [оповещениях журналов в Azure](./alerts-unified-log.md).
- Дополнительные сведения о [настройке оповещений журнала](../log-query/log-query-overview.md).
- Дополнительные сведения о [запросах журналов](../log-query/log-query-overview.md).