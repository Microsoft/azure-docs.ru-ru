---
title: Начало работы с автомасштабированием в Azure
description: Узнайте, как масштабировать ресурсы Веб-приложений, Облачных служб, Виртуальных машин и масштабируемых наборов виртуальных машин в Azure.
ms.topic: conceptual
ms.date: 07/07/2017
ms.subservice: autoscale
ms.openlocfilehash: ee36db3f657365036bb68f641be53fd434f1b64b
ms.sourcegitcommit: b6267bc931ef1a4bd33d67ba76895e14b9d0c661
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/19/2020
ms.locfileid: "97694920"
---
# <a name="get-started-with-autoscale-in-azure"></a>Начало работы с автомасштабированием в Azure
В этой статье описывается, как настроить автомасштабирование для ресурса на портале Microsoft Azure.

Автомасштабирование Azure Monitor используется только с [масштабируемыми наборами виртуальных машин](https://azure.microsoft.com/services/virtual-machine-scale-sets/), [облачными службами](https://azure.microsoft.com/services/cloud-services/), [веб-приложениями службы приложений](https://azure.microsoft.com/services/app-service/web/) и [службами управления API](../../api-management/api-management-key-concepts.md).

## <a name="discover-the-autoscale-settings-in-your-subscription"></a>Обнаружение параметров автомасштабирования в подписках

> [!VIDEO https://www.microsoft.com/en-us/videoplayer/embed/RE4u7ts]

Azure Monitor дает возможность обнаружить все ресурсы, для которых можно применить автомасштабирование. Для этой цели вам нужно выполнить следующие действия.

1. Откройте [портал Azure.][1]
1. Щелкните значок Azure на левой панели.
  ![Открытие Azure Monitor][2]
1. Выберите раздел **Автомасштабирование**, чтобы просмотреть все ресурсы, для которых применимо автомасштабирование, и текущее состояние этой настройки для них.
  ![Открытие раздела "Автомасштабирование" в Azure Monitor][3]

Панель фильтрации в верхней части страницы позволяет сузить список до определенной группы ресурсов, отдельных типов ресурсов или одного конкретного ресурса.

Для каждого ресурса вы увидите здесь текущее количество экземпляров и состояние автомасштабирования. Состояние автомасштабирования может принимать одно из перечисленных ниже значений.

- **Не настроено**. Автомасштабирование еще не настроено для этого ресурса.
- **Включено**. Автомасштабирование включено для этого ресурса.
- **Отключено**. Автомасштабирование отключено для этого ресурса.

## <a name="create-your-first-autoscale-setting"></a>Создание параметра автомасштабирования

Теперь выполним простые пошаговые инструкции для создания параметра автомасштабирования.

1. В Azure Monitor откройте колонку **Автомасштабирование** и выберите ресурс, который нужно масштабировать. (В примере ниже используется план службы приложений, связанный с веб-приложением. Вы можете [за пять минут создать первое веб-приложение ASP.NET в Azure][4]).
1. Как видите, текущее количество экземпляров имеет значение 1. Щелкните **Включить автомасштабирование**.
  ![Параметр масштабирования для нового веб-приложения][5]
1. Укажите имя для параметра масштабирования и щелкните **Добавить правило**. Параметры правила масштабирования откроются в виде контекстной области справа. По умолчанию устанавливается следующее правило: количество экземпляров увеличивается на 1, когда загрузка ЦП для ресурса превышает уровень 70 %. Не изменяйте эти значения по умолчанию, а просто нажмите **Добавить**.
  ![Создание параметра масштабирования для веб-приложения][6]
1. Итак, вы создали первое правило масштабирования. В этом же интерфейсе вы увидите некоторые рекомендация по настройке, например: "Рекомендуется настроить не меньше одного правила увеличения масштаба". Для этого:

    а. Щелкните **Добавить правило**.

    b. Для параметра **Оператор** установите значение **Меньше, чем**.

    c. Для параметра **Пороговое значение** задайте значение **20**.

    d. Для параметра **Операция** установите значение **Уменьшить счетчик на**.

   Теперь у вас есть параметр масштабирования, который изменяет масштаб в зависимости от показателей загрузки ЦП.
   ![Масштабирование на основе загрузки ЦП][8]
1. Выберите команду **Сохранить**.

Поздравляем! Вы успешно создали первый параметр масштабирования, который будет автомасштабировать веб-приложение, исходя из загрузки ЦП.

> [!NOTE]
> Эти действия можно применить для настройки масштабируемого набора виртуальных машин или ролей облачной службы.

## <a name="other-considerations"></a>Другие замечания
### <a name="scale-based-on-a-schedule"></a>Масштабирование на основе расписания
Помимо загрузки ЦП, в параметрах автомасштабирования можно учитывать определенные дни недели.

1. Щелкните **Add a scale condition** (Добавить условие масштабирования).
1. Настройка режима масштабирования и правил выполняется так же, как и для условий по умолчанию.
1. Выберите **Повторять в определенные дни**, чтобы настроить расписание.
1. Выберите дни и время для начала и окончания периода, в который будет применяться условие масштабирования.

![Условие масштабирования на основе расписания][9]
### <a name="scale-differently-on-specific-dates"></a>Масштабирование в определенные даты
Помимо загрузки ЦП, в параметрах автомасштабирования можно учитывать определенные даты.

1. Щелкните **Add a scale condition** (Добавить условие масштабирования).
1. Настройка режима масштабирования и правил выполняется так же, как и для условий по умолчанию.
1. Выберите **Укажите даты начала и окончания**, чтобы настроить расписание.
1. Выберите даты для начала и окончания периода, в который будет применяться условие масштабирования.

![Условие масштабирования на основе дат][10]

### <a name="view-the-scale-history-of-your-resource"></a>Просмотр журнала масштабирования ресурса
Каждый раз, когда масштабируется ресурс, в журнале действий регистрируется событие. Вы можете просмотреть журнал масштабирования ресурса за последние 24 часа, открыв вкладку **Журнал запусков**.

![Журнал выполнения][11]

Если вы хотите просмотреть полный журнал масштабирования (до 90 дней), выберите действие **Щелкните здесь, чтобы просмотреть дополнительные сведения**. Откроется журнал действий автомасштабирования, в котором уже выбраны нужный ресурс и категория.

### <a name="view-the-scale-definition-of-your-resource"></a>Просмотр определения масштабирования для ресурса
Автомасштабирование считается ресурсом Azure Resource Manager. Определение масштабирования можно просмотреть в формате JSON. Для этого откройте вкладку **JSON**.

![Определение масштабирования][12]

При необходимости можно внести изменения в JSON напрямую. Эти изменения будут применены, как только вы их сохраните.

### <a name="disable-autoscale-and-manually-scale-your-instances"></a>Отключение автомасштабирования и масштабирование экземпляров вручную
Иногда необходимо отключить действующий параметр масштабирования и масштабировать ресурс вручную.

Для этого нажмите **Отключить автомасштабирование** в верхней части страницы.
![Отключение автомасштабирования][13]

> [!NOTE]
> Это действие отключает настроенную конфигурацию. Вы всегда можете вернуть прежний режим, включив автомасштабирование.

При отключенном автомасштабировании вы можете вручную задать нужное количество экземпляров.

![Настройка масштабирования вручную][14]

Автомасштабирование можно возобновить в любой момент, щелкнув здесь же **Включить автомасштабирование**, а затем — **Сохранить**.

## <a name="route-traffic-to-healthy-instances-app-service"></a>Маршрутизация трафика в работоспособные экземпляры (служба приложений)

При масштабировании на несколько экземпляров служба приложений может выполнять проверки работоспособности экземпляров для маршрутизации трафика только в работоспособные экземпляры. Для этого откройте портал в службе приложений, а затем выберите **Проверка работоспособности** в разделе **мониторинг**. Выберите **включить** и укажите допустимый путь URL-адреса в приложении, например `/health` или `/api/health` . Выберите команду **Сохранить**.

Чтобы включить функцию с шаблонами ARM, задайте для `healthcheckpath` свойства `Microsoft.Web/sites` ресурса путь проверки работоспособности на сайте, например: `"/api/health/"` . Чтобы отключить эту функцию, снова задайте для свойства пустую строку `""` .

### <a name="health-check-path"></a>Путь проверки работоспособности

Путь должен отвечать в течение одной минуты с кодом состояния от 200 до 299 (включительно). Если путь не отвечает в течение одной минуты или возвращает код состояния за пределами диапазона, то экземпляр считается неработоспособным. Служба приложений не соответствует повышалась (301, 302, 307 и т. д.) перенаправляет путь проверки работоспособности. Эти коды состояния считаются **неработоспособными**. Проверка работоспособности интегрируется с функциями проверки подлинности и авторизации службы приложений. система будет обращаться к конечной точке, даже если эти функции безопасности включены. При использовании собственной системы проверки подлинности путь проверки работоспособности должен разрешить анонимный доступ. Если на сайте включено только HTTP **s**, запрос Healthcheck будет отправлен через HTTP **s**.

Путь проверки работоспособности должен проверять критические компоненты приложения. Например, если приложение зависит от базы данных и системы обмена сообщениями, конечная точка проверки работоспособности должна подключаться к этим компонентам. Если приложение не может подключиться к критическому компоненту, то путь должен вернуть код ответа уровня 500, чтобы указать, что приложение является неработоспособным.

#### <a name="security"></a>Безопасность 

Группам разработчиков на крупных предприятиях часто приходится соблюдать требования к безопасности для предоставляемых API. Чтобы защитить конечную точку Healthcheck, сначала следует использовать такие функции, как [ограничения IP-адресов](../../app-service/app-service-ip-restrictions.md#set-an-ip-address-based-rule), [сертификаты клиентов](../../app-service/app-service-ip-restrictions.md#set-an-ip-address-based-rule)или виртуальная сеть, чтобы ограничить доступ к приложению. Вы можете защитить конечную точку Healthcheck, запросив, что `User-Agent` входящий запрос соответствует `ReadyForRequest/1.0` . Невозможно подменить User-Agent, так как запрос уже защищен с помощью предыдущих функций безопасности.

### <a name="behavior"></a>Поведение

При указании пути проверки работоспособности служба приложений будет проверять связь с путем на всех экземплярах. Если код успешного ответа не получен после 5 проверок связи, этот экземпляр считается неработоспособным. Неработоспособные экземпляры будут исключены из вращения балансировщика нагрузки при масштабировании до 2 или более экземпляров и с использованием [уровня "базовый](../../app-service/overview-hosting-plans.md) " или выше. Можно настроить необходимое число неудачных проверок связи с помощью `WEBSITE_HEALTHCHECK_MAXPINGFAILURES` параметра приложения. Для этого параметра приложения можно задать любое целое число от 2 до 10. Например, если задано значение `2` , экземпляры будут удалены из балансировщика нагрузки после двух неудачных проверок связи. Кроме того, при увеличении или уменьшении масштаба служба приложений выполнит проверку связи с путем проверки работоспособности, чтобы убедиться, что новые экземпляры готовы к выполнению запросов перед добавлением в подсистему балансировки нагрузки.

> [!NOTE]
> Помните, что план службы приложений необходимо масштабировать до 2 или более экземпляров и быть **базовым или более высоким** , чтобы исключить подсистему балансировки нагрузки. Если у вас только один экземпляр, он не будет удален из балансировщика нагрузки, даже если он неисправен. 

Кроме того, путь проверки работоспособности проверяется при добавлении или перезапуске экземпляров, например во время операций масштабирования, ручного перезапуска или развертывания кода на сайте SCM. В случае сбоя проверки работоспособности во время этих операций экземпляры, которые не будут добавлены в подсистему балансировки нагрузки, не добавляются. Это предотвращает негативное влияние этих операций на доступность приложения.

При использовании Healthcheck оставшиеся работоспособные экземпляры могут испытывать повышенную нагрузку. Во избежание перегрузки оставшихся экземпляров не будет исключено больше половины экземпляров. Например, если план службы приложений масштабируется до 4 экземпляров и 3 из которых являются неработоспособными, не будет исключаться из смены подсистемы балансировки нагрузки. Остальные 2 экземпляра (1 работоспособные и 1 неработоспособные) продолжат принимать запросы. В наихудшем сценарии, в котором все экземпляры находятся в неработоспособном состоянии, ни одно из них не будет исключено. Если вы хотите переопределить это поведение, можно задать `WEBSITE_HEALTHCHECK_MAXUNHEALTHYWORKERPERCENT` для параметра приложения значение от `0` до `100` . Если задать для этого параметра более высокое значение, то будут удалены более неработоспособные экземпляры (значение по умолчанию — 50).

Если проверка работоспособности не пройдена для всех приложений в экземпляре в течение одного часа, экземпляр будет заменен. В час будет заменено не более одного экземпляра, а для каждого плана службы приложений — не более трех экземпляров в день.

### <a name="monitoring"></a>Мониторинг

После предоставления пути к проверке работоспособности приложения можно отслеживать работоспособность сайта с помощью Azure Monitor. В колонке **Проверка работоспособности** на портале щелкните **метрики** на верхней панели инструментов. Откроется новая колонка, в которой можно просмотреть историю состояния работоспособности сайта и создать новое правило генерации оповещений. Дополнительные сведения о мониторинге сайтов см. [в разделе Azure Monitor](../../app-service/web-sites-monitor.md).

## <a name="moving-autoscale-to-a-different-region"></a>Перемещение автомасштабирования в другой регион
В этом разделе описывается, как переместить Автомасштабирование Azure в другой регион в той же подписке и группе ресурсов. Для перемещения параметров автомасштабирования можно использовать REST API.
### <a name="prerequisite"></a>Предварительные требования
1. Убедитесь, что подписка и группа ресурсов доступны, а сведения в исходном и целевом регионах идентичны.
1. Убедитесь, что Автомасштабирование Azure доступно в [регионе Azure, который вы хотите переместить](https://azure.microsoft.com/global-infrastructure/services/?products=monitor&regions=all).

### <a name="move"></a>Переместить
Используйте [REST API](/rest/api/monitor/autoscalesettings/createorupdate) , чтобы создать параметр автомасштабирования в новой среде. Параметр автомасштабирования, созданный в целевом регионе, будет копией параметра автомасштабирования в исходном регионе.

Не удается переместить [параметры диагностики](./diagnostic-settings.md) , созданные в связи с параметром автомасштабирования в исходном регионе. После завершения создания параметров автопродажи необходимо будет повторно создать параметры диагностики в целевом регионе. 

### <a name="learn-more-about-moving-resources-across-azure-regions"></a>Дополнительные сведения о перемещении ресурсов в регионах Azure
Дополнительные сведения о перемещении ресурсов между регионами и аварийным восстановлением в Azure см. в статье [Перемещение ресурсов в новую группу ресурсов или подписку](../../azure-resource-manager/management/move-resource-group-and-subscription.md) .

## <a name="next-steps"></a>Дальнейшие действия
- [Создайте оповещение журнала действий, чтобы отслеживать все операции системы автомасштабирования в подписке](https://github.com/Azure/azure-quickstart-templates/tree/master/monitor-autoscale-alert).
- [Создайте оповещение журнала действий, чтобы отслеживать все сбои автомасштабирования в подписке](https://github.com/Azure/azure-quickstart-templates/tree/master/monitor-autoscale-failed-alert).

<!--Reference-->
[1]:https://portal.azure.com
[2]: ./media/autoscale-get-started/azure-monitor-launch.png
[3]: ./media/autoscale-get-started/discover-autoscale-azure-monitor.png
[4]: ../../app-service/quickstart-dotnetcore.md
[5]: ./media/autoscale-get-started/scale-setting-new-web-app.png
[6]: ./media/autoscale-get-started/create-scale-setting-web-app.png
[7]: ./media/autoscale-get-started/scale-in-recommendation.png
[8]: ./media/autoscale-get-started/scale-based-on-cpu.png
[9]: ./media/autoscale-get-started/scale-condition-schedule.png
[10]: ./media/autoscale-get-started/scale-condition-dates.png
[11]: ./media/autoscale-get-started/scale-history.png
[12]: ./media/autoscale-get-started/scale-definition-json.png
[13]: ./media/autoscale-get-started/disable-autoscale.png
[14]: ./media/autoscale-get-started/set-manualscale.png
