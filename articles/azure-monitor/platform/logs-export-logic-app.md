---
title: Архивация данных из рабочей области Log Analytics в службу хранилища Azure с помощью приложения логики
description: Описывает метод использования Azure Logic Apps для запроса данных из Log Analytics рабочей области и их отправки в службу хранилища Azure.
ms.service: azure-monitor
ms.subservice: logs
ms.topic: conceptual
author: bwren
ms.author: bwren
ms.date: 10/02/2020
ms.openlocfilehash: 21b9d73da0df5ada626500a706a19d1025de1dcc
ms.sourcegitcommit: d4734bc680ea221ea80fdea67859d6d32241aefc
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/14/2021
ms.locfileid: "100391972"
---
# <a name="archive-data-from-log-analytics-workspace-to-azure-storage-using-logic-app"></a>Архивация данных из рабочей области Log Analytics в службу хранилища Azure с помощью приложения логики
В этой статье описывается метод использования [Azure Logic Apps](../../logic-apps/index.yml) для запроса данных из log Analytics рабочей области в Azure Monitor и их отправки в службу хранилища Azure. Используйте этот процесс, если необходимо экспортировать данные журнала Azure Monitor для сценариев аудита и соответствия или разрешить другой службе получать эти данные.  

## <a name="other-export-methods"></a>Другие методы экспорта
Метод, описанный в этой статье, описывает запланированный экспорт из запроса журнала с помощью приложения логики. Далее приведены другие варианты экспорта данных для определенных сценариев.

- Чтобы экспортировать все данные из рабочей области Log Analytics в учетную запись хранения Azure или концентратор событий, используйте функцию экспорта данных рабочей области Log Analytics в журналах Azure Monitor. См. раздел [Экспорт данных рабочей области log Analytics в Azure Monitor (Предварительная версия)](logs-data-export.md) .
- Однократный экспорт с помощью приложения логики. [Logic Apps и автоматизация питания см. в разделе Azure Monitor журналов](logicapp-flow-connector.md).
- Один раз экспортируйте на локальный компьютер с помощью скрипта PowerShell. См. раздел [Invoke-Азоператионалинсигхтскуерекспорт]] ( https://www.powershellgallery.com/packages/Invoke-AzOperationalInsightsQueryExport) .

## <a name="overview"></a>Обзор
В этой процедуре используется [соединитель Azure Monitor Logs](/connectors/azuremonitorlogs/) , который позволяет выполнять запрос журнала из приложения логики и использовать его выходные данные в других действиях рабочего процесса. [Соединитель хранилища BLOB-объектов Azure](/connectors/azureblob/) используется в этой процедуре для отправки выходных данных запроса в службу хранилища Azure. Другие действия описаны в следующих разделах.

![Обзор приложения логики](media/logs-export-logicapp/logic-app-overview.png)

При экспорте данных из рабочей области Log Analytics необходимо отфильтровать и выполнить статистическую обработку данных журнала и оптимизировать запрос, чтобы ограничить объем данных, обрабатываемых рабочим процессом приложения логики, необходимыми данными. Например, если необходимо архивировать события входа, можно отфильтровать необходимые события и проецировать только необходимые поля с помощью следующего запроса: 

```json
SecurityEvent
| where EventID == 4624 or EventID == 4625
| project TimeGenerated , Account , AccountType , Computer
```

При экспорте данных по расписанию используйте функцию ingestion_time () в запросе, чтобы не пропустить последние данные. Если данные откладываются из-за проблем с сетью или платформой, использование времени приема гарантирует, что оно будет включено в следующее выполнение приложения логики. Пример см. в разделе [добавление Azure Monitor журналов](#add-azure-monitor-logs-action) .

## <a name="prerequisites"></a>Предварительные требования
Ниже приведены предварительные требования, которые необходимо выполнить перед выполнением этой процедуры.

- Рабочая область Log Analytics. Пользователь, создающий приложение логики, должен иметь по крайней мере разрешение на чтение для рабочей области. 
- Учетная запись хранения Azure. Учетная запись хранения не обязательно должна находиться в той же подписке, что и Рабочая область Log Analytics. Пользователь, создающий приложение логики, должен иметь разрешение на запись в учетную запись хранения. 


## <a name="connector-limits"></a>Ограничения соединителей
Log Analytics рабочие области и запросы журналов в Azure Monitor — это службы многоаренды, которые включают ограничения, которые защищают и изолируют клиентов и поддерживают качество обслуживания. При запросе большого объема данных следует учитывать следующие ограничения, которые могут повлиять на настройку периодичности приложения логики и запрос журнала.

- Запросы журнала не могут возвращать более 500 000 строк.
- Запросы журнала не могут возвращать более 64 000 000 байт.
- По умолчанию запросы журнала не могут выполняться дольше 10 минут. 
- Log Analytics соединителя ограничено 100 вызовом в минуту.


## <a name="create-container-in-the-storage-account"></a>Создание контейнера в учетной записи хранения
Используйте процедуру в разделе [Создание контейнера](../../storage/blobs/storage-quickstart-blobs-portal.md#create-a-container) , чтобы добавить контейнер в учетную запись хранения для хранения экспортированных данных. Имя, используемое для контейнера в этой статье, — **loganalytics-Data**, но можно использовать любое имя.


## <a name="create-logic-app"></a>Создание приложения логики

Перейдите в **Logic Apps** в портал Azure и нажмите кнопку **Добавить**. Выберите **подписку**, **группу ресурсов** и **регион** для хранения нового приложения логики и присвойте ему уникальное имя. Вы можете включить **log Analytics** параметр, чтобы получать сведения о данных и событиях времени выполнения, как описано в разделе [Настройка Azure Monitor журналов и получение диагностических данных для Azure Logic Apps](../../logic-apps/monitor-logic-apps-log-analytics.md). Этот параметр не требуется для использования соединителя журналов Azure Monitor.

![Создание приложения логики](media/logs-export-logicapp/create-logic-app.png)


Щелкните **проверить + создать** , а затем **создать**. После завершения развертывания щелкните **Перейти к ресурсу** , чтобы открыть **конструктор Logic Apps**.

## <a name="create-a-trigger-for-the-logic-app"></a>Создание триггера для приложения логики
В разделе **Запуск с общим триггером** выберите **повторение**. Будет создано приложение логики, которое автоматически запускается с постоянным интервалом. В поле **Частота** действия выберите **день** и в поле **интервал** введите **1** , чтобы запустить рабочий процесс один раз в день.

![Действие повторения](media/logs-export-logicapp/recurrence-action.png)


### <a name="add-azure-monitor-logs-action"></a>Действие "добавить Azure Monitor журналов"
Щелкните **+ новый шаг** , чтобы добавить действие, выполняемое после действия повторение. В разделе **Выбор действия** введите **Azure Monitor** , а затем выберите **Azure Monitor журналы**.

![Действие Azure Monitor журналов](media/logs-export-logicapp/select-azure-monitor-connector.png)

Щелкните **Azure log Analytics — запуск запроса и вывод списка результатов**.

![Снимок экрана нового действия, добавляемого к шагу в конструкторе приложений логики. Azure Monitor журналы выделяются в разделе Выберите действие.](media/logs-export-logicapp/select-query-action-list.png)

Вам будет предложено выбрать клиент и предоставить доступ к рабочей области Log Analytics с учетной записью, которую рабочий процесс будет использовать для выполнения запроса.


## <a name="add-azure-monitor-logs-action"></a>Действие "добавить Azure Monitor журналов"
Действие Azure Monitor журналы позволяет указать запрос для выполнения. Запрос журнала, используемый в этом примере, оптимизирован для почасового повторения и собирает данные, полученные для определенного времени выполнения. Например, если рабочий процесс выполняется в 4:35, диапазон времени будет составлять от 4:00 до 5:00. Если изменение приложения логики выполняется с другой периодичностью, необходимо также изменить запрос. Например, если вы настроили повторение для ежедневного выполнения, задайте значение startTime в запросе в стартофдай (make_datetime (год, месяц, день, 0, 0)). 

Выберите **подписку** и **группу ресурсов** для рабочей области log Analytics. Выберите *рабочую область log Analytics* для **типа ресурса** , а затем выберите имя рабочей области в разделе **имя ресурса**.

В окне **Запрос** добавьте следующий запрос журнала.  

```Kusto
let dt = now();
let year = datetime_part('year', dt);
let month = datetime_part('month', dt);
let day = datetime_part('day', dt);
let hour = datetime_part('hour', dt);
let startTime = make_datetime(year,month,day,hour,0)-1h;
let endTime = startTime + 1h - 1tick;
AzureActivity
| where ingestion_time() between(startTime .. endTime)
| project 
    TimeGenerated,
    BlobTime = startTime, 
    OperationName ,
    OperationNameValue ,
    Level ,
    ActivityStatus ,
    ResourceGroup ,
    SubscriptionId ,
    Category ,
    EventSubmissionTimestamp ,
    ClientIpAddress = parse_json(HTTPRequest).clientIpAddress ,
    ResourceId = _ResourceId 
```

**Диапазон времени** определяет записи, которые будут включены в запрос на основе столбца **timegenerated** . Для него должно быть установлено значение, равное или превышающее диапазон времени, выбранный в запросе. Поскольку этот запрос не использует столбец **timegenerated** , параметр **задать в запросе** недоступен. Дополнительные сведения о диапазоне времени см. в разделе [область запроса](../log-query/scope.md) . 

Выберите **последние 4 часа** для **диапазона времени**. Это обеспечит включение в результаты всех записей с временем приема, превышающим **timegenerated** .
   
![Снимок экрана параметров для нового действия "регистрация" Azure Monitor "выполнить запрос" и визуализировать результаты.](media/logs-export-logicapp/run-query-list-action.png)


### <a name="add-parse-json-activity-optional"></a>Добавление действия "анализ JSON" (необязательно)
Выходные данные действия " **выполнить запрос" и "список результатов** " форматируются в формате JSON. Вы можете проанализировать эти данные и управлять ими в рамках действия подготовки к **формированию** . 

Вы можете предоставить схему JSON, описывающую полезные данные, которые предполагается получить. С помощью этой схемы конструктор выполняет синтаксический анализ содержимого JSON и создает удобные пользовательские токены, представляющие свойства в содержимом JSON. Можно легко ссылаться на эти свойства и использовать их во время рабочего процесса приложения логики. 


Щелкните **+ новый шаг**, а затем — **+ Добавить действие**. В разделе **Выбор действия** введите **JSON** , а затем выберите **анализ JSON**.

![Выбор действия "анализ JSON"](media/logs-export-logicapp/select-parse-json.png)

Щелкните поле **Content (содержимое** ), чтобы отобразить список значений предыдущих действий. Выберите **текст** в действии **выполнить запрос и отобразить результаты** . Это выходные данные запроса журнала.

[![Выбрать текст](media/logs-export-logicapp/select-body.png)](media/logs-export-logicapp/select-body.png#lightbox)

5.  Щелкните **использовать образец полезных данных, чтобы создать схему**. Выполните запрос журнала и скопируйте выходные данные для образца полезных данных.  Для примера запроса можно использовать следующие выходные данные:


```json
{
    "TimeGenerated": "2020-09-29T23:11:02.578Z",
    "BlobTime": "2020-09-29T23:00:00Z",
    "OperationName": "Returns Storage Account SAS Token",
    "OperationNameValue": "MICROSOFT.RESOURCES/DEPLOYMENTS/WRITE",
    "Level": "Informational",
    "ActivityStatus": "Started",
    "ResourceGroup": "monitoring",
    "SubscriptionId": "00000000-0000-0000-0000-000000000000",
    "Category": "Administrative",
    "EventSubmissionTimestamp": "2020-09-29T23:11:02Z",
    "ClientIpAddress": "192.168.1.100",
    "ResourceId": "/subscriptions/00000000-0000-0000-0000-000000000000/resourcegroups/monitoring/providers/microsoft.storage/storageaccounts/my-storage-account"
}
```



![Анализ полезных данных JSON](media/logs-export-logicapp/parse-json-payload.png)

## <a name="add-the-compose-action"></a>Добавление действия создания
Действие **создания** принимает проанализированные выходные данные JSON и создает объект, который необходимо сохранить в большом двоичном объекте.

Щелкните **+ новый шаг**, а затем — **+ Добавить действие**. В разделе **Выбор действия** введите команду **создать** , а затем выберите действие **создать** .

![Выбор действия создания](media/logs-export-logicapp/select-compose.png)


Щелкните поле **входы** , чтобы вывести список значений из предыдущих действий. Выберите **текст** из действия **анализ JSON** . Это проанализированный вывод запроса журнала.

[![Выбрать текст для действия создания](media/logs-export-logicapp/select-body-compose.png)](media/logs-export-logicapp/select-body-compose.png#lightbox)


## <a name="add-the-create-blob-action"></a>Добавление действия "создать BLOB-объект"
Действие создать BLOB-объект записывает сформированный код JSON в хранилище.

Щелкните **+ новый шаг**, а затем — **+ Добавить действие**. В разделе **Выбор действия** введите **BLOB-объект** , а затем выберите действие **создать BLOB** -объект.

![Выберите создать BLOB-объект.](media/logs-export-logicapp/select-create-blob.png)

Введите имя для подключения к учетной записи хранения в поле **имя подключения** , а затем щелкните значок папки в окне **путь к папке** , чтобы выбрать контейнер в вашей учетной записи хранения. Щелкните **имя большого двоичного объекта** , чтобы просмотреть список значений предыдущих действий. Щелкните **выражение** и введите выражение, соответствующее интервалу времени. Для этого запроса, который выполняется ежечасно, следующее выражение задает имя большого двоичного объекта за предыдущий час: 

```json
subtractFromTime(formatDateTime(utcNow(),'yyyy-MM-ddTHH:00:00'), 1,'Hour')
```

[![Выражение BLOB-объекта](media/logs-export-logicapp/blob-expression.png)](media/logs-export-logicapp/blob-expression.png#lightbox)

Щелкните поле **Content BLOB (содержимое большого двоичного объекта** ), чтобы отобразить список значений предыдущих действий, а затем выберите **выходные данные** в разделе **Создание** .


![Создать выражение BLOB-объекта](media/logs-export-logicapp/create-blob.png)


## <a name="test-the-logic-app"></a>Тестирование приложения логики
Протестируйте рабочий процесс, нажав кнопку **выполнить**. Если рабочий процесс содержит ошибки, он будет указан на шаге с проблемой. Можно просмотреть выполнение и выполнить детализацию для каждого шага, чтобы просмотреть входные и выходные данные для изучения сбоев. См. раздел [Устранение неполадок и диагностика сбоев рабочих процессов в Azure Logic Apps](../../logic-apps/logic-apps-diagnosing-failures.md) при необходимости.

[![Журнал запусков](media/logs-export-logicapp/runs-history.png)](media/logs-export-logicapp/runs-history.png#lightbox)


## <a name="view-logs-in-storage"></a>Просмотр журналов в хранилище
Перейдите в меню **учетные записи хранения** в портал Azure и выберите свою учетную запись хранения. Щелкните плитку **BLOB-объекты** и выберите контейнер, указанный в действии создание большого двоичного объекта. Выберите один из больших двоичных объектов, а затем **измените BLOB-объект**.

[![Данные большого двоичного объекта](media/logs-export-logicapp/blob-data.png)](media/logs-export-logicapp/blob-data.png#lightbox)

## <a name="next-steps"></a>Следующие шаги

- Дополнительные сведения о запросах журнала в Azure Monitor см. в [этой статье](../log-query/log-query-overview.md).
- Дополнительные сведения о [Logic Apps](../../logic-apps/index.yml)
- Дополнительные сведения о [Power автоматизируются](https://flow.microsoft.com).
