---
title: Настройка производительности путем кэширования результирующего набора
description: Общие сведения о функции кэширования результирующего набора для выделенного пула SQL в Azure синапсе Analytics
services: synapse-analytics
author: XiaoyuMSFT
manager: craigg
ms.service: synapse-analytics
ms.topic: conceptual
ms.subservice: sql-dw
ms.date: 10/10/2019
ms.author: xiaoyul
ms.reviewer: nidejaco;
ms.custom: azure-synapse
ms.openlocfilehash: d8c6c8d22c059c63fb4f84c84a02a70de30d4ebe
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "98678531"
---
# <a name="performance-tuning-with-result-set-caching"></a>Настройка производительности путем кэширования результирующего набора

Если включено кэширование результирующего набора, выделенный пул SQL автоматически кэширует результаты запроса в пользовательской базе данных для повторяющегося использования.  Это позволяет последующим запросам получать результаты непосредственно из материализованного кэша, поэтому перерасчет не требуется.   Кэширование результирующего набора улучшает производительность запросов и сокращает использование ресурсов вычислений.  Кроме того, запросы, использующие кэшированный результирующий набор, не используют слоты выдачи и поэтому не учитываются для существующих ограничений параллелизма. В целях безопасности пользователи могут получить доступ к кэшированным результатам только в том случае, если они имеют те же разрешения на доступ к данным, что и пользователи, создающие кэшированные результаты.  

## <a name="key-commands"></a>Основные команды

[Включение или выключение кэширования результирующего набора для пользовательской базы данных](/sql/t-sql/statements/alter-database-transact-sql-set-options?toc=/azure/synapse-analytics/sql-data-warehouse/toc.json&bc=/azure/synapse-analytics/sql-data-warehouse/breadcrumb/toc.json&view=azure-sqldw-latest&preserve-view=true)

[Включение или выключение кэширования результирующего набора для сеанса](/sql/t-sql/statements/set-result-set-caching-transact-sql?toc=/azure/synapse-analytics/sql-data-warehouse/toc.json&bc=/azure/synapse-analytics/sql-data-warehouse/breadcrumb/toc.json&view=azure-sqldw-latest&preserve-view=true)

[Проверка размера кэшированного результирующего набора](/sql/t-sql/database-console-commands/dbcc-showresultcachespaceused-transact-sql?toc=/azure/synapse-analytics/sql-data-warehouse/toc.json&bc=/azure/synapse-analytics/sql-data-warehouse/breadcrumb/toc.json&view=azure-sqldw-latest&preserve-view=true)  

[Очистка кэша](/sql/t-sql/database-console-commands/dbcc-dropresultsetcache-transact-sql?toc=/azure/synapse-analytics/sql-data-warehouse/toc.json&bc=/azure/synapse-analytics/sql-data-warehouse/breadcrumb/toc.json&view=azure-sqldw-latest&preserve-view=true)

## <a name="whats-not-cached"></a>Что сохраняется в кэш  

При включении кэширования результирующих наборов для базы данных результаты будут сохраняться в кэше (пока он не заполнится) для всех запросов, кроме следующих:

- Запросы со встроенными функциями или выражениями среды выполнения, которые являются недетерминированными даже при отсутствии изменений в данных или запросах базовых таблиц. Например, DateTime. Now (), GETDATE ().
- запросы с пользовательскими функциями;
- запросы, использующие таблицы с включенной безопасностью уровня строки или столбца;
- запросы, возвращающие данные с размером строк более 64 КБ.
- запросы, возвращающие большой объем данных (больше 10 ГБ). 
>[!NOTE]
> - Некоторые недетерминированные функции и выражения среды выполнения могут быть детерминированными для повторяющихся запросов к одним и тем же данным. Например, ROW_NUMBER ().  
> - Используйте предложение ORDER BY в запросе, если порядок или последовательность строк в результирующем наборе запроса важен для логики приложения.
> - Если данные в столбцах ORDER BY не являются уникальными, гарантид порядок строк для строк с одинаковыми значениями в столбцах ORDER BY не существует, независимо от того, включено или отключено кэширование результирующего набора.

> [!IMPORTANT]
> Операции по созданию кэша результирующего набора и извлечению данных из кэша происходят в управляющем узле выделенного экземпляра пула SQL.
> Если кэширование результирующего набора включено, выполнение запросов, возвращающих большие результирующие наборы (например, больше 1 ГБ), может привести к сильному регулированию на управляющем узле и снизить общую скорость отклика экземпляра на запросы.  Как правило, такие запросы используются в ходе исследования данных, а также при выполнении операций извлечения, преобразования и загрузки. Чтобы избежать чрезмерной загрузки управляющего узла и снижения производительности, перед выполнением запросов такого типа пользователям следует отключить кэширование результирующего набора для базы данных.  

Выполните приведенный ниже запрос, чтобы получить время, затраченное на выполнение операций кэширования результирующего набора для запроса.

```sql
SELECT step_index, operation_type, location_type, status, total_elapsed_time, command
FROM sys.dm_pdw_request_steps
WHERE request_id  = <'request_id'>;
```

Ниже приведен пример выходных данных запроса, выполненного с отключенным кэшированием результирующего набора.

![На снимке экрана показаны результаты запроса, включая тип расположения и команду.](./media/performance-tuning-result-set-caching/query-steps-with-rsc-disabled.png)

А вот пример выходных данных запроса, выполненного с включенным кэшированием результирующего набора.

![На снимке экрана показаны результаты запроса с выбранной командой * from [D W Ресулткаче D b] Dot D b OED.](./media/performance-tuning-result-set-caching/query-steps-with-rsc-enabled.png)

## <a name="when-cached-results-are-used"></a>Когда используются кэшированные результаты

Для запроса повторно используется кэшированный результирующий набор при соблюдении всех следующих требований:

- Пользователь, выполняющий запрос, имеет доступ ко всем таблицам, на которые ссылается запрос.
- Имеется точное соответствие между новым запросом и предыдущим запросом, породившим результирующий набор в кэше.
- Нет изменений в данных или схеме в таблицах, на основе которых создан кэшированный результирующий набор.

Выполните эту команду, чтобы проверить, как был выполнен запрос — с попаданием или промахом в кэше результатов. Столбец result_cache_hit возвращает 1 для попадания в кэше, 0 для промаха кэша и отрицательные значения для причин, по которым кэширование результирующего набора не использовалось. Дополнительные сведения см. в описании [sys.dm_pdw_exec_requests](/sql/relational-databases/system-dynamic-management-views/sys-dm-pdw-exec-requests-transact-sql?toc=/azure/synapse-analytics/sql-data-warehouse/toc.json&bc=/azure/synapse-analytics/sql-data-warehouse/breadcrumb/toc.json&view=azure-sqldw-latest&preserve-view=true).

```sql
SELECT request_id, command, result_cache_hit FROM sys.dm_pdw_exec_requests
WHERE request_id = <'Your_Query_Request_ID'>
```

## <a name="manage-cached-results"></a>Управление кэшированными результатами

Максимальный размер кэша результирующих наборов составляет 1 ТБ на базу данных.  Кэшированные результаты автоматически становятся недействительными при изменении данных базового запроса.  

Исключение кэша управляется выделенным пулом SQL автоматически по следующему расписанию:

- каждые 48 часов, если результирующий набор не использовался или стал недействительным;
- если кэш результирующих наборов достигает максимального размера.

Пользователи могут вручную очистить весь кэш результирующих наборов, воспользовавшись одним из следующих вариантов:

- Отключение функции кэша результирующих наборов для базы данных.
- Выполнение инструкции DBCC DROPRESULTSETCACHE при установленном подключении к базе данных.

Если приостановить базу данных, кэшированный результирующий набор не удаляется.  

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные советы по разработке приведены в [обзоре разработки](sql-data-warehouse-overview-develop.md).
