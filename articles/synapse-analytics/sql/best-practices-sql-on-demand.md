---
title: Рекомендации по использованию бессерверного пула SQL
description: Рекомендации и рекомендации по работе с несерверным пулом SQL.
services: synapse-analytics
author: filippopovic
manager: craigg
ms.service: synapse-analytics
ms.topic: conceptual
ms.subservice: sql
ms.date: 05/01/2020
ms.author: fipopovi
ms.reviewer: jrasnick
ms.openlocfilehash: 93ac8cd3e462c244840a5ed569d685a9d67fa6c2
ms.sourcegitcommit: 16887168729120399e6ffb6f53a92fde17889451
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/13/2021
ms.locfileid: "98165881"
---
# <a name="best-practices-for-serverless-sql-pool-in-azure-synapse-analytics"></a>Рекомендации по использованию бессерверного пула SQL в Azure синапсе Analytics

В этой статье вы найдете набор рекомендаций по использованию бессерверного пула SQL. Бессерверный пул SQL — это ресурс в Azure синапсе Analytics.

## <a name="general-considerations"></a>Общие рекомендации

Бессерверный пул SQL позволяет запрашивать файлы в учетных записях хранения Azure. SQL по запросу не предоставляет возможности локального хранилища или приема данных. Поэтому все файлы, предназначенные для запроса, являются внешними для несерверного пула SQL. Все, что связано с чтением файлов из хранилища, может оказать влияние на производительность запросов.

## <a name="colocate-your-storage-and-serverless-sql-pool"></a>Совместное размещение пула SQL с хранилищем и бессерверным пулом

Чтобы максимально сокращать задержку, совместно находите учетную запись хранения Azure или CosmosDB аналитическое хранилище и конечную точку пула SQL, бессерверной. Учетные записи хранения и конечные точки, подготовленные во время создания рабочей области, расположены в одном регионе.

Для обеспечения оптимальной производительности при доступе к другим учетным записям хранения с помощью бессерверного пула SQL убедитесь, что они находятся в одном регионе. Если они не расположены в одном регионе, будет увеличена задержка сетевой передачи данных между удаленным регионом и регионом конечной точки.

## <a name="azure-storage-throttling"></a>Регулирование службы хранилища Azure

Несколько приложений и служб могут получить доступ к вашей учетной записи хранения. Регулирование хранилища происходит, когда общая скорость операций ввода-вывода или пропускная способность, создаваемая приложениями, службами и рабочей нагрузкой в бессерверном пуле SQL, превышает ограничения учетной записи хранения. В результате вы получаете значительное негативное воздействие на производительность запросов.

При обнаружении регулирования в бессерверном пуле SQL есть встроенная обработка для разрешения этой проблемы. Бессерверный пул SQL делает запросы к хранилищу в более низком темпе, пока регулирование не будет разрешено.

> [!TIP]
> Для оптимального выполнения запросов не следует усложнять работу учетной записи хранения другими рабочими нагрузками во время выполнения запроса.

## <a name="prepare-files-for-querying"></a>Подготовка файлов к запросам

По возможности вы можете подготовить файлы для повышения производительности:

- Преобразование больших CSV-файлов и JSON в Parquet. Parquet — это формат столбцов. Благодаря сжатию файлы в этом формате меньше по размеру, чем CSV- или JSON-файлы с теми же данными. Серверный пул SQL может пропускать столбцы и строки, которые не требуются в запросе, при чтении файлов Parquet. Для бессерверного пула SQL потребуется меньше времени и меньше запросов на хранение.
- Если запрос предназначен для одного большого файла, рекомендуется разделить его на несколько файлов меньшего размера.
- Попробуйте разместить размер CSV-файла от 100 МБ до 10 ГБ.
- Лучше иметь одинаковый размер файлов для одного пути OPENROWSET или для РАСПОЛОЖЕНИЯ внешней таблицы.
- Разделите данные, сохранив разделы в разных папках или файлах. См. раздел [Использование функций fileinfo и filepath для назначения конкретных разделов](#use-filename-and-filepath-functions-to-target-specific-partitions).

## <a name="push-wildcards-to-lower-levels-in-the-path"></a>Отправка подстановочных знаков на более низкие уровни в пути

В пути можно использовать подстановочные знаки, чтобы [запрашивать несколько файлов и папок](query-data-storage.md#query-multiple-files-or-folders). Серверный пул SQL перечисляет файлы в учетной записи хранения, начиная с первого * с помощью API хранилища. При этом файлы, которые не соответствуют указанному пути, исключаются. Сокращение исходного списка файлов может повысить производительность, если есть много файлов, соответствующих указанному пути до первого подстановочного знака.

## <a name="use-appropriate-data-types"></a>Использование соответствующих типов данных

Типы данных, используемые в запросе, влияют на производительность. Производительность можно повысить следующим образом: 

- Используйте наименьший размер данных, соответствующий максимально возможному значению.
  - Если максимальная длина символьного значения равна 30 символам, используйте символьный тип данных длиной 30 символов.
  - Если все символьные значения столбцов имеют фиксированный размер, используйте тип **char** или **nchar**. В противном случае используйте тип **varchar** или **nvarchar**.
  - Если максимальное значение целочисленного столбца равно 500, используйте **smallint**, так как это минимальный тип данных, который может соответствовать этому значению. Диапазоны целочисленных типов данных можно найти в [этой статье](/sql/t-sql/data-types/int-bigint-smallint-and-tinyint-transact-sql?view=azure-sqldw-latest&preserve-view=true).
- По возможности используйте тип **varchar** и **char** вместо **nvarchar** и **nchar**.
- По возможности используйте целочисленные типы данных. Операции SORT, JOIN и GROUP BY выполняются быстрее на основе целых чисел, чем на основе символьных данных.
- Если используется вывод схемы, [проверьте выводимые типы данных](#check-inferred-data-types).

## <a name="check-inferred-data-types"></a>Проверка выводимых типов данных

[Вывод схемы](query-parquet-files.md#automatic-schema-inference) помогает быстро создавать запросы и исследовать данные, не зная схемы файлов. Стоимость этого удобства заключается в том, что выводимые типы данных могут быть больше, чем фактические типы данных. Это происходит, когда в исходных файлах недостаточно сведений, чтобы обеспечить использование соответствующего типа данных. Например, файлы Parquet не содержат метаданных о максимальной длине символьного столбца, Так что бессерверный пул SQL выводит его как varchar (8000).

Вы можете проверить результирующие типы данных запроса с помощью [sp_describe_first_results_set](/sql/relational-databases/system-stored-procedures/sp-describe-first-result-set-transact-sql?view=sql-server-ver15&preserve-view=true).

В следующем примере показано, как оптимизировать выводимые типы данных. Эта процедура используется для отображения выводимых типов данных: 
```sql  
EXEC sp_describe_first_result_set N'
    SELECT
        vendor_id, pickup_datetime, passenger_count
    FROM 
        OPENROWSET(
            BULK ''https://sqlondemandstorage.blob.core.windows.net/parquet/taxi/*/*/*'',
            FORMAT=''PARQUET''
        ) AS nyc';
```

Вот результирующий набор:

|is_hidden|column_ordinal|name|system_type_name|max_length|
|----------------|---------------------|----------|--------------------|-------------------||
|0|1|vendor_id|varchar(8000)|8000|
|0|2|pickup_datetime|datetime2(7)|8|
|0|3|passenger_count|INT|4|

После получения сведений о выводимых типах данных для запроса можно указать соответствующие типы данных:

```sql  
SELECT
    vendor_id, pickup_datetime, passenger_count
FROM 
    OPENROWSET(
        BULK 'https://sqlondemandstorage.blob.core.windows.net/parquet/taxi/*/*/*',
        FORMAT='PARQUET'
    ) 
    WITH (
        vendor_id varchar(4), -- we used length of 4 instead of the inferred 8000
        pickup_datetime datetime2,
        passenger_count int
    ) AS nyc;
```

## <a name="use-filename-and-filepath-functions-to-target-specific-partitions"></a>Использование функций filename и filepath для назначения конкретных разделов

Данные часто организованы в разделы. Можно указать бессерверному пулу SQL запросы к определенным папкам и файлам. Это сокращает количество файлов и объем данных для чтения и обработки в рамках запроса. Дополнительное преимущество — это увеличение производительности.

См. дополнительные сведения о функциях [filename](query-data-storage.md#filename-function) и [filepath](query-data-storage.md#filepath-function), а также примеры [запросов к конкретным файлам](query-specific-files.md).

> [!TIP]
> Всегда приводите результаты функций filepath и filename к соответствующим типам данных. Если используются символьные типы данных, убедитесь, что используется соответствующая длина.

> [!NOTE]
> Функции filepath и filename, используемые для исключения разделов, сейчас не поддерживаются для внешних таблиц (кроме функций, созданных автоматически для каждой таблицы, созданной в Apache Spark для Azure Synapse Analytics).

Если хранимые данные не секционированы, рекомендуем их секционировать. В таком случае вы сможете использовать эти функции для оптимизации запросов, предназначенных для этих файлов. При [запросе секционированных Apache Spark для таблиц Azure синапсе](develop-storage-files-spark-tables.md) из несерверного пула SQL в запросе автоматически будут указываться только необходимые файлы.

## <a name="use-parser_version-20-to-query-csv-files"></a>Использование PARSER_VERSION 2.0 для запросов к CSV-файлам

При запросах к CSV-файлам можно использовать оптимизированное для высокой производительности средство синтаксического анализа. Дополнительные сведения см. в статье о [PARSER_VERSION](develop-openrowset.md).

## <a name="manually-create-statistics-for-csv-files"></a>Создание статистики для CSV-файлов вручную

Бессерверный пул SQL использует статистику для создания оптимальных планов выполнения запросов. Статистика будет автоматически создана для столбцов в файлах Parquet при необходимости. В данный момент статистические данные не создаются автоматически для столбцов в CSV-файлах, и необходимо создавать статистику вручную для столбцов, используемых в запросах, особенно тех, которые используются в разных случаях: DISTINCT, JOIN, WHERE, ORDER BY и GROUP BY. Проверьте [статистику в бессерверном пуле SQL Server] (разработка-Tables-Statistics. md # Statistics-on-Server-SQL-Pool для получения дополнительных сведений.

## <a name="use-cetas-to-enhance-query-performance-and-joins"></a>Использование CETAS для повышения производительности и улучшения соединений запросов

[CETAS](develop-tables-cetas.md) — одна из наиболее важных функций, доступных в бессерверном пуле SQL. CETAS — это параллельная операция, которая создает метаданные внешней таблицы и экспортирует результаты запроса SELECT в набор файлов в учетной записи хранения.

CETAS можно использовать для сохранения часто используемых частей запросов (например, соединенных ссылочных таблиц) в новый набор файлов. Далее можно выполнить объединение с этой отдельной внешней таблицей вместо повторного выполнения операций объединения в нескольких запросах.

Поскольку CETAS создает файлы Parquet, статистика создается автоматически, когда первый запрос обращается к этой внешней таблице, что приводит к повышению производительности для последующих запросов, предназначенных для таблицы, созданной с помощью CETAS.

## <a name="azure-ad-pass-through-performance"></a>Производительность сквозного доступа через Azure AD

Бессерверный пул SQL позволяет получать доступ к файлам в хранилище с помощью Azure Active Directory (Azure AD) или учетных данных SAS. Использование сквозного доступа через Azure AD может вызвать снижение производительности по сравнению с использованием SAS.

Если вы хотите увеличить производительность, попробуйте использовать учетные данные SAS для доступа к хранилищу, пока не будет увеличена производительность сквозного доступа через Azure AD.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о распространенных проблемах и способах их решения см. в статье об [устранении неполадок](../sql-data-warehouse/sql-data-warehouse-troubleshoot.md?toc=/azure/synapse-analytics/toc.json&bc=/azure/synapse-analytics/breadcrumb/toc.json). Если вы работаете с выделенным пулом SQL, а не с бессерверным пулом SQL, ознакомьтесь с рекомендациями [по использованию выделенных ПУЛОВ SQL](best-practices-sql-pool.md) для получения конкретных руководств.
