---
title: Непрерывная интеграция и доставка для рабочей области синапсе
description: Узнайте, как использовать непрерывную интеграцию и доставку для развертывания изменений в рабочей области из одной среды (разработки, тестирования, рабочей) в другой среде.
services: synapse-analytics
author: liud
ms.service: synapse-analytics
ms.topic: conceptual
ms.date: 11/20/2020
ms.author: liud
ms.reviewer: pimorano
ms.openlocfilehash: de3738573bb9bb6f045a45d290c74ba9e6902a5e
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "103561963"
---
# <a name="continuous-integration-and-delivery-for-azure-synapse-workspace"></a>Непрерывная интеграция и доставка для рабочей области Azure синапсе

## <a name="overview"></a>Обзор

Непрерывная интеграция (CI) — это процесс автоматизации сборки и тестирования кода каждый раз, когда член команды фиксирует изменения в системе управления версиями. Непрерывное развертывание (CD) — это процесс создания, тестирования, настройки и развертывания из нескольких тестов или промежуточных сред в рабочей среде.

Для рабочей области Azure синапсе непрерывная интеграция и доставка (CI/CD) перемещают все сущности из одной среды (разработки, тестирования, производства) в другую. Для продвижения рабочей области в другую рабочую область существуют две части: использование [шаблонов Azure Resource Manager](../../azure-resource-manager/templates/overview.md) для создания или обновления ресурсов рабочей области (пулов и рабочих областей); Миграция артефактов (скрипты SQL, записная книжка, определение задания Spark, конвейеры, наборы данных и т. д.) с помощью средств синапсе CI/CD в Azure DevOps. 

В этой статье рассматривается использование конвейера выпуска Azure для автоматизации развертывания рабочей области синапсе в нескольких средах.

## <a name="prerequisites"></a>Предварительные требования

-   В рабочей области, используемой для разработки, настроен репозиторий Git в студии, см. раздел [система управления версиями в синапсе Studio](source-control.md).
-   Проект Azure DevOps был подготовлен для выполнения конвейера выпуска.

## <a name="set-up-a-release-pipelines"></a>Настройка конвейеров выпуска

1.  В [Azure DevOps](https://dev.azure.com/)откройте проект, созданный для выпуска.

1.  В левой части страницы выберите **Конвейеры**, а затем **Выпуски**.

    ![Выбор параметров "Конвейеры", "Выпуски"](media/create-release-1.png)

1.  Выберите **Новый конвейер** или, если у вас есть конвейеры, выберите **Новый**, а затем **Создать конвейер выпуска**.

1.  Выберите шаблон **Пустое задание**.

    ![Выбор шаблона "Пустое задание"](media/create-release-select-empty.png)

1.  В поле **Имя этапа** введите имя своей среды.

1.  Щелкните **Добавить артефакт**, а затем выберите репозиторий Git, настроенный с помощью среды разработки синапсе Studio. Выберите репозиторий Git, который использовался для управления шаблоном ARM пулов и рабочей области. Если вы используете GitHub в качестве источника, необходимо создать подключение к службе для учетной записи GitHub и опрашивающего репозитория. Дополнительные сведения о [подключении службы](/azure/devops/pipelines/library/service-endpoints) 

    ![Добавить ветвь публикации](media/release-creation-github.png)

1.  Выберите ветвь шаблона ARM для обновления ресурсов. Для поля **Версия по умолчанию** выберите **Последний из ветви по умолчанию**.

    ![Добавить шаблон ARM](media/release-creation-arm-branch.png)

1.  Выберите [опубликовать ветвь](source-control.md#configure-publishing-settings) репозитория для поля **Ветвь по умолчанию**. По умолчанию эта ветвь публикации имеет значение `workspace_publish`. Для поля **Версия по умолчанию** выберите **Последний из ветви по умолчанию**.

    ![Добавление артефакта](media/release-creation-publish-branch.png)

## <a name="set-up-a-stage-task-for-arm-resource-create-and-update"></a>Настройка задачи этапа для создания и обновления ресурсов ARM 

Добавьте задачу развертывания Azure Resource Manager для создания или обновления ресурсов, включая рабочую область и пулы:

1. В представлении этапа выберите **Просмотр задач этапа**.

    ![Представлении этапа](media/release-creation-stage-view.png)

1. Создайте задачу. Найдите **Развертывание шаблона ARM** и нажмите кнопку **Добавить**.

1. В задаче развертывание выберите подписку, группу ресурсов и расположение для целевой рабочей области. При необходимости предоставьте учетные данные.

1. В списке **Действие** выберите **Create or update resource group** (Создание или изменение группы ресурсов).

1. Нажмите кнопку с многоточием ( **…** ) рядом с полем **Шаблон**. Поиск шаблона Azure Resource Manager целевой рабочей области

1. Выберите **…** рядом с полем **Параметры шаблона** для выбора файла параметров.

1. Выберите **…** рядом с полем **переопределить параметры шаблона** и введите значения требуемых параметров для целевой рабочей области. 

1. В поле **Режим развертывания** выберите **Добавочные**.
    
    ![Развертывание рабочей области и пулов](media/pools-resource-deploy.png)

1. Используемых Добавьте **Azure PowerShell** для назначения роли предоставить и обновить рабочую область. Если для создания рабочей области синапсе используется конвейер выпуска, субъект-служба конвейера добавляется в качестве администратора рабочей области по умолчанию. Вы можете запустить PowerShell, чтобы предоставить другим учетным записям доступ к рабочей области. 
    
    ![предоставление разрешения](media/release-creation-grant-permission.png)

 > [!WARNING]
> В режиме полного развертывания ресурсы, которые существуют в группе ресурсов, но не указаны в новом шаблоне диспетчер ресурсов, будут **удалены**. Дополнительные сведения см. в разделе [режимы развертывания Azure Resource Manager](../../azure-resource-manager/templates/deployment-modes.md) .

## <a name="set-up-a-stage-task-for-artifacts-deployment"></a>Настройка задачи этапа для развертывания артефактов 

Расширение [развертывания рабочей области синапсе](https://marketplace.visualstudio.com/items?itemName=AzureSynapseWorkspace.synapsecicd-deploy) используется для развертывания других элементов в рабочей области синапсе, таких как набор данных, скрипт SQL, записная книжка, определение задания Spark, поток данных, конвейер, связанная служба, учетные данные и IR (Integration Runtime).  

1. Поиск и получение расширения из **Azure DevOps Marketplace**(https://marketplace.visualstudio.com/azuredevops) 

     ![Получить расширение](media/get-extension-from-market.png)

1. Выберите организацию для установки расширения. 

     ![Установка расширения](media/install-extension.png)

1. Убедитесь, что субъекту-службе конвейера Azure DevOps предоставлено разрешение подписки, а также назначено как администратор рабочей области для целевой рабочей области. 

1. Создайте задачу. Найдите **Развертывание рабочей области синапсе** и нажмите кнопку **Добавить**.

     ![Добавить расширение](media/add-extension-task.png)

1.  В задаче выберите **...** рядом с полем **шаблон** , чтобы выбрать файл шаблона.

1. Выберите **…** рядом с полем **Параметры шаблона** для выбора файла параметров.

1. Выберите подключение, группу ресурсов и имя целевой рабочей области. 

1. Выберите **…** рядом с полем **переопределить параметры шаблона** и введите значения требуемых параметров для целевой рабочей области. 

    ![Развертывание рабочей области синапсе](media/create-release-artifacts-deployment.png)

> [!IMPORTANT]
> В сценариях CI/CD тип среды выполнения интеграции (IR) в разных средах должен совпадать. Например, если у вас есть локальная среда IR в среде разработки, ей необходим также тип "Локальная" в других средах, таких как рабочая и тестовая. Аналогично, если вы совместно используете среды выполнения интеграции в нескольких средах, необходимо настроить их в качестве связанных локальных сред во всех средах (разработки, тестирования и рабочей).

## <a name="create-release-for-deployment"></a>Создать выпуск для развертывания 

После сохранения всех изменений можно выбрать **создать выпуск** , чтобы вручную создать выпуск. Сведения об автоматизации создания выпусков см. в статье [Триггеры выпуска](/azure/devops/pipelines/release/triggers).

   ![Выбор параметра "Создать выпуск"](media/release-creation-manually.png)

## <a name="use-custom-parameters-of-the-workspace-template"></a>Использование пользовательских параметров шаблона рабочей области 

Вы используете автоматизированный CI/CD и хотите изменить некоторые свойства во время развертывания, но свойства не будут параметризованы по умолчанию. В этом случае можно переопределить шаблон параметров по умолчанию.

Чтобы переопределить шаблон параметров по умолчанию, необходимо создать пользовательский шаблон параметров — файл с именем **template-parameters-definition.js** в корневой папке вашей ветви совместной работы Git. Необходимо использовать точное имя файла. При публикации из ветви совместной работы синапсе Рабочая область будет считывать этот файл и использовать его конфигурацию для создания параметров. Если файл не найден, используется шаблон параметров по умолчанию.

### <a name="custom-parameter-syntax"></a>Синтаксис пользовательских параметров

Ниже приведены некоторые рекомендации по созданию файла пользовательских параметров.

* Введите путь к свойству в соответствующем типе сущности.
* Задание имени свойства `*` означает, что необходимо параметризовать все свойства под ним (только на первый уровень, но не рекурсивно). Вы также можете указать исключения в этой конфигурации.
* Установка значения свойства в виде строки указывает, что вы хотите параметризовать свойство. Используйте следующий формат: `<action>:<name>:<stype>`.
   *  `<action>` может быть одним из следующих символов:
      * `=` означает, что текущее значение сохраняется как значение по умолчанию для параметра.
      * `-` означает, что значение по умолчанию для параметра не сохраняется.
      * `|` является особым случаем для секретов из Azure Key Vault для строк подключения или ключей.
   * `<name>` является именем параметра. Если оно пустое, то принимает имя свойства. Если значение начинается со знака `-`, то оно сокращено. Например, `AzureStorage1_properties_typeProperties_connectionString` будет сокращено до `AzureStorage1_connectionString`.
   * `<stype>` тип параметра. Если `<stype>` параметр пуст, используется тип по умолчанию `string` . Поддерживаемые значения: `string` , `securestring` , `int` , `bool` , `object` `secureobject` и `array` .
* Указание массива в файле означает, что соответствующее свойство в шаблоне является массивом. Синапсе перебирает все объекты в массиве с помощью указанного определения. Второй объект, строка, становится именем свойства, которое используется в качестве имени параметра для каждой итерации.
* Определение не может быть указано для экземпляра ресурса. Любое определение применяется ко всем ресурсам этого типа.
* По умолчанию все защищенные строки, такие как секреты Key Vault и защищенные строки, такие как строки подключения, ключи и токены, являются параметризованными.

### <a name="parameter-template-definition-samples"></a>Примеры определения шаблона параметров 

Вот пример того, как выглядит определение шаблона параметра:

```json
{
"Microsoft.Synapse/workspaces/notebooks": {
        "properties":{
            "bigDataPool":{
                "referenceName": "="
            }
        }
    },
    "Microsoft.Synapse/workspaces/sqlscripts": {
     "properties": {
         "content":{
             "currentConnection":{
                    "*":"-"
                 }
            } 
        }
    },
    "Microsoft.Synapse/workspaces/pipelines": {
        "properties": {
            "activities": [{
                 "typeProperties": {
                    "waitTimeInSeconds": "-::int",
                    "headers": "=::object"
                }
            }]
        }
    },
    "Microsoft.Synapse/workspaces/integrationRuntimes": {
        "properties": {
            "typeProperties": {
                "*": "="
            }
        }
    },
    "Microsoft.Synapse/workspaces/triggers": {
        "properties": {
            "typeProperties": {
                "recurrence": {
                    "*": "=",
                    "interval": "=:triggerSuffix:int",
                    "frequency": "=:-freq"
                },
                "maxConcurrency": "="
            }
        }
    },
    "Microsoft.Synapse/workspaces/linkedServices": {
        "*": {
            "properties": {
                "typeProperties": {
                     "*": "="
                }
            }
        },
        "AzureDataLakeStore": {
            "properties": {
                "typeProperties": {
                    "dataLakeStoreUri": "="
                }
            }
        }
    },
    "Microsoft.Synapse/workspaces/datasets": {
        "properties": {
            "typeProperties": {
                "*": "="
            }
        }
    }
}
```
Ниже приведено объяснение того, как создавался предыдущий шаблон, упорядоченный по типу ресурсов.

#### <a name="notebooks"></a>Записные книжки 

* Все свойства в пути `properties/bigDataPool/referenceName` параметризованы со значением по умолчанию. Можно параметризовать подключенный пул Spark для каждого файла записной книжки. 

#### <a name="sql-scripts"></a>Скрипты SQL 

* Свойства (poolName и databaseName) в пути `properties/content/currentConnection` параметризованы как строки без значений по умолчанию в шаблоне. 

#### <a name="pipelines"></a>Конвейеры

* Любое свойство в пути `activities/typeProperties/waitTimeInSeconds` параметризовано. Любое действие в конвейере, которое имеет свойство уровня кода с именем `waitTimeInSeconds` (например, действие `Wait`) параметризовано как число с именем по умолчанию. Но в шаблоне Resource Manager не будет значения по умолчанию. Оно будет обязательным во время развертывания Resource Manager.
* Аналогично, свойство `headers` с именем (например, в `Web` действии) параметризовано с типом `object` (Object). Оно имеет значение по умолчанию, то есть то же значение, что и у исходной фабрики.

#### <a name="integrationruntimes"></a>IntegrationRuntimes

* Все свойства в пути `typeProperties` параметризованы с соответствующими значениями по умолчанию. Например, в свойствах типа `IntegrationRuntimes` есть два свойства: `computeProperties` и `ssisProperties`. Оба типа свойств создаются с соответствующими значениями по умолчанию и типами (объект).

#### <a name="triggers"></a>Триггеры

* В разделе `typeProperties` два свойства являются параметризованными. Первое из них `maxConcurrency`, для которого задано значение по умолчанию и имеет тип `string`. Имя параметра по умолчанию — `<entityName>_properties_typeProperties_maxConcurrency`.
* Свойство `recurrence` также параметризовано. В его разделе все свойства на этом уровне указываются для параметризации в виде строк со значениями по умолчанию и имен параметров. Исключением является свойство `interval`, параметризованное как тип `int`. Имя параметра имеет суффикс `<entityName>_properties_typeProperties_recurrence_triggerSuffix`. Аналогичным образом свойство `freq` — это строка, и параметризовано как строка. Однако свойство `freq` параметризовано без значения по умолчанию. Имя сокращено и имеет суффикс. Например, `<entityName>_freq`.

#### <a name="linkedservices"></a>LinkedServices

* Связанные службы уникальны. Так как связанные службы и наборы данных имеют широкий спектр типов, можно указать настройку для конкретного типа. В этом примере для всех связанных служб типа `AzureDataLakeStore` будет применен конкретный шаблон. Для всех остальных (через `*`) будет применен другой шаблон.
* Свойство `connectionString` будет параметризовано как значение `securestring`. Оно не имеет значения по умолчанию У него будет имя сокращенного параметра с суффиксом `connectionString`.
* Свойство `secretAccessKey` является `AzureKeyVaultSecret` (например, в связанной службе Amazon S3). Оно автоматически параметризовано как секрет Azure Key Vault и получено из настроенного хранилища ключей. Вы также можете параметризовать само хранилище ключей.

#### <a name="datasets"></a>Наборы данных

* Хотя настройка для наборов данных доступна для конкретного типа, можно предоставить конфигурацию без явной настройки уровня \*. В предыдущем примере все свойства набора данных в разделе `typeProperties` были параметризованными.


## <a name="best-practices-for-cicd"></a>Рекомендации для CI/CD

Если вы используете интеграцию Git с рабочей областью синапсе и используете конвейер CI/CD, который перемещает изменения из разработки в тест, а затем в рабочую среду, мы рекомендуем следующие рекомендации:

-   **Интеграция Git.** Настройка только рабочей области разработки синапсе с помощью интеграции с Git. Изменения в рабочих областях тестов и рабочих областей развертываются с помощью CI/CD и не требуют интеграции с Git.
-   **Подготовка пулов перед миграцией артефактов**. Если у вас есть скрипт SQL или Записная книжка, присоединенная к пулам в рабочей области "Разработка", предполагается наличие одинаковых имен пулов в разных средах. 
-   **Инфраструктура как код (IaC)**. Управление инфраструктурой (сетями, виртуальными машинами, подсистемами балансировки нагрузки и топологией подключения) в описательной модели использует те же версии, что и DevOps команда, используемая для исходного кода. 
-   **Другие**. Ознакомьтесь с рекомендациями [по артефактам ADF](../../data-factory/continuous-integration-deployment.md#best-practices-for-cicd)

## <a name="troubleshooting-artifacts-deployment"></a>Устранение неполадок при развертывании артефактов 

### <a name="use-the-synapse-workspace-deployment-task"></a>Использование задачи развертывания рабочей области синапсе

В синапсе существует ряд артефактов, которые не являются ресурсами ARM. Это отличается от фабрики данных Azure. Задача развертывания шаблона ARM не будет правильно работать для развертывания артефактов синапсе
 
### <a name="unexpected-token-error-in-release"></a>Непредвиденная ошибка токена в выпуске

Если в файле параметров есть значения параметров, которые не экранированы, конвейер выпуска не сможет выполнить синтаксический анализ файла и создаст ошибку "непредвиденный токен". Мы рекомендуем переопределить параметры или использовать Azure KeyVault для получения значений параметров. В качестве обходного пути можно также использовать двойные escape-символы.
