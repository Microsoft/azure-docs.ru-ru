---
title: Общие сведения о двойниках устройств в Центре Интернета вещей Azure | Документация Майкрософт
description: Руководство разработчика. Синхронизация данных состояния и конфигурации Центра Интернета вещей и устройств с помощью двойников устройств.
author: nehsin
manager: philmea
ms.author: nehsin
ms.service: iot-hub
services: iot-hub
ms.topic: conceptual
ms.date: 09/29/2020
ms.custom:
- mqtt
- 'Role: Cloud Development'
ms.openlocfilehash: fff4b9157c30203f47c65a74b211e3dbf6426d92
ms.sourcegitcommit: 97c48e630ec22edc12a0f8e4e592d1676323d7b0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/18/2021
ms.locfileid: "101093032"
---
# <a name="understand-and-use-device-twins-in-iot-hub"></a>Общие сведения о двойниках устройств и их использование в Центре Интернета вещей

*Двойникови устройств* — это документы JSON, в которых хранятся сведения о состоянии устройства, включая метаданные, конфигурации и условия. Центр Интернета вещей Azure сохраняет двойник устройства для каждого устройства, подключаемого к Центру Интернета вещей. 

[!INCLUDE [iot-hub-basic](../../includes/iot-hub-basic-whole.md)]

В этой статье рассматриваются следующие вопросы:

* структура двойника устройства: *теги*, *требуемые* и *сообщаемые свойства*;
* операции, которые приложения устройств и серверные части могут выполнить на двойнике устройства.

Двойники устройства используются для выполнения следующих действий:

* Хранение метаданных для конкретного устройства в облаке. Например, расположение развертывания торгового автомата.

* Сообщение сведений о текущем состоянии приложения устройства, таких как доступные возможности и условия. Например, подключение устройства к Центру Интернета вещей по сети мобильной связи или Wi-Fi.

* Синхронизация состояния длительных рабочих процессов между приложением устройства и внутренним приложением. Например, при указании новой версии встроенного ПО в серверной части решения и сообщении различных этапов процесса обновления в приложении для устройства.

* выполнение запроса метаданных, конфигурации или состояния устройства.

Руководство по использованию сообщаемых свойств, сообщений, отправляемых с устройства в облако, или передаче файла см. в статье [Руководство по обмену данными между устройством и облаком](iot-hub-devguide-d2c-guidance.md).

Руководство по использованию требуемых свойств, прямых методов или сообщений, отправляемых из облака на устройство, см. в статье [Руководство по обмену данными между облаком и устройством](iot-hub-devguide-c2d-guidance.md).

Сведения о том, как двойников устройства связаны с моделью устройства, используемой устройством самонастраивающийся Azure IoT, см. в статье [Общие сведения об iot Самонастраивающийся Digital двойников](../iot-pnp/concepts-digital-twin.md).

## <a name="device-twins"></a>Двойники устройства

Двойники устройств хранят сведения об устройствах:

* Устройства и серверные части могут использовать их для синхронизации условий и конфигурации устройства.

* Серверная часть решения может использовать их для выполнения запроса и указания длительных операций.

Жизненный цикл двойника устройства связан с соответствующим [удостоверением устройства](iot-hub-devguide-identity-registry.md). Двойники устройства неявно создаются и удаляются при создании или удалении удостоверения устройства в Центре Интернета вещей.

Двойник устройства является документом JSON, содержащим следующие компоненты:

* **Теги**. Раздел документа JSON, который может считывать и в который может выполнять запись серверная часть решения. Теги не видны для приложений устройств.

* **Требуемые свойства**. Используются совместно с сообщаемыми свойствами для синхронизации конфигурации или условий устройства. В серверной части решения можно задать нужные свойства, а приложение устройства может считывать их. Приложение устройства может также получать уведомления об изменениях в нужных свойствах.

* **Сообщаемые свойства**. Используется совместно с требуемыми свойствами для синхронизации конфигурации или условий устройства. Приложение устройства может задать сообщаемые свойства, а серверная часть решения может считывать и запрашивать их.

* **Свойства удостоверений устройств**. Корень документа JSON двойника устройства содержит свойства только для чтения из соответствующего удостоверения устройства, хранимые в [реестре удостоверений](iot-hub-devguide-identity-registry.md). Свойства `connectionStateUpdatedTime` и `generationId` не будут включаться.

![Снимок экрана свойств двойника устройства](./media/iot-hub-devguide-device-twins/twin.png)

Ниже приведен пример документа JSON двойника устройства:

```json
{
    "deviceId": "devA",
    "etag": "AAAAAAAAAAc=", 
    "status": "enabled",
    "statusReason": "provisioned",
    "statusUpdateTime": "0001-01-01T00:00:00",
    "connectionState": "connected",
    "lastActivityTime": "2015-02-30T16:24:48.789Z",
    "cloudToDeviceMessageCount": 0, 
    "authenticationType": "sas",
    "x509Thumbprint": {     
        "primaryThumbprint": null, 
        "secondaryThumbprint": null 
    }, 
    "version": 2, 
    "tags": {
        "$etag": "123",
        "deploymentLocation": {
            "building": "43",
            "floor": "1"
        }
    },
    "properties": {
        "desired": {
            "telemetryConfig": {
                "sendFrequency": "5m"
            },
            "$metadata" : {...},
            "$version": 1
        },
        "reported": {
            "telemetryConfig": {
                "sendFrequency": "5m",
                "status": "success"
            },
            "batteryLevel": 55,
            "$metadata" : {...},
            "$version": 4
        }
    }
}
```

В корневом объекте содержатся свойства удостоверения устройства и объекты контейнера для свойств `tags`, `reported` и `desired`. Контейнер `properties` содержит некоторые элементы только для чтения (`$metadata`, `$etag` и `$version`), описанные в разделах [Метаданные двойника устройства](iot-hub-devguide-device-twins.md#device-twin-metadata) и [Оптимистичный параллелизм](iot-hub-devguide-device-twins.md#optimistic-concurrency).

### <a name="reported-property-example"></a>Пример сообщаемых свойств

В предыдущем примере двойник устройства содержит свойство `batteryLevel`, сообщаемое приложением устройства. Это свойство позволяет выполнить запрос и работать на устройствах на основе последних сообщенных сведений об уровне заряда аккумулятора. Другой пример: приложение устройства сообщает о возможностях и вариантах подключения устройства.

> [!NOTE]
> Сообщаемые свойства упрощают сценарии, в которых серверной части решения нужно последнее известное значение свойства. Используйте [сообщения, отправленные с устройства в облако](iot-hub-devguide-messages-d2c.md), если серверной части решения нужно обработать данные телеметрии устройства в виде последовательности событий с метками времени, например временные ряды.

### <a name="desired-property-example"></a>Пример требуемого свойства

В предыдущем примере требуемые и сообщаемые свойства двойника устройства `telemetryConfig` используются в серверной части решения и приложении для устройства, чтобы синхронизировать конфигурацию телеметрии для этого устройства. Пример:

1. Серверная часть решения задает требуемое свойство со значением требуемой конфигурации. Ниже приведен фрагмент документа с требуемым заданным свойством:

   ```json
   "desired": {
       "telemetryConfig": {
           "sendFrequency": "5m"
       },
       ...
   },
   ```

2. Приложение устройства получает уведомление об изменении немедленно, если оно подключено, или при первом повторном подключении. Затем приложение устройства сообщает об обновленной конфигурации (или об условии ошибки с помощью свойства `status`). Ниже представлена часть сообщаемого свойства.

   ```json
   "reported": {
       "telemetryConfig": {
           "sendFrequency": "5m",
           "status": "success"
       }
       ...
   }
   ```

3. Серверная часть решения может отслеживать результаты операции изменения конфигурации на множестве устройств, [отправляя запросы](iot-hub-devguide-query-language.md) на двойники устройств.

> [!NOTE]
> Предыдущие фрагменты являются примерами способа кодирования конфигурации устройства и его состояния, оптимизированными для удобства чтения. Центр Интернета вещей не использует специальную схему для требуемых и сообщаемых свойств в двойниках устройств.
> 

Двойники используются для синхронизации длительных операций, например обновления встроенного ПО. Дополнительные сведения о синхронизации и отслеживании длительных операций на устройствах с помощью свойств см. в статье [Настройка устройств с помощью требуемых свойств (Node)](tutorial-device-twins.md).

## <a name="back-end-operations"></a>Операции серверной части

Серверная часть решения выполняет действия в двойнике устройства с помощью следующих атомарных операций, доступных по протоколу HTTPS:

* **Получение двойникаов устройств по идентификатору**. Эта операция возвращает документ двойника устройства, включая теги, а также требуемые и сообщаемые системные свойства.

* **Частичное обновление двойника устройства.** Эта операция позволяет серверной части решения частично обновить теги или требуемые свойства двойника устройства. Частичное обновление выражается в качестве документа JSON, который добавляет или обновляет все свойства. Свойства, для которых указано значение `null`, удаляются. Следующий пример создает требуемое свойство со значением `{"newProperty": "newValue"}`, перезаписывает существующее значение `existingProperty` на `"otherNewValue"` и удаляет `otherOldProperty`. Другие существующие требуемые свойства или теги не изменяются:

   ```json
   {
       "properties": {
           "desired": {
               "newProperty": {
                   "nestedProperty": "newValue"
               },
               "existingProperty": "otherNewValue",
               "otherOldProperty": null
           }
       }
   }
   ```

* **Заменить требуемые свойства**. Эта операция позволяет серверной части решения полностью перезаписать все существующие требуемые свойства и заменить новый документ JSON для `properties/desired`.

* **Заменить теги**. Эта операция позволяет серверной части решения полностью перезаписать все существующие теги и заменить новый документ JSON для `tags`.

* **Получение уведомлений двойника**. Эта операция позволяет серверной части решения получать уведомления при изменении двойника. Для этого в решении Интернета вещей необходимо создать маршрут и присвоить источнику данных значение *twinChangeEvents*. По умолчанию такие маршруты не существуют, поэтому уведомления двойника не отправляются. Если скорость изменения слишком высока или имеются какие-либо другие причины (например, внутренние сбои), Центр Интернета вещей может отправлять только одно уведомление, которое содержит все изменения. Таким образом, если приложению требуется надежный аудит и регистрация всех промежуточных состояний, следует использовать сообщения, отправляемые с устройства в облако. Уведомление двойника содержит свойства и текст.

  - Свойства

    | Имя | Значение |
    | --- | --- |
    $content-type | приложение/json |
    $iothub-enqueuedtime |  Время отправки уведомления |
    $iothub-message-source | twinChangeEvents |
    $content-encoding | utf-8 |
    deviceId | Идентификатор устройства |
    hubName | Имя центра Интернета вещей |
    operationTimestamp | Метка времени операции по стандарту [ISO8601](https://en.wikipedia.org/wiki/ISO_8601) |
    iothub-message-schema | твинчанженотификатион |
    opType | "replaceTwin" или "updateTwin" |

    Системные свойства сообщений начинаются с символов `$`.

  - Текст
        
    Этот раздел содержит все изменения двойника в формате JSON. Он использует тот же формат, что и исправление. разница заключается в том, что он может содержать все разделы двойника: Теги, Properties. reсообщаемые, Properties. и что содержит элементы "$metadata". Например,

    ```json
    {
      "properties": {
          "desired": {
              "$metadata": {
                  "$lastUpdated": "2016-02-30T16:24:48.789Z"
              },
              "$version": 1
          },
          "reported": {
              "$metadata": {
                  "$lastUpdated": "2016-02-30T16:24:48.789Z"
              },
              "$version": 1
          }
      }
    }
    ```

Все предыдущие операции поддерживают [оптимистичный параллелизм](iot-hub-devguide-device-twins.md#optimistic-concurrency) и требуют разрешения **ServiceConnect**, как указано в статье [Управление доступом к Центру Интернета вещей](iot-hub-devguide-security.md).

Помимо выполнения этих операций серверная часть решений может:

* отправлять запросы к двойникам устройств с помощью [языка запросов Центра Интернета вещей](iot-hub-devguide-query-language.md) типа SQL;

* выполнять операции с большими наборами двойников устройств с помощью [заданий](iot-hub-devguide-jobs.md).

## <a name="device-operations"></a>Операции с устройствами

Приложение устройства выполняет действия в двойнике устройства с помощью следующих атомарных операций.

* **Получение двойника устройства.** Эта операция возвращает документ двойникаа устройства (включая требуемые и сообщаемые системные свойства) для подключенного в настоящее время устройства. (Теги не видимы для приложений для устройств.)

* **Частично обновить сообщаемые свойства**. Эта операция позволяет частично обновить сообщаемые свойства подключенного устройства. В этой операции используется тот же формат обновления JSON, как и при частичном обновлении требуемых свойств в серверной части решения.

* **Отслеживать требуемые свойства**. Для подключенного устройства можно настроить немедленное получение уведомлений об обновлениях нужного свойства в момент такого обновления. Устройство выполняет такое же обновление (частичное обновление или полная замена), как и при выполнении в серверной части решения.

Все предыдущие операции требуют разрешения **DeviceConnect**, как указано в статье [Управление доступом к Центру Интернета вещей](iot-hub-devguide-security.md).

[Пакеты SDK для устройств Azure IoT](iot-hub-devguide-sdks.md) упрощают использование указанных выше операций на многих языках и платформах. Дополнительные сведения о примитивах Центра Интернета вещей для синхронизации требуемых свойств см. в разделе [Процедура при повторном подключении устройства](iot-hub-devguide-device-twins.md#device-reconnection-flow).

## <a name="tags-and-properties-format"></a>Формат тегов и свойств

Теги, а также требуемые и сообщаемые свойства являются объектами JSON, на которые накладываются следующие ограничения.

* **Ключи**. все ключи в объектах JSON КОДИРУЮТСЯ в кодировке UTF-8, с учетом регистра и до 1 КБ в длину. Разрешено использовать все знаки, кроме управляющих знаков Юникода (сегменты C0 и C1), а также `.`, `$` и SP.

* **Значения**. все значения в объектах JSON могут иметь следующие типы JSON: Boolean, число, строка, объект. Также поддерживаются массивы.

    * Целые числа могут иметь минимальное значение-4503599627370496 и максимальное значение 4503599627370495.

    * Строковые значения кодируются в кодировке UTF-8 и могут иметь максимальную длину 4 КБ.

* **Глубина**: максимальная глубина объектов JSON в тегах, требуемых свойствах и сообщаемых свойствах равна 10. Например, следующий объект является допустимым:

   ```json
   {
       ...
       "tags": {
           "one": {
               "two": {
                   "three": {
                       "four": {
                           "five": {
                               "six": {
                                   "seven": {
                                       "eight": {
                                           "nine": {
                                               "ten": {
                                                   "property": "value"
                                               }
                                           }
                                       }
                                   }
                               }
                           }
                       }
                   }
               }
           }
       },
       ...
   }
   ```

## <a name="device-twin-size"></a>Размер двойника устройства

Центр Интернета вещей применяет ограничение размера в 8 КБ для значения `tags` , а максимальный размер 32 КБ для каждого значения `properties/desired` и `properties/reported` . Эти итоги являются исключительно для элементов, доступных только для чтения, таких как `$etag` , `$version` и `$metadata/$lastUpdated` .

Размер двойника вычисляются следующим образом:

* Для каждого свойства в документе JSON центр Интернета вещей кумулятивно вычислит и добавляет длину ключа и значения свойства.

* Ключи свойств рассматриваются как строки в кодировке UTF8.

* Значения простых свойств рассматриваются как строки в кодировке UTF8, числовые значения (8 байт) или логические значения (4 байта).

* Размер строк в кодировке UTF8 вычисляется путем подсчета всех символов, за исключением управляющих символов Юникода (сегментов C0 и C1).

* Значения сложных свойств (вложенные объекты) вычисляются на основе размера агрегатных ключей свойств и значений свойств, которые они содержат.

Центр Интернета вещей отклоняется с ошибкой все операции, которые увеличивают размер `tags` `properties/desired` документов, или `properties/reported` выше ограничения.

## <a name="device-twin-metadata"></a>Метаданные двойника устройства

Центр Интернета вещей сохраняет метку времени последнего обновления для каждого объекта JSON в требуемых и сообщаемых свойствах двойника устройства. Метки времени указываются в формате UTC и кодируются в формате [ISO8601](https://en.wikipedia.org/wiki/ISO_8601) (`YYYY-MM-DDTHH:MM:SS.mmmZ`).

Пример:

```json
{
    ...
    "properties": {
        "desired": {
            "telemetryConfig": {
                "sendFrequency": "5m"
            },
            "$metadata": {
                "telemetryConfig": {
                    "sendFrequency": {
                        "$lastUpdated": "2016-03-30T16:24:48.789Z"
                    },
                    "$lastUpdated": "2016-03-30T16:24:48.789Z"
                },
                "$lastUpdated": "2016-03-30T16:24:48.789Z"
            },
            "$version": 23
        },
        "reported": {
            "telemetryConfig": {
                "sendFrequency": "5m",
                "status": "success"
            },
            "batteryLevel": "55%",
            "$metadata": {
                "telemetryConfig": {
                    "sendFrequency": {
                        "$lastUpdated": "2016-03-31T16:35:48.789Z"
                    },
                    "status": {
                        "$lastUpdated": "2016-03-31T16:35:48.789Z"
                    },
                    "$lastUpdated": "2016-03-31T16:35:48.789Z"
                },
                "batteryLevel": {
                    "$lastUpdated": "2016-04-01T16:35:48.789Z"
                },
                "$lastUpdated": "2016-04-01T16:24:48.789Z"
            },
            "$version": 123
        }
    }
    ...
}
```

Эти сведения хранятся на каждом уровне (а не только в конечных элементах структуры JSON) для сохранения обновлений, удаляющих ключи объекта.

## <a name="optimistic-concurrency"></a>Оптимистическая блокировка

Теги, а также требуемые и сообщаемые свойства поддерживают оптимистичный параллелизм.
Теги содержат ETag, например, для [rfc7232)](https://tools.ietf.org/html/rfc7232), который представляет представление JSON тега. ETag можно использовать в операциях условного обновления в серверной части решения, чтобы обеспечить согласованность.

В требуемых и сообщаемых свойствах двойника устройства отсутствует ETag, но они содержат значение `$version`, которое гарантированно будет добавочным. Аналогично ETag для обеспечения согласованности обновлений компонент, выполняющий обновление, использует версию. Например, приложение устройства для сообщаемого свойства или серверная сторона для требуемого свойства.

Версии также полезны, если агент, выполняющий отслеживание (например, приложение устройства, отслеживающее требуемые свойства), должен устранить состояние гонки между результатом извлечения и отправкой уведомлений об обновлении. Дополнительные сведения см. в разделе [Процедура при повторном подключении устройства](iot-hub-devguide-device-twins.md#device-reconnection-flow).

## <a name="device-reconnection-flow"></a>Процедура при повторном подключении устройства

Центр Интернета вещей не сохраняет уведомления об обновлении требуемых свойств для отключенных устройств. Это значит, что подключающееся устройство должно получить весь документ требуемых свойств и подписаться на уведомления об обновлениях. Учитывая возможность возникновения состояния гонки между уведомлениями об обновлениях и полным извлечением, следуйте процедуре ниже:

1. Приложение устройства подключается к Центру Интернета вещей.
2. Приложение устройства подписывается на уведомления об обновлениях требуемых свойств.
3. Приложение устройства получает весь документ требуемых свойств.

Приложение устройства может игнорировать все уведомления со значением `$version`, которое меньше значения версии полного полученного документа или равно ему. Такой подход возможен, так как Центр Интернета вещей гарантирует постоянное увеличение версий.

> [!NOTE]
> Эта логика уже реализована в [пакетах SDK для устройств Azure IoT](iot-hub-devguide-sdks.md). Это описание полезно, только если приложение устройства не может использовать пакеты SDK для устройств Azure IoT и должно программировать интерфейс MQTT напрямую.
> 

## <a name="additional-reference-material"></a>Дополнительные справочные материалы

Другие справочные статьи в руководстве разработчика для Центра Интернета вещей:

* В статье [Руководство. Конечные точки Центра Интернета вещей](iot-hub-devguide-endpoints.md) содержатся сведения о конечных точках, которые каждый Центр Интернета вещей предоставляет для операций управления и среды выполнения.

* Статья [Руководство. Квоты и регулирование в Центре Интернета вещей](iot-hub-devguide-quotas-throttling.md) содержит сведения о квотах, применимых к службе Центра Интернета вещей, и ожидаемом поведении регулирования при использовании службы.

* В статье [Общие сведения о пакетах SDK для Azure IoT и их использование](iot-hub-devguide-sdks.md) указаны различные языковые пакеты SDK, которые можно использовать при разработке приложений для устройств и служб, взаимодействующих с Центром Интернета вещей.

* [Справочник по языку запросов Центра Интернета вещей для двойников устройств, заданий и маршрутизации сообщений](iot-hub-devguide-query-language.md) содержит сведения о языке запросов, который можно использовать для получения сведений о двойниках устройств и заданиях из Центра Интернета вещей.

* В статье [Взаимодействие с Центром Интернета вещей с помощью протокола MQTT](iot-hub-mqtt-support.md) приведены дополнительные сведения о поддержке протокола MQTT в Центре Интернета вещей.

## <a name="next-steps"></a>Следующие шаги

Теперь, когда вы узнали о двойниках устройств, вас могут заинтересовать следующие статьи руководства разработчика для Центра Интернета вещей:

* [Общие сведения о двойниках модулей и их использование в Центре Интернета вещей](iot-hub-devguide-module-twins.md)
* [Общие сведения о прямых методах и информация о вызове этих методов из Центра Интернета вещей](iot-hub-devguide-direct-methods.md)
* [Планирование заданий на нескольких устройствах](iot-hub-devguide-jobs.md)

Чтобы применить некоторые основные понятия, описанные в этой статье, просмотрите следующие руководства по Центру Интернета вещей:

* [Приступая к работе с двойниками устройств (предварительная версия)](iot-hub-node-node-twin-getstarted.md)
* [Использование свойств двойникаа устройства](tutorial-device-twins.md)
* [Управление устройствами с помощью средств Azure IoT для VS Code](iot-hub-device-management-iot-toolkit.md)
