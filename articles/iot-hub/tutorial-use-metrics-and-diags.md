---
title: Учебник. Настройка и использование метрик и журналов с центром Интернета вещей Azure
description: Из этого учебника вы узнаете, как настроить метрики и журналы с центром Интернета вещей Azure и использовать их. Это обеспечит анализ данных для диагностики проблем, которые могут возникнуть в Центре.
author: robinsh
ms.service: iot-hub
services: iot-hub
ms.topic: tutorial
ms.date: 10/29/2020
ms.author: robinsh
ms.custom:
- mvc
- mqtt
- devx-track-azurecli
- devx-track-csharp
ms.openlocfilehash: 099b7f4e812e92503c7ed8e3eb733f2e49ccd8b9
ms.sourcegitcommit: 4b0e424f5aa8a11daf0eec32456854542a2f5df0
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/20/2021
ms.locfileid: "107768077"
---
# <a name="tutorial-set-up-and-use-metrics-and-logs-with-an-iot-hub"></a>Руководство по настройке и использованию метрик и журналов с Центром Интернета вещей

Azure Monitor можно использовать для сбора метрик и журналов Центра Интернета вещей, которые помогут отслеживать работу решения и устранять возникающие проблемы. Из этой статьи вы узнаете, как создавать диаграммы на основе метрик, создавать оповещения, которые инициируются для метрик, как отправлять операции и ошибки Центра Интернета вещей в журналы Azure Monitor и как проверить журналы на наличие ошибок.

В этом учебнике для отправки сообщений в Центр Интернета вещей используется пример Azure [из этой статьи](quickstart-send-telemetry-dotnet.md). Вы всегда можете использовать устройство или другой пример для отправки сообщений, но в таком случае, возможно, придется соответствующим образом изменить несколько шагов.

Прежде чем приступить к работе с этим учебником, ознакомьтесь с концепциями Azure Monitor. Дополнительные сведения см. в статье [Мониторинг Центра Интернета вещей](monitor-iot-hub.md). Дополнительные сведения о метриках и журналах ресурсов, создаваемых Центром Интернета вещей, см. в статье [Справочник по данным мониторинга](monitor-iot-hub-reference.md).

Вот какие шаги выполняются в этом руководстве:

> [!div class="checklist"]
>
> * Использование Azure CLI для создания Центра Интернета вещей, регистрации имитированного устройства и создания рабочей области Log Analytics.  
> * Отправка подключений Центра Интернета вещей и журналов ресурсов телеметрии устройств в журналы Azure Monitor в рабочей области Log Analytics.
> * Использование обозревателя метрик для создания диаграммы на основе выбранных метрик и закрепление ее на панели мониторинга.
> * Создание оповещений метрик, чтобы при возникновении важных условий получать уведомления по электронной почте.
> * Скачивание и запуск приложения, которое имитирует устройство Интернета вещей, отправляющее сообщения в центр.
> * Просмотр оповещений при возникновении условий.
> * Просмотр диаграммы метрик на панели мониторинга.
> * Просмотр ошибок и операций Центра Интернета вещей в журналах Azure Monitor.

## <a name="prerequisites"></a>Обязательные условия

- Подписка Azure. Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

- На компьютере, на котором ведется разработка, необходимо установить пакет SDK для .NET Core версии 2.1 или более поздней. Пакет SDK для .NET Core, предназначенный для нескольких платформ, можно загрузить из [.NET](https://www.microsoft.com/net/download/all).

  Текущую версию C# на компьютере, на котором ведется разработка, можно проверить, используя следующую команду:

  ```cmd/sh
  dotnet --version
  ```

- Рабочая учетная запись электронной почты.

- Убедитесь, что в брандмауэре открыт порт 8883. Пример устройства в этом руководстве использует протокол MQTT, который передает данные через порт 8883. В некоторых корпоративных и академических сетях этот порт может быть заблокирован. Дополнительные сведения и способы устранения этой проблемы см. в разделе о [подключении к Центру Интернета вещей по протоколу MQTT](iot-hub-mqtt-support.md#connecting-to-iot-hub).

[!INCLUDE [azure-cli-prepare-your-environment-no-header.md](../../includes/azure-cli-prepare-your-environment-no-header.md)]

## <a name="set-up-resources"></a>Настройка ресурсов

Во время работы с этим учебником требуется Центр Интернета вещей, рабочая область Log Analytics и имитированное устройство Интернета вещей. Эти ресурсы создаются с помощью Azure CLI или Azure PowerShell. Используйте те же группу ресурсов и расположение для всех ресурсов. По окончании работы, удалив группу ресурсов, можно удалить все данные за один шаг.

Ниже приведены необходимые шаги.

1. Создайте [группу ресурсов](../azure-resource-manager/management/overview.md).

2. Создайте Центр Интернета вещей.

3. Создание рабочей области Log Analytics.

4. Зарегистрируйте удостоверение для имитированного устройства, которое отправляет сообщения Центру Интернета вещей. Сохраните строку подключения устройства, чтобы использовать ее для настройки имитированного устройства.

### <a name="set-up-resources-using-azure-cli"></a>Настройка ресурсов с помощью Azure CLI

Скопируйте и вставьте этот сценарий в Cloud Shell. Предполагая, что вы уже вошли в систему, Cloud Shell запустит сценарий, выполняя одну строку за другой. Выполнение некоторых команд может занять определенное время. Новые ресурсы создаются в группе ресурсов *ContosoResources*.

Имя некоторых ресурсов должно быть уникальным в Azure. Скрипт создает случайное значение с помощью функции `$RANDOM` и сохраняет его в переменной. Для этих ресурсов сценарий добавляет это случайное значение в базовое имя ресурса, делая его уникальным.

Для каждой подписки допускается только один бесплатный Центр Интернета вещей. Если у вас уже есть бесплатный Центр Интернета вещей в подписке, удалите его перед запуском скрипта или измените скрипт, чтобы использовать бесплатный Центр Интернета вещей или Центр уровня "Стандартный" или "Базовый".

Скрипт выводит имя Центра Интернета вещей, имя рабочей области Log Analytics и строку подключения для регистрируемого устройства. Обязательно запишите их, так как они понадобятся далее в этой статье.

```azurecli-interactive

# This is the IOT Extension for Azure CLI.
# You only need to install this the first time.
# You need it to create the device identity.
az extension add --name azure-iot

# Set the values for the resource names that don't have to be globally unique.
# The resources that have to have unique names are named in the script below
#   with a random number concatenated to the name so you can probably just
#   run this script, and it will work with no conflicts.
location=westus
resourceGroup=ContosoResources
iotDeviceName=Contoso-Test-Device
randomValue=$RANDOM

# Create the resource group to be used
#   for all the resources for this tutorial.
az group create --name $resourceGroup \
    --location $location

# The IoT hub name must be globally unique, so add a random number to the end.
iotHubName=ContosoTestHub$randomValue
echo "IoT hub name = " $iotHubName

# Create the IoT hub in the Free tier. Partition count must be 2.
az iot hub create --name $iotHubName \
    --resource-group $resourceGroup \
    --partition-count 2 \
    --sku F1 --location $location

# The Log Analytics workspace name must be globally unique, so add a random number to the end.
workspaceName=contoso-la-workspace$randomValue
echo "Log Analytics workspace name = " $workspaceName


# Create the Log Analytics workspace
az monitor log-analytics workspace create --resource-group $resourceGroup \
    --workspace-name $workspaceName --location $location

# Create the IoT device identity to be used for testing.
az iot hub device-identity create --device-id $iotDeviceName \
    --hub-name $iotHubName

# Retrieve the primary connection string for the device identity, then copy it to
#   Notepad. You need this to run the device simulation during the testing phase.
az iot hub device-identity show-connection-string --device-id $iotDeviceName \
    --hub-name $iotHubName

```

>[!NOTE]
>При создании удостоверения устройства может появиться следующее сообщение об ошибке: *No keys found for policy iothubowner of IoT Hub ContosoTestHub* (Ключи для политики iothubowner Центра Интернета вещей ContosoTestHub не найдены). Чтобы устранить эту ошибку, обновите расширение Azure CLI для Интернета вещей и снова выполните две последние команды скрипта. 
>
>Ниже приведена команда для обновления расширения. Выполните ее в экземпляре Cloud Shell.
>
>```cli
>az extension update --name azure-iot
>```

## <a name="collect-logs-for-connections-and-device-telemetry"></a>Сбор журналов подключений и телеметрии устройств

Центр Интернета вещей выводит журналы ресурсов для нескольких категорий операций. Однако для просмотра этих журналов необходимо создать параметр диагностики для отправки их в целевое назначение. Одним из таких назначений являются журналы Azure Monitor, собираемые в рабочей области Log Analytics. Журналы ресурсов Центра Интернета вещей группируются по различным категориям. В параметре диагностики можно выбрать категории, которые необходимо отправить в журналы Azure Monitor. При работе с этой статьей мы соберем журналы операций и ошибок, связанных с подключением и телеметрией устройств. Полный список категорий, поддерживаемых для Центра Интернета вещей, см. в разделе [Журналы ресурсов](monitor-iot-hub-reference.md#resource-logs).

Чтобы создать параметр диагностики для отправки журналов ресурсов Центра Интернета вещей в журналы Azure Monitor, выполните следующие действия.

1. Во-первых, если вы еще не перешли к центру на портале, щелкните **Группы ресурсов** и выберите группу ресурсов ContosoResources. Выберите Центр Интернета вещей из списка отображаемых ресурсов.

1. Найдите раздел **Мониторинг** в колонке Центра Интернета вещей. Выберите **Параметры диагностики**. Щелкните команду **Добавить параметр диагностики**.

   :::image type="content" source="media/tutorial-use-metrics-and-diags/open-diagnostic-settings.png" alt-text="Снимок экрана: раздел &quot;Мониторинг&quot; с выбранным элементом &quot;Параметры диагностики&quot;.":::

1. На панели **Параметр диагностики** задайте для параметра описательное имя, например Send connections and telemetry to logs (Отправить подключения и данные телеметрии в журналы).

1. В разделе **Сведения о категории** выберите пункты **Подключения** и **Device Telemetry** (Телеметрия устройств).

1. В разделе **Сведения о назначении** щелкните **Отправить в Log Analytics**, а затем с помощью средства выбора рабочей области Log Analytics выберите ранее записанную рабочую область. По завершении настройки диагностики должны выглядеть примерно так, как показано на снимке экрана ниже.

   :::image type="content" source="media/tutorial-use-metrics-and-diags/add-diagnostic-setting.png" alt-text="Снимок экрана с окончательными параметрами журнала диагностики.":::

1. Нажмите кнопку **Сохранить**, чтобы сохранить параметры. Закройте панель **Параметры диагностики**. Новый параметр можно увидеть в списке параметров диагностики.

## <a name="set-up-metrics"></a>Настройка метрик

Теперь с помощью обозревателя метрик мы создадим диаграмму, отображающую метрики, которые требуется отслеживать. Вы закрепите эту диаграмму на панели мониторинга по умолчанию на портале Azure.

1. В левой области Центра Интернета вещей в разделе **Наблюдение** выберите **Метрики**.

1. В верхней части экрана щелкните **Last 24 hours (Automatic)** (Последние 24 часа (автоматически)). В открывшемся списке для параметра **Диапазон времени** выберите **Last 4 hours** (Последние 4 часа), установите для параметра **Степень детализации времени** значение **1 мин** и задайте **Местное время** для параметра **Отображать время как**. Нажмите кнопку **Применить**, чтобы сохранить эти параметры. Теперь параметр должен иметь значение **Local Time: Last 4 hours (1 minute)** (Местное время: последние 4 часа (1 минута)).

   :::image type="content" source="media/tutorial-use-metrics-and-diags/metrics-select-time-range.png" alt-text="Снимок экрана с параметрами времени метрик.":::

1. На диаграмме отображается частичная метрика, ограниченная областью действия Центра Интернета вещей. Оставьте для параметров **Область** и **Пространство имен метрики** значения по умолчанию. Выберите параметр **Метрики** и введите Telemetry (Телеметрия), а затем из раскрывающегося списка выберите **Telemetry messages sent** (Число отправленных сообщений телеметрии). Для параметра **Агрегирование** будет автоматически задано значение **Sum**. Обратите внимание, что также изменяется заголовок диаграммы.

   :::image type="content" source="media/tutorial-use-metrics-and-diags/metrics-telemetry-messages-sent.png" alt-text="Снимок экрана: добавление в диаграмму метрики сообщений телеметрии.":::

1. Теперь щелкните **Добавить метрику**, чтобы добавить другую метрику на диаграмму. В разделе **Метрика** выберите **Total number of messages used** (Общее количество используемых сообщений). Для параметра **Агрегирование** будет автоматически задано значение **Avg**. Обратите внимание, что название диаграммы изменилось и включает эту метрику.

   Теперь на экране отображается свернутая метрика для параметра *Telemetry messages sent* (Число отправленных сообщений телеметрии), а также новая метрика для параметра *Total number of messages used* (Общее количество используемых сообщений).

   :::image type="content" source="media/tutorial-use-metrics-and-diags/metrics-total-number-of-messages-used.png" alt-text="Снимок экрана: добавление общего числа сообщений, используемых метрикой в диаграмме.":::

1. В правом верхнем углу диаграммы выберите **Закрепить на панели мониторинга**.

   :::image type="content" source="media/tutorial-use-metrics-and-diags/metrics-total-number-of-messages-used-pin.png" alt-text="Снимок экрана, на котором выделена кнопка &quot;Закрепить на панели мониторинга&quot;.":::

1. В области **Закрепить на панели мониторинга** выберите вкладку **Существующие**. Выберите **Личный**, а затем в раскрывающемся списке панели мониторинга выберите **Панель мониторинга**. Наконец, щелкните **Закрепить**, чтобы закрепить диаграмму на панели мониторинга по умолчанию на портале Azure. Если вы не закрепите диаграмму на панели мониторинга, при выходе из обозревателя метрик параметры не сохранятся.

   :::image type="content" source="media/tutorial-use-metrics-and-diags/pin-to-dashboard.png" alt-text="Снимок экрана, на котором показаны параметры для закрепления на панели мониторинга.":::

## <a name="set-up-metric-alerts"></a>Настройка оповещений о метриках

Теперь настройте оповещения для активации на основе двух метрик *Telemetry messages sent* (Число отправленных сообщений телеметрии) и *Total number of messages used* (Общее количество используемых сообщений).

Метрику *Telemetry messages sent* (Число отправленных сообщений телеметрии) удобно использовать для отслеживания пропускной способности сообщений и предотвращения регулирования. Для Центра Интернета вещей уровня "Бесплатный" предел регулирования составляет 100 сообщений в секунду. При использовании одного устройства мы не сможем достичь такой пропускной способности, поэтому вместо этого настроим оповещение, чтобы оно срабатывало, если количество сообщений превышает 1000 в течение 5-минутного периода. В рабочей среде вы можете задать более значимое значение в зависимости от уровня, выпуска и количества ресурсов Центра Интернета вещей.

Метрика *Total number of messages used* (Общее количество используемых сообщений) отслеживает ежедневное количество используемых сообщений. Эта метрика сбрасывается до нуля в 00:00 UTC каждый день. Если предельная квота превышает определенный порог, Центр Интернета вещей больше не будет принимать сообщения. Для Центра Интернета вещей уровня "Бесплатный" квота на общее число ежедневных сообщений составляет 8000. Мы настроим оповещение для активации, если общее число сообщений превысит 4000, то есть 50 % квоты. На практике, скорее всего, этот процент будет иметь более высокое значение. Значение ежедневной квоты зависит от уровня, выпуска и объема ресурсов Центра Интернета вещей.

Дополнительные сведения об ограничениях квот и регулирования в центре Интернета вещей см. в [этой статье](iot-hub-devguide-quotas-throttling.md).

Чтобы настроить оповещения о метриках, сделайте следующее:

1. Откройте Центр Интернета вещей на портале Azure.

1. В разделе **Наблюдение** выберите **Оповещения**. Щелкните **Новое правило генерации оповещений**.  Откроется панель **Создать правило генерации оповещений**.

    :::image type="content" source="media/tutorial-use-metrics-and-diags/create-alert-rule-pane.png" alt-text="Снимок экрана: панель создания правила генерации оповещений.":::

    На панели **Создать правило генерации оповещений** есть четыре раздела:

    * раздел **Область** уже настроен для Центра Интернета вещей, поэтому мы не будем вносить изменения в этом разделе;
    * в разделе **Условие** задаются сигнал и условия, которые будут активировать оповещение;
    * в разделе **Действия** указано, что происходит при срабатывании оповещения;
    * в разделе **Сведения о правиле генерации оповещений** можно задать имя и описание оповещения.

1. Сначала настройте условие, в соответствии с которым будет срабатывать оповещение.

    1. В разделе **Условие** выберите элемент **Добавить условие**. На панели **Настроить логику сигналов** в поле поиска введите telemetry (телеметрия) и выберите **Telemetry messages sent** (Число отправленных сообщений телеметрии).

       :::image type="content" source="media/tutorial-use-metrics-and-diags/configure-signal-logic-telemetry-messages-sent.png" alt-text="Снимок экрана с метриками.":::

    1. На панели **Настроить логику сигналов** установите или подтвердите следующие поля в разделе **Логика оповещений** (можно проигнорировать диаграмму):

       **Пороговое значение.**  *Статическое*.

       **Оператор**. *Больше чем*.

       **Тип агрегирования**: *Всего*.

       **Пороговое значение**: 1000.

       **Гранулярность агрегации (период)** : *5 минут*.

       **Частота вычислений**: *Каждую минуту*.

        :::image type="content" source="media/tutorial-use-metrics-and-diags/configure-signal-logic-set-conditions.png" alt-text="Снимок экрана: параметры условий оповещения.":::

       Эти параметры задают для сигнала общее количество сообщений в течение 5 минут. Это общее количество будет оцениваться каждую минуту. Если сумма за последние 5 минут превысит 1000 сообщений, будет активировано оповещение.

       Нажмите кнопку **Готово**, чтобы сохранить логику сигнала.

1. Теперь настройте действие для оповещения.

    1. Вернитесь в область **Создать правило генерации оповещений** и в разделе **Действия** щелкните **Add action groups** (Добавить группы действий). В области **Выбор группы действий для прикрепления к этому правилу генерации оповещений** щелкните **Создать группу действий**.

    1. На вкладке **Основные** области **Создать группу действий** присвойте группе действий имя и отображаемое имя.

        :::image type="content" source="media/tutorial-use-metrics-and-diags/create-action-group-basics.png" alt-text="Снимок экрана, на котором показана вкладка &quot;Основные&quot; на панели &quot;Создать группу действий&quot;.":::

    1. Выберите вкладку **Уведомления**. Для параметра **Тип уведомлений** из раскрывающегося списка выберите **Email/SMS message/Push/Voice** (Адрес электронной почты / SMS-сообщение / Push-уведомление / Голосовое сообщение). Откроется область **Email/SMS message/Push/Voice** (Адрес электронной почты / SMS-сообщение / Push-уведомление / Голосовое сообщение).

    1. В области **Email/SMS message/Push/Voice** (Адрес электронной почты / SMS-сообщение / Push-уведомление / Голосовое сообщение) выберите адрес электронной почты и введите свой адрес, а затем нажмите кнопку **ОК**.

        :::image type="content" source="media/tutorial-use-metrics-and-diags/set-email-address.png" alt-text="Снимок экрана: параметр адреса электронной почты.":::

    1. Вернитесь на панель **Уведомления** и введите имя уведомления.

        :::image type="content" source="media/tutorial-use-metrics-and-diags/create-action-group-notification-complete.png" alt-text="Снимок экрана, на котором отображается панель завершенных уведомлений.":::

    1. (Необязательно). Если щелкнуть вкладку **Действия**, а затем выбрать раскрывающийся список **Тип действия**, вы увидите типы действий, которые можно вызвать с помощью оповещения. При работе с этой статьей мы будем использовать только уведомления, поэтому параметры на этой вкладке можно игнорировать.

        :::image type="content" source="media/tutorial-use-metrics-and-diags/action-types.png" alt-text="Снимок экрана: типы действий, доступные на панели &quot;Действия&quot;.":::

    1. Перейдите на вкладку **Просмотр и создание**, проверьте параметры и нажмите кнопку **Создать**.

        :::image type="content" source="media/tutorial-use-metrics-and-diags/create-action-group-review-and-create.png" alt-text="Снимок экрана: панель &quot;Просмотр и создание&quot;.":::

    1. На панели **Создать правило генерации оповещений** обратите внимание, что новая группа действий добавлена к действиям для оповещения.  

1. Наконец, настройте сведения о правиле генерации оповещений и сохраните правило.

    1. На панели **Создать правило генерации оповещений** в разделе сведений о правиле оповещения введите имя и описание оповещения (например, "Оповещать при возникновении более 1000 сообщений в течение 5 минут"). Убедитесь, что установлен флажок **Enable alert rule upon creation** (Включить правило генерации оповещений при создании). Завершенное правило генерации оповещений будет выглядеть примерно так, как на этом снимке экрана.

        :::image type="content" source="media/tutorial-use-metrics-and-diags/create-alert-rule-final.png" alt-text="Снимок экрана: панель с готовым правилом генерации оповещений.":::

    1. Выберите **Создать правило генерации оповещений**, чтобы сохранить новое правило.

1. Теперь настройте другое оповещение для параметра *Total number of messages used* (Общее количество используемых сообщений). Эта метрика полезна, если вы хотите отправить оповещение, когда количество используемых сообщений приближается к дневной квоте, установленной для Центра Интернета вещей. Так вы узнаете, что центр вскоре начнет отклонять сообщения. Выполните действия, описанные выше, с учетом следующих различий.

    * Для сигнала на панели **Настроить логику сигналов** выберите **Total number of messages used** (Общее количество используемых сообщений).

    * На панели **Настроить логику сигналов** установите или подтвердите следующие поля (можно проигнорировать диаграмму):

       **Пороговое значение.**  *Статическое*.

       **Оператор**. *Больше чем*.

       **Тип агрегирования**: *Максимум*.

       **Пороговое значение**: 4000.

       **Гранулярность агрегации (период)** : *1 минута*.

       **Частота вычислений**: *Каждую минуту*.

       Эти параметры задают сигнал, который будет срабатывать, когда число сообщений достигнет 4000. Метрика вычисляется каждую минуту.

    * При указании действия для правила генерации оповещений просто выберите группу действий, созданную ранее.

    * В поле сведения об оповещении выберите другое имя и описание.

1. В разделе **Наблюдение** в левой области Центра Интернета вещей выберите **Оповещения**. Теперь в меню в верхней части панели **Оповещения** выберите **Управление правилами генерации оповещений**. Откроется область **Правила**. Теперь вы увидите два оповещения:

   :::image type="content" source="media/tutorial-use-metrics-and-diags/rules-management.png" alt-text="Снимок экрана: панель правил с новыми правилами генерации оповещений.":::

1. Закройте панель **Правила**.

С помощью этих параметров будет активировано оповещение. Вы получите уведомление по электронной почте, когда в течение 5-минутного интервала будет передано более 1000 сообщений, а общее количество используемых сообщений превысит 4000 (50 % от дневной квоты для Центра Интернета вещей уровня "Бесплатный").

## <a name="run-the-simulated-device-app"></a>Запуск приложения виртуального устройства

В рамках раздела [Настройка ресурсов](#set-up-resources) вы зарегистрировали удостоверение устройства, которое будет использоваться для имитации с помощью устройства Интернета вещей. В рамках работы с этим разделом происходит загрузка консольного приложения .NET, которое имитирует устройство, отправляющее сообщения с устройства в облако в Центре Интернета вещей, настраивает его для отправки этих сообщений в центр, а затем запускает его.

> [!IMPORTANT]
>
> Для полной настройки и включения оповещений в Центре Интернета вещей может потребоваться до 10 минут. Подождите не менее 10 минут с момента настройки последнего оповещения и запуска приложения имитированного устройства.

Загрузите решение для [имитации устройств IoT](https://github.com/Azure-Samples/azure-iot-samples-csharp/archive/master.zip). Скачается репозиторий с несколькими приложениями. Нужное решение находится в папке iot-hub/Quickstarts/simulated-device/.

1. В окне терминала на локальном компьютере перейдите в корневую папку решения. Затем перейдите в папку **iot-hub\Quickstarts\simulated-device**.

1. Откройте файл **SimulatedDevice.cs** в любом текстовом редакторе.

    1. Замените значение переменной `s_connectionString` строкой подключения устройства, записанной при выполнении сценария для настройки ресурсов.

    1. Откройте метод `SendDeviceToCloudMessagesAsync` и измените значение `Task.Delay` с 1000 на 1, что сократит время между отправкой сообщений с 1 до 0,001 секунды. Сокращение этой задержки увеличивает количество отправленных сообщений. (При этом частота 100 сообщений в секунду будет невозможна.)

        ```csharp
        await Task.Delay(1);
        ```

    1. Сохраните изменения в файле **SimulatedDevice.cs**.

1. Установите необходимые пакеты приложения имитированного устройства, выполнив в окне терминала на локальном компьютере следующую команду:

    ```cmd/sh
    dotnet restore
    ```

1. Создайте и запустите приложение имитированного устройства, выполнив в окне терминала на локальном компьютере следующие команды:

    ```cmd/sh
    dotnet run
    ```

    На следующем снимке экрана показан пример выходных данных, когда приложение имитированного устройства отправляет данные телеметрии в Центр Интернета вещей:

    :::image type="content" source="media/tutorial-use-metrics-and-diags/simulated-device-output.png" alt-text="Снимок экрана: выходные данные имитированного устройства.":::

Оставьте приложение выполняться в течение не менее 10–15 минут. В идеале разрешите его выполнение до тех пор, пока не прекратится отправка сообщений (около 20–30 минут). Это произойдет, если превышена квота ежедневных сообщений для Центра Интернета вещей и он прекратил принимать сообщения.

> [!NOTE]
> Если оставить приложение устройства в течение продолжительного периода после прекращения отправки сообщений, может возникнуть исключение. Вы можете проигнорировать это исключение и закрыть окно приложения.

## <a name="view-metrics-chart-on-your-dashboard"></a>Просмотр диаграммы метрик на панели мониторинга

1. В левом верхнем углу портала Azure откройте меню портала и выберите **Панель мониторинга**.

   :::image type="content" source="media/tutorial-use-metrics-and-diags/select-dashboard.png" alt-text="Снимок экрана: выбор панели мониторинга.":::

1. Найдите ранее закрепленную диаграмму и щелкните ее в любом месте за пределами данных диаграммы, чтобы развернуть. На диаграмме отображаются отправленные сообщения телеметрии и общее количество сообщений. Последние цифры отображаются в нижней части диаграммы. Ви можете переместить курсор на диаграмму, чтобы просмотреть значения метрик в определенные моменты времени. Кроме того, можно изменить значение времени и степень детализации в верхней части диаграммы, чтобы сократить или расширить данные до определенного периода времени.

   :::image type="content" source="media/tutorial-use-metrics-and-diags/metrics-on-dashboard-last-hour.png" alt-text="Снимок экрана: диаграмма метрик.":::

   В этом сценарии пропускная способность отправки сообщений имитированного устройства не настолько велика, чтобы Центр Интернета вещей регулировал свои сообщения. В сценарии, который включает регулирование, вы можете видеть, что отправляемые сообщения телеметрии превышают предел регулирования для Центра Интернета вещей в течение ограниченного времени. Это позволяет обработать пиковое увеличение трафика. Дополнительные сведения о формировании трафика см. в [этом разделе](iot-hub-devguide-quotas-throttling.md#traffic-shaping).

## <a name="view-the-alerts"></a>Просмотр оповещений

Когда число отправленных сообщений превышает ограничения, заданные в правилах генерации оповещений, вы начинаете получать оповещения по электронной почте.

Чтобы узнать, есть ли активные оповещения, в разделе **Наблюдение** в левой области Центра Интернета вещей выберите **Оповещения**. В области **Оповещения** отображается количество сработавших оповещений, отсортированных по степени серьезности за указанный временной диапазон.

   :::image type="content" source="media/tutorial-use-metrics-and-diags/view-alerts.png" alt-text="Снимок экрана: сводка оповещений.":::

Выберите строку с уровнем серьезности 3. Откроется панель **Все оповещения**, на которой перечислены запущенные оповещения с уровнем серьезности 3.

   :::image type="content" source="media/tutorial-use-metrics-and-diags/view-all-alerts.png" alt-text="Снимок экрана: панель &quot;Все оповещения&quot;.":::

Выберите одно из оповещений, чтобы просмотреть сведения о нем.

   :::image type="content" source="media/tutorial-use-metrics-and-diags/view-individual-alert.png" alt-text="Снимок экрана: сведения об оповещении.":::

Проверьте папку "Входящие" на наличие сообщений электронной почты от Microsoft Azure. В строке темы будет описываться оповещение, которое было активировано. Например, *Azure: уровень серьезности: 3. Оповещать, если отправляется более 1000 сообщений за 5 минут*. Этот текст выглядит примерно так, как показано ниже.

   :::image type="content" source="media/tutorial-use-metrics-and-diags/alert-mail.png" alt-text="Снимок экрана сообщения электронной почты с активированными оповещениями.":::

## <a name="view-azure-monitor-logs"></a>Просмотр журналов Azure Monitor

В рамках раздела [Сбор журналов подключений и телеметрии устройств](#collect-logs-for-connections-and-device-telemetry) вы создали параметр диагностики для отправки журналов ресурсов, создаваемых Центром Интернета вещей для подключений и операций телеметрии устройств, в журналы Azure Monitor. В этом разделе описано, как выполнить запрос Kusto к журналам Azure Monitor, чтобы наблюдать за возникшими ошибками.

1. На портале Azure в разделе **Наблюдение** в левой области Центра Интернета вещей выберите пункт **Журналы**. Закройте начальное окно **Запросы**, если оно открыто.

1. На панели "Новый запрос" выберите вкладку **Запросы**, а затем разверните **Центр Интернета вещей**, чтобы просмотреть список запросов по умолчанию.

   :::image type="content" source="media/tutorial-use-metrics-and-diags/new-query-pane.png" alt-text="Снимок экрана запросов по умолчанию для Центра Интернета вещей.":::

1. Выберите запрос *Сводка ошибок*. Запрос появится на панели редактора запросов. Нажмите кнопку **Запустить** на панели редактора и просмотрите результаты запроса. Разверните одну из строк, чтобы просмотреть подробные сведения.

   :::image type="content" source="media/tutorial-use-metrics-and-diags/logs-errors.png" alt-text="Снимок экрана журналов, возвращенных запросом &quot;Сводка ошибок&quot;.":::

   > [!NOTE]
   > Если ошибки не отображаются, попробуйте запустить запрос *Recently connected devices* (Недавно подключенные устройства). Он должен возвращать строку для имитированного устройства.

## <a name="clean-up-resources"></a>Очистка ресурсов

Чтобы удалить все ресурсы, которые были созданы в этом руководстве, удалите группу ресурсов. При этом будут также удалены все ресурсы, содержащиеся в группе. В этом случае происходит удаление Центра Интернета вещей, рабочей области Log Analytics и самой группы ресурсов. Если вы закрепили диаграммы метрик на панели мониторинга, необходимо будет удалить их вручную, щелкнув три точки в верхнем правом углу каждой метрики и выбрав **Удалить**. Не забудьте сохранить изменения после удаления диаграмм.

Чтобы удалить группу ресурсов, используйте команду [az group delete](/cli/azure/group#az_group_delete).

```azurecli-interactive
az group delete --name ContosoResources
```

## <a name="next-steps"></a>Дальнейшие действия

Из этого учебника вы узнали, как использовать метрики и журналы Центра Интернета вещей, выполнив следующие задачи:

> [!div class="checklist"]
>
> * Использование Azure CLI для создания Центра Интернета вещей, регистрации имитированного устройства и создания рабочей области Log Analytics.  
> * Отправка подключений Центра Интернета вещей и журналов ресурсов телеметрии устройств в журналы Azure Monitor в рабочей области Log Analytics.
> * Использование обозревателя метрик для создания диаграммы на основе выбранных метрик и закрепление ее на панели мониторинга.
> * Создание оповещений метрик, чтобы при возникновении важных условий получать уведомления по электронной почте.
> * Скачивание и запуск приложения, которое имитирует устройство Интернета вещей, отправляющее сообщения в центр.
> * Просмотр оповещений при возникновении условий.
> * Просмотр диаграммы метрик на панели мониторинга.
> * Просмотр ошибок и операций Центра Интернета вещей в журналах Azure Monitor.

Перейдите к следующему руководству, чтобы узнать, как управлять состоянием устройств IoT. 

> [!div class="nextstepaction"]
> [Настройка устройств из внутренней службы](tutorial-device-twins.md)