---
title: Краткое руководство. Управление устройством из Центра Интернета вещей Azure (Android) | Документация Майкрософт
description: 'В этом кратком руководстве описано, как запустить два примера приложений Java: приложение-служба, которое может удаленно управлять подключенными к центру устройствами; приложение, которое запущено на физическом или имитированном подключенном к центру устройстве, которым можно управлять удаленно.'
author: wesmc7777
manager: philmea
ms.service: iot-hub
services: iot-hub
ms.devlang: java
ms.topic: quickstart
ms.custom:
- mvc
- mqtt
- devx-track-java
- devx-track-azurecli
ms.date: 06/21/2019
ms.author: wesmc
ms.openlocfilehash: 6b5df6d6eaedd4d7d1793c35db37e06b4478f2b8
ms.sourcegitcommit: dd24c3f35e286c5b7f6c3467a256ff85343826ad
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/29/2021
ms.locfileid: "99072074"
---
# <a name="quickstart-control-a-device-connected-to-an-iot-hub-android"></a>Краткое руководство. Управление подключенным к Центру Интернета вещей устройством Android

[!INCLUDE [iot-hub-quickstarts-2-selector](../../includes/iot-hub-quickstarts-2-selector.md)]

В этом кратком руководстве показано, как использовать прямой метод для управления имитированным устройством, подключенным к Центру Интернета вещей Azure. Центр Интернета вещей — это служба Azure, которая позволяет управлять устройствами Интернета вещей из облака и принимать большие объемы данных телеметрии, передаваемых с устройств в облако, для хранения или обработки. Этот метод позволяет удаленно изменить поведение подключенного к Центру Интернета вещей устройства. При работе с этим кратким руководством используются два приложения: приложение имитированного устройства, которое реагирует на прямые методы, вызываемые внутренним приложением-службой, и приложение-служба, которое вызывает прямой метод на устройстве Android.

## <a name="prerequisites"></a>Предварительные требования

* Учетная запись Azure с активной подпиской. [Создайте бесплатно](https://azure.microsoft.com/free/?ref=microsoft.com&utm_source=microsoft.com&utm_medium=docs&utm_campaign=visualstudio).

* [Android Studio с пакетом SDK для Android версии 27](https://developer.android.com/studio/). Дополнительные сведения см. в разделе об [установке Android Studio](https://developer.android.com/studio/install).

* [Git](https://git-scm.com/download/).

* [Пример приложения Android с использованием пакета SDK для устройств](https://github.com/Azure-Samples/azure-iot-samples-java/tree/master/iot-hub/Samples/device/AndroidSample) из [репозитория с примерами Azure IoT (Java)](https://github.com/Azure-Samples/azure-iot-samples-java).

* [Пример приложения Android с использованием пакета SDK для служб](https://github.com/Azure-Samples/azure-iot-samples-java/tree/master/iot-hub/Samples/service/AndroidSample) из репозитория с примерами Azure IoT (Java).

* Порт 8883, открытый в брандмауэре. Пример устройства в этом кратком руководстве использует протокол MQTT, который передает данные через порт 8883. В некоторых корпоративных и академических сетях этот порт может быть заблокирован. Дополнительные сведения и способы устранения этой проблемы см. в разделе о [подключении к Центру Интернета вещей по протоколу MQTT](iot-hub-mqtt-support.md#connecting-to-iot-hub).

[!INCLUDE [azure-cli-prepare-your-environment.md](../../includes/azure-cli-prepare-your-environment-no-header.md)]

[!INCLUDE [iot-hub-cli-version-info](../../includes/iot-hub-cli-version-info.md)]

## <a name="create-an-iot-hub"></a>Создание Центра Интернета вещей

Если вы закончили работу с предыдущим руководством по [ отправке данных телеметрии с устройства в Центр Интернета вещей](quickstart-send-telemetry-android.md), можете пропустить этот шаг и использовать созданный центр Интернета вещей.

[!INCLUDE [iot-hub-include-create-hub](../../includes/iot-hub-include-create-hub.md)]

## <a name="register-a-device"></a>Регистрация устройства

Если вы закончили работу с предыдущим руководством по [ отправке данных телеметрии с устройства в Центр Интернета вещей](quickstart-send-telemetry-android.md), можете пропустить этот шаг и использовать устройство, которое зарегистрировали при работе с предыдущим руководством.

Устройство должно быть зарегистрировано в Центре Интернета вещей, прежде чем оно сможет подключиться. В этом кратком руководстве для регистрации имитируемого устройства используется Azure Cloud Shell.

1. Выполните приведенные ниже команды в Azure Cloud Shell, чтобы создать удостоверение устройства.

   **YourIoTHubName**. Замените этот заполнитель именем вашего центра Интернета вещей.

   **MyAndroidDevice**. Это имя регистрируемого устройства. Рекомендуется использовать **MyAndroidDevice**, как показано ниже. Если вы выбрали другое имя для устройства, используйте его при работе с этим руководством и обновите имя устройства в примерах приложений перед их запуском.

    ```azurecli-interactive
    az iot hub device-identity create \
      --hub-name {YourIoTHubName} --device-id MyAndroidDevice
    ```

2. Выполните следующую команду в Azure Cloud Shell, чтобы получить _строку подключения_ зарегистрированного устройства:

   **YourIoTHubName**. Замените этот заполнитель именем вашего Центра Интернета вещей.

    ```azurecli-interactive
    az iot hub device-identity connection-string show\
      --hub-name {YourIoTHubName} \
      --device-id MyAndroidDevice \
      --output table
    ```

    Запишите строку подключения устройства, которая выглядит так:

   `HostName={YourIoTHubName}.azure-devices.net;DeviceId=MyAndroidDevice;SharedAccessKey={YourSharedAccessKey}`

    Это значение понадобится позже в рамках этого краткого руководства.

## <a name="retrieve-the-service-connection-string"></a>Получение строки подключения к службе

Чтобы разрешить внутреннему приложению-службе подключаться к центру Интернета вещей, выполнять методы и получать сообщения, требуется _строка подключения к службе_. Следующая команда извлекает строку подключения службы для Центра Интернета вещей:

**YourIoTHubName**. Замените этот заполнитель именем вашего центра Интернета вещей.

```azurecli-interactive
az iot hub connection-string show --policy-name service --name {YourIoTHubName} --output table
```

Запишите строку подключения к службе, которая выглядит так:

`HostName={YourIoTHubName}.azure-devices.net;SharedAccessKeyName=service;SharedAccessKey={YourSharedAccessKey}`

Это значение понадобится позже в рамках этого краткого руководства. Строка подключения к службе отличается от строки подключения к устройству из предыдущего шага.

## <a name="listen-for-direct-method-calls"></a>Ожидание передачи данных при вызове прямого метода

Оба примера для этого краткого руководства содержатся в репозитории azure-iot-samples-java на сайте GitHub. Скачайте или клонируйте репозиторий [azure-iot-samples-java](https://github.com/Azure-Samples/azure-iot-samples-java).

Пример приложения с использованием пакета SDK для устройств может выполняться на физическом устройстве Android или в эмуляторе Android. Такое приложение подключается к конечной точке конкретного устройства в Центре Интернета вещей, отправляет имитированные данные телеметрии и ожидает передачи данных при вызове прямого метода из центра. В рамках этого краткого руководства вызов прямого метода из центра инициирует изменение интервала, с которым устройство отправляет данные телеметрии. После выполнения прямого метода имитированное устройство отправляет подтверждение в центр.

1. В Android Studio откройте пример проекта Android, полученный из GitHub. Проект находится в указанном ниже каталоге копии клонированного или скачанного репозитория [azure-iot-sample-java](https://github.com/Azure-Samples/azure-iot-samples-java): *\azure-iot-samples-java\iot-hub\Samples\device\AndroidSample*.

2. В Android Studio откройте *gradle.properties* для примера проекта и замените заполнитель **Device_Connection_String** строкой подключения устройства, которую вы записали ранее.

    ```
    DeviceConnectionString=HostName={YourIoTHubName}.azure-devices.net;DeviceId=MyAndroidDevice;SharedAccessKey={YourSharedAccessKey}
    ```

3. В Android Studio последовательно выберите **File (Файл)**  > **Sync Project with Gradle Files (Синхронизировать проект с файлами Gradle)** . Проверьте, завершена ли сборка.

   > [!NOTE]
   > Возможные причины сбоя синхронизации проекта:
   >
   > * Версии плагина Android Gradle и Gradle, указанные в проекте, устарели для вашей версии Android Studio. Выполните [эти инструкции](https://developer.android.com/studio/releases/gradle-plugin), чтобы установить надлежащие версии плагина и Gradle, а также добавить на них ссылки.
   > * Лицензионное соглашение для пакета SDK для Android не подписано. Следуйте инструкциям в выходных данных сборки, чтобы подписать лицензионное соглашение и скачать пакет SDK.

4. По завершении сборки щелкните **Run (Запуск)**  > **Run "app" (Запустить "app")** . Настройте приложение для запуска на физическом устройстве Android или в эмуляторе Android. Дополнительные сведения о запуске приложения Android на физическом устройстве или в эмуляторе см. в [этой статье](https://developer.android.com/training/basics/firstapp/running-app).

5. После загрузки приложения нажмите кнопку **Start** (Начать), чтобы начать отправку данных телеметрии в Центр Интернета вещей:

    ![Снимок экрана примера приложения Android на клиентском устройстве](media/quickstart-control-device-android/sample-screenshot.png)

Не завершайте работу этого приложения на физическом устройстве или в эмуляторе при выполнении примера пакета SDK для службы, чтобы изменить интервал телеметрии во время выполнения.

## <a name="read-the-telemetry-from-your-hub"></a>Чтение данных телеметрии из концентратора

В этом разделе объясняется, как использовать Azure Cloud Shell с [расширением Интернета вещей](/cli/azure/ext/azure-iot/iot?view=azure-cli-latest&preserve-view=true) для мониторинга сообщений, отправляемых устройством Android.

1. С помощью Azure Cloud Shell выполните следующую команду для установки подключения к центру Интернета вещей и чтения поступающих из него сообщений:

   **YourIoTHubName**. Замените этот заполнитель именем вашего Центра Интернета вещей.

    ```azurecli-interactive
    az iot hub monitor-events --hub-name {YourIoTHubName} --output table
    ```

    На следующем снимке экрана показан пример выходных данных, когда центр Интернета вещей получает данные телеметрии, отправленные устройством Android:

      ![Чтение сообщений устройства с помощью Azure CLI](media/quickstart-control-device-android/read-data.png)

По умолчанию приложение телеметрии отправляет данные телеметрии с устройства Android каждые пять секунд. В рамках следующего раздела вы вызовете прямой метод, чтобы изменить интервал телеметрии для устройства Android, подключенного к Интернету вещей.

## <a name="call-the-direct-method"></a>Вызов прямого метода

Приложение-служба подключается к конечной точке на стороне службы в Центре Интернета вещей. Приложение выполняет вызовы прямых методов к устройству через Центр Интернета вещей и ожидает подтверждений.

Запустите это приложение на отдельном физическом устройстве Android или в эмуляторе Android.

Внутреннее приложение-служба Центра Интернета вещей обычно выполняется в облаке. Это позволяет сократить риски, связанные с конфиденциальными данными строки подключения, которая используется для управлениям всеми устройствами в Центре Интернета вещей. В этом примере в качестве такого приложения мы используем приложение Android (только для демонстрации). В других языковых версиях этого краткого руководства предоставляются примеры, которые больше соответствуют обычному внутреннему приложению-службе.

1. В Android Studio откройте пример проекта Android со службой, полученный из GitHub. Проект находится в указанном ниже каталоге копии клонированного или скачанного репозитория [azure-iot-sample-java](https://github.com/Azure-Samples/azure-iot-samples-java): *\azure-iot-samples-java\iot-hub\Samples\service\AndroidSample*.

2. В Android Studio откройте файл *gradle.properties* для примера проекта. Замените значение свойства **ConnectionString** записанной ранее строкой подключения к службе, а значение свойства **DeviceId** идентификатором зарегистрированного устройства Android.

    ```
    ConnectionString=HostName={YourIoTHubName}.azure-devices.net;SharedAccessKeyName=service;SharedAccessKey={YourSharedAccessKey}
    DeviceId=MyAndroidDevice
    ```

3. В Android Studio последовательно выберите **File (Файл)**  > **Sync Project with Gradle Files (Синхронизировать проект с файлами Gradle)** . Проверьте, завершена ли сборка.

   > [!NOTE]
   > Возможные причины сбоя синхронизации проекта:
   >
   > * Версии плагина Android Gradle и Gradle, указанные в проекте, устарели для вашей версии Android Studio. Выполните [эти инструкции](https://developer.android.com/studio/releases/gradle-plugin), чтобы установить надлежащие версии плагина и Gradle, а также добавить на них ссылки.
   > * Лицензионное соглашение для пакета SDK для Android не подписано. Следуйте инструкциям в выходных данных сборки, чтобы подписать лицензионное соглашение и скачать пакет SDK.

4. По завершении сборки щелкните **Run (Запуск)**  > **Run "app" (Запустить "app")** . Настройте приложение для запуска на отдельном физическом устройстве Android или в эмуляторе Android. Дополнительные сведения о запуске приложения Android на физическом устройстве или в эмуляторе см. в [этой статье](https://developer.android.com/training/basics/firstapp/running-app).

5. После загрузки приложения для параметра **Set Messaging Interval** (Задать интервал отправки сообщений) укажите значение **1000** и нажмите кнопку **Invoke** (Вызвать).

    Интервал для обмена данными телеметрии указывается в миллисекундах. По умолчанию интервал телеметрии для примера устройства имеет значение 5 секунд. После этого изменения устройство Android, подключенное к Интернету вещей, будет отправлять данные телеметрии каждую секунду.

    ![Ввод значения для интервала телеметрии](media/quickstart-control-device-android/enter-telemetry-interval.png)

6. В приложении вы получите уведомление, указывающее, успешно ли выполнен метод.

    ![Подтверждение выполнения прямого метода](media/quickstart-control-device-android/direct-method-ack.png)

## <a name="clean-up-resources"></a>Очистка ресурсов

[!INCLUDE [iot-hub-quickstarts-clean-up-resources](../../includes/iot-hub-quickstarts-clean-up-resources.md)]

## <a name="next-steps"></a>Дальнейшие действия

В рамках этого краткого руководства вы вызвали прямой метод на устройстве из внутреннего приложения, а также ответили на этот вызов в приложении имитированного устройства.

Чтобы узнать, как маршрутизировать сообщения с устройства в облако в разные расположения в облаке, перейдите к следующему руководству.

> [!div class="nextstepaction"]
> [Руководство. Маршрутизация телеметрии в разные конечные точки для обработки](tutorial-routing.md)
