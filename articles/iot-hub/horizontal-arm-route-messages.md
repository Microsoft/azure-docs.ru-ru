---
title: Использование шаблона ARM для публикации сообщений Центра Интернета вещей Azure, передаваемых в учетную запись хранения
description: Использование шаблона ARM для публикации сообщений Центра Интернета вещей Azure, передаваемых в учетную запись хранения
author: robinsh
ms.service: iot-hub
services: iot-hub
ms.topic: quickstart
ms.date: 08/24/2020
ms.author: robinsh
ms.custom: mvc, subject-armqs
ms.openlocfilehash: fc8ddba2ec9b7bc9f1c2db8673ab805810afe17e
ms.sourcegitcommit: f28ebb95ae9aaaff3f87d8388a09b41e0b3445b5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/29/2021
ms.locfileid: "99981295"
---
# <a name="quickstart-deploy-an-azure-iot-hub-and-a-storage-account-using-an-arm-template"></a>Краткое руководство. Развертывание Центра Интернета вещей Azure и учетной записи хранения с помощью шаблона ARM

В этом кратком руководстве рассказывается о том, как использовать шаблон Azure Resource Manager (ARM) для создания Центра Интернета вещей, который будет маршрутизировать сообщения в службу хранилища Azure, а также учетной записи хранения, в которой будут храниться сообщения. После добавления вручную виртуального устройства Интернета вещей в центр для отправки сообщений необходимо настроить соответствующие сведения о подключении в приложении под названием *arm-read-write* для отправки сообщений с устройства в центр. Центр настраивается таким образом, чтобы отправляемые в него сообщения автоматически направлялись в учетную запись хранения. После выполнения инструкций этого краткого руководства вы сможете открыть учетную запись хранения и просмотреть отправленные сообщения.

[!INCLUDE [About Azure Resource Manager](../../includes/resource-manager-quickstart-introduction.md)]

Если среда соответствует предварительным требованиям и вы знакомы с использованием шаблонов ARM, нажмите кнопку **Развертывание в Azure**. Шаблон откроется на портале Azure.

[![Развернуть в Azure](https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/1-CONTRIBUTION-GUIDE/images/deploytoazure.svg?sanitize=true)](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure%2Fazure-quickstart-templates%2Fmaster%2F101-iothub-auto-route-messages%2Fazuredeploy.json)

## <a name="prerequisites"></a>Предварительные требования

Если у вас еще нет подписки Azure, создайте [бесплатную учетную запись](https://azure.microsoft.com/free/) Azure, прежде чем начинать работу.

## <a name="review-the-template"></a>Изучение шаблона

Шаблон, используемый в этом кратком руководстве, называется `101-iothub-auto-route-messages` и взят из [шаблонов быстрого запуска Azure](https://azure.microsoft.com/resources/templates/101-iothub-auto-route-messages).

:::code language="json" source="~/quickstart-templates/101-iothub-auto-route-messages/azuredeploy.json":::

В шаблоне определено два ресурса Azure:

- [Microsoft.Storage/storageAccounts](/azure/templates/microsoft.storage/storageaccounts)
- [Microsoft.Devices/IotHubs](/azure/templates/microsoft.devices/iothubs)

## <a name="deploy-the-template-and-run-the-sample-app"></a>Развертывание шаблона и запуск примера приложения

В этом разделе приведены инструкции по развертыванию шаблона, созданию виртуального устройства и запуску приложения arm-read-write для отправки сообщений.

1. Создайте ресурсы, развернув шаблон ARM.

    > [!TIP]
    > Нажмите кнопку ниже, чтобы запустить развертывание шаблона. Пока оно выполняется, настройте приложение arm-read-write для запуска.

    [![Развернуть в Azure](https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/1-CONTRIBUTION-GUIDE/images/deploytoazure.svg?sanitize=true)](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure%2Fazure-quickstart-templates%2Fmaster%2F101-iothub-auto-route-messages%2Fazuredeploy.json)

1. Скачайте и распакуйте [примеры C# для Интернета вещей](/samples/azure-samples/azure-iot-samples-csharp/azure-iot-samples-for-csharp-net/).

1. Откройте командное окно и перейдите в папку, в которую вы распаковали примеры C# для Интернета вещей. Найдите папку с файлом arm-read-write.csproj. Переменные среды создаются в этом командном окне. Войдите на [портал Azure](https://portal.azure.com), чтобы получить ключи. Выберите **Группы ресурсов**, а затем щелкните группу ресурсов, используемую для этого краткого руководства.

   ![Выбор группы ресурсов](./media/horizontal-arm-route-messages/01-select-resource-group.png)

1. Вы увидите Центр Интернета вещей и учетную запись хранения, созданные при развертывании шаблона ARM. Прежде чем продолжить, дождитесь, когда шаблон будет полностью развернут. Затем выберите группу ресурсов, чтобы просмотреть ресурсы.

   ![Просмотр ресурсов в группе ресурсов](./media/horizontal-arm-route-messages/02-view-resources-in-group.png)

1. Вам потребуется **имя центра**. Выберите центр в списке ресурсов. Скопируйте имя центра из верхней части раздела Центра Интернета вещей в буфер обмена Windows.

   ![Копирование имени центра](./media/horizontal-arm-route-messages/03-copy-hub-name.png)

    Замените текст <hub name goes here> в этой команде именем центра и запустите ее выполнение в командном окне.

    ```cmd
    SET IOT_HUB_URI=<hub name goes here>.azure-devices-net;
    ```

   В этом примере она будет выглядеть следующим образом:

   ```cmd
   SET IOT_HUB_URI=ContosoTestHubdlxlud5h.azure-devices-net;
   ```

1. Следующая переменная среды — это ключ устройства Интернета вещей. Добавьте новое устройство в центр, выбрав в меню его Центра Интернета вещей пункт **Устройства Интернета вещей**.

   ![Выбор устройств Интернета вещей](./media/horizontal-arm-route-messages/04-select-iot-devices.png)

1. В правой части экрана выберите **+ СОЗДАТЬ**, чтобы добавить новое устройство.

   Укажите имя нового устройства. В этом кратком руководстве используется имя, начинающееся с **Contoso-Test-Device**. Сохраните устройство, а затем снова откройте этот экран, чтобы получить его ключ. (Ключ создается автоматически при закрытии области.) Выберите первичный или вторичный ключ и скопируйте его в буфер обмена Windows. В окне командной строки задайте команду для выполнения и нажмите клавишу **ВВОД**. Команда должна выглядеть так, как показано ниже, но со вставленным ключом устройства.

   ```cmd
   SET IOT_DEVICE_KEY=<device-key-goes-here>
   ```

1. Последняя переменная среды — это **идентификатор устройства**. В командном окне настройте команду и выполните ее.

   ```cmd
   SET IOT_DEVICE_ID=<device-id-goes-here>
   ```

   В этом примере она будет выглядеть следующим образом:

   ```cmd
   SET IOT_DEVICE_ID=Contoso-Test-Device
   ```

1. Чтобы просмотреть определенные переменные среды, в командной строке введите команду SET и нажмите клавишу **ВВОД**, а затем найдите имена, начинающиеся с **IoT**.

   ![Просмотр переменных среды](./media/horizontal-arm-route-messages/06-environment-variables.png)

    Теперь, когда переменные среды заданы, запустите приложение из того же командного окна. Так как вы используете то же окно, переменные будут доступны в памяти при запуске приложения.

1. Чтобы запустить приложение, введите в командном окне следующую команду и нажмите клавишу **ВВОД**.

    `dotnet run arm-read-write`

   Приложение будет создавать и отображать сообщения в консоли при отправке каждого из них в Центр Интернета вещей. В шаблоне ARM для центра была настроена автоматическая маршрутизация. Сообщения, содержащие текст `level = storage`, автоматически направляются в учетную запись хранения. После того, как приложение проработает 10–15 минут, нажмите клавишу **ВВОД** один или два раза, чтобы остановить его выполнение.

## <a name="review-deployed-resources"></a>Просмотр развернутых ресурсов

1. Войдите на [портал Azure](https://portal.azure.com) и выберите группу ресурсов, а затем — учетную запись хранения.

1. Детализируйте учетную запись хранения до тех пор, пока не найдете файлы.

   ![Поиск файлов в учетной записи хранения](./media/horizontal-arm-route-messages/07-see-storage.png)

1. Выберите один из файлов, нажмите **Скачать** и скачайте файл в расположение, которое сможете найти позже. Его имя будет числовым, например 47. Добавьте _.txt_ в конец файла, а затем дважды щелкните его, чтобы открыть.

1. В открывшемся файле каждая строка предназначена для отдельного сообщения. Кроме того, текст каждого сообщения зашифрован. Для выполнения запросов по тексту сообщения порядок должен оставаться неизменным.

   ![Просмотр отправленных сообщений](./media/horizontal-arm-route-messages/08-messages.png)

   > [!NOTE]
   > Для этих сообщений используется кодировка UTF-32 и Base64. Если вам необходимо считать сообщение в кодировке ASCII, его необходимо декодировать из Base64 и UTF-32. Если вам это интересно, вы можете использовать метод ReadOneRowFromFile, описанный в учебнике по маршрутизации, чтобы считать сообщение, содержащееся в одном из этих файлов, и декодировать его в ASCII. ReadOneRowFromFile находится в репозитории примеров C# для Интернета вещей, который вы распаковали при выполнении инструкций этого краткого руководства. Вот путь к нему из корня этой папки: *./iot-hub/Tutorials/Routing/SimulatedDevice/Program.cs.* Присвойте логическому параметру `readTheFile` значение true и жестко задайте путь к файлу на диске. Файл откроется, поле чего будет преобразована его первая строка.

Вы развернули шаблон ARM для создания Центра Интернета вещей и учетной записи хранения и запустили программу для отправки сообщений в центр. Теперь сообщения будут автоматически сохраняться в учетной записи хранения, где их можно просмотреть.

## <a name="clean-up-resources"></a>Очистка ресурсов

Чтобы удалить ресурсы, добавленные при выполнении инструкций этого краткого руководства, войдите на [портал Azure](https://portal.azure.com). Выберите **Группы ресурсов**, а затем найдите группу ресурсов, используемую для этого краткого руководства. Выберите группу ресурсов, а затем щелкните *Удалить*. Это приведет к удалению всех ресурсов в группе.

## <a name="next-steps"></a>Дальнейшие действия

> [!div class="nextstepaction"]
> [Руководство. Создание и развертывание первого шаблона ARM](../azure-resource-manager/templates/template-tutorial-create-first-template.md)
