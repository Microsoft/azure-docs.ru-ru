---
title: Мониторинг отключений от Центра Интернета вещей и устранение неполадок
description: Сведения о мониторинге и устранении распространенных ошибок с подключением устройств к Центру Интернета вещей
author: jlian
manager: briz
ms.service: iot-hub
services: iot-hub
ms.topic: conceptual
ms.date: 11/06/2020
ms.author: jlian
ms.custom:
- mqtt
- 'Role: Cloud Development'
- 'Role: IoT Device'
- 'Role: Technical Support'
- fasttrack-edit
- iot
ms.openlocfilehash: 8bd20e3c7207c75e87a2132fca89906885de2676
ms.sourcegitcommit: e559daa1f7115d703bfa1b87da1cf267bf6ae9e8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/17/2021
ms.locfileid: "100579255"
---
# <a name="monitor-diagnose-and-troubleshoot-disconnects-with-azure-iot-hub"></a>Мониторинг, диагностика отключений от Центра Интернета вещей и устранение неполадок

Иногда проблемы с подключением устройств Интернета вещей трудно устранить, так как существует множество возможных точек отказа. Логика приложения, физические сети, протоколы, оборудование, Центр Интернета и другие облачные службы вещей могут быть причиной проблем. Очень важно иметь возможность обнаруживать и выявлять источники проблем. Однако крупномасштабное решение Интернета вещей может включать тысячи устройств, поэтому проверка отдельных устройств вручную нецелесообразна. Центр Интернета вещей интегрируется с двумя службами Azure, которые помогут вам:

* **Azure Monitor** Чтобы помочь в обнаружении, диагностике и устранении этих проблем в масштабе, используйте возможности мониторинга центра Интернета вещей с помощью Azure Monitor. Сюда входит настройка оповещений для активации уведомлений и действий при отключении подключений и Настройка журналов, которые можно использовать для обнаружения условий, вызвавших отключение.

* **Сетка событий Azure** Для критической инфраструктуры и отключений для каждого устройства используйте службу "Сетка событий Azure" для подписки на события подключения и отключения устройств, созданные центром Интернета вещей.

В обоих случаях эти возможности ограничены тем, что может наблюдать центр Интернета вещей, поэтому мы также рекомендуем следовать рекомендациям по мониторингу для устройств и других служб Azure.

## <a name="event-grid-vs-azure-monitor"></a>Сетка событий и Azure Monitor

Сетка событий предоставляет решение для мониторинга с низкой задержкой, которое можно использовать для отслеживания подключений устройств к критически важным устройствам и инфраструктуре. Azure Monitor предоставляет метрику, *подключенные устройства*, которые можно использовать для наблюдения за числом устройств, подключенных к центру Интернета вещей, и запуска оповещений, когда это число становится меньше статического порогового значения.

При принятии решения о том, следует ли использовать сетку событий или Azure Monitor для конкретного сценария, учитывайте следующее.

* Задержка предупреждений. события подключения центра Интернета вещей доставляются гораздо быстрее с помощью службы "Сетка событий". Это делает сетку событий лучшим выбором для сценариев, в которых желательно быстрое уведомление.

* Уведомления для каждого устройства: сетка событий позволяет отключать подключения и отключать отдельные устройства. Это делает сетку событий лучшим выбором для сценариев, в которых необходимо отслеживать подключения для критически важных устройств.

* Упрощенная настройка. Azure Monitor оповещения метрик предоставляют упрощенную процедуру установки, которая не требует интеграции с другими службами для доставки уведомлений по электронной почте, SMS, голосов и другим уведомлениям.  С помощью службы "Сетка событий" необходимо интегрироваться с другими службами Azure для доставки уведомлений. Обе службы могут интегрироваться с другими службами для запуска более сложных действий.

В связи с низкой задержкой и возможностями для каждого устройства в рабочих средах мы настоятельно рекомендуем использовать сетку событий для наблюдения за подключениями. Конечно, выбранный вариант не является эксклюзивным, вы можете использовать как Azure Monitor оповещения метрики, так и сетку событий. Независимо от выбора для отслеживания отключений, скорее всего, вы будете использовать Azure Monitor журналы ресурсов для устранения причин непредвиденных отключений устройств. В следующих разделах каждый из этих вариантов рассматривается более подробно.

## <a name="event-grid-monitor-device-connect-and-disconnect-events"></a>Сетка событий: мониторинг событий подключения и отключения устройства

Чтобы отслеживать события подключения и отключения устройств в рабочей среде, мы рекомендуем подписаться на [события **Девицеконнектед** и **Девицедисконнектед**](iot-hub-event-grid.md#event-types) в службе "Сетка событий", чтобы активировать предупреждения и отслеживать состояние подключения устройства. Сетка событий обеспечивает большую задержку событий, чем Azure Monitor, и вы можете наблюдать за каждым устройством, а не с общим числом подключенных устройств. Эти факторы делают сетку событий предпочтительным методом для мониторинга критически важных устройств и инфраструктуры.

При использовании службы "Сетка событий" для наблюдения или активации оповещений при отключении устройств убедитесь, что сборка выполняется путем фильтрации периодических отключений из-за продления токена SAS на устройствах, использующих пакеты SDK для Интернета вещей Azure. Дополнительные сведения см. в разделе [поведение отключения устройства MQTT с помощью пакетов SDK для Интернета вещей Azure](#mqtt-device-disconnect-behavior-with-azure-iot-sdks).

Ознакомьтесь со следующими разделами, чтобы узнать больше о мониторинге событий подключения устройств с помощью сетки событий.

* Общие сведения об использовании сетки событий с центром Интернета вещей см. [в статье реагирование на события центра Интернета вещей с помощью сетки событий](iot-hub-event-grid.md). Обратите особое внимание на [ограничения в разделе подключения устройства и события отключения устройства](iot-hub-event-grid.md#limitations-for-device-connected-and-device-disconnected-events) .

* Руководство по упорядочиванию событий подключения устройств см. в статье [заказ событий подключения устройств из центра Интернета вещей Azure с помощью Azure Cosmos DB](iot-hub-how-to-order-connection-state-events.md).

* Руководство по отправке уведомлений по электронной почте см. в статье [Отправка уведомлений по электронной почте о событиях центра Интернета вещей Azure с помощью службы "Сетка событий" и Logic Apps](../event-grid/publish-iot-hub-events-to-logic-apps.md) в документации по службе "Сетка событий".

## <a name="azure-monitor-route-connection-events-to-logs"></a>Azure Monitor: маршрутизация событий подключения в журналы

Центр Интернета вещей непрерывно выдает журналы ресурсов для нескольких категорий операций. Однако для получения этих данных журнала необходимо создать параметр диагностики, чтобы направить его в место назначения, где их можно проанализировать или заархивировать. Одним из таких назначений является Azure Monitor журналов через Log Analytics рабочую область ([см. цены](https://azure.microsoft.com/pricing/details/log-analytics/)), где можно анализировать данные с помощью запросов Kusto.

[Категория соединений с журналами ресурсов](monitor-iot-hub-reference.md#connections) центра Интернета вещей выдает операции и ошибки, относящиеся к подключениям устройств. На следующем снимке экрана показан параметр диагностики для маршрутизации этих журналов в рабочую область Log Analytics:

:::image type="content" source="media/iot-hub-troubleshoot-connectivity/create-diagnostic-setting.png" alt-text="Рекомендуемый параметр для отправки журналов подключения в Log Analytics рабочую область.":::

Рекомендуется создать параметр диагностики как можно раньше после создания центра Интернета вещей, поскольку хотя центр Интернета вещей всегда создает журналы ресурсов, они не собираются Azure Monitor, пока вы не направите их в место назначения.

Дополнительные сведения о маршрутизации журналов в назначение см. в разделе [сбор и маршрутизация](monitor-iot-hub.md#collection-and-routing). Подробные инструкции по созданию параметров диагностики см. в руководстве по [использованию метрик и журналов](tutorial-use-metrics-and-diags.md).

## <a name="azure-monitor-set-up-metric-alerts-for-device-disconnect-at-scale"></a>Azure Monitor: Настройка оповещений метрик для отключения устройства в масштабе

Вы можете настроить оповещения на основе метрик платформы, созданных центром Интернета вещей. С помощью оповещений метрик можно уведомлять пользователей о том, что возникло определенное условие, а также запускать действия, которые могут автоматически отвечать на это условие.

Метрика [*подключенных устройств (Предварительная версия)*](monitor-iot-hub-reference.md#device-metrics) показывает, сколько устройств подключено к центру Интернета вещей. Вы можете создать оповещения для активации, если метрика станет меньше порогового значения:

:::image type="content" source="media/iot-hub-troubleshoot-connectivity/configure-alert-logic.png" alt-text="Параметры логики оповещений для метрики подключенных устройств.":::

Вы можете использовать правила генерации оповещений метрик для отслеживания ошибок при отключении устройства в масштабе. То есть при неожиданном отключении значительного числа устройств. При обнаружении такого вхождения можно просмотреть журналы, чтобы помочь устранить проблему. Для наблюдения за отсоединением устройств от критических устройств и отключения от них; Однако необходимо использовать сетку событий. Служба "Сетка событий" также обеспечивает работу в режиме реального времени, чем метрики Azure.

Дополнительные сведения об оповещениях в центре Интернета вещей см. [в разделе оповещения в мониторе монитора Интернета вещей](monitor-iot-hub.md#alerts). Пошаговое руководство по созданию оповещений в центре Интернета вещей см. в [руководстве по использованию метрик и журналов](tutorial-use-metrics-and-diags.md). Более подробные сведения об оповещениях см. в разделе [Обзор оповещений в Microsoft Azure](../azure-monitor/alerts/alerts-overview.md) в документации по Azure Monitor.

## <a name="azure-monitor-use-logs-to-resolve-connectivity-errors"></a>Azure Monitor: использование журналов для разрешения ошибок подключения

При обнаружении отсоединения устройств (независимо от того, с Azure Monitor оповещений о метриках или с помощью сетки событий) можно использовать журналы для помощи в устранении причины. В этом разделе описано, как найти распространенные проблемы в журналах Azure Monitor. В описанных ниже действиях предполагается, что вы уже создали [параметр диагностики](#azure-monitor-route-connection-events-to-logs) для отправки журналов подключений центра Интернета вещей в рабочую область log Analytics.

После создания параметра диагностики для маршрутизации журналов ресурсов центра Интернета вещей в журналы Azure Monitor выполните следующие действия, чтобы просмотреть журналы в портал Azure.

1. Перейдите в центр Интернета вещей в [портал Azure](https://portal.azure.com).

1. В разделе **мониторинг** на левой панели центра Интернета вещей выберите **журналы**.

1. Чтобы изолировать журналы ошибок подключения для центра Интернета вещей, введите следующий запрос в редакторе запросов и выберите **выполнить**:

    ```kusto
    AzureDiagnostics
    | where ( ResourceType == "IOTHUBS" and Category == "Connections" and Level == "Error")
    ```

1. В результатах (если они будут) найдите `OperationName`, `ResultType` (код ошибки) и `ResultDescription` (сообщение об ошибке), чтобы получить более подробную информацию об ошибке.

   ![Пример журнала ошибок](./media/iot-hub-troubleshoot-connectivity/diag-logs.png)

Определив ошибку, следуйте руководствам по устранению проблем, чтобы получить справку по наиболее распространенным ошибкам.

* [400027 ConnectionForcefullyClosedOnNewConnection](iot-hub-troubleshoot-error-400027-connectionforcefullyclosedonnewconnection.md)

* [404104 DeviceConnectionClosedRemotely](iot-hub-troubleshoot-error-404104-deviceconnectionclosedremotely.md)

* [401003 IoTHubUnauthorized](iot-hub-troubleshoot-error-401003-iothubunauthorized.md)

* [409002 LinkCreationConflict](iot-hub-troubleshoot-error-409002-linkcreationconflict.md)

* [500001 ServerError](iot-hub-troubleshoot-error-500xxx-internal-errors.md)

* [500008 GenericTimeout](iot-hub-troubleshoot-error-500xxx-internal-errors.md)

## <a name="mqtt-device-disconnect-behavior-with-azure-iot-sdks"></a>Поведение отключения устройства MQTT с помощью пакетов SDK для Интернета вещей Azure

Пакеты SDK для устройств Azure IoT отключаются от центра Интернета вещей, а затем повторно подключаются при обновлении маркеров SAS через протокол MQTT (и MQTT через WebSockets). В журналах это отображается как информационное отключение устройства и события подключения, которые иногда сопровождают событиями ошибок.

По умолчанию срок жизни маркера составляет 60 минут для всех пакетов SDK; Тем не менее, разработчики могут изменить его в некоторых пакетах SDK. В следующей таблице приведены сведения о сроках существования маркера, продлении токена и возобновлении маркеров для каждого из пакетов SDK.

| SDK | Срок существования токена | Продление срока действия маркера | Поведение при продлении |
|-----|----------|---------------------|---------|
| .NET | 60 минут, настраиваемый | 85% срока существования, настраиваемое | Пакет SDK подключается и отключается в течение срока действия маркера плюс 10-минутный льготный период. Информационные события и ошибки, созданные в журналах. |
| Java | 60 минут, настраиваемый | 85% срока существования, не может быть настроено | Пакет SDK подключается и отключается в течение срока действия маркера плюс 10-минутный льготный период. Информационные события и ошибки, созданные в журналах. |
| Node.js | 60 минут, настраиваемый | можно настроить | Пакет SDK подключается и отключается при обновлении токена. В журналах создаются только информационные события. |
| Python | 60 минут, не может быть настроено | -- | Пакет SDK подключается и отключается в течение срока существования маркера. |

На следующих снимках экрана показано поведение обновления маркера в журналах Azure Monitor для разных пакетов SDK. Значения по умолчанию для срока существования и обновления маркера были изменены, как указано.

* Пакет SDK для устройств .NET с 1200-секундным сроком действия маркера (20 минут) и продлением на 90% срока существования. Отключение происходит каждые 30 минут:

    :::image type="content" source="media/iot-hub-troubleshoot-connectivity/net-mqtt.png" alt-text="Поведение при возобновлении токена по MQTT в журналах Azure Monitor с помощью пакета SDK для .NET.":::

* Пакет SDK для Java с 300-секундным временем существования маркера и по умолчанию 85% продления срока существования. Отключение происходит каждые 15 минут:

    :::image type="content" source="media/iot-hub-troubleshoot-connectivity/java-mqtt.png" alt-text="Поведение при возобновлении токена по MQTT в журналах Azure Monitor с пакетом SDK для Java.":::

* Пакет SDK для Node со сроком действия маркера 300 секунды (5 минут), а продление токена составляет 3 минуты. Происходит отключение при обновлении токена. Кроме того, не возникает ошибок, выдаются только информационные события подключения и отключения:

    :::image type="content" source="media/iot-hub-troubleshoot-connectivity/node-mqtt.png" alt-text="Поведение при возобновлении токена по MQTT в журналах Azure Monitor с помощью пакета SDK для Node.":::

Для накопления результатов использовался следующий запрос. Запрос извлекает имя и версию пакета SDK из контейнера свойств. Дополнительные сведения см. в статье [версия пакета SDK в журналах центра Интернета вещей](monitor-iot-hub.md#sdk-version-in-iot-hub-logs).

```kusto
AzureDiagnostics
| where ResourceProvider == "MICROSOFT.DEVICES" and ResourceType == "IOTHUBS"
| where Category == "Connections"
| extend parsed_json = parse_json(properties_s)
| extend SDKVersion = tostring(parsed_json.sdkVersion) , DeviceId = tostring(parsed_json.deviceId) , Protocol =  tostring(parsed_json.protocol)
| distinct TimeGenerated, OperationName, Level, ResultType, ResultDescription, DeviceId, Protocol, SDKVersion

```

В качестве разработчика или оператора решений IoT необходимо учитывать такое поведение, чтобы интерпретировать события подключения и отключения и связанные ошибки в журналах. Если вы хотите изменить время существования маркера или режим продления для устройств, проверьте, реализует ли устройство параметр двойникаа устройства или метод устройства, который делает это возможным.

Если вы отслеживаете подключения устройств с помощью концентратора событий, убедитесь, что сборка выполняется путем фильтрации периодических отключений из-за продления токена SAS. Например, не запускает действия на основе отключений, если за ним следует событие Connect за определенный промежуток времени.

> [!NOTE]
> Центр Интернета вещей поддерживает только одно активное подключение MQTT на устройство. Любое новое подключение MQTT от имени того же идентификатора устройства приводит к тому, что Центр Интернета вещей разрывает существующее подключение.
>
> 400027 Коннектионфорцефулликлоседонневконнектион будет выполнен вход в журналы центра Интернета вещей

## <a name="i-tried-the-steps-but-they-didnt-work"></a>Предложенные шаги не помогли устранить проблему

Если предыдущие действия не помогли, попробуйте следующее.

* Если у вас есть доступ к проблемным устройствам физически или удаленно (например, через SSH), выполните инструкции в [руководстве по устранению неполадок на стороне устройства](https://github.com/Azure/azure-iot-sdk-node/wiki/Troubleshooting-Guide-Devices), чтобы устранить неполадки.

* Убедитесь, что ваши устройства **включены**. На портале Azure выберите "Центр Интернета вещей > Устройства IoT".

* Если устройство использует протокол MQTT, убедитесь, что порт 8883 открыт. Дополнительные сведения см. в разделе [Подключение к Центру Интернета вещей (MQTT)](iot-hub-mqtt-support.md#connecting-to-iot-hub).

* Получите помощь на [странице Майкрософт с вопросами и ответами о Центре Интернета вещей](/answers/topics/azure-iot-hub.html), в [Stack Overflow](https://stackoverflow.com/questions/tagged/azure-iot-hub) или в [службе поддержки Azure](https://azure.microsoft.com/support/options/).

Чтобы помочь улучшить документацию, оставьте комментарий в разделе отзывов, если сведения в этом руководстве не были полезны.

## <a name="next-steps"></a>Дальнейшие действия

* Дополнительные сведения об устранении временных проблем см. в статье [Обработка временных сбоев](/azure/architecture/best-practices/transient-faults).

* Дополнительные сведения о пакете SDK для Интернета вещей Azure и об управлении механизмами повторов см. в разделе [Управление подключениями и надежный обмен сообщениями](iot-hub-reliability-features-in-sdks.md#connection-and-retry).