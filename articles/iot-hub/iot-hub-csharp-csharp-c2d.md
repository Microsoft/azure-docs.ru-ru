---
title: Отправка сообщений из облака на устройство с помощью Центра Интернета вещей Azure (.NET) | Документация Майкрософт
description: Сведения об отправке сообщений из облака на устройство из Центра Интернета вещей Azure с помощью пакетов SDK для Интернета вещей Azure для .NET. Для получения сообщений, отправляемых из облака на устройство, следует изменить приложение для устройства, а для отправки таких сообщений — внутреннее приложение.
author: robinsh
manager: philmea
ms.service: iot-hub
services: iot-hub
ms.devlang: csharp
ms.topic: conceptual
ms.date: 07/07/2020
ms.author: robinsh
ms.custom:
- amqp
- mqtt
- 'Role: Cloud Development'
- 'Role: IoT Device'
- devx-track-csharp
ms.openlocfilehash: d8df9884c0104792240d85d9ebd4235ef2a18741
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "92142359"
---
# <a name="send-messages-from-the-cloud-to-your-device-with-iot-hub-net"></a>Отправка сообщений из облака на устройство с помощью Центра Интернета вещей (.NET)

[!INCLUDE [iot-hub-selector-c2d](../../includes/iot-hub-selector-c2d.md)]

Центр Интернета вещей Azure — это полностью управляемая служба, которая обеспечивает надежный и защищенный двунаправленный обмен данными между миллионами устройств и серверной частью решения. В кратком руководстве по [отправке данных телеметрии с устройства в центр Интернета вещей](quickstart-send-telemetry-dotnet.md) показано, как создать центр Интернета вещей, подготовить в нем удостоверение устройства и написать код приложения для устройства, которое отправляет сообщения из устройства в облако.

[!INCLUDE [iot-hub-basic](../../includes/iot-hub-basic-whole.md)]

Этот учебник является логическим продолжением статьи по [отправке данных телеметрии с устройства в центр Интернета вещей](quickstart-send-telemetry-dotnet.md). В нем описывается, как выполнять следующие задачи:

* Отправка сообщений, передаваемых из облака на устройство, из серверной части решения на одно устройство через Центр Интернета вещей.

* Получение на устройстве сообщений, передаваемых из облака на устройство.

* Запрос из серверной части решения подтверждения доставки (*отзыва*) для сообщений, отправленных на устройство из Центра Интернета вещей.

Дополнительные сведения о сообщениях, отправляемых из облака на устройство, см. в статье [Обмен сообщениями между устройством и облаком с помощью Центра Интернета вещей](iot-hub-devguide-messaging.md).

В конце этого руководства запускаются два консольных приложения для .NET.

* **SimulatedDevice**. Это приложение подключается к центру Интернета вещей и получает сообщения, отправляемые из облака на устройство. Это приложение является измененной версией приложения, созданного в руководстве [Отправка данных телеметрии с устройства в центр Интернета вещей](quickstart-send-telemetry-dotnet.md).

* **SendCloudToDevice**. Это приложение отправляет сообщение из облака в приложение устройства через Центр Интернета вещей и затем получает подтверждение доставки сообщения.

> [!NOTE]
> В Центре Интернета вещей реализована поддержка для пакетов SDK для многих платформ устройств и языков (включая C, Java, Python и Javascript). Эти пакеты работают на основе [пакетов SDK для устройств Azure IoT](iot-hub-devguide-sdks.md). Пошаговые инструкции по связыванию устройства с кодом из этого руководства, а также по подключению к Центру Интернета вещей Azure см. в [руководстве разработчика для Центра Интернета вещей](iot-hub-devguide.md).
>

## <a name="prerequisites"></a>Предварительные требования

* Visual Studio

* Активная учетная запись Azure. Если ее нет, можно создать [бесплатную учетную запись](https://azure.microsoft.com/pricing/free-trial/) всего за несколько минут.

* Убедитесь, что в брандмауэре открыт порт 8883. Пример устройства в этой статье использует протокол MQTT, который передает данные через порт 8883. В некоторых корпоративных и академических сетях этот порт может быть заблокирован. Дополнительные сведения и способы устранения этой проблемы см. в разделе о [подключении к Центру Интернета вещей по протоколу MQTT](iot-hub-mqtt-support.md#connecting-to-iot-hub).

## <a name="receive-messages-in-the-device-app"></a>Получение сообщений в приложении для устройства

В этом разделе вы измените приложение устройства, созданное в руководстве [Отправка данных телеметрии с устройства в Центр Интернета вещей](quickstart-send-telemetry-dotnet.md), чтобы с помощью Центра Интернета вещей получать сообщения из облака на устройство.

1. В Visual Studio в проекте **SimulatedDevice** добавьте следующий метод в класс **SimulatedDevice** .

   ```csharp
    private static async void ReceiveC2dAsync()
    {
        Console.WriteLine("\nReceiving cloud to device messages from service");
        while (true)
        {
            Message receivedMessage = await s_deviceClient.ReceiveAsync();
            if (receivedMessage == null) continue;

            Console.ForegroundColor = ConsoleColor.Yellow;
            Console.WriteLine("Received message: {0}", 
            Encoding.ASCII.GetString(receivedMessage.GetBytes()));
            Console.ResetColor();

            await s_deviceClient.CompleteAsync(receivedMessage);
        }
    }
   ```

1. Добавьте в метод **Main** непосредственно перед строкой `Console.ReadLine()` следующий метод:

   ```csharp
   ReceiveC2dAsync();
   ```

Метод `ReceiveAsync` асинхронно возвращает полученное сообщение, когда устройство его получило. Он возвращает *NULL* после указанного периода ожидания. В этом примере установлен период по умолчанию — одна минута. Когда приложение получит значение *NULL*, оно продолжит ожидание новых сообщений. Из-за этого требования присутствует строка `if (receivedMessage == null) continue`.

Вызов `CompleteAsync()` уведомляет центр Интернета вещей о том, что сообщение успешно обработано, и что сообщение можно безопасно удалить из очереди устройства. Устройство должно вызывать этот метод при успешном завершении обработки, независимо от используемого протокола.

С AMQP и HTTPS, но не с MQTT, устройство также может:

* Отказаться от сообщения, в результате чего центр Интернета вещей будет хранить сообщение в очереди устройства для будущего использования.
* Отклонить сообщение, которое окончательно удаляет сообщение из очереди устройства.

Если что-то происходит, что не позволяет устройству завершить работу, отменять или отклонять сообщение, центр Интернета вещей через фиксированный период времени ожидания помещает сообщение в очередь для доставки. По этой причине логика обработки сообщений в приложении устройства должна быть *идемпотентными*, поэтому при многократном получении одного и того же сообщения выдается один и тот же результат.

Дополнительные сведения о том, как центр Интернета вещей обрабатывает сообщения, пересылаемые из облака на устройство, включая сведения о жизненном цикле сообщений, отправляемых из облака на устройство, см. в статье [Отправка сообщений из облака на устройство из центра Интернета вещей](iot-hub-devguide-messages-c2d.md).

> [!NOTE]
> При использовании HTTPS вместо MQTT или AMQP в качестве транспорта немедленно возвращается метод `ReceiveAsync`. Поддерживаемый шаблон для сообщений, отправляемых из облака на устройство с протоколом HTTPS, — это периодически подключаемые устройства, которые проверяют наличие сообщений нечасто (по крайней мере каждые 25 минут). Если HTTPS получает много результатов, регулируются запросы в Центре Интернета вещей. Дополнительные сведения о различиях между MQTT, AMQP и поддержкой HTTPS см. в [статье Руководство по обмену данными между облаком и устройством](iot-hub-devguide-c2d-guidance.md) и [Выбор протокола связи](iot-hub-devguide-protocols.md).
>

## <a name="get-the-iot-hub-connection-string"></a>Получение строки подключения центра Интернета вещей

В этой статье вы создадите серверную службу для отправки сообщений из облака на устройство через центр Интернета вещей, созданный в кратком руководстве [Отправка данных телеметрии с устройства в центр Интернета вещей](quickstart-send-telemetry-dotnet.md). Для отправки сообщений из облака на устройство службе требуется разрешение **service connect**. По умолчанию каждый Центр Интернета вещей создается с помощью политики общего доступа, называемой **службой**, которая предоставляет это разрешение.

[!INCLUDE [iot-hub-include-find-service-connection-string](../../includes/iot-hub-include-find-service-connection-string.md)]

## <a name="send-a-cloud-to-device-message"></a>Отправка сообщения из облака на устройство

В этом разделе вы создадите консольное приложение .NET, которое отправляет сообщения из облака на устройство в приложение имитации устройства.

1. В текущем решении Visual Studio выберите **Файл** > **Создать** > **Проект**. В окне **Создание проекта** выберите **Консольное приложение (.NET Framework)** и нажмите кнопку **Далее**.

1. Присвойте проекту имя *SendCloudToDevice*. В разделе **Решение** выберите **Добавить в решение** и примите последнюю версию .NET Framework. Выберите **Создать**, чтобы создать проект.

   ![Настройка нового проекта в Visual Studio](./media/iot-hub-csharp-csharp-c2d/sendcloudtodevice-project-configure.png)

1. В обозреватель решений щелкните правой кнопкой мыши новый проект и выберите пункт **Управление пакетами NuGet**.

1. В окне **Управление пакетами NuGet** нажмите **Обзор**, найдите и выберите **Microsoft.Azure.Devices**. Нажмите **Установить**.

   После этого будут выполнены скачивание, установка и добавление ссылки на [пакет SDK NuGet для служб Azure IoT](https://www.nuget.org/packages/Microsoft.Azure.Devices/).

1. Добавьте следующий оператор `using` в начало файла **Program.cs**.

   ``` csharp
   using Microsoft.Azure.Devices;
   ```

1. Добавьте следующие поля в класс **Program** . Замените `{iot hub connection string}` значение заполнителя строкой подключения центра Интернета вещей, записанной ранее в [поле получение строки подключения для центра Интернета вещей](#get-the-iot-hub-connection-string). Замените `{device id}` значение ЗАПОЛНИТЕЛЯ идентификатором устройства, добавленного в краткое руководство по [отправке данных телеметрии с устройства в центр Интернета вещей](quickstart-send-telemetry-dotnet.md) .

   ``` csharp
   static ServiceClient serviceClient;
   static string connectionString = "{iot hub connection string}";
   static string targetDevice = "{device id}";
   ```

1. Добавьте следующий метод в класс **Program** , чтобы отправить сообщение на устройство.

   ``` csharp
   private async static Task SendCloudToDeviceMessageAsync()
   {
        var commandMessage = new
         Message(Encoding.ASCII.GetBytes("Cloud to device message."));
        await serviceClient.SendAsync(targetDevice, commandMessage);
   }
   ```

1. Наконец, добавьте следующие строки в метод **Main** .

   ``` csharp
   Console.WriteLine("Send Cloud-to-Device message\n");
   serviceClient = ServiceClient.CreateFromConnectionString(connectionString);

   Console.WriteLine("Press any key to send a C2D message.");
   Console.ReadLine();
   SendCloudToDeviceMessageAsync().Wait();
   Console.ReadLine();
   ```

1. В обозревателе решений щелкните решение правой кнопкой мыши и выберите **Назначить запускаемые проекты**.

1. В меню **стандартные свойства**  >  **Запуск проекта** выберите **Несколько запускаемых проектов**, а затем выберите действие при **запуске** для **SimulatedDevice** и **SendCloudToDevice**. Нажмите кнопку **ОК** , чтобы сохранить изменения.

1. Нажмите клавишу **F5**. Должны запуститься оба приложения. Выберите окно **SendCloudToDevice** и нажмите клавишу **Ввод**. Приложение для устройства должно получить сообщение.

   ![Сообщение получения приложения устройства](./media/iot-hub-csharp-csharp-c2d/sendc2d1.png)

## <a name="receive-delivery-feedback"></a>Получение подтверждений доставки

Для каждого сообщения, передаваемого из облака на устройство, в Центре Интернета вещей можно запросить подтверждения доставки (или истечения срока действия). Этот параметр позволяет серверной части решения легко передавать данные в логику повторных попыток или компенсаций. Дополнительные сведения об отзывах сообщений, передаваемых из облака на устройство, см. в статье [Обмен сообщениями между устройством и облаком с помощью Центра Интернета вещей](iot-hub-devguide-messaging.md).

В этом разделе вы измените приложение **SendCloudToDevice**, чтобы оно запрашивало подтверждение и получало его из Центра Интернета вещей.

1. В Visual Studio в проекте **SendCloudToDevice** добавьте в класс **Program** следующий метод:

   ```csharp
   private async static void ReceiveFeedbackAsync()
   {
        var feedbackReceiver = serviceClient.GetFeedbackReceiver();

        Console.WriteLine("\nReceiving c2d feedback from service");
        while (true)
        {
            var feedbackBatch = await feedbackReceiver.ReceiveAsync();
            if (feedbackBatch == null) continue;

            Console.ForegroundColor = ConsoleColor.Yellow;
            Console.WriteLine("Received feedback: {0}",
              string.Join(", ", feedbackBatch.Records.Select(f => f.StatusCode)));
            Console.ResetColor();

            await feedbackReceiver.CompleteAsync(feedbackBatch);
        }
    }
    ```

    Обратите внимание, что шаблон получения здесь аналогичен шаблону, использовавшемуся для получения сообщений из облака на устройство из приложения устройства.

1. Добавьте в метод **Main** сразу после строки `serviceClient = ServiceClient.CreateFromConnectionString(connectionString)` следующую строку.

   ``` csharp
   ReceiveFeedbackAsync();
   ```

1. Чтобы запросить подтверждение доставки сообщения из облака на устройство, необходимо указать свойство в методе **SendCloudToDeviceMessageAsync** . Добавьте следующую строку сразу после строки `var commandMessage = new Message(...);`.

   ``` csharp
   commandMessage.Ack = DeliveryAcknowledgement.Full;
   ```

1. Запустите приложения, нажав клавишу **F5**. Вы должны увидеть, что оба приложения запущены. Выберите окно **SendCloudToDevice** и нажмите клавишу **Ввод**. Приложение для устройства должно получить сообщение, а через несколько секунд ваше приложение **SendCloudToDevice** должно получить сообщение о подтверждении.

   ![Получение сообщения и получения отзыва от приложения для устройства](./media/iot-hub-csharp-csharp-c2d/sendc2d2.png)

> [!NOTE]
> Для упрощения в этом руководстве не реализуются политики повтора. В рабочем коде следует реализовать политики повторных попыток (например, с экспоненциальной задержкой), как указано в статье [Обработка временных сбоев](/azure/architecture/best-practices/transient-faults).
>

## <a name="next-steps"></a>Дальнейшие действия

В этом руководстве вы научились отправлять и получать сообщения из облака на устройство.

Примеры комплексных решений, в которых используется Центр Интернета вещей, см. в [документации по акселератору решения Azure IoT для удаленного мониторинга](/azure/iot-suite/).

Дополнительные сведения о разработке решений с помощью Центра Интернета вещей см. в [руководстве разработчика для Центра Интернета вещей](iot-hub-devguide.md).