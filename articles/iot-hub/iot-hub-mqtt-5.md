---
title: Поддержка центра Интернета вещей Azure MQTT 5 (Предварительная версия)
description: Дополнительные сведения о поддержке MQTT 5 в центре Интернета вещей
services: iot-hub
author: jlian
ms.service: iot-fundamentals
ms.topic: conceptual
ms.date: 11/19/2020
ms.author: jlian
ms.openlocfilehash: fb2cc0b81083936a67bcd465e0408b9f4b53996b
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "96603555"
---
# <a name="iot-hub-mqtt-5-support-overview-preview"></a>Обзор поддержки MQTT 5 центра Интернета вещей (Предварительная версия)

**Версия:** 2,0 **api версии:** 2020-10-01-Preview

Этот документ определяет API плоскости данных центра Интернета вещей по протоколу MQTT версии 5,0. Полные определения в этом API см. в [справочнике по API](iot-hub-mqtt-5-reference.md) .

## <a name="prerequisites"></a>Предварительные условия

- [Включите режим предварительного просмотра](iot-hub-preview-mode.md) для нового центра Интернета вещей, чтобы попробовать MQTT 5.
- Требуются знания о [спецификации MQTT 5](https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html) .

## <a name="level-of-support-and-limitations"></a>Уровень поддержки и ограничений

Поддержка центра Интернета вещей для MQTT 5 доступна в предварительной версии и ограничена следующими способами (с передачей клиенту через `CONNACK` свойства, если явно не указано иное):

- Официальная поддержка [пакета SDK для устройств центра Интернета вещей Azure](iot-hub-devguide-sdks.md) еще не предусмотрена.
- Идентификаторы подписок не поддерживаются.
- Общие подписки не поддерживаются.
- `RETAIN` не поддерживается.
- Параметр `Maximum QoS` равен `1`.
- `Maximum Packet Size` — `256 KiB` (подчиняются дополнительным ограничениям на операцию).
- Назначенные идентификаторы клиентов не поддерживаются.
- `Keep Alive` ограничено `19 min` (максимальная задержка для проверки на актуальность — `28.5 min` ).
- Параметр `Topic Alias Maximum` равен `10`.
- `Response Information` не поддерживается; `CONNACK` не возвращает `Response Information` свойство, даже если `CONNECT` содержит `Request Response Information` свойство.
- `Receive Maximum` (максимальное количество разрешенных неподтвержденных `PUBLISH` пакетов (в направлении "клиент-сервер") `QoS: 1` — `16` .
- У одного клиента может быть не больше `50` подписок.
  По достижении предела `SUBACK` будет возвращен `0x97` код причины (Превышение квоты) для подписок.

## <a name="connection-lifecycle"></a>Жизненный цикл подключения

### <a name="connection"></a>Подключение

Чтобы подключить клиент к центру Интернета вещей с помощью этого API, установите подключение для каждой спецификации MQTT 5.
Клиент должен отправить `CONNECT` пакет в течение 30 секунд после успешного подтверждения TLS или сервер закроет подключение.
Ниже приведен пример `CONNECT` пакета.

```yaml
-> CONNECT
    Protocol_Version: 5
    Clean_Start: 0
    Client_Id: D1
    Authentication_Method: SAS
    Authentication_Data: {SAS bytes}
    api-version: 2020-10-10
    host: abc.azure-devices.net
    sas-at: 1600987795320
    sas-expiry: 1600987195320
    client-agent: artisan;Linux
```

- `Authentication Method` свойство является обязательным и определяет используемый метод проверки подлинности. Дополнительные сведения о методе проверки подлинности см. в разделе [Проверка подлинности](#authentication).
- `Authentication Data` Обработка свойств зависит от `Authentication Method` . Если параметр `Authentication Method` имеет значение `SAS` , то `Authentication Data` параметр является обязательным и должен содержать допустимую сигнатуру. Дополнительные сведения о данных проверки подлинности см. в разделе [Проверка подлинности](#authentication).
- `api-version` свойство является обязательным и должно быть установлено в значение версии API, указанное в заголовке этой спецификации для применения этой спецификации.
- `host` свойство определяет имя узла клиента. Это необходимо, если только расширение SNI не было представлено в записи Client Hello во время подтверждения TLS.
- `sas-at` Определяет время соединения.
- `sas-expiry` Определяет время истечения срока действия предоставленного SAS.
- `client-agent` При необходимости сообщает сведения о клиенте, создающем соединение.

> [!NOTE]
> `Authentication Method` и другие свойства в спецификации с прописными именами — это свойства первого класса в MQTT 5. они описаны в статье сведения о спецификации MQTT 5. `api-version` и другие свойства в штриховых регистрах — это свойства пользователя, относящиеся к API центра Интернета вещей.

Центр Интернета вещей реагирует на `CONNACK` пакет после завершения проверки подлинности и получения данных для поддержки подключения. Если подключение установлено успешно, то `CONNACK` выглядит следующим образом:

```yaml
<- CONNACK
    Session_Present: 1
    Reason_Code: 0x00
    Session_Expiry_Interval: 0xFFFFFFFF # included only if CONNECT specified value less than 0xFFFFFFFF and more than 0x00
    Receive_Maximum: 16
    Maximum_QoS: 1
    Retain_Available: 0
    Maximum_Packet_Size: 262144
    Topic_Alias_Maximum: 10
    Subscription_Identifiers_Available: 0
    Shared_Subscriptions_Available: 0
    Server_Keep_Alive: 1140 # included only if client did not specify Keep Alive or if it specified a bigger value
```

Эти `CONNACK` Свойства пакета соответствуют [спецификации MQTT 5](https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901080). Они отражая возможности центра Интернета вещей.

### <a name="authentication"></a>Аутентификация

`Authentication Method`Свойство на `CONNECT` клиенте определяет тип проверки подлинности, используемый для этого подключения:

- `SAS` — Подпись общего доступа предоставляется в `CONNECT` `Authentication Data` свойстве,
- `X509` -Клиент использует проверку подлинности на основе сертификата клиента.

 Проверка подлинности завершается ошибкой, если метод проверки подлинности не совпадает с настроенным клиентом методом в центре Интернета вещей.

> [!NOTE]
> Для этого API необходимо `Authentication Method` , чтобы свойство было задано в `CONNECT` пакете. Если `Authentication Method` свойство не указано, соединение завершается с `Bad Request` ответом.

Проверка подлинности имени пользователя и пароля, используемая в предыдущих версиях API, не поддерживается.

#### <a name="sas"></a>SAS

При использовании проверки подлинности на основе SAS клиент должен предоставить подпись контекста соединения. Это подтверждает подлинность подключения MQTT. Подпись должна быть основана на одном из двух ключей проверки подлинности в конфигурации клиента в центре Интернета вещей или в одном из двух общих ключей доступа [политики общего доступа](iot-hub-devguide-security.md).

Строка для подписи должна быть сформирована следующим образом:

```text
{host name}\n
{Client Id}\n
{sas-policy}\n
{sas-at}\n
{sas-expiry}\n
```

- `host name` является производным от расширения SNI (представленного клиентом в записи Client Hello во время подтверждения TLS) или `host` свойством пользователя в `CONNECT` пакете.
- `Client Id` Идентификатор клиента в `CONNECT` пакете.
- `sas-policy` — При наличии определяет политику доступа для центра Интернета вещей, используемую для проверки подлинности. Он кодируется как свойство пользователя в `CONNECT` пакете. Необязательно. пропуск этого параметра означает, что вместо него будут использоваться параметры проверки подлинности в реестре устройств.
- `sas-at` — Если указано, указывает время подключения (текущее время). Он кодируется как свойство пользователя `time` типа в `CONNECT` пакете.
- `sas-expiry` определяет срок действия проверки подлинности. Это `time` типизированное свойство пользователя в `CONNECT` пакете. Это свойство обязательно.

Для необязательных параметров, если они опущены, в строке необходимо использовать пустую строку для подписывания.

HMAC-SHA256 используется для хэширования строки на основе одного из симметричных ключей устройства. Затем значение хэша задается в качестве значения `Authentication Data` Свойства.

#### <a name="x509"></a>X509

Если `Authentication Method` свойство имеет значение `X509` , центр Интернета вещей проверяет подлинность подключения на основе предоставленного сертификата клиента.

#### <a name="reauthentication"></a>Повторной проверки подлинности

Если используется проверка подлинности на основе SAS, рекомендуется использовать кратковременные маркеры проверки подлинности. Чтобы проверить подлинность подключения и запретить отключение из-за истечения срока действия, клиент должен выполнить повторную проверку подлинности, отправив `AUTH` пакет с помощью `Reason Code: 0x19` (повторная проверка подлинности)

```yaml
-> AUTH
    Reason_Code: 0x19
    Authentication_Method: SAS
    Authentication_Data: {SAS bytes}
    sas-at: {current time}
    sas-expiry: {SAS expiry time}
```

Правила:

- `Authentication Method` должно совпадать с именем, используемым для первоначальной проверки подлинности
- Если подключение изначально прошло проверку подлинности с использованием SAS на основе политики общего доступа, то сигнатура, используемая при повторной проверке подлинности, должна основываться на той же политике.

Если перепроверка подлинности завершается успешно, центр Интернета вещей отправляет `AUTH` пакет с помощью `Reason Code: 0x00` (Success). В противном случае центр Интернета вещей отправляет `DISCONNECT` пакет с `Reason Code: 0x87` (не санкционированным) и закрывает подключение.

### <a name="disconnection"></a>Отключения

Сервер может отключить клиент по нескольким причинам:

- Клиент является неправильным поведением, который не может ответить с отрицательным подтверждением (или ответом) напрямую,
- серверу не удалось синхронизировать состояние подключения в актуальном состоянии,
- клиент с тем же удостоверением подключен.

Сервер может отключиться с помощью любого кода причины, определенного в спецификации MQTT 5,0. Важные упоминания:

- `135` (Не разрешено) при сбое перепроверки подлинности срок действия текущего маркера SAS истекает или изменение учетных данных устройства
- `142` (Сеанс был сделан) при открытии нового подключения с тем же идентификатором клиента.
- `159` (Превышено число подключений), если частота подключения для центра Интернета вещей превышает  
- `131` (Ошибка, связанная с реализацией) используется для любых пользовательских ошибок, определенных в этом API. `status``reason`Свойства и будут использоваться для передачи дополнительных сведений о причине отключения (Дополнительные сведения см. в [ответе](#response) ).

## <a name="operations"></a>Операции

Все функции в этом API выражаются как операции. Ниже приведен пример операции Send телеметрии.

```yaml
-> PUBLISH
    QoS: 1
    Packet_Id: 3
    Topic: $iothub/telemetry
    Payload: Hello

<- PUBACK
    Packet_Id: 3
    Reason_Code: 0
```

Полную спецификацию операций в этом API см. в [справочнике по API](iot-hub-mqtt-5-reference.md).

> [!NOTE]
> Все примеры в этой спецификации показаны в перспективе клиента. Подпись `->` означает, что клиент отправляет пакет, `<-` — получение.

### <a name="message-topics-and-subscriptions"></a>Разделы и подписки на сообщения

Темы, используемые в сообщениях операций в этом API, начинаются с `$iothub/` .
Семантика брокера MQTT не применяется к этим операциям (Дополнительные сведения см. в разделе "[разделы, начинающиеся с \$ ](https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901246)").
Темы, начинающиеся с `$iothub/` , не определены в этом API, не поддерживаются:

- Отправка сообщений в неопределенный раздел приводит к получению `Not Found` ответа (Дополнительные сведения см. в [ответе](#response) ниже).
- При подписке на неопределенный раздел отображаются результаты `SUBACK` с `Reason Code: 0x8F` (недопустимый фильтр разделов).

Имена разделов и свойств чувствительны к регистру и должны точно совпадать. Например, `$iothub/telemetry/` не поддерживается, если `$iothub/telemetry` имеет.

> [!NOTE]
> Подстановочные знаки в подписках `$iothub/..` не поддерживаются. То есть клиент не может подписываться на `$iothub/+` или `$iothub/#` . Попытка сделать это приведет к результату `SUBACK` WITH `Reason Code: 0xA2` (подписки с подстановочными знаками не поддерживаются). Только односегментные подстановочные знаки ( `+` ) поддерживаются вместо параметров пути в имени раздела для операций, имеющих их.

### <a name="interaction-types"></a>Типы взаимодействия

Все операции в этом API основаны на одном из двух типов взаимодействия:

- Сообщение с дополнительным подтверждением (Мессажеакк)
- Request-Response (Рекреп)

Операции также зависят от направления (определяется направлением начального сообщения в Exchange):

- Клиент-сервер (C2S)
- Сервер-клиент (S2C)

Например, отправка данных телеметрии является операцией "клиент-сервер" типа "сообщение с подтверждением", тогда как для обработки прямого метода требуется операция "сервер-клиент" типа Request-Response.

#### <a name="message-acknowledgement-interactions"></a>Диалоги подтверждения сообщений

Сообщение с необязательным подтверждением (Мессажеакк) выражается как обмен `PUBLISH` `PUBACK` пакетами и в MQTT. Подтверждение является необязательным, и отправитель может не запросить его, отправив `PUBLISH` пакет с помощью `QoS: 0` .

> [!NOTE]
> Если свойства в `PUBACK` пакете должны быть усечены из-за `Maximum Packet Size` объявления клиентом, центр Интернета вещей будет хранить столько же свойств пользователей, сколько может уместиться в пределах заданного предела. Свойства пользователя, указанные в списке первыми, имеют более высокую вероятность отправки, чем в перечисленных ниже. `Reason String` свойство имеет наименьший приоритет.

##### <a name="example-of-simple-messageack-interaction"></a>Пример простого взаимодействия Мессажеакк

Сообщение:

```yaml
PUBLISH
    QoS: 1
    Packet_Id: 34
    Topic: $iothub/{request.path}
    Payload: <any>
```

Подтверждение (успешное завершение):

```yaml
PUBACK
    Packet_Id: 34
    Reason_Code: 0
```

#### <a name="request-response-interactions"></a>Request-Response взаимодействия

При взаимодействии Request-Response (Рекреп) как запрос, так и ответ переводятся в `PUBLISH` пакеты с `QoS: 0` .

`Correlation Data` свойство должно быть задано в и используется для сопоставления пакета ответа с запросом пакета.

Этот API использует один раздел ответа `$iothub/responses` для всех операций рекреп. Подписка и Отмена подписки на этот раздел для операций "клиент-сервер" не требуется — сервер предполагает, что все клиенты должны быть подписаны.

##### <a name="example-of-simple-reqrep-interaction"></a>Пример простого взаимодействия Рекреп

Запрос:

```yaml
PUBLISH
    QoS: 0
    Topic: $iothub/{request.path}
    Correlation_Data: 0x01 0xFA
    Payload: ...
```

Ответ (успешное завершение):

```yaml
PUBLISH
    QoS: 0
    Topic: $iothub/responses
    Correlation_Data: 0x01 0xFA
    Payload: ...
```

Взаимодействия Рекреп не поддерживают `PUBLISH` пакеты с `QoS: 1` как сообщения запроса или ответа. Отправка `PUBLISH` результатов запроса в `Bad Request` ответ на запрос.

Максимальная поддерживаемая длина `Correlation Data` Свойства — 16 байт. Если `Correlation Data` для свойства `PUBLISH` пакета задано значение более 16 байт, центр Интернета вещей отправляет `DISCONNECT` `Bad Request` результат и закрывает соединение. Это поведение применяется только к пакетам, переданным через этот API.

> [!NOTE]
> Данные корреляции — произвольная последовательность байтов, например, строка UTF-8 не гарантируется.
>
> Рекреп использовать предопределенные разделы для ответа; Свойство раздела ответа в `PUBLISH` пакете запроса (если оно задано отправителем) игнорируется.

Центр Интернета вещей автоматически подписывает клиентов на разделы ответов для всех операций "клиент-сервер". Даже если клиент явно отменяет подписку из раздела ответа, центр Интернета вещей автоматически возобновит подписку. Для взаимодействия "сервер-клиент" по-прежнему требуется, чтобы устройство подписалось на Рекреп.

### <a name="message-properties"></a>Свойства сообщения

Свойства операции — системные или пользовательские — указываются в виде свойств пакетов в MQTT 5.

В именах свойств пользователя учитывается регистр, и их необходимо указывать в точности так, как определено. Например, `Trace-ID` не поддерживается, если `trace-id` имеет.

Запросы со свойствами пользователя вне спецификации и без указания префикса имеют `@` значение Error.

Системные свойства кодируются либо как свойства первого класса (например, `Content Type` ), либо как свойства пользователя. Спецификация содержит исчерпывающий список поддерживаемых системных свойств.
Все свойства первого класса игнорируются, если их поддержка явным образом не указана в спецификации.

Если разрешены определяемые пользователем свойства, их имена должны соответствовать формату `@{property name}` . Определяемые пользователем свойства поддерживают только допустимые строковые значения UTF-8. Например, `MyProperty1` свойство со значением `15` должно быть закодировано как свойство пользователя с именем `@MyProperty` и значением `15` .

Если центр Интернета вещей не распознает свойство пользователя, он считается ошибкой, а центр Интернета вещей отвечает `PUBACK` с `Reason Code: 0x83` (ошибками конкретной реализации) и `status: 0100` (недопустимый запрос). Если подтверждение не было запрошено (QoS: 0), `DISCONNECT` произойдет Отправка пакета с той же ошибкой и подключение будет прервано.

Этот API определяет следующие типы данных, помимо `string` :

- `time`: число миллисекунд с `1970-01-01T00:00:00.000Z` . Например, `1600987195320` для `2020-09-24T22:39:55.320Z` ,
- `u32`: 32-разрядное целое число без знака,
- `u64`: 64-разрядное целое число без знака,
- `i32`: 32-разрядное целое число со знаком.

### <a name="response"></a>Ответ

Взаимодействие может привести к различным результатам: `Success` , `Bad Request` , `Not Found` и другим.
Результаты различаются по `status` свойствам пользователя. `Reason Code` в `PUBACK` пакетах (для взаимодействий мессажеакк) соответствует `status` , где это возможно.

> [!NOTE]
> Если клиент указывает `Request Problem Information: 0` в параметре Connect, пакеты не будут отправляться по `PUBACK` пакетам в соответствии со спецификацией MQTT 5, `status` включая свойство. В этом случае клиент по-прежнему может использовать, `Reason Code` чтобы определить, является ли подтверждение положительным или отрицательным. 

Каждое взаимодействие имеет значение по умолчанию (или успешно). Он имеет `Reason Code` `0` свойство и со `status` значением "Not Set". В противном случае:

- Для взаимодействий Мессажеакк `PUBACK` возвращает, кроме `Reason Code` 0x0 (успешно). `status` может присутствовать свойство, чтобы уточнить результат.
- Для взаимодействий Рекреп ответ `PUBLISH` получает `status` набор свойств.
- Так как не существует способа реагирования на взаимодействия Мессажеакк с `QoS: 0` напрямую, `DISCONNECT` вместо сведений о ответе отправляется пакет, а затем отключается.

Примеры:

Недопустимый запрос (Мессажеакк):

```yaml
PUBACK
    Reason_Code: 131
    status: 0100
    reason: Unknown property `test`
```

Не санкционировано (Мессажеакк):

```yaml
PUBACK
    Reason_Code: 135
    status: 0101
```

Не санкционировано (Рекреп):

```yaml
PUBLISH
    QoS: 0
    Topic: $iothub/responses
    Correlation_Data: ...
    status: 0101
```

При необходимости центр Интернета вещей устанавливает следующие свойства пользователя:

- `status` — Расширенный код центра Интернета вещей для состояния операции. Этот код можно использовать для различения результатов.
- `trace-id` — Идентификатор трассировки для операции; Центр Интернета вещей может поддерживать дополнительную диагностику для операции, которая может использоваться для внутреннего исследования.
- `reason` — удобное для восприятия сообщение, предоставляющее дополнительные сведения о том, почему операция завершилась в состоянии, указанном `status` свойством.

> [!NOTE]
> Если клиент устанавливает `Maximum Packet Size` свойство в параметре Connect Packet на очень маленькое значение, не все свойства пользователя могут уместиться и не будут отображаться в пакете.
> 
> `reason` предназначен только для пользователей и не должен использоваться в клиентской логике. Этот API позволяет изменять сообщения в любой момент без предупреждения или изменения версии.
>
> Если клиент отправляет `RequestProblemInformation: 0` в пакет Connect, свойства пользователя не будут включаться в подтверждения в соответствии со [спецификацией MQTT 5](https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901053).

#### <a name="status-code"></a>Код состояния

`status` свойство содержит код состояния для операции. Она оптимизирована для повышения эффективности чтения компьютера.
Он состоит из 2-байтового целого числа без знака в шестнадцатеричном виде в строке Like `0501` .
Структура кода (битовая схема):

```text
7 6 5 4 3 2 1 0 | 7 6 5 4 3 2 1 0
0 0 0 0 0 R T T | C C C C C C C C
```

Первый байт используется для флагов:

- биты 0 и 1 обозначают тип результатов:
  - `00` — успешное завершение
  - `01` -Ошибка клиента
  - `10` -Ошибка сервера
- бит 2: `1` указывает, что ошибка является повторяемой
- биты с 3 по 7 зарезервированы и должны иметь значение `0`

Второй байт содержит фактический отличный код ответа. Коды ошибок с разными флагами могут иметь одинаковое значение второго байта. Например, коды ошибок могут иметь `0001` `0101` `0201` `0301` разные значения.

Например, `Too Many Requests` — это клиент, повторяемая ошибка с собственным кодом `1` . Его значение — `0000 0101 0000 0001` или `0x0501` .

Клиенты могут использовать биты типа, чтобы определить, успешно ли завершилась операция. Клиенты также могут использовать повторяемый бит, чтобы решить, насколько разумны попытки повторить операцию.

## <a name="recommendations"></a>Рекомендации

### <a name="session-management"></a>Управление сеансом

`CONNACK` пакет содержит `Session Present` свойство, указывающее, восстановлен ли сервер ранее созданный сеанс. Используйте это свойство, чтобы выяснить, следует ли подписаться на разделы или пропустить подписку, так как подписка была выполнена ранее.

Для использования клиент должен следить за тем, какие `Session Present` подписки он выполняет (то есть отправляет пакет, `SUBSCRIBE` полученный `SUBACK` с успешным кодом причины), или подписываться на все разделы в одном `SUBSCRIBE` / `SUBACK` Exchange. В противном случае, если клиент отправляет два `SUBSCRIBE` пакета, и только один из них успешно обрабатывается сервером, сервер будет обмениваться данными, `Session Present: 1` `CONNACK` при этом принимаются только часть подписок клиента.

Чтобы предотвратить случай, когда более старая версия клиента не подписалась на все разделы, лучше подписываться безусловно при изменении поведения клиента (например, в составе обновления встроенного по). Кроме того, чтобы гарантировать отсутствие устаревших подписок (от максимального допустимого числа подписок), следует явно отменить подписку на подписки, которые больше не используются.

### <a name="batching"></a>Пакетная обработка

Нет специального формата для отправки пакета сообщений. Чтобы сократить издержки на ресурсоемкие операции в TLS и сети, пакеты пакетов ( `PUBLISH` , `PUBACK` , `SUBSCRIBE` и т. д.), прежде чем передать их в базовый стек TLS/TCP. Кроме того, клиент может упростить создание псевдонима раздела в "пакете":

- Укажите полное имя раздела в первом `PUBLISH` пакете для подключения и свяжите с ним псевдоним раздела.
- Добавьте следующие пакеты для одного раздела с пустым свойством "имя раздела" и "псевдоним раздела".

## <a name="migration"></a>Миграция

В этом разделе перечислены изменения в API по сравнению с [предыдущим API MQTT](iot-hub-mqtt-support.md).

- Транспортный протокол — MQTT 5. Ранее MQTT 3.1.1.
- Сведения о контексте для проверки подлинности SAS содержатся в `CONNECT` пакете непосредственно вместо кодирования вместе с сигнатурой.
- Метод проверки подлинности используется для указания используемого метода проверки подлинности.
- Подпись общего доступа помещается в свойство данных проверки подлинности. Было использовано поле ранее использованного пароля.
- Темы для операций различаются:
  - Данные телеметрии: `$iothub/telemetry` вместо `devices/{Client Id}/messages/events` ,
  - Команды: `$iothub/commands` вместо `devices/{Client Id}/messages/devicebound` ,
  - Двойника исправлений: `$iothub/twin/patch/reported` вместо `$iothub/twin/PATCH/properties/reported` ,
  - Уведомлять двойника требуемое состояние изменено: `$iothub/twin/patch/desired` вместо `$iothub/twin/PATCH/properties/desired` .
- Подписку на клиент-сервер — операции запроса и ответа не требуется.
- Свойства пользователя используются вместо свойств кодировки в сегменте имени раздела.
- имена свойств записываются в соглашении об именовании "штрих-Case" вместо сокращений с использованием специального префикса. Для определяемых пользователем свойств теперь требуется префикс. Например, `$.mid` теперь имеет `message-id` `myProperty1` вид `@myProperty1` .
- Свойство данных корреляции используется для корреляции запросов и ответных сообщений для операций "запрос-ответ" вместо `$rid` свойств, закодированных в разделе.
- `iothub-connection-auth-method` свойство больше не отмечается для событий телеметрии.
- Команды C2D не удаляются при отсутствии подписки с устройства. Они останутся в очереди до тех пор, пока устройство не подпишется или не истечет срок их действия.

## <a name="examples"></a>Примеры

### <a name="send-telemetry"></a>Отправка данных телеметрии

Сообщение:

```yaml
-> PUBLISH
    QoS: 1
    Packet_Id: 31
    Topic: $iothub/telemetry
    @myProperty1: My String Value # optional
    creation-time: 1600987195320 # optional
    @ No_Rules-ForUser-PROPERTIES: Any UTF-8 string value # optional
    Payload: <data>
```

Подтверждение.

```yaml
<- PUBACK
    Packet_Id: 31
    Reason_Code: 0
```

Альтернативное подтверждение (регулируется):

```yaml
<- PUBACK
    Packet_Id: 31
    Reason_Code: 151
    status: 0501
```

---

### <a name="send-get-twins-state"></a>Отправить состояние получения двойника

Запрос:

```yaml
-> PUBLISH
    QoS: 0
    Topic: $iothub/twin/get
    Correlation_Data: 0x01 0xFA
    Payload: <empty>
```

Ответ (успешное завершение):

```yaml
<- PUBLISH
    QoS: 0
    Topic: $iothub/responses
    Correlation_Data: 0x01 0xFA
    Payload: <twin/desired state>
```

Ответ (не разрешено):

```yaml
<- PUBLISH
    QoS: 0
    Topic: $iothub/responses
    Correlation_Data: 0x01 0xFA
    status: 0102
    reason: Operation not allowed for `B2` SKU
    Payload: <empty>
```

---

### <a name="handle-direct-method-call"></a>Обрабатывает вызов прямого метода

Запрос:

```yaml
<- PUBLISH
    QoS: 0
    Topic: $iothub/methods/abc
    Correlation_Data: 0x0A 0x10
    Payload: <data>
```

Ответ (успешное завершение):

```yaml
-> PUBLISH
    QoS: 0
    Topic: $iothub/responses
    Correlation_Data: 0x0A 0x10
    response-code: 200 # user defined response code
    Payload: <data>
```

> [!NOTE]
> `status` не задано — это ответ на Успешный запрос.

Отклик устройства недоступен:

```yaml
-> PUBLISH
    QoS: 0
    Topic: $iothub/responses
    Correlation_Data: 0x0A 0x10
    status: 0603
```

---

### <a name="error-while-using-qos-0-part-1"></a>Ошибка при использовании качества обслуживания 0, часть 1

Запрос:

```yaml
-> PUBLISH
    QoS: 0
    Topic: $iothub/twin/gett # misspelled topic name - server won't recognize it as Request-Response interaction
    Correlation_Data: 0x0A 0x10
    Payload: <data>
```

Ответ:

```yaml
<- DISCONNECT
    Reason_Code: 144
    reason: "Unsupported topic: `$iothub/twin/gett`"
```

---

### <a name="error-while-using-qos-0-part-2"></a>Ошибка при использовании качества обслуживания 0, часть 2

Запрос:

```yaml
-> PUBLISH # missing Correlation Data
    QoS: 0
    Topic: $iothub/twin/get
    Payload: <data>
```

Ответ:

```yaml
<- DISCONNECT
    Reason_Code: 131
    status: 0100
    reason: "`Correlation Data` property is missing"
```
## <a name="next-steps"></a>Дальнейшие действия

- Справочник по API MQTT 5 Preview см. в статье Справочник по API для [плоскости данных центра Интернета вещей MQTT 5](iot-hub-mqtt-5-reference.md).
- Чтобы перейти к примеру на C#, см. [Пример репозитория GitHub](https://github.com/Azure-Samples/iot-hub-mqtt-5-preview-samples-csharp).