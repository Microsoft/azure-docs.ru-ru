---
title: Сведения о маршрутизации сообщений Центра Интернета вещей Azure | Документация Майкрософт
description: Руководство разработчика по использованию маршрутизации сообщений для отправки с устройства в облако. Эта статья содержит сведения об отправке данных телеметрии и других данных.
author: ash2017
manager: briz
ms.service: iot-hub
services: iot-hub
ms.topic: conceptual
ms.date: 05/15/2019
ms.author: asrastog
ms.custom:
- 'Role: Cloud Development'
- devx-track-csharp
ms.openlocfilehash: 07bbd50dbc415b86aa0c511d46ead9f0612df107
ms.sourcegitcommit: c8b50a8aa8d9596ee3d4f3905bde94c984fc8aa2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2021
ms.locfileid: "105642502"
---
# <a name="use-iot-hub-message-routing-to-send-device-to-cloud-messages-to-different-endpoints"></a>Использование маршрутизации сообщений в Центре Интернета вещей для отправки с устройства в облако в разные конечные точки

[!INCLUDE [iot-hub-basic](../../includes/iot-hub-basic-partial.md)]

Маршрутизация сообщений позволяет отправлять сообщения с устройств в облачные службы автоматическим, масштабируемым и надежным способом. Маршрутизацию сообщений можно использовать в следующих случаях. 

* **Отправка сообщений телеметрии устройства** , а также событий, событий жизненного цикла устройства, событий изменения двойникаов устройств и событий изменения цифровых двойника в встроенную конечную точку и пользовательские конечные точки. Сведения о [конечных точках маршрутизации](#routing-endpoints). Дополнительные сведения о событиях, отправленных с устройств IoT самонастраивающийся, см. в разделе Общие сведения об [iot Самонастраивающийся Digital двойников](../iot-pnp/concepts-digital-twin.md).

* **Фильтрация данных перед их отправкой по различным конечным точкам** путем применения полнофункциональных запросов. Маршрутизация сообщений позволяет запрашивать свойства сообщения, текст сообщения, теги и свойства двойников устройств. Дополнительные сведения об использовании [запросов в маршрутизации сообщений](iot-hub-devguide-routing-query-syntax.md).

Для маршрутизации сообщений Центру Интернета вещей требуется доступ на запись к этим конечным точкам служб. При настройке конечных точек через портал Azure необходимые разрешения добавляются автоматически. Настройте в службах поддержку ожидаемой пропускной способности. Например, если в качестве пользовательской конечной точки используются концентраторы событий, необходимо настроить **единицы пропускной способности** для этого концентратора событий, чтобы он мог управлять входящими событиями, которые планируется отправить через маршрутизацию сообщений центра Интернета вещей. Аналогично, при использовании очереди служебной шины в качестве конечной точки необходимо настроить **максимальный размер** , чтобы очередь могла вместить все входящий данных, пока она не будет егресседа потребителями. При первой настройке решения Интернета вещей может потребоваться отслеживать дополнительные конечные точки, а затем вносить необходимые изменения с учетом реальной нагрузки.

Центр Интернета вещей задает [общий формат](iot-hub-devguide-messages-construct.md) для всех случаев обмена сообщениями с устройства в облако для взаимодействия по различным протоколам. Если сообщение соответствует нескольким маршрутам, которые указывают на одну и ту же конечную точку, то Центр Интернета вещей доставляет сообщение в эту конечную точку только один раз. Таким образом, не требуется настраивать дедупликацию для очереди или раздела служебной шины. В секционированных очередях сопоставление секций гарантирует упорядочивание сообщений. В этом руководстве вы научитесь [настраивать маршрутизацию сообщений](tutorial-routing.md).

## <a name="routing-endpoints"></a>Конечные точки маршрутизации

В Центре Интернета вещей имеется встроенная конечная точка по умолчанию (**messages/events**), совместимая с Центрами событий. Вы можете создать [пользовательские конечные точки](iot-hub-devguide-endpoints.md#custom-endpoints) для маршрутизации сообщений, связав с Центром Интернета вещей другие службы в подписке. 

Каждое сообщение направляется всем конечным точкам, которым соответствуют запросы маршрутизации. Иными словами, сообщение может маршрутизироваться к нескольким конечным точкам.

Если в пользовательской конечной точке есть конфигурации брандмауэра, рассмотрите возможность использования исключения доверенной первой стороны Майкрософт, чтобы предоставить центру Интернета вещей доступ к определенной конечной точке — [службе хранилища Azure](./virtual-network-support.md#egress-connectivity-to-storage-account-endpoints-for-routing), [концентраторам событий Azure](./virtual-network-support.md#egress-connectivity-to-event-hubs-endpoints-for-routing) и [служебной шине Azure](./virtual-network-support.md#egress-connectivity-to-service-bus-endpoints-for-routing). Это можно найти в выбранных регионах для центров Интернета вещей с [управляемым удостоверением службы](./virtual-network-support.md).

В настоящее время центр Интернета вещей поддерживает следующие конечные точки:

 - Встроенная конечная точка
 - Хранилище Azure
 - Очереди и разделы служебной шины
 - Центры событий

## <a name="built-in-endpoint-as-a-routing-endpoint"></a>Встроенная конечная точка в качестве конечной точки маршрутизации

Вы можете использовать стандартную [интеграцию Центров событий и пакеты SDK](iot-hub-devguide-messages-read-builtin.md), чтобы отправлять сообщения с устройства в облако из встроенной конечной точки (**messages/events**). После создания маршрута данные перестают передаваться во встроенную конечную точку, если только маршрут не создан для этой конечной точки.

## <a name="azure-storage-as-a-routing-endpoint"></a>Служба хранилища Azure в качестве конечной точки маршрутизации

Существует два центра Интернета вещей служб хранилища, которые могут маршрутизировать сообщения в [хранилище BLOB-объектов Azure](../storage/blobs/storage-blobs-introduction.md) и учетные записи [Azure Data Lake Storage 2-го поколения](../storage/blobs/data-lake-storage-introduction.md) (ADLS 2-го поколения). Учетные записи Azure Data Lake Storage являются иерархическими учетными записями хранения с поддержкой [пространств имен](../storage/blobs/data-lake-storage-namespace.md), созданными на основе хранилища BLOB-объектов. Оба они используют большие двоичные объекты для хранения.

Центр Интернета вещей поддерживает запись данных в службу хранилища Azure в формате [Apache Avro](https://avro.apache.org/) , а также в формате JSON. По умолчанию используется AVRO. При использовании кодировки JSON необходимо задать для contentType значение **Application/JSON** , а ContentEncoding **— UTF-8** в [свойствах системы](iot-hub-devguide-routing-query-syntax.md#system-properties)сообщений. Оба этих значения не учитывают регистр. Если кодировка содержимого не задана, центр Интернета вещей будет записывать сообщения в формате Base 64.

Формат кодирования можно задать только при настройке конечной точки хранилища BLOB-объектов. его нельзя изменить для существующей конечной точки. Чтобы переключить форматы кодирования для существующей конечной точки, необходимо удалить и повторно создать настраиваемую конечную точку с нужным форматом. Одной из полезных стратегий может быть создание новой пользовательской конечной точки с требуемым форматом кодирования и Добавление параллельного маршрута к этой конечной точке. Таким образом можно проверить данные перед удалением существующей конечной точки.

Формат кодирования можно выбрать с помощью REST API создания или обновления центра Интернета вещей, в частности [раутингсторажеконтаинерпропертиес](/rest/api/iothub/iothubresource/createorupdate#routingstoragecontainerproperties), портал Azure, [Azure CLI](/cli/azure/iot/hub/routing-endpoint)или [Azure PowerShell](/powershell/module/az.iothub/add-aziothubroutingendpoint). На следующем рисунке показано, как выбрать формат кодировки в портал Azure.

![Кодирование конечной точки хранилища BLOB-объектов](./media/iot-hub-devguide-messages-d2c/blobencoding.png)

Центр Интернета вещей пакетно передает сообщения и записывает данные в хранилище каждый раз, когда пакет достигнет определенного размера или прошло определенное время. По умолчанию Центр Интернета вещей использует следующее соглашение об именовании файлов:

```
{iothub}/{partition}/{YYYY}/{MM}/{DD}/{HH}/{mm}
```

Вы можете применять любое соглашение об именовании файлов, однако необходимо использовать все перечисленные токены. Центр Интернета вещей будет записывать пустой большой двоичный объект, если нет данных для записи.

Рекомендуется перечислить большие двоичные объекты или файлы, а затем перепроходить их, чтобы гарантировать чтение всех больших двоичных объектов или файлов без принятия каких-либо предположений раздела. Диапазон секций может измениться в процессе [инициированной корпорацией Майкрософт отработки отказа](iot-hub-ha-dr.md#microsoft-initiated-failover) или при [переходе на другой ресурс вручную](iot-hub-ha-dr.md#manual-failover) с помощью Центра Интернета вещей. Вы можете использовать [API List blobs](/rest/api/storageservices/list-blobs) для перечисления списка больших двоичных объектов или [ADLS 2-го поколения API списка](/rest/api/storageservices/datalakestoragegen2/path) файлов. Ознакомьтесь со следующим примером в качестве руководства.

```csharp
public void ListBlobsInContainer(string containerName, string iothub)
{
    var storageAccount = CloudStorageAccount.Parse(this.blobConnectionString);
    var cloudBlobContainer = storageAccount.CreateCloudBlobClient().GetContainerReference(containerName);
    if (cloudBlobContainer.Exists())
    {
        var results = cloudBlobContainer.ListBlobs(prefix: $"{iothub}/");
        foreach (IListBlobItem item in results)
        {
            Console.WriteLine(item.Uri);
        }
    }
}
```

Чтобы создать учетную запись хранения Azure Data Lake, совместимую с Gen2, создайте новую учетную запись хранения v2 и выберите параметр *включена* в поле *Иерархическое пространство имен* на вкладке **Дополнительно** , как показано на следующем рисунке.

![Выберите хранилище Azure Date Lake Gen2](./media/iot-hub-devguide-messages-d2c/selectadls2storage.png)

## <a name="service-bus-queues-and-service-bus-topics-as-a-routing-endpoint"></a>Очереди служебной шины и разделы служебной шины в качестве конечной точки маршрутизации

Для очередей и разделов служебной шины, которые используются как конечные точки Центра Интернета вещей, **сеансы** или **поиск повторяющихся данных** должны быть выключены. Если одна из этих возможностей включена, на портале Azure конечная точка будет отображаться как **недоступная**.

## <a name="event-hubs-as-a-routing-endpoint"></a>Концентраторы событий в качестве конечной точки маршрутизации

Помимо конечной точки, совместимой со встроенными Центрами событий, вы также можете направлять данные в пользовательские конечные точки типа Центров событий. 

## <a name="reading-data-that-has-been-routed"></a>Чтение маршрутизированных данных

Вы можете настроить маршрут, следуя инструкциям в [этом руководстве](tutorial-routing.md).

В следующих руководствах вы узнаете, как читать сообщения из конечной точки.

* Считывание данных из [встроенной конечной точки](quickstart-send-telemetry-node.md).

* Считывание данных из [хранилища BLOB-объектов](../storage/blobs/storage-blob-event-quickstart.md).

* Чтение из [концентраторов событий](../event-hubs/event-hubs-dotnet-standard-getstarted-send.md)

* Чтение из [очередей служебной шины](../service-bus-messaging/service-bus-dotnet-get-started-with-queues.md)

* Считывание данных из [разделов служебной шины](../service-bus-messaging/service-bus-dotnet-how-to-use-topics-subscriptions.md).


## <a name="fallback-route"></a>Резервный маршрут

Резервный маршрут позволяет отправить все сообщения, которые не соответствуют условиям запроса на любом из имеющихся маршрутов, ко встроенным Центрам событий (**/messages/events**), совместимым со службой [Центры событий](../event-hubs/index.yml). Если маршрутизация сообщений включена, вы можете включить возможность резервного маршрута. После создания маршрута данные перестают передаваться во встроенную конечную точку, если только маршрут не создан для этой конечной точки. Если маршруты ко встроенной конечной точке отсутствуют и резервный маршрут включен, на встроенную конечную точку будут отправляться только те сообщения, которые не соответствуют каким-либо условиям запроса для маршрутов. Кроме того, если удалить имеющиеся маршруты, необходимо включить резервный маршрут, чтобы все данные поступали на встроенную конечную точку.

Вы можете включить или отключить резервный маршрут в колонке "портал Azure->маршрутизация сообщений". Вы также можете использовать Azure Resource Manager, чтобы свойства [FallbackRouteProperties](/rest/api/iothub/iothubresource/createorupdate#fallbackrouteproperties) использовали пользовательскую конечную точку для резервного маршрута.

## <a name="non-telemetry-events"></a>События без использования телеметрии

Кроме телеметрии устройств, маршрутизация сообщений также позволяет отправлять события изменения двойникаа устройства, события жизненного цикла устройства и события изменения цифровых двойника. Например, при создании маршрута с источником данных со значением **события изменения двойников устройства** Центр Интернета вещей отправляет сообщения на конечную точку, содержащую изменения двойника устройства. Аналогично, если маршрут создается с источником данных **событиями жизненного цикла устройства**, центр Интернета вещей отправляет сообщение, указывающее, было ли устройство удалено или создано. Наконец, в рамках [Самонастраивающийся Интернета вещей Azure](../iot-pnp/overview-iot-plug-and-play.md)разработчик может создавать маршруты с источниками данных для **событий изменения цифровых двойника** , а центр Интернета вещей отправляет сообщения при установке или изменении свойства Digital двойника, при замене цифрового двойника или при наступлении события изменения базового устройства двойника.

[Центр Интернета вещей также интегрируется со службой "Сетка событий Azure](iot-hub-event-grid.md) " для публикации событий устройств для поддержки интеграции и автоматизации рабочих процессов в режиме реального времени на основе этих событий. Ознакомьтесь с основными различиями [между маршрутизацией сообщений и Сеткой событий](iot-hub-event-grid-routing-comparison.md), чтобы узнать, какой вариант подходит вам больше.

## <a name="testing-routes"></a>Тестирование маршрутов

При создании маршрута или изменении имеющегося маршрута необходимо проверить запрос маршрута, отправив пример сообщения. Вы можете протестировать отдельные маршруты или проверить все маршруты за один раз и не отправлять сообщения на конечные точки во время теста. Для тестирования можно использовать портал Azure, Azure Resource Manager, Azure PowerShell и Azure CLI. Результаты помогают определить, соответствует ли образец сообщения запросу, сообщение не совпало с запросом, или тест не удалось выполнить, так как образец сообщения или синтаксис запроса неверны. Дополнительные сведения см. в статьях о [проверке маршрута](/rest/api/iothub/iothubresource/testroute) и [проверке всех маршрутов](/rest/api/iothub/iothubresource/testallroutes).

## <a name="ordering-guarantees-with-at-least-once-delivery"></a>Упорядочение гарантирует по крайней мере одну доставку

Маршрутизация сообщений центра Интернета вещей гарантирует упорядоченность и хотя бы одну доставку сообщений конечным точкам. Это означает, что могут существовать дублирующиеся сообщения, а последовательность сообщений может быть повторно передаваться с учетом исходного порядка сообщений. Например, если исходный порядок сообщений — [1, 2, 3, 4], можно получить последовательность сообщений, например [1, 2, 1, 2, 3, 1, 2, 3, 4]. Гарантийная Сортировка заключается в том, что если вы получаете сообщение [1], за ним всегда будет следовать [2, 3, 4].

Для обработки дубликатов сообщений рекомендуется пометить уникальный идентификатор в свойствах приложения сообщения в точке происхождения, которая обычно является устройством или модулем. Служба, использующая сообщения, может управлять повторяющимися сообщениями с помощью этого идентификатора.

## <a name="latency"></a>Задержка

При маршрутизации сообщений телеметрии, передаваемой с устройства в облако с помощью встроенных конечных точек наблюдается небольшое увеличение общей задержки после создания первого маршрута.

В большинстве случаев среднее увеличение задержки составляет менее 500 мс. Вы можете отслеживать задержки с помощью метрики Центра Интернета вещей **Routing: message latency for messages/events** (Маршрутизация: задержка сообщений для messages/events) или **d2c.endpoints.latency.builtIn.events**. Последующее создание или удаление любого маршрута не влияет на общую задержку.

## <a name="monitoring-and-troubleshooting"></a>Мониторинг и устранение неполадок

Центр Интернета вещей предоставляет несколько метрик, связанных с маршрутизацией и конечными точками, которые позволяют получить представление о работоспособности центра и отправленных сообщений. Список всех метрик центра Интернета вещей, разбитых функциональной категорией, см. в разделе [метрики в справочнике по данным мониторинга](monitor-iot-hub-reference.md#metrics). Вы можете отвести наблюдение за ошибками, возникающими при оценке запроса маршрутизации и работоспособности конечной точки, как показано в центре Интернета вещей, с помощью категории " [ **маршруты** " в журналах ресурсов центра Интернета вещей](monitor-iot-hub-reference.md#routes). Дополнительные сведения об использовании метрик и журналов ресурсов в центре Интернета вещей см. в статье [мониторинг центра Интернета вещей](monitor-iot-hub.md).

Для получения [состояния работоспособности](iot-hub-devguide-endpoints.md#custom-endpoints) конечных точек можно использовать REST API [получить работоспособность конечной точки](/rest/api/iothub/iothubresource/getendpointhealth#iothubresource_getendpointhealth) .

Используйте [руководство по устранению неполадок для маршрутизации](troubleshoot-message-routing.md) для получения дополнительных сведений и поддержки по устранению неполадок маршрутизации.

## <a name="next-steps"></a>Дальнейшие шаги

* Дополнительные сведения о создании маршрутов сообщений см. в статье [Руководство. Настройка маршрутизации сообщений с Центром Интернета вещей](tutorial-routing.md).

* [Краткое руководство. Отправка данных телеметрии с устройства в Центр Интернета вещей и чтение данных телеметрии из центра с помощью внутреннего приложения (Node.js)](quickstart-send-telemetry-node.md)

* Дополнительные сведения о пакетах SDK, которые можно использовать для отправки сообщений с устройства в облако, см. в статье, посвященной [пакетам SDK для Azure IoT](iot-hub-devguide-sdks.md).
