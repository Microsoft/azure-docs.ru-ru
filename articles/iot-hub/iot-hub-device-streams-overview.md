---
title: Потоки устройств центра Интернета вещей Azure | Документация Майкрософт
description: Обзор потоков устройств центра Интернета вещей Azure, которые упрощают безопасные двунаправленные туннели TCP для различных сценариев взаимодействия между облаком и устройством.
author: robinsh
services: iot-hub
ms.service: iot-hub
ms.topic: conceptual
ms.date: 01/15/2019
ms.author: robinsh
ms.custom:
- 'Role: Cloud Development'
- 'Role: IoT Device'
- 'Role: Technical Support'
ms.openlocfilehash: 9487fc562fa099d2650aabc8d15fc1449c7fcb5c
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "97825178"
---
# <a name="iot-hub-device-streams-preview"></a>Потоки устройств Центра Интернета вещей (предварительная версия)

*Потоки устройств* Центра Интернета вещей Azure облегчают создание защищенных двусторонних туннелей TCP для различных сценариев взаимодействия между устройством и облаком. Поток устройства проходит через *конечную точку потоковой передачи* Центра Интернета вещей, которая действует в качестве прокси-сервера между вашим устройством и конечными точками службы. Эта конфигурация (показана на схеме ниже) особенно полезна, когда устройства находятся за сетевым брандмауэром или в частной сети. Таким образом, потоки устройств Центра Интернета вещей позволяют клиентам связываться с устройствами Центра Интернета вещей при использовании брандмауэра без необходимости открывать набор портов сетевого брандмауэра для входящего или исходящего трафика.

!["Общие сведения о потоках устройств центра Интернета вещей"](./media/iot-hub-device-streams-overview/iot-hub-device-streams-overview.png )

При использовании потоков устройств Центра Интернета вещей устройства остаются защищенными и на них всего лишь нужно открыть исходящие подключения TCP к конечной точке потоковой передачи Центра Интернета вещей через порт 443. После установки потоковой передачи приложения на стороне службы и устройства получат программный доступ к объекту клиента WebSocket для обмена необработанными байтами. Гарантии надежности и упорядоченности, предоставляемые этим туннелем, точно такие же, как и у протокола TCP.

## <a name="benefits"></a>Преимущества

Потоки устройств Центра Интернета вещей предоставляют следующие преимущества:

* **Безопасное подключение с брандмауэром:** Доступ к устройствам IoT можно получить из конечных точек службы, не открывая порт входящего трафика брандмауэра на устройстве или периметре сети (для порта 443 требуется только исходящее подключение к центру Интернета вещей).

* **Проверка подлинности:** Как на устройстве, так и на стороне службы туннеля необходимо пройти проверку подлинности в центре Интернета вещей, используя соответствующие учетные данные.

* **Шифрование:** По умолчанию в потоках устройств центра Интернета вещей используются подключения с поддержкой TLS. Это гарантирует, что трафик всегда шифруется, независимо от того, использует ли приложение шифрование.

* **Простота подключения:** Во многих случаях использование потоков устройств устраняет необходимость в сложной настройке виртуальных частных сетей для обеспечения возможности подключения к устройствам IoT.

* **Совместимость с стеком TCP/IP:** Потоки устройств центра Интернета вещей могут поддерживать трафик приложений TCP/IP. Это означает, что эту функцию может использовать широкий диапазон запатентованных протоколов, а также протоколов, основанных на стандартах.

* **Простота использования в настройках частных сетей:** Служба может взаимодействовать с устройством, ссылаясь на идентификатор устройства, а не на IP-адрес устройства. Это полезно в ситуациях, когда устройство находится в частной сети и имеет частный IP-адрес или когда IP-адрес назначается динамически и неизвестен на стороне службы.

## <a name="device-stream-workflows"></a>Рабочие процессы потока устройства

Потоковая передача данных устройства инициируется в том случае, когда служба запрашивает подключение к устройству с указанием его идентификатора. Этот рабочий процесс особенно подходит для модели взаимодействия "клиент — сервер", в том числе с задействованием протоколов SSH и RDP, когда пользователь хочет удаленно подключиться к серверу SSH и RDP, выполняемому на устройстве, с помощью клиентской программы SSH и RDP.

Процесс создания потока устройства включает согласование между устройством, службой, основной конечной точкой и конечной точкой потоковой передачи Центра Интернета вещей. Хотя основная конечная точка Центра Интернета вещей организует создание потока устройства, конечная точка потоковой передачи обрабатывает трафик, который проходит между службой и устройством.

### <a name="device-stream-creation-flow"></a>Процесс создания потока устройства

Программное создание потока устройства с помощью пакета SDK состоит из приведенных ниже шагов, которые также показаны на рисунке ниже:

!["Процесс подтверждения потока устройства"](./media/iot-hub-device-streams-overview/iot-hub-device-streams-handshake.png)

1. Приложение устройства заранее регистрирует обратный вызов, чтобы получить уведомление при инициации подключения нового потока к устройству. Этот шаг обычно происходит, когда устройство загружается и подключается к Центру Интернета вещей.

2. Программа на стороне службы инициирует подключение потока устройства, когда это необходимо, предоставляя идентификатор устройства (_не_ IP-адрес).

3. Центр Интернета вещей уведомляет программу на стороне устройства, вызывая обратный вызов, зарегистрированный на шаге 1. Устройство может принять или отклонить запрос на инициацию потоковой передачи. Эта логика может отличаться в зависимости от конкретного сценария приложения. Если устройство отклоняет этот запрос потоковой передачи, Центр Интернета вещей уведомляет службу. В противном случае выполняются следующие действия.

4. Устройство создает защищенное исходящее подключение TCP к конечной точке потоковой передачи через порт 443 и преобразует его в подключение WebSocket. URL-адрес конечной точки потоковой передачи, а также учетные данные, используемые для аутентификации, предоставляются устройству с помощью Центра Интернета вещей как часть запроса, отправленного на шаге 3.

5. Служба уведомляется о результатах принятия потока устройством и устанавливает собственное подключение клиента WebSocket к конечной точке потоковой передачи. Аналогичным образом она получает URL-адрес конечной точки потоковой передачи и информацию об аутентификации из Центра Интернета вещей.

Во время описанного выше процесса подтверждения:

* Процесс подтверждения необходимо выполнить в течение 60 секунд (шаг 2–5), в противном случае подтверждение завершится ошибкой из-за истечения времени ожидания, а служба получит соответствующее уведомление.

* Когда поток будет создан, конечная точка потоковой передачи будет действовать в качестве прокси-сервера и будет передавать трафик между службой и устройством через соответствующие WebSocket-подключения.

* Устройству, как и службе, требуется исходящее подключение к основной конечной точке Центра Интернета вещей, а также к конечной точке потоковой передачи через порт 443. URL-адреса этих конечных точек доступны на вкладке *Обзор* на портале Центра Интернета вещей.

* Гарантии надежности и упорядоченности установленного потока точно такие же, как и предоставляемые TCP.

* Все подключения к Центру Интернета вещей и конечной точке потоковой передачи используют TLS и шифруются.

### <a name="termination-flow"></a>Завершение потока

Установленный поток завершается, когда любое из подключений по протоколу TCP к шлюзу отключается (службой или устройством). Это может произойти добровольно, если закрыть подключение WebSocket в программе устройства или службы, или недобровольно в случае истечения времени ожидания или сбоя процесса. После закрытия подключения устройства или службы к конечной точке потоковой передачи другое подключение TCP также будет принудительно разорвано. И служба, и устройство отвечают за повторное создание потока, если это необходимо.

## <a name="connectivity-requirements"></a>Требования к подключению

Как сторона устройства, так и сторона службы потока устройства должны иметь возможность устанавливать TLS-подключения к Центру Интернета вещей и его конечной точке потоковой передачи. Для этого требуется исходящее подключение к этим конечным точкам через порт 443. Имя узла, связанное с этими конечными точками, можно найти на вкладке *Обзор* Центра Интернета вещей, как показано на рисунке ниже:

!["Конечные точки потока устройства"](./media/iot-hub-device-streams-overview/device-stream-in-portal.png)

Кроме того, сведения о конечных точках можно получить с помощью Azure CLI в разделе свойств концентратора, в частности, `property.hostname` и `property.deviceStreams` ключи.

```azurecli-interactive
az iot hub devicestream show --name <YourIoTHubName>
```

Результат представляет собой объект JSON всех конечных точек, к которым службе и устройству центра необходимо подключаться для установки потока устройства.

```json
{
  "streamingEndpoints": [
    "https://<YourIoTHubName>.<region-stamp>.streams.azure-devices.net"
  ]
}
```

> [!NOTE]
> Убедитесь, что вы установили Azure CLI 2.0.57 или новее. Последнюю версию можно скачать на странице [установка Azure CLI](/cli/azure/install-azure-cli) .
>

## <a name="allow-outbound-connectivity-to-the-device-streaming-endpoints"></a>Разрешить исходящие подключения к конечным точкам потоковой передачи устройства

Как упоминалось в начале этой статьи, устройство создает исходящее подключение к конечной точке потоковой передачи центра Интернета вещей во время процесса запуска потоков устройств. Ваши брандмауэры устройства или сети должны разрешать исходящие подключения к шлюзу потоковой передачи через порт 443 (обратите внимание, что обмен данными осуществляется через подключение WebSocket, зашифрованное с помощью протокола TLS).

Имя узла конечной точки потоковой передачи устройства можно найти на портале Центра Интернета вещей Azure на вкладке Обзор ![ . Конечные точки потока устройства "](./media/iot-hub-device-streams-overview/device-stream-in-portal.png)

Кроме того, эти сведения можно найти с помощью Azure CLI:

```azurecli-interactive
az iot hub devicestream show --name <YourIoTHubName>
```

> [!NOTE]
> Убедитесь, что вы установили Azure CLI 2.0.57 или новее. Последнюю версию можно скачать на странице [установка Azure CLI](/cli/azure/install-azure-cli) .
>

## <a name="troubleshoot-via-device-streams-resource-logs"></a>Устранение неполадок с помощью журналов ресурсов для потоков устройств

Вы можете настроить Azure Monitor, чтобы получать [журналы ресурсов для потоков устройств](monitor-iot-hub-reference.md#device-streams-preview) , созданных центром Интернета вещей. Это может быть очень полезно в сценариях устранения неполадок.

Выполните следующие действия, чтобы создать параметр диагностики для отправки журналов потоков устройств для центра Интернета вещей в журналы Azure Monitor:

1. В портал Azure перейдите в центр Интернета вещей. В области слева в разделе **мониторинг** выберите **параметры диагностики**. Щелкните команду **Добавить параметр диагностики**.

2. Укажите имя для параметра диагностики и выберите **девицестреамс** в списке журналов. Затем выберите **отправить log Analytics**. Вы сможете выбрать существующую рабочую область Log Analytics или создать новую.

    :::image type="content" source="media/iot-hub-device-streams-overview/device-streams-configure-diagnostics.png" alt-text="Включение журналов потоков устройств":::

3. После создания параметра диагностики для отправки журналов потоков устройства в рабочую область Log Analytics можно получить доступ к журналам, выбрав **журналы** в разделе **мониторинг** в левой области центра Интернета вещей в портал Azure. Журналы потоков устройств будут отображаться в `AzureDiagnostics` таблице и иметь значение `Category=DeviceStreams` . Имейте в виду, что после выполнения операции записи журналов в таблице может потребоваться несколько минут.

   Как показано ниже, идентификатор целевого устройства и результат операции также доступны в журналах.

   !["Доступ к журналам потоковой передачи устройства"](./media/iot-hub-device-streams-overview/device-streams-view-logs.png)

Дополнительные сведения об использовании Azure Monitor с центром Интернета вещей см. в статье [мониторинг центра Интернета вещей](monitor-iot-hub.md). Сведения о всех журналах ресурсов, метриках и таблицах, доступных для центра Интернета вещей, см. в статье [мониторинг справочника по данным центра Интернета вещей Azure](monitor-iot-hub-reference.md).

## <a name="regional-availability"></a>Доступность в регионах

Во время общедоступной предварительной версии потоки устройств центра Интернета вещей доступны в центральной части США, центральной части США (EUAP), Северной Европе и Юго-Восточной Азии. Убедитесь, что центр создан в одном из этих регионов.

## <a name="sdk-availability"></a>Доступность пакета SDK

Обе стороны каждого потока (на стороне устройства и службы) создают туннель, используя пакет SDK для Центра Интернета вещей. На этапе общедоступной предварительной версии клиенты могут выбрать пакет SDK для следующих языков:

* пакеты SDK для C и C# поддерживают потоки устройств на стороне устройства;

* пакеты SDK для NodeJS и C## поддерживают потоки устройств на стороне службы.

## <a name="iot-hub-device-stream-samples"></a>Примеры потоков устройств центра Интернета вещей

На странице центра Интернета вещей доступны два [примера](./index.yml) быстрого запуска. Они демонстрируют использование потоков устройств приложениями.

* В образце *echo* показано программное использование потоков устройств (путем непосредственного вызова API пакета SDK).

* В примере с *локальным прокси-сервером* демонстрируется туннелирование трафика готовых клиентских и серверных приложений (например, SSH, RDP или веб) через потоки устройств.

Эти примеры более подробно описаны ниже.

### <a name="echo-sample"></a>Пример эхо

В примере echo показано программное использование потоков устройства для отправки и получения байтов между службой и приложением устройства. Обратите внимание, что программы обслуживания и устройств можно использовать на разных языках. Например, программу для устройства C можно использовать со служебной программой C#.

Ниже приведены примеры эха:

* [Служба и служебная программа C#](quickstart-device-streams-echo-csharp.md)

* [ Служебная программаNode.js](quickstart-device-streams-echo-nodejs.md)

* [Программа для устройства C](quickstart-device-streams-echo-c.md)

### <a name="local-proxy-sample-for-ssh-or-rdp"></a>Пример локального прокси-сервера (для SSH или RDP)

В примере с локальным прокси-сервером демонстрируется способ включить туннелирование существующего трафика приложения, к которому относится обмен данными между клиентом и программой сервера. Эта настройка работает для протоколов клиента и сервера, таких как SSH и RDP, в которых сторона службы выступает в качестве клиента (выполняя программы клиента SSH или RDP), а сторона устройства — в качестве сервера (выполняя управляющую программу SSH или программы сервера RDP).

В этом разделе описывается использование потоков устройства для реализации сценариев SSH-подключения к устройству (случай с RDP или другими протоколами клиента или сервера аналогичен использованию соответствующего порта протокола).

В этой конфигурации используются две программы *локального прокси-сервера* (показаны на рисунке ниже), а именно: *локальный прокси-сервер устройства* и *локальный прокси-сервер службы*. Программы локального прокси-сервера отвечают за выполнение [подтверждения запуска потока устройства](#device-stream-creation-flow) с помощью Центра Интернета вещей и взаимодействуют с клиентом и управляющей программой SSH, используя обычные сокеты клиента и сервера.

!["Настройка прокси-сервера потока устройства для SSH/RDP"](./media/iot-hub-device-streams-overview/iot-hub-device-streams-ssh.png)

1. Пользователь выполняет локальный прокси-сервер службы для инициирования установки потока данных к устройству.

2. Локальный прокси-сервер устройства принимает запрос на инициацию потоковой передачи, а к конечной точке потоковой передачи Центра Интернета вещей устанавливается туннель (как обсуждалось выше).

3. Локальный прокси-сервер устройства подключается к конечной точке управляющей программы SSH, ожидая передачи данных к устройству через порт 22.

4. Локальный прокси-сервер службы ожидает передачи данных на указанный порт, в частности новых SSH-подключений от пользователя (в примере используется порт — 2222, но вы можете настроить любой доступный порт). Пользователь указывает клиент SSH на порте локального прокси-сервера в localhost.

### <a name="notes"></a>Примечания

* На описанных выше шагах создается сквозной туннель между клиентом SSH (справа) и управляющей программой SSH (слева). В рамках этого сквозного подключения выполняется отправка трафика в Центр Интернета вещей через поток устройства.

* Стрелки на рисунке указывают направление, в котором подключения устанавливаются между конечными точками. В частности, обратите внимание, что входящие подключения к устройству отсутствуют (часто блокируются брандмауэром).

* Использование порта 2222 в локальном прокси-сервере — произвольный выбор. Прокси-сервер можно настроить для использования любого другого доступного порта.

* Выбранный порт 22 зависит от протокола, а зависит от SSH в этом случае. В случае с RDP необходимо использовать порт 3389. Это можно настроить в предоставленных примерах программ.

Воспользуйтесь ссылками ниже, чтобы узнать, как запустить программы локального прокси-сервера на выбранном языке. Аналогично [примеру echo](#echo-sample) можно запустить программы локальных прокси-серверов службы и устройства на разных языках, так как они полностью совместимы.

* [Служба и служебная программа C#](quickstart-device-streams-proxy-csharp.md)

* [ Служебная программаNode.js](quickstart-device-streams-proxy-nodejs.md)

* [Программа для устройства C](quickstart-device-streams-proxy-c.md)

## <a name="next-steps"></a>Дальнейшие действия

Используйте приведенные ниже ссылки для получения дополнительных сведений о потоках устройств.

> [!div class="nextstepaction"]
> [Потоки устройств в IoT демонстрация (канал 9)](https://nam06.safelinks.protection.outlook.com/?url=https%3A%2F%2Fchannel9.msdn.com%2FShows%2FInternet-of-Things-Show%2FAzure-IoT-Hub-Device-Streams&data=02%7C01%7Crezas%40microsoft.com%7Cc3486254a89a43edea7c08d67a88bcea%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C636831125031268909&sdata=S6u9qiehBN4tmgII637uJeVubUll0IZ4p2ddtG5pDBc%3D&reserved=0)
