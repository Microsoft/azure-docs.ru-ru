---
title: Принципы отправки сообщений Центра Интернета вещей Azure из облака на устройство | Документы Майкрософт
description: В этом руководство для разработчиков обсуждаются способы использования обмена сообщениями между облаком и устройством с центром Интернета вещей. Он содержит сведения о жизненном цикле сообщения и параметрах конфигурации.
author: wesmc7777
manager: philmea
ms.author: wesmc
ms.service: iot-hub
services: iot-hub
ms.topic: conceptual
ms.date: 03/15/2018
ms.custom: mqtt, devx-track-azurecli
ms.openlocfilehash: 5515d1084b28091cf7d20958cfca8af3f2664563
ms.sourcegitcommit: dda0d51d3d0e34d07faf231033d744ca4f2bbf4a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/05/2021
ms.locfileid: "102199498"
---
# <a name="send-cloud-to-device-messages-from-an-iot-hub"></a>Отправка сообщений из облака на устройство из центра Интернета вещей

Чтобы отправить односторонние уведомления в приложение для устройства из серверной части решения, отправьте сообщения из облака на устройство из центра Интернета вещей на ваше устройства. Обсуждение других параметров облака на устройство, поддерживаемых центром Интернета вещей Azure, см. в [статье Руководство по обмену данными между облаком и устройством](iot-hub-devguide-c2d-guidance.md).

[!INCLUDE [iot-hub-basic](../../includes/iot-hub-basic-whole.md)]

Вы отправляете сообщения из облака на устройство через конечную точку, доступную для службы, */Messages/devicebound*. Затем устройство получает сообщения через конечную точку конкретного устройства, */Devices/{deviceId}/messages/devicebound*.

Чтобы использовать каждое сообщение из облака на устройство на одном устройстве, центр Интернета вещей устанавливает для свойства **to** значение */Devices/{deviceId}/messages/devicebound*.

Каждая очередь устройств содержит не более 50 сообщений, отправляемых из облака на устройство. Попытка отправить больше сообщений на одно и то же устройство приведет к ошибке.

## <a name="the-cloud-to-device-message-life-cycle"></a>Жизненный цикл сообщения, переданного из облака на устройство

Чтобы гарантировать доставку сообщений по крайней мере, центр Интернета вещей сохраняет сообщения, переявляющиеся из облака на устройство, в очереди для каждого устройства. Чтобы центр Интернета вещей удалил сообщения из очереди, устройства должны явно подтвердить *Завершение*. Этот способ гарантирует устойчивость к сбоям подключения и ошибкам устройств.

Граф состояния жизненного цикла отображается на следующей схеме:

![Жизненный цикл сообщения, переданного из облака на устройство](./media/iot-hub-devguide-messages-c2d/lifecycle.png)

Когда служба центра Интернета вещей отправляет сообщение на устройство, служба устанавливает состояние сообщения в *очередь*. Когда устройству требуется *получить* сообщение, центр Интернета вещей *блокирует* сообщение, установив для него состояние " *невидимый*". Это состояние позволяет другим потокам на устройстве начать получать другие сообщения. Когда поток устройства завершает обработку сообщения, он уведомляет центр Интернета вещей, *выполняя* сообщение. Затем центр Интернета вещей устанавливает состояние " *завершено*".

Устройство также может:

* *Отклоните* сообщение, которое заставляет центр Интернета вещей установить *недоставленное* состояние. Устройства, подключающиеся через протокол передачи данных телеметрии очереди сообщений (MQTT), не могут отклонять сообщения, переданные из облака на устройство.

*  Отмените сообщение, что приведет к тому, что центр Интернета вещей поместит сообщение обратно в очередь с состоянием, установленным в *очередь*. Устройства, подключающиеся по протоколу MQTT, не могут отменять сообщения, передаваемых из облака на устройство.

Поток может не обработать сообщение, не уведомляя центр Интернета вещей. В этом случае сообщения автоматически переходят из *невидимого* состояния обратно в состояние «в *очереди* » после истечения времени ожидания *видимости* (или *блокировки* ). Значение этого времени ожидания равно одной минуте и не может быть изменено.

Свойство **Max Delivery Count (максимальное число доставок** ) в центре Интернета вещей определяет максимальное количество попыток перехода сообщения между состояниями, *поставленными в очередь* и *невидимыми* . После этого число переходов центр Интернета вещей устанавливает состояние сообщения с *недоставленным письмом*. Аналогичным образом центр Интернета вещей устанавливает состояние сообщения с *недоставленным письмом* после истечения срока действия. Дополнительные сведения см. [в разделе время жизни](#message-expiration-time-to-live).

В статье [Отправка сообщений из облака на устройство с помощью центра Интернета вещей](iot-hub-csharp-csharp-c2d.md) показано, как отправлять сообщения из облака на устройство из облака и получать их на устройстве.

Устройство обычно завершает сообщение, переданное из облака на устройство, когда потери сообщения не влияют на логику приложения. Например, это может быть вызвано тем, что устройство сохраняет содержимое сообщения локально или успешно выполнило операцию. Сообщение также может содержать временные сведения, потери которых не повлияли на функциональность приложения. Иногда при работе с длительно выполняемыми задачами можно сделать следующее:

* Заполните сообщение, переданное из облака на устройство, после того, как устройство сохранит описание задачи в локальном хранилище.

* Отправить одно или несколько сообщений (с устройства в облако) в серверную часть решения на различных этапах выполнения задачи.

## <a name="message-expiration-time-to-live"></a>Срок действия сообщения (срок жизни)

Каждое сообщение из облака на устройство имеет срок действия. Это время задается одним из следующих:

* Свойство **ExpiryTimeUtc** в службе
* Центр Интернета вещей с использованием *срока жизни* по умолчанию, указанного в качестве свойства центра Интернета вещей.

Ознакомьтесь с разделом [Параметры конфигурации сообщений, отправляемых из облака на устройство](#cloud-to-device-configuration-options).

Распространенным способом использования преимуществ истечения срока действия сообщения и предотвращения отправки сообщений на отключенные устройства является установка короткого *времени для динамических* значений. Такой подход достигает того же результата, что и поддержание состояния подключения устройства, но он является более эффективным. При запросе подтверждения сообщения центр Интернета вещей уведомляет о том, какие устройства:

* могут получать сообщения;
* находятся в автономном режиме или в состоянии сбоя.

## <a name="message-feedback"></a>Отзыв на сообщение

При отправке сообщения, отправляемого из облака на устройство, служба может запросить доставку каждого сообщения о последнем состоянии сообщения. Это можно сделать, задав свойство приложения **iothub-ACK** в сообщении, отправляемом из облака на устройство, которое отправляется в одно из следующих четырех значений:

| Значение свойства ACK | Поведение |
| ------------ | -------- |
| нет     | Центр Интернета вещей не создает обратное сообщение (поведение по умолчанию). |
| позитивная тональность | Если сообщение, переданное из облака на устройство, достигает состояния *завершено* , центр Интернета вещей создает сообщение с отзывом. |
| негативная тональность | Если сообщение, переданное из облака на устройство, достигает *недоставленного* состояния, центр Интернета вещей создает обратное сообщение. |
| переполненные     | Центр Интернета вещей создает отзыв в любом случае. |

Если значение **ACK** *заполнено* и вы не получаете обратное сообщение, это означает, что срок действия сообщения отзыва истек. Служба не знает, что случилось с исходным сообщением. На практике служба должна убедиться, что может обработать отзыв до истечения срока его действия. Максимальное время истечения срока действия составляет два дня, что оставляет время для повторного запуска службы при возникновении сбоя.

Как описано в [конечных точках](iot-hub-devguide-endpoints.md), центр Интернета вещей доставляет отзыв через конечную точку, доступную для службы, */Messages/servicebound/Feedback* в виде сообщений. Семантика получения отзыва идентична семантике, используемой для сообщений, отправляемых из облака на устройство. По возможности отзывы на сообщения группируются в одно сообщение, имеющее приведенный ниже формат:

| Свойство.     | Описание |
| ------------ | ----------- |
| EnqueuedTime | Отметка времени, указывающая, когда центр получил сообщение отзыва |
| UserId       | `{iot hub name}` |
| ContentType  | `application/vnd.microsoft.iothub.feedback.json` |

Основная часть — это сериализованный массив записей JSON, каждая из которых имеет следующие свойства:

| Свойство.           | Описание |
| ------------------ | ----------- |
| EnqueuedTimeUtc    | Отметка времени, указывающая, когда был получен результат сообщения (например, когда центр получил сообщение с отзывом или истек срок действия исходного сообщения). |
| OriginalMessageId  | Идентификатор *MessageId* сообщения, переданного из облака на устройство, к которому относится эта информация о отзывах |
| StatusCode         | Обязательная строка, используемая в сообщениях отзыва, созданных центром Интернета вещей: <br/> *Успешно* <br/> *Срок действия истек* <br/> *деливерикаунтексцеедед* <br/> *Отклонено* <br/> *Очистке* |
| Описание        | Строковые значения для *StatusCode* |
| DeviceId           | Идентификатор устройства назначения для сообщения, переданного *из облака* на устройство, к которому относится этот элемент отзыва |
| DeviceGenerationId | *Девицеженератионид* целевого устройства для сообщения из облака на устройство, к которому относится этот фрагмент обратной связи |

Чтобы сообщение, переданное из облака на устройство, соотнесено на отзыв с исходным сообщением, служба должна указать *MessageId*.

Текст сообщения обратной связи показан в следующем коде:

```json
[
  {
    "OriginalMessageId": "0987654321",
    "EnqueuedTimeUtc": "2015-07-28T16:24:48.789Z",
    "StatusCode": 0,
    "Description": "Success",
    "DeviceId": "123",
    "DeviceGenerationId": "abcdefghijklmnopqrstuvwxyz"
  },
  {
    ...
  },
  ...
]
```

**Ожидающие Отзывы об удаленных устройствах**

При удалении устройства также удаляются все ожидающие отзывы. Отзывы устройств отправляются пакетами. Если устройство будет удалено в окне с узким интервалом (часто менее 1 секунды), когда устройство подтверждает получение сообщения и когда будет подготовлен следующий пакет обратной связи, отзыв не будет выполняться.

Это поведение можно устранить, ожидая периода времени на поступление ожидающих отзывов перед удалением устройства. При удалении устройства следует предполагать, что потеряны соответствующие ответы на сообщения.

## <a name="cloud-to-device-configuration-options"></a>Параметры конфигурации сообщений, отправляемых из облака на устройство

Каждый Центр Интернета вещей предоставляет следующие параметры конфигурации для отправки сообщений из облака на устройство.

| Свойство.                  | Описание | Диапазон и значение по умолчанию |
| ------------------------- | ----------- | ----------------- |
| defaultTtlAsIso8601       | TTL для сообщений, отправляемых из облака на устройство, по умолчанию | ISO_8601 интервал до 2 дней (минимум 1 минута); по умолчанию: 1 час |
| maxDeliveryCount          | Максимальное число доставок для очередей устройств из облака на устройство | от 1 до 100; по умолчанию: 10 |
| feedback.ttlAsIso8601     | Хранение сообщений об отзыве, привязанных к службе | ISO_8601 интервал до 2 дней (минимум 1 минута); по умолчанию: 1 час |
| feedback.maxDeliveryCount | Максимальное число доставок для очереди отзывов | от 1 до 100; по умолчанию: 10 |
| Feedback. lockDurationAsIso8601 | Максимальное число доставок для очереди отзывов | Интервал ISO_8601 от 5 до 300 секунд (минимум 5 секунд); по умолчанию: 60 с. |

Параметры конфигурации можно задать одним из следующих способов.

* **Портал Azure**. в разделе **Параметры** в центре Интернета вещей выберите **встроенные конечные точки** и разверните узел **Обмен сообщениями между облаком и устройством**. (Настройка свойств **Feedback. maxDeliveryCount** и **Feedback. lockDurationAsIso8601** в настоящее время не поддерживается в портал Azure.)

    ![Настройка параметров конфигурации для обмена сообщениями из облака на устройство на портале](./media/iot-hub-devguide-messages-c2d/c2d-configuration-portal.png)

* **Azure CLI**: воспользуйтесь командой [AZ IOT центра обновления](/cli/azure/iot/hub#az-iot-hub-update) :

    ```azurecli
    az iot hub update --name {your IoT hub name} \
        --set properties.cloudToDevice.defaultTtlAsIso8601=PT1H0M0S

    az iot hub update --name {your IoT hub name} \
        --set properties.cloudToDevice.maxDeliveryCount=10

    az iot hub update --name {your IoT hub name} \
        --set properties.cloudToDevice.feedback.ttlAsIso8601=PT1H0M0S

    az iot hub update --name {your IoT hub name} \
        --set properties.cloudToDevice.feedback.maxDeliveryCount=10

    az iot hub update --name {your IoT hub name} \
        --set properties.cloudToDevice.feedback.lockDurationAsIso8601=PT0H1M0S
    ```

## <a name="next-steps"></a>Дальнейшие действия

Сведения о пакетах SDK, которые можно использовать для получения сообщений из облака на устройство, см. в статье [пакеты SDK для центра Интернета вещей Azure](iot-hub-devguide-sdks.md).

Инструкции по настройке получения сообщений, передаваемых из облака на устройство, см. в статье [Отправка сообщений из облака на устройство с помощью Центра Интернета вещей (.NET)](iot-hub-csharp-csharp-c2d.md).
