---
title: Визуализация данных центра Интернета вещей в реальном времени в веб-приложении
description: Сведения о визуализации данных о температуре и влажности, собранных с датчиков и переданных в центр Интернета вещей Azure, с помощью веб-приложения.
author: robinsh
ms.service: iot-hub
services: iot-hub
ms.topic: conceptual
ms.tgt_pltfrm: arduino
ms.date: 05/31/2019
ms.author: robinsh
ms.custom:
- 'Role: Cloud Development'
- 'Role: Data Analytics'
- devx-track-azurecli
ms.openlocfilehash: 53b5add7526b0c20487e8fe3adb0b8ebe207a2ce
ms.sourcegitcommit: dda0d51d3d0e34d07faf231033d744ca4f2bbf4a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/05/2021
ms.locfileid: "102200032"
---
# <a name="visualize-real-time-sensor-data-from-your-azure-iot-hub-in-a-web-application"></a>Визуализация данных, поступающих от датчиков в реальном времени, из центра Интернета вещей в веб-приложении

![Комплексная схема](./media/iot-hub-live-data-visualization-in-web-apps/1_iot-hub-end-to-end-diagram.png)

[!INCLUDE [iot-hub-get-started-note](../../includes/iot-hub-get-started-note.md)]

## <a name="what-you-learn"></a>Что вы узнаете

Из этого руководства вы узнаете, как визуализировать данные датчиков, полученные в реальном времени и отправленные в центр Интернета вещей, с помощью веб-приложения Node.js, размещенного на локальном компьютере. После локального запуска веб-приложения можно при необходимости выполнить действия по размещению веб-приложения в Службе приложений Azure. Если вы хотите визуализировать данные, поступающие с датчиков в реальном времени, в Центре Интернета вещей с помощью Power BI, см. сведения в [этой статье](iot-hub-live-data-visualization-in-power-bi.md).

## <a name="what-you-do"></a>Что нужно сделать

* Добавление группы потребителей в центр Интернета вещей, который веб-приложение будет использовать для чтения данных датчиков
* Загрузка кода веб-приложения с GitHub
* Изучение кода веб-приложения
* Настройка переменных среды для хранения артефактов Центра Интернета вещей, необходимых веб-приложению
* Запуск веб-приложения на компьютере разработчика
* Открытие веб-страницы для просмотра данных о температуре и влажности, полученных в реальном времени, в центре Интернета вещей
* (Необязательно) Использование Azure CLI для размещения веб-приложения в Службе приложений Azure

## <a name="what-you-need"></a>Необходимые элементы

* Пройдите одно из руководств по [использованию симулятора Raspberry Pi в подключенном режиме](iot-hub-raspberry-pi-web-simulator-get-started.md), например [Подключение онлайн-симулятора Raspberry Pi к Центру Интернета вещей Azure (Node.js)](iot-hub-raspberry-pi-kit-node-get-started.md). В них используется следующее:

  * активная подписка Azure;
  * Центр Интернета вещей в подписке;
  * клиентское приложение, которое отправляет сообщения в Центр Интернета вещей.

* [Скачайте Git](https://www.git-scm.com/downloads).

* Действия, описанные в этой статье, предполагают наличие компьютера, на котором выполняется разработка Windows. Однако эти действия можно легко выполнить в системе Linux в любой оболочке.

[!INCLUDE [azure-cli-prepare-your-environment.md](../../includes/azure-cli-prepare-your-environment-no-header.md)]

## <a name="add-a-consumer-group-to-your-iot-hub"></a>Добавление группы потребителей в Центр Интернета вещей

[Группы потребителей](../event-hubs/event-hubs-features.md#event-consumers) предоставляют независимые представления в поток событий, что позволяет приложениям и службам Azure независимо использовать данные из одной конечной точки концентратора событий. В этом разделе вы добавите группу потребителей во встроенную конечную точку центра Интернета вещей, которую веб-приложение будет использовать для чтения данных.

Выполните следующую команду, чтобы добавить группу потребителей во встроенную конечную точку центра Интернета вещей:

```azurecli-interactive
az iot hub consumer-group create --hub-name YourIoTHubName --name YourConsumerGroupName
```

Запишите выбранное имя, оно понадобится позже в этом руководстве.

## <a name="get-a-service-connection-string-for-your-iot-hub"></a>Получение строки подключения к службе для центра Интернета вещей

Центры Интернета вещей создаются с использованием нескольких политик доступа по умолчанию. Одной из таких политик является политика **службы**, которая предоставляет достаточные разрешения на чтение и запись конечных точек центра Интернета вещей для службы. Выполните следующую команду, чтобы получить строку подключения для центра Интернета вещей, которая соответствует политике службы:

```azurecli-interactive
az iot hub show-connection-string --hub-name YourIotHub --policy-name service
```

Строка подключения должна выглядеть так:

```javascript
"HostName={YourIotHubName}.azure-devices.net;SharedAccessKeyName=service;SharedAccessKey={YourSharedAccessKey}"
```

Запишите строку подключения службы, она понадобится позже в этом руководстве.

## <a name="download-the-web-app-from-github"></a>Загрузка веб-приложения с GitHub

Откройте окно команд и введите следующие команды, чтобы скачать пример из GitHub и перейти в каталог примеров:

```cmd
git clone https://github.com/Azure-Samples/web-apps-node-iot-hub-data-visualization.git
cd web-apps-node-iot-hub-data-visualization
```

## <a name="examine-the-web-app-code"></a>Изучение кода веб-приложения

В каталоге web-apps-node-iot-hub-data-visualization откройте веб-приложение в любимом редакторе. Ниже показана структура файла, отображаемая в VS Code:

![Структура файла веб-приложения](./media/iot-hub-live-data-visualization-in-web-apps/web-app-files.png)

Изучите следующие файлы:

* **Server.js** — это скрипт на стороне службы, который инициализирует веб-сокет и класс-оболочку концентратора событий. Он обеспечивает обратный вызов класса-оболочки концентратора событий, который используется классом для передачи входящих сообщений в веб-сокет.

* **Event-hub-reader.js** — это сценарий на стороне службы, который подключается к встроенной конечной точке центра Интернета вещей, используя указанную строку подключения и группу потребителей. Он извлекает DeviceId и EnqueuedTimeUtc из метаданных во входящих сообщениях, а затем передает сообщение с помощью метода обратного вызова, зарегистрированного server.js.

* **Chart-device-data.js** является сценарием на стороне клиента, который прослушивает веб-сокет, отслеживает каждый DeviceId и сохраняет последние 50 точек входящих данных для каждого устройства. Затем он привязывает выбранные данные устройства к объекту диаграммы.

* **Index.html** обрабатывает макет пользовательского интерфейса для веб-страницы и ссылается на необходимые скрипты для логики на стороне клиента.

## <a name="configure-environment-variables-for-the-web-app"></a>Настройка переменных среды для веб-приложения

Для чтения данных из центра Интернета вещей веб-приложению требуется строка подключения центра Интернета вещей и имя группы потребителей, данные которой оно будет считывать. Оно получает эти строки из среды процесса в следующих строках в server.js:

```javascript
const iotHubConnectionString = process.env.IotHubConnectionString;
const eventHubConsumerGroup = process.env.EventHubConsumerGroup;
```

Задайте переменные среды в окне командной строки с помощью следующих команд. Замените значения заполнителей строкой подключения службы для центра Интернета вещей и именем созданной ранее группы потребителей. Не заключайте строки в кавычки.

```cmd
set IotHubConnectionString=YourIoTHubConnectionString
set EventHubConsumerGroup=YourConsumerGroupName
```

## <a name="run-the-web-app"></a>Запуск веб-приложения

1. Убедитесь, что устройство работает и отправляет данные.

2. В окне команд выполните следующие строки, чтобы скачать и установить указанные пакеты и запустить веб-сайт:

   ```cmd
   npm install
   npm start
   ```

3. В консоли должны отобразиться выходные данные, указывающие, что веб-приложение успешно подключено к центру Интернета вещей и ожидает передачи данных через порт 3000:

   ![Веб-приложение запущено в консоли](./media/iot-hub-live-data-visualization-in-web-apps/web-app-console-start.png)

## <a name="open-a-web-page-to-see-data-from-your-iot-hub"></a>Открытие веб-страницы для просмотра данных из центра Интернета вещей

Откройте в браузере страницу `http://localhost:3000`.

В списке **Выбрать устройство** выберите устройство, чтобы просмотреть выполняющийся график последних 50 точек данных о температуре и влажности, отправленных устройством в центр Интернета вещей.

![Страница веб-приложения с данными о температуре и влажности, полученными в реальном времени](./media/iot-hub-live-data-visualization-in-web-apps/web-page-output.png)

Кроме того, в консоли отображаются выходные данные, которые показывают сообщения, передаваемые веб-приложением клиенту браузера:  

![Выходные данные вещания веб-приложения на консоли](./media/iot-hub-live-data-visualization-in-web-apps/web-app-console-broadcast.png)

## <a name="host-the-web-app-in-app-service"></a>Размещение веб-приложения в Службе приложений Azure

[Функция веб-приложений в Службе приложений Azure](../app-service/overview.md) предоставляет платформу как услугу (PAAS) для размещения веб-приложений. Веб-приложения, размещенные в Службе приложений Azure, могут использовать преимущества мощных функций Azure, таких как дополнительная безопасность, балансировка нагрузки и масштабируемость, а также решения Azure и партнеров для DevOps, например непрерывное развертывание, управление пакетами и т. д. Служба приложений Azure поддерживает веб-приложения, разработанные на многих популярных языках и развернутые в инфраструктуре Windows или Linux.

В этом разделе вы подготавливаете веб-приложение в Службе приложений и развертываете в него свой код с помощью команд Azure CLI. Подробные сведения об используемых командах см. в документации по [az webapp](/cli/azure/webapp). Прежде чем начать, убедитесь, что выполнили действия по [добавлению группы ресурсов в центр Интернета вещей](#add-a-consumer-group-to-your-iot-hub), [получению строки подключения службы для центра Интернета вещей](#get-a-service-connection-string-for-your-iot-hub) и [загрузке веб-приложения из GitHub](#download-the-web-app-from-github).

1. [План службы приложений](../app-service/overview-hosting-plans.md) определяет набор вычислительных ресурсов, на которых выполняется приложение, размещенное в Службе приложений. В этом руководстве мы используем уровень "Разработка" и "Бесплатный" для размещения веб-приложения. На уровне "Бесплатный" веб-приложение делит ресурсы Windows с другими приложениями Службы приложений, включая приложения других клиентов. Azure также предлагает планы Службы приложений для развертывания веб-приложений на базе вычислительных ресурсов Linux. Если у вас уже есть план службы приложений, который вы хотите использовать, этот шаг можно пропустить.

   Чтобы создать план службы приложений с помощью уровня "Бесплатный" Windows, выполните следующую команду. Выберите группу ресурсов, в которой находится центр Интернета вещей. Имя плана службы может содержать буквы верхнего и нижнего регистра, цифры и дефисы.

   ```azurecli-interactive
   az appservice plan create --name <app service plan name> --resource-group <your resource group name> --sku FREE
   ```

2. Теперь подготовьте веб-приложение в плане службы приложений. Параметр `--deployment-local-git` позволяет отправлять и развертывать код веб-приложения из репозитория Git на локальном компьютере. Имя веб-приложения должно быть глобально уникальным и может содержать буквы верхнего и нижнего регистра, цифры и дефисы. Убедитесь, что для параметра `--runtime` указана версия Node 10.6 или более поздняя, в зависимости от используемой версии среды выполнения Node.js. Для получения списка поддерживаемых сред выполнения можно использовать команду `az webapp list-runtimes`.

   ```azurecli-interactive
   az webapp create -n <your web app name> -g <your resource group name> -p <your app service plan name> --runtime "node|10.6" --deployment-local-git
   ```

3. Теперь добавьте параметры приложения для переменных среды, которые указывают строку подключения центра Интернета вещей и группу потребителей концентратора событий. Отдельные параметры разделяются пробелами в параметре `-settings`. Используйте строку подключения службы для центра Интернета вещей и группу потребителей, которую вы создали ранее. Не заключайте значения в кавычки.

   ```azurecli-interactive
   az webapp config appsettings set -n <your web app name> -g <your resource group name> --settings EventHubConsumerGroup=<your consumer group> IotHubConnectionString="<your IoT hub connection string>"
   ```

4. Включите протокол веб-сокетов для веб-приложения и настройте веб-приложение на получение только запросов HTTPS (HTTP-запросы перенаправляются к HTTPS).

   ```azurecli-interactive
   az webapp config set -n <your web app name> -g <your resource group name> --web-sockets-enabled true
   az webapp update -n <your web app name> -g <your resource group name> --https-only true
   ```

5. Чтобы развернуть код в службе приложений, вы будете использовать [учетные данные развертывания на уровне пользователя](../app-service/deploy-configure-credentials.md). Учетные данные развертывания на уровне пользователя отличаются от учетных данных Azure и используются для локальных и FTP-развертываний Git в веб-приложении. После настройки они будут действительны во всех приложениях службы приложений во всех подписках в учетной записи Azure. Если вы ранее настроили учетные данные развертывания на уровне пользователя, используйте их.

   Если вы не настраивали учетные данные развертывания на уровне пользователя или забыли пароль, выполните следующую команду. Имя пользователя развертывания должно быть уникальным в пределах Azure и не должно содержать \@ символ "" для локальных push-уведомлений Git. При появлении запроса введите и подтвердите новый пароль. Пароль должен содержать не менее восьми символов и включать два из трех следующих элементов: буквы, цифры и символы.

   ```azurecli-interactive
   az webapp deployment user set --user-name <your deployment user name>
   ```

6. Получите URL-адрес Git, который будет использоваться для отправки кода в службу приложений.

   ```azurecli-interactive
   az webapp deployment source config-local-git -n <your web app name> -g <your resource group name>
   ```

7. Добавьте удаленный репозиторий в клон, который ссылается на репозиторий Git для веб-приложения в службе приложений. Для \<Git clone URL\> Используйте URL-адрес, возвращенный на предыдущем шаге. Выполните следующую команду в командном окне.

   ```cmd
   git remote add webapp <Git clone URL>
   ```

8. Чтобы развернуть код в службе приложений, введите в командном окне следующую команду. При появлении запроса на ввод учетных данных введите учетные данные развертывания на уровне пользователя, созданные на шаге 5. Убедитесь, что вы перемещаетесь в главную ветвь службы приложений Remote.

    ```cmd
    git push webapp main:main
    ```

9. Ход выполнения развертывания будет обновлен в окне командной строки. Если развертывание пройдет успешно, вы увидите примерно такой результат:

    ```cmd
    remote:
    remote: Finished successfully.
    remote: Running post deployment command(s)...
    remote: Deployment successful.
    To https://contoso-web-app-3.scm.azurewebsites.net/contoso-web-app-3.git
    6b132dd..7cbc994  main -> main
    ```

10. Выполните следующую команду, чтобы запросить состояние веб-приложения и убедиться, что оно выполняется:

    ```azurecli-interactive
    az webapp show -n <your web app name> -g <your resource group name> --query state
    ```

11. Откройте браузер и перейдите по адресу `https://<your web app name>.azurewebsites.net`. Откроется веб-страница, похожая на ту, которую вы видели при локальном запуске веб-приложения. При условии, что устройство работает и отправляет данные, вы увидите график с 50 последними показателями температуры и влажности с устройства.

## <a name="troubleshooting"></a>Устранение неполадок

Если с примером возникли проблемы, выполните действия, описанные в следующих разделах. Если у вас по-прежнему возникают проблемы, отправьте нам отзыв в конце этого раздела.

### <a name="client-issues"></a>Проблемы с клиентом

* Если устройство не отображается в списке или граф не отрисовывается, убедитесь, что на устройстве выполняется код устройства.

* В браузере откройте средства разработчика (во многих браузерах нужно нажать клавишу F12) и найдите консоль. Обратите внимание на указанные предупреждения и ошибки.

* Сценарий на стороне клиента можно отладить /js/chat-device-data.js.

### <a name="local-website-issues"></a>Проблемы с локальным веб-сайтом

* Просмотрите выходные данные в окне, в котором был запущен узел для вывода консоли.

* Выполните отладку серверного кода, в частности файлы server.js и /scripts/event-hub-reader.js.

### <a name="azure-app-service-issues"></a>Неполадки со Службой приложений Azure

* Откройте портал Azure и перейдите к своему веб-приложению. В разделе **Мониторинг** на левой панели выберите **Журналы службы приложений**. Включите **Ведение журнала приложений (файловая система)** , установите для параметра **Уровень** значение "Ошибка" и нажмите **Сохранить**. Затем откройте **Поток журнала** (в разделе **Мониторинг**).

* Из веб-приложения на портале Azure в разделе **Средства разработки** выберите **Консоль** и проверьте версии узла и npm с помощью `node -v` и `npm -v`.

* Если появится сообщение о том, что не удается найти пакет, возможно, вы выполнили шаги не в том порядке. При развертывании сайта (с `git push`) служба приложений запускает `npm install`, который выполняется на основе настроенной текущей версии узла. Если версия в конфигурации изменилась, необходимо внести соответствующие изменения в код и отправить его снова.

## <a name="next-steps"></a>Дальнейшие действия

Вы успешно использовали веб-приложение для визуализации данных датчика, полученных в реальном времени, из Центра Интернета вещей.

Другой способ визуализации данных из Центра Интернета вещей Azure см. в статье [Визуализация данных, поступающих от датчиков в реальном времени, из Центра Интернета вещей с помощью Power BI](iot-hub-live-data-visualization-in-power-bi.md).

[!INCLUDE [iot-hub-get-started-next-steps](../../includes/iot-hub-get-started-next-steps.md)]
