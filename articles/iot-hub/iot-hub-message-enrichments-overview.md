---
title: Обзор дополнений сообщений в центре Интернета вещей Azure
description: В этой статье описаны обогащения сообщений, которые позволяют центру Интернета вещей отмечать сообщения дополнительными сведениями перед отправкой сообщений в указанную конечную точку.
author: robinsh
manager: philmea
ms.service: iot-hub
services: iot-hub
ms.topic: conceptual
ms.date: 05/10/2019
ms.author: robinsh
ms.openlocfilehash: 3975a57c095a8593e392e932bd125308853d3756
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "92541525"
---
# <a name="message-enrichments-for-device-to-cloud-iot-hub-messages"></a>Дополнения сообщений для сообщений центра Интернета вещей, отправляемых с устройства в облако

*Обогащение сообщений* — это способность центра Интернета вещей *отмечать* сообщения дополнительными сведениями перед отправкой сообщений в указанную конечную точку. Одной из причин для использования обогащений сообщений является включение данных, с помощью которых можно упростить последующую обработку. Например, обогащение сообщений телеметрии устройства с включением тега двойника устройства позволяет уменьшить нагрузку для клиентов путем отправки вызовов API двойнику устройства для получения этой информации.

![Поток обогащения сообщений](./media/iot-hub-message-enrichments-overview/message-enrichments-flow.png)

Обогащение сообщений имеет три ключевых элемента:

* Имя или ключ обогащения

* Значение

* Одна или несколько [конечных точек](iot-hub-devguide-endpoints.md) , к которым следует применить обогащение.

**Ключ** является строкой. Ключ может содержать только буквенно-цифровые символы или следующие специальные символы: дефис ( `-` ), символ подчеркивания ( `_` ) и точка ( `.` ).

**Значением** может быть любой из следующих примеров:

* Любая статическая строка. Динамические значения, такие как условия, логика, операции и функции, не допускаются. Например, при разработке приложения SaaS, которое используется несколькими клиентами, можно назначить идентификатор каждому клиенту и сделать этот идентификатор доступным в приложении. При запуске приложения центр Интернета вещей будет отмечать сообщения телеметрии устройства идентификатором клиента, что позволяет обрабатывать сообщения по-разному для каждого клиента.

* Имя центра Интернета вещей, отправляющего сообщение. Это значение равно *$iothubname*.

* Сведения из двойникаа устройства, например путь. Примерами могут быть *$Twin. Tags. Field* и *$Twin. Tags. Широта*.

   > [!NOTE]
   > В настоящее время только $iothubname, $Twin. tagss, $Twin. Properties. и $Twin. Properties. reсообщаемые переменные для обогащения сообщений.

Дополнения сообщений добавляются в виде свойств приложения в сообщения, отправляемые в выбранные конечные точки.  

## <a name="applying-enrichments"></a>Применение дополнений

Сообщения могут поступать из любого источника данных, поддерживаемого [маршрутизацией сообщений центра Интернета вещей](iot-hub-devguide-messages-d2c.md), включая следующие примеры:

* данные телеметрии устройств, такие как температура или давление.
* уведомления об изменении двойникаа устройства — изменения в двойникае устройства
* события жизненного цикла устройства, например при создании или удалении устройства

Вы можете добавлять дополнения к сообщениям, которые помещаются во встроенную конечную точку центра Интернета вещей, или сообщения, направляемые в пользовательские конечные точки, такие как хранилище BLOB-объектов Azure, очередь служебной шины или раздел служебной шины.

Вы можете добавить дополнения к сообщениям, публикуемым в сетку событий, выбрав конечную точку в качестве сетки событий. Мы создадим маршрут по умолчанию в центре Интернета вещей для телеметрии устройств на основе подписки на сетку событий. Этот один маршрут может поддерживать все подписки на сетку событий. Вы можете настроить дополнения для конечной точки сетки событий после создания подписки на сетку событий для телеметрии устройства. Дополнительные сведения см. в разделе центр [Интернета вещей и сетка событий](iot-hub-event-grid.md).

Дополнения применяются для каждой конечной точки. Если указать пять дополнений, которые будут отмечены для определенной конечной точки, все сообщения, отправляемые в эту конечную точку, будут отмечены одними и теми же пятью дополнениями.

Дополнения можно настроить с помощью следующих методов.

| **Метод** | **Команда** |
| ----- | -----| 
| Портал | [Портал Azure](https://portal.azure.com) | См. [руководство по обогащению сообщений](tutorial-message-enrichments.md) | 
| Azure CLI   | [AZ IOT сообщение в центре Интернета вещей](/cli/azure/iot/hub/message-enrichment) |
| Azure PowerShell | [Add-AzIotHubMessageEnrichment;](/powershell/module/az.iothub/add-aziothubmessageenrichment) |

Добавление дополнений сообщений не приводит к задержке маршрутизации сообщений.

Чтобы испытать обогащения сообщений, ознакомьтесь с [руководством по созданию сообщений](tutorial-message-enrichments.md) .

## <a name="limitations"></a>Ограничения

* Вы можете добавить до 10 дополнений на центр Интернета вещей для этих центров на уровне Standard или Basic. Для центров Интернета вещей на уровне Free можно добавить до 2 дополнений.

* В некоторых случаях при применении обогащения со значением, заданным для тега или свойства в двойникае устройства, значение будет помечено как строковое значение. Например, если значение обогащения установлено в $twin. Tags. поле, сообщения будут отмечаться строкой "$twin. Tags. поле", а не значением этого поля из двойника. Это происходит в следующих случаях:

   * Центр Интернета вещей находится на уровне Basic. Центры Интернета вещей уровня "базовый" не поддерживают двойникови устройств.

   * Центр Интернета вещей находится на уровне Standard, но устройство, отправляющее сообщение, не имеет двойникаов устройств.

   * Центр Интернета вещей находится на уровне Standard, но путь двойникаа устройства, используемый для значения, не существует. Например, если для параметра обогащения задано значение $twin. Tags. Location, а в двойникае устройства нет свойства Location, то сообщение будет отмечено строкой "$twin. tagss. Location". 

* Обновление двойникаа устройства может занять до пяти минут, чтобы оно отражалось в соответствующем значении обогащения.

* Общий размер сообщения, включая дополнения, не может превышать 256 КБ. Если размер сообщения превышает 256 КБ, то центр Интернета вещей удаляет сообщение. [Метрики центра Интернета вещей](monitor-iot-hub-reference.md#metrics) можно использовать для обнаружения и отладки ошибок при удалении сообщений. Например, можно отслеживать *несовместимость сообщений телеметрии* (*D2C. телеметрии. исходящего трафика. недопустимо*) в [метриках маршрутизации](monitor-iot-hub-reference.md#routing-metrics). Дополнительные сведения см. в статье [Мониторинг Центра Интернета вещей](monitor-iot-hub.md).

* Обогащения сообщений не применяются к событиям изменения цифровых двойника.

## <a name="pricing"></a>Цены

Дополнения сообщений доступны без дополнительной платы. В настоящее время при отправке сообщения в центр Интернета вещей выставляются счета. Вы платите только один раз для этого сообщения, даже если оно переходит на несколько конечных точек.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о маршрутизации сообщений в центр Интернета вещей см. в этих статьях:

* [Учебник по обогащению сообщений](tutorial-message-enrichments.md)

* [Использование маршрутизации сообщений в Центре Интернета вещей для отправки с устройства в облако в разные конечные точки](iot-hub-devguide-messages-d2c.md)

* [Учебник. Маршрутизация в Центре Интернета вещей](tutorial-routing.md)