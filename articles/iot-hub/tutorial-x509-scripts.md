---
title: Руководство по созданию тестовых сертификатов X.509 для Центра Интернета вещей Azure с помощью скриптов Майкрософт | Документация Майкрософт
description: Руководство по созданию центра сертификации и сертификатов устройств для Центра Интернета вещей Azure с помощью скриптов
author: v-gpettibone
manager: philmea
ms.service: iot-hub
services: iot-hub
ms.topic: tutorial
ms.date: 02/26/2021
ms.author: robinsh
ms.custom:
- mvc
- 'Role: Cloud Development'
- 'Role: Data Analytics'
ms.openlocfilehash: ff4b63f49a87dd9ca6b0ef458bdcf1c285a34a18
ms.sourcegitcommit: 2654d8d7490720a05e5304bc9a7c2b41eb4ae007
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/13/2021
ms.locfileid: "107378216"
---
# <a name="tutorial-using-microsoft-supplied-scripts-to-create-test-certificates"></a>Руководство. Создание тестовых сертификатов с помощью скриптов, предоставляемых корпорацией Майкрософт

Корпорация Майкрософт предоставляет скрипты PowerShell и Bash, которые помогут вам разобраться в процессах создания сертификатов X.509 и проверки подлинности в Центре Интернета вещей с их использованием. Скрипты находятся в [репозитории](https://github.com/Azure/azure-iot-sdk-c/tree/master/tools/CACertificates) GitHub. Они предоставляются только для демонстрации. Не используйте в рабочей среде созданные с помощью этих скриптов сертификаты. Они содержат жестко заданные пароли ("1234"). Срок действия таких сертификатов истекает через 30 дней. Для рабочей среды необходимо соблюдать все применимые к вашему случаю рекомендации по созданию сертификатов и управлению жизненным циклом.

## <a name="powershell-scripts"></a>Сценарии PowerShell

### <a name="step-1---setup"></a>Шаг 1. Установка

Установите OpenSSL для Windows. Откройте страницу <https://www.openssl.org/docs/faq.html#MISC4>, чтобы найти расположение для скачивания, или <https://www.openssl.org/source/> для компиляции из исходного кода. Затем выполните скрипты предварительной подготовки:

1. Скопируйте скрипты из репозитория [GitHub](https://github.com/Azure/azure-iot-sdk-c/tree/master/tools/CACertificates) в локальный каталог, в котором вы будете работать. Все файлы будут созданы как дочерние элементы этого каталога.

1. Запустите оболочку PowerShell от имени администратора.

1. Перейдите в каталог, куда вы поместили скрипты.

1. В командной строке задайте для переменной среды `$ENV:OPENSSL_CONF` значение, указывающее на каталог с файлом конфигурации OpenSSL (openssl.cnf).

1. Выполните команду `Set-ExecutionPolicy -ExecutionPolicy Unrestricted`, чтобы PowerShell мог выполнить скрипты.

1. Выполните `. .\ca-certs.ps1`. Эта команда включает функции скрипта в глобальное пространство имен PowerShell.

1. Выполните `Test-CACertsPrerequisites`. PowerShell использует для управления сертификатами хранилище сертификатов Windows. Эта команда позволяет проверить, не могут ли позже возникнуть конфликты имен с существующими сертификатами и правильно ли настроено решение OpenSSL.

### <a name="step-2---create-certificates"></a>Шаг 2. Создание сертификатов

Выполните `New-CACertsCertChain [ecc|rsa]`. Для сертификатов центра сертификации рекомендуется использовать ECC, но это не обязательно. Этот скрипт позволяет сохранить в каталог и в хранилище сертификатов Windows следующие сертификаты центра сертификации и промежуточные сертификаты:

* intermediate1.pem;
* intermediate2.pem;
* intermediate3.pem;
* RootCA.cer;
* RootCA.pem.

После выполнения скрипта добавьте новый сертификат центра сертификации (RootCA.pem) в Центр Интернета вещей.

1. Откройте Центр Интернета вещей и перейдите к разделу сертификатов.

1. Выберите **Добавить**.

1. Введите отображаемое имя для сертификата центра сертификации.

1. Отправьте сертификат центра сертификации.

1. Щелкните **Сохранить**.

### <a name="step-3---prove-possession"></a>Шаг 3. Подтверждение прав владения

Итак, вы успешно отправили сертификат центра сертификации в Центр Интернета вещей. Теперь вам нужно доказать, что он действительно принадлежит вам.

1. Выберите новый сертификат центра сертификации.

1. Выберите элемент **Создать код проверки** в диалоговом окне **Сведения о сертификате**. Дополнительные сведения см. в руководстве [Подтверждение владения сертификатом центра сертификации](tutorial-x509-prove-possession.md).

1. Создайте сертификат с кодом проверки. Например, если код проверки имеет значение `"106A5SD242AF512B3498BD6098C4941E66R34H268DDB3288"`, выполните приведенную ниже команду, чтобы создать в рабочем каталоге новый сертификат с субъектом `CN = 106A5SD242AF512B3498BD6098C4941E66R34H268DDB3288`. Этот скрипт позволяет создать сертификат с именем `VerifyCert4.cer`.

    `New-CACertsVerificationCert "106A5SD242AF512B3498BD609C4941E66R34H268DDB3288"`

1. Отправьте `VerifyCert4.cer` в Центр Интернета вещей, используя диалоговое окно **Сведения о сертификате**.

1. Нажмите кнопку **Проверить**.

### <a name="step-4---create-a-new-device"></a>Шаг 4. Создание устройства

Создайте устройство для Центра Интернета вещей:

1. В Центре Интернета вещей перейдите к разделу **Устройства Интернета вещей**.

1. Добавьте новое устройство с идентификатором `mydevice`.

1. Выберите режим проверки подлинности **Сертификат X.509, подписанный центром сертификации**.

1. Выполните `New-CACertsDevice mydevice`, чтобы создать сертификат устройства. В рабочем каталоге будут созданы следующие файлы:

   * `mydevice.pfx`
   * `mydevice-all.pem`
   * `mydevice-private.pem`
   * `mydevice-public.pem`

### <a name="step-5---test-your-device-certificate"></a>Шаг 5. Проверка сертификата устройства

Руководство по [тестированию проверки подлинности с использованием сертификатов](tutorial-x509-test-certificate.md) поможет вам убедиться, что ваш сертификат позволяет устройству выполнять вход в Центр Интернета вещей. Вам потребуется версия сертификата в формате PFX, `mydevice.pfx`.

### <a name="step-6---cleanup"></a>Шаг 6. Очистка

В меню "Пуск" откройте раздел **Управление сертификатами компьютера** и последовательно выберите элементы **Сертификаты — Локальный компьютер — Персональный**. Удалите все сертификаты, выданные центром сертификации "Azure IoT CA TestOnly*". Также удалите все подобные сертификаты из разделов **"Доверенный корневой центр сертификации > Сертификаты" и "Промежуточные центры сертификации > Сертификаты"** .

## <a name="bash-scripts"></a>Скрипты Bash

### <a name="step-1---setup"></a>Шаг 1. Установка

1. Запустите оболочку Bash.

1. Перейдите в каталог, в котором планируете работать. Все файлы будут созданы в этом каталоге.

1. Скопируйте `*.cnf` и `*.sh` в рабочий каталог.

### <a name="step-2---create-certificates"></a>Шаг 2. Создание сертификатов

1. Выполните `./certGen.sh create_root_and_intermediate`. В каталоге **certs** будут созданы следующие файлы:

    * azure-iot-test-only.chain.ca.cert.pem;
    * azure-iot-test-only.intermediate.cert.pem;
    * azure-iot-test-only.root.ca.cert.pem.

1. Откройте Центр Интернета вещей и перейдите к разделу **сертификатов**.

1. Выберите **Добавить**.

1. Введите отображаемое имя для сертификата центра сертификации.

1. Отправьте в Центр Интернета вещей только сертификат центра сертификации. Это сертификат с именем `./certs/azure-iot-test-only.root.ca.cert.pem.`.

1. Щелкните **Сохранить**.

### <a name="step-3---prove-possession"></a>Шаг 3. Подтверждение прав владения

1. Выберите новый сертификат центра сертификации, созданный на предыдущем шаге.

1. Выберите элемент **Создать код проверки** в диалоговом окне **Сведения о сертификате**. Дополнительные сведения см. в руководстве [Подтверждение владения сертификатом центра сертификации](tutorial-x509-prove-possession.md).

1. Создайте сертификат с кодом проверки. Например, если код проверки имеет значение `"106A5SD242AF512B3498BD6098C4941E66R34H268DDB3288"`, выполните приведенную ниже команду, чтобы создать в рабочем каталоге с именем `verification-code.cert.pem` новый сертификат с субъектом `CN = 106A5SD242AF512B3498BD6098C4941E66R34H268DDB3288`.

    `./certGen.sh create_verification_certificate "106A5SD242AF512B3498BD6098C4941E66R34H268DDB3288"`

1. Отправьте этот сертификат в Центр Интернета вещей, используя диалоговое окно **Сведения о сертификате**.

1. Нажмите кнопку **Проверить**.

### <a name="step-4---create-a-new-device"></a>Шаг 4. Создание устройства

Создайте устройство для Центра Интернета вещей:

1. В Центре Интернета вещей перейдите к разделу "Устройства Интернета вещей".

1. Добавьте новое устройство с идентификатором `mydevice`.

1. Выберите режим проверки подлинности **Сертификат X.509, подписанный центром сертификации**.

1. Выполните `./certGen.sh create_device_certificate mydevice`, чтобы создать сертификат устройства. В рабочем каталоге будут созданы два файла с именами `new-device.cert.pem` и `new-device.cert.pfx`.

### <a name="step-5---test-your-device-certificate"></a>Шаг 5. Проверка сертификата устройства

Руководство по [тестированию проверки подлинности с использованием сертификатов](tutorial-x509-test-certificate.md) поможет вам убедиться, что ваш сертификат позволяет устройству выполнять вход в Центр Интернета вещей. Вам потребуется версия сертификата в формате PFX, `new-device.cert.pfx`.

### <a name="step-6---cleanup"></a>Шаг 6. Очистка

Так как с помощью этого скрипта Bash только создаются сертификаты в рабочем каталоге, по завершении тестирования просто удалите их.

## <a name="next-steps"></a>Next Steps

Руководство по [тестированию проверки подлинности с использованием сертификатов](tutorial-x509-test-certificate.md) поможет вам протестировать сертификат и убедиться, что он позволяет устройству выполнять вход в Центр Интернета вещей.
