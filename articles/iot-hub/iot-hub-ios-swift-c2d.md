---
title: Отправка сообщений из облака на устройство с помощью Центра Интернета вещей Azure (iOS) | Документация Майкрософт
description: Сведения об отправке сообщений из облака на устройство из Центра Интернета вещей Azure с помощью пакетов SDK для Интернета вещей Azure для iOS.
author: kgremban
ms.service: iot-hub
services: iot-hub
ms.topic: conceptual
ms.date: 04/19/2018
ms.author: kgremban
ms.custom: mqtt
ms.openlocfilehash: 15c0df33b8f09ec71f2be913d72f0785dc766375
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "93027539"
---
# <a name="send-cloud-to-device-messages-with-iot-hub-ios"></a>Отправка сообщений из облака на устройство с помощью Центра Интернета вещей (iOS)

[!INCLUDE [iot-hub-selector-c2d](../../includes/iot-hub-selector-c2d.md)]

Центр Интернета вещей Azure — это полностью управляемая служба, которая обеспечивает надежный и защищенный двунаправленный обмен данными между миллионами устройств и серверной частью решения. В руководстве по [отправке данных телеметрии с устройства в центр Интернета вещей](quickstart-send-telemetry-ios.md) показано, как создать центр Интернета вещей, подготовить в нем удостоверение устройства и написать код приложения для имитации устройства, которое отправляет сообщения из устройства в облако.

В этом учебнике описаны следующие процедуры.

* Отправка сообщений, передаваемых из облака на устройство, из серверной части решения на одно устройство через Центр Интернета вещей.

* Получение на устройстве сообщений, передаваемых из облака на устройство.

* Запрос из серверной части решения подтверждения доставки (*отзыва*) для сообщений, отправленных на устройство из Центра Интернета вещей.

Дополнительные сведения о сообщениях, отправляемых из облака на устройство, см. в статье [Отправка сообщений с устройства в облако и из облака на устройство с помощью Центра Интернета вещей](iot-hub-devguide-messaging.md).

С помощью этой статьи вы запустите два проекта Swift iOS:

* приложение **sample-device**, которое вы создали при работе с руководством по [отправке данных телеметрии с устройства в Центр Интернета вещей (Swift)](quickstart-send-telemetry-ios.md) и которое подключается к Центру Интернета вещей и получает сообщения из облака на устройство;

* **Пример — служба**, которая отправляет сообщение из облака на устройство в приложение имитации устройства через центр Интернета вещей, а затем получает подтверждение доставки.

> [!NOTE]
> В Центре Интернета вещей реализована поддержка для пакетов SDK для многих платформ устройств и языков (включая C, Java, Python и Javascript). Эти пакеты работают на основе пакетов SDK для устройств Azure IoT. Пошаговые указания по связыванию устройства с кодом из этого руководства, а также по подключению к Центру Интернета вещей Azure см. в [центре разработчиков для Интернета вещей Azure](https://www.azure.com/develop/iot).

## <a name="prerequisites"></a>Предварительные требования

* Активная учетная запись Azure. Если ее нет, можно создать [бесплатную учетную запись](https://azure.microsoft.com/pricing/free-trial/) всего за несколько минут.

* действующий Центр Интернета вещей в Azure;

* Пример кода из [примеров Azure](https://github.com/Azure-Samples/azure-iot-samples-ios/archive/master.zip).

* Последняя версия [XCode](https://developer.apple.com/xcode/), выполняющая последнюю версию пакета SDK для iOS. Это краткое руководство протестировано с использованием версий XCode 9.3 и iOS 11.3;

* Последняя версия [CocoaPods](https://guides.cocoapods.org/using/getting-started.html).

* Убедитесь, что в брандмауэре открыт порт 8883. Пример устройства в этой статье использует протокол MQTT, который передает данные через порт 8883. В некоторых корпоративных и академических сетях этот порт может быть заблокирован. Дополнительные сведения и способы устранения этой проблемы см. в разделе о [подключении к Центру Интернета вещей по протоколу MQTT](iot-hub-mqtt-support.md#connecting-to-iot-hub).

## <a name="simulate-an-iot-device"></a>Имитация устройства Интернета вещей

В этом разделе вы подготовите имитацию устройства iOS под управлением приложения Swift, которое будет получать сообщения из облака на устройство через Центр Интернета вещей. 

Это пример устройства, которое вы создали, работая со статьей [отправке данных телеметрии с устройства в Центр Интернета вещей (Swift)](quickstart-send-telemetry-ios.md). Если он у вас уже есть, можете пропустить этот раздел.

### <a name="install-cocoapods"></a>Установка CocoaPods

CocoaPods управляет зависимостями проектов iOS, которые используют сторонние библиотеки.

В окне терминала перейдите в папку Azure-IoT-Samples-iOS, скачанную на этапе подготовки. Перейдите к примеру проекта:

```sh
cd quickstart/sample-device
```

Убедитесь, что XCode закрыт, а затем выполните следующую команду, чтобы установить CocoaPods, объявленный в файле **podfile**:

```sh
pod install
```

Вместе с установкой модулей, необходимых для проекта, команда установки также создает файл рабочей области XCode, который уже настроен для использования pod с зависимостями.

### <a name="run-the-sample-device-application"></a>Запуск примера приложения устройства

1. Получите строку подключения к устройству. Эту строку можно скопировать на [портале Azure](https://portal.azure.com) из колонки сведений об устройстве или получить с помощью следующей команды CLI.

    ```azurecli-interactive
    az iot hub device-identity show-connection-string --hub-name {YourIoTHubName} --device-id {YourDeviceID} --output table
    ```

1. Откройте пример рабочей области в XCode.

   ```sh
   open "MQTT Client Sample.xcworkspace"
   ```

2. Разверните проект **Пример клиента MQTT**, а затем папку с таким же именем.  

3. Откройте **ViewController.swift** для редактирования в XCode. 

4. Найдите переменную **connectionString** и замените ее значение строкой подключения к устройству, которую вы скопировали на первом шаге.

5. Сохраните изменения. 

6. Выполните проект в эмуляторе устройства, нажав кнопку **Сборка и запуск** или клавиши **COMMAND+R**.

   ![На снимке экрана показана кнопка "сборка и запуск" в эмуляторе устройства.](media/iot-hub-ios-swift-c2d/run-sample.png)

## <a name="get-the-iot-hub-connection-string"></a>Получение строки подключения центра Интернета вещей

В этой статье вы создадите серверную службу для отправки сообщений из облака на устройство через центр Интернета вещей, созданный в кратком руководстве [Отправка данных телеметрии с устройства в центр Интернета вещей](quickstart-send-telemetry-ios.md). Для отправки сообщений из облака на устройство службе требуется разрешение **service connect**. По умолчанию каждый Центр Интернета вещей создается с помощью политики общего доступа, называемой **службой**, которая предоставляет это разрешение.

[!INCLUDE [iot-hub-include-find-service-connection-string](../../includes/iot-hub-include-find-service-connection-string.md)]

## <a name="simulate-a-service-device"></a>Эмуляция устройства службы

В этом разделе вы подготовите эмуляцию второго устройства iOS с приложением Swift, которое отправляет сообщения из облака на устройство через Центр Интернета вещей. Такая конфигурация удобна для сценариев Интернета вещей, в которых устройство iPhone или iPad выполняет роль контроллера для других устройств под управлением iOS, подключенных к Центру Интернета вещей.

### <a name="install-cocoapods"></a>Установка CocoaPods

CocoaPods управляет зависимостями проектов iOS, которые используют сторонние библиотеки.

Перейдите в папку примеров Интернета вещей Azure для iOS, которую вы скачали на этапе подготовки. Перейдите к примеру проекта службы:

```sh
cd quickstart/sample-service
```

Убедитесь, что XCode закрыт, а затем выполните следующую команду, чтобы установить CocoaPods, объявленный в файле **podfile**:

```sh
pod install
```

Вместе с установкой модулей, необходимых для проекта, команда установки также создает файл рабочей области XCode, который уже настроен для использования pod с зависимостями.

### <a name="run-the-sample-service-application"></a>Запуск примера приложения службы

1. Откройте пример рабочей области в XCode.

   ```sh
   open AzureIoTServiceSample.xcworkspace
   ```

2. Разверните проект **AzureIoTServiceSample**, а затем разверните папку с тем же именем.  

3. Откройте **ViewController.swift** для редактирования в XCode. 

4. Найдите переменную **ConnectionString** и обновите ее значение, указав строку подключения службы, скопированную ранее в [поле получение строки подключения к центру Интернета вещей](#get-the-iot-hub-connection-string).

5. Сохраните изменения.

6. В Xcode измените параметры эмулятора, чтобы это устройство iOS отличалось от того, на котором выполняется устройство Интернета вещей. XCode не может выполнять несколько эмуляторов одного типа.

   ![Изменение эмулируемого устройства](media/iot-hub-ios-swift-c2d/change-device.png)

7. Запустите проект в эмуляторе устройства с помощью кнопки " **Сборка" и "выполнить** " или команды со списком ключей **+ r**.

   ![На снимке экрана показана кнопка "сборка и запуск".](media/iot-hub-ios-swift-c2d/run-app.png)

## <a name="send-a-cloud-to-device-message"></a>Отправка сообщения из облака на устройство

Теперь вы готовы выполнять два приложения для отправки и получения сообщений из облака на устройство.

1. В приложении **пример приложения iOS**, которое работает на эмулированном устройстве Интернета вещей, щелкните **Запустить**. Приложение сразу начинает отправлять сообщения из устройства в облако, а также прослушивать поступающие сообщения из облака.

   ![Просмотр примера приложения для устройства Интернета вещей](media/iot-hub-ios-swift-c2d/view-d2c.png)

2. В приложении **Пример клиента службы Центра Интернета вещей**, которое выполняется на имитированном устройстве службы, введите идентификатор того устройства Интернета вещей, на которое вы хотите отправить сообщение. 

3. Создайте сообщение с открытым текстом и щелкните **Отправить**.

    При нажатии кнопки отправки одновременно выполняются несколько действий. Пример службы отправляет сообщение в Центр Интернета вещей, доступ к которому предоставляет указанная вами строка подключения. Центр Интернета вещей проверяет идентификатор устройства, отправляет сообщение на целевое устройство и возвращает подтверждающее уведомление на исходное устройство. Приложение, работающее на эмулированном устройстве Интернета вещей, проверяет сообщения от Центра Интернета вещей и выводит на экран самое свежее из них.

    Полученный результат должен выглядеть примерно так:

   ![Просмотр сообщений из облака на устройство](media/iot-hub-ios-swift-c2d/view-c2d.png)

## <a name="next-steps"></a>Дальнейшие действия

В этом учебнике вы научились отправлять и получать сообщения с облака на устройство.

Примеры комплексных решений, в которых используется центр Интернета вещей, см. в [Документации по акселераторам решений Интернета вещей](https://azure.microsoft.com/documentation/suites/iot-suite/).

Дополнительные сведения о разработке решений с помощью Центра Интернета вещей см. в [руководстве разработчика для Центра Интернета вещей](iot-hub-devguide.md).
