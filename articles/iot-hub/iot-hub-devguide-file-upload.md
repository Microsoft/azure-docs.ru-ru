---
title: Общие сведения об отправке файлов в Центре Интернета вещей Azure | Документация Майкрософт
description: Руководство разработчика. Воспользуйтесь функцией отправки файлов в Центре Интернета вещей для управления передачей файлов с устройства в контейнер больших двоичных объектов службы хранилища Azure.
author: robinsh
manager: philmea
ms.author: robinsh
ms.service: iot-hub
services: iot-hub
ms.topic: conceptual
ms.date: 11/07/2018
ms.custom:
- mqtt
- 'Role: Cloud Development'
- 'Role: IoT Device'
ms.openlocfilehash: 3286b464051b8fea88d2797d4f82b20fe432b4b8
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "90019535"
---
# <a name="upload-files-with-iot-hub"></a>Отправка файлов с помощью Центра Интернета вещей

Как описано в статье о [конечных точках Центра Интернета вещей](iot-hub-devguide-endpoints.md), устройства могут инициировать передачу файлов путем отправки уведомления через конечную точку, доступную для устройства (**/devices/{идентификатор_устройства}/files**). Когда устройство уведомляет Центр Интернета вещей о завершении отправки, Центр Интернета вещей отправляет сообщение уведомления о передаче файлов через конечную точку, доступную для службы (**/messages/servicebound/filenotifications**).

Вместо функций брокера сообщений Центр Интернета вещей выполняет роль диспетчера для связанной учетной записи хранения Azure. Устройство запрашивает из Центра Интернета вещей маркер хранилища, относящийся к файлу, который должно отправить устройство. Для отправки файла в хранилище устройство использует код URI SAS, а по завершении загрузки отправляет соответствующее уведомление в Центр Интернета вещей. Центр Интернета вещей проверяет, завершена ли отправка файлов, а затем добавляет сообщение уведомления о передаче файлов в конечную точку уведомления о файлах, доступную для службы.

Перед отправкой файла в Центр Интернета вещей с устройства необходимо настроить центр, [связав учетную запись хранения Azure](iot-hub-devguide-file-upload.md#associate-an-azure-storage-account-with-iot-hub) с ним.

После этого устройство сможет [инициализировать отправку](iot-hub-devguide-file-upload.md#initialize-a-file-upload) и [уведомить Центр Интернета вещей](iot-hub-devguide-file-upload.md#notify-iot-hub-of-a-completed-file-upload) о завершении передачи. Служба может дополнительно создавать [сообщение уведомления](iot-hub-devguide-file-upload.md#file-upload-notifications), когда устройство будет уведомлять Центр Интернета вещей о завершении передачи.

[!INCLUDE [iot-hub-include-x509-ca-signed-file-upload-support-note](../../includes/iot-hub-include-x509-ca-signed-file-upload-support-note.md)]

### <a name="when-to-use"></a>Назначение

Передача файлов используется для отправки файлов мультимедиа и больших пакетов телеметрии, передаваемых периодически подключаемыми устройствами или сжатых для экономии пропускной способности.

Дополнительные сведения см. в [руководстве по обмену данными, отправляемыми с устройства в облако](iot-hub-devguide-d2c-guidance.md), если сомневаетесь относительно использования сообщаемых свойств, сообщений, отправляемых с устройства в облако, или передачей файла.

## <a name="associate-an-azure-storage-account-with-iot-hub"></a>Связывание учетной записи хранения Azure с Центром Интернета вещей

Чтобы использовать функции отправки файлов, сначала необходимо связать учетную запись хранения Azure с Центром Интернета вещей. Эту задачу можно выполнить либо с помощью портал Azure, либо программно с помощью [API-интерфейсов интерфейса RESTful поставщика ресурсов центра Интернета вещей](/rest/api/iothub/iothubresource). После привязки учетной записи хранения Azure к Центру Интернета вещей служба возвращает универсальный код ресурса (URI) SAS на устройство, получив от него запрос на отправку файла.

В руководствах по [отправке файлов с устройства в облако с помощью центра Интернета вещей](iot-hub-csharp-csharp-file-upload.md) представлена полная пошаговая инструкция по процессу отправки файла. В этих руководствах показано, как связать учетную запись хранения с центром Интернета вещей с помощью портала Azure.

> [!NOTE]
> [Пакеты SDK для служб Azure IoT](iot-hub-devguide-sdks.md) автоматически управляют получением кода URI SAS, отправкой файла и уведомлением Центра Интернета вещей о завершении отправки.

## <a name="initialize-a-file-upload"></a>Инициализация отправки файла
У Центра Интернета вещей есть конечная точка, предназначенная для выполнения устройствами запросов на URI SAS хранилища, куда необходимо отправить файл. Чтобы инициировать процесс отправки файла, устройство отправляет в `{iot hub}.azure-devices.net/devices/{deviceId}/files` запрос POST со следующим текстом в формате JSON.

```json
{
    "blobName": "{name of the file for which a SAS URI will be generated}"
}
```

Центр Интернета вещей возвращает следующие данные, которые устройство использует для передачи файла:

```json
{
    "correlationId": "somecorrelationid",
    "hostName": "yourstorageaccount.blob.core.windows.net",
    "containerName": "testcontainer",
    "blobName": "test-device1/image.jpg",
    "sasToken": "1234asdfSAStoken"
}
```

### <a name="deprecated-initialize-a-file-upload-with-a-get"></a>Инициализация передачи файла с использованием запроса GET (не рекомендуется)

> [!NOTE]
> В этом разделе описаны нерекомендуемые возможности получения кода URI SAS из Центра Интернета вещей. Используйте метод POST, описанный выше.

Центр Интернета вещей располагает двумя конечными точками REST для поддержки отправки файлов. Одна предназначена для получения кода URI SAS для хранения, а другая — для уведомления Центра Интернета вещей о завершении загрузки. Устройство инициирует отправку файла, отправляя запрос GET в центр Интернета вещей по адресу `{iot hub}.azure-devices.net/devices/{deviceId}/files/{filename}`. Центр Интернета вещей возвращает следующие данные:

* универсальный код ресурса (URI) SAS, относящийся к передаваемому файлу;

* идентификатор корреляции, который необходимо использовать по завершении передачи.

## <a name="notify-iot-hub-of-a-completed-file-upload"></a>Уведомление Центра Интернета вещей о завершении отправки файла

Устройство отправляет файл в хранилище с помощью пакетов SDK службы хранилища Azure. По завершении передачи устройство отправляет запрос POST в `{iot hub}.azure-devices.net/devices/{deviceId}/files/notifications` со следующим текстом в формате JSON:

```json
{
    "correlationId": "{correlation ID received from the initial request}",
    "isSuccess": bool,
    "statusCode": XXX,
    "statusDescription": "Description of status"
}
```

Значение `isSuccess` является логическим и указывает, успешно ли загружен файл. Код состояния для `statusCode` является состоянием отправки файла в хранилище и `statusDescription` соответствует `statusCode`.

## <a name="reference-topics"></a>Справочные материалы

Далее предоставлены дополнительные сведения о передаче файлов с устройства.

## <a name="file-upload-notifications"></a>Уведомления об отправке файлов

При необходимости, когда устройство уведомляет центр Интернета вещей о завершении отправки, центр Интернета вещей создает сообщение с уведомлением. Это сообщение содержит имя и место хранения файла.

Как описано в руководстве [Конечные точки Центра Интернета вещей](iot-hub-devguide-endpoints.md), Центр Интернета вещей доставляет уведомления об отправке файлов через конечную точку, обращенную к службе (**/messages/servicebound/fileuploadnotifications**), в виде сообщений. Семантика получения уведомлений о передаче файлов такая же, как и для сообщений, отправляемых из облака на устройство, и имеет одинаковый [жизненный цикл сообщения](iot-hub-devguide-messages-c2d.md#the-cloud-to-device-message-life-cycle). Каждое сообщение, полученное из конечной точки уведомления об отправке файла, — это запись JSON с перечисленными ниже свойствами.

| Свойство. | Описание |
| --- | --- |
| EnqueuedTimeUtc |Метка времени, указывающая, когда было создано уведомление. |
| DeviceId |**DeviceId** устройства, с которого был отправлен файл. |
| BlobUri |Код URI переданного файла. |
| BlobName |Имя переданного файла. |
| LastUpdatedTime |Метка времени, указывающая, когда файл был в последний раз обновлен. |
| BlobSizeInBytes |Размер переданного файла. |

**Пример.** В этом примере показан текст уведомления об отправке файла.

```json
{
    "deviceId":"mydevice",
    "blobUri":"https://{storage account}.blob.core.windows.net/{container name}/mydevice/myfile.jpg",
    "blobName":"mydevice/myfile.jpg",
    "lastUpdatedTime":"2016-06-01T21:22:41+00:00",
    "blobSizeInBytes":1234,
    "enqueuedTimeUtc":"2016-06-01T21:22:43.7996883Z"
}
```

## <a name="file-upload-notification-configuration-options"></a>Параметры конфигурации уведомлений об отправке файла

В каждом центре Интернета вещей есть перечисленные ниже параметры конфигурации уведомлений об отправке файлов.

| Свойство. | Описание | Диапазон и значение по умолчанию |
| --- | --- | --- |
| **enableFileUploadNotifications** |Позволяет указать, следует ли записывать уведомления об отправке файлов в конечную точку файловых уведомлений. |Bool. По умолчанию: True. |
| **fileNotifications.ttlAsIso8601** |Значение TTL по умолчанию для уведомлений об отправке файлов. |Интервал ISO_8601 — до 48 часов (минимум 1 минута). Значение по умолчанию — 1 час. |
| **fileNotifications.lockDuration** |Длительность блокировки для очереди уведомлений об отправке файлов. |5–300 секунд (минимум 5 секунд). Значение по умолчанию — 60 секунд. |
| **fileNotifications.maxDeliveryCount** |Максимальное количество доставок для очереди уведомлений об отправке файлов. |От 1 до 100. Значение по умолчанию — 100. |

Эти свойства можно задать в центре Интернета вещей с помощью портал Azure, Azure CLI или PowerShell. Дополнительные сведения см. в разделах, посвященных [настройке передачи файлов](iot-hub-configure-file-upload.md).

## <a name="additional-reference-material"></a>Дополнительные справочные материалы

Другие справочные статьи в руководстве разработчика для Центра Интернета вещей:

* В [руководстве по конечным точкам центра Интернета вещей](iot-hub-devguide-endpoints.md) описаны различные конечные точки центра Интернета вещей для операций управления и среды выполнения.

* Руководство [Квоты и регулирование в Центре Интернета вещей](iot-hub-devguide-quotas-throttling.md) содержит сведения о квотах, применимых к службе Центра Интернета вещей, и поведении регулирования.

* В статье о [пакетах SDK для устройств и служб Azure IoT](iot-hub-devguide-sdks.md) указаны различные языковые пакеты SDK, которые можно использовать при разработке приложений для устройств и служб, взаимодействующих с Центром Интернета вещей.

* В статье [Язык запросов Центра Интернета вещей для двойников устройств и двойников модулей, заданий и маршрутизации сообщений](iot-hub-devguide-query-language.md) описывается язык запросов, который можно использовать для получения сведений о двойниках устройств и заданиях из Центра Интернета вещей.

* Статья [Взаимодействие с Центром Интернета вещей с помощью протокола MQTT](iot-hub-mqtt-support.md) содержит дополнительные сведения о поддержке протокола MQTT в Центре Интернета вещей.

## <a name="next-steps"></a>Дальнейшие действия

Теперь, когда вы узнали, как отправлять файлы с устройств с помощью центра Интернета вещей, вас могут заинтересовать следующие статьи в руководстве разработчика для центра Интернета вещей.

* [Управление удостоверениями устройств в Центре Интернета вещей](iot-hub-devguide-identity-registry.md)

* [Управление доступом к Центру Интернета вещей](iot-hub-devguide-security.md)

* [Общие сведения о двойниках устройств и их использование в Центре Интернета вещей](iot-hub-devguide-device-twins.md)

* [Общие сведения о прямых методах и информация о вызове этих методов из Центра Интернета вещей](iot-hub-devguide-direct-methods.md)

* [Планирование заданий на нескольких устройствах](iot-hub-devguide-jobs.md)

Чтобы применить некоторые основные понятия, описанные в этой статье, просмотрите следующие руководства по Центру Интернета вещей:

* [Передача файлов с устройства в облако с помощью Центра Интернета вещей и .NET](iot-hub-csharp-csharp-file-upload.md)