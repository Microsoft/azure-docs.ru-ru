---
title: Классический IP-фильтр центра Интернета вещей Azure (не рекомендуется) | Документация Майкрософт
description: Как выполнить обновление с помощью классической IP-фильтра и каковы преимущества
author: jlian
ms.service: iot-hub
services: iot-hub
ms.topic: conceptual
ms.date: 10/16/2020
ms.author: jlian
ms.openlocfilehash: 6f326bafb311acedc48c5a349c78f1cd6bcebc87
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "101661160"
---
# <a name="iot-hub-classic-ip-filter-and-how-to-upgrade"></a>Классический IP-фильтр центра Интернета вещей и обновление 

Обновленный IP-фильтр для центра Интернета вещей защищает встроенную конечную точку и защищен по умолчанию. Хотя мы стремимся никогда не вносить критические изменения, улучшенная модель безопасности обновленного IP-фильтра несовместима с классическим IP-фильтром, поэтому мы объявляем свое прекращение. Дополнительные сведения о новом обновленном IP-фильтре см. в разделе [новые возможности](#whats-new) и [IP-фильтры центра Интернета вещей](iot-hub-ip-filtering.md).

Чтобы избежать прерывания работы служб, необходимо выполнить интерактивное обновление до наступления крайнего срока миграции, после чего обновление будет выполнено автоматически. Дополнительные сведения о временной шкале миграции см. в [статье обновление Azure](https://aka.ms/ipfilterv2azupdate).

## <a name="how-to-upgrade"></a>Обновление

1.  Посетите портал Azure
2.  Перейдите в Центр Интернета вещей.
3.  В меню слева выберите **сеть** .
4.  Вы увидите баннер с предложением обновить IP-фильтр до новой модели. Щелкните **Да**, чтобы продолжить.
    :::image type="content" source="media/iot-hub-ip-filter-classic/ip-filter-upgrade-banner.png" alt-text="Изображение с запросом заголовка для обновления с помощью классического IP-фильтра":::
5.  Поскольку новый IP-фильтр блокирует все IP-адреса по умолчанию, обновление удаляет индивидуальные правила блокировки, но дает возможность просматривать их перед сохранением. Внимательно проверьте правила, чтобы убедиться, что они работают за вас.
6.  Следуйте инструкциям на экране, чтобы завершить обновление.

## <a name="whats-new"></a>Новое

### <a name="secure-by-default"></a>Обеспечение безопасности по умолчанию

Классический IP-фильтр неявно разрешает всем IP-адресам подключаться к центру Интернета вещей по умолчанию, что не хорошо соответствует наиболее распространенным сценариям безопасности сети. Как правило, необходимо, чтобы только доверенные IP-адреса могли подключаться к центру Интернета вещей и отклонять все остальное. Для достижения этой цели с помощью классического IP-фильтра это многоэтапный процесс. Например, если вы хотите принимать трафик только от `192.168.100.0/22` , необходимо

1. Настройте одно *разрешающее* правило для `192.168.100.0/22` .
1. Настройка другого правила *блокировки* для `0.0.0.0/0` (правило "блокировать все")
1. Убедитесь, что правила упорядочены правильно, с разрешающим правилом, упорядоченным над правилом блокировки.

На практике этот многошаговый процесс приводит к путанице. Пользователи не настроили правило "блокировать все" или не упорядочивают правила правильно, что приводит к непредвиденному раскрытию. 

Новый IP-фильтр блокирует все IP-адреса по умолчанию. Только явно добавленные диапазоны IP-адресов могут подключаться к центру Интернета вещей. В приведенном выше примере больше не требуется выполнить шаги 2 и 3. Это новое поведение упрощает настройку и придерживается по [принципу безопасности по умолчанию](https://wikipedia.org/wiki/Secure_by_default).

### <a name="protect-the-built-in-event-hub-compatible-endpoint"></a>Защита встроенной конечной точки концентратора событий

Классический IP-фильтр нельзя применить к встроенной конечной точке. Это ограничение означает, что событие с настроенным правилом "блокировать все" (блокировать все `0.0.0.0/0` ) встроенная конечная точка по-прежнему доступна с любого IP-адреса.

Новый IP-фильтр предоставляет возможность применить правила к встроенной конечной точке, что снижает вероятность возникновения угроз безопасности сети.

:::image type="content" source="media/iot-hub-ip-filter-classic/ip-filter-built-in-endpoint.png" alt-text="Изображение, показывающее переключатель для применения к встроенной конечной точке":::

> [!NOTE]
> Этот параметр недоступен для бесплатных центров Интернета вещей (F1). Чтобы применить правила фильтрации IP-адресов к встроенной конечной точке, используйте платный центр Интернета вещей.

### <a name="api-impact"></a>Воздействие на API

Обновленный IP-фильтр доступен в API ресурсов центра Интернета вещей `2020-08-31` (как `2020-08-31-preview` и), а также в перенаправлении. Классический IP-фильтр по-прежнему доступен во всех версиях API, но будет удален в будущей версии API рядом с крайним сроком миграции. Дополнительные сведения о временной шкале миграции см. в [статье обновление Azure](https://aka.ms/ipfilterv2azupdate).

## <a name="tip-try-the-changes-before-they-apply"></a>Совет. Попробуйте внести изменения, прежде чем они будут применены

Поскольку новый IP-фильтр блокирует все IP-адреса по умолчанию, правила отдельных блоков больше не совместимы. Таким образом, процесс интерактивного обновления удаляет эти индивидуальные правила блоков. 

Чтобы попробовать изменить с помощью классической IP-фильтрации, выполните следующие действия.

1. Перейдите на вкладку " **сеть** " в центре Интернета вещей.
1. Запишите существующую конфигурацию IP-фильтра (классической), если вы хотите выполнить откат
1. Рядом с правилами с **блоком** щелкните значок корзины, чтобы удалить их.
1. Добавьте еще одно правило в нижнюю часть с `0.0.0.0/0` и выберите **блок**
1. Нажмите кнопку **Сохранить**.

Эта конфигурация имитирует поведение нового IP-фильтра после обновления классической версии. Единственным исключением является встроенная защита конечных точек, которая не позволяет использовать классический IP-фильтр. Однако эта функция является необязательной, поэтому ее не нужно использовать, если вы считаете, что она может нарушить работу.

## <a name="tip-check-diagnostic-logs-for-all-ip-connections-to-your-iot-hub"></a>Совет. Проверьте журналы диагностики для всех IP-подключений к центру Интернета вещей.

Чтобы обеспечить плавный переход, проверьте журналы диагностики в категории "подключения". Найдите свойство, `maskedIpAddress` чтобы узнать, не являются ли диапазоны желаемыми. Помните: новый IP-фильтр будет блокировать все IP-адреса, которые не были добавлены явным образом.

## <a name="iot-hub-classic-ip-filter-documentation-retired"></a>Документация по классической IP-фильтрации центра Интернета вещей (с снятым с учета)

> [!IMPORTANT]
> Ниже приведена исходная документация по классическому IP-фильтру, которая будет прекращена.

Безопасность является важным аспектом любого решения Интернета вещей на базе Центра Интернета вещей Azure. Иногда при настройке системы безопасности необходимо явно указать IP-адреса, с которых могут подключаться устройства. Функция *фильтрации IP-адресов* позволяет настроить правила для отклонения или приема трафика с определенных IPv4-адресов.

### <a name="when-to-use"></a>Назначение

Есть два конкретных варианта применения этой функции, когда рекомендуется заблокировать конечные точки Центра Интернета вещей для определенных IP-адресов:

* Центр Интернета вещей должен принимать трафик только из определенного диапазона IP-адресов и отклонять весь остальной трафик. Допустим, что Центр Интернета вещей используется в сочетании с [Azure Express Route](../expressroute/expressroute-faqs.md#supported-services) для создания частных подключений между Центром Интернета вещей и локальной инфраструктурой.

* В этом случае требуется отклонять трафик с IP-адресов, которые были определены администратором Центра Интернета вещей как подозрительные.

### <a name="how-filter-rules-are-applied"></a>Применение правил фильтрации

Правила фильтрации IP-адресов применяются на уровне службы Центра Интернета вещей. Поэтому они действуют для всех подключений с устройств и внутренних приложений, использующих любые поддерживаемые протоколы. Однако клиенты, использующие [встроенную конечную точку, совместимую с концентратором событий](iot-hub-devguide-messages-read-builtin.md) (а не строку подключения к Центру Интернета вещей), не привязаны к правилам фильтрации IP-адресов. 

При попытке подключения с IP-адреса, который соответствует правилу отклонения IP-адресов в Центре Интернета вещей, пользователь получает сообщение об ошибке с кодом состояния 401 (Не авторизовано) и описанием. В ответном сообщении не указывается правило фильтрации IP-адресов. Отклонение IP-адресов может препятствовать взаимодействию других служб Azure (таких как Azure Stream Analytics, виртуальные машины Azure или обозреватель устройств на портале Azure) с Центром Интернета вещей.

> [!NOTE]
> Если для чтения сообщений из Центра Интернета вещей с включенной IP-фильтрацией требуется использовать Azure Stream Analytics (ASA), используйте совместимые с концентратором событий имя и конечную точку, чтобы вручную добавить [входные данные потока центров событий](../stream-analytics/stream-analytics-define-inputs.md#stream-data-from-event-hubs) в ASA.

### <a name="default-setting"></a>Параметр по умолчанию

По умолчанию раздел **Фильтрация IP-адресов** на портале для Центра Интернета вещей пуст. Этот означает, что по умолчанию центр принимает подключения с любых IP-адресов. То есть, такое значение параметра по умолчанию равноценно правилу, которое принимает диапазон IP-адресов 0.0.0.0/0.

Чтобы перейти на страницу параметров фильтрации IP-адресов, выберите **Сеть**, **Общий доступ**, а затем **Выбранные диапазоны IP-адресов**:

:::image type="content" source="media/iot-hub-ip-filter-classic/ip-filter-default.png" alt-text="Параметры фильтрации IP-адресов по умолчанию для Центра Интернета вещей":::

### <a name="add-or-edit-an-ip-filter-rule"></a>Добавление или изменение правила фильтрации IP-адресов

Чтобы добавить правило фильтрации IP-адресов, выберите **+ Добавить правило фильтрации IP-адресов**.

:::image type="content" source="./media/iot-hub-ip-filter-classic/ip-filter-add-rule.png" alt-text="Добавление правила фильтрации IP-адресов в Центр Интернета вещей":::

После выбора параметра **Добавить правило фильтрации IP-адресов** заполните поля.

:::image type="content" source="./media/iot-hub-ip-filter-classic/ip-filter-after-selecting-add.png" alt-text="После выбора параметра &quot;Добавить правило фильтрации IP-адресов&quot;":::

* Укажите **имя** правила фильтрации IP-адресов. Оно должно быть уникальной строкой буквенно-цифровых символов длиной не более 128 символов без учета регистра. Допускаются только 7-разрядные буквы и цифры ASCII, а также `{'-', ':', '/', '\', '.', '+', '%', '_', '#', '*', '?', '!', '(', ')', ',', '=', '@', ';', '''}`.

* Укажите один IPv4-адрес или блок IP-адресов в нотации CIDR. Например, в нотации CIDR 192.168.100.0/22 обозначает диапазон из 1024 IPv4-адресов от 192.168.100.0 до 192.168.103.255.

* В качестве **действия** для правила фильтрации IP-адресов выберите **Разрешить** или **Блокировать**.

После заполнения полей выберите **Сохранить**, чтобы сохранить правило. Появится предупреждение о том, что выполняется обновление.

:::image type="content" source="./media/iot-hub-ip-filter-classic/ip-filter-save-new-rule.png" alt-text="Уведомление о сохранении правила фильтрации IP-адресов":::

Параметр **Добавить** становится неактивным, когда достигается максимальное число правил фильтрации IP-адресов (10).

Чтобы изменить существующее правило, выберите данные, которые необходимо изменить, внесите изменения, а затем выберите **Сохранить**, чтобы сохранить изменения.

### <a name="delete-an-ip-filter-rule"></a>Удаление правила фильтрации IP-адресов

Чтобы удалить правило фильтрации IP-адресов, выберите значок корзины в этой строке, а затем выберите **Сохранить**. Правило удаляется, а изменения сохраняются.

:::image type="content" source="./media/iot-hub-ip-filter-classic/ip-filter-delete-rule.png" alt-text="Удаление правила фильтрации IP-адресов в Центре Интернета вещей":::

### <a name="retrieve-and-update-ip-filters-using-azure-cli"></a>Получение и обновление фильтров IP-адресов с помощью Azure CLI

Фильтры IP-адресов Центра Интернета вещей можно получать и обновлять с помощью [интерфейса командной строки Azure](/cli/azure/).

Чтобы получить текущие фильтры IP-адресов Центра Интернета вещей, выполните следующую команду:

```azurecli-interactive
az resource show -n <iothubName> -g <resourceGroupName> --resource-type Microsoft.Devices/IotHubs
```

Она возвратит объект JSON, в котором ваши имеющиеся фильтры IP-адресов отображаются в разделе `properties.ipFilterRules`:

```json
{
...
    "properties": {
        "ipFilterRules": [
        {
            "action": "Reject",
            "filterName": "MaliciousIP",
            "ipMask": "6.6.6.6/6"
        },
        {
            "action": "Allow",
            "filterName": "GoodIP",
            "ipMask": "131.107.160.200"
        },
        ...
        ],
    },
...
}
```

Чтобы добавить новый фильтр IP-адреса для Центра Интернета вещей, выполните следующую команду:

```azurecli-interactive
az resource update -n <iothubName> -g <resourceGroupName> --resource-type Microsoft.Devices/IotHubs --add properties.ipFilterRules "{\"action\":\"Reject\",\"filterName\":\"MaliciousIP\",\"ipMask\":\"6.6.6.6/6\"}"
```

Чтобы удалить имеющийся фильтр IP-адреса в Центре Интернета вещей, выполните следующую команду:

```azurecli-interactive
az resource update -n <iothubName> -g <resourceGroupName> --resource-type Microsoft.Devices/IotHubs --add properties.ipFilterRules <ipFilterIndexToRemove>
```

Обратите внимание, что `<ipFilterIndexToRemove>` должен соответствовать порядковому номеру IP-фильтра в Центре Интернета вещей раздела `properties.ipFilterRules`.

### <a name="retrieve-and-update-ip-filters-using-azure-powershell"></a>Получение и обновление фильтров IP-адресов с помощью Azure PowerShell

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

Фильтры IP-адресов Центра Интернета вещей можно получать и обновлять с помощью [Azure PowerShell](/powershell/azure/).

```powershell
# Get your IoT Hub resource using its name and its resource group name
$iothubResource = Get-AzResource -ResourceGroupName <resourceGroupNmae> -ResourceName <iotHubName> -ExpandProperties

# Access existing IP filter rules
$iothubResource.Properties.ipFilterRules |% { Write-host $_ }

# Construct a new IP filter
$filter = @{'filterName'='MaliciousIP'; 'action'='Reject'; 'ipMask'='6.6.6.6/6'}

# Add your new IP filter rule
$iothubResource.Properties.ipFilterRules += $filter

# Remove an existing IP filter rule using its name, e.g., 'GoodIP'
$iothubResource.Properties.ipFilterRules = @($iothubResource.Properties.ipFilterRules | Where 'filterName' -ne 'GoodIP')

# Update your IoT Hub resource with your updated IP filters
$iothubResource | Set-AzResource -Force
```

### <a name="update-ip-filter-rules-using-rest"></a>Обновление правил фильтра IP-адреса с помощью REST

Вы также можете получать и изменять фильтры IP-адресов Центра Интернета вещей, используя конечную точку REST поставщика ресурсов Azure. Подробные сведения о `properties.ipFilterRules` см. в статье [Iot Hub Resource — Create Or Update](/rest/api/iothub/iothubresource/createorupdate) (Ресурс Центра Интернета вещей. Создание или обновление).

### <a name="ip-filter-rule-evaluation"></a>Оценка правила фильтрации IP-адресов

Правила фильтрации IP-адресов применяются по порядку, поэтому первое правило, которое соответствует IP-адресу, определяет действие (принять или отклонить).

Например, если вы хотите, чтобы адреса в диапазоне 192.168.100.0/22 принимались, а все остальные отклонялись, то первым правилом в списке должно быть именно правило о приеме трафика из диапазона адресов 192.168.100.0/22. Следующим должно быть правило об отклонении всех адресов; для этого используется диапазон 0.0.0.0/0.

Последовательность правил фильтрации IP-адресов в списке можно изменить. Для этого щелкните три вертикальные точки в начале строки и воспользуйтесь функцией перетаскивания.

Чтобы сохранить новую последовательность, нажмите кнопку **Сохранить**.

:::image type="content" source="media/iot-hub-ip-filter-classic/ip-filter-rule-order.png" alt-text="Изменение порядка правил фильтрации IP-адресов центра Интернета вещей":::

## <a name="next-steps"></a>Дальнейшие действия

Для дальнейшего изучения возможностей Центра Интернета вещей см. следующие статьи:

* [Использование фильтрации IP-адресов](iot-hub-ip-filtering.md)