---
title: Руководство. Просмотр результатов маршрутизации сообщений Центра Интернета вещей Azure (.NET) | Документация Майкрософт
description: Руководство. После настройки всех ресурсов с помощью части 1 этого руководства добавьте возможность перенаправлять сообщения в Azure Stream Analytics и просматривать результаты в Power BI.
author: robinsh
manager: philmea
ms.service: iot-hub
services: iot-hub
ms.topic: tutorial
ms.date: 03/25/2018
ms.author: robinsh
ms.custom: mvc, devx-track-csharp
ms.openlocfilehash: f441a1cf97c069c4755b436bbb8cb9268b469eb3
ms.sourcegitcommit: dda0d51d3d0e34d07faf231033d744ca4f2bbf4a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/05/2021
ms.locfileid: "102199753"
---
# <a name="tutorial-part-2---view-the-routed-messages"></a>Руководство по Часть 2. Просмотр маршрутизированных сообщений

[!INCLUDE [iot-hub-include-routing-intro](../../includes/iot-hub-include-routing-intro.md)]

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

## <a name="rules-for-routing-the-messages"></a>Правила маршрутизации сообщений

Ниже описаны правила для маршрутизации сообщений. Они были определены в части 1 этого руководства, чтобы вы могли их использовать во второй.

|Значение |Результат|
|------|------|
|level="storage" |Запись в хранилище Azure.|
|level="critical" |Запись в очередь служебной шины. Приложение логики извлекает сообщение из очереди и использует Office 365 для отправки сообщения по электронной почте.|
|значение по умолчанию |Отобразите эти данные с помощью Power BI.|

Теперь необходимо создать ресурсы, к которым будут маршрутизироваться сообщения, запустить приложение для отправки сообщений в концентратор и оценить ход выполнения маршрутизации.

## <a name="create-a-logic-app"></a>Создание приложения логики  

Очередь служебной шины должна использоваться для приема сообщений, обозначенных как критические. Настройте приложение логики для мониторинга очереди служебной шины и отправки электронного письма, когда сообщение добавлено в очередь.

1. На [портале Azure](https://portal.azure.com) щелкните **+Создать ресурс**. Поместите **Приложение логики** в поле поиска и нажмите клавишу ВВОД. В отображаемых результатах поиска выберите приложение логики, затем щелкните **Создать**, чтобы перейти к панели **Создание приложения логики**. Заполните поля.

   **Name** (Имя). Это поле имени приложения логики. В этом руководстве используется **ContosoLogicApp**.

   **Подписка**: Выберите подписку Azure.

   **Группа ресурсов.** Щелкните **Использовать существующую** и выберите свою группу ресурсов. В этом руководстве используется **ContosoResources**.

   **Расположение.** Укажите свое расположение. В этом руководстве используется **Западная часть США**.

   **Enable Log Analytics** (Включить Log Analytics). Этот переключатель должен быть выключен.

   ![Экран создания приложения логики](./media/tutorial-routing-view-message-routing-results/create-logic-app.png)

   Нажмите кнопку **создания**. На развертывание приложения может потребоваться несколько минут.

2. Теперь перейдите в приложение логики. Самый простой способ получить приложение логики — щелкнуть **Группы ресурсов**, выбрать группу ресурсов (в этом руководстве используется **ContosoResources**), а затем выбрать в списке ресурсов приложение логики. 

    Появится страница конструктора Logic Apps (может потребоваться прокрутить вправо для просмотра всей страницы). На странице конструктора Logic Apps прокрутите вниз, пока не увидите плитку с надписью **Пустое приложение логики+** . Щелкните ее. Вкладка по умолчанию — "Для вас". Если эта панель пустая, щелкните **Все**, чтобы увидеть все доступные соединители и триггеры.

3. Выберите в списке соединителей **Служебная шина**.

   ![Список соединителей](./media/tutorial-routing-view-message-routing-results/logic-app-connectors.png)

4. Отобразится список триггеров. Выберите **При получении сообщения в очереди (автозавершение) / Служебная шина**.

   ![Список триггеров для служебной шины.](./media/tutorial-routing-view-message-routing-results/logic-app-triggers.png)

5. На следующем экране введите имя подключения. В этом руководстве используется **ContosoConnection**.

   ![Настройка подключения для очереди служебной шины](./media/tutorial-routing-view-message-routing-results/logic-app-define-connection.png)

   Выберите пространство имен служебной шины. В этом руководстве используется **ContosoSBNamespace**. При выборе пространства имен портал запрашивает пространство имен служебной шины для извлечения ключей. Выберите **RootManageSharedAccessKey** и щелкните **Создать**.

   ![Завершение настройки подключения](./media/tutorial-routing-view-message-routing-results/logic-app-finish-connection.png)

6. На следующем экране из раскрывающегося списка выберите имя очереди (в этом руководстве используется **contososbqueue**). Можно использовать значения по умолчанию для остальных полей.

   ![Параметры очереди](./media/tutorial-routing-view-message-routing-results/logic-app-queue-options.png)

7. Теперь настройте действие для отправки сообщений электронной почты, когда очередь получила сообщение. В конструкторе приложений логики, выберите **+Новый шаг**, чтобы добавить шаг, а затем щелкните **Все**, чтобы увидеть все доступные параметры. На панели **Выбрать действие** найдите и щелкните **Office 365 Outlook**. На экране действия выберите **Отправить электронное письмо / Outlook Office 365**.  

   ![Параметры Office 365](./media/tutorial-routing-view-message-routing-results/logic-app-select-outlook.png)

8. Войдите в рабочую или учебную учетную запись, чтобы установить соединение. Если время ожидания истечет, просто повторите попытку. Укажите адреса электронной почты получателей сообщений электронной почты. Также укажите тему и введите текст сообщения, который увидит получатель. Для тестирования заполните свой собственный адрес электронной почты в качестве получателя.

   Щелкните **Добавить динамическое содержимое**, чтобы отобразить содержимое сообщения, которое можно включить. Выберите **Содержимое** — оно будет содержать сообщение по электронной почте.

   ![Параметры электронной почты для приложения логики](./media/tutorial-routing-view-message-routing-results/logic-app-send-email.png)

9. Щелкните **Сохранить**. Затем закройте конструктор Logic App.

## <a name="set-up-azure-stream-analytics"></a>Настройка Azure Stream Analytics

Чтобы просмотреть данные в визуализации Power BI, прежде всего настройте задание Stream Analytics для извлечения данных. Помните, что в конечную точку по умолчанию отправляются только те сообщения, у которых параметр **level** имеет значение **normal**, и именно они будут извлекаться заданием Stream Analytics для визуализации Power BI.

### <a name="create-the-stream-analytics-job"></a>Создание задания Stream Analytics

1. На [портале Azure](https://portal.azure.com) последовательно выберите **Создать ресурс** > **Интернет вещей** > **Задание Stream Analytics**.

2. Введите представленные ниже сведения для задания.

   **Имя задания.** Имя задания. Оно должно быть глобально уникальным. В этом руководстве используется **contosoJob**.

   **Подписка**: Подписка Azure, используемая в этом руководстве.

   **Группа ресурсов.** Выберите ту же группу ресурсов, которую использует Центр Интернета вещей. В этом руководстве используется **ContosoResources**.

   **Расположение.** Используйте то же расположение, которое используется в сценарии установки. В этом руководстве используется **Западная часть США**.

   ![Создание задания Stream Analytics](./media/tutorial-routing-view-message-routing-results/stream-analytics-create-job.png)

3. Щелкните **Создать**, чтобы создать задание. Развертывание может занять несколько минут.

    Чтобы вернуться к заданию, щелкните **Группа ресурсов**. В этом руководстве используется **ContosoResources**. Выберите группу ресурсов и щелкните задание Stream Analytics в списке ресурсов.

### <a name="add-an-input-to-the-stream-analytics-job"></a>Добавление входных данных в задание Stream Analytics

1. В разделе **Топология задания** выберите **Входные данные**.

2. На панели **Входные данные**, щелкните **Добавить потоковый вход** и выберите Центр Интернета вещей. На появившемся экране заполните следующие поля:

   **Входной псевдоним.** В этом руководстве используется **contosoinputs**.

   **Выбрать Центр Интернета вещей в подписке**. Установите этот переключатель.

   **Подписка**: Выберите подписку Azure, используемую в этом руководстве.

   **Центр Интернета вещей.** Выберите Центр Интернета вещей. В этом руководстве используется **ContosoTestHub**.

   **Конечная точка**. Выберите **Сообщения**. (При выборе "мониторинг операций", вы получите данные телеметрии Центра IoT, а не данные, которые вы отправляете через него.) 

   **Имя политики общего доступа.** Выберите пункт **Служба**. Портал заполняет ключ политики совместного доступа для вас.

   **Группа потребителей.** Выберите группу потребителей, настроенную в части 1 этого руководства. В этом руководстве используется **contosoconsumers**.
   
   Для остальных полей примите параметры по умолчанию. 

   ![Настройка входных данных для задания Stream Analytics](./media/tutorial-routing-view-message-routing-results/stream-analytics-job-inputs.png)

3. Щелкните **Сохранить**.

### <a name="add-an-output-to-the-stream-analytics-job"></a>Добавление выходных данных в задание Stream Analytics

1. В разделе **Топология задания** выберите **Выходные данные**.

2. На панели **Выходные данные** щелкните **Добавить** и выберите **Power BI**. На появившемся экране заполните следующие поля:

   **Выходной псевдоним.** Уникальный псевдоним для выходных данных. В этом руководстве используется **contosooutputs**. 

   **Имя набора данных.** Имя набора данных для использования в Power BI. В этом руководстве используется **contosodataset**. 

   **Имя таблицы.** Имя таблицы для использования в Power BI. В этом руководстве используется **contosotable**.

  **Режим проверки подлинности**: выберите нужный режим.

   Для остальных полей оставьте значения по умолчанию.

3. Щелкните **Авторизовать** и войдите в учетную запись Power BI. (Возможно, вы выполните несколько попыток.)

   ![Настройка выходных данных для задания Stream Analytics](./media/tutorial-routing-view-message-routing-results/stream-analytics-job-outputs.png)

4. Щелкните **Сохранить**.

### <a name="configure-the-query-of-the-stream-analytics-job"></a>Настройка запроса задания Stream Analytics

1. В разделе **Топология задания** выберите **Запрос**.

2. Замените значение `[YourInputAlias]` значением псевдонима входных данных задания. В этом руководстве используется **contosoinputs**.

3. Замените значение `[YourOutputAlias]` значением псевдонима выходных данных задания. В этом руководстве используется **contosooutputs**.

   ![Настройка очереди для задания Stream Analytics](./media/tutorial-routing-view-message-routing-results/stream-analytics-job-query.png)

4. Щелкните **Сохранить**.

5. Закройте панель запроса. Это действие вернет вас в представление ресурсов в группе ресурсов. Выберите задание Stream Analytics. В этом руководстве оно имеет имя **contosoJob**.

### <a name="run-the-stream-analytics-job"></a>Выполнение задания Stream Analytics

В задании Stream Analytics щелкните **Запуск** > **Сейчас** > **Запустить**. После успешного запуска состояние задания **Остановлено** изменится на **Выполняется**.

Чтобы настроить отчет Power BI, нужны данные. Поэтому настройка Power BI будет происходить после создания устройства и запуска приложения имитации устройства.

## <a name="run-simulated-device-app"></a>Запуск приложения имитированного устройства

В части 1 этого руководства было описано, как настроить устройство для моделирования с помощью устройства Интернета вещей. В этом разделе описано, как скачать консольное приложение .NET, которое имитирует это устройство, отправляя сообщения между устройством и облаком в Центр Интернета вещей (если вы еще не скачали приложение и ресурсы, описанные в части 1 руководства).

Это приложение отправляет сообщения для каждого из методов маршрутизации. Кроме того, в скачиваемых ресурсах есть папка, которая содержит полный шаблон Azure Resource Manager и файл параметров, а также скрипты Azure CLI и PowerShell.

Если вы еще не скачивали файлы из репозитория, как описано в части 1 этого руководства, скачайте их на странице [симулятора устройств Интернета вещей](https://github.com/Azure-Samples/azure-iot-samples-csharp/archive/master.zip). Когда вы щелкнете эту ссылку, начнется скачивание репозитория с несколькими приложениями. Нужное решение — это файл iot-hub/Tutorials/Routing/IoT_SimulatedDevice.sln. 

Дважды щелкните файл решения (IoT_SimulatedDevice.sln), чтобы открыть код в Visual Studio, а затем откройте файл Program.cs. Замените `{your hub name}` на имя узла Центра IoT. Формат имени узла Центра IoT **{iot-hub-name}.azure-devices.net**. В этом руководстве имя узла концентратора **ContosoTestHub.azure-devices.net**. Затем замените `{your device key}` ранее сохраненным ключом устройства при настройке имитированного устройства. 

   ```csharp
        static string s_myDeviceId = "Contoso-Test-Device";
        static string s_iotHubUri = "ContosoTestHub.azure-devices.net";
        // This is the primary key for the device. This is in the portal. 
        // Find your IoT hub in the portal > IoT devices > select your device > copy the key. 
        static string s_deviceKey = "{your device key}";
   ```

## <a name="run-and-test"></a>Запуск и тестирование

Запустите консольное приложение. Подождите несколько минут. Вы увидите сообщения, отправленные на экран консоли приложения.

Приложение отправляет новое сообщение с устройства в облако к Центру IoT каждую секунду. Сообщение содержит JSON-сериализованный объект с идентификатором устройства, температурой, влажностью и уровнем сообщений, значение которого по умолчанию `normal`. Случайным образом назначается уровень `critical` или `storage`, вызывая сообщение, которое направляется в учетную запись хранения или в очередь служебной шины (которая запускает приложение логики для отправки сообщения электронной почты). Показания по умолчанию (`normal`) будут отображаться в отчете бизнес-аналитики, которая настроится позже.

Если все настроено правильно, на этом этапе можно увидеть следующие результаты:

1. Вы начинаете получать сообщения о критических сообщениях.

   ![Результат: сообщение электронной почты](./media/tutorial-routing-view-message-routing-results/results-in-email.png)

   Этот результат означает, что выполнены следующие условия: 

   * Маршрутизация в очередь служебной шины работает правильно.
   * Приложение логики, получающее сообщение из очереди служебной шины, работает правильно.
   * Соединитель приложения логики для Outlook работает правильно. 

2. На [портале Azure](https://portal.azure.com) щелкните **Группы ресурсов** и выберите группу ресурсов. В этом руководстве используется **ContosoResources**. 

    Выберите учетную запись хранения, щелкните **Контейнеры** и выберите контейнер. В этом руководстве используется **contosoresults**. Должна появиться папка, и можно выполнить детализацию по каталогах пока не найдется один или несколько файлов. Откройте один из этих файлов. Они содержат записи, направляемые в учетную запись хранилища. 

   ![Результат: файлы в хранилище](./media/tutorial-routing-view-message-routing-results/results-in-storage.png)

Этот результат означает, что выполнено следующее условие:

   * Маршрутизация к учетной записи хранения работает правильно.

Теперь, не останавливая приложение, настройте визуализацию Power BI, чтобы увидеть сообщения, поступающие через маршруты по умолчанию.

## <a name="set-up-the-power-bi-visualizations"></a>Настройка визуализаций Power BI

1. Выполните вход в учетную запись [Power BI](https://powerbi.microsoft.com/).

2. Перейдите в **Рабочие области** и выберите рабочую область, которая устанавливается при создании вывода для задания Stream Analytics. В этом руководстве используется **Моя рабочая область**. 

3. Щелкните **Наборы данных**. Если у вас нет наборов данных, подождите несколько минут и проверьте еще раз.

   Вы должны увидеть набор данных, указанный при создании выходных данных для задания Stream Analytics. В этом руководстве используется **contosodataset**. (Это может занять 5–10 минут для отображения набора данных в первый раз.)

4. В разделе **Действия** щелкните первый значок, чтобы создать отчет.

   ![Рабочая область Power BI с выделенными меню действий и значком отчета](./media/tutorial-routing-view-message-routing-results/power-bi-actions.png)

5. Создайте график для отображения данных температуры в реальном времени за определенный период времени.

   * На странице создания отчетов добавьте график, щелкнув значок графика.

     ![Визуализации и поля](./media/tutorial-routing-view-message-routing-results/power-bi-visualizations-and-fields.png)

   * В области **Поля** разверните таблицу, указанную при создании выходных данных для задания Stream Analytics. В этом руководстве используется **contosotable**.

   * Перетащите элемент **EventEnqueuedUtcTime** на **ось** в области **Визуализации**.

   * Перетащите элемент **температура** в раздел **Значения** той же области.

   График создан. Ось Х отображает дату и время в часовом поясе UTC. Ось Y отображает данные температуры, полученные от датчика.

6. Создайте другой график для отображения влажности в реальном времени за определенный период времени. Чтобы настроить вторую диаграмму, выполните те же действия для первой диаграммы, поместив **EventEnqueuedUtcTime** на ось X (**ось**) и **humidity** на ось Y (**значения**).

   ![Итоговый отчет Power BI с двумя графиками](./media/tutorial-routing-view-message-routing-results/power-bi-report.png)

7. Чтобы сохранить отчет, нажмите кнопку **Сохранить** и при появлении запроса введите имя отчета.

Вы сможете просматривать данные на обоих графиках. Этот результат означает, что выполнены следующие условия:

   * Маршрутизация в конечной точке по умолчанию работает правильно.
   * Задание Azure Stream Analytics выполняется правильно.
   * Визуализация Power BI настроена правильно.

Чтобы увидеть последние данные, можно обновить графики, щелкнув "Обновить" в верхней части окна Power BI. 

## <a name="clean-up-resources"></a>Очистка ресурсов 

Чтобы удалить все ресурсы, созданные при работе с двумя частями этого руководства, удалите группу ресурсов. При этом будут также удалены все ресурсы, содержащиеся в группе. В этом случае действие удаляет Центр IoT, пространство имен служебной шины и очереди, приложение логики, учетную запись хранения и саму группу ресурсов. Вы можете также удалить ресурсы Power BI и очистить сообщения электронной почты, отправленные в ходе работы с этим руководством.

### <a name="clean-up-resources-in-the-power-bi-visualization"></a>Очистка ресурсов в визуализации Power BI

Выполните вход в учетную запись [Power BI](https://powerbi.microsoft.com/). Перейдите в рабочую область. В этом руководстве используется **Моя рабочая область**. Чтобы удалить визуализацию Power BI, перейдите к наборам данных и щелкните значок корзины для удаления набора данных. В этом руководстве используется **contosodataset**. При удалении набора данных отчет будет также удален.

### <a name="use-the-azure-cli-to-clean-up-resources"></a>Очистка ресурсов с помощью Azure CLI

Чтобы удалить группу ресурсов, используйте команду [az group delete](/cli/azure/group#az-group-delete). Значение `$resourceGroup` было присвоено **ContosoResources** в начале работы с этим руководством.

```azurecli-interactive
az group delete --name $resourceGroup
```

### <a name="use-powershell-to-clean-up-resources"></a>Очистка ресурсов с помощью PowerShell

Чтобы удалить группу ресурсов, используйте команду [Remove-AzResourceGroup](/powershell/module/az.resources/remove-azresourcegroup). Значение `$resourceGroup` было присвоено **ContosoResources** в начале работы с этим руководством.

```azurepowershell-interactive
Remove-AzResourceGroup -Name $resourceGroup
```

### <a name="clean-up-test-emails"></a>Очистка тестовых сообщений электронной почты

Вы также можете удалить сообщения электронной почты в папке "Входящие", созданные с помощью приложения логики во время работы приложения устройства.

## <a name="next-steps"></a>Дальнейшие действия

Из второй части этого руководства вы узнали, как осуществить маршрутизацию сообщений Центра IoT в разные места назначения, выполняя следующие задачи.  

**Часть 1. Создание ресурсов, настройка маршрутизации сообщений**
> [!div class="checklist"]
> * Создание ресурсов: Центра Интернета вещей, учетной записи хранения, очереди служебной шины и имитированного устройства.
> * Настройка конечных точек и маршрутов сообщений в Центре Интернета вещей для учетной записи хранения и очереди служебной шины.

**Часть 2. Отправка сообщений в концентратор, просмотр результатов маршрутизации**
> [!div class="checklist"]
> * Создание приложения логики, которое запущено и отправляет сообщение по электронной почте, когда сообщение добавляется в очередь служебной шины.
> * Загрузка и запуск приложения, которое имитирует устройство IoT отправки сообщений в концентратор для различных параметров маршрутизации.
> * Создайте визуализацию Power BI для данных, отправляемых в конечную точку по умолчанию.
> * Просмотр результатов ...
> * ... в очереди служебной шины и в сообщениях электронной почты.
> * ... в учетной записи хранения.
> * ... в визуализации Power BI.

Перейдите к следующему руководству, чтобы узнать, как управлять состоянием устройств IoT. 

> [!div class="nextstepaction"]
> [Tutorial: Set up and use metrics and diagnostic logs with an IoT hub](tutorial-use-metrics-and-diags.md) (Руководство. Настройка и использование метрик и журналов диагностики с Центром Интернета вещей)