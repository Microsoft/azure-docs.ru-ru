---
title: Высокий уровень доступности и аварийное восстановление Центра Интернета вещей Azure | Документация Майкрософт
description: В статье описывается ряд возможностей Azure и Центра Интернета вещей для создания высокодоступных решений Интернета вещей Azure с функциями аварийного восстановления.
author: jlian
ms.service: iot-hub
services: iot-hub
ms.topic: conceptual
ms.date: 03/17/2020
ms.author: philmea
ms.openlocfilehash: 9d2ffac813456398c02066c978c37bdb09501aeb
ms.sourcegitcommit: a9ce1da049c019c86063acf442bb13f5a0dde213
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2021
ms.locfileid: "105628991"
---
# <a name="iot-hub-high-availability-and-disaster-recovery"></a>Высокая доступность и аварийное восстановление Центра Интернета вещей

Первый шаг, который архитекторы, разработчики и владельцы предприятий должны выполнить для реализации отказоустойчивого решения для Интернета вещей, — это определить цели доступности для создаваемых решений. Эти цели можно определить преимущественно на основе конкретных бизнес-целей для каждого сценария. В этом контексте в статье [Проектирование устойчивых приложений для Azure](/azure/architecture/resiliency/) описывается общая платформа, которая поможет вам понять непрерывность бизнес-процессов и аварийного восстановления. Статья об [аварийном восстановлении и высокой доступности для приложений Azure](/azure/architecture/reliability/disaster-recovery) представляет собой руководство об архитектуре со стратегиями, позволяющими обеспечить высокий уровень доступности и возможности аварийного восстановления для приложений Azure.

В этой статье рассматриваются функции обеспечения высокого уровня доступности и аварийного восстановления, предлагаемые конкретно службой Центра Интернета вещей. Особое внимание в этой статье уделено таким областям:

- Обеспечение высокого уровня доступности внутри региона
- Обеспечение возможности аварийного восстановления между регионами
- обеспечение высокого уровня доступности между регионами.

В зависимости от целей доступности, которые вы определяете для своих решений для Интернета вещей, нужно определить, какие из перечисленных ниже вариантов лучше всего соответствуют вашим бизнес-целям. Включение любой из этих альтернатив обеспечения высокого уровня доступности и аварийного восстановления в решение для Интернета вещей требует тщательной оценки компромиссов между:

- требуемым уровнем отказоустойчивости; 
- сложностью реализации и обслуживания;
- влиянием расходов COGS.

## <a name="intra-region-ha"></a>Обеспечение высокого уровня доступности внутри региона

Служба "Центр Интернета вещей" обеспечивает высокую доступность внутри регионов с помощью реализации избыточности почти во всех слоях службы. [Соглашение об уровне обслуживания, опубликованное службой "Центр Интернета вещей"](https://azure.microsoft.com/support/legal/sla/iot-hub) достигается за счет использования этой избыточности. Разработчикам решения для Интернета вещей не нужно выполнять дополнительную работу, чтобы воспользоваться преимуществами этих функций обеспечения высокого уровня доступности. Хотя Центр Интернета вещей предлагает достаточно высокую гарантию уровня доступности, как и в случае с любой распределенной вычислительной платформой можно ожидать временные сбои. Если вы только начинаете работу с переносом решений в облако из локального решения, вам нужно переместиться с оптимизации "среднее время между сбоями" и "среднее время восстановления". Другими словами, временные сбои считаются нормальными при работе с облаком в наборе. Чтобы справляться с временными сбоями, в компоненты, взаимодействующие с облачным приложением, должны быть встроены соответствующие [политики повтора](iot-hub-reliability-features-in-sdks.md).

> [!NOTE]
> Некоторые службы Azure также предоставляют дополнительные уровни доступности внутри региона путем интеграции с компонентом [Зоны доступности](../availability-zones/az-overview.md). Этот компонент в настоящее время не поддерживается службой Центра Интернета вещей.

## <a name="cross-region-dr"></a>Обеспечение возможности аварийного восстановления между регионами

Изредка могут случаться ситуации, когда в центре обработки данных наблюдаются длительные сбои из-за сбоев питания или других сбоев, связанных с физическими ресурсами. Во время таких редких событий обеспечение высокого уровня доступности внутри региона, описанное выше, не всегда может помочь. Центр Интернета вещей предоставляет несколько решений для восстановления после таких длительных сбоев. 

Возможности восстановления, доступные клиентам в такой ситуации, — это [инициированная корпорацией Майкрософт отработка отказа](#microsoft-initiated-failover) и [Переход на другой ресурс вручную](#manual-failover). Основное различие между ними состоит в том, что первый процесс инициирует корпорация Майкрософт, а второй — пользователь. Также переход на другой ресурс вручную обеспечивает меньшее целевое время восстановления (RTO) по сравнению с вариантом восстановления, инициируемым корпорацией Майкрософт. Определенное время RTO, предлагаемое в каждом отдельном случае, приводится ниже. При использовании любого из этих вариантов для отработки отказа Центра Интернета вещей из его основного региона все функции этого центра работают в соответствующем [географически связанном регионе Azure](../best-practices-availability-paired-regions.md).

Оба этих варианта отработки отказа предлагают следующие целевые точки восстановления (RPO):

| Тип данных | Целевые точки восстановления (RPO) |
| --- | --- |
| Реестр удостоверений |Потеря 0–5 мин данных |
| Данные двойника устройства |Потеря 0–5 мин данных |
| Получение сообщений из облака на устройство <sup>1</sup> |Потеря 0–5 мин данных |
| Родительское<sup>1</sup> устройство и его задания |Потеря 0–5 мин данных |
| Отправка сообщений с устройства в облако |Теряются все непрочитанные сообщения |
| Отправка сообщений о мониторинге операций |Теряются все непрочитанные сообщения |
| Сообщения обратной связи из облака на устройство |Теряются все непрочитанные сообщения |

<sup>1</sup> Сообщения, отправляемые из облака на устройство и родительские задания, не восстанавливаются в ходе отработки отказа вручную.

После завершения операции отработки отказа Центра Интернета вещей все операции устройства и внутренних приложений будут выполняться без активации каких-либо действий вручную. Это означает, что сообщения, отправляемые с устройства в облако, должны продолжать работать, и весь реестр устройства не изменяется. События, созданные через службу "Сетка событий", можно использовать с помощью тех же подписок, которые настроены ранее, если эти подписки на сетку событий по-прежнему доступны. Для пользовательских конечных точек дополнительная обработка не требуется.

> [!CAUTION]
> - Имя, совместимое с концентратором событий, и встроенная конечная точка событий Центра Интернета вещей после отработки отказа изменятся. При получении сообщений телеметрии из встроенной конечной точки с помощью клиента концентратора событий или узла обработчика событий следует [использовать строку подключения центра Интернета вещей](iot-hub-devguide-messages-read-builtin.md#read-from-the-built-in-endpoint) для установления соединения. Это гарантирует, что ваши серверные приложения продолжат работу без активации (после отработки отказа) каких-либо действий вручную. Если имя и конечная точка, совместимые с концентратором событий, используются непосредственно в приложении, необходимо будет [получить новую конечную точку, совместимую с концентратором событий](iot-hub-devguide-messages-read-builtin.md#read-from-the-built-in-endpoint) , после отработки отказа для продолжения операций. 
>
> - Если вы используете функции Azure или Azure Stream Analytics для подключения встроенной конечной точки событий, может потребоваться выполнить **перезагрузку**. Это связано с тем, что во время отработки отказа предыдущие смещения больше не действительны.
>
> - При маршрутизации к хранилищу рекомендуется перечислить большие двоичные объекты или файлы, а затем перепроходить их, чтобы гарантировать чтение всех больших двоичных объектов или файлов без принятия каких-либо предположений раздела. Диапазон секций может измениться во время отработки отказа, инициированного Майкрософт, или при отработке отказа вручную. Вы можете использовать [API List blobs](/rest/api/storageservices/list-blobs) для перечисления списка больших двоичных объектов или [ADLS 2-го поколения API списка](/rest/api/storageservices/datalakestoragegen2/filesystem/listpaths) файлов. Дополнительные сведения см. в статье [Служба хранилища Azure в качестве конечной точки маршрутизации](iot-hub-devguide-messages-d2c.md#azure-storage-as-a-routing-endpoint).

## <a name="microsoft-initiated-failover"></a>Корпорация Майкрософт инициирует отработку отказа

Корпорация Майкрософт инициирует отработку отказа в редких случаях. Это делается, чтобы выполнить отработку отказа всех Центров Интернета вещей из затронутого региона в соответствующий географически связанный регион. Это процесс по умолчанию (пользователи не могут от него отказаться), и он не требует действий пользователя. Майкрософт оставляет за собой право определять, в каких случаях использовать этот параметр. Отработка отказа центра пользователя с помощью этого механизма не требует согласия этого пользователя. Целевое время восстановления (RTO) отработки отказа, инициируемого корпорацией Майкрософт, составляет 2–26 часов. 

Большое время RTO объясняется тем, что Майкрософт нужно выполнить отработку отказа от имени всех затронутых пользователей в этом регионе. Если вы запускаете менее критичное решение для Интернета вещей, которое может справиться с простоем в течение одного дня, можете использовать этот вариант для обеспечения всех целей аварийного восстановления своего решения для Интернета вещей. Общее время готовности к выполнению операций в среде выполнения после запуска соответствующего процесса описывается в разделе, посвященном времени восстановления.

## <a name="manual-failover"></a>Переход на другой ресурс вручную

Если цели вашего бизнеса не соответствуют RTO, предоставленному корпорацией Майкрософт при отработке отказа, рассмотрите возможность перехода на другой ресурс вручную для самостоятельного запуска процесса отработки отказа. При использовании этого параметра время RTO может составлять от 10 минут до пары часов. В настоящее время RTO является функцией ряда устройств, зарегистрированных в экземпляре Центра Интернета вещей, к которому применяется отработка отказа. Для центра, в котором размещается примерно 100 000 устройств, время RTO будет приблизительно 15 минут. Общее время готовности к выполнению операций в среде выполнения после запуска соответствующего процесса описывается в разделе, посвященном времени восстановления.

Параметр перехода на другой ресурс вручную всегда можно использовать независимо от наличия простоя в основном регионе. Таким образом, этот параметр потенциально можно использовать для выполнения запланированных отработок отказа. Одним из примеров использования запланированных отработок отказа является выполнение тестовых отработок отказа. Тем не менее запланированная отработка отказа является причиной простоя в центре в течение времени, определенного в соответствии со временем RTO этого параметра, а также приводит к потере данных, как определено в таблице RPO выше. Вы можете настроить тестовый экземпляр Центра Интернета вещей для периодического запуска параметра запланированной отработки отказа, чтобы быть уверенными в том, что во время реального сбоя комплексные решения будут настроены и готовы к запуску.

Отработка отказа вручную предоставляется бесплатно для центров Интернета вещей, созданных после 18 мая 2017 г.

Пошаговые инструкции см. в разделе [учебник. Выполнение перехода на другой ресурс вручную для центра Интернета вещей](tutorial-manual-failover.md)

### <a name="running-test-drills"></a>Выполнение детализации теста

Не нужно выполнять эти проверки в Центрах Интернета вещей, которые используются в рабочих средах.

### <a name="dont-use-manual-failover-to-migrate-iot-hub-to-a-different-region"></a>Не используйте отработку отказа вручную для переноса центра Интернета вещей в другой регион

Отработка отказа вручную *не* следует использовать в качестве механизма безвозвратного переноса центра между географическими регионами Azure. Это увеличивает задержку операций, выполняемых с центром Интернета вещей, с устройств, размещенных в старом основном регионе.

## <a name="failback"></a>Восстановление размещения

Для восстановления размещения в прежнем основном регионе нужно повторно запустить операцию отработки отказа. Если первоначальная операция отработки отказа была выполнена для восстановления после длительного сбоя в исходном основном регионе, мы рекомендовали восстановить размещение центра в исходном расположении после его восстановления после сбоя.

> [!IMPORTANT]
> - Пользователям разрешается выполнять только 2 успешные отработки отказа и 2 успешные операции восстановления размещения в день.
>
> - Нельзя повторно выполнить прежнюю отработку отказа или операцию восстановления размещения. Необходимо подождать один час между этими операциями.

## <a name="time-to-recover"></a>Время восстановления

В то время как полное доменное имя (и, следовательно, строка подключения) экземпляра центра Интернета вещей остается таким же, как и при отработке отказа, базовый IP-адрес изменяется. Поэтому общее время готовности к выполнению операций среды выполнения в экземпляре Центра Интернета вещей после активации процесса отработки отказа можно выразить с помощью функции ниже.

Время восстановления = RTO [от 10 мин до 2 ч для перехода на другой ресурс вручную | от 2 до 26 часов для отработки отказа, инициируемой корпорацией Майкрософт] + задержка распространения DNS + время, затраченное приложением клиента для обновления любого кэшированного IP-адреса Центра Интернета вещей.

> [!IMPORTANT]
> Пакеты SDK Интернета вещей не кэшируют IP-адрес Центра Интернета вещей. Лучше, если код пользователя, взаимодействующий с пакетами SDK, не будет кэшировать IP-адрес Центра Интернета вещей.

## <a name="achieve-cross-region-ha"></a>Обеспечение высокой доступности между регионами

Если время RTO, которое обеспечивается отработкой отказа, инициируемой корпорацией Майкрософт, или переходом на другой ресурс вручную, не подходит для целей доступности вашей организации, вы можете реализовать автоматический механизм отработки отказа между регионами для каждого устройства.
Полное освещение топологий развертывания в решениях Интернета вещей выходит за рамки этой статьи. Чтобы раскрыть тему высокого уровня доступности и аварийного восстановления, в статье рассматривается модель развертывания с *отработкой отказа между регионами*.

В модели региональной отработки отказа серверная часть решения запускается в первую очередь в центре обработки данных в одном расположении. Дополнительные Центр Интернета вещей и серверная часть развертываются в другом расположении центра обработки данных. Если в Центре Интернета вещей в основном регионе произойдет сбой или сетевое подключение устройства к основному региону по какой-то причине будет нарушено, устройства будут использовать дополнительную конечную точку службы. Доступность решения можно повысить, реализовав модель отработки отказа между регионами, а не в пределах одного региона. 

Если говорить в общем, то чтобы реализовать модель с отработкой отказа между регионами, необходимо следующее:

* **Дополнительный Центр Интернета вещей и логика маршрутизации устройств.** В случае нарушения работы службы в основном регионе устройства должны подключаться к дополнительному региону. Учитывая, что состояние большинства задействованных служб отслеживается, чаще всего процесс отработки отказа между регионами активируют администраторы решений. Лучший способ сообщить устройствам новую конечную точку и сохранить контроль над процессом — заставить устройства регулярно получать из *дежурной* службы текущую активную конечную точку. Дежурной службой может быть простое реплицируемое веб-приложение, доступность которого обеспечивается посредством перенаправления DNS-трафика (например, с помощью [диспетчера трафика Azure](../traffic-manager/traffic-manager-overview.md)).

   > [!NOTE]
   > Служба "Центр Интернета вещей" не является поддерживаемым типом конечной точки в диспетчере трафика Azure. Мы рекомендуем интегрировать предложенную дежурную службу с диспетчером трафика Azure путем реализации API пробы работоспособности конечной точки.

* **Репликация реестра удостоверений.** Дополнительный Центр Интернета вещей будет работоспособен только в том случае, если в нем будут все удостоверения устройств и эти удостоверения смогут подключаться к решению. Решение должно хранить геореплицированные резервные копии удостоверений устройств и передавать их в дополнительный центр IoT до перевода устройств на другую конечную точку. В этом случае вам пригодится функция Центра Интернета вещей для экспорта удостоверений устройств. Дополнительные сведения см. в [разделе, посвященном реестру удостоверений, руководства разработчика для Центра Интернета вещей](iot-hub-devguide-identity-registry.md).

* **Логика объединения.** Когда основной регион снова станет доступным, все состояния и данные, которые были созданы в дополнительном регионе, необходимо перенести обратно в основной. Эти состояния и данные главным образом относятся к удостоверениям устройств и метаданным приложений, которые необходимо добавить в основной Центр Интернета вещей и другие хранилища приложений в основном регионе. 

Чтобы упростить эту процедуру, следует использовать идемпотентные операции. Они сводят к минимуму количество побочных эффектов от итогового согласованного распределения событий и от дублирования данных или беспорядочной доставки событий. Кроме того, логику приложения необходимо спроектировать таким образом, чтобы потенциальные несоответствия или незначительно устаревшие состояния считались допустимыми. Эта ситуация связана как с целевыми точками восстановления (RPO), так и с тем, что восстановление системы требует времени.

## <a name="choose-the-right-hadr-option"></a>Выбор правильного варианта обеспечения высокого уровня доступности и аварийного восстановления

Вот общие сведения о вариантах обеспечения высокого уровня доступности и аварийного восстановления, которые можно использовать в качестве справки, чтобы выбрать вариант, подходящий для вашего решения.

| Вариант обеспечения высокого уровня доступности и аварийного восстановления | RTO | RPO | Требуются действия вручную? | Сложность реализации | Дополнительные затраты|
| --- | --- | --- | --- | --- | --- |
| Корпорация Майкрософт инициирует отработку отказа |2–26 часов|См. сведения в таблице RPO выше|Нет|None|Нет|
| Переход на другой ресурс вручную |От 10 мин до 2 ч|См. сведения в таблице RPO выше|Да|Очень низкая. Необходимо просто запустить эту операцию на портале.|Нет|
| Обеспечение высокого уровня доступности между регионами |< 1 мин|Зависит от частоты репликации пользовательского решения обеспечения высокого уровня доступности|Нет|Высокий|> 1x стоимости 1 Центра Интернета вещей|

## <a name="next-steps"></a>Дальнейшие шаги

* [Что такое Центр Интернета вещей в Azure?](about-iot-hub.md)
* [Приступая к работе с Центром Интернета вещей Azure (Краткое руководство)](quickstart-send-telemetry-dotnet.md)
* [Руководство по выполнению отработки отказа вручную для Центра Интернета вещей](tutorial-manual-failover.md)
