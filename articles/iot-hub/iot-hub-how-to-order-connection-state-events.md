---
title: Упорядочение событий изменения состояния подключения устройства из Центра Интернета вещей Azure с помощью Azure Cosmos DB
description: В этой статье описывается, как упорядочивать и записывать события изменения состояния подключения устройств из Центра Интернета вещей Azure с использованием Azure Cosmos DB для поддержания последнего состояния подключения.
services: iot-hub
ms.service: iot-hub
author: ash2017
ms.topic: conceptual
ms.date: 04/11/2019
ms.author: asrastog
ms.custom: devx-track-azurecli
ms.openlocfilehash: 90b7b6aebfce1c37bef76d371d829048d755e39e
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "92147274"
---
# <a name="order-device-connection-events-from-azure-iot-hub-using-azure-cosmos-db"></a>Упорядочение событий изменения состояния подключения устройства из Центра Интернета вещей Azure с использованием Azure Cosmos DB

Сетка событий Azure поможет вам создавать приложения на основе событий и легко интегрировать события Центра Интернета вещей в бизнес-приложения. В этой статье вы ознакомитесь с настройкой, которую можно использовать для отслеживания и сохранения последнего состояния подключения устройства в Cosmos DB. Мы будем использовать порядковый номер, доступный в событиях отключения и подключения устройства, и сохраним последнее состояние в Cosmos DB. Кроме того, мы используем хранимую процедуру — логику приложения, которая выполняется в коллекции Cosmos DB.

Порядковый номер является строковым представлением шестнадцатеричного числа. Сравнение строк можно использовать для идентификации большего числа. Если вы преобразуете строку в шестнадцатеричную, то число будет 256-битным. Порядковый номер строго возрастает, и номер последнего события будет выше номера других событий. Это полезно, если у вас есть устройство, которое часто подключается и отключается, и вы хотите убедиться, что только последнее событие используется для запуска нижестоящего действия, так как Сетка событий Azure не поддерживает упорядочение событий.

## <a name="prerequisites"></a>Предварительные требования

* Активная учетная запись Azure. Если ее нет, можно создать [бесплатную учетную запись](https://azure.microsoft.com/pricing/free-trial/).

* Активная учетная запись API SQL Azure Cosmos DB. Если вы ее еще не создали, ознакомьтесь с соответствующими инструкциями в разделе [Создание учетной записи базы данных](../cosmos-db/create-sql-api-java.md#create-a-database-account).

* Коллекция в базе данных. Пошаговое руководство см. в разделе [Добавление коллекции](../cosmos-db/create-sql-api-java.md#add-a-container). При создании коллекции используйте `/id` для ключа секции.

* Центр Интернета вещей в Azure. Если вы его еще не создали, ознакомьтесь с соответствующими инструкциями в статье [Подключение устройства к Центру Интернета вещей с помощью .NET](./quickstart-send-telemetry-dotnet.md).

## <a name="create-a-stored-procedure"></a>Создание хранимой процедуры

Сначала создайте хранимую процедуру и настройте ее для запуска логики, которая сравнивает порядковые номера входящих событий и записывает последнее событие каждого устройства в базе данных.

1. В API SQL для Cosmos DBI выберите **Обозреватель данных** > **Элементы** > **Новая хранимая процедура**.

   ![Создание хранимой процедуры](./media/iot-hub-how-to-order-connection-state-events/create-stored-procedure.png)

2. Введите **LatestDeviceConnectionState** в качестве идентификатора хранимой процедуры и вставьте следующий код в поле **Тело хранимой процедуры**. Обратите внимание, что этот код должен заменить любой существующий код в тексте хранимой процедуры. Этот код поддерживает одну строку на идентификатор устройства и записывает последнее состояние подключения этого идентификатора устройства, определяя наивысший порядковый номер.

    ```javascript
    // SAMPLE STORED PROCEDURE
    function UpdateDevice(deviceId, moduleId, hubName, connectionState, connectionStateUpdatedTime, sequenceNumber) {
      var collection = getContext().getCollection();
      var response = {};

      var docLink = getDocumentLink(deviceId, moduleId);

      var isAccepted = collection.readDocument(docLink, function(err, doc) {
        if (err) {
          console.log('Cannot find device ' + docLink + ' - ');
          createDocument();
        } else {
          console.log('Document Found - ');
          replaceDocument(doc);
        }
      });

      function replaceDocument(document) {
        console.log(
          'Old Seq :' +
            document.sequenceNumber +
            ' New Seq: ' +
            sequenceNumber +
            ' - '
        );
        if (sequenceNumber > document.sequenceNumber) {
          document.connectionState = connectionState;
          document.connectionStateUpdatedTime = connectionStateUpdatedTime;
          document.sequenceNumber = sequenceNumber;

          console.log('replace doc - ');

          isAccepted = collection.replaceDocument(docLink, document, function(
            err,
            updated
          ) {
            if (err) {
              getContext()
                .getResponse()
                .setBody(err);
            } else {
              getContext()
                .getResponse()
                .setBody(updated);
            }
          });
        } else {
          getContext()
            .getResponse()
            .setBody('Old Event - current: ' + document.sequenceNumber + ' Incoming: ' + sequenceNumber);
        }
      }
      function createDocument() {
        document = {
          id: deviceId + '-' + moduleId,
          deviceId: deviceId,
          moduleId: moduleId,
          hubName: hubName,
          connectionState: connectionState,
          connectionStateUpdatedTime: connectionStateUpdatedTime,
          sequenceNumber: sequenceNumber
        };
        console.log('Add new device - ' + collection.getAltLink());
        isAccepted = collection.createDocument(
          collection.getAltLink(),
          document,
          function(err, doc) {
            if (err) {
              getContext()
                .getResponse()
                .setBody(err);
            } else {
              getContext()
                .getResponse()
                .setBody(doc);
            }
          }
        );
      }

      function getDocumentLink(deviceId, moduleId) {
        return collection.getAltLink() + '/docs/' + deviceId + '-' + moduleId;
      }
    }
    ```

3. Сохраните хранимую процедуру:

    ![Сохранение хранимой процедуры](./media/iot-hub-how-to-order-connection-state-events/save-stored-procedure.png)

## <a name="create-a-logic-app"></a>Создайте приложение логики

Сначала создайте приложение логики и добавьте триггер службы "Сетка событий", отслеживающий группу ресурсов для виртуальной машины.

### <a name="create-a-logic-app-resource"></a>Создание ресурса приложения логики

1. На [портале Azure](https://portal.azure.com) нажмите **+ Создать ресурс**, выберите **Интеграция**, а затем — **Приложение логики**.

   ![Создание приложения логики](./media/iot-hub-how-to-order-connection-state-events/select-logic-app.png)

2. Присвойте уникальное в вашей подписке имя приложению логики и выберите ту же подписку, группу ресурсов и расположение, которые используются для Центра Интернета вещей.

   ![Новое приложение логики](./media/iot-hub-how-to-order-connection-state-events/new-logic-app.png)

3. Выберите **Создать**, чтобы создать приложение логики.

   Вы создали ресурс Azure для приложения логики. После того, как Azure развернет приложение логики, конструктор Logic Apps отобразит несколько распространенных шаблонов, чтоб вы могли быстрее приступить к работе.

   > [!NOTE]
   > Чтобы снова найти и открыть приложение логики, выберите **Группы ресурсов**, а затем выберите группу ресурсов, которую вы используете для этого руководства. Затем выберите новое приложение логики. Откроется конструктор приложений логики.

4. В конструкторе приложений логики прокрутите вправо до тех пор, пока не отобразятся общие триггеры. В разделе **Шаблоны** выберите **Пустое приложение логики**. Это позволит создать приложение логики с нуля.

### <a name="select-a-trigger"></a>Выбор триггера

Триггер представляет собой определенное событие, которое запускает приложение логики. В этом руководстве триггер, который инициирует рабочий процесс, получает запрос через HTTP.

1. На панели поиска триггеров и соединителей введите **HTTP** и нажмите клавишу ВВОД.

2. Выберите в качестве триггера вариант **Запрос — при получении HTTP-запроса**.

   ![Выбор триггера запроса HTTP](./media/iot-hub-how-to-order-connection-state-events/http-request-trigger.png)

3. Выберите **Использовать пример полезной нагрузки, чтобы создать схему**.

   ![Использование примера полезных данных для создания схемы](./media/iot-hub-how-to-order-connection-state-events/sample-payload.png)

4. Вставьте пример кода JSON ниже в текстовое поле, а затем нажмите кнопку **Готово**:

   ```json
   [{
    "id": "fbfd8ee1-cf78-74c6-dbcf-e1c58638ccbd",
    "topic":
      "/SUBSCRIPTIONS/DEMO5CDD-8DAB-4CF4-9B2F-C22E8A755472/RESOURCEGROUPS/EGTESTRG/PROVIDERS/MICROSOFT.DEVICES/IOTHUBS/MYIOTHUB",
    "subject": "devices/Demo-Device-1",
    "eventType": "Microsoft.Devices.DeviceConnected",
    "eventTime": "2018-07-03T23:20:11.6921933+00:00",
    "data": {
      "deviceConnectionStateEventInfo": {
        "sequenceNumber":
          "000000000000000001D4132452F67CE200000002000000000000000000000001"
      },
      "hubName": "MYIOTHUB",
      "deviceId": "48e44e11-1437-4907-83b1-4a8d7e89859e",
      "moduleId": ""
    },
    "dataVersion": "1",
    "metadataVersion": "1"
   }]
   ```

   ![Вставка примера полезных данных JSON](./media/iot-hub-how-to-order-connection-state-events/paste-sample-payload.png)

5. Вы можете получить всплывающее уведомление: **Не забудьте включить заголовок Content-Type со значением application/json в запросе.** Можно спокойно проигнорировать это уведомление и перейти к следующему разделу.

### <a name="create-a-condition"></a>Создание условия

Условия помогают выполнять определенные действия после удовлетворения определенного условия в рабочем процессе приложения логики. Когда условие выполняется, можно определить нужное действие. В этом руководстве применяется условие, проверяющее, соответствует ли значение eventType подключенному или отключенному устройству. Действие выполнит хранимую процедуру в вашей базе данных.

1. Выберите **+ Новый шаг**, затем **Встроенный**, найдите и выберите **Условие**. Щелкните **Выберите значение**, после чего появится всплывающее окно с динамическим содержимым — поля, которые можно выбрать. Заполните поля, как показано ниже, чтобы выполнять действие только для событий, связанных с подключением и отключением устройств:

   * Выберите значение: **eventType** — выберите из полей в динамическом содержимом, которое появляется при щелчке этого поля.
   * Измените "равно" на **заканчивается на**.
   * Выберите значение: **nected**.

     ![Заполнение условия](./media/iot-hub-how-to-order-connection-state-events/condition-detail.png)

2. В диалоговом окне **Если истинно** щелкните **Добавить действие**.
  
   ![Добавление действия в том случае, если значение равно true](./media/iot-hub-how-to-order-connection-state-events/action-if-true.png)

3. Найдите Cosmos DB и выберите **Azure Cosmos DB — Выполнить хранимую процедуру**.

   ![Поиск Cosmos DB](./media/iot-hub-how-to-order-connection-state-events/cosmosDB-search.png)

4. Укажите **cosmosdb-connection** в поле **Имя подключения** и выберите запись в таблице, а затем нажмите **Создать**. Отобразится панель **Выполнить хранимую процедуру**. Введите значения в полях.

   **Идентификатор базы данных**: ToDoList

   **Идентификатор коллекции**: Items

   **Идентификатор Sproc**: LatestDeviceConnectionState

5. Выберите **Добавить новый параметр**. В открывшемся раскрывающемся списке установите флажки **Ключ секции** и **Параметры для хранимой процедуры**, а затем щелкните в любом месте экрана. Будет добавлено поле для значения ключа секции и поле для параметров хранимой процедуры.

   ![На снимке экрана показан элемент "выполнить хранимую процедуру" с выбранным параметром "добавить новый".](./media/iot-hub-how-to-order-connection-state-events/logicapp-stored-procedure.png)

6. Введите значение ключа секции и параметры, как показано ниже. Обязательно поместите их в квадратные скобки и двойные кавычки, как показано ниже. Может потребоваться щелкнуть **Добавить динамическое содержимое**, чтобы получить допустимые значения, которые можно использовать здесь.

   ![На снимке экрана показан элемент выполнения хранимой процедуры с указанными параметрами.](./media/iot-hub-how-to-order-connection-state-events/logicapp-stored-procedure-2.png)

7. В верхней части панели, где отображается **Для каждого**, в разделе **Выберите выходные данные предыдущих шагов** убедитесь, что выбрано **Тело**.

   ![Заполнение сведений о приложении логики](./media/iot-hub-how-to-order-connection-state-events/logicapp-foreach-body.png)

8. Сохраните приложение логики.

### <a name="copy-the-http-url"></a>Копирование URL-адреса HTTP

Скопируйте для триггера URL-адрес, с которого приложение логики ожидает передачи данных, а затем закройте конструктор Logic Apps. Этот URL-адрес вы используете для настройки сетки событий.

1. Щелкните поле конфигурации триггера **При получении HTTP-запроса**, чтобы развернуть его.

2. Скопируйте значение **URL-адрес HTTP POST**, нажав кнопку копирования рядом с этим параметром.

   ![Копирование URL-адреса HTTP POST](./media/iot-hub-how-to-order-connection-state-events/copy-url.png)

3. Сохраните этот URL-адрес, чтобы использовать его в следующем разделе.

## <a name="configure-subscription-for-iot-hub-events"></a>Настройка подписки на события Центра Интернета вещей

В этом разделе вы настроите Центр Интернета вещей для публикации событий по мере их появления.

1. Найдите нужный Центр Интернета вещей на портале Azure.

2. Выберите **События**.

   ![Открытие сведений сетки событий](./media/iot-hub-how-to-order-connection-state-events/event-grid.png)

3. Выберите **+ Подписка на события**.

   ![Создание подписки на события](./media/iot-hub-how-to-order-connection-state-events/event-subscription.png)

4. Заполните раздел **Сведения о подписке на события**: Укажите описательное имя и выберите **Схема Сетки событий**.

5. Заполните поля **Типы событий**. В раскрывающемся списке в меню выберите только **Устройство подключено** и **Устройство отключено**. Щелкните в любом месте экрана, чтобы закрыть список и сохранить настройки.

   ![Задание типов событий для поиска](./media/iot-hub-how-to-order-connection-state-events/set-event-types.png)

6. **Сведения о конечной точке**: выберите для типа конечной точки значение **Веб-перехватчик**, щелкните выбранную конечную точку, вставьте URL-адрес, скопированный из приложения логики, и подтвердите выбор.

   ![Выбор URL-адреса конечной точки](./media/iot-hub-how-to-order-connection-state-events/endpoint-select.png)

7. Теперь форма должна выглядеть как в показанном ниже примере:

   ![Пример формы подписки на события](./media/iot-hub-how-to-order-connection-state-events/subscription-form.png)

   Выберите **Создать**, чтобы сохранить подписку на события.

## <a name="observe-events"></a>Просмотр событий

Теперь, когда ваша подписка на события настроена, давайте протестируем, подключив устройство.

### <a name="register-a-device-in-iot-hub"></a>Регистрация устройства в Центре Интернета вещей

1. В Центре Интернета вещей выберите **IoT Devices** (Устройства Интернета вещей).

2. Щелкните **+Добавить** в верхней части панели.

3. Для **идентификатора устройства** введите `Demo-Device-1`.

4. Щелкните **Сохранить**.

5. Вы можете добавить несколько устройств с разными идентификаторами.

   ![Устройства, добавленные в центр](./media/iot-hub-how-to-order-connection-state-events/AddIoTDevice.png)

6. Щелкните устройство еще раз. Теперь строки подключения и ключи будут заполнены. Скопируйте значение из поля **Connection string -- primary key** (Строка подключения — первичный ключ) для последующего использования.

   ![Строка подключения для устройства](./media/iot-hub-how-to-order-connection-state-events/DeviceConnString.png)

### <a name="start-raspberry-pi-simulator"></a>Запуск симулятора Raspberry Pi

Давайте используем веб-симулятор Raspberry Pi для имитации подключения устройства.

[Запустить симулятор Raspberry Pi](https://azure-samples.github.io/raspberry-pi-web-simulator/#Getstarted)

### <a name="run-a-sample-application-on-the-raspberry-pi-web-simulator"></a>Запуск примера приложения в веб-симуляторе Raspberry Pi

Следующие действия активируют событие, связанное с устройством.

1. В области кода замените заполнитель в строке 15 на строку подключения устройства Центра Интернета вещей Azure, сохраненную в конце предыдущего раздела.

   ![Вставка строки подключения устройства](./media/iot-hub-how-to-order-connection-state-events/raspconnstring.png)

2. Запустите приложение, выбрав **Запустить**.

Должны отобразиться результаты, аналогичные следующему, которые содержат данные датчика и сообщения, отправляемые в Центр Интернета вещей.

   ![Запуск приложения](./media/iot-hub-how-to-order-connection-state-events/raspmsg.png)

   Нажмите кнопку **Остановить**, чтобы остановить симулятор, и запустите событие **Device Disconnected** (Устройство отключено).

Вы запустили пример приложения, чтобы собрать данные датчика и отправить их в Центр Интернета вещей.

### <a name="observe-events-in-cosmos-db"></a>Просмотр событий в Cosmos DB

Вы можете увидеть результаты выполненной хранимой процедуры в вашем документе Cosmos DB. Это будет выглядеть следующим образом. Каждая строка содержит последнее состояние подключения каждого устройства.

   ![Результат](./media/iot-hub-how-to-order-connection-state-events/cosmosDB-outcome.png)

## <a name="use-the-azure-cli"></a>Использование Azure CLI

Вместо того чтобы использовать [портал Azure](https://portal.azure.com), шаги для работы с Центром Интернета вещей можно выполнить с помощью Azure CLI. С дополнительными сведениями можно ознакомиться в статьях, посвященных созданию [подписки на события](/cli/azure/eventgrid/event-subscription) и [устройств Интернета вещей](/cli/azure/ext/azure-iot/iot/hub/device-identity#ext-azure-iot-az-iot-hub-device-identity-create) с использованием Azure CLI.

## <a name="clean-up-resources"></a>Очистка ресурсов

В этом руководстве используются ресурсы, за которые в подписке Azure предусмотрена плата. По завершении работы с этим учебником и тестирования результатов отключите или удалите ресурсы, которые больше не нужны.

Чтобы не потерять работу, проделанную в приложении логики, мы рекомендуем отключить ресурсы, а не удалять их.

1. Перейдите в приложение логики.

2. В колонке **Обзор** выберите **Удалить** или **Отключить**.

    В подписке может быть только один бесплатный Центр Интернета вещей. Если для работы с этим руководством вы создали бесплатный Центр Интернета вещей, его можно не удалять, так как никакая плата взиматься не будет.

3. Перейдите в Центр Интернета вещей.

4. В колонке **Обзор** выберите **Удалить**.

    Даже если вы не удалите свой Центр Интернета вещей, вы можете удалить созданную подписку на события.

5. В Центре Интернета вещей выберите **Сетка событий**.

6. Выберите подписку на события, которую нужно удалить.

7. Выберите команду **Удалить**.

Чтобы удалить учетную запись Azure Cosmos DB на портале Azure, щелкните правой кнопкой мыши имя учетной записи и выберите **Удалить учетную запись**. Подробные инструкции см. в разделе [Удаление учетной записи Azure Cosmos DB](../cosmos-db/how-to-manage-database-account.md).

## <a name="next-steps"></a>Дальнейшие действия

* Узнайте больше о [реагировании на события в Центре Интернета вещей, используя службу "Сетка событий" для запуска действий](../iot-hub/iot-hub-event-grid.md).

* [Send email notifications about Azure IoT Hub events using Logic Apps](../event-grid/publish-iot-hub-events-to-logic-apps.md) (Отправка уведомлений электронной почты о событиях в Центре Интернета вещей Azure с помощью Logic Apps)

* Узнайте о дополнительных возможностях службы [Сетка событий](../event-grid/overview.md).