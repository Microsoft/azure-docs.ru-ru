---
title: Создание политик брандмауэра веб-приложения (WAF) для шлюза приложений
description: Узнайте, как создавать политики брандмауэра веб-приложений для шлюза приложений.
services: web-application-firewall
ms.topic: conceptual
author: vhorne
ms.service: web-application-firewall
ms.date: 02/08/2020
ms.author: victorh
ms.openlocfilehash: 26078c3757e42c3e290a5f4122461b287582fb80
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "96518827"
---
# <a name="create-web-application-firewall-policies-for-application-gateway"></a>Создание политик брандмауэра веб-приложения для шлюза приложений

Связывание политики WAF с прослушивателями позволяет защитить несколько сайтов за один WAF с помощью разных политик. Например, если имеется пять сайтов за WAF, можно иметь пять отдельных политик WAF (по одному для каждого прослушивателя) для настройки исключений, настраиваемых правил и управляемых наборов правил для одного сайта, не оказывая влияния на остальные четыре. Если требуется применить одну политику ко всем сайтам, можно просто связать политику с шлюзом приложений, а не с отдельными прослушивателями, чтобы сделать его глобально примененным. Политики также можно применить к правилу маршрутизации на основе пути. 

Можно создать любое количество политик. После создания политики она должна быть связана с шлюзом приложений, чтобы приступать к работе, но ее можно связать с любым сочетанием шлюзов и прослушивателей приложений. 

Если к шлюзу приложений применена политика, а затем к прослушивателю на этом шлюзе приложений применяется другая политика, политика прослушивателя вступит в силу, но только для прослушивателей, которым они назначены. Политика шлюза приложений по-прежнему применяется ко всем другим прослушивателям, которым не назначена определенная политика. 

   > [!NOTE]
   > После того как политика брандмауэра связана с WAF, всегда должна быть политика, связанная с этим WAF. Эту политику можно перезаписать, но полностью связать политику из WAF не поддерживается. 

Все новые параметры WAF брандмауэра веб-приложения (настраиваемые правила, конфигурации управляемого рулсет, исключения и т. д.) находятся внутри политики WAF. Если у вас уже есть WAF, эти параметры могут по-прежнему существовать в конфигурации WAF. Инструкции по переходу к новой политике WAF см. в разделе [Миграция конфигурации WAF в политику WAF](#migrate) далее в этой статье. 

## <a name="create-a-policy"></a>Создание политики

Сначала создайте базовую политику WAF с управляемым набором правил по умолчанию (DRS) с помощью портал Azure.

1. В верхней левой части портала выберите **создать ресурс**. Выполните поиск по запросу **WAF**, выберите **брандмауэр веб-приложения**, а затем щелкните **создать**.
2. На странице **Создание политики WAF** , вкладка " **основы** " введите или выберите следующие сведения, примите значения по умолчанию для остальных параметров, а затем щелкните " **проверить и создать**".

   |Параметр  |Значение  |
   |---------|---------|
   |Политика для     |Региональные WAF (шлюз приложений)|
   |Подписка     |Выберите имя подписки|
   |Группа ресурсов     |Выберите группу ресурсов|
   |Имя политики     |Введите уникальное имя для политики WAF.|
3. На вкладке **Ассоциация** введите один из следующих параметров, а затем нажмите кнопку **Добавить**.

   |Параметр  |Значение  |
   |---------|---------|
   |Связать шлюз приложений     |Выберите имя профиля шлюза приложений.|
   |Сопоставление прослушивателей     |Выберите имя прослушивателя шлюза приложений, а затем нажмите кнопку **Добавить**.|

   > [!NOTE]
   > При назначении политики для шлюза приложений (или прослушивателя), в котором уже есть политика, исходная политика перезаписывается и заменяется новой политикой.
4. Выберите **Проверить и создать**, а затем выберите **Создать**.

   ![Основы политики WAF](../media/create-waf-policy-ag/waf-policy-basics.png)

## <a name="configure-waf-rules-optional"></a>Настройка правил WAF (необязательно)

При создании политики WAF по умолчанию она находится в режиме *обнаружения* . В режиме Обнаружение WAF не блокирует запросы. Вместо этого соответствующие правила WAF регистрируются в журналах WAF. Чтобы увидеть WAF в действии, можно изменить параметры режима на *предотвращение*. В режиме предотвращения правила сопоставления, определенные в выбранном наборе правил CR, блокируются и (или) регистрируются в журналах WAF.

## <a name="managed-rules"></a>Управляемые правила

Правила OWASP, управляемые Azure, включены по умолчанию. Чтобы отключить отдельное правило в группе правил, разверните правила в этой группе правил, установите флажок перед номером правила и нажмите кнопку **Отключить** на вкладке выше.

[![Управляемые правила ](../media/create-waf-policy-ag/managed-rules.png)](../media/create-waf-policy-ag/managed-rules-lrg.png#lightbox)

## <a name="custom-rules"></a>Настраиваемые правила

Чтобы создать настраиваемое правило, выберите **Добавить настраиваемое правило** на вкладке **Настраиваемые правила** . Откроется страница конфигурации настраиваемого правила. На следующем снимке экрана показан пример настраиваемого правила, настроенного для блокировки запроса, если строка запроса содержит текст *блоккме*.

[![Изменить настраиваемое правило ](../media/create-waf-policy-ag/edit-custom-rule.png)](../media/create-waf-policy-ag/edit-custom-rule-lrg.png#lightbox)

## <a name="migrate-your-waf-config-to-a-waf-policy"></a><a name="migrate"></a>Перенос конфигурации WAF в политику WAF

Если у вас уже есть WAF, вы могли заметить некоторые изменения на портале. Сначала необходимо определить тип политики, которую вы включили в WAF. Существует три возможных состояния:

- Нет политики WAF
- Политика "только настраиваемые правила"
- Политика WAF

Вы можете узнать, в каком состоянии находится WAF, взглянув на него на портале. Если параметры WAF видимы и могут быть изменены в представлении шлюза приложений, WAF находится в состоянии 1.

[![Конфигурация ](../media/create-waf-policy-ag/waf-configure.png) WAF](../media/create-waf-policy-ag/waf-configure-lrg.png#lightbox)

Если выбран параметр **брандмауэр веб-приложения** и отображается связанная политика, то WAF находится в состоянии 2 или 3. Если после перехода к политике отображаются **только** пользовательские правила и связанные шлюзы приложений, то это будет политика только для пользовательских правил.

![Настраиваемые правила WAF](../media/create-waf-policy-ag/waf-custom-rules.png)

Если в нем также показаны параметры политики и управляемые правила, это полная политика брандмауэра веб-приложения. 

![Параметры политики WAF](../media/create-waf-policy-ag/waf-policy-settings.png)

## <a name="migrate-to-waf-policy"></a>Миграция в политику WAF

Если у вас есть пользовательские правила, WAF только политику, то может потребоваться перейти к новой политике WAF. В дальнейшем политика брандмауэра будет поддерживать параметры политики WAF, управляемые наборы правил, исключения и группы правил. По сути, все конфигурации WAF, которые ранее выполнялись в шлюзе приложений, теперь выполняются с помощью политики WAF. 

Изменения в пользовательском правиле только WAF политика отключены. Чтобы изменить любые параметры WAF, такие как отключение правил, Добавление исключений и т. д., необходимо выполнить миграцию на новый ресурс политики брандмауэра верхнего уровня.

Для этого создайте *политику брандмауэра веб-приложения* и свяжите ее со шлюзами приложений и выбранными прослушивателями. Эта новая политика должна точно совпадать с текущей конфигурацией WAF, то есть каждое настраиваемое правило, исключение, отключенное правило и т. д. должны быть скопированы в новую политику, которую вы создаете. После создания политики, связанной с шлюзом приложений, можно продолжить внесение изменений в правила и параметры WAF. Это также можно сделать с помощью Azure PowerShell. Дополнительные сведения см. в статье [связывание политики WAF с существующим шлюзом приложений](associate-waf-policy-existing-gateway.md).

При необходимости можно использовать скрипт миграции для миграции в политику WAF. Дополнительные сведения см. в статье [Миграция политик брандмауэра веб-приложения с помощью Azure PowerShell](migrate-policy.md).

## <a name="force-mode"></a>Принудительный режим

Если вы не хотите копировать все в политику, которая точно совпадает с текущей конфигурацией, вы можете задать для WAF режим "Force". Выполните следующий код Azure PowerShell, и ваш WAF будет работать в принудительном режиме. Затем можно связать любую политику WAF с WAF, даже если у нее нет точно тех же параметров, что и в конфигурации. 

```azurepowershell-interactive
$appgw = Get-AzApplicationGateway -Name <your Application Gateway name> -ResourceGroupName <your Resource Group name>
$appgw.ForceFirewallPolicyAssociation = $true
```

Затем процеес действия, чтобы связать политику WAF с шлюзом приложений. Дополнительные сведения см. в статье [связывание политики WAF с существующим шлюзом приложений.](associate-waf-policy-existing-gateway.md)

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о [группах правил и правилах CR в брандмауэре веб-приложений](application-gateway-crs-rulegroups-rules.md).
