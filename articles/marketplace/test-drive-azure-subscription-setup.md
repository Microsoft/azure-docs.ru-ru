---
title: Настройка подписки Azure Marketplace для размещенных тестовых дисков
description: В этой статье объясняется, как настроить подписку Azure Marketplace для Dynamics 365 для служб взаимодействия с клиентами и Dynamics 365 для дисков с тестовыми операциями.
ms.service: marketplace
ms.subservice: partnercenter-marketplace-publisher
ms.topic: article
author: trkeya
ms.author: trkeya
ms.date: 11/09/2020
ms.openlocfilehash: 60eeceac916a7f8c64214b7a74a8cf60fd1ec8ac
ms.sourcegitcommit: 04297f0706b200af15d6d97bc6fc47788785950f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/28/2021
ms.locfileid: "98986130"
---
# <a name="set-up-an-azure-marketplace-subscription-for-hosted-test-drives"></a>Настройка подписки Azure Marketplace для размещенных тестовых дисков

В этой статье объясняется, как настроить подписку Azure Marketplace и **dynamics 365 для служб** взаимодействия с клиентами или **Dynamics 365 для Operations** Environment для тестовых дисков.

## <a name="set-up-for-dynamics-365-for-customer-engagement"></a>Настройка Dynamics 365 для участия клиентов

1. Войдите в [портал Azure](https://portal.azure.com/) с помощью учетной записи администратора.
2. Убедитесь, что вы в клиенте, связанном с экземпляром тестового диска Dynamics 365, наведите указатель мыши на значок учетной записи в правом верхнем углу. Если вы не используете правильный клиент, щелкните значок учетной записи, чтобы переключиться в правильный клиент.

    :::image type="content" source="./media/test-drive/select-correct-tenant.png" alt-text="Выбор правильного клиента.":::

3. Убедитесь, что лицензия на план взаимодействия с **клиентом Dynamics 365** доступна.

    [![Проверка лицензии на план.](media/test-drive/check-plan-license.png)](media/test-drive/check-plan-license.png#lightbox)

4. Создание приложения Azure Active Directory (AD) в Azure. AppSource будет использовать это приложение для подготовки и отмены подготовки пользователя тестового диска в клиенте.
    1. На панели "фильтр" выберите **Azure Active Directory**.
    2. Щелкните **Регистрация приложений**.

        [![Выбор регистрации приложений.](media/test-drive/app-registrations.png)](media/test-drive/app-registrations.png#lightbox)

    3. Выберите **Новая регистрация**.
    4. Укажите соответствующее имя приложения.

        :::image type="content" source="./media/test-drive/register-an-application.png" alt-text="Регистрация приложения.":::

    5. В разделе Поддерживаемые типы учетных записей выберите **учетная запись в любом каталоге Организации и личных учетных записях Майкрософт**.
    6. Выберите **создать** и дождитесь создания приложения.
    7. После создания приложения Обратите внимание на **идентификатор приложения** , отображаемый на экране обзора. Это значение потребуется позже при настройке тестового диска.
    8. Чтобы добавить URI перенаправления nativeclient, выберите колонку **Проверка подлинности** . В разделе **Конфигурация платформы** выберите **Добавить платформу**  >  **мобильное приложение Мобильный**  >  **класс** . Выберите универсальный код ресурса (URI) перенаправления **nativeclient** и щелкните **Configure (настроить**).

        :::image type="content" source="./media/test-drive/configure-desktop-devices.png" alt-text="Добавление URI перенаправления nativeclient.":::

    9. В разделе **Управление приложением** выберите **разрешения API**.
    10. Выберите **Добавить разрешение** , а затем **Microsoft Graph API**.
    11. Выберите категорию разрешения **приложения** , а затем — **Directory. Read. ALL** и **Directory. ReadWrite. ALL** .

        :::image type="content" source="./media/test-drive/microsoft-graph.png" alt-text="Настройка разрешений приложения.":::

    12. Чтобы добавить **Dynamics CRM — доступ к олицетворению пользователя** для списка разрешенных приложений Azure AD, нажмите кнопку **Добавить разрешение** еще раз.

        :::image type="content" source="./media/test-drive/request-api-permissions.png" alt-text="Запрос разрешений приложения.":::

    13. После добавления разрешения выберите **предоставить согласие администратора для Майкрософт**.
    14. В предупреждении сообщения выберите **Да**.

        [![Показывает, что разрешения приложения успешно предоставлены.](media/test-drive/api-permissions-confirmation-customer.png)](media/test-drive/api-permissions-confirmation-customer.png#lightbox)

    15. Чтобы создать секрет для Azure AD App:
        1. В **приложении Управление приложением** выберите **сертификат и секреты**.
        2. В разделе секреты клиента выберите **новый секрет клиента**.
        3. Введите описание, например *тестовый диск*, и выберите соответствующую длительность. После истечения срока действия ключа тестовый диск будет прерываться, после чего необходимо будет создать и предоставить AppSource новый ключ.
        4. Нажмите кнопку **Добавить** , чтобы создать секрет приложения Azure. Скопируйте это значение, так как оно будет скрыто, как только вы лавеи эту колонку. Это значение потребуется позже при настройке тестового диска.

            :::image type="content" source="./media/test-drive/add-client-secret.png" alt-text="Добавление секрета клиента.":::

5. Иногда синхронизация пользователя из Azure AD с экземпляром CRM занимает больше времени, чем ожидалось. Для этого мы добавили процесс принудительной синхронизации пользователя, но для этого требуется, чтобы приложение Azure AD алловлистед по центру партнеров. Для этого см. раздел [синхронизация пользователей с экземпляром взаимодействия с клиентом](https://github.com/microsoft/AppSource/blob/master/Microsoft%20Hosted%20Test%20Drive/CDS_Utility_to_ForceUserSync_in_CRM_Instance.md).
6. Добавьте роль субъекта-службы в приложение, чтобы разрешить приложению Azure AD удалять пользователей из клиента Azure.
    1. Откройте командную строку PowerShell на административном уровне.
    2. Install-Module MSOnline (выполните эту команду, если MSOnline не установлен).
    3. Connect-MsolService (отображается всплывающее окно; Войдите в систему с созданным клиентом организации).
    4. $applicationId = **<YOUR_APPLICATION_ID>**.
    5. $sp = Get-MsolServicePrincipal-AppPrincipalId $applicationId.
    6. Add-MsolRoleMember-Ролеобжектид fe930be7-5e62-47dB-91af-98c3a49a38b1-Ролемемберобжектид $sp. ObjectId — Ролемембертипе servicePrincipal.

        :::image type="content" source="./media/test-drive/sign-in-to-account.png" alt-text="Вход в учетную запись.":::

7. Добавьте созданное ранее приложение Azure в качестве пользователя приложения в экземпляр CRM тестового диска.
    1. Добавьте нового пользователя в **Azure Active Directory**. Для создания этого пользователя требуются только значения **Name** и **username** (принадлежащие одному клиенту). остальные поля оставьте по умолчанию. Скопируйте значение username.
    2. Войдите в **экземпляр CRM** и выберите **параметр Настройка**  >    >  **пользователей** безопасности.
    3. Измените представление на **Пользователи приложения**.

        :::image type="content" source="./media/test-drive/application-users.png" alt-text="Установка сведений об учетной записи для пользователя.":::

    4. Добавьте нового пользователя (убедитесь, что используется форма для пользователя приложения).
    5. Введите то же имя пользователя в полях **основной адрес электронной почты** и **имя пользователя** . Добавьте идентификатор приложения **Azure** в **Application ID**.
    6. Укажите любое **полное имя**.
    7. Нажмите кнопку **Сохранить**.
    8. Выберите **Управление ролями**.
    9. Назначьте пользовательскую или OOB роль безопасности, которая содержит привилегии на чтение, запись и назначение роли, например *системный администратор*.

        :::image type="content" source="./media/test-drive/security-roles-selection.png" alt-text="Выбор привилегий роли.":::

    10. Назначьте пользователю приложения настраиваемую роль безопасности, созданную для тестового диска.

## <a name="set-up-for-dynamics-365-for-operations"></a>Настройка Dynamics 365 для операций

1. Войдите в [портал Azure](https://portal.azure.com/) с помощью учетной записи администратора.
2. Убедитесь, что вы в клиенте, связанном с экземпляром тестового диска Dynamics 365, наведите указатель мыши на значок учетной записи в правом верхнем углу. Если вы не используете правильный клиент, щелкните значок учетной записи, чтобы переключиться в правильный клиент.

    :::image type="content" source="./media/test-drive/select-correct-tenant.png" alt-text="Выбор правильного клиента.":::

3. Создание Azure AD App в Azure. AppSource будет использовать это приложение для подготовки и отмены подготовки пользователя тестового диска в клиенте.
    1. На панели "фильтр" выберите **Azure Active Directory**.
    2. Щелкните **Регистрация приложений**.

        :::image type="content" source="./media/test-drive/app-registrations.png" alt-text="Выбор регистрации приложения.":::

    3. Выберите **Новая регистрация**.
    4. Укажите соответствующее имя приложения.

        :::image type="content" source="./media/test-drive/register-an-application.png" alt-text="Регистрация приложения.":::

    5. В разделе Поддерживаемые типы учетных записей выберите **учетная запись в любом каталоге Организации и личных учетных записях Майкрософт**.
    6. Выберите **создать** и дождитесь создания приложения.
    7. После создания приложения Обратите внимание на **идентификатор приложения** , отображаемый на экране обзора. Это значение потребуется позже при настройке тестового диска.
    8. В разделе **Управление приложением** выберите **разрешения API**.
    9. Выберите **Добавить разрешение** , а затем **Microsoft Graph API**.
    10. Выберите категорию разрешения **приложения** , а затем — **Directory. Read. ALL** и **Directory. ReadWrite. ALL** .

        :::image type="content" source="./media/test-drive/microsoft-graph.png" alt-text="Настройка разрешений приложения.":::

    11. Выберите **Добавить разрешение**.
    12. После добавления разрешения выберите **предоставить согласие администратора для Майкрософт**.
    13. В предупреждении сообщения выберите **Да**.

        [![Показывает, что разрешения приложения успешно предоставлены.](media/test-drive/api-permissions-confirmation-operations.png)](media/test-drive/api-permissions-confirmation-operations.png#lightbox)

    14. Чтобы создать секрет для Azure AD App:
        1. В **приложении Управление приложением** выберите **сертификат и секреты**.
        2. В разделе секреты клиента выберите **новый секрет клиента**.
        3. Введите описание, например *тестовый диск*, и выберите соответствующую длительность. После истечения срока действия ключа тестовый диск будет прерываться, после чего необходимо будет создать и предоставить AppSource новый ключ.
        4. Нажмите кнопку **Добавить** , чтобы создать секрет приложения Azure. Скопируйте это значение, так как оно будет скрыто, как только вы лавеи эту колонку. Это значение потребуется позже при настройке тестового диска.

            :::image type="content" source="./media/test-drive/add-client-secret.png" alt-text="Добавление секрета клиента.":::

4. Добавьте роль субъекта-службы в приложение, чтобы разрешить приложению Azure AD удалять пользователей из клиента Azure.
    1. Откройте командную строку PowerShell на административном уровне.
    2. Install-Module MSOnline (выполните эту команду, если MSOnline не установлен).
    3. Connect-MsolService (отображается всплывающее окно; Войдите в систему с созданным клиентом организации).
    4. $applicationId = **<YOUR_APPLICATION_ID>**.
    5. $sp = Get-MsolServicePrincipal-AppPrincipalId $applicationId.
    6. Add-MsolRoleMember-Ролеобжектид fe930be7-5e62-47dB-91af-98c3a49a38b1-Ролемемберобжектид $sp. ObjectId — Ролемембертипе servicePrincipal.

        :::image type="content" source="./media/test-drive/sign-in-to-account.png" alt-text="Вход в учетную запись.":::

5. Теперь добавьте приведенное выше приложение в **Dynamics 365 для операций** , чтобы позволить приложению управлять пользователями.
    1. Найдите свой экземпляр **Dynamics 365 для операций** .
    2. В левом верхнем углу щелкните меню из трех строк (гамбургер).
    3. Выберите **Администрирование системы**.
    4. Выберите **Azure Active Directory приложения**.
    5. Выберите **+ Создать**.
    6. Введите **идентификатор клиента приложения Azure AD** , которое будет выполнять действия от имени.

    > [!NOTE]
    > Идентификатор пользователя, от имени которого будут выполняться действия (обычно это системный администратор экземпляра или пользователь с правами на добавление других пользователей).

    [![Идентификатор пользователя, от имени которого будут выполняться действия (обычно это системный администратор экземпляра или пользователь с правами на добавление других пользователей).](media/test-drive/system-admin-user-id.png)](media/test-drive/system-admin-user-id.png#lightbox)
<!--
## Next steps

- [Commercial marketplace partner and customer usage attribution](azure-partner-customer-usage-attribution.md) -->
