---
title: Парадигма программного доступа
description: Общие сведения о потоке шаблона вызова API для программной аналитики. Также рассматриваются API-интерфейсы для доступа к отчетам аналитики в коммерческом магазине Майкрософт.
ms.service: marketplace
ms.subservice: partnercenter-marketplace-publisher
ms.topic: article
author: sayantanroy83
ms.author: sroy
ms.date: 3/08/2021
ms.openlocfilehash: 8e0b94a46e96dd8ba16040e16b421520eb67de19
ms.sourcegitcommit: e6de1702d3958a3bea275645eb46e4f2e0f011af
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "102584086"
---
# <a name="programmatic-access-paradigm"></a>Парадигма программного доступа

На этой схеме показан шаблон вызова API, используемый для создания нового шаблона отчета, планирования пользовательского отчета и получения данных об ошибках.

[ ![ Демонстрируется шаблон вызова API, используемый для создания нового шаблона отчета, планирования пользовательского отчета и получения данных об ошибках.](./media/analytics-programmatic-access/analytics-high-level-flow.png)](./media/analytics-programmatic-access/analytics-high-level-flow.png#lightbox) 
 ***Рисунок 1. высокоуровневый поток шаблона вызова API***

Этот список содержит дополнительные сведения о рисунке 1.

1. Клиентское приложение может определить схему или шаблон пользовательского отчета, вызвав [API создания запроса отчета](#create-report-query-api). Кроме того, можно использовать шаблон отчета ( `QueryId` ) из [списка системных запросов](analytics-system-queries.md).
1. При успешном выполнении интерфейс API создания шаблона отчета возвращает `QueryId` .
1. Затем клиентское приложение вызывает [API создания отчета](#create-report-api) с помощью `QueryID` вместе с датой начала отчета, интервалом повтора, повторением и необязательным URI обратного вызова.
1. При успешном выполнении [API создания отчета](#create-report-api) возвращает `ReportID` .
1. Клиентское приложение получает уведомления на URI обратного вызова, как только данные отчета готовы к скачиванию.
1. Затем клиентское приложение использует [API получения отчетов для выполнения](#get-report-executions-api) запроса состояния отчета с `Report ID` диапазоном дат и.
1. При успешном выполнении возвращается ссылка на скачивание отчета, и приложение может инициировать скачивание данных.

## <a name="report-query-language-specification"></a>Спецификация языка запросов отчетов

Хотя мы предоставляем [системные запросы](analytics-system-queries.md) , которые можно использовать для создания отчетов, можно также создавать собственные запросы на основе бизнес-потребностей. Дополнительные сведения о пользовательских запросах см. в разделе [Спецификация настраиваемого запроса](analytics-custom-query-specification.md).

## <a name="create-report-query-api"></a>API создания запросов отчетов

Этот API помогает создавать пользовательские запросы, определяющие набор данных, из которого должны быть экспортированы столбцы и метрики. API обеспечивает гибкость создания нового шаблона отчетов на основе бизнес-потребностей.

Вы также можете использовать [системные запросы](analytics-system-queries.md) , которые мы предоставляем. Если пользовательские шаблоны отчетов не нужны, можно вызвать [API Create Report](#create-report-api) напрямую, используя [куеридс](analytics-system-queries.md) системных запросов, которые мы предоставляем.

В следующем примере показано, как создать настраиваемый запрос для получения _нормализованного использования и оценки финансовых расходов для платных номеров SKU_ из набора данных [исвусаже](analytics-make-your-first-api-call.md#programmatic-api-call) за прошлый месяц.

*Синтаксис запроса*

| Метод | Универсальный код ресурса (URI) запроса |
| ------------ | ------------- |
| POST | `https://api.partnercenter.microsoft.com/insights/v1/cmp/ScheduledQueries` |
|||

*Заголовок запроса*

| Header | Type | Описание |
| ------------- | ------------- | ------------- |
| Авторизация | строка | Обязательный. Маркер доступа Azure Active Directory (Azure AD). Формат — `Bearer <token>`. |
| Content-Type | `string` | `application/JSON` |
||||

*Параметр пути*

Нет

*Параметр запроса*

Нет

*Пример полезных данных запроса*

```json
{
    "Name": "ISVUsageQuery",
    "Description": "Normalized Usage and Estimated Financial Charges for PAID SKUs",
    "Query": "SELECT UsageDate, NormalizedUsage, EstimatedExtendedChargePC FROM ISVUsage WHERE SKUBillingType = 'Paid' ORDER BY UsageDate DESC TIMESPAN LAST_MONTH"
}
```

*Словарь терминов*

Эта таблица содержит ключевые определения элементов в полезных данных запроса.

| Параметр | Обязательно | Описание | Допустимые значения |
| ------------ | ------------- | ------------- | ------------- |
| `Name` | Да | Понятное имя запроса | Строка |
| `Description` | Нет | Описание возвращаемого запроса | строка |
| `Query` | Да | Строка запроса отчета | Тип данных: строка<br>[Пользовательский запрос](analytics-sample-queries.md) , основанный на бизнес-нуждах |
|||||

> [!NOTE]
> Примеры [запросов](analytics-sample-queries.md)см. в примерах пользовательских запросов.

*Пример ответа*

Полезные данные ответа структурированы следующим образом:

Коды ответов: 200, 400, 401, 403, 500

Пример полезных данных ответа:

```json
{
  "value": [
        {
            "queryId": "78be43f2-e35f-491a-8cd5-78fe14194f9c",
            "name": " ISVUsageQuery",
            "description": "Normalized Usage and Estimated Financial Charges for PAID SKUs”,
            "query": " SELECT UsageDate, NormalizedUsage, EstimatedExtendedChargePC FROM ISVUsage WHERE SKUBillingType = 'Paid' ORDER BY UsageDate DESC TIMESPAN LAST_MONTH",
            "type": "userDefined",
            "user": "142344300",
            "createdTime": "2021-01-06T05:38:34Z"
        }
    ],
    "totalCount": 1,
    "message": "Query created successfully",
    "statusCode": 200
}
```

*Словарь терминов*

Эта таблица содержит ключевые определения элементов в ответе.

| Параметр | Описание |
| ------------ | ------------- |
| `QueryId` | Универсальный уникальный идентификатор (UUID) созданного запроса |
| `Name` | Понятное имя, присвоенное запросу в полезных данных запроса |
| `Description` | Описание, заданное при создании запроса |
| `Query` | Запрос отчета, переданный в качестве входных данных при создании запроса |
| `Type` | Установите значение `userDefined` |
| `User` | Идентификатор пользователя, используемый для создания запроса |
| `CreatedTime` | Время создания запроса в формате UTC: гггг-мм-ddTHH: мм: ссZ |
| `TotalCount` | Число наборов данных в массиве значений |
| `StatusCode` | Код результата<br>Возможные значения: 200, 400, 401, 403, 500 |
| `message` | Сообщение о состоянии из-за выполнения API |
|||

## <a name="create-report-api"></a>Создание API отчета

При успешном создании пользовательского шаблона отчета и получении `QueryID` компонента в ответе на [запрос создания отчета](#create-report-query-api) этот API можно вызвать, чтобы запланировать выполнение запроса с регулярными интервалами. Для отчета можно задать частоту и расписание доставки. Для системных запросов, предоставляемых нами, API создания отчетов также можно вызывать с помощью [QueryId](analytics-sample-queries.md).

*Синтаксис запроса*

| Метод | Универсальный код ресурса (URI) запроса |
| ------------ | ------------- |
| POST | `https://api.partnercenter.microsoft.com/insights/v1/cmp/ScheduledReport` |
|||

*Заголовок запроса*

| Header | Type | Описание |
| ------ | ---- | ----------- |
| Авторизация | строка | Обязательный. Маркер доступа Azure Active Directory (Azure AD). Формат — `Bearer <token>`. |
| Тип содержимого | строка | `application/JSON` |
||||

*Параметр пути*

Нет

*Параметр запроса*

Нет

*Пример полезных данных запроса*

```json
{
  "ReportName": "ISVUsageReport",
  "Description": "Normalized Usage and Estimated Financial Charges for PAID SKUs",
  "QueryId": "78be43f2-e35f-491a-8cd5-78fe14194f9c ",
  "StartTime": "2021-01-06T19:00:00Z ",
  "RecurrenceInterval": 48,
  "RecurrenceCount": 20,
  "Format": "csv",
  "CallbackUrl": "https://<SampleCallbackUrl>"
}
```

*Словарь терминов*

Эта таблица содержит ключевые определения элементов в полезных данных запроса.

| Параметр | Обязательно | Описание | Допустимые значения |
| ------------ | ------------- | ------------- | ------------- |
| `ReportName` | Да | Имя, присвоенное отчету | Строка |
| `Description` | Нет | Описание созданного отчета | строка |
| `QueryId` | Да | Идентификатор запроса отчета | строка |
| `StartTime` | Да | Метка времени в формате UTC, с которой начнется создание отчета.<br>Формат должен быть следующим: гггг-мм-ddTHH: мм: ссZ | строка |
| `RecurrenceInterval` | Да | Периодичность создания отчета в часах.<br>Минимальное значение равно 4, а максимальное значение — 90. | Целое число |
| `RecurrenceCount` | Нет | Число создаваемых отчетов. | Целое число |
| `Format` | Нет | Формат файла экспортируемого файла.<br>Формат по умолчанию —. -. | CSV/TSV |
| `CallbackUrl` | Нет | Общедоступный URL-адрес, который можно дополнительно настроить в качестве назначения обратного вызова. | Строка (URL-адрес HTTP) |
| `ExecuteNow` | Нет | Этот параметр следует использовать для создания отчета, который будет выполняться только один раз. `StartTime`, `RecurrenceInterval` и `RecurrenceCount` не учитываются, если задано значение `true` . Отчет немедленно выполняется в асинхронном режиме. | true/false |
| `QueryStartTime` | Нет | Дополнительно указывает время начала запроса, извлекающее данные. Этот параметр применим только для одного отчета о выполнении, для которого `ExecuteNow` задано значение `true` . Формат должен быть гггг-мм-ddTHH: мм: ссZ | Отметка времени в виде строки |
| `QueryEndTime` | Нет | При необходимости задает время окончания запроса, извлекающее данные. Этот параметр применим только для одного отчета о выполнении, для которого `ExecuteNow` задано значение `true` . Формат должен быть гггг-мм-ddTHH: мм: ссZ | Отметка времени в виде строки |
|||||

*Пример ответа*

Полезные данные ответа структурированы следующим образом:

Код ответа: 200, 400, 401, 403, 404, 500

Полезные данные ответа:

```json
{
  "Value": [
    {
            "reportId": "72fa95ab-35f5-4d44-a1ee-503abbc88003",
            "reportName": "ISVUsageReport",
            "description": "Normalized Usage and Estimated Financial Charges for PAID SKUs",
            "queryId": "78be43f2-e35f-491a-8cd5-78fe14194f9c",
            "query": "SELECT UsageDate, NormalizedUsage, EstimatedExtendedChargePC FROM ISVUsage WHERE SKUBillingType = 'Paid' ORDER BY UsageDate DESC TIMESPAN LAST_MONTH",
            "user": "142344300",
            "createdTime": "2021-01-06T05:46:00Z",
            "modifiedTime": null,
            "startTime": "2021-01-06T19:00:00Z",
            "reportStatus": "Active",
            "recurrenceInterval": 48,
            "recurrenceCount": 20,
            "callbackUrl": "https://<SampleCallbackUrl>",
            "format": "csv"    
    }
  ],
  "TotalCount": 1,
  "Message": "Report created successfully",
  "StatusCode": 200
}
```

*Словарь терминов*

Эта таблица содержит ключевые определения элементов в ответе.

| Параметр | Описание |
| ------------ | ------------- |
| `ReportId` | Универсальный уникальный идентификатор (UUID) созданного отчета |
| `ReportName` | Имя, присвоенное отчету в полезных данных запроса |
| `Description` | Описание, заданное при создании отчета |
| `QueryId` | Идентификатор запроса, переданный во время создания отчета |
| `Query` | Текст запроса, который будет выполнен для этого отчета |
| `User` | Идентификатор пользователя, используемый для создания отчета |
| `CreatedTime` | Время создания отчета в формате UTC в следующем формате: гггг-мм-ddTHH: мм: ссZ |
| `ModifiedTime` | Время последнего изменения отчета в формате UTC в следующем формате: гггг-мм-ddTHH: мм: ссZ |
| `StartTime` | Время выполнения отчета в формате UTC начинается в следующем формате: гггг-мм-ddTHH: mm: ссZ |
| `ReportStatus` | Состояние выполнения отчета. Возможные значения: **приостановлено**, **активно** и **неактивно**. |
| `RecurrenceInterval` | Интервал повторения, указанный при создании отчета |
| `RecurrenceCount` | Число повторений, указанное при создании отчета |
| `CallbackUrl` | URL-адрес обратного вызова, указанный в запросе |
| `Format` | Формат файлов отчета. Возможные значения: CSV или TSV. |
| `TotalCount` | Число наборов данных в массиве значений |
| `StatusCode` | Код результата<br>Возможные значения: 200, 400, 401, 403, 500 |
| `message` | Сообщение о состоянии из-за выполнения API |
|||

## <a name="get-report-executions-api"></a>Получение API выполнения отчетов

Этот метод можно использовать для запроса состояния выполнения отчета с помощью метода, `ReportId` полученного из [API создания отчета](#create-report-api). Метод возвращает ссылку для скачивания отчета, если отчет готов к скачиванию. В противном случае метод возвращает состояние. Этот API также можно использовать для получения всех выполнений, произошедших для данного отчета.

> [!IMPORTANT]
> Этот API имеет параметры запроса по умолчанию, заданные для `executionStatus=Completed` и  `getLatestExecution=true` . Поэтому вызов API до первого успешного выполнения отчета возвратит 404. Ожидающие выполнения можно получить с помощью параметра `executionStatus=Pending` .

*Синтаксис запроса*

| Метод | Универсальный код ресурса (URI) запроса |
| ------------ | ------------- |
| Получить | `https://api.partnercenter.microsoft.com/insights/v1/cmp/ScheduledReport/execution/{reportId}?executionId={executionId}&executionStatus={executionStatus}&getLatestExecution={getLatestExecution}` |
|||

*Заголовок запроса*

| Header | Type | Описание |
| ------ | ------ | ------ |
| Авторизация | строка | Обязательный. Маркер доступа Azure Active Directory (Azure AD). Формат — `Bearer <token>`. |
| Тип содержимого | строка | `application/json` |
||||

*Параметр пути*

Нет

*Параметр запроса*

| Имя параметра | Обязательно | Тип | Описание |
| ------------ | ------------- | ------------- | ------------- |
| `reportId` | Да | строка | Фильтр для получения сведений о выполнении только отчетов с `reportId` указанными в этом аргументе. Несколько `reportIds` можно указать, разделив их точкой с запятой ";". |
| `executionId` | Нет | строка | Фильтр для получения сведений только об отчетах, `executionId` указанных в этом аргументе. Несколько `executionIds` можно указать, разделив их точкой с запятой ";". |
| `executionStatus` | Нет | строка или перечисление | Фильтр для получения сведений только об отчетах, `executionStatus` указанных в этом аргументе.<br>Допустимые значения: `Pending` , `Running` , `Paused` и. `Completed` <br>Значение по умолчанию — `Completed`. Можно указать несколько состояний, разделяя их точкой с запятой ";". |
| `getLatestExecution` | Нет | Логическое | API возвратит сведения о последнем выполнении отчета.<br>По умолчанию этот параметр имеет значение `true`. Если вы решили передать значение этого параметра в виде `false` , API возвратит экземпляры выполнения за последние 90 дней. |
|||||

*Полезные данные запроса*

Нет

*Пример ответа*

Полезные данные ответа структурированы следующим образом:

Коды ответов: 200, 400, 401, 403, 404, 500

Пример полезных данных ответа:

```json
{
    "value": [
        {
            "executionId": "a0bd78ad-1a05-40fa-8847-8968b718d00f",
            "reportId": "72fa95ab-35f5-4d44-a1ee-503abbc88003",
            "recurrenceInterval": 4,
            "recurrenceCount": 10,
            "callbackUrl": null,
            "format": "csv",
            "executionStatus": "Completed",
            "reportAccessSecureLink": "https://<path to report for download>",
            "reportExpiryTime": null,
            "reportGeneratedTime": "2021-01-13T14:40:46Z"
        }
    ],
    "totalCount": 1,
    "message": null,
    "statusCode": 200
}
```

После выполнения отчета отображается состояние выполнения `Completed` . Вы можете скачать отчет, выбрав URL-адрес в `reportAccessSecureLink` .

*Словарь терминов*

Основные определения элементов в ответе.

| Параметр | Описание |
| ------------ | ------------- |
| `ExecutionId` | Универсальный уникальный идентификатор (UUID) экземпляра выполнения |
| `ReportId` | ИДЕНТИФИКАТОР отчета, связанный с экземпляром выполнения |
| `RecurrenceInterval` | Интервал повторения, указанный при создании отчета |
| `RecurrenceCount` | Число повторений, указанное при создании отчета |
| `CallbackUrl` | URL-адрес обратного вызова, связанный с экземпляром выполнения |
| `Format` | Формат созданного файла при завершении выполнения |
| `ExecutionStatus` | Состояние экземпляра выполнения отчета.<br>Допустимые значения: `Pending` , `Running` , `Paused` и. `Completed` |
| `ReportAccessSecureLink` | Ссылка, с помощью которой можно безопасно получить доступ к отчету |
| `ReportExpiryTime` | Время в формате UTC, по истечении которого срок действия ссылки на отчет истекает в следующем формате: гггг-мм-ddTHH: mm: ссZ |
| `ReportGeneratedTime` | Время в формате UTC, когда отчет был создан в следующем формате: гггг-мм-ddTHH: мм: ссZ |
| `TotalCount` | Число наборов данных в массиве значений |
| `StatusCode` | Код результата <br>Возможные значения: 200, 400, 401, 403, 404 и 500 |
| `message` | Сообщение о состоянии из-за выполнения API |
|||

## <a name="next-steps"></a>Дальнейшие действия
- Вы можете испытать интерфейсы API через [URL-адрес API Swagger](https://api.partnercenter.microsoft.com/insights/v1/cmp/swagger/index.html) .
- Приступая к работе с программным доступом к данным аналитики
