---
title: Типы тестовых дисков, коммерческий рынок Майкрософт
description: Типы тестовых дисков в коммерческом магазине
ms.service: marketplace
ms.subservice: partnercenter-marketplace-publisher
ms.topic: article
ms.date: 06/19/2020
ms.author: trkeya
author: trkeya
ms.openlocfilehash: 2addf415c39691b4e662f304522a418aa8a778c2
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "101730377"
---
# <a name="azure-resource-manager-test-drive"></a>Azure Resource Manager тестовый накопитель

Используйте этот тип, если у вас есть предложение в Azure Marketplace или AppSource, но вы хотите создать тестовый выпуск только с ресурсами Azure. Шаблон Azure Resource Manager (ARM) — это закодированный контейнер ресурсов Azure, которые вы разрабатываете для лучшего представления решения. Тестовый диск использует указанный шаблон ARM и развертывает все необходимые ресурсы для группы ресурсов. Это единственный вариант тестового диска для виртуальных машин или предложений приложений Azure.

Если вы не знакомы с шаблоном ARM, прочитайте [Azure Resource Manager?](../azure-resource-manager/management/overview.md) и ознакомьтесь [со структурой и СИНТАКСИСом шаблонов ARM](../azure-resource-manager/templates/template-syntax.md) , чтобы лучше понять, как создавать и тестировать собственные шаблоны.

Сведения о **размещенном** или тестовом накопителе **приложения логики** см. в статье [что такое тестовый накопитель?](what-is-test-drive.md)

## <a name="technical-configuration"></a>Техническая конфигурация

Шаблон развертывания содержит все ресурсы Azure, составляющие ваше решение. Для этого сценария подходят приложения, использующие только ресурсы Azure. Задайте следующие свойства в центре партнеров:

- **Регионы** (обязательно) — в настоящее время Azure поддерживает 26 регионов для тестового выпуска. Как правило,тестовый выпуск должен быть доступен в тех регионах, где вы ожидаете наибольшее число клиентов, чтобы можно было выбрать ближайший регион для лучшей производительности. Нужно гарантировать, что подписка допускает развертывание всех ресурсов, необходимых в каждом из выбранных вами регионов.

- **Экземпляры** — выберите тип (горячий или холодный) и количество доступных экземпляров, которые будут умножены на количество регионов, где доступно предложение.

  - **Горячий** — этот тип экземпляра развертывается и ожидает доступа в выбранном регионе. Клиенты могут мгновенно получить доступ к *горячим* экземплярам тестового выпуска, не ожидая их развертывания. Недостаток в том, что эти экземпляры всегда выполняются в вашей подписке Azure, так что за их работу будет взиматься больше средств. Настоятельно рекомендуется запустить по крайней мере один *горячий* экземпляр, так как большинство клиентов не хотят ждать полного развертывания, и отсутствие *горячего* экземпляра ведет к падению популярности среди клиентов.

  - **Холодный** — этот тип экземпляра представляет общее количество экземпляров, которые могут быть развернуты для каждого региона. Для холодных экземпляров требуется полное развертывание шаблона тестового выпуска Resource Manager по запросу клиента, так что *холодные* экземпляры загружаются гораздо медленнее, чем *горячие*. Преимущество заключается в том, что необходимо платить только за время тестового выпуска. Он *не* всегда выполняется в подписке Azure, как в случае с *горячим* экземпляром.

- **Шаблон тестового выпуска Azure Resource Manager** — отправьте ZIP-файл, содержащий шаблон Azure Resource Manager. Дополнительные сведения о создании шаблона Azure Resource Manager см. в кратком руководстве [Создание и развертывание шаблонов Azure Resource Manager на портале Azure](../azure-resource-manager/templates/quickstart-create-templates-use-the-portal.md).

    > [!note]
    > Для успешной публикации важно проверить форматирование шаблона ARM. Это можно сделать двумя способами: (1) с помощью [интерактивного средства API](/rest/api/resources/deployments/validate) или (2) с [тестовым развертыванием](../azure-resource-manager/templates/deploy-portal.md).

- **Продолжительность тестового выпуска** (обязательно) — укажите количество часов, в течение которых тестовый выпуск будет оставаться активным. Тестовый выпуск автоматически завершит работу по истечении этого периода. Используйте только целые числа (пример: 2 — допустимое количество часов, а 1,5 — нет).

## <a name="write-the-test-drive-template"></a>Создание шаблона тестового диска

После создания необходимого пакета ресурсов создайте и создайте шаблон ARM для тестового диска. Поскольку тестовый выпуск запускает развертывания в полностью автоматическом режиме, шаблоны тестового диска имеют некоторые ограничения.

### <a name="parameters"></a>Параметры

Большинство шаблонов имеют набор параметров, определяющих имена ресурсов, размеры ресурсов (например, типы учетных записей хранения или размеры виртуальных машин), имена пользователей и пароли, DNS-имена и т. д. При развертывании решений с помощью портала Azure можно вручную заполнить все эти параметры, выбрать доступные DNS-имена или имена учетных записей хранения и так далее.

![Список параметров в Azure Resource Manager](media/test-drive/resource-manager-parameters.png)

Однако тестовый диск работает автоматически, без участия человека, поэтому он поддерживает только ограниченный набор категорий параметров. Если параметр в шаблоне тестового диска не попадает в одну из поддерживаемых категорий, необходимо заменить этот параметр на переменную или постоянное значение.

Для параметров можно использовать любое допустимое имя. тестовый диск распознает категорию параметра, используя значение типа метаданных. Укажите тип метаданных для каждого параметра шаблона, иначе шаблон не будет проходить проверку:

```JSON
"parameters": {
  ...
  "username": {
    "type": "string",
    "metadata": {
      "type": "username"
    }
  },
  ...
}
```

> [!NOTE]
> Все параметры являются необязательными, поэтому, если вы не хотите использовать их, вам не нужно.

### <a name="accepted-parameter-metadata-types"></a>Допустимые типы метаданных параметров

| Тип метаданных   | Тип параметра  | Описание     | Образец значения    |
|---|---|---|---|
| **baseUri**     | строка          | Базовый универсальный код ресурса (URI) пакета развертывания| `https://<..>.blob.core.windows.net/<..>` |
| **username**    | строка          | Новое случайное имя пользователя.| admin68876      |
| **password**    | защищенная строка    | Новый случайный пароль | Lp!ACS\^2kh     |
| **Идентификатор сеанса**   | строка          | Уникальный идентификатор сеанса тестового диска (GUID)    | b8c8693e-5673-449c-badd-257a405a6dee |

#### <a name="baseuri"></a>baseUri

Тестовый диск Инициализирует этот параметр **базовым URI** пакета развертывания, чтобы можно было использовать этот параметр для создания URI любого файла, входящего в пакет.

```JSON
"parameters": {
  ...
  "baseuri": {
    "type": "string",
    "metadata": {
      "type": "baseuri",
      "description": "Base Uri of the deployment package."
    }
  },
  ...
}
```

Используйте этот параметр внутри шаблона, чтобы создать URI любого файла из пакета развертывания тестового диска. В следующем примере показано, как создать URI связанного шаблона.

```JSON
"templateLink": {
  "uri": "[concat(parameters('baseuri'),'templates/solution.json')]",
  "contentVersion": "1.0.0.0"
}
```

#### <a name="username"></a>username

Тестовый диск Инициализирует этот параметр новым случайным именем пользователя:

```JSON
"parameters": {
  ...
  "username": {
    "type": "string",
    "metadata": {
      "type": "username",
      "description": "Solution admin name."
    }
  },
  ...
}
```

Пример значения: `admin68876`

Для вашего решения можно задействовать как случайные, так и постоянные имена пользователей.

#### <a name="password"></a>password

Тестовый диск Инициализирует этот параметр новым случайным паролем:

```JSON
"parameters": {
  ...
  "password": {
    "type": "securestring",
    "metadata": {
      "type": "password",
      "description": "Solution admin password."
    }
  },
  ...
}
```

Пример значения:  `Lp!ACS^2kh`

Для вашего решения можно задействовать как случайные, так и постоянные пароли.

#### <a name="session-id"></a>session ID

Тестовый диск Инициализирует этот параметр уникальным идентификатором GUID, представляющим идентификатор сеанса тестового диска:

```JSON
"parameters": {
  ...
  "sessionid": {
    "type": "string",
    "metadata": {
      "type": "sessionid",
      "description": "Unique test drive session id."
    }
  },
  ...
}
```

Пример значения: `b8c8693e-5673-449c-badd-257a405a6dee`

Этот параметр можно использовать для уникальной идентификации сеанса тестового диска, если это необходимо.

### <a name="unique-names"></a>Уникальные имена

Для некоторых ресурсов Azure, например учетных записей хранения или DNS-имен, требуются глобально уникальные имена. Это означает, что каждый раз, когда тестовый диск развертывает шаблон ARM, он создает новую группу ресурсов с уникальным именем для всех ее ресурсов. Поэтому для создания случайных уникальных значений необходимо использовать функцию [uniquestring](../azure-resource-manager/templates/template-functions.md) , объединенную с именами переменных в идентификаторах групп ресурсов:

```JSON
"variables": {
  ...
  "domainNameLabel": "[concat('contosovm',uniquestring(resourceGroup().id))]",
  "storageAccountName": "[concat('contosodisk',uniquestring(resourceGroup().id))]",
  ...
}
```

Убедитесь, что вы объединяете строки параметров и переменных ( `contosovm` ) с уникальным строковым выходом ( `resourceGroup().id` ), так как это гарантирует уникальность и надежность каждой переменной.

Например, большинство имен ресурсов не могут начинаться с цифры, но уникальная строковая функция может вернуть строку, которая начинается с цифры. Таким образом, при использовании необработанных уникальных строковых выходных данных развертывание завершится ошибкой.

Дополнительные сведения о правилах и ограничениях именования ресурсов можно найти в [этой статье](/azure/cloud-adoption-framework/ready/azure-best-practices/naming-and-tagging).

### <a name="deployment-location"></a>Расположение развертывания

Вы можете сделать тестовый накопитель доступным в разных регионах Azure. Идея в том, чтобы позволить пользователю выбрать ближайший регион для максимального удобства работы.

Когда тестовый диск создает экземпляр лаборатории, он всегда создает группу ресурсов в выбранном пользователем регионе, а затем выполняет шаблон развертывания в этом контексте группы. Таким образом, шаблон должен выбирать расположение развертывания из группы ресурсов:

```JSON
"variables": {
  ...
  "location": "[resourceGroup().location]",
  ...
}
```

А затем использовать это расположение для каждого ресурса в конкретном экземпляре лаборатории:

```JSON
"resources": [
  {
    "type": "Microsoft.Storage/storageAccounts",
    "location": "[variables('location')]",
    ...
  },
  {
    "type": "Microsoft.Network/publicIPAddresses",
    "location": "[variables('location')]",
    ...
  },
  {
    "type": "Microsoft.Network/virtualNetworks",
    "location": "[variables('location')]",
    ...
  },
  {
    "type": "Microsoft.Network/networkInterfaces",
    "location": "[variables('location')]",
    ...
  },
  {
    "type": "Microsoft.Compute/virtualMachines",
    "location": "[variables('location')]",
    ...
  }
]
```

Убедитесь, что ваша подписка разрешается развертывать все необходимые ресурсы в каждом из выбранных регионов. Также убедитесь, что образы виртуальных машин доступны во всех регионах, которые вы будете включать, в противном случае шаблон развертывания не будет работать в некоторых регионах.

### <a name="outputs"></a>Выходные данные

Обычно с помощью шаблонов диспетчер ресурсов можно развертывать без вывода выходных данных. Причина в том, что вам известны все значения, используемые для заполнения параметров шаблона, и всегда можно вручную проверить свойства любого ресурса.

Однако для тестового диска диспетчер ресурсов шаблоны важно вернуться к тесту, чтобы получить доступ к лаборатории (URI веб-сайта, имена узлов виртуальных машин, имена пользователей и пароли). Убедитесь, что все выходные имена доступны для чтения, так как эти переменные представлены для клиента.

Для выходных данных шаблона отсутствуют ограничения. Тестовый диск преобразует все выходные значения в строки, поэтому при отправке объекта в выходные данные пользователь увидит строку JSON.

Пример

```JSON
"outputs": {
  "Host Name": {
    "type": "string",
    "value": "[reference(variables('pubIpId')).dnsSettings.fqdn]"
  },
  "User Name": {
    "type": "string",
    "value": "[parameters('adminName')]"
  },
  "Password": {
    "type": "string",
    "value": "[parameters('adminPassword')]"
  }
}
```

### <a name="subscription-limits"></a>Ограничения подписки

Не забывайте об ограничениях подписки и службы. Например, если вы хотите развернуть до 10 4-Core виртуальных машин, необходимо убедиться, что подписка, используемая для лаборатории, позволяет использовать 40 ядер. Дополнительные сведения об ограничениях подписки и службы Azure см. в статье [Подписка Azure и ограничения службы, квоты и ограничения](../azure-resource-manager/management/azure-subscription-service-limits.md). Так как несколько тестовых дисков могут быть выполнены одновременно, убедитесь, что подписка может обрабатывать количество ядер, умноженное на общее количество параллельных тестовых дисков, которые могут быть выполнены.

### <a name="what-to-upload"></a>Что следует отправлять

Шаблон ARM для тестового диска передается в виде ZIP-файла, который может включать в себя различные артефакты развертывания, но должен иметь один файл с именем `main-template.json` . Это шаблон развертывания ARM, который тестовый диск использует для создания экземпляра лаборатории. Если у вас есть дополнительные ресурсы, помимо этого файла, вы можете ссылаться на них как на внешние ресурсы в шаблоне или включить их в ZIP-файл.

Во время сертификации публикации тестовый диск распаковать пакет развертывания и поместит его содержимое во внутренний контейнер больших двоичных объектов тестового диска. Структура контейнера отражает структуру пакета развертывания:

| package.zip                       | Контейнер больших двоичных объектов тестового диска         |
|---|---|
| `main-template.json`                | `https:\//\<\...\>.blob.core.windows.net/\<\...\>/main-template.json`  |
| `templates/solution.json`           | `https:\//\<\...\>.blob.core.windows.net/\<\...\>/templates/solution.json` |
| `scripts/warmup.ps1`                | `https:\//\<\...\>.blob.core.windows.net/\<\...\>/scripts/warmup.ps1`  |
|||

Мы называем URI этого контейнера больших двоичных объектов базовым URI. Так как каждая редакция лаборатории имеет собственный контейнер больших двоичных объектов, каждая редакция лаборатории имеет собственный базовый URI. Тестовый диск может передавать базовый URI распакованного пакета развертывания в шаблон с помощью параметров шаблона.

### <a name="transform-template-examples-for-test-drive"></a>Примеры шаблонов преобразования для тестового диска

Процесс включения архитектуры ресурсов в тестовый выпуск диспетчер ресурсов шаблона может быть непростой задачей. Дополнительные сведения см. в следующих примерах того, как лучше преобразовать текущие шаблоны развертывания в разделе [что такое тестовый накопитель?](what-is-test-drive.md#transforming-examples).

## <a name="test-drive-deployment-subscription-details"></a>Сведения о подписке на развертывание тестового диска

Последний раздел для завершения — возможность автоматического развертывания тестовых дисков путем подключения подписки Azure и Azure Active Directory (AD).

![Сведения о подписке на развертывание тестового диска](media/test-drive/deployment-subscription-details.png)

1. Получите **идентификатор подписки Azure**. Предоставляет доступ к службам Azure и порталу Azure. Именно в подписке производится учет использования ресурсов и выставляются счета за услуги. Если у вас еще нет отдельной подписки Azure для тестовых дисков, сделайте это. Вы можете найти идентификаторы подписок Azure (например, `1a83645ac-1234-5ab6-6789-1h234g764ghty1` ), войдя в портал Azure и выбрав **подписки** в меню слева.

   ![Подписки Azure](media/test-drive/azure-subscriptions.png)

2. Получите **идентификатор клиента Azure AD**. Если у вас уже есть идентификатор клиента, его можно найти в **Azure Active Directory**  >  **Свойства**  >  **идентификатор каталога**:

   ![Пункт "Свойства" для Azure Active Directory](media/test-drive/azure-active-directory-properties.png)

   Если у вас нет идентификатора клиента, создайте его в Azure Active Directory. Сведения о настройке клиента см. в разделе [Краткое руководство. Настройка клиента](../active-directory/develop/quickstart-create-new-tenant.md).

3. **Идентификатор Azure AD App** — создайте и зарегистрируйте новое приложение. Мы будем использовать это приложение для выполнения операций с экземпляром тестового диска.

   1. Перейдите к только что созданному каталогу или уже существующему каталогу и выберите Azure Active Directory на панели фильтра.
   2. Найдите **Регистрация приложений** и выберите **Добавить**.
   3. Введите имя приложения.
   4. Выберите **тип** **веб-приложения или API**.
   5. Укажите любое значение в URL-адресе входа. это поле не используется.
   6. Нажмите кнопку **создания**.
   7. После создания приложения выберите **Свойства**  >  **настроить приложение как многопользовательский** , а затем **Сохраните**.

4. Щелкните **Сохранить**.

5. Скопируйте идентификатор приложения для этого зарегистрированного приложения и вставьте его в поле "тестовый выпуск".

   ![Сведения об идентификаторе приложения Azure AD](media/test-drive/azure-ad-application-id-detail.png)

6. Так как мы используем приложение для развертывания в подписке, необходимо добавить приложение в качестве участника в подписку:

   1. Выберите тип **подписки** , которую вы используете для тестового диска.
   1. Выберите **Управление доступом (IAM)** .
   1. Перейдите на вкладку **назначения ролей** и **добавьте назначение ролей**.

      ![Добавление нового участника службы управления доступом](media/test-drive/access-control-principal.jpg)

   1. Задайте **роль** и **назначьте доступ к** , как показано ниже. В поле **Выбор** введите имя приложения Azure AD. Выберите приложение, которому необходимо назначить роль **участника** .

      ![Добавление разрешений](media/test-drive/access-control-permissions.jpg)

   1. Щелкните **Сохранить**.

7. Создание ключа проверки подлинности **Azure AD App** . В разделе **ключи** добавьте **Описание ключа**, задайте срок **действия бессрочный** (ключ с истекшим сроком действия приведет к разрыву тестового диска в рабочей среде), а затем нажмите кнопку **сохранить**. Скопируйте и вставьте это значение в поле требуемый тестовый диск.

![Отображение ключей для приложения Azure AD](media/test-drive/azure-ad-app-keys.png)

## <a name="republish"></a>Повторная публикация

Теперь, когда все поля тестового диска завершены, **опубликуйте предложение повторно** . После того, как тестовый диск прошел сертификацию, протестируйте его в предварительной версии предложения:

1. Запустите тестовый диск в пользовательском интерфейсе.
1. Откройте подписку Azure в портал Azure.
1. Убедитесь, что тестовый диск развернут правильно.

   ![Портал Azure](media/test-drive/azure-portal.png)

Не удаляйте все экземпляры тестовых дисков, подготовленные для клиентов. Служба тестового диска автоматически очистит эти группы ресурсов после завершения работы клиента.

Когда вы сможете **воспользоваться** предварительной версией предложения, пора приступить к работе! Существует заключительный процесс проверки, позволяющий дважды проверить всю сквозную работу. Если мы отклоним предложение, мы будем отправлять по электронной почте Контактное лицо для вашего предложения, объясняющее, что необходимо исправить.

## <a name="next-steps"></a>Дальнейшие действия

- Если вы выполните инструкции по созданию предложения в центре партнеров, вернитесь к этому разделу с помощью стрелки "назад".
- Дополнительные сведения о других типах тестовых дисков см. в статье [что такое тестовый накопитель?](what-is-test-drive.md).