---
title: Сведения о партнере коммерческого рынка и использовании клиентов
description: Узнайте, как отслеживать использование решений Azure Marketplace клиентами.
ms.service: marketplace
ms.subservice: partnercenter-marketplace-publisher
ms.topic: article
author: cpercy737
ms.author: camper
ms.date: 11/4/2020
ms.custom: devx-track-terraform
ms.openlocfilehash: 99e1e77a37afbdc1ed54767700574316ed03fae3
ms.sourcegitcommit: ea822acf5b7141d26a3776d7ed59630bf7ac9532
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/03/2021
ms.locfileid: "99525251"
---
# <a name="commercial-marketplace-partner-and-customer-usage-attribution"></a>Сведения о партнере коммерческого рынка и использовании клиентов

Отслеживание потребления услуг клиентами — это метод, позволяющий связать (сопоставить) ресурсы Azure, работающие в рамках клиентских подписок и развернутых в вашем решении, с вами в качестве партнера Майкрософт. Такие связи и сопоставления во внутренних системах Майкрософт помогают лучше контролировать использование ресурсов Azure вашим программным обеспечением. Используя этот механизм отслеживания, вы поможете отделам продаж Майкрософт и получите дополнительные преимущества по партнерским программам Майкрософт.

Такие связи можно создавать с помощью Azure Marketplace, репозитория шаблонов быстрого запуска, частных репозиториев GitHub и индивидуальных соглашений с клиентами, в рамках которых им присваиваются постоянные IP-адреса (например, для разработки приложения).

В рамках отслеживания потребления услуг клиентами поддерживаются три варианта развертывания.

- Шаблоны Azure Resource Manager. Партнеры могут с помощью шаблонов Resource Manager развертывать службы Azure для запуска своего программного обеспечения. Партнеры могут создать шаблон Resource Manager, который определяет инфраструктуру и конфигурацию решения Azure. Шаблон Resource Manager позволит вам и вашим клиентам легко развертывать решение на всем протяжении его жизненного цикла. Вы можете быть уверены, что все ресурсы развертываются в согласованном состоянии.
- API Azure Resource Manager. Партнеры могут напрямую вызывать интерфейсы API Resource Manager, чтобы развернуть шаблон Azure Resource Manager или создавать вызовы API для непосредственной подготовки служб Azure.
- Terraform. Партнеры могут использовать Terraform для развертывания шаблонов Resource Manager или непосредственного развертывания служб Azure.

>[!IMPORTANT]
>- Механизм отслеживания потребления услуг клиентами не предназначен для отслеживания работы системных интеграторов, поставщиков управляемых услуг или инструментов, которые применяются для развертывания программного обеспечения на платформе Azure и управления им.
>
>- Механизм отслеживания потребления услуг клиентами применяется при развертывании новых служб и НЕ распространяется на существующие ресурсы, которые уже развернуты.
>
>- Отслеживание потребления услуг клиентами — обязательное условие при публикации [приложений Azure](./create-new-azure-apps-offer.md) в Microsoft Azure Marketplace.
>
>- Не все службы Azure совместимы с атрибутами использования клиентов. В настоящее время в службах Azure Kubernetes Services (AKS) и масштабируемых наборах виртуальных машин есть известные проблемы, которые приводят к появлению отчетов об использовании.

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

## <a name="create-guids"></a>Создание глобальных уникальных идентификаторов

Идентификатор GUID является уникальным идентификатором из 32 шестнадцатеричных цифр и используется для создания ссылок. Чтобы создать идентификаторы GUID для отслеживания, следует использовать генератор GUID, например, с помощью PowerShell.

```powershell
[guid]::NewGuid()
```

Рекомендуется создавать уникальные GUID для всех предложений и каналов распределения каждого продукта. Можно использовать один идентификатор GUID для нескольких каналов распределения, если дробить отчетность нежелательно.

Если продукт развертывается с помощью шаблона и доступен как в Azure Marketplace, так и в GitHub, можно создать и зарегистрировать два отдельных идентификатора GUID:

- продукт А в Azure Marketplace;
- продукт А на сайте GitHub.

Учет осуществляется по идентификатору Microsoft Partner Network и GUID.

Отслеживание также можно вести на более подробном уровне, зарегистрировав дополнительные GUID и используя разные GUID в разных планах (разновидностях вашего предложения).

## <a name="register-guids"></a>Регистрация уникальных идентификаторов GUID

Для отслеживания потребления услуг клиентами идентификаторы GUID регистрируются в Центре партнеров.

После того как вы добавите GUID в шаблон или агент пользователя и зарегистрируете GUID в Центре партнеров, все развертывания с ним будут отслеживаться.

> [!NOTE]
> Если вы публикуете предложение [приложения Azure](./create-new-azure-apps-offer.md) в Azure Marketplace с помощью центра партнеров, все новые идентификаторы GUID, используемые в шаблоне, будут автоматически зарегистрированы в вашем профиле центра партнеров при передаче шаблона.  

1. Войдите в [Центр партнеров](https://partner.microsoft.com/dashboard).

1. Зарегистрируйтесь как [коммерческий издатель Azure Marketplace](https://aka.ms/JoinMarketplace).

   * У каждого партнера должен быть [свой профиль в Центре партнеров](./partner-center-portal/create-account.md). Мы рекомендуем вам опубликовать свое предложение в Azure Marketplace или AppSource.
   * Любой партнер может зарегистрировать несколько идентификаторов GUID.
   * Партнеры могут регистрировать GUID даже для предложений и (или) шаблонов решений, не включенных в Marketplace.

1. Щелкните **Параметры** (значок шестеренки) в правом верхнем углу > **Параметры учетной записи**.

1. В меню  >  **идентификаторы** профиля организации выберите **добавить GUID отслеживания**.

1. В поле **GUID** введите созданный GUID отслеживания. Введите только GUID без `pid-` префикса. В поле **Description** (Описание) введите произвольное название или описание предложения.

1. Чтобы зарегистрировать дополнительный идентификатор GUID, снова щелкните **Add Tracking GUID** (Добавить GUID отслеживания). На странице появятся дополнительные поля.

1. Щелкните **Сохранить**.

## <a name="use-resource-manager-templates"></a>Использование шаблонов Resource Manager
Многие решения партнеров развертываются с помощью шаблонов Azure Resource Manager. Если у вас есть шаблон диспетчер ресурсов, доступный в Azure Marketplace, в GitHub или в качестве краткого руководства, процесс изменения шаблона для включения атрибутов использования клиентов будет прямым.

> [!NOTE]
> Дополнительные сведения о создании и публикации шаблонов решений см. в статье
> * [Краткое руководство. Создание и развертывание шаблонов Azure Resource Manager с помощью портала Azure](../azure-resource-manager/templates/quickstart-create-templates-use-the-portal.md).
>* [Предложение приложения Azure](./create-new-azure-apps-offer.md).
>* Видео. [Создание шаблонов решений и управляемых приложений для Azure Marketplace](https://channel9.msdn.com/Events/Build/2018/BRK3603).


Чтобы добавить глобальный уникальный идентификатор (GUID), в основной файл шаблона нужно внести всего одно изменение.

1. [Создайте GUID](#create-guids) с помощью предлагаемого метода и [зарегистрируйте GUID](#register-guids).

1. Откройте шаблон Resource Manager.

1. Добавьте новый ресурс типа [Microsoft. Resources/deployments](/azure/templates/microsoft.resources/deployments) в основной файл шаблона. Этот ресурс можно указать только в файле **mainTemplate.json** или **azuredeploy.json**, но не во вложенных или связанных шаблонах.

1. Введите значение GUID после `pid-` префикса в качестве имени ресурса. Например, если GUID имеет значение eb7927c8-dd66-43e1-b0cf-c346a422063, имя ресурса будет иметь значение _PID-eb7927c8-dd66-43e1-b0cf-c346a422063_.

1. Проверьте шаблон на наличие ошибок.

1. Повторно опубликуйте шаблон в соответствующих репозиториях.

1. [Проверка GUID в развертывании шаблона](#verify-the-guid-deployment).

### <a name="sample-resource-manager-template-code"></a>Пример кода шаблона Resource Manager

Чтобы включить отслеживание ресурсов для шаблона, необходимо добавить следующие дополнительные ресурсы в разделе ресурсов. Обязательно измените данные в примере кода ниже своими входными данными, когда будете добавлять его в основной файл шаблона.
Этот ресурс должен быть добавлен только в файл **mainTemplate.json** или **azuredeploy.json**, но не во вложенные или связанные шаблоны.

```json
// Make sure to modify this sample code with your own inputs where applicable

{ // add this resource to the resources section in the mainTemplate.json (do not add the entire file)
    "apiVersion": "2020-06-01",
    "name": "pid-XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX", // use your generated GUID here
    "type": "Microsoft.Resources/deployments",
    "properties": {
        "mode": "Incremental",
        "template": {
            "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
            "contentVersion": "1.0.0.0",
            "resources": []
        }
    }
} // remove all comments from the file when complete
```

## <a name="use-the-resource-manager-apis"></a>Использование интерфейсов API Resource Manager

В некоторых случаях будет удобно напрямую вызывать интерфейсы REST API Resource Manager для развертывания служб Azure. [Azure поддерживает несколько пакетов SDK](../index.yml?pivot=sdkstools), позволяющих реализовать такие вызовы. Можно использовать один из пакетов SDK или вызывать REST API напрямую для развертывания ресурсов.

Если вы используете шаблон Azure Resource Manager, присвойте решению тег, выполнив приведенные выше инструкции. Если вместо применения шаблона Azure Resource Manager вы выполняете прямые вызовы к API, у вас сохраняется возможность присвоить развертыванию тег для связывания с информацией об использовании ресурсов Azure.

### <a name="tag-a-deployment-with-the-resource-manager-apis"></a>Присвоение тегов развертыванию с помощью интерфейсов API Resource Manager

Чтобы реализовать отслеживанию потребления услуг клиентами, включите идентификатор GUID в заголовок агента пользователя в запросе при создании вызовов API. Добавьте отдельный идентификатор GUID для каждого предложения или номера SKU. Отформатируйте строку `pid-` префиксом и включите созданный партнером идентификатор GUID. Ниже приведен пример формата для включения GUID в агент пользователя:

![Пример формата GUID](media/marketplace-publishers-guide/tracking-sample-guid-for-lu-2.PNG)

> [!NOTE]
> Важно соблюдать формат строки. Если `pid-` префикс не указан, запрос данных невозможен. Разные пакеты SDK выполняют отслеживание по-разному. Чтобы реализовать этот метод, изучите сведения о поддержке и процессах отслеживания для выбранного пакета SDK Azure.

#### <a name="example-the-python-sdk"></a>Пример Пакет SDK для Python

В Python используется атрибут **config**. Этот атрибут можно добавить только в UserAgent. Ниже приведен пример:

![Добавление атрибута в агент пользователя](media/marketplace-publishers-guide/python-for-lu.PNG)

> [!NOTE]
> Добавьте атрибут для каждого клиента. Глобальная статическая конфигурация не поддерживается. Вы может присвоить тег фабрике клиента, чтобы гарантировать отслеживание каждого клиента. Дополнительные сведения см. в [примере фабрики клиента](https://github.com/Azure/azure-cli/blob/7402fb2c20be2cdbcaa7bdb2eeb72b7461fbcc30/src/azure-cli-core/azure/cli/core/commands/client_factory.py#L70-L79), размещенном в GitHub.

#### <a name="example-the-net-sdk"></a>Пример: пакет SDK для .NET

Для .NET обязательно задайте агент пользователя. Библиотеку [Microsoft. Azure. Management. Fluent](/dotnet/api/microsoft.azure.management.fluent) можно использовать для задания агента пользователя с помощью следующего кода (пример в C#):

```csharp

var azure = Microsoft.Azure.Management.Fluent.Azure
    .Configure()
    // Add your pid in the user agent header
    .WithUserAgent("pid-XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX", String.Empty) 
    .Authenticate(/* Credentials created via Microsoft.Azure.Management.ResourceManager.Fluent.SdkContext.AzureCredentialsFactory */)
    .WithSubscription("<subscription ID>");
```

#### <a name="tag-a-deployment-by-using-the-azure-powershell"></a>Присвоение тега развертыванию с помощью Azure PowerShell

Если для развертывания ресурсов вы используете Azure PowerShell, идентификатор GUID можно добавить следующим способом:

```powershell
[Microsoft.Azure.Common.Authentication.AzureSession]::ClientFactory.AddUserAgent("pid-eb7927c8-dd66-43e1-b0cf-c346a422063")
```

#### <a name="tag-a-deployment-by-using-the-azure-cli"></a>Присвоение тега развертыванию с помощью Azure CLI

Чтобы добавить GUID с помощью Azure CLI, задайте переменную среды **AZURE_HTTP_USER_AGENT**. Значение этой переменной можно задать в области скрипта. Также ее можно задать глобально для области оболочки:

```powershell
export AZURE_HTTP_USER_AGENT='pid-eb7927c8-dd66-43e1-b0cf-c346a422063'
```

Дополнительные сведения см. в описании пакета [Azure SDK для Go](/azure/developer/go/).

## <a name="use-terraform"></a>Использование Terraform

Поддержка Terraform доступна в выпуске Azure Provider 1.21.0: [https://github.com/terraform-providers/terraform-provider-azurerm/blob/master/CHANGELOG.md#1210-january-11-2019](https://github.com/terraform-providers/terraform-provider-azurerm/blob/master/CHANGELOG.md#1210-january-11-2019).  Эта поддержка распространяется на всех партнеров, которые развертывают свои решения через Terraform, и все ресурсы, развернутые и отслеживаемые через Azure Provider (версии 1.21.0 или более поздней).

В Azure Provider для Terraform добавлено новое необязательное поле [*partner_id*](https://www.terraform.io/docs/providers/azurerm/#partner_id), в котором можно указать GUID отслеживания для решения. Значение этого поля также можно получить из переменной среды *ARM_PARTNER_ID*.

```
provider "azurerm" {
          subscription_id = "xxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
          client_id = "xxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
          ……
          # new stuff for ISV attribution
          partner_id = "xxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"}
```
Партнеры, которые хотят реализовать отслеживание потребления услуг клиентами для своего развертывания в Terraform, должны выполнить перечисленные ниже шаги.

* Создать GUID (он должен быть добавлен для каждого предложения или SKU).
* В Azure Provider установить для поля *partner_id* значение GUID (БЕЗ префикса pid-: необходимо указать фактическое значение GUID).

## <a name="verify-the-guid-deployment"></a>Проверка развертывания GUID

Когда вы измените шаблон и выполните тестовое развертывание, запустите указанный ниже скрипт PowerShell, чтобы получить данные о развернутых ресурсах с указанным тегом.

Этот скрипт позволяет убедиться, что GUID успешно добавлен в шаблон Resource Manager. Скрипт не применяется при развертывании через API Resource Manager или Terraform.

Войдите в Azure. Перед выполнением скрипта выберите подписку, в которой размещено тестируемое развертывание. Выполните скрипт в контексте подписки развертывания.

Скрипт принимает **GUID** и **resourceGroup** (имя группы ресурсов) в качестве обязательных параметров.

[Оригинал этого скрипта](https://gist.github.com/bmoore-msft/ae6b8226311014d6e7177c5127c7eba1#file-verify-deploymentguid-ps1) размещен в GitHub.

```powershell
Param(
    [GUID][Parameter(Mandatory=$true)]$guid,
    [string][Parameter(Mandatory=$true)]$resourceGroupName
)

# Get the correlationId of the pid deployment

$correlationId = (Get-AzResourceGroupDeployment -ResourceGroupName
$resourceGroupName -Name "pid-$guid").correlationId

# Find all deployments with that correlationId

$deployments = Get-AzResourceGroupDeployment -ResourceGroupName $resourceGroupName | Where-Object{$_.correlationId -eq $correlationId}

# Find all deploymentOperations in a deployment by name
# PowerShell doesn't surface outputResources on the deployment
# or correlationId on the deploymentOperation

foreach ($deployment in $deployments){

# Get deploymentOperations by deploymentName
# then the resourceId for any create operation

($deployment | Get-AzResourceGroupDeploymentOperation | Where-Object{$_.properties.provisioningOperation -eq "Create" -and $_.properties.targetResource.resourceType -ne "Microsoft.Resources/deployments"}).properties.targetResource.id

}
```
## <a name="report"></a>Report
В настоящее время отчеты об использовании Azure, которые отправляются с помощью атрибутов использования клиентов, недоступны для партнеров независимых поставщиков программного обеспечения. Добавление отчетов в программу коммерческого рынка в центре партнеров для покрытия атрибутов использования клиентов нацелена на вторую половину 2021.

## <a name="notify-your-customers"></a>Информирование клиентов

Партнер следует оповестить своих клиентов о том, что их развертывания отслеживаются на предмет потребления услуг клиентами. Корпорация Майкрософт передает партнеру сведения о потреблении ресурсов Azure, связанном с этими развертываниями. Ниже представлены примеры сообщений, которые можно использовать для уведомления клиентов о таких развертываниях. В примерах замените \<PARTNER> именем вашей компании. Кроме того, нужно согласовать эти сообщения с политиками конфиденциальности и сбора данных, используемыми партнером, а также предоставить клиенту возможность отключить отслеживание.

### <a name="notification-for-resource-manager-template-deployments"></a>Информационное сообщение для развертываний с помощью шаблона Resource Manager

При развертывании этого шаблона Корпорация Майкрософт может опознать установку \<PARTNER> программного обеспечения с развернутыми ресурсами Azure. Корпорация Майкрософт может отслеживать ресурсы Azure, используемые для работы этого программного обеспечения. Корпорация Майкрософт собирает эти сведения, чтобы максимально повысить качество использования своих продуктов и делового сотрудничества. Данные собираются и управляются политиками конфиденциальности Майкрософт, которые можно найти по адресу [https://www.microsoft.com/trustcenter](https://www.microsoft.com/trustcenter) .

### <a name="notification-for-sdk-or-api-deployments"></a>Информационное сообщение для развертываний с использованием пакета SDK или API

При развертывании \<PARTNER> программного обеспечения корпорация Майкрософт может опознать установку \<PARTNER> программного обеспечения с развернутыми ресурсами Azure. Корпорация Майкрософт может отслеживать ресурсы Azure, используемые для работы этого программного обеспечения. Корпорация Майкрософт собирает эти сведения, чтобы максимально повысить качество использования своих продуктов и делового сотрудничества. Данные собираются и управляются политиками конфиденциальности Майкрософт, которые можно найти по адресу [https://www.microsoft.com/trustcenter](https://www.microsoft.com/trustcenter) .

## <a name="get-support"></a>Получение поддержки

Узнайте о вариантах поддержки в коммерческом магазине по [поддержке программы коммерческого рынка в центре партнеров](support.md).

### <a name="how-to-submit-a-technical-consultation-request"></a>Как подать запрос техническому консультанту

1. Зайдите на страницу [технических услуг для партнеров](https://aka.ms/TechnicalJourney).
1. Выберите раздел Cloud infrastructure and management (Облачная инфраструктура и управление). Откроется новая страница с описанием соответствующей технической процедуры.
1. В разделе Deployment Services (Службы развертывания) нажмите кнопку Submit a request (Подать запрос).
1. Войдите со своими учетными данными MSA (учетной записью MPN) или AAD (учетной записью панели мониторинга партнера). Откроется форма веб-запроса:
    * Укажите или проверьте контактные данные.
    * Детали вашего обращения могут быть подставлены автоматически; в противном случае выберите их из раскрывающихся списков.
    * Введите заголовок и описание проблемы (опишите ее как можно подробнее).

1. Щелкните "Submit" (Отправить).

Ознакомьтесь с пошаговыми инструкциями и снимками экрана на странице [Использование услуг технической поддержки в предпродажной работе и развертывании](https://aka.ms/TechConsultInstructions).

### <a name="whats-next"></a>Что дальше?

Технический консультант для партнеров Майкрософт свяжется с вами, чтобы запланировать беседу для уточнения ваших вопросов.

## <a name="faq"></a>ВОПРОСЫ И ОТВЕТЫ

**Зачем добавлять GUID в шаблон?**

Корпорация Майкрософт предоставляет партнерам сведения о развертывании их решений клиентами, а также о потреблении ими ресурсов. Корпорация Майкрософт и партнер могут использовать эту информацию, чтобы обеспечить более плотное взаимодействие между отделами продаж. Корпорация Майкрософт и партнер также могут использовать эти данные для оценки влияния отдельных партнеров на рост и развитие Azure.

**Можно ли изменить добавленный ранее GUID?**

Да, клиент или партнер по реализации может изменять шаблон, удалять GUID или указывать другой GUID. Мы рекомендуем заранее объяснять роль и смысл ресурса и GUID клиентам и партнерам, чтобы предотвратить удаление или изменение GUID. Изменение GUID влияет только на новые развертывания и ресурсы, но не затрагивает уже существующие.

**Можно ли отслеживать шаблоны, развертываемые из репозитория сторонних производителей, например GitHub?**

Да. Данные о потреблении будут отслеживаться, если в шаблоне на момент развертывания указан GUID. Однако партнеры все равно должны регистрировать свои GUID.

**Получает ли клиент отчеты?**

Клиенты могут отслеживать потребление отдельных ресурсов или определенных клиентом групп ресурсов на портале управления Azure. У клиентов нет доступа к сведениям о потреблении ресурсов с детализацией по GUID.

**Похожа ли эта схема на метод зарегистрированного цифрового партнера (DPOR)?**

Этот новый метод привязки развертывания и данных об использовании к решению партнера дает возможность связать решение партнера с данными об использовании ресурсов Azure. DPOR предназначен для связывания партнера, предоставляющего услуги консультирования (системный интегратор) или управления (поставщик управляемых служб), с подпиской Azure клиента.

**Можно ли использовать частный (собственный) виртуальный жесткий диск (VHD) для предложения шаблона решения в Azure Marketplace?**

Нет, нельзя. Образ виртуальной машины должен быть получен из Azure Marketplace. см. [руководство по публикации предложений виртуальных машин в Azure Marketplace](marketplace-virtual-machines.md).

Вы можете создать предложение виртуальной машины в Marketplace с использованием собственного VHD и пометить его как частное, чтобы оно не отображалось для пользователей. Затем вы можете сослаться на эту виртуальную машину в своем шаблоне решения.

**Вам не удалось обновить свойство *contentVersion* основного шаблона?**

Скорее всего, это ошибка, если шаблон развертывается с помощью TemplateLink из другого шаблона, который ожидает более ранних contentVersion по какой-либо причине. Обойти эту проблему можно путем использования свойства метаданных:

```
"$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "metadata": {
        "contentVersion": "1.0.1.0"
    },
    "parameters": {
```
