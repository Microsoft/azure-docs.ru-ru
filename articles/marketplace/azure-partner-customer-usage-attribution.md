---
title: Атрибуты использования клиентов Azure
description: Ознакомьтесь с обзором отслеживания использования клиентов для приложений Azure на коммерческом рынке и другого развертываемого IP-адреса, разработанного партнерами.
ms.service: marketplace
ms.subservice: partnercenter-marketplace-publisher
ms.topic: article
author: cpercy737
ms.author: camper
ms.date: 03/22/2021
ms.custom: devx-track-terraform
ms.openlocfilehash: ed7f27b0b8fde902f4ae9b65b9f6b4ada78f79c6
ms.sourcegitcommit: ba3a4d58a17021a922f763095ddc3cf768b11336
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/23/2021
ms.locfileid: "104799196"
---
# <a name="azure-customer-usage-attribution"></a>Атрибуты использования клиентов Azure

Атрибут "использование клиентов" связывает использование ресурсов Azure в клиентских подписках, созданных при развертывании вашего IP-адреса в качестве партнера. Такие связи и сопоставления во внутренних системах Майкрософт помогают лучше контролировать использование ресурсов Azure вашим программным обеспечением. Для [предложений приложений Azure в коммерческом магазине](#commercial-marketplace-azure-apps)эта возможность отслеживания помогает обеспечить соответствие группам продаж корпорации Майкрософт и получить кредит для партнерских программ Майкрософт.

В рамках отслеживания потребления услуг клиентами поддерживаются три варианта развертывания.

1. Шаблоны Azure Resource Manager (общие подпрограммы для приложений Azure, которые также упоминаются в коммерческом магазине как "шаблоны решений" или "управляемые приложения"): Партнеры создают шаблоны диспетчер ресурсов для определения инфраструктуры и конфигурации решений Azure. Шаблон диспетчер ресурсов позволяет клиентам развертывать ресурсы решения в единообразном и повторяемом состоянии.
1. Azure Resource Manager API: партнеры могут вызывать API диспетчер ресурсов для развертывания шаблона диспетчер ресурсов или непосредственно подготавливать службы Azure.
1. Terraform: партнеры могут использовать terraform для развертывания шаблона диспетчер ресурсов или непосредственного развертывания служб Azure.

Существуют вторичные варианты использования для атрибутов использования клиентов за пределами коммерческого рынка, описанных [Далее в этой статье](#other-use-cases).

>[!IMPORTANT]
>- Атрибуты использования клиентов не предназначены для мониторинга работы системных интеграторов, поставщиков управляемых служб или средств, разработанных в основном для развертывания ресурсов Azure и управления ими.
>- Атрибуты использования клиентов для новых развертываний и не поддерживают отслеживание уже развернутых ресурсов.
>- Не все службы Azure совместимы с атрибутами использования клиентов. Службы Azure Kubernetes Services (AKS), масштабируемые наборы виртуальных машин и пакетная служба Azure имеют известные проблемы, которые приводят к появлению отчетов об использовании.

## <a name="commercial-marketplace-azure-apps"></a>Приложения Azure для коммерческого рынка

Отслеживание использования Azure из приложений Azure, опубликованных в коммерческом магазине, происходит в основном автоматически. При отправке диспетчер ресурсов шаблона в рамках [технической настройки плана приложения Azure Marketplace](https://docs.microsoft.com/azure/marketplace/create-new-azure-apps-offer-solution#define-the-technical-configuration)центр партнеров добавит идентификатор отслеживания, доступный для чтения Azure Resource Manager.

При использовании Azure Resource Manager API-интерфейсов необходимо добавить идентификатор отслеживания в соответствии с [приведенными ниже инструкциями](#use-resource-manager-apis) , чтобы передать его Azure Resource Manager как код развертывает ресурсы. Этот идентификатор отображается в центре партнеров на странице технической конфигурации вашего плана. 

> [!NOTE]
> Для существующих приложений Azure однократная миграция началась в марте 2021, чтобы обновить идентификаторы отслеживания в технической конфигурации каждого плана. Использование в прошлых развертываниях этих предложений останется в системах Майкрософт.
>
>После обновления предложений вам больше не нужно добавлять тип ресурса **Microsoft. Resources/deployments** в основной файл шаблона.

## <a name="other-use-cases"></a>Другие варианты использования 

Вы можете использовать атрибуты использования клиента для контроля использования решений Azure, недоступных в коммерческом магазине. Эти решения обычно находятся в репозитории быстрого запуска, закрытых репозиториев GitHub или от 1:1 клиентов, которые создают устойчивый IP-адрес (например, развертываемое и масштабируемое приложение).

Требуется выполнить несколько действий вручную.

1. Создайте один или несколько идентификаторов GUID для использования в качестве идентификаторов отслеживания.
1. Зарегистрируйте эти идентификаторы GUID в центре партнеров.
1. Добавьте зарегистрированные идентификаторы GUID в приложение Azure и (или) строки агента пользователя.

### <a name="create-guids"></a>Создание глобальных уникальных идентификаторов

В отличие от идентификаторов отслеживания, создаваемых центром партнеров для приложений Azure в коммерческом магазине, для других целей КУА требуется создать идентификатор GUID для использования в качестве идентификатора отслеживания. Идентификатор GUID является уникальным идентификатором из 32 шестнадцатеричных цифр и используется для создания ссылок. Чтобы создать идентификаторы GUID для отслеживания, следует использовать генератор GUID, например, с помощью PowerShell:

```powershell
[guid]::NewGuid()
```

Необходимо создать уникальный идентификатор GUID для каждого продукта и канала распространения. Если вы не хотите, чтобы отчеты были разделены, можно использовать один идентификатор GUID для нескольких каналов распространения продукта. Отчеты выполняются по ИДЕНТИФИКАТОРу Microsoft Partner Network и идентификатору GUID.

### <a name="register-guids"></a>Регистрация уникальных идентификаторов GUID

Идентификаторы GUID должны быть затем зарегистрированы в центре партнеров, чтобы их можно было связать с вами в качестве партнера:

1. Войдите в [Центр партнеров](https://partner.microsoft.com/dashboard).

1. Зарегистрируйтесь как [коммерческий издатель Azure Marketplace](https://aka.ms/JoinMarketplace).

1. Щелкните **Параметры** (значок шестеренки) в правом верхнем углу и выберите **Параметры учетной записи**.

1. Выберите   >  **идентификаторы** профиля организации  >  **добавить GUID отслеживания**.

1. В поле **GUID** введите созданный GUID отслеживания. Введите только GUID без `pid-` префикса. В поле **Описание** введите имя или описание решения.

1. Чтобы зарегистрировать дополнительный идентификатор GUID, снова щелкните **Add Tracking GUID** (Добавить GUID отслеживания). На странице появятся дополнительные поля.

1. Щелкните **Сохранить**.

### <a name="add-a-guid-to-a-resource-manager-template"></a>Добавление идентификатора GUID в шаблон диспетчер ресурсов

Чтобы добавить зарегистрированный GUID в шаблон диспетчер ресурсов, внесите одно изменение в основной файл шаблона:

1. Откройте шаблон Resource Manager.

1. Добавьте новый ресурс типа [Microsoft. Resources/deployments](/azure/templates/microsoft.resources/deployments) в основной файл шаблона. Ресурс должен находиться в **mainTemplate.js** или **azuredeploy.jsтолько для** файлов, но не во вложенных или связанных шаблонах.

1. Введите значение GUID после `pid-` префикса в качестве имени ресурса. Например, если GUID имеет значение eb7927c8-dd66-43e1-b0cf-c346a422063, имя ресурса будет иметь значение **PID-eb7927c8-dd66-43e1-b0cf-c346a422063**. Пример
 
```json
{ // add this resource to the resources section in the mainTemplate.json
    "apiVersion": "2020-06-01",
    "name": "pid-XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX", // use your generated GUID here
    "type": "Microsoft.Resources/deployments",
    "properties": {
        "mode": "Incremental",
        "template": {
            "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
            "contentVersion": "1.0.0.0",
            "resources": []
        }
    }
} // remove all comments from the file when complete
```
4. Проверьте наличие ошибок в шаблоне.

1. Повторно опубликуйте шаблон в соответствующих репозиториях.

1. [Проверка GUID в развертывании шаблона](#verify-deployments-tracked-with-a-guid).

> [!TIP]
> Дополнительные сведения о создании и публикации шаблонов диспетчер ресурсов см. в статье [Создание и развертывание первого шаблона диспетчер ресурсов](../azure-resource-manager/templates/quickstart-create-templates-use-the-portal.md).

### <a name="verify-deployments-tracked-with-a-guid"></a>Проверка развертываний с помощью идентификатора GUID

После изменения шаблона и запуска тестового развертывания используйте следующий сценарий PowerShell, чтобы получить развернутые и помеченные ресурсы.

Этот скрипт позволяет убедиться, что GUID успешно добавлен в шаблон Resource Manager. Скрипт не применяется при развертывании через API Resource Manager или Terraform.

Войдите в Azure. Выберите подписку с развертыванием, которое необходимо проверить перед запуском скрипта. Выполните скрипт в контексте подписки развертывания.

**Идентификатор GUID** (под названием "deploymentName") и имя **resourceGroupName** развертывания являются обязательными параметрами.

[Оригинал этого скрипта](https://gist.github.com/bmoore-msft/ae6b8226311014d6e7177c5127c7eba1) размещен в GitHub.

```powershell
Param(
    [string][Parameter(Mandatory=$true)]$deploymentName, # the full name of the deployment, e.g. pid-XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX
    [string][Parameter(Mandatory=$true)]$resourceGroupName
)

# Get the correlationId of the named deployment
$correlationId = (Get-AzResourceGroupDeployment -ResourceGroupName $resourceGroupName -Name "$deploymentName").correlationId

# Find all deployments with that correlationId
$deployments = Get-AzResourceGroupDeployment -ResourceGroupName $resourceGroupName | Where-Object{$_.correlationId -eq $correlationId}

# Find all deploymentOperations in all deployments with that correlationId as PowerShell doesn't surface outputResources on the deployment or correlationId on the deploymentOperation

foreach ($deployment in $deployments){
    # Get deploymentOperations by deploymentName
    # then the resourceIds for each resource
    ($deployment | Get-AzResourceGroupDeploymentOperation | Where-Object{$_.targetResource -notlike "*Microsoft.Resources/deployments*"}).TargetResource
}
```

### <a name="notify-your-customers"></a>Информирование клиентов

Партнер следует оповестить своих клиентов о том, что их развертывания отслеживаются на предмет потребления услуг клиентами. Корпорация Майкрософт сообщает об использовании Azure, связанном с этими развертываниями, с партнером. Ниже представлены примеры сообщений, которые можно использовать для уведомления клиентов о таких развертываниях. В примерах замените \<PARTNER> именем вашей компании. Партнеры должны обеспечить соответствие уведомлений политикам конфиденциальности и сбора данных, включая параметры клиентов, которые следует исключить из отслеживания.

#### <a name="notification-for-resource-manager-template-deployments"></a>Информационное сообщение для развертываний с помощью шаблона Resource Manager

При развертывании этого шаблона Корпорация Майкрософт может опознать установку \<PARTNER> программного обеспечения с развернутыми ресурсами Azure. Корпорация Майкрософт может сопоставлять эти ресурсы, используемые для поддержки программного обеспечения. Корпорация Майкрософт собирает эти сведения, чтобы максимально повысить качество использования своих продуктов и делового сотрудничества. Данные собираются и управляются политиками конфиденциальности Майкрософт, расположенными по адресу [https://www.microsoft.com/trustcenter](https://www.microsoft.com/trustcenter) .

#### <a name="notification-for-sdk-or-api-deployments"></a>Информационное сообщение для развертываний с использованием пакета SDK или API

При развертывании \<PARTNER> программного обеспечения корпорация Майкрософт может опознать установку \<PARTNER> программного обеспечения с развернутыми ресурсами Azure. Корпорация Майкрософт может сопоставлять эти ресурсы, используемые для поддержки программного обеспечения. Корпорация Майкрософт собирает эти сведения, чтобы максимально повысить качество использования своих продуктов и делового сотрудничества. Данные собираются и управляются политиками конфиденциальности Майкрософт, расположенными по адресу [https://www.microsoft.com/trustcenter](https://www.microsoft.com/trustcenter) .

## <a name="use-resource-manager-apis"></a>Использование диспетчер ресурсов API

В некоторых случаях вы можете выполнять вызовы непосредственно для диспетчер ресурсов интерфейсов API-интерфейса RESTFUL, чтобы развернуть службы Azure. [Azure поддерживает несколько пакетов SDK](../index.yml?pivot=sdkstools), позволяющих реализовать такие вызовы. Для развертывания ресурсов можно использовать один из пакетов SDK или вызвать интерфейсы API для остальных функций напрямую.

Чтобы включить атрибуты использования клиента, при проектировании вызовов API включите ваш идентификатор отслеживания в заголовок агента пользователя в запросе. Отформатируйте строку `pid-` префиксом. Примеры:

```xml
//Commercial Marketplace Azure app
pid-contoso-myoffer-partnercenter //copy the tracking ID exactly as it appears in Partner Center

//Other use cases
pid-b6addd8f-5ff4-4fc0-a2b5-0ec7861106c4 //enter your GUID after "pid-"
```
> [!IMPORTANT]
> Если вы используете диспетчер ресурсов API с приложением Azure в коммерческом магазине, используйте идентификатор отслеживания, предоставленный в центре партнеров. НЕ используйте идентификатор GUID.

Различные пакеты SDK взаимодействуют с интерфейсами API диспетчер ресурсов по-разному и потребовали некоторых различий в коде. В приведенных ниже примерах используется некоммерческий подход, использующий идентификатор GUID и охватывающий множество наиболее популярных пакетов SDK для Azure.

#### <a name="example-python-sdk"></a>Пример: пакет SDK для Python

В Python используется атрибут **config**. Этот атрибут можно добавить только в UserAgent. Пример

```python
client = azure.mgmt.servicebus.ServiceBusManagementClient(**parameters)
client.config.add_user_agent("pid-b6addd8f-5ff4-4fc0-a2b5-0ec7861106c4")
```
> [!IMPORTANT]
> Добавьте атрибут для каждого клиента. Глобальная статическая конфигурация не поддерживается. Вы можете пометить клиентскую фабрику, чтобы гарантировать отслеживание каждого клиента. Дополнительные сведения см. в [примере фабрики клиента](https://github.com/Azure/azure-cli/blob/7402fb2c20be2cdbcaa7bdb2eeb72b7461fbcc30/src/azure-cli-core/azure/cli/core/commands/client_factory.py#L70-L79), размещенном в GitHub.

#### <a name="example-net-sdk"></a>Пример: пакет SDK для .NET

Для .NET обязательно задайте агент пользователя. Используйте библиотеку [Microsoft. Azure. Management. Fluent](/dotnet/api/microsoft.azure.management.fluent) , чтобы задать агент пользователя с помощью следующего кода (пример в C#):

```csharp
var azure = Microsoft.Azure.Management.Fluent.Azure
    .Configure()
    // Add your pid in the user agent header
    .WithUserAgent("pid-XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX", String.Empty) 
    .Authenticate(/* Credentials created via Microsoft.Azure.Management.ResourceManager.Fluent.SdkContext.AzureCredentialsFactory */)
    .WithSubscription("<subscription ID>");
```

#### <a name="example-azure-powershell"></a>Пример: Azure PowerShell

При развертывании ресурсов с помощью Azure PowerShell добавьте свой GUID с помощью этого метода:

```powershell
[Microsoft.Azure.Common.Authentication.AzureSession]::ClientFactory.AddUserAgent("pid-eb7927c8-dd66-43e1-b0cf-c346a422063")
```

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

#### <a name="example-azure-cli"></a>Пример: Azure CLI

При использовании Azure CLI для добавления идентификатора GUID задайте переменную среды **AZURE_HTTP_USER_AGENT** в области скрипта. Также ее можно задать глобально для области оболочки:

```powershell
export AZURE_HTTP_USER_AGENT='pid-eb7927c8-dd66-43e1-b0cf-c346a422063'
```

Дополнительные сведения см. в описании пакета [Azure SDK для Go](/azure/developer/go/).

## <a name="use-terraform"></a>Использование Terraform

Поддержка terraform доступна в выпуске 1.21.0 поставщика Azure: [https://github.com/terraform-providers/terraform-provider-azurerm/blob/master/CHANGELOG.md#1210-january-11-2019](https://github.com/terraform-providers/terraform-provider-azurerm/blob/master/CHANGELOG.md#1210-january-11-2019) . Это относится ко всем партнерам, которые развертывают свое решение через terraform, и ко всем ресурсам, развернутым и отслеживаемым поставщиком Azure (версия 1.21.0 или более поздняя).

Поставщик Azure для terraform добавил новое дополнительное поле с именем [*partner_id*](https://www.terraform.io/docs/providers/azurerm/#partner_id) для указания идентификатора GUID отслеживания, используемого для решения. Значение этого поля также можно получить из переменной среды *ARM_PARTNER_ID*.

```
provider "azurerm" {
          subscription_id = "xxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
          client_id = "xxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
          ……
          # new stuff for ISV attribution
          partner_id = "xxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"}
```
Присвойте параметру *partner_id* зарегистрированный GUID. НЕ добавляйте к идентификатору GUID префикс "PID-", просто присвойте ему фактический идентификатор GUID.

> [!IMPORTANT]
> Если вы используете terraform с приложением Azure в коммерческом магазине, используйте весь идентификатор отслеживания, предоставленный в центре партнеров. НЕ используйте идентификатор GUID.

## <a name="get-support"></a>Получение поддержки

Узнайте о вариантах поддержки в коммерческом магазине по [поддержке программы коммерческого рынка в центре партнеров](support.md).

### <a name="how-to-submit-a-technical-consultation-request"></a>Как подать запрос техническому консультанту

1. Зайдите на страницу [технических услуг для партнеров](https://aka.ms/TechnicalJourney).
1. Выберите **облачную инфраструктуру и управление** для просмотра технического пути.
1. Выберите **службы развертывания**  >  **Отправить запрос**.
1. Выполните вход с помощью MSA (учетная запись MPN) или AAD (учетная запись информационной панели партнера).
1. Завершите или проверьте контактные данные в открывшейся форме. Сведения об консультации могут быть предварительно заполнены или иметь параметры раскрывающегося списка.
1. Введите заголовок и подробное описание проблемы.
1. Нажмите кнопку **Submit** (Отправить).

Ознакомьтесь с пошаговыми инструкциями и снимками экрана на странице [Использование услуг технической поддержки в предпродажной работе и развертывании](https://aka.ms/TechConsultInstructions).

Технический консультант для партнеров Майкрософт свяжется с вами, чтобы запланировать беседу для уточнения ваших вопросов.

## <a name="report"></a>Report
В настоящее время отчеты об использовании Azure, которые отправляются с помощью атрибутов использования клиентов, недоступны для партнеров независимых поставщиков программного обеспечения. Добавление отчетов в программу коммерческого рынка в центре партнеров для покрытия атрибутов использования клиентов нацелена на вторую половину 2021.

## <a name="faq"></a>ВОПРОСЫ И ОТВЕТЫ

#### <a name="after-a-tracking-id-is-added-can-it-be-changed"></a>Можно ли изменить идентификатор отслеживания после его добавления?

Идентификаторы отслеживания для приложений Azure в коммерческом магазине управляются автоматически центром партнеров. Клиент, тем не менее, может скачать шаблон, изменить или удалить идентификатор отслеживания. Партнеры должны заранее описать роль идентификатора отслеживания своим клиентам, чтобы предотвратить удаление или изменение. Изменение идентификатора отслеживания влияет только на новые развертывания и ресурсы, но не на существующие.

#### <a name="can-i-track-templates-deployed-from-a-non-microsoft-repository-like-github"></a>Можно ли отслеживать шаблоны, развертываемые из репозитория сторонних производителей, например GitHub?

Да, если идентификатор отслеживания имеется при развертывании шаблона, отслеживание использования будет отслеживаться. Чтобы поддерживать связь между вами как с издателем, так и с шаблоном, развернутым из репозитория сторонних производителей, Скачайте копию опубликованного шаблона (который будет содержать идентификатор отслеживания) из списка коммерческого рынка вашего предложения в портал Azure. Опубликуйте эту версию в GitHub или другом репозитории сторонних производителей.

Если шаблон отсутствует в коммерческом магазине и включает зарегистрированный GUID, убедитесь, что идентификатор GUID присутствует в версии, опубликованной в GitHub или другом репозитории сторонних производителей.

#### <a name="does-the-customer-receive-reporting-as-well"></a>Получает ли клиент отчеты?

Нет. Клиенты могут контролировать использование всех ресурсов или групп ресурсов в портал Azure. Клиенты не видят использование с нарушением кода отслеживания КУА.

#### <a name="is-customer-usage-attribution-similar-to-the-digital-partner-of-record-dpor-or-partner-admin-link-pal"></a>Является ли атрибут использования клиентов аналогом цифрового партнера записи (DPOR) или ссылки администратора партнеров (PAL)?

Атрибуты использования клиентов — это механизм для связывания использования Azure с повторяемым и развертываемым IP-адресом партнера во время развертывания. DPOR и PAL предназначены для связи с представителем консультационного (интегратора) или управления (управляемого поставщика услуг) с соответствующим местом клиента в Azure в течение времени, когда партнер вовлечен с клиентом.