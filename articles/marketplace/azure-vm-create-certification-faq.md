---
title: Устранение неполадок сертификации виртуальной машины (VM) для Azure Marketplace
description: Устранение распространенных проблем, связанных с тестированием и сертификацией образов виртуальных машин для Azure Marketplace.
ms.service: marketplace
ms.subservice: partnercenter-marketplace-publisher
ms.topic: troubleshooting
author: iqshahmicrosoft
ms.author: iqshah
ms.date: 01/18/2021
ms.openlocfilehash: 80dc19a58d212bb6ab8d608e222cd3a0bd3990d1
ms.sourcegitcommit: fc401c220eaa40f6b3c8344db84b801aa9ff7185
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/20/2021
ms.locfileid: "98600990"
---
# <a name="troubleshoot-virtual-machine-certification"></a>Устранение неполадок сертификации виртуальной машины

При публикации образа виртуальной машины в Azure Marketplace группа Azure проверяет ее, чтобы обеспечить ее загрузку, защиту и совместимость с Azure. Если образ виртуальной машины не проходит высококачественные тесты, он не будет опубликован. Вы получите сообщение об ошибке с описанием проблемы.

В этой статье описываются распространенные сообщения об ошибках во время публикации образов виртуальных машин, а также связанные решения.

> [!NOTE]
> Если у вас возникли вопросы по этой статье или предложения по улучшению, обратитесь в [службу поддержки центра партнеров](https://aka.ms/marketplacepublishersupport).

## <a name="vm-extension-failure"></a>Сбой расширения виртуальной машины

Проверьте, поддерживает ли образ ВМ расширения.

Чтобы включить расширения виртуальной машины, выполните следующие действия.

1. Выберите виртуальную машину Linux.
1. Перейдите в раздел **параметры диагностики**.
1. Включите базовые матрицы, обновив **учетную запись хранения**.
1. Щелкните **Сохранить**.

   ![Снимок экрана, на котором показано, как включить мониторинг на гостевом уровне.](./media/create-vm/vm-certification-issues-solutions-1.png)

Чтобы убедиться, что расширения виртуальной машины должным образом активированы, выполните следующие действия.

1. На виртуальной машине перейдите на вкладку **расширения ВМ** и проверьте состояние **расширения системы диагностики Linux**.
1. Проверьте состояние подготовки.

   - Если состояние — *Подготовка успешно*, тестовый случай был пройден.  
   - Если состояние — *Ошибка подготовки*, тестовый случай не удалось выполнить, и необходимо установить флаг усиленной безопасности.

   ![Снимок экрана, показывающий, что подготовка выполнена успешно.](./media/create-vm/vm-certification-issues-solutions-2.png)

   Если расширение виртуальной машины завершается сбоем, см. раздел [Использование диагностического расширения Linux для мониторинга метрик и журналов](../virtual-machines/extensions/diagnostics-linux.md) для включения. Если вы не хотите, чтобы расширение виртуальной машины было включено, обратитесь в службу поддержки и попросите его отключить.

## <a name="vm-provisioning-issue"></a>Ошибка подготовки виртуальной машины

Перед отправкой предложения убедитесь, что вы следите за процессом подготовки виртуальной машины. Чтобы просмотреть формат JSON для подготовки ВИРТУАЛЬНОЙ машины, см. статью [тестирование образа виртуальных машин](azure-vm-image-test.md).

Проблемы подготовки могут включать в себя следующие сценарии сбоя:

|Сценарий|Ошибка|Причина|Решение|
|---|---|---|---|
|1|Недопустимый виртуальный жесткий диск (VHD)|Если указанное значение файла cookie в нижнем колонтитуле VHD неверно, VHD будет считаться недопустимым.|Повторно создайте образ и отправьте запрос.|
|2|Недопустимый тип BLOB-объекта|Не удалось подготовить виртуальную машину, так как используемый блок является типом большого двоичного объекта, а не типом страницы.|Повторно создайте образ и отправьте запрос.|
|3|Время ожидания подготовки или неправильное обобщенное|Возникла ошибка при обходе обобщения виртуальной машины.|Повторно создайте образ с обобщением и отправьте запрос.|
|

> [!NOTE]
> Дополнительные сведения о обходе обобщения виртуальных машин см. в следующих статьях:
> - [Документация по Linux](azure-vm-create-using-approved-base.md#generalize-the-image)
> - [Документация по Windows](../virtual-machines/windows/capture-image-resource.md#generalize-the-windows-vm-using-sysprep)

## <a name="vhd-specifications"></a>Спецификации VHD

### <a name="conectix-cookie-and-other-vhd-specifications"></a>Файлы cookie конектикс и другие спецификации VHD

Строка "конектикс" является частью спецификации виртуального жесткого диска. Он определен как 8-байтный файл cookie в нижнем колонтитуле VHD, который определяет автора файла. Все VHD-файлы, созданные корпорацией Майкрософт, имеют этот файл cookie.

В формате большого двоичного объекта VHD должен быть 512-разрядный нижний колонтитул в следующем формате:

|Поля нижнего колонтитула жесткого диска|Размер (в байтах)|
|---|---|
Куки-файл|8
Компоненты|4
Версия формата файла|4
Смещение данных|8
Метка времени|4
Приложение Creator|4
Версия создателя|4
ОС узла создателя|4
Оригинальный размер|8
Текущий размер|8
Геометрия диска|4
Тип диска|4
Контрольная сумма|4
Уникальный идентификатор|16
Сохраненное состояние|1
Зарезервированное|427
|

### <a name="vhd-specifications"></a>Спецификации VHD

Чтобы обеспечить гладкую публикацию, убедитесь, что виртуальный жесткий диск соответствует следующим критериям.

- Файл Cookie содержит строку "конектикс".
- Диск имеет фиксированный тип.
- Виртуальный размер виртуального жесткого диска составляет не менее 20 МБ.
- Виртуальный жесткий диск будет согласован. Виртуальный размер должен быть кратен 1 МБ.
- Длина большого двоичного объекта VHD равна размеру виртуального размера и нижнего колонтитула VHD (512).

Скачайте [спецификацию VHD](https://www.microsoft.com/download/details.aspx?id=23850).

## <a name="software-compliance-for-windows"></a>Соответствие программного обеспечения требованиям для Windows

Если ваш запрос на создание образа Windows отклонен из-за проблемы соответствия программного обеспечения, возможно, вы создали образ Windows с установленным экземпляром SQL Server. Вместо этого необходимо получить соответствующий базовый образ версии SQL Server из Azure Marketplace.

Не создавайте собственный образ Windows с SQL Server, установленным в нем. Используйте утвержденные базовые образы SQL Server (Enterprise/Standard/Web) из Azure Marketplace.

Если вы пытаетесь установить Visual Studio или любой продукт, лицензированный по Office, обратитесь в службу поддержки для получения предварительного утверждения.

Дополнительные сведения о выборе утвержденной базы данных см. в разделе [Создание виртуальной машины из утвержденной базы](azure-vm-create-using-approved-base.md).

## <a name="toolkit-test-case-execution-failed"></a>Сбой выполнения тестового случая набора средств

Набор средств сертификации Майкрософт может помочь в выполнении тестовых случаев и проверке совместимости VHD или образа с средой Azure.

Загрузите [Microsoft Certification Toolkit](azure-vm-image-test.md).

### <a name="linux-test-cases"></a>Тестовые случаи Linux

В следующей таблице перечислены тестовые случаи Linux, которые будут выполняться набором инструментов. Проверка теста указывается в описании.

|Сценарий|Тестовый случай|Описание|
|---|---|---|
|1|Журнал bash|Перед созданием образа виртуальной машины необходимо очистить файлы журнала bash.|
|2|Версия агента Linux|Необходимо установить агент Linux для Azure 2.2.41 или более поздней версии.|
|3|Обязательные параметры ядра|Проверяет, установлены ли следующие параметры ядра: <br>Console = ttyS0<br>еарлипринтк = ttyS0<br>рутделай = 300 |
|4|Переключение раздела на диск ОС|Проверяет, что разделы подкачки не создаются на диске операционной системы.|
|5|Корневой раздел на диске ОС|Создайте один корневой раздел для диска ОС.|
|6|Версия OpenSSL|Версия OpenSSL должна быть версии 0.9.8 или более поздней.|
|7|Версия Python|Настоятельно рекомендуется использовать Python версии 2,6 или более поздней.|
|8|Интервал активности клиента|Задайте для ClientAliveInterval значение 180. В приложении необходимо установить значение от 30 до 235. Если вы включаете SSH для конечных пользователей, это значение должно быть задано в соответствии с описанием.|
|9|Архитектура ОС|Поддерживаются только 64-разрядные операционные системы.|
|10|Автоматическое обновление|Указывает, включено ли автоматическое обновление агента Linux.|
|

### <a name="common-test-case-errors"></a>Распространенные ошибки тестовых случаев

Общие ошибки, которые могут возникнуть при выполнении тестовых случаев, см. в следующей таблице:

| Сценарий | Тестовый случай | Error | Решение |
| --- | --- | --- | --- |
| 1 | Тестовый случай версии агента Linux | Минимальная версия агента Linux — 2.2.41 или более поздняя. Это требование было обязательным с 1 мая 2020 г. | Обновите версию агента Linux. Он должен быть 2,241 или более поздней версии. Дополнительные сведения см. на [странице обновления версии агента Linux](https://support.microsoft.com/help/4049215/extensions-and-virtual-machine-agent-minimum-version-support). |
| 2 | Тестовый случай истории bash | Если размер журнала Bash в отправленном изображении превышает 1 килобайт (КБ), возникает ошибка. Размер ограничен 1 КБ, чтобы убедиться, что файл журнала Bash не содержит потенциально конфиденциальных сведений. | Разрешите подключение виртуального жесткого диска к другой работающей виртуальной машине и внесите изменения, чтобы уменьшить размер до 1 КБ или меньше. Например, удалите `.bash` файлы журнала. |
| 3 | Обязательный параметр ядра тестовый случай | Эта ошибка возникает, когда для параметра `console` не задано значение `ttyS0` . Проверьте, выполнив следующую команду: <br /> `cat /proc/cmdline` | Задайте значение для `console` `ttyS0` и повторно отправьте запрос. |
| 4 | Тестовый случай интервала Клиенталиве | Если набор средств предоставит неудачный результат для этого тестового случая, то для параметра будет задано неверное значение `ClientAliveInterval` . | Задайте для параметра значение `ClientAliveInterval` меньше или равное 235, а затем повторно отправьте запрос. |
|

### <a name="windows-test-cases"></a>Тестовые случаи для Windows

В следующей таблице перечислены тестовые случаи Windows, которые будут запускаться с помощью набора средств, а также описание проверки теста.

|Сценарий |Проверочные варианты|Описание|
|---|---|---|
|1|Архитектура ОС|Azure поддерживает только 64-разрядные операционные системы.|
|2|Зависимость учетной записи пользователя|Выполнение приложения не должно зависеть от учетной записи администратора.|
|3|Отказоустойчивый кластер|Компонент отказоустойчивой кластеризации Windows Server пока не поддерживается. Приложение не должно зависеть от этой функции.|
|4|IPV6|Протокол IPv6 пока не поддерживается в среде Azure. Приложение не должно зависеть от этой функции.|
|5|DHCP|Роль сервера протокола динамической настройки узла пока не поддерживается. Приложение не должно зависеть от этой функции.|
|6|Hyper-V|Роль сервера Hyper-V пока не поддерживается. Приложение не должно зависеть от этой функции.|
|7|Удаленный доступ.|Роль сервера "удаленный доступ (прямой доступ)" пока не поддерживается. Приложение не должно зависеть от этой функции.|
|8|службы Rights Management Services|Службы Rights Management. Роль сервера пока не поддерживается. Приложение не должно зависеть от этой функции.|
|9|Windows Deployment Services|Службы развертывания Windows. Роль сервера пока не поддерживается. Приложение не должно зависеть от этой функции.|
|10|Шифрование диска BitLocker|Шифрование диска BitLocker не поддерживается на жестком диске операционной системы, но может использоваться на дисках данных.|
|11|Сервер имен интернет-хранилища|Компонент сервера службы "имя хранилища Интернета" пока не поддерживается. Приложение не должно зависеть от этой функции.|
|12|Multipath I/O;|Multipath I/O. Эта функция сервера пока не поддерживается. Приложение не должно зависеть от этой функции.|
|13|Network Load Balancing|Балансировка сетевой нагрузки. Эта функция сервера пока не поддерживается. Приложение не должно зависеть от этой функции.|
|14|Протокол PNRP|Протокол разрешения имен одноранговых узлов. Эта функция сервера пока не поддерживается. Приложение не должно зависеть от этой функции.|
|15|Службы SNMP|Компонент служб SNMP пока не поддерживается. Приложение не должно зависеть от этой функции.|
|16|Служба WINS|Служба Windows Internet Name Service. Эта функция сервера пока не поддерживается. Приложение не должно зависеть от этой функции.|
|17|Служба беспроводной локальной сети|Служба беспроводной локальной сети. Эта функция сервера пока не поддерживается. Приложение не должно зависеть от этой функции.|
|

Если вы пойдете за любые сбои с предыдущими тестовыми случаями, обратитесь к столбцу **Description** в таблице решения. Для получения дополнительных сведений обратитесь в службу поддержки.

## <a name="data-disk-size-verification"></a>Проверка размера диска данных

Запросы к диску с данными размером более 1023 гигабайт (ГБ) не будут утверждаться. Это правило применяется как к Linux, так и к Windows.

Повторно отправьте запрос, размер которого меньше или равен 1023 ГБ.

## <a name="os-disk-size-validation"></a>Проверка размера диска ОС

Сведения об ограничениях размера диска ОС см. в следующих правилах. При отправке любого запроса убедитесь, что размер диска ОС находится в пределах ограничений для Linux или Windows.

|ОС|Рекомендуемый размер VHD|
|---|---|
|Linux|от 1 ГБ до 1023 ГБ|
|Windows|от 30 ГБ до 250 ГБ|
|

Так как виртуальные машины разрешают доступ к базовой операционной системе, убедитесь, что размер виртуального жесткого диска достаточно велик для виртуального жесткого диска. Диски не расширяются без простоев. Используйте размер диска от 30 ГБ до 50 ГБ.

|Размер виртуального жесткого диска|Фактический объем занятого объема|Решение|
|---|---|---|
|>500 тебибитес (тиб)|Н/Д|Обратитесь в службу поддержки за исключением утверждения.|
|250-500 тиб|Разница >200 гибибайтах (гиб) от размера BLOB-объекта|Обратитесь в службу поддержки за исключением утверждения.|
|

> [!NOTE]
> Увеличение размера диска приводит к более высокой стоимости и приведет к задержке в процессе установки и репликации. Из-за этой задержки и стоимости Группа поддержки может найти обоснование для утверждения исключения.

## <a name="wannacry-patch-verification-test-for-windows"></a>Проверка исправления WannaCry для Windows

Чтобы предотвратить потенциальную атаку, связанную с вирусом WannaCry, убедитесь, что все запросы образа Windows обновлены с использованием последнего исправления.

Версию файла образа можно проверить с `C:\windows\system32\drivers\srv.sys` или `srv2.sys` .

В следующей таблице показана минимальная исправленная версия Windows Server.

|Операционная система|Version|
|---|---|
|Windows обслуживает 2008 R2|6.1.7601.23689|
|Windows Server 2012|6.2.9200.22099|
|Windows Server 2012 R2|6.3.9600.18604|
|Windows Server 2016|10.0.14393.953|
|Windows Server 2019|Н/Д|
|

> [!NOTE]
> Windows Server 2019 не имеет обязательных требований к версии.

## <a name="sack-vulnerability-patch-verification"></a>Проверка исправления с уязвимостью SACK

При отправке образа Linux запрос может быть отклонен из-за проблем с версиями ядра.

Обновите ядро, используя утвержденную версию, и отправьте запрос повторно. Утвержденную версию ядра можно найти в следующей таблице. Номер версии должен быть больше или равен числу, указанному здесь.

Если образ не установлен с одной из следующих версий ядра, обновите его с помощью правильных исправлений. Запросите необходимое утверждение у группы поддержки после обновления образа с помощью этих необходимых исправлений:

- CVE-2019-11477
- CVE-2019-11478
- CVE-2019-11479

|Семейство ОС|Версия|Ядро|
|---|---|---|
|Ubuntu|14.04 LTS|4.4.0 — 151| 
||14.04 LTS|4.15.0-1049- \* -Azure|
||16.04 LTS|4.15.0 — 1049|
||18.04 LTS|4.18.0-1023|
||18.04 LTS|5.0.0-1025|
||18.10 |4.18.0-1023|
||19.04 |5.0.0-1010|
||19.04 |5.3.0-1004|
|ОС RHEL и цент|6.10|2.6.32 — 754.15.3|
||7.2|3.10.0 — 327.79.2|
||7.3|3.10.0 — 514.66.2|
||7.4|3.10.0 — 693.50.3|
||7,5 %|3.10.0 — 862.34.2|
||7.6|3.10.0 — 957.21.3|
||7.7|3.10.0 — 1062.1.1|
||8.0|4.18.0 — 80.4.2|
||8.1|4.18.0-147|
||"7-RAW" (7,6)||
||"7-LVM" (7,6)|3.10.0 — 957.21.3|
||RHEL — SAP 7,4|TBD|
||RHEL — SAP 7,5|TBD|
|SLES|SLES11SP4 (включая SAP)|3.0.101 — 108.95.2|
||SLES12SP1 для SAP|3.12.74 — 60.64.115.1|
||SLES12SP2 для SAP|4.4.121 — 92.114.1|
||SLES12SP3|4.4180-4.31.1 (ядро — Azure)|
||SLES12SP3 для SAP|4.4.180 — 94.97.1|
||SLES12SP4|4.12.14-6.15.2 (ядро — Azure)|
||SLES12SP4 для SAP|4.12.14 — 95.19.1|
||SLES15|4.12.14-5.30.1 (ядро — Azure)|
||SLES15 для SAP|4.12.14-5.30.1 (ядро — Azure)|
||SLES15SP1|4.12.14-5.30.1 (ядро — Azure)|
|Oracle;|6.10|UEK2 2.6.39 — 400.312.2<br>UEK3 3.8.13 — 118.35.2<br>RHCK 2.6.32 — 754.15.3 
||7.0 — 7,5|UEK3 3.8.13 — 118.35.2<br>UEK4 4.1.12 — 124.28.3<br>RHCK соответствует RHEL выше|
||7.6|RHCK 3.10.0 — 957.21.3<br>UEK5 4.14.35 — 1902.2.0|
|CoreOS стабильный 2079.6.0|4.19.43\*|
||Бета-версия 2135.3.1|4.19.50\*|
||Альфа-2163.2.1|4.19.50\*|
|Debian|Jessie (безопасность)|3.16.68-2|
||неjessieные порты|4.9.168-1 + deb9u3|
||Stretch (безопасность)|4.9.168-1 + deb9u3|
||Debian GNU/Linux 10 (бустер)|Debian 6.3.0-18 + deb9u1|
||бустер, ИД безопасности (непереносимые порты Stretch)|4.19.37-5|
|

## <a name="image-size-should-be-in-multiples-of-megabytes"></a>Размер изображения должен быть кратен мегабайтам

Виртуальным жестким дискам в Azure должен быть назначен виртуальный размер, кратный одному мегабайту (МБ). Если виртуальный жесткий диск не соответствует рекомендуемому виртуальному размеру, запрос может быть отклонен.

При преобразовании с необработанного диска на виртуальный жесткий диск следуйте рекомендациям. Убедитесь, что размер необработанного диска является кратным 1 МБ. Дополнительные сведения см. в разделе сведения о нерекомендуемых [дистрибутивах](../virtual-machines/linux/create-upload-generic.md).

## <a name="vm-access-denied"></a>Доступ к виртуальной машине запрещен

Ошибка _доступа_ для выполнения тестового случая на виртуальной машине может быть вызвана недостаточными привилегиями.

Убедитесь, что вы включили правильный доступ к учетной записи, в которой выполняются сценарии самотестирования. Включите доступ для выполнения тестовых случаев, если он не включен. Если вы не хотите разрешать доступ, вы можете поделиться результатами самотестирования с группой поддержки.

Чтобы отправить запрос с образом отключенного протокола SSH для процесса сертификации, выполните следующие действия.

1. Запустите [новейшее средство проверки сертификации для виртуальных машин Azure](https://aka.ms/AzureCertificationTestTool) в образе.

2. Создайте запрос в [службу поддержки](https://aka.ms/marketplacepublishersupport). Обязательно прикрепите отчет набора средств и предоставьте сведения о предложении:
   - Название предложения
   - Имя издателя
   - ИДЕНТИФИКАТОР плана, номер SKU и версия

3. Повторно отправьте запрос на сертификацию.

## <a name="download-failure"></a>Сбой скачивания

В следующей таблице приведены сведения о проблемах, возникающих при скачивании образа виртуальной машины с URL-адресом SAS.

|Ошибка|Причина|Решение|
|---|---|---|
|Не удалось найти большой двоичный объект.|Виртуальный жесткий диск может быть удален или перемещен из указанного расположения.|| 
|Используемый BLOB-объект|Виртуальный жесткий диск используется другим внутренним процессом.|Виртуальный жесткий диск должен быть в используемом состоянии при скачивании с помощью URL-адреса SAS.|
|Недопустимый URL-адрес SAS|Неправильный URL-адрес SAS для виртуального жесткого диска.|Получите правильный URL-адрес SAS.|
|Недопустимая подпись|Неправильный URL-адрес SAS для виртуального жесткого диска.|Получите правильный URL-адрес SAS.|
|Условный заголовок HTTP|Недопустимый URL-адрес SAS.|Получите правильный URL-адрес SAS.|
|Недопустимое имя виртуального жесткого диска|Проверьте `%` `"` , существуют ли в имени виртуального жесткого диска какие-либо специальные символы, такие как знак процента или кавычки.|Переименуйте VHD-файл, удалив специальные символы.|
|

## <a name="first-partition-starts-at-1-mb-2048-sectors"></a>Первый раздел начинается с 1 МБ (2048 секторов)

Если вы [создаете собственный образ](azure-vm-create-using-own-image.md), убедитесь, что первые 2048 секторов (1 МБ) диска ОС пусты. В противном случае публикация завершится ошибкой. Это требование применимо только к диску ОС (а не к дискам данных). Если вы создаете образ [на основе утвержденной базы](azure-vm-create-using-approved-base.md), это требование можно пропустить.

### <a name="create-a-1-mb-2048-sectors-each-sector-of-512-bytes-partition-on-an-empty-vhd"></a>Создайте раздел размером 1 МБ (2048 секторов, каждый сектор 512 байт) на пустом виртуальном жестком диске.

Эти действия применимы только к Linux.

1. Создайте виртуальную машину Linux любого типа, например Ubuntu, Центную ОС или другую. Заполните обязательные поля и выберите **"Далее": диски >**.

   ![Снимок экрана, на котором показана страница "Создание виртуальной машины" с выделенной кнопкой "Далее: диски".](./media/create-vm/vm-certification-issues-solutions-15.png)

1. Создайте неуправляемый диск для виртуальной машины.

   Либо используйте значения по умолчанию, либо укажите любое значение для таких полей, как NIC, NSG и общедоступный IP-адрес.

   ![Снимок экрана со страницей "диски данных" в статье Создание виртуальной машины в потоке.](./media/create-vm/vm-certification-issues-solutions-16.png)

1. После создания виртуальной машины выберите **диски** в левой области.

   ![Снимок экрана, показывающий, как выбрать диски для виртуальной машины.](./media/create-vm/vm-certification-issues-solutions-17.png)

1. Подключите VHD в качестве диска данных к виртуальной машине, чтобы создать таблицу секционирования.

   1. Выберите **Добавить**  >  **существующий большой двоичный объект** на диске.

      ![Снимок экрана, показывающий, как добавить диск данных к виртуальному жесткому диску.](./media/create-vm/vm-certification-issues-solutions-18.png)

   1. Найдите учетную запись хранения VHD.
   1. Выберите **контейнер** , а затем выберите свой виртуальный жесткий диск.
   1. Нажмите кнопку **ОК**.

      ![Снимок экрана со страницей присоединения неуправляемого диска.](./media/create-vm/vm-certification-issues-solutions-19.png)

      Виртуальный жесткий диск будет добавлен как LUN диска данных 0.

   1. Перезапустите виртуальную машину.

1. После перезапуска виртуальной машины Войдите на виртуальную машину с помощью инструкции выведения или другого клиента и выполните `sudo  -i` команду, чтобы получить доступ к корневому каталогу.

   ![Снимок экрана командной строки клиента, иллюстрирующий команду sudo-i.](./media/create-vm/vm-certification-issues-solutions-20.png)

1. Создайте раздел на виртуальном жестком диске.

   1. Введите `fdisk /dev/sdb` команду.
   1. Чтобы просмотреть существующий список разделов из виртуального жесткого диска, введите `p` .
   1. Введите `d` , чтобы удалить все существующие разделы, доступные в вашем виртуальном жестком диске. Этот шаг можно пропустить, если он не требуется.

      ![Снимок экрана командной строки клиента с командами для удаления существующих секций.](./media/create-vm/vm-certification-issues-solutions-21.png)

   1. Введите `n` , чтобы создать новую секцию, и выберите `p` для (основной раздел).

   1. Введите 2048 в качестве _первого сектора_ . Вы можете оставить _последний сектор_ в качестве значения по умолчанию.

      >[!IMPORTANT]
      >Все существующие данные будут стерты до 2048 секторов (каждый сектор 512 байт). Резервное копирование виртуального жесткого диска перед созданием нового раздела.

      ![Снимок экрана командной строки клиента, отображающий команды и выходные данные для удаленных данных.](./media/create-vm/vm-certification-issues-solutions-22.png)

   1. Введите `w` , чтобы подтвердить создание секции.

      ![Снимок экрана командной строки клиента, отображающий команды для создания секции.](./media/create-vm/vm-certification-issues-solutions-23.png)

   1. Таблицу секционирования можно проверить, выполнив команду `n fdisk /dev/sdb` и введя `p` . Вы увидите, что Секция создана со значением смещения 2048.

      ![Снимок экрана командной строки клиента, отображающий команды для создания смещения 2048.](./media/create-vm/vm-certification-issues-solutions-24.png)

1. Отключите виртуальный жесткий диск от виртуальной машины и удалите виртуальную машину.

### <a name="create-a-1-mb-2048-sectors-each-sector-of-512-bytes-partition-by-moving-existing-data-on-vhd"></a>Создайте секцию размером 1 МБ (2048 секторов, каждый сектор 512 байт), переместив существующие данные на виртуальный жесткий диск.

Эти действия применимы только к Linux.

1. Создайте виртуальную машину Linux любого типа, например Ubuntu, Центную ОС или другую. Заполните обязательные поля и выберите **"Далее": диски >**.

   ![Снимок экрана, на котором показана страница "Создание виртуальной машины" с выделенной кнопкой "Далее: диски".](./media/create-vm/vm-certification-issues-solutions-15.png)

1. Создайте неуправляемый диск для виртуальной машины.

   ![Снимок экрана со страницей "диски данных" в статье Создание виртуальной машины в потоке.](./media/create-vm/vm-certification-issues-solutions-16.png)

   Либо используйте значения по умолчанию, либо укажите любое значение для таких полей, как NIC, NSG и общедоступный IP-адрес.

1. После создания виртуальной машины выберите **диски** в левой области.

   ![Снимок экрана, показывающий, как выбрать диски для виртуальной машины.](./media/create-vm/vm-certification-issues-solutions-17.png)

1. Подключите VHD в качестве диска данных к виртуальной машине, чтобы создать таблицу секционирования.

   1. Подключите VHD в качестве диска данных к виртуальной машине, чтобы создать таблицу секционирования.

   1. Выберите **Добавить**  >  **существующий большой двоичный объект** на диске.

      ![Снимок экрана, показывающий, как добавить диск данных к виртуальному жесткому диску.](./media/create-vm/vm-certification-issues-solutions-18.png)

   1. Найдите учетную запись хранения VHD.
   1. Выберите **контейнер** , а затем выберите свой виртуальный жесткий диск.
   1. Нажмите кнопку **ОК**.

      ![Снимок экрана со страницей присоединения неуправляемого диска.](./media/create-vm/vm-certification-issues-solutions-19.png)

      Виртуальный жесткий диск будет добавлен как LUN диска данных 0.

   1. Перезапустите виртуальную машину.

1. Войдите в виртуальную машину с помощью выводимого или другого клиента и выполните `sudo  -i` команду, чтобы получить доступ к корневому каталогу.

   ![Снимок экрана командной строки клиента, на котором показано вход и команда sudo-i.](./media/create-vm/vm-certification-issues-solutions-20.png)

1. Выполните команду `echo '+1M,' | sfdisk --move-data /dev/sdc -N 1`.

   ![Снимок экрана командной строки клиента, показывающий выполнение команд.](./media/create-vm/vm-certification-issues-solutions-25.png)

   >[!NOTE]
   >Выполнение этой команды может занять некоторое время, так как зависит от размера диска.

1. Отключите виртуальный жесткий диск от виртуальной машины и удалите виртуальную машину.


## <a name="default-credentials"></a>Учетные данные по умолчанию

Никогда не отправлять учетные данные по умолчанию с помощью отправленного виртуального жесткого диска. Добавление учетных данных по умолчанию делает виртуальный жесткий диск более уязвимым для угроз безопасности. Вместо этого создайте собственные учетные данные при отправке виртуального жесткого диска.
  
## <a name="datadisk-mapped-incorrectly"></a>Неверно сопоставленный диск с подсистемами

При отправке запроса с несколькими непоследовательными дисками данных может возникнуть ошибка сопоставления. Например, порядок нумерации для трех дисков данных должен быть *равен 0, 1, 2*. Любой другой порядок рассматривается как вопрос о сопоставлении.

Повторно отправьте запрос с соответствующей последовательностью дисков данных.

## <a name="incorrect-os-mapping"></a>Неправильное сопоставление ОС

Созданное изображение может быть сопоставлено с неправильной меткой ОС или назначено ей. Например, при выборе **Windows** в качестве части имени ОС во время создания образа диск операционной системы должен быть установлен только с Windows. Те же требования применимы и к Linux.

## <a name="vm-not-generalized"></a>Виртуальная машина не обобщена

Если все образы, взятые из Azure Marketplace, необходимо использовать повторно, VHD операционной системы должен быть обобщенным.

- Для **Linux** следующий процесс ОБобщает виртуальную машину Linux и повторно развертывает ее как ОТДЕЛЬную виртуальную машину.

  В окне SSH введите следующую команду: `sudo waagent -deprovision+user`.

- Для **Windows** вы обобщаете образы Windows с помощью `sysreptool` .

  Дополнительные сведения об этом `sysreptool` средстве см. в разделе [Обзор подготовки системы (Sysprep)](/windows-hardware/manufacture/desktop/sysprep--system-preparation--overview).

## <a name="datadisk-errors"></a>Ошибки на диске

Для устранения ошибок, связанных с диском данных, используйте следующую таблицу:

|Ошибка|Причина|Решение|
|---|---|---|
|`DataDisk- InvalidUrl:`|Эта ошибка может возникать из-за недопустимого логического номера устройства (LUN) при отправке предложения.|Убедитесь, что последовательность номеров LUN для диска данных находится в центре партнеров.|
|`DataDisk- NotFound:`|Эта ошибка может возникать, если диск данных не находится по указанному URL-адресу SAS.|Убедитесь, что диск данных расположен по указанному URL-адресу SAS.|

## <a name="remote-access-issue"></a>Проблемы с удаленным доступом

Эта ошибка возникает, если параметр протокол удаленного рабочего стола (RDP) не включен для образа Windows.

Включите доступ по протоколу RDP для образов Windows, прежде чем отправлять их.

## <a name="bash-history-failed"></a>Сбой журнала bash

Эта ошибка появится, если размер журнала Bash в отправленном изображении превышает 1 КБ. Размер ограничен 1 КБ, чтобы ограничить файл, содержащий потенциально конфиденциальную информацию.

Чтобы удалить журнал bash, сделайте следующее:

1. Разверните виртуальную машину и выберите параметр **выполнить команду** в портал Azure.

   ![Снимок экрана портал Azure с параметром "выполнить команду" в левой области.](./media/create-vm/vm-certification-issues-solutions-3.png)

1. Выберите первый вариант **руншеллскрипт** и выполните команду: `cat /dev/null > ~/.bash_history && history -c` .

   ![Снимок экрана со страницей "Запуск скрипта команды" на портал Azure.](./media/create-vm/vm-certification-issues-solutions-4.png)

1. После успешного выполнения команды перезапустите виртуальную машину.

1. Подготовьте виртуальную машину, возьмите VHD-образ и завершите работу виртуальной машины.

1. Повторно отправьте обобщенное изображение.

## <a name="request-an-exception-on-vm-images-for-select-tests"></a>Запрос исключения в образах виртуальных машин для выбранных тестов

Издатели могут запрашивать исключения для нескольких тестов, выполняемых во время сертификации виртуальной машины. Исключения предоставляются в редких случаях, когда издатель предоставляет свидетельство для поддержки запроса. Группа сертификации оставляет за собой право отклонять или утверждать исключения в любое время.

В этом разделе описаны общие сценарии, в которых издатели запрашивают исключение и как запросить одно из них.

### <a name="scenarios-for-exception"></a>Сценарии для исключения

Издатели обычно запрашивают исключения в следующих случаях:

- **Исключение для одного или нескольких тестовых случаев**. Обратитесь в [службу поддержки центра партнеров](https://aka.ms/marketplacepublishersupport) , чтобы запросить исключения для тестовых случаев.

- **Заблокированные виртуальные машины без корневого доступа**. У нескольких издателей есть сценарии, в которых виртуальные машины должны быть заблокированы, так как на ней установлены такие программы, как брандмауэры. В этом случае Скачайте [сертифицированное средство тестирования](https://aka.ms/AzureCertificationTestTool) и отправьте отчет в [службу поддержки центра партнеров](https://aka.ms/marketplacepublishersupport).

- **Пользовательские шаблоны**. Некоторые издатели публикуют образы виртуальных машин, для которых требуется пользовательский шаблон Azure Resource Manager (ARM) для развертывания виртуальных машин. В этом случае отправьте пользовательские шаблоны в [службу поддержки центра партнеров](https://aka.ms/marketplacepublishersupport) , чтобы группа сертификации могла использовать ее для проверки.

### <a name="information-to-provide-for-exception-scenarios"></a>Сведения, предоставляемые для сценариев исключений

Обратитесь в [службу поддержки центра партнеров](https://aka.ms/marketplacepublishersupport) , чтобы запросить исключение для одного из сценариев и включить следующие сведения:

- **Идентификатор издателя**. Введите идентификатор издателя центрального портала партнера.
- **Идентификатор или имя предложения**. Введите идентификатор или имя предложения.
- Номер **SKU или плана**. Введите идентификатор плана предложения для виртуальной машины или номер SKU.
- **Версия**. Введите версию предложения для виртуальной машины, для которой требуется исключение.
- **Тип исключения**. Выберите тесты, заблокированные виртуальные машины или пользовательские шаблоны.
- **Причина запроса**. Включите причину запроса исключения и любые сведения об исключениях тестов.
- **Временная шкала**. Введите дату окончания исключения.
- **Вложение**. Прикрепленные важные документы доказательств:

  - Для заблокированных виртуальных машин присоедините тестовый отчет.
  - Для пользовательских шаблонов укажите пользовательский шаблон ARM в качестве вложения.

  Если не включить эти вложения, запрос будет отклонен.

## <a name="address-a-vulnerability-or-an-exploit-in-a-vm-offer"></a>Устранение уязвимости или эксплойта в предложении виртуальной машины

В этом разделе описывается, как предоставить новый образ виртуальной машины при обнаружении уязвимости или атаки с помощью одного из образов виртуальных машин. Она применяется только к предложениям виртуальных машин Azure, опубликованным в Azure Marketplace.

> [!NOTE]
> Вы не можете удалить последний образ виртуальной машины из плана или придать ему возможность приказаться от последнего плана для предложения.

Выполните одно из следующих действий.

- Если у вас есть новый образ ВИРТУАЛЬНОЙ машины для замены уязвимого образа виртуальной машины, см. раздел [предоставление фиксированного образа](#provide-a-fixed-vm-image)виртуальной машины.
- Если у вас нет нового образа виртуальной машины для замены единственного образа виртуальной машины в плане или если вы закончили работу с планом, вы можете приступать [к продаже плана](partner-center-portal/update-existing-offer.md#stop-selling-an-offer-or-plan).
- Если вы не планируете замену единственного образа виртуальной машины в предложении, рекомендуем вам [отменить продажу предложения](partner-center-portal/update-existing-offer.md#stop-selling-an-offer-or-plan).

### <a name="provide-a-fixed-vm-image"></a>Укажите фиксированный образ виртуальной машины

Чтобы предоставить фиксированный образ виртуальной машины для замены образа виртуальной машины с уязвимостью или эксплойтом, выполните следующие действия.

1. Предоставьте новый образ виртуальной машины для устранения уязвимости или использования уязвимости системы безопасности.
1. Удалите образ виртуальной машины с помощью уязвимости или уязвимости системы безопасности.
1. Повторно опубликуйте предложение.

#### <a name="provide-a-new-vm-image-to-address-the-security-vulnerability-or-exploit"></a>Предоставление нового образа виртуальной машины для устранения уязвимости или эксплойта системы безопасности

Чтобы выполнить эти действия, подготовьте технические ресурсы для образа виртуальной машины, который вы хотите добавить. Дополнительные сведения см. в статьях [Создание виртуальной машины с помощью утвержденной базы](azure-vm-create-using-approved-base.md) данных или [Создание виртуальной машины с помощью собственного образа](azure-vm-create-using-own-image.md) и [Создание URI SAS для образа виртуальной машины](azure-vm-get-sas-uri.md).

1. Войдите в [Центр партнеров](https://partner.microsoft.com/dashboard/home).
1. В левой области выберите Обзор **коммерческого рынка**  >  .
1. В столбце **псевдоним предложения** выберите предложение.
1. На вкладке **Обзор плана** в столбце **имя** выберите соответствующий план.
1. На вкладке **Техническая конфигурация** в разделе **образы виртуальных машин** выберите **+ Добавить образ виртуальной машины**.

   > [!NOTE]
   > За раз можно добавить только один образ виртуальной машины в один план. Чтобы добавить несколько образов виртуальных машин, опубликуйте первый из них перед добавлением следующего образа виртуальной машины.

1. В появившихся полях укажите новую версию диска и образ виртуальной машины.
1. Выберите элемент **Сохранить черновик**.

Затем удалите образ виртуальной машины с уязвимостью системы безопасности.

#### <a name="remove-the-vm-image-with-the-security-vulnerability-or-exploit"></a>Удаление образа виртуальной машины с помощью уязвимости или эксплойта системы безопасности

1. Войдите в [Центр партнеров](https://partner.microsoft.com/dashboard/home).
2. В левой области выберите Обзор **коммерческого рынка**  >  .
3. В столбце **псевдоним предложения** выберите предложение.
4. На вкладке **Обзор плана** в столбце **имя** выберите соответствующий план.
5. На вкладке **Техническая конфигурация** в разделе **образы виртуальных** машин рядом с изображением виртуальной машины, которое необходимо удалить, выберите **Удалить образ виртуальной машины**.
6. В диалоговом окне выберите **продолжить**.
7. Выберите элемент **Сохранить черновик**.

Затем повторно опубликуйте предложение.

#### <a name="republish-the-offer"></a>Повторная публикация предложения

1. Выберите **Проверка и публикация**.
2. Если необходимо предоставить сведения группе сертификации, добавьте ее в поле **Примечания для сертификации** .
3. Нажмите кнопку **Опубликовать**.

Чтобы завершить процесс публикации, см. статью [Просмотр и публикация предложений](review-publish-offer.md).

## <a name="next-steps"></a>Следующие шаги

- [Настройка свойств предложения виртуальной машины](azure-vm-create-properties.md)
- [Активные вознаграждения Marketplace](partner-center-portal/marketplace-rewards.md)
- Если у вас есть вопросы или отзывы для улучшения, обратитесь в [службу поддержки центра партнеров](https://aka.ms/marketplacepublishersupport).
