---
title: Запрос контейнеров в Azure Cosmos DB
description: Узнайте, как запрашивать контейнеры в Azure Cosmos DB с помощью запросов in-Partition и кросс-Partition.
author: markjbrown
ms.service: cosmos-db
ms.subservice: cosmosdb-sql
ms.topic: how-to
ms.date: 3/18/2019
ms.author: mjbrown
ms.openlocfilehash: 0f08ca84597b08b9a236b7bfb0fc9c849423a752
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "93335897"
---
# <a name="query-an-azure-cosmos-container"></a>Запрос контейнера Azure Cosmos
[!INCLUDE[appliesto-sql-api](includes/appliesto-sql-api.md)]

В этой статье описывается, как запрашивать контейнеры (коллекции, графы и таблицы) в Azure Cosmos DB. В частности, в нем рассматривается работа запросов in-Partition и перекрестных секций в Azure Cosmos DB.

## <a name="in-partition-query"></a>Запрос в секции

При запросе данных из контейнеров, если в запросе указан фильтр ключа секции, Azure Cosmos DB автоматически оптимизирует запрос. Он направляет запрос в [физические секции](partitioning-overview.md#physical-partitions) , соответствующие значениям ключа секции, указанным в фильтре.

Например, рассмотрим приведенный ниже запрос с фильтром равенства `DeviceId` . Если выполнить этот запрос для контейнера, секционированного по `DeviceId` , этот запрос будет выполнять фильтрацию по одной физической секции.

```sql
    SELECT * FROM c WHERE c.DeviceId = 'XMS-0001'
```

Как и в предыдущем примере, этот запрос также будет выполнять фильтрацию по одной секции. Добавление дополнительного фильтра в не `Location` приводит к изменению этого:

```sql
    SELECT * FROM c WHERE c.DeviceId = 'XMS-0001' AND c.Location = 'Seattle'
```

Вот запрос, имеющий фильтр диапазона для ключа секции и не относящийся к одной физической секции. Чтобы быть запросом в секции, запрос должен иметь фильтр равенства, включающий ключ секции:

```sql
    SELECT * FROM c WHERE c.DeviceId > 'XMS-0001'
```

## <a name="cross-partition-query"></a>Запрос между секциями

Следующий запрос не имеет фильтра для ключа секции ( `DeviceId` ). Таким образом, он должен разбиваться на все физические секции, где он выполняется по индексу каждого раздела:

```sql
    SELECT * FROM c WHERE c.Location = 'Seattle`
```

Каждая физическая секция имеет собственный индекс. Поэтому при выполнении межсекционного запроса в контейнере фактически выполняется один запрос *для каждой* физической секции. Azure Cosmos DB будет автоматически объединять результаты по различным физическим секциям.

Индексы в разных физических секциях независимы друг от друга. В Azure Cosmos DB нет глобального индекса.

## <a name="parallel-cross-partition-query"></a>Параллельный запрос между секциями

Пакеты SDK Azure Cosmos DB 1.9.0 и более поздних версий поддерживают параметры выполнения параллельных запросов. Параллельные запросы между секциями позволяют выполнять запросы с низкой задержкой.

Вы можете управлять параллельным выполнением запросов, регулируя следующие параметры.

- **Максконкурренци**: задает максимальное число одновременных сетевых подключений к секциям контейнера. Если задать для этого свойства значение `-1` , пакет SDK будет управлять степенью параллелизма. Если  `MaxConcurrency` задано значение `0` , в секции контейнера входит одно сетевое подключение.

- **MaxBufferedItemCount**: задержка запросов на транзакции и использование памяти на стороне клиента. Если пропустить этот параметр или задать значение -1, пакет SDK будет регулировать число буферизованных элементов при параллельном выполнении запросов.

Из-за возможности Azure Cosmos DB параллелизации запросов между секциями, задержка запросов обычно масштабируется по мере того, как система добавит [физические секции](partitioning-overview.md#physical-partitions). Однако плата за ЕДИНИЦу будет значительно увеличиваться по мере увеличения общего числа физических секций.

При выполнении запроса между секциями, по сути, выполняется отдельный запрос для отдельной физической секции. Хотя запросы запросов между секциями будут использовать индекс (если он доступен), они по-прежнему не так эффективны, как запросы на секционирование.

## <a name="useful-example"></a>Полезный пример

Вот аналог для лучшего понимания запросов между секциями:

Предположим, что вы являетесь драйвером доставки, который должен доставлять пакеты в различные подразделения комплексес. У каждого комплексного апартамента есть список в локальной среде со всеми номерами резидентных единиц. Можно сравнить каждый из этих подразделений с физической секцией и каждым списком с индексом физической секции.

С помощью этого примера можно сравнивать запросы в секциях и перекрестных секциях.

### <a name="in-partition-query"></a>Запрос в секции

Если драйвер доставки знает правильную комплексную подразделение (физическую секцию), они могут сразу же приступить к правильному построению. Драйвер может проверить список номеров блоков резидентных модулей (индекс), а также быстро предоставить соответствующие пакеты. В этом случае драйвер не тратит время или усилия, влияющие на подразделение, и проверит, находятся ли в нем получатели пакетов.

### <a name="cross-partition-query-fan-out"></a>Запрос между секциями (Вентилятор-out)

Если драйвер доставки не знает подходящего комплексного апартамента (физического раздела), ему потребуется выполнить сборку каждого отдельного апартамента и проверить список со всеми номерами резидентных единиц (индексом). После того как они поступают в каждом апартаменте, они по-прежнему смогут использовать список адресов каждого резидентного объекта. Тем не менее, они должны проверять все списки, работающие со сложными апартаментами, независимо от того, находятся ли получатели пакетов в динамическом режиме. Вот как работают запросы между секциями. Хотя они могут использовать индекс (не нужно маскировать на каждой отдельной дверце), они должны отдельно проверить индекс для каждой физической секции.

### <a name="cross-partition-query-scoped-to-only-a-few-physical-partitions"></a>Запрос между секциями (с областью только несколько физических секций)

Если драйвер доставки знает, что все получатели пакета находятся в нескольких комплексесах апартамента, им не потребуется каждый из них. Хотя при работе с несколькими комплексес апартамента потребуется больше усилий, чем посещение всего одного здания, драйвер доставки по-прежнему сохраняет значительное время и усилия. Если запрос содержит ключ секции в фильтре с `IN` ключевым словом, он будет проверять только соответствующие индексы физической секции для данных.

## <a name="avoiding-cross-partition-queries"></a>Предотвращение запросов между секциями

Для большинства контейнеров неизбежно будет несколько запросов между секциями. Наличие запросов между секциями — это нормально! Почти все операции запроса поддерживаются в секциях (логические ключи секции и физические секции). Azure Cosmos DB также имеет много оптимизаций в механизме запросов и клиентских пакетах SDK для параллельного выполнения запросов в физических секциях.

Для большинства сценариев, интенсивно иссчитывающих запросы, рекомендуется просто выбрать наиболее общее свойство в фильтрах запросов. Необходимо также убедиться, что ключ раздела соответствует другим рекомендациям по [выбору ключа раздела](partitioning-overview.md#choose-partitionkey).

Предотвращение запросов между секциями обычно имеет большое значение только для больших контейнеров. Вам будет выставляться минимум примерно 2,5 единиц запросов при проверке индекса физической секции на предмет результатов, даже если ни один из элементов физической секции не соответствует фильтру запроса. Таким образом, при наличии только одной (или нескольких) физических секций запросы между секциями не будут потреблять значительно больше запросов, чем в секционировании.

Число физических секций связано с объемом подготовленных единиц запросов. Каждый физический раздел поддерживает до 10 000 подготовленных единиц запросов и может хранить до 50 ГБ данных. Azure Cosmos DB будет автоматически управлять физическими секциями. Количество физических секций в контейнере зависит от подготовленной пропускной способности и использованного хранилища.

Следует попытаться избежать запросов между секциями, если Рабочая нагрузка соответствует следующим критериям:
- Вы планируете использовать более 30 000 единиц запросов
- Вы планируете хранить более 100 ГБ данных

## <a name="next-steps"></a>Дальнейшие действия

Чтобы узнать о секционировании в Azure Cosmos DB, ознакомьтесь со следующими статьями:

- [Partitioning in Azure Cosmos DB](partitioning-overview.md) (Секционирование в Azure Cosmos DB)
- [Искусственные ключи секций в Azure Cosmos DB](synthetic-partition-keys.md)
