---
title: Работа с хранимыми процедурами, триггерами и UDF в Azure Cosmos DB
description: В этой статье вводятся такие концепции, как хранимые процедуры, триггеры и определяемые пользователем функции в Azure Cosmos DB.
author: timsander1
ms.service: cosmos-db
ms.subservice: cosmosdb-sql
ms.topic: conceptual
ms.date: 04/09/2020
ms.author: tisande
ms.reviewer: sngun
ms.openlocfilehash: ad9e6b99b396465c2cff95bd6ab340ef9d668085
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "99575963"
---
# <a name="stored-procedures-triggers-and-user-defined-functions"></a>Хранимые процедуры, триггеры и определяемые пользователем функции
[!INCLUDE[appliesto-sql-api](includes/appliesto-sql-api.md)]

Azure Cosmos DB обеспечивает транзакционное выполнение JavaScript с интегрированной средой для языка. При использовании API SQL в Azure Cosmos DB можно писать **хранимые процедуры**, **триггеры** и **определяемые пользователем функции (UDF)** на языке JavaScript. Вы можете написать свою логику на JavaScript, которую выполните в ядре СУБД. Можно создавать и выполнять триггеры, хранимые процедуры и определяемые пользователем функции с помощью [портал Azure](https://portal.azure.com/), [API интегрированных запросов JavaScript в Azure Cosmos DB](javascript-query-api.md) или [Cosmos DB клиентских пакетов SDK для SQL API](how-to-use-stored-procedures-triggers-udfs.md).

## <a name="benefits-of-using-server-side-programming"></a>Преимущества использования программирования на стороне сервера

Написание хранимых процедур, триггеров и пользовательских функций (UDF) в JavaScript позволяет создавать многофункциональные приложения, которые обладают следующими преимуществами.

* **Процедурная логика:** JavaScript как язык программирования высокого уровня, который предоставляет богатый и привычный интерфейс для выражения бизнес-логики. Вы можете выполнять последовательность сложных операций с данными.

* **Атомарные транзакции:** Azure Cosmos DB операции с базой данных, которые выполняются внутри одной хранимой процедуры или триггера, являются атомарными. Атомарные транзакции позволяют приложению объединить соответствующие операции в один пакет, который будет выполнен успешно полностью или не будет выполнен вовсе.

* **Производительность:** Данные JSON внутренне сопоставляются с системой типов языка JavaScript. Это сопоставление позволяет выполнить ряд оптимизаций, таких как отложенная материализация документов JSON в пуле буферов и их доступность по требованию для исполняемого кода. Существуют также другие преимущества производительности, связанные с доставкой бизнес-логики в базу данных:

   * *Пакетная обработка:* Вы можете группировать операции, такие как вставки, и отправлять их в группу. При создании отдельных операций значительно сокращаются затраты на задержку сетевого трафика и накладные расходы для хранения.

   * *Предварительная компиляция:* Хранимые процедуры, триггеры и определяемые пользователем функции неявно предварительно скомпилированы в формат байтового кода, чтобы избежать затрат на компиляцию во время каждого вызова скрипта. Благодаря предварительной компиляции скорость хранимой процедуры высокая, а занимаемая память небольшая.

   * *Последовательность:* Иногда операциям нужен механизм активации, который может выполнять одно или несколько обновлений данных. Помимо атомарности, выполнение на стороне сервера также дает преимущество в отношении производительности.

* **Инкапсуляция:** Хранимые процедуры можно использовать для группирования логики в одном месте. Инкапсуляция добавляет уровень абстракции поверх данных, что позволяет вам развивать свои приложения независимо от данных. Этот уровень абстракции полезен, когда данные не содержат схем, и вам не нужно внедрять дополнительную логику непосредственно в ваше приложение. Абстракция позволяет вам сохранить свои данные в безопасности, упрощая доступ к ним из сценариев.

> [!TIP]
> Хранимые процедуры лучше всего подходят для операций с высокой записью и потребовать транзакцию в значении ключа секции. При принятии решения о том, следует ли использовать хранимые процедуры, оптимизируйте их с инкапсуляцией максимально возможного объема операций записи. В целом, хранимые процедуры не являются наиболее эффективным средством для выполнения большого количества операций чтения или запроса, поэтому использование хранимых процедур для пакетного большого количества операций считывания для возврата клиенту не даст желаемого результата. Для лучшей производительности эти операции с высокой интенсивностью чтения должны выполняться на стороне клиента с помощью пакета SDK Cosmos. 

## <a name="transactions"></a>Transactions

Транзакции в типичной базе данных могут быть определены как последовательность операций, выполняемых в одной логической единице работы. Каждая транзакция предоставляет **гарантию выполнения принципа ACID**. ACID — хорошо известная аббревиатура, которая **означает: томиЦити**, **C** онсистенци, **I** солатион и **D** урабилити. 

* Атомарность гарантирует, что все операции, проделанные в транзакции, рассматриваются как единое целое и могут быть выполнены либо все, либо не выполнены вообще. 

* Согласованность гарантирует, что данные всегда находятся в допустимом состоянии между транзакциями. 

* Изолированность гарантирует, что никакие две транзакции не будут мешать друг другу. Много коммерческих систем обеспечивают несколько уровней изолированности, которые могут быть использованы в зависимости от потребностей приложений. 

* Устойчивость гарантирует, что любое изменение, которое совершено в базе данных, всегда будет присутствовать.

В Azure Cosmos DB среда выполнения JavaScript включена в ядро базы данных. Следовательно, запросы, хранимые процедуры и триггеры выполняются в том же пространстве, что и база данных. Эта возможность позволяет Azure Cosmos DB соблюдать принцип ACID для всех операций, которые являются частью хранимой процедуры или триггера. Примеры см. в статье [Транзакции в хранимых процедурах](how-to-write-stored-procedures-triggers-udfs.md#transactions).

### <a name="scope-of-a-transaction"></a>Область транзакции

Хранимые процедуры связаны с контейнером Azure Cosmos, а выполнение хранимой процедуры ограничивается логическим ключом секции. Хранимые процедуры должны включать значение ключа логической секции во время выполнения, определяющее логическую секцию для области транзакции. Дополнительные сведения см. в статье [Секционирование и горизонтальное масштабирование в Azure Cosmos DB](partitioning-overview.md).

### <a name="commit-and-rollback"></a>Фиксация и откат транзакций

Транзакции изначально интегрированы в модель программирования JavaScript в Azure Cosmos DB. В функции JavaScript все операции автоматически встроены в одну транзакцию. Если логика JavaScript в хранимой процедуре завершается без каких-либо исключений, то все операции транзакции передаются в базу данных. Такие операторы как `BEGIN TRANSACTION` и `COMMIT TRANSACTION` (знакомые по реляционным базам данных) неявно присутствуют в Azure Cosmos DB. Если в сценарии есть исключения, среда выполнения JavaScript в Azure Cosmos DB откатит всю транзакцию. Таким образом, вызов исключения фактически эквивалентен `ROLLBACK TRANSACTION` в базе данных Azure Cosmos DB.

### <a name="data-consistency"></a>Согласованность данных

Хранимые процедуры и триггеры всегда выполняются на основной реплике контейнера Azure Cosmos. Эта возможность гарантирует, что операции чтения в хранимых процедурах обеспечивают [сильную согласованность](./consistency-levels.md). Запросы с использованием пользовательских функций могут выполняться на первичной либо на любой вторичной реплике. Хранимые процедуры и триггеры предназначены для поддержки транзакционных записей, в то время как логика только для чтения лучше всего реализована в виде логики на стороне приложения и запросов с использованием [пакетов SDK API SQL Azure Cosmos DB](sql-api-dotnet-samples.md), которые помогут вам насыщать пропускную способность базы данных. 

> [!TIP]
> Запросы, выполняемые в хранимой процедуре или триггере, могут не видеть изменения элементов, внесенных в одну и ту же транзакцию скрипта. Эта инструкция применяется к запросам SQL, таким как `getContent().getCollection.queryDocuments()` , а также к запросам на языке LINQ, таким как `getContext().getCollection().filter()` .

## <a name="bounded-execution"></a>Ограниченное выполнение

Все операции Azure Cosmos DB должны завершаться за определенный период времени. Время ожидания хранимых процедур равно 5 секундам. Это ограничение относится к функциям JavaScript: хранимым процедурам, триггерам и определяемым пользователем функциям. Если операция не завершается в течение этого периода времени, транзакция откатывается.

Вы можете или завершить функции JavaScript за определенный период времени или поддерживать модель продолжения работы для пакетной или поэтапной обработки. Для упрощения разработки хранимых процедур и триггеров и ограничения времени их выполнения все функции в соответствии с контейнером Azure Cosmos (например, для создания, чтения, обновления и удаления элементов) возвращают логическое значение, которое представляет, будет ли эта операция завершена. Если значение равно false, это указывает на то, что процедура должна завершить выполнение, поскольку сценарий потребляет больше времени или ресурсов, чем предусмотрено в настройках. Операции, предшествующие первой неакцептованной операции сохранения данных, помещаются в очередь и гарантированно будут завершены, если хранимая процедура завершается в срок и очередь пуста. Таким же операциям следует ставить в очередь по очереди, используя соглашение об ответном вызове JavaScript для управления потоком управления сценария. Поскольку сценарии выполняются в среде на стороне сервера, они строго регламентированы. Сценарии, которые неоднократно нарушают границы выполнения, могут получить метку о неактивности и не могут выполняться. Их необходимо создать заново для соблюдения границ выполнения.

Функции JavaScript также подлежат [выделенной пропускной способности](request-units.md). Функции JavaScript потенциально могут использовать большое количество блоков запросов в течение короткого времени и могут быть ограничены по скорости, если достигнут предела пропускной способности. Важно отметить, что сценарии используют пропускную способность в дополнение к пропускной способности, затрачиваемой на выполнение операций с базой данных, хотя эти операции с базами данных немного дешевле, чем выполнение тех же операций клиентом.

## <a name="triggers"></a>Триггеры

Azure Cosmos DB поддерживает два типа триггеров:

### <a name="pre-triggers"></a>Триггеры предварительного выполнения

Azure Cosmos DB предоставляет триггеры, которые можно вызвать путем выполнения операций с элементом Azure Cosmos DB. Например, при создании элемента можно указать триггер предварительного выполнения. В этом случае триггер предварительного выполнения будет выполнен еще до создания элемента. Триггеры со срабатыванием до наступления события не могут иметь никаких входных параметров. При необходимости объект запроса можно использовать для обновления основного текста документа по сравнению с исходным запросом. При регистрации триггеров пользователи могут указать операции, с которыми они запускаются. Если триггер создавался с помощью `TriggerOperation.Create`, то его запрещается использовать в операции замены. Примеры см. в статье [Как записать триггеры](how-to-write-stored-procedures-triggers-udfs.md#triggers).

### <a name="post-triggers"></a>Триггеры последующего выполнения

Аналогично триггерам pre-Triggers, POST-Triggers также связаны с операцией в элементе Cosmos Azure и не нуждаются в входных параметрах. Они выполняются *после* завершения операции и имеют доступ к ответному сообщению, отправленному клиенту. Примеры см. в статье [Как записать триггеры](how-to-write-stored-procedures-triggers-udfs.md#triggers).

> [!NOTE]
> Зарегистрированные триггеры не запускаются автоматически при выполнении соответствующих операций (Create, DELETE, Replace/Update). При выполнении этих операций их приходится вызывать явным образом. Дополнительные сведения см. в статье [запуск триггеров](how-to-use-stored-procedures-triggers-udfs.md#pre-triggers) .

## <a name="user-defined-functions"></a><a id="udfs"></a>Пользовательские функции

[Определяемые пользователем функции](sql-query-udfs.md) (UDF) используются для расширения синтаксиса языка запросов API SQL и упрощения реализации собственной бизнес-логики. Их можно вызвать только внутри запросов. Определяемые пользователем функции не имеют доступа к объектам контекста и предназначены для использования только в качестве вычислимых скриптов JavaScript. Таким образом, определяемые пользователем функции могут запускаться только на дополнительных репликах. Примеры см. в статье [Как записать определяемые пользователем функции](how-to-write-stored-procedures-triggers-udfs.md#udfs).

## <a name="javascript-language-integrated-query-api"></a><a id="jsqueryapi"></a>API запросов, интегрированный в язык JavaScript

Кроме выдачи запросов с использованием синтаксиса запросов API SQL, [серверный пакет SDK](https://azure.github.io/azure-cosmosdb-js-server) позволяет создавать запросы с помощью интерфейса JavaScript без знания языка SQL. API запросов JavaScript позволяет программно создавать запросы, передавая функции предикатов в последовательность вызовов функций. Запросы анализируются средой выполнения JavaScript и эффективно выполняются в Azure Cosmos DB. Дополнительные сведения о поддержке API запросов JavaScript см. в статье [Working with JavaScript language integrated query API](javascript-query-api.md) (Как работать с API запросов с интегрированным языком JavaScript). Примеры см. в статье [How to write stored procedures and triggers using Javascript Query API](how-to-write-javascript-query-api.md) (Как записывать хранимые процедуры и триггеры в Azure Cosmos DB с помощью API запросов JavaScript).

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о том, как записать и использовать хранимые процедуры, триггеры и определяемые пользователем функции в Azure Cosmos DB, см. в этих статьях:

* [Как писать хранимые процедуры, триггеры и определяемые пользователем функции в Azure Cosmos DB](how-to-write-stored-procedures-triggers-udfs.md)

* [Как зарегистрировать и использовать хранимые процедуры, триггеры и определяемые пользователем функции в Azure Cosmos DB](how-to-use-stored-procedures-triggers-udfs.md)

* [Working with JavaScript language integrated query API](javascript-query-api.md) (Как работать с API запросов с интегрированным языком JavaScript)