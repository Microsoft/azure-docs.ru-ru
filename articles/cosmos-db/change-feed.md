---
title: Работа с поддержкой веб-канала изменений в Azure Cosmos DB
description: Используйте поддержку веб-канала изменений Azure Cosmos DB, чтобы отслеживать изменения в документах и выполнять обработку на основе событий, например триггеров, и поддерживать кэши и аналитические системы в обновленном состоянии.
author: TheovanKraay
ms.author: thvankra
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 04/08/2020
ms.reviewer: sngun
ms.custom: seodec18, "seo-nov-2020"
ms.openlocfilehash: c6856a0cb70123f1a3570b611c81660a592fdc1b
ms.sourcegitcommit: e46f9981626751f129926a2dae327a729228216e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "98027810"
---
# <a name="change-feed-in-azure-cosmos-db"></a>Канал изменений в Azure Cosmos DB
[!INCLUDE[appliesto-all-apis-except-table](includes/appliesto-all-apis-except-table.md)]

Веб-канал изменений в Azure Cosmos DB — это постоянная запись изменений в контейнер в порядке их возникновения. Канал изменений, поддерживаемый в Azure Cosmos DB, прослушивает изменения в контейнере Azure Cosmos. Затем он выводит отсортированный список документов в порядке, в котором они были изменены. Сохраненные изменения могут обрабатываться асинхронно и постепенно, а выходные данные могут быть распределены по одному или нескольким потребителям для параллельной обработки.

См. дополнительные сведения о [конструктивных шаблонах канала изменений](change-feed-design-patterns.md).

## <a name="supported-apis-and-client-sdks"></a>Поддерживаемые API и клиентские пакеты SDK

Этот компонент сейчас поддерживается следующими API Cosmos DB и клиентскими пакетами SDK:

| **Клиентские драйверы**; | **API SQL**; | **API Azure Cosmos DB для Cassandra** | **API Azure Cosmos DB для MongoDB** | **API Gremlin**;|**API таблицы**; |
| --- | --- | --- | --- | --- | --- | --- |
| .NET | Да | Да | Да | Да | нет |
|Java|Да|Да|Да|Да|нет|
|Python|Да|Да|Да|Да|нет|
|Node/JS|Да|Да|Да|Да|нет|

## <a name="change-feed-and-different-operations"></a>Канал изменений и разные операции

На сегодняшний момент вы видите все вставки и обновления в канале изменений. Возможность фильтрации канала изменений для просмотра только операций определенного типа не предусмотрена. Одно из возможных альтернативных решений заключается в том, чтобы помечать элементы для обновлений программным маркером, а затем фильтровать по нему элементы при обработке канала изменений.

Сейчас в канале изменений не регистрируются операции удаления. Аналогично предыдущему примеру, в удаляемые элементы можно добавить программный маркер. Например, можно добавить атрибут в элемент "deleted" и задать значение true для этого атрибута, а затем настроить срок жизни для этого элемента, чтобы его можно было удалять автоматически. Вы можете читать канал изменений, чтобы узнать исторические элементы (последнее изменение, соответствующее элементу, не включающее промежуточные изменения), например элементы, добавленные пять лет назад. Вы можете читать канал изменений до того момента, когда появился источник вашего контейнера, но если элемент удаляется, он будет удален и из канала изменений.

### <a name="sort-order-of-items-in-change-feed"></a>Порядок сортировки элементов в канале изменений

Элементы в канале изменений упорядочены по времени их изменения. Этот порядок сортировки обеспечивается только в пределах ключа логического раздела.

### <a name="consistency-level"></a>Уровень согласованности

При использовании канала изменений на уровне итоговой согласованности могут возникать повторяющиеся события между последовательными операциями чтения канала изменений (последнее событие одной операции чтения отображается как первое событие следующей операции).

### <a name="change-feed-in-multi-region-azure-cosmos-accounts"></a>Канал изменений для учетных записей Azure Cosmos с поддержкой нескольких регионов

В учетной записи Azure Cosmos с поддержкой нескольких регионов действует следующее правило: если для региона записи выполнена отработка отказа, канал изменений учитывает отработку отказа вручную и сохраняет непрерывность.

### <a name="change-feed-and-time-to-live-ttl"></a>Канал изменений и срок жизни (TTL)

Если для элемента свойство TTL (Срок жизни) имеет значение -1, канал изменений будет сохраняться без ограничения по времени. Если данные не удаляются, они будут храниться в канале изменений.  

### <a name="change-feed-and-_etag-_lsn-or-_ts"></a>Канал изменений и теги _etag, _lsn или _ts

Формат _etag считается внутренним, и его не следует применять для важных элементов, так как он может измениться в любое время. Тег _ts содержит метку времени последнего изменения или создания. Этот идентификатор можно использовать для сравнения в хронологическом порядке. Тег _isn — это идентификатор пакета, который добавляется только для канала изменений; он представляет идентификатор транзакции. Значение _lsn будет одинаковым для многих элементов. ETag для FeedResponse отличается от eTag для элементов. _etag является внутренним идентификатором и используется для управления параллелизмом. Свойство _etag сообщает о версии элемента, тогда как свойство ETag используется для виртуализации веб-канала.

## <a name="working-with-change-feed"></a>Работа с каналом изменений

Для работы с каналом изменений у вас есть следующие варианты:

* [Как использовать канал изменений Azure Cosmos DB с Функциями Azure](change-feed-functions.md)
* [Использование канала изменений с обработчиком канала изменений](change-feed-processor.md) 

Канал изменений доступен для каждого ключа логических разделов в контейнере, и его можно распределить для одного или нескольких потребителей для параллельной обработки, как показано на следующем рисунке.

:::image type="content" source="./media/change-feed/changefeedvisual.png" alt-text="Распределенная обработка веб-канала изменений Azure Cosmos DB" border="false":::

## <a name="features-of-change-feed"></a>Функции канала изменений

* Канал изменений по умолчанию включен для всех учетных записей Azure Cosmos.

* Вы можете использовать свою [подготовленную пропускную способность](request-units.md) для чтения из канала изменений, как и для любой другой операции Azure Cosmos DB, в любом регионе, настроенном для базы данных Azure Cosmos.

* Канал изменений поддерживает операции вставки и обновления, выполняемые по отношению к элементам в контейнере. Вы можете отслеживать операции удаления, используя вместо прямого удаления флаг обратимого удаления в элементах (например, документах). Или же можно установить ограниченный срок жизни элементов, используя настройки [срока жизни](time-to-live.md). Например, установите значение 24 часа и отслеживайте удаления по значению этого свойства. Эта возможность позволяет обрабатывать изменения быстрее, чем с использованием срока жизни.

* Каждое изменение в документе отображается в канале изменений ровно один раз, а логикой контрольных точек управляют клиенты. Если вы предпочитаете обойтись без сложности управления контрольными точками, обработчик канала изменений обеспечивает автоматический механизм установки контрольных точек и семантику "хотя бы однажды". См. раздел [Использование канала изменений с обработчиком канала изменений](change-feed-processor.md)

* В журнал изменений вносится только самое последнее изменение в конкретном элементе. Промежуточные изменения могут быть недоступны.

* Канал изменений сортируется по времени изменения в пределах каждого значения ключа логических разделов. Для значений ключа разделов не четкий порядок не предусмотрен.

* Изменения можно синхронизировать в любой момент времени. Это означает, что фиксированный период хранения данных, в пределах которого доступны изменения, отсутствует.

* Изменения поступают параллельно для всех ключей логических разделов из контейнера Azure Cosmos. Это позволяет нескольким потребителям параллельно обрабатывать изменения из больших контейнеров.

* Приложения могут обращаться сразу к нескольким каналам изменений в одном контейнере. Свойство ChangeFeedOptions.StartTime позволяет определить начальную точку. Например, так можно найти токен продолжения за определенный период времени. Если значение ContinuationToken указано, оно имеет приоритет перед значениями StartTime и StartFromBeginning. Точность ChangeFeedOptions.StartTime равняется приблизительно 5 секундам.

## <a name="change-feed-in-apis-for-cassandra-and-mongodb"></a>Канал изменений в API-интерфейсах для Cassandra и MongoDB

Функциональность канала изменений отображается как поток изменений в API MongoDB и запрос с предикатом в API Cassandra. Подробные сведения о реализации API MongoDB см. в разделе [Потоки изменений в API Azure Cosmos DB для MongoDB](mongodb-change-streams.md).

Встроенный API Apache Cassandra обеспечивает отслеживание измененных данных (CDC), механизм пометки определенных таблиц для архивирования, а также отклонения записей в эти таблицы после достижения настраиваемого размера на диске для журнала CDC. Функция канала изменений в API Azure Cosmos DB для Cassandra расширяет возможности запроса изменений с помощью предиката через CQL. Подробные сведения о реализации см. в разделе [Канал изменений в API Azure Cosmos DB для Cassandra](cassandra-change-feed.md).

## <a name="next-steps"></a>Дальнейшие действия

Вы можете продолжить знакомство с каналом изменений, перейдя к следующим статьям:

* [Reading Azure Cosmos DB change feed](read-change-feed.md) (Чтение канала изменений Azure Cosmos DB)
* [Как использовать канал изменений Azure Cosmos DB с Функциями Azure](change-feed-functions.md)
* [Использование обработчика канала изменений](change-feed-processor.md)
