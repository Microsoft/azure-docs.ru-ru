---
title: Непрерывное резервное копирование с функцией восстановления на момент времени в Azure Cosmos DB
description: Функция восстановления до точки во времени Azure Cosmos DB помогает восстановить данные из случайной операции записи, удаления или восстановления данных в любой регион. Сведения о ценах и текущих ограничениях.
author: kanshiG
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 02/01/2021
ms.author: govindk
ms.reviewer: sngun
ms.custom: references_regions
ms.openlocfilehash: d1dc108ecec93dddeb768eb61af425ba67f23002
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "100393145"
---
# <a name="continuous-backup-with-point-in-time-restore-preview-feature-in-azure-cosmos-db"></a>Непрерывное резервное копирование с возможностью восстановления до точки во времени (Предварительная версия) в Azure Cosmos DB
[!INCLUDE[appliesto-sql-mongodb-api](includes/appliesto-sql-mongodb-api.md)]

> [!IMPORTANT]
> Функция восстановления на момент времени (режим непрерывного резервного копирования) для Azure Cosmos DB в настоящее время находится в общедоступной предварительной версии.
> Эта предварительная версия предоставляется без соглашения об уровне обслуживания и не рекомендована для использования рабочей среде. Некоторые функции могут не поддерживаться или их возможности могут быть ограничены.
> Дополнительные сведения см. в статье [Дополнительные условия использования предварительных выпусков Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).

Функция восстановления до точки во времени Azure Cosmos DB (Предварительная версия) помогает в нескольких сценариях, таких как следующие:

* Для восстановления после случайной операции записи или удаления в контейнере.
* Восстановление удаленной учетной записи, базы данных или контейнера.
* Для восстановления в любой регион (где существовали резервные копии) в момент времени восстановления.

Azure Cosmos DB выполняет резервное копирование данных в фоновом режиме без использования дополнительной подготовленной пропускной способности (RUs) или влияя на производительность и доступность базы данных. Непрерывное резервное копирование выполняется в каждом регионе, где существует учетная запись. На следующем рисунке показано, как контейнер с регионом записи в западной части США, в регионах "Восток" и "Восточная часть США 2" архивируется в удаленную учетную запись хранилища BLOB-объектов Azure в соответствующих регионах. По умолчанию в каждом регионе хранится резервная копия в учетных записях локально избыточного хранилища. Если в регионе включена [Зона доступности](high-availability.md#availability-zone-support) , то резервная копия хранится в учетных записях хранения Zone-Redundant.

:::image type="content" source="./media/continuous-backup-restore-introduction/continuous-backup-restore-blob-storage.png" alt-text="Azure Cosmos DB резервное копирование данных в хранилище BLOB-объектов Azure." lightbox="./media/continuous-backup-restore-introduction/continuous-backup-restore-blob-storage.png" border="false":::

Временное окно для восстановления (также известное как срок хранения) — это наименьшее значение следующих двух: *30 дней назад в прошлом* или *до времени создания ресурса*. Момент времени для восстановления может быть любой меткой времени в пределах срока хранения.

В общедоступной предварительной версии можно восстановить учетную запись Azure Cosmos DB для API SQL или точки во времени в другой учетной записи, используя [портал Azure](continuous-backup-restore-portal.md), [интерфейс командной строки Azure](continuous-backup-restore-command-line.md) (az CLI), [Azure PowerShell](continuous-backup-restore-powershell.md)или [Azure Resource Manager](continuous-backup-restore-template.md).

## <a name="what-is-restored"></a>Что будет восстановлено?

В стабильном состоянии все изменения, выполненные в исходной учетной записи (в том числе базы данных, контейнеры и элементы), архивируются асинхронно в течение 100 секунд. Если носитель резервной копии (то есть служба хранилища Azure) не работает или недоступен, изменения сохраняются локально до тех пор, пока носитель не станет доступен, а затем записывается на диск, чтобы предотвратить потери в точности операций, которые можно восстановить.

Вы можете выбрать восстановление любой комбинации подготовленных контейнеров пропускной способности, общей пропускной способности или всей учетной записи. Действие восстановления восстанавливает все данные и их свойства индекса в новую учетную запись. Процесс восстановления гарантирует, что все данные, восстанавливаемые в учетной записи, базе данных или контейнере, будут точно соответствовать указанному времени восстановления. Длительность восстановления будет зависеть от объема данных, которые необходимо восстановить.

> [!NOTE]
> В режиме непрерывного резервного копирования резервные копии берутся в каждом регионе, где доступна ваша учетная запись Azure Cosmos DB. Резервные копии, созданные для каждой учетной записи региона, локально избыточны по умолчанию, а зона избыточна, если в вашей учетной записи включена функция [зоны доступности](high-availability.md#availability-zone-support) для этого региона. Действие восстановления всегда восстанавливает данные в новую учетную запись.

## <a name="what-is-not-restored"></a>Что не будет восстановлено?

Следующие конфигурации не восстанавливаются после восстановления на момент времени.

* Параметры брандмауэра, виртуальной сети, частной конечной точки.
* Параметры согласованности. По умолчанию учетная запись восстанавливается с согласованностью сеанса.  
* Регионах.
* Хранимые процедуры, триггеры, UDF.

Эти конфигурации можно добавить в восстановленную учетную запись после завершения восстановления.

## <a name="restore-scenarios"></a>Сценарии восстановления

Ниже приведены некоторые ключевые сценарии, которые решаются функцией восстановления до точки во времени. В сценариях [a] – [c] показано, как активировать восстановление, если метка времени восстановления известна заранее.
Однако возможны ситуации, когда неизвестно точное время случайного удаления или повреждения. В сценариях [d] и [e] показано, как _обнаружить_ отметку времени восстановления с помощью новых API-интерфейсов веб-канала событий в базе данных restorable или контейнерах.

:::image type="content" source="./media/continuous-backup-restore-introduction/restorable-account-scenario.png" alt-text="События жизненного цикла с отметками времени для учетной записи restorable." lightbox="./media/continuous-backup-restore-introduction/restorable-account-scenario.png" border="false":::

а. **Восстановить удаленную учетную запись** — все удаленные учетные записи, которые можно восстановить, видны на панели **восстановления** . Например, если *учетная запись A* удаляется по метке времени T3. В этом случае достаточно отметок времени перед T3, расположением, именем целевой учетной записи, группой ресурсов и именем целевой учетной записи, достаточным для восстановления из [портал Azure](continuous-backup-restore-portal.md#restore-deleted-account), [PowerShell](continuous-backup-restore-powershell.md#trigger-restore)или [CLI](continuous-backup-restore-command-line.md#trigger-restore).  

:::image type="content" source="./media/continuous-backup-restore-introduction/restorable-container-database-scenario.png" alt-text="События жизненного цикла с отметками времени для базы данных restorable и контейнера." lightbox="./media/continuous-backup-restore-introduction/restorable-container-database-scenario.png" border="false":::

b. **Восстановление данных учетной записи в определенном регионе** — например, если *учетная запись a* существует в двух регионах: *Восточная часть США* и *Западная часть США* по метке времени T3. Если вам нужна копия учетной записи A в *западной части США*, можно выполнить восстановление на момент времени из [портал Azure](continuous-backup-restore-portal.md), [PowerShell](continuous-backup-restore-powershell.md#trigger-restore)или [CLI](continuous-backup-restore-command-line.md#trigger-restore) , указав Запад США в качестве целевого расположения.

c. **Восстановление после случайной операции записи или удаления в контейнере с известной меткой времени восстановления** — например, если **известно** , что содержимое *контейнера 1* в *базе данных 1* было случайно изменено при отметке времени T3. Вы можете выполнить восстановление на момент времени из [портал Azure](continuous-backup-restore-portal.md#restore-live-account), [PowerShell](continuous-backup-restore-powershell.md#trigger-restore)или [CLI](continuous-backup-restore-command-line.md#trigger-restore) в другую учетную запись с меткой времени T3, чтобы восстановить требуемое состояние контейнера.

d. **Восстановление учетной записи до предыдущей точки во времени перед случайным удалением базы данных** . в [портал Azure](continuous-backup-restore-portal.md#restore-live-account)можно использовать панель "поток событий", чтобы определить, когда база данных была удалена, и найти время восстановления. Аналогично, с помощью [Azure CLI](continuous-backup-restore-command-line.md#trigger-restore) и [PowerShell](continuous-backup-restore-powershell.md#trigger-restore)можно обнаружить событие удаления базы данных, перечисляя веб-канал событий базы данных, а затем выполнив команду Restore с необходимыми параметрами.

д) **Восстановление учетной записи до предыдущей точки во времени перед случайным удалением или изменением свойств контейнера.** — В [портал Azure](continuous-backup-restore-portal.md#restore-live-account)можно использовать панель «канал событий» для определения времени создания, изменения или удаления контейнера, чтобы найти время восстановления. Аналогично, с помощью [Azure CLI](continuous-backup-restore-command-line.md#trigger-restore) и [PowerShell](continuous-backup-restore-powershell.md#trigger-restore)можно обнаружить все события контейнера, перечисляя поток событий контейнера, а затем активировать команду Restore с необходимыми параметрами.

## <a name="permissions"></a>Разрешения

Azure Cosmos DB позволяет изолировать и ограничить разрешения на восстановление для учетной записи непрерывного резервного копирования определенной ролью или участником. Владелец учетной записи может активировать восстановление и назначить роль другим участникам для выполнения операции восстановления. Дополнительные сведения см. в статье о [разрешениях](continuous-backup-restore-permissions.md) .

## <a name="pricing"></a><a id="continuous-backup-pricing"></a>Цены

Учетные записи Azure Cosmos DB с включенным непрерывным резервным копированием потребуют дополнительной ежемесячной оплаты для *хранения резервной копии* и *восстановления данных*. Затраты на восстановление добавляются при каждом запуске операции восстановления. Если вы настраиваете учетную запись с непрерывной резервной копией, но не восстанавливаете данные, в счет включается только стоимость хранилища резервных копий.

Следующий пример основан на ценах на учетную запись Azure Cosmos, развернутую в регионе, не являющемся государственным в США. Цены и вычисления могут различаться в зависимости от используемого региона. сведения о ценах см. на [странице цен Azure Cosmos DB](https://azure.microsoft.com/pricing/details/cosmos-db/) .

* Для всех учетных записей с политикой непрерывного резервного копирования взимается дополнительная ежемесячная плата за хранилище резервных копий, которая вычисляется следующим образом:

  Размер данных $0,20/ГБ * в ГБ учетной записи * число регионов

* Каждый вызов API восстановления требует однократной оплаты. Плата является функцией объема восстановления данных и вычисляется следующим образом:

  Размер данных $0,15/GB * в ГБ.

Например, если у вас есть 1 ТБ данных в двух регионах, то:

* Стоимость хранилища резервных копий вычисляется как (1000 * 0,20 * 2) = $400 в месяц

* Затраты на восстановление рассчитываются как (1000 * 0,15) = $150 на восстановление

## <a name="current-limitations-public-preview"></a>Текущие ограничения (общедоступная Предварительная версия)

В настоящее время функция восстановления на момент времени находится в общедоступной предварительной версии и имеет следующие ограничения.

* Для непрерывного резервного копирования поддерживаются только интерфейсы API Azure Cosmos DB для SQL и MongoDB. API-интерфейсы таблиц, Gremlin и Cassandra пока не поддерживаются.

* Существующую учетную запись с политикой периодических резервных копий по умолчанию нельзя преобразовать для использования режима непрерывной архивации.

* Облачные регионы Azure независимых и Azure для государственных организаций еще не поддерживаются.

* Учетные записи с ключами, управляемыми клиентом, не поддерживают непрерывное резервное копирование.

* Учетные записи для записи в несколько регионов не поддерживаются.

* Учетные записи с включенной ссылкой синапсе не поддерживаются.

* Восстановленная учетная запись создается в том же регионе, в котором находится исходная учетная запись. Нельзя восстановить учетную запись в регион, в котором исходная учетная запись не существовала ранее.

* Окно восстановления занимает всего лишь 30 дней и не может быть изменено.

* Резервные копии не поддерживают автоматическую устойчивость к отказам на уровне региона. Необходимо явно добавить другой регион, чтобы обеспечить устойчивость учетной записи и резервной копии.

* Пока выполняется восстановление, не изменяйте и не удаляйте политики управления удостоверениями и доступом (IAM), которые предоставляют разрешения для учетной записи или изменяют любую виртуальную сеть, конфигурацию брандмауэра.

* API Azure Cosmos DB для учетных записей SQL или MongoDB, которые создают уникальный индекс после создания контейнера, не поддерживаются для непрерывного резервного копирования. Поддерживаются только контейнеры, создающие уникальный индекс в рамках исходного создания контейнера. Для учетных записей MongoDB вы создаете уникальный индекс с помощью [команд расширения](mongodb-custom-commands.md).

* Функция восстановления на определенный момент времени всегда восстанавливается в новой учетной записи Azure Cosmos. Восстановление в имеющуюся учетную запись в настоящее время не поддерживается. Если вы заинтересованы в предоставлении отзыва о восстановлении на месте, обратитесь к группе Azure Cosmos DB с помощью представителя учетной записи или [UserVoice](https://feedback.azure.com/forums/263030-azure-cosmos-db).

* Все новые интерфейсы API, предоставляемые для перечисления,,,, могут быть изменены, `RestorableDatabaseAccount` `RestorableSqlDatabases` `RestorableSqlContainer` `RestorableMongodbDatabase` `RestorableMongodbCollection` пока эта функция находится на этапе предварительной версии.

* После восстановления возможно, что для некоторых коллекций последовательный индекс может быть перестроен. Состояние операции перестроения можно проверить с помощью свойства [IndexTransformationProgress](how-to-manage-indexing-policy.md) .

* В процессе восстановления восстанавливаются все свойства контейнера, включая его конфигурацию TTL. В результате возможно, что восстанавливаемые данные будут удалены немедленно, если они настроены таким образом. Чтобы предотвратить эту ситуацию, временная метка восстановления должна быть установлена перед добавлением свойств TTL в контейнер.

## <a name="next-steps"></a>Дальнейшие действия

* Настройка непрерывного резервного копирования и управление им с помощью [портал Azure](continuous-backup-restore-portal.md), [PowerShell](continuous-backup-restore-powershell.md), [интерфейса командной строки](continuous-backup-restore-command-line.md)или [Azure Resource Manager](continuous-backup-restore-template.md).
* [Управление разрешениями](continuous-backup-restore-permissions.md) , необходимыми для восстановления данных в режиме непрерывной архивации.
* [Модель ресурсов режима непрерывного резервного копирования](continuous-backup-restore-resource-model.md)
