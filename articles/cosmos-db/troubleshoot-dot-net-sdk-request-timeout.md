---
title: Устранение неполадок Azure Cosmos DB HTTP 408 или времени ожидания запроса с помощью пакета SDK для .NET
description: Узнайте, как диагностировать и исправить исключения времени ожидания запроса пакета SDK для .NET.
author: j82w
ms.service: cosmos-db
ms.subservice: cosmosdb-sql
ms.date: 03/05/2021
ms.author: jawilley
ms.topic: troubleshooting
ms.reviewer: sngun
ms.custom: devx-track-dotnet
ms.openlocfilehash: c8d35f7c666562022f503b2777f30f84193d0231
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "102440009"
---
# <a name="diagnose-and-troubleshoot-azure-cosmos-db-net-sdk-request-timeout-exceptions"></a>Диагностика и устранение неполадок с Azure Cosmos DB исключениями времени ожидания запроса пакета SDK для .NET
[!INCLUDE[appliesto-sql-api](includes/appliesto-sql-api.md)]

Ошибка HTTP 408 возникает, если пакету SDK не удалось выполнить запрос до наступления предельного времени ожидания.

## <a name="customize-the-timeout-on-the-azure-cosmos-db-net-sdk"></a>Настройка времени ожидания для пакета SDK для Azure Cosmos DB .NET

Пакет SDK имеет два разных варианта времени ожидания управления, каждый из которых имеет разную область.

### <a name="requesttimeout"></a>RequestTimeout

`CosmosClientOptions.RequestTimeout`Конфигурация (или `ConnectionPolicy.RequestTimeout` для пакета SDK версии 2) позволяет задать время ожидания, влияющее на каждый отдельный сетевой запрос. Операция, запущенная пользователем, может охватывать несколько сетевых запросов (например, может потребоваться регулирование). Эта конфигурация будет применяться к каждому сетевому запросу при повторной попытке. Это время ожидания не является сквозным запросом на выполнение операции.

### <a name="cancellationtoken"></a>CancellationToken

Все асинхронные операции в пакете SDK имеют необязательный параметр CancellationToken. Этот параметр [CancellationToken](/dotnet/standard/threading/how-to-listen-for-cancellation-requests-by-polling) используется во всей операции во всех сетевых запросах. В между сетевыми запросами может быть установлен маркер отмены, и операция отменяется, если истек срок действия связанного маркера. Токен отмены следует использовать для определения приблизительного ожидаемого времени ожидания в области действия операции.

> [!NOTE]
> `CancellationToken`Параметр — это механизм, при котором библиотека проверяет отмену, когда она [не вызывает недопустимого состояния](https://devblogs.microsoft.com/premier-developer/recommended-patterns-for-cancellationtoken/). Операция может не отменяться в точности, если время, определенное в отмене, истекло. В противном случае она отменяется, когда это надежно.

## <a name="troubleshooting-steps"></a>Действия по устранению неполадок
Следующий список содержит известные причины и решения для исключений времени ожидания запроса.

### <a name="high-cpu-utilization"></a>Высокая загрузка ЦП.
Высокая загрузка ЦП является наиболее распространенным вариантом. Для оптимальной задержки загрузка ЦП должна составлять примерно 40%. Используйте 10 секунд в качестве интервала для наблюдения за максимальным (несредним) потреблением ресурсов ЦП. Пиковые нагрузки ЦП наиболее распространены с запросами между секциями, где они могут выполнять несколько подключений для одного запроса.

Если ошибка содержит `TransportException` сведения, она также может содержать `CPU History` :

```
CPU history: 
(2020-08-28T00:40:09.1769900Z 0.114), 
(2020-08-28T00:40:19.1763818Z 1.732), 
(2020-08-28T00:40:29.1759235Z 0.000), 
(2020-08-28T00:40:39.1763208Z 0.063), 
(2020-08-28T00:40:49.1767057Z 0.648), 
(2020-08-28T00:40:59.1689401Z 0.137), 
CPU count: 8)
```

* Если размер ЦП превышает 70%, то время ожидания может быть вызвано нехваткой ресурсов ЦП. В этом случае для решения проблемы следует изучить источник высокой загрузки ЦП и сократить ее или масштабировать компьютер, чтобы увеличить количество ресурсов.
* Если измерения ЦП не происходят каждые 10 секунд (например, присутствуют пропуски или время измерения свидетельствует о том, что между измерениями проходит больше времени), причина в нехватке потоков. В этом случае для решения проблемы следует изучить причину нехватки потоков (потенциально заблокированные потоки) или масштабировать компьютеры, чтобы увеличить количество ресурсов.

#### <a name="solution"></a>Решение.
Клиентское приложение, использующее пакет SDK, должно быть увеличено или уменьшено.

### <a name="socket-or-port-availability-might-be-low"></a>Доступность сокета или порта может быть низкой
При работе в Azure клиенты, использующие пакет SDK для .NET, могут достичь нехватки портов Azure SNAT (PAT).

#### <a name="solution-1"></a>Решение 1.
Если вы используете виртуальные машины Azure, следуйте указаниям в разделе " [нехватка портов SNAT](troubleshoot-dot-net-sdk.md#snat)".

#### <a name="solution-2"></a>Решение 2.
Если вы используете службу приложений Azure, выполните [инструкции по устранению неполадок подключения](../app-service/troubleshoot-intermittent-outbound-connection-errors.md#cause) и [используйте диагностику службы приложений](https://azure.github.io/AppService/2018/03/01/Deep-Dive-into-TCP-Connections-in-App-Service-Diagnostics.html).

#### <a name="solution-3"></a>Решение 3.
Если вы используете функции Azure, убедитесь, что вы отслеживаете [рекомендации Azure](../azure-functions/manage-connections.md#static-clients) по обслуживанию одноэлементных или статических клиентов для всех связанных служб (включая Azure Cosmos DB). Проверьте [ограничения службы](../azure-functions/functions-scale.md#service-limits) в зависимости от типа и размера размещения приложение-функция.

#### <a name="solution-4"></a>Решение 4.
При использовании прокси-сервера HTTP убедитесь, что он может поддерживать число подключений, указанное в свойстве `ConnectionPolicy` пакета SDK. В противном случае возникают проблемы с подключением.

### <a name="create-multiple-client-instances"></a>Создание нескольких экземпляров клиента
Создание нескольких экземпляров клиента может привести к конфликтам соединений и времени ожидания.

#### <a name="solution"></a>Решение.
Следуйте [рекомендациям по повышению производительности](performance-tips-dotnet-sdk-v3-sql.md#sdk-usage)и используйте один экземпляр космосклиент во всем процессе.

### <a name="hot-partition-key"></a>Ключ горячей секции
Azure Cosmos DB распределяет общую пропускную способность равномерно по физическим секциям. При наличии горячей секции один или несколько ключей логических секций в физическом разделе потребляют все единицы запросов физического раздела в секунду (единиц запроса/с). В то же время единицы запросов/s на других физических секциях будут недоступными. В качестве симптома общий объем занятых единиц запросов в секунду будет меньше, чем общая подготовленная единица запросов/s в базе данных или контейнере, но вы по-прежнему увидите регулирование (429s) в запросах к ключу горячей логической секции. Используйте [нормализованную метрику потребления на единицу](monitor-normalized-request-units.md) , чтобы определить, обнаруживается ли в рабочей нагрузке горячую секцию. 

#### <a name="solution"></a>Решение.
Выберите хороший ключ секции, который равномерно распределяет объем запросов и хранилище. Узнайте, как [изменить ключ секции](https://devblogs.microsoft.com/cosmosdb/how-to-change-your-partition-key/).

### <a name="high-degree-of-concurrency"></a>Высокая степень параллелизма
Приложение выполняет высокий уровень параллелизма, что может привести к состязанию в канале.

#### <a name="solution"></a>Решение.
Клиентское приложение, использующее пакет SDK, должно быть увеличено или уменьшено.

### <a name="large-requests-or-responses"></a>Большие запросы или ответы
Большие запросы или ответы могут привести к блокированию головного компьютера на основе усугубить, даже с относительно низкой степенью параллелизма.

#### <a name="solution"></a>Решение.
Клиентское приложение, использующее пакет SDK, должно быть увеличено или уменьшено.

### <a name="failure-rate-is-within-the-azure-cosmos-db-sla"></a>Частота сбоев в рамках соглашения об уровне обслуживания Azure Cosmos DB
Приложение должно иметь возможность обрабатывать временные сбои и при необходимости повторять попытку. Любые исключения 408 не повторяются, так как при создании путей невозможно определить, создан ли элемент службой. Повторная отправка одного и того же элемента для CREATE вызовет исключение конфликта. Бизнес-логика пользовательских приложений может иметь пользовательскую логику обработки конфликтов, что приведет к нарушению неоднозначности существующего элемента, а также конфликту при создании повторных попыток.

### <a name="failure-rate-violates-the-azure-cosmos-db-sla"></a>Частота сбоев нарушает Azure Cosmos DB соглашения об уровне обслуживания
Обратитесь в [службу поддержки Azure](https://aka.ms/azure-support).

## <a name="next-steps"></a>Дальнейшие действия
* [Диагностика и устранение неполадок](troubleshoot-dot-net-sdk.md) при использовании пакета SDK для Azure Cosmos DB .NET.
* Ознакомьтесь с рекомендациями по производительности для [.NET v3](performance-tips-dotnet-sdk-v3-sql.md) и [.NET v2](performance-tips.md).