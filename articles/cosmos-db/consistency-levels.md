---
title: Уровни согласованности в Azure Cosmos DB
description: В Azure Cosmos DB есть пять уровней согласованности, что позволяет сбалансировать компромиссы между согласованностью в конечном счете, доступностью и задержками.
author: markjbrown
ms.author: mjbrown
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 12/09/2020
ms.openlocfilehash: a480c8f2dfdda0ce7a1eb879554fb79c96adbe1e
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "97347818"
---
# <a name="consistency-levels-in-azure-cosmos-db"></a>Уровни согласованности в Azure Cosmos DB
[!INCLUDE[appliesto-all-apis](includes/appliesto-all-apis.md)]

Распределенные базы данных, использующие репликацию для обеспечения высокой доступности, низкой задержки или и того и другого, должны обеспечить фундаментальный компромисс между согласованностью чтения, доступностью, задержкой и пропускной способностью, как определено в [паклк Теорема](https://en.wikipedia.org/wiki/PACELC_theorem). Линеаризации модели строгой согласованности является золотым стандартом программирования данных. Но это увеличивает цену с высокой задержкой при записи из-за данных, требующих репликации и фиксации на больших расстояниях. Строгая согласованность может также пострадать от снижения доступности (во время сбоев), так как данные не могут реплицироваться и зафиксироваться в каждом регионе. Окончательная согласованность обеспечивает более высокую доступность и лучшую производительность, но усложняет программирование приложений, поскольку данные могут быть не полностью согласованы во всех регионах.

В настоящее время большинство коммерческих доступных распределенных баз данных NoSQL, доступных на рынке, обеспечивают только строгую и окончательную согласованность. Azure Cosmos DB предлагает пять четко определенных уровней. С самого стойки на слабые уровни:

- *Уровень согласованности "Строгая"*
- *Ограниченное устаревание*
- *Session*
- *Последовательный префикс*
- *Рано*

Каждый уровень предоставляет компромиссы по доступности и производительности. На следующем рисунке показаны различные уровни согласованности в качестве спектра.

:::image type="content" source="./media/consistency-levels/five-consistency-levels.png" alt-text="Согласованность как спектр" border="false" :::

Уровни согласованности не зависят от региона и гарантированно выполняются для всех операций независимо от региона, из которого обслуживаются операции чтения и записи, число регионов, связанных с учетной записью Cosmos Azure, или для вашей учетной записи настроен один или несколько регионов записи.

## <a name="consistency-levels-and-azure-cosmos-db-apis"></a>Уровни согласованности и API для Azure Cosmos DB

Azure Cosmos DB предоставляет встроенную поддержку интерфейсов API, совместимых с протоколом Wired, для популярных баз данных. К ним относятся MongoDB, Apache Cassandra, Gremlin и хранилище таблиц Azure. При использовании API Gremlin и API таблиц используется уровень согласованности по умолчанию, настроенный в учетной записи Azure Cosmos. Дополнительные сведения о сопоставлении уровней согласованности между API Cassandra или API для уровней согласованности для MongoDB и Azure Cosmos DB см. в [API Cassandra сопоставление согласованности](cassandra-consistency.md) и [API для сопоставления согласованности MongoDB](mongodb-consistency.md).

## <a name="scope-of-the-read-consistency"></a>Область согласованности данных при чтении

Согласованность чтения применяется к одной операции чтения, ограниченной в пределах логической секции. Операции чтения могут выдаваться удаленным клиентом или хранимой процедурой.

## <a name="configure-the-default-consistency-level"></a>Настройка уровня согласованности по умолчанию

Уровень согласованности по умолчанию в учетной записи Azure Cosmos DB можно настроить в любое время. Уровень согласованности по умолчанию, настроенный для учетной записи, применяется ко всем базам данных и контейнерам Azure Cosmos в этой учетной записи. Все операции чтения и запросы к контейнеру или базе данных будут по умолчанию использовать указанный уровень согласованности. Дополнительные сведения см.в статье [о настройке уровня согласованности по умолчанию](how-to-manage-consistency.md#configure-the-default-consistency-level). Вы также можете переопределить уровень согласованности по умолчанию для конкретного запроса. Дополнительные сведения см. в разделе [Переопределение статьи уровня согласованности по умолчанию](how-to-manage-consistency.md?#override-the-default-consistency-level) .

> [!IMPORTANT]
> После изменения уровня согласованности по умолчанию необходимо повторно создать любой экземпляр пакета SDK. Это можно сделать, перезапустив приложение. Это гарантирует, что пакет SDK будет использовать новый уровень согласованности по умолчанию.

## <a name="guarantees-associated-with-consistency-levels"></a>Гарантии, связанные с уровнями согласованности

Azure Cosmos DB гарантирует, что 100% запросов на чтение соответствует гарантии согласованности для выбранного уровня согласованности. Точные определения пяти уровней согласованности в Azure Cosmos DB, использующих язык спецификации TLA +, приведены в репозитории GitHub [Azure-Cosmos-TLA](https://github.com/Azure/azure-cosmos-tla) .

Ниже описана семантика этих пяти уровней согласованности.

- **Strong**: строгая согласованность обеспечивает гарантию линеаризации. Линеаризации означает одновременное обслуживание запросов. Все операции чтения гарантированно возвращают последнюю версию элемента. Клиент никогда не увидит не зафиксированную или частично измененную запись. Пользователь всегда гарантированно сможет прочесть последнюю зафиксированную запись.

  На следующем рисунке показана строгая согласованность с музыкальными примечаниями. После того как данные записываются в регион "Западная часть США 2", при чтении данных из других регионов вы получаете Последнее значение:

  :::image type="content" source="media/consistency-levels/strong-consistency.gif" alt-text="Иллюстрация уровня строгой согласованности":::

- **Ограниченное устаревание**: операции чтения гарантированно учитывают гарантию соответствия префиксов. Операции чтения могут отставать от операций записи по большинству версий *"K"* (то есть "обновления") элемента или по *"T"* интервалу времени, в зависимости от того, что достигнуто первым. Иными словами, при выборе ограниченного устаревания можно настроить «устаревания» двумя способами.

- Число версий элемента (*K*)
- Операции чтения временного интервала (*T*) могут отставать от операций записи

Для учетной записи одного региона минимальное значение *K* и *T* равно 10 операциям записи или 5 секундам. Для учетных записей в нескольких регионах минимальное значение *K* и *T* — 100 000 операций записи или 300 секунд.

Ограниченная устаревшая версия предлагает общий глобальный порядок за пределами "окна устаревания". Если клиент выполняет операции чтения в регионе, который принимает записи, то гарантии, обеспечиваемые согласованностью ограниченного устаревания, идентичны этим гарантиям строгой согласованности. Так как окно устаревания приближается к времени или обновлениям, в зависимости от того, какое значение ближе, служба будет регулировать новые операции записи, чтобы обеспечить репликацию и обеспечить целостность.

В окне устаревания ограничения ограниченного устаревания обеспечивают следующие гарантии согласованности.

- Согласованность для клиентов в одном регионе для учетной записи с единственной областью записи = strong
- Согласованность для клиентов в разных регионах для учетной записи с единственной областью записи = согласованный префикс
- Согласованность для клиентов, записывающих в один регион для учетной записи с несколькими регионами записи = согласованный префикс
- Согласованность для клиентов, записывающих в разные регионы для учетной записи с несколькими регионами записи = в конечном итоге

  Ограниченное устаревание часто выбирается глобально распределенными приложениями, которые предполагают низкую задержку при записи, но нуждаются в общей гарантии глобального порядка. Ограниченное устаревание подходит для приложений, использующих совместную работу групп и совместного использования, биржевых котировок, публикации-подписки и очереди и т. д. На следующем рисунке показана согласованность ограниченного устаревания с музыкальными примечаниями. После того как данные записываются в регион "Западная часть США 2", регионы "Восточная часть США 2" и "Восточная Австралия" считывают записанное значение на основе заданного максимального времени запаздывания или максимального числа операций:

  :::image type="content" source="media/consistency-levels/bounded-staleness-consistency.gif" alt-text="Иллюстрация уровня согласованности ограниченного устаревания":::

- **Сеанс**. в рамках одного клиентского сеанса операции чтения гарантированно соблюдают согласованные, монотонные операции чтения, монотонные операции записи, записи с возможностью чтения и записи, а затем — чтение. Это предполагает наличие одного сеанса "записи" или совместного использования маркера сеанса для нескольких модулей записи.

Клиенты за пределами сеанса, выполняющего операции записи, увидят следующие гарантии:

- Согласованность для клиентов в одном регионе для учетной записи с единственной областью записи = согласованный префикс
- Согласованность для клиентов в разных регионах для учетной записи с единственной областью записи = согласованный префикс
- Согласованность для клиентов, записывающих в один регион для учетной записи с несколькими регионами записи = согласованный префикс
- Согласованность для клиентов, записывающих в несколько регионов для учетной записи с несколькими регионами записи = в конечном итоге

  Согласованность сеансов — это наиболее широко используемый уровень согласованности как для одного региона, так и для глобально распределенных приложений. Она обеспечивает задержку записи, доступность и пропускную способность чтения, сравнимую с учетом окончательной согласованности, но также предоставляет гарантии согласованности, которые соответствуют потребностям приложений, написанных для работы в контексте пользователя. На следующем рисунке показана согласованность сеанса с музыкальными примечаниями. Модуль записи «Западная часть США 2» и модуль чтения «Западная часть США 2» используют один сеанс (сеанс а), чтобы они одновременно читали одни и те же данные. В то время как регион "Восточная Австралия" использует сеанс б, он получает данные позже, но в том же порядке, что и записи.

  :::image type="content" source="media/consistency-levels/session-consistency.gif" alt-text="Иллюстрация уровня согласованности сеанса":::

- **Последовательный префикс**. возвращаемые обновления содержат некоторые префиксы всех обновлений без пробелов. Согласованность префиксного уровня согласованности гарантирует, что операции чтения никогда не увидят неупорядоченные операции записи.

Если операции записи выполнялись в указанном порядке `A, B, C` , то клиент видит либо, `A` `A,B` либо, `A,B,C` но не все неупорядоченные перестановки, такие как `A,C` или `B,A,C` . Последовательный префикс обеспечивает задержку записи, доступность и пропускную способность чтения, сравнимую с конечной согласованностью, но также предоставляет гарантии порядка, которые соответствуют потребностям сценариев, в которых важен порядок.

Ниже приведены гарантии согласованности для согласованного префикса:

- Согласованность для клиентов в одном регионе для учетной записи с единственной областью записи = согласованный префикс
- Согласованность для клиентов в разных регионах для учетной записи с единственной областью записи = согласованный префикс
- Согласованность для клиентов, записывающих в один регион для учетной записи с несколькими регионами записи = согласованный префикс
- Согласованность для клиентов, записывающих в несколько регионов для учетной записи с несколькими регионами записи = в конечном итоге

На следующем рисунке показана согласованность префикса согласованности с музыкальными примечаниями. Во всех регионах операции чтения никогда не видят неупорядоченные записи:

  :::image type="content" source="media/consistency-levels/consistent-prefix.gif" alt-text="Рисунок с постоянным префиксом":::

- В **конечном итоге**: нет гарантий по упорядочиванию для операций чтения. В отсутствие операций записи в дальнейшем реплики в конечном итоге сходятся.  
Окончательная согласованность — это слабая форма согласованности, так как клиент может считывать более старые значения, чем те, которые были считаны ранее. Окончательная согласованность идеально подходит для того, чтобы приложение не требовало никаких гарантий упорядочения. Примерами могут служить число ретвитов, разметки "нравится" или несвязанные комментарии. На следующем рисунке показана окончательная согласованность с музыкальными примечаниями.

  :::image type="content" source="media/consistency-levels/eventual-consistency.gif" alt-text="Вииллустратион согласованности в конечном итоге":::

## <a name="consistency-guarantees-in-practice"></a>Гарантии согласованности на практике

На практике часто могут возникать более надежные гарантии согласованности. Гарантии согласованности для операции чтения соответствуют актуальности и упорядочению состояния запрашиваемой базы данных. Согласованность чтения связана с упорядочением и распространением операций записи или обновления.  

Если в базе данных нет операций записи, операция чтения с **окончательным** и **согласованным префиксом** уровней согласованности, скорее **всего, приведет** к тому же результату, что и операция чтения со строгим уровнем согласованности.

Если ваша учетная запись Azure Cosmos настроена с уровнем согласованности, отличным от строгой согласованности, можно выяснить вероятность того, что клиенты могут получить надежные и согласованные операции чтения для рабочих нагрузок, просмотрев метрику *Probabilistically ограниченного устаревания* (PBS). Эта метрика предоставляется на портале Azure. Дополнительные сведения см. в разделе [Мониторинг метрики вероятностного ограниченного устаревания (PBS)](how-to-manage-consistency.md#monitor-probabilistically-bounded-staleness-pbs-metric).

Вероятностное ограниченное устаревание показывает степень итоговой согласованности. Эта метрика позволяет понять, насколько часто можно добиться более высокой согласованности, чем уровень согласованности, настроенный в вашей учетной записи Azure Cosmos. Другими словами, вы можете увидеть вероятность (в миллисекундах) выполнения строго согласованных операций чтения для комбинации регионов записи и чтения.

## <a name="consistency-levels-and-latency"></a>Уровни согласованности и время задержки

Задержка чтения для всех уровней согласованности гарантированно никогда не превышает 10 миллисекунд для 99-го процентиля, Средняя задержка чтения, на 50-й процентиль, обычно составляет 4 миллисекунды или меньше.

Задержка записи для всех уровней согласованности всегда гарантирована менее 10 миллисекунд на 99-м процентиль. Среднее время задержки записи (50-й процентиль) обычно не превышает 5 миллисекунд. Учетные записи Azure Cosmos, охватывающие несколько регионов и настраиваемые со строгой согласованностью, являются исключением из этой гарантии.

### <a name="write-latency-and-strong-consistency"></a>Задержка записи и строгая согласованность

Для учетных записей Azure Cosmos, для которых настроена строгая согласованность с несколькими регионами, задержка записи равна двум значениям времени приема-передачи (RTT) между любым из двух самых крайних регионов плюс 10 миллисекунд на 99-м процентиль. Высокая задержка сетевого переключения между регионами перейдет к более высокой задержке для запросов Cosmos DB, так как строгая согласованность завершает операцию только после того, как гарантируется, что она зафиксирована во всех регионах в пределах учетной записи.

Точная задержка RTT определяется расстоянием, которое преодолевает сигнал, двигаясь со скоростью света, и топологией сети Azure. Служба "сеть Azure" не предоставляет соглашения об уровне обслуживания задержки для RTT между любыми двумя регионами Azure, однако она публикует [статистику задержки приема-передачи для сети Azure](../networking/azure-network-latency.md). Задержки репликации учетной записи Azure Cosmos отображаются на портале Azure. Вы можете использовать портал Azure (перейдите в колонку метрики, выберите вкладку согласованность), чтобы отслеживать задержки репликации между различными регионами, связанными с вашей учетной записью Azure Cosmos.

> [!IMPORTANT]
> Строгая согласованность для учетных записей с регионами, охватывающими более 5000 миль (8000 километров), по умолчанию блокируется из-за высокой задержки записи. Чтобы включить эту возможность, обратитесь в службу поддержки.

## <a name="consistency-levels-and-throughput"></a>Уровни согласованности и пропускная способность

- Для строгой и ограниченного устаревания операции чтения выполняются с двумя репликами в наборе из четырех наборов реплик (доли миноритария) для обеспечения гарантии согласованности. Сеанс, последовательный префикс и, в конечном итоге, операции чтения одной реплики. Результат заключается в том, что для одинакового количества единиц запроса пропускная способность чтения для строгой и ограниченной устаревания составляет половину других уровней согласованности.

- Для этого типа операций записи (вставка, замена, обновление или вставка, удаление и т. д.) пропускная способность одинаковая для всех уровней согласованности.

|**Уровень согласованности**|**Операции чтения кворума**|**Записи кворума**|
|--|--|--|
|**Уровень согласованности "Строгая"**|Местная доля|Глобальная часть|
|**Ограниченное устаревание**|Местная доля|Локальный большинство|
|**Session**|Одна реплика (с использованием токена сеанса)|Локальный большинство|
|**Последовательный префикс**|Одна реплика|Локальный большинство|
|**Рано**|Одна реплика|Локальный большинство|

> [!NOTE]
> Стоимость единиц запросов в секунду при чтении для локальных чтений доли составляет вдвое более слабых уровней согласованности, так как операции чтения выполняются из двух реплик для обеспечения гарантии согласованности для строгой и ограниченной устаревания.

## <a name="consistency-levels-and-data-durability"></a><a id="rto"></a>Уровни согласованности и устойчивость данных

В среде глобально распределенной базы данных существует прямая связь между уровнем согласованности и устойчивостью данных при наличии простоя в регионе. При разработке плана обеспечения непрерывности бизнес-процессов нужно понимать, какое максимальное время до полного восстановления приложения после аварийного события допустимо. Время, необходимое для полного восстановления приложения, называется **целевым временем восстановления** (**RTO**). Необходимо также понимать, потерю какого максимального периода последних обновлений данных приложение может допустить при восстановлении после аварийного события. Период времени, в течение которого можно потерять обновления, называется **целевой точкой восстановления** (**RPO**).

В приведенной ниже таблице определяется связь между моделью согласованности и устойчивостью данных при непростом уровне региона. Важно отметить, что в распределенной системе даже при строгой согласованности невозможно иметь распределенную базу данных с RPO и RTO, равными нулю, из-за [ограничения Теорема](https://en.wikipedia.org/wiki/CAP_theorem).

|**Регион (ы)**|**Режим репликации**|**Уровень согласованности**|**RPO**|**RTO**|
|---------|---------|---------|---------|---------|
|1|Один или несколько регионов записи|Любой уровень согласованности|< 240 минут|< 1 неделя|
|>1|Регион с одной записью|Сеанс, постоянный префикс, случайный|< 15 минут|< 15 минут|
|>1|Регион с одной записью|Ограниченное устаревание|*Л*  &  *T*|< 15 минут|
|>1|Регион с одной записью|Уровень согласованности "Строгая"|0|< 15 минут|
|>1|Несколько регионов записи|Сеанс, постоянный префикс, случайный|< 15 минут|0|
|>1|Несколько регионов записи|Ограниченное устаревание|*Л*  &  *T*|0|

*K* = число версий *"K"* (т. е. обновлений) элемента.

*T* = интервал времени *"T"* с момента последнего обновления.

Для учетной записи одного региона минимальное значение *K* и *T* равно 10 операциям записи или 5 секундам. Для учетных записей в нескольких регионах минимальное значение *K* и *T* — 100 000 операций записи или 300 секунд. Определяет минимальное значение RPO для данных при использовании ограниченного устаревания.

## <a name="strong-consistency-and-multiple-write-regions"></a>Строгая согласованность и несколько регионов записи

Для учетных записей Cosmos, настроенных с несколькими регионами записи, нельзя настроить строгую согласованность, так как невозможно предоставить распределенной системе значение RPO, равное нулю, и значение RTO, равное нулю. Кроме того, не существует преимуществ задержки записи при использовании строгой согласованности с несколькими регионами записи, так как запись в любой регион должна быть реплицирована и зафиксирована во всех настроенных регионах в учетной записи. Это приводит к тому же задержкам записи, что и у одной учетной записи региона записи.

## <a name="additional-reading"></a>Дополнительные материалы

Дополнительные сведения об основных понятиях согласованности можно найти в следующих статьях.

- [High-level TLA+ specifications for the five consistency levels offered by Azure Cosmos DB](https://github.com/Azure/azure-cosmos-tla) (Высокоуровневые спецификации TLA+ для пяти уровней согласованности, предлагаемых Azure Cosmos DB)
- [Согласованность реплицируемых данных, объясненная через бейсбольную (видео) Дуг Терри](https://www.youtube.com/watch?v=gluIh8zd26I)
- [Согласованность реплицируемых данных, объясненная через бейсбольный (технический документ) с помощью Дуг Терри](https://www.microsoft.com/research/publication/replicated-data-consistency-explained-through-baseball/)
- [Session guarantees for weakly consistent replicated data](https://dl.acm.org/citation.cfm?id=383631) (Гарантии на уровне сеанса для слабо согласованных реплицированных данных)
- [Consistency Tradeoffs in Modern Distributed Database Systems Design: CAP is only part of the story](https://www.computer.org/csdl/magazine/co/2012/02/mco2012020037/13rRUxjyX7k) (Компромиссы согласованности в современных распределенных системах проектирования баз данных: теорема CAP — это только начало)
- [Probabilistic Bounded Staleness (PBS) for Practical Partial Quorums](https://vldb.org/pvldb/vol5/p776_peterbailis_vldb2012.pdf)
- [Eventually Consistent - Revisited](https://www.allthingsdistributed.com/2008/12/eventually_consistent.html) (Итоговая согласованность. Пересмотрено)

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения об уровнях согласованности в Azure Cosmos DB можно найти в следующих статьях.

- [Настройка уровня согласованности по умолчанию](how-to-manage-consistency.md#configure-the-default-consistency-level)
- [Переопределение уровня согласованности по умолчанию](how-to-manage-consistency.md#override-the-default-consistency-level)
- [Соглашение об уровне обслуживания для Azure Cosmos DB](https://azure.microsoft.com/support/legal/sla/cosmos-db/v1_3/)
