---
title: Хранение ключей Azure Cosmos DB и получение доступа к ним в Key Vault
description: Хранение строк подключения, ключей и конечных точек Azure Cosmos DB, а также получение доступа к ним в Azure Key Vault.
author: markjbrown
ms.author: mjbrown
ms.service: cosmos-db
ms.devlang: dotnet
ms.topic: how-to
ms.date: 05/23/2019
ms.reviewer: sngun
ms.openlocfilehash: a9bea0664f99a21ac734de666c802e9875ff00b5
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "97359332"
---
# <a name="secure-azure-cosmos-keys-using-azure-key-vault"></a>Защита ключей Azure Cosmos с помощью Azure Key Vault 
[!INCLUDE[appliesto-all-apis](includes/appliesto-all-apis.md)]

>[!IMPORTANT]
> Рекомендуемым решением для доступа к Azure Cosmos DB ключам является использование [управляемого системой удостоверения](managed-identity-based-authentication.md). Если служба не может воспользоваться преимуществами управляемых удостоверений, используйте [решение на основе сертификата](certificate-based-authentication.md). Если как управляемое решение идентификации, так и решение на основе сертификата не соответствуют вашим потребностям, используйте решение хранилища ключей, приведенное ниже.

При использовании Azure Cosmos DB для приложений можно получить доступ к базе данных, коллекциям, документам с помощью конечной точки и ключа в файле конфигурации приложения.  Однако неважно, чтобы ключи и URL-адреса направляются непосредственно в код приложения, так как они доступны для всех пользователей в формате открытого текста. Нужно гарантировать доступность конечной точки и ключей через защищенный механизм. Azure Key Vault может помочь в надежном хранении секретов приложения и в управлении ими.

Чтобы сохранить ключи доступа Azure Cosmos DB в Key Vault и читать их оттуда, требуются следующие шаги:

* Создание хранилища ключей  
* добавление ключей доступа Azure Cosmos DB в Key Vault;  
* создание веб-приложения Azure;  
* Регистрация приложения и предоставление ему разрешений на чтение из Key Vault  


## <a name="create-a-key-vault"></a>Создание хранилища ключей

1. Войдите на [портал Azure](https://portal.azure.com/).  
2. Выберите **Создать ресурс > Безопасность > Key Vault**.  
3. В разделе **Создать Key Vault** введите приведенные ниже сведения.  
   * **Имя**. Укажите уникальное имя для Key Vault.  
   * **Подписка**. Выберите подписку, которую нужно использовать.  
   * В разделе **Группа ресурсов** выберите **создать** и введите имя группы ресурсов.  
   * Выберите расположение в раскрывающемся меню "Расположение".  
   * Для других параметров оставьте значения по умолчанию.  
4. Указав приведенные выше сведения, выберите **Создать**.  

## <a name="add-azure-cosmos-db-access-keys-to-the-key-vault"></a>Добавление в Key Vault ключей доступа Azure Cosmos DB
1. Перейдите в хранилище Key Vault, созданное на предыдущем шаге, и откройте вкладку **Секреты**.  
2. Выберите **+ создать/импорт**, 

   * Выберите **вручную** для **параметров отправки**.
   * Укажите **имя** для секрета.
   * Укажите строку подключения вашей учетной записи Cosmos DB в поле **Значение**. Затем нажмите **Создать**.

   :::image type="content" source="./media/access-secrets-from-keyvault/create-a-secret.png" alt-text="Создание секрета":::

4. После того как секрет будет создан, откройте его и скопируйте **идентификатор секрета в следующем формате. Этот идентификатор понадобится вам в следующем разделе. 

   `https://<Key_Vault_Name>.vault.azure.net/secrets/<Secret _Name>/<ID>`

## <a name="create-an-azure-web-application"></a>создание веб-приложения Azure;

1. Создайте веб-приложение Azure или загрузите его из [репозитория GitHub](https://github.com/Azure/azure-cosmos-dotnet-v2/tree/master/Demo/keyvaultdemo). Это простое приложение MVC.  

2. Распакуйте загруженное приложение и откройте файл **HomeController.cs**. Обновите идентификатор секрета в следующей строке:

   `var secret = await keyVaultClient.GetSecretAsync("<Your Key Vault’s secret identifier>")`

3. **Сохраните** файл и выполните **сборку** решения.  
4. Затем разверните приложение в Azure. Щелкните проект правой кнопкой мыши и выберите **Опубликовать**. Создайте новый профиль службы приложения (вы можете назвать приложение WebAppKeyVault1) и выберите **Опубликовать**.   

5. После этого приложение будет развернуто. На портале Azure перейдите к развернутому веб-приложению и включите **управляемое удостоверение службы** этого приложения.  

   :::image type="content" source="./media/access-secrets-from-keyvault/turn-on-managed-service-identity.png" alt-text="Управляемое удостоверение службы":::

Если вы запустите приложение сейчас, отобразится следующая ошибка. Она возникает, потому что вы не предоставили этому приложению прав на использование Key Vault.

:::image type="content" source="./media/access-secrets-from-keyvault/app-deployed-without-access.png" alt-text="Приложение развернуто без доступа":::

## <a name="register-the-application--grant-permissions-to-read-the-key-vault"></a>Регистрация приложения и предоставление ему разрешений на чтение из Key Vault

В этом разделе вы регистрируете приложение в Azure Active Directory и предоставляете ему разрешения на чтение из Key Vault. 

1. Перейдите на портал Azure и откройте **Key Vault**, созданное в предыдущем разделе.  

2. Откройте **политики доступа**, выберите **+ Добавить**, найдите развернутое веб-приложение, выберите разрешения и нажмите кнопку **ОК**.  

   :::image type="content" source="./media/access-secrets-from-keyvault/add-access-policy.png" alt-text="Добавление политики доступа":::

Теперь, запустив приложение, вы сможете прочитать секрет из Key Vault.

:::image type="content" source="./media/access-secrets-from-keyvault/app-deployed-with-access.png" alt-text="Развернутое приложение, в котором отображается секрет":::
 
Аналогичным образом вы можете предоставить пользователю доступ к Key Vault. Вам нужно добавить себя в Key Vault. Для этого выберите **Политики доступа**, а затем предоставьте все необходимые разрешения для запуска приложения из Visual Studio. Если это приложение запускается с вашего рабочего стола, оно использует ваш идентификатор.

## <a name="next-steps"></a>Дальнейшие действия

* Сведения о настройке брандмауэра для Azure Cosmos DB см. в статье [Поддержка брандмауэра](how-to-configure-firewall.md) .
* Чтобы настроить конечную точку службы для виртуальной сети, перейдите к статье [Безопасный доступ к учетной записи Azure Cosmos DB с использованием конечной точки службы для виртуальной сети Azure](how-to-configure-vnet-service-endpoint.md).
