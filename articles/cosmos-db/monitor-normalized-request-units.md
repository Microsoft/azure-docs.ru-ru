---
title: Мониторинг нормализованных единиц запросов/с для контейнера Azure Cosmos или учетной записи
description: Узнайте, как отслеживать нормализованное использование единиц запросов для операции в Azure Cosmos DB. Владельцы учетной записи Azure Cosmos DB могут понять, какие операции потребляют больше единиц запросов.
ms.service: cosmos-db
ms.topic: how-to
author: kanshiG
ms.author: govindk
ms.date: 01/07/2021
ms.openlocfilehash: ec82532b54e7834b62fcc03d3ee7de1345a0f546
ms.sourcegitcommit: e46f9981626751f129926a2dae327a729228216e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "98027814"
---
# <a name="how-to-monitor-normalized-rus-for-an-azure-cosmos-container-or-an-account"></a>Мониторинг нормализованных единиц запросов в секунду для контейнера Azure Cosmos или учетной записи
[!INCLUDE[appliesto-all-apis](includes/appliesto-all-apis.md)]

Azure Monitor для Azure Cosmos DB предоставляет представление метрик для мониторинга учетной записи и создания панелей мониторинга. Метрики по Azure Cosmos DB собираются по умолчанию, для этого компонента не требуется явно включать или настраивать что-либо.

**Нормализованная метрика потребления единиц** измерения используется для того, чтобы увидеть степень насыщенности диапазонов ключей секций относительно трафика. Azure Cosmos DB равномерно распределяет пропускную способность по всем диапазонам ключей секций. Эта метрика обеспечивает в секунду представление максимального использования пропускной способности для диапазона ключей секций. Используйте эту метрику для вычисления использования единиц запросов/s в диапазоне ключей секций для заданного контейнера. Используя эту метрику, если вы видите высокий процент использования единиц запросов для всех диапазонов ключей разделов в Azure Monitor, необходимо увеличить пропускную способность в соответствии с потребностями рабочей нагрузки. Пример. нормализованное использование определяется как максимальное значение использования единиц запросов/s во всех диапазонах ключей разделов. Например, предположим, что максимальная пропускная способность составляет 20 000 единиц запросов в секунду и имеется два диапазона ключей разделов: P_1 и P_2, каждый из которых поддерживает масштабирование до 10 000 единиц запросов в секунду. Если за определенную секунду P_1 использовал 6000 ЕЗ/с, а P_2 — 8000 ЕЗ/с, то нормализованная нагрузка составляет MAX (6000 ЕЗ / 10 000 ЕЗ, 8000 ЕЗ / 10 000 ЕЗ) = 0,8.

## <a name="what-to-expect-and-do-when-normalized-rus-is-higher"></a>Что делать, если нормализованные единицы запросов в секунду больше

Когда нормализованное потребление единиц запросов в секунду достигает 100% для заданного диапазона ключей секции, и если клиент по-прежнему выполняет запросы в этом временном интервале, равном 1 секунде, с определенным диапазоном ключей секций, он получает ошибку с ограничением скорости. Клиент должен учитывать предлагаемое время ожидания и повторить запрос. Пакет SDK упрощает обработку этой ситуации, повторяя предварительно настроенные времена, ожидая соответствующим образом.  Не обязательно видеть ошибку ограничения частоты единиц запросов, так как нормализованное количество достигло 100%. Это обусловлено тем, что нормализованный RU представляет собой одно значение, представляющее максимальное использование для всех диапазонов ключей секций, один диапазон ключей секции может быть занят, но другие диапазоны ключей секций могут обрабатывать запросы без проблем. Например, одна операция, например хранимая процедура, использующая все единицы запроса в диапазоне ключей секций, приведет к короткому пик в нормализованном потреблении единиц запросов/с. В таких случаях ошибки немедленного ограничения частоты не будут отображаться, если частота запросов мала или запросы выполняются к другим секциям в разных диапазонах ключей секций. 

Метрики Azure Monitor помогают найти операции на код состояния для API SQL с помощью метрики " **всего запросов** ". Позже можно будет отфильтровать эти запросы по коду состояния 429 и разделить их по **типу операции**.  

Чтобы найти запросы, которые имеют ограниченный объем, рекомендуется получить эти сведения с помощью журналов диагностики.

Если существует непрерывная Пиковая нагрузка на 100%, или близкое к 100% по нескольким диапазонам ключей разделов, рекомендуется увеличить пропускную способность. Вы можете узнать, какие операции имеют большое значение, и их пиковое использование, используя метрики Azure Monitor и журналы диагностики Azure Monitor.

В целом, **нормализованная метрика потребления единиц** измерения используется для того, чтобы узнать, какой диапазон ключей секции более тепло в плане использования. Это позволяет отклонять пропускную способность в диапазоне ключей секций. Позже вы сможете просмотреть журнал **партитионкэйруконсумптион** в журналах Azure Monitor, чтобы получить сведения о том, какие ключи логических секций являются горячими в условиях использования. Это будет указывать на изменение ключа секции или изменение логики приложения. Чтобы устранить ограничение скорости, Распределите нагрузку на несколько секций или просто увеличьте пропускную способность по мере необходимости. 

## <a name="view-the-normalized-request-unit-consumption-metric"></a>Просмотр нормализованной метрики потребления единиц запросов

1. Войдите на [портал Azure](https://portal.azure.com/).

2. На панели навигации слева выберите пункт **Монитор**, а затем выберите **Метрики**.

   :::image type="content" source="./media/monitor-normalized-request-units/monitor-metrics-blade.png" alt-text="Область метрик в Azure Monitor":::

3. В области **Метрики** щелкните **Выбрать ресурс** и выберите требуемые **подписку** и **группу ресурсов**. В поле **Тип ресурса** выберите **Учетные записи Azure Cosmos DB**, выберите одну из существующих учетных записей Azure Cosmos и нажмите кнопку **Применить**.

   :::image type="content" source="./media/monitor-normalized-request-units/select-cosmos-db-account.png" alt-text="Выберите учетную запись Azure Cosmos для просмотра метрик":::

4. Далее можно выбрать метрику из списка доступных метрик. Вы можете выбрать метрики, связанные с единицами запросов, хранилищем, задержкой, доступностью, Cassandra и т. д. Подробные сведения о всех доступных метриках в списке см. в статье с [перечнем метрик по категориям](monitor-cosmos-db-reference.md). В этом примере мы выбираем **нормализованную метрику потребления единиц запросов** и **максимум** в качестве значения статистической обработки.

   Помимо этих сведений, можно также выбрать **диапазон времени** и **степень детализации времени** для метрик. Вы можете просмотреть метрики максимум за последние 30 дней.  После применения фильтра отображается диаграмма на его основе.

   :::image type="content" source="./media/monitor-normalized-request-units/normalized-request-unit-usage-metric.png" alt-text="Выбор метрики на портале Azure":::

### <a name="filters-for-normalized-request-unit-consumption"></a>Фильтры для нормализованного потребления единиц запросов

Можно также фильтровать метрики и диаграмму, отображаемую конкретными **CollectionName**, **DatabaseName**, **партитионкэйранжеид** и **регионом**. Чтобы отфильтровать метрики, щелкните **Добавить фильтр** и выберите требуемое свойство, например **CollectionName** , и соответствующее значение, которое вас интересует. Затем на диаграмме отображаются нормализованные единицы потребления единиц запросов, потребляемые для контейнера за выбранный период.  

Метрики можно группировать с помощью параметра **Применить разделение**. Для баз данных с общей пропускной способностью нормализованная метрика единиц запросов показывает данные только по степени гранулярности базы данных, но не отображает данные в каждой коллекции. Итак, для базы данных с общей пропускной способностью вы не видите никаких данных при применении разделения по имени коллекции.

Нормализованная метрика потребления единиц запросов для каждого контейнера отображается, как показано на следующем рисунке:

:::image type="content" source="./media/monitor-normalized-request-units/normalized-request-unit-usage-filters.png" alt-text="Применение фильтров к нормализованной метрике потребления единиц запросов":::

## <a name="next-steps"></a>Дальнейшие действия

* Отслеживайте Azure Cosmos DB данные с помощью [параметров диагностики](cosmosdb-monitor-resource-logs.md) в Azure.
* [Аудит операций Azure Cosmos DB плоскости управления](audit-control-plane-logs.md)
