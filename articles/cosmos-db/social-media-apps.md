---
title: 'Azure Cosmos DB шаблон проектирования: приложения социальных сетей'
description: Узнайте о конструктивном шаблоне для социальных сетей, используя гибкие возможности хранения данных Azure Cosmos DB и другие службы Azure.
author: ealsur
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 05/28/2019
ms.author: maquaran
ms.openlocfilehash: 329c4b40f11b36de80581d4a1396813bc8de5c73
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "96010322"
---
# <a name="going-social-with-azure-cosmos-db"></a>Использование социальных сетей с помощью Azure Cosmos DB
[!INCLUDE[appliesto-all-apis](includes/appliesto-all-apis.md)]

Жизнь в сильно взаимосвязанном обществе означает, что в определенный момент вы присоединяетесь к **социальной сети**. Вы используете социальные сети, чтобы поддерживать связь с друзьями, коллегами и родными, а иногда — чтобы делиться увлечением с теми, кто разделяет ваши интересы.

Как инженер или разработчик, вы могли интересоваться, как эти сети хранят и соединяют ваши данные между собой. Вам также могли поручить создание или проектирование новой социальной сети для специализированного рынка. Именно тогда возникает важный вопрос: как хранятся все эти данные?

Предположим, что вы создаете новую яркую социальную сеть, где ваши пользователи могут публиковать статьи с сопутствующими материалами, например изображениями, видео или даже музыкой. Пользователи могут комментировать записи и оценивать их с помощью очков. В сети будет веб-канал записей, которые будут видны пользователям. Кроме того, пользователи смогут взаимодействовать с целевой страницей основного веб-сайта. Поначалу этот способ может показаться несложным, предлагаем на этом остановиться, чтобы не усложнять его. (Вы можете подробнее изучить настраиваемые каналы пользователей, но это не относится к теме данной статьи.)

Итак, как и где хранить все эти данные?

Возможно, у вас есть опыт работы с базами данных SQL или представление о [реляционном моделировании данных](https://en.wikipedia.org/wiki/Relational_model). Вы можете начать рисовать нечто подобное:

:::image type="content" source="./media/social-media-apps/social-media-apps-sql.png" alt-text="Схема, иллюстрирующая относительную реляционную модель" border="false":::

Идеально нормализованная и аккуратная структура данных, которая не масштабируется.

Поймите меня правильно, я всю жизнь работаю с базами данных SQL. Они полезны, но как и все остальные шаблоны, практики и программные платформы, они подходят не для каждого сценария.

Почему SQL — не наилучший вариант для этого сценария? Рассмотрим структуру одной записи. Если мне нужно показать запись на веб-сайте или в приложении, потребуется отправить запрос, объединив восемь таблиц (!) только для того, чтобы показать одну запись. Теперь представьте поток записей, которые динамически загружаются и отображаются на экране, и вы поймете, о чем я.

Вы могли бы использовать огромный экземпляр SQL с вычислительной мощностью, достаточной для обработки тысяч запросов с большим количеством соединений, чтобы обслуживать ваше содержимое. Но зачем это делать, если есть более простое решение?

## <a name="the-nosql-road"></a>Путь NoSQL

В этой статье представлены инструкции по экономичному моделированию данных социальной платформы с помощью базы данных NoSQL [Azure Cosmos DB](https://azure.microsoft.com/services/cosmos-db/). В ней также описывается использование других функций Azure Cosmos DB, например [API Gremlin](../cosmos-db/graph-introduction.md). Используя [NoSQL](https://en.wikipedia.org/wiki/NoSQL), храня данные в формате JSON и применяя [денормализацию](https://en.wikipedia.org/wiki/Denormalization), запись, которая ранее представлялась сложной, можно преобразовать в один [документ](https://en.wikipedia.org/wiki/Document-oriented_database).

```json
{
    "id":"ew12-res2-234e-544f",
    "title":"post title",
    "date":"2016-01-01",
    "body":"this is an awesome post stored on NoSQL",
    "createdBy":User,
    "images":["https://myfirstimage.png","https://mysecondimage.png"],
    "videos":[
        {"url":"https://myfirstvideo.mp4", "title":"The first video"},
        {"url":"https://mysecondvideo.mp4", "title":"The second video"}
    ],
    "audios":[
        {"url":"https://myfirstaudio.mp3", "title":"The first audio"},
        {"url":"https://mysecondaudio.mp3", "title":"The second audio"}
    ]
}
```

И его можно получить с помощью одного запроса без каких-либо операций соединения. Эти запросы выполняются намного проще, эффективнее и экономнее, и для достижения наилучшего результата требуется меньше ресурсов.

Azure Cosmos DB обеспечивает индексирование всех свойств с помощью автоматического индексирования. Автоматическое индексирование даже можно [настраивать](index-policy.md). Подход без схемы позволяет хранить документы с различными динамическими структурами. Возможно, завтра вам потребуется, чтобы с записями были связаны списки категорий или хэштегов? Cosmos DB будет обрабатывать новые документы с добавленными атрибутами, а от нас не потребуется дополнительных усилий.

Комментарии к записи можно считать такими же записями, но со свойством родительской записи. (Такой подход упрощает сопоставление объектов.)

```json
{
    "id":"1234-asd3-54ts-199a",
    "title":"Awesome post!",
    "date":"2016-01-02",
    "createdBy":User2,
    "parent":"ew12-res2-234e-544f"
}

{
    "id":"asd2-fee4-23gc-jh67",
    "title":"Ditto!",
    "date":"2016-01-03",
    "createdBy":User3,
    "parent":"ew12-res2-234e-544f"
}
```

И все взаимодействия в социальной сети могут храниться в отдельном объекте как счетчики.

```json
{
    "id":"dfe3-thf5-232s-dse4",
    "post":"ew12-res2-234e-544f",
    "comments":2,
    "likes":10,
    "points":200
}
```

Создание веб-каналов — это просто создание документов, которые могут содержать список идентификаторов записей в указанном ниже порядке релевантности.

```json
[
    {"relevance":9, "post":"ew12-res2-234e-544f"},
    {"relevance":8, "post":"fer7-mnb6-fgh9-2344"},
    {"relevance":7, "post":"w34r-qeg6-ref6-8565"}
]
```

Можно создать поток новейших записей, отсортированных по дате создания, или поток самых популярных записей, которые понравились наибольшему количеству пользователей за последние 24 часа. Вы даже можете реализовать специальный поток для каждого пользователя по таким критериям, как подписчики и интересы. Это по-прежнему будет список записей. Важно то, как создаются эти списки, а производительность чтения остается неизменной. После получения одного из этих списков вы создаете один запрос для Cosmos DB помощью [ключевого слова in](sql-query-keywords.md#in) для получения страниц записей за раз.

Потоки веб-канала можно создать с использованием фоновых процессов [служб приложений Azure](https://azure.microsoft.com/services/app-service/) — [веб-заданий](../app-service/webjobs-create.md). После создания записи фоновую обработку можно активировать с помощью [очередей](https://azure.microsoft.com/services/storage/) [службы хранилища Azure](../storage/queues/storage-dotnet-how-to-use-queues.md), а веб-задания можно активировать с помощью [пакета SDK Azure веб-заданий](https://github.com/Azure/azure-webjobs-sdk/wiki), реализовав распространение записей в потоках на основе собственной настраиваемой логики.

Очки и отметки "Нравится" записи могут обрабатываться с отсрочкой, этот же подход применяется для создания согласованной среды.

С читателями все сложнее. В Cosmos DB действует ограничение размера документа, а операции чтения или записи с большими документами могут повлиять на масштабируемость приложения. Поэтому можно рассмотреть хранение читателей в документе со следующей структурой.

```json
{
    "id":"234d-sd23-rrf2-552d",
    "followersOf": "dse4-qwe2-ert4-aad2",
    "followers":[
        "ewr5-232d-tyrg-iuo2",
        "qejh-2345-sdf1-ytg5",
        //...
        "uie0-4tyg-3456-rwjh"
    ]
}
```

Эта структура может подойти пользователю с несколькими тысячами подписчиков. Однако если к вам присоединится какая-либо знаменитость, то при данном подходе размер документа увеличится, а вы все равно натолкнетесь на ограничение размера.

Чтобы решить эту проблему, можно применить смешанный подход. В документе статистики пользователей вы можете хранить количество читателей.

```json
{
    "id":"234d-sd23-rrf2-552d",
    "user": "dse4-qwe2-ert4-aad2",
    "followers":55230,
    "totalPosts":452,
    "totalPoints":11342
}
```

Вы можете хранить фактический граф подписчиков с помощью [API Gremlin](../cosmos-db/graph-introduction.md) базы данных Azure Cosmos DB. При этом создаются [вершины](http://mathworld.wolfram.com/GraphVertex.html) для каждого пользователя и [грани](http://mathworld.wolfram.com/GraphEdge.html), поддерживающие отношения "А подписан на Б". С помощью API Gremlin вы можете не только получать подписчиков конкретного пользователя, но и создавать более сложные запросы, предлагающие пользователей с некоторыми общими характеристиками. Если добавить в граф категории содержимого, которые нравятся пользователям, вы сможете добавить возможности связывания, включая интеллектуальное обнаружение содержимого, предложение содержимого, интересующего пользователей, на которых вы подписаны, или поиск людей, с которыми у вас могут быть общие интересы.

С помощью документа "Статистика пользователей" также можно создавать карточки в пользовательском интерфейсе или просматривать краткие профили.

## <a name="the-ladder-pattern-and-data-duplication"></a>Дублирование данных и шаблон "Лестница"

Как вы могли заметить, в документе JSON, на который ссылается запись, имеется множество вхождений данных пользователя. Как вы уже догадались, это означает, что данные, описывающие пользователя (с учетом денормализации), могут находиться в нескольких местах.

Чтобы ускорить обработку запросов, вы применяете дублирование данных. Побочный эффект состоит в том, что если какое-либо действие меняет данные пользователя, вам нужно найти все действия, которые он когда-либо выполнил, и обновить их. Звучит не слишком практично, верно?

Вы решите эту проблему, определив ключевые атрибуты пользователя, которые отображаются в вашем приложении для каждого действия. Если вы показываете запись в приложении только с именем и изображением автора, зачем хранить в атрибуте createdBy все данные пользователя? Если для каждого комментария вы показываете только изображение пользователя, остальные его данные не нужны. Вот когда нам пригодится так называемый шаблон "Лестница".

Для примера рассмотрим информацию о пользователе.

```json
{
    "id":"dse4-qwe2-ert4-aad2",
    "name":"John",
    "surname":"Doe",
    "address":"742 Evergreen Terrace",
    "birthday":"1983-05-07",
    "email":"john@doe.com",
    "twitterHandle":"\@john",
    "username":"johndoe",
    "password":"some_encrypted_phrase",
    "totalPoints":100,
    "totalPosts":24
}
```

Посмотрев на эту информацию, вы можете быстро определить, какая информация важна, а какая — нет, тем самым строя "Лестницу".

:::image type="content" source="./media/social-media-apps/social-media-apps-ladder.png" alt-text="Схема шаблона &quot;Лестница&quot;" border="false":::

Наименьший объект называется блоком пользователя, это минимальный объем информации, идентифицирующий пользователя и используемый для дублирования данных. Уменьшая размер дублируемых данных только до "видимой" информации, вы снизите вероятность масштабных обновлений.

Средний объект называется пользователем. Это полные данные, которые будут использоваться в большинстве зависящих от производительности запросов в Cosmos DB. Это наиболее используемые и важные данные. Пользователь содержит информацию, представленную в блоке пользователя.

Самый большой объект — расширенный пользователь. Он включает критически важные сведения о пользователях и другие данные, которые не требуется быстро считывать или которые применяются время от времени, например для входа. Эти данные могут храниться за пределами Cosmos DB, в базе данных SQL Azure или таблицах хранилища Azure.

Зачем разделять данные пользователя и хранить эту информацию в разных местах? Это необходимо, поскольку с точки зрения производительности, чем больше документы, тем дороже обходятся запросы. Оставляйте документы небольшими, сохраняя только необходимую информацию для всех зависящих от производительности запросов в вашей социальной сети. Сохраняйте дополнительные сведения для редко используемых сценариев, например полного редактирования профиля, входа и интеллектуального анализа данных для аналитики использования и инициатив с большими данными. Для вас не имеет значения, что данные для интеллектуального анализа собираются медленнее, так как это происходит в Базе данных SQL Azure. Однако для вас важны скорость и удобство работы пользователей. Данные пользователя, хранящиеся в Cosmos DB, будут выглядеть примерно так:

```json
{
    "id":"dse4-qwe2-ert4-aad2",
    "name":"John",
    "surname":"Doe",
    "username":"johndoe"
    "email":"john@doe.com",
    "twitterHandle":"\@john"
}
```

И запрос POST будет выглядеть следующим образом.

```json
{
    "id":"1234-asd3-54ts-199a",
    "title":"Awesome post!",
    "date":"2016-01-02",
    "createdBy":{
        "id":"dse4-qwe2-ert4-aad2",
        "username":"johndoe"
    }
}
```

При редактировании, влияющем на атрибут блока, вы можете легко найти соответствующие документы. Просто используйте запросы, указывающие на индексированные атрибуты, например `SELECT * FROM posts p WHERE p.createdBy.id == "edited_user_id"`, а затем обновите блоки.

## <a name="the-search-box"></a>Поле поиска

К счастью, пользователи будут формировать много содержимого. И вы должны дать возможность искать и находить содержимое, которое может отсутствовать непосредственно в их потоках содержимого, возможно потому, что они не подписались на их авторов или просто пытаются найти старую запись, созданную шесть месяцев назад.

Поскольку вы используете Azure Cosmos DB, вы можете легко реализовать поисковую систему с помощью [когнитивный Поиск Azure](https://azure.microsoft.com/services/search/) за несколько минут без ввода кода, кроме процесса поиска и пользовательского интерфейса.

Почему этот процесс так прост?

Azure Когнитивный поиск реализует то, что они вызывают [индексаторы](/rest/api/searchservice/Indexer-operations), фоновые процессы, которые присоединяются к репозиториям данных и автоматически добавляют, обновляют или удаляют объекты в индексах. Они поддерживают [индексаторы базы данных SQL Azure](/archive/blogs/kaevans/indexing-azure-sql-database-with-azure-search), [индексаторы больших двоичных объектов Azure](../search/search-howto-indexing-azure-blob-storage.md) и, к счастью, [индексаторы Azure Cosmos DB](../search/search-howto-index-cosmosdb.md). Переход от Cosmos DB в Azure Когнитивный поиск прост. Обе технологии хранят данные в формате JSON, поэтому вам достаточно [создать индекс](../search/search-what-is-an-index.md) и сопоставить индексируемые атрибуты документов. Вот и все! В зависимости от размера данных, все содержимое станет доступно для поиска в течение нескольких минут благодаря лучшему решению "поиск как служба" в облачной инфраструктуре.

Дополнительные сведения об Azure Когнитивный поиск см. в разделе [путеводитель Guide (Поиск](/archive/blogs/mvpawardprogram/a-hitchhikers-guide-to-search)).

## <a name="the-underlying-knowledge"></a>Базовый набор знаний

Храня все это содержимое, которое ежедневно увеличивается, вы можете задуматься: что делать с потоком информации, поступающей от моих пользователей?

Ответ прост: включить его в работу и учиться.

Но как вы можете учиться? Из простых примеров можно привести [анализ тональности](https://en.wikipedia.org/wiki/Sentiment_analysis), т. е. рекомендации содержимого на основе предпочтений пользователя, или даже автоматический модератор содержимого, который гарантирует, что все содержимое, публикуемое в вашей социальной сети, безопасно для семьи.

Теперь, когда я заинтересовал вас, скорее всего вы думаете, что нужна кандидатская степень по математике, чтобы извлечь эти шаблоны и информацию из простых баз данных и файлов, но это не так.

[Машинное обучение Azure](https://azure.microsoft.com/services/machine-learning/), часть [Cortana Intelligence Suite](https://social.technet.microsoft.com/wiki/contents/articles/36688.introduction-to-cortana-intelligence-suite.aspx)— это полностью управляемая облачная служба, которая позволяет создавать рабочие процессы с помощью алгоритмов в простом интерфейсе перетаскивания, кодировать собственные алгоритмы в [R](https://en.wikipedia.org/wiki/R_\(programming_language\))или использовать некоторые уже созданные и готовые к использованию API-интерфейсы, такие как: [анализ текста](https://gallery.cortanaanalytics.com/MachineLearningAPI/Text-Analytics-2), Content Moderator или [рекомендации](https://gallery.azure.ai/Solution/Recommendations-Solution).

Чтобы реализовать любой из этих сценариев машинного обучения, вы можете использовать [Azure Data Lake](https://azure.microsoft.com/services/data-lake-store/) для приема информации из различных источников. Вы также можете использовать [U-SQL](https://azure.microsoft.com/documentation/videos/data-lake-u-sql-query-execution/) для обработки информации и создания выходных данных, которые может обрабатывать Машинное обучение Azure.

Еще один доступный вариант анализа содержимого ваших пользователей — использование [Azure Cognitive Services](https://www.microsoft.com/cognitive-services). Вы можете не только лучше понять их (анализируя с помощью [API анализа текста](https://www.microsoft.com/cognitive-services/en-us/text-analytics-api), что они пишут), но и обнаружить нежелательное содержимое или материалы для взрослых и действовать соответствующим образом, используя [API компьютерного зрения](https://www.microsoft.com/cognitive-services/en-us/computer-vision-api). Службы Cognitive Services включают в себя много готовых решений, для использования которых не требуется никаких знаний машинного обучения.

## <a name="a-planet-scale-social-experience"></a>Глобально масштабируемое социальное взаимодействие

Последняя, но совсем не маловажная тема, которую необходимо рассмотреть, — **масштабируемость**. При проектировании архитектуры каждый компонент должен масштабироваться отдельно. Со временем вам понадобится обрабатывать больше данных или потребуется более широкий географический охват. К счастью, решение обеих этих задач **уже заложено** в Cosmos DB.

Служба Cosmos DB изначально поддерживает динамическое секционирование. Она автоматически создает секции в соответствии с определенным **ключом секции**, заданным в качестве атрибута документов. Определять правильный ключ секции необходимо во время разработки. Дополнительные сведения см. в статье [Общие сведения о секционировании в Azure Cosmos DB](partitioning-overview.md).

Для социального взаимодействия необходимо согласовать стратегию секционирования со способом отправки запросов и записи. (Например, операции чтения в одной секции предпочтительны и Избегайте «горячих точек» путем распространения операций записи на несколько секций). Некоторые параметры: секции, основанные на временном ключе (день/месяц/неделя), по категории содержимого, по географическому региону или по пользователю. На самом деле все зависит от того, как вы будете запрашивать данные и отображать их при социальном взаимодействии.

Cosmos DB будет открыто выполнять ваши запросы (включая [статистические выражения](https://azure.microsoft.com/blog/planet-scale-aggregates-with-azure-documentdb/)) по всем секциям, и вам не придется добавлять никакой логики по мере роста объема данных.

Со временем у вас увеличатся трафик и потребление ресурсов (измеряемое в единицах запроса, [ЕЗ](request-units.md)). По мере роста пользовательской базы чтение и запись будут выполняться все чаще. Пользовательская база начнет создавать и считывать больше содержимого. Поэтому возможность **масштабирования пропускной способности** крайне важна. Увеличить количество единиц запросов легко. Это можно сделать, нажав несколько кнопок на портале Azure или [выполнив команды через интерфейс API](/rest/api/cosmos-db/replace-an-offer).

:::image type="content" source="./media/social-media-apps/social-media-apps-scaling.png" alt-text="Увеличение масштаба и определение ключа секции":::

Что произойдет, если ваше решение продолжит набирать популярность? Допустим, пользователи из другого региона, страны или континента, узнают о вашей платформе и начинают использовать ее. Какой приятный сюрприз!

Но подождите! Скоро вы поймете, что им неудобно работать с вашей платформой. Они находятся так далеко от вашего рабочего региона, что возникает огромная задержка. Естественно, вы не хотите, чтобы они покидали вашу платформу. Было бы очень удобно иметь возможность **охватить весь мир**. И такая возможность есть!

Cosmos DB позволяет [реплицировать данные глобально](../cosmos-db/tutorial-global-distribution-sql-api.md) и прозрачно всего парой щелчков мышью, а также автоматически выбирать из [клиентского кода](../cosmos-db/tutorial-global-distribution-sql-api.md) доступные регионы. Это также означает, что у вас может быть [несколько регионов отработки отказа](high-availability.md).

При глобальной репликации данных необходимо убедиться, что ваши клиенты могут этим воспользоваться. Если вы используете веб-интерфейс или получаете доступ к API с мобильных клиентов, то вы можете развернуть [диспетчер трафика Azure](https://azure.microsoft.com/services/traffic-manager/) и клонировать свою службу приложений Azure во всех необходимых регионах, используя конфигурацию производительности для поддержки расширенного глобального покрытия. При обращении ваших клиентов к интерфейсу или API они будут направляться в ближайшую службу приложений, которая, в свою очередь, будет подключаться к локальной реплике Cosmos DB.

:::image type="content" source="./media/social-media-apps/social-media-apps-global-replicate.png" alt-text="Добавление глобального покрытия в социальную платформу" border="false":::

## <a name="conclusion"></a>Заключение

В этой статье описываются некоторые альтернативы созданию социальных сетей исключительно в Azure с использованием недорогих служб. Она приносит результаты, способствуя использованию многоуровневого решения для хранения и распространения данных под названием "Лестница".

:::image type="content" source="./media/social-media-apps/social-media-apps-azure-solution.png" alt-text="Схема взаимодействия между службами Azure для социальных сетей" border="false":::

Дело в том, что универсального решения для таких сценариев не существует. Это взаимосвязь, созданная сочетанием замечательных служб, которые позволяют нам создавать большие впечатления: скорость и свобода Azure Cosmos DB для предоставления отличного социальных приложений, аналитических средств для поиска в первую очередь, таких как Azure Когнитивный поиск, гибкость служб приложений Azure для размещения даже независимых от языка приложений, но мощных фоновых процессов и расширяемой службы хранилища Azure и базы данных SQL Azure для хранения огромных объемов данных и аналитической мощности компьютера Azure. Обучение созданию знаний и аналитических данных, которые могут обеспечить отзыв о ваших процессах и помочь нам обеспечить правильное содержимое нужным пользователям.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о вариантах использования Cosmos DB см. в [этой статье](use-cases.md).