---
title: Что такое Azure Cosmos DB аналитическое хранилище?
description: Общие сведения о Azure Cosmos DB транзакционных (основанных на строках) и аналитических (основанных на столбцах) хранилищах. Преимущества аналитического хранилища, влияние на производительность для крупномасштабных рабочих нагрузок и автоматическая синхронизация данных из хранилища транзакций в аналитическое хранилище
author: Rodrigossz
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 03/16/2021
ms.author: rosouz
ms.custom: seo-nov-2020
ms.openlocfilehash: bca4eb7f5f266a639916c0f8e520f025d259c39b
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "104577365"
---
# <a name="what-is-azure-cosmos-db-analytical-store"></a>Что такое Azure Cosmos DB аналитическое хранилище?
[!INCLUDE[appliesto-sql-mongodb-api](includes/appliesto-sql-mongodb-api.md)]

Azure Cosmos DB Analytics Store — это полностью изолированное хранилище столбцов, позволяющее выполнять крупномасштабную аналитику с операционными данными в Azure Cosmos DB без каких-либо последствий с транзакционными рабочими нагрузками. 

Хранилище транзакций Azure Cosmos DB не зависит от схемы и позволяет выполнять итерации по транзакционным приложениям без необходимости управлять схемой или индексами. В отличие от этого, аналитическое хранилище Azure Cosmos DB разработано с целью оптимизации производительности аналитических запросов. В этой статье подробно описывается аналитическое хранилище.

## <a name="challenges-with-large-scale-analytics-on-operational-data"></a>Сложности крупномасштабного анализа операционных данных

Многомодельные операционные данные в контейнере Azure Cosmos DB хранятся в индексированном транзакционном хранилище на основе строк. Формат хранилища строк предназначен для ускорения операций чтения и записи транзакций при миллисекундном времени для ответа и оперативных запросов. Если размер набора данных растет, сложные аналитические запросы могут быть дорогостоящими с точки зрения подготовленной пропускной способности для данных, хранящихся в этом формате. Высокий уровень потребления подготовленной пропускной способности, в свою очередь, влияет на производительность транзакционных рабочих нагрузок, используемых приложениями и службами в реальном времени.

Обычно для анализа больших объемов данных операционные данные извлекаются из хранилища транзакций Azure Cosmos DB и хранятся на отдельном уровне данных. Например, данные хранятся в хранилище данных или озере данных в подходящем формате. Эти данные позже используются для крупномасштабной аналитики и анализируются с помощью подсистемы вычислений, например кластеров Apache Spark. Такое разделение аналитического и вычислительного уровней для операционных данных приводит к дополнительной задержке, так как конвейеры ETL (извлечение, преобразование, загрузка) выполняются реже, чтобы сократить влияние на транзакционные рабочие нагрузки.

Конвейеры ETL также усложняются при обработке обновлений операционных данных по сравнению с обработкой только новых принимаемых операционных данных. 

## <a name="column-oriented-analytical-store"></a>Аналитическое хранилище для столбцов

Аналитическое хранилище Azure Cosmos DB устраняет трудности и задержки, возникающие при использовании традиционных конвейеров ETL. Аналитическое хранилище Azure Cosmos DB может автоматически синхронизировать операционные данные с отдельным хранилищем столбцов. Формат хранилища столбцов подходит для крупномасштабных аналитических запросов, которые выполняются оптимизированным образом, что позволяет повысить задержку таких запросов.

С помощью ссылки Azure синапсе вы можете создавать решения HTAP без ETL, напрямую связываясь с Azure Cosmos DB аналитическим хранилищем из Azure синапсе Analytics. Благодаря этому можно выполнять крупномасштабную аналитику на операционных данных почти в реальном времени.

## <a name="features-of-analytical-store"></a>Возможности аналитического хранилища 

При включении аналитического хранилища в контейнере Azure Cosmos DB новое хранилище столбцов создается на основе операционных данных в контейнере. Это хранилище столбцов сохраняется отдельно от транзакционного хранилища строк для этого контейнера. Операции вставки, обновления и удаления для операционных данных автоматически синхронизируются с аналитическим хранилищем. Для синхронизации данных не требуется канал изменений или ETL.

### <a name="column-store-for-analytical-workloads-on-operational-data"></a>Хранилище столбцов для аналитических рабочих нагрузок в операционных данных

Аналитические рабочие нагрузки обычно содержат агрегаты и последовательные проверки выбранных полей. Благодаря хранению данных в виде столбцов аналитическое хранилище позволяет группировать значения для каждого поля, чтобы сериализовать их вместе. Такой формат сокращает количество операций ввода-вывода, необходимых для сканирования или вычислений статистики по конкретным полям. Он значительно сокращает время отклика запросов для больших наборов данных. 

Например, если рабочие таблицы имеют следующий формат:

:::image type="content" source="./media/analytical-store-introduction/sample-operational-data-table.png" alt-text="Пример операционной таблицы" border="false":::

Хранилище строк сохраняет приведенные выше данные в сериализованном формате в строке на диске. Такой формат позволяет быстрее выполнять транзакционные операции чтения, записи и оперативные запросы, например "Вернуть сведения о product1". Однако по мере роста набора данных и необходимости выполнять сложные аналитические запросы к данным, такие запросы могут оказаться дорогостоящими. Например, если вы хотите получить тенденции продаж для продукта в категории "Оборудование"по разным подразделениям и месяцам, необходимо выполнить сложный запрос. Крупные проверки этого набора данных могут оказаться затратными в плане подготовленной пропускной способности и могут повлиять на производительность транзакционных рабочих нагрузок, обеспечивающих работу приложений и служб в режиме реального времени.

Аналитическое хранилище, которое является хранилищем столбцов, лучше подходит для таких запросов, так как оно сериализует похожие поля данных вместе и сокращает число операций ввода-вывода на диск.

На следующем рисунке показано хранилище транзакций и хранилище аналитических столбцов в Azure Cosmos DB:

:::image type="content" source="./media/analytical-store-introduction/transactional-analytical-data-stores.png" alt-text="Транзакционное хранилище строк и хранилище аналитических столбцов в Azure Cosmos DB" border="false":::

### <a name="decoupled-performance-for-analytical-workloads"></a>Несвязанная производительность для аналитических рабочих нагрузок

Аналитические запросы не влияют на производительность транзакционных рабочих нагрузок, так как аналитическое хранилище отделено от хранилища транзакций.  Для аналитического хранилища не требуется выделять отдельные единицы запроса (ЕЗ).

### <a name="auto-sync"></a>Автосинхронизация

Автоматическая синхронизация — это полностью управляемая возможность Azure Cosmos DB, в которой операции вставки, обновления и удаления в операционные данные автоматически синхронизируются из хранилища транзакций в аналитическое хранилище практически в реальном времени. Задержка автоматической синхронизации обычно составляет в течение 2 минут. В случае с общей пропускной способностью базы данных с большим количеством контейнеров, задержка автоматической синхронизации отдельных контейнеров может быть выше и займет до 5 минут. Мы хотели бы узнать больше о том, как эта задержка подходит для ваших сценариев. Для этого обратитесь к [группе Azure Cosmos DB](mailto:cosmosdbsynapselink@microsoft.com).

Функция автоматической синхронизации вместе с аналитическим хранилищем предоставляет следующие основные преимущества.

### <a name="scalability--elasticity"></a>Масштабируемость и эластичность

Используя горизонтальное секционирование, хранилище транзакций Azure Cosmos DB может эластично масштабировать хранилище и пропускную способность без простоев. Горизонтальное секционирование в хранилище транзакций обеспечивает масштабируемость и эластичность при автоматической синхронизации, чтобы обеспечить синхронизацию данных с аналитическим хранилищем почти в реальном времени. Синхронизация данных происходит независимо от объема трафика транзакций, который составляет 1000 операций/с или 1 000 000 операций/с, и не влияет на подготовленную пропускную способность в хранилище транзакций. 

### <a name="automatically-handle-schema-updates"></a><a id="analytical-schema"></a>Автоматическая работа с обновлениями схемы

Хранилище транзакций Azure Cosmos DB не зависит от схемы и позволяет выполнять итерации по транзакционным приложениям без необходимости управлять схемой или индексами. В отличие от этого, аналитическое хранилище Azure Cosmos DB разработано с целью оптимизации производительности аналитических запросов. С помощью функции автоматической синхронизации Azure Cosmos DB управляет выводом схемы по последним обновлениям из хранилища транзакций.  Она также управляет готовым представлением схемы в аналитическом хранилище, которое выполняет обработку вложенных типов данных.

По мере развития схемы и добавления новых свойств с течением времени аналитическое хранилище автоматически представляет Объединенную схему для всех исторических схем в хранилище транзакций.

#### <a name="schema-constraints"></a>Ограничения схемы

Следующие ограничения применимы к рабочим данным в Azure Cosmos DB при включении автоматического определения и представления схемы в аналитическом хранилище:

* Можно установить максимум 1000 свойств на любом уровне вложенности в схеме и максимальную глубину вложенности 127.
  * В аналитическом хранилище представлены только первые свойства 1000.
  * В аналитическом хранилище представлены только первые 127 вложенных уровней.

* Хотя документы JSON (и Cosmos DB коллекции и контейнеры) чувствительны к регистру с точки зрения уникальности, аналитическое хранилище не имеет значение.

  * **В том же документе:** Имена свойств на одном уровне должны быть уникальными при сравнении без учета регистра. Например, следующий документ JSON содержит "Name" и "Name" на том же уровне. Хотя это допустимый документ JSON, он не удовлетворяет ограничению уникальности и, следовательно, не будет полностью представлен в аналитическом хранилище. В этом примере "Name" и "Name" одинаковы при сравнении без учета регистра. `"Name": "fred"`Будет представлен только в аналитическом хранилище, так как это первое вхождение. И `"name": "john"` не будут представлены вообще.
  
  
  ```json
  {"id": 1, "Name": "fred", "name": "john"}
  ```
  
  * **В разных документах:** Свойства на одном и том же уровне и с тем же именем, но в разных случаях будут представлены в одном столбце с использованием формата имени первого вхождения. Например, следующие документы JSON имеют `"Name"` и `"name"` на одном уровне. Так как формат первого документа — `"Name"` , это будет использоваться для представления имени свойства в аналитическом хранилище. Иными словами, имя столбца в аналитическом хранилище будет иметь значение `"Name"` . `"fred"`И `"john"` будут представлены в `"Name"` столбце.


  ```json
  {"id": 1, "Name": "fred"}
  {"id": 2, "name": "john"}
  ```


* Первый документ коллекции определяет схему первоначального аналитического хранилища.
  * Свойства на первом уровне документа будут представлены как столбцы.
  * Документы с большим количеством свойств, чем исходная схема, будут формировать новые столбцы в аналитическом хранилище.
  * Невозможно удалить столбцы.
  * Удаление всех документов в коллекции не приводит к сбросу схемы аналитического хранилища.
  * Управление версиями схемы не поддерживается. Последняя версия, выводимая из хранилища транзакций, — это то, что вы увидите в аналитическом хранилище.

* Сейчас мы не поддерживаем Azure синапсе Spark, считывающий имена столбцов, которые содержат пробелы (пробелы).

* В отношении значений требуется другое поведение `NULL` :
  * Пулы Spark в Azure синапсе будут считать эти значения 0 (ноль).
  * Несинапсеные пулы в Azure будут считать эти значения `NULL` .

* В отношении отсутствующих столбцов требуется другое поведение:
  * Пулы Spark в Azure синапсе будут представлять эти столбцы как `undefined` .
  * Несинапсеные пулы в Azure будут представлять эти столбцы как `NULL` .

#### <a name="schema-representation"></a>Представление схемы

В аналитическом хранилище существует два режима представления схемы. Эти режимы являются компромиссом между простым представлением по столбцам, обработкой полиморфных схем и упрощенной работой с запросами.

* Четко определенное представление схемы
* Полное представление схемы точности

> [!NOTE]
> Для учетных записей API SQL (Core) при включенном аналитическом хранилище представление схемы по умолчанию в аналитическом хранилище четко определено. В то время как для Azure Cosmos DB API для учетных записей MongoDB представление схемы в аналитическом хранилище по умолчанию представляет собой полное представление схемы точности. Если у вас есть сценарии, которым требуется другое представление схемы, чем предложение по умолчанию для каждого из этих интерфейсов API, можно обратиться к [группе Azure Cosmos DB](mailto:cosmosdbsynapselink@microsoft.com) , чтобы включить ее.

**Четко определенное представление схемы**

Четко определенное представление схемы создает простое табличное представление данных, не зависящих от схемы, в хранилище транзакций. Четко определенное представление схемы имеет следующие соображения.

* Свойство всегда имеет одинаковый тип в нескольких элементах.

  * Например, `{"a":123} {"a": "str"}` не имеет четко определенной схемы, так как `"a"` иногда является строкой, а иногда числом. В этом случае аналитическое хранилище регистрирует тип данных `"a"` в качестве типа данных `“a”` в первом элементе во время существования контейнера. Документ по-прежнему будет включаться в аналитическое хранилище, но элементы, в которых тип данных `"a"` отличается, не будут.
  
    Это условие не применяется к свойствам со значением NULL. Например, `{"a":123} {"a":null}` по-прежнему определено правильно.

* Типы массивов должны содержать один повторяющийся тип.

  * Например, `{"a": ["str",12]}` не является четко определенной схемой, так как массив содержит сочетание целочисленных и строковых типов.

> [!NOTE]
> Если Azure Cosmos DB аналитическое хранилище соответствует четко определенному представлению схемы, а приведенная выше спецификация нарушается определенными элементами, эти элементы не будут включаться в аналитическое хранилище.

**Полное представление схемы точности**

Полное представление схемы точности предназначено для работы с полноценными схемами полиморфизма в рабочих данных, не зависящих от схемы. В этом представлении схемы элементы не удаляются из аналитического хранилища, даже если нарушены четко определенные ограничения схемы (не являющиеся полями смешанных типов данных и смешанными массивами типов данных).

Это достигается путем преобразования конечных свойств рабочих данных в аналитическое хранилище с различными столбцами, основанными на типе данных значений в свойстве. Имена конечных свойств расширены с использованием типов данных в качестве суффикса в схеме аналитического хранилища таким образом, что они могут быть запросами без неоднозначности.

Например, давайте рассмотрим следующий образец документа в хранилище транзакций:

```json
{
name: "John Doe",
age: 32,
profession: "Doctor",
address: {
  streetNo: 15850,
  streetName: "NE 40th St.",
  zip: 98052
},
salary: 1000000
}
```

Конечное свойство `streetNo` внутри вложенного объекта `address` будет представлено в схеме аналитического хранилища в виде столбца `address.object.streetNo.int32` . Тип данных добавляется в качестве суффикса к столбцу. Таким образом, если в хранилище транзакций добавляется другой документ, где значение конечного свойства `streetNo` равно "123" (Обратите внимание, что это строка), схема аналитического хранилища автоматически изменяется без изменения типа ранее записанного столбца. Новый столбец, добавляемый в аналитическое хранилище как `address.object.streetNo.string` место, где хранится значение "123".

**Тип данных для сопоставлений суффиксов**

Ниже приведена схема всех типов данных свойств и их представлений суффиксов в аналитическом хранилище.

|Исходный тип данных  |Суффикс  |Пример  |
|---------|---------|---------|
| Double |  ". float64" |    24,99|
| Array | ". Array" |    ["a", "b"]|
|Двоичные данные | ". binary" |0|
|Логическое    | ". bool"   |Верно|
|Int32  | ". Int32"  |123|
|Int64  | ". Int64"  |255486129307|
|NULL   | ". null"   | null|
|Строка|    ". String" | "ABC"|
|Отметка времени |    ". timestamp" |  Отметка времени (0, 0)|
|Дата/время   |". Date"    | Исодате ("2020-08-21T07:43:07.375 Z")|
|ObjectId   |". objectId"    | ObjectId ("5f3f7b59330ec25c132623a2")|
|Документ   |". Object" |    {"a": "a"}|

### <a name="cost-effective-archival-of-historical-data"></a>Экономичное архивирование исторических данных

Распределение данных по уровням означает разделение данных между инфраструктурами хранилища, оптимизированными для различных сценариев. Таким образом повышается общая производительность и экономичность всего стека данных. С помощью аналитического хранилища Azure Cosmos DB теперь поддерживается автоматическое распределение данных из хранилища транзакций в аналитическое хранилище с различными макетами данных. При использовании аналитического хранилища, оптимизированного с точки зрения стоимости хранилища по сравнению с хранилищем транзакций, можно хранить более длинные горизонты операционных данных для исторического анализа.

После включения аналитического хранилища в зависимости от потребностей хранения данных в транзакционных рабочих нагрузках можно настроить свойство "время жизни в хранилище транзакций (транзакционное TTL)", чтобы записи автоматически удалялись из хранилища транзакций по истечении определенного периода времени. Аналогично, "время жизни в аналитическом хранилище (аналитическое TTL)" позволяет управлять жизненным циклом данных, хранимых в аналитическом хранилище, независимом от хранилища транзакций. Включив аналитическое хранилище и настроив свойства TTL, можно эффективно распределять и определять срок хранения данных для двух хранилищ.

### <a name="global-distribution"></a>Глобальное распределение

Если вы используете глобально распределенную учетную запись Azure Cosmos DB, после включения аналитического хранилища для контейнера он будет доступен во всех регионах этой учетной записи.  Любые изменения в операционных данных глобально реплицируются во всех регионах. Это позволяет эффективно выполнять аналитические запросы по отношению к ближайшей региональной копии данных в Azure Cosmos DB.

### <a name="security"></a>Безопасность

Проверка подлинности для аналитического хранилища совпадает с проверкой для хранилища транзакций в заданной базе данных. Для проверки подлинности можно использовать первичный ключ или ключи только для чтения. Чтобы не вставлять ключи Azure Cosmos DB в записные книжки Spark, можно использовать связанную службу в Synapse Studio. Доступ к этой связанной службе предоставляется всем, у кого есть доступ к рабочей области.

### <a name="support-for-multiple-azure-synapse-analytics-runtimes"></a>Поддержка нескольких сред выполнения Azure Synapse Analytics

Аналитическое хранилище оптимизировано для обеспечения масштабируемости, эластичности и производительности для аналитических рабочих нагрузок без какой-либо зависимости от времени выполнения вычислений. Технология хранения самостоятельно оптимизирует рабочие нагрузки аналитики без вмешательства вручную.

Отделив систему аналитического хранилища от аналитической системы вычислений, данные в аналитическом хранилище Azure Cosmos DB можно запрашивать одновременно из разных сред выполнения аналитики, поддерживаемых Azure Synapse Analytics. На сегодняшний день Azure синапсе Analytics поддерживает Apache Spark и бессерверный пул SQL с Azure Cosmos DB аналитическим хранилищем.

> [!NOTE]
> Вы можете читать только из аналитического хранилища, используя время выполнения аналитики Azure синапсе. Данные можно записать обратно в хранилище транзакций в качестве уровня обслуживания.

## <a name="pricing"></a><a id="analytical-store-pricing"></a> Цены

Аналитическое хранилище соответствует модели ценообразования на основе потребления, в которой вы платите за:

* Хранилище: объем данных, хранящихся в хранилище в течение месяца, включая исторические данные в соответствии с аналитическим TTL.

* Аналитические операции записи: полностью управляемая синхронизация обновлений операционных данных в хранилище транзакций (автоматическая синхронизация).

* Операции аналитического чтения: операции чтения, выполняемые для аналитического хранилища из пула Spark Azure синапсе Analytics и времени выполнения несерверного пула SQL.

Цены на аналитическое хранилище определяются отдельно от модели ценообразования для хранилища транзакций. В аналитическом хранилище нет понятия подготовленных ЕЗ. Подробные сведения о модели ценообразования для аналитического хранилища см. на странице цен для [Azure Cosmos DB](https://azure.microsoft.com/pricing/details/cosmos-db/).

Чтобы получить общую оценку затрат для включения аналитического хранилища для контейнера Azure Cosmos DB, можно воспользоваться планировщиком ресурсов [Azure Cosmos DB](https://cosmos.azure.com/capacitycalculator/) и получить оценку затрат на аналитическое хранилище и операции записи. Затраты на аналитические операции чтения зависят от характеристик рабочей нагрузки аналитики, но согласно общей оценке проверка 1 ТБ данных в аналитическом хранилище обычно приводит к 130 000 аналитических операций чтения и стоит 0,065 $.

## <a name="analytical-time-to-live-ttl"></a><a id="analytical-ttl"></a> Аналитическое время жизни (TTL)

Аналитическое TTL указывает, как долго данные должны храниться в аналитическом хранилище для контейнера. 

Если аналитическое хранилище включено, операции вставки, обновления и удаления в операционные данные автоматически синхронизируются из хранилища транзакций в аналитическое хранилище, независимо от конфигурации с TTL для транзакций. Хранение этих операционных данных в аналитическом хранилище может осуществляться с помощью аналитического TTL на уровне контейнера, как указано ниже:

Аналитическое TTL в контейнере задается с помощью свойства `AnalyticalStoreTimeToLiveInSeconds`:

* Если задано значение "0", не задано (или установлено значение NULL): аналитическое хранилище отключено, а данные из хранилища транзакций в аналитическое хранилище не реплицируются

* Если параметр есть и для него задано значение "-1", аналитическое хранилище сохраняет все исторические данные независимо от хранения данных в хранилище транзакций. Этот параметр указывает на бесконечное время хранения операционных данных в аналитическом хранилище.

* Если параметр есть и для него задано положительное число "n", срок хранения элементов в аналитическом хранилище истечет через "n" секунд после их последнего изменения в хранилище транзакций. Этот параметр можно использовать, если требуется сохранить операционные данные в течение ограниченного периода времени в аналитическом хранилище независимо от хранения данных в хранилище транзакций.

Учитывайте следующие факторы.

*   После активации аналитического хранилища с заданным значением аналитического TTL, это значение можно обновить до другого допустимого значения позднее. 
*   Хотя параметр TTL можно установить на уровне контейнера или элемента, аналитическое время жизни можно задать только на уровне контейнера.
*   Длительного хранения операционных данных в аналитическом хранилище можно достичь, установив аналитическое время жизни > = транзакционного времени жизни на уровне контейнера.
*   Аналитическое хранилище может быть создано для отражения хранилища транзакций путем установки аналитического TTL = срока жизни транзакций.

При включении аналитического хранилища в контейнере:

* В портал Azure для параметра "аналитический срок жизни" задано значение по умолчанию, равное-1. Это значение можно изменить на "n" секунд, перейдя к параметрам контейнера в разделе обозреватель данных. 
 
* С помощью пакета SDK для Azure или PowerShell или интерфейса командной строки можно включить параметр аналитики TTL, задав для него значение-1 или "n". 

Дополнительные сведения см. в разделе [Настройка аналитического времени жизни для контейнера](configure-synapse-link.md#create-analytical-ttl).

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения см. в следующих документах:

* [Сведения об Azure Synapse Link для Azure Cosmos DB](synapse-link.md)

* [Начало работы с Azure Synapse Link для Azure Cosmos DB](configure-synapse-link.md)

* [Часто задаваемые вопросы о Azure Synapse Link для Azure Cosmos DB](synapse-link-frequently-asked-questions.md).

* [Варианты использования Azure Synapse Link для Azure Cosmos DB](synapse-link-use-cases.md)
