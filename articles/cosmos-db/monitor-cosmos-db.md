---
title: Мониторинг Azure Cosmos DB | Документация Майкрософт
description: Узнайте, как отслеживать производительность и доступность Azure Cosmos DB.
author: SnehaGunda
services: cosmos-db
ms.service: cosmos-db
ms.topic: how-to
ms.date: 12/01/2020
ms.author: sngun
ms.custom: subject-monitoring
ms.openlocfilehash: f18d1850cb6ccf28ff70f826e3d4bfe74ae05c40
ms.sourcegitcommit: 24a12d4692c4a4c97f6e31a5fbda971695c4cd68
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/05/2021
ms.locfileid: "102178734"
---
# <a name="monitor-azure-cosmos-db"></a>Мониторинг Azure Cosmos DB
[!INCLUDE[appliesto-all-apis](includes/appliesto-all-apis.md)]

При наличии критически важных приложений и бизнес-процессов, использующих ресурсы Azure, необходимо отслеживать эти ресурсы на предмет их доступности, производительности и работы. В этой статье описаны данные мониторинга, созданные в базах данных Azure Cosmos, а также анализ таких данных и оповещений о них с помощью функций Azure Monitor.

Вы можете отслеживать данные с помощью клиентских и серверных метрик. При использовании метрик на стороне сервера можно отслеживать данные, хранящиеся в Azure Cosmos DB, с помощью следующих параметров.

* **Монитор с Azure Cosmos DB портала:** Вы можете отслеживать метрики, доступные на вкладке **метрики** в учетной записи Azure Cosmos. Метрики на этой вкладке включают показатели пропускной способности, хранилища, доступности, задержки, согласованности и уровня системы. По умолчанию срок хранения этих метрик составляет 7 дней. Дополнительные сведения см. в разделе " [мониторинг данных, собранных из Azure Cosmos DB](#monitoring-from-azure-cosmos-db) " этой статьи.

* **Мониторинг с помощью метрик в Azure Monitor:** Вы можете отслеживать метрики учетной записи Azure Cosmos и создавать панели мониторинга из Azure Monitor. Azure Monitor собирает метрики Azure Cosmos DB по умолчанию, вы не настраиваете ничего явно. Эти метрики собираются с детализацией в одну минуту, гранулярность может меняться в зависимости от выбранной метрики. По умолчанию срок хранения этих метрик составляет 30 дней. Большинство метрик, доступных из предыдущих вариантов, также доступны в этих метриках. Значения измерений для таких метрик, как имя контейнера, не учитывают регистр. Поэтому при сравнении строк по этим значениям измерений необходимо использовать сравнение без учета регистра. Дополнительные сведения см. в разделе [анализ данных метрик](#analyze-metric-data) этой статьи.

* **Мониторинг с помощью журналов диагностики в Azure Monitor:** Вы можете отслеживать журналы учетной записи Azure Cosmos и создавать панели мониторинга из Azure Monitor. Данные телеметрии, такие как события и трассировки, происходящие во второй степени гранулярности, хранятся в виде журналов. Например, если пропускная способность контейнера изменяется, свойства учетной записи Cosmos изменяются. Эти события записываются в журналы. Вы можете проанализировать эти журналы, запустив запросы к собранным данным. Дополнительные сведения см. в разделе [анализ данных журнала](#analyze-log-data) этой статьи.

* **Программное отслеживание с помощью пакетов SDK:** Вы можете отслеживать учетную запись Azure Cosmos программным путем с помощью .NET, Java, Python, Node.js пакетов SDK и заголовков в REST API. Дополнительные сведения см. в разделе [мониторинг Azure Cosmos DB программным способом](#monitor-cosmosdb-programmatically) этой статьи.

На следующем рисунке показаны различные параметры, доступные для мониторинга учетной записи Azure Cosmos DB с помощью портал Azure.

:::image type="content" source="media/monitor-cosmos-db/monitoring-options-portal.png" alt-text="Параметры мониторинга, доступные в портал Azure" border="false":::

При использовании Azure Cosmos DB на стороне клиента можно собираются сведения о расходах запросов, ИДЕНТИФИКАТОРах действий, исключениях и трассировках стека, коде состояния HTTP/подсостояния, диагностической строке для отладки любой проблемы, которая может возникнуть. Эти сведения также необходимы, если необходимо обратиться к группе поддержки Azure Cosmos DB. 

## <a name="monitor-overview"></a>Общие сведения о мониторинге

Страница **Обзор** в портал Azure для каждой учетной записи Azure Cosmos DB содержит краткое представление об использовании ресурсов, например общее количество запросов, запросы, в результате которых указан код состояния HTTP, и почасовая оплата. Эта информация полезна, но на этой панели доступен только небольшой объем данных мониторинга. Некоторые из этих данных собираются автоматически и доступны для анализа сразу после создания ресурса. Вы можете включить дополнительные типы сбора данных с помощью определенной конфигурации.

## <a name="what-is-azure-monitor"></a>Общие сведения об Azure Monitor

Azure Cosmos DB создает данные мониторинга с помощью [Azure Monitor](../azure-monitor/overview.md) — комплексной службы мониторинга в Azure, которая предоставляет полный набор функций для отслеживания ресурсов Azure в дополнение к ресурсам в других облаках и локальных средах.

Если вы еще не знакомы с мониторингом служб Azure, начните с статьи [мониторинг ресурсов Azure с помощью Azure Monitor](../azure-monitor/essentials/monitor-azure-resource.md) , в котором описаны следующие понятия.

* Общие сведения об Azure Monitor
* затраты, связанные с мониторингом;
* данные мониторинга, собираемые в Azure;
* настройка сбора данных;
* стандартные средства Azure для анализа данных мониторинга и оповещения.

Следующие разделы являются продолжением этой статьи и посвящены описанию данных, собираемых в Azure Cosmos DB. Кроме того, в ней приводятся примеры настройки сбора и анализа данных с помощью средств Azure.

## <a name="azure-monitor-for-azure-cosmos-db"></a>Azure Monitor для Azure Cosmos DB

Azure Monitor для Azure Cosmos DB основаны на [функциях книг в Azure Monitor](../azure-monitor/visualize/workbooks-overview.md) и использует те же данные мониторинга, собранные для Azure Cosmos DB, описанных в следующих разделах. Используйте Azure Monitor для получения общего представления о производительности, сбоях, емкости и работоспособности всех ваших ресурсов Azure Cosmos DB в едином интерактивном интерфейсе. Кроме того, в Azure Monitor есть функции для подробного анализа и оповещений. Дополнительные сведения см. в статье [Изучение возможностей Azure Monitor для Azure Cosmos DB](../azure-monitor/insights/cosmosdb-insights-overview.md).

> [!NOTE]
> При создании контейнеров следите за тем, чтобы не создать два контейнера с одинаковыми именами, но в разных регистрах. Причина в том, что некоторые компоненты платформы Azure не учитывают регистр. Это может привести к путанице или конфликтам в данных телеметрии и действиях с контейнерами с такими именами.

## <a name="monitoring-data"></a><a id="monitoring-from-azure-cosmos-db"></a> Данные мониторинга 

Azure Cosmos DB собирает данные мониторинга тех же типов, что и другие ресурсы Azure, которые описаны в разделе [Мониторинг ресурсов Azure с помощью Azure Monitor](../azure-monitor/essentials/monitor-azure-resource.md#monitoring-data). Подробную справку по журналам и метрикам, создаваемым Azure Cosmos DB, см. в [справочнике по данным мониторинга Azure Cosmos DB](monitor-cosmos-db-reference.md).

На странице **Обзор** на портале Azure приводится сводка использования каждой базы данных Azure Cosmos, включая количество запросов и стоимость в час. Это полезная информация, которая, однако, представляет собой лишь небольшую часть доступных данных мониторинга. Некоторые из этих данных собираются автоматически и доступны для анализа сразу же после создания базы данных, но для сбора дополнительных данных требуется настройка.

:::image type="content" source="media/monitor-cosmos-db/overview-page.png" alt-text="Страница &quot;Обзор&quot;":::

## <a name="collection-and-routing"></a>Сбор и маршрутизация

Метрики платформы и журнал действий собираются и сохраняются автоматически, но их можно направить в другие расположения с помощью параметра диагностики.  

Журналы ресурсов не собираются и не сохраняются, пока вы не создадите параметр диагностики и не направите их в одно или несколько расположений.

Подробный процесс создания параметров диагностики с помощью портал Azure и некоторых примеров диагностического запроса см. в статье [Создание параметра диагностики для сбора журналов и метрик платформы в Azure](cosmosdb-monitor-resource-logs.md) . Создавая параметр диагностики, нужно указать, какие категории журналов должны собираться.

Собираемые метрики и журналы обсуждаются в следующих разделах.

## <a name="analyzing-metrics"></a><a id="analyze-metric-data"></a> Анализ метрик

Azure Cosmos DB предоставляет пользовательский интерфейс для работы с метриками. Вы можете анализировать метрики Azure Cosmos DB вместе с метриками из других служб Azure с помощью обозревателя метрик. Для этого выберите пункт **Метрики** в меню **Azure Monitor**. Подробные сведения об использовании этого средства см. в статье [Начало работы с обозревателем метрик Azure](../azure-monitor/essentials/metrics-getting-started.md). Вы также можете извлекать сведения о мониторинге [задержки на стороне сервера](monitor-server-side-latency.md), [использовании единиц запросов](monitor-request-unit-usage.md)и [нормализованного использования единиц запросов](monitor-normalized-request-units.md) для ресурсов Azure Cosmos DB.

Список метрик платформы, собранных для Azure Cosmos DB, см. в статье [мониторинг метрик Azure Cosmos DB ссылок на данные](monitor-cosmos-db-reference.md#metrics) .

Все метрики Azure Cosmos DB находятся в пространстве имен **Стандартные метрики Cosmos DB**. При добавлении фильтра к диаграмме можно использовать следующие измерения с метриками.

* CollectionName
* имя_базы_данных
* OperationType
* Регион
* StatusCode

Для справки можно просмотреть список [всех метрик ресурсов, поддерживаемых Azure Monitor](../azure-monitor/essentials/metrics-supported.md).

### <a name="view-operation-level-metrics-for-azure-cosmos-db"></a>Просмотр метрик на уровне операций для Azure Cosmos DB

1. Войдите на [портал Azure](https://portal.azure.com/).

1. На панели навигации слева выберите пункт **Монитор**, а затем выберите **Метрики**.

   :::image type="content" source="./media/monitor-cosmos-db/monitor-metrics-blade.png" alt-text="Область метрик в Azure Monitor":::

1. В области **Метрики** щелкните **Выбрать ресурс** и выберите требуемые **подписку** и **группу ресурсов**. В поле **Тип ресурса** выберите **Учетные записи Azure Cosmos DB**, выберите одну из существующих учетных записей Azure Cosmos и нажмите кнопку **Применить**.

   :::image type="content" source="./media/monitor-cosmos-db/select-cosmosdb-account.png" alt-text="Выбор учетной записи Cosmos DB для просмотра метрик":::

1. Далее можно выбрать метрику из списка доступных метрик. Вы можете выбрать метрики, связанные с единицами запросов, хранилищем, задержкой, доступностью, Cassandra и т. д. Подробные сведения о всех доступных метриках в списке см. в статье с [перечнем метрик по категориям](monitor-cosmos-db-reference.md). В этом примере выберем **Единицы запроса** и **Среднее** в качестве значения агрегата.

   Помимо этих сведений, можно также выбрать **диапазон времени** и **степень детализации времени** для метрик. Вы можете просмотреть метрики максимум за последние 30 дней.  После применения фильтра отображается диаграмма на его основе. На ней можно увидеть среднее количество единиц запросов, употреблявшихся в минуту за выбранный период.  

   :::image type="content" source="./media/monitor-cosmos-db/metric-types.png" alt-text="Выбор метрики на портале Azure":::

### <a name="add-filters-to-metrics"></a>Добавление фильтров к метрикам

Можно также отфильтровать метрики и отображаемую диаграмму по определенному значению **CollectionName**, **DatabaseName**, **OperationType**, **Region** или **StatusCode**. Чтобы отфильтровать метрики, выберите команду **Добавить фильтр**, а затем выберите требуемое свойство, например **OperationType**, и значение, например **Запрос**. После этого на графе отобразятся единицы запросов, использованные для операции запроса за выбранный период. Операции, выполняемые с помощью хранимой процедуры, не регистрируются в журнале, поэтому они недоступны в метрике OperationType.

:::image type="content" source="./media/monitor-cosmos-db/add-metrics-filter.png" alt-text="Добавление фильтра для выбора степени детализации метрики":::

Метрики можно группировать с помощью параметра **Применить разделение**. Например, можно сгруппировать единицы запросов по типу операции и просмотреть граф для всех операций сразу, как показано на следующем рисунке:

:::image type="content" source="./media/monitor-cosmos-db/apply-metrics-splitting.png" alt-text="Добавление фильтра &quot;Применить разделение&quot;":::

## <a name="analyzing-logs"></a><a id="analyze-log-data"></a> Анализ журналов

Данные в журналах Azure Monitor хранятся в таблицах, и каждая таблица имеет собственный набор уникальных свойств.

Все журналы ресурсов в Azure Monitor имеют те же поля, за которыми следуют поля, связанные со службой. Общая схема описана в [Azure Monitor схеме журнала ресурсов](../azure-monitor/essentials/resource-logs-schema.md#top-level-common-schema). Список типов журналов ресурсов, собранных для Azure Cosmos DB, см. в разделе [мониторинг справочника по данным Azure Cosmos DB](monitor-cosmos-db-reference.md#resource-logs).

[Журналы действий](../azure-monitor/essentials/activity-log.md) — это средство платформы Azure, которое предоставляет представление о событиях уровня подписки. Вы можете просмотреть их независимо или направить в журналы Azure Monitor, где можно выполнять гораздо более сложные запросы с помощью Log Analytics.  

Azure Cosmos DB сохраняет данные в указанных ниже таблицах.

| Таблица | Описание |
|:---|:---|
| AzureDiagnostics | Общая таблица, используемая несколькими службами для хранения журналов ресурсов. Журналы ресурсов из Azure Cosmos DB можно определить по `MICROSOFT.DOCUMENTDB`.   |
| AzureActivity    | Общая таблица, в которой хранятся все записи из журнала действий.

### <a name="sample-kusto-queries"></a>Примеры запросов Kusto

> [!IMPORTANT]
> При выборе **журналов** в меню Azure Cosmos DB log Analytics открывается с областью запроса, для которой задана текущая учетная запись Azure Cosmos DB. Это означает, что запросы к журналам будут содержать данные только из этого ресурса. Если требуется выполнить запрос, который включает данные из других учетных записей или данных из других служб Azure, выберите **журналы** в меню **Azure Monitor** . Подробные сведения см. в статье [Область запросов журнала и временной диапазон в Azure Monitor Log Analytics](../azure-monitor/logs/scope.md).

Ниже приведены некоторые запросы, которые можно ввести в строку поиска по **журналам** , чтобы упростить мониторинг ресурсов Azure Cosmos. Эти запросы поддерживают [новый язык](../azure-monitor/logs/log-query-overview.md).

* Для запроса всех журналов диагностики из Azure Cosmos DB за указанный период времени:

    ```Kusto
    AzureDiagnostics 
    | where ResourceProvider=="Microsoft.DocumentDb" and Category=="DataPlaneRequests"

    ```

* Для запроса всех операций, сгруппированных по ресурсу:

    ```Kusto
    AzureActivity 
    | where ResourceProvider=="Microsoft.DocumentDb" and Category=="DataPlaneRequests" 
    | summarize count() by Resource

    ```

* Для запроса всех действий пользователя, сгруппированных по ресурсу:

    ```Kusto
    AzureActivity 
    | where Caller == "test@company.com" and ResourceProvider=="Microsoft.DocumentDb" and Category=="DataPlaneRequests" 
    | summarize count() by Resource
    ```

## <a name="alerts"></a>видны узлы

Оповещения Azure Monitor заблаговременно уведомляют вас при обнаружении важных условий в данных мониторинга. Они позволяют выявлять и устранять проблемы в системе до того, как ваши клиенты заметят их. Оповещения можно настроить для [метрик](../azure-monitor/alerts/alerts-metric-overview.md), [журналов](../azure-monitor/alerts/alerts-unified-log.md) и [журнала действий](../azure-monitor/alerts/activity-log-alerts.md). Различные типы оповещений имеют преимущества и недостатки

Например, в следующей таблице перечислены некоторые правила генерации оповещений для ресурсов. Подробный список правил генерации оповещений можно найти в портал Azure. Дополнительные сведения см. в статье [Настройка предупреждений](create-alerts.md) .  

| Тип оповещения | Условие | Описание  |
|:---|:---|:---|
|Ограничение частоты единиц запросов (оповещение метрики) |Имя измерения: StatusCode, оператор: Equals, значения измерения: 429  | Создает предупреждения, если контейнер или база данных превысили подготовленное ограничение пропускной способности. |
|Отработка отказа региона |Оператор: больше, тип агрегирования: count, пороговое значение: 1 | При отработки отказа одного региона. Это предупреждение полезно, если вы не включили автоматический переход на другой ресурс. |
| Клавиши вращения (оповещение журнала действий)| Уровень события: информационное, состояние: запущено| Оповещение при вращении ключей учетной записи. Вы можете обновить приложение с помощью новых ключей. |

## <a name="monitor-azure-cosmos-db-programmatically"></a><a id="monitor-cosmosdb-programmatically"></a> Программное отслеживание Azure Cosmos DB

Доступные на портале метрики уровня учетной записи, такие как данные об использовании хранилища учетной записи и общее число запросов, недоступны через API-интерфейсы SQL. Тем не менее, можно получить данные об использовании на уровне коллекции с помощью API SQL. Чтобы получить данных на уровне коллекции, выполните следующие действия:

* Чтобы использовать REST API, [выполните запрос GET к коллекции](/rest/api/cosmos-db/get-a-collection). Квота и данные об использовании коллекции возвращаются в заголовке ответа x-ms-resource-quota и x-ms-resource-usage headers.

* Чтобы использовать пакет SDK для .NET, воспользуйтесь методом [DocumentClient.ReadDocumentCollectionAsync](/dotnet/api/microsoft.azure.documents.client.documentclient.readdocumentcollectionasync), возвращающим объект [ResourceResponse](/dotnet/api/microsoft.azure.documents.client.resourceresponse-1), который содержит ряд свойств использования, например **CollectionSizeUsage**, **DatabaseUsage**, **DocumentUsage** и прочие.

Чтобы получить дополнительные метрики, используйте [пакет SDK для Azure Monitor](https://www.nuget.org/packages/Microsoft.Azure.Insights). Доступные определения метрик можно получить с помощью следующего вызова.

```http
https://management.azure.com/subscriptions/{SubscriptionId}/resourceGroups/{ResourceGroup}/providers/Microsoft.DocumentDb/databaseAccounts/{DocumentDBAccountName}/providers/microsoft.insights/metricDefinitions?api-version=2018-01-01
```

Чтобы получить отдельные метрики, используйте следующий формат:

```http
https://management.azure.com/subscriptions/{SubscriptionId}/resourceGroups/{ResourceGroup}/providers/Microsoft.DocumentDb/databaseAccounts/{DocumentDBAccountName}/providers/microsoft.insights/metrics?timespan={StartTime}/{EndTime}&interval={AggregationInterval}&metricnames={MetricName}&aggregation={AggregationType}&`$filter={Filter}&api-version=2018-01-01
```

Дополнительные сведения см. в статье [REST API мониторинга Azure](../azure-monitor/essentials/rest-api-walkthrough.md) .

## <a name="next-steps"></a>Дальнейшие действия

* Справку по журналам и метрикам, создаваемым Azure Cosmos DB, см. в [справочнике по данным мониторинга Azure Cosmos DB](monitor-cosmos-db-reference.md).
* Подробные сведения о мониторинге ресурсов Azure см. в статье [Мониторинг ресурсов Azure с помощью Azure Monitor](../azure-monitor/essentials/monitor-azure-resource.md).
