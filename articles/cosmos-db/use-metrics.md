---
title: Мониторинг и отладка с помощью метрик в Azure Cosmos DB
description: Сведения об отладке распространенных проблем и мониторинге базы данных с помощью метрик в Azure Cosmos DB.
author: kanshiG
ms.author: govindk
ms.reviewer: sngun
ms.service: cosmos-db
ms.subservice: cosmosdb-sql
ms.topic: how-to
ms.date: 07/22/2020
ms.custom: devx-track-csharp
ms.openlocfilehash: b0760b86012504ea86e4a0cde36ae878e8ff3b26
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "98685743"
---
# <a name="monitor-and-debug-with-metrics-in-azure-cosmos-db"></a>Мониторинг и отладка с помощью метрик в Azure Cosmos DB
[!INCLUDE[appliesto-all-apis](includes/appliesto-all-apis.md)]

Azure Cosmos DB предоставляет метрики пропускной способности, хранилища, согласованности, доступности и задержки. На портале Azure отображается общее представление этих метрик. Кроме того, вы можете просматривать метрики Azure Cosmos DB из API Azure Monitor. Значения измерений для таких метрик, как имя контейнера, не учитывают регистр. Поэтому при сравнении строк по этим значениям измерений необходимо использовать сравнение без учета регистра. Дополнительные сведения о просмотре метрик из Azure Monitor см. в статье [Получение метрик из Azure Monitor](./monitor-cosmos-db.md) .

В этой статье рассматриваются распространенные варианты использования Azure Cosmos DB, а также представлены сведения об анализе и отладке проблем в этой базе данных на основе метрик. Сбор метрик осуществляется каждые пять минут. Они хранятся в течение семи дней.

## <a name="view-metrics-from-azure-portal"></a>Просмотр метрик из портал Azure

1. Войдите на [портал Azure](https://portal.azure.com/).

1. Откройте панель **метрики** . По умолчанию на панели метрики отображаются метрики хранилища, индекса и единиц запросов для всех баз данных в учетной записи Azure Cosmos. Эти метрики можно фильтровать по каждой базе данных, контейнеру или региону. Вы также можете фильтровать метрики в определенное время гранулярности. Дополнительные сведения о показателях пропускной способности, хранилища, доступности, задержки и согласованности приведены на отдельных вкладках. 

   :::image type="content" source="./media/use-metrics/performance-metrics.png" alt-text="Cosmos DB метрики производительности в портал Azure":::

На панели « **метрики** » доступны следующие метрики. 

* **Метрики пропускной способности** — эта метрика показывает количество использованных или неудачных запросов (код ответа 429) из-за превышения пропускной способности или емкости хранилища, подготовленной для контейнера.

* **Метрики хранилища** — эта метрика показывает размер данных и использование индексов.

* **Метрики доступности** — эта метрика показывает процент успешных запросов по общему количеству запросов в час. Частота успеха определяется Azure Cosmos DB соглашения об уровне обслуживания.

* **Метрики задержки** — эта метрика показывает задержку чтения и записи, наблюдаемую Azure Cosmos DB в регионе, где работает ваша учетная запись. Вы можете визуализировать задержку для геореплицированной учетной записи в разных регионах. Эта метрика не представляет собой задержку сквозного запроса.

* **Метрики согласованности** — эта метрика показывает, насколько в конечном итоге используется согласованность для выбранной модели согласованности. Для учетных записей в нескольких регионах эта метрика также показывает задержку репликации между выбранными регионами.

* **Системные метрики** . Эта метрика показывает количество запросов к метаданным, обслуживаемых основным разделом. Он также помогает выявление регулируемых запросов.

В следующих разделах описаны распространенные сценарии, в которых можно использовать метрики Azure Cosmos DB. 

## <a name="understand-how-many-requests-are-succeeding-or-causing-errors"></a>Сведения о количестве успешных запросов и запросов, приводящих к ошибкам

Чтобы приступить к работе, перейдите на [портал Azure](https://portal.azure.com) и откройте колонку **Метрики**. В колонке найдите число запросов, превышающее емкость за 1 минуту. На этой диаграмме показано общее количество запросов за минуту, разбитых по коду состояния. Дополнительные сведения о кодах состояния HTTP см. в разделе [коды состояния HTTP для Azure Cosmos DB](/rest/api/cosmos-db/http-status-codes-for-cosmosdb).

Наиболее распространенный код состояния ошибки — 429 (ограничение скорости и регулирование). Эта ошибка означает, что запросы к Azure Cosmos DB превышают квоту подготовленной пропускной способности. Чтобы решить эту проблему, чаще всего следует [увеличить число единиц запроса](./set-throughput.md) определенной коллекции.

:::image type="content" source="media/use-metrics/metrics-12.png" alt-text="Число запросов в минуту":::

## <a name="determine-the-throughput-distribution-across-partitions"></a>Определение распределения пропускной способности по секциям

При использовании масштабируемого приложения важно иметь достаточное количество ключей секции. Чтобы определить распределение пропускной способности для любого секционированного контейнера, перейдите в колонку **Метрики** на [портале Azure](https://portal.azure.com). На вкладке **Пропускная способность** на диаграмме **Max consumed RU/second by each physical partition** (Максимальное число потребленных единиц запроса каждой физической секцией за секунду) отображаются показатели хранилища. На графике ниже приведен пример неравномерного распределения данных, о чем свидетельствует секция слева.

:::image type="content" source="media/use-metrics/metrics-17.png" alt-text="Использование одной секции для просмотра интенсивного использования":::

Неравномерное распределение пропускной способности может привести к образованию секций с *высокой нагрузкой*, из-за чего могут возникать отрегулированные запросы и может потребоваться повторное секционирование. Дополнительные сведения о секционировании в Azure Cosmos DB см. в [этой статье](./partitioning-overview.md).

## <a name="determine-the-storage-distribution-across-partitions"></a>Определение распределения ресурсов хранения по секциям

При использовании масштабируемого приложения важно иметь достаточное количество секций. Чтобы определить распределение ресурсов хранения для любого секционированного контейнера, перейдите в колонку "Метрики" на [портале Azure](https://portal.azure.com). На вкладке "Хранилище" сведения о ресурсах хранения отображаются в диаграмме "Объем хранилища данных и индекса, занятый ведущими ключами секций". На графике ниже приведено неравномерное распределение ресурсов хранения данных, о чем свидетельствует секция слева.

:::image type="content" source="media/use-metrics/metrics-07.png" alt-text="Пример неравномерного распределения данных":::

Чтобы определить, какой ключ секции искажает распределение, щелкните секцию на диаграмме.

:::image type="content" source="media/use-metrics/metrics-05.png" alt-text="Ключ секции, искажающий распределение":::

После определения ключа секции, искажающего распределение, вы можете повторно разбить контейнер с большим числом распределенных ключей секции. Дополнительные сведения о секционировании в Azure Cosmos DB см. в [этой статье](./partitioning-overview.md).

## <a name="compare-data-size-against-index-size"></a>Сравнение размера данных и размера индекса

В базе данных Azure Cosmos DB общий использованный объем хранилища зависит от размера данных и размера индекса. Обычно размер индекса — это часть объема данных. Дополнительные сведения см. в статье о [размере индекса](index-policy.md#index-size) . В колонке "Метрики" [портала Azure](https://portal.azure.com) на вкладке "Хранилище" можно просмотреть сведения о потреблении хранилища на основе данных и индекса.

```csharp
// Measure the document size usage (which includes the index size)  
ResourceResponse<DocumentCollection> collectionInfo = await client.ReadDocumentCollectionAsync(UriFactory.CreateDocumentCollectionUri("db", "coll"));
 Console.WriteLine("Document size quota: {0}, usage: {1}", collectionInfo.DocumentQuota, collectionInfo.DocumentUsage);
```

Чтобы сэкономить пространство индекса, вы можете настроить [политику индексирования](index-policy.md).

## <a name="debug-why-queries-are-running-slow"></a>Устранение причины медленного выполнения запросов

В пакетах SDK для API SQL можно просмотреть статистику выполнения запросов в базе данных Azure Cosmos DB.

```csharp
IDocumentQuery<dynamic> query = client.CreateDocumentQuery(
 UriFactory.CreateDocumentCollectionUri(DatabaseName, CollectionName),
 "SELECT * FROM c WHERE c.city = 'Seattle'",
 new FeedOptions
 {
 PopulateQueryMetrics = true,
 MaxItemCount = -1,
 MaxDegreeOfParallelism = -1,
 EnableCrossPartitionQuery = true
 }).AsDocumentQuery();
FeedResponse<dynamic> result = await query.ExecuteNextAsync();

// Returns metrics by partition key range Id
IReadOnlyDictionary<string, QueryMetrics> metrics = result.QueryMetrics;
```

Свойство *QueryMetrics* предоставляет подробные сведения о длительности выполнения каждого компонента запроса. Основная первопричина медленного выполнения запросов — сканирования. Это означает, что запрос не может использовать индексы. Эту проблему можно устранить, настроив оптимальное условие фильтра.

## <a name="next-steps"></a>Дальнейшие действия

Теперь вы знаете, как отслеживать и отлаживать неполадки с помощью метрик, предоставленных на портале Azure. Узнать больше о повышении производительности базы данных можно из следующих статей:

* Дополнительные сведения о просмотре метрик из Azure Monitor см. в статье [Получение метрик из Azure Monitor](./monitor-cosmos-db.md) . 
* [Проверка производительности и масштабирования с помощью Azure Cosmos DB](performance-testing.md)
* [Советы по повышению производительности для Azure Cosmos DB](performance-tips.md)