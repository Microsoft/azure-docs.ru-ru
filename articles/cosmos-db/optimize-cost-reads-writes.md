---
title: Оптимизация затрат на запросы в Azure Cosmos DB
description: В этой статье объясняется, как оптимизировать затраты при выдаче запросов на Azure Cosmos DB.
author: markjbrown
ms.author: mjbrown
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 10/14/2020
ms.openlocfilehash: 36ecef007e10f9a090dbabc8b5a91fd473930141
ms.sourcegitcommit: b572ce40f979ebfb75e1039b95cea7fce1a83452
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/11/2021
ms.locfileid: "102633858"
---
# <a name="optimize-request-cost-in-azure-cosmos-db"></a>Оптимизировать стоимость запросов в Azure Cosmos DB
[!INCLUDE[appliesto-all-apis](includes/appliesto-all-apis.md)]

В этой статье описывается, как запросы чтения и записи преобразуются в [единицы запросов](request-units.md) и оптимизируются затраты на эти запросы. Операции чтения включают чтение точек и запросы. Операции записи включают в себя вставку, замену, удаление и Upsert элементов.

Azure Cosmos DB предлагает обширный набор операций с базами данных, которые работают с элементами в контейнере. Затраты, связанные с каждой из этих операций, зависят от типа процессора, операций ввода-вывода и памяти, необходимой для завершения операции. Вместо того, чтобы думать об аппаратных ресурсах и управлении ими, можно представить единицу запроса (RU) как единую меру для ресурсов, необходимых для выполнения различных операций с базой данных для обслуживания запроса.

## <a name="measuring-the-ru-charge-of-a-request"></a>Измерение единиц оплаты для запроса

Важно измерять ЕДИНИЦу оплаты за запросы, чтобы понять их фактические затраты, а также оценить эффективность оптимизации. Вы можете получить эти затраты с помощью портал Azure или проверить ответ, полученный от Azure Cosmos DB, с помощью одного из пакетов SDK. Подробные инструкции о том, как добиться этого, см. [в разделе Поиск затрат единиц запросов в Azure Cosmos DB](find-request-unit-charge.md) .

## <a name="reading-data-point-reads-and-queries"></a>Чтение данных: чтение точек и запросы

Операции чтения в Azure Cosmos DB обычно упорядочиваются от самых быстрых и более эффективных к медленным и менее эффективным с точки зрения потребления единиц запросов.  

* Операции чтения точек (Поиск ключа и значения для одного идентификатора элемента и ключа секции).
* запрос с предложением фильтра в пределах одного ключа секции;
* запрос без условий равенства или диапазона для любого свойства;
* запрос без фильтров.

### <a name="role-of-the-consistency-level"></a>Роль уровня согласованности

При использовании [уровней согласованности](consistency-levels.md) **строгих** или **ограниченных устаревших** значений стоимость единиц операций чтения (точка чтения или запроса) удваивается.

### <a name="point-reads"></a>Операции чтения точек

Единственный фактор, который влияет на ЕДИНИЦу оплаты единицы чтения точки (кроме используемого уровня согласованности), — это размер извлекаемого элемента. В следующей таблице показана Цена за единицу операций чтения баллов для элементов размером в 1 КБ и 100 КБ.

| **Размер элемента** | **Стоимость одной точки чтения** |
| --- | --- |
| 1 КБ | 1 ЕЗ |
| 100 КБ | 10 ЕЗ |

Поскольку операции чтения с точками (уточняющие запросы "ключ — значение" на ИДЕНТИФИКАТОРе элемента) являются наиболее эффективным видом, следует убедиться, что идентификатор элемента имеет осмысленное значение, поэтому при возможности можно получить элементы с помощью точки Read (вместо запроса).

### <a name="queries"></a>Запросы

Количество единиц запроса, расходуемых на запрос, зависит от нескольких факторов. Например, число загруженных/возвращенных элементов Cosmos Azure, Количество уточняющих запросов по индексу, время компиляции запроса и т. д. подробные сведения. Azure Cosmos DB гарантирует, что один и тот же запрос к одним и тем же данным всегда будет иметь одинаковую стоимость в единицах запроса. Профиль запроса, полученный по метрикам выполнения запроса, дает хорошее представление о затратах единиц запроса.  

В некоторых случаях при постраничном выполнении запроса вы будете поочередно получать ответы 200 и 429 с разными затратами единиц запроса. Это связано с тем, что запросы всегда выполняются максимально быстро с учетом доступных единиц запроса. Вы можете заметить, что выполнение запроса предусматривает разбивку на несколько страниц или операций отправки и обработки данных между клиентом и сервером. Например, ответ, содержащий 10 000 элементов, может возвращаться на нескольких страницах, стоимость каждой из которых будет зависеть от объема вычислений, выполненных для этой страницы. Просуммировав стоимость таких страниц, вы получите точно такое же количество единиц запроса, как и при выполнении всего запроса сразу.

#### <a name="metrics-for-troubleshooting-queries"></a>Метрики для устранения неполадок запросов

Производительность и пропускная способность, потребляемая запросами (включая определяемые пользователем функции), в основном зависят от тела функции. Самый простой способ узнать, сколько времени выполнения запроса находится в определяемой пользователем функции, а также сколько используется метод RUs, — включить метрики запроса. Если вы используете пакет SDK для .NET, ниже приведены примеры метрик запросов, возвращаемых пакетом SDK.

```bash
Retrieved Document Count                 :               1              
Retrieved Document Size                  :           9,963 bytes        
Output Document Count                    :               1              
Output Document Size                     :          10,012 bytes        
Index Utilization                        :          100.00 %            
Total Query Execution Time               :            0.48 milliseconds 
  Query Preparation Times 
    Query Compilation Time               :            0.07 milliseconds 
    Logical Plan Build Time              :            0.03 milliseconds 
    Physical Plan Build Time             :            0.05 milliseconds 
    Query Optimization Time              :            0.00 milliseconds 
  Index Lookup Time                      :            0.06 milliseconds 
  Document Load Time                     :            0.03 milliseconds 
  Runtime Execution Times 
    Query Engine Execution Time          :            0.03 milliseconds 
    System Function Execution Time       :            0.00 milliseconds 
    User-defined Function Execution Time :            0.00 milliseconds 
  Document Write Time                    :            0.00 milliseconds 
  Client Side Metrics 
    Retry Count                          :               1              
    Request Charge                       :            3.19 RUs  
```

#### <a name="best-practices-to-cost-optimize-queries"></a>Рекомендации по оптимизации затрат на запросы 

При оптимизации стоимости запросов постарайтесь учесть следующие рекомендации:

* **Размещайте разные типы сущностей вместе**

   Постарайтесь разместить все разные типы сущностей в одном контейнере, или хотя бы уменьшить количество контейнеров. Этот метод позволяет не только снизить стоимость, но и ускорить выполнение запросов и транзакций. Запросы выполняются в пределах одного контейнера, а атомарные транзакции к многочисленным записям с использованием хранимых процедур и триггеров выполняются в пределах одного ключа секции в одном контейнере. Совместное размещение сущностей в одном контейнере позволяет снизить количество сетевых запросов для обработки связей между записями. Благодаря этому повышается общая производительность, поддерживаются атомарные транзакции к множеству записей в крупном наборе данных, и, соответственно, снижаются расходы. Если в вашем сценарии сложно разместить все типы сущностей в одном контейнере или снизить количество контейнеров, попробуйте повысить предоставляемую производительность на уровне базы данных. Чаще всего такая ситуация возникает при невозможности или нежелании вносить изменения в код при переносе существующего приложения.  

* **Измерение и настройка расхода единиц запроса/повторного использования**

   Сложность запроса влияет на количество единиц запроса, потребляемых операцией. Количество предикатов и их характер, количество определяемых пользователем функций и размер набора исходных данных. Все эти факторы влияют на стоимость операций запросов. 

Azure Cosmos DB обеспечивает прогнозируемую производительность с точки зрения пропускной способности и задержки, используя подготовленную модель пропускной способности. Подготовленная пропускная способность выражается в [единицах запросов](request-units.md) в секунду. Единицы запроса (ЕЗ) представляют собой логическую абстракцию определенного набора вычислительных ресурсов, в том числе ЦП, памяти и устройств ввода-вывода, необходимых для выполнения запроса. Подготовленная пропускная способность резервирует определенное количество ЕЗ для вашего контейнера или базы данных, что позволяет гарантировать предсказуемые значения пропускной способности и задержки. Подготовленная пропускная способность позволяет Azure Cosmos DB обеспечить стабильную и предсказуемую производительность, гарантировать низкую задержку и высокий уровень доступности в любом масштабе. Единицы запроса выполняют роль нормализованной "валюты", которая упрощает принятие решений о выделении ресурсов приложению.

Стоимость запроса, возвращаемая в заголовке ответа, обозначает стоимость конкретного запроса. Например, если запрос возвращает 1000 элементов по 1 КБ, на эту операцию расходуется 1000 единиц запроса. Таким образом, перед ограничением частоты выполнения последующих запросов сервер за одну секунду выполняет только два таких запроса. Чтобы узнать больше, просмотрите статью о [единицах запроса](request-units.md) и ознакомьтесь с калькулятором единиц запроса.

## <a name="writing-data"></a>Запись данных

Затраты на ЕДИНИЦу записи элемента зависят от:

- Размер элемента.
- Количество свойств, охваченных [политикой индексирования](index-policy.md) и необходимое для индексирования.

Вставка элемента размером 1 КБ без индексирования около ~ 5,5 RUs. При замене затрат на номенклатуру в два раза взимается плата, необходимая для вставки одного и того же элемента.

### <a name="optimizing-writes"></a>Оптимизация операций записи

Лучшим способом оптимизации стоимости операций записи в секунду является подобрать правильный размер элементов и количество индексированных свойств.

- Хранение очень больших элементов в Azure Cosmos DB приводит к высокой оплате единиц запросов и может рассматриваться как антишаблонный. В частности, не храните двоичное содержимое или большие фрагменты текста, которые не должны запрашиваться. Рекомендуется размещать этот тип данных в [хранилище BLOB-объектов Azure](../storage/blobs/storage-blobs-introduction.md) и хранить ссылку (или ссылку) на большой двоичный объект в элементе, который вы пишете в Azure Cosmos DB.
- Оптимизация политики индексирования для индексации только тех свойств, которые фильтруются по запросам, может значительно отличаться в версии-получателей, используемой операциями записи. При создании нового контейнера политика индексирования по умолчанию индексирует каждый и все свойства, найденные в элементах. Хотя это хороший вариант по умолчанию для действий разработки, настоятельно рекомендуется повторно оценить и [настроить политику индексирования](how-to-manage-indexing-policy.md) при переходе в рабочую среду или когда Рабочая нагрузка начнет принимать значительный трафик.

При выполнении массового приема данных также рекомендуется использовать [библиотеку массового исполнителя Azure Cosmos DB](bulk-executor-overview.md) , так как она предназначена для оптимизации использования единиц запросов в секунду. При необходимости можно также использовать [фабрику данных Azure](../data-factory/introduction.md) , которая построена на той же библиотеке.

## <a name="next-steps"></a>Дальнейшие действия

Теперь вы можете перейти к изучению оптимизации затрат в Azure Cosmos DB в следующих статьях:

* Дополнительные сведения об [оптимизации для разработки и тестирования](optimize-dev-test.md)
* Дополнительные сведения о [расшифровке счета Azure Cosmos DB](understand-your-bill.md)
* Дополнительные сведения об [оптимизации расходов на пропускную способность](optimize-cost-throughput.md)
* Дополнительные сведения об [оптимизации расходов на хранилище](optimize-cost-storage.md)
* Дополнительные сведения об [оптимизации расходов на учетные записи Cosmos Azure с поддержкой нескольких регионов](optimize-cost-regions.md)
* Дополнительные сведения о [Azure Cosmos DB зарезервированной емкости](cosmos-db-reserved-capacity.md)
