---
title: Сведения о защите доступа к данным в Azure Cosmos DB
description: Сведения о концепциях управления доступом в Azure Cosmos DB, включая первичные ключи, ключи только для чтения, пользователей и разрешения.
author: thomasweiss
ms.author: thweiss
ms.service: cosmos-db
ms.subservice: cosmosdb-sql
ms.topic: conceptual
ms.date: 02/11/2021
ms.custom: devx-track-csharp
ms.openlocfilehash: 8a16ecd2ee6ed939b2afd0e51e9cf531e419c8af
ms.sourcegitcommit: b4647f06c0953435af3cb24baaf6d15a5a761a9c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/02/2021
ms.locfileid: "101656403"
---
# <a name="secure-access-to-data-in-azure-cosmos-db"></a>Защита доступа к данным в Azure Cosmos DB
[!INCLUDE[appliesto-sql-api](includes/appliesto-sql-api.md)]

В этой статье приводятся общие сведения об управлении доступом к данным в Azure Cosmos DB.

Azure Cosmos DB предоставляет три способа управления доступом к данным.

| Тип контроля доступа | Характеристики |
|---|---|
| [Первичные ключи](#primary-keys) | Общий секрет, который позволяет выполнять любые операции управления или работы с данными. Он предоставляется как для чтения, так и для чтения и записи. |
| [Управление доступом на основе ролей](#rbac) (Предварительная версия) | Детализированная модель разрешений на основе ролей, использующая удостоверения Azure Active Directory (AAD) для проверки подлинности. |
| [Маркеры ресурсов](#resource-tokens)| Детализированная модель разрешений на основе собственных Azure Cosmos DB пользователей и разрешений. |

## <a name="primary-keys"></a><a id="primary-keys"></a> Первичные ключи

Первичные ключи предоставляют доступ ко всем административным ресурсам учетной записи базы данных. Каждая учетная запись состоит из двух первичных ключей: первичного ключа и вторичного ключа. Двойные ключи позволяют повторно создавать или изменять ключи, обеспечивая постоянный доступ к вашей учетной записи и данным. Дополнительные сведения о первичных ключах см. в статье [безопасность базы данных](database-security.md#primary-keys) .

### <a name="key-rotation"></a><a id="key-rotation"></a> Смена ключа

Процесс поворота первичного ключа прост. 

1. Перейдите к портал Azure, чтобы получить вторичный ключ.
2. Замените первичный ключ вторичным ключом в приложении. Убедитесь, что все клиенты Cosmos DB для всех развертываний быстро перезапускаются и начнут использовать обновленный ключ.
3. Поворачивайте первичный ключ в портал Azure.
4. Проверка того, что новый первичный ключ работает для всех ресурсов. Процесс смены ключа может занять от минуты до нескольких часов в зависимости от размера учетной записи Cosmos DB.
5. Замените вторичный ключ новым первичным ключом.

:::image type="content" source="./media/secure-access-to-data/nosql-database-security-master-key-rotate-workflow.png" alt-text="Смена первичного ключа в портал Azure — демонстрация безопасности базы данных NoSQL" border="false":::

### <a name="code-sample-to-use-a-primary-key"></a>Пример кода для использования первичного ключа

В следующем примере кода показано, как использовать конечную точку учетной записи Cosmos DB и первичный ключ для создания экземпляра DocumentClient и создания базы данных.

```csharp
//Read the Azure Cosmos DB endpointUrl and authorization keys from config.
//These values are available from the Azure portal on the Azure Cosmos DB account blade under "Keys".
//Keep these values in a safe and secure location. Together they provide Administrative access to your Azure Cosmos DB account.

private static readonly string endpointUrl = ConfigurationManager.AppSettings["EndPointUrl"];
private static readonly string authorizationKey = ConfigurationManager.AppSettings["AuthorizationKey"];

CosmosClient client = new CosmosClient(endpointUrl, authorizationKey);
```

В следующем примере кода показано, как использовать конечную точку учетной записи Azure Cosmos DB и первичный ключ для создания экземпляра `CosmosClient` объекта.

:::code language="python" source="~/cosmosdb-python-sdk/sdk/cosmos/azure-cosmos/samples/access_cosmos_with_resource_token.py" id="configureConnectivity":::

## <a name="role-based-access-control-preview"></a><a id="rbac"></a> Управление доступом на основе ролей (Предварительная версия)

Azure Cosmos DB предоставляет встроенную систему управления доступом на основе ролей (RBAC), которая позволяет:

- Проверка подлинности запросов к данным с помощью удостоверения Azure Active Directory (AAD).
- Авторизация запросов данных с помощью детализированной модели разрешений на основе ролей.

Azure Cosmos DB RBAC — идеальный метод контроля доступа в ситуациях, когда:

- Вы не хотите использовать общий секрет, такой как первичный ключ, и предпочитаете полагаться на механизм проверки подлинности на основе маркеров,
- Вы хотите использовать удостоверения Azure AD для проверки подлинности запросов,
- Чтобы жестко ограничить операции с базами данных, разрешенные для выполнения удостоверений, необходима детализированная модель разрешений.
- Вы хотите материализовать политики контроля доступа как "роли", которые можно назначить нескольким удостоверениям.

Дополнительные сведения о Azure Cosmos DB RBAC см. в статье [Настройка управления доступом на основе ролей для учетной записи Azure Cosmos DB](how-to-setup-rbac.md) .

## <a name="resource-tokens"></a><a id="resource-tokens"></a> Маркеры ресурсов

Маркеры ресурсов предоставляют доступ к ресурсам приложения в базе данных. Маркеры ресурсов.

- предоставляют доступ к определенным контейнерам, ключам секции, документам, вложениям, хранимым процедурам, триггерам и определяемым пользователем функциям (UDF);
- создаются, когда [пользователю](#users) предоставляются [разрешения](#permissions) на доступ к определенному ресурсу;
- создаются повторно, когда в отношении ресурса разрешения выполняется вызов POST, GET или PUT;
- используют хэш, который маркер ресурса специально создал для пользователя, ресурса и разрешения;
- имеют ограничение по времени (настраиваемый срок действия). Допустимый интервал времени по умолчанию составляет один час. Однако продолжительность действия маркера можно задать явным образом. Ее значение не должно превышать пять часов;
- Укажите надежную альтернативу для предоставления первичного ключа.
- позволяют клиентам читать, записывать и удалять ресурсы в учетной записи Cosmos DB в соответствии с предоставленными им разрешениями.

Маркер ресурса (путем создания Cosmos DB пользователей и разрешений) можно использовать, если требуется предоставить доступ к ресурсам в учетной записи Cosmos DB клиенту, который не может быть доверенным с первичным ключом.  

Маркеры ресурсов Cosmos DB предоставляют надежную альтернативу, позволяющую клиентам читать, записывать и удалять ресурсы в учетной записи Cosmos DB в соответствии с предоставленными разрешениями и без необходимости в первичном или доступном только для чтения ключе.

Ниже приведена стандартная схема запроса, создания и отправки маркеров ресурсов клиентам.

1. Служба среднего уровня настроена для обслуживания мобильного приложения по обмену фотографиями.
2. Служба среднего уровня владеет первичным ключом учетной записи Cosmos DB.
3. Приложение по обмену фотографиями устанавливается на мобильных устройствах конечных пользователей.
4. При входе в систему приложение для обмена фотографиями идентифицирует пользователя службы. Механизм установления личности пользователя реализуется исключительно в приложении.
5. После установления личности служба среднего уровня запрашивает разрешения на основе удостоверения.
6. Служба среднего уровня отправляет маркер ресурса обратно в приложение для телефона.
7. Приложение может по-прежнему использовать маркер ресурса для прямого доступа к ресурсам Cosmos DB с разрешениями, определенными маркером, и в течение интервала времени, разрешенного этим маркером.
8. По истечении срока действия маркера ресурса последующие запросы получают исключение: 401 — не авторизовано.  На этом этапе приложение для телефона повторно установит личность и запросит новый маркер ресурса.

    :::image type="content" source="./media/secure-access-to-data/resourcekeyworkflow.png" alt-text="Рабочий процесс маркеров ресурсов Azure Cosmos DB" border="false":::

Создание и управление маркерами ресурсов осуществляется с помощью собственных клиентских библиотек Cosmos DB; Однако при использовании RESTFUL необходимо создать заголовки запросов и аутентификации. Дополнительные сведения о создании заголовков проверки подлинности для RESTFUL см. в статье [Управление доступом к Cosmos DB ресурсам](/rest/api/cosmos-db/access-control-on-cosmosdb-resources) или исходный код [пакета SDK для .NET](https://github.com/Azure/azure-cosmos-dotnet-v3/blob/master/Microsoft.Azure.Cosmos/src/Authorization/AuthorizationHelper.cs) или [ пакета SDK дляNode.js](https://github.com/Azure/azure-cosmos-js/blob/master/src/auth.ts).

Пример службы среднего уровня, используемой для создания маркеров ресурсов или в качестве брокера, см. в [репозитории приложения ResourceTokenBroker](https://github.com/Azure/azure-cosmos-dotnet-v2/tree/master/samples/xamarin/UserItems/ResourceTokenBroker/ResourceTokenBroker/Controllers).

### <a name="users"></a>Пользователи<a id="users"></a>

Azure Cosmos DB пользователи связаны с базой данных Cosmos.  Каждая база данных может содержать несколько пользователей Cosmos DB или не содержать ни одного. В следующем примере кода показано, как создать Cosmos DB пользователя с помощью [пакета SDK для Azure Cosmos DB .NET v3](https://github.com/Azure/azure-cosmos-dotnet-v3/tree/master/Microsoft.Azure.Cosmos.Samples/Usage/UserManagement).

```csharp
//Create a user.
Database database = benchmark.client.GetDatabase("SalesDatabase");

User user = await database.CreateUserAsync("User 1");
```

> [!NOTE]
> Каждый Cosmos DB пользователь имеет метод ReadAsync (), который можно использовать для получения списка [разрешений](#permissions) , связанных с пользователем.

### <a name="permissions"></a>Разрешения<a id="permissions"></a>

Ресурс разрешения связывается с пользователем и назначается в контейнере, а также на уровне ключа секции. Каждый пользователь может содержать не более одного разрешения. Ресурс разрешения предоставляет доступ к маркеру безопасности, который необходим пользователю при попытке доступа к определенному контейнеру или данным в указанном ключе секции. Существует два уровня доступа, предоставляемых ресурсом разрешения:

- Все. Пользователь имеет полный набор разрешений для ресурса.
- Чтение. Пользователь может только считывать содержимое ресурса, но не может выполнять на ресурсе операции записи, обновления или удаления.

> [!NOTE]
> Для выполнения хранимых процедур пользователь должен иметь разрешение ALL на контейнер, в котором будет выполняться хранимая процедура.

Если включить [журналы диагностики в запросах плоскости данных](cosmosdb-monitor-resource-logs.md), регистрируются следующие два свойства, соответствующие этому разрешению:

* **ресаурцетокенпермиссионид** — это свойство указывает идентификатор разрешения маркера ресурса, который вы указали. 

* **ресаурцетокенпермиссионмоде** — это свойство указывает режим разрешений, заданный при создании маркера ресурса. Режим разрешения может иметь такие значения, как "все" или "чтение".

#### <a name="code-sample-to-create-permission"></a>Пример кода для создания разрешения

В следующем примере кода показано, как создать ресурс разрешения, прочесть его маркер и связать разрешения с созданным выше [пользователем](#users).

```csharp
// Create a permission on a container and specific partition key value
Container container = client.GetContainer("SalesDatabase", "OrdersContainer");
user.CreatePermissionAsync(
    new PermissionProperties(
        id: "permissionUser1Orders",
        permissionMode: PermissionMode.All,
        container: benchmark.container,
        resourcePartitionKey: new PartitionKey("012345")));
```

#### <a name="code-sample-to-read-permission-for-user"></a>Пример кода для разрешения на чтение для пользователя

В следующем фрагменте кода показано, как получить разрешение, связанное с созданным ранее пользователем, и создать экземпляр нового Космосклиент от имени пользователя с областью действия с одним ключом секции.

```csharp
//Read a permission, create user client session.
PermissionProperties permissionProperties = await user.GetPermission("permissionUser1Orders")

CosmosClient client = new CosmosClient(accountEndpoint: "MyEndpoint", authKeyOrResourceToken: permissionProperties.Token);
```

## <a name="differences-between-rbac-and-resource-tokens"></a>Различия между RBAC и маркерами ресурсов

| Тема | RBAC | Маркеры ресурсов |
|--|--|--|
| Аутентификация  | С Azure Active Directory (Azure AD). | На основе собственных Azure Cosmos DB пользователей<br>Интеграция маркеров ресурсов в Azure AD требует дополнительной работы для моста удостоверений Azure AD и Azure Cosmos DB пользователей. |
| Авторизация | На основе ролей: определения ролей сопоставляют разрешенные действия и могут быть назначены нескольким удостоверениям. | На основе разрешений. для каждого Azure Cosmos DB пользователя необходимо назначить разрешения на доступ к данным. |
| Область действия токена | Токен AAD передает удостоверение инициатора запроса. Это удостоверение сопоставляется со всеми назначенными определениями ролей для выполнения авторизации. | Маркер ресурса передает разрешение, предоставленное конкретному Azure Cosmos DB пользователю, на конкретный ресурс Azure Cosmos DB. Для запросов авторизации в разных ресурсах могут потребоваться разные токены. |
| Обновление токена | Токен AAD автоматически обновляется Azure Cosmos DB пакеты SDK по истечении срока действия. | Обновление токена ресурса не поддерживается. По истечении срока действия маркера ресурса должен быть выдан новый. |

## <a name="add-users-and-assign-roles"></a>Добавление пользователей и назначение ролей

Чтобы добавить доступ с правами читателя учетной записи Azure Cosmos DB в пользовательскую учетную запись, владельцу подписки необходимо сделать следующее на портале Azure.

1. Откройте портал Azure и выберите учетную запись Azure Cosmos DB.
2. Щелкните вкладку **Управление доступом (IAM)**, а затем — **+ Добавить назначение ролей**.
3. На вкладке **Добавить назначение ролей** в поле **Роль** выберите **Роль читателя учетных записей Cosmos DB**.
4. В **поле назначить доступ к** выберите **пользователь, группа или приложение Azure AD**.
5. В каталоге выберите пользователя, группу или приложение, которым нужно предоставить доступ.  Каталог можно искать по отображаемому имени, адресу электронной почты или идентификатору объектов.
    Выбранный пользователь, группа или приложение появятся в списке выбранных участников.
6. Выберите команду **Сохранить**.

Теперь сущность может считывать ресурсы Azure Cosmos DB.

## <a name="delete-or-export-user-data"></a>Удаление и экспорт сведений о пользователях

В качестве службы базы данных Azure Cosmos DB позволяет искать, выбирать, изменять и удалять любые данные, расположенные в базе данных или контейнерах. Однако вы несете ответственность за использование предоставляемых API и определение логики, необходимой для поиска и удаления персональных данных при необходимости. Каждый Многомодельный API (SQL, MongoDB, Gremlin, Cassandra, таблица) предоставляет разные языковые пакеты SDK, содержащие методы для поиска и удаления данных на основе настраиваемых предикатов. Вы также можете включить функцию [срока жизни (TTL)](time-to-live.md) для автоматического удаления данных по истечении указанного периода времени без дополнительных затрат.

[!INCLUDE [GDPR-related guidance](../../includes/gdpr-dsr-and-stp-note.md)]

## <a name="next-steps"></a>Дальнейшие действия

- Дополнительные сведения о безопасности базы данных Cosmos см. в разделе [Cosmos DB безопасность базы данных](database-security.md).
- Сведения о создании маркеров проверки подлинности Azure Cosmos DB см. в статье [Access control in the DocumentDB API](/rest/api/cosmos-db/access-control-on-cosmosdb-resources) (Управление доступом в API DocumentDB).
- Примеры управления пользователями с пользователями и разрешениями: [примеры управления пользователями для .NET SDK v3](https://github.com/Azure/azure-cosmos-dotnet-v3/blob/master/Microsoft.Azure.Cosmos.Samples/Usage/UserManagement/UserManagementProgram.cs)
