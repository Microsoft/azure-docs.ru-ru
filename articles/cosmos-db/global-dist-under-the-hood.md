---
title: Глобальное распределение в Azure Cosmos DB — взгляд изнутри
description: Эта статья содержит технические сведения, относящиеся к глобальному распределению Azure Cosmos DB
author: SnehaGunda
ms.service: cosmos-db
ms.topic: conceptual
ms.date: 07/02/2020
ms.author: sngun
ms.reviewer: sngun
ms.openlocfilehash: 1b47ad27abbe59eceabd15d091f88f4659d8dad6
ms.sourcegitcommit: 8d1b97c3777684bd98f2cfbc9d440b1299a02e8f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/09/2021
ms.locfileid: "102486392"
---
# <a name="global-data-distribution-with-azure-cosmos-db---under-the-hood"></a>Глобальное распределение данных в Azure Cosmos DB — взгляд изнутри
[!INCLUDE[appliesto-all-apis](includes/appliesto-all-apis.md)]

Azure Cosmos DB — это базовая служба в Azure, поэтому она развертывается во всех регионах Azure по всему миру, включая общедоступные, независимых, отделы обороны и государственные облака. В центре обработки данных мы развертываем службу Azure Cosmos DB и управляем ей на больших метках машин, каждая из которых имеет выделенное локальное хранилище. В центре обработки данных Azure Cosmos DB развертывается во многих кластерах, каждый из которых потенциально запускает несколько поколений оборудования. Компьютеры в кластере обычно распределяются между доменами сбоя 10-20 для обеспечения высокой доступности в пределах региона. На следующем рисунке показана топология системы к использованию глобального распределения Cosmos DB.

:::image type="content" source="./media/global-dist-under-the-hood/distributed-system-topology.png" alt-text="Топология системы" border="false":::

**Глобальное распределение в Azure Cosmos DB работает:** В любое время, несколько щелчков мыши или программно с одним вызовом API, можно добавить или удалить географические регионы, связанные с базой данных Cosmos. База данных Cosmos, в свою очередь, состоит из набора контейнеров Cosmos. В Cosmos DB контейнеры служат в качестве логических единиц распределения и масштабируемости. Коллекции, таблицы и диаграммы, которые вы создаете, являются (изнутри) просто контейнерами Cosmos. Контейнеры полностью не зависят от схемы и предоставляют область для запроса. Данные в контейнере Cosmos автоматически индексируются после приема. Автоматическое индексирование позволяет пользователям запрашивать данные без трудностей с управлением схемой или индексами, особенно в глобально распределенной настройке.  

- В заданном регионе данные в контейнере распределяются с помощью ключа секции, который предоставляется и прозрачно управляется базовыми физическими секциями (*Локальное распределение*).  

- Каждая физическая Секция также реплицируется по географическим регионам (*глобальное распределение*). 

Когда приложение, использующее Cosmos DB эластично масштабирует пропускную способность в контейнере Cosmos или потребляет больше места, Cosmos DB прозрачно обрабатывает операции управления секциями (разбиение, клонирование, удаление) во всех регионах. Независимо от масштабирования, распределения или ошибок, Cosmos DB предоставляет один образ системы данных в контейнерах, которые распределены по всему миру в любом количестве регионов.  

Как показано на следующем рисунке, данные в контейнере распределяются по двум измерениям — в пределах региона и в разных регионах:  

:::image type="content" source="./media/global-dist-under-the-hood/distribution-of-resource-partitions.png" alt-text="Физические секции" border="false":::

Физическая Секция реализуется группой реплик, которая называется *набором реплик*. На каждом компьютере размещаются сотни реплик, которые соответствуют различным физическим секциям в фиксированном наборе процессов, как показано на рисунке выше. Реплики, соответствующие физическим секциям, динамически размещаются и распределяют нагрузки между машинами в кластере и центрах обработки данных в пределах региона.  

Реплика однозначно принадлежит клиенту Azure Cosmos DB. Каждая реплика содержит экземпляр [ядра СУБД](https://www.vldb.org/pvldb/vol8/p1668-shukla.pdf) Cosmos DB, который управляет ресурсами, а также соответствующими индексами. Ядро СУБД Cosmos работает в системе типов на основе Atom-Record-Sequence (ARS). Ядро не зависит от концепции схемы, размытием границы между значениями структуры и экземпляра записей. База данных Cosmos DB обеспечивает полную независимость от схемы, автоматически индексируя все при приеме эффективным образом, что позволяет пользователям запрашивать свои глобально распределенные данные без необходимости управлять схемой или индексом.

Ядро СУБД Cosmos состоит из компонентов, включая реализацию нескольких примитивов координации, языковых сред выполнения, обработчик запросов, а также подсистемы хранения и индексирования, отвечающие за хранение транзакций и индексирование данных соответственно. Чтобы обеспечить устойчивость и высокую доступность, ядро СУБД сохраняет свои данные и индексы на дисках SSD и реплицирует их среди экземпляров ядра СУБД в наборах реплик соответственно. Более крупные клиенты соответствуют более высокому масштабу пропускной способности и хранилища и имеют либо больше, либо больше реплик или оба. Каждый компонент системы полностью асинхронен — ни один поток никогда не блокирует другой, и каждый поток работает кратковременно без каких-либо ненужных переключателей потоков. Ограничение скорости и обратной реакции передаются по всему стеку из контроля допуском на все каналы ввода-вывода. Ядро СУБД Cosmos предназначено для использования детализированного параллелизма и обеспечения высокой пропускной способности при работе в фругал объемах системных ресурсов.

Глобальное распределение Cosmos DB зависит от двух ключевых абстракций — *наборов реплик* и *наборов секций*. Набор реплик представляет собой модульный блок "Лего" для координации, а набор секций — это динамическое наложение одного или нескольких географически распределенных физических секций. Чтобы понять, как работает глобальное распределение, необходимо понимать эти две ключевые абстракции. 

## <a name="replica-sets"></a>Наборы реплик

Физическая секция, которая материализуется как самоуправляемая и динамически сбалансированная по нагрузке группа реплик, распределенная между несколькими доменами сбоя, называется набором реплик. Этот набор совместно реализует протокол реплицированного состояния машины, чтобы сделать данные в физической секции доступными, устойчивыми и согласованными. Членство в наборе реплик *N* является динамическим: оно обеспечивает колебания между *nмин.* и *nмакс.* в зависимости от сбоев, административных операций и времени, в течение которого реплики со сбоями могут повторно создавать или восстанавливаться. Исходя из изменений членства, протокол репликации также перенастраивает размер кворумов чтения и записи. Для равномерного распределения пропускной способности, назначенной данной физической секции, мы применяете две идеи: 

- Во-первых, затраты на обработку запросов на запись в лидере выше, чем затраты на применение обновлений в последующих версиях. Соответственно, лидеру предусмотрено больше системных ресурсов, чем подписчику. 

- Во-вторых, насколько это возможно, кворум чтения для заданного уровня согласованности состоит исключительно из реплик подписчиков. Мы избегаем контакта с лидером для выполнения операций чтения, если этого не требуется. Мы приучились к исследованиям, связанным с [нагрузкой и емкостью](https://www.cs.utexas.edu/~lorenzo/corsi/cs395t/04S/notes/naor98load.pdf) в системах на основе кворума, для [пяти моделей согласованности](consistency-levels.md) , которые Cosmos DB поддерживаются.  

## <a name="partition-sets"></a>Наборы секций

Группа физических секций, одна из которых настроена с использованием регионов базы данных Cosmos, состоит в управлении тем же набором ключей, которые реплицируются по всем настроенным регионам. Этот более высокий примитив координации называется *набором разделов* — географически распределенным динамическим перекрытием физических секций, управляющих заданным набором ключей. Хотя данная физическая секция (набор реплик) ограничивается в пределах кластера, набор секций может охватывать кластеры, центры обработки данных и географические регионы, как показано на рисунке ниже.  

:::image type="content" source="./media/global-dist-under-the-hood/dynamic-overlay-of-resource-partitions.png" alt-text="Наборы секций" border="false":::

Набор секций можно считать географически распределенным "супернабором реплик", который состоит из нескольких наборов реплик, обладающих тем же набором ключей. Как и в случае с набором реплик, членство в наборе секций также является динамическим: оно не зависит от неявных операций по управлению физическими секциями для добавления или удаления новых секций в заданном наборе разделов (например, при масштабировании пропускной способности в контейнере, добавлении или удалении региона в базе данных Cosmos или при возникновении сбоев). После того, как каждая из секций (набора разделов) управляет членством в наборе секций в пределах собственной реплики, членство полностью децентрализовано и высоко доступно. Во время перенастройки набора секций также устанавливается топология наложения между физическими секциями. Топология выбирается динамически в зависимости от уровня согласованности, географического расстояния и доступной пропускной способности сети между исходной и целевой физическими секциями.  

Служба позволяет настроить базы данных Cosmos либо с одним регистром записи, либо с несколькими регионами записи, и в зависимости от выбора наборы секций настроены так, чтобы принимать записи в только одном или во всех регионах. Система использует двухуровневый протокол на основе консенсуса — один уровень работает в репликах набора реплик физической секции, принимая записи, а другой работает на уровне набора секций, чтобы обеспечить полные гарантии упорядочения для всех зафиксированных записей в наборе секций. Этот многоуровневый вложенный консенсус имеет решающее значение для реализации наших строгих соглашений об уровне обслуживания для обеспечения высокой доступности, а также для реализации моделей согласованности, которые предлагает Cosmos DB своим клиентам.  

## <a name="conflict-resolution"></a>Устранение конфликтов

Наша разработка для распространения обновлений, разрешения конфликтов и отслеживания причинности основана на предыдущей работе над [алгоритмами эпидемии](https://www.cs.utexas.edu/~lorenzo/corsi/cs395t/04S/notes/naor98load.pdf) и системой [Bayou](https://zoo.cs.yale.edu/classes/cs422/2013/bib/terry95managing.pdf). Хотя ядра идей сохранились и предоставляют удобную систему отсчета для создания структуры системы Cosmos DB, они также значительно изменились, когда их применяли к системе Cosmos DB. Это было необходимо, поскольку предыдущие системы разрабатывались не с помощью управления ресурсами, а с масштабом, на котором Cosmos DB должны выполняться, и не предоставлять возможности (например, согласованность с ограниченной устойчивостью) и жесткие и комплексные соглашения об уровне обслуживания, которые Cosmos DB доставляются своим клиентам.  

Помните, что набор секций распределяется по нескольким регионам и соответствует протоколу репликации Cosmos баз данных (несколько регионов) для репликации данных между физическими секциями, состоящими из заданного набора разделов. Каждая физическая секция (из набора секций) принимает записи и обычно служит для чтения клиентам из этого региона. Записи, принятые физической секцией в регионе, надежно зафиксированы и сделаны высокодоступными в пределах физической секции, прежде чем быть подтвержденными для клиента. Эти предварительные записи распространяются на другие физические секции в наборе секций с помощью канала защиты от энтропии. Клиенты могут запрашивать либо предварительные, либо зафиксированные записи путем передачи заголовка запроса. Распространение защиты от энтропии (включая частоту распространения) является динамическим, основанным на топологии набора секций, региональной близости физических секций и настроенном уровне согласованности. В наборе секций Cosmos DB следует первичной схеме фиксации с динамически выбранной секцией арбитра. Выбор арбитра динамический. Он является неотъемлемой частью перенастройки набора секций на основе топологии наложения. Заказы зафиксированных записей (включая многострочные или пакетные обновления) гарантируются. 

Мы используем закодированные векторные часы (содержащие идентификатор региона и логические часы, соответствующие каждому уровню консенсуса в наборе реплик и наборе секций соответственно) для отслеживания причинно-следственных связей и версий векторов, чтобы обнаружить и разрешить конфликты обновления. Топология и алгоритм выбора одноранговых узлов предназначены для обеспечения фиксированного и минимального хранения и минимальных нагрузок на сеть версий векторов. Алгоритм гарантирует строгое свойство конвергенции.  

Для баз данных Cosmos, настроенных с несколькими регионами записи, система предлагает ряд гибких политик автоматического разрешения конфликтов для разработчиков на выбор, включая следующие. 

- **Last-Write-WINS (лвв)**, который по умолчанию использует определенное системой свойство timestamp (основанное на часовом протоколе синхронизации времени). Cosmos DB также позволяет указать любое другое пользовательское числовое свойство, которое будет использоваться для разрешения конфликтов.  
- **Определяемая приложением (настраиваемая) политика разрешения конфликтов** (выраженная в процедурах слияния), предназначенная для выверки конфликтов с семантикой, определяемой приложением. Эти процедуры вызываются при обнаружении конфликтов "запись — запись" во время обработки транзакции в базе данных на стороне сервера. Система обеспечивает ровно одну гарантию выполнения процедуры слияния в рамках протокола обязательств. Существует [несколько примеров разрешения конфликтов](how-to-manage-conflicts.md) , которые можно использовать для воспроизведения.  

## <a name="consistency-models"></a>Модели согласованности

Независимо от того, настроена ли база данных Cosmos с одним или несколькими регионами записи, можно выбрать одну из пяти четко определенных моделей согласованности. В нескольких регионах записи ниже приведены некоторые важные аспекты уровней согласованности.  

Согласованность ограниченного устаревания гарантирует, что все операции чтения будут находиться в пределах от последней записи в любом из регионов до префикса *K* или *T* секунд. Более того, операции чтения с ограниченной согласованностью устаревания гарантированно монотонны и с согласованными гарантиями префикса. Протокол защиты от энтропии работает с ограничением скорости и гарантирует, что префиксы не накапливаются и обратная реакция при записи не применяется. Согласованность сеансов гарантирует монотонное чтение, монотонную запись, чтение собственных операций записи, запись после считывания и согласованность префиксов по всему миру. Для баз данных, для которых настроена строгая согласованность, преимущества (низкая задержка записи, высокая доступность записи) нескольких регионов записи не применяются, поскольку синхронная репликация между регионами не применяется.

Семантика пяти моделей согласованности в Cosmos DB описывается [здесь](consistency-levels.md)и математически описывается с помощью [ВЫСОКОУРОВНЕВЫХ спецификаций](https://github.com/Azure/azure-cosmos-tla)TLA +.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о том, как настроить политики глобального распределения, можно узнать в приведенных ниже статьях.

* [Добавление и удаление регионов из учетной записи базы данных](how-to-manage-database-account.md#addremove-regions-from-your-database-account)
* [Создание пользовательской политики разрешения конфликтов](how-to-manage-conflicts.md#create-a-custom-conflict-resolution-policy)
