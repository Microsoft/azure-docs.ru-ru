---
title: 'Наблюдатель за сетями Azure: проверка пакетов | Документация Майкрософт'
description: В этой статье описывается использование службы наблюдения за сетями для подробной проверки пакетов, собранных от виртуальной машины
services: network-watcher
documentationcenter: na
author: damendo
ms.assetid: 7b907d00-9c35-40f5-a61e-beb7b782276f
ms.service: network-watcher
ms.devlang: na
ms.topic: how-to
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 01/07/2021
ms.author: damendo
ms.openlocfilehash: 3bd85d6faf05fcf659e9335ee9de3d64198dfa08
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "98011175"
---
# <a name="packet-inspection-with-azure-network-watcher"></a>Проверка пакетов в службе наблюдения за сетями Azure

Функция записи пакетов в Наблюдателе за сетями позволяет инициировать и администрировать сеансы записи для виртуальных машин Azure с помощью портала, PowerShell и интерфейса командной строки, а также программно с использованием REST API и пакета SDK. Функция записи пакетов используется в ситуациях, когда для получения информации в удобной для использования форме вам нужны данные на уровне пакетов. Вы можете использовать доступные бесплатные средства для изучения потоков данных, отправляемых и получаемых виртуальными машинами, а также анализа сведений о сетевом трафике. Вот некоторые примеры использования данных о собранных пакетах: анализ проблем с сетью или приложениями, обнаружение попыток вторжения и нарушений в сети, поддержание соответствия нормативным требованиям. В этой статье мы покажем, как использовать популярное средство с открытым исходным кодом для работы с файлом записи пакетов, который создан службой наблюдения за сетями. Также мы продемонстрируем, как вычислить задержку подключения, обнаружить аномальный трафик и проанализировать сетевую статистику.

## <a name="before-you-begin"></a>Перед началом

В этой статье рассматривается несколько предварительно настроенных сценариев на основе ранее выполненной операции записи пакетов. Эти сценарии демонстрируют возможности, связанные с использованием функции записи пакетов. В этом сценарии для работы с функцией записи пакетов используется средство [WireShark](https://www.wireshark.org/).

Предполагается, что вы уже выполнили запись пакетов на виртуальной машине. Дополнительные сведения о выполнении записи пакетов см. в статьях [Manage packet captures with the portal](network-watcher-packet-capture-manage-portal.md) (Управление записью пакетов на портале Azure) и [Managing Packet Captures with REST API](network-watcher-packet-capture-manage-rest.md) (Управление записью пакетов с помощью интерфейса REST API).

## <a name="scenario"></a>Сценарий

В рамках этого сценария вы:

* анализ записи пакетов;

## <a name="calculate-network-latency"></a>расчет задержки в сети.

На примере этого сценария мы покажем, как определить время кругового пути (RTT) для начала сеанса TCP между двумя конечными точками.

Когда создается подключение TCP, первые три пакета обрабатываются в определенной последовательности, которая называется трехэтапным подтверждением. Проанализировав первые два пакета, отправленных в ходе подтверждения (исходный запрос от клиента и ответ от сервера), мы можем вычислить величину задержки для этого подключения. Такая задержка называется временем кругового пути. Дополнительные сведения о протоколе TCP и трехэтапном подтверждении см. на этой странице: [https://support.microsoft.com/en-us/help/172983/explanation-of-the-three-way-handshake-via-tcp-ip](https://support.microsoft.com/en-us/help/172983/explanation-of-the-three-way-handshake-via-tcp-ip)

### <a name="step-1"></a>Шаг 1

Запустите WireShark

### <a name="step-2"></a>Шаг 2

Загрузите файл **.cap**, созданный при записи пакетов. Этот файл сохраняется в большом двоичном объекте или локально на виртуальной машине, в зависимости от указанных настроек.

### <a name="step-3"></a>Шаг 3

Чтобы узнать начальное время кругового пути для сеанса TCP, мы изучим первые два пакета, используемые в подтверждении TCP. Это два первых пакета, которые обрабатываются в рамках трехэтапного подтверждения, — пакеты [SYN] и [SYN, ACK]. Названия этих пакетов определяются тем, какие флаги для них установлены в заголовке TCP. Последний пакет трехэтапного подтверждения (или пакет [ACK]), в этом сценарии не рассматривается. Клиент отправляет пакет [SYN]. После получения сервер отправляет пакет [ACK] как подтверждение получения SYN от клиента. Учитывая тот факт, что этот ответ почти не требует обработки на стороне сервера, мы можем считать, что разница во времени получения клиентом пакета [SYN, ACK] и отправки клиентом пакета [SYN] и составляет время кругового пути.

Это значение мы можем получить с помощью средства WireShark.

Чтобы нам было удобнее просматривать первые два пакета в рамках трехэтапного подтверждения TCP, мы воспользуемся возможностью фильтрации в WireShark.

Чтобы применить фильтр, разверните в WireShark сегмент TCP для записанного пакета [SYN] и изучите флаги в соответствующем заголовке TCP.

Сейчас мы хотим настроить фильтр так, чтобы отобразить только пакеты [SYN] и [SYN, ACK]. Для этого в разделе флагов проверьте, что бит Syn имеет значение 1. Затем щелкните его правой кнопкой мыши и выберите Apply as Filter -> Selected (Применить в качестве фильтра -> Выбрано).

![Рис. 7.][7]

### <a name="step-4"></a>Шаг 4

Теперь в этом окне вы видите только пакеты, для которых установлен бит [SYN]. Это позволяет легко выбрать сеансы, для которых вы хотите определить начальное время кругового пути. В WireShark можно очень легко вычислить время кругового пути, щелкнув раскрывающийся список с именем "SEQ/ACK". Здесь вы сразу увидите требуемое время кругового пути. В нашем примере это значение составляет 0,0022114 с или 2,211 мс.

![Рис. 8.][8]

## <a name="unwanted-protocols"></a>Нежелательные протоколы

На вашем экземпляре виртуальной машины, развернутом в Azure, может работать множество приложений. Некоторые из этих приложений обмениваются данными по сети, возможно, даже без явного разрешения. Функция записи пакетов, собирающая информацию о сетевых взаимодействиях, позволяет нам выяснить, как именно взаимодействуют приложения и какие могут возникать проблемы.

В этом примере мы проанализируем уже выполненный захват пакетов, чтобы проверить наличие нежелательных протоколов, которые могут указывать на несанкционированное сетевое взаимодействие запущенных на компьютере приложений.

### <a name="step-1"></a>Шаг 1

Использование той же записи в предыдущем сценарии. Выберите пункт **Статистика**  >  **протоколов**

![Пункт меню "Иерархия протоколов"][2]

Откроется окно иерархии протоколов. Это представление содержит список всех протоколов, которые использовались в записанных в этом сеансе пакетах, а также число пакетов, отправленных и полученных по каждому из протоколов. Это представление позволяет обнаруживать нежелательный трафик на виртуальных машинах или в сети.

![Открытая иерархия протоколов][3]

Как вы видите на представленном ниже снимке экрана, обнаружен трафик по протоколу BitTorrent (используется в одноранговых сетях обмена файлами). Как администратор, вы удивлены наличию трафика BitTorrent на этих виртуальных машинах. Теперь, когда вы знаете, что он существует, вы можете найти и удалить установленное программное обеспечение для одноранговых сетей или заблокировать этот трафик с помощью групп безопасности сети или брандмауэра. Кроме того, вы можете настроить расписание для регулярной записи пакетов, чтобы постоянно контролировать использование сетевых протоколов на виртуальных машинах. Пример автоматизации сетевых задач см. в статье [Monitor network resources with azure automation](network-watcher-monitor-with-azure-automation.md) (Мониторинг сетевых ресурсов с помощью службы автоматизации Azure).

## <a name="finding-top-destinations-and-ports"></a>Поиск самых активных адресов назначения и портов

Осведомленность о типах трафика, конечных точках и портах, которые используются для передачи данных, крайне важна при устранении неполадок, связанных с приложениями и ресурсами в сети, а также для их мониторинга. На примере представленного выше файла записи пакетов мы можем быстро выяснить наиболее активные адреса назначения, с которыми взаимодействует наша виртуальная машина, и используемые для обмена данными порты.

### <a name="step-1"></a>Шаг 1

При использовании записи в предыдущем сценарии щелкните **Статистика**  >  **IPv4**  >  **назначение и порты** .

![Окно захвата пакетов][4]

### <a name="step-2"></a>Шаг 2

При просмотре этих данных сразу бросается в глаза большое количество подключений через порт 111. Самым активным из портов здесь является порт 3389 (это порт удаленного рабочего стола), а все остальные — это динамически назначаемые порты RPC.

Возможно, в этом трафике нет ничего плохого, но следует обратить внимание на большое число подключений по порту, о котором администратору ничего не известно.

![Рис. 5.][5]

### <a name="step-3"></a>Шаг 3

Итак, мы нашли порт с необычной активностью и можем теперь отфильтровать нашу запись по этому порту.

В нашем примере фильтр будет выглядеть вот так:

```
tcp.port == 111
```

Введите этот текст фильтра в поле фильтра вверху и нажмите клавишу ВВОД.

![Рис. 6.][6]

В полученных результатах мы видим, что весь этот трафик поступает от локальной виртуальной машины из той же подсети. Если этого нам недостаточно для понимания характера трафика, мы можем дополнительно изучить отдельные пакеты. Возможно, это поможет понять, зачем они передаются на порт 111. Благодаря этим сведениям вы сможете предпринять необходимые действия.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о других диагностических возможностях Наблюдателя за сетями см. в [этом обзоре](network-watcher-monitoring-overview.md).

[1]: ./media/network-watcher-deep-packet-inspection/figure1.png
[2]: ./media/network-watcher-deep-packet-inspection/figure2.png
[3]: ./media/network-watcher-deep-packet-inspection/figure3.png
[4]: ./media/network-watcher-deep-packet-inspection/figure4.png
[5]: ./media/network-watcher-deep-packet-inspection/figure5.png
[6]: ./media/network-watcher-deep-packet-inspection/figure6.png
[7]: ./media/network-watcher-deep-packet-inspection/figure7.png
[8]: ./media/network-watcher-deep-packet-inspection/figure8.png













