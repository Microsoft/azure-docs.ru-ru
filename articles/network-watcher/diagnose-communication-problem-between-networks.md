---
title: Учебник по диагностике проблем с обменом данными между сетями на портале Azure
titleSuffix: Azure Network Watcher
description: В этом учебнике вы узнаете о диагностике проблем с обменом данными между виртуальной сетью Azure, подключенной к локальной или другой виртуальной сети через шлюз виртуальной сети Azure, с помощью функции диагностики VPN службы "Наблюдатель за сетями".
services: network-watcher
documentationcenter: na
author: damendo
ms.service: network-watcher
ms.devlang: na
ms.topic: tutorial
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 01/07/2021
ms.author: damendo
ms.custom: mvc
ms.openlocfilehash: e9122a323556bebd4ed08ab99f2183313d04eaca
ms.sourcegitcommit: 73fb48074c4c91c3511d5bcdffd6e40854fb46e5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/31/2021
ms.locfileid: "106066030"
---
# <a name="tutorial-diagnose-a-communication-problem-between-networks-using-the-azure-portal"></a>Руководство по Диагностика проблем с обменом данными между сетями на портале Azure

Шлюз виртуальной сети соединяет виртуальную сеть Azure с локальной или другой виртуальной сетью. В этом руководстве описано следующее:

> [!div class="checklist"]
> * Выполнение диагностики проблемы с помощью шлюза виртуальной сети с возможностью диагностики VPN службы "Наблюдатель за сетями".
> * Выполнение диагностики проблем путем подключения шлюза.
> * Устранение проблемы со шлюзом.

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.


[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

## <a name="prerequisites"></a>Предварительные требования

Чтобы использовать диагностику VPN, необходимо наличие работающего VPN-шлюза. Если у вас нет VPN-шлюза для диагностики, вы можете развернуть его, используя [скрипт PowerShell](../vpn-gateway/scripts/vpn-gateway-sample-site-to-site-powershell.md?toc=%2fazure%2fnetwork-watcher%2ftoc.json). Вы можете запустить скрипт PowerShell из:
- **Локальной установки PowerShell**. Для работы этого сценария требуется модуль Azure PowerShell `Az`. Выполните командлет `Get-Module -ListAvailable Az`, чтобы узнать установленную версию. Если вам необходимо выполнить обновление, ознакомьтесь со статьей, посвященной [установке Azure PowerShell](/powershell/azure/install-Az-ps). Если модуль PowerShell запущен локально, необходимо также выполнить командлет `Connect-AzAccount`, чтобы создать подключение к Azure.
- **Azure Cloud Shell**. В [Azure Cloud Shell](https://shell.azure.com/powershell) установлена и настроена последняя версия PowerShell. Эта служба позволяет выполнить вход в Azure.

С помощью этого скрипта VPN-шлюз можно создать приблизительно за час. В последующих шагах предполагается, что диагностика выполняется для шлюза, развернутого с помощью этого скрипта. Если вместо этого выполнить диагностику для имеющегося шлюза, результаты будут отличаться.

## <a name="sign-in-to-azure"></a>Вход в Azure

Войдите на [портал Azure](https://portal.azure.com).

## <a name="enable-network-watcher"></a>Включение Наблюдателя за сетями

Если в регионе "Восточная часть США" уже включена служба "Наблюдатель за сетями", перейдите к разделу о [диагностике шлюза](#diagnose-a-gateway).

1. На портале выберите **Все службы**. В текстовом поле **Фильтр** введите *Наблюдатель за сетями*. Когда в результатах появится **Наблюдатель за сетями**, выберите его.
2. Выберите раздел **Регионы**, чтобы развернуть его, а затем щелкните **...** справа от региона **Восточная часть США**, как показано на следующем изображении:

    ![Включение Наблюдателя за сетями](./media/diagnose-communication-problem-between-networks/enable-network-watcher.png)

3. Выберите **Включить Наблюдатель за сетями**.

## <a name="diagnose-a-gateway"></a>Диагностика шлюза

1. В левой области портала выберите **Все службы**.
2. Начните вводить *наблюдатель за сетями* в поле **Фильтр**. Когда в результатах поиска появится **Наблюдатель за сетями**, выберите его.
3. В разделе **Средства диагностики сети** выберите **Диагностика VPN**.
4. Щелкните **Учетная запись хранения**, а затем выберите учетную запись хранения, в которую необходимо записывать диагностические данные.
5. В списке **учетных записей хранения** выберите учетную запись хранения, которую необходимо использовать. При отсутствии имеющейся учетной записи хранения выберите **+ Storage account** (+ Учетная запись хранения), введите или выберите необходимые данные, а затем щелкните **Создать**, чтобы создать ее. Если VPN-шлюз создан с помощью скрипта, указанного в разделе [предварительных требований](#prerequisites), вам может понадобиться создать учетную запись хранения в той же группе ресурсов (*TestRG1*), что и шлюз.
6. В списке **Контейнеры** выберите контейнер, который вы хотите использовать, а затем щелкните **Выбрать**. Если у вас нет контейнера, щелкните **+ Container** (+ Контейнер), введите имя контейнера, а затем выберите **ОК**.
7. Выберите шлюз, а затем щелкните **Начать устранение неполадок**. Как показано на следующем изображении, тест выполняется для шлюза с именем **Vnet1GW**.

    ![Диагностика VPN](./media/diagnose-communication-problem-between-networks/vpn-diagnostics.png)

8. Во время выполнения теста отображается состояние **Выполняется** в столбце **Состояние устранения неполадок** (где на предыдущем изображении отображалось состояние **Не запущено**). Выполнение этого теста может занять несколько минут.
9. Просмотрите состояние завершенного теста. На следующем изображении показаны результаты состояния завершенного теста диагностики.

    ![Снимок экрана, на котором показаны результаты диагностического теста, неработоспособного в этом примере, включая сводку и подробные сведения.](./media/diagnose-communication-problem-between-networks/status.png)

    На изображении видно, что в столбце **Состояние устранения неполадок** отображается значение **Неработоспособно**, а также **сводка** и **сведения** о проблеме на вкладке **Status** (Состояние).
10. Если перейти на вкладку **Действие**, диагностика VPN предоставит дополнительные сведения. В примере, показанном на следующем изображении, из VPN-диагностики можно понять, что следует проверить работоспособность каждого подключения.

    ![Снимок экрана, на котором показана вкладка "Действие", содержащая дополнительные сведения.](./media/diagnose-communication-problem-between-networks/action.png)

## <a name="diagnose-a-gateway-connection"></a>Диагностика подключения шлюза

Шлюз подключен к другим сетям через подключение шлюза. Для успешного обмена данными между виртуальной и подключенной сетями шлюз и подключения шлюза должны быть работоспособными.

1. Выполите шаг 7 из раздела о [диагностике шлюза](#diagnose-a-gateway) еще раз. На этот раз выберите подключение. В следующем примере тестируется подключение с именем **VNet1toSite1**.

    ![Снимок экрана, на котором показано, как начать устранение неполадок выбранного подключения.](./media/diagnose-communication-problem-between-networks/connection.png)

    Выполнение теста занимает несколько минут.
2. После завершения тестирования подключения появляются результаты, аналогичные результатам, показанным на следующих изображениях вкладок **Состояние** и **Действие**.

    ![Состояние подключения](./media/diagnose-communication-problem-between-networks/connection-status.png)

    ![Действие подключения](./media/diagnose-communication-problem-between-networks/connection-action.png)

    С помощью диагностики VPN можно узнать об ошибке на вкладке **Состояние**, а также несколько возможных причин возникновения ошибки (на вкладке **Действие**).

    Если для тестирования использовался шлюз, развернутый с помощью [скрипта](../vpn-gateway/scripts/vpn-gateway-sample-site-to-site-powershell.md?toc=%2fazure%2fnetwork-watcher%2ftoc.json) из раздела [предварительных требований](#prerequisites), то проблему на вкладке **Состояние** можно решить, используя первые два варианта на вкладке **Действия**. Этот скрипт настраивает IP-адрес заполнителя 23.99.221.164 для устройства локального шлюза VPN.

    Чтобы устранить эту проблему, необходимо удостовериться в том, что локальный шлюз VPN [настроен должным образом](../vpn-gateway/vpn-gateway-about-vpn-devices.md?toc=%2fazure%2fnetwork-watcher%2ftoc.json), и изменить IP-адрес, настроенный с помощью скрипта для локального сетевого шлюза, на фактический общедоступный адрес локального шлюза VPN.

## <a name="clean-up-resources"></a>Очистка ресурсов

Если вы создали VPN-шлюз, используя скрипт из раздела [предварительных требований](#prerequisites), исключительно для выполнения заданий данного руководства и он больше не нужен, удалите группу ресурсов и все содержащиеся в ней ресурсы.

1. В поле **Поиск** в верхней части портала введите *TestRG1*. Выберите **TestRG1** в результатах поиска.
2. Выберите **Удалить группу ресурсов**.
3. Введите *TestRG1* в поле **Введите имя группы ресурсов:** и щелкните **Удалить**.

## <a name="next-steps"></a>Дальнейшие действия

Из этого руководства вы узнали, как выполнить диагностику проблемы с помощью шлюза виртуальной сети. Вы можете сделать запись о сетевом обмене данными с виртуальной машиной, чтобы иметь возможность проверить журнал на наличие аномалий. Чтобы узнать, как сделать это, перейдите к изучению следующего руководства.

> [!div class="nextstepaction"]
> [Запись сетевого входящего и исходящего трафика виртуальной машины в журнал](network-watcher-nsg-flow-logging-portal.md)
