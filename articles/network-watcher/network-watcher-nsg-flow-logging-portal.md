---
title: Руководство по регистрации потока сетевого трафика на виртуальную машину и с нее с помощью портала Azure | Документация Майкрософт
description: Дополнительные сведения о регистрации потока сетевого трафика на виртуальную машину и обратно с помощью функции журналов потока NSG службы "Наблюдатель за сетями".
services: network-watcher
documentationcenter: na
author: damendo
tags: azure-resource-manager
ms.assetid: 01606cbf-d70b-40ad-bc1d-f03bb642e0af
ms.service: network-watcher
ms.devlang: na
ms.topic: tutorial
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 04/30/2018
ms.author: damendo
ms.custom: mvc
ms.openlocfilehash: 76d57990fcdd82bfe382fa2fb4ab75fb037caf4f
ms.sourcegitcommit: 73fb48074c4c91c3511d5bcdffd6e40854fb46e5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/31/2021
ms.locfileid: "106063936"
---
# <a name="tutorial-log-network-traffic-to-and-from-a-virtual-machine-using-the-azure-portal"></a>Руководство по Регистрация потока входящего и исходящего сетевого трафика виртуальной машины с помощью портала Azure

> [!div class="op_single_selector"]
> - [Портал Azure](network-watcher-nsg-flow-logging-portal.md)
> - [PowerShell](network-watcher-nsg-flow-logging-powershell.md)
> - [Azure CLI](network-watcher-nsg-flow-logging-cli.md)
> - [REST API](network-watcher-nsg-flow-logging-rest.md)
> - [Azure Resource Manager](network-watcher-nsg-flow-logging-azure-resource-manager.md)

Группа безопасности сети (NSG) позволяет выполнять фильтрацию входящего и исходящего трафика на виртуальную машину и с нее. Вы можете регистрировать сетевой трафик, проходящий через NSG, с помощью функции журналов потока NSG службы "Наблюдатель за сетями". В этом руководстве описано следующее:

> [!div class="checklist"]
> * Создание виртуальной машины с помощью группы безопасности сети.
> * Включение службы "Наблюдатель за сетями" и регистрация поставщика Microsoft.Insights.
> * Включение регистрации потока трафика для NSG, используя функцию журнала потока NSG службы "Наблюдатель за сетями".
> * Скачивание зарегистрированных в журнале данных.
> * Просмотр зарегистрированных в журнале данных.

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

## <a name="create-a-vm"></a>Создание виртуальной машины

1. Выберите **+ Создать ресурс** в верхнем левом углу окна портала Azure.
2. Выберите **Вычисление**, а затем — **Windows Server 2016 Datacenter** или версию **Ubuntu Server**.
3. Введите или выберите следующие значения, примите значения по умолчанию для остальных параметров и нажмите кнопку **ОК**:

    |Параметр|Значение|
    |---|---|
    |Имя|myVm|
    |Имя пользователя| Введите выбранное имя пользователя.|
    |Пароль| Введите выбранный пароль. Пароль должен включать минимум 12 символов и соответствовать [определенным требованиям к сложности](../virtual-machines/windows/faq.md?toc=%2fazure%2fnetwork-watcher%2ftoc.json#what-are-the-password-requirements-when-creating-a-vm).|
    |Подписка| Выберите свою подписку.|
    |Группа ресурсов| Выберите **Создать новую**, а затем введите **myResourceGroup**.|
    |Расположение| Выберите **Восточная часть США**.|

4. Выберите размер виртуальной машины и щелкните **Выбрать**.
5. На странице **Параметры** примите все значения по умолчанию и нажмите кнопку **ОК**.
6. В разделе **создания** на странице **Сводка** выберите **Создать**, чтобы начать развертывание виртуальной машины. Развертывание виртуальной машины занимает несколько минут. Дождитесь окончания развертывания виртуальной машины, прежде чем приступить к выполнению следующих шагов.

Создание виртуальной машины занимает несколько минут. Выполняйте последующие шаги только после создания виртуальной машины. Во время создания виртуальной машины на портале также создается группа безопасности сети с именем **myVm-nsg** и выполняется ее привязка к сетевому интерфейсу для виртуальной машины.

## <a name="enable-network-watcher"></a>Включение Наблюдателя за сетями

Если в регионе "Восточная часть США" уже включена служба "Наблюдатель за сетями", перейдите к разделу о [регистрации поставщика Microsoft Insights](#register-insights-provider).

1. На портале выберите **Все службы**. В текстовом поле **Фильтр** введите *Наблюдатель за сетями*. Когда в результатах появится **Наблюдатель за сетями**, выберите его.
2. Выберите раздел **Регионы**, чтобы развернуть его, а затем щелкните **...** справа от региона **Восточная часть США**, как показано на следующем изображении:

    ![Включение Наблюдателя за сетями](./media/network-watcher-nsg-flow-logging-portal/enable-network-watcher.png)

3. Выберите **Включить Наблюдатель за сетями**.

## <a name="register-insights-provider"></a>Регистрация поставщика Microsoft Insights

Для регистрации потока NSG требуется поставщик **Microsoft.Insights**. Чтобы зарегистрировать поставщик, выполните следующие шаги:

1. В верхнем левом углу портала выберите **Все службы**. В поле фильтра введите *Подписки*. Когда в результатах поиска появится пункт **Подписки**, выберите его.
2. Из списка подписок выберите ту, для которой необходимо включить поставщик.
3. В разделе **Settings** (Параметры) выберите **Поставщики ресурсов**.
4. Убедитесь, что для поставщика **microsoft.insights** задано **состояние** **Зарегистрировано**, как показано на следующем изображении. Если состояние — **Не зарегистрировано**, выберите **Зарегистрировать** справа от поставщика.

    ![Регистрация поставщика](./media/network-watcher-nsg-flow-logging-portal/register-provider.png)

## <a name="enable-nsg-flow-log"></a>Включение журнала потоков NSG

1. Данные журнала потоков NSG записываются в учетную запись хранения Azure. Чтобы создать учетную запись хранения Azure, выберите **+ Создать ресурс** в верхнем левом углу портала.
2. Выберите **Хранилище**, а затем **Учетная запись хранения — BLOB-объект, файл, таблица, очередь**.
3. Введите или выберите приведенные ниже сведения, примите значения по умолчанию для остальных параметров и щелкните **Создать**.

    | Параметр        | Значение                                                        |
    | ---            | ---   |
    | Имя           | Должно состоять из 3–24 символов, может содержать только буквы нижнего регистра и цифры и должно быть уникальным среди всех учетных записей хранения Azure.                                                               |
    | Расположение       | Выберите **Восточная часть США**.                                           |
    | Группа ресурсов | Щелкните **Use existing** (Использовать существующую), а затем выберите **myResourceGroup**. |

    Создание учетной записи хранения может занять примерно минуту. Выполняйте последующие шаги только после создания учетной записи хранения. Во любом случае учетная запись хранения находиться в том же регионе, что и NSG.
4. В верхнем левом углу портала выберите **Все службы**. В текстовом поле **Фильтр** введите *Наблюдатель за сетями*. Когда в результатах поиска появится **Наблюдатель за сетями**, выберите его.
5. В разделе **Журналы** выберите **Журналы последовательностей NSG**, как показано на следующем изображении.

    ![Снимок экрана: журнал потоков для групп безопасности сети Наблюдателя за сетями.](./media/network-watcher-nsg-flow-logging-portal/nsgs.png)

6. В списке NSG выберите NSG с именем **myVm-nsg**.
7. В разделе **Параметры журналов потоков** выберите **On** (Включить).
8. Выберите версию журналов потоков. В версии 2 доступна статистика сеансов потоков (количество байт и пакетов).

   ![Выбор версии журналов потоков](./media/network-watcher-nsg-flow-logging-portal/select-flow-log-version.png)

9. Выберите учетную запись хранения, созданную во время выполнения шага 3.
   > [!NOTE]
   > Журналы потоков NSG не работают с учетными записями хранения, в которых включено [иерархическое пространство имен](../storage/blobs/data-lake-storage-namespace.md).
1. В верхнем левом углу портала выберите **Все службы**. В текстовом поле **Фильтр** введите *Наблюдатель за сетями*. Когда в результатах поиска появится **Наблюдатель за сетями**, выберите его.
10. Задайте в разделе **Хранение (дни)** значение 5, а затем выберите **Save** (Сохранить).

## <a name="download-flow-log"></a>Скачивание журналов потоков

1. В службе &quot;Наблюдатель за сетями&quot; на портале выберите **Журналы потоков NSG** в разделе **Журналы**.
2. Выберите **You can download flow logs from configured storage accounts** (Журналы потоков можно скачать в настроенных учетных записях хранения), как показано на следующем изображении.

   ![Скачивание журналов потоков](./media/network-watcher-nsg-flow-logging-portal/download-flow-logs.png)

3. Выберите учетную запись хранения, настроенную на шаге 2 в разделе о [включении журнала потоков NSG](#enable-nsg-flow-log).
4. В разделе **Служба BLOB-объектов** выберите **Контейнеры**, а затем —контейнер **insights-logs-networksecuritygroupflowevent**.
5. В контейнере перейдите к иерархии папок и найдите файл PT1H.json, как показано на следующем изображении. Файлы журналов записываются в иерархию папок, которая соответствует следующему соглашению об именовании: https://{storageAccountName}.blob.core.windows.net/insights-logs-networksecuritygroupflowevent/resourceId=/SUBSCRIPTIONS/{subscriptionID}/RESOURCEGROUPS/{resourceGroupName}/PROVIDERS/MICROSOFT.NETWORK/NETWORKSECURITYGROUPS/{nsgName}/y={year}/m={month}/d={day}/h={hour}/m=00/macAddress={macAddress}/PT1H.json

   ![Журнал потока](./media/network-watcher-nsg-flow-logging-portal/log-file.png)

6. Выберите **...** справа от файла PT1H.json и щелкните **Download** (Скачать).

## <a name="view-flow-log"></a>Просмотр журнала потоков

В следующем файле Json представлен пример отображаемых данных в файле PT1H.json для каждого потока, для которого зарегистрированы данные:

### <a name="version-1-flow-log-event"></a>Событие журнала потоков версии 1
```json
{
    "time": "2018-05-01T15:00:02.1713710Z",
    "systemId": "<Id>",
    "category": "NetworkSecurityGroupFlowEvent",
    "resourceId": "/SUBSCRIPTIONS/<Id>/RESOURCEGROUPS/MYRESOURCEGROUP/PROVIDERS/MICROSOFT.NETWORK/NETWORKSECURITYGROUPS/MYVM-NSG",
    "operationName": "NetworkSecurityGroupFlowEvents",
    "properties": {
        "Version": 1,
        "flows": [
            {
                "rule": "UserRule_default-allow-rdp",
                "flows": [
                    {
                        "mac": "000D3A170C69",
                        "flowTuples": [
                            "1525186745,192.168.1.4,10.0.0.4,55960,3389,T,I,A"
                        ]
                    }
                ]
            }
        ]
    }
}
```
### <a name="version-2-flow-log-event"></a>Событие журнала потоков версии 2
```json
{
    "time": "2018-11-13T12:00:35.3899262Z",
    "systemId": "a0fca5ce-022c-47b1-9735-89943b42f2fa",
    "category": "NetworkSecurityGroupFlowEvent",
    "resourceId": "/SUBSCRIPTIONS/00000000-0000-0000-0000-000000000000/RESOURCEGROUPS/FABRIKAMRG/PROVIDERS/MICROSOFT.NETWORK/NETWORKSECURITYGROUPS/FABRIAKMVM1-NSG",
    "operationName": "NetworkSecurityGroupFlowEvents",
    "properties": {
        "Version": 2,
        "flows": [
            {
                "rule": "DefaultRule_DenyAllInBound",
                "flows": [
                    {
                        "mac": "000D3AF87856",
                        "flowTuples": [
                            "1542110402,94.102.49.190,10.5.16.4,28746,443,U,I,D,B,,,,",
                            "1542110424,176.119.4.10,10.5.16.4,56509,59336,T,I,D,B,,,,",
                            "1542110432,167.99.86.8,10.5.16.4,48495,8088,T,I,D,B,,,,"
                        ]
                    }
                ]
            },
            {
                "rule": "DefaultRule_AllowInternetOutBound",
                "flows": [
                    {
                        "mac": "000D3AF87856",
                        "flowTuples": [
                            "1542110377,10.5.16.4,13.67.143.118,59831,443,T,O,A,B,,,,",
                            "1542110379,10.5.16.4,13.67.143.117,59932,443,T,O,A,E,1,66,1,66",
                            "1542110379,10.5.16.4,13.67.143.115,44931,443,T,O,A,C,30,16978,24,14008",
                            "1542110406,10.5.16.4,40.71.12.225,59929,443,T,O,A,E,15,8489,12,7054"
                        ]
                    }
                ]
            }
        ]
    }
}
```

Значение, заданное для **mac** в предыдущих выходных данных — MAC-адрес сетевого интерфейса, созданного при генерировании виртуальной машины. Данные, разделенные запятыми в разделе **flowTuples**, выглядят следующим образом:

| Демонстрационные данные | Что представляют собой данные   | Объяснение                                                                              |
| ---          | ---                    | ---                                                                                      |
| 1542110377   | Метка времени             | Метка времени возникновения потока в формате UNIX EPOCH. В предыдущем примере дата преобразуется в 1 мая 2018 г., 2:59:05 (GMT).                                                                                    |
| 10.0.0.4  | Исходный IP-адрес      | Исходный IP-адрес, с которого поступил поток. 10.0.0.4 — частный IP-адрес виртуальной машины, созданной в [этом разделе](#create-a-vm).
| 13.67.143.118     | Конечный IP-адрес | IP-адрес назначения, на который был отправлен поток.                                                                                  |
| 44931        | Исходный порт            | Исходный порт, с которого был отправлен поток.                                           |
| 443         | Конечный порт       | Порт назначения, на который был отправлен поток. Так как трафик отправлялся на порт 443, файл был обработан с помощью правила с именем **UserRule_default-allow-rdp** в файле журнала этого потока.                                                |
| T            | Протокол               | Какой протокол использовался для передачи потока: TCP (T) или UDP (U).                                  |
| O            | Направление              | Тип трафика: входящий (I) или исходящий (O).                                     |
| Объект            | Действие                 | Разрешен (A) или запрещен (D) трафик.  
| C            | Состояние потока (**только в версии 2**) | Фиксируется состояние потоков. Возможны следующие состояния **B**. Начать при создании потока. Статистика не предоставляется. **C**. Продолжить для текущего потока. Статистика предоставляется с интервалом в 5 минут. **E**. Завершить после окончания потока. Статистика предоставляется. |
| 30 | Пакеты, отправленные из источника в место назначения (**только в версии 2**) | Общее количество TCP- или UDP-пакетов, отправленных из источника в место назначения (с момента последнего обновления). |
| 16978 | Байты, отправленные из источника в место назначения (**только в версии 2**) | Общее количество байт TCP- или UDP-пакетов, отправленных из источника в место назначения с момента последнего обновления. Байты пакетов включают в себя заголовок пакета и полезные данные. |
| 24 | Пакеты, отправленные из места назначения в источник (**только в версии 2**) | Общее количество TCP- или UDP-пакетов, отправленных из места назначения в источник (с момента последнего обновления). |
| 14008| Байты, отправленные из места назначения в источник (**только в версии 2**) | Общее количество байт TCP- и UDP-пакетов, отправленных из назначения к источнику с момента последнего обновления. Байты пакетов включают в себя заголовок пакета и полезные данные.|

## <a name="next-steps"></a>Дальнейшие действия

В этом руководстве вы узнали, как включить ведение журнала NSG для потока NSG. Вы также узнали, как скачать и просмотреть данные, записанные в файл. Необработанные данные в JSON-файле могут быть сложными для понимания. Чтобы визуализировать данные журналов потока, можно использовать [Аналитику трафика Azure](traffic-analytics.md), [Microsoft Power BI](network-watcher-visualize-nsg-flow-logs-power-bi.md) и другие средства. Вы можете испытать альтернативные методы включения журналов потоков NSG, такие как [PowerShell](network-watcher-nsg-flow-logging-powershell.md), [Azur CLI](network-watcher-nsg-flow-logging-cli.md), [REST API](network-watcher-nsg-flow-logging-rest.md) и [шаблоны ARM](network-watcher-nsg-flow-logging-azure-resource-manager.md).