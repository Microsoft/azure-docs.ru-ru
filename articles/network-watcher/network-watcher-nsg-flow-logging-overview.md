---
title: Общие сведения о ведении журналов потоков для группы безопасности сети
titleSuffix: Azure Network Watcher
description: В этой статье объясняется, как использовать возможности журналов потоков NSG, доступные в Наблюдателе за сетями Azure.
services: network-watcher
documentationcenter: na
author: damendo
ms.service: network-watcher
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 01/04/2021
ms.author: damendo
ms.openlocfilehash: bc085163b4f738d022ab9771794ec85293de5ed8
ms.sourcegitcommit: 27d616319a4f57eb8188d1b9d9d793a14baadbc3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/15/2021
ms.locfileid: "100521685"
---
# <a name="introduction-to-flow-logging-for-network-security-groups"></a>Общие сведения о ведении журнала потоков для групп безопасности сети

## <a name="introduction"></a>Введение

Журналы потоков [группы безопасности сети](../virtual-network/network-security-groups-overview.md#security-rules) (NSG) — это функция наблюдателя за сетями Azure, которая позволяет записывать в журнал сведения о IP-трафике, переданном через NSG. Данные потока отправляются в учетные записи хранения Azure, откуда вы можете получить к ним доступ, а также экспортировать их в любое средство визуализации, SIEM или ИДЕНТИФИКАТОРы по своему усмотрению.

![Обзор журналов потоков](./media/network-watcher-nsg-flow-logging-overview/homepage.jpg)

## <a name="why-use-flow-logs"></a>Зачем использовать журналы потоков

Крайне важно выполнять мониторинг своей сети, управлять ею и знать ее структуру для обеспечения бескомпромиссной безопасности, соответствия и высокой производительности. Знание собственной среды имеет первостепенное значение для ее защиты и оптимизации. Практически всегда нужно знать текущее состояние сети, кто выполняет подключения, откуда они выполняются, какие порты открыты для доступа из Интернета, ожидаемую и подозрительную активность в сети, а также внезапные пики трафика.

Журналы потоков — это источник истинности для всех сетевых операций в облачной среде. Есть ли предстоящие попытки для оптимизации ресурсов или крупных предприятий, пытающихся обнаружить вторжение, журналы потоков являются наиболее подходящим элементом. Его можно использовать для оптимизации сетевых потоков, мониторинга пропускной способности, проверки соответствия, обнаружения вторжений и многого другого.

## <a name="common-use-cases"></a>Распространенные варианты использования

**Мониторинг сети**: выявление неизвестного или ненужного трафика. Мониторинг уровней трафика и потребления пропускной способности. Фильтрация журналов потоков по IP-адресу и порту для понимания поведения приложения. Экспортируйте журналы потоков в средства аналитики и визуализации по своему усмотрению, чтобы настроить панели мониторинга.

**Мониторинг использования и оптимизация:** Выявление ведущих разговоров в сети. Объедините с данными Жеоип для обнаружения трафика между регионами. Понимание роста трафика для прогнозирования емкости. Используйте данные для удаления овертли правил трафика.

**Соответствие**: Используйте данные потока для проверки сетевой изоляции и соответствия правилам корпоративного доступа.

**Сетевые судебные & анализ безопасности**: анализ сетевых потоков от скомпрометированных IP-адресов и сетевых интерфейсов. Экспортируйте журналы потоков в любое средство SIEM или ИДЕНТИФИКАТОРы по своему усмотрению.

## <a name="how-logging-works"></a>Как работает ведение журнала

**Ключевые свойства**

- Журналы потоков работают на [уровне 4](https://en.wikipedia.org/wiki/OSI_model#Layer_4:_Transport_Layer) и записывают все IP-потоки, которые поступают и выходят из NSG
- Журналы собираются по **1-минутному интервалу** на платформе Azure и не влияют на ресурсы клиента или производительность сети.
- Журналы записываются в формате JSON и показывают исходящие и входящие потоки по отдельности для каждого правила NSG.
- Каждая запись журнала содержит сетевой интерфейс (NIC), к которому применяется поток, а также сведения о пропускной способности из 5 кортежей & (только версии 2). Полные сведения см. в следующем _формате журнала_ .
- Журналы потоков имеют функцию хранения, которая позволяет автоматически удалять журналы до года после их создания. 

> [!NOTE]
> Хранение доступно только при использовании [учетных записей хранения общего назначения версии 2 (GPv2)](../storage/common/storage-account-overview.md#types-of-storage-accounts). 

**Основные понятия**

- Программно определенные сети упорядочены по виртуальным сетям (виртуальных сетей) и подсетям. Безопасность этих виртуальных сетей и подсетей можно управлять с помощью NSG.
- Группа безопасности сети (NSG) содержит список _правил безопасности_ , которые разрешают или запрещают сетевой трафик в ресурсах, к которым он подключен. Группы безопасности сети можно связать с подсетями, отдельными виртуальными машинами или отдельными сетевыми интерфейсами (NIC), подключенными к виртуальным машинам (диспетчер ресурсов). Дополнительные сведения см. в статье [Безопасность сети](../virtual-network/network-security-groups-overview.md?toc=%2fazure%2fnetwork-watcher%2ftoc.json).
- Все потоки трафика в сети оцениваются с помощью правил в соответствующем NSG.
- Результатом этих оценок являются журналы потоков NSG. Журналы потоков собираются на платформе Azure и не нуждаются в каких-либо изменениях в ресурсах клиента.
- Примечание. правила относятся к двум типам — завершать & без завершения, каждый из которых имеет различные поведения ведения журнала.
- - Правила отклонения NSG завершаются. NSG, запрещающее трафик, будет записывать его в журналы потоков, а обработка в этом случае будет останавливаться после того, как любой NSG отклоняет трафик. 
- - NSG разрешать правила не завершаются. Это означает, что даже если один NSG допускает его, обработка будет продолжаться следующим NSG. Последний NSG, разрешающий трафик, будет записывать трафик в журналы потоков.
- Журналы потоков NSG записываются в учетные записи хранения, откуда они могут быть доступны.
- Вы можете экспортировать, обрабатывать, анализировать и визуализировать журналы потоков с помощью таких средств, как TA, Splunk, Grafana, Стеалсватч и т. д.

## <a name="log-format"></a>Формат журнала

Журналы потока включают в себя следующие свойства:

* **time** — время занесения события в журнал.
* **SystemId** — идентификатор системы группы безопасности сети.
* **category** — категория события. Категория — всегда **NetworkSecurityGroupFlowEvent**.
* **ResourceId** — идентификатор ресурса NSG.
* **operationName** — всегда имеет значение NetworkSecurityGroupFlowEvents.
* **properties** — набор свойств потока.
    * **Version** — номер версии схемы событий журнала потоков.
    * **потоки** — коллекция потоков. Это свойство имеет несколько записей для различных ролей.
        * **rule** — правило, для которого отображены потоки.
            * **flows** — набор потоков.
                * **mac** — MAC-адрес сетевой карты виртуальной машины, в которой был получен поток.
                * **flowTuples** — строка с разделителями-запятыми, содержащая несколько свойств кортежа потока.
                    * **Метка времени** . это значение представляет собой метку времени, когда поток помещается в формате ЭПОХи UNIX.
                    * **Source IP** — исходный IP-адрес.
                    * **Destination IP** — конечный IP-адрес.
                    * **Source Port** — исходный порт.
                    * **Destination Port** — конечный порт.
                    * **Protocol** — протокол потока. Допустимые значения: **T** для протокола TCP и **U** для протокола UDP.
                    * **Traffic Flow** — направление потока трафика. Допустимые значения: **I** для входящего трафика и **O** для исходящего трафика.
                    * **Traffic Decision** — указывает, разрешен ли трафик. Допустимые значения: **A**, если трафик разрешен, и **D**, если запрещен.
                    * **Flow State - Version 2 Only** — фиксирует состояние потока. Возможны следующие состояния **B**. Начать при создании потока. Статистика не предоставляется. **C**. Продолжить для текущего потока. Статистика предоставляется с интервалом в 5 минут. **E**. Завершить после окончания потока. Статистика предоставляется.
                    * **Packets - Source to destination - Version 2 Only** — общее количество пакетов TCP или UDP, отправленных из источника в место назначения (с момента последнего обновления).
                    * **Bytes sent - Source to destination - Version 2 Only** — общее количество байт пакетов TCP или UDP, отправленных из источника в место назначения (с момента последнего обновления). Байты пакетов включают в себя заголовок пакета и полезные данные.
                    * **Packets - Destination to source - Version 2 Only** — общее количество пакетов TCP или UDP, отправленных из места назначения в источник (с момента последнего обновления).
                    * **Bytes sent - Destination to source - Version 2 Only** — общее количество байт пакетов TCP или UDP, отправленных из места назначения в источник (с момента последнего обновления). Байты пакетов включают в себя заголовок пакета и полезные данные.


**Журналы потоков NSG версии 2 (VS версии 1)** 

В версии 2 журналов представлено понятие состояния потока. Вы можете указать, какая версия журналов потоков будет сохраняться.

Состояние потока _B_ регистрируется, когда инициируется поток. Состояние потока _C_ и состояние потока _E_ отмечают продолжение потока и его завершение соответственно. Оба состояния, _C_ и _E_, содержат информацию о пропускной способности трафика.

### <a name="sample-log-records"></a>Примеры записей журнала

Ниже приведен пример журнала потоков. Как вы видите, он содержит несколько записей, соответствующих списку свойств, описанных в предыдущем разделе.

> [!NOTE]
> Значения в свойстве *фловтуплес* представляют собой список с разделителями-запятыми.
 
**Пример формата журнала потоков версии 1**
```json
{
    "records": [
        {
            "time": "2017-02-16T22:00:32.8950000Z",
            "systemId": "2c002c16-72f3-4dc5-b391-3444c3527434",
            "category": "NetworkSecurityGroupFlowEvent",
            "resourceId": "/SUBSCRIPTIONS/00000000-0000-0000-0000-000000000000/RESOURCEGROUPS/FABRIKAMRG/PROVIDERS/MICROSOFT.NETWORK/NETWORKSECURITYGROUPS/FABRIAKMVM1-NSG",
            "operationName": "NetworkSecurityGroupFlowEvents",
            "properties": {
                "Version": 1,
                "flows": [
                    {
                        "rule": "DefaultRule_DenyAllInBound",
                        "flows": [
                            {
                                "mac": "000D3AF8801A",
                                "flowTuples": [
                                    "1487282421,42.119.146.95,10.1.0.4,51529,5358,T,I,D"
                                ]
                            }
                        ]
                    },
                    {
                        "rule": "UserRule_default-allow-rdp",
                        "flows": [
                            {
                                "mac": "000D3AF8801A",
                                "flowTuples": [
                                    "1487282370,163.28.66.17,10.1.0.4,61771,3389,T,I,A",
                                    "1487282393,5.39.218.34,10.1.0.4,58596,3389,T,I,A",
                                    "1487282393,91.224.160.154,10.1.0.4,61540,3389,T,I,A",
                                    "1487282423,13.76.89.229,10.1.0.4,53163,3389,T,I,A"
                                ]
                            }
                        ]
                    }
                ]
            }
        },
        {
            "time": "2017-02-16T22:01:32.8960000Z",
            "systemId": "2c002c16-72f3-4dc5-b391-3444c3527434",
            "category": "NetworkSecurityGroupFlowEvent",
            "resourceId": "/SUBSCRIPTIONS/00000000-0000-0000-0000-000000000000/RESOURCEGROUPS/FABRIKAMRG/PROVIDERS/MICROSOFT.NETWORK/NETWORKSECURITYGROUPS/FABRIAKMVM1-NSG",
            "operationName": "NetworkSecurityGroupFlowEvents",
            "properties": {
                "Version": 1,
                "flows": [
                    {
                        "rule": "DefaultRule_DenyAllInBound",
                        "flows": [
                            {
                                "mac": "000D3AF8801A",
                                "flowTuples": [
                                    "1487282481,195.78.210.194,10.1.0.4,53,1732,U,I,D"
                                ]
                            }
                        ]
                    },
                    {
                        "rule": "UserRule_default-allow-rdp",
                        "flows": [
                            {
                                "mac": "000D3AF8801A",
                                "flowTuples": [
                                    "1487282435,61.129.251.68,10.1.0.4,57776,3389,T,I,A",
                                    "1487282454,84.25.174.170,10.1.0.4,59085,3389,T,I,A",
                                    "1487282477,77.68.9.50,10.1.0.4,65078,3389,T,I,A"
                                ]
                            }
                        ]
                    }
                ]
            }
        },
    "records":
    [
        
        {
             "time": "2017-02-16T22:00:32.8950000Z",
             "systemId": "2c002c16-72f3-4dc5-b391-3444c3527434",
             "category": "NetworkSecurityGroupFlowEvent",
             "resourceId": "/SUBSCRIPTIONS/00000000-0000-0000-0000-000000000000/RESOURCEGROUPS/FABRIKAMRG/PROVIDERS/MICROSOFT.NETWORK/NETWORKSECURITYGROUPS/FABRIAKMVM1-NSG",
             "operationName": "NetworkSecurityGroupFlowEvents",
             "properties": {"Version":1,"flows":[{"rule":"DefaultRule_DenyAllInBound","flows":[{"mac":"000D3AF8801A","flowTuples":["1487282421,42.119.146.95,10.1.0.4,51529,5358,T,I,D"]}]},{"rule":"UserRule_default-allow-rdp","flows":[{"mac":"000D3AF8801A","flowTuples":["1487282370,163.28.66.17,10.1.0.4,61771,3389,T,I,A","1487282393,5.39.218.34,10.1.0.4,58596,3389,T,I,A","1487282393,91.224.160.154,10.1.0.4,61540,3389,T,I,A","1487282423,13.76.89.229,10.1.0.4,53163,3389,T,I,A"]}]}]}
        }
        ,
        {
             "time": "2017-02-16T22:01:32.8960000Z",
             "systemId": "2c002c16-72f3-4dc5-b391-3444c3527434",
             "category": "NetworkSecurityGroupFlowEvent",
             "resourceId": "/SUBSCRIPTIONS/00000000-0000-0000-0000-000000000000/RESOURCEGROUPS/FABRIKAMRG/PROVIDERS/MICROSOFT.NETWORK/NETWORKSECURITYGROUPS/FABRIAKMVM1-NSG",
             "operationName": "NetworkSecurityGroupFlowEvents",
             "properties": {"Version":1,"flows":[{"rule":"DefaultRule_DenyAllInBound","flows":[{"mac":"000D3AF8801A","flowTuples":["1487282481,195.78.210.194,10.1.0.4,53,1732,U,I,D"]}]},{"rule":"UserRule_default-allow-rdp","flows":[{"mac":"000D3AF8801A","flowTuples":["1487282435,61.129.251.68,10.1.0.4,57776,3389,T,I,A","1487282454,84.25.174.170,10.1.0.4,59085,3389,T,I,A","1487282477,77.68.9.50,10.1.0.4,65078,3389,T,I,A"]}]}]}
        }
        ,
        {
             "time": "2017-02-16T22:02:32.9040000Z",
             "systemId": "2c002c16-72f3-4dc5-b391-3444c3527434",
             "category": "NetworkSecurityGroupFlowEvent",
             "resourceId": "/SUBSCRIPTIONS/00000000-0000-0000-0000-000000000000/RESOURCEGROUPS/FABRIKAMRG/PROVIDERS/MICROSOFT.NETWORK/NETWORKSECURITYGROUPS/FABRIAKMVM1-NSG",
             "operationName": "NetworkSecurityGroupFlowEvents",
             "properties": {"Version":1,"flows":[{"rule":"DefaultRule_DenyAllInBound","flows":[{"mac":"000D3AF8801A","flowTuples":["1487282492,175.182.69.29,10.1.0.4,28918,5358,T,I,D","1487282505,71.6.216.55,10.1.0.4,8080,8080,T,I,D"]}]},{"rule":"UserRule_default-allow-rdp","flows":[{"mac":"000D3AF8801A","flowTuples":["1487282512,91.224.160.154,10.1.0.4,59046,3389,T,I,A"]}]}]}
        }
        
        
```
**Пример формата журнала потоков версии 2**
```json
 {
    "records": [
        {
            "time": "2018-11-13T12:00:35.3899262Z",
            "systemId": "a0fca5ce-022c-47b1-9735-89943b42f2fa",
            "category": "NetworkSecurityGroupFlowEvent",
            "resourceId": "/SUBSCRIPTIONS/00000000-0000-0000-0000-000000000000/RESOURCEGROUPS/FABRIKAMRG/PROVIDERS/MICROSOFT.NETWORK/NETWORKSECURITYGROUPS/FABRIAKMVM1-NSG",
            "operationName": "NetworkSecurityGroupFlowEvents",
            "properties": {
                "Version": 2,
                "flows": [
                    {
                        "rule": "DefaultRule_DenyAllInBound",
                        "flows": [
                            {
                                "mac": "000D3AF87856",
                                "flowTuples": [
                                    "1542110402,94.102.49.190,10.5.16.4,28746,443,U,I,D,B,,,,",
                                    "1542110424,176.119.4.10,10.5.16.4,56509,59336,T,I,D,B,,,,",
                                    "1542110432,167.99.86.8,10.5.16.4,48495,8088,T,I,D,B,,,,"
                                ]
                            }
                        ]
                    },
                    {
                        "rule": "DefaultRule_AllowInternetOutBound",
                        "flows": [
                            {
                                "mac": "000D3AF87856",
                                "flowTuples": [
                                    "1542110377,10.5.16.4,13.67.143.118,59831,443,T,O,A,B,,,,",
                                    "1542110379,10.5.16.4,13.67.143.117,59932,443,T,O,A,E,1,66,1,66",
                                    "1542110379,10.5.16.4,13.67.143.115,44931,443,T,O,A,C,30,16978,24,14008",
                                    "1542110406,10.5.16.4,40.71.12.225,59929,443,T,O,A,E,15,8489,12,7054"
                                ]
                            }
                        ]
                    }
                ]
            }
        },
        {
            "time": "2018-11-13T12:01:35.3918317Z",
            "systemId": "a0fca5ce-022c-47b1-9735-89943b42f2fa",
            "category": "NetworkSecurityGroupFlowEvent",
            "resourceId": "/SUBSCRIPTIONS/00000000-0000-0000-0000-000000000000/RESOURCEGROUPS/FABRIKAMRG/PROVIDERS/MICROSOFT.NETWORK/NETWORKSECURITYGROUPS/FABRIAKMVM1-NSG",
            "operationName": "NetworkSecurityGroupFlowEvents",
            "properties": {
                "Version": 2,
                "flows": [
                    {
                        "rule": "DefaultRule_DenyAllInBound",
                        "flows": [
                            {
                                "mac": "000D3AF87856",
                                "flowTuples": [
                                    "1542110437,125.64.94.197,10.5.16.4,59752,18264,T,I,D,B,,,,",
                                    "1542110475,80.211.72.221,10.5.16.4,37433,8088,T,I,D,B,,,,",
                                    "1542110487,46.101.199.124,10.5.16.4,60577,8088,T,I,D,B,,,,",
                                    "1542110490,176.119.4.30,10.5.16.4,57067,52801,T,I,D,B,,,,"
                                ]
                            }
                        ]
                    }
                ]
            }
        }
        
```
**Описание кортежа журнала**

![кортеж журналов потоков](./media/network-watcher-nsg-flow-logging-overview/tuple.png)

**Пример вычисления пропускной способности**

Кортежи потока из TCP-диалога между 185.170.185.105:35370 и 10.2.0.4:23:

"1493763938,185.170.185.105,10.2.0.4,35370,23,T,I,A,B,,,," "1493695838,185.170.185.105,10.2.0.4,35370,23,T,I,A,C,1021,588096,8005,4610880" "1493696138,185.170.185.105,10.2.0.4,35370,23,T,I,A,E,52,29952,47,27072"

Для состояний продолжения _C_ и окончания _E_ потока счетчики байтов и пакетов являются совокупными счетчиками со времени предыдущей записи кортежа потока. Для предыдущего примера общее количество переданных пакетов равно 1021+52+8005+47 = 9125. Общее число переданных байтов: 588096+29952+4610880+27072 = 5256000.


## <a name="enabling-nsg-flow-logs"></a>Включение журналов потоков NSG

Используйте соответствующую ссылку ниже для руководства по включению журналов потоков.

- [Портал Azure](./network-watcher-nsg-flow-logging-portal.md)
- [PowerShell](./network-watcher-nsg-flow-logging-powershell.md)
- [CLI](./network-watcher-nsg-flow-logging-cli.md)
- [REST](./network-watcher-nsg-flow-logging-rest.md)
- [Azure Resource Manager](./network-watcher-nsg-flow-logging-azure-resource-manager.md)

## <a name="updating-parameters"></a>Обновление параметров

**Портал Azure**

На портал Azure перейдите к разделу журналы потоков NSG в наблюдатель за сетями. Затем щелкните имя NSG. Откроется панель Параметры для журнала потоков. Измените нужные параметры и нажмите кнопку **сохранить** , чтобы развернуть изменения.

**PS/CLI/RESTFUL/ARM**

Чтобы обновить параметры с помощью программ командной строки, используйте ту же команду, которая использовалась для включения журналов потоков (см. выше), но с обновленными параметрами, которые необходимо изменить.

## <a name="working-with-flow-logs"></a>Работа с журналами потоков

*Чтение и экспорт журналов потоков*

- [Скачивание &amp; журналов потоков для просмотра с портала](./network-watcher-nsg-flow-logging-portal.md#download-flow-log)
- [Чтение журналов потоков с помощью функций PowerShell](./network-watcher-read-nsg-flow-logs.md)
- [Экспорт журналов потоков NSG в Splunk](https://www.splunk.com/en_us/blog/tips-and-tricks/splunking-microsoft-azure-network-watcher-data.html)

Хотя журналы потоков предназначены для NSG, они не отображаются так же, как и другие журналы. Журналы потоков хранятся только в учетной записи хранения и имеют путь ведения журнала, показанный в следующем примере:

```
https://{storageAccountName}.blob.core.windows.net/insights-logs-networksecuritygroupflowevent/resourceId=/SUBSCRIPTIONS/{subscriptionID}/RESOURCEGROUPS/{resourceGroupName}/PROVIDERS/MICROSOFT.NETWORK/NETWORKSECURITYGROUPS/{nsgName}/y={year}/m={month}/d={day}/h={hour}/m=00/macAddress={macAddress}/PT1H.json
```

*Визуализация журналов потоков*

- [Аналитика трафика Azure](./traffic-analytics.md) — это собственная служба Azure для обработки журналов потоков, которая извлекает аналитические сведения и визуализируют журналы потоков. 
- [Показано Визуализация журналов потоков NSG с помощью Power BI](./network-watcher-visualize-nsg-flow-logs-power-bi.md)
- [Показано Визуализация журналов потоков NSG с помощью эластичного стека](./network-watcher-visualize-nsg-flow-logs-open-source-tools.md)
- [Показано Управление журналами потоков NSG и их анализ с помощью Grafana](./network-watcher-nsg-grafana.md)
- [Показано Управление журналами потоков NSG и их анализ с помощью Graylog](./network-watcher-analyze-nsg-flow-logs-graylog.md)


## <a name="nsg-flow-logging-considerations"></a>Вопросы ведения журналов потоков NSG

**Рекомендации по учетной записи хранения**: 

- Расположение. используемая учетная запись хранения должна находиться в том же регионе, что и NSG.
- Уровень производительности. в настоящее время поддерживаются только учетные записи хранения уровня "Стандартный".
- Самостоятельное управление ключами. при изменении или вращении ключей доступа в учетную запись хранения журналы потоков NSG перестанут работать. Чтобы устранить эту проблему, необходимо отключить и снова включить журналы потоков NSG.

**Затраты на ведение журнала потоков**. в журнале потоков NSG взимается плата за объем созданных журналов. Большой объем трафика может привести к большому объему журнала потока и соответствующих затрат. Цены журнала потока группы безопасности сети не включают базовую стоимость хранилища. Использование функции политики хранения для ведения журнала потоков NSG означает наличие отдельных затрат на хранение в течение продолжительного периода времени. Если вы хотите хранить данные неограниченно долго и не хотите применять политику хранения, задайте для параметра период хранения (дни) значение 0. Дополнительные сведения см. в разделе [цены на наблюдателя за сетями](https://azure.microsoft.com/pricing/details/network-watcher/) и [цены на хранилище Azure](https://azure.microsoft.com/pricing/details/storage/) .

**Проблемы с определяемыми пользователем правилами входящего трафика TCP**. [группы безопасности сети (группы безопасности сети)](../virtual-network/network-security-groups-overview.md) реализованы в виде [брандмауэра с отслеживанием состояния](https://en.wikipedia.org/wiki/Stateful_firewall?oldformat=true). Однако из-за текущих ограничений платформы определяемые пользователем правила, влияющие на входящие TCP-потоки, реализуются без отслеживания состояния. Из-за этого потоки, затрагиваемые определяемыми пользователем правилами для входящих подключений, не будут завершаться. Кроме того, для этих потоков не записываются байты и количество пакетов. Следовательно, число байтов и пакетов, сообщаемых в журналах потоков NSG (и Аналитика трафика), может отличаться от реальных чисел. Флаг согласия, использующий эти проблемы, планируется получить до последней версии 2021 марта. В предварительной ситуации клиенты, которые сталкиваются с серьезными проблемами из-за такого поведения, могут запросить включение в службу поддержки. Отправьте запрос в службу поддержки в разделе "наблюдатель за сетями" > NSG журналы потоков.  

**Входящие потоки, зарегистрированные с IP-адресов из Интернета на виртуальных машинах без общедоступных** IP: виртуальных машин, которым не назначен общедоступный IP адрес, связанный с сетевым адаптером в качестве общедоступного IP-адреса уровня экземпляра или входящих в состав пула серверной части базового балансировщика нагрузки, используют [значение SNAT по умолчанию](../load-balancer/load-balancer-outbound-connections.md) и назначаются Azure для упрощения исходящего подключения. В результате вы можете увидеть записи журнала потоков для последовательностей из IP-адресов Интернета, если последовательность направлена на порт в диапазоне портов, назначенных для SNAT. В то время как Azure не разрешает передачу этих потоков на виртуальную машину, попытка записи в журнал и появляется в журнале потоков NSG для наблюдателя за сетями. Рекомендуется явно заблокировать нежелательный входящий Интернет для NSG.

**Ошибка в подсети шлюза приложений версии 2 (NSG**): ведение журнала потоков в подсети шлюза приложений версии 2 NSG в настоящее время [не поддерживается](../application-gateway/application-gateway-faq.yml#are-nsg-flow-logs-supported-on-nsgs-associated-to-application-gateway-v2-subnet) . Эта проблема не влияет на шлюз приложений версии v1.

**Несовместимые службы**. из-за ограничений текущей платформы небольшой набор служб Azure не поддерживается журналами потоков NSG. Текущий список несовместимых служб:
- [Службы Azure Kubernetes (AKS)](https://azure.microsoft.com/services/kubernetes-service/)
- [Logic Apps](https://azure.microsoft.com/services/logic-apps/) 

## <a name="best-practices"></a>Рекомендации

**Включить в критических виртуальных сетей и подсетях**: журналы потоков должны быть включены во всех критических виртуальных сетей и подсетях в подписке как подходящие для аудита и обеспечения безопасности. 

**Включение ведения журнала потоков NSG для всех группы безопасности сети, подключенных к ресурсу**. ведение журнала потоков в Azure настроено для ресурса NSG. Поток будет связан только с одним правилом группы безопасности сети. В сценариях, где используются несколько группы безопасности сети, рекомендуется включить журналы потоков NSG для всех группы безопасности сети, применяемых в подсети ресурса или сетевом интерфейсе, чтобы обеспечить запись всего трафика. Дополнительные сведения см. в разделе [Оценка трафика](../virtual-network/network-security-group-how-it-works.md) в группах безопасности сети. 

Несколько распространенных сценариев:
1. **Несколько сетевых карт на виртуальной** машине. в случае, если несколько сетевых карт подключены к виртуальным машинам, необходимо включить ведение журнала потоков.
1. **Наличие NSG на уровне сетевой карты и уровня подсети**. Если NSG настроены на СЕТЕВом интерфейсе, а также на уровне подсети, то ведение журнала потоков должно быть включено и в группы безопасности сети. 

**Подготовка хранилища**. необходимо подготовить хранилище в процессе настройки с ожидаемым объемом журнала потоков.

**Именование**: имя NSG должно содержать до 80 символов, а имена правил NSG — 65 символов. Если имена превышают предел числа символов, они могут быть усечены при ведении журнала.

## <a name="troubleshooting-common-issues"></a>Устранение распространенных проблем

**Не удалось включить журналы потоков NSG**

- Поставщик ресурсов **Microsoft. Insights** не зарегистрирован

Если возникла ошибка _​AuthorizationFailed_ или _GatewayAuthenticationFailed_, возможно, вы не включили поставщик ресурсов Microsoft Insights в подписке. [Следуйте инструкциям](./network-watcher-nsg-flow-logging-portal.md#register-insights-provider) , чтобы включить поставщик Microsoft Insights.

**Журналы потоков NSG включились, но данные не отображаются в учетной записи хранения**

- **Время настройки**

На отображение журналов потоков NSG в учетной записи хранения может потребоваться до 5 минут (при корректной настройке). Отобразится файл PT1H.json, доступ к которому можно получить [указанным здесь способом](./network-watcher-nsg-flow-logging-portal.md#download-flow-log).

- **В группах безопасности сети нет трафика**

Иногда журналы не отображаются, если виртуальные машины не активны или на шлюзе приложений или других устройствах имеются вышестоящие фильтры, блокирующие трафик к группе безопасности сети.

**Я хочу автоматизировать журналы потока группы безопасности сети**

В настоящее время поддержка автоматизации через шаблоны Resource Manager для журналов потоков группы безопасности сети недоступна. Дополнительные сведения см. в [объявлении о функции](https://azure.microsoft.com/updates/arm-template-support-for-nsg-flow-logs/) .

## <a name="faq"></a>ВОПРОСЫ И ОТВЕТЫ

**Что делают журналы потоков NSG?**

Сетевые ресурсы Azure можно объединять и управлять ими с помощью [групп безопасности сети (группы безопасности сети)](../virtual-network/network-security-groups-overview.md). Журналы потоков NSG позволяют записывать в журнал сведения о потоке с пятью кортежами по всему трафику через группы безопасности сети. Журналы необработанных потоков записываются в учетную запись хранения Azure, откуда они могут быть обработаны, проанализированы, запрошены или экспортированы по мере необходимости.

**Влияет ли использование журналов потоков на задержку или производительность сети?**

Данные журналов потоков собираются за пределами пути к сетевому трафику и поэтому не влияют на пропускную способность или задержку сети. Вы можете создавать или удалять журналы последовательностей без риска влияния на производительность сети.

**Разделы справки использовать журналы потоков NSG с учетной записью хранения, защищенной брандмауэром?**

Чтобы использовать учетную запись хранения за брандмауэром, необходимо предоставить исключение для доверенных служб Майкрософт, чтобы получить доступ к вашей учетной записи хранения:

- Перейдите к учетной записи хранения, введя имя учетной записи хранения в глобальный поиск на портале или на [странице учетные записи хранения](https://ms.portal.azure.com/#blade/HubsExtension/BrowseResource/resourceType/Microsoft.Storage%2FStorageAccounts) .
- В разделе **Параметры** выберите **брандмауэры и виртуальные сети** .
- В списке **Разрешить доступ из** выберите  **Выбранные сети**. Затем в разделе  **исключения** установите флажок рядом с полем * * * разрешить доверенным службам Майкрософт доступ к этой учетной записи хранения * * * *
- Если они уже выбраны, никаких изменений не требуется.
- Выберите целевую NSG на [странице Обзор журналов потоков NSG](https://ms.portal.azure.com/#blade/Microsoft_Azure_Network/NetworkWatcherMenuBlade/flowLogs) и включите журналы последовательностей NSG с выбранной учетной записью хранения.

Через несколько минут можно проверить журналы хранилища. Вы должны увидеть обновленную метку времени или новый файл JSON.

**Разделы справки использовать журналы потоков NSG с учетной записью хранения, расположенной за конечной точкой службы?**

Журналы потоков NSG совместимы с конечными точками службы, не требуя дополнительной настройки. См. [руководство по включению конечных точек службы](../virtual-network/tutorial-restrict-network-access-to-resources.md#enable-a-service-endpoint) в виртуальной сети.

**В чем разница между журналами потоков версии 1 & 2?**

Журналы потоков версии 2 представляют концепцию _состояния потока_ & хранят сведения о передаваемых байтах и пакетах. [Дополнительные сведения](#log-format)

## <a name="pricing"></a>Цены

Журналы потоков NSG начисляются за каждый ГИГАБАЙТ журналов и поставляются с уровнем Free 5 ГБ в месяц на подписку. Текущие цены в вашем регионе см. на странице с [ценами на наблюдатель за сетями](https://azure.microsoft.com/pricing/details/network-watcher/).

Плата за хранение журналов осуществляется отдельно. Дополнительные сведения см. на [странице цен на блочные BLOB-объекты службы хранилища Azure](https://azure.microsoft.com/pricing/details/storage/blobs/) .