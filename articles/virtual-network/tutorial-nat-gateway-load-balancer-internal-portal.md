---
title: Учебник. Интеграция шлюза NAT с внутренней подсистемой балансировки нагрузки (портал Azure)
titleSuffix: Virtual Network NAT
description: В этом учебнике описано, как интегрировать шлюз NAT виртуальной сети с внутренней подсистемой балансировки нагрузки с помощью портала Azure.
author: asudbring
ms.author: allensu
ms.service: virtual-network
ms.subservice: nat
ms.topic: tutorial
ms.date: 03/19/2021
ms.custom: template-tutorial
ms.openlocfilehash: f25266f5a969514ca515e8cbbec959404428d6fb
ms.sourcegitcommit: f28ebb95ae9aaaff3f87d8388a09b41e0b3445b5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/30/2021
ms.locfileid: "104670711"
---
# <a name="tutorial-integrate-a-nat-gateway-with-an-internal-load-balancer-using-the-azure-portal"></a>Учебник. Интеграция шлюза NAT с внутренней подсистемой балансировки нагрузки с помощью портала Azure

Из этого учебника вы узнаете, как интегрировать шлюз NAT с внутренней подсистемой балансировки нагрузки.

По умолчанию служба Load Balancer (цен. категория "Стандартный") Azure безопасна. Исходящее подключение явно определяется путем включения исходящего подключения SNAT (преобразование сетевых адресов источника). 

Механизм SNAT включается для внутреннего серверного пула с помощью другой общедоступной подсистемы балансировки нагрузки, сетевой маршрутизации или общедоступного IP-адреса, определенного на виртуальной машине.

Интеграция со шлюзом NAT устраняет необходимость развертывать общедоступную подсистему балансировки нагрузки, использовать сетевую маршрутизацию или общедоступный IP-адрес, определенный на виртуальной машине в серверном пуле.

В этом руководстве описано следующее.

> [!div class="checklist"]
> * создание Azure Load Balancer;
> * Создание двух виртуальных машин для серверного пула Azure Load Balancer.
> * Создание шлюза NAT.
> * Проверка исходящего подключения виртуальных машин в серверном пуле подсистемы балансировки нагрузки

## <a name="prerequisites"></a>Предварительные требования

Учетная запись Azure с активной подпиской. [Создайте учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F) бесплатно.

## <a name="create-the-virtual-network"></a>Создание виртуальной сети

С помощью этого раздела вы создадите виртуальную сеть и подсеть.

1. Войдите на [портал Azure](https://portal.azure.com).

1. Слева вверху экрана щелкните **Создать ресурс > Сеть > Виртуальная сеть** или выполните поиск по фразе **виртуальная сеть**.

2. Нажмите кнопку **создания**. 

3. В подменю **Создать виртуальную сеть** введите или выберите следующую информацию на вкладке **Основные сведения**:

    | **Параметр**          | **Значение**                                                           |
    |------------------|-----------------------------------------------------------------|
    | **Сведения о проекте**  |                                                                 |
    | Подписка     | Выбор подписки Azure                                  |
    | Группа ресурсов   | Выберите **Создать**. Введите **TutorIntLBNAT-rg**. </br> Щелкните **ОК**. |
    | **Сведения об экземпляре** |                                                                 |
    | Имя             | Введите **myVNet**.                                    |
    | Регион           | Выберите **Восточная часть США**. |

4. Откройте вкладку **IP-адрес** или нажмите кнопку **Далее: IP-адреса** внизу страницы.

5. На вкладке **IP-адреса** укажите следующие сведения:

    | Параметр            | Значение                      |
    |--------------------|----------------------------|
    | Диапазон IPv4-адресов | Введите **10.1.0.0/16**. |

6. В разделе **Имя подсети** выберите **по умолчанию**.

7. В окне **Изменение подсети** введите следующие сведения:

    | Параметр            | Значение                      |
    |--------------------|----------------------------|
    | Имя подсети | Введите **myBackendSubnet**. |
    | Диапазон адресов подсети | Введите **10.1.0.0/24**. |

8. Щелкните **Сохранить**.

9. Перейдите на вкладку **Безопасность**.

10. В разделе **BastionHost** выберите **Включить**. Введите такие сведения:

    | Параметр            | Значение                      |
    |--------------------|----------------------------|
    | Имя бастиона | Введите **myBastionHost**. |
    | Адресное пространство AzureBastionSubnet | Введите **10.1.1.0/24**. |
    | Общедоступный IP-адрес | Выберите **Создать**. </br> В поле **Имя** введите **myBastionIP**. </br> Щелкните **ОК**. |


11. Перейдите на вкладку **Просмотр и создание** или нажмите кнопку **Просмотр и создание**.

12. Нажмите кнопку **создания**.

## <a name="create-load-balancer"></a>Создание подсистемы балансировки нагрузки

В этом разделе вы узнаете, как создать Azure Load Balancer (цен. категория "Стандартный"). 

1. Выберите **Создать ресурс**. 

2. В поле поиска введите **подсистема балансировки нагрузки**. В результатах поиска выберите **Подсистема балансировки нагрузки**.

3. На странице **Подсистема балансировки нагрузки** щелкните **Создать**.
4. На странице **Создание подсистемы балансировки нагрузки** введите или выберите следующие значения: 

    | Параметр                 | Значение                                              |
    | ---                     | ---                                                |
    | **Сведения о проекте** |   |
    | Подписка               | Выберите свою подписку.    |    
    | Группа ресурсов         | Выберите **TutorIntLBNAT-rg**.|
    | **Сведения об экземпляре** |    |
    | Имя                   | Введите **myLoadBalancer**.                                   |
    | Регион         | Выберите регион **(США) Восточная часть США**.                                        |
    | Тип          | Выберите **Внутренний**.                                        |
    | номер SKU           | Оставьте значение по умолчанию **Стандартная**. |
    | **Настройка виртуальной сети** |    |
    | Виртуальная сеть | Выберите **myVNet**. |
    | Подсеть | Выберите **myBackendSubnet**. |
    | Назначение IP-адресов | Выберите **Динамический**. |
    | Зона доступности | Введите **Избыточная между зонами**, чтобы создать устойчивую подсистему балансировки нагрузки. </br> Чтобы создать подсистему балансировки нагрузки в определенной зоне, выберите нужную зону (1, 2 или 3). |
    

5. Оставьте значения по умолчанию для остальных параметров и нажмите кнопку **Просмотр и создание**.

6. На вкладке **Отзыв и создание** выберите **Создать**.

## <a name="create-load-balancer-resources"></a>Создание ресурсов подсистемы балансировки нагрузки

В этом разделе показано, как настроить следующее:

* параметры подсистемы балансировки нагрузки для пула адресов внутренней части;
* пробу работоспособности;
* Правило подсистемы балансировки нагрузки:

### <a name="create-a-backend-pool"></a>Создание внутреннего пула.

Внутренний пул адресов содержит IP-адреса виртуальных сетевых карт, подключенных к подсистеме балансировки нагрузки. 

Создайте внутренний пул адресов **myBackendPool**, чтобы включить виртуальные машины для балансировки нагрузки интернет-трафика.

1. В меню слева щелкните **Все службы**, выберите **Все ресурсы**, а затем из списка ресурсов выберите **myLoadBalancer**.

2. В разделе **Параметры** выберите **Серверные пулы**, затем щелкните **Добавить**.

3. На странице **Добавление серверного пула** введите имя **myBackendPool** для серверного пула и щелкните **Добавить**.

### <a name="create-a-health-probe"></a>Создание пробы работоспособности

Подсистема балансировки нагрузки отслеживает состояние приложения, выполняя пробу работоспособности. 

Проба работоспособности добавляет виртуальные машины в балансировщик нагрузки или удаляет их оттуда на основе их ответа на проверки работоспособности. 

Создайте зонд работоспособности с именем **myHealthProbe**, чтобы отслеживать работоспособность виртуальных машин.

1. В меню слева щелкните **Все службы**, выберите **Все ресурсы**, а затем из списка ресурсов выберите **myLoadBalancer**.

2. В разделе **Параметры** выберите **Пробы работоспособности**, а затем щелкните **Добавить**.
    
    | Параметр | Значение |
    | ------- | ----- |
    | Имя | Введите **myHealthProbe**. |
    | Протокол | Выберите **TCP**. |
    | Порт | Введите **80**.|
    | Интервал | В качестве **интервала** между попытками выполнения пробы (в секундах) введите **15**. |
    | Пороговое значение сбоя | Выберите **2** в качестве значения **порога состояния неработоспособности** или количества последовательных сбоев пробы, после которых виртуальная машина будет считаться неработоспособной.|
   
3. Сохраните остальные значения по умолчанию и нажмите кнопку **Добавить**.

### <a name="create-a-load-balancer-rule"></a>Создание правила балансировщика нагрузки

Правило балансировщика нагрузки позволяет определить распределение трафика между виртуальными машинами. Вы определяете конфигурацию внешнего IP-адреса для входящего трафика и пул внутренних IP-адресов для приема трафика. В этом правиле определяются исходный и конечный порты. 

В этом разделе показано, как создать правило подсистемы балансировки нагрузки, которая имеет следующие характеристики:

* имеет имя **myHTTPRule**;
* находится в интерфейсной части с именем **LoadBalancerFrontEnd**;
* ожидает передачи данных на **порт 80**;
* отправляет трафик балансировки нагрузки на внутреннюю часть с именем **myBackendPool** через **порт 80**.

1. В меню слева щелкните **Все службы**, выберите **Все ресурсы**, а затем из списка ресурсов выберите **myLoadBalancer**.

2. В разделе **Параметры** выберите **Правила балансировки нагрузки**, а затем щелкните **Добавить**.

3. Для настройки правила балансировки нагрузки используйте следующие значения.
    
    | Параметр | Значение |
    | ------- | ----- |
    | Имя | Введите **myHTTPRule**. |
    | Версия IP-адреса | Выберите **IPv4**. |
    | Интерфейсный IP-адрес | Выберите **LoadBalancerFrontEnd**. |
    | Протокол | Выберите **TCP**. |
    | Порт | Введите **80**.|
    | Серверный порт | Введите **80**. |
    | Серверный пул | Выберите **myBackendPool**.|
    | Проверка работоспособности | Выберите **myHealthProbe**. |
    | Время ожидания простоя (в минутах) | Введите **15** минут. |
    | Сброс TCP | Щелкните **Включено**. |

4. Сохраните остальные значения по умолчанию и нажмите кнопку **ОК**.


## <a name="create-virtual-machines"></a>Создание виртуальных машин

В этом разделе вы узнаете, как создать две виртуальные машины (**myVM1** и **myVM2**) в двух разных зонах (**зона 1** и **зона 2**).

Эти виртуальные машины добавляются во внутренний пул подсистемы балансировки нагрузки, которую вы создали ранее.

1. В верхнем левом углу страницы портала выберите **Создать ресурс** > **Вычисления** > **Виртуальная машина**. 
   
2. В разделе **Создание виртуальной машины** на вкладке **Основные сведения** укажите следующее.

    | Параметр | Значение                                          |
    |-----------------------|----------------------------------|
    | **Сведения о проекте** |  |
    | Подписка | Выбор подписки Azure |
    | Группа ресурсов | Выберите **TutorIntLBNAT-rg**. |
    | **Сведения об экземпляре** |  |
    | Имя виртуальной машины | Введите **myVM1**. |
    | Регион | Выберите **Восточная часть США**. |
    | Параметры доступности | Выберите **Зоны доступности**. |
    | Зона доступности | Выберите **1**. |
    | Образ — | Выберите **Windows Server 2019 Datacenter**. |
    | Точечный экземпляр Azure | Оставьте значение по умолчанию. |
    | Размер | Выберите размер виртуальной машины или подтвердите значение по умолчанию. |
    | **Учетная запись администратора** |  |
    | Имя пользователя | Введите имя пользователя. |
    | Пароль | Введите пароль. |
    | Подтверждение пароля | Введите пароль еще раз. |
    | **Правила входящего порта** |  |
    | Общедоступные входящие порты | Выберите **Нет**. |

3. Выберите вкладку **Сеть** или **Далее: диски**, затем **Далее: сеть**.
  
4. На вкладке "Сеть" укажите следующее.

    | Параметр | Значение |
    |-|-|
    | **Сетевой интерфейс** |  |
    | Виртуальная сеть | **myVNet** |
    | Подсеть | **myBackendSubnet** |
    | Общедоступный IP-адрес | Выберите **Отсутствует**. |
    | Сетевая группа безопасности сетевого адаптера | Нажмите кнопку **Дополнительно**.|
    | Настройка группы безопасности сети | Выберите **Создать**. </br> В разделе **Создание группы безопасности сети** введите строку **myNSG** в поле **Имя**. </br> В разделе **Правила для входящего трафика** выберите **+ Добавить правило для входящих подключений**. </br> В поле **Диапазоны портов назначения** введите значение **80**. </br> В поле **Приоритет** введите значение **100**. </br> В поле **Имя** введите **myHTTPRule**. </br> Выберите **Добавить**. </br> Нажмите кнопку **ОК**. |
    | **Балансировка нагрузки**  |
    | Настроить эту виртуальную машину для работы с существующим решением по балансировке нагрузки? | Установите флажок. |
    | **Параметры балансировки нагрузки** |
    | Параметры балансировки нагрузки | Выберите **подсистему балансировки нагрузки Azure** |
    | Выберите подсистему балансировки нагрузки | Выберите **myLoadBalancer**.  |
    | Выберите серверный пул | Выберите **MyBackendPool**. |
   
5. Выберите **Review + create** (Просмотреть и создать). 
  
6. Проверьте параметры, а затем нажмите кнопку **Создать**.

7. Выполните шаги 1–7, чтобы создать виртуальную машину со следующими значениями (все остальные параметры совпадают с параметрами виртуальной машины **myVM1**).

    | Параметр | Виртуальная машина 2 |
    | ------- | ----- |
    | Имя |  **myVM2** |
    | Зона доступности | **2** |
    | Группа безопасности сети | Выберите существующий вариант **myNSG**.| 

## <a name="create-nat-gateway"></a>Создание шлюза NAT

В этом разделе вы научитесь создавать шлюз NAT и назначать его подсети в виртуальной сети, созданной ранее.

1. В левом верхнем углу экрана выберите **Создать ресурс >Сеть > Шлюз NAT** или введите **Шлюз NAT** в поле поиска.

2. Нажмите кнопку **создания**. 

3. В разделе **Создание шлюза NAT** на вкладке **Основные сведения** введите или выберите следующие сведения:

    | **Параметр**          | **Значение**                                                           |
    |------------------|-----------------------------------------------------------------|
    | **Сведения о проекте**  |                                                                 |
    | Подписка     | Выберите подписку Azure.                                  |
    | Группа ресурсов   | Выберите **TutorIntLBNAT-rg**. |
    | **Сведения об экземпляре** |                                                                 |
    | Имя             | Введите **myNATGateway**.                                    |
    | Регион           | Выберите регион **(США) Восточная часть США**.  |
    | Зона доступности | Выберите **Отсутствует**. |
    | Время ожидания простоя (в минутах) | Введите **10**. |

4. Откройте вкладку **Outbound IP** (Исходящий IP-адрес) или нажмите кнопку **Next: Outbound IP** (Далее: исходящий IP-адрес) внизу страницы.

5. На вкладке **Outbound IP** (Исходящий IP-адрес) введите или выберите следующие значения параметров:

    | **Параметр** | **Значение** |
    | ----------- | --------- |
    | Общедоступные IP-адреса | Выберите **Создание общедоступного IP-адреса**. </br> В поле **Имя** введите **myPublicIP-NAT**. </br> Щелкните **ОК**. |

6. Откройте вкладку **Подсеть** или нажмите кнопку **Next: Subnet** (Далее: подсеть) внизу страницы.

7. На вкладке **подсеть** в раскрывающемся списке **Виртуальная сеть** выберите **myVNet**.

8. Установите флажок рядом с **myBackendSubnet**.

9. Перейдите на вкладку **Просмотр и создание** или нажмите синюю кнопку **Просмотр и создание** внизу страницы.

10. Нажмите кнопку **создания**.

## <a name="test-nat-gateway"></a>Тестирование шлюза NAT

Используя сведения из этого раздела, мы протестируем шлюз NAT. Сначала мы определим общедоступный IP-адрес шлюза NAT. Затем мы подключимся к тестовой виртуальной машине и проверим исходящее подключение через шлюз NAT.
    
1. Найдите общедоступный IP-адрес для шлюза NAT на экране **обзора**. В меню слева щелкните **Все службы**, выберите **Все ресурсы**, а затем — **myPublicIP**.

2. Запишите общедоступный IP-адрес:

    :::image type="content" source="./media/tutorial-nat-gateway-load-balancer-internal-portal/find-public-ip.png" alt-text="Снимок экрана: обнаружение общедоступного IP-адреса шлюза NAT." border="true":::

3. В меню слева щелкните **Все службы**, выберите **Все ресурсы**, а затем в списке ресурсов выберите виртуальную машину **myVM1**, расположенную в группе ресурсов **TutorIntLBNAT-rg**.

4. На странице **Обзор** выберите **Подключиться** и **Бастион**.

5. Нажмите синюю кнопку **Использовать Бастион**.

6. Введите имя пользователя и пароль, введенные в процессе создания виртуальной машины.

7. Откройте **Internet Explorer** на виртуальной машине **myVM1**.

8. В адресной строке введите **https://whatsmyip.com** .

9. Убедитесь, что отображаемый IP-адрес соответствует адресу шлюза NAT, записанному на предыдущем этапе:

    :::image type="content" source="./media/tutorial-nat-gateway-load-balancer-internal-portal/my-ip.png" alt-text="Снимок экрана: внешний исходящий IP-адрес в Internet Explorer." border="true":::

## <a name="clean-up-resources"></a>Очистка ресурсов

Если вы не собираетесь продолжать использовать это приложение, удалите виртуальную сеть, виртуальную машину и шлюз NAT, выполнив следующие действия.

1. В меню слева выберите **Группы ресурсов**.

2. Выберите группу ресурсов **TutorIntLBNAT-rg**.

3. Выберите **Удалить группу ресурсов**.

4. Введите **TutorIntLBNAT-rg** и щелкните **Удалить**.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о NAT виртуальных сетей см. в следующей статье:
> [!div class="nextstepaction"]
> [Общие сведения о NAT виртуальных сетей](nat-overview.md)
