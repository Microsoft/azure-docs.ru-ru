---
title: Проверка задержки сети виртуальной машины Azure в виртуальной сети Azure | Документация Майкрософт
description: Узнайте, как проверить сетевую задержку между виртуальными машинами Azure в виртуальной сети.
services: virtual-network
documentationcenter: na
author: steveesp
manager: Marina Lipshteyn
editor: ''
ms.assetid: ''
ms.service: virtual-network
ms.devlang: na
ms.topic: how-to
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 10/29/2019
ms.author: steveesp
ms.openlocfilehash: f8f167a7947c42ce837ec83b336ae636f593f2e4
ms.sourcegitcommit: d59abc5bfad604909a107d05c5dc1b9a193214a8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/14/2021
ms.locfileid: "98219264"
---
# <a name="test-vm-network-latency"></a>Проверка задержки сети виртуальной машины

Для получения наиболее точных результатов Измерьте задержку сети виртуальной машины Azure с помощью средства, предназначенного для этой задачи. Общедоступные средства, такие как Соккперф (для Linux) и latte.exe (для Windows), могут изолировать и измерять задержку в сети, не исключая задержки других типов, например задержку приложений. Эти средства сосредоточены на типе сетевого трафика, который влияет на производительность приложения (а именно, на трафик протокола управления передачей TCP и UDP). 

Другие распространенные средства подключения, такие как проверка связи, могут измерять задержку, но их результаты могут не представлять сетевой трафик, используемый в реальных рабочих нагрузках. Это связано с тем, что большинство этих средств используют протокол ICMP, который может обрабатываться иначе, чем трафик приложения, результаты которого могут не относиться к рабочим нагрузкам, использующим TCP и UDP. 

Для точного тестирования сетевой задержки протоколов, используемых большинством приложений, Соккперф (для Linux) и latte.exe (для Windows) предоставляют наиболее релевантные результаты. В этой статье рассматриваются оба этих средства.

## <a name="overview"></a>Обзор

Используя две виртуальные машины: один как отправитель и один получатель, вы создадите двусторонний канал связи. При таком подходе вы можете отправлять и получать пакеты в обоих направлениях и измерять время приема-передачи (RTT).

Этот подход можно использовать для измерения задержки в сети между двумя виртуальными машинами или даже между двумя физическими компьютерами. Измерения задержки могут быть полезны в следующих сценариях:

- Создайте тест производительности для задержки сети между развернутыми виртуальными машинами.
- Сравните последствия изменений в сетевой задержке после внесения связанных изменений в:
  - Программное обеспечение операционной системы (ОС) или сетевого стека, включая изменения конфигурации.
  - Метод развертывания виртуальной машины, например развертывание в зоне доступности или группе размещения с учетом расположения (ППГ).
  - Свойства виртуальной машины, такие как Ускоренная сеть или изменение размера.
  - Виртуальная сеть, например маршрутизация или фильтрация изменений.

### <a name="tools-for-testing"></a>Средства для тестирования
Для измерения задержки у вас есть два различных инструмента:

* Для систем на основе Windows: [latte.exe (Windows)](https://gallery.technet.microsoft.com/Latte-The-Windows-tool-for-ac33093b)
* Для систем на основе Linux: [соккперф (Linux)](https://github.com/mellanox/sockperf)

С помощью этих средств можно гарантировать, что измеряется только время доставки полезных данных TCP или UDP, а не ICMP (проверка связи) или другие типы пакетов, которые не используются приложениями и не влияют на их производительность.

### <a name="tips-for-creating-an-optimal-vm-configuration"></a>Советы по созданию оптимальной конфигурации виртуальной машины

При создании конфигурации виртуальной машины учитывайте следующие рекомендации.
- Используйте последнюю версию Windows или Linux.
- Для получения наилучших результатов включите функцию ускорения сети.
- Развертывание виртуальных машин с помощью [группы размещения](../virtual-machines/co-location.md)с учетом расположения Azure.
- Крупные виртуальные машины обычно работают лучше, чем небольшие.

### <a name="tips-for-analysis"></a>Советы по анализу

При анализе результатов тестирования учитывайте следующие рекомендации.

- Создайте базовую базу на раннем этапе, как только развертывание, Настройка и оптимизация будут завершены.
- Всегда сравнивайте новые результаты с базовыми показателями или, в противном случае, от одного теста к другому с управляемыми изменениями.
- Повторяйте тесты при каждом изменении или планировании изменений.


## <a name="test-vms-that-are-running-windows"></a>Тестирование виртуальных машин под Windows

### <a name="get-latteexe-onto-the-vms"></a>Получение latte.exe на виртуальных машинах

Скачайте [последнюю версию latte.exe](https://gallery.technet.microsoft.com/Latte-The-Windows-tool-for-ac33093b).

Рассмотрите возможность помещения latte.exe в отдельную папку, например *c:\Tools*.

### <a name="allow-latteexe-through-windows-defender-firewall"></a>Разрешить latte.exe через брандмауэр защитника Windows

В окне *приемника* создайте правило Allow на брандмауэре защитника Windows, чтобы разрешить поступление latte.exeного трафика. Проще всего разрешить всем latte.exe программу по имени, а не разрешать входящие TCP-порты.

Разрешите latte.exe через брандмауэр защитника Windows, выполнив следующую команду:

```cmd
netsh advfirewall firewall add rule program=<path>\latte.exe name="Latte" protocol=any dir=in action=allow enable=yes profile=ANY
```

Например, если вы скопировали latte.exe в папку *c:\Tools* , это будет команда:

`netsh advfirewall firewall add rule program=c:\tools\latte.exe name="Latte" protocol=any dir=in action=allow enable=yes profile=ANY`

### <a name="run-latency-tests"></a>Запуск тестов задержки

* На *получателе* запустите latte.exe (запустите его из окна CMD, а не из PowerShell):

    ```cmd
    latte -a <Receiver IP address>:<port> -i <iterations>
    ```

    Около 65 000 итераций достаточно долго для возврата репрезентативных результатов.

    Любой доступный номер порта прекрасно подходит.

    Если виртуальная машина имеет IP-адрес 10.0.0.4, команда будет выглядеть следующим образом:

    `latte -a 10.0.0.4:5005 -i 65100`

* На *отправителю* запустите latte.exe (запустите его из окна CMD, а не из PowerShell):

    ```cmd
    latte -c -a <Receiver IP address>:<port> -i <iterations>
    ```

    Результирующая команда совпадает с получателем, за исключением добавления &nbsp; *-c* для указания на то, что это *клиент* или *отправитель*:

    `latte -c -a 10.0.0.4:5005 -i 65100`

Дождитесь результатов. В зависимости от того, насколько далеко находятся виртуальные машины, тестирование может занять несколько минут. Рекомендуется начинать с меньшего количества итераций для проверки успешности перед выполнением длинных тестов.

## <a name="test-vms-that-are-running-linux"></a>Тестирование виртуальных машин под управлением Linux

Чтобы проверить виртуальные машины под управлением Linux, используйте [соккперф](https://github.com/mellanox/sockperf).

### <a name="install-sockperf-on-the-vms"></a>Установка Соккперф на виртуальных машинах

На виртуальных машинах Linux как *отправитель* , так и *получатель* выполните следующие команды, чтобы подготовить соккперф на виртуальных машинах. Для основных дистрибутивов предоставляются команды.

#### <a name="for-red-hat-enterprise-linux-rhelcentos"></a>Для Red Hat Enterprise Linux (RHEL)/Центос

Выполните следующие команды:

```bash
#RHEL/CentOS - Install Git and other helpful tools
    sudo yum install gcc -y -q
    sudo yum install git -y -q
    sudo yum install gcc-c++ -y
    sudo yum install ncurses-devel -y
    sudo yum install -y automake
    sudo yum install -y autoconf
```

#### <a name="for-ubuntu"></a>Для Ubuntu

Выполните следующие команды:

```bash
#Ubuntu - Install Git and other helpful tools
    sudo apt-get install build-essential -y
    sudo apt-get install git -y -q
    sudo apt-get install -y autotools-dev
    sudo apt-get install -y automake
    sudo apt-get install -y autoconf
```

#### <a name="for-all-distros"></a>Для всех дистрибутивов

Копирование, компиляция и установка Соккперф в соответствии с приведенными ниже шагами.

```bash
#Bash - all distros

#From bash command line (assumes Git is installed)
git clone https://github.com/mellanox/sockperf
cd sockperf/
./autogen.sh
./configure --prefix=

#make is slower, may take several minutes
make

#make install is fast
sudo make install
```

### <a name="run-sockperf-on-the-vms"></a>Запуск Соккперф на виртуальных машинах

После завершения установки Соккперф виртуальные машины готовы к запуску тестов задержки. 

Сначала запустите Соккперф на *получателе*.

Любой доступный номер порта прекрасно подходит. В этом примере мы используем порт 12345:

```bash
#Server/Receiver - assumes server's IP is 10.0.0.4:
sudo sockperf sr --tcp -i 10.0.0.4 -p 12345
```

Теперь, когда сервер прослушивает, клиент может начать отправку пакетов на сервер через порт, на котором он прослушивается (в данном случае 12345).

Около 100 секунд достаточно долго для возврата репрезентативных результатов, как показано в следующем примере:

```bash
#Client/Sender - assumes server's IP is 10.0.0.4:
sockperf ping-pong -i 10.0.0.4 --tcp -m 350 -t 101 -p 12345  --full-rtt
```

Дождитесь результатов. В зависимости от того, насколько далеко находятся виртуальные машины, количество итераций будет разным. Чтобы проверить успешность до выполнения более длинных тестов, рассмотрите возможность запуска с более короткими тестами около 5 секунд.

В этом примере Соккперф используется размер сообщения размером 350 байт, что является типичным для среднего пакета. Можно изменить размер выше или ниже, чтобы добиться результатов, которые точнее отражают рабочую нагрузку, выполняемую на виртуальных машинах.


## <a name="next-steps"></a>Дальнейшие действия
* Повысьте задержку с помощью [группы размещения](../virtual-machines/co-location.md)службы "близость" Azure.
* Узнайте, как [оптимизировать сетевые подключения для виртуальных машин](../virtual-network/virtual-network-optimize-network-bandwidth.md) в вашем сценарии.
* Узнайте о [том, как пропускная способность выделяется виртуальным машинам](../virtual-network/virtual-machine-network-throughput.md).
* Дополнительные сведения см. в статье [часто задаваемые вопросы о виртуальной сети Azure](../virtual-network/virtual-networks-faq.md).