---
title: Руководство. Фильтрация сетевого трафика с помощью портала Azure
titlesuffix: Azure Virtual Network
description: В этом руководстве описано, как фильтровать сетевой трафик в подсети с помощью группы безопасности сети, используя портал Azure.
services: virtual-network
documentationcenter: virtual-network
author: KumudD
tags: azure-resource-manager
Customer intent: I want to filter network traffic to virtual machines that perform similar functions, such as web servers.
ms.service: virtual-network
ms.devlang: ''
ms.topic: tutorial
ms.tgt_pltfrm: virtual-network
ms.workload: infrastructure
ms.date: 12/13/2018
ms.author: kumud
ms.openlocfilehash: 97690618de5d58fa4022d01fa36a872f9d220083
ms.sourcegitcommit: d59abc5bfad604909a107d05c5dc1b9a193214a8
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/14/2021
ms.locfileid: "98221686"
---
# <a name="tutorial-filter-network-traffic-with-a-network-security-group-using-the-azure-portal"></a>Руководство по Фильтрация сетевого трафика с помощью групп безопасности сети на портале Azure

Вы можете отфильтровать входящий и исходящий трафик в подсети виртуальной сети с помощью группы безопасности сети. Группы безопасности сети содержат правила безопасности, которые фильтруют трафик по IP-адресу, порту и протоколу. Правила безопасности применяются к ресурсам, развернутым в подсети. В этом руководстве описано следующее:

> [!div class="checklist"]
> * Создание группы безопасности сети и правил безопасности.
> * Создание виртуальной сети и привязка группы безопасности сети к подсети.
> * Развертывание виртуальных машин в подсеть.
> * Тестирование фильтров трафика

При необходимости инструкции из этого руководства можно выполнить с помощью [Azure CLI](tutorial-filter-network-traffic-cli.md) или [PowerShell](tutorial-filter-network-traffic-powershell.md).

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

## <a name="sign-in-to-azure"></a>Вход в Azure

Войдите на портал Azure по адресу https://portal.azure.com.

## <a name="create-a-virtual-network"></a>Создание виртуальной сети

1. На **домашней странице** или в меню портала Azure выберите **Создать ресурс**. 
2. Щелкните **Сеть** и выберите **Виртуальная сеть**.
3. Введите или выберите следующие значения, примите значения по умолчанию для остальных параметров и нажмите кнопку **Создать**:

    | Параметр                 | Значение                                              |
    | ---                     | ---                                                |
    | Имя                    | myVirtualNetwork                                   |
    | Пространство адресов           | 10.0.0.0/16                                        |
    | Подписка            | Выберите свою подписку.                          |
    | Группа ресурсов          | Выберите **Создать новую**, а затем введите *myResourceGroup*. |
    | Расположение                | Выберите **Восточная часть США**.                                |
    | Имя подсети            | mySubnet                                           |
    | Диапазон адреса подсети  | 10.0.0.0/24                                        |

## <a name="create-application-security-groups"></a>Создание групп безопасности приложений

Группа безопасности приложений позволяет группировать серверы с аналогичными функциями, например веб-серверы.

1. На **домашней странице** или в меню портала Azure выберите **Создать ресурс**. 
2. В поле **Поиск в Marketplace** введите *Группа безопасности приложений*. Когда в результатах поиска появится **Группа безопасности приложений**, выберите ее, потом снова щелкните **Группа безопасности приложений** на вкладке **Все**, а затем нажмите **Создать**.
3. Выберите или введите следующие сведения, а затем щелкните **Создать**.

    | Параметр        | Значение                                                         |
    | ---            | ---                                                           |
    | Имя           | myAsgWebServers                                               |
    | Подписка   | Выберите свою подписку.                                     |
    | Группа ресурсов | Щелкните **Use existing** (Использовать существующую), а затем выберите **myResourceGroup**. |
    | Расположение       | Восточная часть США                                                       |

4. Повторите шаг 3, указав следующие значения:

    | Параметр        | Значение                                                         |
    | ---            | ---                                                           |
    | Имя           | myAsgMgmtServers                                              |
    | Подписка   | Выберите свою подписку.                                     |
    | Группа ресурсов | Щелкните **Use existing** (Использовать существующую), а затем выберите **myResourceGroup**. |
    | Расположение       | Восточная часть США                                                       |

## <a name="create-a-network-security-group"></a>Создание группы безопасности сети

1. На **домашней странице** или в меню портала Azure выберите **Создать ресурс**. 
2. Выберите **Сеть**, а затем — **Группа безопасности сети**.
3. Выберите или введите следующие сведения, а затем щелкните **Создать**.

    |Параметр|Значение|
    |---|---|
    |Имя|myNsg|
    |Подписка| Выберите свою подписку.|
    |Группа ресурсов | Щелкните **Use existing** (Использовать существующую), а затем выберите *myResourceGroup*.|
    |Расположение|Восточная часть США|

## <a name="associate-network-security-group-to-subnet"></a>Связывание группы безопасности сети с подсетью

1. В поле *Поиск ресурсов, служб и документов* в верхней части портала введите *myNsg*. Когда виртуальная машина **myNsg** появится в результатах поиска, выберите ее.
2. В разделе **Параметры** выберите **Подсети**, а затем — **+ Associate** (+ Связать), как показано на следующем рисунке:

    ![Связывание группы безопасности сети (NSG) с подсетью](./media/tutorial-filter-network-traffic/associate-nsg-subnet.png)

3. В разделе **Связать подсеть** выберите **Виртуальная сеть**, а затем **myVirtualNetwork**. Выберите **Подсеть**, затем **mySubnet** и нажмите **OK**.

## <a name="create-security-rules"></a>Создание правил безопасности

1. В разделе **Параметры** выберите **Правила безопасности для входящего трафика**, а затем — **+ Добавить**, как показано на следующем рисунке:

    ![Добавление правил безопасности для входящего трафика](./media/tutorial-filter-network-traffic/add-inbound-rule.png)

2. Создайте правило безопасности, которое позволяет использование портов 80 и 443 в группе безопасности приложения **myAsgWebServers**. В разделе **Добавление правила безопасности для входящего трафика** введите или выберите следующие значения, примите остальные значения по умолчанию, а затем щелкните **Добавить**:

    | Параметр                 | Значение                                                                                                           |
    | ---------               | ---------                                                                                                       |
    | Назначение             | Выберите **Группа безопасности приложений**, а затем — **myAsgWebServers** для **группы безопасности приложений**.  |
    | Диапазоны портов назначения | Введите 80, 443                                                                                                    |
    | Протокол                | Выберите протокол TCP                                                                                                      |
    | Имя                    | Allow-Web-All                                                                                                   |

3. Выполните шаги 2 еще раз, указав следующие значения.

    | Параметр                 | Значение                                                                                                           |
    | ---------               | ---------                                                                                                       |
    | Назначение             | Выберите **Группу безопасности приложений**, а затем — **myAsgMgmtServers** для **Группы безопасности приложений**. |
    | Диапазоны портов назначения | Введите 3389                                                                                                      |
    | Протокол                | Выберите протокол TCP                                                                                                      |
    | Приоритет                | Введите 110                                                                                                       |
    | Имя                    | Allow-RDP-All                                                                                                   |

    В этом руководстве RDP (порт 3389) доступно в Интернете для виртуальной машины *myAsgMgmtServers*, которая назначена группе безопасности приложений. В рабочих средах вместо открытия порта 3389 для доступа из Интернета рекомендуется подключиться к ресурсам Azure, которыми вы хотите управлять, с помощью VPN-подключения или частного сетевого подключения.

Выполнив шаги 1–3, просмотрите созданные вами правила. Список должен выглядеть так, как показано на следующем рисунке:

![Правила безопасности](./media/tutorial-filter-network-traffic/security-rules.png)

## <a name="create-virtual-machines"></a>Создание виртуальных машин

Создайте две виртуальные машины в виртуальной сети.

### <a name="create-the-first-vm"></a>Создание первой виртуальной машины

1. На **домашней странице** или в меню портала Azure выберите **Создать ресурс**. 
2. Выберите **Вычисления**, а затем — **Windows Server 2016 Datacenter**.
3. Введите или выберите следующие значения и примите значения по умолчанию для остальных параметров.

    |Параметр|Значение|
    |---|---|
    |Подписка| Выберите свою подписку.|
    |Группа ресурсов| Щелкните **Использовать существующую** и выберите **myResourceGroup**.|
    |Имя|myVmWeb|
    |Расположение| Выберите **Восточная часть США**.|
    |Имя пользователя| Введите выбранное имя пользователя.|
    |Пароль| Введите выбранный пароль. Пароль должен включать минимум 12 символов и соответствовать [определенным требованиям к сложности](../virtual-machines/windows/faq.md?toc=%2fazure%2fvirtual-network%2ftoc.json#what-are-the-password-requirements-when-creating-a-vm).|

   

4. Выберите размер виртуальной машины и щелкните **Выбрать**.
5. В разделе **Сеть** выберите приведенные ниже значения и примите остальные значения по умолчанию.

    |Параметр|Значение|
    |---|---|
    |Виртуальная сеть |Выберите **myVirtualNetwork**.|
    |Сетевая группа безопасности сетевого адаптера |Выберите **Отсутствует**.|
  

6. Щелкните **Просмотр и создание** слева внизу, а затем **Создать**, чтобы запустить развертывание виртуальной машины.

### <a name="create-the-second-vm"></a>Создание второй виртуальной машины

Повторите шаги 1–6 снова, но на шаге 3 присвойте виртуальной машине имя *myVmMgmt*. Развертывание виртуальной машины занимает несколько минут. Не переходите к следующему шагу, пока виртуальная машина не будет развернута.

## <a name="associate-network-interfaces-to-an-asg"></a>Связывание сетевых интерфейсов с группой безопасности приложений

При создании виртуальных машин портал создал сетевой интерфейс для каждой из них и подключил сетевой интерфейс. Добавьте сетевой интерфейс для каждой виртуальной машины в одну из ранее созданных групп безопасности приложений:

1. В поле *Поиск ресурсов, служб и документов* в верхней части портала введите *myVmWeb*. Когда в результатах поиска появится виртуальная машина **myVmPrivate**, выберите ее.
2. В разделе **Параметры** выберите **Сеть**.  Выберите **Configure the application security groups** (Настройка групп безопасности приложений), потом щелкните **myAsgWebServers** для параметра **Группы безопасности приложений**, а затем нажмите **Сохранить**, как показано на следующем рисунке:

    ![Связывание с группой безопасности приложений](./media/tutorial-filter-network-traffic/associate-to-asg.png)

3. Выполните шаги 1 и 2 снова, найдите виртуальную машину **myVmMgmt** и выберите группы безопасности приложений **myAsgMgmtServers**.

## <a name="test-traffic-filters"></a>Тестирование фильтров трафика

1. Свяжитесь с виртуальной машиной *myVmMgmt*. В верхней части портала в поле поиска введите *myVmMgmt*. Когда виртуальная машина **myVmMgmt** появится в результатах поиска, выберите ее. Нажмите кнопку **Подключиться**.
2. Щелкните **Скачать RDP-файл**.
3. Откройте скачанный RDP-файл и нажмите **Подключиться**. Введите имя пользователя и пароль, указанные при создании виртуальной машины. Возможно, потребуется выбрать **More choices** (Дополнительные варианты), а затем **Use a different account** (Использовать другую учетную запись), чтобы указать учетные данные, введенные при создании виртуальной машины.
4. Щелкните **ОК**.
5. При входе в систему может появиться предупреждение о сертификате. Если вы получили предупреждение, выберите **Да** или **Продолжить**.

    Подключение будет установлено успешно, так как через порт 3389 разрешено получать входящий трафик из Интернета в группу безопасности приложений *myAsgMgmtServers*, в которой находится сетевой интерфейс, подключенный к виртуальной машине *myVmMgmt*.

6. Подключитесь к виртуальной машине *myVmWeb* из виртуальной машины *myVmMgmt*, введя следующую команду в сеансе PowerShell:

    ``` 
    mstsc /v:myVmWeb
    ```

    Вы можете подключиться к виртуальной машине myVmWeb с виртуальной машины myVmMgmt, так как виртуальные машины в одной и той же виртуальной сети могут взаимодействовать друг с другом через любой порт по умолчанию. Однако невозможно установить подключение к удаленному рабочему столу виртуальной машины *myVmWeb* из Интернета, так как правило безопасности для *myAsgWebServers* не допускает входящий трафик из Интернета через порт 3389 и входящий трафик из Интернета по умолчанию отсутствует у всех ресурсов.

7. Для установки Microsoft IIS на виртуальной машине *myVmWeb* введите следующую команду из сеанса PowerShell в виртуальной машине *myVmWeb*:

    ```powershell
    Install-WindowsFeature -name Web-Server -IncludeManagementTools
    ```

8. Когда установка служб IIS завершится, отключитесь от виртуальной машины *myVmWeb*, после чего вы останетесь в сеансе удаленного рабочего стола виртуальной машины *myVmMgmt*.
9. Отключитесь от виртуальной машины *myVmMgmt*.
10. В поле *Поиск ресурсов, служб и документов* в верхней части портала Azure введите *myVmWeb* со своего компьютера. При появлении **myVmWeb** в результатах поиска выберите ее. Запишите **общедоступный IP-адрес** своей виртуальной машины. Адрес, показанный на следующем рисунке, — 137.135.84.74, но ваш адрес другой:

    ![Общедоступный IP-адрес](./media/tutorial-filter-network-traffic/public-ip-address.png)
  
11. Чтобы убедиться в наличии доступа к веб-серверу *myVmWeb* из Интернета, откройте веб-браузер на своем компьютере и перейдите по адресу `http://<public-ip-address-from-previous-step>`. Вы увидите экран приветствия службы IIS, так как через порт 80 разрешено получение входящего трафика из Интернета в группу безопасности приложений *myAsgWebServers*, в которой находится сетевой интерфейс, подключенный к виртуальной машине *myVmWeb*.

## <a name="clean-up-resources"></a>Очистка ресурсов

Удалите группу ресурсов и все содержащиеся в ней ресурсы, когда она станет не нужна.

1. В поле **Поиск** в верхней части портала введите *myResourceGroup*. Когда группа ресурсов **myResourceGroup** появится в результатах поиска, выберите ее.
2. Выберите **Удалить группу ресурсов**.
3. Введите *myResourceGroup* в поле **TYPE THE RESOURCE GROUP NAME:** (Введите имя группы ресурсов:) и нажмите кнопку **Удалить**.

## <a name="next-steps"></a>Дальнейшие действия

В этом руководстве вы создали группу безопасности сети и связали ее с подсетью виртуальной сети. Дополнительные сведения о группах безопасности сети см. в статьях [Безопасность сети](./network-security-groups-overview.md) и [Create, change, or delete a network security group](manage-network-security-group.md) (Создание, изменение или удаление группы безопасности сети).

Azure маршрутизирует трафик между подсетями по умолчанию. Вместо этого вы можете перенаправлять трафик между подсетями через виртуальную машину, которая используется в качестве брандмауэра. Чтобы узнать, как создать таблицу маршрутов, перейдите к следующему руководству.

> [!div class="nextstepaction"]
> [Создание таблицы маршрутов](./tutorial-create-route-table-portal.md)