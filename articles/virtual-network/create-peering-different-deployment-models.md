---
title: Создание пиринга виртуальных сетей Azure с разными моделями развертывания в одной подписке | Документация Майкрософт
description: Узнайте, как создать пиринг между виртуальными сетями, созданными с помощью разных моделей развертывания Azure, которые существуют в одной подписке Azure.
services: virtual-network
documentationcenter: ''
author: KumudD
manager: mtillman
editor: ''
tags: azure-resource-manager
ms.assetid: ''
ms.service: virtual-network
ms.devlang: na
ms.topic: how-to
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 11/15/2018
ms.author: kumud
ms.reviewer: anavin
ms.openlocfilehash: 1ff9fcbb693f7e606c07985f9bce9acd60c5591a
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "98222978"
---
# <a name="create-a-virtual-network-peering---different-deployment-models-same-subscription"></a>Создание пиринга виртуальных сетей с разными моделями развертывания в одной подписке

В этом руководстве вы узнаете, как создать пиринг между виртуальными сетями, созданными с помощью разных моделей развертывания. Обе виртуальные сети относятся к одной и той же подписке. Установление пиринга между двумя виртуальными сетями позволяет ресурсам в разных виртуальных сетях взаимодействовать друг с другом с такими же пропускной способностью и задержкой, как если бы эти ресурсы находились в одной виртуальной сети. Узнайте больше о [пиринге виртуальных сетей](virtual-network-peering-overview.md).

Действия по созданию пиринга виртуальных сетей зависят от того, находятся ли виртуальные сети в одной или разных подписках, и того, какая [модель развертывания Azure](../azure-resource-manager/management/deployment-models.md?toc=%2fazure%2fvirtual-network%2ftoc.json) использовалась для их создания. Узнайте, как создать пиринг виртуальных сетей в других сценариях, щелкнув сценарий в следующей таблице.

|Модель развертывания Azure  | Подписка Azure.  |
|--------- |---------|
|[Обе Resource Manager](tutorial-connect-virtual-networks-portal.md) |Аналогично|
|[Обе Resource Manager](create-peering-different-subscriptions.md) |Разные|
|[Одна виртуальная сеть Resource Manager, одна классическая виртуальная сеть](create-peering-different-deployment-models-subscriptions.md) |Разные|

Создать пиринг между двумя виртуальными сетями, развернутыми с помощью классической модели развертывания, невозможно. Если вам необходимо подключить виртуальные сети, созданные с помощью классической модели развертывания, можно использовать [VPN-шлюз](../vpn-gateway/tutorial-site-to-site-portal.md?toc=%2fazure%2fvirtual-network%2ftoc.json) Azure.

Это руководство по созданию пиринга между виртуальными сетями в одном регионе. Пиринг можно создавать между виртуальными сетями в разных [поддерживаемых регионах](virtual-network-manage-peering.md#cross-region). Рекомендуется ознакомиться с [требованиями и ограничениями пиринга](virtual-network-manage-peering.md#requirements-and-constraints) перед созданием пиринга виртуальных сетей.

Для создания пиринга виртуальных сетей можно использовать портал Azure, [интерфейс командной строки](#cli) Azure (CLI), Azure [PowerShell](#powershell)или шаблон Azure Resource Manager. Щелкните любую из предыдущих ссылок на инструмент, чтобы перейти непосредственно к инструкциям по созданию пиринга виртуальных сетей с помощью выбранного инструмента.

## <a name="create-peering---azure-portal"></a>Создание пиринга с помощью портала Azure

1. Войдите на [портал Azure](https://portal.azure.com). У учетной записи, используемой для входа, должны быть необходимые разрешения для создания пиринга виртуальных сетей. Список разрешений см. в разделе [Создание, изменение и удаление пиринга в виртуальной сети](virtual-network-manage-peering.md#requirements-and-constraints).
2. Щелкните **+ Создать**, выберите **Сети** и щелкните **Виртуальная сеть**.
3. В колонке **Создание виртуальной сети** введите или выберите значения для приведенных ниже параметров и щелкните **Создать**.
    - **Имя**: *myVnet1*.
    - **Диапазон адресов**: *10.0.0.0/16*.
    - **Имя подсети**: *по умолчанию*.
    - **Диапазон адресов подсети**: *10.0.0.0/24*.
    - **Подписка**: выберите подписку.
    - **Группа ресурсов**: установите флажок **Создать** и введите *myResourceGroup*.
    - **Расположение.** *восточная часть США*.
4. Щелкните **+ Создать**. В поле **Поиск по Marketplace** введите *Виртуальная сеть*. Когда в результатах поиска появится пункт **Виртуальная сеть**, щелкните его.
5. В колонке **Виртуальная сеть** в поле **Выбор модели развертывания** выберите **Классический** и нажмите кнопку **Создать**.
6. В колонке **Создание виртуальной сети** введите или выберите значения для приведенных ниже параметров и щелкните **Создать**.
    - **Имя**: *myVnet2*.
    - **Диапазон адресов**: *10.1.0.0/16*.
    - **Имя подсети**: *по умолчанию*.
    - **Диапазон адресов подсети**: *10.1.0.0/24*.
    - **Подписка**: выберите подписку.
    - **Группа ресурсов**: выберите **использовать существующий** и выберите *myResourceGroup* .
    - **Расположение.** *восточная часть США*.
7. В поле **Поиск ресурсов**, находящемся в верхней части портала, введите *myResourceGroup*. Когда группа ресурсов **myResourceGroup** появится в результатах поиска, щелкните ее. Откроется колонка группы ресурсов **myResourceGroup**. Эта группа ресурсов содержит две виртуальные сети, созданные на предыдущих шагах.
8. Щелкните сеть **myVNet1**.
9. В вертикальном списке параметров в левой части отобразившейся колонки **myVnet1** щелкните **Пиринги**.
10. В открывшейся колонке **myVnet1 — пиринги** щелкните **+ Добавить**.
11. В открывшейся колонке **Добавить пиринг** введите или выберите значения приведенных ниже параметров, после чего нажмите кнопку **ОК**.
     - **Имя**: *myVnet1ToMyVnet2*.
     - **Модель развертывания виртуальной сети**: выберите **Классический**.
     - **Подписка**: выберите подписку.
     - **Виртуальная сеть**: щелкните **Выбор виртуальной сети**, затем выберите **myVnet2**.
     - **Разрешить доступ к виртуальным сетям**: выберите значение **Включено**.
    Другие параметры в этом руководстве не используются. Чтобы узнать о всех параметрах пиринга, прочитайте раздел [Создание, изменение и удаление пиринга в виртуальной сети](virtual-network-manage-peering.md#create-a-peering).
12. После нажатия кнопки **ОК** на предыдущем шаге колонка **Добавить пиринг** закроется, и вы снова увидите колонку **myVnet1 — пиринги**. Через несколько секунд созданный пиринг отобразится в этой колонке. В столбце **Состояние пиринга** для созданного пиринга **myVnet1ToMyVnet2** указано состояние **Подключено**.

    Пиринг установлен. Теперь все ресурсы Azure, созданные в любой из виртуальных сетей, могут взаимодействовать друг с другом, используя свои IP-адреса. Если вы используете для виртуальных сетей стандартное разрешение имен Azure, то ресурсы в этих виртуальных сетях не смогут разрешать имена между виртуальными сетями. Если требуется разрешение имен между виртуальными сетями в пиринге, необходимо создать собственный DNS-сервер. Узнайте, как настроить [разрешение имен с помощью собственного DNS-сервера](virtual-networks-name-resolution-for-vms-and-role-instances.md#name-resolution-that-uses-your-own-dns-server).
13. **Необязательно**. Хотя в этом руководстве не рассматривается создание виртуальных машин, создайте по одной виртуальной машине в каждой виртуальной сети и подключите их между собой, чтобы проверить связь.
14. **Необязательно**: чтобы удалить ресурсы, созданные при работе с этим руководством, выполните инструкции, описанные в разделе [Удаление ресурсов](#delete-portal) этой статьи.

## <a name="create-peering---azure-cli"></a><a name="cli"></a>Создание пиринга с помощью Azure CLI

Выполните следующие действия с помощью классического интерфейса командной строки Azure и Azure CLI. Действия из Azure Cloud Shell можно выполнить, только выбрав кнопку **Попробовать** в любом из следующих действий или установив [классический интерфейс командной строки](/cli/azure/install-cli-version-1.0?toc=%2fazure%2fvirtual-network%2ftoc.json) и [CLI](/cli/azure/install-azure-cli?toc=%2fazure%2fvirtual-network%2ftoc.json) и выполнив команды на локальном компьютере.

1. При использовании Cloud Shell перейдите к шагу 2, так как Cloud Shell выполняет автоматический вход Azure. Запустите сеанс командной строки и войдите в Azure с помощью команды `azure login`.
2. Запустите интерфейс командной строки в режиме управления службами, введя команду `azure config mode asm`.
3. Чтобы создать классическую виртуальную сеть, введите приведенную ниже команду.

   ```azurecli-interactive
   azure network vnet create --vnet myVnet2 --address-space 10.1.0.0 --cidr 16 --location "East US"
   ```

4. Выполните следующий сценарий bash CLI с помощью CLI, а не классический интерфейс командной строки. Сведения о вариантах выполнения скриптов Bash CLI в клиенте Windows см. в статье [Установка Azure CLI в Windows](/cli/azure/install-azure-cli-windows).

   ```azurecli-interactive
   #!/bin/bash

   # Create a resource group.
   az group create \
     --name myResourceGroup \
     --location eastus

   # Create the virtual network (Resource Manager).
   az network vnet create \
     --name myVnet1 \
     --resource-group myResourceGroup \
     --location eastus \
     --address-prefix 10.0.0.0/16
   ```

5. Создайте пиринг между двумя виртуальными сетями, созданными с помощью разных моделей развертывания, используя CLI. Скопируйте следующий сценарий в текстовый редактор на своем компьютере. Замените `<subscription id>` идентификатором своей подписки. Если вам неизвестен идентификатор подписки, выполните команду `az account show`. Значением **идентификатора** в выходных данных является идентификатор подписки. Вставьте измененный сценарий в окно сеанса интерфейса командной строки и нажмите клавишу `Enter`.

   ```azurecli-interactive
   # Get the ID for VNet1.
   vnet1Id=$(az network vnet show \
     --resource-group myResourceGroup \
     --name myVnet1 \
     --query id --out tsv)

   # Peer VNet1 to VNet2.
   az network vnet peering create \
     --name myVnet1ToMyVnet2 \
     --resource-group myResourceGroup \
     --vnet-name myVnet1 \
     --remote-vnet-id /subscriptions/<subscription id>/resourceGroups/Default-Networking/providers/Microsoft.ClassicNetwork/virtualNetworks/myVnet2 \
     --allow-vnet-access
   ```

6. После выполнения сценария просмотрите сведения о пиринге виртуальной сети Resource Manager. Скопируйте следующую команду, вставьте ее в окно сеанса интерфейса командной строки и нажмите клавишу `Enter`.

   ```azurecli-interactive
   az network vnet peering list \
     --resource-group myResourceGroup \
     --vnet-name myVnet1 \
     --output table
   ```

   В выходных данных в столбце **PeeringState** (Состояние пиринга) указано состояние **Connected** (Подключен).

   Теперь все ресурсы Azure, созданные в любой из виртуальных сетей, могут взаимодействовать друг с другом, используя свои IP-адреса. Если вы используете для виртуальных сетей стандартное разрешение имен Azure, то ресурсы в этих виртуальных сетях не смогут разрешать имена между виртуальными сетями. Если требуется разрешение имен между виртуальными сетями в пиринге, необходимо создать собственный DNS-сервер. Узнайте, как настроить [разрешение имен с помощью собственного DNS-сервера](virtual-networks-name-resolution-for-vms-and-role-instances.md#name-resolution-that-uses-your-own-dns-server).
7. **Необязательно**. Хотя в этом руководстве не рассматривается создание виртуальных машин, создайте по одной виртуальной машине в каждой виртуальной сети и подключите их между собой, чтобы проверить связь.
8. **Необязательно**: чтобы удалить ресурсы, созданные при работе с этим руководством, выполните инструкции, описанные в разделе [Удаление ресурсов](#delete-cli) этой статьи.

## <a name="create-peering---powershell"></a><a name="powershell"></a>Создание пиринга с помощью PowerShell

1. Установите последнюю версию модулей PowerShell [Azure](https://www.powershellgallery.com/packages/Azure) и [AZ](https://www.powershellgallery.com/packages/Az/) . Если вы еще не работали с Azure PowerShell, ознакомьтесь со статьей [Overview of Azure PowerShell](/powershell/azure/?toc=%2fazure%2fvirtual-network%2ftoc.json) (Общие сведения об Azure PowerShell).
2. Запустите сеанс PowerShell.
3. В PowerShell войдите в Azure, выполнив команду `Add-AzureAccount`. У учетной записи, используемой для входа, должны быть необходимые разрешения для создания пиринга виртуальных сетей. Список разрешений см. в разделе [Создание, изменение и удаление пиринга в виртуальной сети](virtual-network-manage-peering.md#requirements-and-constraints).
4. Чтобы создать классическую виртуальную сеть с помощью PowerShell, необходимо создать новый или изменить существующий файл конфигурации сети. Узнайте, как [экспортировать, обновлять и импортировать файлы конфигурации сети](/previous-versions/azure/virtual-network/virtual-networks-using-network-configuration-file). Файл должен содержать приведенный ниже элемент **VirtualNetworkSite** для виртуальной сети, используемой в этом руководстве.

    ```xml
    <VirtualNetworkSite name="myVnet2" Location="East US">
      <AddressSpace>
        <AddressPrefix>10.1.0.0/16</AddressPrefix>
      </AddressSpace>
      <Subnets>
        <Subnet name="default">
          <AddressPrefix>10.1.0.0/24</AddressPrefix>
        </Subnet>
      </Subnets>
    </VirtualNetworkSite>
    ```

    > [!WARNING]
    > Импорт измененного файла конфигурации сети может привести к изменениям в классических виртуальных сетях в вашей подписке. Убедитесь, что вы добавили только указанную выше виртуальную сеть и не изменили или удалили имеющиеся в своей подписке виртуальные сети.
5. Выполните команду `Connect-AzAccount`, чтобы войти в Azure и создать виртуальную сеть (Resource Manager). У учетной записи, используемой для входа, должны быть необходимые разрешения для создания пиринга виртуальных сетей. Список разрешений см. в разделе [Создание, изменение и удаление пиринга в виртуальной сети](virtual-network-manage-peering.md#requirements-and-constraints).
6. Создайте группу ресурсов и виртуальную сеть Resource Manager. Скопируйте сценарий, вставьте его в окно сеанса PowerShell и нажмите клавишу `Enter`.

    ```powershell
    # Create a resource group.
      New-AzResourceGroup -Name myResourceGroup -Location eastus

    # Create the virtual network (Resource Manager).
      $vnet1 = New-AzVirtualNetwork `
      -ResourceGroupName myResourceGroup `
      -Name 'myVnet1' `
      -AddressPrefix '10.0.0.0/16' `
      -Location eastus
    ```

7. Создайте пиринг между двумя виртуальными сетями, созданными с помощью разных моделей развертывания. Скопируйте следующий сценарий в текстовый редактор на своем компьютере. Замените `<subscription id>` идентификатором своей подписки. Если вам неизвестен идентификатор подписки, выполните команду `Get-AzSubscription`, чтобы узнать его. Значение **Id** (Идентификатор) в полученных выходных данных является идентификатором вашей подписки. Чтобы выполнить сценарий, скопируйте измененный сценарий из текстового редактора, затем щелкните правой кнопкой мыши в окне сеанса PowerShell и нажмите клавишу `Enter`.

    ```powershell
    # Peer VNet1 to VNet2.
    Add-AzVirtualNetworkPeering `
      -Name myVnet1ToMyVnet2 `
      -VirtualNetwork $vnet1 `
      -RemoteVirtualNetworkId /subscriptions/<subscription Id>/resourceGroups/Default-Networking/providers/Microsoft.ClassicNetwork/virtualNetworks/myVnet2
    ```

8. После выполнения сценария просмотрите сведения о пиринге виртуальной сети Resource Manager. Скопируйте следующую команду, вставьте ее в окно сеанса PowerShell и нажмите клавишу `Enter`.

    ```powershell
    Get-AzVirtualNetworkPeering `
      -ResourceGroupName myResourceGroup `
      -VirtualNetworkName myVnet1 `
      | Format-Table VirtualNetworkName, PeeringState
    ```

    В выходных данных в столбце **PeeringState** (Состояние пиринга) указано состояние **Connected** (Подключен).

    Теперь все ресурсы Azure, созданные в любой из виртуальных сетей, могут взаимодействовать друг с другом, используя свои IP-адреса. Если вы используете для виртуальных сетей стандартное разрешение имен Azure, то ресурсы в этих виртуальных сетях не смогут разрешать имена между виртуальными сетями. Если требуется разрешение имен между виртуальными сетями в пиринге, необходимо создать собственный DNS-сервер. Узнайте, как настроить [разрешение имен с помощью собственного DNS-сервера](virtual-networks-name-resolution-for-vms-and-role-instances.md#name-resolution-that-uses-your-own-dns-server).

9. **Необязательно**. Хотя в этом руководстве не рассматривается создание виртуальных машин, создайте по одной виртуальной машине в каждой виртуальной сети и подключите их между собой, чтобы проверить связь.
10. **Необязательно**: чтобы удалить ресурсы, созданные при работе с этим руководством, выполните инструкции, описанные в разделе [Удаление ресурсов](#delete-powershell) этой статьи.

## <a name="delete-resources"></a><a name="delete"></a>Удаление ресурсов

По завершении работы с этим руководством может потребоваться удалить созданные в его рамках ресурсы, чтобы за их использование не взималась плата. При удалении группы ресурсов будут также удалены все ресурсы, содержащиеся в ней.

### <a name="azure-portal"></a><a name="delete-portal"></a>Портал Azure

1. В поле поиска на портале введите **myResourceGroup**. В результатах поиска щелкните **myResourceGroup**.
2. В колонке **myResourceGroup** щелкните значок **Удалить** .
3. Чтобы подтвердить удаление, в поле **введите имя группы ресурсов** введите **myResourceGroup** и нажмите кнопку **Удалить**.

### <a name="azure-cli"></a><a name="delete-cli"></a>Интерфейс командной строки Azure

1. Используйте Azure CLI, чтобы удалить виртуальную сеть Resource Manager с помощью приведенной ниже команды:

    ```azurecli-interactive
    az group delete --name myResourceGroup --yes
    ```

2. Чтобы удалить классическую виртуальную сеть, выполните в классической командной строке следующие команды:

    ```azurecli-interactive
    azure config mode asm

    azure network vnet delete --vnet myVnet2 --quiet
    ```

### <a name="powershell"></a><a name="delete-powershell"></a>PowerShell

1. Введите приведенную ниже команду, чтобы удалить виртуальную сеть Resource Manager.

    ```powershell
    Remove-AzResourceGroup -Name myResourceGroup -Force
    ```

2. Чтобы удалить классическую виртуальную сеть с помощью PowerShell, необходимо изменить существующий файл конфигурации сети. Узнайте, как [экспортировать, обновлять и импортировать файлы конфигурации сети](/previous-versions/azure/virtual-network/virtual-networks-using-network-configuration-file). Удалите приведенный ниже элемент VirtualNetworkSite для виртуальной сети, используемой в этом руководстве.

    ```xml
    <VirtualNetworkSite name="myVnet2" Location="East US">
      <AddressSpace>
        <AddressPrefix>10.1.0.0/16</AddressPrefix>
      </AddressSpace>
      <Subnets>
        <Subnet name="default">
          <AddressPrefix>10.1.0.0/24</AddressPrefix>
        </Subnet>
      </Subnets>
    </VirtualNetworkSite>
    ```

    > [!WARNING]
    > Импорт измененного файла конфигурации сети может привести к изменениям в классических виртуальных сетях в вашей подписке. Убедитесь, что вы удалили только указанную выше виртуальную сеть и не изменили или удалили другие виртуальные сети в своей подписке.

## <a name="next-steps"></a>Дальнейшие действия

- Внимательно ознакомьтесь с важными [ограничениями и особенностями работы пиринга виртуальных сетей](virtual-network-manage-peering.md#requirements-and-constraints), прежде чем создавать пиринг виртуальных сетей для рабочей среды.
- Узнайте о [параметрах пиринга виртуальных сетей](virtual-network-manage-peering.md#create-a-peering).
- Узнайте, как [создать звездообразную топологию сети](/azure/architecture/reference-architectures/hybrid-networking/hub-spoke#virtual-network-peering) с помощью пиринга виртуальных сетей.