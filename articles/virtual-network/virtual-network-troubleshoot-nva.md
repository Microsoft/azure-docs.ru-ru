---
title: Устранение неполадок сетевого виртуального модуля в Azure | Документация Майкрософт
description: Устранение неполадок сетевого виртуального устройства (NVA) в Azure и проверка основных требований к платформе Azure для конфигураций NVA.
services: virtual-network
documentationcenter: na
author: genlin
manager: dcscontentpm
editor: ''
tags: azure-resource-manager
ms.service: virtual-network
ms.devlang: na
ms.topic: troubleshooting
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 10/26/2018
ms.author: genli
ms.openlocfilehash: 18f2128b6869b4047cc6f35e1638aca81233a014
ms.sourcegitcommit: d59abc5bfad604909a107d05c5dc1b9a193214a8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/14/2021
ms.locfileid: "98219289"
---
# <a name="network-virtual-appliance-issues-in-azure"></a>Неполадки сетевого виртуального модуля в Azure

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

При использовании стороннего сетевого виртуального модуля (NVA) в Microsoft Azure могут возникнуть проблемы и ошибки подключения к виртуальной машине или VPN. В этой статье приведены основные шаги, которые помогут вам проверить базовые требования к конфигурациям NVA на платформе Azure.

Поставщик NVA обеспечивает техническую поддержку сторонних модулей NVA и их интеграцию с платформой Azure.

> [!NOTE]
> Если у вас есть проблема с подключением или маршрутизацией, которая связана с NVA, вы должны [напрямую обратиться к поставщику NVA](https://support.microsoft.com/help/2984655/support-for-azure-market-place-for-virtual-machines).

[!INCLUDE [support-disclaimer](../../includes/support-disclaimer.md)]

## <a name="checklist-for-troubleshooting-with-nva-vendor"></a>Контрольный список для устранения неполадок при помощи поставщика NVA

- Обновления программного обеспечения для программного обеспечения виртуальной машины NVA.
- Настройка учетной записи службы и ее функций.
- Определенные пользователем маршруты (UDR) в подсетях виртуальной сети, которые направляют трафик к модулям NVA.
- Маршруты UDR в подсетях виртуальной сети, которые направляют трафик из модулей NVA.
- Маршрутизация таблиц и правил в модулях NVA (например, из NIC1 в NIC2).
- Трассировка в сетевых адаптерах NVA для проверки входящего и исходящего трафика.
- При использовании SKU "Стандартный" и общедоступных IP-адресов необходимо создать NSG и явное правило, чтобы разрешить маршрутизацию трафика в NVA.

## <a name="basic-troubleshooting-steps"></a>Основные шаги по устранению неполадок

- Проверка базовой конфигурации.
- Проверка производительности NVA.
- Устранение неполадок с расширенными функциями сети.

## <a name="check-the-minimum-configuration-requirements-for-nvas-on-azure"></a>Проверка минимальных требований к конфигурации модулей NVA в Azure

Для каждого модуля NVA предусмотрены базовые требования к конфигурации для правильной работы в Azure. В следующем разделе приведены шаги для проверки этих основных конфигураций. Для получения дополнительных сведений [свяжитесь с поставщиком NVA](https://support.microsoft.com/help/2984655/support-for-azure-market-place-for-virtual-machines).

**Проверка того, включена ли в модуле NVA переадресация IP-адресов**

Использование портала Azure

1. Найдите ресурс модуля NVA на [портале Azure](https://portal.azure.com), выберите "Сети", а затем — "Сетевой интерфейс".
2. На странице сетевого интерфейса выберите IP-конфигурацию.
3. Включите переадресацию IP-адресов.

Использование PowerShell

1. Откройте PowerShell и войдите в свою учетную запись Azure.
2. Выполните следующую команду (замените значения в скобках своими значениями):

   ```powershell
   Get-AzNetworkInterface -ResourceGroupName <ResourceGroupName> -Name <NicName>
   ```

3. Проверьте, чтобы было включено свойство **EnableIPForwarding**.
4. Если IP-пересылка отключена, выполните следующие команды, чтобы включить ее:

   ```powershell
   $nic2 = Get-AzNetworkInterface -ResourceGroupName <ResourceGroupName> -Name <NicName>
   $nic2.EnableIPForwarding = 1
   Set-AzNetworkInterface -NetworkInterface $nic2
   Execute: $nic2 #and check for an expected output:
   EnableIPForwarding   : True
   NetworkSecurityGroup : null
   ```

**Проверять наличие NSG при использовании IP-адреса SKU "Стандартный" пубилк** При использовании SKU "Стандартный" и общедоступных IP-адресов необходимо создать NSG и явное правило, чтобы разрешить трафик к NVA.

**Проверьте, может ли трафик маршрутизироваться к NVA.**

1. На [портале Azure](https://portal.azure.com) откройте раздел **Наблюдатель за сетями** и выберите **Следующий прыжок**.
2. Укажите виртуальную машину, настроенную для перенаправления трафика к модулю NVA, и IP-адрес назначения, по которому можно просмотреть следующий прыжок. 
3. Если модуль NVA не указан в списке как **следующий прыжок**, проверьте и обновите таблицы маршрутов Azure.

**Проверка того, доходит ли трафик до модуля NVA**

1. На [портале Azure](https://portal.azure.com) откройте раздел **Наблюдатель за сетями**, а затем выберите **Проверка IP-потока**. 
2. Укажите виртуальную машину и IP-адрес модуля NVA, а затем проверьте, блокируется ли трафик группами безопасности сети (NSG).
3. Если есть правило NSG, которое блокирует трафик, найдите его в правилах **эффективной безопасности** и обновите, чтобы разрешить трафик. Затем снова запустите команду **Проверка IP-потока** и используйте параметр **устранения неполадок подключения**, чтобы проверить TCP-подключения из виртуальной машины к внутреннему или внешнему IP-адресу.

**Проверка того, прослушивают ли виртуальные машины и модуль NVA для получения ожидаемого трафика**

1. Подключитесь к модулю NVA с помощью протокола RDP или SSH, а затем выполните следующую команду.

    Для Windows:

    ```console
   netstat -an
    ```

    Для Linux:

    ```console
   netstat -an | grep -i listen
    ```
2. Если вы не видите TCP-порт, который используется программным обеспечением модуля NVA, указанным в результатах, нужно настроить приложение в модуле NVA и на виртуальной машине для прослушивания трафика, который доходит до этих портов, и соответствующего реагирования на него. [При необходимости свяжитесь с поставщиком NVA](https://support.microsoft.com/help/2984655/support-for-azure-market-place-for-virtual-machines).

## <a name="check-nva-performance"></a>Проверка производительности NVA

### <a name="validate-vm-cpu"></a>Проверка ЦП виртуальной машины

Если загрузка ЦП приближается к 100 процентам, могут возникнуть проблемы, влияющие на удаление сетевых пакетов. Виртуальная машина предоставляет отчет о средней загрузке ЦП за определенный период времени на портале Azure. Во время пика загрузки ЦП проанализируйте, какой процесс на гостевой виртуальной машине вызывает высокое потребление ЦП, и при возможности остановите его. Возможно, вам также придется изменить размер виртуальной машины на более крупный размер SKU. Для масштабируемого набора виртуальных машин увеличьте количество экземпляров или установите автоматическое масштабирование с учетом использования ЦП. При необходимости [обратитесь к поставщику NVA за помощью](https://support.microsoft.com/help/2984655/support-for-azure-market-place-for-virtual-machines)по любой из этих проблем.

### <a name="validate-vm-network-statistics"></a>Проверка статистики сети виртуальных машин

Если в сети виртуальных машин наблюдаются всплески или отображаются периоды высокой нагрузки, вам также может потребоваться увеличить размер номера SKU виртуальной машины для получения более высокой пропускной способности. Вы также можете повторно развернуть виртуальную машину, включив параметр "Ускоренная сеть". Чтобы проверить, поддерживает ли модуль NVA функцию ускоренной сети, [при необходимости свяжитесь с поставщиком NVA](https://support.microsoft.com/help/2984655/support-for-azure-market-place-for-virtual-machines).

## <a name="advanced-network-administrator-troubleshooting"></a>Устранение неполадок с расширенными функциями сети администратором

### <a name="capture-network-trace"></a>Запись трассировки сети
Запустив **[PsPing](/sysinternals/downloads/psping)** или **Nmap**, записывайте одновременную трассировку сети на исходной виртуальной машине, модуле NVA и виртуальной машине назначения, а затем остановите трассировку.

1. Чтобы записать параллельную трассировку сети, выполните следующую команду.

   **Для Windows**

   Netsh трассировка начало записи = Yes TraceFile = c:\ server_IP. ETL, сценарий = NetConnection

   **Для Linux**

   sudo tcpdump-S0-i eth0-X-w vmtrace. Cap

2. Используйте **PsPing** или **Nmap** из исходной виртуальной машины к виртуальной машине назначения (например, `PsPing 10.0.0.4:80` или `Nmap -p 80 10.0.0.4`).
3. Откройте трассировку сети из виртуальной машины назначения с помощью [Network Monitor](https://download.cnet.com/s/network-monitor) или tcpdump. Примените фильтр по IP-адресу исходной виртуальной машины, с которой вы выполняли **PsPing** или **Nmap** (например, `IPv4.address==10.0.0.4 (Windows netmon)` или `tcpdump -nn -r vmtrace.cap src or dst host 10.0.0.4` (Linux)).

### <a name="analyze-traces"></a>Анализ трассировок

Если входящие пакеты не отображаются в трассировке на внутренней виртуальной машине, скорее всего, этому препятствуют настройки группы безопасности сети, определенные пользователем маршрутизации или неправильные таблицы маршрутов модуля NVA.

Если входящие пакеты отображаются, но не отвечают, возможно, проблема в приложении виртуальной машины или брандмауэре. При возникновении любой из этих проблем [при необходимости свяжитесь с поставщиком NVA](https://support.microsoft.com/help/2984655/support-for-azure-market-place-for-virtual-machines).