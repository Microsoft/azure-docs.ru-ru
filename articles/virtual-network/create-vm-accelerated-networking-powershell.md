---
title: Создание виртуальной машины Windows с ускоренной сетью — Azure PowerShell
description: Создайте виртуальную машину Windows с ускоренной сетью, чтобы значительно повысить производительность сети.
services: virtual-network
documentationcenter: ''
author: gsilva5
manager: gedegrac
editor: ''
ms.assetid: ''
ms.service: virtual-network
ms.devlang: na
ms.topic: how-to
ms.tgt_pltfrm: vm-windows
ms.workload: infrastructure
ms.date: 04/15/2020
ms.author: gsilva
ms.openlocfilehash: b3728a2b67529bab0900d42b3e39140d9329bc83
ms.sourcegitcommit: d59abc5bfad604909a107d05c5dc1b9a193214a8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/14/2021
ms.locfileid: "98223641"
---
# <a name="create-a-windows-vm-with-accelerated-networking-using-azure-powershell"></a>Создание виртуальной машины Windows с функцией ускорения сети с помощью Azure PowerShell

В этом руководстве вы узнаете, как создать виртуальную машину Windows с ускоренной сетью.

> [!NOTE]
> Сведения об использовании ускоренной сети с виртуальной машиной Linux см. в статье [Создание виртуальной машины Linux с ускоренной сетью](create-vm-accelerated-networking-cli.md).

Функция ускорения сети позволяет использовать виртуализацию ввода-вывода с единым корнем (SR-IOV), повышая тем самым производительность сети виртуальной машины. Этот высокопроизводительный путь обходит узел из пути к данным, что сокращает задержку, колебание и загрузку ЦП для наиболее требовательных сетевых рабочих нагрузок на поддерживаемых типах виртуальных машин. На следующей схеме показано, как две виртуальные машины взаимодействуют с и без ускорения работы в сети.

![Обмен данными между виртуальными машинами Azure и без них с ускоренной сетью](./media/create-vm-accelerated-networking/accelerated-networking.png)

Без функции ускорения сети весь входящий и исходящий сетевой трафик виртуальной машины должен проходить через узел и виртуальный коммутатор. Виртуальный коммутатор обеспечивает принудительное применение всех политик, таких как группы безопасности сети, списки управления доступом, изоляция, и использование других служб виртуализации сети для сетевого трафика.

> [!NOTE]
> Дополнительные сведения о виртуальных коммутаторах см. в статье [виртуальный коммутатор Hyper-V](/windows-server/virtualization/hyper-v-virtual-switch/hyper-v-virtual-switch).

При использовании ускоренной сети сетевой трафик поступает на сетевой интерфейс виртуальной машины и перенаправляется на ВИРТУАЛЬную машину. Все сетевые политики, которые применяет виртуальный коммутатор, выгружены и применяются на аппаратном уровне. Так как политика применяется в оборудовании, сетевая карта может перенаправлять сетевой трафик непосредственно на виртуальную машину. Сетевая карта обходит узел и виртуальный коммутатор, в то время как он сохраняет всю политику, примененную на узле.

Преимущества ускорения работы в сети применяются только к виртуальной машине, на которой она включена. Для получения наилучших результатов включите эту функцию по крайней мере на двух виртуальных машинах, подключенных к одной виртуальной сети Azure. При обмене данными между виртуальными сетями или подключением в локальной среде эта функция оказывает минимальное влияние на общую задержку.

## <a name="benefits"></a>Преимущества

- **Меньше задержек и более высоких пакетов в секунду (PPS)**. Удаление виртуального коммутатора из пути к данным приводит к удалению в узле времени, затрачиваемого на обработку политики. Кроме того, увеличивается число пакетов, которые могут быть обработаны в виртуальной машине.

- **Снижение колебаний**. обработка виртуального коммутатора зависит от объема политики, которую необходимо применить. Он также зависит от рабочей нагрузки процессора, выполняющего обработку. Разгрузка применения политики к оборудованию устраняет эту вариативность за счет доставки пакетов непосредственно на виртуальную машину. При разгрузке также удаляются связи между виртуальными машинами, все программные прерывания и переключения контекста.

- **Уменьшение загрузки ЦП**. обход виртуального коммутатора на узле приводит к снижению загрузки ЦП для обработки сетевого трафика.

## <a name="supported-operating-systems"></a>Поддерживаемые операционные системы

Следующие дистрибутивы поддерживаются непосредственно из коллекции Azure:

- **Windows Server 2019 Datacenter**
- **Windows Server 2016 Datacenter** 
- **Windows Server 2012 R2 Datacenter**

## <a name="limitations-and-constraints"></a>Пределы и ограничения

### <a name="supported-vm-instances"></a>Поддерживаемые экземпляры виртуальных машин

Ускоренная работа в сети поддерживается в большинстве размеров экземпляров, оптимизированных для вычислений, с двумя или более виртуальными процессорами (виртуальных ЦП).  Поддерживаются следующие серии: Dv2/DSv2 и F/FS.

В экземплярах, поддерживающих технологию Hyper-Threading, Технология ускоренной сети поддерживается на экземплярах виртуальных машин с четырьмя и более виртуальных ЦП. Поддерживаются следующие серии: D/Dsv3, D/Dsv4, Da/Dasv4, E/Esv3, EA/Easv4, серия fsv2, Lsv2, MS/MMS и MS/Mmsv2.

Дополнительные сведения об экземплярах ВИРТУАЛЬНЫХ машин см. [в статье размеры виртуальных машин Windows в Azure](../virtual-machines/sizes.md?toc=%2fazure%2fvirtual-network%2ftoc.json).

### <a name="custom-images"></a>Пользовательские образы

Если вы используете пользовательский образ и образ поддерживает ускорение работы в сети, убедитесь, что у вас есть необходимые драйверы, работающие с сетевыми адаптерами Mellanox ConnectX-3 и ConnectX-4 LX в Azure.

### <a name="regions"></a>Регионы

Ускоренная сеть доступна во всех глобальных регионах Azure и облаке Azure для государственных организаций.

### <a name="enabling-accelerated-networking-on-a-running-vm"></a>Включение ускоренной работы в сети на работающей виртуальной машине

Поддерживаемый размер виртуальной машины без поддержки ускорения работы сети может включать только функцию, когда она остановлена и освобождена.

### <a name="deployment-through-azure-resource-manager"></a>Развертывание с помощью Azure Resource Manager

Виртуальные машины (классические) не могут быть развернуты с ускоренной сетью.

## <a name="vm-creation-using-the-portal"></a>Создание виртуальной машины с помощью портала

Хотя в этой статье описаны действия по созданию виртуальной машины с ускоренной сетью с помощью Azure PowerShell, можно также [использовать портал Azure для создания виртуальной машины](../virtual-machines/windows/quick-create-portal.md?toc=%2fazure%2fvirtual-network%2ftoc.json) , которая обеспечивает ускоренную работу сети. При создании виртуальной машины на портале на странице **Создание виртуальной машины** перейдите на вкладку **сеть** . На этой вкладке имеется возможность **ускорения** работы в сети. Если вы выбрали [поддерживаемую операционную систему](#supported-operating-systems) и [Размер виртуальной машины](#supported-vm-instances), для этого параметра автоматически устанавливается значение **вкл**. В противном случае параметр имеет значение **Off**, и в Azure отображается причина, по которой ее нельзя включить.

> [!NOTE]
> На портале можно включить только поддерживаемые операционные системы. Если вы используете пользовательский образ, а образ поддерживает ускорение работы в сети, создайте виртуальную машину с помощью интерфейса командной строки или PowerShell. 

После создания виртуальной машины можно проверить, включена ли Ускоренная сеть. Следуйте указаниям, приведенным ниже:

1. Перейдите в [портал Azure](https://portal.azure.com) для управления виртуальными машинами. Найдите и щелкните **Виртуальные машины**.

2. В списке виртуальная машина выберите новую виртуальную машину.

3. В строке меню виртуальной машины выберите **сети**.

В сведениях о сетевом интерфейсе рядом с меткой **ускоренной сети** на портале отображается значение **отключено** или **включено** для состояния ускоренной сети.

## <a name="vm-creation-using-powershell"></a>Создание виртуальной машины с помощью PowerShell

Прежде чем продолжать установку, установите [Azure PowerShell](/powershell/azure/install-az-ps) версии 1.0.0 или более поздней. Чтобы определить текущую версию, выполните командлет `Get-Module -ListAvailable Az`. Если необходимо установить или обновить, установите последнюю версию модуля az из [коллекция PowerShell](https://www.powershellgallery.com/packages/Az). В сеансе PowerShell Войдите в учетную запись Azure с помощью [Connect-азаккаунт](/powershell/module/az.accounts/connect-azaccount).

В следующих примерах замените имена параметров собственными значениями. Примеры имен параметров включают *myResourceGroup*, *myNic* и *myVM*.

### <a name="create-a-virtual-network"></a>Создание виртуальной сети

1. Создайте группу ресурсов с помощью командлета [New-AzResourceGroup](/powershell/module/az.Resources/New-azResourceGroup). Следующая команда создает группу ресурсов с именем *myResourceGroup* в расположении *centralus* :

    ```azurepowershell
    New-AzResourceGroup -Name "myResourceGroup" -Location "centralus"
    ```

2. Создайте конфигурацию подсети с помощью [New-азвиртуалнетворксубнетконфиг](/powershell/module/az.Network/New-azVirtualNetworkSubnetConfig). Следующая команда создает подсеть с именем *mySubnet*:

    ```azurepowershell
    $subnet = New-AzVirtualNetworkSubnetConfig `
        -Name "mySubnet" `
        -AddressPrefix "192.168.1.0/24"
    ```

3. Создайте виртуальную сеть с помощью [New-азвиртуалнетворк](/powershell/module/az.Network/New-azVirtualNetwork)и подсетью *mySubnet* .

    ```azurepowershell
    $vnet = New-AzVirtualNetwork -ResourceGroupName "myResourceGroup" `
        -Location "centralus" `
        -Name "myVnet" `
        -AddressPrefix "192.168.0.0/16" `
        -Subnet $Subnet
    ```

### <a name="create-a-network-security-group"></a>Создание группы безопасности сети

1. Создайте правило группы безопасности сети с помощью командлета [New-AzNetworkSecurityRuleConfig](/powershell/module/az.Network/New-azNetworkSecurityRuleConfig):

    ```azurepowershell
    $rdp = New-AzNetworkSecurityRuleConfig `
        -Name 'Allow-RDP-All' `
        -Description 'Allow RDP' `
        -Access Allow `
        -Protocol Tcp `
        -Direction Inbound `
        -Priority 100 `
        -SourceAddressPrefix * `
        -SourcePortRange * `
        -DestinationAddressPrefix * `
        -DestinationPortRange 3389
    ```

2. Создайте группу безопасности сети с помощью [New-азнетворксекуритиграуп](/powershell/module/az.Network/New-azNetworkSecurityGroup) и назначьте ей правило безопасности *allow-RDP-ALL* . Помимо правила *allow-RDP-ALL* , группа безопасности сети содержит несколько правил по умолчанию. Одно правило по умолчанию отключает весь входящий доступ из Интернета. После его создания в группу безопасности сети будет назначено правило *Разрешить-RDP-ALL* , чтобы можно было удаленно подключаться к виртуальной машине.

    ```azurepowershell
    $nsg = New-AzNetworkSecurityGroup `
        -ResourceGroupName myResourceGroup `
        -Location centralus `
        -Name "myNsg" `
        -SecurityRules $rdp
    ```

3. Свяжите группу безопасности сети с подсетью *mySubnet* с помощью [Set-азвиртуалнетворксубнетконфиг](/powershell/module/az.Network/Set-azVirtualNetworkSubnetConfig). Правило в группе безопасности сети распространяется на все ресурсы, развернутые в подсети.

    ```azurepowershell
    Set-AzVirtualNetworkSubnetConfig `
        -VirtualNetwork $vnet `
        -Name 'mySubnet' `
        -AddressPrefix "192.168.1.0/24" `
        -NetworkSecurityGroup $nsg
    ```

### <a name="create-a-network-interface-with-accelerated-networking"></a>Создание сетевого интерфейса с функцией ускорения сети

1. Создайте общедоступный IP-адрес с помощью командлета [New-AzPublicIpAddress](/powershell/module/az.Network/New-azPublicIpAddress). Общедоступный IP-адрес не требуется, если вы не планируете получать доступ к виртуальной машине из Интернета. Однако это необходимо для выполнения действий, описанных в этой статье.

    ```azurepowershell
    $publicIp = New-AzPublicIpAddress `
        -ResourceGroupName myResourceGroup `
        -Name 'myPublicIp' `
        -location centralus `
        -AllocationMethod Dynamic
    ```

2. Создайте сетевой интерфейс с помощью [New-азнетворкинтерфаце](/powershell/module/az.Network/New-azNetworkInterface) с включенной функцией ускорения сети и назначьте сетевому интерфейсу общедоступный IP-адрес. В следующем примере создается сетевой интерфейс с именем *myNic* в подсети *MySubnet* виртуальной сети *myVnet* , в которую назначается общедоступный IP-адрес *myPublicIp* :

    ```azurepowershell
    $nic = New-AzNetworkInterface `
        -ResourceGroupName "myResourceGroup" `
        -Name "myNic" `
        -Location "centralus" `
        -SubnetId $vnet.Subnets[0].Id `
        -PublicIpAddressId $publicIp.Id `
        -EnableAcceleratedNetworking
    ```

### <a name="create-a-vm-and-attach-the-network-interface"></a>Создание виртуальной машины и подключение сетевого интерфейса

1. Задайте для учетных данных виртуальной машины `$cred` переменную с помощью команды [Get-Credential](/powershell/module/microsoft.powershell.security/get-credential), которая предлагает выполнить вход:

    ```azurepowershell
    $cred = Get-Credential
    ```

2. Определите виртуальную машину с помощью [New-AzVMConfig](/powershell/module/az.compute/new-azvmconfig). Следующая команда определяет виртуальную машину с именем *myVM* и размером виртуальной машины, которая поддерживает функцию ускорения сети (*Standard_DS4_v2*):

    ```azurepowershell
    $vmConfig = New-AzVMConfig -VMName "myVm" -VMSize "Standard_DS4_v2"
    ```

    Чтобы просмотреть список всех размеров виртуальных машин и их характеристики, ознакомьтесь со статьей [Размеры виртуальных машин Windows в Azure](../virtual-machines/sizes.md?toc=%2fazure%2fvirtual-network%2ftoc.json).

3. Создайте оставшуюся часть конфигурации виртуальной машины с помощью [Set-AzVMOperatingSystem](/powershell/module/az.compute/set-azvmoperatingsystem) и [Set-AzVMSourceImage](/powershell/module/az.compute/set-azvmsourceimage). Следующая команда создает виртуальную машину Windows Server 2016:

    ```azurepowershell
    $vmConfig = Set-AzVMOperatingSystem -VM $vmConfig `
        -Windows `
        -ComputerName "myVM" `
        -Credential $cred `
        -ProvisionVMAgent `
        -EnableAutoUpdate
    $vmConfig = Set-AzVMSourceImage -VM $vmConfig `
        -PublisherName "MicrosoftWindowsServer" `
        -Offer "WindowsServer" `
        -Skus "2016-Datacenter" `
        -Version "latest"
    ```

4. Подключите сетевой интерфейс, созданный ранее с помощью [Add-азвмнетворкинтерфаце](/powershell/module/az.compute/add-azvmnetworkinterface):

    ```azurepowershell
    $vmConfig = Add-AzVMNetworkInterface -VM $vmConfig -Id $nic.Id
    ```

5. Создайте виртуальную машину с помощью [New-AzVM](/powershell/module/az.compute/new-azvm).

    ```azurepowershell
    New-AzVM -VM $vmConfig -ResourceGroupName "myResourceGroup" -Location "centralus"
    ```

### <a name="confirm-the-ethernet-controller-is-installed-in-the-windows-vm"></a>Убедитесь, что контроллер Ethernet установлен на виртуальной машине Windows

После создания виртуальной машины в Azure подключитесь к виртуальной машине и убедитесь, что контроллер Ethernet установлен в Windows.

1. Перейдите в [портал Azure](https://portal.azure.com) для управления виртуальными машинами. Найдите и щелкните **Виртуальные машины**.

2. В списке виртуальная машина выберите новую виртуальную машину.

3. На странице Обзор виртуальной машины, если **состояние** виртуальной машины указано как **Создание**, подождите, пока Azure не завершит создание виртуальной машины. После завершения создания виртуальной машины **состояние** изменится на **выполняется** .

4. На панели инструментов обзор виртуальной машины выберите **подключить**  >  **RDP**  >  **скачать RDP-файл**.

5. Откройте RDP-файл, а затем войдите на виртуальную машину с учетными данными, введенными в разделе [Создание виртуальной машины и подключение к сетевому интерфейсу](#create-a-vm-and-attach-the-network-interface) . Ознакомьтесь с разделом [Подключение к виртуальной машине](../virtual-machines/windows/quick-create-portal.md?toc=%2fazure%2fvirtual-network%2ftoc.json#connect-to-virtual-machine), если вы никогда не подключались к виртуальной машине Windows в Azure.

6. После отображения сеанса удаленного рабочего стола для виртуальной машины щелкните правой кнопкой мыши кнопку Пуск Windows и выберите **Device Manager**.

7. В окне **Device Manager** разверните узел **Сетевые адаптеры** .

8. Убедитесь, что отображается **адаптер Ethernet виртуальной функции Mellanox ConnectX-3** , как показано на следующем рисунке:

    ![Виртуальная функция Mellanox ConnectX-3 виртуального адаптера Ethernet, новый сетевой адаптер для ускорения работы в сети, Device Manager](./media/create-vm-accelerated-networking/device-manager.png)

Теперь для виртуальной машины включена функция ускорения сети.

> [!NOTE]
> Если не удается запустить адаптер Mellanox, откройте запрос администратора в сеансе удаленного рабочего стола и введите следующую команду:
>
> `netsh int tcp set global rss = enabled`

## <a name="enable-accelerated-networking-on-existing-vms"></a>Включение ускорения работы в сети на существующих виртуальных машинах

Если вы создали виртуальную машину без ускорения работы с сетью, эту функцию можно включить на существующей виртуальной машине. Виртуальная машина должна поддерживать ускоренную сеть, соблюдая следующие предварительные требования, которые также описаны выше:

* Для ускорения работы сети виртуальная машина должна иметь поддерживаемый размер.
* Виртуальная машина должна представлять собой поддерживаемый образ коллекции Azure (и версию ядра для Linux).
* Перед включением функции ускоренной сети для любой сетевой карты необходимо остановить или освободить все виртуальные машины в группе доступности или масштабируемом наборе виртуальных машин.

### <a name="individual-vms-and-vms-in-an-availability-set"></a>Отдельные виртуальные машины и виртуальные машины в группе доступности

1. Останавливает или освобождает виртуальную машину или, если группа доступности, все виртуальные машины в наборе:

    ```azurepowershell
    Stop-AzVM -ResourceGroup "myResourceGroup" -Name "myVM"
    ```

    > [!NOTE]
    > При создании виртуальной машины по отдельности без группы доступности необходимо только отключить или освободить отдельную виртуальную машину, чтобы включить ускоренную сеть. Если виртуальная машина была создана с помощью группы доступности, необходимо прекратить или отменить выделение всех виртуальных машин, содержащихся в группе доступности, прежде чем включать ускоренную сеть на любой из сетевых интерфейсов, чтобы виртуальные машины находились в кластере, поддерживающем ускоренную сеть. Требование отмены или освобождения не требуется, если отключить функцию ускорения сети, так как кластеры, поддерживающие ускорение сети, также работают с сетевыми картами, которые не используют ускоренную сеть.

2. Включите ускоренную сеть для сетевой карты виртуальной машины:

    ```azurepowershell
    $nic = Get-AzNetworkInterface -ResourceGroupName "myResourceGroup" `
        -Name "myNic"
    
    $nic.EnableAcceleratedNetworking = $true
    
    $nic | Set-AzNetworkInterface
    ```

3. Перезапустите виртуальную машину или выберите в группе доступности все виртуальные машины в наборе и убедитесь, что включена функция ускорения сети.

    ```azurepowershell
    Start-AzVM -ResourceGroup "myResourceGroup" `
        -Name "myVM"
    ```

### <a name="virtual-machine-scale-set"></a>Набор масштабирования виртуальных машин

Масштабируемый набор виртуальных машин немного отличается, но он следует одному и тому же рабочему процессу.

1. Завершите работу виртуальных машин:

    ```azurepowershell
    Stop-AzVmss -ResourceGroupName "myResourceGroup" `
        -VMScaleSetName "myScaleSet"
    ```

2. Обновите свойство ускорения сети в сетевом интерфейсе:

    ```azurepowershell
    $vmss = Get-AzVmss -ResourceGroupName "myResourceGroup" `
        -VMScaleSetName "myScaleSet"
    
    $vmss.VirtualMachineProfile.NetworkProfile.NetworkInterfaceConfigurations[0].EnableAcceleratedNetworking = $true
    
    Update-AzVmss -ResourceGroupName "myResourceGroup" `
        -VMScaleSetName "myScaleSet" `
        -VirtualMachineScaleSet $vmss
    ```

3. Задайте для параметра примененные обновления значение автоматически, чтобы немедленно отобрать изменения:

    ```azurepowershell
    $vmss.UpgradePolicy.Mode = "Automatic"
    
    Update-AzVmss -ResourceGroupName "myResourceGroup" `
        -VMScaleSetName "myScaleSet" `
        -VirtualMachineScaleSet $vmss
    ```

    > [!NOTE]
    > В масштабируемом наборе есть обновления виртуальных машин, которые применяют обновления, используя три разных параметра: автоматические, пошаговые и ручные. В этих инструкциях для политики задано значение автоматически, поэтому масштабируемый набор принимает изменения сразу после перезапуска.

4. Перезапустите масштабируемый набор:

    ```azurepowershell
    Start-AzVmss -ResourceGroupName "myResourceGroup" `
        -VMScaleSetName "myScaleSet"
    ```

После перезагрузки дождитесь завершения обновления. После завершения обновления виртуальная функция (VF) появляется в виртуальной машине. Убедитесь, что вы используете поддерживаемую ОС и размер виртуальной машины.

### <a name="resizing-existing-vms-with-accelerated-networking"></a>Изменение размера существующих виртуальных машин с ускоренной сетью

Если в виртуальной машине включена Ускоренная сеть, вы можете изменить ее размер только на виртуальной машине, поддерживающей ускоренную работу в сети.  

Невозможно изменить размер виртуальной машины с включенной функцией ускорения работы в сети до экземпляра виртуальной машины, который не поддерживает ускоренную работу в сети с помощью операции изменения размера. Вместо этого нужно выполнить указанные ниже действия.

1. Останавливает или освобождает виртуальную машину. Для группы доступности или масштабируемого набора следует отключить или освободить все виртуальные машины в группе доступности или масштабируемом наборе.

2. Отключите ускоренную сеть для сетевой карты виртуальной машины. Для группы доступности или масштабируемого набора отключите ускоренную сеть на сетевых адаптерах всех виртуальных машин в группе доступности или масштабируемом наборе.

3. После отключения функции ускорения сети переместите виртуальную машину, группу доступности или масштабируемый набор на новый размер, который не поддерживает ускоренную сеть, а затем перезапустите их.