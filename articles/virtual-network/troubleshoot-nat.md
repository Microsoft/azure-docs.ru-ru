---
title: Устранение неполадок с подключением при использовании NAT виртуальной сети Azure
titleSuffix: Azure Virtual Network
description: Устранение неполадок с NAT виртуальной сети.
services: virtual-network
documentationcenter: na
author: asudbring
manager: KumudD
ms.service: virtual-network
ms.devlang: na
ms.topic: troubleshooting
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 05/20/2020
ms.author: allensu
ms.openlocfilehash: 51bc4233393be6d914578581597e8cce9d0373b0
ms.sourcegitcommit: 73fb48074c4c91c3511d5bcdffd6e40854fb46e5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/31/2021
ms.locfileid: "106059264"
---
# <a name="troubleshoot-azure-virtual-network-nat-connectivity"></a>Устранение неполадок с подключением при использовании NAT виртуальной сети Azure

Эта статья поможет администраторам диагностировать и устранять проблемы с подключением при использовании NAT виртуальной сети.

## <a name="problems"></a>Проблемы

* [Нехватка SNAT](#snat-exhaustion)
* [Сбой проверки связи ICMP](#icmp-ping-is-failing)
* [Сбои подключений](#connectivity-failures)
* [Совместная работа c IPv6](#ipv6-coexistence)
* [Подключение исходит не от IP-адресов шлюза NAT](#connection-doesnt-originate-from-nat-gateway-ips)

Чтобы устранить эти проблемы, выполните описанные в следующем разделе действия.

## <a name="resolution"></a>Решение

### <a name="snat-exhaustion"></a>Нехватка SNAT

Один [ресурс шлюза NAT](nat-gateway-resource.md) поддерживает от 64 000 до 1 000 000 параллельных потоков.  Каждый IP-адрес пополняет доступные ресурсы на 64 000 портов SNAT. Один ресурс шлюза NAT позволяет использовать до 16 статических IP-адресов.  Механизм SNAT более подробно описан [здесь](nat-gateway-resource.md#source-network-address-translation).

Часто первопричиной нехватки SNAT является антишаблон для установки исходящего подключения и управления им или настраиваемые таймеры, значения которых отличны от значений по умолчанию.  Внимательно просмотрите этот раздел.

#### <a name="steps"></a>Шаги

1. Проверьте, не изменился ли период ожидания с бездействием по умолчанию на значение, превышающее 4 минуты.
2. Выясните, как приложение создает исходящее подключение (например, изучите код или соберите пакеты). 
3. Определите, является ли действие ожидаемым или поведение приложения некорректным.  Для подтверждения результатов используйте [метрики](nat-metrics.md) Azure Monitor. Используйте категорию "Сбой" для метрики подключений SNAT.
4. Оцените, соблюдаются ли применимые шаблоны действий.
5. Выясните, нужно ли устранять нехватку портов SNAT путем назначения ресурсу шлюза NAT дополнительных IP-адресов.

#### <a name="design-patterns"></a>Шаблоны проектирования

Старайтесь повторно использовать подключения и создавать пулы подключений везде, где это возможно.  Эти шаблоны позволяют устранить проблему исчерпания ресурсов и гарантировать предсказуемое поведение. Примитивы для этих шаблонов можно найти во многих библиотеках и платформах разработки.

_**Решение.**_ Применение подходящих шаблонов и рекомендаций

- Ресурсы шлюза преобразования сетевых адресов (NAT) имеют период ожидания с бездействием протокола TCP по умолчанию (4 минуты).  Если этот параметр изменен на большее значение, преобразование сетевых адресов (NAT) будет выполняться дольше и может вызвать [ненужную нагрузку на список портов SNAT](nat-gateway-resource.md#timers).
- Атомарные запросы (один запрос на подключение) будут плохим проектным решением. Этот антишаблон ограничивает возможности масштабирования, снижает производительность и надежность. Вместо этого повторно используйте подключения HTTP(S), чтобы уменьшить число подключений и занятых портов SNAT. Масштабируемость и производительность приложений повышается благодаря снижению числа подтверждений, накладных расходов и стоимости криптографических операций при использовании TLS.
- Служба DNS может добавить огромное число отдельных потоков, если клиент не кэширует результаты разрешения имен DNS. Используйте кэширование.
- Потоки UDP (например, поиск по DNS) занимают порты SNAT на период ожидания с бездействием. Чем дольше это время ожидания, тем выше нагрузка на порты SNAT. Используйте короткое время ожидания при бездействии (например, 4 минуты).
- Используйте пулы соединений, чтобы контролировать число подключений.
- Никогда не отменяйте поток TCP без оповещения и не доверяйте очистку потоков таймерам TCP. Если не разрешить протоколу TCP явным образом закрыть подключение, состояние остается выделенным в промежуточных системах и конечных точках и делает порты SNAT недоступными для других подключений. Такой шаблон может привести к сбоям приложений и исчерпанию ресурсов SNAT. 
- Не изменяйте значения таймера на уровне ОС, связанные с закрытием подключений TCP, без экспертного понимания их влияния. Даже если это исправит стек TCP, производительность приложения может снизиться из-за разных ожиданий конечных точек, участвующих в соединении. Желание изменять таймеры обычно является признаком проблем в архитектуре базовой системы. Изучите приведенные ниже рекомендации.

Исчерпание ресурсов SNAT может усиливаться другими антишаблонами, примененными в базовом приложении. Изучите другие шаблоны и рекомендации, которые позволят повысить масштабируемость и надежность службы.

- Изучите влияние [времени ожидания TCP при бездействии](nat-gateway-resource.md#timers), чтобы уменьшить значения, включая время ожидания при бездействии по умолчанию (4 минуты), и раньше высвобождать списки портов SNAT.
- Попробуйте применить [шаблоны асинхронного опроса](/azure/architecture/patterns/async-request-reply) для длительных операций, чтобы освободить ресурсы подключений для других операций.
- Долгосрочные потоки (например, повторно используемые TCP-подключения) должны использовать методы проверки активности на уровне протокола TCP или приложения, чтобы не истекало время ожидания в промежуточных системах. Увеличение времени ожидания при бездействии можно рассматривать лишь как крайнее средство, которое вряд ли устранит основную причину. Длительное время ожидания может привести к проблемам, связанным с замедлением работы, ведь такое ожидание добавляет задержки и ненужные сбои.
- Следует использовать аккуратные [шаблоны повторных попыток](/azure/architecture/patterns/retry), чтобы избежать агрессивных всплесков нагрузки при временном сбое или при восстановлении после сбоя.
Создание нового TCP-подключения для каждой операции HTTP известно как антишаблон "атомарных подключений".  Атомарные подключения не дают приложению хорошо масштабироваться и тратят много ресурсов впустую.  Обязательно объединяйте последовательные операции в один конвейер в пределах одного подключения.  Это повысит скорость транзакций в приложении и снизит затраты ресурсов.  Если приложение использует шифрование на транспортном уровне (например, TLS), обработка новых подключений влечет значительные затраты.  Изучите статью [Конструктивные шаблоны облачных решений](/azure/architecture/patterns/) с дополнительными рекомендациями по проектированию.

#### <a name="additional-possible-mitigations"></a>Дополнительные способы устранения

_**Решение.**_ Для масштабирования исходящих подключений можно использовать следующий механизм.

| Сценарий | Свидетельство |Меры по снижению риска |
|---|---|---|
| Проявляется конкуренция за порты SNAT и их нехватка в периоды высокой нагрузки. | В категории "Сбой" для [метрики](nat-metrics.md) подключений SNAT в Azure Monitor отображаются временные или постоянные сбои с течением времени и большое количество подключений.  | Определите, можно ли использовать дополнительные ресурсы общедоступных IP-адресов и (или) ресурсы префиксов общедоступных IP-адресов. Вы можете добавить к шлюзу NAT в общей сложности до 16 IP-адресов. Такое дополнение увеличит запас доступных портов SNAT (по 64 000 на каждый IP-адрес) и позволит увеличить масштаб системы.|
| Вы уже используете 16 IP-адресов, но проблемы с исчерпанием портов SNAT сохраняются. | Не удалось добавить дополнительный IP-адрес. Общее число IP-адресов из ресурсов общедоступных IP-адресов или ресурсов префиксов общедоступных IP-адресов превышает 16 байт. | Распределите среду приложения по нескольким подсетям и создайте для каждой из них собственный ресурс шлюза NAT.  Оцените повторно конструктивные шаблоны, чтобы оптимизировать их, основываясь на приведенных выше [рекомендациях](#design-patterns). |

>[!NOTE]
>Важно понимать, почему происходит исчерпание портов SNAT. Убедитесь, что соблюдаете все разумные рекомендации по обеспечению масштиабируемости и надежности.  Добавление в систему портов SNAT без понимания причин высокого спроса допустимо применять только в крайних случаях. Если вы не знаете, почему в системе создается высокий спрос на ресурсы портов SNAT, добавление новых портов через дополнительные IP-адреса лишь отсрочит новые проявления той же проблемы, которые неизбежно повторятся при увеличении масштаба.  Возможно, вы будете затыкать дыры, созданные неэффективностью или антишаблоном в приложении.

### <a name="icmp-ping-is-failing"></a>Сбой проверки связи ICMP

[NAT виртуальной сети](nat-overview.md) поддерживает протоколы UDP и TCP в IPv4. Протокол ICMP не поддерживается и работать не должен.  

_**Решение.**_ Вместо него для сквозной проверки связи используйте тесты подключения на основе TCP (например, так называемый "TCP ping") и UDP, выполняемые на уровне приложения.

В качестве отправной точки при выборе средств для запуска тестов можно использовать следующую таблицу.

| Операционная система | Универсальная проверка TCP-подключения. | Тест TCP на уровне приложения | UDP |
|---|---|---|---|
| Linux | nc (универсальный тест подключения) | curl (тест TCP на уровне приложения) | в зависимости от приложения |
| Windows | [PsPing](/sysinternals/downloads/psping) | PowerShell [Invoke-WebRequest](/powershell/module/microsoft.powershell.utility/invoke-webrequest) | в зависимости от приложения |

### <a name="connectivity-failures"></a>Сбои подключений

Проблемы с подключением при использовании [NAT виртуальной сети](nat-overview.md) могут быть вызваны несколькими причинами:

* постоянные сбои из-за ошибок конфигурации;
* временная или постоянная [нехватка SNAT](#snat-exhaustion) для шлюза NAT;
* временные сбои в инфраструктуре Azure; 
* временные сбои на пути между Azure и общедоступным местом назначения в Интернете; 
* временные или постоянные сбои в общедоступном месте назначения в Интернете.

Для проверки подключения используйте такие средства, как указано ниже. [Проверка связи по ICMP не поддерживается](#icmp-ping-is-failing).

| Операционная система | Универсальная проверка TCP-подключения. | Тест TCP на уровне приложения | UDP |
|---|---|---|---|
| Linux | nc (универсальный тест подключения) | curl (тест TCP на уровне приложения) | в зависимости от приложения |
| Windows | [PsPing](/sysinternals/downloads/psping) | PowerShell [Invoke-WebRequest](/powershell/module/microsoft.powershell.utility/invoke-webrequest) | в зависимости от приложения |

#### <a name="configuration"></a>Конфигурация

Проверка конфигурации
1. Есть ли у ресурса шлюза NAT хотя бы один ресурс общедоступного IP-адреса или один ресурс префикса общедоступного IP-адреса? У вас должен быть хотя бы один IP-адрес, связанный со шлюзом NAT, чтобы он мог обеспечить исходящее соединение.
2. Настроена ли подсеть виртуальной сети на использование шлюза NAT?
3. Используете ли вы UDR (определяемый пользователем маршрут) и переопределяете ли вы назначение?  Ресурсы шлюза NAT становятся в настроенных подсетях маршрутом по умолчанию (0/0).

#### <a name="snat-exhaustion"></a>Нехватка SNAT

Ознакомьтесь с разделом [Нехватка SNAT](#snat-exhaustion) в этой статье.

#### <a name="azure-infrastructure"></a>Инфраструктура Azure

Специалисты Azure наблюдают за инфраструктурой и работают с ней очень осторожно. Могут наблюдаться временные проблемы, и для операций передачи данных не гарантируется отсутствие потерь.  Используйте конструктивные шаблоны, позволяющие повторно передавать SYN для приложений TCP. Используйте достаточно большие значения для времени ожидания соединения, чтобы обеспечить повторную передачу SYN по протоколу TCP для уменьшения влияния временного сбоя, вызванного потерей пакета SYN.

_**Решение**_

* Проверьте, нет ли [нехватки SNAT](#snat-exhaustion).
* Параметр конфигурации в стеке TCP, управляющий поведением при повторной передаче SYN, называется RTO ([время ожидания повторной отправки](https://tools.ietf.org/html/rfc793)). Значение RTO можно изменить, но обычно по умолчанию оно равно 1 секунде или более с экспоненциальной задержкой.  Если время ожидания подключения приложения слишком короткое (например, 1 секунда), время от времени могут происходить тайм-ауты подключения.  Увеличьте время ожидания подключения приложения.
* Если в поведении приложения по умолчанию замечены более длительные непредвиденные тайм-ауты, отправьте запрос в службу поддержки для дальнейшего устранения неполадок.

Мы не рекомендуем искусственно уменьшать время ожидания подключения TCP или изменять параметр RTO.

#### <a name="public-internet-transit"></a>Передача данных через общедоступный Интернет

Чем длиннее путь к месту назначения и больше промежуточных систем, тем выше шансы появления временных сбоев. Ожидается, что временные сбои в этой ситуации происходят чаще, чем в [инфраструктуре Azure](#azure-infrastructure). 

Следуйте тем же рекомендациям, что и в предыдущем разделе [Инфраструктура Azure](#azure-infrastructure).

#### <a name="internet-endpoint"></a>Конечная точка Интернета

Применяются положения из предыдущих разделов, а также правила для конечной точки Интернета, к которой устанавливается подключение. На успешность подключения могут также повлиять другие факторы:

* управление трафиком на стороне назначения;
- ограничение скорости API, накладываемое со стороны места назначения;
- устранение рисков объемных атак DDoS или формирование трафика транспортного уровня;
* брандмауэр или другие компоненты в месте назначения. 

Обычно, чтобы понять, что происходит, требуется захват пакетов в источнике и (если возможно) месте назначения.

_**Решение.**_

* Проверьте, нет ли [нехватки SNAT](#snat-exhaustion). 
* Для сравнения проверьте подключение к конечной точке в том же регионе или в другом месте.  
* Если вы создаете большой объем или тестируете скорость транзакций, проверьте, уменьшится ли частота возникновения сбоев, если снизить скорость.
* Если скорость влияет на частоту сбоев, проверьте, не достигнуты ли предельные значения скорости API и не превышены ли иные ограничения на стороне назначения.
* Если по результатам исследования не удалось прийти к окончательному заключению, отправьте запрос в службу поддержки для дальнейшего устранения неполадок.

#### <a name="tcp-resets-received"></a>Полученные сбросы TCP

Шлюз NAT выполняет сброс TCP на виртуальной машине, если трафик теряет статус передаваемого.

Одна из возможных причин — превышение времени ожидания в состоянии бездействия для подключения TCP.  Время ожидания при бездействии можно настроить в пределах от 4 до 120 минут.

Сбросы TCP не создаются на общедоступной стороне ресурсов шлюза NAT. Сбросы TCP на стороне назначения создаются исходной виртуальной машиной, а не ресурсом шлюза NAT.

_**Решение.**_

* Ознакомьтесь с рекомендациями по созданию [конструктивных шаблонов](#design-patterns).  
* При необходимости отправьте запрос в службу поддержки для дальнейшего устранения неполадок.

### <a name="ipv6-coexistence"></a>Совместная работа c IPv6

[NAT виртуальной сети](nat-overview.md) поддерживает протоколы UDP и TCP через IPv4, а развертывание в [подсети с префиксом IPv6 не поддерживается](nat-overview.md#limitations).

_**Решение.**_ Разверните шлюз NAT в подсети без префикса IPv6.

Вы можете сообщить о заинтересованности в дополнительных возможностях с помощью [UserVoice для NAT виртуальной сети](https://aka.ms/natuservoice).

### <a name="connection-doesnt-originate-from-nat-gateway-ips"></a>Подключение исходит не от IP-адресов шлюза NAT

Вы настроили шлюз NAT, IP-адреса и подсеть, которая должна использовать ресурс шлюза NAT. Но подключения от экземпляров виртуальных машин, которые существовали до развертывания шлюза NAT, не используют эти IP-адреса.  Используемые ими IP-адреса не относятся к диапазону, указанному для ресурса шлюза NAT.

_**Решение.**_

[NAT виртуальных сетей](nat-overview.md) заменяет собой подсеть, для которой он настроен, в исходящих подключениях. При переходе от SNAT, используемого по умолчанию или подсистемой балансировки нагрузки, к использованию шлюзов NAT новые подключения сразу же начинают использовать IP-адреса, связанные с ресурсом шлюза NAT.  Но если во время переключения на ресурс шлюза NAT виртуальная машина сохраняла установленное подключение, это подключение будет и далее использовать старый IP-адрес SNAT, назначенный при его установке.  Обязательно установите новое соединение, а не сохраняйте уже существующее, которое могло сохраниться в кэше операционной системы или браузера.  Например, при использовании _curl_ в PowerShell необходимо указать параметр _-DisableKeepalive_, чтобы принудительно создать новое соединение.  Если вы используете браузер, подключения могут помещаться в пул.

Нет необходимости перезагружать виртуальную машину при настройке подсети для ресурса шлюза NAT.  Но при перезагрузке виртуальной машины состояние подключения будет сброшено.  После сброса состояния подключения все подключения начнут использовать IP-адреса ресурса шлюза NAT.  Но это лишь побочный эффект перезагрузки виртуальной машины, а не признак необходимости такой перезагрузки.

Если проблемы сохраняются, отправьте запрос в службу поддержки для устранения неполадок.

## <a name="next-steps"></a>Дальнейшие действия

* Дополнительные сведения о [NAT виртуальной сети](nat-overview.md).
* Дополнительные сведения о [ресурсе шлюза NAT](nat-gateway-resource.md).
* Дополнительные сведения о [метриках и оповещениях для ресурсов шлюза NAT](nat-metrics.md).
* [Расскажите в UserVoice, что нам следует создать далее для NAT виртуальной сети](https://aka.ms/natuservoice).