---
title: Руководство. Маршрутизация сетевого трафика с помощью портала Azure
titlesuffix: Azure Virtual Network
description: В этом руководстве описано, как маршрутизировать сетевой трафик с помощью таблицы маршрутов и портала Azure.
services: virtual-network
documentationcenter: virtual-network
author: KumudD
Customer intent: I want to route traffic from one subnet, to a different subnet, through a network virtual appliance.
ms.service: virtual-network
ms.devlang: azurecli
ms.topic: tutorial
ms.tgt_pltfrm: virtual-network
ms.workload: infrastructure
ms.date: 03/13/2020
ms.author: kumud
ms.openlocfilehash: e047f46e110e1f7b1d544545c80bd1097ae65167
ms.sourcegitcommit: d59abc5bfad604909a107d05c5dc1b9a193214a8
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/14/2021
ms.locfileid: "98221924"
---
# <a name="tutorial-route-network-traffic-with-a-route-table-using-the-azure-portal"></a>Руководство по Маршрутизация сетевого трафика с помощью таблицы маршрутов с использованием портала Azure

По умолчанию Azure маршрутизирует трафик между всеми подсетями в виртуальной сети. Для переопределения маршрутизации Azure по умолчанию можно создать собственные маршруты. Настраиваемые маршруты полезны, если, к примеру, требуется направить трафик между подсетями через виртуальный сетевой модуль. В этом руководстве описано следующее:

> [!div class="checklist"]
> * создание виртуального сетевого модуля, который перенаправляет трафик;
> * Создание таблицы маршрутов
> * Создание маршрута
> * Связывание таблицы маршрутов с подсетью
> * развертывание виртуальных машин в разных подсетях;
> * направление трафика из одной подсети в другую через виртуальный сетевой модуль.

В этом учебнике используется [портал Azure](https://portal.azure.com). Вы также можете использовать [Azure PowerShell](tutorial-create-route-table-powershell.md) или [Azure CLI](tutorial-create-route-table-cli.md).

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

## <a name="create-an-nva"></a>Создание виртуального сетевого модуля

Сетевые виртуальные модули — это виртуальные машины, которые помогают работать с сетевыми функциями, такими как маршрутизация и оптимизация брандмауэра. В этом руководстве используется **Windows Server 2016 Datacenter**. Если требуется, можно выбрать другую операционную систему.

1. На **домашней странице** или в меню [портала Azure](https://portal.azure.com) щелкните **Создать ресурс**.

1. Щелкните элементы **Безопасность** > **Windows Server 2016 Datacenter**.

    ![Windows Server 2016 Datacenter, создание виртуальной машины, портал Azure](./media/tutorial-create-route-table-portal/vm-ws2016-datacenter.png)

1. На странице **Создание виртуальной машины** в разделе **Основные сведения** введите или выберите следующую информацию:

    | Section | Параметр | Действие |
    | ------- | ------- | ----- |
    | **Сведения о проекте** | Подписка | Выберите свою подписку. |
    | | Группа ресурсов | Выберите **Создать**, а затем введите *myResourceGroup* и нажмите кнопку **ОК**. |
    | **Сведения об экземпляре** | Имя виртуальной машины | Введите *myVmNva*. |
    | | Регион | Выберите регион **(США) Восточная часть США**. |
    | | Параметры доступности | Щелкните **Избыточность инфраструктуры не требуется**. |
    | | Образ — | Введите **Windows Server 2016 Datacenter**. |
    | | Размер | Оставьте значение по умолчанию **Standard DS1 v2**. |
    | **Учетная запись администратора** | Имя пользователя | Введите выбранное имя пользователя. |
    | | Пароль | Вводимый пароль должен состоять из по крайней мере 12 символов и соответствовать [определенным требованиям к сложности](../virtual-machines/windows/faq.md?toc=%2fazure%2fvirtual-network%2ftoc.json#what-are-the-password-requirements-when-creating-a-vm). |
    | | Подтверждение пароля | Введите пароль еще раз. |
    | **Правила входящего порта** | Общедоступные входящие порты | Выберите значение **Нет**. |
    | **Экономия** | У вас уже есть лицензия Windows Server? | Выберите значение **Нет**. |

    ![Раздел "Основные сведения", создание виртуальной машины, портал Azure](./media/tutorial-create-route-table-portal/basics-create-virtual-machine.png)

    Затем щелкните **Далее. Диски >** .

1. В разделе **Диски** выберите нужные параметры, а затем нажмите кнопку **Далее: Сети >** .

1. На вкладке **Сеть**:

    1. Под полем **Виртуальная сеть** щелкните ссылку **Создать**.
    
    1. В диалоговом окне **Создание виртуальной сети** в поле **Имя** введите *myVirtualNetwork*.

    1. В разделе **Адресное пространство** замените существующий диапазон адресов на *10.0.0.0/16*.

    1. В разделе **Подсети** щелкните значок **Удалить**, чтобы удалить существующую подсеть, а затем введите **имя подсети** и **диапазон адресов**. После того как будут введены допустимое имя и диапазон, под ними появится новая пустая строка.

        | Имя подсети | Диапазон адресов |
        | ----------- | ------------- |
        | *Открытый* | *10.0.0.0/24* |
        | *Частное* | *10.0.1.0/24* |
        | *DMZ* | *10.0.2.0/24* |

    1. Нажмите кнопку **ОК**, чтобы закрыть диалоговое окно.

    1. Для параметра **Подсети** выберите **DMZ (10.0.2.0/24)** .

    1. Для параметра **Общедоступный IP-адрес** выберите значение **Нет**, так как эта виртуальная машина не будет подключена через Интернет.

    1. Выберите **Далее: Управление >** .

1. На вкладке **Управление**:

    1. Под полем **Учетная запись хранения для диагностики** щелкните ссылку **Создать**.
    
    1. В подменю **Создание учетной записи хранения** введите или выберите следующую информацию:

        | Параметр | Значение |
        | ------- | ----- |
        | Имя | *mynvastorageaccount* |
        | Тип учетной записи | **Storage (general purpose v1)** (Хранилище общего назначения версии 1) |
        | Производительность | **Standard Edition** |
        | Репликация | **Локально избыточное хранилище** |
    
    1. Нажмите кнопку **ОК**, чтобы закрыть диалоговое окно.

    1. Выберите **Review + create** (Просмотреть и создать). Вы будете перенаправлены на страницу **Просмотр и создание**, и Azure проверит вашу конфигурацию.

1. При появлении сообщения **Проверка пройдена** нажмите кнопку **Создать**.

    Создание виртуальной машины занимает несколько минут. Не продолжайте работу, пока Azure не завершит создание виртуальной машины. На странице **Развертывание выполняется** вы увидите сведения о развертывании.

1. После создания виртуальной машины выберите **Перейти к ресурсу**.

## <a name="create-a-route-table"></a>Создание таблицы маршрутов

1. На **домашней странице** или в меню [портала Azure](https://portal.azure.com) щелкните **Создать ресурс**.

2. В поле поиска введите *Таблица маршрутов*. Когда элемент **Таблица маршрутов** появится в результатах поиска, выберите его.

3. На странице **Таблица маршрутов** щелкните **Создать**.

4. В подменю **Создание таблицы маршрутов** введите или выберите следующую информацию:

    | Параметр | Значение |
    | ------- | ----- |
    | Имя | *myRouteTablePublic* |
    | Подписка | Ваша подписка |
    | Группа ресурсов | **myResourceGroup** |
    | Расположение | **Восточная часть США (США)** |
    | Распространение маршрутов шлюза виртуальной сети | **Enabled** |

    ![Создание таблицы маршрутов, портал Azure](./media/tutorial-create-route-table-portal/create-route-table.png)

5. Нажмите кнопку **создания**.

## <a name="create-a-route"></a>Создание маршрута

1. Перейдите на [портал Azure](https://portal.azure.com) для управления таблицей маршрутизации. Найдите и щелкните **Таблицы маршрутов**.

1. Выберите имя таблицы маршрутов (**myRouteTablePublic**).

1. Выберите **Маршруты** > **Добавить**.

    ![Добавление таблицы маршрутов, портал Azure](./media/tutorial-create-route-table-portal/add-route.png)

1. В подменю **Добавление маршрута** введите или выберите следующую информацию:

    | Параметр | Значение |
    | ------- | ----- |
    | Имя маршрута | *ToPrivateSubnet* |
    | Префикс адреса | *10.0.1.0/24* (диапазон адресов *частной* подсети, созданной ранее) |
    | Тип следующего прыжка | **Виртуальный модуль** |
    | Адрес следующего прыжка | *10.0.2.4* (адрес в диапазоне адресов подсети *DMZ*) |

1. Щелкните **ОК**.

## <a name="associate-a-route-table-to-a-subnet"></a>Связывание таблицы маршрутов с подсетью

1. Перейдите на [портал Azure](https://portal.azure.com) для управления виртуальной сетью. Найдите и щелкните **Виртуальные сети**.

1. Выберите имя виртуальной сети (**myVirtualNetwork**).

1. В строке меню виртуальной сети щелкните **Подсети**.

1. В списке подсети виртуальной сети выберите **Общедоступные**.

1. В поле **Таблица маршрутов** выберите созданную таблицу маршрутов (**myRouteTablePublic**), а затем нажмите кнопку **Сохранить**, чтобы связать таблицу маршрутов с *общедоступной* подсетью.

    ![Связывание таблицы маршрутов, список подсетей, виртуальная сеть, портал Azure](./media/tutorial-create-route-table-portal/associate-route-table.png)

## <a name="turn-on-ip-forwarding"></a>Включение IP-пересылки

Затем включите параметр "IP-пересылка" для новой виртуальной машины *myVmNva*, которая является сетевым виртуальным устройством. Когда Azure отправляет трафик к *myVmNva*, а он предназначается для других IP-адресов, IP-пересылка будет перенаправлять трафик в правильное расположение.

1. Перейдите на [портал Azure](https://portal.azure.com) для управления виртуальной машиной. Найдите и щелкните **Виртуальные машины**.

1. Введите имя виртуальной машины (**myVmNva**).

1. В строке меню виртуальной машины, которая является сетевым виртуальным устройством, выберите раздел **Сеть**.

1. Выберите **myvmnva123**. Это сетевой интерфейс Azure, созданный для вашей виртуальной машины. Azure добавляет числа, чтобы имя было уникальным.

    ![Сеть, сетевой виртуальный модуль, виртуальная машина, портал Azure](./media/tutorial-create-route-table-portal/virtual-machine-networking.png)

1. В строке меню сетевого интерфейса выберите **Конфигурации IP**.

1. На странице **Конфигурации IP** задайте для параметра **IP-пересылка** значение **Включено** и нажмите кнопку **Сохранить**.

    ![Включение IP-пересылки, конфигурации IP-адресов, сетевой интерфейс, виртуальная машина, виртуальный сетевой модуль, портал Azure](./media/tutorial-create-route-table-portal/enable-ip-forwarding.png)

## <a name="create-public-and-private-virtual-machines"></a>Создание общедоступных и частных виртуальных машин

Создайте общедоступную и частную виртуальную машину в виртуальной сети. Вы будете их использовать для просмотра, чтобы убедиться, что Azure направляет трафик *общедоступной* подсети в *частную* подсеть через виртуальные сетевые модули.

Чтобы создать общедоступную и частную виртуальную машину, выполните действия, описанные в разделе [Создание виртуального сетевого модуля](#create-an-nva) выше. Вам не нужно ждать завершения развертывания или переходить к ресурсу виртуальной машины. Вы будете использовать большинство тех же параметров, за исключением описанных ниже.

Прежде чем нажать кнопку **Создать** для создания общедоступной или частной виртуальной машины, перейдите в следующие два подраздела ([Public VM](#public-vm) (Общедоступная виртуальная машина) и [Private VM](#private-vm) (Частная виртуальная машина)), где должны отображаться разные значения. Вы можете перейти к следующему разделу ([Route traffic through an NVA](#route-traffic-through-an-nva) (Перенаправление трафика через виртуальный сетевой модуль)) после того, как Azure завершит развертывание обеих виртуальных машин.

### <a name="public-vm"></a>Общедоступная виртуальная машина

| Вкладка | Параметр | Значение |
| --- | ------- | ----- |
| Основы | Группа ресурсов | **myResourceGroup** |
| | Имя виртуальной машины | *myVmPublic* |
| | Общедоступные входящие порты | **Разрешить выбранные порты** |
| | Выбрать входящие порты | **RDP** |
| Сеть | Виртуальная сеть | **myVirtualNetwork** |
| | Подсеть | **Public (10.0.0.0/24)** (Общедоступная (10.0.0.0/24)) |
| | Общедоступный IP-адрес | По умолчанию |
| Управление | Учетная запись хранения для диагностики | **mynvastorageaccount** |

### <a name="private-vm"></a>Частная виртуальная машина

| Вкладка | Параметр | Значение |
| --- | ------- | ----- |
| Основы | Группа ресурсов | **myResourceGroup** |
| | Имя виртуальной машины | *myVmPrivate* |
| | Общедоступные входящие порты | **Разрешить выбранные порты** |
| | Выбрать входящие порты | **RDP** |
| Сеть | Виртуальная сеть | **myVirtualNetwork** |
| | Подсеть | **Private (10.0.1.0/24)** (Частная (10.0.1.0/24)) |
| | Общедоступный IP-адрес | По умолчанию |
| Управление | Учетная запись хранения для диагностики | **mynvastorageaccount** |

## <a name="route-traffic-through-an-nva"></a>Перенаправление трафика через виртуальный сетевой модуль

### <a name="sign-in-to-myvmprivate-over-remote-desktop"></a>Вход в myVmPrivate через удаленный рабочий стол

1. Перейдите на [портал Azure](https://portal.azure.com) для управления частной виртуальной машиной. Найдите и щелкните **Виртуальные машины**.

1. Выберите имя частной виртуальной машины (**myVmPrivate**).

1. В строке меню виртуальной машины щелкните **Подключиться**, чтобы создать подключения удаленного рабочего стола для виртуальной машины.

1. На странице **Connect with RDP** (Подключение по протоколу RDP) щелкните **Скачать файл RDP**. Azure создаст и скачает на ваш компьютер файл протокола удаленного рабочего стола (*RDP*).

1. Откройте скачанный файл *RDP*. При появлении запроса выберите **Подключиться**. Выберите элементы **More choices (Дополнительные варианты)**  > **Использовать другую учетную запись**, а затем введите имя пользователя и пароль, указанные при создании частной виртуальной машины.

1. Щелкните **ОК**.

1. Если в процессе входа отобразится предупреждение о сертификате, нажмите кнопку **Да**, чтобы подключиться к виртуальной машине.

### <a name="enable-icmp-through-the-windows-firewall"></a>Разрешите трафик ICMP в брандмауэре Windows

Для проверки маршрутизации вы позже будете использовать средство трассировки маршрута. Средство трассировки маршрута использует протокол ICMP, который по умолчанию запрещен в брандмауэре Windows. Разрешите трафик ICMP в брандмауэре Windows.

1. На удаленном рабочем столе *myVmPrivate* откройте PowerShell.

1. Введите эту команду:

    ```powershell
    New-NetFirewallRule –DisplayName "Allow ICMPv4-In" –Protocol ICMPv4
    ```

    Для проверки маршрутизации в этом учебнике используется трассировка маршрута. Мы не рекомендуем разрешать протокол ICMP в брандмауэре Windows в рабочей среде.

### <a name="turn-on-ip-forwarding-within-myvmnva"></a>Включение IP-пересылки в myVmNva

Вы [включили IP-пересылку](#turn-on-ip-forwarding) для сетевого интерфейса виртуальной машины с помощью Azure. Операционная система виртуальной машины также должна переадресовывать сетевой трафик. Включите IP-пересылку для операционной системы виртуальной машины *myVmNva* с помощью следующих команд.

1. Из командной строки виртуальной машины *myVmPrivate* откройте удаленный рабочий стол виртуальной машины *myVmNva*:

    ```cmd
    mstsc /v:myvmnva
    ```

1. В PowerShell на виртуальной машине *myVmNva* введите следующую команду, чтобы включить IP-пересылку:

    ```powershell
    Set-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters -Name IpEnableRouter -Value 1
    ```

1. Перезапустите виртуальную машину *myVmNva*. На панели задач нажмите выберите элементы **Пуск** > **кнопка включения**, **Другое (Запланированное)**  > **Продолжить**.

    Это прервет сеанс входа в систему.

1. После перезапуска виртуальной машины *myVmNva* создайте сеанс входа в систему с виртуальной машиной *myVmPublic*. Во время подключения к виртуальной машине *myVmPrivate* откройте командную строку и выполните следующую команду:

    ```cmd
    mstsc /v:myVmPublic
    ```
1. На удаленном рабочем столе *myVmPublic* откройте PowerShell.

1. Разрешите протокол ICMP в брандмауэре Windows, введя следующую команду:

    ```powershell
    New-NetFirewallRule –DisplayName "Allow ICMPv4-In" –Protocol ICMPv4
    ```

## <a name="test-the-routing-of-network-traffic"></a>Проверка маршрутизации сетевого трафика

Сначала протестируйте маршрутизацию сетевого трафика из виртуальной машины *myVmPublic* в виртуальную машину *myVmPrivate*.

1. В PowerShell на виртуальной машине *myVmPublic* введите следующую команду:

    ```powershell
    tracert myVmPrivate
    ```

    Вы получите ответ, аналогичный приведенному ниже примеру:

    ```powershell
    Tracing route to myVmPrivate.vpgub4nqnocezhjgurw44dnxrc.bx.internal.cloudapp.net [10.0.1.4]
    over a maximum of 30 hops:

    1    <1 ms     *        1 ms  10.0.2.4
    2     1 ms     1 ms     1 ms  10.0.1.4

    Trace complete.
    ```

    Можно заметить, что для первого прыжка указан частный IP-адрес виртуального сетевого модуля (10.0.2.4). Второй прыжок — это частный IP-адрес виртуальной машины *myVmPrivate*: 10.0.1.4. Ранее в таблицу маршрутов *myRouteTablePublic* вы добавили маршрут и связали его с *общедоступной* подсетью. Таким образом, Azure передает трафик через виртуальный сетевой модуль, а не непосредственно к *частной* подсети.

1. Закройте сеанс удаленного рабочего стола с виртуальной машиной *myVmPublic*, сохраняя подключение к виртуальной машине *myVmPrivate*.

1. В командную строку виртуальной машины *myVmPrivate* введите следующую команду:

    ```cmd
    tracert myVmPublic
    ```

    Таким образом будет проверена маршрутизация сетевого трафика из виртуальной машины *myVmPrivate* в виртуальную машину *myVmPublic*. Вы получите ответ, аналогичный приведенному ниже примеру:

    ```cmd
    Tracing route to myVmPublic.vpgub4nqnocezhjgurw44dnxrc.bx.internal.cloudapp.net [10.0.0.4]
    over a maximum of 30 hops:

    1     1 ms     1 ms     1 ms  10.0.0.4

    Trace complete.
    ```

    Вы увидите, что Azure маршрутизирует трафик напрямую из виртуальной машины *myVmPrivate* в виртуальную машину *myVmPublic*. По умолчанию Azure маршрутизирует трафик между подсетями напрямую.

1. Закройте сеанс удаленного рабочего стола с виртуальной машиной *myVmPrivate*.

## <a name="clean-up-resources"></a>Очистка ресурсов

Удалите группу ресурсов *myResourceGroup* и все содержащиеся в ней ресурсы, когда она станет не нужна.

1. Перейдите на [портал Azure](https://portal.azure.com) для управления группой ресурсов. Найдите и щелкните **Группы ресурсов**.

1. Выберите имя группы ресурсов (**myResourceGroup**).

1. Выберите **Удалить группу ресурсов**.

1. В диалоговом окне подтверждения введите *myResourceGroup* в поле **Введите имя группы ресурсов**, а затем нажмите кнопку **Удалить**. Azure удалит *myResourceGroup* и все ресурсы, привязанные к этой группе ресурсов, в том числе таблицы маршрутов, учетные записи хранения, виртуальные сети, виртуальные машины, сетевые интерфейсы и общедоступные IP-адреса.

## <a name="next-steps"></a>Дальнейшие действия

При работе с этим руководстве вы создали таблицу маршрутов и связали ее с подсетью. Вы также создали простой виртуальный сетевой модуль, который направляет трафик из общедоступной подсети в частную подсеть. Теперь вы можете развернуть различные предварительно настроенные сетевые виртуальные ресурсы из [Azure Marketplace](https://azuremarketplace.microsoft.com/marketplace/apps/category/networking), которые предоставляют много полезных сетевых функций. См. дополнительные сведения о [маршрутизации](virtual-networks-udr-overview.md) и [управлении таблицей маршрутов](manage-route-table.md).

Хотя в виртуальной сети можно развернуть множество ресурсов, Azure не может развертывать ресурсы в виртуальную сеть для некоторых служб PaaS. Доступ к ресурсам некоторых служб Azure PaaS можно ограничить, хотя ограничивать следует только трафик из подсети виртуальной сети. Перейдите к следующему учебнику, чтобы узнать, как ограничить сетевой доступ к ресурсам Azure PaaS.

> [!div class="nextstepaction"]
> [Настройка конечных точек служб виртуальной сети](tutorial-restrict-network-access-to-resources.md)

> [!NOTE] 
> За использование служб Azure взимается плата. Управление затратами Azure помогает устанавливать бюджеты и настраивать оповещения, чтобы держать расходы под контролем. Анализируйте, администрируйте и оптимизируйте затраты на Azure с помощью Управления затратами. Дополнительные сведения см. в [кратком руководстве по анализу затрат](../cost-management-billing/costs/quick-acm-cost-analysis.md?WT.mc_id=costmanagementcontent_docsacmhorizontal_-inproduct-learn).