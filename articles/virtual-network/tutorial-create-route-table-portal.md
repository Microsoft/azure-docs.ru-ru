---
title: Руководство. Маршрутизация сетевого трафика с помощью портала Azure
titlesuffix: Azure Virtual Network
description: В этом руководстве описано, как маршрутизировать сетевой трафик с помощью таблицы маршрутов и портала Azure.
services: virtual-network
documentationcenter: virtual-network
author: KumudD
Customer intent: I want to route traffic from one subnet, to a different subnet, through a network virtual appliance.
ms.service: virtual-network
ms.devlang: azurecli
ms.topic: tutorial
ms.tgt_pltfrm: virtual-network
ms.workload: infrastructure
ms.date: 03/16/2021
ms.author: kumud
ms.openlocfilehash: f8090ea9c0d307d1bd290c4cf4dac9bfaabf7c4b
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "104576359"
---
# <a name="tutorial-route-network-traffic-with-a-route-table-using-the-azure-portal"></a>Руководство по Маршрутизация сетевого трафика с помощью таблицы маршрутов с использованием портала Azure

По умолчанию Azure маршрутизирует трафик между всеми подсетями в виртуальной сети. Для переопределения маршрутизации Azure по умолчанию можно создать собственные маршруты. Настраиваемые маршруты полезны, если, к примеру, требуется направить трафик между подсетями через виртуальный сетевой модуль. В этом руководстве описано следующее:

> [!div class="checklist"]
> * создание виртуального сетевого модуля, который перенаправляет трафик;
> * Создание таблицы маршрутов
> * Создание маршрута
> * Связывание таблицы маршрутов с подсетью
> * развертывание виртуальных машин в разных подсетях;
> * направление трафика из одной подсети в другую через виртуальный сетевой модуль.

В этом учебнике используется [портал Azure](https://portal.azure.com). Вы также можете использовать [Azure PowerShell](tutorial-create-route-table-powershell.md) или [Azure CLI](tutorial-create-route-table-cli.md).

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

## <a name="prerequisites"></a>Предварительные требования

- Подписка Azure.

## <a name="sign-in-to-azure"></a>Вход в Azure

Войдите на портал Azure по адресу https://portal.azure.com.

## <a name="create-a-virtual-network"></a>Создание виртуальной сети

1. В меню портала Azure выберите **Создать ресурс**. В Azure Marketplace выберите **Сеть** > **Виртуальная сеть** или найдите **виртуальную сеть** с помощью поля поиска.

2. Нажмите кнопку **создания**.

2. В подменю **Создать виртуальную сеть** введите или выберите следующую информацию:

    | Параметр | Значение |
    | ------- | ----- |
    | Подписка | Выберите свою подписку.|
    | Группа ресурсов | Выберите **Создать** и введите **myResourceGroup**. </br> Щелкните **ОК**. |
    | Имя | Введите **myVirtualNetwork**. |
    | Расположение | Выберите регион **(США) Восточная часть США**.|

3. Откройте вкладку **IP-адрес** или нажмите кнопку **Далее: IP-адреса** внизу страницы.

4. В поле **Диапазон IPv4-адресов** выберите существующий диапазон адресов и измените его на **10.0.0.0/16**.

4. Выберите **+ Добавить подсеть**, а затем введите **Public** в поле **Имя подсети** и **10.0.0.0/24** в поле **Диапазон адресов подсети**.

5. Выберите **Добавить**.

6. Выберите **+ Добавить подсеть**, а затем введите **Private** в поле **Имя подсети** и **10.0.1.0/24** в поле **Диапазон адресов подсети**.

7. Выберите **Добавить**.

8. Выберите **+ Добавить подсеть**, а затем введите **DMZ** в поле **Имя подсети** и **10.0.2.0/24** в поле **Диапазон адресов подсети**.

9. Выберите **Добавить**.

10. Откройте вкладку **Безопасность** или нажмите кнопку **Далее: безопасность** внизу страницы.

11. В разделе **BastionHost** выберите **Включить**. Введите такие сведения:

    | Параметр            | Значение                      |
    |--------------------|----------------------------|
    | Имя бастиона | Введите **myBastionHost**. |
    | Адресное пространство AzureBastionSubnet | Введите **10.0.3.0/24** |
    | Общедоступный IP-адрес | Выберите **Создать**. </br> В поле **Имя** введите **myBastionIP**. </br> Щелкните **ОК**. |

12. Перейдите на вкладку **Просмотр и создание** или нажмите кнопку **Просмотр и создание**.

13. Нажмите кнопку **создания**.

## <a name="create-an-nva"></a>Создание виртуального сетевого модуля

Сетевые виртуальные модули — это виртуальные машины, которые помогают работать с сетевыми функциями, такими как маршрутизация и оптимизация брандмауэра. В этом учебнике используется **Windows Server 2019 Datacenter**. Если требуется, можно выбрать другую операционную систему.

1. В верхнем левом углу страницы портала выберите **Создать ресурс** > **Вычисления** > **Виртуальная машина**. 
   
2. В разделе **Создание виртуальной машины** на вкладке **Основные сведения** укажите следующее.

    | Параметр | Значение                                          |
    |-----------------------|----------------------------------|
    | **Сведения о проекте** |  |
    | Подписка | Выбор подписки Azure |
    | Группа ресурсов | Выберите **MyResourceGroup**. |
    | **Сведения об экземпляре** |  |
    | Имя виртуальной машины | Введите **myVMNVA**. |
    | Регион | Выберите регион **(США) Восточная часть США**. |
    | Параметры доступности | Выберите **Избыточность инфраструктуры не требуется**. |
    | Образ — | Выберите **Windows Server 2019 Datacenter**. |
    | Точечный экземпляр Azure | Выберите **Нет**. |
    | Размер | Выберите размер виртуальной машины или подтвердите значение по умолчанию. |
    | **Учетная запись администратора** |  |
    | Имя пользователя | Введите имя пользователя. |
    | Пароль | Введите пароль. |
    | Подтверждение пароля | Введите пароль еще раз. |
    | **Правила входящего порта** |    |
    | Общедоступные входящие порты | Выберите **Отсутствует**. |
    |

3. Выберите вкладку **Сеть** или **Далее: диски**, затем **Далее: сеть**.
  
4. На вкладке "Сеть" укажите следующее.

    | Параметр | Значение |
    |-|-|
    | **Сетевой интерфейс** |  |
    | Виртуальная сеть | Выберите **myVirtualNetwork**. |
    | Подсеть | Выберите **DMZ**. |
    | Общедоступный IP-адрес | Выберите **Нет**. |
    | Сетевая группа безопасности сетевого адаптера | Выберите **Базовый**.|
    | Общедоступная сеть с входящими портами | Выберите **Отсутствует**. |
   
5. Перейдите на вкладку **Просмотр и создание** или нажмите синюю кнопку **Просмотр и создание** внизу страницы.
  
6. Проверьте параметры, а затем нажмите кнопку **Создать**.

## <a name="create-a-route-table"></a>Создание таблицы маршрутов

1. На **домашней странице** или в меню [портала Azure](https://portal.azure.com) щелкните **Создать ресурс**.

2. В поле поиска введите **Таблица маршрутов**. Когда элемент **Таблица маршрутов** появится в результатах поиска, выберите его.

3. На странице **Таблица маршрутов** щелкните **Создать**.

4. На вкладке **Основные сведения** в разделе **Создание таблицы маршрутов** введите или выберите следующие значения параметров.

    | Параметр | Значение |
    | ------- | ----- |
    | **Сведения о проекте** |   |
    | Подписка | Выберите свою подписку.|
    | Группа ресурсов | Выберите **myResourceGroup**. |
    | **Сведения об экземпляре** |    |
    | Регион | Выберите **Восточная часть США**. |
    | Имя | Введите **myRouteTablePublic**. |
    | Распространение маршрутов шлюза | Выберите ответ **Да**. |

    :::image type="content" source="./media/tutorial-create-route-table-portal/create-route-table.png" alt-text="Создание таблицы маршрутов, портал Azure." border="true":::

5. Перейдите на вкладку **Просмотр и создание** или нажмите синюю кнопку **Просмотр и создание** внизу страницы.

## <a name="create-a-route"></a>Создание маршрута

1. Перейдите на [портал Azure](https://portal.azure.com) для управления таблицей маршрутизации. Найдите и щелкните **Таблицы маршрутов**.

2. Выберите имя таблицы маршрутов (**myRouteTablePublic**).

3. На странице **myRouteTablePublic** в разделе **Параметры** выберите **Маршруты**.

4. На странице "Маршруты" нажмите кнопку **+ Добавить**.

5. В подменю **Добавление маршрута** введите или выберите следующую информацию:

    | Параметр | Значение |
    | ------- | ----- |
    | Имя маршрута | Введите **ToPrivateSubnet**. |
    | Префикс адреса | Введите **10.0.1.0/24** (диапазон адресов подсети **Private**, созданной ранее) |
    | Тип следующего прыжка | Выберите **Виртуальный модуль**. |
    | Адрес следующего прыжка | Введите **10.0.2.4** (адрес в диапазоне адресов подсети **DMZ**) |

6. Щелкните **ОК**.

## <a name="associate-a-route-table-to-a-subnet"></a>Связывание таблицы маршрутов с подсетью

1. Перейдите на [портал Azure](https://portal.azure.com) для управления виртуальной сетью. Найдите и щелкните **Виртуальные сети**.

2. Выберите имя виртуальной сети **myVirtualNetwork**.

3. На странице **myVirtualNetwork** в разделе **Параметры** выберите **Подсети**.

4. В списке подсетей виртуальной сети выберите **Public**.

5. В **таблице маршрутов** выберите созданную таблицу маршрутов **myRouteTablePublic**. 

6. Нажмите кнопку **Сохранить**, чтобы связать таблицу маршрутов с подсетью **Public**.

    :::image type="content" source="./media/tutorial-create-route-table-portal/associate-route-table.png" alt-text="Связывание таблицы маршрутов, список подсетей, виртуальная сеть, портал Azure" border="true":::

## <a name="turn-on-ip-forwarding"></a>Включение IP-пересылки

Затем включите параметр "IP-пересылка" для новой виртуальной машины **myVMNVA**, которая является сетевым виртуальным устройством. Когда Azure отправляет трафик к **myVMNVA**, а он предназначается для других IP-адресов, IP-пересылка будет перенаправлять трафик в правильное расположение.

1. Перейдите на [портал Azure](https://portal.azure.com) для управления виртуальной машиной. Найдите и щелкните **Виртуальные машины**.

2. Выберите имя виртуальной машины **myVMNVA**.

3. На странице "Обзор" для **myVMNVA** в разделе **Параметры** выберите **Сеть**.

4. На странице **Сеть** виртуальной машины **myVMNVA** выберите сетевой интерфейс рядом с параметром **Сетевой интерфейс**.  Имя интерфейса будет начинаться с **myvmnva**.

    :::image type="content" source="./media/tutorial-create-route-table-portal/virtual-machine-networking.png" alt-text="Сеть, сетевой виртуальный модуль, виртуальная машина, портал Azure" border="true":::

5. На странице обзора сетевых интерфейсов в разделе **Параметры** выберите **Конфигурации IP**.

6. На странице **Конфигурации IP** задайте для параметра **IP-пересылка** значение **Включено** и нажмите кнопку **Сохранить**.

    :::image type="content" source="./media/tutorial-create-route-table-portal/enable-ip-forwarding.png" alt-text="Включение IP-пересылки" border="true":::

## <a name="create-public-and-private-virtual-machines"></a>Создание общедоступных и частных виртуальных машин

Создайте общедоступную и частную виртуальную машину в виртуальной сети. Вы будете их использовать для просмотра, чтобы убедиться, что Azure направляет трафик **общедоступной** подсети в **частную** подсеть через виртуальные сетевые модули.


### <a name="public-vm"></a>Общедоступная виртуальная машина

1. В верхнем левом углу страницы портала выберите **Создать ресурс** > **Вычисления** > **Виртуальная машина**. 
   
2. В разделе **Создание виртуальной машины** на вкладке **Основные сведения** укажите следующее.

    | Параметр | Значение                                          |
    |-----------------------|----------------------------------|
    | **Сведения о проекте** |  |
    | Подписка | Выбор подписки Azure |
    | Группа ресурсов | Выберите **MyResourceGroup**. |
    | **Сведения об экземпляре** |  |
    | Имя виртуальной машины | Введите **myVMPublic**. |
    | Регион | Выберите регион **(США) Восточная часть США**. |
    | Параметры доступности | Выберите **Избыточность инфраструктуры не требуется**. |
    | Образ — | Выберите **Windows Server 2019 Datacenter**. |
    | Точечный экземпляр Azure | Выберите **Нет**. |
    | Размер | Выберите размер виртуальной машины или подтвердите значение по умолчанию. |
    | **Учетная запись администратора** |  |
    | Имя пользователя | Введите имя пользователя. |
    | Пароль | Введите пароль. |
    | Подтверждение пароля | Введите пароль еще раз. |
    | **Правила входящего порта** |    |
    | Общедоступные входящие порты | Выберите **Отсутствует**. |
    |

3. Выберите вкладку **Сеть** или **Далее: диски**, затем **Далее: сеть**.
  
4. На вкладке "Сеть" укажите следующее.

    | Параметр | Значение |
    |-|-|
    | **Сетевой интерфейс** |  |
    | Виртуальная сеть | Выберите **myVirtualNetwork**. |
    | Подсеть | Выберите **Public**. |
    | Общедоступный IP-адрес | Выберите **Нет**. |
    | Сетевая группа безопасности сетевого адаптера | Выберите **Базовый**.|
    | Общедоступная сеть с входящими портами | Выберите **Отсутствует**. |
   
5. Перейдите на вкладку **Просмотр и создание** или нажмите синюю кнопку **Просмотр и создание** внизу страницы.
  
6. Проверьте параметры, а затем нажмите кнопку **Создать**.

### <a name="private-vm"></a>Частная виртуальная машина

1. В верхнем левом углу страницы портала выберите **Создать ресурс** > **Вычисления** > **Виртуальная машина**. 
   
2. В разделе **Создание виртуальной машины** на вкладке **Основные сведения** укажите следующее.

    | Параметр | Значение                                          |
    |-----------------------|----------------------------------|
    | **Сведения о проекте** |  |
    | Подписка | Выбор подписки Azure |
    | Группа ресурсов | Выберите **MyResourceGroup**. |
    | **Сведения об экземпляре** |  |
    | Имя виртуальной машины | Введите **myVMPrivate**. |
    | Регион | Выберите регион **(США) Восточная часть США**. |
    | Параметры доступности | Выберите **Избыточность инфраструктуры не требуется**. |
    | Образ — | Выберите **Windows Server 2019 Datacenter**. |
    | Точечный экземпляр Azure | Выберите **Нет**. |
    | Размер | Выберите размер виртуальной машины или подтвердите значение по умолчанию. |
    | **Учетная запись администратора** |  |
    | Имя пользователя | Введите имя пользователя. |
    | Пароль | Введите пароль. |
    | Подтверждение пароля | Введите пароль еще раз. |
    | **Правила входящего порта** |    |
    | Общедоступные входящие порты | Выберите **Отсутствует**. |
    |

3. Выберите вкладку **Сеть** или **Далее: диски**, затем **Далее: сеть**.
  
4. На вкладке "Сеть" укажите следующее.

    | Параметр | Значение |
    |-|-|
    | **Сетевой интерфейс** |  |
    | Виртуальная сеть | Выберите **myVirtualNetwork**. |
    | Подсеть | Выберите **Private**. |
    | Общедоступный IP-адрес | Выберите **Нет**. |
    | Сетевая группа безопасности сетевого адаптера | Выберите **Базовый**.|
    | Общедоступная сеть с входящими портами | Выберите **Отсутствует**. |
   
5. Перейдите на вкладку **Просмотр и создание** или нажмите синюю кнопку **Просмотр и создание** внизу страницы.
  
6. Проверьте параметры, а затем нажмите кнопку **Создать**.

## <a name="route-traffic-through-an-nva"></a>Перенаправление трафика через виртуальный сетевой модуль

### <a name="sign-in-to-private-vm"></a>Вход на частную виртуальную машину

1. Перейдите на [портал Azure](https://portal.azure.com) для управления частной виртуальной машиной. Найдите и щелкните **Виртуальные машины**.

2. Выберите имя частной виртуальной машины **myVmPrivate**.

3. В строке меню виртуальной машины выберите **Подключить** и щелкните **Бастион**.

4. На странице **Подключение** нажмите синюю кнопку **Использовать Бастион**.

5. На странице **Бастион** введите имя пользователя и пароль, созданные ранее для виртуальной машины.

6. Выберите **Подключиться**.

### <a name="configure-firewall"></a>Настройка брандмауэра

Для проверки маршрутизации вы позже будете использовать средство трассировки маршрута. Средство трассировки маршрута использует протокол ICMP, который по умолчанию запрещен в брандмауэре Windows. 

Разрешите трафик ICMP в брандмауэре Windows.

1. Перейдите к подключению бастиона **myVMPrivate** и откройте PowerShell с правами администратора.

2. Введите эту команду:

    ```powershell
    New-NetFirewallRule –DisplayName "Allow ICMPv4-In" –Protocol ICMPv4
    ```

    Для проверки маршрутизации в этом учебнике используется трассировка маршрута. Мы не рекомендуем разрешать протокол ICMP в брандмауэре Windows в рабочей среде.

### <a name="turn-on-ip-forwarding-within-myvmnva"></a>Включение IP-пересылки в myVMNVA

Вы [включили IP-пересылку](#turn-on-ip-forwarding) для сетевого интерфейса виртуальной машины с помощью Azure. Операционная система виртуальной машины также должна переадресовывать сетевой трафик. 

Включите IP-пересылку для **myVMNVA** с помощью следующих команд.

1. Из PowerShell виртуальной машины **myVMPrivate** откройте удаленный рабочий стол виртуальной машины **myVMNVA**.

    ```powershell
    mstsc /v:myvmnva
    ```

2. В PowerShell на виртуальной машине **myVMNVA** введите следующую команду, чтобы включить IP-пересылку:

    ```powershell
    Set-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters -Name IpEnableRouter -Value 1
    ```

3. Перезапустите **myVMNVA**.

    ```powershell
    Restart-Computer
    ```

4. После перезапуска **myVMNVA** создайте сеанс удаленного рабочего стола для **myVMPublic**. 
    
    Откройте PowerShell, не отключаясь от **myVMPrivate**, и воспользуйтесь следующей командой:

    ```powershell
    mstsc /v:myvmpublic
    ```
5. На удаленном рабочем столе **myVMPublic** откройте PowerShell.

6. Разрешите протокол ICMP в брандмауэре Windows, введя следующую команду:

    ```powershell
    New-NetFirewallRule –DisplayName "Allow ICMPv4-In" –Protocol ICMPv4
    ```

## <a name="test-the-routing-of-network-traffic"></a>Проверка маршрутизации сетевого трафика

Сначала протестируйте маршрутизацию сетевого трафика из **myVMPublic** в **myVMPrivate**.

1. В PowerShell на **myVMPublic** введите следующую команду:

    ```powershell
    tracert myvmprivate
    ```

    Вы получите ответ, аналогичный приведенному ниже примеру:

    ```powershell
    Tracing route to myvmprivate.q04q2hv50taerlrtdyjz5nza1f.bx.internal.cloudapp.net [10.0.1.4]
    over a maximum of 30 hops:

      1     1 ms     *        2 ms  myvmnva.internal.cloudapp.net [10.0.2.4]
      2     2 ms     1 ms     1 ms  myvmprivate.internal.cloudapp.net [10.0.1.4]

    Trace complete.
    ```

    * Можно заметить, что для первого прыжка указан частный IP-адрес **myVMNVA's** 10.0.2.4. 

    * Второй прыжок осуществляется на частный IP-адрес **myVMPrivate**: 10.0.1.4. 

    Ранее в таблицу маршрутов **myRouteTablePublic** вы добавили маршрут и связали его с *общедоступной* подсетью. Azure передает трафик через виртуальный сетевой модуль, а не непосредственно в подсеть *Private*.

2. Закройте сеанс удаленного рабочего стола с **myVMPublic**, сохраняя подключение к **myVMPrivate**.

3. Откройте PowerShell в **myVMPrivate** и введите эту команду:

    ```powershell
    tracert myvmpublic
    ```

    Таким образом будет проверена маршрутизация сетевого трафика из виртуальной машины *myVmPrivate* в виртуальную машину *myVmPublic*. Вы получите ответ, аналогичный приведенному ниже примеру:

    ```cmd
    Tracing route to myvmpublic.q04q2hv50taerlrtdyjz5nza1f.bx.internal.cloudapp.net [10.0.0.4]
    over a maximum of 30 hops:

      1     1 ms     1 ms     1 ms  myvmpublic.internal.cloudapp.net [10.0.0.4]

    Trace complete.
    ```

    Вы увидите, что Azure маршрутизирует трафик напрямую из *myVMPrivate* в *myVMPublic*. По умолчанию Azure маршрутизирует трафик между подсетями напрямую.

4. Закройте сеанс бастиона с **myVMPrivate**.

## <a name="clean-up-resources"></a>Очистка ресурсов

Удалите группу ресурсов **myResourceGroup** и все содержащиеся в ней ресурсы, когда она станет не нужна.

1. Перейдите на [портал Azure](https://portal.azure.com) для управления группой ресурсов. Найдите и щелкните **Группы ресурсов**.

2. Выберите имя группы ресурсов **myResourceGroup**.

3. Выберите **Удалить группу ресурсов**.

4. В диалоговом окне подтверждения введите **myResourceGroup** в поле **Введите имя группы ресурсов**, а затем нажмите кнопку **Удалить**. 


## <a name="next-steps"></a>Дальнейшие действия

Изучив это руководство, вы:

* создали таблицу маршрутов и связали ее с подсетью;
* создали простой виртуальный сетевой модуль, который направляет трафик из общедоступной подсети в частную подсеть. 

Вы можете развернуть различные предварительно настроенные сетевые виртуальные ресурсы из [Azure Marketplace](https://azuremarketplace.microsoft.com/marketplace/apps/category/networking), которые предоставляют много полезных сетевых функций. 

См. дополнительные сведения о [маршрутизации](virtual-networks-udr-overview.md) и [управлении таблицей маршрутов](manage-route-table.md).

Сведения о фильтрации сетевого трафика в виртуальной сети см. в этом документе:
> [!div class="nextstepaction"]
> [Руководство. Фильтрация сетевого трафика с помощью групп безопасности сети, используя портал Azure](tutorial-filter-network-traffic.md)
