---
title: Создание виртуальной машины Azure с ускоренной сетью с помощью Azure CLI
description: Узнайте, как создать виртуальную машину Linux с ускоренной сетью.
services: virtual-network
documentationcenter: na
author: gsilva5
manager: gedegrac
editor: ''
tags: azure-resource-manager
ms.assetid: ''
ms.service: virtual-network
ms.devlang: na
ms.topic: how-to
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 01/10/2019
ms.author: gsilva
ms.custom: ''
ms.openlocfilehash: 5b91d6e58f4ae93bbf020f202991f878e7773114
ms.sourcegitcommit: d59abc5bfad604909a107d05c5dc1b9a193214a8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/14/2021
ms.locfileid: "98222961"
---
# <a name="create-a-linux-virtual-machine-with-accelerated-networking-using-azure-cli"></a>Создание виртуальной машины Linux с функцией ускорения сети с помощью Azure CLI

В этом руководстве вы узнаете, как создать виртуальную машину Linux с ускоренной сетью. Сведения о создании виртуальной машины Windows с ускоренной сетью см. в статье [Создание виртуальной машины Windows с ускоренной сетью](create-vm-accelerated-networking-powershell.md). Функция ускорения сети позволяет использовать виртуализацию ввода-вывода с единым корнем (SR-IOV), повышая тем самым производительность сети виртуальной машины. Этот высокопроизводительный метод обеспечивает обход узла на пути к данным, что уменьшает задержку, дрожание и нагрузку ЦП. Он предназначен для ресурсоемких рабочих нагрузок сети на виртуальных машинах поддерживаемых типов. На следующем рисунке приведена схема обмена данными между двумя виртуальными машинами с функцией ускорения сети и без нее:

![Сравнение](./media/create-vm-accelerated-networking/accelerated-networking.png)

Без функции ускорения сети весь входящий и исходящий сетевой трафик виртуальной машины должен проходить через узел и виртуальный коммутатор. Виртуальный коммутатор обеспечивает принудительное применение всех политик, таких как группы безопасности сети, списки управления доступом, изоляция, и использование других служб виртуализации сети для сетевого трафика. Дополнительные сведения о виртуальных коммутаторах см. в статье о [виртуализации сети Hyper-V](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj134230(v=ws.11)).

При использовании функции ускорения сети трафик поступает в сетевой интерфейс (NIC), а затем перенаправляется на виртуальную машину. Все сетевые политики, которые применяет виртуальный коммутатор, выгружены и применяются на аппаратном уровне. Благодаря применению политик на аппаратном уровне сетевая карта может перенаправлять сетевой трафик непосредственно на виртуальную машину в обход узла и виртуального коммутатора. При этом все политики, примененные на узле, сохраняются.

Возможности функции ускорения сети применяются только к той виртуальной машине, где она включена. Для получения наилучших результатов необходимо включить эту функцию по крайней мере на двух виртуальных машинах, подключенных к одной виртуальной сети Azure. При обмене данными между виртуальными или локальными сетями эта функция практически не влияет на общую задержку.

## <a name="benefits"></a>Преимущества
* **Уменьшение задержки (больше пакетов в секунду).** Благодаря обходу виртуального коммутатора на пути к данным на узле не выполняется обработка политики пакетов. Таким образом, увеличивается число пакетов, которые могут быть обработаны на виртуальной машине.
* **Уменьшение дрожания.** Обработка с помощью виртуального коммутатора зависит от числа политик, которые необходимо применить, и рабочей нагрузки ЦП, выполняющего обработку. Так как принудительное применение политик осуществляется на аппаратном уровне, эта зависимость устраняется за счет доставки пакетов непосредственно на виртуальную машину. Это позволяет избежать обмена данными между узлом и виртуальной машиной, прерываний работы программного обеспечения и переключений контекста.
* **Уменьшение нагрузки ЦП.** Обход виртуального коммутатора на узле приводит к меньшему использованию ЦП для обработки сетевого трафика.

## <a name="supported-operating-systems"></a>Поддерживаемые операционные системы
Без дополнительной настройки из коллекции Azure поддерживаются следующие дистрибутивы: 
* **Ubuntu 14,04 с ядром Linux-Azure**
* **Ubuntu 16.04 или более поздней версии.** 
* **SLES12 SP3 или более поздней версии** 
* **RHEL 7,4 или более поздней версии**
* **CentOS 7,4 или более поздней версии**
* **CoreOS Linux**
* **Debian "Stretch" с поддержкой однопортовых ядер, Debian "бустер" или более поздней версии**
* **Oracle Linux 7,4 и более поздних версий с ядром, совместимым с Red Hat (RHCK)**
* **Oracle Linux 7,5 и более поздних версий с UEK версии 5**
* **FreeBSD 10,4, 11,1 & 12,0 или более поздней версии**

## <a name="limitations-and-constraints"></a>Ограничения

### <a name="supported-vm-instances"></a>Поддерживаемые экземпляры виртуальных машин
Функция ускорения сети поддерживается для большинства размеров экземпляров, оптимизированных для вычислений, и экземпляров общего назначения с количеством виртуальных ЦП от 2.  Поддерживаемые серии: D/DSv2 и F/Fs

На экземплярах, поддерживающих технологию Hyper-Threading, функция ускорения сети поддерживается в экземплярах виртуальных машин с количеством виртуальных ЦП от 4. Поддерживаются следующие серии: D/Dsv3, D/Dsv4, DD/Ddv4, Da/Dasv4, E/Esv3, E/Esv4, ED/Edsv4, EA/Easv4, серия fsv2, Lsv2, MS/MMS и MS/Mmsv2.

Дополнительные сведения см. в статье [Размеры виртуальных машин Linux в Azure](../virtual-machines/sizes.md?toc=%2fazure%2fvirtual-network%2ftoc.json).

### <a name="custom-images"></a>Пользовательские образы
Если вы используете пользовательский образ, а образ поддерживает ускоренную работу в сети, убедитесь, что у вас есть необходимые драйверы для работы с сетевыми адаптерами Mellanox ConnectX-3 и ConnectX-4 LX в Azure.

### <a name="regions"></a>Регионы
Доступно во всех общедоступных регионах Azure, а также в облаках Azure для государственных организаций.

<!-- ### Network interface creation 
Accelerated networking can only be enabled for a new NIC. It cannot be enabled for an existing NIC.
removed per issue https://github.com/MicrosoftDocs/azure-docs/issues/9772 -->
### <a name="enabling-accelerated-networking-on-a-running-vm"></a>Включение ускоренной сети для работающей виртуальной машины
Чтобы включить ускоренную сеть для виртуальной машины поддерживаемого размера, для которой эта функция отключена, виртуальную машину необходимо остановить и отменить ее распределение.  
### <a name="deployment-through-azure-resource-manager"></a>Развертывание с помощью Azure Resource Manager
Классические виртуальные машины нельзя развернуть с включенной функцией ускорения сети.

## <a name="create-a-linux-vm-with-azure-accelerated-networking"></a>Создание виртуальной машины Linux с ускорением сети Azure
## <a name="portal-creation"></a>Создание на портале
В этой статье описано, как создать виртуальную машину с ускорением работы в сети. Но с помощью Azure CLI вы также можете [создать аналогичную виртуальную машину на портале Azure](../virtual-machines/linux/quick-create-portal.md?toc=%2fazure%2fvirtual-network%2ftoc.json). При создании виртуальной машины на портале в колонке **Создание виртуальной машины** перейдите на вкладку **сеть** .  На этой вкладке можно выбрать функцию **ускорения** работы в сети.  Если вы выбрали [поддерживаемую операционную систему](#supported-operating-systems) и [Размер виртуальной машины](#supported-vm-instances), этот параметр будет автоматически заполняться на "вкл.".  В противном случае он заполнит параметр "Выкл." для ускорения сети и предложит пользователю причину, по которой он не включен.   

* *Примечание.* На портале можно включить только поддерживаемые операционные системы.  Если вы используете пользовательский образ, а образ поддерживает ускорение работы в сети, создайте виртуальную машину с помощью интерфейса командной строки или PowerShell. 

После создания виртуальной машины можно проверить, включена ли Ускоренная сеть, следуя инструкциям в разделе [подтверждение включения ускорения сети](#confirm-that-accelerated-networking-is-enabled).

## <a name="cli-creation"></a>Создание интерфейса командной строки
### <a name="create-a-virtual-network"></a>Создание виртуальной сети

Установите последнюю версию [Azure CLI](/cli/azure/install-azure-cli) и войдите в систему с учетной записью Azure, выполнив команду [az login](/cli/azure/reference-index). В следующих примерах замените имена параметров собственными значениями. Примеры имен параметров: *myResourceGroup*, *myNic* и *myVm*.

Создайте группу ресурсов с помощью команды [az group create](/cli/azure/group). В следующем примере создается группа ресурсов с именем *myResourceGroup* в расположении *centralus*.

```azurecli
az group create --name myResourceGroup --location centralus
```

Выберите поддерживаемый регион Linux, указанный в статье [General availability (Windows) and preview (Linux): Accelerated Networking](https://azure.microsoft.com/updates/accelerated-networking-in-expanded-preview) (Ускоренная сеть: общедоступная версия (Windows) и предварительная версия (Linux)).

Создайте виртуальную сеть с помощью команды [az network vnet create](/cli/azure/network/vnet). В следующем примере создаются виртуальная сеть *myVnet* и одна подсеть.

```azurecli
az network vnet create \
    --resource-group myResourceGroup \
    --name myVnet \
    --address-prefix 192.168.0.0/16 \
    --subnet-name mySubnet \
    --subnet-prefix 192.168.1.0/24
```

### <a name="create-a-network-security-group"></a>Создание группы безопасности сети
Создайте группу безопасности сети с помощью команды [az network nsg create](/cli/azure/network/nsg). В следующем примере создается группа безопасности сети *myNetworkSecurityGroup*.

```azurecli
az network nsg create \
    --resource-group myResourceGroup \
    --name myNetworkSecurityGroup
```

Группа безопасности сети содержит несколько правил по умолчанию, одно из которых отключает входящий доступ из Интернета. Откройте порт, чтобы разрешить доступ к виртуальной машине по SSH с помощью команды [az network nsg rule create](/cli/azure/network/nsg/rule):

```azurecli
az network nsg rule create \
  --resource-group myResourceGroup \
  --nsg-name myNetworkSecurityGroup \
  --name Allow-SSH-Internet \
  --access Allow \
  --protocol Tcp \
  --direction Inbound \
  --priority 100 \
  --source-address-prefix Internet \
  --source-port-range "*" \
  --destination-address-prefix "*" \
  --destination-port-range 22
```

### <a name="create-a-network-interface-with-accelerated-networking"></a>Создание сетевого интерфейса с функцией ускорения сети

Создайте общедоступный IP-адрес с помощью команды [az network public-ip create](/cli/azure/network/public-ip). Если вы не планируете входить на виртуальную машину из Интернета, общедоступный IP-адрес не требуется, однако он нужен, чтобы выполнить шаги, описанные в этой статье.

```azurecli
az network public-ip create \
    --name myPublicIp \
    --resource-group myResourceGroup
```

Создайте сетевой интерфейс с включенной функцией ускорения сети, выполнив команду [az network nic create](/cli/azure/network/nic). В следующем примере создается сетевой интерфейс с именем *myNic* в подсети *mySubnet* виртуальной сети *myVnet* и группа безопасности сети *myNetworkSecurityGroup* связывается с сетевым интерфейсом:

```azurecli
az network nic create \
    --resource-group myResourceGroup \
    --name myNic \
    --vnet-name myVnet \
    --subnet mySubnet \
    --accelerated-networking true \
    --public-ip-address myPublicIp \
    --network-security-group myNetworkSecurityGroup
```

### <a name="create-a-vm-and-attach-the-nic"></a>Создание виртуальной машины и подключение сетевого адаптера
При создании виртуальной машины укажите сетевой адаптер, созданный с помощью `--nics`. Выберите размер и распределение, указанные в статье [General availability (Windows) and preview (Linux): Accelerated Networking](https://azure.microsoft.com/updates/accelerated-networking-in-expanded-preview) (Ускоренная сеть: общедоступная версия (Windows) и предварительная версия (Linux)). 

Создайте виртуальную машину с помощью команды [az vm create](/cli/azure/vm). В следующем примере создается виртуальная машина *myVM* с образом UbuntuLTS и размером, поддерживающим ускоренную сеть (*Standard_DS4_v2*):

```azurecli
az vm create \
    --resource-group myResourceGroup \
    --name myVM \
    --image UbuntuLTS \
    --size Standard_DS4_v2 \
    --admin-username azureuser \
    --generate-ssh-keys \
    --nics myNic
```

Чтобы просмотреть список всех размеров виртуальных машин и их характеристики, ознакомьтесь со статьей [Размеры виртуальных машин Linux в Azure](../virtual-machines/sizes.md?toc=%2fazure%2fvirtual-network%2ftoc.json).

После создания виртуальной машины возвращается результат, аналогичный приведенному ниже. Запишите значение **publicIpAddress**. Этот адрес используется для доступа к виртуальной машине в последующих шагах.

```output
{
  "fqdns": "",
  "id": "/subscriptions/<ID>/resourceGroups/myResourceGroup/providers/Microsoft.Compute/virtualMachines/myVM",
  "location": "centralus",
  "macAddress": "00-0D-3A-23-9A-49",
  "powerState": "VM running",
  "privateIpAddress": "192.168.0.4",
  "publicIpAddress": "40.68.254.142",
  "resourceGroup": "myResourceGroup"
}
```

### <a name="confirm-that-accelerated-networking-is-enabled"></a>Подтверждение активации ускоренной сети

Используйте следующую команду для создания сеанса SSH с виртуальной машиной. Замените `<your-public-ip-address>` общедоступным IP-адресом, назначенным созданной виртуальной машине, а также замените *azureuser*, если при создании виртуальной машины вы использовали другое значение для `--admin-username`.

```bash
ssh azureuser@<your-public-ip-address>
```

В окне оболочки Bash введите `uname -r` и убедитесь, что версия ядра соответствует одной из следующих версий или более поздней версии:

* **Ubuntu 16.04**: 4.11.0-1013
* **SLES SP3**: 4.4.92-6.18
* **RHEL**: 7.4.2017120423
* **CentOS**: 7.4.20171206


Выполнив команду `lspci`, убедитесь, что устройство Mellanox VF находится на виртуальной машине. Выходные данные аналогичны приведенным ниже.

```output
0000:00:00.0 Host bridge: Intel Corporation 440BX/ZX/DX - 82443BX/ZX/DX Host bridge (AGP disabled) (rev 03)
0000:00:07.0 ISA bridge: Intel Corporation 82371AB/EB/MB PIIX4 ISA (rev 01)
0000:00:07.1 IDE interface: Intel Corporation 82371AB/EB/MB PIIX4 IDE (rev 01)
0000:00:07.3 Bridge: Intel Corporation 82371AB/EB/MB PIIX4 ACPI (rev 02)
0000:00:08.0 VGA compatible controller: Microsoft Corporation Hyper-V virtual VGA
0001:00:02.0 Ethernet controller: Mellanox Technologies MT27500/MT27520 Family [ConnectX-3/ConnectX-3 Pro Virtual Function]
```

Проверьте работоспособность виртуальной функции VF с помощью команды `ethtool -S eth0 | grep vf_`. Если будут выведены выходные данные, аналогичные следующим, это значит, что ускоренная сеть включена и работает.

```output
vf_rx_packets: 992956
vf_rx_bytes: 2749784180
vf_tx_packets: 2656684
vf_tx_bytes: 1099443970
vf_tx_dropped: 0
```
Ускорение работы в сети теперь включено на вашей виртуальной машине.

## <a name="handle-dynamic-binding-and-revocation-of-virtual-function"></a>Обработайте динамическую привязку и отзыв виртуальной функции 
Приложения должны выполняться через искусственный сетевой адаптер, который доступен в виртуальной машине. Если приложение запускается непосредственно через сетевой адаптер VF, он не получает **все** пакеты, предназначенные для виртуальной машины, так как некоторые пакеты отображаются через искусственный интерфейс.
Если приложение запускается по искусственному сетевому интерфейсу, оно гарантирует, что приложение получит **все** пакеты, предназначенные для него. Это также гарантирует, что приложение продолжает работать, даже если при обслуживании узла будет отозван VF. Привязка приложений к искусственному сетевому адаптеру является **обязательным** требованием для всех приложений, использующих преимущества **ускоренной сети**.

## <a name="enable-accelerated-networking-on-existing-vms"></a>Включение ускоренной сети для имеющихся виртуальных машин
Если вы создали виртуальную машину без ускоренной сети, для нее можно включить эту функцию позднее.  Виртуальная машина должна поддерживать ускоренную сеть, то есть соответствовать указанным ниже требованиям, которые также описаны выше.

* Виртуальная машина должна иметь размер, поддерживаемый функцией ускоренной сети.
* Виртуальная машина должна быть развернута из поддерживаемого образа коллекции Azure (и иметь поддерживаемую версию ядра для Linux).
* Все виртуальные машины в группе доступности или масштабируемом наборе виртуальных машин должны быть остановлены и освобождены перед включением ускоренной сети в любом из сетевых адаптеров.

### <a name="individual-vms--vms-in-an-availability-set"></a>Отдельные виртуальные машины и виртуальные машины в группе доступности
Сначала остановите виртуальную машину и отмените ее выделение. В случае с группой доступности сделайте это со всеми виртуальными машинами в наборе:

```azurecli
az vm deallocate \
    --resource-group myResourceGroup \
    --name myVM
```

Обратите внимание на то, что если виртуальная машина была создана отдельно, то есть без группы доступности, для включения ускоренной сети необходимо остановить только эту виртуальную машину и отменить ее выделение.  Если виртуальная машина была создана с группой доступности, перед включением ускоренной сети в любом сетевом адаптере необходимо остановить все виртуальные машины в группе и отменить их выделение. 

После остановки виртуальной машины включите ускоренную сеть в ее сетевом адаптере:

```azurecli
az network nic update \
    --name myNic \
    --resource-group myResourceGroup \
    --accelerated-networking true
```

Перезапустите виртуальную машину или, в случае с группой доступности, все виртуальные машины в группе и убедитесь в том, что ускоренная сеть включена: 

```azurecli
az vm start --resource-group myResourceGroup \
    --name myVM
```

### <a name="vmss"></a>Масштабируемый набор виртуальных машин
Процедура для масштабируемого набора виртуальных машин немного отличается, но в целом похожа.  Сначала остановите виртуальные машины:

```azurecli
az vmss deallocate \
    --name myvmss \
    --resource-group myrg
```

После остановки виртуальных машин измените значение свойства ускоренной сети в сетевом интерфейсе:

```azurecli
az vmss update --name myvmss \
    --resource-group myrg \
    --set virtualMachineProfile.networkProfile.networkInterfaceConfigurations[0].enableAcceleratedNetworking=true
```

Обратите внимание на то, что обновления к виртуальным машинам в масштабируемом наборе применяются тремя разными способами: автоматически, последовательно и вручную.  В рассматриваемом случае настроено автоматическое обновление, поэтому изменения применяются к масштабируемому набору виртуальных машин сразу после перезапуска.  Чтобы настроить автоматическое обновление, выполните следующую команду: 

```azurecli
az vmss update \
    --name myvmss \
    --resource-group myrg \
    --set upgradePolicy.mode="automatic"
```

Наконец, перезапустите масштабируемый набор виртуальных машин:

```azurecli
az vmss start \
    --name myvmss \
    --resource-group myrg
```

После перезапуска дождитесь завершения обновления. Как только оно закончится, в виртуальной машине появится виртуальная функция.  (Убедитесь в том, что вы используете поддерживаемые ОС и размер виртуальной машины.)

### <a name="resizing-existing-vms-with-accelerated-networking"></a>Изменение размеров имеющихся виртуальных машин с ускоренной сетью

Размер виртуальных машин с ускоренной сетью можно изменить только на такой, который также поддерживает ускоренную сеть.  

Виртуальную машину с включенной виртуальной сетью нельзя изменить на экземпляр такого размера, который не поддерживает ускоренную сеть, с помощью операции изменения размера.  Вместо этого нужно выполнить указанные ниже действия. 

* Остановите виртуальную машину и отмените ее выделение. В случае с группой доступности или масштабируемым набором виртуальных машин сделайте это со всеми виртуальными машинами в группе или наборе.
* Отключите ускоренную сеть в сетевом адаптере виртуальной машины.В случае с группой доступности или масштабируемым набором виртуальных машин сделайте это со всеми виртуальными машинами в группе или наборе.
* После отключения ускоренной сети можно изменить размер виртуальной машины, группы доступности или масштабируемого набора виртуальных машин на новый, который не поддерживает ускоренную сеть, а затем перезапустить виртуальные машины.