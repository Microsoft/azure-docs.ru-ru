---
title: Служба подготовки устройств к добавлению в Центр Интернета вещей. Аттестация симметричных ключей
description: В этой статье приводятся общие сведения о аттестации симметричных ключей с помощью службы подготовки устройств Интернета вещей (DPS).
author: wesmc7777
ms.author: wesmc
ms.date: 04/04/2019
ms.topic: conceptual
ms.service: iot-dps
services: iot-dps
manager: philmea
ms.custom: devx-track-csharp
ms.openlocfilehash: 994c2c3124d6822f047af942268ad7a401d5a976
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "90531565"
---
# <a name="symmetric-key-attestation"></a>Аттестация симметричных ключей

В этой статье описывается процесс аттестации удостоверения при использовании симметричных ключей с помощью Службы подготовки устройств. 

Аттестация симметричных ключей — это простой подход к аутентификации устройства в экземпляре Службы подготовки устройств. Этот метод аттестации представляет возможности программы Hello world для разработчиков, которые не имеют опыта подготовки устройств или строгих требований к безопасности. Аттестация устройства с помощью [доверенного платформенного модуля](concepts-tpm-attestation.md) или [сертификата X.509](concepts-x509-attestation.md) является более защищенной. Эти способы следует использовать при наличии более строгих требований к безопасности.

Регистрация симметричных ключей также является отличным методом для устаревших устройств с ограниченными функциональными возможностями. Она позволяет выполнить безопасную начальную загрузку в облако через Центр Интернета вещей Azure. Дополнительные сведения об аттестации симметричных ключей для устаревших устройств см. в [этой статье](how-to-legacy-device-symm-key.md).


## <a name="symmetric-key-creation"></a>Создание симметричных ключей

По умолчанию служба подготовки устройств создает новые симметричные ключи с длиной по умолчанию 64 байт при сохранении новых регистраций с включенным параметром **Автоматическое создание ключей** .

![Автоматическое создание симметричных ключей](./media/concepts-symmetric-key-attestation/auto-generate-keys.png)

Вы также можете предоставить собственные симметричные ключи для регистраций, отключив этот параметр. Указываемые собственные симметричные ключи должны быть длиной 16–64 байт. Кроме того, симметричные ключи необходимо предоставлять в допустимом формате Base64.



## <a name="detailed-attestation-process"></a>Подробный процесс аттестации

Аттестация симметричных ключей с помощью Службы подготовки устройств выполняется с использованием одинаковых [маркеров безопасности](../iot-hub/iot-hub-devguide-security.md#security-token-structure), поддерживаемых Центром Интернета вещей для определения устройств. Это [маркеры подписанного URL-адреса (SAS)](../service-bus-messaging/service-bus-sas.md). 

Для маркеров SAS предоставлена хэшированная *подпись*, созданная с использованием симметричного ключа. Эта подпись заново создается в Службе подготовки устройств, что позволяет проверить, является ли указанный во время аттестации маркер безопасности подлинным.

Маркеры SAS предоставляются в следующем формате:

`SharedAccessSignature sig={signature}&se={expiry}&skn={policyName}&sr={URL-encoded-resourceURI}`

Рассмотрим компоненты каждого маркера:

| Значение | Описание |
| --- | --- |
| {signature} |Строка подписи HMAC-SHA256. В отдельных регистрациях для выполнения хэширования эта подпись создается с использованием симметричного ключа (первичного или вторичного). Для групп регистраций ключ, полученный из ключа группы регистрации, используется для выполнения хэширования. Хэширование выполняется для сообщения в формате: `URL-encoded-resourceURI + "\n" + expiry`. **Важно!** Ключ необходимо расшифровать из кодировки base64, прежде чем использовать его для вычислений HMAC-SHA256. Кроме того, результат подписи необходимо закодировать в формате URL-адреса. |
| {resourceURI} |URI конечной точки регистрации, доступ к которой может осуществляться с помощью этого маркера. Начинается с идентификатора области для экземпляра Службы подготовки устройств. Например `{Scope ID}/registrations/{Registration ID}`. |
| {expiry} |Строки в формате UTF8, отображающие количество секунд с начала эры 00:00:00 (в формате UTC) 1 января 1970 г. |
| {URL-encoded-resourceURI} |Строчное URL-кодирование строчного URL ресурса |
| {policyName} |Имя политики общего доступа, к которой относится этот маркер. Имя политики, используемое при подготовке с применением аттестации симметричного ключа, — **registration**. |

Если аттестация устройства выполняется с применением отдельной регистрации, это устройство использует симметричный ключ, определенный в записи об этой регистрации, для создания хэшированной подписи маркера SAS.

Примеры кода для создания маркера SAS см. в разделе, [посвященном маркерам безопасности](../iot-hub/iot-hub-devguide-security.md#security-token-structure).

Создание маркеров безопасности для аттестации симметричного ключа поддерживается пакетом SDK Azure IoT для C. Пример использования пакета SDK Azure IoT для C для аттестации с помощью отдельной регистрации см. в статье [Краткое руководство по подготовке имитированного устройства с использованием симметричных ключей](quick-create-simulated-device-symm-key.md).


## <a name="group-enrollments"></a>Групповые регистрации

Симметричные ключи для групповых регистраций не используются непосредственно на устройствах при подготовке. Вместо них для подготовки устройств, входящих в группу регистраций, используется производный ключ устройства. 

Сначала для каждого устройства, аттестация которого выполняется с помощью группы регистраций, определяется уникальный идентификатор регистрации. Допустимые знаки для идентификатора регистрации — буквы нижнего регистра, цифры и дефис (-). Этот идентификатор регистрации должен быть уникальным значением, идентифицирующим устройство. Например, устаревшее устройство не может поддерживать множество функций безопасности. Такое устройство может содержать только MAC-адрес или серийный номер, который уникально его идентифицирует. В этом случае идентификатор регистрации может состоять из MAC-адреса и серийного номера, как показано ниже:

```
sn-007-888-abc-mac-a1-b2-c3-d4-e5-f6
```

Именно этот пример используется в статье [Способы подготовки устройств для использования симметричных ключей](how-to-legacy-device-symm-key.md).

После определения идентификатора регистрации устройства для получения производного ключа применяется симметричный ключ группы регистраций с целью вычисления хэш-кода [HMAC-SHA256](https://wikipedia.org/wiki/HMAC) этого идентификатора. Хэширование идентификатора регистрации может выполняться с помощью следующего кода C#:

```csharp
using System; 
using System.Security.Cryptography; 
using System.Text;  

public static class Utils 
{ 
    public static string ComputeDerivedSymmetricKey(byte[] masterKey, string registrationId) 
    { 
        using (var hmac = new HMACSHA256(masterKey)) 
        { 
            return Convert.ToBase64String(hmac.ComputeHash(Encoding.UTF8.GetBytes(registrationId))); 
        } 
    } 
} 
```

```csharp
String deviceKey = Utils.ComputeDerivedSymmetricKey(Convert.FromBase64String(masterKey), registrationId);
```

Затем полученный ключ устройства используется при создании маркера SAS, применяемого в целях аттестации. Каждое устройство в группе регистраций необходимо аттестовать с использованием маркера безопасности, созданного на основе уникального производного ключа. Симметричный ключ группы регистраций нельзя использовать непосредственно для выполнения аттестации.

#### <a name="installation-of-the-derived-device-key"></a>Установка производного ключа устройства

В идеале ключи устройства получаются и устанавливаются на этапе производства. Этот метод гарантирует, что ключ группы не будет включен в какое-либо программное обеспечение, развернутое на устройстве. Когда устройству назначен MAC-адрес или серийный номер, ключ можно получить и внедрить в устройство согласно методу хранения, выбранному производителем.

Рассмотрим следующую диаграмму, на которой показана таблица ключей устройств, созданных на этапе производства путем хэширования каждого идентификатора регистрации устройства с помощью ключа регистрации группы (**K**). 

![Ключи устройства, назначенные на этапе производства](./media/concepts-symmetric-key-attestation/key-diversification.png)

Удостоверение каждого устройства предоставляется с помощью идентификатора регистрации и производного ключа устройства, установленного на этапе производства. Ключ устройства нельзя копировать в другое расположение, а ключ группы нельзя хранить на устройстве.

Если ключи устройств не установлены на этапе производства, для безопасного хранения удостоверения устройства необходимо использовать [аппаратный модуль безопасности (HSM)](concepts-service.md#hardware-security-module).

## <a name="next-steps"></a>Дальнейшие действия

Изучив все сведения об аттестации симметричных ключей, вы можете приступить к работе со следующими статьями:

* [Краткое руководство по подготовке имитированного устройства с использованием симметричных ключей](quick-create-simulated-device-symm-key.md)
* [Сведения о концепциях подготовки](about-iot-dps.md#provisioning-process)
* [Настройка службы подготовки устройств для Центра Интернета вещей на портале Azure](./quick-setup-auto-provision.md) 
