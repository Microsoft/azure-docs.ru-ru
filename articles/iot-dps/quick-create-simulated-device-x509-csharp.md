---
title: Краткое руководство. Подготовка имитированного устройства X.509 в Центре Интернета вещей Azure с помощью C#
description: Краткое руководство по созданию и подготовке устройства X.509 с помощью пакета SDK C# для устройства, который предназначен для Службы подготовки устройств к добавлению в Центр Интернета вещей (DPS). В этом кратком руководстве используется индивидуальная регистрация.
author: wesmc7777
ms.author: wesmc
ms.date: 02/01/2021
ms.topic: quickstart
ms.service: iot-dps
services: iot-dps
ms.devlang: csharp
ms.custom: mvc
ms.openlocfilehash: 7d2a21a30cefbc6e83e48c29d81191323387b8f2
ms.sourcegitcommit: f28ebb95ae9aaaff3f87d8388a09b41e0b3445b5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/29/2021
ms.locfileid: "101705549"
---
# <a name="quickstart-create-and-provision-an-x509-device-using-c-device-sdk-for-iot-hub-device-provisioning-service"></a>Краткое руководство. Создание и подготовка устройства X.509 с помощью пакета SDK для устройства C# для Службы подготовки устройств к добавлению в Центр Интернета вещей

[!INCLUDE [iot-dps-selector-quick-create-simulated-device-x509](../../includes/iot-dps-selector-quick-create-simulated-device-x509.md)]

Здесь приведены инструкции по инициализации устройства X.509 с помощью кода устройств из [примеров Интернета вещей Azure для C#](https://github.com/Azure-Samples/azure-iot-samples-csharp). При работе с этой статьей вы запустите пример кода устройства на компьютере разработки, чтобы подключиться к Центру Интернета вещей с помощью Службы подготовки устройств.

## <a name="prerequisites"></a>Предварительные требования

Если вы не знакомы с процессом автоматической подготовки, см. раздел [Роли и учетные записи Azure](about-iot-dps.md#provisioning-process). Кроме того, прежде чем продолжить, выполните инструкции по [настройке службы "Подготовка устройств к добавлению в Центр Интернета вещей" на портале Azure](./quick-setup-auto-provision.md).

Служба подготовки устройств Интернета вещей Azure поддерживает два типа регистрации:
- [Группы регистрации](concepts-service.md#enrollment-group). Используются для регистрации нескольких связанных устройств.
- [Индивидуальные регистрации](concepts-service.md#individual-enrollment). Предназначены для регистрации одного устройства.

В этой статье описана индивидуальная регистрация.

[!INCLUDE [IoT Device Provisioning Service basic](../../includes/iot-dps-basic.md)]

<a id="setupdevbox"></a>
## <a name="prepare-the-development-environment"></a>Подготовка среды разработки 

1. Установите на компьютер систему `git` и добавьте ее в переменные среды, доступные в командном окне. Последнюю версию средств `git` для установки, которая включает **Git Bash**, приложение командной строки для взаимодействия с локальным репозиторием Git, можно найти на [этой странице](https://git-scm.com/download/). 

1. Откройте окно командной строки или Git Bash. Клонируйте репозиторий GitHub с примерами на C# для Интернета вещей Azure:
    
    ```bash
    git clone https://github.com/Azure-Samples/azure-iot-samples-csharp.git
    ```

1. Убедитесь, что на компьютере установлен [пакет SDK для .NET Core 3.0.0 или более поздней версии](https://www.microsoft.com/net/download/windows). Вы можете проверить установленную версию с помощью приведенной ниже команды.

    ```bash
    dotnet --info
    ```

## <a name="create-a-self-signed-x509-device-certificate"></a>Создание самозаверяющего сертификата для устройства X.509

При работе с этим разделом вы создадите тестовый самозаверяющий сертификат X.509, указав `iothubx509device1` в качестве общего имени субъекта. При этом стоит учесть следующее:

* Самозаверяющие сертификаты предназначены только для тестирования и не должны использоваться в рабочей среде.
* Срок действия самозаверяющего сертификата по умолчанию составляет один год.
* Идентификатор устройства Интернета вещей будет совпадать с общим именем субъекта, указанным в сертификате. Следите за тем, чтобы имя субъекта соответствовало [требованиям к строке идентификатора устройства](../iot-hub/iot-hub-devguide-identity-registry.md#device-identity-properties).

С помощью примера кода [X509Sample](https://github.com/Azure-Samples/azure-iot-samples-csharp/tree/master/provisioning/Samples/device/X509Sample) вы создадите сертификат, который будет использоваться с отдельной записью регистрации для устройства.


1. В окне командной строки PowerShell замените каталоги значением каталога проекта для примера подготовки устройства X.509.

    ```powershell
    cd .\azure-iot-samples-csharp\provisioning\Samples\device\X509Sample
    ```

2. Пример кода настроен на использование сертификатов X.509, хранящихся в защищенном паролем форматированном файле PKCS12 (certificate.pfx). Кроме того, дальше в этом кратком руководстве для создания индивидуальной регистрации вам понадобится файл сертификата открытого ключа (certificate.cer). Чтобы создать самозаверяющий сертификат и соответствующие CER- и PFX-файлы, выполните следующую команду:

    ```powershell
    PS D:\azure-iot-samples-csharp\provisioning\Samples\device\X509Sample> .\GenerateTestCertificate.ps1 iothubx509device1
    ```

3. Появится запрос на ввод пароля для PFX-файла. Запомните этот пароль, так как он понадобится позднее для выполнения примера кода. Вы можете запустить `certutil`, чтобы выгрузить сертификат и проверить имя субъекта.

    ```powershell
    PS D:\azure-iot-samples-csharp\provisioning\Samples\device\X509Sample> certutil .\certificate.pfx
    Enter PFX password:
    ================ Certificate 0 ================
    ================ Begin Nesting Level 1 ================
    Element 0:
    Serial Number: 7b4a0e2af6f40eae4d91b3b7ff05a4ce
    Issuer: CN=iothubx509device1, O=TEST, C=US
     NotBefore: 2/1/2021 6:18 PM
     NotAfter: 2/1/2022 6:28 PM
    Subject: CN=iothubx509device1, O=TEST, C=US
    Signature matches Public Key
    Root Certificate: Subject matches Issuer
    Cert Hash(sha1): e3eb7b7cc1e2b601486bf8a733887a54cdab8ed6
    ----------------  End Nesting Level 1  ----------------
      Provider = Microsoft Strong Cryptographic Provider
    Signature test passed
    CertUtil: -dump command completed successfully.    
    ```

 ## <a name="create-an-individual-enrollment-entry-for-the-device"></a>Создание индивидуальной записи регистрации для устройства


1. Войдите на портал Azure, нажмите кнопку **Все ресурсы** в меню слева и откройте службу подготовки.

2. В меню службы подготовки устройств выберите **Управление регистрациями**. Выберите вкладку **Индивидуальные регистрации** и нажмите кнопку **Добавить индивидуальную регистрацию** вверху. 

3. На панели **Добавление регистрации** введите следующие сведения:
   - Выберите **X.509** как *механизм* аттестации удостоверения.
   - В поле *PEM-файл или CER-файл первичного сертификата* щелкните *Выбрать файл*, чтобы выбрать созданный ранее файл сертификата **certificate.cer**.
   - Оставьте поле **идентификатор устройства** пустым. Устройство будет подготовлено с идентификатором, который назначен общему имени в сертификате X.509, т. е. **iothubx509device1**. Кроме того, это общее имя будет использоваться в качестве идентификатора регистрации для индивидуальной записи регистрации. 
   - При необходимости можно указать следующие сведения:
       - Выберите Центр Интернета вещей, связанный с вашей службой подготовки.
       - Обновите **начальное состояние двойника устройства**, используя требуемую начальную конфигурацию для устройства.
   - По завершении нажмите кнопку **Сохранить**. 

     [![Добавление индивидуальной регистрации для аттестации X.509 на портале](./media/quick-create-simulated-device-x509-csharp/device-enrollment.png)](./media/quick-create-simulated-device-x509-csharp/device-enrollment.png#lightbox)
    
   После регистрации запись о регистрации устройства X.509 отобразится как **iothubx509device1** в столбце *Идентификатор регистрации* на вкладке *Индивидуальные регистрации*. 



## <a name="provision-the-device"></a>Подготовка устройства к работе

1. Выберите колонку **Обзор** службы подготовки и запишите значение **_области идентификатора_** .

    ![Извлеките сведения о конечной точке службы подготовки устройств из колонки на портале](./media/quick-create-simulated-device-x509-csharp/copy-scope.png) 


2. Введите следующую команду, чтобы создать и запустить пример подготавливаемого устройства X.509. Замените значение `<IDScope>` значением области идентификатора для службы подготовки. 

    По умолчанию с помощью команды создается файл сертификата с именем *./certificate.pfx* и запрашивается пароль для этого PFX-файла.  

    ```powershell
    dotnet run -- -s <IDScope>
    ```

    Если вы хотите передать все значения в параметрах, используйте предложенный ниже формат.

    ```powershell
    dotnet run -- -s 0ne00000A0A -c certificate.pfx -p 1234
    ```


3. Устройство подключится к службе DPS и будет приписано к определенному Центру Интернета вещей. Кроме того, устройство отправит в этот центр сообщение телеметрии.

    ```output
    Loading the certificate...
    Found certificate: 10952E59D13A3E388F88E534444484F52CD3D9E4 CN=iothubx509device1, O=TEST, C=US; PrivateKey: True
    Using certificate 10952E59D13A3E388F88E534444484F52CD3D9E4 CN=iothubx509device1, O=TEST, C=US
    Initializing the device provisioning client...
    Initialized for registration Id iothubx509device1.
    Registering with the device provisioning service...
    Registration status: Assigned.
    Device iothubx509device2 registered to sample-iot-hub1.azure-devices.net.
    Creating X509 authentication for IoT Hub...
    Testing the provisioned device with IoT Hub...
    Sending a telemetry message...
    Finished.
    ```

4. Убедитесь, что устройство подготовлено. После успешной подготовки устройства для Центра Интернета вещей, подключенного к службе подготовки, идентификатор этого устройства появится в колонке **Устройства Интернета вещей**. 

    ![Устройство зарегистрировано в Центре Интернета вещей](./media/quick-create-simulated-device-x509-csharp/registration.png) 

    Если в записи регистрации для своего устройства вы изменили значение по умолчанию для *начального состояния двойника устройства*, требуемое состояние двойника будет извлечено из концентратора с последующим выполнением соответствующих действий. См. [общие сведения о двойниках устройств и их использовании в Центре Интернета вещей](../iot-hub/iot-hub-devguide-device-twins.md).


## <a name="clean-up-resources"></a>Очистка ресурсов

Если вы планируете продолжить работу с примером клиентского устройства, не удаляйте ресурсы, созданные в ходе работы с этим кратким руководством. Если вы не планируете продолжать работу, следуйте инструкциям ниже, чтобы удалить все созданные ресурсы.

1. Закройте окно выходных данных примера клиентского устройства на компьютере.
1. Закройте окно симулятора доверенного платформенного модуля на компьютере.
1. В меню слева на портале Azure щелкните **Все ресурсы** и откройте службу подготовки устройств. В верхней части колонки **Обзор** нажмите **Удалить** в верхней части области.  
1. В меню слева на портале Azure щелкните **Все ресурсы** и выберите свой центр Интернета вещей. В верхней части колонки **Обзор** нажмите **Удалить** в верхней части области.  

## <a name="next-steps"></a>Дальнейшие действия

Из этого краткого руководства вы узнали, как подготовить устройств X.509 в Центре Интернета вещей, используя Службу подготовки устройств к добавлению в Центр Интернета вещей. Чтобы узнать, как выполнить программную регистрацию устройства X.509, изучите соответствующее краткое руководство. 

> [!div class="nextstepaction"]
> [Краткое руководство. Регистрация устройств X.509 в Службе подготовки устройств с помощью C#](quick-enroll-device-x509-csharp.md)
