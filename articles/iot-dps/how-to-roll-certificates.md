---
title: Развертывание сертификатов X. 509 в службе подготовки устройств для центра Интернета вещей Azure
description: Как выполнить откат сертификатов X. 509 с помощью экземпляра службы подготовки устройств (DPS)
author: wesmc7777
ms.author: wesmc
ms.date: 08/06/2018
ms.topic: conceptual
ms.service: iot-dps
services: iot-dps
ms.openlocfilehash: bf8b1e04e11dee4e636826430838a467fe034e3f
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "94951134"
---
# <a name="how-to-roll-x509-device-certificates"></a>Развертывание сертификатов устройств X.509

В течение жизненного цикла вашего решения Центра Интернета вещей вам нужно будет развертывать сертификаты. В основном это необходимо делать по двум причинам: бреши в системе безопасности и истечение срока действия сертификата. 

Развертывание сертификатов — это лучшая методика защиты системы в случае нарушения безопасности. В рамках руководства [Microsoft Enterprise Cloud Red Teaming](https://download.microsoft.com/download/C/1/9/C1990DBA-502F-4C2A-848D-392B93D9B9C3/Microsoft_Enterprise_Cloud_Red_Teaming.pdf) корпорация Майкрософт объясняет необходимость внедрения реактивных процессов по обеспечению безопасности наряду с превентивными мерами. Развертывание сертификатов устройств относится к этим процессам безопасности. Частота, с которой вы развертываете сертификаты, будет зависеть от требований безопасности вашего решения. Клиенты с решениями, содержащими конфиденциальные данные, могут развертывать сертификаты ежедневно, а остальные — каждые два года.

Развертывание сертификатов устройств будет включать обновление сертификата, хранящегося на устройстве, и Центра Интернета вещей. Впоследствии устройство может повторно подготовиться к работе с центром Интернета вещей, используя нормальную [подготовку](about-iot-dps.md#provisioning-process) с помощью службы подготовки устройств (DPS).


## <a name="obtain-new-certificates"></a>Получение новых сертификатов

Существуют различные способы получения сертификатов для устройств Интернета вещей. К ним относятся получение сертификатов из фабрики устройств, создание собственных сертификатов и создание сертификатов третьей стороной. 

Сертификаты подписываются друг другом, чтобы сформировать цепочку доверия от корневого сертификата ЦС к [конечному сертификату](concepts-x509-attestation.md#end-entity-leaf-certificate). Сертификат для подписи — это сертификат, используемый для подписи конечного сертификата в конце цепочки доверия. Это может быть корневой сертификат ЦС или промежуточный сертификат в цепочке доверия. Дополнительные сведения см. в разделе [Сертификаты X.509](concepts-x509-attestation.md#x509-certificates).
 
Получить сертификат для подписи можно двумя способами. Первый способ рекомендуется для производственных систем. Он заключается в приобретении сертификата для подписи из корневого центра сертификации (ЦС). Таким образом обеспечивается цепочка безопасности с надежным источником. 

Второй способ — создать свои собственные сертификаты X.509 с помощью такого инструмента, как OpenSSL. Этот способ отлично подходит для тестирования сертификатов X.509, однако он предоставляет всего лишь несколько гарантий безопасности. Мы рекомендуем использовать этот подход только для тестирования, если вы не готовы действовать в качестве собственного поставщика ЦС.
 

## <a name="roll-the-certificate-on-the-device"></a>Развертывание сертификата на устройстве

Сертификаты на устройстве всегда должны храниться в безопасном месте, например в [аппаратном модуле безопасности (HSM)](concepts-service.md#hardware-security-module). Способ развертывания сертификатов устройств будет зависеть от того, как они были созданы и установлены на устройствах изначально. 

Если вы получили свои сертификаты от сторонних производителей, необходимо узнать, как они их развертывают. Этот процесс может быть включен в вашу договоренность с ними, или они могут предложить это как отдельную услугу. 

Если вы управляете своими сертификатами устройств, вам нужно будет создать собственный конвейер для обновления сертификатов. Старые и новые конечные сертификаты должны иметь одинаковое общее имя. В этом случае устройство сможет самостоятельно выполнить повторную подготовку, не создавая дубликат записи регистрации. 


## <a name="roll-the-certificate-in-the-iot-hub"></a>Развертывание сертификата в Центре Интернета вещей

Сертификат устройства можно добавить в Центр Интернета вещей вручную. Сертификат также можно автоматически подготовить с помощью экземпляра службы подготовки устройств. В этой статье мы предположим, что используется экземпляр службы подготовки устройств для поддержки автоматической подготовки.

Если изначально устройство подготовлено с помощью автоматической подготовки, оно загружается и связывается со службой подготовки. Служба подготовки отвечает путем выполнения проверки подлинности перед созданием идентификатора устройства в Центре Интернета вещей, используя конечный сертификат устройства в качестве учетных данных. Затем служба подготовки назначает для устройства Центр Интернета вещей, и устройство выполняет проверку подлинности и устанавливает подключение к Центру Интернета вещей с помощью своего конечного сертификата. 

Когда новый конечный сертификат будет развернут на устройстве, оно больше не сможет подключиться к Центру Интернета вещей, потому что для подключения используется новый сертификат. Центр Интернета вещей распознает устройство только со старым сертификатом. В результате попытки подключения устройства возникнет ошибка "Недостаточно прав". Чтобы устранить эту ошибку, обновите запись регистрации устройства для использования учетной записи нового конечного сертификата устройства. Затем после повторной подготовки устройства служба подготовки может при необходимости обновить информацию о реестре устройства Центра Интернета вещей. 

Единственным возможным исключением, что касается этого сбоя подключения, будет сценарий, в котором вы создали [группу регистрации](concepts-service.md#enrollment-group) для своего устройства в службе подготовки. В этом случае, если вы не развертываете корневой или промежуточные сертификаты в цепочке доверия сертификатов устройства, устройство будет распознаваться, если новый сертификат является частью цепочки доверия, определенной в группе регистрации. Если этот сценарий возникает в качестве реакции на нарушение безопасности, необходимо по крайней мере запретить определенные сертификаты устройств в группе, которые считаются нарушением. Дополнительные сведения см. [в разделе запрет конкретных устройств в группе регистрации](./how-to-revoke-device-access-portal.md#disallow-specific-devices-in-an-enrollment-group).

Обновление записей регистрации для развернутых сертификатов выполняется на странице **Управление регистрациями**. Для доступа к этой странице сделайте следующее:

1. Войдите на [портал Azure](https://portal.azure.com) и перейдите к экземпляру Службы подготовки устройств к добавлению в Центр Интернета вещей, в котором есть запись регистрации для вашего устройства.

2. Щелкните **Управление регистрациями**.

    ![Управление регистрациями](./media/how-to-roll-certificates/manage-enrollments-portal.png)


Процесс обновления записи регистрации будет зависеть от того, какие регистрации вы используете: индивидуальные или групповые. Рекомендуемые процедуры также различаются в зависимости от причины развертывания сертификатов: из-за бреши в системе безопасности или истечения срока действия сертификата. В разделах ниже описано, как выполнить эти обновления.


## <a name="individual-enrollments-and-security-breaches"></a>Индивидуальные регистрации и бреши в системе безопасности

Если вы развертываете сертификаты по причине бреши в системе безопасности, используйте следующий подход, в котором немедленно удаляется текущий сертификат:

1. Щелкните **Индивидуальные регистрации** и выберите запись идентификатора регистрации в списке. 

2. Нажмите кнопку **Delete current certificate** (Удалить текущий сертификат), а затем щелкните значок папки, чтобы выбрать новый сертификат, который будет загружен для записи регистрации. По завершении щелкните **Сохранить**.

    Эти шаги необходимо выполнить для первичного и вторичного сертификатов, если они скомпрометированы.

    ![Управление отдельными регистрациями с нарушением безопасности](./media/how-to-roll-certificates/manage-individual-enrollments-portal.png)

3. После удаления скомпрометированного сертификата из службы подготовки его можно использовать для подключения устройства к Центру Интернета вещей при условии наличия регистрации устройства. Это можно сделать двумя способами: 

    Первый способ — вручную перейти в Центр Интернета вещей и немедленно удалить регистрацию устройства, связанную со скомпрометированным сертификатом. После повторной подготовки устройства с использованием обновленного сертификата выполняется новая регистрация устройства.     

    ![Удаление регистрации устройства Центра Интернета вещей](./media/how-to-roll-certificates/remove-hub-device-registration.png)

    Второй способ — использовать поддержку повторной подготовки и еще раз подготовить устройство для того же Центра Интернета вещей. Этот подход можно использовать для замены сертификата, с помощью которого устройства регистрируются в Центре Интернета вещей. Дополнительные сведения см. в статье [Способы повторной подготовки устройств](how-to-reprovision.md).

## <a name="individual-enrollments-and-certificate-expiration"></a>Индивидуальные регистрации и истечение срока действия сертификата

Если вы развертываете сертификаты из-за истечения срока действия предыдущих, используйте конфигурацию вторичного сертификата следующим образом, чтобы сократить время простоя для устройств, пытающихся выполнить подготовку.

Позже, когда срок действия вторичного сертификата будет близок к истечению и нужно будет развернуть новый, вы можете переключиться на использование конфигурации первичного сертификата. Таким образом, переключение между первичным и вторичным сертификатами сокращает время простоя для устройств, пытающихся выполнить подготовку.


1. Щелкните **Индивидуальные регистрации** и выберите запись идентификатора регистрации в списке. 

2. Щелкните **Вторичный сертификат**, а затем щелкните значок папки, чтобы выбрать новый сертификат, который будет загружен для записи регистрации. Выберите команду **Сохранить**.

    ![Управление отдельными регистрациями с использованием дополнительного срока действия сертификата](./media/how-to-roll-certificates/manage-individual-enrollments-secondary-portal.png)

3. Позже, когда срок действия первичного сертификата истечет, вернитесь и удалите этот сертификат, нажав кнопку **Delete current certificate** (Удалить текущий сертификат).

## <a name="enrollment-groups-and-security-breaches"></a>Группы регистрации и бреши в системе безопасности

Чтобы обновить групповую регистрацию в ответ на брешь в системе безопасности, используйте один из следующих подходов, который немедленно удалит текущий корневой сертификат ЦС или промежуточный сертификат.

#### <a name="update-compromised-root-ca-certificates"></a>Обновление скомпрометированных корневых сертификатов CA

1. Щелкните вкладку **Сертификаты** для экземпляра службы подготовки устройств.

2. Выберите скомпрометированный сертификат в списке и нажмите кнопку **Удалить**. Подтвердите удаление, введя имя сертификата и нажмите кнопку **ОК**. Повторите этот процесс для всех скомпрометированных сертификатов.

    ![Удаление корневого сертификата ЦС](./media/how-to-roll-certificates/delete-root-cert.png)

3. Выполните шаги, описанные в статье [Как подтвердить владение сертификатами ЦС X.509 с помощью службы подготовки устройств](how-to-verify-certificates.md), чтобы добавить и проверить новые корневые сертификаты ЦС.

4. Щелкните вкладку **Управление регистрациями** для экземпляра службы подготовки устройств и щелкните список **Группы регистрации**. Щелкните название своей группы регистрации в списке.

5. Щелкните **Сертификат ЦС** и выберите новый корневой сертификат ЦС. Затем нажмите кнопку **Сохранить**. 

    ![Выберите новый сертификат корневого ЦС для скомпрометированного сертификата](./media/how-to-roll-certificates/select-new-root-cert.png)

6. После удаления скомпрометированного сертификата из службы подготовки его можно использовать для подключения устройства к Центру Интернета вещей при условии наличия регистраций устройств. Это можно сделать двумя способами: 

    Первый способ — вручную перейти в Центр Интернета вещей и немедленно удалить регистрацию устройства, связанную со скомпрометированным сертификатом. Затем, когда устройства снова будут подготовлены с использованием обновленных сертификатов, для каждого из этих устройств будет создана регистрация.     

    ![Удаление регистрации устройства Центра Интернета вещей](./media/how-to-roll-certificates/remove-hub-device-registration.png)

    Второй способ — использовать поддержку повторной подготовки и еще раз подготовить устройства для того же Центра Интернета вещей. Этот подход можно использовать для замены сертификатов, используемых при регистрации устройств в Центре Интернета вещей. Дополнительные сведения см. в статье [Способы повторной подготовки устройств](how-to-reprovision.md).



#### <a name="update-compromised-intermediate-certificates"></a>Обновление скомпрометированных промежуточных сертификатов

1. Щелкните **Группы регистрации**, а затем выберите имя группы в списке. 

2. Щелкните **Intermediate certificate** (Промежуточный сертификат) и **Delete current certificate** (Удалить текущий сертификат). Щелкните значок папки, чтобы перейти к новому промежуточному сертификату, который будет загружен для группы регистрации. По завершении щелкните **Сохранить**. Эти шаги необходимо выполнить для первичного и вторичного сертификатов, если они скомпрометированы.

    Этот новый промежуточный сертификат должен быть подписан проверенным корневым сертификатом ЦС, который уже был добавлен в службу подготовки. Дополнительные сведения см. в разделе [Сертификаты X.509](concepts-x509-attestation.md#x509-certificates).

    ![Управление отдельными регистрациями для скомпрометированного промежуточного уровня](./media/how-to-roll-certificates/enrollment-group-delete-intermediate-cert.png)


3. После удаления скомпрометированного сертификата из службы подготовки его можно использовать для подключения устройства к Центру Интернета вещей при условии наличия регистраций устройств. Это можно сделать двумя способами: 

    Первый способ — вручную перейти в Центр Интернета вещей и немедленно удалить регистрацию устройства, связанную со скомпрометированным сертификатом. Затем, когда устройства снова будут подготовлены с использованием обновленных сертификатов, для каждого из этих устройств будет создана регистрация.     

    ![Удаление регистрации устройства Центра Интернета вещей](./media/how-to-roll-certificates/remove-hub-device-registration.png)

    Второй способ — использовать поддержку повторной подготовки и еще раз подготовить устройства для того же Центра Интернета вещей. Этот подход можно использовать для замены сертификатов, используемых при регистрации устройств в Центре Интернета вещей. Дополнительные сведения см. в статье [Способы повторной подготовки устройств](how-to-reprovision.md).


## <a name="enrollment-groups-and-certificate-expiration"></a>Группы регистрации и истечение срока действия сертификата

Если вы развертываете сертификаты из-за истечения срока действия предыдущих, используйте конфигурацию вторичного сертификата следующим образом, чтобы гарантировать отсутствие простоя для устройств, пытающихся выполнить подготовку.

Позже, когда срок действия вторичного сертификата будет близок к истечению и нужно будет развернуть новый, вы можете переключиться на использование конфигурации первичного сертификата. Таким образом переключение между первичным и вторичным сертификатами гарантирует отсутствие простоя для устройств, пытающихся выполнить подготовку. 

#### <a name="update-expiring-root-ca-certificates"></a>Обновление корневых сертификатов ЦС с истекшим сроком действия

1. Выполните шаги, описанные в статье [Как подтвердить владение сертификатами ЦС X.509 с помощью службы подготовки устройств](how-to-verify-certificates.md), чтобы добавить и проверить новые корневые сертификаты ЦС.

2. Щелкните вкладку **Управление регистрациями** для экземпляра службы подготовки устройств и щелкните список **Группы регистрации**. Щелкните название своей группы регистрации в списке.

3. Щелкните **Сертификат ЦС** и выберите новый корневой сертификат ЦС в разделе конфигурации **вторичного сертификата**. Затем нажмите кнопку **Сохранить**. 

    ![Выберите новый сертификат корневого ЦС для истечения срока действия](./media/how-to-roll-certificates/select-new-root-secondary-cert.png)

4. Позже, когда срок действия первичного сертификата истечет, щелкните вкладку **Сертификаты** для экземпляра службы подготовки устройств. Выберите сертификат с истекшим сроком действия в списке и нажмите кнопку **Удалить**. Подтвердите удаление, введя имя сертификата и нажав кнопку **ОК**.

    ![Удаление корневого сертификата ЦС](./media/how-to-roll-certificates/delete-root-cert.png)



#### <a name="update-expiring-intermediate-certificates"></a>Обновление промежуточных сертификатов с истекшим сроком действия


1. Щелкните **Группы регистрации** и выберите имя группы в списке. 

2. Щелкните **Вторичный сертификат**, а затем щелкните значок папки, чтобы выбрать новый сертификат, который будет загружен для записи регистрации. Выберите команду **Сохранить**.

    Этот новый промежуточный сертификат должен быть подписан проверенным корневым сертификатом ЦС, который уже был добавлен в службу подготовки. Дополнительные сведения см. в разделе [Сертификаты X.509](concepts-x509-attestation.md#x509-certificates).

   ![Управление группами регистрации с истечением срока действия вторичного сертификата](./media/how-to-roll-certificates/manage-enrollment-group-secondary-portal.png)

3. Позже, когда срок действия первичного сертификата истечет, вернитесь и удалите этот сертификат, нажав кнопку **Delete current certificate** (Удалить текущий сертификат).


## <a name="reprovision-the-device"></a>Повторная подготовка устройства

Когда сертификат будет развернут как на устройстве, так и в службе подготовки устройств, устройство сможет выполнить повторную подготовку, связавшись со службой подготовки устройств. 

Первый простой способ настройки повторной подготовки — запрограммировать устройство для установки связи со службой подготовки, чтобы пройти через поток подготовки, если устройство получает ошибку "Недостаточно прав" при подключении к Центру Интернета вещей.

Другой способ допустим для старых и новых сертификатов. В нем Центр Интернета вещей используется для отправки устройствам команды на выполнение повторной регистрации в службе подготовки, чтобы обновить информацию о подключении к Центру Интернета вещей. Так как каждое устройство может обрабатывать команды по-разному, необходимо запрограммировать устройство, указав ему действия при вызове команды. Существует несколько способов отправки команды устройству через Центр Интернета вещей. Для запуска процесса мы рекомендуем использовать [прямые методы](../iot-hub/iot-hub-devguide-direct-methods.md) или [задания](../iot-hub/iot-hub-devguide-jobs.md).

После завершения повторной подготовки устройства смогут подключаться к Центру Интернета вещей с помощью новых сертификатов.


## <a name="disallow-certificates"></a>Запретить сертификаты

В ответ на нарушение безопасности может потребоваться запретить сертификат устройства. Чтобы запретить сертификат устройства, отключите запись регистрации для целевого устройства или сертификата. Дополнительные сведения см. в разделе запрещение устройств в статье [Управление отменой регистрации](how-to-revoke-device-access-portal.md) .

После того как сертификат будет включен как часть отключенной записи регистрации, любые попытки зарегистрироваться в Центре Интернета вещей с помощью сертификатов завершатся ошибкой, даже если он включен как часть другой записи регистрации.
 



## <a name="next-steps"></a>Дальнейшие действия

- Дополнительные сведения о сертификатах X. 509 в службе подготовки устройств см. в разделе [аттестация сертификатов x. 509](concepts-x509-attestation.md) . 
- Сведения о подтверждении владения сертификатами ЦС X.509 с помощью Службы подготовки устройств к добавлению в Центр Интернета вещей см. в [этой статье](how-to-verify-certificates.md).
- Дополнительные сведения о создании группы регистрации на портале см. в статье [Как управлять регистрацией устройств с помощью портала Azure](how-to-manage-enrollments.md).