---
title: Подготовка устройств с помощью симметричных ключей — служба подготовки устройств для центра Интернета вещей Azure
description: Использование симметричных ключей для подготовки устройств с помощью экземпляра службы подготовки устройств (DPS)
author: wesmc7777
ms.author: wesmc
ms.date: 01/28/2021
ms.topic: conceptual
ms.service: iot-dps
services: iot-dps
manager: lizross
ms.openlocfilehash: a4c16347d1883e1522fda18c2382f2d67b8ace80
ms.sourcegitcommit: d1e56036f3ecb79bfbdb2d6a84e6932ee6a0830e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/29/2021
ms.locfileid: "99051115"
---
# <a name="how-to-provision-devices-using-symmetric-key-enrollment-groups"></a>Как подготавливать устройства с помощью групп регистрации симметричных ключей

В этой статье показано, как безопасно подготавливать несколько симметричных ключей к одному центру Интернета вещей с помощью группы регистрации.

Некоторые устройства могут не иметь сертификата, доверенного платформенного модуля или любой другой функции безопасности, которую можно использовать для безопасного обнаружения устройства. Служба подготовки устройств включает [аттестацию симметричных ключей](concepts-symmetric-key-attestation.md). Аттестация симметричных ключей может использоваться для обнаружения устройства на основе уникальной информации, такой как MAC-адрес или серийный номер.

Если вы можете легко установить [аппаратный модуль безопасности (HSM)](concepts-service.md#hardware-security-module) и сертификат, то это может быть лучшим подходом к идентификации и подготовке устройств. Использование АППАРАТного модуля безопасности позволит обойти обновление кода, развернутого на всех устройствах, и секретный ключ не будет внедрен в образы устройств. В этой статье предполагается, что ни HSM, ни сертификат не являются приемлемым вариантом. Тем не менее предполагается, что существует некий метод обновления кода устройств для подготовки этих устройств с помощью службы подготовки. 

В этой статье также предполагается, что обновление устройства выполняется в защищенной среде, чтобы предотвратить несанкционированный доступ к главному ключу группы или производному ключу устройства.

В этой статье описывается использование рабочей станции под управлением Windows. Тем не менее эти процедуры можно выполнить и на Linux. Пример для Linux см. в статье [Подготовка к мультитенантности](how-to-provision-multitenant.md).

> [!NOTE]
> Пример, используемый в этой статье, написан на языке C. Также доступен [Пример симметричного ключа подготовки устройства C#](https://github.com/Azure-Samples/azure-iot-samples-csharp/tree/master/provisioning/Samples/device/SymmetricKeySample) . Чтобы использовать этот пример, скачайте или клонировать репозиторий [Azure-IOT-Samples-CSharp](https://github.com/Azure-Samples/azure-iot-samples-csharp) и следуйте инструкциям в примере кода. Чтобы создать группу регистрации симметричных ключей с помощью портала и найти область ИДЕНТИФИКАТОРов и первичный и вторичный ключи, необходимые для запуска примера, следуйте инструкциям, приведенным в этой статье. Можно также создать отдельные регистрации с помощью примера.

## <a name="overview"></a>Обзор

Уникальный идентификатор регистрации будет определен для каждого устройства на основе сведений, идентифицирующих это устройство. Например, MAC-адреса или серийного номера.

Служба подготовки устройств создаст группу регистраций, использующую [аттестацию симметричного ключа](concepts-symmetric-key-attestation.md). Группа регистраций будет содержать главный ключ группы. Этот главный ключ будет использоваться для хэширования каждого уникального идентификатора регистрации, чтобы получить уникальный ключ для каждого устройства. Устройство будет использовать этот производный ключ устройства вместе с уникальным идентификатором регистрации для аттестации с помощью службы подготовки устройств и будет назначено Центру Интернета вещей.

Код устройства, приведенный в этой статье, следует тому же шаблону, который используется в [кратком руководстве по подготовке имитированного устройства с использованием симметричных ключей](quick-create-simulated-device-symm-key.md). Код будет имитировать устройство с использованием примера из [пакета SDK Azure IoT для C](https://github.com/Azure/azure-iot-sdk-c). Имитированное устройство пройдет аттестацию с группой регистраций вместо отдельной регистрации, как показано в кратком руководстве.

[!INCLUDE [quickstarts-free-trial-note](../../includes/quickstarts-free-trial-note.md)]


## <a name="prerequisites"></a>Предварительные требования

* Выполните процедуру, описанную в кратком руководстве по [настройке Службы подготовки устройств к добавлению в Центр Интернета вещей на портале Azure](./quick-setup-auto-provision.md).

Приведенные ниже предварительные требования касаются среды разработки Windows. При использовании Linux или macOS ознакомьтесь с соответствующим разделом в статье [Подготовка среды разработки](https://github.com/Azure/azure-iot-sdk-c/blob/master/doc/devbox_setup.md) из документации к пакету SDK.

* [Visual Studio 2019](https://visualstudio.microsoft.com/vs/) с включенной рабочей нагрузкой [Разработка классических приложений на C++](/cpp/ide/using-the-visual-studio-ide-for-cpp-desktop-development). Visual Studio 2015 или Visual Studio 2017 также поддерживаются.

* Установите последнюю версию [Git](https://git-scm.com/download/).

## <a name="prepare-an-azure-iot-c-sdk-development-environment"></a>Подготовка среды разработки для пакета SDK Azure IoT для C

В этом разделе вы подготовите среду разработки, которая используется для сборки [пакета SDK Azure IoT для C](https://github.com/Azure/azure-iot-sdk-c). 

В пакет SDK входит пример кода для имитированного устройства. Для этого имитированного устройства будет выполнена попытка подготовки во время последовательности загрузки.

1. Скачайте [систему сборки CMake](https://cmake.org/download/).

    **Перед** установкой `CMake` очень важно установить на компьютер необходимые компоненты Visual Studio (Visual Studio с рабочей нагрузкой "Разработка классических приложений на C++"). После установки компонентов и проверки загрузки установите систему сборки CMake.

2. Найдите имя тега для [последнего выпуска](https://github.com/Azure/azure-iot-sdk-c/releases/latest) пакета SDK.

3. Откройте командную строку или оболочку Git Bash. Выполните приведенные ниже команды, чтобы клонировать репозиторий GitHub с последним выпуском [пакета SDK Azure IoT для C](https://github.com/Azure/azure-iot-sdk-c). Используйте найденный тег в качестве значения для параметра `-b`:

    ```cmd/sh
    git clone -b <release-tag> https://github.com/Azure/azure-iot-sdk-c.git
    cd azure-iot-sdk-c
    git submodule update --init
    ```

    Выполнение этой операции может занять несколько минут.

4. Создайте `cmake` подкаталог в корневом каталоге репозитория Git и перейдите к этой папке. В каталоге `azure-iot-sdk-c` выполните следующие команды:

    ```cmd/sh
    mkdir cmake
    cd cmake
    ```

5. Выполните приведенную ниже команду, чтобы создать версию пакета SDK для используемой клиентской платформы разработки. Эта команда также создает решение Visual Studio для имитированного устройства в каталоге `cmake`. 

    ```cmd
    cmake -Dhsm_type_symm_key:BOOL=ON -Duse_prov_client:BOOL=ON  ..
    ```
    
    Если `cmake` не удастся найти компилятор C++, могут возникнуть ошибки сборки во время выполнения предыдущей команды. В этом случае попробуйте, выполнить эту команду в [командной строке Visual Studio](/dotnet/framework/tools/developer-command-prompt-for-vs). 

    После успешного создания последние несколько строк выходных данных будут выглядеть следующим образом:

    ```cmd/sh
    $ cmake -Dhsm_type_symm_key:BOOL=ON -Duse_prov_client:BOOL=ON  ..
    -- Building for: Visual Studio 15 2017
    -- Selecting Windows SDK version 10.0.16299.0 to target Windows 10.0.17134.
    -- The C compiler identification is MSVC 19.12.25835.0
    -- The CXX compiler identification is MSVC 19.12.25835.0

    ...

    -- Configuring done
    -- Generating done
    -- Build files have been written to: E:/IoT Testing/azure-iot-sdk-c/cmake
    ```


## <a name="create-a-symmetric-key-enrollment-group"></a>Создание группы регистраций симметричного ключа

1. Войдите на [портал Azure](https://portal.azure.com) и перейдите к своему экземпляру службы подготовки устройств.

2. Выберите вкладку **Управление регистрациями**, а затем нажмите кнопку **Добавить группу регистрации** в верхней части страницы. 

3. В разделе **Добавление группы регистрации** введите приведенные ниже сведения, а затем нажмите кнопку **Сохранить**.

   - **Имя группы**: введите **mylegacydevices**.

   - **Тип аттестации**: выберите **Симметричный ключ**.

   - **Автоматически создавать ключи**: установите флажок.

   - **Выберите способ назначения устройств для Центров**: выберите **статическую конфигурацию**, чтобы вы могли назначить устройство определенному центру.

   - **Select the IoT hubs this group can be assigned to** (Выберите Центры Интернета вещей, которым может быть назначена эта группа): выберите один из центров.

     ![Добавление группы регистраций для аттестации симметричного ключа](./media/how-to-legacy-device-symm-key/symm-key-enrollment-group.png)

4. После сохранения регистрации **первичный** и **вторичный ключи** будут созданы и добавлены в запись регистрации. Ваша группа регистраций симметричного ключа отображается как **mylegacydevices** в столбце *Имя группы* на вкладке *Группы регистрации*. 

    Откройте регистрацию и скопируйте значение сформированного **первичного ключа**. Этот ключ является главным ключом группы.


## <a name="choose-a-unique-registration-id-for-the-device"></a>Выбор уникального идентификатора регистрации для устройства

Уникальный идентификатор регистрации должен быть определен для идентификации каждого устройства. Можно использовать MAC-адрес, серийный номер или любые уникальные сведения устройства. 

В этом примере мы используем сочетание MAC-адреса и серийного номера, формирующие следующую строку для идентификатора регистрации.

```
sn-007-888-abc-mac-a1-b2-c3-d4-e5-f6
```

Создайте уникальные идентификаторы регистрации для каждого устройства. Допустимые знаки — буквы в нижнем регистре, цифры и дефис ("-").


## <a name="derive-a-device-key"></a>Получение ключа устройства 

Чтобы создать ключи устройств, используйте главный ключ группы регистрации для вычисления [HMAC-SHA256](https://wikipedia.org/wiki/HMAC) идентификатора регистрации для каждого устройства. Затем результат преобразуется в формат Base64 для каждого устройства.

> [!WARNING]
> Код устройства для каждого устройства должен содержать только соответствующий производный ключ устройства для этого устройства. Не добавляйте главный ключ группы в код устройства. Скомпрометированный главный ключ может нарушить безопасность всех устройств, прошедших проверку подлинности.


# <a name="windows"></a>[Windows](#tab/windows)

Если вы используете рабочую станцию для Windows, можно использовать PowerShell для формирования производного ключа устройства, как показано в следующем примере.

Замените значение **KEY** значением **первичного ключа**, записанным ранее.

Замените значение **REG_ID** идентификатором регистрации.

```powershell
$KEY='8isrFI1sGsIlvvFSSFRiMfCNzv21fjbE/+ah/lSh3lF8e2YG1Te7w1KpZhJFFXJrqYKi9yegxkqIChbqOS9Egw=='
$REG_ID='sn-007-888-abc-mac-a1-b2-c3-d4-e5-f6'

$hmacsha256 = New-Object System.Security.Cryptography.HMACSHA256
$hmacsha256.key = [Convert]::FromBase64String($KEY)
$sig = $hmacsha256.ComputeHash([Text.Encoding]::ASCII.GetBytes($REG_ID))
$derivedkey = [Convert]::ToBase64String($sig)
echo "`n$derivedkey`n"
```

```powershell
Jsm0lyGpjaVYVP2g3FnmnmG9dI/9qU24wNoykUmermc=
```

# <a name="linux"></a>[Linux](#tab/linux)

Если вы используете рабочую станцию Linux, можно использовать OpenSSL для формирования производного ключа устройства, как показано в следующем примере.

Замените значение **KEY** значением **первичного ключа**, записанным ранее.

Замените значение **REG_ID** идентификатором регистрации.

```bash
KEY=8isrFI1sGsIlvvFSSFRiMfCNzv21fjbE/+ah/lSh3lF8e2YG1Te7w1KpZhJFFXJrqYKi9yegxkqIChbqOS9Egw==
REG_ID=sn-007-888-abc-mac-a1-b2-c3-d4-e5-f6

keybytes=$(echo $KEY | base64 --decode | xxd -p -u -c 1000)
echo -n $REG_ID | openssl sha256 -mac HMAC -macopt hexkey:$keybytes -binary | base64
```

```bash
Jsm0lyGpjaVYVP2g3FnmnmG9dI/9qU24wNoykUmermc=
```

---

Каждое устройство использует свой производный ключ устройства и уникальный идентификатор регистрации для выполнения аттестации симметричного ключа с группой регистрации во время подготовки.



## <a name="create-a-device-image-to-provision"></a>Создание образа устройства для подготовки к работе

В этом разделе вы обновите пример для подготовки **prov\_dev\_client\_sample**, который размещен в пакете SDK Azure IoT для C, настроенном ранее. 

Пример кода имитирует последовательность загрузки устройства, которое отправляет запрос на подготовку в экземпляр службы подготовки устройств. При выполнении последовательности загрузки устройство будет распознано и назначено настроенному Центру Интернета вещей в группе регистраций. Это будет выполнено для каждого устройства, которое будет подготовлено с помощью группы регистрации.

1. На портале Azure выберите вкладку **Обзор** службы подготовки устройств и запишите значение **_области идентификатора_**.

    ![Извлеките сведения о конечной точке службы подготовки устройств из колонки на портале](./media/quick-create-simulated-device-x509/extract-dps-endpoints.png) 

2. В Visual Studio откройте файл решения **azure_iot_sdks.sln**, который был создан ранее в результате запуска CMake. Файл решения должен находиться в следующем расположении:

    ```
    \azure-iot-sdk-c\cmake\azure_iot_sdks.sln
    ```

3. В окне *Обозреватель решений* Visual Studio перейдите в папку **Provision\_Samples**. Разверните пример проекта с именем **prov\_dev\_client\_sample**. Разверните **исходные файлы** и откройте **prov\_dev\_client\_sample.c**.

4. Найдите константу `id_scope` и замените ее значение ранее скопированным значением **области идентификатора**. 

    ```c
    static const char* id_scope = "0ne00002193";
    ```

5. Найдите определение функции `main()` в том же файле. Проверьте, чтобы переменной `hsm_type` было задано значение `SECURE_DEVICE_TYPE_SYMMETRIC_KEY`, как показано ниже.

    ```c
    SECURE_DEVICE_TYPE hsm_type;
    //hsm_type = SECURE_DEVICE_TYPE_TPM;
    //hsm_type = SECURE_DEVICE_TYPE_X509;
    hsm_type = SECURE_DEVICE_TYPE_SYMMETRIC_KEY;
    ```

6. Найдите закомментированный вызов `prov_dev_set_symmetric_key_info()` в **prov\_dev\_client\_sample.c**.

    ```c
    // Set the symmetric key if using they auth type
    //prov_dev_set_symmetric_key_info("<symm_registration_id>", "<symmetric_Key>");
    ```

    Раскомментируйте вызов функции и замените значения заполнителей (включая угловые скобки) уникальным идентификатором регистрации для своего устройства и производным ключом устройства, который вы создали.

    ```c
    // Set the symmetric key if using they auth type
    prov_dev_set_symmetric_key_info("sn-007-888-abc-mac-a1-b2-c3-d4-e5-f6", "Jsm0lyGpjaVYVP2g3FnmnmG9dI/9qU24wNoykUmermc=");
    ```
   
    Сохраните файл.

7. Щелкните проект **prov\_dev\_client\_sample** правой кнопкой мыши и выберите пункт **Назначить запускаемым проектом**. 

8. В меню Visual Studio выберите **Отладка** > **Запуск без отладки**, чтобы запустить решение. При появлении запроса перестроить проект щелкните **Да**, чтобы перестроить его перед запуском.

    Следующий результат является примером успешной загрузки имитированного устройства и его подключения к экземпляру службы подготовки для назначения Центру Интернета вещей.

    ```cmd
    Provisioning API Version: 1.2.8

    Registering Device

    Provisioning Status: PROV_DEVICE_REG_STATUS_CONNECTED
    Provisioning Status: PROV_DEVICE_REG_STATUS_ASSIGNING
    Provisioning Status: PROV_DEVICE_REG_STATUS_ASSIGNING

    Registration Information received from service: 
    test-docs-hub.azure-devices.net, deviceId: sn-007-888-abc-mac-a1-b2-c3-d4-e5-f6

    Press enter key to exit:
    ```

9. На портале перейдите к центру Интернета вещей, которому назначено имитируемое устройство, и перейдите на вкладку **устройства IOT** . При успешной подготовке имитации в концентраторе его идентификатор устройства отображается в колонке **устройства IOT** с *состоянием* **включено**. Возможно, вам потребуется нажать кнопку **Обновить** в верхней области. 

    ![Устройство зарегистрировано в Центре Интернета вещей](./media/how-to-legacy-device-symm-key/hub-registration.png) 



## <a name="security-concerns"></a>Соображения безопасности

Имейте в виду, что это приведет к порождению ключа производного устройства, включенного в образ для каждого устройства, что не рекомендуется по соображениям безопасности. Это одна из причин того, почему безопасность и простота использования часто являются компромиссами. Необходимо полностью проверить безопасность ваших устройств в соответствии с собственными требованиями.


## <a name="next-steps"></a>Дальнейшие действия

* Дополнительные сведения о повторной подготовке см. в статье [Основные понятия повторной инициализации устройств центра Интернета вещей](concepts-device-reprovision.md) . 
* [Краткое руководство по подготовке имитированного устройства с использованием симметричных ключей](quick-create-simulated-device-symm-key.md)
* Дополнительные сведения об отмене подготовки см. в статье [как отменить подготовку устройств, которые были подготовлены ранее](how-to-unprovision-devices.md) .
