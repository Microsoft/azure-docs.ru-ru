---
title: Учебник. Подготовка устройства с помощью Службы подготовки устройств к добавлению в Центр Интернета вещей Azure
description: В этом учебнике показано, как подготовить устройство в одном центре Интернета вещей с помощью Службы подготовки устройств к добавлению в Центр Интернета вещей (DPS).
author: wesmc7777
ms.author: wesmc
ms.date: 11/12/2019
ms.topic: tutorial
ms.service: iot-dps
services: iot-dps
ms.custom: mvc
ms.openlocfilehash: 876fd8260b64fba4d3d34a766b4259323c660b76
ms.sourcegitcommit: f28ebb95ae9aaaff3f87d8388a09b41e0b3445b5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/29/2021
ms.locfileid: "94968083"
---
# <a name="tutorial-provision-the-device-to-an-iot-hub-using-the-azure-iot-hub-device-provisioning-service"></a>Руководство по Подготовка устройства в Центре Интернета вещей с помощью службы подготовки устройств для Центра Интернета вещей Azure

В предыдущем руководстве вы узнали, как настраивать устройство для подключения к службе подготовки устройств. В этом руководстве объясняется, как использовать эту службу для подготовки устройства в одном Центре Интернета вещей с помощью функции автоматической подготовки и **_списков регистрации_** . В этом учебнике описаны следующие процедуры.

> [!div class="checklist"]
> * Регистрация устройства
> * запуск устройства;
> * проверка регистрации устройства.

## <a name="prerequisites"></a>Предварительные требования

Прежде чем продолжить, настройте устройство, как описано в руководстве [Настройка устройства для подготовки с помощью службы подготовки устройств для Центра Интернета вещей](./tutorial-set-up-device.md).

При необходимости ознакомьтесь с обзором [процесса подготовки](about-iot-dps.md#provisioning-process), прежде чем продолжить.

<a id="enrolldevice"></a>
## <a name="enroll-the-device"></a>Регистрация устройства

Этот шаг подразумевает добавление уникальных артефактов безопасности устройства в службу подготовки устройств. Эти артефакты безопасности основаны на [механизме аттестации](concepts-service.md#attestation-mechanism) устройства, который описан ниже.

- Для устройств на основе доверенного платформенного модуля (TPM) требуется следующее:
    - Уникальный для каждой микросхемы или моделирования доверенного платформенного модуля *ключ подтверждения*, полученный у производителя микросхемы доверенного платформенного модуля.  Дополнительные сведения см. в статье [Общие сведения о ключе подтверждения доверенного платформенного модуля](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc770443(v=ws.11)).
    - *Registration ID* (ИД регистрации), который позволяет уникально идентифицировать устройство в пространстве имен и (или) области. Этот идентификатор может как совпадать, так и не совпадать с идентификатором устройства. Идентификатор — обязателен для каждого устройства. Для устройств на основе доверенного платформенного модуля идентификатор регистрации может быть производным от самого TPM, например хэш SHA-256 ключа подтверждения доверенного платформенного модуля.

      [![Сведения о регистрации для доверенного платформенного модуля на портале](./media/tutorial-provision-device-to-hub/tpm-device-enrollment.png)](./media/tutorial-provision-device-to-hub/tpm-device-enrollment.png#lightbox)  

- Для устройств на основе X.509 требуется следующее:
    - [Сертификат выдается микросхеме или имитации X.509](/windows/win32/seccertenroll/about-x-509-public-key-certificates) в файле формата *PERM* или *CER*. Для отдельной регистрации необходимо использовать *сертификат подписчика*, выдаваемый на устройство, для системы X.509, а для групп регистраций — *корневой сертификат*. 

      [![Добавление индивидуальной регистрации для аттестации X.509 на портале](./media/tutorial-provision-device-to-hub/individual-enrollment.png)](./media/tutorial-provision-device-to-hub/individual-enrollment.png#lightbox)

Имеется два способа регистрации устройства в службе подготовки устройств:

- **Enrollment Groups** (Группы регистраций). Представляет группу устройств, использующих определенный механизм аттестации. Мы советуем использовать группу регистраций для большого количества устройств, имеющих необходимую начальную конфигурацию, или для устройств, предназначенных для одного и того же клиента. Дополнительные сведения об аттестации удостоверения для регистрации групп см. в разделе [Управление доступом устройств к службе подготовки с использованием сертификатов X.509](concepts-x509-attestation.md#controlling-device-access-to-the-provisioning-service-with-x509-certificates).

    [![Добавление групповой регистрации для аттестации X.509 на портале](./media/tutorial-provision-device-to-hub/group-enrollment.png)](./media/tutorial-provision-device-to-hub/group-enrollment.png#lightbox)

- **Individual Enrollments** (Отдельные регистрации). Представляет собой запись для одного устройства, которое можно зарегистрировать с помощью службы подготовки устройств. Отдельные регистрации могут использовать сертификаты X.509 или маркеры SAS (в реальном или виртуальном доверенном платформенном модуле) в качестве механизма аттестации. Мы советуем использовать отдельные регистрации для устройств, которым требуются уникальные начальные конфигурации, и для устройств, которые могут использовать только маркеры SAS через TPM или виртуальный TPM в качестве механизма аттестации. Для отдельных регистраций можно указать нужный идентификатор устройства Центра Интернета вещей.

Теперь устройство зарегистрировано в экземпляре службы подготовки устройств с использованием необходимых артефактов безопасности на основе механизма аттестации устройства: 

1. Войдите на портал Azure, нажмите кнопку **Все ресурсы** в меню слева и откройте службу подготовки устройств.

2. В колонке сводки службы подготовки устройств выберите **Управление регистрациями**. Выберите вкладку **Individual Enrollments** (Отдельные регистрации) или **Enrollment Groups** (Группы регистраций) согласно настройке устройства. Нажмите кнопку **Добавить** вверху. Выберите **TPM** или **X.509** в качестве *механизма* аттестации удостоверения и введите соответствующий артефакт безопасности, как описано выше. Теперь можно ввести новый идентификатор устройства **IoT Hub device ID** (ИД устройства Центра Интернета вещей). Затем нажмите кнопку **Сохранить**. 

3. При успешной регистрации устройства вы увидите на портале следующее:

    ![Успешная регистрация доверенного платформенного модуля (TPM) на портале](./media/tutorial-provision-device-to-hub/tpm-enrollment-success.png)

После регистрации служба подготовки ожидает загрузки этого устройства и подключается к нему в любой момент времени в будущем. При первой загрузке устройства клиентская библиотека SDK взаимодействует с микросхемой, извлекая артефакты безопасности с устройства, и проверяет регистрацию в службе подготовки устройств. 

## <a name="start-the-iot-device"></a>Запуск устройства Интернета вещей

Устройство Интернета вещей может быть реальным или имитированным. Так как устройство Интернета вещей теперь регистрируется с экземпляром Службы подготовки устройств, оно может загружаться и вызывать службу подготовки, которая будет распознаваться с помощью механизма аттестации. Как только служба подготовки распознает устройство, оно будет присвоено Центру Интернета вещей. 

В примерах имитированного устройства используются аттестации доверенного платформенного модуля (TPM) и X.509, включенные для C, Java, C#, Node.js и Python. Например, имитированное устройство, использующее доверенный платформенный модуль (TPM) и [пакет SDK для Azure IoT C](https://github.com/Azure/azure-iot-sdk-c), выполнит процесс, описанный в разделе [Имитация последовательности первой загрузки для устройства](quick-create-simulated-device.md#simulate-first-boot-sequence-for-the-device). То же устройство, использующее аттестацию сертификата X.509, будет соответствовать процессу в разделе [Имитация последовательности первой загрузки для устройства](quick-create-simulated-device-x509.md#simulate-first-boot-sequence-for-the-device).

Ознакомьтесь с примером реального устройства в статье [Использование автоподготовки в службе подготовки устройств к добавлению в Центр Интернета вещей Azure для регистрации MXChip IoT DevKit в Центре Интернета вещей](how-to-connect-mxchip-iot-devkit.md).

Запустите устройство, чтобы разрешить клиентскому приложению устройства начать регистрацию в службе подготовки устройств.  

## <a name="verify-the-device-is-registered"></a>проверка регистрации устройства.

После загрузки устройства необходимо выполнить следующие действия.

1. Устройство отправляет запрос на регистрацию в службу подготовки устройств.
2. Устройствам с доверенным платформенным модулем служба подготовки устройств отправляет обратный запрос регистрации, на который отвечает устройство. 
3. При успешной регистрации служба подготовки устройств отправляет обратно к устройству универсальный код ресурса Центра Интернета вещей, идентификатор устройства и зашифрованный ключ. 
4. Затем клиентское приложение Центра Интернета вещей на устройстве подключается к центру. 
5. При успешном подключении к центру устройство отобразится в обозревателе **Устройства Центра Интернета вещей** Центра IoT. 

    ![Успешное подключение к центру на портале](./media/tutorial-provision-device-to-hub/hub-connect-success.png)

Дополнительные сведения см. в примере клиента подготовки устройства [prov_dev_client_sample.c](https://github.com/Azure/azure-iot-sdk-c/blob/master/provisioning_client/samples/prov_dev_client_sample/prov_dev_client_sample.c). В примере демонстрируется подготовка имитированного устройства с помощью TPM, сертификатов X.509 и симметричных ключей. Пошаговые инструкции по использованию примера см. в руководствах по аттестации [TPM](./quick-create-simulated-device.md), [X.509](./quick-create-simulated-device-x509.md), и [симметричного ключа](./quick-create-simulated-device-symm-key.md).

## <a name="next-steps"></a>Дальнейшие действия
В этом руководстве вы узнали, как выполнять следующие задачи:

> [!div class="checklist"]
> * Регистрация устройства
> * запуск устройства;
> * проверка регистрации устройства.

Перейдите к следующему руководству, чтобы узнать, как подготовить несколько устройств через концентраторы с балансировкой нагрузки. 

> [!div class="nextstepaction"]
> [Подготовка устройств в Центрах Интернета вещей с балансировкой нагрузки](./tutorial-provision-multiple-hubs.md)