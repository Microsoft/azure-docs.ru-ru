---
title: Служба подготовки устройств для центра Интернета вещей Azure — основные понятия устройства
description: Описание принципов повторной подготовки устройств для службы подготовки устройств к добавлению в центр Интернета вещей Azure (DPS)
author: wesmc7777
ms.author: wesmc
ms.date: 04/04/2019
ms.topic: conceptual
ms.service: iot-dps
services: iot-dps
ms.openlocfilehash: 9653a584382584d982c55008a6e8547de28691b7
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "91842858"
---
# <a name="iot-hub-device-reprovisioning-concepts"></a>Основные понятия повторной подготовки устройств к добавлению в центр Интернета вещей

Во время жизненного цикла решения Интернета вещей часто приходится перемещать устройства между центрами Интернета вещей. Причинами этого перемещения могут быть следующие сценарии.

* **Географическое расположение и географическая задержка**: при перемещении устройства между расположениями сетевая задержка снижается за счет переноса устройства в ближайший центр Интернета вещей.

* **Мультитенантность**: устройство можно использовать в одном решении Интернета вещей и переназначить новому клиенту или расположению клиента. Обслуживание этого нового клиента может выполняться с помощью другого Центра Интернета вещей.

* **Смена решения**: устройство может быть перемещено в новое или обновленное решение Интернета вещей. Для этого переопределения устройству может потребоваться взаимодействовать с новым центром Интернета вещей, подключенным к другим компонентам серверной части.

* **Карантин**: аналогичен смене решения. Неисправное, скомпрометированное или устаревшее устройство может быть переназначено центру Интернета вещей,который может только пройти обновление и вернуться в состояние соответствия требованиям. Когда устройство будет работать надлежащим образом, оно переносится в свой основной центр.

Все эти вопросы решает поддержка повторной подготовки в службе подготовки устройств. Устройства можно автоматически переназначить новому центру Интернета вещей на основе политики повторной подготовки, которая настроена в записи регистрации устройства.

## <a name="device-state-data"></a>Данные о состоянии устройства

Данные о состоянии устройства состоят из [двойникаов устройств](../iot-hub/iot-hub-devguide-device-twins.md) и возможностей устройства. Эти данные хранятся в экземпляре службы подготовки устройств и в центре Интернета вещей, которому назначено устройство.

![Схема, показывающая, как подготовка работает со службой подготовки устройств.](./media/concepts-device-reprovisioning/dps-provisioning.png)

При начальной подготовке устройства с помощью экземпляра службы подготовки устройств выполняются следующие действия:

1. Устройство отправляет запрос на подготовку в экземпляр службы подготовки устройств. Экземпляр службы проверяет подлинность удостоверения устройства на основе записи регистрации и создает начальную конфигурации данных о состоянии устройства. Экземпляр службы назначает устройство центру Интернета вещей на основе конфигурации регистрации и возвращает это назначение центра Интернета вещей устройству.

2. Экземпляр службы подготовки предоставляет копию данных о начальном состоянии устройства в назначенный центр Интернета вещей. Устройство подключается к назначенному центру Интернета вещей и начинает работать.

Со временем данные о состоянии устройства в центре Интернета могут обновляться с помощью [операций на устройстве](../iot-hub/iot-hub-devguide-device-twins.md#device-operations) и [операций в серверной части](../iot-hub/iot-hub-devguide-device-twins.md#back-end-operations). Сведения о начальном состоянии устройства, хранящиеся в экземпляре службы подготовки устройств, не затрагиваются. Эти данные представляют начальную конфигурацию.

![Подготовка с помощью службы подготовки устройств](./media/concepts-device-reprovisioning/dps-provisioning-2.png)

В зависимости от сценария при перемещении устройства между центрами Интернета вещей может также потребоваться перенести состояние устройства, обновленное в предыдущем центре Интернета вещей, в новый центр Интернета вещей. Эта миграция поддерживается политиками повторной подготовки в службе подготовки устройств.

## <a name="reprovisioning-policies"></a>Политики повторной подготовки

В зависимости от сценария устройство обычно отправляет запрос экземпляру службы подготовки при перезагрузке. Она также поддерживает метод запуска подготовки вручную по требованию. Политика повторной подготовки в записи регистрации определяет способ обработки этих запросов экземпляром службы подготовки устройств. Политика также определяет, следует ли переносить данные о состоянии устройства во время повторной подготовки. К отдельным регистрациям и группам регистраций применяются одни и те же политики.

* **Повторная подготовка и перенос данных**. Эта политика используется по умолчанию для новых записей регистрации. Эта политика начинает действовать, когда устройства, связанные с записью регистрации, отправляют новый запрос (1). В зависимости от конфигурации записи регистрации устройство может быть переназначено другому Центру Интернета вещей. При смене Центров Интернета вещей происходит удаление регистрации устройства в начальном Центре Интернета вещей. Обновленные сведения о состоянии устройства из этого начального центра Интернета вещей будут перенесены в новый центр Интернета вещей (2). Во время миграции состояние устройства будет отображаться как **назначение**.

    ![Схема, показывающая, что политика принимает действие, когда устройства, связанные с записью регистрации, отправляют новый запрос.](./media/concepts-device-reprovisioning/dps-reprovisioning-migrate.png)

* **Повторная подготовка и сброс до начальной конфигурации**. Эта политика начинает действовать, когда устройства, связанные с записью регистрации, отправляют новый запрос на подготовку (1). В зависимости от конфигурации записи регистрации устройство может быть переназначено другому Центру Интернета вещей. При смене Центров Интернета вещей происходит удаление регистрации устройства в начальном Центре Интернета вещей. Данные начальной конфигурации, полученные экземпляром службы подготовки во время подготовки устройства, предоставляются в новый центр Интернета вещей (2). Во время миграции состояние устройства будет отображаться как **назначение**.

    Эта политика часто используется для сброса параметров до заводских настроек без смены центров Интернета вещей.

    ![Схема, на которой показано, как политика принимает действия, когда устройства, связанные с записью регистрации, отправляют новый запрос на подготовку.](./media/concepts-device-reprovisioning/dps-reprovisioning-reset.png)

* **Никогда не выполнять повторную подготовку**. Устройство никогда не переназначается другому центру. Эта политика предоставляется для управления обратной совместимостью.

### <a name="managing-backwards-compatibility"></a>Управление обратной совместимостью

До сентября 2018 г. назначения устройств центрам Интернета вещей были фиксированными. Когда устройство проходило процедуру повторной подготовки, оно могло быть назначено только тому же центру Интернета вещей.

Решениям, которые стали зависимыми от этого поведения, служба подготовки предлагает обратную совместимость. Сейчас такое поведение сохраняется для устройств в соответствии со следующими критериями.

1. Устройства подключаются с помощью версии API до появления собственной поддержки повторной подготовки в службе подготовки устройств. См. в таблицу API ниже.

2. В записи регистрации для устройств не задана политика их повторной подготовки.

Такая совместимость гарантирует, что к ранее развернутым устройствам применяется то же поведение, которое было во время начального тестирования. Чтобы сохранить прежнее поведение, не сохраняйте политику повторной подготовки в эти регистрации. Если политика повторной подготовки задана, она имеет приоритет над поведением. За счет приоритизации политики повторной подготовки клиенты могут обновлять поведение устройства без повторного создания образа устройства.

На следующей блок-схеме приводятся данные, определяющие поведение:

![блок-схема обратной совместимости](./media/concepts-device-reprovisioning/reprovisioning-compatibility-flow.png)

В следующей таблице приводятся версии API до появления собственной поддержки повторной подготовки в службе подготовки устройств:

| REST API | Пакет C SDK | Пакет SDK для Python |  Пакет SDK для Node | Пакет SDK для Java | Пакет SDK для .NET |
| -------- | ----- | ---------- | --------- | -------- | -------- |
| [2018-04-01 и более ранние версии](/rest/api/iot-dps/createorupdateindividualenrollment/createorupdateindividualenrollment#uri-parameters) | [1.2.8 и более ранние версии](https://github.com/Azure/azure-iot-sdk-c/blob/master/version.txt) | [1.4.2 и более ранние версии](https://github.com/Azure/azure-iot-sdk-python/blob/0a549f21f7f4fc24bc036c1d2d5614e9544a9667/device/iothub_client_python/src/iothub_client_python.cpp#L53) | [1.7.3 или более ранние версии](https://github.com/Azure/azure-iot-sdk-node/blob/074c1ac135aebb520d401b942acfad2d58fdc07f/common/core/package.json#L3) | [1.13.0 или более ранние версии](https://github.com/Azure/azure-iot-sdk-java/blob/794c128000358b8ed1c4cecfbf21734dd6824de9/device/iot-device-client/pom.xml#L7) | [1.1.0 или более ранние версии](https://github.com/Azure/azure-iot-sdk-csharp/blob/9f7269f4f61cff3536708cf3dc412a7316ed6236/provisioning/device/src/Microsoft.Azure.Devices.Provisioning.Client.csproj#L20)

> [!NOTE]
> Эти значения и ссылки могут меняться. Это лишь попытка выяснить, когда версии могут быть определены клиентом и какими будут ожидаемые версии.

## <a name="next-steps"></a>Дальнейшие действия

* [Повторная инициализация устройств](how-to-reprovision.md)
