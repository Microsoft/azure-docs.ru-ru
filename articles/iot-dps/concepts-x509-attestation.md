---
title: Служба подготовки устройств для центра Интернета вещей Azure — аттестация сертификата X. 509
description: Описание концепций, относящихся к использованию аттестации сертификатов X. 509 с помощью службы подготовки устройств (DPS) и центра Интернета вещей.
author: wesmc7777
ms.author: wesmc
ms.date: 09/14/2020
ms.topic: conceptual
ms.service: iot-dps
services: iot-dps
ms.openlocfilehash: 9eee315aac28847710662b463add7d6e68d8d505
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "94967301"
---
# <a name="x509-certificate-attestation"></a>Аттестация на основе сертификата X.509

В этой статье приводятся общие сведения о концепциях службы подготовки устройств (DPS), которые используются при подготовке устройств с помощью аттестации сертификатов X. 509. Сведения в этой статье касаются пользователей, участвующих в подготовке устройства для развертывания.

Сертификаты X. 509 могут храниться в аппаратном HSM модуля безопасности.

> [!TIP]
> Настоятельно рекомендуется использовать HSM с устройствами для безопасного хранения секретов, таких как сертификат X. 509, на устройствах в рабочей среде.


## <a name="x509-certificates"></a>Сертификаты X.509

Применение сертификатов X.509 в качестве механизма аттестации позволяет легко масштабировать производство и упростить подготовку устройств к работе. Сертификаты X.509 обычно организуются в цепочки доверия, в которых каждый сертификат подписан закрытым ключом от сертификата следующего уровня. На самом верху цепочки расположен самозаверяющий корневой сертификат. Такая схема создает систему делегированного доверия от корневого сертификата, созданного доверенным корневым центром сертификации (ЦС), через все промежуточные ЦС вплоть до сертификата конечного объекта, установленного на устройстве. Дополнительные сведения см. в статье [Device Authentication using X.509 CA Certificates](../iot-hub/iot-hub-x509ca-overview.md) (Аутентификация устройств с помощью сертификатов ЦС X.509). 

Цепочка сертификатов часто соответствует реальной логической или физической иерархии, характерной для конкретных устройств. Например, производитель может сделать следующее:
- выдать самозаверяющий корневой сертификат ЦС;
- с помощью корневого сертификата создать уникальный промежуточный сертификат ЦС для каждого завода;
- с помощью отдельного сертификата каждого завода создать уникальный промежуточный сертификат ЦС для каждой производственной линии на заводе;
- и наконец, с помощью сертификата производственной линии создать уникальный сертификат устройства (конечного объекта) для каждого устройства, изготовленного на этой линии. 

Дополнительные сведения см. в статье [Концептуальное представление о сертификатах ЦС X.509 в отрасли Интернета вещей](../iot-hub/iot-hub-x509ca-concept.md). 

### <a name="root-certificate"></a>Корневой сертификат

Корневой сертификат — это самозаверяющий сертификат X.509, представляющий определенный центр сертификации (ЦС). Он выполняет роль конечной точки (якоря доверия) в цепочке сертификатов. Организация может самостоятельно выдавать корневые сертификаты или приобретать их в корневом центре сертификации. Дополнительные сведения см. в разделе [Получение сертификатов ЦС X.509](../iot-hub/iot-hub-security-x509-get-started.md#get-x509-ca-certificates). Корневой сертификат также может называться сертификатом корневого ЦС.

### <a name="intermediate-certificate"></a>Промежуточный сертификат

Промежуточным сертификатом считается сертификат X.509, подписанный корневым сертификатом (или другим промежуточным сертификатом, в цепочке которого есть корневой сертификат). Последний промежуточный сертификат в цепочке используется для подписи конечного сертификата. Промежуточный сертификат также может называться сертификатом промежуточного ЦС.

##### <a name="why-are-intermediate-certs-useful"></a>Почему используются промежуточные сертификаты?
Промежуточные сертификаты используются различными способами. Например, промежуточные сертификаты можно использовать для группировки устройств по линиям продуктов, клиентам, которые приобретают устройства, подразделения компании или фабрики. 

Представьте себе, что contoso — это крупная организация с собственной инфраструктурой открытых ключей (PKI), использующей корневой сертификат с именем *контосорутцерт*. Каждое подразделение Contoso имеет свой собственный промежуточный сертификат, подписанный *контосорутцерт*. Каждый филиал будет использовать их промежуточный сертификат для подписи конечных сертификатов для каждого устройства. В этом сценарии компания Contoso может использовать один экземпляр DP, где *контосорутцерт* проверена с помощью [подтверждения принадлежности](./how-to-verify-certificates.md). У них может быть Группа регистрации для каждой дочерней компании. Таким образом, каждому отдельному филиалу не придется беспокоиться о проверке сертификатов.


### <a name="end-entity-leaf-certificate"></a>Сертификат конечного объекта

Конечный сертификат (сертификат конечного субъекта) определяет владельца сертификата. В его цепочке сертификатов содержится один корневой сертификат и может быть несколько промежуточных сертификатов. Конечный сертификат не используется для подписи каких-либо других сертификатов. Он уникально идентифицирует устройство для службы подготовки, поэтому иногда его называют сертификатом устройства. В процессе аутентификации устройство применяет закрытый ключ, связанный с этим сертификатом, чтобы вернуть ответ с подтверждением владения на соответствующий запрос от службы.

Конечные сертификаты, используемые с [индивидуальной](./concepts-service.md#individual-enrollment) записью регистрации, имеют требование, что **имя субъекта** должно быть установлено в идентификатор регистрации отдельной записи регистрации. Конечным сертификатам, используемым с записью [группы регистрации](./concepts-service.md#enrollment-group) , должно быть присвоено **имя** нужного идентификатора устройства, которое будет отображаться в **записях регистрации** для устройства, прошедшего проверку подлинности, в группе регистрации.

Дополнительные сведения см. в разделе [Authenticating devices signed with X.509 CA certificates](../iot-hub/iot-hub-x509ca-overview.md#authenticating-devices-signed-with-x509-ca-certificates) (Аутентификация устройств, подписанных с помощью сертификатов ЦС X.509).

## <a name="controlling-device-access-to-the-provisioning-service-with-x509-certificates"></a>Управление доступом устройств к службе подготовки с использованием сертификатов X.509

Служба подготовки предоставляет два типа регистрации, которые можно использовать для управления доступом к устройствам с помощью механизма аттестации X. 509:  

- [Отдельные регистрации](./concepts-service.md#individual-enrollment) создаются на основе сертификата устройства, связанного с определенным устройством. Эти записи устанавливают правила регистрации для конкретных устройств.
- [Группа регистраций](./concepts-service.md#enrollment-group) создается на основе определенного сертификата промежуточного или корневого ЦС. Эти записи устанавливают правила регистрации для всех устройств, содержащих этот промежуточный или корневой сертификат в своей цепочке сертификатов. 

#### <a name="dps-device-chain-requirements"></a>Требования к цепочке устройств DPS

Когда устройство пытается зарегистрироваться через службу DPS с помощью группы регистрации, устройство должно отправить цепочку сертификатов из конечного сертификата в сертификат, проверенный с помощью [подтверждения принадлежности](how-to-verify-certificates.md). В противном случае проверка подлинности завершится ошибкой.

Например, если проверяется только корневой сертификат и в группу регистрации передается промежуточный сертификат, устройство должно представлять цепочку сертификатов от конечного сертификата до проверенного корневого сертификата. Эта цепочка сертификатов будет включать все промежуточные сертификаты. Проверка подлинности завершится ошибкой, если служба DPS не может пройти по цепочке сертификатов до проверенного сертификата.

Например, рассмотрим корпорацию, использующую для устройства следующую цепочку устройств.

![Пример цепочки сертификатов устройств](./media/concepts-x509-attestation/example-device-cert-chain.png) 

Проверяется только корневой сертификат, и сертификат *intermediate2* отправляется в группу регистрации.

![Пример проверенного корня](./media/concepts-x509-attestation/example-root-verified.png) 

Если устройство отправляет в процессе подготовки только следующую цепочку устройств, проверка подлинности завершится ошибкой. Так как служба DPS не может выполнить проверку подлинности, исходя из-за действительности сертификата *intermediate1*

![Пример цепочки сертификатов с ошибками](./media/concepts-x509-attestation/example-fail-cert-chain.png) 

Если устройство отправляет полную цепь устройств следующим образом во время подготовки, служба DPS может попытаться выполнить проверку подлинности устройства.

![Пример цепочки сертификатов устройств](./media/concepts-x509-attestation/example-device-cert-chain.png) 




> [!NOTE]
> Промежуточные сертификаты также можно проверить с помощью [подтверждения принадлежности](how-to-verify-certificates.md).


#### <a name="dps-order-of-operations-with-certificates"></a>Порядок операций с сертификатами в службе DPS
Когда устройство подключается к службе подготовки, эта служба сначала проверяет для него записи регистрации в порядке от более конкретных к более обобщенным. Например, если есть отдельная регистрация для устройства, служба подготовки применяет именно эту запись. Если отдельная регистрация для устройства отсутствует, а Группа регистрации для первого промежуточного сертификата в цепочке сертификатов на устройстве существует, то она применяет эту запись и т. д. в цепочку к корню. Служба применяет первую подходящую запись следующим образом:

- если первая из найденных записей включена, служба выполняет подготовку устройства;
- если первая из найденных записей отключена, служба отклоняет подготовку устройства;  
- если не будет найдено ни одной записи для сертификатов в цепочке сертификатов устройства, служба отклоняет подготовку устройства. 

Такой механизм и иерархическая структура сертификатов предоставляют мощный и гибкий инструмент управления доступом для отдельных устройств и групп устройств. Предположим, что мы создали пять устройств со следующими цепочками сертификатов: 

- *устройство 1*: корневой сертификат -> сертификат A -> сертификат устройства 1;
- *устройство 2*: корневой сертификат -> сертификат A -> сертификат устройства 2;
- *устройство 3*: корневой сертификат -> сертификат A -> сертификат устройства 3;
- *устройство 4*: корневой сертификат -> сертификат B -> сертификат устройства 4;
- *устройство 5*: корневой сертификат -> сертификат B -> сертификат устройства 5.

Изначально вы создаете запись групповой регистрации для корневого сертификата, чтобы включить доступ для всех пяти устройств. Если в определенный момент сертификат B окажется скомпрометирован, вы можете создать дополнительную групповую запись для сертификата B и отключить ее, чтобы запретить регистрацию *устройства 4* и *устройства 5*. Если позднее будет скомпрометировано еще и *устройство 3*, вы можете создать запись отдельной регистрации для сертификата этого устройства и отключить ее. Таким образом, доступ будет закрыт для *устройства 3*, но *устройство 1* и *устройство 2* смогут пройти регистрацию.