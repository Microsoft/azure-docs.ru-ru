---
title: Руководство. Настройка протокола HTTPS на личном домене для Azure Front Door | Документация Майкрософт
description: Из этого руководства вы узнаете, как включать и отключать протокол HTTPS в Azure Front Door для личного домена.
services: frontdoor
documentationcenter: ''
author: duongau
editor: ''
ms.service: frontdoor
ms.workload: infrastructure-services
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: tutorial
ms.date: 10/21/2020
ms.author: duau
ms.openlocfilehash: 17677ea89b04659de66b9bda35975b96ff33473a
ms.sourcegitcommit: c27a20b278f2ac758447418ea4c8c61e27927d6a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/03/2021
ms.locfileid: "101740789"
---
# <a name="tutorial-configure-https-on-a-front-door-custom-domain"></a>Руководство по Настройка протокола HTTPS на личном домене Front Door

В этом руководстве показано, как включить протокол HTTPS для личного домена, связанного со службой Front Door, в разделе интерфейсных узлов. С помощью протокола HTTPS в личном домене (например, https:\//www.contoso.com) вы гарантируете безопасную доставку конфиденциальных данных с TLS/SSL-шифрованием при отправке через Интернет. При подключении веб-браузера к веб-сайту по протоколу HTTPS он выполняет проверку сертификата безопасности веб-сайта и подтверждает, что он выдан правомочным центром сертификации. Этот процесс обеспечивает безопасность и защиту веб-приложений от атак.

По умолчанию Azure Front Door поддерживает HTTPS в стандартном имени узла Front Door. Например, при создании службы Front Door (скажем, `https://contoso.azurefd.net`) протокол HTTPS включен по умолчанию для запросов к `https://contoso.azurefd.net`. Тем не менее после развертывания личного домена 'www.contoso.com' потребуется дополнительно включить протокол HTTPS для этого интерфейсного узла.   

Ниже приведены некоторые ключевые характеристики настраиваемой функции HTTPS:

- Дополнительные затраты не требуются. Вам не придется оплачивать приобретение или продление сертификата или платить за трафик, переданный по протоколу HTTPS. 

- Простое включение: на [портале Azure](https://portal.azure.com) доступна подготовка одним щелчком. Для включения этого компонента можно также использовать REST API или другие средства разработки.

- Доступно полноценное управление сертификатами: закупка всех сертификатов и управление ими осуществляется без вашего участия. Сертификаты автоматически подготавливаются и продлеваются до истечения их срока действия, что устраняет риски прерывания работы службы в связи с истечением срока действия сертификата.

В этом руководстве описано следующее:
> [!div class="checklist"]
> - включение протокола HTTPS в личном домене;
> - использование управляемого AFD сертификата; 
> - использование собственного сертификата, то есть пользовательского TLS/SSL-сертификата;
> - проверка домена;
> - отключение протокола HTTPS в личном домене.


[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

## <a name="prerequisites"></a>Предварительные требования

Прежде чем перейти к выполнению шагов в этом руководстве, создайте службу Front Door и разверните в ней как минимум один личный домен. Дополнительные сведения см. в статье [Учебник. Добавление личного домена в службу Front Door](front-door-custom-domain.md).

## <a name="tlsssl-certificates"></a>TLS/SSL-сертификаты

Чтобы включить протокол HTTPS для безопасной доставки содержимого в личном домене Front Door, необходимо использовать TLS/SSL-сертификат. Вы можете использовать сертификат под управлением Azure Front Door или собственный сертификат.


### <a name="option-1-default-use-a-certificate-managed-by-front-door"></a>Вариант 1 (по умолчанию). Использование сертификата под управлением Front Door

При использовании сертификата под управлением Azure Front Door вы можете включить HTTPS несколькими щелчками. Azure Front Door полностью управляет задачами управления сертификатами, такими как приобретение и продление. Как только функция будет включена, процесс сразу же запустится. Если личный домен уже сопоставлен с интерфейсным узлом Front Door по умолчанию (`{hostname}.azurefd.net`), дальнейших действий не требуется. Front Door предпримет нужные действия и автоматически выполнит запрос. Тем не менее, если личный домен сопоставлен в другом месте, используйте электронную почту, чтобы проверить принадлежность домена.

Ниже описана процедура включения протокола HTTPS для личного домена.

1. На [портале Azure](https://portal.azure.com)перейдите к профилю **Front Door**.

2. Из списка интерфейсных узлов выберите личный домен, для которого необходимо включить протокол HTTPS.

3. В разделе **HTTPS для личного домена** щелкните **Включено** и выберите **Управляемая служба Frontdoor**, чтобы настроить источник сертификата.

4. Нажмите кнопку «Сохранить».

5. Перейдите к [проверке домена](#validate-the-domain).

> [!NOTE]
> К сертификатам, управляемым AFD, применяется ограничение DigiCert на 64 символа. При превышении такого ограничения проверка завершится сбоем.


### <a name="option-2-use-your-own-certificate"></a>Вариант 2. использование собственного сертификата;

Для включения функции HTTPS можно использовать собственный сертификат. Этот процесс выполняется путем интеграции с Azure Key Vault, что позволяет безопасно хранить сертификаты. Azure Front Door использует этот механизм безопасности, чтобы получить сертификат. При этом вам потребуется выполнить ряд дополнительных действий. TLS/SSL-сертификат необходимо создать в разрешенном центре сертификации. В противном случае при использовании недопустимого ЦС, ваш запрос, будет отклонен. Список разрешенных ЦС приведен в статье [Разрешенные центры сертификации для включения настраиваемого протокола HTTPS в Azure Front Door](front-door-troubleshoot-allowed-ca.md).

#### <a name="prepare-your-azure-key-vault-account-and-certificate"></a>Подготовка учетной записи Azure Key Vault и сертификата
 
1. Azure Key Vault. Требуется активная учетная запись Azure Key Vault в той же подписке, что и служба Front Door, для которой нужно включить настраиваемый протокол HTTPS. Если у вас ее еще нет, создайте учетную запись Azure Key Vault.

> [!WARNING]
> Сейчас Azure Front Door поддерживает только учетные записи Key Vault, размещенные в той же подписке, что и конфигурация Front Door. Если выбрать Key Vault в другой подписке, произойдет сбой.

2. Сертификаты Azure Key Vault. Если у вас уже есть сертификат, его можно отправить непосредственно в свою учетную запись Azure Key Vault или же можно создать сертификат непосредственно через Azure Key Vault из одного из партнерских центров сертификации, с которыми интегрируется Azure Key Vault. Отправьте сертификат как объект типа **сертификат**, а не **секрет**.

> [!NOTE]
> При использовании личного TLS/SSL-сертификата Front Door не поддерживает сертификаты с алгоритмами шифрования EC.

#### <a name="register-azure-front-door"></a>Регистрация Azure Front Door

Зарегистрируйте субъект-службу для Azure Front Door в качестве приложения в Azure Active Directory с помощью PowerShell.

> [!NOTE]
> Для выполнения этого действия требуются разрешения глобального администратора. Оно выполняется только **один раз** для каждого клиента.

1. При необходимости установите [Azure PowerShell](/powershell/azure/install-az-ps) в PowerShell на локальном компьютере.

2. Выполните следующую команду в PowerShell:

     `New-AzADServicePrincipal -ApplicationId "ad0e1c7e-6d38-4ba4-9efd-0bc77ba9f037"`              

#### <a name="grant-azure-front-door-access-to-your-key-vault"></a>Предоставление Azure Front Door доступа к хранилищу ключей
 
Предоставьте Azure Front Door разрешение на доступ к сертификатам в учетной записи Azure Key Vault.

1. В своей учетной записи хранилища ключей в разделе "Параметры" выберите **Политики доступа**, а затем — **Добавить**, чтобы создать политику.

2. В разделе **Выбор субъекта** найдите **ad0e1c7e-6d38-4ba4-9efd-0bc77ba9f037** и выберите **Microsoft.Azure.Frontdoor**. Нажмите кнопку **Выбрать**.

3. Выберите **Разрешения секрета** и **Получить**, чтобы разрешить Front Door получить сертификат.

4. Выберите **Разрешения сертификата** и **Получить**, чтобы разрешить Front Door получить сертификат.

5. Щелкните **ОК**. 

    Теперь у Azure Front Door есть доступ к этому Key Vault и сертификатам, которые хранятся в нем.
 
#### <a name="select-the-certificate-for-azure-front-door-to-deploy"></a>Выбор сертификата для развертывания в Azure Front Door
 
1. Вернитесь к службе Front Door на портале. 

2. В списке личных доменов выберите домен, для которого нужно включить протокол HTTPS.

    Откроется страница **Личный домен**.

3. В разделе с типом управления сертификатом выберите **Использовать собственный сертификат**. 

4. Для работы Azure Front Door требуется, чтобы подписка учетной записи Key Vault совпадала с подпиской службы Front Door. Выберите хранилище ключей, сертификат (секрет) и версию сертификата.

    Azure Front Door выводит следующие сведения: 
    - учетные записи хранилища ключей для идентификатора подписки; 
    - сертификаты (секреты) в выбранном хранилище ключей; 
    - доступные версии сертификатов.
 
5. При использовании собственного сертификата проверка домена не является обязательной. Переходите к разделу [Ожидание распространения](#wait-for-propagation).

## <a name="validate-the-domain"></a>проверка домена;

Если вы уже используете личный домен, сопоставленный с пользовательской конечной точкой с помощью записи CNAME, или используете собственный сертификат, перейдите к разделу  
[Личный домен сопоставлен со службой Front Door](#custom-domain-is-mapped-to-your-front-door-by-a-cname-record). Если же запись CNAME для домена больше не существует или содержит поддомен afdverify, перейдите к разделу [Личный домен не сопоставлен со службой Front Door](#custom-domain-is-not-mapped-to-your-front-door).

### <a name="custom-domain-is-mapped-to-your-front-door-by-a-cname-record"></a>Личный домен сопоставлен со службой Front Door с помощью записи CNAME

Добавив личный домен для интерфейсных узлов Front Door, вы создали в таблице DNS регистратора доменов запись CNAME, которая сопоставляет этот домен с именем узла по умолчанию Front Door (.azurefd.net). Если эта запись CNAME еще существует и не содержит поддомен afdverify, центр сертификации DigiCert использует ее для автоматической проверки прав владения личным доменом. 

При использовании собственного сертификата проверка домена не является обязательной.

Запись CNAME должна иметь указанный ниже формат, где *Name* обозначает имя личного домена, а *Value* —имя узла по умолчанию Front Door (.azurefd.net).

| Имя            | Тип  | Значение                 |
|-----------------|-------|-----------------------|
| <www.contoso.com> | CNAME | contoso.azurefd.net |

Дополнительные сведения о записи CNAME см. в разделе [о создании записи CNAME в DNS](../cdn/cdn-map-content-to-custom-domain.md).

Если запись CNAME имеет правильный формат, DigiCert автоматически подтверждает имя личного домена и добавляет его к сертификату SAN. DigitCert не будет отправлять писем для подтверждения и вам не нужно подтверждать этот запрос. Сертификат будет действителен в течение одного года, а перед истечением срока действия — автоматически продлеваться. Переходите к разделу [Ожидание распространения](#wait-for-propagation). 

Автоматическая проверка обычно занимает несколько минут. Если после проверки домен не отображается в течение часа, отправьте запрос в службу поддержки.

>[!NOTE]
>Если у поставщика DNS имеется запись авторизации центра сертификации, то она должна включать DigiCert как допустимый ЦС. Запись авторизации ЦС позволяет владельцам доменов указывать своим поставщикам DNS, какие ЦС уполномочены выдавать сертификаты безопасности для их домена. Если ЦС получает заказ на сертификат для домена, который имеет запись авторизации ЦС, и этот ЦС не указан как уполномоченный издатель, тогда этому домену или поддомену запрещается выдавать сертификат безопасности. Сведения об управлении записями авторизации ЦС см. в [этой статье](https://support.dnsimple.com/articles/manage-caa-record/). Средство для работы с записями авторизации ЦС доступно [здесь](https://sslmate.com/caa/).

### <a name="custom-domain-is-not-mapped-to-your-front-door"></a>Личный домен не сопоставлен со службой Front Door

Если запись CNAME для конечной точки не существует или содержит поддомен afdverify, следуйте инструкциям в этом шаге.

При включении HTTPS для личного домена центр сертификации DigiCert (ЦС) проверяет право собственности на ваш домен, связавшись с пользователем, выполнившим регистрацию, в соответствии с информацией в базе данных [WHOIS](http://whois.domaintools.com/) для домена. Контакт осуществляется по электронной почте (по умолчанию) или телефону, указанному в базе данных WHOIS. Чтобы поддержка HTTPS стала активной для личного домена, необходимо выполнить его проверку. Для подтверждения домена у вас есть шесть рабочих дней. Запросы, которые не утверждены в течение шести рабочих дней, будут автоматически отменены. 

![Запись WHOIS](./media/front-door-custom-domain-https/whois-record.png)

DigiCert также отправляет письмо для подтверждения на дополнительные адреса электронной почты. Если сведения о регистрируемом пользователе в базе данных WHOIS являются частными, убедитесь, что возможно утверждение непосредственно с одного из этих адресов:

admin@&lt;имя_вашего_домена.com&gt;  
administrator@&lt;имя_вашего_домена.com&gt;  
webmaster@&lt;имя_вашего_домена.com&gt;  
hostmaster@&lt;имя_вашего_домена.com&gt;  
postmaster@&lt;имя_вашего_домена.com&gt;  

Через несколько минут должно появиться электронное сообщение, как показано в следующем примере, с просьбой подтвердить запрос. При использовании фильтра нежелательной почты добавьте admin@digicert.com в список разрешений. Если вы не получите электронное сообщение в течение 24 часов, обратитесь в службу поддержки Майкрософт.

Щелчок ссылки для подтверждения запроса откроет онлайн-форму подтверждения. Следуйте инструкциям в форме. Есть два варианта проверки:

- Можно утвердить все будущие заказы, оформленные с использованием одной и той же учетной записи для одного корневого домена, например contoso.com. Этот подход рекомендуется, если планируется добавлять дополнительные пользовательские домены для одного корневого домена.

- Можно просто утвердить конкретное имя узла, которое используется в данном запросе. Для последующих запросов требуются дополнительные утверждения.

После утверждения DigiCert завершает создание сертификата для имени личного домена. Сертификат будет действителен в течение одного года, а перед истечением срока действия — автоматически продлеваться.

## <a name="wait-for-propagation"></a>Ожидание распространения

Активация компонента HTTPS для личного домена после проверки доменного имени может занять до 6–8 часов. Когда процесс будет завершен, состояние пользовательского HTTPS на портале Azure будет иметь значение **Вкл.** , а четыре шага в диалоговом окне пользовательского домена будут отмечены как завершенные. Личный домен готов для использования протокола HTTPS.

### <a name="operation-progress"></a>Ход выполнения операции

В следующей таблице показан ход операции, возникающей при включении HTTPS. После включения HTTPS в диалоговом окне личного домена отобразятся четыре шага операции. По мере активации этих шагов в них появляются вложенные шаги со сведениями о ходе выполнения. Не все из вложенных шагов будут выполняться. После успешного завершения шага рядом с ним появится зеленый флажок. 

| Шаг операции | Сведения о вложенном шаге операции | 
| --- | --- |
| 1\. Отправка запроса | Отправка запроса |
| | Отправляется HTTP-запрос. |
| | HTTPS-запрос успешно отправлен. |
| 2\. Проверка домена | Домен автоматически считается проверенным, если его запись CNAME сопоставлена с интерфейсным узлом по умолчанию Front Door (.azurefd.net). В противном случае запрос на проверку будет отправляться на адрес электронной почты, указанный в записи регистрации вашего домена (регистрант WHOIS). Как можно скорее проверьте домен. |
| | Владение доменом успешно подтверждено. |
| | Истек срок действия запроса на подтверждение прав владения доменом (клиент, скорее всего, не ответил в течение 6 дней). HTTPS не будет включен в вашем домене. * |
| | Клиент отклонил запрос на подтверждение прав собственности на домен. HTTPS не будет включен в вашем домене. * |
| 3\. Подготовка сертификата | В настоящее время центр сертификации выдает сертификат, необходимый для включения HTTPS в вашем домене. |
| | Сертификат был выдан и в настоящее время развертывается для службы Front Door. Этот процесс может занять до 1 часа. |
| | Сертификат успешно развернут для службы Front Door. |
| 4\. Завершение | HTTPS успешно включен для вашего домена. |

\* Это сообщение отображается, только если произошла ошибка. 

Если перед отправкой запроса возникает ошибка, появится следующее сообщение об ошибке:

<code>
We encountered an unexpected error while processing your HTTPS request. Please try again and contact support if the issue persists.
</code>

## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы

1. *Кто является поставщиком сертификата и какой тип сертификата используется?*

    Для личного домена используется выделенный (отдельный) сертификат, предоставленный Digicert. 

2. *Какое подключение TLS/SSL используется: на основе IP-адреса или SNI?*

    Azure Front Door использует протокол TLS/SSL на основе SNI.

3. *Что делать, если я не получу сообщение электронной почты для проверки домена от DigiCert?*

    Если для личного домена существует запись CNAME, которая указывает на имя узла конечной точки (и в домене не существует поддомен afdverify), вы не получите письмо с запросом на подтверждение домена. Проверка в этом случае проходит автоматически. Если запись CNAME отсутствует и вы не получили сообщение электронной почты в течение 24 часов, обратитесь в службу поддержки Майкрософт.

4. *Не окажется ли сертификат SAN менее безопасным, чем выделенный сертификат?*
    
    Для сертификата SAN используются те же стандарты безопасности и шифрования, что и для выделенного сертификата. Чтобы дополнительно обезопасить сервер, для всех выданных TLS/SSL-сертификатов используется алгоритм SHA-256.

5. *Нужно ли иметь запись авторизации центра сертификации у моего поставщика DNS?*

    Нет, в настоящее время не требуется запись авторизации центра сертификации. Однако если у вас она есть, она должна включать DigiCert в качестве действительного центра сертификации.

## <a name="clean-up-resources"></a>Очистка ресурсов

Выше объяснялось, как включить протокол HTTPS для личного домена. Если вам больше не нужно использовать личный домен с протоколом HTTPS, его можно отключить, сделав следующее.

### <a name="disable-the-https-feature"></a>Отключение компонента HTTPS 

1. На [портале Azure](https://portal.azure.com) перейдите к конфигурации **Azure Front Door**.

2. В списке интерфейсных узлов щелкните личный домен, для которого требуется отключить протокол HTTPS.

3. Щелкните **Отключить**, чтобы отключить протокол HTTPS, а затем нажмите кнопку **Сохранить**.

### <a name="wait-for-propagation"></a>Ожидание распространения

После отключения компонента HTTPS личного домена для вступления изменений в силу может потребоваться до 6–8 часов. Когда процесс будет завершен, состояние пользовательского HTTPS на портале Azure будет иметь значение **Выкл.** , а три шага в диалоговом окне пользовательского домена будут отмечены как завершенные. Личный домен больше не сможет использовать HTTPS.

#### <a name="operation-progress"></a>Ход выполнения операции

В следующей таблице показан ход операции, возникающей при отключении HTTPS. После отключения HTTPS в диалоговом окне личного домена отобразятся три шага. По мере того, как каждый шаг становится активным, под ним появляются дополнительные сведения. После успешного завершения шага рядом с ним появится зеленый флажок. 

| Ход выполнения операции | Сведения об операции | 
| --- | --- |
| 1\. Отправка запроса | Отправка запроса |
| 2\. Отзыв сертификата | Удаление сертификата |
| 3\. Завершение | Сертификат удален |

## <a name="next-steps"></a>Дальнейшие действия

В этом руководстве вы узнали, как выполнять следующие задачи:

* отправка сертификата в Key Vault;
* проверка домена;
* включение протокола HTTPS для личного домена.

Чтобы узнать, как настроить политику геофильтрации для Front Door, перейдите к следующему руководству.

> [!div class="nextstepaction"]
> [Настройка политики геофильтрации](front-door-geo-filtering.md)
