---
title: Ведение журнала для передней дверцы Azure уровня "Стандартный"/Premium (Предварительная версия)
description: В этой статье объясняется, как ведение журнала работает в передней дверце Azure "Стандартный" или "Премиум".
services: front-door
author: duongau
ms.service: frontdoor
ms.topic: article
ms.date: 03/15/2021
ms.author: duau
ms.openlocfilehash: 531f4a9c9f535779e451ca316a8a5867f6cdaba5
ms.sourcegitcommit: 87a6587e1a0e242c2cfbbc51103e19ec47b49910
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/16/2021
ms.locfileid: "103573903"
---
# <a name="azure-front-door-standardpremium-preview-logging"></a>Ведение журнала для передней дверцы Azure уровня "Стандартный"/Premium (Предварительная версия)

> [!Note]
> Эта документация предназначена для передней дверцы Azure уровня "Стандартный" или "Премиум" (Предварительная версия). Ищете информацию о передней дверце Azure? Просмотреть [здесь](../front-door-overview.md).

Передняя дверца Azure обеспечивает различные функции ведения журнала, которые помогают отслеживать, отслеживать и отлаживать переднюю дверцу. 

* Журналы доступа содержат подробную информацию о каждом запросе, который АФД получает, и помогает анализировать и отслеживать шаблоны доступа, а также устранять проблемы. 
* Журналы действий позволяют анализировать операции, выполненные с ресурсами Azure.  
* Журналы проверки работоспособности предоставляют журналы для каждой неудачной проверки в источнике. 
* Журналы брандмауэра веб-приложения (WAF) предоставляют подробные сведения о запросах, которые регистрируются в режиме обнаружения или предотвращения конечной точки передней дверцы Azure. Пользовательский домен, который настраивается с помощью WAF, также можно просмотреть в этих журналах.

> [!IMPORTANT]
> Передняя дверца Azure Standard/Premium (Предварительная версия) в настоящее время доступна в общедоступной предварительной версии.
> Эта предварительная версия предоставляется без соглашения об уровне обслуживания и не рекомендована для использования рабочей среде. Некоторые функции могут не поддерживаться или их возможности могут быть ограничены.
> Дополнительные сведения см. в статье [Дополнительные условия использования предварительных выпусков Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).

Журналы доступа, журналы проверки работоспособности и журналы WAF не включены по умолчанию. Чтобы включить ведение журнала, выполните следующие действия. Записи этого журнала собираются по умолчанию, и их можно просмотреть на портале Azure. В журналах может быть задержка до нескольких минут. 

Существует три способа хранения журналов: 

* **Учетная запись хранения:** Учетные записи хранения лучше всего использовать для сценариев, когда журналы хранятся дольше, а при необходимости — для проверки. 
* **Концентраторы событий:** Концентраторы событий — это отличный вариант для интеграции с другими средствами управления сведениями о безопасности и событиями (SIEM) или внешними хранилищами данных. Например: Splunk/DataDog/Sumo. 
* **Log Analytics Azure:** Log Analytics Azure в Azure Monitor лучше использовать для общего мониторинга и анализа производительности передней дверцы Azure в реальном времени.

## <a name="configure-logs"></a>Настройка журналов

1. Войдите на [портал Azure](https://portal.azure.com).

1. Найдите переднюю дверцу Azure Standard/Premium и выберите профиль передней дверцы Azure.

1. В профиле перейдите к разделу **мониторинг** и выберите **параметр диагностики**. Выберите **Добавить параметр диагностики**.

   :::image type="content" source="../media/how-to-logging/front-door-logging-1.png" alt-text="Снимок экрана с целевой страницей параметров диагностики.":::

1. В разделе **параметры диагностики** введите имя для  **параметров диагностики**.

1. Выберите  **Журнал** из **фронтдуракцесслог**, **фронтдурхеалспробелог** и **фронтдурвебаппликатионфиревалллог**.

1. Выберите **сведения о назначении**. Доступны следующие варианты назначения: 

    * **Отправить в Log Analytics.**
        * Выберите *подписку* и *рабочую область Log Analytics*.
    * **Архивировать в учетной записи хранения.**
        * Выберите *подписку* и *учетную запись хранения*. и задайте **период хранения (в днях)**.
    * **Передать в концентратор событий.**
        * Выберите *подписку, пространство имен концентратора событий, имя концентратора событий (необязательно)* и *имя политики концентратора событий*. 

     :::image type="content" source="../media/how-to-logging/front-door-logging-2.png" alt-text="Снимок экрана со страницей параметров диагностики.":::

1. Щелкните **Save**(Сохранить).

## <a name="access-log"></a>журнал доступа;

В настоящее время Передняя дверца Azure предоставляет отдельные запросы API с каждой записью, имеющей следующую схему и зарегистрированную в формате JSON, как показано ниже. 

| Свойство | Описание |
|----------|-------------| 
| TrackingReference | Уникальная строка ссылки, определяющая запрос, обслуживаемый АФД, который также отправляется клиенту в виде заголовка X-Azure-ref. Эта строка нужна для поиска в журналах доступа сведений о конкретном запросе. |
| время; | Дата и время, когда АФД пограничная доставка запросила содержимое клиенту (в формате UTC). |
| HttpMethod | Метод HTTP, используемый запросом: удаление, получение, HEAD, параметры, исправление, POST или размещение. |
| HttpVersion | Версия HTTP, которую средство просмотра задает в запросе. |
| RequestUri | URI полученного запроса. Это поле является полной схемой, портом, доменом, путем и строкой запроса. |
| HostName | Имя узла в запросе от клиента. Если вы включили личные домены и используете домен с подстановочными знаками (*. contoso.com), именем узла будет a.contoso.com. Если вы используете домен передней дверцы Azure (contoso.azurefd.net), имя узла — contoso.azurefd.net. |
| RequestBytes | Размер сообщения с HTTP-запросом в байтах, включая заголовки и текст запроса. Число байтов данных, которые средство просмотра включило в запрос, включая заголовки. |
| ResponseBytes | Количество байтов, отправленных внутренним сервером в качестве ответа. |
| UserAgent | Тип браузера, используемый клиентом. |
| ClientIp | IP-адрес клиента, который сделал исходный запрос. Если в запросе был указан заголовок X-Forwardd-for, то IP-адрес клиента выбирается из этого же. |
| соккетип | IP-адрес прямого подключения к АФД границе. Если клиент использовал прокси-сервер HTTP или подсистему балансировки нагрузки для отправки запроса, значение Соккетип — это IP-адрес прокси-сервера или балансировщика нагрузки. |
| Задержка | Время, в течение которого пограничным сервером АФД получает клиентский запрос до момента, когда АФД отправляет последний байт ответа клиенту в миллисекундах. Это поле не учитывает задержку сети и TCP-буферизацию. |
| рекуестпротокол | Протокол, указанный клиентом в запросе: HTTP, HTTPS. |
| SecurityProtocol | Версия протокола TLS/SSL, которая использовалась в запросе. Содержит значение NULL, если шифрование не использовалось. Возможные значения: SSLv3, TLSv1, TLSv 1.1, TLSv 1.2 |
| секуритиЦифер | Если для протокола запроса задано значение HTTPS, в этом поле указывается шифр TLS/SSL, согласованный с клиентом, и АФД для шифрования. |
| Конечная точка | Доменное имя конечной точки АФД, например contoso.z01.azurefd.net |
| HttpStatusCode | Код состояния HTTP, возвращенный из АФД. |
| Pop | Граничная точка присутствия, которая ответила на запрос пользователя.  |
| Состояние кэша | Предоставляет код состояния, определяющий, как запрос обрабатывается службой CDN, когда дело доходит до кэширования. Возможны следующие значения: HTTP-запрос был обслужен из кэша POP АФД. <br> **Промахи**: HTTP-запрос был обслужен из источника. <br/> **PARTIAL_HIT**: некоторые байты из запроса были переданы из кэша POP АФД, в то время как некоторые байты доставлены из источника для сценариев фрагментирования объектов. <br> **CACHE_NOCONFIG**: пересылка запросов без параметров кэширования, включая сценарий обхода. <br/> **PRIVATE_NOSTORE**: ни один кэш не настроен в параметрах кэширования клиентами. <br> **REMOTE_HIT**: запрос был обслужен родительским кэшем узла. <br/> **Н/д**:* * запрос, который был отклонен с помощью подписанного URL-адреса и набора правил. |
| матчедрулессетнаме | Имена правил, которые были обработаны. |
| RouteName | Имя маршрута, которому соответствует запрос. |
| клиентпорт | IP-порт клиента, который сделал запрос. |
| Referrer | URL-адрес сайта, отправившего запрос. |
| тиметофирстбите | Время в миллисекундах от АФД получает запрос до момента отправки первого байта клиенту, измеряемого в передней дверце Azure. Это свойство не измеряет данные клиента. |
| ErrorInfo | Это поле предоставляет подробные сведения об маркере ошибки для каждого ответа. <br> **Ошибка**: указывает, что ошибка не найдена. <br> **Цертификатиррор**: ошибка УНИВЕРСАЛЬНого SSL-сертификата. <br> **Цертификатенамечеккфаилед**: имя узла в SSL-сертификате недопустимо или не совпадает. <br> **Клиентдисконнектед**: сбой запроса из-за сетевого подключения клиента. <br> **Клиентжеоблоккед**: клиент заблокирован из-за географического расположения IP-адреса. <br> **УнспеЦифиедклиентеррор**: Общая ошибка клиента. <br> **Инвалидрекуест**: недопустимый запрос. Это может произойти из-за неверно сформированного заголовка, текста и URL. <br> **Днсфаилуре**: сбой DNS. <br> **Днстимеаут**: истекло время ожидания запроса DNS для разрешения серверной части. <br> **Днснаменотресолвед**: не удалось разрешить имя или адрес сервера. <br> **Оригинконнектионабортед**: подключение к источнику разорвано аварийно. <br> **Оригинконнектионеррор**: Ошибка универсального соединения с источником. <br> **Оригинконнектионрефусед**: соединение с источником не было установлено. <br> **Оригинеррор**: ошибка общего источника. <br> **Оригининвалидрекуест**: в источник был отправлен недопустимый запрос. <br> **Респонсехеадертубиг**: источник вернул слишком большой заголовок ответа. <br> Источник **оригининвалидреспонсе**:* * вернул недопустимый или нераспознанный ответ. <br> **Оригинтимеаут**: истек период ожидания для запроса источника. <br> **Респонсехеадертубиг**: источник вернул слишком большой заголовок ответа. <br> **Рестриктедип**: запрос заблокирован в связи с ограниченным IP-адресом. <br> **Сслхандшакиррор**: не удалось установить соединение с исходным кодом из-за сбоя SSL встряхните. <br> **Сслинвалидрутка**: RootCA является недопустимым. <br> **СслинвалидЦифер**: шифр недопустим, для которого установлено подключение по протоколу HTTPS. <br> **Оригинконнектионабортед**: подключение к источнику разорвано аварийно. <br> **Оригинконнектионрефусед**: соединение с источником не было установлено. <br> **УнспеЦифиедеррор**: произошла ошибка, которая не помещается ни в одной из ошибок в таблице. |
| оригинурл | Полный URL-адрес источника, на который отправляются запросы. Состоит из схемы, заголовка узла, порта, пути и строки запроса. <br> **Перезапись URL-адреса**. Если в наборе правил есть правило переопределения URL-адресов, то путь ссылается на перезаписанный путь. <br> **Кэш на точке появления пограничных** устройств Если это попадание в кэш на точке присутствия, то источником является "н/д". <br> **Крупный запрос** Если запрошенное содержимое велико с несколькими фрагментированными запросами, которые возвращаются к источнику, это поле будет соответствовать первому запросу к источнику. Дополнительные сведения см. в разделе объектное Фрагментирование для получения дополнительных сведений. |
| оригинип | Исходный IP-адрес, обслуживающий запрос. <br> **Попадание в кэш при пограничных POP** Если это попадание в кэш на точке присутствия, то источником является "н/д". <br> **Крупный запрос** Если запрошенное содержимое велико с несколькими фрагментированными запросами, которые возвращаются к источнику, это поле будет соответствовать первому запросу к источнику. Дополнительные сведения см. в разделе объектное Фрагментирование для получения дополнительных сведений. |
| оригиннаме| Полное DNS-имя (имя узла в URL-адресе источника) к источнику. <br> **Попадание в кэш при пограничных POP** Если это попадание в кэш на точке присутствия, то источником является "н/д". <br> **Крупный запрос** Если запрошенное содержимое велико с несколькими фрагментированными запросами, которые возвращаются к источнику, это поле будет соответствовать первому запросу к источнику. Дополнительные сведения см. в разделе объектное Фрагментирование для получения дополнительных сведений. |

## <a name="health-probe-log"></a>Журнал проверки работоспособности

Журналы проверки работоспособности обеспечивают ведение журнала для каждой неудачной проверки, помогающей диагностировать источник.В журналах будут предоставлены сведения, которые можно использовать для возврата источника обратно в службу. В некоторых сценариях этот журнал может быть полезен:

* Вы заметили, что трафик передней дверцы Azure был отправлен в некоторые источники. Например, трафик получается только из трех из четырех источников. Вы хотите узнать, получают ли источники пробы, а не причину сбоя.  

* Вы заметили, что состояние работоспособности источника ниже ожидаемого, и необходимо узнать, какой источник завершился сбоем, и причину сбоя.

### <a name="health-probe-log-properties"></a>Свойства журнала зонда работоспособности

Каждый журнал проверки работоспособности имеет следующую схему.

| Свойство | Описание |
| --- | --- |
| хеалспробеид  | Уникальный идентификатор для идентификации запроса. |
| время; | Время завершения пробы |
| HttpMethod | Метод HTTP, используемый запросом проверки работоспособности. Значения включают GET и HEAD на основе конфигураций проверки работоспособности. |
| Result | Состояние проверки работоспособности "источник", "значение" включает "успешно" и другой текст ошибки. |
| HttpStatusCode  | Код состояния HTTP, возвращенный из источника. |
| Пробеурл (цель) | Полный URL-адрес источника, на который отправляются запросы. Состоит из схемы, заголовка узла, пути и строки запроса. |
| оригиннаме  | Источник, куда отправляются запросы. Это поле помогает выбрать интересующие источники, если источник настроен для FDQN. |
| POP | POP ребра, которая отправила запрос на пробу. |
| Исходный IP-адрес | IP-адрес целевого источника. Это поле полезно при поиске интересующих источников, если вы настраиваете источник с помощью FDQN. |
| тотолалатенци | Время от АФДКС помещает запрос к источнику во время источника времени, отправляющий последний ответ на АФДКС ребро. |
| коннектионлатенци| Длительность, потраченная на настройку TCP-соединения для отправки запроса проверки HTTP в источник. | 
| Задержка Днсресолутион | Длительность, потраченная на разрешение DNS, если источник настроен как FDQN, а не IP. Н/д, если источник настроен на IP-адрес. |

### <a name="health-probe-log-sample-in-json"></a>Пример журнала пробы работоспособности в JSON

`{ "records": [ { "time": "2021-02-02T07:15:37.3640748Z",
      "resourceId": "/SUBSCRIPTIONS/27CAFCA8-B9A4-4264-B399-45D0C9CCA1AB/RESOURCEGROUPS/AFDXPRIVATEPREVIEW/PROVIDERS/MICROSOFT.CDN/PROFILES/AFDXPRIVATEPREVIEW-JESSIE",
      "category": "FrontDoorHealthProbeLog",
      "operationName": "Microsoft.Cdn/Profiles/FrontDoorHealthProbeLog/Write",
      "properties": { "healthProbeId": "9642AEA07BA64675A0A7AD214ACF746E",
        "POP": "MAA",
        "httpVerb": "HEAD",
        "result": "OriginError",
        "httpStatusCode": "400",
        "probeURL": "http://afdxprivatepreview.blob.core.windows.net:80/",
        "originName": "afdxprivatepreview.blob.core.windows.net",
        "originIP": "52.239.224.228:80",
        "totalLatencyMilliseconds": "141",
        "connectionLatencyMilliseconds": "68",
        "DNSLatencyMicroseconds": "1814" } } ]
} `

## <a name="activity-logs"></a>Журналы действий

Журналы действий содержат сведения об операциях, выполненных в интерфейсе передней дверцы Azure уровня "Стандартный" или "Премиум". Журналы содержат сведения о том, что и когда операция записи была выполнена в передней дверце Azure. 

> [!NOTE]
> Журналы действий не включают операции GET. Они также не включают операции, выполняемые с помощью портал Azure или исходного API управления. 

Доступ к журналам действий осуществляется на передней дверце или во всех журналах ресурсов Azure в Azure Monitor.

Чтобы просмотреть журналы действий, сделайте следующее:

1. Выберите профиль передней дверцы.

1. Выберите **Журнал действий.**

1. Выберите область фильтрации и нажмите кнопку **Применить**.

## <a name="next-steps"></a>Дальнейшие действия

- Сведения о [предварительных и высокодоступных отчетах для передней дверцы Azure](how-to-reports.md).
- Сведения о [метриках мониторинга в режиме реального времени для передней дверцы Azure (Предварительная версия)](how-to-monitor-metrics.md).
