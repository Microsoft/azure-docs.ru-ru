---
title: Мониторинг метрик и журналов в передней дверце Azure | Документация Майкрософт
description: В этой статье описываются различные показатели и журналы доступа, поддерживаемые интерфейсом передней дверцы Azure.
services: frontdoor
documentationcenter: ''
author: duongau
ms.service: frontdoor
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 11/23/2020
ms.author: yuajia
ms.openlocfilehash: d1f3e59cc88ea9cb30e7eacbd26591e08d71be61
ms.sourcegitcommit: e559daa1f7115d703bfa1b87da1cf267bf6ae9e8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/17/2021
ms.locfileid: "100575254"
---
# <a name="monitoring-metrics-and-logs-in-azure-front-door"></a>Мониторинг метрик и журналов в передней дверце Azure

С помощью передней дверцы Azure можно отслеживать ресурсы следующими способами.

- **Метрики**. В настоящее время Передняя дверца Azure имеет восемь метрик для просмотра счетчиков производительности.
- **Журналы**. Журналы действий и диагностики позволяют сохранять и использовать данные о производительности, доступе и других данных в ресурсе для мониторинга.

### <a name="metrics"></a>Метрики

Метрики — это функция для некоторых ресурсов Azure, позволяющая просматривать счетчики производительности на портале. Ниже перечислены доступные метрики передней дверцы.

| Метрика | Отображаемое имя метрики | Unit | Измерения | Описание |
| --- | --- | --- | --- | --- |
| RequestCount | Число запросов | Count | HttpStatus</br>HttpStatusGroup</br>ClientRegion</br>ClientCountry | Число клиентских запросов, обслуженных службой Front Door.  |
| RequestSize | Размер запроса | Байты | HttpStatus</br>HttpStatusGroup</br>ClientRegion</br>ClientCountry | Число байт, отправленных в качестве запросов от клиентов в службу Front Door. |
| ResponseSize | Размер ответа | Байты | HttpStatus</br>HttpStatusGroup</br>ClientRegion</br>ClientCountry | Число байт, отправленных клиентам в качестве ответов из службы Front Door. |
| TotalLatency | Total Latency (Общая задержка) | Миллисекунды | HttpStatus</br>HttpStatusGroup</br>ClientRegion</br>ClientCountry | Общее время от запроса клиента, полученного с помощью передней дверцы, до последнего байта ответа, отправленного из АФД на клиент. |
| BackendRequestCount | Число запросов к серверному компоненту | Count | HttpStatus</br>HttpStatusGroup</br>Серверная часть | Число запросов, отправленных из службы Front Door к серверным частям. |
| BackendRequestLatency | Backend Request Latency (Задержка запросов к серверным частям) | Миллисекунды | Серверная часть | Время с момента отправки запроса службой Front Door к серверной части до получения Front Door последнего байта ответа от серверной части. |
| BackendHealthPercentage | Работоспособность серверного компонента (в процентах) | Процент | Серверная часть</br>BackendPool | Процент успешных проб работоспособности от службы Front Door к серверным частям. |
| WebApplicationFirewallRequestCount | Web Application Firewall Request Count (Число запросов к брандмауэру веб-приложения) | Count | PolicyName</br>RuleName</br>Действие | Количество клиентских запросов, обрабатываемых механизмом безопасности на прикладном уровне службы Front Door. |

## <a name="activity-logs"></a><a name="activity-log"></a>Журналы действий

Журналы действий содержат сведения об операциях, выполняемых на передней дверце. Они также определяют, что и когда для любых операций записи (размещение, публикация или удаление), сделанных на передней дверце.

>[!NOTE]
>Журналы действий не включают операции чтения (Get). Они также не включают операции, выполняемые с помощью портал Azure или исходного API управления.

Доступ к журналам действий осуществляется на передней дверце или во всех журналах ресурсов Azure в Azure Monitor. Чтобы просмотреть журналы действий, сделайте следующее:

1. Выберите экземпляр передней дверцы.
2. Выберите **Журнал действий**.

    :::image type="content" source="./media/front-door-diagnostics/activity-log.png" alt-text="Журнал действий":::

3. Выберите область фильтрации и нажмите кнопку **Применить**.

## <a name="diagnostic-logs"></a><a name="diagnostic-logging"></a>Журналы диагностики
Журналы диагностики содержат подробные сведения об операциях и ошибках, которые важны для аудита и устранения неполадок. Журналы диагностики отличаются от журналов действий.

Журналы действий предоставляют подробные сведения об операциях, выполняемых в ресурсах Azure. Журналы диагностики позволяют получить представление об операциях, выполненных ресурсом. Дополнительные сведения см. в разделе [Azure Monitor журналов диагностики](../azure-monitor/essentials/platform-logs-overview.md).

:::image type="content" source="./media/front-door-diagnostics/diagnostic-log.png" alt-text="Журналы диагностики":::

Чтобы настроить журналы диагностики для передней дверцы, сделайте следующее:

1. Выберите свою переднюю дверцу Azure.

2. Выберите **параметры диагностики**.

3. Выберите **Включить диагностику**. Архивация журналов диагностики вместе с метриками в учетную запись хранения, потоковая передача в концентратор событий или отправка в журналы Azure Monitor.

В настоящее время Передняя дверца предоставляет журналы диагностики (в пакетном режиме каждый час). Журналы диагностики предоставляют отдельные запросы API с каждой записью, имеющей следующую схему:

| Свойство  | Описание |
| ------------- | ------------- |
| баккендхостнаме | Если запрос перенаправляется на серверную часть, это поле представляет имя узла внутреннего сервера. Это поле будет пустым, если запрос перенаправляется или перенаправляется в Региональный кэш (если для правила маршрутизации включено кэширование). |
| качестатус | В сценариях кэширования это поле определяет попадание или промахи кэша на POP |
| ClientIp | IP-адрес отправившего запрос клиента. Если в запросе был указан заголовок X-Forwardd-for, то IP-адрес клиента выбирается из этого же. |
| клиентпорт | IP-порт клиента, который сделал запрос. |
| HttpMethod | Метод HTTP, используемый для запроса. |
| HttpStatusCode | Код состояния HTTP, полученный от прокси-сервера. |
| HttpStatusDetails | Итоговое состояние запроса. Пояснения к этому строковому значению есть в ссылочной таблице "Состояние". |
| HttpVersion | Тип запроса или подключения. |
| POP | Короткое имя края, где был выданный запрос. |
| RequestBytes | Размер сообщения с HTTP-запросом в байтах, включая заголовки и текст запроса. |
| RequestUri | URI полученного запроса. |
| ResponseBytes | Количество байтов, отправленных внутренним сервером в качестве ответа.  |
| раутингруленаме | Имя правила маршрутизации, которому соответствует запрос. |
| рулесенгинематчнамес | Имена правил, соответствующих запросу. |
| SecurityProtocol | Версия протокола TLS/SSL, которая использовалась в запросе. Содержит значение NULL, если шифрование не использовалось. |
| сенттуригиншиелд </br> (не рекомендуется) * **Дополнительные сведения см. в разделе Примечания об устаревании.**| Если установлено значение true, значит, ответ на запрос был получен из кэша защиты источника, а не из граничной точки присутствия. Защитой источника называется родительский кэш, который предназначен для повышения коэффициента попаданий в кэш. |
| исрецеиведфромклиент | Если значение — true, это означает, что запрос поступил от клиента. Если значение равно false, запрос является пропуском ребра (дочернего окна) и ответ получен от экранирования источника (родительский элемент POP). |
| TimeTaken | Время в секундах с первого байта запроса в переднюю дверь до последнего байта ответа. |
| TrackingReference | Это уникальная эталонная строка, которая идентифицирует обслуженный Front Door запрос. Она же отправляется клиенту в заголовке X-Azure-Ref. Эта строка нужна для поиска в журналах доступа сведений о конкретном запросе. |
| UserAgent | Тип браузера, используемый клиентом. |
| ErrorInfo | Это поле содержит сведения об ошибке конкретного типа для дальнейшего устранения неполадок. </br> Ниже перечислены возможные значения. </br> **Ошибка**: указывает, что ошибка не найдена. </br> **Цертификатиррор**: ошибка УНИВЕРСАЛЬНого SSL-сертификата.</br> **Цертификатенамечеккфаилед**: имя узла в SSL-сертификате недопустимо или не совпадает. </br> **Клиентдисконнектед**: сбой запроса из-за сетевого подключения клиента. </br> **УнспеЦифиедклиентеррор**: Общая ошибка клиента. </br> **Инвалидрекуест**: недопустимый запрос. Это может произойти из-за неверно сформированного заголовка, текста и URL. </br> **Днсфаилуре**: сбой DNS. </br> **Днснаменотресолвед**: не удалось разрешить имя или адрес сервера. </br> **Оригинконнектионабортед**: соединение с источником было внезапно остановлено. </br> **Оригинконнектионеррор**: Ошибка универсального соединения с источником. </br> **Оригинконнектионрефусед**: не удалось установить подключение к источнику. </br> **Оригинеррор**: ошибка общего источника. </br> **Оригининвалидреспонсе**: источник вернул недопустимый или нераспознанный ответ. </br> **Оригинтимеаут**: истек период ожидания для запроса источника. </br> **Респонсехеадертубиг**: источник вернул слишком большой заголовок ответа. </br> **Рестриктедип**: запрос заблокирован в связи с ограниченным IP-адресом. </br> **Сслхандшакиррор**: не удалось установить соединение с исходным кодом из-за сбоя SSL встряхните. </br> **УнспеЦифиедеррор**: произошла ошибка, которая не помещается ни в одной из ошибок в таблице. |

### <a name="sent-to-origin-shield-deprecation"></a>Нерекомендуемая отправка на исходную панель
Необработанное свойство журнала **иссенттуригиншиелд** является устаревшим и заменено новым полем **исрецеиведфромклиент**. Используйте новое поле, если вы уже используете устаревшее поле. 

Необработанные журналы включают журналы, созданные из границы CDN (дочернего окна) и точки источника. Точка происхождения ссылается на родительские узлы, которые стратегически расположены по всему миру. Эти узлы обмениваются данными с исходными серверами и снижают нагрузку на источник данных. 

Для каждого запроса, который перемещается в точку происхождения, существуют две записи журнала:

* Один для граничных узлов
* Один для источника щита. 

Чтобы отличить исходящие или отклики от пограничных узлов против экранирования, можно использовать поле **исрецеиведфромклиент** для получения правильных данных. 

Если значение равно false, то это означает, что запрос ответил от точки защиты источника к граничным узлам. Этот подход эффективен для сравнения необработанных журналов с данными о выставлении счетов. Плата не взимается за исходящий трафик с точки пограничной защиты на граничные узлы. Плата взимается за исходящий трафик от граничных узлов к клиентам. 

**Пример запроса Kusto для исключения журналов, созданных на исходном щита в Log Analytics.**

`AzureDiagnostics 
| where Category == "FrontdoorAccessLog" and isReceivedFromClient_b == true`

> [!NOTE]
> Для различных конфигураций маршрутизации и поведений трафика некоторые поля, такие как Баккендхостнаме, Качестатус, Исрецеиведфромклиент и POP, могут реагировать на различные значения. В приведенной ниже таблице описаны различные значения этих полей для различных сценариев.

| Сценарии | Число записей в журнале | POP | баккендхостнаме | исрецеиведфромклиент | качестатус |
| ------------- | ------------- | ------------- | ------------- | ------------- | ------------- |
| Правило маршрутизации без включенного кэширования | 1 | Код POP пограничных точек | Серверная часть, где был перенаправлен запрос | Верно | CONFIG_NOCACHE |
| Правило маршрутизации с включенным кэшированием. Попадание в кэш в точке подключения на границе | 1 | Код POP пограничных точек | Empty | Верно | ПРОИЗВОДИТСЯ |
| Правило маршрутизации с включенным кэшированием. Промахи кэша в POP пограничных окон, но попадания в кэш во всплывающем окне родительского кэша | 2 | 1. пограничных точек кода</br>2. код POP родительского кэша | 1. имя узла POP родительского кэша</br>2. пусто | 1. true</br>2. false | 1. ПРОМАХ</br>2. ПОПАДАНИЕ |
| Правило маршрутизации с включенным кэшированием. Промахи кэша при переходе на пограничные точки, но при нажатии неполного кэша в точке присутствия родительского кэша | 2 | 1. пограничных точек кода</br>2. код POP родительского кэша | 1. имя узла POP родительского кэша</br>2. Серверная часть, помогающая заполнять кэш | 1. true</br>2. false | 1. ПРОМАХ</br>2. PARTIAL_HIT |
| Правило маршрутизации с включенным кэшированием. Кэширование PARTIAL_HIT в пограничных POP, но попадание в кэш во всплывающем окне родительского кэша | 2 | 1. пограничных точек кода</br>2. код POP родительского кэша | 1. пограничных точек кода</br>2. код POP родительского кэша | 1. true</br>2. false | 1. PARTIAL_HIT</br>2. ПОПАДАНИЕ |
| Правило маршрутизации с включенным кэшированием. Промахи кэша в выпуске граничных и родительских кэшей | 2 | 1. пограничных точек кода</br>2. код POP родительского кэша | 1. пограничных точек кода</br>2. код POP родительского кэша | 1. true</br>2. false | 1. ПРОМАХ</br>2. ПРОМАХИ |

> [!NOTE]
> Для сценариев кэширования значение состояния кэша будет partial_hit, когда некоторые байты для запроса будут доставлены из внешнего периметра или кэша экранирования, а некоторые байты будут доставлены из источника для больших объектов.

Front Door использует метод фрагментирования объекта. Когда запрашивается большой файл, передняя дверца получает небольшие фрагменты файла из источника. После того как сервер POP переднего плана получает полный или байтовый диапазон запрошенного файла, сервер переднего плана запрашивает файл из источника в виде фрагментов по 8 МБ.

После того как блок поступает на передний план, он кэшируется и немедленно отправляется пользователю. Затем передняя дверца предварительно выбирает следующий фрагмент в параллельном режиме. Такая предварительная выборка гарантирует, что содержимое остается в одном фрагменте вперед от пользователя, что сокращает задержку. Этот процесс выполняется до тех пор, пока не будет загружен весь файл (при запросе), все диапазоны байтов будут доступны (при запросе) или Клиент закроет соединение. Дополнительные сведения о запросе диапазона байт см. в разделе RFC 7233. Передняя дверца кэширует все блоки по мере их получения. Весь файл не должен кэшироваться в кэше передней дверцы. Запросы на файлы или диапазоны байтов обслуживаются из кэша передней дверцы. Если не все блоки кэшируются на передней дверце, для запроса блоков из источника используется предварительная выборка. В основе этой оптимизации лежит поддержка запросов диапазонов байт сервером-источником. Если сервер-источник не поддерживает запросы диапазонов байт, эта оптимизация будет неэффективной.

## <a name="next-steps"></a>Дальнейшие шаги

- [Создание профиля Front Door](quickstart-create-front-door.md)
- [Принцип работы передней дверцы](front-door-routing-architecture.md)
