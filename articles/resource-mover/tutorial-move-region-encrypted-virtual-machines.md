---
title: Перемещение зашифрованных виртуальных машин Azure между регионами с помощью Azure Resource Mover
description: Сведения о перемещении зашифрованных виртуальных машин Azure в другой регион с помощью Azure Resource Mover
manager: evansma
author: rayne-wiselman
ms.service: resource-move
ms.topic: tutorial
ms.date: 02/10/2021
ms.author: raynew
ms.custom: mvc
ms.openlocfilehash: 014b4d09a991ae4d0bb31ec0b9adee0c9e3b3553
ms.sourcegitcommit: f28ebb95ae9aaaff3f87d8388a09b41e0b3445b5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/29/2021
ms.locfileid: "100361015"
---
# <a name="tutorial-move-encrypted-azure-vms-across-regions"></a>Руководство по перемещению зашифрованных виртуальных машин Azure между регионами

Из этой статьи вы узнаете, как перемещать зашифрованные виртуальные машины Azure в другой регион Azure с помощью [Azure Resource Mover](overview.md). Под шифрованием мы подразумеваем следующее.

- Виртуальные машины с дисками, для которых настроено шифрование дисков Azure. [Дополнительные сведения](../virtual-machines/windows/disk-encryption-portal-quickstart.md)
- Или виртуальные машины, которые используют для шифрования неактивных данных (шифрование на стороне сервера) ключи, управляемые клиентом (CMK). [Дополнительные сведения](../virtual-machines/disks-enable-customer-managed-keys-portal.md)


В этом руководстве описано следующее:

> [!div class="checklist"]
> * Проверка предварительных требований. 
> * Копирование ключей и секретов из хранилища ключей исходного региона в хранилище ключей целевого региона для виртуальных машин с настроенным шифрованием дисков Azure.
> * Подготовка виртуальных машин к перемещению и выбор ресурсов в исходном регионе, которые нужно переместить.
> * Разрешение зависимостей ресурсов.
> * Назначение целевого хранилища ключей вручную для виртуальных машин с настроенным шифрованием дисков Azure. Ручное назначение набора шифрования дисков в целевом регионе для виртуальных машин, применяющих шифрование на стороне сервера с использованием ключей, управляемых клиентом.
> * Перемещение хранилища ключей или набора шифрования дисков.
> * Подготовка и перемещение исходной группы ресурсов. 
> * Подготовка и перемещение остальных ресурсов.
> * Отмена и фиксация перемещения. 
> * Удаление ресурсов в исходном регионе после перемещения (при необходимости).

> [!NOTE]
> В учебниках показан самый быстрый способ выполнения сценария и используются параметры по умолчанию. 

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/pricing/free-trial/), прежде чем начинать работу. Затем войдите на [портал Azure](https://portal.azure.com).

## <a name="prerequisites"></a>Предварительные требования

**Требование** |**Сведения**
--- | ---
**Права доступа к подпискам** | Убедитесь, что у вас есть доступ *владельца* в подписке, содержащей ресурсы, которые вы хотите переместить.<br/><br/> **Зачем мне нужен доступ владельца?** При первом добавлении ресурса для определенной пары источника и назначения в подписке Azure Resource Mover создает [управляемое удостоверение, назначаемое системой](../active-directory/managed-identities-azure-resources/overview.md#managed-identity-types) (ранее известное как управляемая службой идентификация (MSI)), которая является доверенной для подписки. Чтобы создать идентификатор и назначить ему требуемую роль (участника и администратора доступа пользователя в исходной подписке), для учетной записи, используемой для добавления ресурсов, требуются разрешения *владельца* в подписке. [Дополнительные сведения](../role-based-access-control/rbac-and-directory-admin-roles.md#azure-roles) о ролях Azure.
**Поддержка виртуальных машин** | Убедитесь, что виртуальные машины, которые требуется переместить, поддерживаются.<br/><br/> - [Убедитесь](support-matrix-move-region-azure-vm.md#windows-vm-support) в наличии поддерживаемых виртуальных машин Windows.<br/><br/> - [Убедитесь](support-matrix-move-region-azure-vm.md#linux-vm-support) в наличии поддерживаемых виртуальных машин Linux и версий ядра.<br/><br/> - Убедитесь, что параметры [вычислений](support-matrix-move-region-azure-vm.md#supported-vm-compute-settings), [хранилища](support-matrix-move-region-azure-vm.md#supported-vm-storage-settings) и [сети](support-matrix-move-region-azure-vm.md#supported-vm-networking-settings) являются поддерживаемыми.
**Требования к хранилищу ключей (шифрование дисков Azure)** | Если для виртуальных машин включено шифрование дисков Azure, помимо хранилища ключей в исходном регионе, вам потребуется хранилище ключей в целевом регионе. [Создайте хранилище ключей](../key-vault/general/quick-create-portal.md).<br/><br/> Для хранилищ ключей в исходном и целевом регионах необходимы следующие разрешения:<br/><br/> – Разрешения ключей: операции управления ключами (получение, перечисление); операции шифрования (расшифровка и шифрование).<br/><br/> – Разрешения секретов: операции управления секретами (получение, перечисление и настройка).<br/><br/> – Сертификаты (перечисление и получение).
**Набор шифрования дисков (шифрование на стороне сервера с помощью ключа, управляемого клиентом)** | Если вы используете виртуальные машины с шифрованием на стороне сервера при помощи ключа, управляемого клиентом, набор шифрования дисков понадобится не только в исходном регионе, но и в целевом. [Создайте набор шифрования дисков](../virtual-machines/disks-enable-customer-managed-keys-portal.md#set-up-your-disk-encryption-set).<br/><br/> Перемещение между регионами не будет поддерживаться, если вы используете для ключей, управляемых клиентом, ключи HSM.
**Квота целевого региона** | Подписке требуется достаточный объем квот, чтобы создать ресурсы, перемещаемые в целевой регион. Если квота отсутствует, [запросите дополнительные ресурсы](../azure-resource-manager/management/azure-subscription-service-limits.md).
**Расходы на целевой регион** | Проверьте цены в целевом регионе, в который вы перемещаете виртуальные машины. Оцените затраты с помощью [калькулятора цен](https://azure.microsoft.com/pricing/calculator/).


## <a name="verify-user-permissions-on-key-vault-for-vms-using-azure-disk-encryption-ade"></a>Проверка разрешений пользователя в хранилище ключей для виртуальных машин с помощью Шифрования дисков Azure (ADE)

Если вы перемещаете виртуальные машины с включенным шифрованием дисков Azure, необходимо выполнить сценарий, как указано [ниже](#copy-the-keys-to-the-destination-key-vault). Пользователь, выполняющий сценарий, должен иметь соответствующие разрешения. Дополнительные сведения о необходимых разрешениях см. в таблице ниже. Параметры для изменения разрешений находятся в хранилище ключей на портале Azure в разделе **Параметры** > **Политики доступа**.

:::image type="content" source="./media/tutorial-move-region-encrypted-virtual-machines/key-vault-access-policies.png" alt-text="Экран &quot;Кнопка, нажав которую можно открыть политики доступа для хранилища ключей&quot;." lightbox="./media/tutorial-move-region-encrypted-virtual-machines/key-vault-access-policies.png":::

Если разрешения пользователя отсутствуют, выберите **Добавление политики доступа** и укажите разрешения. Если в учетной записи пользователя уже указана политика, задайте разрешения в разделе **Пользователь** в соответствии с данными в таблице ниже.

Виртуальные машины Azure, использующие ADE, могут иметь описанные ниже вариации. Разрешения для необходимых компонентов должны быть настроены соответствующим образом.
- Параметр по умолчанию, при котором диск шифруется только с использованием секретов.
- Дополнительная защита благодаря [ключу шифрования ключей](../virtual-machines/windows/disk-encryption-key-vault.md#set-up-a-key-encryption-key-kek).

### <a name="source-region-keyvault"></a>Хранилище ключей в исходном регионе

Следующие разрешения необходимо установить для пользователя, который выполняет сценарий. 

**Компонент** | **Необходимое разрешение**
--- | ---
Секреты|  Разрешение на получение <br> </br> В меню **Разрешения секретов**>  **Операции управления секретами** выберите **Получить**. 
Ключи <br> </br> Если вы используете ключ шифрования ключей (KEK), помимо секретов вам также потребуется это разрешение.| Разрешения на получение и расшифровку <br> </br> В меню **Разрешения ключей** > **Операции управления ключами** выберите **Получить**. В меню **Операции шифрования** выберите **Расшифровать**.

### <a name="destination-region-keyvault"></a>Хранилище ключей в целевом регионе

Убедитесь, что на вкладке **Политики доступа** настроен параметр **Шифрование дисков Azure для шифрования томов**. 

Следующие разрешения необходимо установить для пользователя, который выполняет сценарий. 

**Компонент** | **Необходимое разрешение**
--- | ---
Секреты|  Разрешение на настройку <br> </br> В меню **Разрешения секретов**>  **Операции управления секретами** выберите **Настроить**. 
Ключи <br> </br> Если вы используете ключ шифрования ключей (KEK), помимо секретов вам также потребуется это разрешение.| Разрешения на получение, создание и шифрование <br> </br> В меню **Разрешения ключей** > **Операции управления ключами** выберите **Получить** и **Создать**. В меню **Операции шифрования** выберите **Шифровать**.

Помимо указанных выше разрешений, в целевом хранилище ключей необходимо добавить разрешения для [удостоверения управляемой системы](./common-questions.md#how-is-managed-identity-used-in-resource-mover), которое использует Resource Mover для доступа к ресурсам Azure от вашего имени. 

1. В разделе **Параметры** выберите **Add Access policies** (Добавить политики доступа). 
2. В разделе **Выбор субъекта** найдите MSI. Имя MSI — ```movecollection-<sourceregion>-<target-region>-<metadata-region>```. 
3. Добавьте указанные ниже разрешения для MSI.

**Компонент** | **Необходимое разрешение**
--- | ---
Секреты|  Разрешение на получение и вывод списка <br> </br> В меню **Разрешения секретов**>  **Операции управления секретами** выберите **Получить** и **Вывод**. 
Ключи <br> </br> Если вы используете ключ шифрования ключей (KEK), помимо секретов вам также потребуется это разрешение.| Разрешения на получение и вывод списка <br> </br> В меню **Разрешения ключей** > **Операции управления ключами** выберите **Получить** и **Вывод**.



### <a name="copy-the-keys-to-the-destination-key-vault"></a>Копирование ключей в целевое хранилище ключей

Теперь вам нужно скопировать секреты и ключи шифрования из исходного хранилища ключей в целевое с помощью предоставленного нами сценария.

- Сценарий нужно выполнять в PowerShell. Мы рекомендуем использовать последнюю версию PowerShell.
- В частности, для сценария требуются следующие модули:
    - Az.Compute
    - Az.KeyVault (версия 3.0.0)
    - Az.Accounts (версия 2.2.3)

Выполните следующую команду.

1. Перейдите к [сценарию](https://raw.githubusercontent.com/AsrOneSdk/published-scripts/master/CopyKeys/CopyKeys.ps1) на GitHub.
2. Скопируйте содержимое сценария в локальный файл и назовите его *Copy-keys.ps1*.
3. Выполните скрипт.
4. Войдите в Azure.
5. Во всплывающем окне **Ввод данных пользователем** выберите исходную подписку, группу ресурсов и исходную виртуальную машину. Затем выберите целевое расположение и целевое хранилище для шифрования диска и ключа.

    :::image type="content" source="./media/tutorial-move-region-encrypted-virtual-machines/script-input.png" alt-text="Экран &quot;Всплывающее окно для ввода значений сценария&quot;." :::


6. После завершения выполнения сценария выходные данные на экране укажут на успешное выполнение сценария CopyKeys.

## <a name="prepare-vms"></a>Подготовка виртуальных машин

1. [Проверив соответствие виртуальных машин требованиям](#prerequisites), убедитесь, что виртуальные машины, которые нужно переместить, включены. Все диски виртуальных машин, которые должны быть доступны в целевом регионе, должны быть подключены и инициализированы на виртуальной машине.
3. Убедитесь, что на виртуальных машинах установлены последние версии доверенных корневых сертификатов и обновленный список отзыва сертификатов (CRL). Для этого выполните следующие действия.
    - На виртуальных машинах Windows установите последние обновления Windows.
    - На виртуальных машинах Linux следуйте инструкциям поставщика, чтобы обеспечить наличие последней версии сертификатов и списка отзыва сертификатов на компьютерах. 
4. Разрешите исходящие подключения с виртуальных машин следующим образом.
    - При использовании прокси-сервера или брандмауэра на основе URL-адресов для управления исходящими подключениями разрешите использование этих [URL-адресов](support-matrix-move-region-azure-vm.md#url-access):
    - Если вы используете правила группы безопасности сети (NSG) для управления исходящими подключениями, создайте [правила тегов службы](support-matrix-move-region-azure-vm.md#nsg-rules).

## <a name="select-resources-to-move"></a>Выбор ресурсов для перемещения


- Вы можете выбрать любой поддерживаемый тип ресурса в любой из групп ресурсов выбранного исходного региона.  
- Ресурсы перемещаются в целевой регион в той же подписке, в которой расположен исходный регион. Если требуется изменить подписку, это можно сделать после перемещения ресурсов.

Выберите ресурсы следующим образом.

1. На портале Azure найдите и выберите *средство перемещения ресурсов*. Затем в разделе **Службы** выберите **Azure Resource Mover**.

    :::image type="content" source="./media/tutorial-move-region-encrypted-virtual-machines/search.png" alt-text="Экран &quot;Результаты поиска средства перемещения ресурсов на портале Azure&quot;." :::

2. В разделе **Обзор** щелкните **Перемещение между регионами**.

    :::image type="content" source="./media/tutorial-move-region-encrypted-virtual-machines/move-across-regions.png" alt-text="Экран &quot;Кнопка добавления ресурсов для перемещения в другой регион&quot;." lightbox="./media/tutorial-move-region-encrypted-virtual-machines/move-across-regions.png":::

3. В разделе **Перемещение ресурсов** > **Источник и назначение** выберите исходную подписку и регион.
4. В разделе **Назначение** выберите регион, в который необходимо переместить виртуальные машины. Затем нажмите кнопку **Далее**.

    :::image type="content" source="./media/tutorial-move-region-encrypted-virtual-machines/source-target.png" alt-text="Экран &quot;Страница для выбора исходного и целевого регионов&quot;." :::

5. В разделе **Перемещаемые ресурсы** выберите **Выбор ресурсов**.

    :::image type="content" source="./media/tutorial-move-region-encrypted-virtual-machines/select-resources.png" alt-text="Экран &quot;Кнопка, нажатие которой позволяет выбрать ресурс для перемещения&quot;." :::

6. В разделе **Выбор ресурсов** выберите виртуальные машины. Вы можете добавить только [ресурсы, поддерживаемые для перемещения](#prepare-vms). Затем нажмите кнопку **Done**(Готово).

    :::image type="content" source="./media/tutorial-move-region-encrypted-virtual-machines/select-vm.png" alt-text="Экран &quot;Страница выбора виртуальных машин для перемещения&quot;." :::

    > [!NOTE]
    >  В этом учебнике мы выбираем виртуальную машину, которая использует шифрование на стороне сервера (rayne-vm) с ключом, управляемым клиентом, и виртуальную машину с включенным шифрованием диска (rayne-vm-ade).

7.  В разделе **Перемещаемые ресурсы** нажмите кнопку **Далее**.
8. В разделе **Просмотр** проверьте параметры источника и назначения. 

    :::image type="content" source="./media/tutorial-move-region-encrypted-virtual-machines/review.png" alt-text="Экран &quot;Страница просмотра параметров и сведений о выполнении перемещения&quot;." :::

9. Нажмите кнопку **Продолжить**, чтобы приступить к добавлению ресурсов.
10. Щелкните значок уведомления, чтобы отслеживать ход выполнения. После успешного завершения процесса добавления в области уведомления выберите **Added resources for move** (Добавленные ресурсы для перемещения).

    :::image type="content" source="./media/tutorial-move-region-encrypted-virtual-machines/added-resources-notification.png" alt-text="Экран &quot;Уведомление об успешном добавлении ресурсов&quot;." lightbox="./media/tutorial-move-region-encrypted-virtual-machines/added-resources-notification.png":::
    
    
11. Щелкнув уведомление, изучите ресурсы на странице **Across regions** (Между регионами).

    :::image type="content" source="./media/tutorial-move-region-encrypted-virtual-machines/resources-prepare-pending.png" alt-text="Экран &quot;Страницы, отображающие добавленные ресурсы, ожидающие подготовки&quot;." :::

> [!NOTE]
> - Добавляемые ресурсы переводятся в состояние *Prepare pending* (Ожидание подготовки).
> - Группа ресурсов для виртуальных машин будет добавлена автоматически.
> - Если изменить записи **конфигурации назначения**, чтобы использовать ресурс, который уже существует в целевом регионе, состояние ресурса будет изменено на *Commit pending* (Ожидание фиксации), поскольку для него не нужно инициировать перемещение.
> - Если вам нужно удалить добавленный ресурс, необходимые действия зависят от того, где происходит процесс перемещения. [Подробнее](remove-move-resources.md).


## <a name="resolve-dependencies"></a>Устранение ошибок, связанных с зависимостями

1. Если для любого ресурса отображается сообщение *Проверить зависимости* в столбце **Проблемы**, нажмите кнопку **Проверить зависимости**.

    :::image type="content" source="./media/tutorial-move-region-encrypted-virtual-machines/check-dependencies.png" alt-text="Экран &quot;Кнопка для проверки зависимостей&quot;." lightbox="./media/tutorial-move-region-encrypted-virtual-machines/check-dependencies.png":::

    Начнется процесс проверки.
2. Если зависимости обнаружены, выберите **Добавить зависимости**  

    :::image type="content" source="./media/tutorial-move-region-encrypted-virtual-machines/add-dependencies.png" alt-text="Экран &quot;Кнопка добавления зависимостей&quot;." lightbox="./media/tutorial-move-region-encrypted-virtual-machines/add-dependencies.png":::


3. В разделе **Добавить зависимости** оставьте параметр по умолчанию **Показать все зависимости**.

    - Параметр **Показать все зависимости** выполняет итерацию по всем прямым и косвенным зависимостям ресурса. Например, для виртуальной машины выбор этого параметра приведет к отображению сетевой карты, виртуальной сети, групп безопасности сети (NSG) и т. д.
    - Выбор параметра **Show first level dependencies only** (Показывать только зависимости первого уровня) приводит к отображению только прямых зависимостей. Например, для виртуальной машины будет отображаться сетевая карта, но не виртуальная сеть.
 
4. Выберите зависимые ресурсы, которые нужно добавить > **Добавить зависимости**.

    :::image type="content" source="./media/tutorial-move-region-encrypted-virtual-machines/select-dependencies.png" alt-text="Экран &quot;Выбор зависимостей из списка зависимостей&quot;." lightbox="./media/tutorial-move-region-encrypted-virtual-machines/select-dependencies.png":::

5. Снова проверьте зависимости. 

    :::image type="content" source="./media/tutorial-move-region-encrypted-virtual-machines/validate-again.png" alt-text="Экран &quot;Страница для повторной проверки&quot;." lightbox="./media/tutorial-move-region-encrypted-virtual-machines/validate-again.png":::

## <a name="assign-destination-resources"></a>Назначение целевых ресурсов

Целевые ресурсы, связанные с шифрованием, нужно назначать вручную.

- При перемещении виртуальной машины с шифрованием дисков Azure (ADE) хранилище ключей в целевом регионе будет отображаться как зависимость.
- При перемещении виртуальной машины с шифрованием на стороне сервера, которое использует ключи, управляемые клиентом (CMK), набор шифрования дисков в целевом регионе отобразится как зависимость. 
- Поскольку в этом учебнике приведены сведения о перемещении виртуальной машины с настроенным шифрованием дисков Azure и виртуальной машины, использующей ключ, управляемый клиентом, как зависимости будут отображаться как целевое хранилище ключей, так и набор шифрования дисков.

Выполните назначение вручную следующим образом:

1. В записи набора шифрования диска выберите в столбце **Конфигурация назначения** пункт **Resource not assigned** (Неназначенный ресурс).
2. В меню **Параметры конфигурации** выберите целевой набор шифрования дисков. Затем щелкните **Сохранить изменения**.
3. Вы либо можете сохранить изменения и проверить зависимости изменяемого ресурса, либо можете просто сохранить изменения и проверить все, что вы изменяете, за один раз.

    :::image type="content" source="./media/tutorial-move-region-encrypted-virtual-machines/select-destination-set.png" alt-text="Экран &quot;Страница для выбора набора шифрования диска в целевом регионе&quot;." lightbox="./media/tutorial-move-region-encrypted-virtual-machines/select-destination-set.png":::

    После добавления целевого ресурса набор шифрования диска перейдет в состояние *Commit move pending* (Ожидание фиксации перемещения).
3. В записи хранилища ключей выберите в столбце **Конфигурация назначения** пункт **Resource not assigned** (Неназначенный ресурс). В меню **Параметры конфигурации** выберите целевое хранилище ключей. Сохраните изменения. 

На этом этапе как набор шифрования диска, так и состояние хранилища ключей перейдут в состояние *Commit move pending* (Ожидание фиксации перемещения).

:::image type="content" source="./media/tutorial-move-region-encrypted-virtual-machines/prepare-other-resources.png" alt-text="Экран &quot;Страница выбора подготовки других ресурсов&quot;." lightbox="./media/tutorial-move-region-encrypted-virtual-machines/prepare-other-resources.png":::

Для фиксации и завершения процесса перемещения ресурсов шифрования.

1. В разделе **Across regions** (Между регионами) выберите ресурс (набор шифрования дисков или хранилище ключей) > **Commit move** (Зафиксировать перемещение).
2. В разделе **Перемещение ресурсов** нажмите кнопку **Зафиксировать**.

> [!NOTE]
> После фиксации перемещения ресурс находится в состоянии *Delete source pending* (Ожидание удаления источника).


## <a name="move-the-source-resource-group"></a>Перемещение исходной группы ресурсов 

Прежде чем можно будет подготовить и переместить виртуальные машины, группа ресурсов виртуальной машины должна присутствовать в целевом регионе. 

### <a name="prepare-to-move-the-source-resource-group"></a>Подготовка к перемещению исходной группы ресурсов

Во время подготовки Resource Mover создает шаблоны Azure Resource Manager (ARM), используя параметры группы ресурсов. Ресурсы в группе ресурсов не затрагиваются.

Подготовка выполняется следующим образом.

1. В разделе **Across regions** (Между регионами) выберите исходную группу ресурсов, а затем нажмите кнопку **Подготовить**.

    :::image type="content" source="./media/tutorial-move-region-encrypted-virtual-machines/prepare-resource-group.png" alt-text="Экран &quot;Подготовка группы ресурсов&quot;." lightbox="./media/tutorial-move-region-encrypted-virtual-machines/prepare-resource-group.png":::

2. В разделе **Подготовка ресурсов** нажмите кнопку **Подготовить**.

> [!NOTE]
> После подготовки группы ресурсов она находится в состоянии *ожидания начала перемещения*. 

 
### <a name="move-the-source-resource-group"></a>Перемещение исходной группы ресурсов

Начните перемещение, выполнив следующие действия:

1. В разделе **Across regions** (Между регионами) выберите исходную группу ресурсов, а затем нажмите кнопку **Initiate move** (Начать перемещение).

    :::image type="content" source="./media/tutorial-move-region-encrypted-virtual-machines/initiate-move-resource-group.png" alt-text="Экран &quot;Кнопка для инициирования перемещения&quot;." lightbox="./media/tutorial-move-region-encrypted-virtual-machines/initiate-move-resource-group.png":::

2. В разделе **Перемещение ресурсов** выберите **Initiate move** (Начать перемещение). Группа ресурсов будет иметь состояние *Initiate move in progress* (Начало перемещения).   
3. После начала перемещения создается целевая группа ресурсов на основе созданного шаблона Resource Manager. Исходная группа ресурсов будет иметь состояние *Commit move pending* (Ожидается фиксация перемещения).

    :::image type="content" source="./media/tutorial-move-region-encrypted-virtual-machines/resource-group-commit-move-pending.png" alt-text="Экран &quot;Проверка состояния ожидания фиксации перемещения&quot;." lightbox="./media/tutorial-move-region-encrypted-virtual-machines/resource-group-commit-move-pending.png":::

Чтобы зафиксировать и завершить процесс перемещения, сделайте следующее:

1. В разделе **Across regions** (Между регионами) выберите исходную группу ресурсов, а затем нажмите кнопку **Commit move** (Зафиксировать перемещение).
2. В разделе **Перемещение ресурсов** нажмите кнопку **Зафиксировать**.

> [!NOTE]
> После фиксации перемещения исходная группа ресурсов находится в состоянии *ожидания удаления источника*.

:::image type="content" source="./media/tutorial-move-region-encrypted-virtual-machines/resource-group-delete-move-pending.png" alt-text="Экран &quot;Проверка состояния ожидания удаления перемещения&quot;." lightbox="./media/tutorial-move-region-encrypted-virtual-machines/resource-group-delete-move-pending.png":::

## <a name="prepare-resources-to-move"></a>Добавление ресурсов для перемещения

Теперь, когда ресурсы шифрования и исходная группа ресурсов перемещены, можно подготовиться к перемещению других ресурсов, которые находятся в состоянии *Prepare pending* (Ожидание подготовки).


1. В разделе **Across regions** (Между регионами) выполните повторную проверку и устраните все проблемы.
2. Если необходимо изменить целевые параметры перед началом перемещения, щелкните ссылку в столбце **Destination configuration** (Конфигурация назначения) для ресурса и измените параметры. При изменении параметров целевой виртуальной машины ее размер не должен превышать размер исходной виртуальной машины.
3. Нажмите кнопку **Подготовить** для ресурсов в состоянии *Prepare pending* (Ожидается подготовка), которые нужно переместить.
3. В разделе **Подготовка ресурсов** нажмите кнопку **Подготовить**

    - В процессе подготовки на виртуальных машинах устанавливается агент службы "Мобильность" Azure Site Recovery для репликации.
    - Данные виртуальной машины периодически реплицируются в целевой регион. Это не влияет на исходную виртуальную машину.
    - При перемещении ресурсов создаются шаблоны Resource Manager для других исходных ресурсов.

После подготовки ресурсов они находятся в состоянии *ожидания начала перемещения*.

:::image type="content" source="./media/tutorial-move-region-encrypted-virtual-machines/resources-initiate-move-pending.png" alt-text="Экран &quot;Страница с ресурсами в состоянии ожидания начала перемещения&quot;." lightbox="./media/tutorial-move-region-encrypted-virtual-machines/resources-initiate-move-pending.png":::



## <a name="initiate-the-move"></a>Начало перемещения

Теперь, когда ресурсы подготовлены, можно начать перемещение. 

1. В разделе **Across regions** (Между регионами) выберите ресурсы с состоянием *ожидания начала перемещения*. Затем нажмите кнопку **Initiate move** (Начать перемещение).
2. В разделе **Перемещение ресурсов** нажмите кнопку **Initiate move** (Начать перемещение).
3. Отслеживать ход перемещения можно на панели уведомлений.

    - Реплики виртуальных машин создаются в целевом регионе. Исходная виртуальная машина завершает работу, и возникает некоторое время простоя (обычно несколько минут).
    - Resource Mover воссоздает другие ресурсы с помощью подготовленных шаблонов Resource Manager. Обычно время простоя отсутствует.
    - После перемещения ресурсов они находятся в состоянии *ожидания фиксации перемещения*.

:::image type="content" source="./media/tutorial-move-region-encrypted-virtual-machines/resources-commit-move-pending.png" alt-text="Экран &quot;Страница, на которой показаны ресурсы в состоянии ожидания фиксации перемещения&quot;." lightbox="./media/tutorial-move-region-encrypted-virtual-machines/resources-commit-move-pending.png" :::


## <a name="discard-or-commit"></a>Отмена или фиксация

После первоначального перемещения нужно решить, следует ли фиксировать перемещение или отменить его. 

- **Отмена**. Если вы выполняете тестирование и не хотите фактически перемещать исходный ресурс, вы можете отменить перемещение. При отмене перемещения ресурс возвращается в состояние *ожидания начала перемещения*.
- **Фиксация**. Фиксация завершает перемещение в целевой регион. После фиксации исходный ресурс будет находиться в состоянии *ожидания удаления источника*. Затем вы можете его удалить.


## <a name="discard-the-move"></a>Отмена перемещения 

Вы можете отменить перемещение следующим образом:

1. В разделе **Across regions** (Между регионами) выберите ресурсы с состоянием *ожидания фиксации перемещения* и нажмите кнопку **Discard move** (Отменить перемещение).
2. В разделе **Discard move** (Отмена перемещения) нажмите кнопку **Отменить**.
3. Отслеживать ход перемещения можно на панели уведомлений.


> [!NOTE]
> После отмены перемещения ресурсов виртуальные машины находятся в состоянии *ожидания начала перемещения*.

## <a name="commit-the-move"></a>Фиксация перемещения

Если вы хотите завершить процесс перемещения, зафиксируйте перемещение. 

1. В разделе **Across regions** (Между регионами) выберите ресурсы с состоянием *ожидания фиксации перемещения* и нажмите кнопку **Commit move** (Зафиксировать перемещение).
2. В разделе **Commit resources** (Фиксация ресурсов) нажмите кнопку **Зафиксировать**.

    :::image type="content" source="./media/tutorial-move-region-encrypted-virtual-machines/resources-commit-move.png" alt-text="Экран &quot;Страница фиксации ресурсов для завершения перемещения&quot;." lightbox="./media/tutorial-move-region-encrypted-virtual-machines/resources-commit-move.png" :::

3. Отслеживать ход фиксации можно на панели уведомлений.

> [!NOTE]
> - После фиксации перемещения репликация виртуальных машин останавливается. Фиксация не влияет на исходную виртуальную машину.
> - Фиксация не влияет на исходные сетевые ресурсы.
> - После фиксации перемещения ресурсы находятся в состоянии *ожидания удаления источника*.



## <a name="configure-settings-after-the-move"></a>Настройка параметров после перемещения

- Служба "Мобильность" не удаляется автоматически с виртуальных машин. Удалите ее вручную или оставьте, если планируется повторное перемещение сервера.
- После перемещения измените правила управления доступом Azure на основе ролей (Azure RBAC).

## <a name="delete-source-resources-after-commit"></a>Удаление исходных ресурсов после фиксации

После перемещения при необходимости можно удалить ресурсы в исходном регионе. 

1. В разделе **Across Regions** (Между регионами) выберите все исходные ресурсы, которые нужно удалить. Затем выберите **Удалить источник**.
2. В разделе **Удалить источник** проверьте удаляемый элемент и в поле **Подтверждение удаления** введите **да**. Это действие необратимо, поэтому будьте внимательны при проверке!
3. После ввода **да** выберите **Удалить ресурс**.

> [!NOTE]
>  На портале перемещения ресурсов нельзя удалять группы ресурсов, хранилища ключей или серверы SQL Server. Их нужно удалять по отдельности со страницы свойств каждого ресурса.


## <a name="delete-additional-resources-created-for-move"></a>Удаление дополнительных ресурсов, созданных для перемещения

После перемещения можно вручную удалить коллекцию перемещения и созданные ресурсы Site Recovery.

- Коллекция перемещения по умолчанию скрыта. Чтобы увидеть ее, необходимо включить отображение скрытых ресурсов.
- Хранилище кэша имеет блокировку, которую необходимо убрать, прежде чем его можно будет удалить.

Удаление выполняется следующим образом: 
1. Найдите ресурсы в группе ресурсов ```RegionMoveRG-<sourceregion>-<target-region>```.
2. Убедитесь, что все виртуальные машины и другие исходные ресурсы в исходном регионе перемещены или удалены. Это гарантирует, что у вас отсутствуют ресурсы, ожидающие использования.
2. Удаление ресурсов:

    - Имя перемещаемой коллекции — ```movecollection-<sourceregion>-<target-region>```.
    - Имя учетной записи хранения — ```resmovecache<guid>```.
    - Имя хранилища — ```ResourceMove-<sourceregion>-<target-region>-GUID```.
## <a name="next-steps"></a>Дальнейшие действия

Изучив это руководство, вы:

> [!div class="checklist"]
> * Научились перемещать зашифрованные виртуальные машины Azure и зависимые от них ресурсы в другой регион Azure.


Теперь попробуйте переместить базы данных и эластичные пулы SQL Azure в другой регион.

> [!div class="nextstepaction"]
> [Перемещение ресурсов SQL Azure](./tutorial-move-region-sql.md)
