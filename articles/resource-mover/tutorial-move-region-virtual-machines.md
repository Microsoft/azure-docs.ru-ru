---
title: Перемещение виртуальных машин Azure между регионами с помощью Azure Resource Mover
description: Сведения о перемещении виртуальных машин Azure в другой регион с помощью Azure Resource Mover
manager: evansma
author: rayne-wiselman
ms.service: resource-move
ms.topic: tutorial
ms.date: 02/04/2021
ms.author: raynew
ms.custom: mvc
ms.openlocfilehash: 5712448c8c5248d3c84ce43f8a41c669355f1d43
ms.sourcegitcommit: f28ebb95ae9aaaff3f87d8388a09b41e0b3445b5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/30/2021
ms.locfileid: "102565739"
---
# <a name="tutorial-move-azure-vms-across-regions"></a>Руководство по перемещению виртуальных машин Azure между регионами

Из этой статьи вы узнаете, как перемещать виртуальные машины Azure, связанные ресурсы сети или хранилища в другой регион Azure с помощью [Azure Resource Mover](overview.md).
.


В этом руководстве описано следующее:

> [!div class="checklist"]
> * Проверка предварительных требований.
> * Выбор ресурсов, которые требуется переместить.
> * Разрешение зависимостей ресурсов.
> * Подготовка и перемещение исходной группы ресурсов. 
> * Подготовка и перемещение остальных ресурсов.
> * Отмена и фиксация перемещения. 
> * Удаление ресурсов в исходном регионе после перемещения (при необходимости).

> [!NOTE]
> В учебниках показан самый быстрый способ выполнения сценария и используются параметры по умолчанию. 

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/pricing/free-trial/), прежде чем начинать работу. Затем войдите на [портал Azure](https://portal.azure.com).

## <a name="prerequisites"></a>Предварительные требования
**Требование** | **Описание**
--- | ---
**Поддержка Resource Mover** | [Ознакомьтесь](common-questions.md) с поддерживаемыми регионами и другими распространенными вопросами.
**Права доступа к подпискам** | Убедитесь, что у вас есть доступ *владельца* в подписке, содержащей ресурсы, которые вы хотите переместить<br/><br/> **Зачем мне нужен доступ владельца?** При первом добавлении ресурса для определенной пары источника и назначения в подписке Azure Resource Mover создает [управляемое удостоверение, назначаемое системой](../active-directory/managed-identities-azure-resources/overview.md#managed-identity-types) (ранее известное как управляемая службой идентификация (MSI)), которая является доверенной для подписки. Чтобы создать удостоверение и назначить ему требуемую роль (участника или администратора доступа пользователя в исходной подписке), учетной записи, используемой для добавления ресурсов, требуются разрешения *владельца* в подписке. [Дополнительные сведения](../role-based-access-control/rbac-and-directory-admin-roles.md#azure-roles) о ролях Azure.
**Поддержка виртуальных машин** |  Убедитесь, что виртуальные машины, которые требуется переместить, поддерживаются.<br/><br/> - [Убедитесь](support-matrix-move-region-azure-vm.md#windows-vm-support) в наличии поддерживаемых виртуальных машин Windows.<br/><br/> - [Убедитесь](support-matrix-move-region-azure-vm.md#linux-vm-support) в наличии поддерживаемых виртуальных машин Linux и версий ядра.<br/><br/> - Убедитесь, что параметры [вычислений](support-matrix-move-region-azure-vm.md#supported-vm-compute-settings), [хранилища](support-matrix-move-region-azure-vm.md#supported-vm-storage-settings) и [сети](support-matrix-move-region-azure-vm.md#supported-vm-networking-settings) являются поддерживаемыми.
**Целевая подписка** | Для подписки в целевом регионе требуется достаточный объем квот, чтобы создать ресурсы, перемещаемые в целевой регион. Если квота отсутствует, [запросите дополнительные ресурсы](../azure-resource-manager/management/azure-subscription-service-limits.md).
**Расходы на целевой регион** | Проверьте цены в целевом регионе, в который вы перемещаете виртуальные машины. Оцените затраты с помощью [калькулятора цен](https://azure.microsoft.com/pricing/calculator/).
    

## <a name="prepare-vms"></a>Подготовка виртуальных машин

1. Проверив соответствие виртуальных машин требованиям, убедитесь, что виртуальные машины, которые нужно переместить, включены. Все диски виртуальных машин, которые должны быть доступны в целевом регионе, должны быть подключены и инициализированы на виртуальной машине.
1. Убедитесь, что на виртуальных машинах установлены последние доверенные корневые сертификаты и обновленный список отзыва сертификатов (CRL). Для этого выполните следующие действия.
    - На виртуальных машинах Windows установите последние обновления Windows.
    - На виртуальных машинах Linux следуйте инструкциям поставщика, чтобы обеспечить наличие последней версии сертификатов и списка отзыва сертификатов на компьютерах. 
1. Разрешите исходящие подключения от виртуальных машин:
    - При использовании прокси-сервера или брандмауэра на основе URL-адресов для управления исходящими подключениями разрешите использование этих [URL-адресов](support-matrix-move-region-azure-vm.md#url-access):
    - Если вы используете правила группы безопасности сети (NSG) для управления исходящими подключениями, создайте [правила тегов службы](support-matrix-move-region-azure-vm.md#nsg-rules).

## <a name="select-resources"></a>Выбор ресурсов 

Выберите ресурсы, которые требуется переместить.

- Отображаются все поддерживаемые типы ресурсов в группах ресурсов в выбранном исходном регионе.
- Ресурсы, которые уже были добавлены для перемещения между регионами, не отображаются.
- Ресурсы перемещаются в целевой регион в той же подписке, где расположен исходный регион. Если требуется изменить подписку, это можно сделать после перемещения ресурсов.

1. На портале Azure найдите и выберите *средство перемещения ресурсов*. Затем в разделе **Службы** выберите **Azure Resource Mover**.

    ![Результаты поиска средства перемещения ресурсов на портале Azure](./media/tutorial-move-region-virtual-machines/search.png)

2. В разделе **Обзор** нажмите кнопку **Начало работы**.

    ![Кнопка добавления ресурсов для перемещения в другой регион](./media/tutorial-move-region-virtual-machines/get-started.png)

3. В разделе **Перемещение ресурсов** > **Источник и назначение** выберите исходную подписку и регион.
4. В разделе **Назначение** выберите регион, в который необходимо переместить виртуальные машины. Затем нажмите кнопку **Далее**.

    ![Страница для выбора исходного и целевого региона](./media/tutorial-move-region-virtual-machines/source-target.png)

6. В разделе **Перемещаемые ресурсы** выберите **Выбор ресурсов**.
7. В разделе **Выбор ресурсов** выберите виртуальную машину. Вы можете добавить только [ресурсы, поддерживаемые для перемещения](#prepare-vms). Затем нажмите кнопку **Done**(Готово).

    ![Страница выбора виртуальных машин для перемещения](./media/tutorial-move-region-virtual-machines/select-vm.png)

8.  В разделе **Перемещаемые ресурсы** нажмите кнопку **Далее**.
9. В разделе **Просмотр** проверьте параметры источника и назначения. 

    ![Страница просмотра параметров и сведений о выполнении перемещения](./media/tutorial-move-region-virtual-machines/review.png)
10. Нажмите кнопку **Продолжить**, чтобы приступить к добавлению ресурсов.
11. После успешного завершения процесса добавления в области уведомления выберите **Adding resources for move** (Добавление ресурсов для перемещения).
12. Щелкнув уведомление, изучите ресурсы на странице **Across regions** (Между регионами).

> [!NOTE]
> - Добавленные ресурсы находятся в состоянии *ожидания подготовки*.
> - Группа ресурсов для виртуальных машин будет добавлена автоматически.
> - Если требуется удалить ресурс из перемещаемой коллекции, действия зависят от того, где происходит процесс перемещения. [Подробнее](remove-move-resources.md).

## <a name="resolve-dependencies"></a>Устранение ошибок, связанных с зависимостями

1. Если в списке ресурсов отображается сообщение *Validate dependencies* (Проверить зависимости) в столбце **Проблемы**, нажмите кнопку **Проверить зависимости**. Начнется процесс проверки.
2. Если зависимости обнаружены, выберите **Добавить зависимости**. 
3. В разделе **Добавить зависимости** оставьте параметр по умолчанию **Показать все зависимости**.

    - Параметр "Показать все зависимости" выполняет итерацию по всем прямым и косвенным зависимостям ресурса. Например, для виртуальной машины выбор этого параметра приведет к отображению сетевой карты, виртуальной сети, групп безопасности сети (NSG) и т. д.
    - Выбор параметра Show first level dependencies only (Показывать только зависимости первого уровня) приводит к отображению только прямых зависимостей. Например, для виртуальной машины будет отображаться сетевая карта, но не виртуальная сеть.


4. Выберите зависимые ресурсы, которые нужно добавить > **Добавить зависимости**. Проверьте ход выполнения в области уведомлений.

    ![Добавление зависимостей](./media/tutorial-move-region-virtual-machines/add-dependencies.png)

4. Снова проверьте зависимости. 
    ![Страница для добавления дополнительных зависимостей](./media/tutorial-move-region-virtual-machines/add-additional-dependencies.png)



## <a name="move-the-source-resource-group"></a>Перемещение исходной группы ресурсов 

Прежде чем можно будет подготовить и переместить виртуальные машины, группа ресурсов виртуальной машины должна присутствовать в целевом регионе. 

### <a name="prepare-to-move-the-source-resource-group"></a>Подготовка к перемещению исходной группы ресурсов

Во время подготовки Resource Mover создает шаблоны Azure Resource Manager (ARM), используя параметры группы ресурсов. Ресурсы в группе ресурсов не затрагиваются.

Подготовка выполняется следующим образом.

1. В разделе **Across regions** (Между регионами) выберите исходную группу ресурсов, а затем нажмите кнопку **Подготовить**.
2. В разделе **Подготовка ресурсов** нажмите кнопку **Подготовить**.

    ![Подготовка группы ресурсов](./media/tutorial-move-region-virtual-machines/prepare-resource-group.png)

> [!NOTE]
> После подготовки группы ресурсов она находится в состоянии *ожидания начала перемещения*. 

 
### <a name="move-the-source-resource-group"></a>Перемещение исходной группы ресурсов

Начните перемещение, выполнив следующие действия:

1. В разделе **Across regions** (Между регионами) выберите исходную группу ресурсов, а затем нажмите кнопку **Initiate move** (Начать перемещение).
2. В разделе **Перемещение ресурсов** выберите **Initiate move** (Начать перемещение). Группа ресурсов будет иметь состояние *Initiate move in progress* (Начало перемещения).
3. После начала перемещения создается целевая группа ресурсов на основе созданного шаблона Resource Manager. Исходная группа ресурсов будет иметь состояние *Commit move pending* (Ожидается фиксация перемещения).

    ![Нажатие кнопки начала перемещения](./media/tutorial-move-region-virtual-machines/commit-move-pending.png)

Чтобы зафиксировать и завершить процесс перемещения, сделайте следующее:

1. В разделе **Across regions** (Между регионами) выберите исходную группу ресурсов, а затем нажмите кнопку **Commit move** (Зафиксировать перемещение).
2. В разделе **Перемещение ресурсов** нажмите кнопку **Зафиксировать**.

> [!NOTE]
> После фиксации перемещения исходная группа ресурсов находится в состоянии *ожидания удаления источника*.

## <a name="prepare-resources-to-move"></a>Добавление ресурсов для перемещения

Теперь, когда исходная группа ресурсов перемещена, можно подготовиться к перемещению других ресурсов, которые находятся в состоянии *Prepare pending* (Ожидание подготовки).

1. На странице **Across regions** (Между регионами) убедитесь, что ресурсы теперь находятся в состоянии *ожидания подготовки* без проблем. При наличии проблем повторите проверку и устраните их.

    ![Страница с ресурсами с состоянием ожидания подготовки](./media/tutorial-move-region-virtual-machines/prepare-pending.png)

2. Если необходимо изменить целевые параметры перед началом перемещения, щелкните ссылку в столбце **Destination configuration** (Конфигурация назначения) для ресурса и измените параметры. При изменении параметров целевой виртуальной машины ее размер не должен превышать размер исходной виртуальной машины.  

Теперь, когда исходная группа ресурсов перемещена, можно подготовиться к перемещению других ресурсов.

3. Выберите ресурсы, которые нужно подготовить. 

    ![Страница выбора подготовки других ресурсов](./media/tutorial-move-region-virtual-machines/prepare-other.png)

2. Нажмите кнопку **Подготовить**. 

> [!NOTE]
> - В процессе подготовки на виртуальных машинах устанавливается агент службы "Мобильность" Azure Site Recovery для репликации.
> - Данные виртуальной машины периодически реплицируются в целевой регион. Это не влияет на исходную виртуальную машину.
> - При перемещении ресурсов создаются шаблоны Resource Manager для других исходных ресурсов.
> - После подготовки ресурсов они находятся в состоянии *ожидания начала перемещения*.

![Страница с ресурсами в состоянии ожидания начала перемещения](./media/tutorial-move-region-virtual-machines/initiate-move-pending.png)


## <a name="initiate-the-move"></a>Начало перемещения

Теперь, когда ресурсы подготовлены, можно начать перемещение. 

1. В разделе **Across regions** (Между регионами) выберите ресурсы с состоянием *ожидания начала перемещения*. Затем нажмите кнопку **Initiate move** (Начать перемещение).
2. В разделе **Перемещение ресурсов** нажмите кнопку **Initiate move** (Начать перемещение).

    ![Нажатие кнопки Initiate move (Начать перемещение)](./media/tutorial-move-region-virtual-machines/initiate-move.png)

3. Отслеживать ход перемещения можно на панели уведомлений.

> [!NOTE]
> - Реплики виртуальных машин создаются в целевом регионе. Исходная виртуальная машина завершает работу, и возникает некоторое время простоя (обычно несколько минут).
> - Resource Mover воссоздает другие ресурсы с помощью подготовленных шаблонов Resource Manager. Обычно время простоя отсутствует.
> - После перемещения ресурсов они находятся в состоянии *ожидания фиксации перемещения*.

![Страница с ресурсами в состоянии ожидания удаления источника.](./media/tutorial-move-region-virtual-machines/delete-source-pending.png)


## <a name="discard-or-commit"></a>Отмена или фиксация

После первоначального перемещения нужно решить, следует ли фиксировать перемещение или отменить его. 

- **Отмена**. Если вы выполняете тестирование и не хотите фактически перемещать исходный ресурс, вы можете отменить перемещение. При отмене перемещения ресурс возвращается в состояние *ожидания начала перемещения*.
- **Фиксация**. Фиксация завершает перемещение в целевой регион. После фиксации исходный ресурс будет находиться в состоянии *ожидания удаления источника*. Затем вы можете его удалить.


## <a name="discard-the-move"></a>Отмена перемещения 

Вы можете отменить перемещение следующим образом:

1. В разделе **Across regions** (Между регионами) выберите ресурсы с состоянием *ожидания фиксации перемещения* и нажмите кнопку **Discard move** (Отменить перемещение).
2. В разделе **Discard move** (Отмена перемещения) нажмите кнопку **Отменить**.
3. Отслеживать ход перемещения можно на панели уведомлений.


> [!NOTE]
> После отмены перемещения ресурсов виртуальные машины находятся в состоянии *ожидания начала перемещения*.

## <a name="commit-the-move"></a>Фиксация перемещения

Если вы хотите завершить процесс перемещения, зафиксируйте перемещение. 

1. В разделе **Across regions** (Между регионами) выберите ресурсы с состоянием *ожидания фиксации перемещения* и нажмите кнопку **Commit move** (Зафиксировать перемещение).
2. В разделе **Commit resources** (Фиксация ресурсов) нажмите кнопку **Зафиксировать**.

    ![Страница фиксации ресурсов для завершения перемещения](./media/tutorial-move-region-virtual-machines/commit-resources.png)

3. Отслеживать ход фиксации можно на панели уведомлений.

> [!NOTE]
> - После фиксации перемещения репликация виртуальных машин останавливается. Фиксация не влияет на исходную виртуальную машину.
> - Фиксация не влияет на исходные сетевые ресурсы.
> - После фиксации перемещения ресурсы находятся в состоянии *ожидания удаления источника*.

![Страница с ресурсами в состоянии ожидания удаления источника.](./media/tutorial-move-region-virtual-machines/delete-source-pending.png)


## <a name="configure-settings-after-the-move"></a>Настройка параметров после перемещения

- Служба "Мобильность" не удаляется автоматически с виртуальных машин. Удалите ее вручную или оставьте, если планируется повторное перемещение сервера.
- После перемещения измените правила управления доступом Azure на основе ролей (Azure RBAC).


## <a name="delete-source-resources-after-commit"></a>Удаление исходных ресурсов после фиксации

После перемещения при необходимости можно удалить ресурсы в исходном регионе. 

> [!NOTE]
> Некоторые ресурсы, например хранилища ключей и серверы SQL Server, нельзя удалить с портала. Это можно сделать со страницы свойств ресурса.

1. В разделе **Across Regions** (Между регионами) щелкните имя каждого исходного ресурса, который требуется удалить.
2. Выберите **Удалить ресурс**.

## <a name="delete-additional-resources-created-for-move"></a>Удаление дополнительных ресурсов, созданных для перемещения

После перемещения можно вручную удалить коллекцию перемещения и созданные ресурсы Site Recovery.

- Коллекция перемещения по умолчанию скрыта. Чтобы увидеть ее, необходимо включить отображение скрытых ресурсов.
- Хранилище кэша имеет блокировку, которую необходимо убрать, прежде чем его можно будет удалить.

Удаление выполняется следующим образом: 
1. Найдите ресурсы в группе ресурсов ```RegionMoveRG-<sourceregion>-<target-region>```.
2. Убедитесь, что все виртуальные машины и другие исходные ресурсы в исходном регионе перемещены или удалены. Это гарантирует, что у вас отсутствуют ресурсы, ожидающие использования.
2. Удаление ресурсов:

    - Имя перемещаемой коллекции — ```movecollection-<sourceregion>-<target-region>```.
    - Имя учетной записи хранения — ```resmovecache<guid>```.
    - Имя хранилища — ```ResourceMove-<sourceregion>-<target-region>-GUID```.
## <a name="next-steps"></a>Дальнейшие действия

Изучив это руководство, вы:

> [!div class="checklist"]
> * Переместили виртуальные машины Azure в другой регион Azure.
> * Переместили ресурсы, связанные с виртуальными машинами, в другой регион.

Теперь попробуйте переместить базы данных и эластичные пулы SQL Azure в другой регион.

> [!div class="nextstepaction"]
> [Перемещение ресурсов SQL Azure](./tutorial-move-region-sql.md)
