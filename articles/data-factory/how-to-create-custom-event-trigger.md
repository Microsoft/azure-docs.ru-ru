---
title: Создание пользовательских триггеров событий в фабрике данных Azure
description: Узнайте, как создать настраиваемый триггер в фабрике данных Azure, который запускает конвейер в ответ на пользовательское событие, опубликованное в службе "Сетка событий".
ms.service: data-factory
author: chez-charlie
ms.author: chez
ms.reviewer: jburchel
ms.topic: conceptual
ms.date: 03/11/2021
ms.openlocfilehash: 2d2f26b24e7fa10d9244de8f99d78c64a44b3d61
ms.sourcegitcommit: f611b3f57027a21f7b229edf8a5b4f4c75f76331
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/22/2021
ms.locfileid: "104785654"
---
# <a name="create-a-trigger-that-runs-a-pipeline-in-response-to-a-custom-event-preview"></a>Создание триггера, запускающего конвейер в ответ на пользовательское событие (Предварительная версия)

[!INCLUDE[appliesto-adf-asa-md](includes/appliesto-adf-asa-md.md)]

В этой статье описываются триггеры пользовательских событий, которые можно создать в конвейерах фабрики данных.

Управляемая событиями архитектура (EDA) — это общий шаблон интеграции данных, включающий в себя производство, обнаружение, потребление и реагирование на события. В сценариях интеграции данных часто требуется, чтобы клиенты фабрики данных инициировали конвейеры на основе определенных событий. Собственная интеграция фабрики данных с помощью службы " [Сетка событий Azure](https://azure.microsoft.com/services/event-grid/) " теперь охватывает [пользовательские события](../event-grid/custom-topics.md): клиенты отправляют произвольные события в службу "Сетка событий", а фабрика данных подписывается на раздел и активирует конвейеры соответствующим образом.

> [!NOTE]
> Интеграция, описанная в этой статье, зависит от службы [Сетка событий Azure](https://azure.microsoft.com/services/event-grid/). Убедитесь, что ваша подписка зарегистрирована у поставщика ресурсов "Сетка событий". См. дополнительные сведения о [поставщиках и типах ресурсов](../azure-resource-manager/management/resource-providers-and-types.md#azure-portal). Необходимо иметь возможность выполнить действие *Microsoft. EventGrid/eventSubscriptions/**. Это действие является частью встроенной роли участника EventGrid подписки.

Кроме того, объединение параметров конвейера и пользовательского триггера событий позволяет клиентам анализировать и ссылаться на полезные _данные пользовательских данных_ при выполнении конвейера. поле _данных_ в полезных данных пользовательского события — это структура ключа в свободной форме в формате JSON, предоставляющая пользователям максимальный контроль над выполнением конвейеров, управляемых событиями.

> [!IMPORTANT]
> Каждый раз, когда в полезных данных пользовательского события может отсутствовать ключ, на который ссылается параметр. _Выполнение триггера_ завершится ошибкой, в котором будет указано, что выражение не может быть вычислено, так как свойство _keyName_ не существует. Событие __не__ вызывает _Запуск конвейера_ .

## <a name="setup-event-grid-custom-topic"></a>Пользовательский раздел "Сетка событий настройки"

Чтобы использовать триггер настраиваемого события в фабрике данных, необходимо _сначала_ настроить [пользовательский раздел в сетке событий](../event-grid/custom-topics.md). Рабочий процесс отличается от триггера событий хранилища, в котором фабрика данных настроит этот раздел. Здесь необходимо переместиться в службу "Сетка событий Azure" и создать раздел самостоятельно. Дополнительные сведения о создании пользовательских разделов см. в [учебниках](../event-grid/custom-topics.md#azure-portal-tutorials) по службе "Сетка событий Azure" и в [учебниках по CLI](../event-grid/custom-topics.md#azure-cli-tutorials) .

Фабрики данных предполагают, что события следуют [схеме событий сетки событий](../event-grid/event-schema.md). Убедитесь, что полезные данные события содержат следующие поля.

```json
[
  {
    "topic": string,
    "subject": string,
    "id": string,
    "eventType": string,
    "eventTime": string,
    "data":{
      object-unique-to-each-publisher
    },
    "dataVersion": string,
    "metadataVersion": string
  }
]
```

## <a name="data-factory-ui"></a>Пользовательский интерфейс Фабрики данных

В этом разделе показано, как создать триггер событий хранилища в пользовательском интерфейсе фабрики данных Azure.

1. Перейдите на вкладку **Правка** , показанную значком карандаша.

1. Выберите **триггер** в меню, а затем выберите **создать/изменить**.

1. На странице **Добавление триггеров** выберите **выбрать триггер...**, а затем выберите **+ создать**.

1. Выбор типа триггера **пользовательские события**

    :::image type="content" source="media/how-to-create-custom-event-trigger/custom-event-1-creation.png" alt-text="Снимок экрана: страница &quot;создание&quot; для создания нового пользовательского триггера событий в пользовательском интерфейсе фабрики данных." lightbox="media/how-to-create-custom-event-trigger/custom-event-1-creation-expanded.png":::

1. Выберите настраиваемый раздел в раскрывающемся списке подписки Azure или вручную введите область раздела события.

   > [!NOTE]
   > Чтобы создать новый или изменить существующий триггер настраиваемого события, учетная запись Azure, используемая для входа в фабрику данных, и опубликуйте триггер событий хранилища, должны иметь соответствующее разрешение на управление доступом на основе ролей (Azure RBAC) в разделе. Никаких дополнительных разрешений не требуется: субъект-служба для фабрики данных Azure _не_ требует специального разрешения для службы "Сетка событий". Дополнительные сведения об управлении доступом см. в разделе [Управление доступом на основе ролей](#role-based-access-control) .

1. **Тема начинается с** , а **Тема** "Свойства" позволяет фильтровать события, для которых требуется активировать конвейер. Оба свойства являются необязательными.

1. Используйте **+ создать** для добавления **типов событий** , по которым требуется выполнить фильтрацию. Пользователь триггера пользовательского события a или отношение для списка: Если пользовательское событие имеет свойство _EventType_ , соответствующее любому из перечисленных здесь, оно вызовет запуск конвейера. Тип события не учитывает регистр. Например, на следующем снимке экрана триггер соответствует всем событиям _копикомплетед_ или _кописукцеедед_ с темой начинается с _фабрик_ .

    :::image type="content" source="media/how-to-create-custom-event-trigger/custom-event-2-properties.png" alt-text="Снимок экрана: страница &quot;изменение триггера&quot; для объяснения типов событий и фильтрации субъектов в пользовательском интерфейсе фабрики данных.":::

1. Триггер настраиваемого события может анализировать и отсылать полезные _данные пользовательских данных_ в конвейер. Сначала создайте параметры конвейера и заполните значения на странице **Параметры** . Используйте формат **@triggerBody (). Event. Data._keyName_** для синтаксического анализа полезных данных и передачи значений в параметры конвейера. Подробное описание см. [в разделе Метаданные триггера справочника в конвейерах](how-to-use-trigger-parameterization.md) и [системных переменных в пользовательском триггере событий](control-flow-system-variables.md#custom-event-trigger-scope) .

    :::image type="content" source="media/how-to-create-custom-event-trigger/custom-event-4-trigger-values.png" alt-text="Снимок экрана с параметром параметров конвейера.":::

    :::image type="content" source="media/how-to-create-custom-event-trigger/custom-event-3-parameters.png" alt-text="Снимок экрана: страница параметров для ссылки на полезные данные в пользовательском событии.":::

1. По завершении нажмите кнопку **ОК** .

## <a name="json-schema"></a>Схема JSON

В следующей таблице приведены общие сведения об элементах схемы, связанных с триггерами пользовательских событий.

| **Элемент JSON** | **Описание** | **Тип** | **Допустимые значения** | **Обязательно** |
| ---------------- | --------------- | -------- | ------------------ | ------------ |
| **область** | Azure Resource Manager идентификатор ресурса для раздела сетки событий. | Строка | Идентификатор Azure Resource Manager | Да |
| **events** | Тип событий, вызывающих срабатывание триггера. | Массив строк    |  | Да, ожидается по крайней мере одно значение |
| **subjectBeginsWith** | Поле темы должно начинаться с шаблона, предоставленного для срабатывания триггера. Например, `factories` триггер срабатывает только для субъекта события, начинающегося с `factories` . | Строка   | | Нет |
| **subjectEndsWith** | Поле темы должно заканчиваться шаблоном, предоставленным для срабатывания триггера. | Строка   | | Нет |

## <a name="role-based-access-control"></a>управление доступом на основе ролей;

Фабрика данных Azure использует управление доступом на основе ролей Azure (Azure RBAC), чтобы гарантировать, что несанкционированный доступ к прослушиванию, подписка на обновления из и активация конвейеров, связанных с пользовательскими событиями, строго запрещен.

* Для успешного создания нового или обновления существующего триггера настраиваемого события учетная запись Azure, выполненная в фабрике данных, должна иметь соответствующий доступ к соответствующей учетной записи хранения. В противном случае операция с ошибкой с _доступом будет запрещена_.
* Фабрике данных не требуется специального разрешения для вашей службы "Сетка событий", поэтому вам _не_ нужно назначать особое разрешение Azure RBAC субъекту-службе фабрики данных для операции.

В частности, клиенту требуются разрешения _Microsoft. EventGrid/EventSubscriptions/Write_ на _/Subscriptions/# # # #/ресаурцеграупс//# # # #/провидерс/Микрософт.евентгрид/топикс/сометопикс_

## <a name="next-steps"></a>Дальнейшие действия

* Дополнительные сведения см. в руководстве по [выполнению конвейера и использованию триггеров](concepts-pipeline-execution-triggers.md#trigger-execution).
* Сведения о ссылках на метаданные триггера в конвейере см. в разделе [метаданные триггера справочника при выполнении конвейера](how-to-use-trigger-parameterization.md)
