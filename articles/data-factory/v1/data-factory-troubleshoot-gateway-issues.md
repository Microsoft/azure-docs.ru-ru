---
title: Устранение неполадок Управление данными шлюза
description: Эта статья содержит советы по устранению неполадок, связанных со шлюзом управления данными.
author: nabhishek
ms.service: data-factory
ms.topic: conceptual
ms.date: 10/01/2017
ms.author: abnarain
robots: noindex
ms.openlocfilehash: 284486c5db248ced8ada6e7194c7bc5a9be5689f
ms.sourcegitcommit: d4734bc680ea221ea80fdea67859d6d32241aefc
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/14/2021
ms.locfileid: "100388351"
---
# <a name="troubleshoot-issues-with-using-data-management-gateway"></a>Устранение неполадок в работе шлюза управления данными
В этой статье приводятся сведения об устранении неполадок в работе шлюза управления данными.

> [!NOTE]
> В этой статье рассматривается служба "Фабрика данных Azure" версии 1. Если вы используете текущую версию Фабрики данных, см. статью о [локальной среде IR в службе "Фабрика данных"](../create-self-hosted-integration-runtime.md).

Подробные сведения о шлюзе см. в статье [Шлюз управления данными](data-factory-data-management-gateway.md). Пошаговое руководство по перемещению данных из базы данных SQL Server Microsoft Azure в хранилище BLOB-объектов с помощью шлюза см. в статье [Перемещение данных между локальными и облачными](data-factory-move-data-between-onprem-and-cloud.md) службами.

## <a name="failed-to-install-or-register-gateway"></a>Не удалось установить и зарегистрировать шлюз
### <a name="1-problem"></a>1. проблема
Это сообщение об ошибке отображается при установке и регистрации шлюза, а именно при скачивании файла установки шлюза.

`Unable to connect to the remote server". Please check your local settings (Error Code: 10003).`

#### <a name="cause"></a>Причина
Компьютеру, на который вы пытаетесь установить шлюз, не удалось скачать последний файл установки шлюза из центра загрузки из-за проблемы в сети.

#### <a name="resolution"></a>Решение
Проверьте параметры прокси-сервера брандмауэра, чтобы определить, не блокируют ли эти параметры сетевое подключение компьютера к [центру загрузки](https://download.microsoft.com/), и измените их соответствующим образом.

Или можно скачать файл установки последнего шлюза из [центра загрузки](https://www.microsoft.com/download/details.aspx?id=39717) на других компьютерах, которые могут подключаться к центру загрузки. Затем можно скопировать файл установщика на главный компьютер шлюза и запустить его вручную, чтобы установить и обновить шлюз.

### <a name="2-problem"></a>2. проблема
Эта ошибка возникает при попытке установить шлюз с помощью ссылки **Установка непосредственно на этот компьютер** на портале Azure.

`Error:  Abort installing a new gateway on this computer because this computer has an existing installed gateway and a computer without any installed gateway is required for installing a new gateway.`  

#### <a name="cause"></a>Причина
Шлюз уже установлен на компьютере.

#### <a name="resolution"></a>Решение
Удалите существующий шлюз на компьютере и снова щелкните ссылку **установить непосредственно на этот компьютер** .

### <a name="3-problem"></a>3. проблема
Эта ошибка может возникнуть при регистрации нового шлюза.

`Error: The gateway has encountered an error during registration.`

#### <a name="cause"></a>Причина
Это сообщение может отображаться по одной из следующих причин:

* недопустимый формат ключа шлюза;
* ключ шлюза стал недействительным;
* ключ шлюза создан повторно на портале.  

#### <a name="resolution"></a>Решение
Просмотрите сведения на портале, чтобы убедиться, что используется правильный ключ шлюза. При необходимости повторно создайте ключ и зарегистрируйте шлюз с его помощью.

### <a name="4-problem"></a>4. проблема
При регистрации шлюза может появиться следующее сообщение об ошибке.

`Error: The content or format of the gateway key "{gatewayKey}" is invalid, please go to azure portal to create one new gateway or regenerate the gateway key.`



![Недопустимое содержимое или формат ключа](media/data-factory-troubleshoot-gateway-issues/invalid-format-gateway-key.png)

#### <a name="cause"></a>Причина
Содержимое или формат входного ключа шлюза неправильные. Одной из причин может быть копирование части ключа на портале или использование недопустимого ключа.

#### <a name="resolution"></a>Решение
Создайте ключ шлюза на портале и скопируйте весь ключ с помощью кнопки копирования. Затем вставьте его в это окно, чтобы зарегистрировать шлюз.

### <a name="5-problem"></a>5. проблема
При регистрации шлюза может появиться следующее сообщение об ошибке.

`Error: The gateway key is invalid or empty. Specify a valid gateway key from the portal.`

![Снимок экрана с сообщением об ошибке, указывающим, что ключ шлюза является недопустимым или пустым.](media/data-factory-troubleshoot-gateway-issues/gateway-key-is-invalid-or-empty.png)

#### <a name="cause"></a>Причина
Ключ шлюза создан повторно или шлюз удален на портале Azure. Это также может произойти, если установлена не последняя версия шлюза управления данными.

#### <a name="resolution"></a>Решение
Проверьте, установлена ли последняя версия шлюза управления данными. Последнюю версию можно найти в [Центре загрузки Майкрософт](https://go.microsoft.com/fwlink/p/?LinkId=271260).

Если установлена актуальная (последняя) версия и шлюз существует на портале, повторно создайте ключ шлюза на портале Azure, скопируйте весь ключ, нажав кнопку "Копировать", и вставьте его в это окно, чтобы зарегистрировать шлюз. В противном случае повторно создайте шлюз и начните заново.

### <a name="6-problem"></a>6. проблема
При регистрации шлюза может появиться следующее сообщение об ошибке.

`Error: Gateway has been online for a while, then shows "Gateway is not registered" with the status "Gateway key is invalid"`

![Ключ шлюза является недопустимым или пустым](media/data-factory-troubleshoot-gateway-issues/gateway-not-registered-key-invalid.png)

#### <a name="cause"></a>Причина
Эта ошибка может возникать из-за удаления шлюза или повторного создания ключа соответствующего шлюза.

#### <a name="resolution"></a>Решение
Если шлюз был удален, заново создайте его на портале, нажмите кнопку **Зарегистрировать**, скопируйте ключ с портала, вставьте его и попытайтесь зарегистрировать шлюз.

Если шлюз существует, но его ключ был создан повторно, зарегистрируйте шлюз, используя новый ключ. Если у вас нет ключа, повторно создайте ключ на портале.

### <a name="7-problem"></a>7. проблема
При регистрации шлюза может потребоваться ввести путь и пароль к сертификату.

![Снимок экрана, на котором показано, где вводится путь и пароль для сертификата.](media/data-factory-troubleshoot-gateway-issues/specify-certificate.png)

#### <a name="cause"></a>Причина
Этот шлюз ранее зарегистрирован на других компьютерах. Во время первоначальной регистрации шлюза с ним связывается сертификат шифрования. Сертификат может быть создан шлюзом или предоставлен пользователем.  Этот сертификат используется для шифрования учетных данных хранилища данных (связанные службы).  

![Экспорт сертификата](media/data-factory-troubleshoot-gateway-issues/export-certificate.png)

При восстановлении шлюза на другом хост-компьютере мастер регистрации запрашивает этот сертификат для расшифровки учетных данных, зашифрованных с его помощью.  Без этого сертификата новому шлюзу не удастся расшифровать учетные данные, а последующие действия копирования, связанные с этим новым шлюзом, будут завершаться ошибкой.  

#### <a name="resolution"></a>Решение
Если сертификат учетных данных экспортирован с исходного компьютера шлюза с помощью кнопки **Экспорт** на вкладке **Параметры** в диспетчере конфигураций шлюза управления данными, используйте сертификат отсюда.

Нельзя пропускать этот шаг при восстановлении шлюза. Если сертификат отсутствует, необходимо удалить шлюз на портале и заново создать его.  Также следует обновить все связанные службы шлюза. Для этого нужно повторно ввести их учетные данные.

### <a name="8-problem"></a>8. проблема
Вы можете получить следующее сообщение об ошибке.

`Error: The remote server returned an error: (407) Proxy Authentication Required.`

#### <a name="cause"></a>Причина
Эта ошибка возникает, если шлюз находится в среде, которой для доступа к интернет-ресурсам требуется прокси-сервер HTTP, или если пароль для аутентификации прокси-сервера изменился, но не обновился соответствующим образом в шлюзе.

#### <a name="resolution"></a>Решение
Следуйте инструкциям в разделе с рекомендациями для прокси-сервера в этой статье и настройте параметры прокси-сервера с помощью диспетчера конфигураций шлюза управления данными.

## <a name="gateway-is-online-with-limited-functionality"></a>Шлюз находится в сети с ограниченной функциональностью
### <a name="1-problem"></a>1. проблема
Шлюз находится в состоянии "в сети с ограниченной функциональностью".

#### <a name="cause"></a>Причина
Шлюз может находиться в состоянии "в сети с ограниченной функциональностью" по одной из следующих причин:

* шлюзу не удается подключиться к облачной службе через служебную шину Azure;
* облачной службе не удается подключиться к шлюзу через служебную шину.

Если шлюз находится в сети с ограниченной функциональностью, вы не сможете использовать мастер копирования фабрики данных, чтобы создавать конвейеры данных для копирования данных между локальными хранилищами данных. Для решения проблемы можно использовать редактор фабрики данных на портале, Visual Studio или Azure PowerShell.

#### <a name="resolution"></a>Решение
Устранить эту проблему (состояние "в сети с ограниченной функциональностью") можно, определив ее причину (например, шлюзу не удается подключиться к облачной службе). В следующих разделах описываются эти методы устранения проблемы.

### <a name="2-problem"></a>2. проблема
Возникла следующая ошибка:

`Error: Gateway cannot connect to cloud service through service bus`

![Шлюзу не удается подключиться к облачной службе](media/data-factory-troubleshoot-gateway-issues/gateway-cannot-connect-to-cloud-service.png)

#### <a name="cause"></a>Причина
Шлюзу не удается подключиться к облачной службе через служебную шину.

#### <a name="resolution"></a>Решение
Выполните следующие действия, чтобы перевести шлюз в состояние "в сети".

1. Разрешите правила для исходящих подключений по IP-адресам на компьютере шлюза и в корпоративном брандмауэре. IP-адреса можно найти в журнале событий Windows (идентификатор 401): "Попытка доступа к сокету методом, запрещенным его разрешениями на доступ XX.XX.XX.XX:9350".
1. Настройте параметры прокси-сервера на шлюзе. Дополнительные сведения см. в разделе с рекомендациями для прокси-сервера.
1. Откройте исходящие порты 5671 и 9350–9354 в брандмауэре Windows на компьютере шлюза и в корпоративном брандмауэре. Дополнительные сведения см. в разделе о портах и брандмауэре. Это делать не обязательно, но рекомендуется из соображений производительности.

### <a name="3-problem"></a>3. проблема
Возникла следующая ошибка:

`Error: Cloud service cannot connect to gateway through service bus.`

#### <a name="cause"></a>Причина
Временная ошибка подключения к сети.

#### <a name="resolution"></a>Решение
Выполните следующие действия, чтобы перевести шлюз в состояние "в сети".

1. Подождите несколько минут. Подключение восстановится автоматически после устранения ошибки.
1. Если ошибка не исчезнет, перезапустите службу шлюза.

## <a name="failed-to-author-linked-service"></a>Не удалось создать связанную службу
### <a name="problem"></a>Проблема
Эта ошибка может возникнуть при попытке использовать диспетчер учетных данных на портале, чтобы ввести учетные данные для новой связанной службы или обновить учетные данные для существующей связанной службы.

`Error: The data store '<Server>/<Database>' cannot be reached. Check connection settings for the data source.`

При появлении этой ошибки страница параметров диспетчера конфигураций шлюза управления данными может выглядеть, как на следующем снимке экрана.

![Не удается получить доступ к базе данных](media/data-factory-troubleshoot-gateway-issues/database-cannot-be-reached.png)

#### <a name="cause"></a>Причина
Возможно, на компьютере шлюза был потерян сертификат TLS/SSL. Компьютеру шлюза не удается загрузить сертификат, который в настоящее время используется для шифрования TLS. Кроме того, в журнале событий также может появиться сообщение об ошибке примерно следующего вида.

 `Unable to get the gateway settings from cloud service. Check the gateway key and the network connection. (Certificate with thumbprint cannot be loaded.)`

#### <a name="resolution"></a>Решение
Чтобы решить проблему, сделайте следующее:

1. Запустите диспетчер конфигураций шлюза управления данными.
2. Переключитесь на вкладку **Параметры** .  
3. Нажмите кнопку **изменить** , чтобы изменить сертификат TLS/SSL.

   ![Кнопка "Изменить" для сертификата](media/data-factory-troubleshoot-gateway-issues/change-button-ssl-certificate.png)
4. Выберите новый сертификат в качестве сертификата TLS/SSL. Вы можете использовать любой сертификат TLS/SSL, созданный вами или любой организацией.

   ![Выбор сертификата](media/data-factory-troubleshoot-gateway-issues/specify-http-end-point.png)

## <a name="copy-activity-fails"></a>Сбой действия копирования
### <a name="problem"></a>Проблема
После настройки конвейера на портале может возникнуть следующая ошибка UserErrorFailedToConnectToSqlserver.

`Error: Copy activity encountered a user error: ErrorCode=UserErrorFailedToConnectToSqlServer,'Type=Microsoft.DataTransfer.Common.Shared.HybridDeliveryException,Message=Cannot connect to SQL Server`

#### <a name="cause"></a>Причина
Она может возникнуть по разным причинам, от которых зависят и способы ее устранения.

#### <a name="resolution"></a>Решение
Разрешать исходящие TCP-подключения через порт TCP/1433 на стороне клиента шлюза Управление данными перед подключением к базе данных SQL.

Если целевая база данных находится в базе данных SQL Azure, проверьте также SQL Server параметры брандмауэра для Azure.

Инструкции по проверке подключения к локальному хранилищу данных см. в следующем разделе.

## <a name="data-store-connection-or-driver-related-errors"></a>Ошибки, связанные с подключением к хранилищу данных или с драйверами
Если возникают ошибки, связанные с подключением к хранилищу данных или с драйверами, выполните перечисленные ниже действия.

1. На компьютере шлюза запустите диспетчер конфигураций шлюза управления данными.
2. Перейдите на вкладку **Диагностика** .
3. В разделе **Проверка подключения** добавьте значения для группы шлюза.
4. Нажмите кнопку **Тестировать**, чтобы проверить возможность подключения к локальному источнику данных с компьютера шлюза, используя сведения о подключении и учетные данные. Если после установки драйвера тестовое подключение по-прежнему не работает, перезапустите шлюз для того, чтобы получить последние изменения.

![Раздел "Проверить подключение" на вкладке "Диагностика"](media/data-factory-troubleshoot-gateway-issues/test-connection-in-diagnostics-tab.png)

## <a name="gateway-logs"></a>Журналы шлюза
### <a name="send-gateway-logs-to-microsoft"></a>Отправка журналов шлюза в корпорацию Майкрософт
Возможно, при обращении в службу поддержки Майкрософт с проблемами в работе шлюза вас попросят предоставить журналы шлюза. Выпуск шлюза позволяет предоставить требуемые журналы всего двумя щелчками в диспетчере конфигураций шлюза управления данными.    

1. Перейдите на вкладку **Диагностика** в диспетчере конфигураций шлюза управления данными.

    ![Вкладка "Диагностика"в шлюзе управления данными](media/data-factory-troubleshoot-gateway-issues/data-management-gateway-diagnostics-tab.png)
2. Щелкните **Отправить журналы**, чтобы открыть приведенное ниже диалоговое окно.

    ![Кнопка "Отправить журналы" в шлюзе управления данными](media/data-factory-troubleshoot-gateway-issues/data-management-gateway-send-logs-dialog.png)
3. (Необязательно.) Щелкните **Просмотреть журналы**, чтобы просмотреть журналы в средстве просмотра событий.
4. (Необязательно.) Щелкните **Конфиденциальность**, чтобы просмотреть заявление о конфиденциальности веб-служб Майкрософт.
5. Выбрав все, что нужно передать, щелкните **Отправить журналы**, чтобы отправить журналы за последние семь дней в корпорацию Майкрософт для диагностики и устранения неполадок. Вы увидите состояние отправки журналов, как показано на снимке экрана ниже.

    ![Снимок экрана, на котором показано, где можно просмотреть состояние операции отправки журналов.](media/data-factory-troubleshoot-gateway-issues/data-management-gateway-send-logs-status.png)
6. После завершения отправки появится диалоговое окно, как показано на снимке экрана ниже.

    ![Состояние отправки журналов в шлюзе управления данными](media/data-factory-troubleshoot-gateway-issues/data-management-gateway-send-logs-result.png)
7. Сохраните **идентификатор отчета** и передайте его в службу поддержки Майкрософт. Идентификатор отчета используется для поиска журналов шлюза, которые вы передали для устранения неполадок.  Кроме того, этот идентификатор сохраняется в средстве просмотра событий.  Его можно найти, просмотрев событие с ИДЕНТИФИКАТОРом "25", и проверьте дату и время.

    ![Идентификатор отчета об отправке журналов в шлюзе управления данными](media/data-factory-troubleshoot-gateway-issues/data-management-gateway-send-logs-report-id.png)    

### <a name="archive-gateway-logs-on-gateway-host-machine"></a>Архивация журналов шлюза на хост-компьютере шлюза
Существует несколько сценариев, в которых при наличии проблем в работе шлюза вы не можете передать журналы шлюза напрямую:

* вы вручную устанавливаете и регистрируете шлюз;
* вы пытаетесь зарегистрировать шлюз с помощью повторно созданного ключа в диспетчере конфигураций шлюза управления данными;
* вы пытаетесь отправить журналы, но не можете подключиться к службе узла шлюза.

В таких случаях можно сохранить журналы шлюза в ZIP-файл и предоставить их при обращении в службу поддержки Майкрософт. Например, это можно сделать при возникновении ошибки во время регистрации шлюза, как показано на снимке экрана ниже.   

![Ошибка регистрации в шлюзе управления данными](media/data-factory-troubleshoot-gateway-issues/data-management-gateway-registration-error.png)

Щелкните ссылку **Архивировать журналы шлюза**, чтобы заархивировать и сохранить журналы, а затем передайте полученный ZIP-файл в службу поддержки Майкрософт.

![Архивация журналов в шлюзе управления данными](media/data-factory-troubleshoot-gateway-issues/data-management-gateway-archive-logs.png)

### <a name="locate-gateway-logs"></a>Поиск журналов шлюза
Подробную информацию о журналах шлюза можно найти в журналах событий Windows.

1. Запустите **средство просмотра событий** Windows.
2. Нахождение журналов в **журналах приложений и служб**  >  **Управление данными папке шлюза** .

   Устраняя связанные со шлюзом ошибки, обращайте внимание на события уровня ошибок в средстве просмотра событий.

![Журналы в средстве просмотра событий в шлюзе управления данными](media/data-factory-troubleshoot-gateway-issues/gateway-logs-event-viewer.png)
