---
title: Шифрование в Фабрике данных Azure с помощью управляемого клиентом ключа
description: Повышение безопасности Фабрики данных за счет создания собственных ключей (BYOK)
author: chez-charlie
ms.service: data-factory
ms.topic: quickstart
ms.date: 05/08/2020
ms.author: chez
ms.reviewer: mariozi
ms.openlocfilehash: a18d06e3a0324889a4cb9936fb339fd9d8f9b816
ms.sourcegitcommit: 3f684a803cd0ccd6f0fb1b87744644a45ace750d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/02/2021
ms.locfileid: "106222707"
---
# <a name="encrypt-azure-data-factory-with-customer-managed-keys"></a>Шифрование в Фабрике данных Azure с помощью управляемых клиентом ключей

[!INCLUDE[appliesto-adf-xxx-md](includes/appliesto-adf-xxx-md.md)]

Фабрика данных Azure шифрует неактивные данные, в том числе определения сущностей и все данные, кэшированные во время выполнения. По умолчанию данные шифруются с помощью генерируемого случайным образом ключа под управлением Майкрософт, который назначается фабрике данных с соблюдением уникальности. Благодаря возможности использовать управляемые клиентом ключи в Фабрике данных Azure теперь для обеспечения дополнительной безопасности можно включить создание собственных ключей (BYOK). Если задан управляемый клиентом ключ, Фабрика данных использует для шифрования данных клиента __как системный ключ фабрики, так и CMK__. Отсутствие любого из них может привести к отказу в доступе к данным и фабрике.

Для хранения управляемых клиентом ключей требуется Azure Key Vault. Можно либо создать собственные ключи и хранить их в хранилище ключей, либо использовать API-интерфейсы Azure Key Vault для их генерации. Хранилище ключей и фабрика данных должны находиться в одном и том же клиенте Azure Active Directory (Azure AD) и одном регионе, но они могут относиться к разным подпискам. Дополнительные сведения о хранилище ключей Azure см. в статье [Что такое хранилище ключей Azure?](../key-vault/general/overview.md)

## <a name="about-customer-managed-keys"></a>Сведения об управляемых клиентом ключах

На следующей схеме показано, как Фабрика данных использует Azure Active Directory и Azure Key Vault для выполнения запросов с помощью управляемого клиентом ключа:

  :::image type="content" source="media/enable-customer-managed-key/encryption-customer-managed-keys-diagram.png" alt-text="Экран &quot;Схема, на которой показан принцип действия управляемых клиентом ключей в Фабрике данных Azure&quot;.":::

В следующем списке описаны шаги, пронумерованные на схеме.

1. Администратор Azure Key Vault предоставляет управляемому удостоверению, связанному с Фабрикой данных, разрешения на использование ключей шифрования.
1. Администратор Фабрики данных включает в фабрике возможность использовать управляемые клиентом ключи.
1. Фабрика данных использует управляемое удостоверение, связанное с фабрикой, для проверки подлинности при доступе к Azure Key Vault через Azure Active Directory.
1. Фабрика данных заключает в оболочку ключ шифрования фабрики, используя ключ клиента в Azure Key Vault.
1. В случае операций чтения и записи Фабрика данных отправляет запросы в Azure Key Vault для извлечения ключа шифрования учетной записи из оболочки с целью выполнения операций шифрования и расшифровки.

Существует два способа добавления шифрования управляемого клиентом ключа в фабрики данных. Первый — во время создания фабрики на портале Azure, а второй — после создания фабрики в пользовательском интерфейсе Фабрики данных.

## <a name="prerequisites---configure-azure-key-vault-and-generate-keys"></a>Необходимые условия. Настройка Azure Key Vault и создание ключей

### <a name="enable-soft-delete-and-do-not-purge-on-azure-key-vault"></a>Включение обратимого удаления и запрета на очистку Azure Key Vault

Для использования управляемых клиентом ключей с Фабрикой данных необходимо задать для хранилища ключей два свойства: __Обратимое удаление__ и __Do Not Purge__ (Не очищать). Эти свойства можно включить с помощью PowerShell или Azure CLI в новом или имеющемся хранилище ключей. Сведения о том, как включить эти свойства в существующем хранилище ключей, см. в статье [Azure Key Vault. Управление восстановлением с помощью обратимого удаления и защиты от очистки](../key-vault/general/key-vault-recovery.md).

Если вы создаете новый Azure Key Vault с помощью портала Azure, свойства __Обратимое удаление__ и __Do Not Purge__ (Не очищать) можно задать следующим образом.

  :::image type="content" source="media/enable-customer-managed-key/01-enable-purge-protection.png" alt-text="Экран &quot;Снимок экрана: включение обратимого удаления и защиты от очистки при создании Key Vault&quot;.":::

### <a name="grant-data-factory-access-to-azure-key-vault"></a>Предоставление Фабрике данных доступа к Azure Key Vault

Убедитесь, что Azure Key Vault и Фабрика данных Azure находятся в одном и том же клиенте Azure Active Directory (Azure AD), а также в _одном регионе_. Используя функцию управления доступом в Azure Key Vault, предоставьте фабрике данных следующие разрешения: _Получение_, _Распаковка ключа_ и _Упаковка ключа_. Эти разрешения необходимы для включения возможности использования управляемых клиентом ключей в Фабрике данных.

* Если вы хотите добавить шифрование управляемого клиентом ключа [после создания фабрики в пользовательском интерфейсе Фабрики данных](#post-factory-creation-in-data-factory-ui), убедитесь, что управляемому удостоверения (MSI) службы фабрики данных предоставлены все три разрешения для Key Vault
* Если вы хотите добавить шифрование с помощью ключа, управляемого клиентом, [во время создания фабрики на портале Azure](#during-factory-creation-in-azure-portal) убедитесь, что назначаемому пользователем управляемому удостоверению (UA-MI) предоставлены все три разрешения для Key Vault

  :::image type="content" source="media/enable-customer-managed-key/02-access-policy-factory-managed-identities.png" alt-text="Экран &quot;Снимок экрана: предоставление Фабрике данных доступа к Key Vault&quot;.":::

### <a name="generate-or-upload-customer-managed-key-to-azure-key-vault"></a>Создание или передача управляемого клиентом ключа в Azure Key Vault

Вы можете создавать свои собственные ключи и хранить их в хранилище ключей. Для создания ключей также можно использовать API Azure Key Vault. При шифровании Фабрики данных поддерживаются только 2048-разрядные ключи RSA. См. дополнительные сведения о [ключах, секретах и сертификатах](../key-vault/general/about-keys-secrets-certificates.md).

  :::image type="content" source="media/enable-customer-managed-key/03-create-key.png" alt-text="Экран &quot;Снимок экрана: сведения о создании ключа, управляемого клиентом&quot;.":::

## <a name="enable-customer-managed-keys"></a>Активация управляемых клиентом ключей

### <a name="post-factory-creation-in-data-factory-ui"></a>После создания фабрики в пользовательском интерфейсе Фабрики данных

В этом разделе описывается процесс добавления шифрования управляемого клиентом ключа в пользовательском интерфейсе Фабрики данных _после_ создания фабрики.

> [!NOTE]
> Управляемый клиентом ключ, можно настроить только в пустой фабрике данных. Фабрика данных не может содержать такие ресурсы, как связанные службы, конвейеры и потоки данных. Рекомендуется разрешить использование управляемого клиентом ключа сразу после создания фабрики.

> [!IMPORTANT]
> Этот подход неприменим к фабрикам с поддержкой управляемой виртуальной сети. Если вы хотите зашифровать такие фабрики, рассмотрите возможность использования [альтернативного метода](#during-factory-creation-in-azure-portal).

1. Убедитесь, что Управляемое удостоверение службы (MSI) фабрики данных имеет следующие разрешения для Key Vault: _Получение_, _Распаковка ключа_ и _Упаковка ключа_.

1. Убедитесь, что фабрика данных пуста. Фабрика данных не может содержать такие ресурсы, как связанные службы, конвейеры и потоки данных. На данный момент развертывание управляемого клиентом ключа в непустой фабрике приводит к ошибке.

1. Чтобы найти URI ключа на портале Azure, перейдите к Azure Key Vault и выберите параметр "Ключи". Выберите нужный ключ, а затем щелкните его, чтобы просмотреть его версии. Выберите версию ключа для просмотра параметров.

1. Скопируйте значение поля "Идентификатор ключа", которое предоставляет URI :::image type="content" source="media/enable-customer-managed-key/04-get-key-identifier.png" alt-text="Экран &quot;Снимок экрана: получения ключа URI из Key Vault&quot;.":::

1. Запустите портал Фабрики данных Azure и перейдите с помощью панели навигации слева на портал управления Фабрикой данных Azure.

1. Щелкните значок __управляемого клиентом ключа__ :::image type="content" source="media/enable-customer-managed-key/05-customer-managed-key-configuration.png" alt-text="Экран &quot;Снимок экрана: сведения о включении управляемого клиентом ключа в пользовательском интерфейсе Фабрики данных&quot;.":::

1. Введите универсальный код ресурса (URI) для управляемого клиентом ключа, скопированного ранее.

1. Нажмите __Сохранить__, и для Фабрики данных будет включено шифрование управляемого клиентом ключа.

### <a name="during-factory-creation-in-azure-portal"></a>Во время создания фабрики на портале Azure

В этом разделе описано, как добавить шифрование с помощью управляемого клиентом ключа на портале Azure _во время_ развертывания фабрики.

Чтобы зашифровать фабрику, Фабрике данных необходимо сначала получить ключ, управляемый клиентом, из Key Vault. Поскольку развертывание по-прежнему выполняется, MSI еще недоступно для проверки подлинности с помощью Key Vault. Таким образом, чтобы использовать этот подход, клиенту необходимо назначить фабрике данных управляемое удостоверение, назначаемое пользователем (UA-MI). Предполагается, что роли были определенны в UA-MI и проходят проверку подлинности с помощью Key Vault.

Дополнительные сведения об управляемом удостоверении, назначаемом пользователем, см. в разделе [Типы управляемых удостоверений](../active-directory/managed-identities-azure-resources/overview.md#managed-identity-types) и статье [Назначение ролей для управляемого удостоверения, назначаемого пользователем](../active-directory/managed-identities-azure-resources/how-to-manage-ua-identity-portal.md).

1. Убедитесь, что управляемое удостоверение, назначаемое пользователем (UA-MI), имеет следующие разрешения для Key Vault: _Получение_, _Распаковка ключа_ и _Упаковка ключа_.

1. На вкладке __Дополнительно__ установите флажок _Enable encryption using a customer managed key_ (Включить шифрование с использованием ключа, управляемого клиентом)
  :::image type="content" source="media/enable-customer-managed-key/06-user-assigned-managed-identity.png" alt-text="Экран &quot;Снимок экрана: вкладка &quot;Дополнительно&quot; для процедуры создания фабрики данных на портале Azure&quot;.":::

1. Укажите URL-адрес для управляемого клиентом ключа, хранящегося в Key Vault

1. Выберите соответствующее управляемое удостоверение, назначаемое пользователем, для проверки подлинности с помощью Key Vault

1. Продолжите развертывание фабрики

## <a name="update-key-version"></a>Обновление версии ключа

При создании новой версии ключа обновите Фабрику данных, чтобы в ней использовалась эта новая версия. Выполните действия, аналогичные описанным в разделе [Пользовательский интерфейс Фабрики данных](#post-factory-creation-in-data-factory-ui), в том числе следующие:

1. Найдите универсальный код ресурса (URI) для новой версии ключа с помощью портала Azure Key Vault.

1. Перейдите к параметру __Управляемый клиентом ключ__.

1. Замените в нем универсальный код ресурса (URI), вставив соответствующее значение для нового ключа

1. Нажмете __Сохранить__ и Фабрика данных теперь будет использовать для шифрования новую версию ключа.

## <a name="use-a-different-key"></a>Использование другого ключа

Чтобы изменить ключ, используемый для шифрования фабрики данных, необходимо вручную обновить параметры в Фабрике данных. Выполните действия, аналогичные описанным в разделе [Пользовательский интерфейс Фабрики данных](#post-factory-creation-in-data-factory-ui), в том числе следующие:

1. Найдите универсальный код ресурса (URI) для нового ключа с помощью портала Azure Key Vault.

1. Перейдите к параметру __Управляемый клиентом ключ__.

1. Замените в нем универсальный код ресурса (URI), вставив соответствующее значение для нового ключа

1. Нажмете __Сохранить__ и Фабрика данных теперь будет использовать для шифрования новый ключ.

## <a name="disable-customer-managed-keys"></a>Отключение возможности использования управляемых клиентом ключей

После включения возможности использования управляемых клиентом ключей, исключить дополнительный шаг безопасности невозможно. Так и должно быть. Мы будем всегда рассчитывать, что клиент предоставит ключ для шифрования фабрики и данных.

## <a name="customer-managed-key-and-continuous-integration-and-continuous-deployment"></a>Управляемый клиентом ключ, непрерывная интеграция и непрерывное развертывание

По умолчанию конфигурация CMK не включена в шаблон Azure Resource Manager (ARM). Чтобы включить параметры шифрования с управляемым ключом клиента в шаблон ARM для непрерывной интеграции (CI/CD), выполните следующие действия.

1. Убедитесь, что производство находится в режиме Git.
1. Перейдите на портал управления — раздел "Управляемый клиентом ключ"
1. Установите флажок _Включить в шаблон ARM_

  :::image type="content" source="media/enable-customer-managed-key/07-include-in-template.png" alt-text="Снимок экрана включения параметра ключа, управляемого клиентом, в шаблон ARM.":::

В шаблон ARM будут добавлены следующие параметры. Эти свойства могут быть параметризованы в конвейерах непрерывной интеграции и поставки путем изменения [конфигурации параметров Azure Resource Manager](continuous-integration-deployment.md#use-custom-parameters-with-the-resource-manager-template).

  :::image type="content" source="media/enable-customer-managed-key/08-template-with-customer-managed-key.png" alt-text="Снимок экрана включения параметра ключа, управляемого клиентом, в шаблон Azure Resource Manager.":::

> [!NOTE]
> Добавление параметра шифрования в шаблоны ARM добавляет параметр уровня производства, который будет переопределять другие параметры уровня производства, такие как конфигурации Git, в других средах. Если вы включили эти параметры в среде с повышенными привилегиями, например UAT или PROD, см. [глобальные параметры в CI/CD](author-global-parameters.md#cicd).

## <a name="next-steps"></a>Дальнейшие действия

Перейдите к [руководствам](tutorial-copy-data-dot-net.md), чтобы узнать об использовании фабрики данных в различных сценариях.
