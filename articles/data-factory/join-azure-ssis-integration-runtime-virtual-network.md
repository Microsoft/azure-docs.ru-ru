---
title: Присоединение среды выполнения интеграции Azure SSIS к виртуальной сети
description: Узнайте, как присоединить среду выполнения интеграции Azure SSIS к виртуальной сети Azure.
ms.service: data-factory
ms.topic: conceptual
ms.date: 11/02/2020
author: swinarko
ms.author: sawinark
ms.openlocfilehash: 9a82b305adec1385bf659987ea39df6bb953cd70
ms.sourcegitcommit: d4734bc680ea221ea80fdea67859d6d32241aefc
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/14/2021
ms.locfileid: "100370977"
---
# <a name="join-an-azure-ssis-integration-runtime-to-a-virtual-network"></a>Присоединение среды выполнения интеграции Azure SSIS к виртуальной сети

[!INCLUDE[appliesto-adf-xxx-md](includes/appliesto-adf-xxx-md.md)]

При использовании SQL Server Integration Services (SSIS) в фабрике данных Azure необходимо присоединить среду выполнения интеграции Azure SSIS (IR) к виртуальной сети Azure в следующих сценариях:

- Необходимо подключиться к локальным хранилищам данных из пакетов служб SSIS, выполняемых на Azure-SSIS IR, без настройки и управления локальным IR в качестве прокси-сервера. 

- Вы хотите разместить базу данных каталога SSIS (SSISDB) в базе данных SQL Azure с правилами брандмауэра IP-адресов, конечными точками службы виртуальной сети или в SQL Управляемый экземпляр с закрытой конечной точкой. 

- Вы хотите подключиться к ресурсам Azure, настроенным с конечными точками службы виртуальной сети, из пакетов служб SSIS, которые выполняются на Azure-SSIS IR.

- Необходимо подключиться к хранилищам данных и ресурсам, настроенным с помощью правил брандмауэра IP-адресов из пакетов служб SSIS, которые выполняются на Azure-SSIS IR.

Фабрика данных позволяет присоединить Azure-SSIS IR к виртуальной сети, созданной с помощью классической модели развертывания или модели развертывания Azure Resource Manager.

> [!IMPORTANT]
> Классическая виртуальная сеть является устаревшей, поэтому вместо нее следует использовать виртуальную сеть Azure Resource Manager.  Если вы уже используете классическую виртуальную сеть, переключайтесь в Azure Resource Managerную виртуальную сеть как можно скорее.

В учебнике [Настройка среды выполнения интеграции Azure-SQL Server Integration Services (SSIS) (IR) для приподключения к виртуальной сети](tutorial-deploy-ssis-virtual-network.md) показаны минимальные действия, выполняемые с помощью портал Azure. Эта статья раскрывает учебник и описывает все необязательные задачи:

- Если вы используете виртуальную сеть (классическая модель).
- Если вы предместит собственные общедоступные IP-адреса для Azure-SSIS IR.
- Если используется собственный сервер системы доменных имен (DNS).
- Если в подсети используется группа безопасности сети (NSG).
- При использовании Azure ExpressRoute или определяемого пользователем маршрута (UDR).
- При использовании настраиваемого Azure-SSIS IR.
- Если вы используете подготовку Azure PowerShell.

## <a name="access-to-on-premises-data-stores"></a>Доступ к локальным хранилищам данных

Если пакеты служб SSIS обращаются к локальным хранилищам данных, вы можете присоединить Azure-SSIS IR к виртуальной сети, подключенной к локальной сети. Вы также можете настроить и управлять локальным IR в качестве прокси-сервера для Azure-SSIS IR. Дополнительные сведения см. в статье [Настройка автономного IR в качестве прокси-сервера для Azure-SSIS IR](./self-hosted-integration-runtime-proxy-ssis.md). 

При присоединении Azure-SSIS IR к виртуальной сети помните следующие важные моменты. 

- Если виртуальная сеть не подключена к локальной сети, сначала создайте [Azure Resource Managerную виртуальную сеть](../virtual-network/quick-create-portal.md#create-a-virtual-network) для присоединения Azure-SSIS IR. Затем настройте [подключение VPN-шлюза](../vpn-gateway/vpn-gateway-howto-site-to-site-classic-portal.md) типа "сеть — сеть" или подключение [ExpressRoute](../expressroute/expressroute-howto-linkvnet-classic.md) из этой виртуальной сети к локальной сети. 

- Если Azure Resource Managerная виртуальная сеть уже подключена к локальной сети в том же расположении, что и Azure-SSIS IR, вы можете присоединить к ней IR в этой виртуальной сети. 

- Если классическая виртуальная сеть уже подключена к локальной сети в другом расположении из Azure-SSIS IR, можно создать [Azure Resource Managerную виртуальную сеть](../virtual-network/quick-create-portal.md#create-a-virtual-network) для присоединения Azure-SSIS IR. Затем настройте подключение " [классический-к Azure Resource Manager виртуальной сети](../vpn-gateway/vpn-gateway-connect-different-deployment-models-portal.md) ". 
 
- Если Azure Resource Manager виртуальная сеть уже подключена к локальной сети в другом расположении из Azure-SSIS IR, можно сначала создать [Azure Resource Manager виртуальную сеть](../virtual-network/quick-create-portal.md#create-a-virtual-network) для присоединения Azure-SSIS IR. Затем настройте подключение Azure Resource Manager к Azure Resource Manager виртуальной сети. 

## <a name="hosting-the-ssis-catalog-in-sql-database"></a>Размещение каталога служб SSIS в базе данных SQL

Если вы размещаете каталог служб SSIS в базе данных SQL Azure с конечными точками службы виртуальной сети, убедитесь, что вы присоединяете Azure-SSIS IR к той же виртуальной сети и подсети.

Если вы размещаете каталог служб SSIS в SQL Управляемый экземпляр с закрытой конечной точкой, убедитесь, что вы присоединяете Azure-SSIS IR к той же виртуальной сети, но в другой подсети, чем управляемый экземпляр. Для присоединения Azure-SSIS IR к другой виртуальной сети, отличной от Управляемый экземпляр SQL, рекомендуется использовать пиринг виртуальных сетей (который ограничен тем же регионом) или подключение между виртуальной сетью и виртуальной сетью. Дополнительные сведения см. в статье [Подключение приложения к Azure SQL управляемый экземпляр](../azure-sql/managed-instance/connect-application-instance.md).

## <a name="access-to-azure-services"></a>Доступ к службам Azure

Если пакеты SSIS обращаются к ресурсам Azure, поддерживающим [конечные точки службы виртуальной сети](../virtual-network/virtual-network-service-endpoints-overview.md) , и вы хотите защитить доступ к этим ресурсам из Azure-SSIS IR, вы можете присоединить Azure-SSIS IR к подсети виртуальной сети, настроенной для конечных точек службы виртуальной сети, а затем добавить правило виртуальной сети к соответствующим ресурсам Azure, чтобы разрешить доступ из той же подсети.

## <a name="access-to-data-sources-protected-by-ip-firewall-rule"></a>Доступ к источникам данных, защищенным правилом брандмауэра IP

Если пакеты служб SSIS обращаются к хранилищам данных и ресурсам, которые разрешают только определенные статические общедоступные IP-адреса и вы хотите защитить доступ к этим ресурсам из Azure-SSIS IR, можно связать [общедоступные IP-адреса](../virtual-network/virtual-network-public-ip-address.md) с Azure-SSIS IR при присоединении к виртуальной сети, а затем добавить правило брандмауэра IP к соответствующим ресурсам, чтобы разрешить доступ с этих IP-адресов. Существует два альтернативных способа сделать это: 

- При создании Azure-SSIS IR можно использовать собственные общедоступные IP-адреса и указать их с помощью [пользовательского интерфейса фабрики данных или пакета SDK](#join-the-azure-ssis-ir-to-a-virtual-network). Только исходящее подключение к Интернету Azure-SSIS IR будет использовать предоставленные общедоступные IP-адреса, а другие устройства в подсети не будут их использовать.
- Можно также настроить [NAT виртуальной сети](../virtual-network/nat-overview.md) для подсети, которая Azure-SSIS IR будет присоединяться, и все исходящие подключения в этой подсети будут использовать указанные общедоступные IP-адреса.

Во всех случаях виртуальную сеть можно развернуть только с помощью модели развертывания Azure Resource Manager.

В следующих разделах приведены дополнительные сведения. 

## <a name="virtual-network-configuration"></a>Конфигурация виртуальной сети

Настройте виртуальную сеть в соответствии с этими требованиями: 

- Убедитесь, что `Microsoft.Batch` это зарегистрированный поставщик в подсети виртуальной сети, в которой размещается Azure-SSIS IR. При использовании классической виртуальной сети также присоединитесь `MicrosoftAzureBatch` к классической роли участника виртуальной машины для этой виртуальной сети. 

- Убедитесь, что необходимые разрешения доступны. Дополнительные сведения см. в разделе [Настройка разрешений](#perms).

- Выберите подходящую подсеть для размещения Azure-SSIS IR. Дополнительные сведения см. [в разделе Выбор подсети](#subnet). 

- Если вы перенесете собственные общедоступные IP-адреса для Azure-SSIS IR, см. статью [Выбор статических общедоступных IP-](#publicIP) адресов.

- Если вы используете собственный сервер системы доменных имен (DNS) в виртуальной сети, см. раздел [Настройка DNS-сервера](#dns_server). 

- Если в подсети используется группа безопасности сети (NSG), см. раздел [Настройка NSG](#nsg). 

- Если вы используете Azure ExpressRoute или определяемый пользователем маршрут (UDR), см. статью [Использование Azure expressroute или UDR](#route). 

- Убедитесь, что группа ресурсов виртуальной сети (или группа ресурсов общедоступных IP-адресов) может создавать и удалять определенные сетевые ресурсы Azure. Дополнительные сведения см. [в разделе Настройка группы ресурсов](#resource-group). 

- Если вы настраиваете Azure-SSIS IR, как описано в разделе [Выборочная установка для Azure-SSIS IR](./how-to-configure-azure-ssis-ir-custom-setup.md), наш внутренний процесс управления узлами будет использовать частные IP-адреса из предопределенного диапазона от 172.16.0.0 до 172.31.255.255. Поэтому убедитесь, что диапазоны частных IP-адресов ваших виртуальных или локальных сетей не конфликтуют с этим диапазоном.

На этой схеме показаны необходимые подключения для Azure-SSIS IR:

![Схема, на которой показаны необходимые подключения для Azure-SSIS IR.](media/join-azure-ssis-integration-runtime-virtual-network/azure-ssis-ir.png)

### <a name="set-up-permissions"></a><a name="perms"></a> Настройка разрешений

Пользователь, создающий Azure-SSIS IR, должен иметь следующие разрешения:

- Если вы присоединяете Azure-SSIS IR к виртуальной сети Azure Resource Manager, у вас есть два варианта:

  - Использовать встроенную роль "Участник сетей". Эта роль предоставляет разрешение _Microsoft.Network/\*_ , область применения которого намного шире, чем требуется для этой задачи.

  - Создать настраиваемую роль, которая включает только нужное разрешение _Microsoft.Network/virtualNetworks/\*/join/action_. Если вы хотите также использовать собственные общедоступные IP-адреса для Azure-SSIS IR при присоединении к Azure Resource Manager виртуальной сети, включите в эту роль разрешение _Microsoft. Network/publicIPAddresses/*/Жоин/Актион_ .

- Если вы присоединяете SSIS IR к классической виртуальной сети, мы рекомендуем использовать встроенную роль Участник классических виртуальных машин. В противном случае вам нужно будет определить пользовательскую роль, которая включает разрешение на присоединение к виртуальной сети.

### <a name="select-the-subnet"></a><a name="subnet"></a> Выбор подсети

При выборе подсети: 

- Не выбирайте GatewaySubnet для развертывания Azure-SSIS IR. Он выделен для шлюзов виртуальной сети. 

- Убедитесь, что выбранная подсеть имеет достаточно свободного адресного пространства для использования Azure-SSIS IR. Оставлять доступные IP-адреса как минимум в два раза больше, чем номер ИНФРАКРАСного узла. Azure резервирует некоторые IP-адреса в каждой подсети. Эти адреса нельзя использовать. Первый и последний IP-адреса подсетей зарезервированы для соответствия протоколу, и для служб Azure используются три адреса. Дополнительные сведения см. в разделе [Существуют ли ограничения на использование IP-адресов в пределах этих подсетей?](../virtual-network/virtual-networks-faq.md#are-there-any-restrictions-on-using-ip-addresses-within-these-subnets) 

- Не используйте подсеть, предназначенную исключительно для других служб Azure (например, SQL Database Управляемый экземпляр, служба приложений и т. д.). 

### <a name="select-the-static-public-ip-addresses"></a><a name="publicIP"></a>Выберите статические общедоступные IP-адреса

Если вы хотите использовать собственные статические общедоступные IP-адреса для Azure-SSIS IR при присоединении к виртуальной сети, убедитесь, что они отвечают следующим требованиям.

- Необходимо предоставить ровно две неиспользуемые объекты, которые еще не связаны с другими ресурсами Azure. При периодическом обновлении Azure-SSIS IR будет использоваться дополнительный. Обратите внимание, что один общедоступный IP-адрес не может быть общим для вашей активной службы Azure-SSIS IRs.

- Они должны быть статическими для стандартного типа. Дополнительные сведения см. в разделе [номера SKU общедоступного IP-адреса](../virtual-network/public-ip-addresses.md#sku) .

- Они должны иметь DNS-имя. Если вы не указали DNS-имя при создании, это можно сделать на портал Azure.

![Azure SSIS IR](media/ssis-integration-runtime-management-troubleshoot/setup-publicipdns-name.png)

- Они и виртуальная сеть должны находиться в одной и той же подписке и в одном регионе.

### <a name="set-up-the-dns-server"></a><a name="dns_server"></a> Настройка DNS-сервера 
Если вам нужно использовать собственный DNS-сервер в виртуальной сети, присоединенной Azure-SSIS IR для разрешения имени частного узла, убедитесь, что он также может разрешить глобальные имена узлов Azure (например, большой двоичный объект службы хранилища Azure `<your storage account>.blob.core.windows.net` ). 

Ниже приведен один из рекомендуемых подходов. 

-   Настройте пользовательский DNS для пересылки запросов на Azure DNS. Неразрешенные записи DNS можно пересылать по IP-адресу рекурсивных арбитров конфликтов Azure (168.63.129.16) на собственном DNS-сервере. 

Дополнительные сведения см. в разделе [разрешение имен, использующее собственный DNS-сервер](../virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances.md#name-resolution-that-uses-your-own-dns-server). 

> [!NOTE]
> Используйте полное доменное имя (FQDN) для имени частного узла (например, используйте `<your_private_server>.contoso.com` вместо `<your_private_server>` ). Кроме того, можно использовать стандартную настраиваемую установку на Azure-SSIS IR для автоматического добавления собственного DNS-суффикса (например `contoso.com` ) в любое имя домена с неполным именем и перед его использованием в DNS-запросах. см. раздел [стандартные примеры выборочной установки](./how-to-configure-azure-ssis-ir-custom-setup.md#standard-custom-setup-samples). 

### <a name="set-up-an-nsg"></a><a name="nsg"></a> Настройка NSG
Если необходимо реализовать NSG для подсети, используемой Azure-SSIS IR, разрешите входящий и исходящий трафик через следующие порты: 

-   **Требование для входящего трафика Azure-SSIS IR**

| Направление | Транспортный протокол | Источник | Диапазон исходных портов | Назначение | Диапазон портов назначения | Комментарии |
|---|---|---|---|---|---|---|
| Входящий трафик | TCP | BatchNodeManagement | * | Виртуальная сеть | 29876, 29877 (при присоединении среды выполнения интеграции к виртуальной сети Resource Manager) <br/><br/>10100, 20100, 30100 (при присоединении среды выполнения интеграции к классической виртуальной сети)| Служба фабрики данных использует эти порты для взаимодействия с узлами вашей среды выполнения интеграции Azure-SSIS IR в виртуальной сети. <br/><br/> Независимо от того, создан уровень подсети NSG или нет, Фабрика данных всегда настраивает NSG на уровне карт сетевых интерфейсов, подключенных к виртуальным машинам, на которых размещается Azure-SSIS IR. NSG уровня сетевых адаптеров на указанных портах разрешает только входящий трафик от IP-адресов Фабрики данных. Даже если эти порты доступны для интернет-трафика, трафик с IP-адресов, которые не являются IP-адресами Фабрики данных, блокируется на уровне сетевых адаптеров. |
| Входящий трафик | TCP | CorpNetSaw | * | Виртуальная сеть | 3389 | Используемых Это правило требуется только тогда, когда программа Microsoft Support просит клиента открыть для расширенного устранения неполадок и может быть закрыта сразу после устранения неполадок. Тег службы **CorpNetSaw** позволяет использовать удаленный рабочий стол только с помощью рабочих станций с защищенным доступом в корпоративной сети Майкрософт. Этот тег службы нельзя выбрать на портале, он доступен только через Azure PowerShell или Azure CLI. <br/><br/> В NSG уровня сетевых адаптеров порт 3389 открыт по умолчанию, и мы позволяем управлять портом 3389 в NSG на уровне подсети, в то время как Azure-SSIS IR по умолчанию отключил исходящий порт 3389 в правиле брандмауэра Windows на каждом узле IR в целях защиты. |
||||||||

-   **Требование исходящего трафика для Azure-SSIS IR**

| Направление | Транспортный протокол | Источник | Диапазон исходных портов | Назначение | Диапазон портов назначения | Комментарии |
|---|---|---|---|---|---|---|
| Исходящие | TCP | Виртуальная сеть | * | AzureCloud; | 443 | Узлы Azure-SSIS IR в виртуальной сети используют этот порт для доступа к службам Azure, например к службе хранилища Azure и Центрам событий Azure. |
| Исходящие | TCP | Виртуальная сеть | * | Интернет | 80 | (Необязательно.) Узлы Azure SSIS IR в виртуальной сети используют этот порт для скачивания списка отзыва сертификатов из Интернета. Если заблокировать этот трафик, производительность при запуске IR может снизиться и вы можете потерять возможность выполнить проверку списка отзыва сертификатов для использования сертификата. Если вы хотите дополнительно сузить место назначения до определенных полных доменных имен, ознакомьтесь с разделом **Использование Azure ExpressRoute или UDR** .|
| Исходящие | TCP | Виртуальная сеть | * | SQL | 1433, 11000–11999 | Используемых Это правило требуется только в том случае, если узлы Azure-SSIS IR в виртуальной сети обращаются к SSISDB, размещенной на сервере. Если для политики подключения сервера задано значение **прокси** вместо **перенаправления**, то требуется только порт 1433. <br/><br/> Это правило безопасности для исходящего трафика не применимо к SSISDB, размещенной в Управляемый экземпляр SQL в виртуальной сети или базе данных SQL, настроенной с помощью частной конечной точки. |
| Исходящие | TCP | Виртуальная сеть | * | Виртуальная сеть | 1433, 11000–11999 | Используемых Это правило требуется только в том случае, если узлы Azure-SSIS IR в виртуальной сети обращаются к SSISDB, размещенной в Управляемый экземпляре SQL в виртуальной сети или базе данных SQL, настроенной с помощью частной конечной точки. Если для политики подключения сервера задано значение **прокси** вместо **перенаправления**, то требуется только порт 1433. |
| Исходящие | TCP | Виртуальная сеть | * | Память | 445 | (Необязательно.) Это правило требуется только при выполнении пакета службы интеграции SQL Server, хранящегося в службе "Файлы Azure". |
||||||||

### <a name="use-azure-expressroute-or-udr"></a><a name="route"></a> Использование Azure ExpressRoute или UDR
Если вы хотите проверить исходящий трафик от Azure-SSIS IR, можно направить трафик, инициированный из Azure-SSIS IR, в локальное устройство брандмауэра с помощью [Azure ExpressRoute](https://azure.microsoft.com/services/expressroute/) Force Tunneling (объявление маршрута BGP, 0.0.0.0/0, виртуальной сети) или сетевого виртуального устройства (NVA) в качестве брандмауэра или [брандмауэра Azure](../firewall/index.yml) через [определяемые пользователем маршруты](../virtual-network/virtual-networks-udr-overview.md). 

![Сценарий NVA для Azure-SSIS IR](media/join-azure-ssis-integration-runtime-virtual-network/azure-ssis-ir-nva.png)

Для выполнения всего сценария необходимо выполнить следующие действия.
   -   Входящий трафик между службами управления пакетной службой Azure и Azure-SSIS IR не может маршрутизироваться через устройство брандмауэра.
   -   Устройство брандмауэра должно разрешать исходящий трафик, необходимый для Azure-SSIS IR.

Входящий трафик между службами управления пакетной службой Azure и Azure-SSIS IR не может маршрутизироваться к устройству брандмауэра. в противном случае трафик будет разорван из-за проблемы с асимметричной маршрутизацией. Маршруты должны быть определены для входящего трафика, чтобы трафик мог обратно ответить так же, как он был в нем. Вы можете определить конкретные определяемые пользователем маршруты для маршрутизации трафика между службами управления пакетной службой Azure и Azure-SSIS IR с типом следующего прыжка в **Интернете**.

Например, если Azure-SSIS IR расположен в `UK South` и вы хотите проверить исходящий трафик через брандмауэр Azure, сначала необходимо получить список диапазонов IP-адресов `BatchNodeManagement.UKSouth` из [ссылки для скачивания тегов службы](https://www.microsoft.com/download/details.aspx?id=56519) или через [API обнаружения тегов служб](../virtual-network/service-tags-overview.md#service-tags-on-premises). Затем примените следующие определяемые пользователем маршруты маршрутов диапазонов IP-адресов с типом следующего прыжка в **Интернете** вместе с маршрутом 0.0.0.0/0 и типом следующего прыжка в качестве **виртуального устройства**.

![Параметры UDR пакетной службы Azure](media/join-azure-ssis-integration-runtime-virtual-network/azurebatch-udr-settings.png)

> [!NOTE]
> Этот подход влечет за собой дополнительную стоимость обслуживания. Регулярно проверяйте диапазон IP-адресов и добавьте новые диапазоны IP-адресов в UDR, чтобы избежать нарушения Azure-SSIS IR. Мы рекомендуем проверять диапазон IP-адресов ежемесячно, так как при появлении нового IP-адреса в теге службы этот IP-адрес будет действовать в следующий месяц. 

Чтобы упростить настройку правил UDR, можно выполнить следующий сценарий PowerShell, чтобы добавить правила UDR для служб управления пакетной службой Azure.
```powershell
$Location = "[location of your Azure-SSIS IR]"
$RouteTableResourceGroupName = "[name of Azure resource group that contains your Route Table]"
$RouteTableResourceName = "[resource name of your Azure Route Table ]"
$RouteTable = Get-AzRouteTable -ResourceGroupName $RouteTableResourceGroupName -Name $RouteTableResourceName
$ServiceTags = Get-AzNetworkServiceTag -Location $Location
$BatchServiceTagName = "BatchNodeManagement." + $Location
$UdrRulePrefixForBatch = $BatchServiceTagName
if ($ServiceTags -ne $null)
{
    $BatchIPRanges = $ServiceTags.Values | Where-Object { $_.Name -ieq $BatchServiceTagName }
    if ($BatchIPRanges -ne $null)
    {
        Write-Host "Start to add rule for your route table..."
        for ($i = 0; $i -lt $BatchIPRanges.Properties.AddressPrefixes.Count; $i++)
        {
            $UdrRuleName = "$($UdrRulePrefixForBatch)_$($i)"
            Add-AzRouteConfig -Name $UdrRuleName `
                -AddressPrefix $BatchIPRanges.Properties.AddressPrefixes[$i] `
                -NextHopType "Internet" `
                -RouteTable $RouteTable `
                | Out-Null
            Write-Host "Add rule $UdrRuleName to your route table..."
        }
        Set-AzRouteTable -RouteTable $RouteTable
    }
}
else
{
    Write-Host "Failed to fetch service tags, please confirm that your Location is valid."
}
```

Чтобы устройство брандмауэра позволяло исходящий трафик, необходимо разрешить исходящие пакеты на порты ниже, как и в правилах исходящих подключений NSG.
-   Порт 443 с целевым объектом в качестве облачных служб Azure.

    При использовании брандмауэра Azure можно указать правило сети с тегом службы AzureCloud. Для брандмауэра других типов можно просто разрешить назначение как все для порта 443 или разрешить следующие полные доменные имена в зависимости от типа среды Azure:

    | Среда Azure | Конечные точки                                                                                                                                                                                                                                                                                                                                                              |
    |-------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
    | Azure Public      | <ul><li><b>Фабрика данных Azure (управление)</b><ul><li>\*. frontend.clouddatahub.net</li></ul></li><li><b>Служба хранилища Azure (управление)</b><ul><li>\*.blob.core.windows.net</li><li>\*. table.core.windows.net</li></ul></li><li><b>Реестр контейнеров Azure (Выборочная установка)</b><ul><li>\*.azurecr.io</li></ul></li><li><b>Концентратор событий (ведение журнала)</b><ul><li>\*.servicebus.windows.net.</li></ul></li><li><b>Служба ведения журнала Майкрософт (для внутреннего использования)</b><ul><li>gcs.prod.monitoring.core.windows.net</li><li>prod.warmpath.msftcloudes.com;</li><li>azurewatsonanalysis-prod.core.windows.net</li></ul></li></ul> |
    | Azure для государственных организаций  | <ul><li><b>Фабрика данных Azure (управление)</b><ul><li>\*. frontend.datamovement.azure.us</li></ul></li><li><b>Служба хранилища Azure (управление)</b><ul><li>\*.blob.core.usgovcloudapi.net</li><li>\*. table.core.usgovcloudapi.net</li></ul></li><li><b>Реестр контейнеров Azure (Выборочная установка)</b><ul><li>\*. azurecr.us</li></ul></li><li><b>Концентратор событий (ведение журнала)</b><ul><li>\*. servicebus.usgovcloudapi.net</li></ul></li><li><b>Служба ведения журнала Майкрософт (для внутреннего использования)</b><ul><li>fairfax.warmpath.usgovcloudapi.net;</li><li>azurewatsonanalysis.usgovcloudapp.net</li></ul></li></ul> |
    | Azure China 21Vianet     | <ul><li><b>Фабрика данных Azure (управление)</b><ul><li>\*. frontend.datamovement.azure.cn</li></ul></li><li><b>Служба хранилища Azure (управление)</b><ul><li>\*. blob.core.chinacloudapi.cn</li><li>\*. table.core.chinacloudapi.cn</li></ul></li><li><b>Реестр контейнеров Azure (Выборочная установка)</b><ul><li>\*. azurecr.cn</li></ul></li><li><b>Концентратор событий (ведение журнала)</b><ul><li>\*. servicebus.chinacloudapi.cn</li></ul></li><li><b>Служба ведения журнала Майкрософт (для внутреннего использования)</b><ul><li>mooncake.warmpath.chinacloudapi.cn;</li><li>azurewatsonanalysis.chinacloudapp.cn</li></ul></li></ul> |

    Как и для полных доменных имен службы хранилища Azure, реестра контейнеров Azure и концентратора событий, можно включить следующие конечные точки служб для виртуальной сети, чтобы сетевой трафик к этим конечным точкам проходил через магистральную сеть Azure, а не направляться на устройство брандмауэра.
    -  Microsoft.Storage;
    -  Microsoft.ContainerRegistry
    -  Microsoft.EventHub


-   Порт 80 с целевым объектом в качестве сайтов скачивания списков отзыва сертификатов.

    Вы должны предоставить следующие полные доменные имена, используемые в качестве CRL (список отзыва сертификатов), скачивать сайты сертификатов для целей управления Azure-SSIS IR:
    -  crl.microsoft.com:80
    -  mscrl.microsoft.com:80
    -  crl3.digicert.com:80
    -  crl4.digicert.com:80
    -  ocsp.digicert.com:80
    -  cacerts.digicert.com:80
    
    Если используются сертификаты с разными CRL, рекомендуется также включить их. Его можно прочитать, чтобы получить дополнительные сведения о [списке отзыва сертификатов](https://social.technet.microsoft.com/wiki/contents/articles/2303.understanding-access-to-microsoft-certificate-revocation-list.aspx).

    Если вы запретили этот трафик, вы можете столкнуться с понижением производительности при запуске Azure-SSIS IR и потерять возможность проверки списка отзыва сертификатов для использования сертификата, что не рекомендуется с точки зрения безопасности.

-   Порт 1433, 11000-11999 с назначением в качестве базы данных SQL Azure (требуется только в том случае, если узлы Azure-SSIS IR в виртуальной сети обращаются к SSISDB, размещенной на сервере).

    При использовании брандмауэра Azure можно указать правило сети с помощью тега службы SQL Azure. в противном случае можно разрешить назначение в качестве конкретного URL-адреса SQL Azure в устройстве брандмауэра.

-   Порт 445 с назначением в качестве хранилища Azure (требуется только при выполнении пакета служб SSIS, хранящегося в службе файлов Azure).

    При использовании брандмауэра Azure можно указать правило сети с помощью тега службы хранилища. в противном случае можно разрешить назначение как конкретный URL-адрес хранилища файлов Azure в устройстве брандмауэра.

> [!NOTE]
> Для Azure SQL и хранилища при настройке конечных точек службы виртуальной сети в подсети трафик между Azure-SSIS IR и Azure SQL в одном регионе с хранилищем Azure в одном регионе или в парном регионе будет направляться в Microsoft Azure магистральной сети напрямую, а не на устройство брандмауэра.

Если вам не нужна возможность проверки исходящего трафика Azure-SSIS IR, можно просто применить маршрут, чтобы принудительно передать весь трафик в тип " **Интернет**" следующего прыжка:

-   В сценарии Azure ExpressRoute можно применить маршрут 0.0.0.0/0 с типом следующего прыжка в **Интернете** в подсети, в которой размещается Azure-SSIS IR. 
-   В сценарии NVA можно изменить существующий маршрут 0.0.0.0/0, применяемый к подсети, в которой размещен Azure-SSIS IR, из типа следующего прыжка в качестве **виртуального устройства** в **Интернет**.

![Добавление маршрута](media/join-azure-ssis-integration-runtime-virtual-network/add-route-for-vnet.png)

> [!NOTE]
> Укажите маршрут с типом следующего прыжка **Интернет** не означает, что весь трафик будет проходить через Интернет. Пока адрес назначения предназначен для одной из служб Azure, Azure направляет трафик непосредственно в службу через магистральную сеть Azure вместо маршрутизации трафика в Интернет.

### <a name="set-up-the-resource-group"></a><a name="resource-group"></a> Настройка группы ресурсов

Среда выполнения интеграции Azure SSIS должна создать определенные сетевые ресурсы в той же группе ресурсов, в которой находится виртуальная сеть. К этим ресурсам относятся:
- Балансировщик нагрузки Azure с именем *\<Guid> -azurebatch-клаудсервицелоадбаланцер*.
- Общедоступный IP-адрес Azure с именем *\<Guid> -azurebatch-клаудсервицепублиЦип*.
- Группа безопасности рабочей сети с именем *\<Guid> -azurebatch-клаудсервиценетворксекуритиграуп*. 

> [!NOTE]
> Теперь вы можете перенести собственные статические общедоступные IP-адреса для Azure-SSIS IR. В этом сценарии мы создадим только подсистему балансировки нагрузки Azure и группу безопасности сети в той же группе ресурсов, что и статические общедоступные IP-адреса, а не виртуальную сеть.

Эти ресурсы будут созданы при запуске Azure-SSIS IR. Они будут удалены после остановки Azure-SSIS IR. Если вы перенесете собственные статические общедоступные IP-адреса для Azure-SSIS IR, ваши собственные статические IP-адреса не будут удалены при остановке Azure-SSIS IR. Чтобы предотвратить блокировку остановки Azure-SSIS IR, не используйте повторно эти сетевые ресурсы в других ресурсах.

Убедитесь в отсутствии блокировки ресурсов для группы ресурсов или подписки, к которой принадлежат виртуальная сеть или статические общедоступные IP-адреса. Если вы настроили блокировку только для чтения или удаления, запуск и остановка среды Azure-SSIS IR завершатся ошибкой или она перестанет отвечать на запросы.

Убедитесь, что у вас нет назначения политики Azure, которое предотвращает создание следующих ресурсов в группе ресурсов или подписке, к которой принадлежат виртуальная сеть или статические общедоступные IP-адреса. 
- Microsoft.Network/LoadBalancers 
- Microsoft.Network/NetworkSecurityGroups 
- Microsoft.Network/PublicIPAddresses 

Убедитесь, что квота ресурса для вашей подписки достаточна для перечисленных выше трех сетевых ресурсов. В частности, для каждого Azure-SSIS IR, созданного в виртуальной сети, необходимо зарезервировать две свободные квоты для каждого из перечисленных выше трех сетевых ресурсов. При периодическом обновлении Azure-SSIS IR будет использоваться одна квота.

### <a name="faq"></a><a name="faq"></a> Вопросы и ответы

- Как защитить общедоступный IP-адрес, предоставленный на моем Azure-SSIS IR для входящего подключения? Можно ли удалить общедоступный IP-адрес?
 
  Сейчас общедоступный IP-адрес будет создан автоматически, когда Azure-SSIS IR присоединяется к виртуальной сети. У нас есть NSG на уровне сетевой карты, чтобы разрешить входящие подключения к Azure-SSIS IR только службам управления пакетной службой Azure. Можно также указать NSG на уровне подсети для защиты входящего трафика.

  Если вы не хотите предоставлять общедоступный IP-адрес, рассмотрите возможность [настройки самостоятельно размещенного IR в качестве прокси-сервера для Azure-SSIS IR](./self-hosted-integration-runtime-proxy-ssis.md) вместо присоединения Azure-SSIS IR к виртуальной сети, если это применимо к вашему сценарию.
 
- Можно ли добавить общедоступный IP-адрес из папки "Мои Azure-SSIS IR" в список разрешений брандмауэра для источников данных?

  Теперь вы можете перенести собственные статические общедоступные IP-адреса для Azure-SSIS IR. В этом случае можно добавить IP-адреса в список разрешений брандмауэра для источников данных. Вы также можете использовать другие параметры, чтобы защитить доступ к данным из Azure-SSIS IR в зависимости от сценария.

  - Если ваш источник данных локальный, после подключения виртуальной сети к локальной сети и присоединения Azure-SSIS IR к подсети виртуальной сети можно добавить диапазон частных IP-адресов этой подсети в список разрешений брандмауэра для источника данных.
  - Если источником данных является служба Azure, которая поддерживает конечные точки службы виртуальной сети, можно настроить конечную точку службы виртуальной сети в подсети виртуальной сети и присоединить Azure-SSIS IR к этой подсети. Затем можно добавить правило виртуальной сети с этой подсетью в брандмауэр для источника данных.
  - Если источником данных является облачная служба, не относящаяся к Azure, вы можете использовать UDR для маршрутизации исходящего трафика из Azure-SSIS IR в брандмауэр NVA/Azure через статический общедоступный IP-адрес. Затем можно добавить статический общедоступный IP-адрес своего брандмауэра NVA/Azure в список разрешений брандмауэра для источника данных.
  - Если ни один из указанных вариантов не удовлетворяет вашим потребностям, рассмотрите возможность [настройки локальной среды IR в качестве прокси-сервера для Azure-SSIS IR](./self-hosted-integration-runtime-proxy-ssis.md). Затем можно добавить статический общедоступный IP-адрес компьютера, на котором размещена локальная среда IR, в список разрешений брандмауэра для источника данных.

- Зачем мне нужно предоставлять два статических общедоступных адреса, если я хочу использовать для Azure-SSIS IR?

  Azure-SSIS IR автоматически обновляется на регулярной основе. Новые узлы создаются во время обновления, и старые будут удалены. Однако во избежание простоя старые узлы не удаляются, пока новые не будут готовы. Поэтому ваш первый статический общедоступный IP-адрес, используемый старыми узлами, не может быть освобожден немедленно, и для создания новых узлов нам нужен второй статический общедоступный IP-адрес.

- Я принимаю статические общедоступные IP-адреса для Azure-SSIS IR, но почему он по-прежнему не может получить доступ к источникам данных?

  - Убедитесь, что два статических общедоступных IP-адреса добавлены в список разрешений брандмауэра для источников данных. При каждом обновлении Azure-SSIS IR его статический общедоступный IP-адрес переключается между двумя, предоставленными вами. Если добавить в список разрешений только один из них, доступ к данным для Azure-SSIS IR будет нарушен после его обновления.
  - Если источником данных является служба Azure, проверьте, настроена ли она с конечными точками службы виртуальной сети. В этом случае трафик от Azure-SSIS IR к источнику данных будет переключаться на использование частных IP-адресов, управляемых службами Azure, и добавление собственных статических общедоступных IP-адресов в список разрешений брандмауэра для источника данных не вступит в силу.

## <a name="azure-portal-data-factory-ui"></a>Портал Azure (пользовательский интерфейс фабрики данных)

В этом разделе показано, как присоединить существующую Azure-SSIS IR к виртуальной сети (классической или Azure Resource Manager) с помощью портал Azure и пользовательского интерфейса фабрики данных. 

Перед присоединением Azure-SSIS IR к виртуальной сети необходимо правильно настроить виртуальную сеть. Выполните действия, описанные в разделе, который относится к типу виртуальной сети (классическая или Azure Resource Manager). Затем выполните действия, описанные в третьем разделе, чтобы присоединить Azure-SSIS IR к виртуальной сети. 

### <a name="configure-an-azure-resource-manager-virtual-network"></a>Настройка виртуальной сети Azure Resource Manager

С помощью портала настройте виртуальную сеть Azure Resource Manager, прежде чем пытаться присоединить к ней Azure-SSIS IR.

1. Запустите Microsoft Edge или Google Chrome. В настоящее время пользовательский интерфейс фабрики данных поддерживается только в этих веб-браузерах. 

1. Войдите на [портал Azure](https://portal.azure.com). 

1. Выберите **больше служб**. Примените фильтр и выберите **Виртуальные сети**. 

1. Примените фильтр и выберите в списке свою виртуальную сеть. 

1. На странице **Виртуальная сеть** выберите **Свойства**. 

1. Нажмите кнопку копирования напротив поля **Идентификатор ресурса**, чтобы скопировать идентификатор ресурса для виртуальной сети в буфер обмена. Сохраните идентификатор из буфера обмена в OneNote или в файле. 

1. В меню слева выберите **подсети**. Убедитесь, что число доступных адресов превышает количество узлов в Azure-SSIS IR. 

1. Убедитесь, что поставщик пакетной службы Azure зарегистрирован в подписке Azure, которая содержит виртуальную сеть. Или зарегистрируйте поставщик пакетной службы Azure. Если у вас уже есть учетная запись пакетной службы Azure в вашей подписке, ваша подписка будет зарегистрирована в пакетной службе Azure. (При создании Azure-SSIS IR на портале фабрики данных поставщик пакетной службы Azure регистрируется автоматически.) 

   1. В портал Azure в меню слева выберите **подписки**. 

   1. Выберите свою подписку. 

   1. В левой части выберите **поставщики ресурсов** и убедитесь, что **Microsoft.BatCH** является зарегистрированным поставщиком. 

   ![Подтверждение состояния "Зарегистрировано"](media/join-azure-ssis-integration-runtime-virtual-network/batch-registered-confirmation.png)

   Если поставщик **Microsoft.Batch** не отображается в списке, то для его регистрации [создайте в своей подписке пустую учетную запись пакетной службы Azure](../batch/batch-account-create-portal.md). Затем ее можно будет удалить. 

### <a name="configure-a-classic-virtual-network"></a>Настройка классической виртуальной сети

Используйте портал для настройки классической виртуальной сети, прежде чем пытаться присоединить к ней Azure-SSIS IR. 

1. Запустите Microsoft Edge или Google Chrome. В настоящее время пользовательский интерфейс фабрики данных поддерживается только в этих веб-браузерах. 

1. Войдите на [портал Azure](https://portal.azure.com). 

1. Выберите **больше служб**. Примените фильтр и выберите **Виртуальные сети (классика)**. 

1. Примените фильтр и выберите в списке свою виртуальную сеть. 

1. На странице **Виртуальные сети (классика)** выберите **Свойства**. 

   ![Идентификатор ресурса классической виртуальной сети](media/join-azure-ssis-integration-runtime-virtual-network/classic-vnet-resource-id.png)

1. Нажмите кнопку копирования напротив поля **Идентификатор ресурса**, чтобы скопировать идентификатор ресурса для классической сети в буфер обмена. Сохраните идентификатор из буфера обмена в OneNote или в файле. 

1. В меню слева выберите **подсети**. Убедитесь, что число доступных адресов превышает количество узлов в Azure-SSIS IR. 

   ![Число доступных адресов в виртуальной сети](media/join-azure-ssis-integration-runtime-virtual-network/number-of-available-addresses.png)

1. Присоедините **MicrosoftAzureBatch** к роли **Участник классической виртуальной машины** для виртуальной сети. 

   1. В меню слева выберите **Управление доступом (IAM)** и перейдите на вкладку **назначения ролей** . 

       ![Кнопки "Управление доступом" и "Добавить"](media/join-azure-ssis-integration-runtime-virtual-network/access-control-add.png)

   1. Выберите **Добавить назначение ролей**.

   1. На странице **Добавление назначения ролей** выберите **роль** **участник классической виртуальной машины**. В поле **SELECT** вставьте **ddbf3205-c6bd-46ae-8127-60eb93363864**, а затем выберите **Пакетная служба Microsoft Azure** из списка результатов поиска. 

       ![Результаты поиска на странице "Добавление назначения ролей"](media/join-azure-ssis-integration-runtime-virtual-network/azure-batch-to-vm-contributor.png)

   1. Нажмите кнопку **сохранить** , чтобы сохранить параметры и закрыть страницу. 

       ![Сохранение параметров доступа](media/join-azure-ssis-integration-runtime-virtual-network/save-access-settings.png)

   1. Убедитесь, что в списке участников отображается **пакетная служба Microsoft Azure**. 

       ![Подтверждение доступа к пакетной службе Azure](media/join-azure-ssis-integration-runtime-virtual-network/azure-batch-in-list.png)

1. Убедитесь, что поставщик пакетной службы Azure зарегистрирован в подписке Azure, которая содержит виртуальную сеть. Или зарегистрируйте поставщик пакетной службы Azure. Если у вас уже есть учетная запись пакетной службы Azure в вашей подписке, ваша подписка будет зарегистрирована в пакетной службе Azure. (При создании Azure-SSIS IR на портале фабрики данных поставщик пакетной службы Azure регистрируется автоматически.) 

   1. В портал Azure в меню слева выберите **подписки**. 

   1. Выберите свою подписку. 

   1. В левой части выберите **поставщики ресурсов** и убедитесь, что **Microsoft.BatCH** является зарегистрированным поставщиком. 

   ![Подтверждение состояния "Зарегистрировано"](media/join-azure-ssis-integration-runtime-virtual-network/batch-registered-confirmation.png)

   Если поставщик **Microsoft.Batch** не отображается в списке, то для его регистрации [создайте в своей подписке пустую учетную запись пакетной службы Azure](../batch/batch-account-create-portal.md). Затем ее можно будет удалить. 

### <a name="join-the-azure-ssis-ir-to-a-virtual-network"></a>Присоединение среды выполнения интеграции Azure SSIS к виртуальной сети

После настройки Azure Resource Manager виртуальной сети или классической виртуальной сети можно присоединить Azure-SSIS IR к виртуальной сети.

1. Запустите Microsoft Edge или Google Chrome. В настоящее время пользовательский интерфейс фабрики данных поддерживается только в этих веб-браузерах. 

1. В [портал Azure](https://portal.azure.com)в меню слева выберите **фабрики данных**. Если в меню не отображаются **фабрики данных** , выберите **больше служб**, а затем в разделе **аналитики и аналитика** выберите **фабрики данных**. 

   ![Список фабрик данных](media/join-azure-ssis-integration-runtime-virtual-network/data-factories-list.png)

1. Выберите фабрику данных с Azure-SSIS IR в списке. После этого откроется домашняя страница фабрики данных. Щелкните плитку **Создание и мониторинг**. На отдельной вкладке откроется пользовательский интерфейс фабрики данных. 

   ![Домашняя страница фабрики данных](media/join-azure-ssis-integration-runtime-virtual-network/data-factory-home-page.png)

1. В пользовательском интерфейсе фабрики данных перейдите на вкладку **Правка**, щелкните **Подключения**, а затем выберите вкладку **сред выполнения интеграции**. 

   ![Вкладка сред выполнения интеграции](media/join-azure-ssis-integration-runtime-virtual-network/integration-runtimes-tab.png)

1. Если Azure-SSIS IR выполняется, в списке **среды выполнения интеграции** в столбце **действия** нажмите кнопку " **Отключить** " для Azure-SSIS IR. Вы не сможете изменить Azure-SSIS IR, пока не завершите ее. 

   ![Остановка среды выполнения интеграции](media/join-azure-ssis-integration-runtime-virtual-network/stop-ir-button.png)

1. В списке **среды выполнения интеграции** в столбце **действия** нажмите кнопку **изменить** для Azure-SSIS IR. 

   ![Изменение среды выполнения интеграции](media/join-azure-ssis-integration-runtime-virtual-network/integration-runtime-edit.png)

1. На панели настройки среды выполнения интеграции перейдите к разделу **Общие параметры** и **параметры SQL** , нажав кнопку **Далее** . 

1. В разделе **Дополнительные параметры** : 

   1. Выберите **вариант выбрать виртуальную сеть для присоединиться к Azure-SSIS Integration Runtime, разрешить ADF-файл для создания определенных сетевых ресурсов и при необходимости установить собственный статический список общедоступных IP-адресов** . 

   1. В поле **Подписка** выберите подписку Azure, в которой расположена виртуальная сеть.

   1. В поле **Расположение** введите то же расположение среды выполнения интеграции.

   1. В поле **тип** выберите тип виртуальной сети: классический или Azure Resource Manager. Рекомендуется выбрать виртуальную сеть Azure Resource Manager, так как классические виртуальные сети скоро будут считаться устаревшими.

   1. В поле **Имя виртуальной сети** выберите имя вашей виртуальной сети. Он должен быть тем же, что используется для базы данных SQL с конечными точками службы виртуальной сети или SQL Управляемый экземпляр с частной конечной точкой для размещения SSISDB. Он должен быть тем же, что и подключение к локальной сети. В противном случае может быть любая виртуальная сеть, чтобы использовать собственные статические общедоступные IP-адреса для Azure-SSIS IR.

   1. В поле **Имя подсети** выберите имя подсети в виртуальной сети. Он должен быть тем же, что используется для базы данных SQL с конечными точками службы виртуальной сети для размещения SSISDB. Кроме того, он должен быть другой подсетью, используемой для SQL Управляемый экземпляр с частной конечной точкой для размещения SSISDB. В противном случае она может быть любой подсетью, чтобы использовать собственные статические общедоступные IP-адреса для Azure-SSIS IR.

   1. Установите флажок **привести статические общедоступные IP-адреса для Azure-SSIS Integration Runtime** , чтобы выбрать, следует ли использовать собственные статические общедоступные IP-адреса для Azure-SSIS IR, чтобы разрешить их в брандмауэре для источников данных.

      Если вы установите флажок, выполните следующие действия.

      1. Для **первого статического общедоступного IP-адреса** выберите первый статический общедоступный IP-адрес, [соответствующий требованиям](#publicIP) для Azure-SSIS IR. Если у вас нет, щелкните **создать новую** ссылку, чтобы создать статические общедоступные IP-адреса на портал Azure а затем нажмите кнопку обновить здесь, чтобы их можно было выбрать.
      
      1. Для **второго статического общедоступного IP-адреса** выберите второй статический общедоступный IP-адрес, [соответствующий требованиям](#publicIP) для Azure-SSIS IR. Если у вас нет, щелкните **создать новую** ссылку, чтобы создать статические общедоступные IP-адреса на портал Azure а затем нажмите кнопку обновить здесь, чтобы их можно было выбрать.

   1. Выберите **Проверка виртуальной сети**. Если проверка прошла успешно, нажмите кнопку **продолжить**. 

   ![Дополнительные параметры с использованием виртуальной сети](./media/tutorial-create-azure-ssis-runtime-portal/advanced-settings-vnet.png)

1. В разделе **Сводка** проверьте все параметры для Azure-SSIS IR. Затем выберите **Обновить**.

1. Запустите Azure-SSIS IR, нажав кнопку **Пуск** в столбце **действия** для Azure-SSIS IR. Запуск Azure-SSIS IR, который присоединяется к виртуальной сети, займет от 20 до 30 минут. 

## <a name="azure-powershell"></a>Azure PowerShell

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

### <a name="define-the-variables"></a>Определение переменных

```powershell
$ResourceGroupName = "[your Azure resource group name]"
$DataFactoryName = "[your data factory name]"
$AzureSSISName = "[your Azure-SSIS IR name]"
# Virtual network info: Classic or Azure Resource Manager
$VnetId = "[your virtual network resource ID or leave it empty]" # REQUIRED if you use SQL Database with IP firewall rules/virtual network service endpoints or SQL Managed Instance with private endpoint to host SSISDB, or if you require access to on-premises data without configuring a self-hosted IR. We recommend an Azure Resource Manager virtual network, because classic virtual networks will be deprecated soon.
$SubnetName = "[your subnet name or leave it empty]" # WARNING: Use the same subnet as the one used for SQL Database with virtual network service endpoints, or a different subnet from the one used for SQL Managed Instance with a private endpoint
# Public IP address info: OPTIONAL to provide two standard static public IP addresses with DNS name under the same subscription and in the same region as your virtual network
$FirstPublicIP = "[your first public IP address resource ID or leave it empty]"
$SecondPublicIP = "[your second public IP address resource ID or leave it empty]"
```

### <a name="configure-a-virtual-network"></a>Настройка виртуальной сети

Перед присоединением Azure-SSIS IR к виртуальной сети необходимо настроить виртуальную сеть. Чтобы автоматически настроить разрешения и параметры виртуальной сети для Azure-SSIS IR присоединиться к виртуальной сети, добавьте следующий скрипт:

```powershell
# Make sure to run this script against the subscription to which the virtual network belongs.
if(![string]::IsNullOrEmpty($VnetId) -and ![string]::IsNullOrEmpty($SubnetName))
{
    # Register to the Azure Batch resource provider
    $BatchApplicationId = "ddbf3205-c6bd-46ae-8127-60eb93363864"
    $BatchObjectId = (Get-AzADServicePrincipal -ServicePrincipalName $BatchApplicationId).Id
    Register-AzResourceProvider -ProviderNamespace Microsoft.Batch
    while(!(Get-AzResourceProvider -ProviderNamespace "Microsoft.Batch").RegistrationState.Contains("Registered"))
    {
    Start-Sleep -s 10
    }
    if($VnetId -match "/providers/Microsoft.ClassicNetwork/")
    {
        # Assign the VM contributor role to Microsoft.Batch
        New-AzRoleAssignment -ObjectId $BatchObjectId -RoleDefinitionName "Classic Virtual Machine Contributor" -Scope $VnetId
    }
}
```

### <a name="create-an-azure-ssis-ir-and-join-it-to-a-virtual-network"></a>Создание среды выполнения интеграции Azure SSIS и ее присоединение к виртуальной сети

Вы можете создать среду выполнения интеграции Azure SSIS и присоединить ее к виртуальной сети одновременно. Полный сценарий и инструкции см. в разделе [создание Azure-SSIS IR](create-azure-ssis-integration-runtime.md#use-azure-powershell-to-create-an-integration-runtime).

### <a name="join-an-existing-azure-ssis-ir-to-a-virtual-network"></a>Присоединение имеющейся среды выполнения интеграции Azure SSIS к виртуальной сети

В статье [создание Azure-SSIS IR](create-azure-ssis-integration-runtime.md) показано, как создать Azure-SSIS IR и присоединить ее к виртуальной сети в том же скрипте. Если у вас уже есть Azure-SSIS IR, выполните следующие действия, чтобы присоединить его к виртуальной сети. 
1. Остановите среду выполнения интеграции Azure SSIS. 
1. Настройте среду выполнения интеграции Azure SSIS для присоединения виртуальной сети. 
1. Запустите среду выполнения интеграции Azure SSIS. 

### <a name="stop-the-azure-ssis-ir"></a>Остановка среды выполнения интеграции Azure SSIS

Чтобы присоединиться к виртуальной сети, необходимо прерывать Azure-SSIS IR. Следующая команда освобождает все узлы и прекращает выставление счетов.

```powershell
Stop-AzDataFactoryV2IntegrationRuntime -ResourceGroupName $ResourceGroupName `
    -DataFactoryName $DataFactoryName `
    -Name $AzureSSISName `
    -Force 
```

### <a name="configure-virtual-network-settings-for-the-azure-ssis-ir-to-join"></a>Настройка параметров виртуальной сети для присоединения средой выполнения интеграции Azure SSIS

Чтобы настроить параметры для виртуальной сети, к которой будут присоединяться службы Azure SSIS, используйте следующий скрипт: 

```powershell
# Make sure to run this script against the subscription to which the virtual network belongs.
if(![string]::IsNullOrEmpty($VnetId) -and ![string]::IsNullOrEmpty($SubnetName))
{
    # Register to the Azure Batch resource provider
    $BatchApplicationId = "ddbf3205-c6bd-46ae-8127-60eb93363864"
    $BatchObjectId = (Get-AzADServicePrincipal -ServicePrincipalName $BatchApplicationId).Id
    Register-AzResourceProvider -ProviderNamespace Microsoft.Batch
    while(!(Get-AzResourceProvider -ProviderNamespace "Microsoft.Batch").RegistrationState.Contains("Registered"))
    {
        Start-Sleep -s 10
    }
    if($VnetId -match "/providers/Microsoft.ClassicNetwork/")
    {
        # Assign VM contributor role to Microsoft.Batch
        New-AzRoleAssignment -ObjectId $BatchObjectId -RoleDefinitionName "Classic Virtual Machine Contributor" -Scope $VnetId
    }
}
```

### <a name="configure-the-azure-ssis-ir"></a>Настройка среды выполнения интеграции Azure SSIS

Чтобы присоединить Azure-SSIS IR к виртуальной сети, выполните `Set-AzDataFactoryV2IntegrationRuntime` команду: 

```powershell
Set-AzDataFactoryV2IntegrationRuntime -ResourceGroupName $ResourceGroupName `
    -DataFactoryName $DataFactoryName `
    -Name $AzureSSISName `
    -VnetId $VnetId `
    -Subnet $SubnetName

# Add public IP address parameters if you bring your own static public IP addresses
if(![string]::IsNullOrEmpty($FirstPublicIP) -and ![string]::IsNullOrEmpty($SecondPublicIP))
{
    $publicIPs = @($FirstPublicIP, $SecondPublicIP)
    Set-AzDataFactoryV2IntegrationRuntime -ResourceGroupName $ResourceGroupName `
        -DataFactoryName $DataFactoryName `
        -Name $AzureSSISName `
        -PublicIPs $publicIPs
}
```

### <a name="start-the-azure-ssis-ir"></a>Запуск среды выполнения интеграции Azure SSIS

Чтобы запустить Azure-SSIS IR, выполните следующую команду: 

```powershell
Start-AzDataFactoryV2IntegrationRuntime -ResourceGroupName $ResourceGroupName `
    -DataFactoryName $DataFactoryName `
    -Name $AzureSSISName `
    -Force
```

Выполнение этой команды занимает от 20 до 30 минут.

## <a name="next-steps"></a>Следующие шаги

Дополнительные сведения о Azure-SSIS IR см. в следующих статьях: 
- [Azure-SSIS IR](concepts-integration-runtime.md#azure-ssis-integration-runtime). В этой статье содержатся общие сведения о IRs, включая Azure-SSIS IR. 
- [Руководство. Развертывание пакетов служб SSIS в Azure](./tutorial-deploy-ssis-packages-azure.md). В этом учебнике приводятся пошаговые инструкции по созданию Azure-SSIS IR. Для размещения каталога SSIS в ней используется База данных SQL Azure. 
- [Создайте Azure-SSIS IR](create-azure-ssis-integration-runtime.md). Эта статья разворачивается в этом руководстве. В нем приведены инструкции по использованию базы данных SQL Azure с конечными точками службы виртуальной сети или Управляемый экземпляр SQL в виртуальной сети для размещения каталога служб SSIS. В нем показано, как присоединить Azure-SSIS IR к виртуальной сети. 
- [Мониторинг среды выполнения интеграции в фабрике данных Azure](monitor-integration-runtime.md#azure-ssis-integration-runtime). В этой статье показано, как получить сведения о Azure-SSIS IR. Он предоставляет описания состояния для возвращаемых сведений. 
- [Manage an Azure-SSIS integration runtime](manage-azure-ssis-integration-runtime.md) (Управление средой выполнения интеграции Azure SSIS). В этой статье показано, как приступить к работе, запускать или удалять Azure-SSIS IR. Кроме того, здесь показано, как развернуть IR Azure SSIS путем добавления узлов.
