---
title: Настройка среды выполнения интеграции Azure SSIS для обеспечения непрерывности бизнес-процессов и аварийного восстановления (BCDR)
description: В этой статье описывается, как настроить среду выполнения интеграции Azure SSIS в фабрике данных Azure с помощью базы данных SQL Azure/Управляемый экземпляр группы отработки отказа для обеспечения непрерывности бизнес-процессов и аварийного восстановления (BCDR).
services: data-factory
ms.service: data-factory
ms.workload: data-services
ms.devlang: powershell
author: swinarko
ms.author: sawinark
manager: mflasko
ms.reviewer: douglasl
ms.topic: conceptual
ms.custom: seo-lt-2019
ms.date: 03/05/2021
ms.openlocfilehash: 2744d51b6d68ed494050be10a9f0e4d1f59cdc49
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2021
ms.locfileid: "102204071"
---
# <a name="configure-azure-ssis-integration-runtime-for-business-continuity-and-disaster-recovery-bcdr"></a>Настройка среды выполнения интеграции Azure SSIS для обеспечения непрерывности бизнес-процессов и аварийного восстановления (BCDR) 

[!INCLUDE[appliesto-adf-asa-md](includes/appliesto-adf-xxx-md.md)]

База данных SQL Azure, Управляемый экземпляр и SQL Server Integration Services (SSIS) в фабрике данных Azure (ADF) можно сочетать в качестве рекомендуемого решения "все-платформа как услуга" (PaaS) для SQL Server миграции. Вы можете развернуть проекты служб SSIS в базе данных каталога SSIS (SSISDB), размещенной в базе данных SQL Azure, Управляемый экземпляр и запускать пакеты служб SSIS в среде выполнения интеграции Azure SSIS (IR) в ADF.

Для обеспечения непрерывности бизнес-процессов и аварийного восстановления (BCDR) база данных SQL Azure/Управляемый экземпляр может быть настроена с помощью [группы георепликации или отработки отказа](https://docs.microsoft.com/azure/azure-sql/database/auto-failover-group-overview), где SSISDB в основном регионе Azure с доступом для чтения и записи (первичная роль) будет непрерывно реплицироваться в дополнительный регион с доступом только для чтения (вторичная роль). При возникновении аварии в основном регионе активируется отработка отказа, где первичная и вторичная Ссисдбс переключают роли.

Для BCDR можно также настроить двойное резервное сочетание IR Azure SSIS, которое работает в синхронизации с группой отработки отказа базы данных SQL Azure или Управляемый экземпляр. Это позволяет иметь пару запущенных служб Azure SSIS IRs, которая в любой момент времени может получить доступ только к первичной базе данных SSISDB для получения и выполнения пакетов, а также для записи журналов выполнения пакетов (первичной роли), а другая — для пакетов, развернутых в других местах, например в службе файлов Azure (вторичная роль). Когда происходит отработка отказа SSISDB, первичная и вторичная IRs Azure-SSIS также отменяют роли, а если обе работают, то время простоя почти равно нулю.

В этой статье описывается, как настроить Azure-SSIS IR с помощью группы отработки отказа базы данных SQL Azure или Управляемый экземпляр для BCDR.

## <a name="configure-a-dual-standby-azure-ssis-ir-pair-with-azure-sql-database-failover-group"></a>Настройка двойного резервного Azure-SSIS IR пары с помощью группы отработки отказа базы данных SQL Azure

Чтобы настроить двойное резервное Azure-SSIS IR, которое работает в синхронизации с группой отработки отказа базы данных SQL Azure, выполните следующие действия.

1. С помощью пользовательского интерфейса портал Azure или ADF можно создать новый Azure-SSIS IR с основным сервером базы данных SQL Azure для размещения SSISDB в основном регионе. Если у вас есть Azure-SSIS IR, который уже подключен к SSIDB необходимо запустить, размещенному на основном сервере базы данных SQL Azure, и он по-прежнему работает, его необходимо сначала отключить, чтобы перенастроить его. Это будет основной Azure-SSIS IR.

   При [выборе для использования SSISDB](./tutorial-deploy-ssis-packages-azure.md#creating-ssisdb) на странице **Параметры развертывания** панели **настройки среды выполнения интеграции** установите флажок **использовать пару с двойным ожиданием Azure-SSIS Integration Runtime с помощью параметра SSISDB Failover** . В качестве **имени пары "двойной резерв"** введите имя, чтобы обозначить пару первичной и вторичной службы Azure-SSIS IRS. После завершения создания первичной Azure-SSIS IR он будет запущен и подключен к первичной SSISDB, который будет создан от вашего имени с доступом для чтения и записи. Если вы только что настроили его, необходимо перезапустить его.

1. С помощью портал Azure можно проверить, создан ли первичный SSISDB на странице **обзора** основного сервера базы данных SQL Azure. После создания [группы отработки отказа для основного и дополнительного серверов базы данных SQL Azure, а также для добавления SSISDB](https://docs.microsoft.com/azure/azure-sql/database/failover-group-add-single-database-tutorial?tabs=azure-portal#2---create-the-failover-group) на страницу **группы отработки отказа** . После создания группы отработки отказа вы можете проверить, реплицируется ли первичный сайт SSISDB на базу данных-получатель с доступом только для чтения на странице **Обзор** сервера-получателя Azure SQL Server.

1. С помощью пользовательского интерфейса портал Azure или ADF можно создать еще один Azure-SSIS IR с сервером базы данных SQL Azure, чтобы разместить SSISDB в дополнительном регионе. Это будет дополнительный Azure-SSIS IR. Чтобы получить полный BCDR, убедитесь, что все ресурсы, от которых он зависит, также создаются в дополнительном регионе, например в хранилище Azure для хранения скрипта или файлов настраиваемой установки, ADF для согласования и планирования выполнения пакетов и т. д.

   При [выборе для использования SSISDB](./tutorial-deploy-ssis-packages-azure.md#creating-ssisdb) на странице **Параметры развертывания** панели **настройки среды выполнения интеграции** установите флажок **использовать пару с двойным ожиданием Azure-SSIS Integration Runtime с помощью параметра SSISDB Failover** . В поле **имя пары с двумя резервными** копиями введите то же имя, чтобы обозначить пару первичной и вторичной службы Azure-SSIS IRS. После завершения создания вторичного Azure-SSIS IR он будет запущен и присоединен к дополнительной базе данных SSISDB.

1. Если при отработке отказа SSISDB требуется почти нулевое время простоя, сохраните обе службы Azure-SSIS IRs. Только ваш первичный Azure-SSIS IR имеет доступ к первичной базе данных SSISDB для получения и выполнения пакетов, а также для записи журналов выполнения пакетов, в то время как вторичный Azure-SSIS IR может сделать то же самое для пакетов, развернутых в другом месте, например в службе файлов Azure.

   Если вы хотите ограничить затраты на выполнение, можно после ее создания закрыть вторичный Azure-SSIS IR. При отработке отказа SSISDB первичная и вторичная службы Azure-SSIS IRs переключают роли. Если основная Azure-SSIS IR остановлена, ее необходимо перезапустить. В зависимости от того, внедряется ли он в виртуальную сеть и используемый метод внедрения, он будет выполняться в течение 5 минут или около 20-30 минут.

1. Если вы [используете ADF для согласования или планирования выполнения пакетов](./how-to-invoke-ssis-package-ssis-activity.md), убедитесь, что все соответствующие конвейеры ADF с действиями "выполнение пакета служб SSIS" и "связанные триггеры" копируются в дополнительный ADF-файл с отключенными триггерами. Когда происходит отработка отказа SSISDB, необходимо включить их.

1. Вы можете [протестировать группу отработки отказа базы данных SQL Azure](https://docs.microsoft.com/azure/azure-sql/database/failover-group-add-single-database-tutorial?tabs=azure-portal#3---test-failover) и проверить [страницу мониторинга Azure-SSIS IR на портале ADF](./monitor-integration-runtime.md#monitor-the-azure-ssis-integration-runtime-in-azure-portal) , независимо от того, имеют ли ваши основные и вторичные службы Azure-SSIS IRS перепутаные роли. 

## <a name="configure-a-dual-standby-azure-ssis-ir-pair-with-azure-sql-managed-instance-failover-group"></a>Настройка пары с двумя резервными Azure-SSIS IR с помощью группы отработки отказа Azure SQL Управляемый экземпляр

Чтобы настроить двойное резервное Azure-SSIS IR, которое работает в синхронизации с группой отработки отказа Azure SQL Управляемый экземпляр, выполните следующие действия.

1. С помощью портал Azure можно [создать группу отработки отказа для основного и дополнительного управляемых экземпляров Azure SQL](https://docs.microsoft.com/azure/azure-sql/managed-instance/failover-group-add-instance-tutorial?tabs=azure-portal) на странице **группы отработки отказа** основного управляемый экземпляр SQL Azure.

1. С помощью пользовательского интерфейса портал Azure или ADF можно создать новый Azure-SSIS IR с основным Управляемый экземпляр Azure SQL для размещения SSISDB в основном регионе. Если у вас есть Azure-SSIS IR, который уже подключен к SSIDB необходимо запустить, размещенному на основном Управляемый экземпляр SQL Azure и все еще запущен, необходимо сначала его отключить, чтобы перенастроить его. Это будет основной Azure-SSIS IR.

   При [выборе для использования SSISDB](./create-azure-ssis-integration-runtime.md#creating-ssisdb) на странице **Параметры развертывания** панели **настройки среды выполнения интеграции** установите флажок **использовать пару с двойным ожиданием Azure-SSIS Integration Runtime с помощью параметра SSISDB Failover** . В качестве **имени пары "двойной резерв"** введите имя, чтобы обозначить пару первичной и вторичной службы Azure-SSIS IRS. После завершения создания первичной Azure-SSIS IR он будет запущен и подключен к первичной SSISDB, который будет создан от вашего имени с доступом для чтения и записи. Если вы только что настроили его, необходимо перезапустить его. Вы также можете проверить, реплицируется ли первичная база данных SSISDB на базу данных-получатель с доступом только для чтения на странице **обзора** вторичного управляемый экземпляр Azure SQL.

1. С помощью пользовательского интерфейса портал Azure или ADF можно создать еще один Azure-SSIS IR с дополнительным Управляемый экземпляр Azure SQL для размещения SSISDB в дополнительном регионе. Это будет дополнительный Azure-SSIS IR. Чтобы получить полный BCDR, убедитесь, что все ресурсы, от которых он зависит, также создаются в дополнительном регионе, например в хранилище Azure для хранения скрипта или файлов настраиваемой установки, ADF для согласования и планирования выполнения пакетов и т. д.

   При [выборе для использования SSISDB](./create-azure-ssis-integration-runtime.md#creating-ssisdb) на странице **Параметры развертывания** панели **настройки среды выполнения интеграции** установите флажок **использовать пару с двойным ожиданием Azure-SSIS Integration Runtime с помощью параметра SSISDB Failover** . В поле **имя пары с двумя резервными** копиями введите то же имя, чтобы обозначить пару первичной и вторичной службы Azure-SSIS IRS. После завершения создания вторичного Azure-SSIS IR он будет запущен и присоединен к дополнительной базе данных SSISDB.

1. Управляемый экземпляр Azure SQL может защищать конфиденциальные данные в базах данных, например SSISDB, путем их шифрования с помощью главного ключа базы данных (DMK). DMK сам по себе шифруется с помощью главного ключа службы (SMK) по умолчанию. На момент написания этой статьи группа отработки отказа Azure SQL Управляемый экземпляр не реплицирует SMK из основного Управляемый экземпляр SQL Azure, поэтому DMK и, в свою очередь, невозможно расшифровать на вторичной Управляемый экземпляр Azure SQL после отработки отказа. Чтобы обойти это, можно добавить шифрование паролей для DMK, которое будет расшифровано во вторичной Управляемый экземпляр Azure SQL. С помощью SSMS выполните следующие действия.

   1. Выполните следующую команду для SSISDB в основной Управляемый экземпляр Azure SQL, чтобы добавить пароль для шифрования DMK.

      ```sql
      ALTER MASTER KEY ADD ENCRYPTION BY PASSWORD = 'YourPassword'
      ```
   
   1. Выполните следующую команду для SSISDB в управляемых экземплярах SQL Azure Primary и Secondary, чтобы добавить новый пароль для расшифровки DMK.

      ```sql
      EXEC sp_control_dbmasterkey_password @db_name = N'SSISDB', @password = N'YourPassword', @action = N'add'
      ```

1. Если при отработке отказа SSISDB требуется почти нулевое время простоя, сохраните обе службы Azure-SSIS IRs. Только ваш первичный Azure-SSIS IR имеет доступ к первичной базе данных SSISDB для получения и выполнения пакетов, а также для записи журналов выполнения пакетов, в то время как вторичный Azure-SSIS IR может сделать то же самое для пакетов, развернутых в другом месте, например в службе файлов Azure.

   Если вы хотите ограничить затраты на выполнение, можно после ее создания закрыть вторичный Azure-SSIS IR. При отработке отказа SSISDB первичная и вторичная службы Azure-SSIS IRs переключают роли. Если основная Azure-SSIS IR остановлена, ее необходимо перезапустить. В зависимости от того, внедряется ли он в виртуальную сеть и используемый метод внедрения, он будет выполняться в течение 5 минут или около 20-30 минут.

1. Если вы [используете агент управляемый экземпляр Azure SQL для согласования или планирования выполнения пакетов](./how-to-invoke-ssis-package-managed-instance-agent.md), убедитесь, что все соответствующие задания SSIS с шагами задания и связанные расписания копируются во вторичную управляемый экземпляр SQL Azure с изначально отключенными расписаниями. С помощью SSMS выполните следующие действия.

   1. Для каждого задания служб SSIS щелкните правой кнопкой мыши и выберите пункт создать **Скрипт** для **создания** скрипта в **окне редактора запросов** .

      ![Создать скрипт задания служб SSIS](media/configure-bcdr-azure-ssis-integration-runtime/generate-ssis-job-script.png)

   1. Для каждого созданного скрипта задания служб SSIS найдите команду для выполнения `sp_add_job` хранимой процедуры и измените или удалите присвоение значения `@owner_login_name` аргументу при необходимости.

   1. Для каждого обновленного скрипта задания служб SSIS запустите его на сервере-получателе Azure SQL Управляемый экземпляр, чтобы скопировать задание с шагами задания и связанными расписаниями.

   1. С помощью следующего скрипта создайте задание T-SQL, чтобы включить или отключить расписания заданий служб SSIS на основе первичной или вторичной роли SSISDB, соответственно, как в основном, так и во вторичном управляемых экземплярах SQL Azure, и регулярно запускать их. Когда происходит отработка отказа SSISDB, отключенные расписания заданий служб SSIS будут включены и наоборот.

      ```sql
      IF (SELECT Top 1 role_desc FROM SSISDB.sys.dm_geo_replication_link_status WHERE partner_database = 'SSISDB') = 'PRIMARY'
         BEGIN
            IF (SELECT enabled FROM msdb.dbo.sysschedules WHERE schedule_id = <ScheduleID>) = 0
               EXEC msdb.dbo.sp_update_schedule @schedule_id = <ScheduleID >, @enabled = 1
         END
      ELSE
         BEGIN
            IF (SELECT enabled FROM msdb.dbo.sysschedules WHERE schedule_id = <ScheduleID>) = 1
               EXEC msdb.dbo.sp_update_schedule @schedule_id = <ScheduleID >, @enabled = 0
         END
      ```

1. Если вы [используете ADF для согласования или планирования выполнения пакетов](./how-to-invoke-ssis-package-ssis-activity.md), убедитесь, что все соответствующие конвейеры ADF с действиями "выполнение пакета служб SSIS" и "связанные триггеры" копируются в дополнительный ADF-файл с отключенными триггерами. Когда происходит отработка отказа SSISDB, необходимо включить их.

1. Вы можете [протестировать группу отработки отказа Azure SQL управляемый экземпляр](https://docs.microsoft.com/azure/azure-sql/managed-instance/failover-group-add-instance-tutorial?tabs=azure-portal#test-failover) и проверить на [странице мониторинга Azure-SSIS IR на портале ADF](./monitor-integration-runtime.md#monitor-the-azure-ssis-integration-runtime-in-azure-portal) , есть ли в вашей основной и вторичной службе Azure-SSIS IRS перепутаные роли. 

## <a name="attach-a-new-azure-ssis-ir-to-existing-ssisdb-hosted-by-azure-sql-databasemanaged-instance"></a>Присоединение нового Azure-SSIS IR к существующему SSISDB, размещенному в базе данных SQL Azure или Управляемый экземпляр

Если происходит сбой и влияет на существующие Azure-SSIS IR, но не на базу данных SQL Azure и Управляемый экземпляр в том же регионе, вы можете заменить ее новым в другом регионе. Чтобы присоединить существующую базу данных SSISDB, размещенную на сервере SQL Azure или Управляемый экземпляр, в новую Azure-SSIS IR, выполните следующие действия.

1. Если существующий Azure-SSIS IR все еще работает, его необходимо сначала отключить с помощью пользовательского интерфейса портал Azure/ADF или Azure PowerShell. Если авария также влияет на ADF в одном регионе, этот шаг можно пропустить.

1. С помощью SSMS выполните следующую команду для SSISDB в базе данных SQL Azure или Управляемый экземпляр, чтобы обновить метаданные, которые будут разрешать подключения из нового ADF-и Azure-SSIS IR.

   ```sql
   EXEC [catalog].[failover_integration_runtime] @data_factory_name = 'YourNewADF', @integration_runtime_name = 'YourNewAzureSSISIR'
   ```

1. Используя [Пользовательский интерфейс портал Azure/ADF](./create-azure-ssis-integration-runtime.md#use-the-azure-portal-to-create-an-integration-runtime) или [Azure PowerShell](./create-azure-ssis-integration-runtime.md#use-azure-powershell-to-create-an-integration-runtime), создайте новый ADF-файл или Azure-SSIS IR с именем *йоурневадф* / *йоурневазурессисир*, соответственно, в другом регионе. При использовании пользовательского интерфейса портал Azure или ADF можно пропустить страницу Проверка ошибок подключения на странице **Параметры развертывания** панели **настройки среды выполнения интеграции** .

## <a name="next-steps"></a>Дальнейшие действия

Вы можете рассмотреть следующие параметры конфигурации для Azure-SSIS IR.

- [Настройка хранилищ пакетов для Azure-SSIS IR](./create-azure-ssis-integration-runtime.md#creating-azure-ssis-ir-package-stores)

- [Настройка пользовательских настроек для Azure-SSIS IR](./how-to-configure-azure-ssis-ir-custom-setup.md)

- [Настройка внедрения виртуальной сети для Azure-SSIS IR](./join-azure-ssis-integration-runtime-virtual-network.md)

- [Настройка самостоятельно размещенного IR в качестве прокси-сервера для Azure-SSIS IR](./self-hosted-integration-runtime-proxy-ssis.md)
