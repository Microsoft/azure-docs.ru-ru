---
title: Смещение схемы в потоке данных сопоставления
description: Создание устойчивых потоков данных со смещением схемы в Фабрике данных Azure
author: kromerm
ms.author: makromer
ms.reviewer: daperlov
ms.service: data-factory
ms.topic: conceptual
ms.custom: seo-lt-2019
ms.date: 04/15/2020
ms.openlocfilehash: 11ddb2f40ee56b51c5ecbae11465093abb8e4feb
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "93027488"
---
# <a name="schema-drift-in-mapping-data-flow"></a>Смещение схемы в потоке данных сопоставления

[!INCLUDE[appliesto-adf-asa-md](includes/appliesto-adf-asa-md.md)]

Смещение схемы — это случай, когда источники часто изменяют метаданные. Поля, столбцы и типы можно добавлять, удалять или изменять в режиме реального времени. Без обработки смещения схемы поток данных становится уязвимым для вышестоящего изменения источника данных. Стандартные шаблоны ETL завершаются ошибкой при изменении входящих столбцов и полей, так как они обычно привязаны к этим именам источников.

Для защиты от смещения схемы важно, чтобы средства потока данных позволяли разработчикам данных выполнять следующие задачи:

* Определение источников с изменяемыми именами полей, типами данных, значениями и размерами
* определять параметры преобразования, которые могут работать с шаблонами данных вместо жестко закодированных полей и значений;
* определять выражения, которые распознают шаблоны для сопоставления входящих полей вместо использования именованных полей.

Фабрика данных Azure изначально поддерживает гибкие схемы, которые изменяют выполнение до выполнения, чтобы можно было создавать логику универсального преобразования данных без необходимости перекомпиляции потоков данных.

Необходимо реализовать в потоке данных архитектурное решение, чтобы принимать смещение схемы по всему потоку. При этом можно защититься от изменений схемы, поступающих из источников. Однако в потоке данных будет происходить раннее связывание столбцов и типов. Фабрика данных Azure считает, что смещение схемы проходит в виде потоков с поздним связыванием, поэтому при построении преобразований имена столбцов с несмещенными данными не будут доступны в представлениях схемы во всей последовательности.

В этом видеоролике приводятся общие сведения о некоторых сложных решениях, которые можно легко создать в ADF с помощью функции смещения схемы потока данных. В этом примере мы создаем шаблоны для многократного использования на основе гибких схем баз данных:

> [!VIDEO https://www.microsoft.com/en-us/videoplayer/embed/RE4tyx7]

## <a name="schema-drift-in-source"></a>Смещение схемы в источнике

Столбцы, поступающие в поток данных из определения источника, определяются как "смещенные", если они отсутствуют в исходной проекции. Исходную проекцию можно просмотреть на вкладке проекция в преобразовании «источник». При выборе набора данных для источника ADF автоматически переберет схему из набора данных и создаст проекцию из этого определения схемы набора данных.

В преобразовании «источник» смещение схемы определяется как считывание столбцов, которые не определяют схему набора данных. Чтобы включить отклонение схемы, установите флажок **Разрешить смещение схемы** в преобразовании источника.

![Источник смещения схемы](media/data-flow/schemadrift001.png "Источник смещения схемы")

Если параметр «смещение схемы» включен, все входящие поля считываются из источника во время выполнения и передаются по всему потоку в приемник. По умолчанию все вновь обнаруженные столбцы, известные как *смещенные столбцы*, поступают в виде строкового типа данных. Если вы хотите, чтобы поток данных автоматически высчитал типы данных со смещенными столбцами, установите флажок **определить типы столбцов** с отклонениями в исходных параметрах.

## <a name="schema-drift-in-sink"></a>Смещение схемы в приемнике

В преобразовании «приемник» смещение схемы происходит при записи дополнительных столбцов поверх того, что определено в схеме данных приемника. Чтобы включить отклонение схемы, установите флажок **Разрешить смещение схемы** в преобразовании приемника.

![Приемник смещения схемы](media/data-flow/schemadrift002.png "Приемник смещения схемы")

Если параметр «смещение схемы» включен, убедитесь, что ползунок « **Автоматическое сопоставление** » на вкладке «Сопоставление» включен. Если этот ползунок включен, все входящие столбцы записываются в назначение. В противном случае для записи смещенных столбцов необходимо использовать сопоставление на основе правил.

![Автоматическое сопоставление приемника](media/data-flow/automap.png "Автоматическое сопоставление приемника")

## <a name="transforming-drifted-columns"></a>Преобразование смещенных столбцов

Если в потоке данных имеются смещенные столбцы, к ним можно получить доступ в преобразованиях с помощью следующих методов:

* Используйте `byPosition` выражения и `byName` для явной ссылки на столбец по имени или номеру расположения.
* Добавление шаблона столбца в производный столбец или преобразование «Статистическая обработка» для сопоставления с любым сочетанием имени, потока, положения, происхождения или типа
* Добавление сопоставления на основе правил в преобразовании «выбор» или «приемник» для сопоставления смещенных столбцов и псевдонимов столбцов с помощью шаблона

Дополнительные сведения о реализации шаблонов столбцов см. [в разделе Шаблоны столбцов в потоке данных сопоставления](concepts-data-flow-column-pattern.md).

### <a name="map-drifted-columns-quick-action"></a>Быстрое действие "связать смещенные столбцы"

Чтобы явно ссылаться на смещенные столбцы, можно быстро создавать сопоставления для этих столбцов с помощью быстрого действия "предварительный просмотр данных". Когда [режим отладки](concepts-data-flow-debug-mode.md) включен, перейдите на вкладку Предварительный просмотр данных и нажмите кнопку **Обновить** , чтобы получить предварительную версию данных. Если фабрика данных обнаруживает, что смещенные столбцы существуют, можно щелкнуть элемент раскрытие **карт** и создать производный столбец, который позволяет ссылаться на все смещенные столбцы в представлениях схемы в нисходящем направлении.

![На снимке экрана показана вкладка "предварительный просмотр данных" с незаполненным вызываемым картой.](media/data-flow/mapdrifted1.png "Пересмещенная схема")

В созданном преобразовании «Производный столбец» каждый смещенный столбец сопоставляется с его обнаруженным именем и типом данных. В приведенном выше предварительном просмотре данных столбец "Мовиеид" определяется как целое число. После нажатия кнопки « **смещенная таблица** » мовиеид определяется в производном столбце как `toInteger(byName('movieId'))` и включается в представления схемы в нисходящих преобразованиях.

![На снимке экрана показана вкладка параметров производного столбца.](media/data-flow/mapdrifted2.png "Пересмещенная схема")

## <a name="next-steps"></a>Дальнейшие действия
В [языке выражений потока данных](data-flow-expression-functions.md)вы найдете дополнительные средства для шаблонов столбцов и смещения схем, включая "бинаме" и "бипоситион".
