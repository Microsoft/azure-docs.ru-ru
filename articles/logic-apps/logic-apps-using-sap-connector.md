---
title: Подключение к системам SAP
description: Доступ к ресурсам SAP и управление ими путем автоматизации рабочих процессов с помощью Azure Logic Apps
services: logic-apps
ms.suite: integration
author: divyaswarnkar
ms.author: divswa
ms.reviewer: estfan, daviburg, logicappspm
ms.topic: article
ms.date: 02/01/2021
tags: connectors
ms.openlocfilehash: edf4ce188c9239e697e2148d4fff51966d91f85a
ms.sourcegitcommit: d49bd223e44ade094264b4c58f7192a57729bada
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/02/2021
ms.locfileid: "99252616"
---
# <a name="connect-to-sap-systems-from-azure-logic-apps"></a>Подключение к системам SAP из Azure Logic Apps

В этой статье объясняется, как можно получить доступ к ресурсам SAP из Logic Apps с помощью [соединителя SAP](https://docs.microsoft.com/connectors/sap/).

## <a name="prerequisites"></a>Обязательные условия

* Подписка Azure. Если у вас еще нет подписки Azure, [получите бесплатную учетную запись Azure](https://azure.microsoft.com/free/).

* Приложение логики, из которого вы хотите получить доступ к ресурсам SAP. Если вы не знакомы с Logic Apps, ознакомьтесь с [обзором службы Logic Apps](../logic-apps/logic-apps-overview.md) и [кратким руководством по созданию первого приложения логики в портал Azure](../logic-apps/quickstart-create-first-logic-app-workflow.md).

    * Если вы использовали предыдущую версию соединителя SAP, которая является устаревшей, перед подключением к серверу SAP необходимо [выполнить миграцию на текущий соединитель](#migrate-to-current-connector) .

    * Если вы используете приложение логики в нескольких клиентах Azure, ознакомьтесь с [предварительными требованиями к нескольким клиентам](#multi-tenant-azure-prerequisites).

    * Если вы используете приложение логики в[ среде службы интеграции уровня Premium (ISE)](../logic-apps/connect-virtual-network-vnet-isolated-environment-overview.md), ознакомьтесь с [предварительными требованиями для интегрированной среды сценариев](#ise-prerequisites).

* [Сервер приложений SAP](https://wiki.scn.sap.com/wiki/display/ABAP/ABAP+Application+Server) или [сервер сообщений SAP](https://help.sap.com/saphelp_nw70/helpdata/en/40/c235c15ab7468bb31599cc759179ef/frameset.htm) , к которому требуется получить доступ из Logic Apps. Сведения о том, какие серверы SAP и действия SAP можно использовать с соединителем, см. в разделе [Совместимость с SAP](#sap-compatibility).

* Содержимое сообщения для отправки на сервер SAP, например пример файла IDoc. Это содержимое должно быть в формате XML и содержать пространство имен действия SAP, которое вы хотите использовать. IDoc можно [отправить с помощью схемы неструктурированных файлов, заключив их в оболочку XML](#send-flat-file-idocs).

* Если вы хотите использовать, **когда сообщение получено от** триггера SAP, необходимо также выполнить следующие действия.

    * Настройте разрешения безопасности шлюза SAP с помощью этого параметра: `"TP=Microsoft.PowerBI.EnterpriseGateway HOST=<gateway-server-IP-address> ACCESS=*"`

    * Настройте ведение журнала безопасности шлюза SAP, чтобы помочь найти список управления доступом (ACL). Дополнительные сведения см. в [разделе справки SAP, посвященном настройке ведения журнала шлюза](https://help.sap.com/erp_hcm_ias2_2015_02/helpdata/en/48/b2a710ca1c3079e10000000a42189b/frameset.htm). В противном случае появится следующее сообщение об ошибке: `"Registration of tp Microsoft.PowerBI.EnterpriseGateway from host <host-name> not allowed"`

    > [!NOTE]
    > Этот триггер использует то же расположение URI для продления подписки веб-перехватчика и отмены подписки. Операция продления использует метод HTTP `PATCH` , а операция отмены подписки использует `DELETE` метод HTTP. Это поведение может привести к появлении операции продления в журнале триггера как операция отмены подписки, но операция все еще является возобновлением, поскольку триггер использует в `PATCH` качестве метода HTTP `DELETE` .

### <a name="sap-compatibility"></a>Совместимость с SAP

Соединитель SAP совместим со следующими типами систем SAP:

* Локальные и облачные системы SAP на основе HANA, такие как S/4 HANA.

* Классические локальные системы SAP, такие как R/3 и ECC.

Соединитель SAP поддерживает следующие типы сообщений и интеграции данных из систем на основе SAP NetWeaver:

* Промежуточный документ (IDoc)

* Интерфейс программирования бизнес-приложений (BAPI)

* Удаленный вызов функции (RFC) и транзакционный RFC (Трфк)

Соединитель SAP использует [библиотеку SAP .NET Connector (NCo)](https://support.sap.com/en/product/connectors/msnet.html). С соединителем можно использовать следующие действия SAP и триггер.

* **Отправка сообщения в SAP** для [отправки iDoc через трфк](#send-idoc-action) действие, которое можно использовать в следующих случаях:

    * [Вызов функций BAPI по стандарту RFC](#call-bapi-action)

    * Вызов RFC/Трфк в системах SAP

    * Создание или закрытие сеансов с отслеживанием состояния

    * Фиксация или откат транзакций BAPI

    * Подтвердите идентификатор транзакции

    * Отправить iDoc, получить состояние IDoc из его числа и получить список iDoc для транзакции

    * Чтение таблицы SAP

* **При получении сообщения от** триггера SAP, который можно использовать для:

    * Получение iDoc через Трфк

    * Вызов функций BAPI по сравнению с Трфк

    * Вызов RFC/Трфк в системах SAP

* Действие **создать схемы** , которое можно использовать для создания схем для артефактов SAP для iDoc, BAPI или RFC.

Чтобы использовать эти действия SAP, необходимо сначала проверить подлинность подключения с именем пользователя и паролем. Соединитель SAP также поддерживает [безопасные сетевые подключения (SNC)](https://help.sap.com/doc/saphelp_nw70/7.0.31/e6/56f466e99a11d1a5b00000e835363f/content.htm?no_cache=true). Для единого входа (SSO) SAP NetWeaver можно использовать протокол SNC или дополнительные возможности безопасности внешних продуктов. Если используется SNC, см. [Предварительные требования для SNC](#snc-prerequisites).

### <a name="migrate-to-current-connector"></a>Перенести в текущий соединитель

Прежние соединители сервера приложений SAP и сервера сообщений SAP были признаны 29 февраля 2020. Чтобы выполнить миграцию на текущий соединитель SAP, выполните следующие действия.

1. Обновите [локальный шлюз данных](https://www.microsoft.com/download/details.aspx?id=53127) до текущей версии. Дополнительные сведения см. [в статье Установка локального шлюза данных для Azure Logic Apps](../logic-apps/logic-apps-gateway-install.md).

1. В приложении логики, использующем устаревший соединитель SAP, удалите действие **Send to SAP** .

1. Добавьте действие **Отправить сообщение в SAP** из текущего соединителя SAP.

1. Повторно подключитесь к системе SAP в новом действии.

1. Сохраните приложение логики

### <a name="multi-tenant-azure-prerequisites"></a>Предварительные требования для Azure с несколькими клиентами

Эти предварительные условия применяются, если приложение логики работает в Azure с несколькими клиентами. Управляемый соединитель SAP не запускается изначально в [интегрированной среде сценариев](../logic-apps/connect-virtual-network-vnet-isolated-environment-overview.md).

> [!TIP]
> Если вы используете интегрированную среду сценариев уровня "Премиум", вместо управляемого соединителя SAP можно использовать соединитель SAP ISE. Дополнительные сведения см. в разделе [Предварительные требования для интегрированной среды сценариев](#ise-prerequisites).

Управляемый соединитель SAP интегрируется с системами SAP через [локальный шлюз данных](../logic-apps/logic-apps-gateway-connection.md). Например, в сценариях отправки сообщений, когда сообщение отправляется из приложения логики в систему SAP, шлюз данных выступает в качестве клиента RFC и направляет запросы, полученные от приложения логики в SAP. Аналогично, в сценариях приема сообщений шлюз данных выступает в качестве сервера RFC, который получает запросы от SAP и пересылает их в приложение логики.

* [Скачайте и установите локальный шлюз данных](../logic-apps/logic-apps-gateway-install.md) на главном компьютере или виртуальной машине, которая находится в той же виртуальной сети, что и система SAP, к которой осуществляется подключение.

* [Создайте ресурс шлюза Azure](../logic-apps/logic-apps-gateway-connection.md#create-azure-gateway-resource) для локального шлюза данных в портал Azure. Этот шлюз обеспечивает безопасный доступ к локальным данным и ресурсам. Убедитесь, что используется поддерживаемая версия шлюза.

    * Если у вас возникла проблема с шлюзом, попробуйте [обновить ее до последней версии](https://aka.ms/on-premises-data-gateway-installer), которая может содержать обновления для устранения проблемы.

* [Скачайте и установите последнюю версию клиентской библиотеки SAP](#sap-client-library-prerequisites) на том же локальном компьютере, что и локальный шлюз данных.

### <a name="ise-prerequisites"></a>Предварительные требования интегрированной среды сценариев

Эти предварительные условия применяются при запуске приложения логики в интегрированной среде сценариев уровня "Премиум". Однако они не применяются к приложениям логики, выполняемым в ИНТЕГРИРОВАНной среде разработки на уровне разработчика. Интегрированная среда сценариев предоставляет доступ к ресурсам, защищенным виртуальной сетью Azure, и предоставляет другие встроенные соединители ISE, которые позволяют приложениям логики напрямую обращаться к локальным ресурсам без использования локального шлюза данных.

> [!NOTE]
> Хотя соединитель SAP ISE видим в интегрированной среде сценариев на уровне разработчика, попытки установить соединитель не будут выполнены.

1. Если у вас еще нет учетной записи хранения Azure с контейнером больших двоичных объектов, создайте контейнер с помощью [портал Azure](../storage/blobs/storage-quickstart-blobs-portal.md) или [Обозреватель службы хранилища Azure](../storage/blobs/storage-quickstart-blobs-storage-explorer.md).

1. [Скачайте и установите последнюю версию клиентской библиотеки SAP](#sap-client-library-prerequisites) на локальном компьютере. У вас должны быть следующие файлы сборки:

   * libicudecnumber.dll

   * rscp4n.dll

   * sapnco.dll

   * sapnco_utils.dll

1. Создайте ZIP-файл, содержащий эти файлы сборки. Отправьте пакет в контейнер больших двоичных объектов в службе хранилища Azure.

1. В портал Azure или Обозреватель службы хранилища Azure перейдите к расположению контейнера, куда был отправлен ZIP-файл.

1. Скопируйте URL-адрес расположения контейнера. Убедитесь, что включен маркер подписанного URL-адрес (SAS), поэтому маркер SAS является полномочным. В противном случае произойдет сбой развертывания для соединителя SAP ISE.

1. Установите и разверните соединитель SAP в интегрированной среде сценариев. Дополнительные сведения см. в разделе [Добавление соединителей ISE](../logic-apps/add-artifacts-integration-service-environment-ise.md#add-ise-connectors-environment).

   1. В [портал Azure](https://portal.azure.com)найдите и откройте интегрированную среду сценариев.

   1. В меню интегрированной среды сценариев выберите **управляемые соединители** &gt; **добавить**. В списке соединители найдите и выберите **SAP**.

   1. В области **Добавить новый управляемый соединитель** в поле **пакет SAP** вставьте URL-адрес для файла ZIP, в котором находятся сборки SAP. Еще раз убедитесь, что включен маркер SAS.
 
  1. Щелкните **создать** , чтобы завершить создание соединителя интегрированной среды сценариев.

1. Если ваш экземпляр SAP и интегрированная среда сценариев находятся в разных виртуальных сетях, вам также потребуется [одноранговые сети](../virtual-network/tutorial-connect-virtual-networks-portal.md) , чтобы они были подключены.

### <a name="sap-client-library-prerequisites"></a>Необходимые компоненты для клиентской библиотеки SAP

Это необходимые компоненты для клиентской библиотеки SAP, используемой с соединителем.

* Убедитесь, что установлена последняя версия, [соединитель SAP (NCo 3,0) для Microsoft .NET 3.0.22.0, скомпилированный с платформа .NET Framework 4,0-Windows 64-bit (x64)](https://support.sap.com/en/product/connectors/msnet.html). Более ранние версии SAP NCo могут столкнуться с проблемами, когда одновременно отправляется более одного сообщения IDoc. Это условие блокирует все последующие сообщения, отправляемые в назначение SAP, что приводит к истечению времени ожидания сообщений.

* Необходимо установить 64-разрядную версию клиентской библиотеки SAP, так как шлюз данных работает только в 64-разрядных системах. Установка неподдерживаемой 32-разрядной версии приводит к ошибке "плохое изображение".

* Скопируйте файлы сборки из папки установки по умолчанию в другое расположение на основе вашего сценария, как показано ниже.

    * Для приложений логики, выполняющихся в интегрированной среде сценариев, следуйте [предварительным требованиям для интегрированной среды сценариев](#ise-prerequisites) .

    * Для приложений логики, работающих в Azure с несколькими клиентами и с помощью локального шлюза данных, скопируйте файлы сборки в папку установки шлюза данных. 

        
        * Если подключение SAP завершается с сообщением об ошибке, **Проверьте сведения об учетной записи и/или разрешения и повторите попытку**, убедитесь, что файлы сборки скопированы в папку установки шлюза данных.
        
        * Устранение других проблем с помощью [средства просмотра журнала привязки сборок .NET](/dotnet/framework/tools/fuslogvw-exe-assembly-binding-log-viewer). Это средство позволяет проверить, находятся ли файлы сборки в правильном расположении. 
        
        * При необходимости выберите параметр **регистрации глобального кэша сборок** при установке клиентской библиотеки SAP.

Обратите внимание на следующие отношения между клиентской библиотекой SAP, платформа .NET Framework, средой выполнения .NET и шлюзом.

* И адаптер Microsoft SAP, и служба узла шлюза используют платформа .NET Framework 4.7.2.

* SAP NCo для платформа .NET Framework 4,0 работает с процессами, использующими .NET Runtime 4,0 – 4,8.

* SAP NCo для платформа .NET Framework 2,0 работает с процессами, которые используют среду выполнения .NET 2,0 – 3,5, но больше не работают с последним шлюзом.

### <a name="snc-prerequisites"></a>Предварительные требования SNC

Если вы используете локальный шлюз данных с дополнительным контроллером SNC, который поддерживается только в Azure с несколькими клиентами, необходимо настроить эти дополнительные параметры.

Если вы используете SNC с SSO, убедитесь, что служба шлюза данных запущена от имени пользователя, сопоставленного с пользователем SAP. Чтобы изменить учетную запись по умолчанию, выберите **изменить учетную запись** и введите учетные данные пользователя.

![Снимок экрана параметров локального шлюза данных на портале Azure, на котором отображается страница "Параметры службы" с кнопками для изменения выбранной учетной записи службы шлюза.](./media/logic-apps-using-sap-connector/gateway-account.png)

Если вы включаете SNC через внешний продукт безопасности, Скопируйте библиотеку SNC или файлы на тот же компьютер, на котором установлен шлюз данных. К некоторым примерам продуктов SNC относятся [сапсекулиб](https://help.sap.com/saphelp_nw74/helpdata/en/7a/0755dc6ef84f76890a77ad6eb13b13/frameset.htm), Kerberos и NTLM. Дополнительные сведения о включении SNC для шлюза данных см. в разделе [Включение безопасного сетевого взаимодействия](#enable-secure-network-communications).

## <a name="send-idoc-messages-to-sap-server"></a>Отправка сообщений IDoc на сервер SAP Server

Выполните эти примеры, чтобы создать приложение логики, которое отправляет сообщение IDoc на сервер SAP и возвращает ответ:

1. [Создайте приложение логики, активируемое HTTP-запросом.](#create-http-request-trigger)

1. [Создание действия в рабочем процессе для отправки сообщения в SAP.](#create-sap-action-to-send-message)

1. [Создайте действие HTTP-ответа в рабочем процессе.](#create-http-response-action)

1. [Создайте шаблон "запрос-ответ" для удаленного вызова функции (RFC), если вы используете RFC для получения ответов от SAP ABAP.](#create-rfc-request-response)

1. [Протестируйте приложение логики.](#test-logic-app)

### <a name="create-http-request-trigger"></a>Создание триггера HTTP-запроса

> [!NOTE]
> Когда приложение логики получает iDoc из SAP, [триггер запроса](../connectors/connectors-native-reqres.md) теперь поддерживает формат SAP в формате XML. Чтобы получить iDoc как обычный XML, используйте триггер **при получении сообщения от SAP**. Задайте для параметра **iDoc формат** значение **сапплаинксмл**.

Сначала создайте приложение логики с конечной точкой в Azure для отправки *http-запросов POST* в приложение логики. Когда приложение логики получает эти HTTP-запросы, [триггер](../logic-apps/logic-apps-overview.md#logic-app-concepts) срабатывает и выполняет следующий шаг в рабочем процессе.

1. В [портал Azure](https://portal.azure.com)создайте пустое приложение логики, которое открывает **конструктор Logic Apps**.

1. В поле поиска введите `http request` в качестве фильтра. В списке **триггеры** выберите **время получения HTTP-запроса**.

   ![Снимок экрана конструктора Logic Apps, показывающий новый триггер HTTP-запроса, добавляемый в приложение логики.](./media/logic-apps-using-sap-connector/add-http-trigger-logic-app.png)

1. Сохраните приложение логики, чтобы можно было создать URL-адрес конечной точки для приложения логики. На панели инструментов конструктора щелкните **Сохранить**. URL-адрес конечной точки теперь отображается в триггере. 

   ![Снимок экрана конструктора Logic Apps, в котором выполняется копирование триггера HTTP-запроса с созданным URL-адресом POST.](./media/logic-apps-using-sap-connector/generate-http-endpoint-url.png)

### <a name="create-sap-action-to-send-message"></a>Создание действия SAP для отправки сообщения

Затем создайте действие для отправки сообщения IDoc в SAP при срабатывании [триггера HTTP-запроса](#create-http-request-trigger) .

1. В конструкторе Logic Apps в разделе триггер выберите **новый шаг**.

   ![Снимок экрана конструктора Logic Apps, в котором показано редактируемое приложение логики для добавления нового шага.](./media/logic-apps-using-sap-connector/add-sap-action-logic-app.png)

1. В поле поиска введите `sap` в качестве фильтра. В списке **действия** выберите **Отправить сообщение в SAP**.
  
   ![Снимок экрана конструктора Logic Apps, отображающий выбор действия "отправить сообщение в SAP".](media/logic-apps-using-sap-connector/select-sap-send-action.png)

   Также можно выбрать вкладку " **предприятие** " и выбрать действие SAP.

   ![Снимок экрана конструктора Logic Apps, в котором показан выбор действия "отправить сообщение в SAP" на вкладке "Корпоративный".](media/logic-apps-using-sap-connector/select-sap-send-action-ent-tab.png)

1. Если подключение уже существует, перейдите к следующему шагу. Если появится запрос на создание нового подключения, укажите следующие сведения для подключения к локальному серверу SAP.

   1. Укажите имя подключения.

   1. Если вы используете шлюз данных, выполните следующие действия.
   
      1. В разделе " **шлюз данных** " на вкладке " **Подписка**" сначала выберите подписку Azure для ресурса шлюза данных, созданного в портал Azure для установки шлюза данных.
   
      1. В разделе **шлюз подключений** выберите ресурс шлюза данных в Azure.

   1. Продолжайте предоставлять сведения о подключении. Для свойства **тип входа** выполните действие в зависимости от того, задано ли для свойства значение **сервер приложения** или **Группа**.
   
      * Для **сервера приложений** эти свойства, которые обычно являются необязательными, являются обязательными:

        ![Создание подключения к серверу приложений SAP](media/logic-apps-using-sap-connector/create-SAP-application-server-connection.png)

      * Для **группы** эти свойства, которые обычно являются необязательными, являются обязательными.

        ![Создание подключения к серверу сообщений SAP](media/logic-apps-using-sap-connector/create-SAP-message-server-connection.png)  

      По умолчанию строгая типизация используется для проверки недопустимых значений путем выполнения проверки XML для схемы. Такое поведение поможет обнаружить проблемы ранее. Параметр **безопасного ввода** доступен для обеспечения обратной совместимости и только проверяет длину строки. Дополнительные сведения о [параметре безопасного ввода](#safe-typing).

   1. По завершении нажмите кнопку **Создать**.

      Logic Apps устанавливает и проверяет подключение, чтобы убедиться, что подключение работает правильно.

    > [!NOTE]

    > При возникновении следующей ошибки возникла проблема с установкой клиентской библиотеки SAP NCo: 
    >
    > **Проверка подключения не пройдена. Ошибка "не удалось обработать запрос. Сведения об ошибке: "не удалось загрузить файл или сборку" сапнко, Version = 3.0.0.42, культура = Neutral, PublicKeyToken 50436dca5c7f7d23 "или одну из ее зависимостей. Системе не удается найти указанный файл. "."**
    >
    > Обязательно [установите требуемую версию клиентской библиотеки SAP NCo и выполните все остальные предварительные требования](#sap-client-library-prerequisites).

1. Теперь найдите и выберите действие с сервера SAP.

   1. В окне **действие SAP** выберите значок папки. В списке файлов найдите и выберите сообщение SAP, которое следует использовать. Переходите по списку, используя стрелки.

      В этом примере выбирается IDoc с типом **Orders** .

      ![Поиск и выбор действия IDoc](./media/logic-apps-using-sap-connector/SAP-app-server-find-action.png)

      Если не удается найти необходимое действие, можно вручную ввести путь, например:

      ![Указание пути к действию IDoc вручную](./media/logic-apps-using-sap-connector/SAP-app-server-manually-enter-action.png)

      > [!TIP]
      > Укажите значение для **действия SAP** в редакторе выражений. Таким образом, можно использовать одно и то же действие для различных типов сообщений.

      Дополнительные сведения об операциях IDoc см. в статье [схемы сообщений для операций iDoc](/biztalk/adapters-and-accelerators/adapter-sap/message-schemas-for-idoc-operations).

   1. Щелкните внутри поля **Входное сообщение**, чтобы отобразился список динамического содержимого. В этом списке в разделе **При получении HTTP-запроса** выберите поле **Текст**.

      Этот шаг включает содержимое текста из триггера HTTP-запроса и отправляет эти выходные данные на сервер SAP.

      ![Выберите свойство "Body" из триггера.](./media/logic-apps-using-sap-connector/SAP-app-server-action-select-body.png)

      Когда вы закончите, действие SAP будет выглядеть, как в следующем примере:

      ![Завершение действия SAP](./media/logic-apps-using-sap-connector/SAP-app-server-complete-action.png)

1. Сохраните приложение логики. На панели инструментов конструктора щелкните **Сохранить**.

#### <a name="send-flat-file-idocs"></a>Отправить Неструктурированный файл iDoc

IDoc можно использовать с схемой неструктурированного файла, если они заключены в оболочку XML. Чтобы отправить IDoc неструктурированного файла, используйте общие инструкции, чтобы [создать действие SAP для отправки сообщения iDoc](#create-sap-action-to-send-message) со следующими изменениями.

1. Для действия **Отправить сообщение в SAP** используйте URI действия SAP `http://microsoft.lobservices.sap/2007/03/Idoc/SendIdoc` .

1. Форматирование входного сообщения с помощью конверта XML. Пример см. в следующем примере сообщения:

```xml
<?xml version="1.0" encoding="utf-8"?>
<SendIdoc xmlns="http://Microsoft.LobServices.Sap/2007/03/Idoc/">
  <idocData>EDI_DC    300                      ORDERS052SAPMSS    LIMSFTABCSWI                                                                                           ED  93AORDERSOLP     VLTRFC    KUMSFTABCSWI                                                                                           13561                       231054476                                                                           20190523085430ORDERSORDERS05          US
E2EDK01005300                1     E2EDK010050     1       USD                                                                        Z4O14506907554
E2EDK03   300                2     E2EDK03   0     2   02220190523
E2EDKA1   300                3     E2EDKA1   0     2   RE                  MSFTASWI
E2EDKA1   300                4     E2EDKA1   0     2   US                  MSFTASWI
E2EDKA1   300                5     E2EDKA1   0     2   WE                  MSFTASWILIC
E2EDKA1   300                6     E2EDKA1   0     2   Z1 KKKKKKK                           ABC YYYYYYYYYYY ZZ                                                                                                                          BBBBBBBBBBBBBBBB 11                                                                                      ttttttttttt                                 6666              US                                                                                                999 999 99 99                                                                                                                SSSSSSS SSS SSSSSS                                                                                                                                SSSSSSS SSS SSSSSS
E2EDKA1   300                7     E2EDKA1   0     2   Z2 KKKKKKK                           BBBBBBBBBBBBBBBB DDDDDDDD ZZ                                                                                                                EEEEEEEEEEE 86                                                                                           rrrrrrrr                                    8888              US                                                                                                999 999 99 99                                                                                                                NNNNNN NNNNNN                                                                                                                                     NNNNNN NNNNNN
E2EDK02   300                8     E2EDK02   0     2   901Z
E2EDK02   300                9     E2EDK02   0     2   90399680096ZZS2002
E2EDK02   300                10    E2EDK02   0     2   902S
E2EDKT1   300                11    E2EDKT1   0     2   Z1EME
E2EDKT2   300                12    E2EDKT2   0     3   xxx@xxx-xx.xx
E2EDKT1   300                13    E2EDKT1   0     2   Z2EME
E2EDKT2   300                14    E2EDKT2   0     3   x.xxxxxx@xxxxxxxx-xxxxxxxxxx.xx
E2EDP01001300                15    E2EDP010010     2   10         1              EA                          999.9
E2EDP19   300                16    E2EDP19   0     3   00AAAA-11111</idocData>
</SendIdoc>
```



### <a name="create-http-response-action"></a>Действие "создать HTTP-ответ"

Теперь добавьте действие ответа в рабочий процесс приложения логики и включите в него выходные данные действия SAP. Таким образом приложение логики будет возвращать результаты с сервера SAP исходной запросившей стороне.

1. В конструкторе Logic Apps в разделе действие SAP выберите **новый шаг**.

1. В поле поиска введите `response` в качестве фильтра. В списке **действия** выберите **ответ**.

1. Щелкните внутри поля **Текст**, чтобы отобразился список динамического содержимого. В списке в разделе **Отправить сообщение в SAP** выберите поле **Body** .

   ![Готовое действие SAP](./media/logic-apps-using-sap-connector/select-sap-body-for-response-action.png)

1. Сохраните приложение логики

#### <a name="create-rfc-request-response"></a>Создание запроса RFC-ответ

> [!NOTE]
> Триггер SAP получает iDoc через Трфк, который не имеет параметра отклика по проекту. 

Если необходимо получить ответы с помощью удаленного вызова функции (RFC) для Logic Apps из SAP ABAP, необходимо создать шаблон запроса и ответа. Чтобы получить iDoc в приложении логики, необходимо выполнить в первом действии [http-запрос](../connectors/connectors-native-reqres.md#add-a-response-action) с кодом состояния `200 OK` и без содержимого. Этот рекомендуемый шаг завершает асинхронную передачу SAP LUW через Трфк немедленно, что оставляет за собой доступ к сеансу SAP КПИК. Затем можно добавить в приложение логики дальнейшие действия для обработки полученных IDoc без блокировки дальнейших передач.

Чтобы реализовать шаблон запроса и ответа, сначала необходимо обнаружить схему RFC с помощью [ `generate schema` команды](#generate-schemas-for-artifacts-in-sap). Созданная схема имеет два возможных корневых узла: 

1. Узел запроса, который является вызовом, полученным из SAP.

1. Узел ответа, который представляет ответ обратно в SAP.

В следующем примере создается шаблон запроса и ответа из `STFC_CONNECTION` модуля RFC. Синтаксический анализ запроса XML выполняется для извлечения значения узла, в котором запросы SAP `<ECHOTEXT>` . Ответ вставляет текущую метку времени как динамическое значение. При отправке `STFC_CONNECTION` RFC из приложения логики в SAP вы получаете аналогичный ответ.

```http

<STFC_CONNECTIONResponse xmlns="http://Microsoft.LobServices.Sap/2007/03/Rfc/">
  <ECHOTEXT>@{first(xpath(xml(triggerBody()?['Content']), '/*[local-name()="STFC_CONNECTION"]/*[local-name()="REQUTEXT"]/text()'))}</ECHOTEXT>
  <RESPTEXT>Azure Logic Apps @{utcNow()}</RESPTEXT>


```

### <a name="test-logic-app"></a>Тестирование приложения логики

1. Если приложение логики еще не включено, в меню приложения логики выберите **Обзор**. На панели инструментов выберите **включить**.

1. На панели инструментов конструктора выберите **выполнить**. Так приложение логики будет запущено вручную.

1. Активируйте приложение логики, отправив запрос HTTP POST по URL-адресу в триггере HTTP-запроса.
Включите содержимое сообщения в запрос. Для отправки запроса можно использовать, например, средство [Postman](https://www.getpostman.com/apps).

   В этой статье запрос передает файл IDoc, который должен быть в формате XML и включать в себя пространство имен для используемого действия SAP, например:

   ```xml
   <?xml version="1.0" encoding="UTF-8" ?>
   <Send xmlns="http://Microsoft.LobServices.Sap/2007/03/Idoc/2/ORDERS05//720/Send">
      <idocData>
         <...>
      </idocData>
   </Send>
   ```

1. После отправки HTTP-запроса дождитесь ответа от приложения логики.

   > [!NOTE]
   > Время ожидания приложения логики может истечь, если все действия, необходимые для ответа, не будут завершены в течение [времени ожидания запроса](./logic-apps-limits-and-config.md). Если это произойдет, запросы могут быть заблокированы. Для помощи в диагностике неполадок узнайте, как можно [проверять и отслеживать приложения логики](../logic-apps/monitor-logic-apps.md).

Теперь вы создали приложение логики, которое может взаимодействовать с сервером SAP. Теперь с настроенным подключением SAP для приложения логики можно изучить другие доступные действия SAP, например BAPI и RFC.

## <a name="receive-message-from-sap"></a>Получение сообщения от SAP

В этом примере используется приложение логики, которое активируется, когда приложение получает сообщение от системы SAP.

### <a name="add-an-sap-trigger"></a>Добавление триггера SAP

1. В портал Azure создайте пустое приложение логики, которое открывает конструктор Logic Apps.

1. В поле поиска введите `sap` в качестве фильтра. В списке **триггеры** выберите **время получения сообщения от SAP**.

   ![Добавление триггера SAP](./media/logic-apps-using-sap-connector/add-sap-trigger-logic-app.png)

   Также можно выбрать вкладку " **предприятие** ", а затем выбрать триггер:

   ![Добавление триггера SAP из вкладки "Корпоративный"](./media/logic-apps-using-sap-connector/add-sap-trigger-ent-tab.png)

1. Если подключение уже существует, перейдите к следующему шагу, чтобы можно было настроить действие SAP. Тем не менее, если появится запрос на ввод сведений о подключении, предоставьте сведения, чтобы можно было создать подключение к локальному серверу SAP.

   1. Укажите имя подключения.

   1. Если вы используете шлюз данных, выполните следующие действия.

      1. В разделе " **шлюз данных** " на вкладке " **Подписка**" сначала выберите подписку Azure для ресурса шлюза данных, созданного в портал Azure для установки шлюза данных.

      1. В разделе **шлюз подключений** выберите ресурс шлюза данных в Azure.

   1. Продолжайте предоставлять сведения о соединении. Для свойства **тип входа** выполните действие в зависимости от того, задано ли для свойства значение **сервер приложения** или **Группа**.

      * Для **сервера приложений** эти свойства, которые обычно являются необязательными, являются обязательными:

        ![Создание подключения к серверу приложений SAP](media/logic-apps-using-sap-connector/create-SAP-application-server-connection.png)

      * Для **группы** эти свойства, которые обычно являются необязательными, являются обязательными.

        ![Создание подключения к серверу сообщений SAP](media/logic-apps-using-sap-connector/create-SAP-message-server-connection.png)

      По умолчанию строгая типизация используется для проверки недопустимых значений путем выполнения проверки XML для схемы. Такое поведение поможет обнаружить проблемы ранее. Параметр **безопасного ввода** доступен для обеспечения обратной совместимости и только проверяет длину строки. Дополнительные сведения о [параметре безопасного ввода](#safe-typing).

   1. По завершении нажмите кнопку **Создать**.

      Logic Apps устанавливает и проверяет подключение, чтобы убедиться, что подключение работает правильно.

1. Укажите [необходимые параметры](#parameters) в соответствии с конфигурацией системы SAP. 

   Вы можете [отфильтровать сообщения, полученные с сервера SAP, указав список действий SAP](#filter-with-sap-actions).

   Действие SAP можно выбрать с помощью средства выбора файла:

   ![Добавление действия SAP в приложение логики](media/logic-apps-using-sap-connector/select-SAP-action-trigger.png)  

   Или можно вручную указать действие:

   ![Вручную введите действие SAP, которое вы хотите использовать](media/logic-apps-using-sap-connector/manual-enter-SAP-action-trigger.png)

   Ниже приведен пример, в котором показано, как действие отображается в случае настройки триггера для получения более одного сообщения.

   ![Пример триггера, принимающий несколько сообщений](media/logic-apps-using-sap-connector/example-trigger.png)

   Дополнительные сведения о действии SAP см. в статье [схемы сообщений для операций iDoc](/biztalk/adapters-and-accelerators/adapter-sap/message-schemas-for-idoc-operations) .

1. Теперь сохраните приложение логики, чтобы вы могли начать получать сообщения из системы SAP. На панели инструментов конструктора щелкните **Сохранить**.

Теперь приложение логики может получать сообщения из системы SAP.

> [!NOTE]
> Триггер SAP не является опрашивающим триггером, но вместо него используется триггер на основе веб-перехватчика. Если вы используете шлюз данных, триггер вызывается из шлюза данных только в том случае, если сообщение существует, поэтому опрос не требуется.

#### <a name="parameters"></a>Параметры

Наряду с простыми строковыми и числовыми входными данными соединитель SAP принимает следующие параметры таблицы ( `Type=ITAB` входные данные):

* Параметры направления таблицы — входные и выходные данные для старых выпусков SAP.

* Изменение параметров, которые заменяют параметры направления таблицы для новых выпусков SAP.

* Параметры иерархической таблицы

#### <a name="filter-with-sap-actions"></a>Фильтрация с помощью действий SAP

При необходимости можно отфильтровать сообщения, которые приложение логики получает с сервера SAP, предоставив список или массив с одним или несколькими действиями SAP. По умолчанию этот массив пуст, а это означает, что приложение логики получает все сообщения от сервера SAP без фильтрации. 

При настройке фильтра массива триггер получает сообщения только от указанных типов действий SAP и отклоняет все остальные сообщения с сервера SAP. Однако этот фильтр не влияет на то, является ли ввод полученных полезных данных слабым или строгим.

Любая Фильтрация действий SAP происходит на уровне адаптера SAP для локального шлюза данных. Дополнительные сведения см. в разделе [Отправка тестового iDoc в Logic Apps из SAP](#test-sending-idocs-from-sap).

Если вы не можете отправить пакеты IDoc из SAP в триггер приложения логики, см. сообщение об отклонении при вызове транзакции RFC (Трфк) в диалоговом окне SAP Трфк (T-Code SM58). В интерфейсе SAP могут появиться следующие сообщения об ошибках, которые обрезаются из-за ограничений подстроки в текстовом поле **состояние** .

* `The RequestContext on the IReplyChannel was closed without a reply being`: Непредвиденные сбои происходят, когда обработчик catch-all для канала завершает канал из-за ошибки и перестраивает канал для обработки других сообщений.

  * Чтобы подтвердить, что приложение логики получило IDoc, [добавьте действие ответа](../connectors/connectors-native-reqres.md#add-a-response-action) , которое возвращает `200 OK` код состояния. IDoc передается через Трфк, что не допускает полезные данные ответа.

  * Если вместо этого нужно отклонить IDoc, ответьте на любой код состояния HTTP, отличный от, `200 OK` чтобы адаптер SAP возвращал исключение обратно в SAP от вашего имени. 

* `The segment or group definition E2EDK36001 was not found in the IDoc meta`: Ожидаемые сбои вызваны другими ошибками, например ошибкой создания полезных данных XML IDoc, так как ее сегменты не освобождаются SAP, поэтому метаданные типа сегмента, необходимые для преобразования, отсутствуют. 

  * Чтобы эти сегменты были выпущены SAP, обратитесь к инженеру ABAP для вашей системы SAP.
### <a name="asynchronous-request-reply-for-triggers"></a>Асинхронный запрос-ответ для триггеров

Соединитель SAP поддерживает [асинхронный шаблон запроса-ответа](/azure/architecture/patterns/async-request-reply.md) Azure для триггеров Logic Apps. Этот шаблон можно использовать для создания успешных запросов, которые в противном случае были бы неудачными с помощью синхронного шаблона запроса и ответа по умолчанию. 

> [!TIP]
> В приложениях логики с несколькими действиями ответа все действия ответа должны использовать один и тот же шаблон "запрос-ответ". Например, если приложение логики использует элемент управления "переключатель" с несколькими возможными действиями ответа, необходимо настроить все действия ответа так, чтобы они использовали один и тот же шаблон "запрос-ответ" (синхронный или асинхронный). 

Включение асинхронного ответа для действия ответа позволяет приложению логики ответить на ответ, `202 Accepted` Если запрос был принят на обработку. Ответ содержит заголовок Location, который можно использовать для получения окончательного состояния запроса.

Чтобы настроить шаблон асинхронного запроса-ответа для приложения логики с помощью соединителя SAP, выполните следующие действия.

1. Откройте приложение логики в **конструкторе Logic Apps**.

1. Убедитесь, что соединитель SAP является триггером для приложения логики.

1. Откройте действие **ответ** приложения логики. В заголовке окна действия выберите меню (..**.).** &gt; **Параметры**.

1. В разделе **Параметры** действия ответа включите переключатель в положение **асинхронный ответ**. Нажмите кнопку Готово.

1. Сохраните изменения в приложении логики.

## <a name="find-extended-error-logs"></a>Поиск расширенных журналов ошибок

Чтобы получить полные сообщения об ошибках, проверьте расширенные журналы адаптера SAP. Кроме того, можно [включить расширенный файл журнала для СОЕДИНИТЕЛЯ SAP](#extended-sap-logging-in-on-premises-data-gateway).

Для выпусков локальных шлюзов данных из июня 2020 и более поздних версий можно [включить журналы шлюза в параметрах приложения](/data-integration/gateway/service-gateway-tshoot#collect-logs-from-the-on-premises-data-gateway-app). 

* Уровень ведения журнала по умолчанию — **warning**.

* Если включить  **дополнительное ведение журнала** в параметрах **диагностики** для локального приложения шлюза данных, уровень ведения журнала будет увеличен до **информационного**.

* Чтобы увеличить уровень ведения журнала до уровня **verbose**, обновите следующий параметр в файле конфигурации. Как правило, файл конфигурации находится в папке `C:\Program Files\On-premises data gateway\Microsoft.PowerBI.DataMovement.Pipeline.GatewayCore.dll.config` .

```json
<setting name="SapTraceLevel" serializeAs="String">
   <value>Verbose</value>
</setting>
```

Для выпусков локального шлюза данных с 2020 апреля и более ранних версий журналы по умолчанию отключены.

### <a name="extended-sap-logging-in-on-premises-data-gateway"></a>Расширенное ведение журнала SAP в локальном шлюзе данных

При использовании [локального шлюза данных для Logic Apps](../logic-apps/logic-apps-gateway-install.md)можно настроить расширенный файл журнала для соединителя SAP. Локальный шлюз данных можно использовать для перенаправления событий трассировки событий Windows (ETW) в файлы журнала, включенные в ZIP-файлы вашего шлюза. 

Вы можете [экспортировать все журналы конфигурации и служб шлюза](https://docs.microsoft.com/data-integration/gateway/service-gateway-tshoot#collect-logs-from-the-on-premises-data-gateway-app) в ZIP-файл в с помощью параметров приложения шлюза.

> [!NOTE]
> Расширенное ведение журнала может повлиять на производительность приложений логики при постоянном включении. Рекомендуется отключить расширенные файлы журнала после завершения анализа и устранения неполадок.

#### <a name="capture-etw-events"></a>Запись событий ETW

Кроме того, опытные пользователи могут собирать события ETW напрямую. Затем вы можете [использовать данные в система диагностики Azure в концентраторах событий](https://docs.microsoft.com/azure/azure-monitor/platform/diagnostics-extension-stream-event-hubs) или [собирайте данные для Azure Monitor журналов](https://docs.microsoft.com/azure/azure-monitor/platform/diagnostics-extension-logs). Дополнительные сведения см. в [рекомендациях по сбору и хранению данных](https://docs.microsoft.com/azure/architecture/best-practices/monitoring#collecting-and-storing-data). [PerfView](https://github.com/Microsoft/perfview/blob/master/README.md) можно использовать для работы с полученными файлами ETL, или можно написать собственную программу. В этом пошаговом руководстве используется PerfView:

1. В меню PerfView выберите **собрать** &gt; **сбор** , чтобы записать события.

1. В поле **дополнительное поставщик** введите, `*Microsoft-LobAdapter` чтобы указать поставщика SAP для записи событий адаптера SAP. Если эти сведения не указаны, трассировка включает только общие события ETW.

1. Используйте другие параметры по умолчанию. При необходимости можно изменить имя файла или расположение в поле **файл данных** .

1. Выберите **начать сбор** , чтобы начать трассировку.

1. После того как вы воспользовались возникшей проблемой или собрали достаточно данных анализа, выберите пункт **Закрыть коллекцию**.

Чтобы предоставить общий доступ к данным другим сторонам, таким как инженеры службы поддержки Azure, необходимо сжать ETL-файл.

Чтобы просмотреть содержимое трассировки, выполните следующие действия.

1. В PerfView выберите **файл** &gt; **Открыть** и выберите только что созданный ETL-файл.

1. В боковой панели PerfView раздел **событий** в ETL-файле.

1. В разделе **Фильтр** выберите фильтровать по, `Microsoft-LobAdapter` чтобы просмотреть только соответствующие события и процессы шлюза.

### <a name="test-your-logic-app"></a>Тестирование приложения логики

1. Чтобы активировать приложение логики, отправьте сообщение из системы SAP.

1. В меню приложение логики выберите **Обзор**. Проверьте **журнал запусков** для всех новых запусков приложения логики.

1. Откройте последний запуск, в котором отображается сообщение, отправленное из системы SAP, в разделе выходных данных триггера.

### <a name="test-sending-idocs-from-sap"></a>Тестирование отправки iDoc из SAP

Чтобы отправить iDoc из SAP в приложение логики, требуется следующая минимальная конфигурация:

> [!IMPORTANT]
> Используйте эти шаги только при тестировании конфигурации SAP с помощью приложения логики. Для рабочих сред требуется дополнительная настройка.

1. [Настройка назначения RFC в SAP](#create-rfc-destination)

1. [Создание подключения ABAP к назначению RFC](#create-abap-connection)

1. [Создание порта получателя](#create-receiver-port)

1. [Создание порта отправителя](#create-sender-port)

1. [Создание партнера логической системы](#create-logical-system-partner)

1. [Создание профиля партнера](#create-partner-profiles)

1. [Тест отправки сообщений](#test-sending-messages)

#### <a name="create-rfc-destination"></a>Создать назначение RFC

1. Чтобы открыть **конфигурацию параметров подключения RFC** в ИНТЕРФЕЙСе SAP, используйте код транзакции **sm59** (T-Code) с префиксом **/n** .

1. Выберите **подключения TCP/IP**  >  **создать**.

1. Создайте новое назначение RFC со следующими параметрами:
    
    * В качестве **назначения RFC** введите имя.
    
    * На вкладке **технические параметры** в поле **тип активации** выберите пункт **зарегистрированный серверная программа**. В качестве **идентификатора программы** введите значение. В SAP триггер приложения логики будет зарегистрирован с использованием этого идентификатора.
    
    * На вкладке **Юникод** для **типа связи с целевой системой** выберите **Юникод**.

1. Сохраните изменения.

1. Зарегистрируйте новый **идентификатор программы** с помощью Azure Logic Apps.

1. Чтобы проверить подключение, в интерфейсе SAP в разделе новое **назначение RFC** выберите **Проверка подключения**.

#### <a name="create-abap-connection"></a>Создание подключения ABAP

1. Чтобы открыть **конфигурацию параметров подключения RFC** , в интерфейсе SAP используйте код транзакции **Sm59** _ (T-Code) с префиксом _ */n**.

1. Выберите **ABAP Connections**  >  **CREATE**.

1. В поле **назначение RFC** введите идентификатор для [тестовой системы SAP](#create-rfc-destination).

1. Сохраните изменения.

1. Чтобы проверить подключение, выберите **Проверка подключения**.

#### <a name="create-receiver-port"></a>Создание порта получателя

1. Чтобы открыть **порты в параметрах обработки iDoc** , в интерфейсе SAP используйте код транзакции **we21** (T-Code) с префиксом **/n** .

1. Выберите **порты**  >  создать **транзакционную RFC**  >  **CREATE**.

1. В открывшемся окне Параметры выберите **собственное имя порта**. В качестве тестового порта введите **имя**. Сохраните изменения.

1. В параметрах для нового порта получателя в поле **назначение RFC** введите идентификатор для [тестового назначения RFC](#create-rfc-destination).

1. Сохраните изменения.

#### <a name="create-sender-port"></a>Создание порта отправителя

1.  Чтобы открыть **порты в параметрах обработки iDoc** , в интерфейсе SAP используйте код транзакции **we21** (T-Code) с префиксом **/n** .

1. Выберите **порты**  >  создать **транзакционную RFC**  >  **CREATE**.

1. В открывшемся окне Параметры выберите **собственное имя порта**. В качестве тестового порта введите **имя** , которое начинается с **SAP**. Все имена портов отправителя должны начинаться с букв **SAP**, например **саптест**. Сохраните изменения.

1. В параметрах нового порта отправителя в поле **назначение RFC** введите идентификатор для [подключения ABAP](#create-abap-connection).

1. Сохраните изменения.

#### <a name="create-logical-system-partner"></a>Создать партнера логической системы

1. Чтобы открыть **представление изменений "Логические системы": обзор** параметров в интерфейсе SAP, используйте код транзакции **bd54** (T-Code).

1. Принять предупреждающее сообщение: **внимание: таблица перекрестно клиент**

1. Над списком, в котором показаны существующие логические системы, выберите **новые записи**.

1. Для новой логической системы введите **Log.Sysидентификатор TEM** и краткое описание **имени** . Сохраните изменения.

1. Когда появится **запрос на выдачу Workbench** , создайте новый запрос, указав описание или, если вы уже создали запрос, пропустите этот шаг.

1. После создания запроса Workbench Свяжите этот запрос с запросом на обновление таблицы. Чтобы убедиться, что таблица была обновлена, сохраните изменения.

#### <a name="create-partner-profiles"></a>Создание профилей партнеров

Для рабочих сред необходимо создать два профиля партнеров. Первый профиль предназначен для отправителя, который является вашей организацией и системой SAP. Второй профиль предназначен для получателя, который является приложением логики.

1. Чтобы открыть параметры **профилей партнеров** , в интерфейсе SAP используйте код транзакции **we20** (T-Code) с префиксом **/n** .

1. В разделе **Профили партнеров** выберите **тип партнера Ls**  >  **создать**.

1. Создайте новый профиль партнера со следующими параметрами:

    * В **качестве идентификатора партнера введите** [идентификатор партнера логической системы](#create-logical-system-partner).

    * Для **партн. Введите** **Ls**.

    * В поле **Агент** введите идентификатор учетной записи пользователя SAP, который будет использоваться при регистрации идентификаторов программ для Azure Logic Apps или других систем, отличных от SAP.

1. Сохраните изменения. Если вы еще не [создали партнера логической системы](#create-logical-system-partner), отобразится сообщение об ошибке, **Введите допустимый номер партнера**.

1. В параметрах профиля партнера в разделе **Исходящие пармтрс.** выберите **создать исходящий параметр**.

1. Создайте новый исходящий параметр со следующими параметрами:

    * Введите **тип сообщения**, например **кремас**.

    * Введите [идентификатор порта получателя](#create-receiver-port).

    * Введите размер IDoc для типа " **Pack". Размер**. Чтобы [Отправить iDoc в один момент времени из SAP](#receive-idoc-packets-from-sap), выберите **Pass iDoc немедленно**.

1. Сохраните изменения.

#### <a name="test-sending-messages"></a>Тест отправки сообщений

1. Чтобы открыть **средство тестирования для параметров обработки iDoc** , в интерфейсе SAP используйте код транзакции **we19** (T-Code) с префиксом **/n** .

1. В разделе **шаблон для теста** выберите **тип сообщения** и введите тип сообщения, например **кремас**. Нажмите кнопку **Создать**.

1. Подтвердите, **какой тип iDoc?** сообщение, выбрав **продолжить**.

1. Выберите узел **едидк** . Введите соответствующие значения для получателей и портов отправителя. Выберите **Continue** (Продолжить).

1. Выберите **стандартную исходящую обработку**.

1. Чтобы начать исходящие IDoc обработки, нажмите кнопку **продолжить**. После завершения обработки появится сообщение **iDoc Sent to SAP System или External Program** .

1.  Чтобы проверить ошибки обработки, используйте код транзакции **SM58** (T-Code) с префиксом **/n** .

## <a name="receive-idoc-packets-from-sap"></a>Получение пакетов IDoc из SAP

Вы можете настроить SAP для [отправки iDoc в пакеты](https://help.sap.com/viewer/8f3819b0c24149b5959ab31070b64058/7.4.16/4ab38886549a6d8ce10000000a42189c.html), которые являются пакетами или группами iDoc. Для получения пакетов IDoc, соединитель SAP, в частности триггер, не требует дополнительной настройки. Однако для обработки каждого элемента в пакете IDoc после того, как триггер получит пакет, необходимо выполнить некоторые дополнительные действия, чтобы разделить пакет на отдельные iDoc.

Ниже приведен пример, демонстрирующий извлечение отдельных iDoc из пакета с помощью [ `xpath()` функции](./workflow-definition-language-functions-reference.md#xpath).

1. Прежде чем начать, вам потребуется приложение логики с триггером SAP. Если у вас еще нет этого приложения логики, выполните описанные выше действия в этом разделе, чтобы [настроить приложение логики с помощью триггера SAP](#receive-message-from-sap).

   Пример:

   ![Добавление триггера SAP в приложение логики](./media/logic-apps-using-sap-connector/first-step-trigger.png)

1. Получите корневое пространство имен из IDoc XML, которое приложение логики получает из SAP. Чтобы извлечь это пространство имен из XML-документа, добавьте шаг, который создает локальную строковую переменную и сохраняет это пространство имен с помощью `xpath()` выражения:

   `xpath(xml(triggerBody()?['Content']), 'namespace-uri(/*)')`

   ![Получить корневое пространство имен из IDoc](./media/logic-apps-using-sap-connector/get-namespace.png)

1. Чтобы извлечь отдельные IDoc, добавьте шаг, который создает переменную массива и сохраняет коллекцию IDoc с помощью другого `xpath()` выражения:

   `xpath(xml(triggerBody()?['Content']), '/*[local-name()="Receive"]/*[local-name()="idocData"]')`

   ![Получить массив элементов](./media/logic-apps-using-sap-connector/get-array.png)

   Переменная массива делает каждый IDoc доступным для приложения логики по отдельности, перечисляя коллекцию. В этом примере приложение логики передает каждую IDoc на SFTP-сервер с помощью цикла:

   ![Отправка IDoc на SFTP Server](./media/logic-apps-using-sap-connector/loop-batch.png)

   Каждый IDoc должен включать корневое пространство имен. это причина, по которой содержимое файла упаковывается внутри `<Receive></Receive` элемента вместе с корневым пространством имен перед отправкой iDoc в подчиненное приложение, или SFTP-сервер в этом случае.

Вы можете использовать шаблон быстрого запуска для этого шаблона, выбрав этот шаблон в конструкторе Logic Apps при создании нового приложения логики.

![Выбор шаблона приложения пакетной логики](./media/logic-apps-using-sap-connector/select-batch-logic-app-template.png)

## <a name="generate-schemas-for-artifacts-in-sap"></a>Создание схем для артефактов в SAP

В этом примере используется приложение логики, которое может запускаться по HTTP-запросу. Чтобы создать схемы для указанных IDoc и BAPI, действие SAP **Generate Schema** отправляет запрос в систему SAP.

Это действие SAP возвращает [схему XML](#sample-xml-schemas), а не содержимое и данные XML-документа. Схемы, возвращаемые в ответе, передаются в учетную запись интеграции с помощью соединителя Azure Resource Manager. Схемы содержат следующие компоненты:

* Структура сообщения запроса. Используйте эти сведения для формирования списка BAPI `get` .

* Структура ответного сообщения. Используйте эти сведения для анализа ответа. 

Чтобы отправить сообщение запроса, используйте общее действие SAP **Отправка сообщения в SAP** или **вызов действий BAPI целевого вызова** .

### <a name="sample-xml-schemas"></a>Примеры XML-схем

Если вы изучаете, как создать схему XML для использования при создании образца документа, см. следующие примеры. В этих примерах показано, как можно работать с несколькими типами полезных данных, в том числе:

* [Запросы RFC](#xml-samples-for-rfc-requests)

* [Запросы BAPI](#xml-samples-for-bapi-requests)

* [Запросы IDoc](#xml-samples-for-idoc-requests)

* Простые или сложные типы данных схемы XML

* Параметры таблицы

* Необязательные варианты поведения XML

Вы можете начать XML-схему с помощью необязательного пролога XML. Соединитель SAP работает с прологом XML или без него.

```xml

<?xml version="1.0" encoding="utf-8">

```

#### <a name="xml-samples-for-rfc-requests"></a>Примеры XML для запросов RFC

В следующем примере показан базовый вызов RFC. Имя RFC — `STFC_CONNECTION` . В этом запросе используется пространство имен по умолчанию `xmlns=` . Однако можно назначать и использовать псевдонимы пространств имен, такие как `xmmlns:exampleAlias=` . Значение Namespace — это пространство имен для всех документов RFC в SAP для служб Майкрософт. В запросе есть простой входной параметр `<REQUTEXT>` .

```xml

<STFC_CONNECTION xmlns="http://Microsoft.LobServices.Sap/2007/03/Rfc/">
  <REQUTEXT>exampleInput</REQUTEXT>
</STFC_CONNECTION>

```

В следующем примере показан вызов RFC с параметром Table. Этот пример вызова и Группа тестовых документов RFC доступны как часть всех систем SAP. Имя параметра таблицы — `TCPICDAT` . Тип строки таблицы — `ABAPTEXT` , а этот элемент повторяется для каждой строки в таблице. Этот пример содержит одну строку с именем `LINE` . Запросы с параметром таблицы могут содержать любое количество полей, где число является положительным целым числом (*n*). 

```xml

<STFC_WRITE_TO_TCPIC xmlns="http://Microsoft.LobServices.Sap/2007/03/Rfc/">
  <RESTART_QNAME>exampleQName</RESTART_QNAME>
    <TCPICDAT>
      <ABAPTEXT xmlns="http://Microsoft.LobServices.Sap/2007/03/Rfc/">
        <LINE>exampleFieldInput1</LINE>
      <ABAPTEXT xmlns="http://Microsoft.LobServices.Sap/2007/03/Rfc/">
        <LINE>exampleFieldInput2</LINE>
      <ABAPTEXT xmlns="http://Microsoft.LobServices.Sap/2007/03/Rfc/">
        <LINE>exampleFieldInput3</LINE>
      </ABAPTEXT>
    </TCPICDAT>
</STFC_WRITE_TO_TCPIC>

```

В следующем примере представлен вызов RFC с параметром таблицы, имеющим анонимное поле. Анонимное поле —, когда полю не назначено имя. Сложные типы объявляются в отдельном пространстве имен, в котором объявление задает новое значение по умолчанию для текущего узла и всех его дочерних элементов. В примере шестнадцатеричный код используется `x002F` в качестве escape-символа для символа */* , так как этот символ зарезервирован в имени поля SAP.

```xml

<RFC_XML_TEST_1 xmlns="http://Microsoft.LobServices.Sap/2007/03/Rfc/">
  <IM_XML_TABLE>
    <RFC_XMLCNT xmlns="http://Microsoft.LobServices.Sap/2007/03/Rfc/">
      <_x002F_AnonymousField>exampleFieldInput</_x002F_AnonymousField>
    </RFC_XMLCNT>
  </IM_XML_TABLE>
</RFC_XML_TEST_1>

```

Следующий пример включает префиксы для пространств имен. Можно объявить все префиксы одновременно или можно объявить любое число префиксов как атрибуты узла. Псевдоним пространства имен RFC `ns0` используется в качестве корневого и параметров для базового типа.

> [!NOTE]
> сложные типы объявляются в другом пространстве имен для типов RFC с псевдонимом `ns3` вместо обычного пространства имен RFC с псевдонимом `ns0` .

```xml

<ns0:BBP_RFC_READ_TABLE xmlns:ns0="http://Microsoft.LobServices.Sap/2007/03/Rfc/" xmlns:ns3="http://Microsoft.LobServices.Sap/2007/03/Types/Rfc/">
  <ns0:DELIMITER>0</ns0:DELIMITER>
  <ns0:QUERY_TABLE>KNA1</ns0:QUERY_TABLE>
  <ns0:ROWCOUNT>250</ns0:ROWCOUNT>
  <ns0:ROWSKIPS>0</ns0:ROWSKIPS>
  <ns0:FIELDS>
    <ns3:RFC_DB_FLD>
      <ns3:FIELDNAME>KUNNR</ns3:FIELDNAME>
    </ns3:RFC_DB_FLD>
  </ns0:FIELDS>
</ns0:BBP_RFC_READ_TABLE>

```

#### <a name="xml-samples-for-bapi-requests"></a>Примеры XML для запросов BAPI

Следующие примеры XML — это примеры запросов для [вызова метода BAPI](#call-bapi-action).

> [!NOTE]
> SAP делает бизнес-объекты доступными для внешних систем, описывая их в ответ на RFC `RPY_BOR_TREE_INIT` , который Logic Apps проблемы без входного фильтра. Logic Apps проверяет выходную таблицу `BOR_TREE` . `SHORT_TEXT`Поле используется для имен бизнес-объектов. Бизнес-объекты, не возвращаемые SAP в выходной таблице, недоступны для Logic Apps.
> 
> При использовании пользовательских бизнес-объектов необходимо опубликовать и освободить эти бизнес-объекты в SAP. В противном случае SAP не будет перечислять пользовательские бизнес-объекты в выходной таблице `BOR_TREE` . Вы не можете получить доступ к пользовательским бизнес-объектам в Logic Apps, пока не предоставите бизнес-объекты из SAP. 

В следующем примере возвращается список банков, использующих метод BAPI `GETLIST` . Этот пример содержит бизнес-объект для банка, `BUS1011` . 

```xml

<GETLIST xmlns="http://Microsoft.LobServices.Sap/2007/03/Bapi/BUS1011">
  <BANK_CTRY>US</BANK_CTRY>
  <MAX_ROWS>10</MAX_ROWS>
</GETLIST>

```

В следующем примере создается объект Bank с помощью `CREATE` метода. В этом примере используется тот же бизнес-объект, что и в предыдущем примере `BUS1011` . При использовании `CREATE` метода для создания банка обязательно зафиксируйте изменения, так как этот метод не фиксируется по умолчанию.

> [!TIP]
> Убедитесь, что XML-документ соответствует правилам проверки, настроенным в системе SAP. Например, в этом примере документа ключ банка ( `<BANK_KEY>` ) должен быть номером банковской маршрутизации, также известным как номер ABA в США.

```xml

<CREATE xmlns="http://Microsoft.LobServices.Sap/2007/03/Bapi/BUS1011">
  <BANK_ADDRESS>
    <BANK_NAME xmlns="http://Microsoft.LobServices.Sap/2007/03/Types/Rfc">ExampleBankName</BANK_NAME>
    <REGION xmlns="http://Microsoft.LobServices.Sap/2007/03/Types/Rfc">ExampleRegionName</REGION>
    <STREET xmlns="http://Microsoft.LobServices.Sap/2007/03/Types/Rfc">ExampleStreetAddress</STREET>
    <CITY xmlns="http://Microsoft.LobServices.Sap/2007/03/Types/Rfc">Redmond</CITY>
  </BANK_ADDRESS>
  <BANK_COUNTRY>US</BANK_COUNTRY>
  <BANK_KEY>123456789</BANK_KEY>
</CREATE>

```

В следующем примере показано получение сведений о банке с помощью банковского номера банка, значения для `<BANK_KEY>` . 

```xml

<GETDETAIL xmlns="http://Microsoft.LobServices.Sap/2007/03/Bapi/BUS1011">
  <BANK_COUNTRY>US</BANK_COUNTRY>
  <BANK_KEY>123456789</BANK_KEY>
</GETDETAIL>

```

#### <a name="xml-samples-for-idoc-requests"></a>Примеры XML для запросов IDoc

Чтобы создать простую XML-схему SAP IDoc, используйте приложение **входа SAP** и код T-Code `WE-60` . Получите доступ к документации SAP через графический интерфейс пользователя и создайте схемы XML в формате XSD для типов и расширений IDoc. Описание универсальных форматов и полезных данных SAP, а также их встроенных диалоговых окон см. в [документации SAP](https://help.sap.com/viewer/index).

В этом примере объявляется корневой узел и пространства имен. Универсальный код ресурса (URI) в примере кода `http://Microsoft.LobServices.Sap/2007/03/Idoc/3/ORDERS05//700/Send` объявляет следующую конфигурацию:

* `/IDoc` является корневым примечанием для всех iDoc
* `/3` версия типов записей для общих определений сегментов
* `/ORDERS05` является типом IDoc
* `//` является пустым сегментом, так как отсутствует расширение IDoc
* `/700` является версией SAP
* `/Send` действие по отправке информации в SAP

```xml

<ns0:Send xmlns:ns0="http://Microsoft.LobServices.Sap/2007/03/Idoc/3/ORDERS05//700/Send" xmlns:ns3="http://schemas.microsoft.com/2003/10/Serialization" xmlns:ns1="http://Microsoft.LobServices.Sap/2007/03/Types/Idoc/Common/" xmlns:ns2="http://Microsoft.LobServices.Sap/2007/03/Idoc/3/ORDERS05//700">
  <ns0:idocData>

```

Вы можете повторить `idocData` узел, чтобы отправить пакет iDoc в одном вызове. В приведенном ниже примере имеется одна запись управления, `EDI_DC40` и несколько записей данных.

```xml

<...>
  <ns0:idocData>
    <ns2:EDI_DC40>
      <ns1:TABNAM>EDI_DC40</ns1:TABNAM>
<...>
      <ns1:ARCKEY>Cor1908207-5</ns1:ARCKEY>
    </ns2:EDI_DC40>
    <ns2:E2EDK01005>
      <ns2:DATAHEADERCOLUMN_SEGNAM>E23DK01005</ns2:DATAHEADERCOLUMN_SEGNAM>
      <ns2:CURCY>USD</ns2:CURCY>
    </ns2:E2EDK01005>
    <ns2:E2EDK03>
<...>
  </ns0:idocData>

```

В следующем примере показан пример записи элемента управления IDoc, которая использует префикс `EDI_DC` . Необходимо обновить значения в соответствии с установкой SAP и типом IDoc. Например, код клиента IDoc может быть недоступен `800` . Обратитесь к группе SAP, чтобы убедиться, что вы используете правильные значения для установки SAP.

```xml

<ns2:EDI_DC40>
  <ns:TABNAM>EDI_DC40</ns1:TABNAM>
  <ns:MANDT>800</ns1:MANDT>
  <ns:DIRECT>2</ns1:DIRECT>
  <ns:IDOCTYP>ORDERS05</ns1:IDOCTYP>
  <ns:CIMTYP></ns1:CIMTYP>
  <ns:MESTYP>ORDERS</ns1:MESTYP>
  <ns:STD>X</ns1:STD>
  <ns:STDVRS>004010</ns1:STDVRS>
  <ns:STDMES></ns1:STDMES>
  <ns:SNDPOR>SAPENI</ns1:SNDPOR>
  <ns:SNDPRT>LS</ns1:SNDPRT>
  <ns:SNDPFC>AG</ns1:SNDPFC>
  <ns:SNDPRN>ABAP1PXP1</ns1:SNDPRN>
  <ns:SNDLAD></ns1:SNDLAD>
  <ns:RCVPOR>BTSFILE</ns1:RCVPOR>
  <ns:RCVPRT>LI</ns1:RCVPRT>

```

В следующем примере показан пример записи данных с обычными сегментами. В этом примере используется формат даты SAP. Документы со строгой типизацией могут использовать собственные форматы даты XML, такие как `2020-12-31 23:59:59` .

```xml

<ns2:E2EDK01005>
  <ns2:DATAHEADERCOLUMN_SEGNAM>E2EDK01005</ns2:DATAHEADERCOLUMN_SEGNAM>
    <ns2:CURCY>USD</ns2:CURCY>
    <ns2:BSART>OR</ns2:BSART>
    <ns2:BELNR>1908207-5</ns2:BELNR>
    <ns2:ABLAD>CC</ns2:ABLAD>
  </ns2>
  <ns2:E2EDK03>
    <ns2:DATAHEADERCOLUMN_SEGNAM>E2EDK03</ns2:DATAHEADERCOLUMN_SEGNAM>
      <ns2:IDDAT>002</ns2:IDDAT>
      <ns2:DATUM>20160611</ns2:DATUM>
  </ns2:E2EDK03>

```

В следующем примере показана запись данных с сгруппированными сегментами. Запись включает родительский узел группы, `E2EDKT1002GRP` и несколько дочерних узлов, включая `E2EDKT1002` и `E2EDKT2001` . 

```xml

<ns2:E2EDKT1002GRP>
  <ns2:E2EDKT1002>
    <ns2:DATAHEADERCOLUMN_SEGNAM>E2EDKT1002</ns2:DATAHEADERCOLUMN_SEGNAM>
      <NS2:TDID>ZONE</ns2:TDID>
  </ns2:E2EDKT1002>
  <ns2:E2EDKT2001>
    <ns2:DATAHEADERCOLUMN_SEGNAM>E2EDKT2001</ns2:DATAHEADERCOLUMN_SEGNAM>
      <ns2:TDLINE>CRSD</ns2:TDLINE>
  </ns2:E2EDKT2001>
</ns2:E2EDKT1002GRP>

```

Рекомендуемый способ — создать идентификатор IDoc для использования с Трфк. Этот идентификатор транзакции можно задать `tid` с помощью [операции Send iDoc](/connectors/sap/#send-idoc) в API соединителя SAP.

Следующий пример является альтернативным методом для задания идентификатора транзакции или `tid` . В этом примере закрываются последний узел сегмента записи данных и узел данных IDoc. Затем GUID `guid` используется в качестве идентификатора трфк для обнаружения дубликатов. 

```xml

    </E2STZUM002GRP>
  </idocData>
  <guid>8820ea40-5825-4b2f-ac3c-b83adc34321c</guid>
</Send>

```

### <a name="add-an-http-request-trigger"></a>Добавление триггера HTTP-запроса

1. В портал Azure создайте пустое приложение логики, которое открывает конструктор Logic Apps.

1. В поле поиска введите `http request` в качестве фильтра. В списке **триггеры** выберите **время получения HTTP-запроса**.

   ![Добавление триггера HTTP-запроса](./media/logic-apps-using-sap-connector/add-http-trigger-logic-app.png)

1. Теперь сохраните приложение логики, чтобы можно было создать для него URL-адрес конечной точки.
На панели инструментов конструктора щелкните **Сохранить**.

   Теперь URL-адрес конечной точки появится в триггере, например:

   ![Создание URL-адреса для конечной точки](./media/logic-apps-using-sap-connector/generate-http-endpoint-url.png)

### <a name="add-an-sap-action-to-generate-schemas"></a>Добавление действия SAP для создания схем

1. В конструкторе Logic Apps в разделе триггер выберите **новый шаг**.

   ![Добавление нового шага в приложение логики](./media/logic-apps-using-sap-connector/add-sap-action-logic-app.png)

1. В поле поиска введите `sap` в качестве фильтра. В списке **действия** выберите **создать схемы**.
  
   ![Добавление действия "Создание схем" в приложение логики](media/logic-apps-using-sap-connector/select-sap-schema-generator-action.png)

   Также можно выбрать вкладку " **предприятие** " и выбрать действие SAP.

   ![Выбор действия отправки в SAP на вкладке "Корпоративный"](media/logic-apps-using-sap-connector/select-sap-schema-generator-ent-tab.png)

1. Если подключение уже существует, перейдите к следующему шагу, чтобы можно было настроить действие SAP. Тем не менее, если появится запрос на ввод сведений о подключении, предоставьте сведения, чтобы можно было создать подключение к локальному серверу SAP.

   1. Укажите имя подключения.

   1. В разделе " **шлюз данных** " на вкладке " **Подписка**" сначала выберите подписку Azure для ресурса шлюза данных, созданного в портал Azure для установки шлюза данных. 
   
   1. В разделе **шлюз подключений** выберите ресурс шлюза данных в Azure.

   1. Продолжайте предоставлять сведения о соединении. Для свойства **тип входа** выполните действие в зависимости от того, задано ли для свойства значение **сервер приложения** или **Группа**.
   
      * Для **сервера приложений** эти свойства, которые обычно являются необязательными, являются обязательными:

        ![Создание подключения к серверу приложений SAP](media/logic-apps-using-sap-connector/create-SAP-application-server-connection.png)

      * Для **группы** эти свойства, которые обычно являются необязательными, являются обязательными.

        ![Создание подключения к серверу сообщений SAP](media/logic-apps-using-sap-connector/create-SAP-message-server-connection.png)  

      По умолчанию строгая типизация используется для проверки недопустимых значений путем выполнения проверки XML для схемы. Такое поведение поможет обнаружить проблемы ранее. Параметр **безопасного ввода** доступен для обеспечения обратной совместимости и только проверяет длину строки. Дополнительные сведения о [параметре безопасного ввода](#safe-typing).

   1. По завершении нажмите кнопку **Создать**.

      Logic Apps устанавливает и проверяет подключение, чтобы убедиться, что подключение работает правильно.

1. Укажите путь к артефакту, для которого требуется создать схему.

   Действие SAP можно выбрать с помощью средства выбора файла:

   ![Выбор действия SAP](media/logic-apps-using-sap-connector/select-SAP-action-schema-generator.png)  

   Можно также ввести действие вручную:

   ![Ввод действия SAP вручную](media/logic-apps-using-sap-connector/manual-enter-SAP-action-schema-generator.png)

   Чтобы создать схемы для нескольких артефактов, укажите сведения о действии SAP для каждого артефакта, например:

   ![Выбор команды "Добавить новый элемент"](media/logic-apps-using-sap-connector/schema-generator-array-pick.png)

   ![Отображение двух элементов](media/logic-apps-using-sap-connector/schema-generator-example.png)

   Дополнительные сведения о действии SAP см. в статье [схемы сообщений для операций iDoc](/biztalk/adapters-and-accelerators/adapter-sap/message-schemas-for-idoc-operations).

1. Сохраните приложение логики. На панели инструментов конструктора щелкните **Сохранить**.

### <a name="test-your-logic-app"></a>Тестирование приложения логики

1. На панели инструментов конструктора выберите **выполнить** , чтобы активировать запуск для приложения логики.

1. Откройте выполнение и проверьте выходные данные для действия **создать схемы** .

   В выходных данных отображаются созданные схемы для указанного списка сообщений.

### <a name="upload-schemas-to-an-integration-account"></a>Отправка схем в учетную запись интеграции

При необходимости можно загрузить созданные схемы и сохранить их в репозиториях, таких как большой двоичный объект, хранилище или учетная запись интеграции. Учетные записи интеграции предоставляют отличный интерфейс для работы с другими действиями XML, поэтому в этом примере показано, как отправить схемы в учетную запись интеграции для того же приложения логики с помощью соединителя Azure Resource Manager.

1. В конструкторе Logic Apps в разделе триггер выберите **новый шаг**.

1. В поле поиска введите `Resource Manager` в качестве фильтра. Выберите **создать или обновить ресурс**.

   ![Выбор действия Azure Resource Manager](media/logic-apps-using-sap-connector/select-azure-resource-manager-action.png)

1. Введите сведения о действии, включая подписку Azure, группу ресурсов Azure и учетную запись интеграции. Чтобы добавить маркеры SAP в поля, щелкните внутри полей для этих полей и выберите в появившемся списке динамическое содержимое.

   1. Откройте список **Добавить новый параметр** и выберите поля **Расположение** и **Свойства** .

   1. Укажите сведения для этих новых полей, как показано в этом примере.

      ![Ввод сведений для действия Azure Resource Manager](media/logic-apps-using-sap-connector/azure-resource-manager-action.png)

   Действие SAP **Generate schemas** (Создать схемы) создает схемы в виде коллекции, поэтому конструктор автоматически добавляет цикл **for each** в действие. Ниже приведен пример, в котором показано, как выглядит это действие:

   ![Действие Azure Resource Manager с циклом for each](media/logic-apps-using-sap-connector/azure-resource-manager-action-foreach.png)

   > [!NOTE]
   > Схемы используют формат в кодировке base64. Чтобы отправить схемы в учетную запись интеграции, они должны быть декодированы с помощью функции `base64ToString()`. Ниже приведен пример, содержащий код для элемента `"properties"`:
   >
   > ```json
   > "properties": {
   >    "Content": "@base64ToString(items('For_each')?['Content'])",
   >    "ContentType": "application/xml",
   >    "SchemaType": "Xml"
   > }
   > ```

1. Сохраните приложение логики. На панели инструментов конструктора щелкните **Сохранить**.

### <a name="test-your-logic-app"></a>Тестирование приложения логики

1. На панели инструментов конструктора выберите **выполнить** , чтобы вручную запустить приложение логики.

1. После успешного выполнения перейдите к учетной записи интеграции и убедитесь, что созданные схемы существуют.

## <a name="enable-secure-network-communications"></a>Включить безопасные сетевые подключения

Прежде чем начать, убедитесь, что выполнены предварительно перечисленные [Предварительные требования](#prerequisites), которые применяются только при использовании шлюза данных и приложений логики, работающих в нескольких клиентах Azure:

* Убедитесь, что локальный шлюз данных установлен на компьютере, который находится в той же сети, что и система SAP.

* Для единого входа шлюз данных работает как пользователь, сопоставленный с пользователем SAP.

* Библиотека SNC, которая предоставляет дополнительные функции безопасности, устанавливается на том же компьютере, что и шлюз данных. Некоторые примеры включают [сапсекулиб](https://help.sap.com/saphelp_nw74/helpdata/en/7a/0755dc6ef84f76890a77ad6eb13b13/frameset.htm), Kerberos и NTLM.

   Чтобы включить SNC для запросов или из системы SAP, установите флажок **использовать SNC** в подключении SAP и укажите следующие свойства:

   ![Настройка SAP SNC в подключении](media/logic-apps-using-sap-connector/configure-sapsnc.png)

   | Свойство | Описание |
   |----------| ------------|
   | **Путь к библиотеке SNC** | Имя библиотеки SNC или путь относительно расположения установки NCo или абсолютного пути. Примеры: `sapsnc.dll` или `.\security\sapsnc.dll` `c:\security\sapsnc.dll` . |
   | **ЕДИНЫЙ ВХОД SNC** | При подключении через SNC для проверки подлинности вызывающего объекта обычно используется удостоверение SNC. Другой вариант — переопределить, чтобы данные пользователя и пароля можно было использовать для проверки подлинности вызывающего объекта, но строка по-прежнему шифруется. |
   | **Имя SNC** | В большинстве случаев это свойство можно опустить. Установленное решение SNC обычно знает свое собственное имя SNC. Для решений, которые поддерживают несколько удостоверений, может потребоваться указать удостоверение, которое будет использоваться для этого конкретного назначения или сервера. |
   | **Имя партнера SNC** | Имя серверной части SNC. |
   | **Качество защиты SNC** | Качество обслуживания, используемое для обмена данными с этим конкретным местом назначения или сервером. Значение по умолчанию определяется внутренней системой. Максимальное значение определяется продуктом безопасности, используемым для SNC. |
   |||

   > [!NOTE]
   > Не задавайте переменные среды SNC_LIB и SNC_LIB_64 на компьютере, где есть шлюз данных и библиотека SNC. Если задано значение, они имеют приоритет над значением библиотеки SNC, передаваемым через соединитель.

## <a name="safe-typing"></a>Надежная типизация

По умолчанию при создании подключения SAP используется строгая типизация для проверки недопустимых значений путем выполнения проверки XML для схемы. Такое поведение поможет обнаружить проблемы ранее. Параметр **безопасного ввода** доступен для обеспечения обратной совместимости и только проверяет длину строки. Если выбрана **надежная типизация**, тип DATS и тип TIMS в SAP обрабатываются как строки, а не как их эквиваленты в формате XML `xs:date` и `xs:time` , где `xmlns:xs="http://www.w3.org/2001/XMLSchema"` . В результате безопасного ввода влияет на поведение всех поколений схемы, сообщение Send для полезных данных "Отправлено" и "получено" и триггер. 

При использовании строгой **типизации** схема СОПОСТАВЛЯЕТ типы DATS и TIMS с более простыми типами XML:

```xml
<xs:element minOccurs="0" maxOccurs="1" name="UPDDAT" nillable="true" type="xs:date"/>
<xs:element minOccurs="0" maxOccurs="1" name="UPDTIM" nillable="true" type="xs:time"/>
```

При отправке сообщений с помощью строгой типизации ответ DATS и TIMS соответствует формату соответствующего XML-типа:

```xml
<DATE>9999-12-31</DATE>
<TIME>23:59:59</TIME>
```

Если включена возможность **безопасного ввода** , схема СОПОСТАВЛЯЕТ типы DATS и TIMS с СТРОКОВЫМИ XML-полями с ограничениями длины, например:

```xml
<xs:element minOccurs="0" maxOccurs="1" name="UPDDAT" nillable="true">
  <xs:simpleType>
    <xs:restriction base="xs:string">
      <xs:maxLength value="8" />
    </xs:restriction>
  </xs:simpleType>
</xs:element>
<xs:element minOccurs="0" maxOccurs="1" name="UPDTIM" nillable="true">
  <xs:simpleType>
    <xs:restriction base="xs:string">
      <xs:maxLength value="6" />
    </xs:restriction>
  </xs:simpleType>
</xs:element>
```

Когда сообщения отправляются с включенной службой **безопасного ввода** , ответ DATS и TIMS выглядит следующим образом:

```xml
<DATE>99991231</DATE>
<TIME>235959</TIME>
```

## <a name="advanced-scenarios"></a>Сложные сценарии

### <a name="change-language-headers"></a>Изменение заголовков языков

При подключении к SAP из Logic Apps языком по умолчанию для подключения является английский. Вы можете задать язык для подключения, используя [стандартный заголовок `Accept-Language` http](https://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.4) с входящими запросами.

> [!TIP]
> Большинство веб-браузеров добавляют `Accept-Language` заголовок на основе параметров пользователя. Веб-браузер применяет этот заголовок при создании нового подключения SAP в конструкторе Logic Apps. Если вы не хотите создавать подключения SAP на предпочитаемом языке веб-браузера, обновите параметры веб-браузера, чтобы использовать предпочтительный язык, или создайте подключение SAP с помощью Azure Resource Manager вместо конструктора Logic Apps. 

Например, можно отправить запрос с `Accept-Language` заголовком в приложение логики с помощью триггера **http-запроса** . Все действия в приложении логики получают заголовок. Затем SAP использует указанные языки в системных сообщениях, например сообщения об ошибках BAPI.

Параметры подключения SAP для приложения логики не имеют свойства Language. Поэтому при использовании `Accept-Language` заголовка может появиться следующая ошибка: **Проверьте сведения об учетной записи и/или разрешения и повторите попытку.** В этом случае проверьте журналы ошибок компонента SAP. Ошибка возникает в компоненте SAP, который использует заголовок, поэтому может появиться одно из следующих сообщений об ошибке:

* `"SAP.Middleware.Connector.RfcLogonException: Select one of the installed languages"`
* `"SAP.Middleware.Connector.RfcAbapMessageException: Select one of the installed languages"`

### <a name="confirm-transaction-explicitly"></a>Явно подтвердить транзакцию

При отправке транзакций в SAP из Logic Apps этот обмен происходит в два этапа, как описано в документе SAP, [серверные программы RFC, используемые в транзакции](https://help.sap.com/doc/saphelp_nwpi71/7.1/22/042ad7488911d189490000e829fbbd/content.htm?no_cache=true). По умолчанию действие **Send to SAP** обрабатывает Оба шага передачи функции и для подтверждения транзакции в одном вызове. Соединитель SAP предоставляет возможность отделения этих шагов. Вы можете отправить IDoc, а не автоматически подтверждать транзакцию, можно использовать действие явно **подтвердить идентификатор транзакции** .

Эта возможность отделения идентификатора транзакции может оказаться полезной, если вы не хотите дублировать транзакции в SAP, например в случаях, когда сбои могут произойти из-за таких причин, как проблемы с сетью. Проверив идентификатор транзакции отдельно, транзакция будет выполнена только один раз в системе SAP.

Ниже приведен пример, демонстрирующий этот шаблон:

1. Создайте пустое приложение логики и добавьте триггер HTTP.

1. Из соединителя SAP добавьте действие **Send iDoc** . Укажите сведения о IDoc, отправляемых в систему SAP.

1. Чтобы явно подтвердить идентификатор транзакции на отдельном шаге, в поле **Подтверждение TID** выберите **нет**. Для поля необязательного идентификатора **транзакции идентификатор GUID** можно вручную указать значение или автоматически создать соединитель и вернуть этот идентификатор GUID в ответе действия Send iDoc.

   ![Отправить свойства действия IDOC](./media/logic-apps-using-sap-connector/send-idoc-action-details.png)

1. Чтобы явно подтвердить идентификатор транзакции, добавьте действие **Подтверждение идентификатора транзакции** , чтобы [избежать отправки дубликатов iDoc в SAP](#avoid-sending-duplicate-idocs). Щелкните внутри поля **идентификатор транзакции** , чтобы появился список динамического содержимого. В этом списке выберите значение **идентификатора транзакции** , возвращаемое действием **Send iDoc** .

   ![Действие "подтвердить идентификатор транзакции"](./media/logic-apps-using-sap-connector/explicit-transaction-id.png)

   После выполнения этого шага текущая транзакция помечается как завершенная на обоих концах, на стороне соединителя SAP и на стороне системы SAP.

#### <a name="avoid-sending-duplicate-idocs"></a>Предотвращение отправки повторяющихся iDoc

При возникновении проблемы с повторяющимися iDoc, отправляемыми в SAP из приложения логики, выполните следующие действия, чтобы создать строковую переменную, которая будет использоваться в качестве идентификатора транзакции IDoc. Создание этого идентификатора транзакции помогает предотвратить дублирование сетевых передач при возникновении таких проблем, как временные сбои, сетевые проблемы или потеря подтверждений.

> [!NOTE]
> Системы SAP забывают идентификатор транзакции в течение заданного времени или 24 часа по умолчанию. В результате SAP никогда не сможет подтвердить идентификатор транзакции, если идентификатор или идентификатор GUID неизвестен.
> При сбое подтверждения для идентификатора транзакции это означает, что по протоколу с системой SAP завершилась сбоем, прежде чем SAP смог подтвердить подтверждение.

1. В конструкторе Logic Apps добавьте в приложение логики **переменную инициализации** действия. 

1. В редакторе для **переменной инициализации** действия настройте следующие параметры. Затем сохраните изменения.

    1. В качестве **имени** введите имя переменной. Например, `IDOCtransferID`.

    1. В поле **тип** выберите **строка** в качестве типа переменной.

    1. Для **параметра значение** выберите текстовое поле **введите начальное значение** , чтобы открыть меню динамического содержимого. Перейдите на вкладку **выражения** . В списке функций введите функцию `guid()` . Затем нажмите кнопку **ОК** , чтобы сохранить изменения. Теперь в поле **значение** задается `guid()` функция, которая создает идентификатор GUID.

1. После действия **инициализации переменной** добавьте действие **Send iDoc**.

1. В редакторе для действия **Отправить iDoc** настройте следующие параметры. Затем сохраните изменения.

    1. Для **типа iDoc** выберите тип сообщения, а для **входного сообщения iDoc** укажите сообщение.

    1. В качестве **версии выпуска SAP** выберите значения конфигурации SAP.

    1. В качестве **версии для типов записей** выберите значения конфигурации SAP.

    1. Для **подтверждения TID** выберите **нет**.

    1. Выберите **Добавить новый список параметров**  >  **идентификатор транзакции GUID**. Выберите текстовое поле, чтобы открыть меню динамического содержимого. На вкладке **переменные** выберите имя созданной переменной. Например, `IDOCtransferID`.

1. В строке заголовка действия **Отправить iDoc** выберите **...**  >  **Параметры**. Для **политики повторов** рекомендуется выбрать вариант **по умолчанию** &gt; **Готово**. Однако вместо этого можно настроить настраиваемую политику для конкретных нужд. Для пользовательских политик рекомендуется настроить по крайней мере одну повторную попытку, чтобы устранить временные простои сети.

1. После **отправки iDoc** добавьте действие **подтвердить идентификатор транзакции**.

1. В редакторе для действия **Подтверждение идентификатора транзакции** настройте следующие параметры. Затем сохраните изменения.

    1. В поле **идентификатор транзакции** введите имя переменной еще раз. Например, `IDOCtransferID`.

1. При необходимости проверьте дедупликацию в тестовой среде. Повторите действие **Send iDoc** с тем же **идентификатором GUID идентификатора транзакции** , который использовался на предыдущем шаге. Когда вы отправляете один и тот же IDoc дважды, вы можете проверить, что SAP может определить дублирование вызова Трфк и разрешить два вызова для одного входящего сообщения IDoc.

## <a name="known-issues-and-limitations"></a>Известные проблемы и ограничения

Ниже приведены известные проблемы и ограничения для управляемого соединителя SAP (не ISE):

* Триггер SAP не поддерживает кластеры шлюза данных. В некоторых случаях отработки отказа узел шлюза данных, взаимодействующий с системой SAP, может отличаться от активного узла, что приводит к непредвиденному поведению. Для сценариев отправки поддерживаются кластеры шлюза данных.

* Соединитель SAP в настоящее время не поддерживает строки маршрутизатора SAP. Локальный шлюз данных должен существовать в той же локальной сети, что и система SAP, к которой нужно подключиться.

## <a name="connector-reference"></a>Справочник по соединителям

Дополнительные технические сведения об этом соединителе, такие как триггеры, действия и ограничения, описанные в файле Swagger соединителя, см. на [странице справочника по соединителю](/connectors/sap/). Дополнительная документация по Logic Apps предоставляется для следующих действий.

* [вызов BAPI;](#call-bapi-action)

* [Отправить IDOC](#send-idoc-action)

> [!NOTE]
> Для приложений логики в [среде службы интеграции (ISE)](../logic-apps/connect-virtual-network-vnet-isolated-environment-overview.md)эта версия этого соединителя использует [ограничения сообщений интегрированной](../logic-apps/logic-apps-limits-and-config.md#message-size-limits) среды сценариев.

### <a name="call-bapi-action"></a>Вызов действия BAPI

Действие [Call BAPI ( `CallBapi` )](
https://docs.microsoft.com/connectors/sap/#call-bapi-(preview)) вызывает метод BAPI на сервере SAP. 

При вызове необходимо использовать следующие параметры: 

* **Бизнес-объект** ( `businessObject` ), который является раскрывающимся меню с возможностью поиска.

* **Метод** ( `method` ), который заполняет доступные методы после выбора **бизнес-объекта**. Доступные методы зависят от выбранного **бизнес-объекта**.

* **Входные параметры BAPI** ( `body` ), в которых вызывается XML-документ, содержащий значения входных параметров метода BAPI для вызова, или универсальный код ресурса (URI) большого двоичного объекта хранилища, содержащего параметры BAPI.

Подробные примеры использования действия "вызов BAPI" см. в разделе [XML-образцы запросов BAPI](#xml-samples-for-bapi-requests).

> [!TIP]
> Если вы используете конструктор Logic Apps для изменения запроса BAPI, можно использовать следующие функции поиска: 
> 
> * Выберите объект в конструкторе, чтобы открыть раскрывающееся меню доступных методов.
> * Отфильтруйте типы бизнес-объектов по ключевому слову, используя список с возможностью поиска, предоставленный вызовом BAPI API.

### <a name="send-idoc-action"></a>Отправить действие IDoc

Действие [Send iDoc ( `SendIDoc` )](https://docs.microsoft.com/connectors/sap/#send-idoc-(preview)) отправляет сообщение iDoc на сервер SAP.

При вызове необходимо использовать следующие параметры: 

* **Тип IDOC с необязательным расширением** ( `idocType` ), который является раскрывающимся меню с возможностью поиска.

    * Необязательный параметр **версия выпуска SAP** ( `releaseVersion` ) заполняет значения после выбора типа iDoc и зависит от выбранного типа iDoc.

* **Введите сообщение iDoc** ( `body` ), в котором вызывается XML-документ, содержащий полезные данные iDoc, или URI большого двоичного объекта хранилища, содержащего XML-документ IDOC. Этот документ должен соответствовать XML-схеме SAP IDOC в соответствии с документацией WE60 IDoc или созданной схемой для соответствующего URI действия SAP IDoc.

Подробные примеры использования действия Send IDoc см. в разделе [Пошаговое руководство по отправке сообщений iDoc на сервер SAP](#send-idoc-messages-to-sap-server).

Сведения о том, как использовать необязательный параметр **Confirm TID** ( `confirmTid` ), см. в [пошаговом руководстве по явному подтверждению транзакции](#confirm-transaction-explicitly).

## <a name="next-steps"></a>Дальнейшие действия

* [Подключитесь к локальным системам](../logic-apps/logic-apps-gateway-connection.md) с Azure Logic Apps.

* Узнайте, как проверять, преобразовывать и использовать другие операции с сообщениями с [пакет интеграции Enterprise](../logic-apps/logic-apps-enterprise-integration-overview.md).

* Дополнительные сведения о других [соединителях Logic Apps](../connectors/apis-list.md).
