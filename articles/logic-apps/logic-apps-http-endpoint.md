---
title: Вызов, активация и вложение приложений логики с помощью триггеров запросов
description: Настройка конечных точек HTTPS для вызова, активации или вложения рабочих процессов приложения логики в Azure Logic Apps
services: logic-apps
ms.workload: integration
ms.reviewer: jonfan, logicappspm
ms.topic: article
ms.date: 11/19/2020
ms.openlocfilehash: b345168dad63b1846d46c12721587eaffb5f887e
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "94981210"
---
# <a name="call-trigger-or-nest-logic-apps-by-using-https-endpoints-in-azure-logic-apps"></a>Вызов, активация или вложение приложений логики с помощью конечных точек HTTPS в Azure Logic Apps

Чтобы приложение логики вызываемое через URL-адрес и могло получать входящие запросы от других служб, можно предоставить синхронную конечную точку HTTPS с помощью триггера на основе запроса в приложении логики. С помощью этой возможности вы можете вызвать приложение логики из других приложений логики и создать шаблон вызываемых конечных точек. Чтобы настроить вызываемую конечную точку для обработки входящих вызовов, можно использовать любой из следующих типов триггеров:

* [Запрос](../connectors/connectors-native-reqres.md)
* [HTTP Webhook](../connectors/connectors-native-webhook.md)
* Триггеры управляемых соединителей, которые имеют [тип ApiConnectionWebhook](../logic-apps/logic-apps-workflow-actions-triggers.md#apiconnectionwebhook-trigger) и могут принимать входящие HTTPS запросы

В этой статье показано, как создать вызываемую конечную точку в приложении логики с помощью триггера запроса и вызвать эту конечную точку из другого приложения логики. Все принципы применяются одинаково к другим типам триггеров, которые можно использовать для получения входящих запросов.


Дополнительные сведения о безопасности авторизация и шифрование входящих вызовов приложения логики, таких как протокол [TLS](https://en.wikipedia.org/wiki/Transport_Layer_Security), ранее известные как SSL (SSL), [Azure Active Directory открытая проверка подлинности (Azure AD OAuth)](../active-directory/develop/index.yml), предоставление приложению логики управления API Azure или ограничению IP-адресов, которые являются входящими вызовами, см. в разделе [безопасный доступ и доступ к данным для входящих вызовов триггеров на основе запросов](../logic-apps/logic-apps-securing-a-logic-app.md#secure-inbound-requests).

## <a name="prerequisites"></a>Предварительные требования

* Учетная запись и подписка Azure. Если у вас нет ее, вы можете [зарегистрироваться для получения бесплатной учетной записи Azure](https://azure.microsoft.com/free/).

* Приложение логики, в котором вы хотите использовать триггер для создания вызываемой конечной точки. Можно начать с пустого приложения логики или существующего приложения логики, в котором можно заменить текущий триггер. Этот пример начинается с пустого приложения логики. Если вы не знакомы с приложениями логики, см. статью [что такое Azure Logic Apps](../logic-apps/logic-apps-overview.md) и [Краткое руководство. Создание первого приложения логики](../logic-apps/quickstart-create-first-logic-app-workflow.md).

## <a name="create-a-callable-endpoint"></a>Создание вызываемой конечной точки

1. Войдите на [портал Azure](https://portal.azure.com). Создайте и откройте пустое приложение логики в конструкторе приложений логики.

1. В поле поиска выберите **встроенный**. В поле поиска введите `request` в качестве фильтра. В списке триггеры выберите **время получения HTTP-запроса**.

   ![Поиск и выбор триггера запроса](./media/logic-apps-http-endpoint/find-and-select-request-trigger.png)

1. При необходимости в поле **схема JSON текста запроса** можно ввести схему JSON, описывающую полезную нагрузку или данные, которые должны быть получены триггером.

   Конструктор использует эту схему для создания токенов, представляющих выходные данные триггера. Затем вы можете легко ссылаться на эти выходные данные по всему рабочему процессу приложения логики. Дополнительные сведения о [маркерах, созданных из схем JSON](#generated-tokens).

   В этом примере введите следующую схему:

   ```json
      {
      "type": "object",
      "properties": {
         "address": {
            "type": "object",
            "properties": {
               "streetNumber": {
                  "type": "string"
               },
               "streetName": {
                  "type": "string"
               },
               "town": {
                  "type": "string"
               },
               "postalCode": {
                  "type": "string"
               }
            }
         }
      }
   }
    ```

   ![Укажите схему JSON для действия запроса](./media/logic-apps-http-endpoint/manual-request-trigger-schema.png)

   Можно также создать схему JSON, предоставив пример полезных данных:

   1. В триггере **запроса** выберите **использовать образец полезных данных для создания схемы**.

   1. В поле **введите или вставьте образец полезных данных JSON** введите образец полезных данных, например:

      ```json
      {
         "address": {
            "streetNumber": "00000",
            "streetName": "AnyStreet",
            "town": "AnyTown",
            "postalCode": "11111-1111"
        }
      }
      ```

   1. Когда будете готовы, нажмите кнопку **Готово**.

      Теперь в поле **схема JSON текста запроса** отображается созданная схема.

1. Сохраните приложение логики

   В поле **URL-адрес HTTP POST** теперь отображается созданный URL-адрес обратного вызова, который другие службы могут использовать для вызова и активации приложения логики. Этот URL-адрес включает параметры запроса, указывающие ключ подписанного URL-адреса (SAS), который используется для проверки подлинности.

   ![Созданный URL-адрес обратного вызова для конечной точки](./media/logic-apps-http-endpoint/generated-endpoint-url.png)

1. Чтобы скопировать URL-адрес обратного вызова, необходимо выполнить следующие действия:

   * Справа от поля **URL-адрес HTTP POST** выберите **Копировать URL-адрес** (значок копирования файлов).

   * Сделайте этот вызов с помощью метода, ожидающего триггер запроса. В этом примере используется `POST` метод:

     `POST https://management.azure.com/{logic-app-resource-ID}/triggers/{endpoint-trigger-name}/listCallbackURL?api-version=2016-06-01`

   * Скопируйте URL-адрес обратного вызова из области **обзора** приложения логики.

     1. В меню приложения логики выберите **Обзор**.

     1. В разделе **Сводка** выберите **Просмотреть журнал триггеров**.

        ![Получение URL-адреса конечной точки из портал Azure](./media/logic-apps-http-endpoint/find-manual-trigger-url.png)

     1. В разделе **URL-адрес обратного вызова [Post]** скопируйте URL-адрес:

        ![Копировать URL-адрес конечной точки из портал Azure](./media/logic-apps-http-endpoint/copy-manual-trigger-callback-url-post.png)

<a name="select-method"></a>

## <a name="select-expected-request-method"></a>Выбор ожидаемого метода запроса

По умолчанию триггер запроса принимает `POST` запрос. Однако можно указать другой метод, который должен использовать вызывающий объект, но только один метод.

1. В триггере запроса откройте список **Добавить новый параметр** и выберите **метод**, который добавляет это свойство в триггер.

   ![Добавление свойства "Method" в триггер](./media/logic-apps-http-endpoint/select-add-new-parameter-for-method.png)

1. В списке **метод** выберите метод, который должен быть предполагаем для триггера. Или можно указать пользовательский метод.

   Например, выберите метод **Get** , чтобы можно было протестировать URL-адрес конечной точки позже.

   ![Выбор метода запроса, ожидаемого триггером](./media/logic-apps-http-endpoint/select-method-request-trigger.png)

<a name="endpoint-url-parameters"></a>

## <a name="pass-parameters-through-endpoint-url"></a>Передача параметров через URL-адрес конечной точки

Если вы хотите принимать значения параметров через URL-адрес конечной точки, у вас есть следующие варианты:

* [Принимать значения с помощью параметров Get](#get-parameters) или URL.

  Эти значения передаются в виде пар "имя-значение" в URL-адресе конечной точки. Для этого параметра необходимо использовать метод GET в триггере запроса. В последующем действии значения параметров можно получить в виде выходных данных триггера с помощью `triggerOutputs()` функции в выражении.

* [Принимать значения с помощью относительного пути](#relative-path) для параметров в триггере запроса.

  Эти значения передаются через относительный путь в URL-адресе конечной точки. Также необходимо явно [выбрать метод](#select-method) , который требуется триггеру. В последующем действии можно получить значения параметров в качестве выходных данных триггера, обратившись к этим выходам напрямую.

<a name="get-parameters"></a>

### <a name="accept-values-through-get-parameters"></a>Принимать значения с помощью получения параметров

1. В триггере запроса откройте **список добавить новый параметр**, добавьте свойство **method** в триггер и выберите метод **Get** .

   Дополнительные сведения см. в разделе [Выбор ожидаемого метода запроса](#select-method).

1. В триггере запроса добавьте действие, в котором необходимо использовать значение параметра. Для этого примера добавьте действие **ответ** .

   1. В разделе триггер запроса выберите **новый шаг**  >  **Добавить действие**.
   
   1. В разделе **Выберите действие** введите фильтр `response` в поле поиска. В списке действия выберите действие **ответ** .

1. Чтобы создать `triggerOutputs()` выражение, получающее значение параметра, выполните следующие действия.

   1. Щелкните внутри свойства **текст** действия ответа, чтобы появился список динамического содержимого, и выберите **выражение**.

   1. В поле **выражение** введите это выражение, замените на `parameter-name` имя параметра, а затем нажмите кнопку **ОК**.

      `triggerOutputs()['queries']['parameter-name']`

      ![Добавьте выражение "triggerOutputs ()" в триггер](./media/logic-apps-http-endpoint/trigger-outputs-expression.png)

      В свойстве **Body** выражение разрешается в `triggerOutputs()` маркер.

      ![Разрешенное выражение "triggerOutputs ()"](./media/logic-apps-http-endpoint/trigger-outputs-expression-token.png)

      Если вы сохраните приложение логики, отйдете от конструктора и вернетесь к конструктору, маркер отобразит указанное имя параметра, например:

      ![Разрешенное выражение для имени параметра](./media/logic-apps-http-endpoint/resolved-expression-parameter-token.png)

      В представлении кода свойство **Body** отображается в определении действия ответа следующим образом:

      `"body": "@{triggerOutputs()['queries']['parameter-name']}",`

      Например, предположим, что необходимо передать значение для параметра с именем `postalCode` . Свойство **Body** задает строку `Postal Code: ` с конечным пробелом и соответствующим выражением:

      ![Добавьте пример выражения "triggerOutputs ()" в триггер](./media/logic-apps-http-endpoint/trigger-outputs-expression-postal-code.png)

1. Чтобы протестировать вызываемую конечную точку, скопируйте URL-адрес обратного вызова из триггера запроса и вставьте URL-адрес в другое окно браузера. В URL-адресе добавьте имя параметра и значение после вопросительного знака ( `?` ) в URL-адрес в следующем формате и нажмите клавишу ВВОД.

   `...?{parameter-name=parameter-value}&api-version=2016-10-01...`

   `https://prod-07.westus.logic.azure.com:433/workflows/{logic-app-resource-ID}/triggers/manual/paths/invoke?{parameter-name=parameter-value}&api-version=2016-10-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig={shared-access-signature}`

   Браузер возвращает ответ с этим текстом: `Postal Code: 123456`

   ![Ответ от отправки запроса на URL-адрес обратного вызова](./media/logic-apps-http-endpoint/callback-url-returned-response.png)

1. Чтобы поместить имя и значение параметра в другую точку URL-адреса, убедитесь, что в `&` качестве префикса используется амперсанд (), например:

   `...?api-version=2016-10-01&{parameter-name=parameter-value}&...`

   В этом примере показан URL-адрес обратного вызова с примером имени параметра и значения `postalCode=123456` в разных позициях в URL-адресе:

   * Первое расположение: `https://prod-07.westus.logic.azure.com:433/workflows/{logic-app-resource-ID}/triggers/manual/paths/invoke?postalCode=123456&api-version=2016-10-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig={shared-access-signature}`

   * Второе расположение: `https://prod-07.westus.logic.azure.com:433/workflows/{logic-app-resource-ID}/triggers/manual/paths/invoke?api-version=2016-10-01&postalCode=123456&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig={shared-access-signature}`

> [!NOTE]
> Если вы хотите включить в URI символ hash или решетки ( **#** ), используйте вместо этого закодированную версию: `%25%23`

<a name="relative-path"></a>

### <a name="accept-values-through-a-relative-path"></a>Принимать значения по относительному пути

1. В триггере запроса откройте список **Добавить новый параметр** и выберите **относительный путь**, который добавляет это свойство в триггер.

   ![Добавление свойства "Relative Path" в триггер](./media/logic-apps-http-endpoint/select-add-new-parameter-for-relative-path.png)

1. В свойстве **относительного пути** укажите относительный путь для параметра в схеме JSON, который должен принимать URL-адрес, например `/address/{postalCode}` .

   ![Укажите относительный путь для параметра](./media/logic-apps-http-endpoint/relative-path-url-value.png)

1. В триггере запроса добавьте действие, в котором необходимо использовать значение параметра. Для этого примера добавьте действие **ответ** .

   1. В разделе триггер запроса выберите **новый шаг**  >  **Добавить действие**.

   1. В разделе **Выберите действие** введите фильтр `response` в поле поиска. В списке действия выберите действие **ответ** .

1. В свойстве **Body** действия ответа добавьте маркер, представляющий параметр, указанный в относительных пути триггера.

   Например, предположим, что необходимо вернуть ответное действие `Postal Code: {postalCode}` .

   1. В свойстве **Body** введите `Postal Code: ` конечную пробел. Сохраните курсор внутри поля ввода, чтобы список динамического содержимого оставался открытым.

   1. В списке динамическое содержимое в разделе **при получении HTTP-запроса** выберите токен **PostalCode** .

      ![Добавление указанного параметра в текст ответа](./media/logic-apps-http-endpoint/relative-url-with-parameter-token.png)

      Свойство **Body** теперь включает выбранный параметр:

      ![Пример текста ответа с параметром](./media/logic-apps-http-endpoint/relative-url-with-parameter.png)

1. Сохраните приложение логики

   В триггере запроса URL-адрес обратного вызова обновляется и теперь включает относительный путь, например:

   `https://prod-07.westus.logic.azure.com/workflows/{logic-app-resource-ID}/triggers/manual/paths/invoke/address/{postalCode}?api-version=2016-10-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig={shared-access-signature}`

1. Чтобы протестировать вызываемую конечную точку, скопируйте обновленный URL-адрес обратного вызова из триггера запроса, вставьте URL-адрес в другое окно браузера, замените `{postalCode}` в URL-адресе на `123456` и нажмите клавишу ВВОД.

   Браузер возвращает ответ с этим текстом: `Postal Code: 123456`

   ![Ответ от отправки запроса на URL-адрес обратного вызова](./media/logic-apps-http-endpoint/callback-url-returned-response.png)

> [!NOTE]
> Если вы хотите включить в URI символ hash или решетки ( **#** ), используйте вместо этого закодированную версию: `%25%23`

## <a name="call-logic-app-through-endpoint-url"></a>Вызов приложения логики с помощью URL-адреса конечной точки

После создания конечной точки можно запустить приложение логики, отправив запрос HTTPS на полный URL-адрес конечной точки. Приложения логики имеют встроенную поддержку конечных точек прямого доступа.

<a name="generated-tokens"></a>

## <a name="tokens-generated-from-schema"></a>Токены, созданные из схемы

При предоставлении схемы JSON в триггере запроса конструктор приложений логики создает маркеры для свойств в этой схеме. Затем эти токены можно использовать для передачи данных через рабочий процесс приложения логики.

Например, если добавить в схему JSON дополнительные свойства, такие как `"suite"` , то маркеры для этих свойств будут доступны для использования в последующих шагах для приложения логики. Ниже приведена полная схема JSON.

```json
   {
   "type": "object",
   "properties": {
      "address": {
         "type": "object",
         "properties": {
            "streetNumber": {
               "type": "string"
            },
            "streetName": {
               "type": "string"
            },
            "suite": {
               "type": "string"
            },
            "town": {
               "type": "string"
            },
            "postalCode": {
               "type": "string"
            }
         }
      }
   }
}
```

## <a name="create-nested-logic-apps"></a>Создание вложенных приложений логики

Вы можете вкладывать рабочие процессы в приложение логики, добавляя другие приложения логики, которые могут получать запросы. Чтобы включить эти приложения логики, выполните следующие действия.

1. На шаге, где вы хотите вызвать другое приложение логики, выберите **новый шаг**  >  **Добавить действие**.

1. В разделе **Выберите действие** выберите **Встроенный**. В поле поиска введите `logic apps` в качестве фильтра. В списке действия выберите **пункт выбрать Logic Apps рабочий процесс**.

   ![Вложение приложения логики в текущее приложение логики](./media/logic-apps-http-endpoint/choose-logic-apps-workflow.png)

   В конструкторе отображаются доступные приложения логики для выбора.

1. Выберите приложение логики для вызова из текущего приложения логики.

   ![Выбор приложения логики для вызова из текущего приложения логики](./media/logic-apps-http-endpoint/select-logic-app-to-nest.png)

## <a name="reference-content-from-an-incoming-request"></a>Ссылка на содержимое входящего запроса

Если тип содержимого входящего запроса — `application/json` , можно ссылаться на свойства во входящем запросе. В противном случае это содержимое рассматривается как одна двоичная единица, которую можно передать другим API. Чтобы сослаться на это содержимое в рабочем процессе приложения логики, необходимо сначала преобразовать это содержимое.

Например, при передаче содержимого, имеющего `application/xml` тип, можно использовать [ `@xpath()` выражение](../logic-apps/workflow-definition-language-functions-reference.md#xpath) для выполнения извлечения XPath или использовать [ `@json()` выражение](../logic-apps/workflow-definition-language-functions-reference.md#json) для преобразования XML в JSON. Дополнительные сведения о работе с поддерживаемыми [типами содержимого](../logic-apps/logic-apps-content-type.md).

Чтобы получить выходные данные входящего запроса, можно использовать [ `@triggerOutputs` выражение](../logic-apps/workflow-definition-language-functions-reference.md#triggerOutputs). Например, предположим, что у вас есть выходные данные, которые выглядят, как в следующем примере:

```json
{
   "headers": {
      "content-type" : "application/json"
   },
   "body": {
      "myProperty" : "property value"
   }
}
```

Для доступа к конкретному `body` свойству можно использовать [ `@triggerBody()` выражение](../logic-apps/workflow-definition-language-functions-reference.md#triggerBody) в качестве ярлыка.

## <a name="respond-to-requests"></a>Ответ на запросы

Иногда требуется ответить на определенные запросы, которые активируют приложение логики, возвращая содержимое вызывающему объекту. Чтобы создать код состояния, заголовок и текст для ответа, используйте действие ответ. Это действие может находиться в любом месте приложения логики, а не только в конце рабочего процесса. Если приложение логики не включает в себя действие ответа, конечная точка *немедленно* реагирует на **202** с состоянием "принято".

Чтобы исходный вызывающий объект успешно получил ответ, все необходимые действия для ответа должны завершиться в пределах [предела времени ожидания запроса](./logic-apps-limits-and-config.md) , если только Активируемое приложение логики не вызвано как вложенное приложение логики. Если в рамках этого ограничения ответ не возвращается, истекает время ожидания входящего запроса и получает ответ **времени ожидания клиента 408** .

Для вложенных приложений логики родительское приложение логики по-своему будет ждать ответа до тех пор, пока не будут выполнены все необходимые действия, независимо от того, сколько времени требуется.

### <a name="construct-the-response"></a>Создание ответа

В тексте ответа можно включить несколько заголовков и любого типа содержимого. Например, заголовок ответа указывает, что тип содержимого ответа — `application/json` и что текст содержит значения для `town` `postalCode` свойств и, основанные на схеме JSON, описанной ранее в этом разделе для триггера запроса.

![Укажите содержимое ответа для действия ответа HTTPS](./media/logic-apps-http-endpoint/content-for-response-action.png)

У ответов есть следующие свойства:

| Свойство (отображение) | Свойство (JSON) | Описание |
|--------------------|-----------------|-------------|
| **Код состояния** | `statusCode` | Код состояния HTTPS, используемый в ответе для входящего запроса. Это может быть любой допустимый код состояния, который начинается с 2xx, 4xx или 5xx. Но коды состояния 3xx не допускаются. |
| **Заголовки** | `headers` | Один или несколько заголовков для включения в ответ |
| **Текст** | `body` | Объект Body, который может быть строкой, объектом JSON или даже двоичным содержимым, на которое ссылается предыдущий шаг. |
||||

Чтобы просмотреть определение JSON для действия ответ и полное определение JSON приложения логики, на панели инструментов конструктора приложений логики выберите **представление кода**.

``` json
"Response": {
   "type": "Response",
   "kind": "http",
   "inputs": {
      "body": {
         "postalCode": "@triggerBody()?['address']?['postalCode']",
         "town": "@triggerBody()?['address']?['town']"
      },
      "headers": {
         "content-type": "application/json"
      },
      "statusCode": 200
   },
   "runAfter": {}
}
```

## <a name="q--a"></a>Вопросы и ответы

#### <a name="q-what-about-url-security"></a>Вопрос. Как обеспечивается безопасность URL-адресов?

Ответ **. Azure** безопасно создает URL-адреса обратного вызова приложения логики с помощью [подписанного общего доступа (SAS)](/rest/api/storageservices/delegate-access-with-shared-access-signature). Эта подпись передается в качестве параметра запроса и должна быть проверена перед запуском приложения логики. Azure создает эту подпись на основе уникального сочетания секретного ключа для каждого приложения логики, имени триггера и выполняемой операции. Не имея доступа к секретному ключу приложения логики, создать действительную подпись невозможно.

> [!IMPORTANT]
> Для производственных и более высоких систем безопасности мы настоятельно рекомендуем вызывать приложение логики непосредственно из браузера по следующим причинам:
>
> * ключ общего доступа отображается в URL-адресе;
> * Вы не можете управлять политиками содержимого безопасности из-за общих доменов для Azure Logic Apps клиентов.

Дополнительные сведения о безопасности авторизация и шифрование входящих вызовов приложения логики, таких как протокол [TLS](https://en.wikipedia.org/wiki/Transport_Layer_Security), ранее известные как SSL (SSL), [Azure Active Directory открытая проверка подлинности (Azure AD OAuth)](../active-directory/develop/index.yml), предоставление приложению логики управления API Azure или ограничению IP-адресов, которые являются входящими вызовами, см. в разделе [безопасный доступ и доступ к данным для входящих вызовов триггеров на основе запросов](../logic-apps/logic-apps-securing-a-logic-app.md#secure-inbound-requests).

#### <a name="q-can-i-configure-callable-endpoints-further"></a>Вопрос. можно ли настроить вызываемые конечные точки дальше?

Ответ **. Да**, конечные точки HTTPS поддерживают более расширенную конфигурацию с помощью службы [управления API Azure](../api-management/api-management-key-concepts.md). Эта служба также предлагает вам возможность согласованно управлять всеми своими API, включая приложения логики, настраивать имена домена, использовать дополнительные методы проверки подлинности и т. д. В частности она предоставляет следующие возможности:

* [Изменение метода запроса](../api-management/api-management-advanced-policies.md#SetRequestMethod)
* [Изменение сегментов URL-адреса запроса](../api-management/api-management-transformation-policies.md#RewriteURL)
* Настройка доменов управления API в [портал Azure](https://portal.azure.com/)
* настройка политики для проверки базовой проверки подлинности.

## <a name="next-steps"></a>Дальнейшие действия

* [Получение и реагирование на входящие вызовы HTTPS с помощью Azure Logic Apps](../connectors/connectors-native-reqres.md)
* [Безопасный доступ и данные в Azure Logic Apps — доступ для входящих вызовов триггеров на основе запросов](../logic-apps/logic-apps-securing-a-logic-app.md#secure-inbound-requests)
