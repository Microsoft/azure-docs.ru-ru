---
title: Добавление и выполнение фрагментов кода с помощью встроенного кода
description: Узнайте, как создавать и выполнять фрагменты кода с помощью встроенных действий кода для автоматизированных задач и рабочих процессов, создаваемых с помощью Azure Logic Apps
services: logic-apps
ms.suite: integration
ms.reviewer: deli, logicappspm
ms.topic: article
ms.date: 12/07/2020
ms.custom: devx-track-js
ms.openlocfilehash: 3f88fa38d62778bc3c4c1e29571d1d0ae4eeb5ff
ms.sourcegitcommit: c136985b3733640892fee4d7c557d40665a660af
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/13/2021
ms.locfileid: "98179611"
---
# <a name="add-and-run-code-snippets-by-using-inline-code-in-azure-logic-apps"></a>Добавление и выполнение фрагментов кода с помощью встроенного кода в Azure Logic Apps

Если вы хотите выполнить фрагмент кода внутри приложения логики, можно добавить встроенное действие встроенный код в качестве шага в рабочем процессе приложения логики. Это действие лучше подходит, если требуется выполнить код, соответствующий этому сценарию:

* Выполняется в JavaScript. В ближайшее время ожидается больше языков.

* Завершает выполнение через пять секунд или меньше.

* Обрабатывает данные размером до 50 МБ.

* Не требует работы с [действиями **переменных**](../logic-apps/logic-apps-create-variables-store-values.md), которые еще не поддерживаются.

* Использует Node.js версии 8.11.1. Дополнительные сведения см. в разделе [стандартные встроенные объекты](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects).

  > [!NOTE]
  > Эта `require()` функция не поддерживается действием встроенного кода для выполнения JavaScript.

Это действие выполняет фрагмент кода и возвращает выходные данные из этого фрагмента в виде маркера с именем `Result` . Этот маркер можно использовать с дальнейшими действиями в рабочем процессе приложения логики. В других сценариях, где требуется создать функцию для кода, попробуйте создать [и вызвать функцию с помощью функций Azure, а не](../logic-apps/logic-apps-azure-functions.md) в приложении логики.

В этой статье пример приложения логики активируется при поступлении нового электронного письма в рабочую или учебную учетную запись. Фрагмент кода извлекает и возвращает все адреса электронной почты, которые отображаются в тексте сообщения электронной почты.

![Снимок экрана, на котором показан пример приложения логики](./media/logic-apps-add-run-inline-code/inline-code-example-overview.png)

## <a name="prerequisites"></a>Предварительные требования

* Подписка Azure. Если у вас еще нет подписки Azure, [зарегистрируйтесь для получения бесплатной учетной записи Azure](https://azure.microsoft.com/free/).

* Приложение логики, в которое нужно добавить фрагмент кода, включая триггер. Если у вас нет приложения логики, см. статью [Краткое руководство. Создание первого автоматизированного рабочего процесса с помощью Azure Logic Apps на портале Azure](../logic-apps/quickstart-create-first-logic-app-workflow.md).

   В примере в этом разделе используется триггер Outlook Office 365, названный **при поступлении нового электронного письма**.

* [Учетная запись интеграции](../logic-apps/logic-apps-enterprise-integration-create-integration-account.md) , связанная с приложением логики.

  * Убедитесь, что вы используете учетную запись интеграции, соответствующую Вашему варианту использования или сценарию.

    Например, учетные записи [бесплатных уровней](../logic-apps/logic-apps-pricing.md#integration-accounts) предназначены только для произвольных сценариев и рабочих нагрузок, а не для рабочих. они ограничены в использовании и пропускной способности и не поддерживаются соглашением об уровне обслуживания (SLA). Другие уровни приводят к затратам, но включают поддержку соглашения об уровне обслуживания, обеспечивают дополнительную пропускную способность и имеют более высокие ограничения. Дополнительные сведения об [уровнях](../logic-apps/logic-apps-pricing.md#integration-accounts)учетных записей интеграции, [ценах](https://azure.microsoft.com/pricing/details/logic-apps/)и [ограничениях](../logic-apps/logic-apps-limits-and-config.md#integration-account-limits).

   * Если вы не хотите использовать учетную запись интеграции, можно попробовать использовать [Azure Logic Apps предварительный просмотр](logic-apps-overview-preview.md)и создать приложение логики из типа ресурсов **приложения логики (Предварительная версия)** .

     Встроенный **код** в Azure Logic Apps предварительной версии теперь называется **операциями встроенного кода** , а также следующими отличиями.

     * **Выполнение кода JavaScript** теперь называется **Run in-line JavaScript**.

     * При использовании macOS или Linux действия встроенного кода в настоящее время недоступны при использовании расширения Azure Logic Apps (Предварительная версия) в Visual Studio Code.

     * Действия встроенного кода имеют [обновленные пределы](logic-apps-overview-preview.md#inline-code-limits).

     Для начала можно выбрать один из вариантов:

     * Создайте приложение логики из типа ресурсов **приложения логики (Предварительная версия)** с [помощью портал Azure](create-stateful-stateless-workflows-azure-portal.md).

     * Создание проекта для приложения логики с [помощью Visual Studio Code и расширения Azure Logic Apps (Предварительная версия)](create-stateful-stateless-workflows-visual-studio-code.md)

## <a name="add-inline-code"></a>Добавить встроенный код

1. Если вы еще этого не сделали, в [портал Azure](https://portal.azure.com)откройте приложение логики в конструкторе приложений логики.

1. В конструкторе выберите место для добавления действия встроенного кода в рабочий процесс приложения логики.

   * Чтобы добавить действие в конце рабочего процесса, выберите **новый шаг**.

   * Чтобы добавить действие между шагами, наведите указатель мыши на стрелку, соединяющую эти шаги. Выберите отображаемый знак плюса ( **+** ) и щелкните **Добавить действие**.

   В этом примере добавляется действие встроенного кода с триггером Office 365 Outlook.

   ![Добавьте новый шаг в триггер.](./media/logic-apps-add-run-inline-code/add-new-step.png)

1. В разделе **Выберите действие**, введите в поле поиска `inline code`. В списке действия выберите действие с именем **выполнить код JavaScript**.

   ![Выберите действие "выполнить код JavaScript"](./media/logic-apps-add-run-inline-code/select-inline-code-action.png)

   Действие отображается в конструкторе и по умолчанию содержит несколько примеров кода, включая `return` инструкцию.

   ![Действие встроенного кода с примером кода по умолчанию](./media/logic-apps-add-run-inline-code/inline-code-action-default.png)

1. В поле **код** удалите пример кода и введите свой код. Напишите код, который вы поместили в метод, но без сигнатуры метода.

   Если вы начинаете вводить распознанное ключевое слово, появится список автозаполнения, в котором можно выбрать один из доступных ключевых слов, например:

   ![Список автозаполнения ключевых слов](./media/logic-apps-add-run-inline-code/auto-complete.png)

   В этом примере фрагмент кода сначала создается переменная, в которой хранится *регулярное выражение*, которое указывает шаблон для сопоставления во входном тексте. Затем код создает переменную, в которой хранятся данные текста электронной почты из триггера.

   ![Создание переменных](./media/logic-apps-add-run-inline-code/save-email-body-variable.png)

   Чтобы упростить ссылку на результаты триггера и предыдущих действий, список динамического содержимого отображается, когда курсор находится внутри поля **кода** . В этом примере список отображает доступные результаты триггера, включая маркер **текста** , который теперь можно выбрать.

   После выбора маркера **текста** действие встроенного кода разрешает токен в `workflowContext` объект, который ссылается на `Body` значение свойства электронной почты:

   ![Выбор результата](./media/logic-apps-add-run-inline-code/inline-code-example-select-outputs.png)

   В поле **кода** фрагмент может использовать в `workflowContext` качестве входных данных объект, предназначенный только для чтения. Этот объект включает свойства, которые предоставляют коду доступ к результатам триггера и предыдущих действий в рабочем процессе. Дополнительные сведения см. в разделе [эталонный триггер и результаты действия в коде](#workflowcontext) далее в этой статье.

   > [!NOTE]
   > Если фрагмент кода ссылается на имена действий, которые используют оператор dot (.), необходимо добавить эти имена действий в [параметр **Actions**](#add-parameters). Эти ссылки также должны заключать имена действий в квадратные скобки ([]) и кавычки, например:
   >
   > `// Correct`</br> 
   > `workflowContext.actions["my.action.name"].body`</br>
   >
   > `// Incorrect`</br>
   > `workflowContext.actions.my.action.name.body`

   Для действия встроенного кода не требуется `return` оператор, но результаты `return` инструкции доступны для справки в последующих действиях через токен **результата** . Например, фрагмент кода возвращает результат, вызывая `match()` функцию, которая находит совпадения в тексте сообщения электронной почты с регулярным выражением. Действие **создания** использует маркер **результата** для ссылки на результаты из действия встроенного кода и создает один результат.

   ![Готовое приложение логики](./media/logic-apps-add-run-inline-code/inline-code-complete-example.png)

1. Сохраните приложение логики, когда закончите.

<a name="workflowcontext"></a>

### <a name="reference-trigger-and-action-results-in-your-code"></a>Вызов триггера и результатов действия в коде

`workflowContext`Объект содержит эту структуру, включающую `actions` `trigger` `workflow` подсвойства, и.

```json
{
   "workflowContext": {
      "actions": {
         "<action-name-1>": @actions('<action-name-1>'),
         "<action-name-2>": @actions('<action-name-2>')
      },
      "trigger": {
         @trigger()
      },
      "workflow": {
         @workflow()
      }
   }
}
```

Эта таблица содержит дополнительные сведения об этих вложенных свойствах.

| Свойство. | Тип | Описание |
|----------|------|-------|
| `actions` | Коллекция объектов | Результирующие объекты из действий, выполняемых перед выполнением фрагмента кода. Каждый объект имеет пару " *ключ-значение* ", где ключ — это имя действия, а значение эквивалентно вызову [функции Actions ()](../logic-apps/workflow-definition-language-functions-reference.md#actions) с параметром `@actions('<action-name>')` . Имя действия использует то же имя действия, которое используется в базовом определении рабочего процесса, которое заменяет пробелы ("") в имени действия символом подчеркивания (_). Этот объект предоставляет доступ к значениям свойств действия из текущего запуска экземпляра рабочего процесса. |
| `trigger` | Объект | Результирующий объект из триггера и эквивалент для вызова [функции Trigger ()](../logic-apps/workflow-definition-language-functions-reference.md#trigger). Этот объект предоставляет доступ к значениям свойств триггера из текущего запуска экземпляра рабочего процесса. |
| `workflow` | Объект | Объект рабочего процесса и эквивалент вызова [функции Workflow ()](../logic-apps/workflow-definition-language-functions-reference.md#workflow). Этот объект предоставляет доступ к значениям свойств рабочего процесса, таким как имя рабочего процесса, идентификатор запуска и т. д., из текущего запуска экземпляра рабочего процесса. |
|||

В примере этого раздела `workflowContext` объект имеет следующие свойства, к которым имеет доступ ваш код:

```json
{
   "workflowContext": {
      "trigger": {
         "name": "When_a_new_email_arrives",
         "inputs": {
            "host": {
               "connection": {
                  "name": "/subscriptions/<Azure-subscription-ID>/resourceGroups/<Azure-resource-group-name>/providers/Microsoft.Web/connections/office365"
               }
            },
            "method": "get",
            "path": "/Mail/OnNewEmail",
            "queries": {
               "includeAttachments": "False"
            }
         },
         "outputs": {
            "headers": {
               "Pragma": "no-cache",
               "Content-Type": "application/json; charset=utf-8",
               "Expires": "-1",
               "Content-Length": "962095"
            },
            "body": {
               "Id": "AAMkADY0NGZhNjdhLTRmZTQtNGFhOC1iYjFlLTk0MjZlZjczMWRhNgBGAAAAAABmZwxUQtCGTqSPpjjMQeD",
               "DateTimeReceived": "2019-03-28T19:42:16+00:00",
               "HasAttachment": false,
               "Subject": "Hello World",
               "BodyPreview": "Hello World",
               "Importance": 1,
               "ConversationId": "AAQkADY0NGZhNjdhLTRmZTQtNGFhOC1iYjFlLTk0MjZlZjczMWRhNgAQ",
               "IsRead": false,
               "IsHtml": true,
               "Body": "Hello World",
               "From": "<sender>@<domain>.com",
               "To": "<recipient-2>@<domain>.com;<recipient-2>@<domain>.com",
               "Cc": null,
               "Bcc": null,
               "Attachments": []
            }
         },
         "startTime": "2019-05-03T14:30:45.971564Z",
         "endTime": "2019-05-03T14:30:50.1746874Z",
         "scheduledTime": "2019-05-03T14:30:45.8778117Z",
         "trackingId": "1cd5ffbd-f989-4df5-a96a-6e9ce31d03c5",
         "clientTrackingId": "08586447130394969981639729333CU06",
         "originHistoryName": "08586447130394969981639729333CU06",
         "code": "OK",
         "status": "Succeeded"
      },
      "workflow": {
         "id": "/subscriptions/<Azure-subscription-ID>/resourceGroups/<Azure-resource-group-name>/providers/Microsoft.Logic/workflows/<logic-app-workflow-name>",
         "name": "<logic-app-workflow-name>",
         "type": "Microsoft.Logic/workflows",
         "location": "<Azure-region>",
         "run": {
            "id": "/subscriptions/<Azure-subscription-ID>/resourceGroups/<Azure-resource-group-name>/providers/Microsoft.Logic/workflows/<logic-app-workflow-name>/runs/08586453954668694173655267965CU00",
            "name": "08586453954668694173655267965CU00",
            "type": "Microsoft.Logic/workflows/runs"
         }
      }
   }
}
```

<a name="add-parameters"></a>

## <a name="add-parameters"></a>Добавление параметров

В некоторых случаях может потребоваться явное потребовать, чтобы действие встроенного кода включало результаты триггера или конкретные действия, которые код ссылается в качестве зависимостей, путем добавления параметров **триггера** или **действий** . Этот параметр полезен в сценариях, где результаты, на которые имеются ссылки, не обнаруживаются во время выполнения.

> [!TIP]
> Если вы планируете повторно использовать код, добавьте ссылки на свойства с помощью поля **кода** , чтобы код включал разрешенные ссылки на маркеры, а не добавлять триггер или действия в качестве явных зависимостей.

Например, предположим, что у вас есть код, который ссылается на результат **SelectedOption** из действия **Отправить сообщение электронной почты** для соединителя Office 365 Outlook. Во время создания Logic Apps подсистема анализирует код, чтобы определить, имеются ли ссылки на какие либо триггеры или действия, и включает эти результаты автоматически. Во время выполнения, если вы получаете сообщение о том, что указанный триггер или результат действия недоступен в указанном `workflowContext` объекте, можно добавить триггер или действие в качестве явной зависимости. В этом примере вы добавляете параметр **Actions** и указываете, что действие встроенного кода явным образом включает результат действия **отправить утверждение по электронной почте** .

Чтобы добавить эти параметры, откройте список **Добавить новый параметр** и выберите нужные параметры.

   ![Добавление параметров](./media/logic-apps-add-run-inline-code/inline-code-action-add-parameters.png)

   | Параметр | Описание |
   |-----------|-------------|
   | **Действия** | Включить результаты из предыдущих действий. См. раздел [Включение результатов действия](#action-results). |
   | **Триггер** | Включить результаты из триггера. См. раздел [Включение результатов триггера](#trigger-results). |
   |||

<a name="trigger-results"></a>

### <a name="include-trigger-results"></a>Включить результаты триггера

Если выбрать **триггеры**, появится запрос на включение результатов триггера.

* В списке **триггер** выберите **Да**.

<a name="action-results"></a>

### <a name="include-action-results"></a>Включить результаты действия

Если выбрать **действия**, появится запрос на ввод действий, которые требуется добавить. Однако перед началом добавления действий требуется версия имени действия, которая отображается в базовом определении рабочего процесса приложения логики.

* Эта возможность не поддерживает переменные, циклы и индексы итерации.

* Имена в определении рабочего процесса приложения логики используют символ подчеркивания (_), а не пробел.

* Для имен действий, использующих оператор-точку (.), включите эти операторы, например:

  `My.Action.Name`

1. На панели инструментов конструктора выберите **представление кода** и найдите в `actions` атрибуте имя действия.

   Например, `Send_approval_email_` — это имя JSON для действия **отправить утверждение по электронной почте** .

   ![Найти имя действия в JSON](./media/logic-apps-add-run-inline-code/find-action-name-json.png)

1. Чтобы вернуться в представление конструктора, на панели инструментов представление кода выберите **конструктор**.

1. Чтобы добавить первое действие, в поле **действия элемент-1** введите имя JSON действия.

   ![Введите первое действие](./media/logic-apps-add-run-inline-code/add-action-parameter.png)

1. Чтобы добавить другое действие, выберите **Добавить новый элемент**.

## <a name="reference"></a>Справочник

Дополнительные сведения о структуре и синтаксисе действия **выполнить код JavaScript** в базовом определении рабочего процесса приложения логики с помощью языка определения рабочего процесса см. в [разделе справки](../logic-apps/logic-apps-workflow-actions-triggers.md#run-javascript-code)этого действия.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о [соединителях для Azure Logic Apps](../connectors/apis-list.md)
