---
title: Группирование и запуск действий по области
description: Создание действий в областях, которые выполняются на основе состояния группы в Azure Logic Apps
services: logic-apps
ms.suite: integration
ms.reviewer: klam, logicappspm
ms.date: 10/03/2018
ms.topic: article
ms.openlocfilehash: 95b5cc191ac6857bf8e1b09e70b22d928473fe03
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "92314842"
---
# <a name="run-actions-based-on-group-status-by-using-scopes-in-azure-logic-apps"></a>Вы можете выполнять действия рабочего процесса на основе состояния группы с помощью областей в Azure Logic Apps.

Чтобы выполнить действия только после успешного или неуспешного выполнения действий другой группы, поместите эту группу в *область*. Эта структура полезна, если необходимо упорядочить действия как логическую группу, оценить состояние этой группы и выполнить действия на основе состояния области. После завершения выполнения всех действий в области она также получает собственное состояние. Например, области можно использовать, если необходимо реализовать [обработку ошибок и исключений](../logic-apps/logic-apps-exception-handling.md#scopes). 

Чтобы проверить состояние области, можно использовать те же критерии, что и для определения состояния выполнения приложения логики, например " **успешно**", " **сбой**", " **отменено**" и т. д. По умолчанию, когда все действия в области выполнены, состояние области помечается как **выполненное**. Но когда любое действие в области завершается ошибкой или отменяется, состояние области отмечается как **сбой**. Сведения об ограничениях в областях см. в статье [Ограничения и настройка Logic Apps](../logic-apps/logic-apps-limits-and-config.md). 

Например, вот приложение логики высокого уровня, которое использует область для выполнения определенных действий и условие для проверки состояния области. Если какие-либо действия в области **прерываются** или завершаются неожиданно, область помечается как **Невыполненная** или прерванная соответственно, а приложение логики отправляет сообщение "сбой области". Если все действия области успешны, приложение логики отправляет сообщение Scope succeeded (Область успешна).

![На схеме показан поток области приложения логики с примерами "сбой области" и "область выполнена".](./media/logic-apps-control-flow-run-steps-group-scopes/scope-high-level.png)

## <a name="prerequisites"></a>Предварительные требования

Чтобы выполнить пример в этой статье, потребуется следующее:

* Подписка Azure. Если у вас нет ее, вы можете [зарегистрироваться для получения бесплатной учетной записи Azure](https://azure.microsoft.com/free/). 

* Учетная запись электронной почты любого поставщика электронной почты, поддерживаемого Logic Apps. В этом примере используется Outlook.com. Если вы используете другой поставщик, то общий поток остается прежним, но отображается другой пользовательский интерфейс.

* Ключ карт Bing. Чтобы получить этот ключ, ознакомьтесь со статьей <a href="/bingmaps/getting-started/bing-maps-dev-center-help/getting-a-bing-maps-key" target="_blank">Getting a Bing Maps Key</a> (Получение ключа Карт Bing).

* Базовые знания [создания приложений логики](../logic-apps/quickstart-create-first-logic-app-workflow.md).

## <a name="create-sample-logic-app"></a>Создание примера приложения логики

Сначала создайте этот пример приложения логики, чтобы позднее можно было добавить область:

![Создание примера приложения логики](./media/logic-apps-control-flow-run-steps-group-scopes/finished-sample-app.png)

* Триггер **Расписание — повторение** проверяет службу Карт Bing с заданной вами частотой.
* Действие **Bing Maps - Get route** (Карты Bing — получить маршрут) проверяет время перемещения между двумя расположениями.
* Условный оператор, который проверяет, превышает ли время перемещения указанное время.
* Действие, которое отправляет вам сообщение электронной почты о том, что текущее время перемещения превышает указанное время.

Приложение логики можно сохранить в любое время, так что часто сохраняйте свою работу.

1. Войдите на <a href="https://portal.azure.com" target="_blank">портал Azure</a>, если вы еще этого не сделали. Создание пустого приложения логики.

1. Добавьте триггер **Расписание — повторение** с такими параметрами: **Интервал** — 1, **Частота** — "Минута".

   ![Настройка триггера"Расписание — повторение"](./media/logic-apps-control-flow-run-steps-group-scopes/recurrence.png)

   > [!TIP]
   > Чтобы визуально упростить представление и скрыть сведения о каждом действии в конструкторе, сворачивайте фигуры каждого действия по мере выполнения этих шагов.

1. Добавьте действие **Bing Maps — Get route** (Карты Bing — получить маршрут). 

   1. Если у вас еще нет подключения к Картам Bing, появится запрос на его установку.

      | Параметр | Значение | Описание |
      | ------- | ----- | ----------- |
      | **Имя соединения** | BingMapsConnection | Укажите имя подключения. | 
      | **Ключ API**. | <*ваш ключ Карт Bing*> | Введите ключ Карт Bing, полученный ранее. | 
      ||||  

   1. Настройте действие **Get route** (Получить маршрут), как показано в таблице под этим изображением:

      ![Настройка действия Bing Maps - Get route (Карты Bing — получить маршрут)](./media/logic-apps-control-flow-run-steps-group-scopes/get-route.png) 

      Дополнительные сведения об этих параметрах см. в статье [Calculate a Route](/bingmaps/rest-services/routes/calculate-a-route) (Расчет маршрута).

      | Параметр | Значение | Описание |
      | ------- | ----- | ----------- |
      | **Пункт маршрута 1** | <*Начало*> | Введите начало маршрута. | 
      | **Пункт маршрута 2** | <*Конец*> | Введите место назначения маршрута. | 
      | **Avoid** (Избегать) | None | Введите то, чего нужно избегать на маршруте, например шоссе, платные дороги и т. д. Возможные значения см. в статье [Calculate a Route](/bingmaps/rest-services/routes/calculate-a-route) (Расчет маршрута). | 
      | **Optimize** (Оптимизация) | timeWithTraffic | Выберите параметр для оптимизации маршрута, например расстояние, время в пути в соответствии с информацией о текущей загрузке дорог и т. д. В этом примере используется это значение: "timeWithTraffic". | 
      | **Distance unit** (Единица расстояния) | <*выбранная единица*> | Введите единицы измерения расстояния для расчета маршрута. В этом примере используется значение "миля" | 
      | **Travel mode** (Режим движения) | Driving (Движение на автомобиле) | Введите режим движения по маршруту. В этом примере используется значение: "Driving" (Вождение). | 
      | **Transit Date-Time** (Дата и время транзита) | None | Применяется только для режима движения Transit (Транзит). | 
      | **Transit Date-Time Type** (Тип даты и времени транзита) | None | Применяется только для режима движения Transit (Транзит). | 
      ||||  

1. [Добавьте условие](../logic-apps/logic-apps-control-flow-conditional-statement.md), чтобы проверить, превышает ли текущее время движения в соответствии с текущей загрузкой определенное время. 
   Для данного примера выполните следующее.

   1. Переименуйте условие, используя это описание: **если время трафика превышает указанное время**.

   1. Чтобы появился список динамического содержимого, щелкните в самом левом столбце внутри поля **Выбрать значение**. В данном списке выберите поле **Travel Duration Traffic** (Трафик длительности пути), которое задается в секундах. 

      ![Добавление условия](./media/logic-apps-control-flow-run-steps-group-scopes/build-condition.png)

   1. В среднем поле сравнения выберите оператор **больше чем**

   1. В самом правом столбце введите значение сравнения (в секундах), эквивалентное 10 минутам В самом правом столбце введите значение сравнения (в секундах), эквивалентное 10 минутам — **600**.

      После введения значения условие должно выглядеть приблизительно так, как показано в примере ниже:

      ![Условие завершения](./media/logic-apps-control-flow-run-steps-group-scopes/finished-condition.png)

1. В ветке **Если истинно** добавьте действие "Отправить сообщение" для поставщика электронной почты. 
   Настройте это действие, выполнив шаги, приведенные после изображения.

   ![Добавление действия "Отправить сообщение" в ветвь "Если истинно"](./media/logic-apps-control-flow-run-steps-group-scopes/send-email.png)

   1. В поле **Кому** введите адрес электронной почты в целях тестирования.

   1. В поле **Тема** введите следующий текст:

      ```Time to leave: Traffic more than 10 minutes```

   1. В поле **Текст** введите этот текст с пробелом в конце: 

      ```Travel time:```

      Пока ваш курсор находится в поле **Текст**, список динамического содержимого остается открытым, поэтому вы можете выбрать любые параметры, доступные на этом этапе.

   1. В списке динамического содержимого выберите **Выражение**.

   1. Найдите функцию **div( )** и выберите ее. 
      Наведите курсор на содержимое, которое находится в скобках функции.

   1. Чтобы появился список динамического содержимого, выберите **Динамическое содержимое** (пока курсор находится в скобках функции). 
   
   1. В разделе **Получить маршрут** выберите поле **Travel Duration Traffic** (Трафик длительности пути).

      ![Выбор поля Travel Duration Traffic (Трафик длительности пути)](./media/logic-apps-control-flow-run-steps-group-scopes/send-email-2.png)

   1. После разрешения поля в формат JSON добавьте **запятую** (```,```), за которой следует число ```60```, чтобы преобразовать значение **Travel Duration Traffic** (Трафик длительности пути) из секунд в минуты. 
   
      ```
      div(body('Get_route')?['travelDurationTraffic'],60)
      ```

      Теперь выражение выглядит как в следующем примере:

      ![Итоговое выражение](./media/logic-apps-control-flow-run-steps-group-scopes/send-email-3.png)  

   1. Когда все будет готово, нажмите кнопку **ОК**.

   <!-- markdownlint-disable MD038 -->
   1. После разрешения выражения добавьте текст с начальным пробелом: ``` minutes```.
  
       Теперь поле **Текст** выглядит, как в следующем примере:

       ![Итоговое поле "Текст"](./media/logic-apps-control-flow-run-steps-group-scopes/send-email-4.png)
   <!-- markdownlint-enable MD038 -->

1. Сохраните приложение логики.

Затем добавьте область, чтобы группировать определенные действия и оценивать их состояние.

## <a name="add-a-scope"></a>Добавление области

1. Если это еще не сделано, откройте приложение логики в конструкторе приложений логики. 

1. Добавьте область в нужное место в рабочем процессе. Например, чтобы добавить область между существующими шагами в рабочем процессе приложения логики, выполните следующие действия. 

   1. Переместите указатель на стрелку, где нужно добавить область. 
   Выберите **знак плюс** ( **+** ) > **Add an action** (Добавить действие).

      ![Добавление области](./media/logic-apps-control-flow-run-steps-group-scopes/add-scope.png)

   1. В поле поиска введите слово "scope" в качестве фильтра. 
   Выберите действие **Область**.

## <a name="add-steps-to-scope"></a>Добавление шагов в область

1. Теперь добавьте или перенесите имеющиеся шаги, которые необходимо выполнить внутри области. Например, перетащите эти действия в область:
      
   * **Get route** (Получить маршрут);
   * **Если время трафика превышает указанное время**, которое включает ветви **Если истинно** и **Если ложно**

   Теперь приложение логики выглядит, как в следующем примере:

   ![Область добавлена](./media/logic-apps-control-flow-run-steps-group-scopes/scope-added.png)

1. Добавьте в область условие, которое проверяет ее состояние. Переименуйте условие, используя это описание: **если произошел сбой области**.

   ![Добавление условия для проверки состояния области](./media/logic-apps-control-flow-run-steps-group-scopes/add-condition-check-scope-status.png)
  
1. В условие необходимо добавить выражения, которые выполняют проверку состояния области, которое будет соответствовать значению "Сбой" или "Прервано". 

   1. Чтобы добавить строку, выберите **Добавить**. 

   1. Чтобы отобразился список динамического содержимого, щелкните внутри левого поля каждой строки. 
   В списке динамического содержимого выберите **Выражение**. Введите выражение в поле ввода и нажмите кнопку **OK**. 
   
      `result('Scope')[0]['status']`

      ![Снимок экрана, на котором показано поле "выражение" с выделенным выражением результата.](./media/logic-apps-control-flow-run-steps-group-scopes/check-scope-status.png)

   1. Для обоих строк в качестве оператора выберите **равно**. 
   
   1. Чтобы сравнить значения, введите в первой строке `Failed`. 
   Во второй строке введите `Aborted`. 

      После введения значения условие должно выглядеть приблизительно так, как показано в примере ниже:

      ![Добавление выражения, которое проверяет состояние области](./media/logic-apps-control-flow-run-steps-group-scopes/check-scope-status-finished.png)

      Задайте свойство условия `runAfter`. Теперь условие должно проверяет состояние области и выполнять те действия, которые будут определены в последующих шагах.

   1. В условии **Если область завершилась со сбоем.** нажмите кнопку **Многоточие** (...) и выберите **Настройка последующего запуска**.

      ![Настройка свойства "runAfter"](./media/logic-apps-control-flow-run-steps-group-scopes/configure-run-after.png)

   1. Выберите все приведенные состояния области: **успешно выполнена**, **завершилась сбоем**, **пропущена** и **прекращена по таймауту**

      ![Выбор состояний области](./media/logic-apps-control-flow-run-steps-group-scopes/select-run-after-statuses.png)

   1. По завершении нажмите кнопку **Готово**. 
   Теперь состояние отображается в качестве значка Информация.

1. В ветвях **Если истинно** и **Если ложно** добавьте действия, которые нужно выполнить в зависимости от состояния области, например, отправку письма или сообщения.

   ![Добавление действия, выполняемого на основе состояния области](./media/logic-apps-control-flow-run-steps-group-scopes/handle-true-false-branches.png)

1. Сохраните приложение логики.

Созданное приложение логики выглядит, как в следующем примере:

![Готовое приложение логики с областью](./media/logic-apps-control-flow-run-steps-group-scopes/scopes-overview.png)

## <a name="test-your-work"></a>Проверка результатов своих действий

На панели инструментов конструктора нажмите кнопку **Запустить**. Если все действия области успешны, вы получите сообщение Scope succeeded (Область успешна). Если какие-либо действия области не были успешны, вы получите сообщение Scope failed (Область завершилась со сбоем). 

<a name="scopes-json"></a>

## <a name="json-definition"></a>Определение JSON

При работе в представлении кода вместо этого можно определить структуру области в определении JSON приложения логики. Например, вот определение JSON для триггера и действий в предыдущем приложении логики:

``` json
"triggers": {
  "Recurrence": {
    "type": "Recurrence",
    "recurrence": {
       "frequency": "Minute",
       "interval": 1
    }
  }
}
```

```json
"actions": {
  "If_scope_failed": {
    "type": "If",
    "actions": {
      "Scope_failed": {
        "type": "ApiConnection",
        "inputs": {
          "body": {
            "Body": "Scope failed. Scope status: @{result('Scope')[0]['status']}",
            "Subject": "Scope failed",
            "To": "<your-email@domain.com>"
          },
          "host": {
            "connection": {
              "name": "@parameters('$connections')['outlook']['connectionId']"
            }
          },
          "method": "post",
          "path": "/Mail"
        },
        "runAfter": {}
      }
    },
    "else": {
      "actions": {
        "Scope_succeded": {
          "type": "ApiConnection",
          "inputs": {
            "body": {
              "Body": "Scope succeeded. Scope status: @{result('Scope')[0]['status']}",
              "Subject": "Scope succeeded",
              "To": "<your-email@domain.com>"
            },
            "host": {
              "connection": {
               "name": "@parameters('$connections')['outlook']['connectionId']"
              }
            },
            "method": "post",
            "path": "/Mail"
          },
          "runAfter": {}
        }
      }
    },
    "expression": {
      "or": [ 
         {
            "equals": [ 
              "@result('Scope')[0]['status']", 
              "Failed"
            ]
         },
         {
            "equals": [
               "@result('Scope')[0]['status']", 
               "Aborted"
            ]
         } 
      ]
    },
    "runAfter": {
      "Scope": [
        "Failed",
        "Skipped",
        "Succeeded",
        "TimedOut"
      ]
    }
  },
  "Scope": {
    "type": "Scope",
    "actions": {
      "Get_route": {
        "type": "ApiConnection",
        "inputs": {
          "host": {
            "connection": {
              "name": "@parameters('$connections')['bingmaps']['connectionId']"
            }
          },
          "method": "get",
          "path": "/REST/V1/Routes/Driving",
          "queries": {
            "distanceUnit": "Mile",
            "optimize": "timeWithTraffic",
            "travelMode": "Driving",
            "wp.0": "<start>",
            "wp.1": "<end>"
          }
        },
        "runAfter": {}
      },
      "If_traffic_time_is_more_than_specified_time": {
        "type": "If",
        "actions": {
          "Send_mail_when_traffic_exceeds_10_minutes": {
            "type": "ApiConnection",
            "inputs": {
              "body": {
                 "Body": "Travel time:@{div(body('Get_route')?['travelDurationTraffic'],60)} minutes",
                 "Subject": "Time to leave: Traffic more than 10 minutes",
                 "To": "<your-email@domain.com>"
              },
              "host": {
                "connection": {
                   "name": "@parameters('$connections')['outlook']['connectionId']"
                }
              },
              "method": "post",
              "path": "/Mail"
            },
            "runAfter": {}
          }
        },
        "expression": {
          "and" : [
            {
               "greater": [ 
                  "@body('Get_route')?['travelDurationTraffic']", 
                  600
               ]
            }
          ]
        },
        "runAfter": {
          "Get_route": [
            "Succeeded"
          ]
        }
      }
    },
    "runAfter": {}
  }
},
```

## <a name="get-support"></a>Получение поддержки

* Если у вас есть вопросы, посетите [страницу вопросов и ответов по Azure Logic Apps на сайте Майкрософт](/answers/topics/azure-logic-apps.html).
* Оставить предложения по функциям или проголосовать за них вы можете на [сайте отзывов пользователей Azure Logic Apps](https://aka.ms/logicapps-wish).

## <a name="next-steps"></a>Дальнейшие действия

* [Conditional statements: Run steps based on a condition in logic apps](../logic-apps/logic-apps-control-flow-conditional-statement.md) (Условные операторы. Выполнение шагов на основе условия в приложениях логики)
* [Операторы switch. Выполнение различных шагов на основе различных значений в приложениях логики](../logic-apps/logic-apps-control-flow-switch-statement.md)
* [Loops: Process arrays or repeat actions until a condition is met](../logic-apps/logic-apps-control-flow-loops.md) (Циклы. Обработка массивов или повторение действий до выполнения условия)
* [Create or join parallel branches in your logic app](../logic-apps/logic-apps-control-flow-branches.md) (Создание или присоединение параллельных ветвей в приложении логики)