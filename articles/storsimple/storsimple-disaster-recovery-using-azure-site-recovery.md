---
title: Автоматизация аварийного восстановления файловых ресурсов StorSimple с помощью Azure Site Recovery | Документация Майкрософт
description: В этой статье описываются инструкции и рекомендации по созданию решения аварийного восстановления для файловых ресурсов, размещенных в хранилище Microsoft Azure StorSimple.
services: storsimple
documentationcenter: NA
author: vidarmsft
manager: syadav
editor: ''
ms.assetid: 23049a2c-055e-4d0e-b8f5-af2a87ecf53f
ms.service: storsimple
ms.devlang: NA
ms.topic: how-to
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 10/13/2017
ms.author: alkohli
ms.openlocfilehash: c6152d4b9ee28554efcb5b08b7a2d161a0723852
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "104670910"
---
# <a name="automated-disaster-recovery-solution-using-azure-site-recovery-for-file-shares-hosted-on-storsimple"></a>Решение по автоматизированному аварийному восстановлению с использованием Azure Site Recovery для файловых ресурсов, размещенных в StorSimple

[!INCLUDE [updated-for-az](../../includes/updated-for-az.md)]

## <a name="overview"></a>Обзор
Решение гибридного облачного хранилища Microsoft Azure StorSimple устраняет характерные для неструктурированных данных сложности, которые обычно возникают с файловыми ресурсами. StorSimple использует облачное хранилище в качестве расширения локального решения и автоматически связывает данные локального хранилища с данными облачного хранилища. Интегрированная защита данных, а также локальные и облачные моментальные снимки устраняют необходимость в расширении инфраструктуры хранилища.

[Azure Site Recovery](../site-recovery/site-recovery-overview.md) обеспечивает аварийное восстановление, оркестрируя процессы репликации, отработки отказа и восстановления виртуальных машин. Эта служба поддерживает ряд технологий репликации, которые обеспечивают систематическое создание реплик, защиту и полную отработку отказов виртуальных машин и приложений в общедоступном, частном и размещенном облаках.

Azure Site Recovery, репликация виртуальных машин и возможность создавать моментальные снимки облака в StorSimple позволяют защитить всю среду файловых серверов. В случае прерывания связи файловые ресурсы можно подключить к Azure всего за несколько минут.

В этом документе подробно описано, как создать решение по аварийному восстановлению файловых ресурсов, размещенных в хранилище StorSimple, и выполнять плановые, внеплановые и тестовые отработки отказов с помощью быстрого плана восстановления. По сути, здесь рассказывается, как изменить план восстановления в своем хранилище Azure Site Recovery, чтобы обеспечить отработку отказа StorSimple в аварийных сценариях. Кроме того, здесь описываются поддерживаемые конфигурации и необходимые компоненты. В этом документе предполагается, что вы знакомы с основами архитектуры Azure Site Recovery и StorSimple.

## <a name="supported-azure-site-recovery-deployment-options"></a>Поддерживаемые варианты развертывания Azure Site Recovery
Клиенты могут развертывать файловые серверы в качестве физических серверов или виртуальных машин под управлением Hyper-V или VMware, а затем создавать файловые ресурсы из томов, взятых из хранилища StorSimple. Azure Site Recovery позволяет защитить физические и виртуальные развертывания, перемещая их на дополнительные сайты или в Azure. Этот документ содержит подробные сведения о решении по аварийному восстановлению, в котором Azure используется в качестве сайта восстановления для виртуальной машины файлового сервера. При этом виртуальная машина размещена в системе Hyper-V, а файловые ресурсы — в хранилище StorSimple. Аналогичным образом можно реализовать другие сценарии, в которых виртуальная машина файлового сервера размещена в виртуальной машине VMware или на физическом компьютере.

## <a name="prerequisites"></a>Предварительные условия
Чтобы реализовать решение по быстрому аварийному восстановлению, использующее Azure Site Recovery для файловых ресурсов, размещенных в хранилище StorSimple, требуются следующие компоненты:

   - локальная виртуальная машина файлового сервера Windows Server 2012 R2, размещенная в Hyper-V, VMware или на физическом компьютере;
   - локальное устройство хранилища StorSimple, зарегистрированное с помощью диспетчера Azure StorSimple;
   - Облачное устройство StorSimple, созданное в диспетчере Azure StorSimple. Это устройство может храниться в отключенном состоянии.
   - файловые ресурсы, размещенные в томах, настроенных на устройстве хранилища StorSimple;
   - [хранилище служб Azure Site Recovery](../site-recovery/hyper-v-vmm-azure-tutorial.md) , созданное в подписке Microsoft Azure.

Кроме того, если в качестве сайта аварийного восстановления используется Azure, запустите [средство оценки готовности виртуальных машин Azure](https://azure.microsoft.com/downloads/vm-readiness-assessment/) на виртуальных машинах, чтобы убедиться в их совместимости с виртуальными машинами Azure и службами Azure Site Recovery.

Во избежание задержек (которые могут создавать дополнительные затраты), устройство StorSimple Cloud Appliance, учетная запись автоматизации и все учетные записи хранения должны быть созданы в одном регионе.

## <a name="enable-dr-for-storsimple-file-shares"></a>Включение аварийного восстановления для файловых ресурсов StorSimple
Чтобы можно было включить полные репликацию и восстановление, должен быть защищен каждый компонент локальной среды. В этом разделе описаны следующие процессы:
    
   - настроить репликацию Active Directory и DNS (необязательный шаг);
   - Использование Azure Site Recovery для обеспечения защиты виртуальной машины файлового сервера
   - включить защиту томов StorSimple;
   - Настройка сети

### <a name="set-up-active-directory-and-dns-replication-optional"></a>настроить репликацию Active Directory и DNS (необязательный шаг);
Чтобы защитить компьютеры, на которых работают Active Directory и DNS, и обеспечить их доступность на сайте аварийного восстановления, их нужно защитить явным образом (чтобы файловые серверы были доступны после отработки отказа с выполнением аутентификации). В зависимости от сложности локальной среды клиента рекомендуется два варианта защиты.

#### <a name="option-1"></a>Вариант 1
Если у клиента немного приложений и один контроллер домена для всего локального сайта, а весь сайт будет подвергнут отработке отказа одновременно, рекомендуем создать реплику виртуальной машины с контроллером домена на дополнительном сайте с помощью Azure Site Recovery (возможна репликация как с сайта на сайт, так и с сайта в Azure).

#### <a name="option-2"></a>Вариант 2
Если у клиента много приложений, он использует лес Active Directory, а отработке отказа будет подвергнуто несколько приложений одновременно, рекомендуем настроить дополнительный контроллер домена на сайте аварийного восстановления (на дополнительном сайте или в Azure).

Указания об обеспечении доступности контроллера домена на сайте аварийного восстановления см. в статье [Защита Active Directory и DNS с Azure Site Recovery](../site-recovery/site-recovery-active-directory.md). Далее в этом документе подразумевается, что контроллер домена доступен на сайте аварийного восстановления.

### <a name="use-azure-site-recovery-to-enable-protection-of-the-file-server-vm"></a>Использование Azure Site Recovery для обеспечения защиты виртуальной машины файлового сервера
На этом шаге вам нужно подготовить локальную среду файлового сервера, создать и подготовить хранилище Azure Site Recovery и включить защиту файлов виртуальной машины.

#### <a name="to-prepare-the-on-premises-file-server-environment"></a>Подготовка локальной среды файлового сервера
1. Для параметра **Контроль учетных записей** установите значение **Никогда не уведомлять**. Это необходимо, чтобы сценарии автоматизации Azure можно было использовать для подключения целевых объектов iSCSI после отработки отказа с помощью Azure Site Recovery.
   
   1. Нажмите клавиши Windows+Q и выполните поиск по запросу **UAC**.  
   1. Щелкните **Изменить параметры контроля учетных записей**.  
   1. Перетащите ползунок вниз к пункту **Никогда не уведомлять**.  
   1. Нажмите кнопку **ОК**, а при появлении запроса — **Да**.  
   
      ![Параметры контроля учетных записей](./media/storsimple-disaster-recovery-using-azure-site-recovery/image1.png) 

1. Установите агент виртуальной машины на каждой виртуальной машине файлового сервера. Это необходимо, чтобы запускать сценарии автоматизации Azure на виртуальных машинах, переключившихся на резервный ресурс.
   
   1. [Скачайте агент](https://aka.ms/vmagentwin) в папку с путем `C:\\Users\\<username>\\Downloads`.
   1. Откройте Windows PowerShell в режиме администратора (щелкните "Запустить от имени администратора") и введите следующую команду, чтобы перейти к папке скачивания:  
         `cd C:\\Users\\<username>\\Downloads\\WindowsAzureVmAgent.2.6.1198.718.rd\_art\_stable.150415-1739.fre.msi`
         
         > [!NOTE]
         > Имя файла может зависеть от версии.
      
1. Щелкните **Далее**.
1. Примите **условия соглашения**, а затем нажмите кнопку **Далее**.
1. Нажмите кнопку **Готово**.
1. Создайте файловые ресурсы, используя тома, взятые из хранилища StorSimple. Дополнительные сведения см. в статье [Использование службы StorSimple Manager для управления томами](./index.yml).
   
   1. На каждой локальной виртуальной машине нажмите клавиши Windows+Q и выполните поиск по запросу **iSCSI**.
   1. Щелкните **Инициатор iSCSI**.
   1. Выберите вкладку **Конфигурация** и скопируйте имя инициатора.
   1. Войдите на [портал Azure](https://portal.azure.com/).
   1. Перейдите на вкладку **StorSimple** и выберите службу StorSimple Manager, в которой содержится физическое устройство.
   1. Создайте контейнеры для томов, а затем тома. (Эти тома предназначены для файловых ресурсов на виртуальных машинах файловых серверов.) Скопируйте имя инициатора и присвойте соответствующее имя записям контроля доступа при создании томов.
   1. Выберите вкладку **Настройка** и запишите IP-адрес устройства.
   1. На каждой локальной виртуальной машине снова перейдите в раздел **Инициатор iSCSI** и введите IP-адрес в разделе "Быстрое подключение". Щелкните **Быстрое подключение** (теперь устройство должно быть подключено).
   1. Откройте портал Azure и выберите вкладку **тома и устройства** . Щелкните **Автоматическая настройка**. После этого должен отобразиться созданный том.
   1. На портале выберите вкладку **Устройства** и щелкните **Create a New Virtual Device** (Создать виртуальное устройство).  (Создать виртуальное устройство). (Это виртуальное устройство будет использоваться в случае отработки отказа.) Новое виртуальное устройство можно хранить не подключенным к сети, чтобы избежать лишних затрат. Чтобы перевести виртуальное устройство в автономный режим, на портале перейдите в раздел **Виртуальные машины** и завершите работу устройства.
   1. Вернитесь к каждой локальной виртуальной машине и откройте раздел "Управление дисками" (нажмите клавиши Windows+X и щелкните **Управление дисками**).
   1. Здесь можно увидеть еще несколько дисков (в зависимости от количества созданных томов). Щелкните первый диск правой кнопкой мыши, выберите пункт **Инициализировать диск** и нажмите кнопку **ОК**. Щелкните правой кнопкой мыши раздел **Не выделено**, щелкните **Создать простой том**, назначьте диску букву и завершите работу мастера.
   1. Повторите предыдущий шаг для всех дисков. Теперь все диски на **этом ПК** можно увидеть в проводнике.
   1. Создавайте файловые ресурсы в этих томах, используя роль файловых служб и служб хранилища.

#### <a name="to-create-and-prepare-an-azure-site-recovery-vault"></a>Создание и подготовка хранилища Azure Site Recovery
Сведения о начале работы с Azure Site Recovery до защиты виртуальной машины файлового сервера см. в [документации по Azure Site Recovery](../site-recovery/index.yml).

#### <a name="to-enable-protection"></a>Включение защиты
1. Отключите целевые объекты iSCSI для локальных виртуальных машин, которые необходимо защитить, с помощью Azure Site Recovery:
   
   1. Нажмите клавиши Windows+Q и выполните поиск по запросу **iSCSI**.
   1. Щелкните **Настройка iSCSI-инициатора**.
   1. Отключите устройство StorSimple, которое вы подключили ранее. Как вариант, во время включения защиты можно отключить файловый сервер на несколько минут.
      
   > [!NOTE]
   > В результате файловые ресурсы будут временно недоступны.
   
1. [Включите защиту виртуальной машины](../site-recovery/hyper-v-azure-tutorial.md) файлового сервера на портале Azure Site Recovery.
1. Когда запустится начальная синхронизация, целевой объект можно подключить снова. Перейдите к инициатору iSCSI, выберите устройство StorSimple и щелкните **Подключить**.
1. Когда синхронизация завершится, у виртуальной машины будет состояние **Защищено**. Выберите виртуальную машину, щелкните вкладку **Настройка** и соответствующим образом обновите сеть виртуальной машины (это сеть, к которой будет принадлежать виртуальная машина, для которой выполнена отработка отказа). Если сеть не будет отображаться, значит синхронизация еще не завершена.

### <a name="enable-protection-of-storsimple-volumes"></a>включить защиту томов StorSimple;
Если вы не установили параметр **Включить архивацию по умолчанию для этого тома** для томов StorSimple, то в службе StorSimple Manager перейдите к **Политики архивации** и создайте подходящую политику архивации для всех томов. Для частоты резервного копирования рекомендуется установить целевую точку восстановления (RPO), которую необходимо использовать для приложения.

### <a name="configure-the-network"></a>Настройка сети
Для виртуальной машины файлового сервера в Azure Site Recovery настройте параметры сети так, чтобы сети виртуальных машин были подключены к правильной сети аварийного восстановления после отработки отказа.

Вы можете выбрать виртуальную машину на вкладке **Реплицированные элементы**, чтобы настроить параметры сети, как показано на рисунке ниже.

![Вычисления и сеть](./media/storsimple-disaster-recovery-using-azure-site-recovery/image2.png)

## <a name="create-a-recovery-plan"></a>Создание плана восстановления
Вы можете создать план восстановления в Azure Site Recovery, чтобы автоматизировать отработку отказа файловых ресурсов. Если произойдет прерывание связи, файловые ресурсы можно подключить к Azure всего за несколько минут. Чтобы применить автоматизацию, понадобится учетная запись автоматизации Azure.

#### <a name="to-create-an-automation-account"></a>Создание учетной записи службы автоматизации
1. Перейдите на портал Azure  в раздел &gt; **Автоматизация**.
1. Нажмите кнопку **+ Добавить**. Откроется колонка, показанная ниже.
   
   ![Добавление учетной записи службы автоматизации](./media/storsimple-disaster-recovery-using-azure-site-recovery/image11.png)
   
   - Имя: введите имя новой учетной записи службы автоматизации.
   - Подписка: выберите подписку.
   - Группа ресурсов: создайте или выберите существующую группу ресурсов.
   - Расположение: выберите расположение. Оно должно быть в том же геообъекте или регионе, в котором были созданы облачное устройство StorSimple и учетные записи хранения.
   - Создать учетную запись запуска от имени Azure: выберите вариант **Да**.
   
1. Перейдите в учетную запись службы автоматизации и последовательно выберите **Модули Runbook** &gt; **Просмотреть коллекцию**, чтобы импортировать все необходимые модули Runbook в учетную запись службы автоматизации.
1. Добавьте следующие модули Runbook, найдя тег **Аварийное восстановление** в коллекции:
   
   - Clean up of StorSimple volumes after Test Failover (Очистка томов StorSimple после тестовой отработки отказа);
   - Failover StorSimple volume containers (Отработка отказа контейнеров томов StorSimple);
   - Mount volumes on StorSimple device after failover (Подключение томов на устройстве StorSimple после отработки отказа);
   - Uninstall custom script extension in Azure VM (Удаление расширения пользовательского сценария на виртуальной машине Azure).
   - Start StorSimple Virtual Appliance (Запуск виртуального устройства StorSimple);
   
      ![Обзор коллекции](./media/storsimple-disaster-recovery-using-azure-site-recovery/image3.png)
   
1. Опубликуйте все скрипты, выбрав модуль runbook в учетной записи службы автоматизации, выбрав **Правка** &gt; **Опубликовать**, а затем нажав кнопку **Да** в подтверждении. После выполнения этого шага вкладка **Модули Runbook** будет выглядеть следующим образом:
   
   ![Модули runbook](./media/storsimple-disaster-recovery-using-azure-site-recovery/image4.png)
   
1. В учетной записи службы автоматизации щелкните **Variables (Переменные),** &gt; **Добавить переменную** и добавьте приведенные ниже переменные. Вы также можете зашифровать эти ресурсы. Переменные зависят от плана восстановления. Если имя плана восстановления, который вы создадите на следующем шаге, — TestPlan, то у переменных будут имена TestPlan-StorSimRegKey, TestPlan-AzureSubscriptionName и т. п.

   - **BaseUrl.** URL-адрес диспетчера ресурсов для облака Azure. Получите использование командлета **Get-азенвиронмент | Select-Object Name, ResourceManagerUrl** .
   - _RecoveryPlanName_**-ResourceGroupName.** Группа диспетчера ресурсов с ресурсом StorSimple.
   - _RecoveryPlanName_**-Манажернаме**— ресурс storsimple с устройством storsimple.
   - _RecoveryPlanName_**-DeviceName**: устройство StorSimple, для которого требуется отработка отказа.
   - _RecoveryPlanName_**-девицеипаддресс**: IP-адрес устройства (это можно найти на вкладке " **устройства** " в разделе StorSimple Диспетчер устройств &gt; **Параметры** &gt; **сети** &gt; Группа **параметров DNS** ).
   - _RecoveryPlanName_**-VolumeContainers**: разделенная запятыми строка контейнеров томов на устройстве, для которых необходимо выполнить отработку отказа; Например: volcon1, volcon2, volcon3.
   - _RecoveryPlanName_**-таржетдевиценаме**— облачное устройство StorSimple, на котором отправляются контейнеры для отработки отказа.
   - _RecoveryPlanName_**-таржетдевицеипаддресс**: IP-адрес целевого устройства (это можно найти на  &gt;  &gt; вкладке **Сетевые подключения** группы параметры раздела виртуальной машины).
   - _RecoveryPlanName_**-StorageAccountName**: имя учетной записи хранения, в которой будет храниться скрипт (который должен выполняться на виртуальной машине, для которой выполнена отработка отказа). Ею может быть любая учетная запись хранения, в которой есть пространство для временного хранения сценария.
   - _RecoveryPlanName_**-StorageAccountKey**— ключ доступа для указанной выше учетной записи хранения.
   - _RecoveryPlanName_**-вмгуидс**. после защиты виртуальной машины Azure Site Recovery назначает каждой виртуальной машине уникальный идентификатор, который предоставляет сведения о виртуальной машине, для которой выполнена отработка отказа. Чтобы получить VMGUID, откройте вкладку **Службы восстановления** и последовательно выберите **Защищенный элемент** &gt; **Группы защиты** &gt; **Компьютеры** &gt; **Свойства**. При наличии нескольких виртуальных машин добавьте идентификаторы GUID в формате строки с разделителями-запятыми.

     Например, если имя плана восстановления — fileServerpredayRP, после добавления всех ресурсов вкладка **Переменные**, **Подключения** и **Сертификаты** будет выглядеть следующим образом.

      ![Активы](./media/storsimple-disaster-recovery-using-azure-site-recovery/image5.png)

1. Отправьте модуль Runbook серии StorSimple 8000 в учетную запись службы автоматизации. Выполните следующие шаги, чтобы добавить модуль:
   
   1. Откройте PowerShell, создайте папку и замените каталог на папку.
      
      ```
            mkdir C:\scripts\StorSimpleSDKTools
            cd C:\scripts\StorSimpleSDKTools
      ```
   1. Скачайте интерфейс командной строки NuGet в папку, созданную на шаге 1.
      В [ресурсах для скачивания nuget](https://www.nuget.org/downloads) доступны различные версии nuget.exe. Каждая ссылка для загрузки указывает непосредственно на EXE-файл. Щелкните правой кнопкой мыши, сохраните файл на компьютере и не запускайте его из браузера.
      
      ```
            wget https://dist.nuget.org/win-x86-commandline/latest/nuget.exe -Out C:\scripts\StorSimpleSDKTools\nuget.exe
      ```
      
   1. Скачайте зависимый пакет SDK.
      
      ```
            C:\scripts\StorSimpleSDKTools\nuget.exe install Microsoft.Azure.Management.Storsimple8000series
            C:\scripts\StorSimpleSDKTools\nuget.exe install Microsoft.IdentityModel.Clients.ActiveDirectory -Version 2.28.3
            C:\scripts\StorSimpleSDKTools\nuget.exe install Microsoft.Rest.ClientRuntime.Azure.Authentication -Version 2.2.9-preview
      ```
      
   1. Создайте модуль Runbook службы автоматизации Azure для управления устройствами StorSimple серии 8000. Выполните команды, приведенные ниже, чтобы создать ZIP-файл модуля службы автоматизации.
         
      ```powershell
            # set path variables
            $downloadDir = "C:\scripts\StorSimpleSDKTools"
            $moduleDir = "$downloadDir\AutomationModule\Microsoft.Azure.Management.StorSimple8000Series"

            #don't change the folder name "Microsoft.Azure.Management.StorSimple8000Series"
            mkdir "$moduleDir"

            copy "$downloadDir\Microsoft.IdentityModel.Clients.ActiveDirectory.2.28.3\lib\net45\Microsoft.IdentityModel.Clients.ActiveDirectory*.dll" $moduleDir
            copy "$downloadDir\Microsoft.Rest.ClientRuntime.Azure.3.3.7\lib\net452\Microsoft.Rest.ClientRuntime.Azure*.dll" $moduleDir
            copy "$downloadDir\Microsoft.Rest.ClientRuntime.2.3.8\lib\net452\Microsoft.Rest.ClientRuntime*.dll" $moduleDir
            copy "$downloadDir\Newtonsoft.Json.6.0.8\lib\net45\Newtonsoft.Json*.dll" $moduleDir
            copy "$downloadDir\Microsoft.Rest.ClientRuntime.Azure.Authentication.2.2.9-preview\lib\net45\Microsoft.Rest.ClientRuntime.Azure.Authentication*.dll" $moduleDir
            copy "$downloadDir\Microsoft.Azure.Management.Storsimple8000series.1.0.0\lib\net452\Microsoft.Azure.Management.Storsimple8000series*.dll" $moduleDir

            #Don't change the name of the Archive
            compress-Archive -Path "$moduleDir" -DestinationPath Microsoft.Azure.Management.StorSimple8000Series.zip
      ```
         
   1. Импортируйте ZIP-файл модуля службы автоматизации Azure (Microsoft.Azure.Management.StorSimple8000Series.zip), созданный на предыдущем шаге. Для этого выберите учетную запись службы автоматизации, щелкните **Modules** (Модули) в разделе "Общие ресурсы" и выберите **Добавить модуль**.
   
   После завершения импорта модуля StorSimple серии 8000 вкладка **Modules** (Модули) должна выглядеть следующим образом:
   
      ![Модули](./media/storsimple-disaster-recovery-using-azure-site-recovery/image12.png)

1. Перейдите к разделу **Службы восстановления** и выберите хранилище Azure Site Recovery, созданное ранее.
1. В группе **Управление** выберите параметр **Планы восстановления (Site Recovery)** и создайте план восстановления, выполнив указанные ниже действия.
   
   - Нажмите кнопку **+ План восстановления**. Откроется колонка, показанная ниже.
      
      ![Создать план восстановления](./media/storsimple-disaster-recovery-using-azure-site-recovery/image6.png)
      
   - Введите имя плана восстановления. Выберите значения источника, целевого объекта и модели развертывания.
   
   - Выберите в группе защиты виртуальные машины, которые необходимо включить в план восстановления, и нажмите кнопку **ОК**.
   
   - Выберите план восстановления, который был создан ранее, и нажмите кнопку **Настроить**, чтобы открыть представление настройки плана восстановления.
   
   - Щелкните правой кнопкой мыши элемент **Завершение работы всех групп** и выберите пункт **Добавить предварительное действие**.
   
   - Откроется колонка "Вставка действия". Введите имя, выберите значение **Первичное расположение** для параметра "Где запускать", выберите учетную запись службы автоматизации (в которой вы добавили модули runbook), а затем выберите модуль runbook **Failover-StorSimple-Volume-Containers**.
   
   - Щелкните правой кнопкой мыши элемент **Группа 1: запуск** и выберите пункт **Добавить защищенные элементы**. Затем выберите виртуальные машины, подлежащие защите в плане восстановления, и нажмите кнопку **ОК**. Если виртуальные машины уже выбраны, это действие выполнять необязательно.
   
   - Щелкните правой кнопкой мыши элемент **Группа 1: запуск** и выберите пункт **Действие при учете**, а затем добавьте все следующие скрипты:  
      
      - модуль Runbook Start-StorSimple-Virtual-Appliance;  
      - модуль Runbook Fail over-StorSimple-volume-containers;  
      - модуль Runbook Mount-volumes-after-failover;  
      - модуль Runbook Uninstall-custom-script-extension.  
        
   - Добавьте ручное действие после четырех сценариев, указанных выше, в том же разделе **Группа 1: последующие действия** . Это действие позволяет проверить, все ли работает правильно. Это действие необходимо добавить только в состав тестовой отработки отказа (поэтому установите флажок **Тестовая отработка отказа** ).
    
   - После ручного действия Добавьте скрипт **очистки** , используя ту же процедуру, которая использовалась для других модулей Runbook. **Сохраните** план восстановления.
    
   > [!NOTE]
   > При выполнении тестовой отработки отказа следует проверить все на шаге ручного действия, так как по его завершении тома StorSimple, клонированные на целевом устройстве, будут удалены при очистке.
       
      ![План восстановления](./media/storsimple-disaster-recovery-using-azure-site-recovery/image7.png)

## <a name="perform-a-test-failover"></a>Тестовая отработка отказа
Рекомендации по работе с Active Directory во время тестовой отработки отказа см. во вспомогательном руководстве по [решению аварийного восстановления с помощью Active Directory](../site-recovery/site-recovery-active-directory.md). Тестовая отработка отказа никак не влияет на локальные настройки. Тома StorSimple, подключенные к локальной виртуальной машине, копируются на устройство StorSimple Cloud Appliance в Azure. Виртуальная машина для тестирования подключается к Azure, а клонированные тома подключаются к виртуальной машине.

#### <a name="to-perform-the-test-failover"></a>Выполнение тестовой отработки отказа
1. На портале Azure выберите свое хранилище Site Recovery.
1. Щелкните план восстановления, созданный для виртуальной машины файлового сервера.
1. Щелкните **Тестовая отработка отказа**.
1. Выберите виртуальную сеть Azure, к которой будут подключаться виртуальные машины Azure после отработки отказа.
   
   ![Запуск отработки отказа](./media/storsimple-disaster-recovery-using-azure-site-recovery/image8.png)
   
1. Нажмите кнопку **ОК** , чтобы запустить отработку отказа. За ходом выполнения можно следить в окне свойств, которое можно открыть, щелкнув виртуальную машину, или в **задании тестовой отработки отказа**, выбрав имя хранилища &gt; **Задания** &gt; **Задания Site Recovery**.
1. После завершения отработки отказа реплика виртуальной машины Azure появится на портале Azure в разделе  **Виртуальные машины**. Вы можете выполнить проверки.
1. По завершении проверок щелкните **Проверка завершена**. После этого тома StorSimple будут удалены, а работа облачного устройства StorSimple завершится.
1. Когда все будет готово, нажмите кнопку **Cleanup test failover** (Очистить тестовую отработку отказа) в плане восстановления. В разделе "Примечания" можно записать и сохранить наблюдения касательно тестовой отработки отказа. Это приведет к удалению виртуальной машины, созданной при тестовой отработке отказа.

## <a name="perform-a-planned-failover"></a>Плановая отработка отказа
   Во время плановой отработки отказа работа локальных виртуальных машин файловых серверов завершается корректно и на устройстве StorSimple создается моментальный снимок облачной резервной копии томов. Тома StorSimple переключаются на виртуальное устройство, реплика виртуальной машины подключается к Azure, а к виртуальной машине подключаются тома.

#### <a name="to-perform-a-planned-failover"></a>Выполнение плановой отработки отказа
1. На портале Azure выберите хранилище **Службы восстановления**&gt; **Планы восстановления (Site Recovery)** &gt; **имя_плана_восстановления**, созданного для виртуальной машины файлового сервера.
1. В колонке "План восстановления" щелкните **Дополнительно** &gt;  **Плановая отработка отказа**.

   ![Снимок экрана, на котором выделены параметры плановой отработки отказа](./media/storsimple-disaster-recovery-using-azure-site-recovery/image9.png)
1. В колонке **Подтвердить плановую отработку отказа** выберите исходное и целевое расположения, целевую сеть, а затем щелкните значок галочки ✓, чтобы запустить процесс отработки отказа.
1. После создания реплицированных виртуальных машин они находятся в состоянии ожидания фиксации. Щелкните **Применить**, чтобы применить отработку отказа.
1. По завершении репликации виртуальные машины будут запущены в дополнительном расположении.

## <a name="perform-a-failover"></a>Выполнение отработки отказа
Во время внеплановой отработки отказа тома StorSimple переключаются на виртуальное устройство, реплика виртуальной машины подключается к Azure, а к виртуальной машине подключаются тома.

#### <a name="to-perform-a-failover"></a>Выполнение отработки отказа
1. На портале Azure выберите хранилище **Службы восстановления**&gt; **Планы восстановления (Site Recovery)** &gt; **имя_плана_восстановления**, созданного для виртуальной машины файлового сервера.
1. В колонке "План восстановления" щелкните **Дополнительно** &gt;  **Отработка отказа**.
1. В колонке **Подтверждение отработки отказа** выберите исходное и целевое расположения.
1. Установите флажок **Завершить работу виртуальных машин и синхронизировать последние данные**. Этот флажок указывает, что Site Recovery следует завершать работу защищенных виртуальных машин и синхронизировать данные, чтобы можно было выполнять отработку отказа на основе последней версии данных.
1. После отработки отказа виртуальные машины будут находиться в состоянии ожидании фиксации. Щелкните **Применить**, чтобы применить отработку отказа.


## <a name="perform-a-failback"></a>Восстановление размещения
Размещение контейнеров томов StorSimple восстанавливается на физическом устройстве после резервного копирования.

#### <a name="to-perform-a-failback"></a>Выполнение восстановления размещения
1. На портале Azure выберите хранилище **Службы восстановления**&gt; **Планы восстановления (Site Recovery)** &gt; **имя_плана_восстановления**, созданного для виртуальной машины файлового сервера.
1. В колонке "План восстановления" щелкните **Дополнительно** &gt;  **Плановая отработка отказа**.
1. Выберите исходное и целевое расположения и настройте соответствующие параметры синхронизации данных и создания виртуальной машины.
1. Чтобы начать процесс восстановления размещения, нажмите кнопку **ОК**.
   
   ![Запуск восстановления размещения](./media/storsimple-disaster-recovery-using-azure-site-recovery/image10.png)

## <a name="best-practices"></a>Рекомендации
### <a name="capacity-planning-and-readiness-assessment"></a>Планирование ресурсов и оценка готовности
#### <a name="hyper-v-site"></a>Узел Hyper-V
Используйте [пользовательский инструмент планировщика ресурсов](https://www.microsoft.com/download/details.aspx?id=39057) , чтобы спроектировать инфраструктуру сервера, хранилища и сети для среды реплики Hyper-V.

#### <a name="azure"></a>Azure
Вы можете запустить [средство оценки готовности виртуальных машин Azure](https://azure.microsoft.com/downloads/vm-readiness-assessment/) на виртуальных машинах, чтобы убедиться в их совместимости с виртуальными машинами Azure и службами Azure Site Recovery. Средство оценки готовности проверяет конфигурацию виртуальных машин и предупреждает, если она несовместима с Azure. Например, средство сообщит, если емкость диска C: превышает 127 ГБ.

Планирование ресурсов предполагает выполнение по крайней мере двух важных процессов:

   - сопоставление размеров локальных виртуальных машин Hyper-V и виртуальных машин Azure (например, A6, A7, A8 и A9);
   - определение требуемой пропускной способности интернет-канала.

## <a name="limitations"></a>Ограничения
- Сейчас можно выполнить отработку отказа только одного устройства StorSimple (устройства StorSimple Cloud Appliance). Сценарий, когда файловый сервер охватывает несколько устройств StorSimple, не поддерживается.
- Если во время включения защиты виртуальной машины отобразится сообщение об ошибке, убедитесь, что вы отключили целевые объекты iSCSI.
- Все контейнеры томов, сгруппированные, так как политики архивации охватывают их, будут переключены на другой ресурс вместе.
- Все тома в выбранных контейнерах будут переключены на другой ресурс.
- Нельзя выполнить отработку отказа для томов, после добавления которых емкость будет больше 64 ТБ, так как максимальная емкость одного устройства StorSimple Cloud Appliance — 64 ТБ.
- Если произошел сбой плановой или внеплановой отработки отказа, а виртуальные машины созданы в Azure, не удаляйте эти виртуальные машины. Вместо этого можно восстановить их размещение. Если удалить эти виртуальные машины, больше нельзя будет включить локальные виртуальные машины.
- Если после отработки отказа вы не видите тома, перейдите к каждой виртуальной машине, откройте раздел "Управление дисками", повторно просканируйте диски, а затем подключите их к сети.
- В некоторых случаях буквы диска на сайте аварийного восстановления могут отличаться от букв в локальной системе. В этом случае необходимо вручную исправить проблему после отработки отказа.
- Время ожидания задания отработки отказа. Время ожидания выполнения сценария StorSimple истечет, если отработка отказа контейнеров томов будет длиться дольше, чем установлено для ограничения сценария Azure Site Recovery (сейчас это 120 минут).
- Время ожидания задания резервного копирования. Время ожидания выполнения сценария StorSimple истечет, если резервное копирование томов длится дольше, чем установлено для ограничения сценария Azure Site Recovery (сейчас это 120 минут).
   
  > [!IMPORTANT]
  > В таком случае резервное копирование необходимо запустить вручную на портале Azure, а затем повторно запустить план восстановления.
   
- Время ожидания задания клонирования. Время ожидания выполнения сценария StorSimple истекает, если клонирование томов длится дольше, чем установлено для ограничения сценария Azure Site Recovery (сейчас это 120 минут).
- Ошибка синхронизации времени. Сценарий StorSimple будет отображать сообщения о том, что процессы резервного копирования завершились с ошибкой, несмотря на то, что они выполнены успешно на портале. Причиной этому может быть то, что время на устройстве StorSimple не отвечает текущему времени часового пояса.
   
  > [!IMPORTANT]
  > Синхронизируйте время устройства с текущим временем часового пояса.
   
- Ошибка отработки отказа устройства. Если во время выполнения плана восстановления произойдет отработка отказа устройства, может произойти сбой сценария StorSimple.
   
  > [!IMPORTANT]
  > В таком случае запустите план восстановления снова после отработки отказа устройства.


## <a name="summary"></a>Итоги
С помощью Azure Site Recovery можно создать всеобъемлющий план автоматизированного аварийного восстановления для виртуальной машины файлового сервера, файловые ресурсы которого размещены в хранилище StorSimple. Отработку отказа можно запустить из любого места в течение нескольких секунд после сбоя и восстановить таким образом работоспособность приложения за считанные минуты.