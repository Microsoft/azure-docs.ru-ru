---
title: Резервное копирование Базы данных Azure для PostgreSQL
description: Сведения о резервном копировании базы данных Azure для PostgreSQL с долгосрочным периодом хранения (Предварительная версия)
ms.topic: conceptual
ms.date: 09/08/2020
ms.custom: references_regions
ms.openlocfilehash: 1e2d83d4a5e21ed747ec9d4dcf2fa03d1e3935cc
ms.sourcegitcommit: 78ecfbc831405e8d0f932c9aafcdf59589f81978
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/23/2021
ms.locfileid: "98737578"
---
# <a name="azure-database-for-postgresql-backup-with-long-term-retention-preview"></a>Резервное копирование базы данных Azure для PostgreSQL с долгосрочным периодом хранения (Предварительная версия)

Azure Backup и службы баз данных Azure объединены, чтобы создать решение для резервного копирования корпоративного уровня для серверов базы данных Azure для PostgreSQL, в котором хранятся резервные копии до 10 лет.

Помимо долгосрочного хранения, решение также имеет множество других возможностей, перечисленных ниже.

- Управление доступом на основе ролей Azure (Azure RBAC) к базе данных с использованием проверки подлинности Azure Active Directory и Управляемое удостоверение службы (MSI).
- Управляемое клиентом плановое резервное копирование по запросу на уровне отдельных баз данных.
- Уровень базы данных восстанавливается на любом сервере postgres или непосредственно в хранилище BLOB-объектов.
- Длительное хранение.
- Централизованный мониторинг всех операций и заданий.
- Резервные копии хранятся в отдельных доменах безопасности и сбоя. Таким образом, даже если исходный сервер был скомпрометирован или даже уничтожен, резервные копии останутся в [резервном хранилище](backup-vault-overview.md).
- Использование **pg_dump** обеспечивает большую гибкость при восстановлении, что позволяет восстанавливать версии баз данных или даже восстанавливать только часть резервной копии.

Это решение можно использовать независимо или в дополнение к собственному решению резервного копирования, предлагаемому Azure PostgreSQL, которое предлагает срок хранения до 35 дней. Собственное решение подходит для оперативного восстановления, например, если требуется выполнить восстановление из последней резервной копии. Решение Azure Backup помогает обеспечить соответствие требованиям и более детализированное и гибкое резервное копирование и восстановление.

## <a name="support-matrix"></a>Матрица поддержки

|Поддержка  |Сведения  |
|---------|---------|
|Поддерживаемые развертывания   |  [База данных Azure для PostgreSQL — один сервер](../postgresql/overview.md#azure-database-for-postgresql---single-server)     |
|Поддерживаемые регионы Azure |  Восточная часть США, Восточная часть США 2, Центральная часть США, Юго-Центральный регион (Запад США), Западная часть США 2, Западная Центральная часть US, Южная Бразилия, Центральная Канада, Северная Европа, Западная Европа, южная часть Соединенного Королевства, западная часть Соединенного Королевства, Центрально-Западная Германия, Северная Швейцария, Западная Швейцария, Восточная Азия, Южная Восточная Азия, Восточная Япония, Западная Япония, Центральная Корея, Южная Корея, Северная Австралия  |
|Поддерживаемые версии Azure PostgreSQL    |   9,5, 9,6, 10, 11      |

## <a name="feature-considerations-and-limitations"></a>Характеристики и ограничения

- Все операции поддерживаются только в портал Azure.
- Рекомендуемый предел для максимального размера базы данных — 400 ГБ.
- Резервное копирование между регионами не поддерживается. Это означает, что вы не сможете создать резервную копию сервера Azure PostgreSQL в хранилище в другом регионе. Аналогичным образом можно восстановить резервную копию на сервер, находящиеся в том же регионе, что и хранилище.
- Во время восстановления восстанавливаются только данные. "Роли" не восстановлены.
- В предварительной версии рекомендуется запускать решение только в тестовой среде.

## <a name="backup-process"></a>Процесс резервного копирования

1. Это решение использует **pg_dump** для создания резервных копий баз данных Azure PostgreSQL.

2. После указания баз данных Azure PostgreSQL, для которых необходимо создать резервную копию, служба проверяет, имеет ли она правильный набор разрешений и доступ для выполнения операции резервного копирования на сервере и в базе данных.

3. Azure Backup выполняет запуск рабочей роли с установленным расширением резервного копирования. Это расширение взаимодействует с сервером postgres.

4. Это расширение состоит из координатора и подключаемого модуля Azure postgres. Хотя координатор отвечает за активацию рабочих процессов для различных операций, таких как Настройка резервного копирования, резервного копирования и восстановления, подключаемый модуль отвечает за фактический поток данных.
  
5. После активации настройки защиты для выбранных баз данных служба резервного копирования настраивает координатор с помощью расписаний резервного копирования и других сведений о политике.

6. В запланированное время координатор взаимодействует с подключаемым модулем и начинает потоковую передачу резервных данных с сервера Postgres с помощью **pg_dump**.

7. Подключаемый модуль отправляет данные непосредственно в хранилище службы архивации, устраняя необходимость в промежуточном расположении. Данные шифруются с помощью ключей, управляемых корпорацией Майкрософт, и хранятся в службе Azure Backup в учетных записях хранения.

8. После завершения передачи данных координатор подтверждает фиксацию в службе резервного копирования.

    ![Процесс резервного копирования](./media/backup-azure-database-postgresql/backup-process.png)

## <a name="configure-backup-on-azure-postgresql-databases"></a>Настройка резервного копирования в базах данных Azure PostgreSQL

Вы можете настроить резервное копирование нескольких баз данных на нескольких серверах Azure PostgreSQL. Убедитесь, что [предварительно необходимые разрешения](#prerequisite-permissions-for-configure-backup-and-restore) , необходимые службе для резервного копирования серверов postgres, уже настроены.

Ниже приведены пошаговые инструкции по настройке резервного копирования в базах данных Azure PostgreSQL с помощью Azure Backup.

1. Начать процесс можно двумя способами:

    1. Перейдите в [](backup-center-overview.md)  ->  **Обзор**  ->  **резервного копирования** центра архивации.

        ![Переход в Центр архивации](./media/backup-azure-database-postgresql/backup-center.png)

        В разделе **инициировать: Настройка резервного копирования** выберите **тип источника** **данных Azure для PostgreSQL**.

        ![В окне Запуск: Настройка резервного копирования выберите тип источника данных.](./media/backup-azure-database-postgresql/initiate-configure-backup.png)

    1. Кроме того, можно напрямую перейти к [](backup-vault-overview.md)  ->  **резервному копированию** резервных хранилищ.

        ![Переход к резервным хранилищам](./media/backup-azure-database-postgresql/backup-vaults.png)

        ![Выбор резервной копии в хранилище службы архивации](./media/backup-azure-database-postgresql/backup-backup-vault.png)

1. В разделе **Настройка резервного копирования** выберите Резервное **хранилище** , в которое необходимо создать резервные копии баз данных postgres. Эти сведения предварительно заполнены, если вы уже находитесь в контексте хранилища.

    ![Выбор хранилища архивации в окне настройки резервного копирования](./media/backup-azure-database-postgresql/configure-backup.png)

1. Выберите или создайте **политику архивации**.

    ![Выбор политики архивации](./media/backup-azure-database-postgresql/backup-policy.png)

1. Выберите ресурсы или базы данных postgres для резервного копирования.

    ![Выберите ресурсы для резервного копирования](./media/backup-azure-database-postgresql/select-resources.png)

1. Вы можете выбрать один из списка всех серверов Azure PostgreSQL в подписках, если они находятся в том же регионе, что и хранилище. Разверните стрелку, чтобы просмотреть список баз данных на сервере.

    ![Выбор серверов](./media/backup-azure-database-postgresql/choose-servers.png)

1. Служба выполняет эти проверки в выбранных базах данных, чтобы проверить наличие у хранилища разрешений на резервное копирование выбранных серверов и баз данных postgres.
    1. Чтобы продолжить, **готовность к резервному копированию** для всех баз данных должна считаться **успешным** .
    1. Если возникает ошибка, **исправьте** ошибку и повторно **Проверьте** или удалите базу данных из выбора.

    ![Ошибки проверки для исправления](./media/backup-azure-database-postgresql/validation-errors.png)

1. Подтвердите все сведения в разделе **Обзор и настройка** и выберите **Настройка архивации** , чтобы отправить операцию.

    ![Подтверждение сведений в обзоре и настройке](./media/backup-azure-database-postgresql/review-and-configure.png)

1. После запуска операция **настройки резервного копирования** создаст экземпляр резервной копии. Состояние операции можно отвести на панели [экземпляры резервного копирования](backup-center-monitor-operate.md#backup-instances) в представлении резервного копирования или хранилища.

    ![Экземпляры резервных копий](./media/backup-azure-database-postgresql/backup-instances.png)

1. Резервные копии запускаются в соответствии с расписанием резервного копирования, определенным в политике. Задания можно контролировать в разделе [задания резервного копирования](backup-center-monitor-operate.md#backup-jobs). В настоящее время задания можно просматривать за последние семь дней.

    ![Задания резервного копирования](./media/backup-azure-database-postgresql/backup-jobs.png)

## <a name="create-backup-policy"></a>Создание политики архивации

1. Перейдите в раздел  ->  **политики резервного копирования** центра архивации  ->  **Добавить**. Кроме того, можно воспользоваться политикой резервного копирования **резервного хранилища**  ->    ->  **Добавить**.

    ![Добавить политику архивации](./media/backup-azure-database-postgresql/add-backup-policy.png)

1. Введите **имя** новой политики.

    ![Введите имя политики](./media/backup-azure-database-postgresql/enter-policy-name.png)

1. Определите расписание резервного копирования. В настоящее время поддерживается **еженедельное** резервное копирование. Резервные копии можно запланировать на один или несколько дней недели.

    ![Определение расписания резервного копирования](./media/backup-azure-database-postgresql/define-backup-schedule.png)

1. Определите параметры **хранения** . Можно добавить одно или несколько правил хранения. Каждое правило хранения предполагает входные данные для конкретных резервных копий, хранилище данных и длительность хранения для этих резервных копий.

1. Резервные копии можно хранить в одном из двух хранилищ данных (или на уровнях): **хранилище данных резервных копий** (уровень Standard) или **архивное хранилище данных** (Предварительная версия). Можно выбрать один из **двух вариантов уровней** , чтобы определить, когда резервные копии распределены по двум хранилищам данных:

    - Выберите вариант **немедленного** копирования, если вы предпочитаете хранить резервную копию одновременно в резервных копиях и архивных хранилищах данных.
    - Если вы предпочитаете переместить резервную копию в архив хранилища данных по истечении срока действия в хранилище данных резервного копирования, выберите **срок действия** .

1. **Правило хранения по умолчанию** применяется при отсутствии какого-либо другого правила хранения и имеет значение по умолчанию, равное трем месяцам.

    - Срок хранения в диапазоне от семи до 10 лет в **хранилище данных резервных копий**.
    - Продолжительность хранения в диапазоне от шести месяцев до 10 лет в **архивном хранилище данных**.

    ![Изменить длительность хранения](./media/backup-azure-database-postgresql/edit-retention.png)

>[!NOTE]
>Правила хранения оцениваются в заранее определенном порядке приоритета. Приоритет имеет наибольшее значение для **ежегодного** правила, за которым следует **ежемесячное** и **еженедельное** правило. Параметры хранения по умолчанию применяются, если не определены другие правила. Например, одной и той же точкой восстановления может быть Первая успешная резервная копия, созданная каждую неделю, а также Первая успешная резервная копия, созданная каждый месяц. Однако, поскольку приоритет ежемесячного правила выше, чем в еженедельном правиле, применяется сохранение, соответствующее первой успешной резервной копии, созданной каждый месяц.

## <a name="restore"></a>Восстановить

Вы можете восстановить базу данных на любой сервер Azure PostgreSQL в той же подписке, если служба имеет соответствующий набор разрешений на целевом сервере. Убедитесь, что [предварительно необходимые разрешения](#prerequisite-permissions-for-configure-backup-and-restore) , необходимые службе для резервного копирования серверов postgres, уже настроены.

Выполните это пошаговое руководство, чтобы запустить восстановление.

1. Процесс восстановления можно запустить двумя способами:
    1. Перейдите в раздел Обзор [центра архивации](backup-center-overview.md)  ->    ->  **Восстановление**.

    ![Выбор восстановления в центре архивации](./media/backup-azure-database-postgresql/backup-center-restore.png)

    В разделе **initiate: Restore** выберите **Тип DataSource** в качестве **базы данных Azure для PostgreSQL**. Выберите **экземпляр резервной копии**.

    ![Выберите тип источника данных в окне инициировать: RESTORE](./media/backup-azure-database-postgresql/initiate-restore.png)

    1. Кроме того, можно напрямую перейти к   ->  **экземплярам резервной копии** хранилища службы архивации. Выберите **экземпляр резервной копии** , соответствующий базе данных, которую необходимо восстановить.

    ![Экземпляры резервного копирования для восстановления](./media/backup-azure-database-postgresql/backup-instances-restore.png)

    ![Список экземпляров резервных копий](./media/backup-azure-database-postgresql/list-backup-instances.png)

    ![Выбор "Восстановить"](./media/backup-azure-database-postgresql/select-restore.png)

1. **Выберите пункт точка восстановления** из списка всех доступных полных резервных копий для выбранного экземпляра резервной копии. По умолчанию выбрана последняя точка восстановления.

    ![Выбор точки восстановления](./media/backup-azure-database-postgresql/select-recovery-point.png)

    ![Список точек восстановления](./media/backup-azure-database-postgresql/list-recovery-points.png)

1. Входные **Параметры восстановления**. На этом этапе можно выбрать один из двух типов **восстановления: восстановить как базу данных** и **восстановить как файлы**.

1. **Восстановить как базу данных**. Восстановите данные резервной копии, чтобы создать новую базу данных на целевом сервере PostgreSQL.

    - Целевой сервер может совпадать с исходным сервером. Однако перезапись исходной базы данных не поддерживается.
    - Можно выбрать сервер для всех подписок, но в том же регионе, что и хранилище.
    - Выберите **Проверка и восстановление**. Это приведет к активации проверки для проверки наличия у службы соответствующих разрешений на восстановление на целевом сервере.

    ![Восстановить как базу данных](./media/backup-azure-database-postgresql/restore-as-database.png)

1. **Восстановить как файлы**. Выведите дамп файлов резервной копии в целевую учетную запись хранения (BLOB-объекты).

    - Вы можете выбрать одну из учетных записей хранения во всех подписках, но в том же регионе, что и хранилище.
    - Выберите целевой контейнер из списка контейнеров, отфильтрованный для выбранной учетной записи хранения.
    - Выберите **Проверка и восстановление**. Это приведет к активации проверки для проверки наличия у службы соответствующих разрешений на восстановление на целевом сервере.

    ![Восстановление в виде файлов](./media/backup-azure-database-postgresql/restore-as-files.png)

1. Проверьте сведения и нажмите кнопку **восстановить**. Это приведет к запуску соответствующего задания восстановления, которое можно отвести в рамках **заданий резервного копирования**.

## <a name="prerequisite-permissions-for-configure-backup-and-restore"></a>Необходимые разрешения для настройки резервного копирования и восстановления

Azure Backup следовать строгим рекомендациям по безопасности. Несмотря на то, что это собственная служба Azure, разрешения на ресурс не предполагаются и должны быть явно предоставлены пользователем.  Аналогично, учетные данные для подключения к базе данных не сохраняются. Это важно для защиты данных. Вместо этого мы используем Azure Active Directoryную проверку подлинности.

[Загрузите этот документ](https://download.microsoft.com/download/7/4/d/74d689aa-909d-4d3e-9b18-f8e465a7ebf5/OSSbkpprep_automated.docx) , чтобы получить автоматизированный сценарий и соответствующие инструкции. Он предоставит соответствующий набор разрешений на сервер Azure PostgreSQL для резервного копирования и восстановления.

## <a name="manage-the-backed-up-azure-postgresql-databases"></a>Управление резервными копиями баз данных Azure PostgreSQL

Это операции управления, которые можно выполнять с **экземплярами резервных копий**:

### <a name="on-demand-backup"></a>Резервное копирование по запросу

Чтобы активировать резервное копирование не в расписании, указанном в политике, перейдите к резервному копированию **экземпляров**  ->  **сейчас**.
Выберите из списка правил хранения, определенных в связанной политике резервного копирования.

![Активировать резервное копирование сейчас](./media/backup-azure-database-postgresql/backup-now.png)

![Выбрать из списка правил хранения](./media/backup-azure-database-postgresql/retention-rules.png)

### <a name="stop-protection"></a>Остановить защиту

Вы можете отключить защиту для элемента резервного копирования. При этом также будут удалены связанные точки восстановления для этого элемента резервного копирования. Мы пока не предоставляем параметр "отключить защиту", сохраняя существующие точки восстановления.

![Остановить защиту](./media/backup-azure-database-postgresql/stop-protection.png)

### <a name="change-policy"></a>Изменение политики

Связанную политику можно изменить с помощью экземпляра резервной копии.

1. Выберите политику **изменения экземпляра резервной копии**  ->  .

    ![Изменение политики](./media/backup-azure-database-postgresql/change-policy.png)

1. Выберите новую политику, которую вы хотите применить к базе данных.

    ![Переназначить политику](./media/backup-azure-database-postgresql/reassign-policy.png)

## <a name="troubleshooting"></a>Устранение неполадок

В этом разделе содержатся сведения об устранении неполадок при резервном копировании баз данных PostgreSQL Azure с помощью Azure Backup.

### <a name="usererrormsimissingpermissions"></a>усереррормсимиссингпермиссионс

Предоставьте программе архивации MSI доступ на **Чтение** на сервере PG, для которого требуется выполнить резервное копирование или восстановление:

Чтобы установить безопасное подключение к базе данных PostgreSQL, Azure Backup использует модель проверки подлинности [управляемое удостоверение службы (MSI)](../active-directory/managed-identities-azure-resources/overview.md) . Это означает, что хранилище службы архивации будет иметь доступ только к тем ресурсам, которым пользователь явно предоставил разрешение.

Системный MSI-файл автоматически назначается хранилищу во время его создания. Необходимо предоставить этому MSI для хранилища доступ к серверам PostgreSQL, с которых планируется выполнять резервное копирование баз данных.

Шаги:

1. На сервере postgres перейдите на панель **управления доступом (IAM)** .

    ![Панель управления доступом](./media/backup-azure-database-postgresql/access-control-pane.png)

1. Выберите **добавить назначение ролей**.

    ![Добавление назначения роли](./media/backup-azure-database-postgresql/add-role-assignment.png)

1. В открывшейся правой области контекста введите следующее:<br>

    **Роль:** Сканер<br>
    **Назначение доступа к:** Выбор **хранилища архивации**<br>
    Если в раскрывающемся списке не удается найти **хранилище архивации** , выберите **параметр пользователь, группа или субъект-служба в Azure AD** .<br>

    ![Выберите должность](./media/backup-azure-database-postgresql/select-role.png)

    **Выберите:** Введите имя резервного хранилища, для которого требуется создать резервную копию этого сервера и его баз данных.<br>

    ![Введите имя хранилища службы архивации](./media/backup-azure-database-postgresql/enter-backup-vault-name.png)

### <a name="usererrorbackupuserauthfailed"></a>усереррорбаккупусераусфаилед

Создайте пользователя резервной копии базы данных, который может выполнять проверку подлинности с помощью Azure Active Directory:

Эта ошибка может возникать из-за отсутствия Azure Active Directory администратора сервера PostgreSQL или отсутствия пользователя резервного копирования, который может проходить проверку подлинности с помощью Azure Active Directory.

Шаги:

Добавьте администратора Active Directory на сервер OSS:

Этот шаг необходим для подключения к базе данных с помощью пользователя, который может выполнять проверку подлинности Azure Active Directory вместо пароля. Роль пользователя "Администратор Azure AD в базе данных Azure для PostgreSQL" будет **azure_ad_admin**. Только роль **azure_ad_admin** может создавать новых пользователей базы данных, которые могут проходить проверку подлинности в Azure AD.

1. Перейдите на вкладку Администратор Active Directory в области навигации слева в представлении сервера и добавьте себя (или другого пользователя) в качестве администратора Active Directory.

    ![Настройка Active Directory администратора](./media/backup-azure-database-postgresql/set-admin.png)

1. Не забудьте **сохранить** параметр пользователя "администратор AD".

    ![Сохранить Active Directory параметр пользователя администратора](./media/backup-azure-database-postgresql/save-admin-setting.png)

В [этом документе](https://download.microsoft.com/download/7/4/d/74d689aa-909d-4d3e-9b18-f8e465a7ebf5/OSSbkpprep_automated.docx) содержится список шагов, которые необходимо выполнить для выполнения шагов по предоставлению разрешений.

### <a name="usererrormissingnetworksecuritypermissions"></a>усереррормиссингнетворксекуритипермиссионс

Установите сетевую сеть анализа, включив флаг **Разрешить доступ к службам Azure** в представлении сервера. В представлении "сервер" в области " **Безопасность подключения** " установите для флага **Разрешить доступ к службам Azure** значение **Да**.

![Разрешение доступа службам Azure](./media/backup-azure-database-postgresql/allow-access-to-azure-services.png)

### <a name="usererrorcontainernotaccessible"></a>усереррорконтаинернотакцессибле

#### <a name="permission-to-restore-to-a-storage-account-container-when-restoring-as-files"></a>Разрешение на восстановление в контейнере учетной записи хранения при восстановлении в виде файлов

1. Предоставьте MSI для хранилища службы архивации разрешение на доступ к контейнерам учетной записи хранения с помощью портал Azure.
    1. Последовательно выберите Управление доступом к **учетной записи хранения**  ->    ->  **добавить назначение ролей**.
    1. Назначение роли **участника данных BLOB-объекта хранилища** для MSI-файла хранилища службы архивации.

    ![Назначение роли участника данных BLOB-объекта хранилища](./media/backup-azure-database-postgresql/assign-storage-blog-data-contributor-role.png)

1. Кроме того, предоставьте детализированные разрешения для конкретного восстанавливаемого контейнера с помощью команды Azure CLI [AZ Role назначение Create](/cli/azure/role/assignment) .

    ```azurecli
    az role assignment create --assignee $VaultMSI_AppId  --role "Storage Blob Data Contributor"   --scope $id
    ```

    1. Замените параметр уполномоченного **идентификатором приложения** MSI хранилища и параметром области, чтобы он ссылался на конкретный контейнер.
    1. Чтобы получить **идентификатор приложения** MSI хранилища, выберите **все приложения** в разделе **Тип приложения**:

        ![Выбрать все приложения](./media/backup-azure-database-postgresql/select-all-applications.png)

    1. Найдите имя хранилища и скопируйте идентификатор приложения:

        ![Поиск имени хранилища](./media/backup-azure-database-postgresql/search-for-vault-name.png)

## <a name="next-steps"></a>Следующие шаги

- [Общие сведения о резервных хранилищах](backup-vault-overview.md)