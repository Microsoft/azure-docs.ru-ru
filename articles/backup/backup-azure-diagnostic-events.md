---
title: Использование параметров диагностики для хранилищ служб восстановления
description: В этой статье описывается, как использовать старые и новые события диагностики для Azure Backup.
ms.topic: conceptual
ms.date: 10/30/2019
ms.openlocfilehash: b2130f06e17dd2b5cf8461d4e58342ee41c14f96
ms.sourcegitcommit: 867cb1b7a1f3a1f0b427282c648d411d0ca4f81f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "100575412"
---
# <a name="use-diagnostics-settings-for-recovery-services-vaults"></a>Использование параметров диагностики для хранилищ служб восстановления

Azure Backup отправляет диагностические события, которые можно собирать и использовать в целях анализа, оповещения и создания отчетов.

Вы можете настроить параметры диагностики для хранилища служб восстановления с помощью портал Azure, перейдя в хранилище и выбрав **параметры диагностики**. Выбор **+ Добавить параметр диагностики** позволяет отправить одно или несколько событий диагностики в учетную запись хранения, концентратор событий или рабочую область log Analytics.

![Панель параметров диагностики](./media/backup-azure-diagnostics-events/diagnostics-settings-blade.png)

## <a name="diagnostics-events-available-for-azure-backup-users"></a>События диагностики, доступные для пользователей Azure Backup

Azure Backup предоставляет следующие диагностические события. Каждое событие предоставляет подробные данные о конкретном наборе артефактов, связанных с резервным копированием:

* кореазуребаккуп
* AddonAzureBackupAlerts
* AddonAzureBackupProtectedInstance
* AddonAzureBackupJobs
* аддоназуребаккупполици
* AddonAzureBackupStorage

Если вы по-прежнему используете [устаревшие события](#legacy-event) установите azurebackupreport, мы рекомендуем переключиться на использование приведенных выше событий.

Дополнительные сведения см. в разделе [модель данных для событий диагностики Azure Backup](./backup-azure-reports-data-model.md).

Данные для этих событий можно отправлять в учетную запись хранения, рабочую область Log Analytics или концентратор событий. Если вы отправляете эти данные в Log Analytics рабочую область, выберите переключатель для **определенного ресурса** на экране **параметры диагностики** . Дополнительные сведения приведены в следующем разделе.

## <a name="use-diagnostics-settings-with-log-analytics"></a>Использование параметров диагностики с Log Analytics

Теперь можно использовать Azure Backup для отправки данных диагностики хранилища в выделенные Log Analytics таблицы для резервного копирования. Эти таблицы называются [таблицами, зависящими от ресурсов](../azure-monitor/essentials/resource-logs.md#send-to-log-analytics-workspace).

Чтобы отправить данные диагностики хранилища в Log Analytics:

1. Перейдите в хранилище и выберите **параметры диагностики**. Выберите **+ Добавить параметр диагностики**.
1. Присвойте имя параметру диагностики.
1. Установите флажок **отправить на log Analytics** и выберите log Analytics рабочую область.
1. Выберите **ресурс определенные** в переключателе и выберите следующие шесть событий: **кореазуребаккуп**, **аддоназуребаккупжобс**, **аддоназуребаккупалертс**, **аддоназуребаккупполици**, **AddonAzureBackupStorage** и **AddonAzureBackupProtectedInstance**.
1. Щелкните **Сохранить**.

   ![Режим, зависящий от ресурса](./media/backup-azure-diagnostics-events/resource-specific-blade.png)

После передачи данных в рабочую область Log Analytics в рабочей области создаются выделенные таблицы для каждого из этих событий. Можно выполнить запрос к любой из этих таблиц напрямую. При необходимости можно также выполнять объединения или объединения между этими таблицами.

> [!IMPORTANT]
> Шесть событий, а именно, Кореазуребаккуп, Аддоназуребаккупжобс, Аддоназуребаккупалертс, Аддоназуребаккупполици, AddonAzureBackupStorage и AddonAzureBackupProtectedInstance, поддерживаются *только* в режиме конкретного ресурса в [отчетах о резервном копировании](./configure-reports.md). *При попытке отправить данные для этих шести событий в режиме диагностики Azure данные в отчетах по резервному копированию отображаться не будут.*

## <a name="legacy-event"></a>Устаревшее событие

Обычно все данные диагностики для хранилища, связанные с резервным копированием, содержатся в одном событии с именем установите azurebackupreport. Шесть описанных здесь событий по сути являются декомпозицией всех данных, содержащихся в установите azurebackupreport.

В настоящее время мы продолжаем поддерживать событие установите azurebackupreport для обратной совместимости в случаях, когда у пользователей есть пользовательские запросы к этому событию. Примерами могут быть пользовательские оповещения журнала и пользовательские визуализации. *Рекомендуется как можно раньше перейти к [новым событиям](#diagnostics-events-available-for-azure-backup-users)*. Новые события:

* Упрощение работы с данными в запросах журналов.
* Обеспечение более эффективного обнаружения схем и их структуры.
* Повышение производительности как задержки приема, так и времени выполнения запросов.

*Устаревшее событие в режиме диагностики Azure в конечном итоге будет устаревшим. Выбор новых событий может помочь избежать сложных миграций позднее*. Наше [решение для создания отчетов](./configure-reports.md) , использующее log Analytics, также останавливает поддержку данных из устаревшего события.

### <a name="steps-to-move-to-new-diagnostics-settings-for-a-log-analytics-workspace"></a>Шаги для перехода к новым параметрам диагностики для Log Analytics рабочей области

1. Выясните, какие хранилища отправляют данные в Log Analytics рабочие области с помощью устаревшего события и подписок, к которым они относятся. Выполните следующий запрос в каждой рабочей области, чтобы найти эти хранилища и подписки.

    ````Kusto
    let RangeStart = startofday(ago(3d));
    let VaultUnderAzureDiagnostics = (){
        AzureDiagnostics
        | where TimeGenerated >= RangeStart | where Category == "AzureBackupReport" and OperationName == "Vault" and SchemaVersion_s == "V2"
        | summarize arg_max(TimeGenerated, *) by ResourceId
        | project ResourceId, Category};
    let VaultUnderResourceSpecific = (){
        CoreAzureBackup
        | where TimeGenerated >= RangeStart | where OperationName == "Vault"
        | summarize arg_max(TimeGenerated, *) by ResourceId
        | project ResourceId, Category};
        // Some Workspaces will not have AzureDiagnostics Table, so you need to use isFuzzy
    let CombinedVaultTable = (){
        union isfuzzy = true
        (VaultUnderAzureDiagnostics() ),
        (VaultUnderResourceSpecific() )
        | distinct ResourceId, Category};
    CombinedVaultTable | where Category == "AzureBackupReport"
    | join kind = leftanti (
    CombinedVaultTable | where Category == "CoreAzureBackup"
    ) on ResourceId
    | parse ResourceId with * "SUBSCRIPTIONS/" SubscriptionId:string "/RESOURCEGROUPS" * "MICROSOFT.RECOVERYSERVICES/VAULTS/" VaultName:string
    | project ResourceId, SubscriptionId, VaultName
    ````

    Ниже приведен снимок экрана запроса, выполняемого в одной из рабочих областей:

    ![Запрос рабочей области](./media/backup-azure-diagnostics-events/workspace-query.png)

2. Используйте [встроенные определения политик Azure](./azure-policy-configure-diagnostics.md) в Azure Backup, чтобы добавить новый параметр диагностики для всех хранилищ в указанной области. Эта политика добавляет новый параметр диагностики в хранилищах, для которых не задан параметр диагностики или установлен параметр диагностики только для прежних версий. Эта политика может быть назначена всей подписке или группе ресурсов за раз. Необходимо иметь доступ владельца к каждой подписке, для которой назначена политика.

Вы можете выбрать отдельные параметры диагностики для установите azurebackupreport и шесть новых событий, пока не перенесены все пользовательские запросы на использование данных из новых таблиц. На следующем рисунке показан пример хранилища с двумя параметрами диагностики. Первый параметр с именем **Setting1** отправляет данные о событии установите azurebackupreport в рабочую область log Analytics в режиме диагностики Azure. Второй параметр с именем **Setting2** отправляет данные из шести новых событий Azure Backup в log Analytics рабочую область в режиме, характерном для ресурса.

![Два параметра](./media/backup-azure-diagnostics-events/two-settings-example.png)

> [!IMPORTANT]
> Событие установите azurebackupreport поддерживается *только* в режиме диагностики Azure. *При попытке отправить данные для этого события в режиме, определенном для ресурса, данные не будут передаваться в рабочую область Log Analytics.*

> [!NOTE]
> Переключатель для **диагностики Azure** или для **конкретного ресурса** отображается только в том случае, если пользователь выбрал **Send to log Analytics**. Чтобы отправить данные в учетную запись хранения или концентратор событий, пользователь выбирает требуемое назначение и устанавливает флажки для всех требуемых событий без дополнительных входов. Опять же, не рекомендуется выбирать устаревшие события установите azurebackupreport.

## <a name="send-azure-site-recovery-events-to-log-analytics"></a>Отправка Azure Site Recovery событий в Log Analytics

События Azure Backup и Azure Site Recovery отправляются из одного хранилища служб восстановления. Azure Site Recovery в настоящее время недоступна для таблиц, связанных с ресурсами. Пользователи, которые хотят отправлять события Azure Site Recovery в Log Analytics, направляются на использование *только* режима диагностики Azure, как показано на рисунке. *Выбор режима, относящегося к ресурсу для Azure Site Recovery событий, помешает отправке необходимых данных в рабочую область log Analytics*.

![События Site Recovery](./media/backup-azure-diagnostics-events/site-recovery-settings.png)

Подведение итогов.

* Если вы уже настроили Log Analyticsную диагностику с система диагностики Azure и записали пользовательские запросы поверх него, не заполняйте этот параметр до тех пор, *пока не будут* перенесены запросы на использование данных из новых событий.
* Если вы также хотите подключить новые таблицы, как мы рекомендуем, создайте **Новый** параметр диагностики, выберите " **ресурс зависит**" и выберите шесть новых событий.
* Если вы отправляете Azure Site Recovery события в Log Analytics, *не* выбирайте для этих событий режим, зависящий от конкретного ресурса. В противном случае данные для этих событий не будут передаваться в рабочую область Log Analytics. Вместо этого создайте дополнительный параметр диагностики, выберите пункт система **диагностики Azure** и выберите соответствующие события Azure Site Recovery.

На следующем рисунке показан пример пользователя с тремя параметрами диагностики для хранилища. Первый параметр с именем **Setting1** отправляет данные из события установите azurebackupreport в рабочую область log Analytics в режиме диагностики Azure. Второй параметр с именем **Setting2** отправляет данные из шести новых событий Azure Backup в log Analytics рабочую область в режиме, характерном для ресурса. Третий параметр с именем **Setting3** отправляет данные из событий Azure Site Recovery в рабочую область log Analytics в режиме диагностики Azure.

![Три параметра](./media/backup-azure-diagnostics-events/three-settings-example.png)

## <a name="next-steps"></a>Дальнейшие действия

[Изучение модели данных Log Analytics для событий диагностики](./backup-azure-reports-data-model.md)
