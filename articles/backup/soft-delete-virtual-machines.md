---
title: Обратимое удаление виртуальных машин
description: Узнайте, как обратимое удаление виртуальных машин делает резервные копии более безопасными.
ms.topic: conceptual
ms.date: 04/30/2020
ms.custom: references_regions
ms.openlocfilehash: a8b70d4c8240d096c19e5a8d7449921557b8896c
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "89022247"
---
# <a name="soft-delete-for-virtual-machines"></a>Обратимое удаление виртуальных машин

Обратимое удаление для виртуальных машин защищает резервные копии виртуальных машин от непреднамеренного удаления. Даже после удаления резервных копий они сохраняются в состоянии обратимого удаления в течение 14 дополнительных дней.

> [!NOTE]
> Обратимое удаление защищает только удаленные данные резервных копий. Если виртуальная машина удаляется без резервной копии, функция обратимого удаления не сохранит данные. Для обеспечения полной устойчивости все ресурсы должны быть защищены с помощью Azure Backup.
>

## <a name="supported-regions"></a>Поддерживаемые регионы

Обратимое удаление сейчас поддерживается в западной центральной части США, Восточная Азия, Центральная Канада, Восточная Канада, Центральная Франция, Южная Франция, Центральная Корея, Южная Корея, южная часть Соединенного Королевства, западная часть Соединенного Королевства, Восточная Австралия, Юго-Восточная Австралия, Северная Европа, Западная часть США, Запад США 2, Центральная часть США, юго-запад, Северо-центральный регион США, Юго Восточная Азия-Центральный регион , Северная Швейцария, Западная Швейцария, Западная Норвегия, Восточная Норвежская и все национальные регионы.

## <a name="soft-delete-for-vms-using-azure-portal"></a>Обратимое удаление для виртуальных машин с помощью портал Azure

1. Чтобы удалить данные резервной копии виртуальной машины, необходимо остановить резервное копирование. В портал Azure перейдите к хранилищу служб восстановления, щелкните правой кнопкой мыши элемент резервного копирования и выберите пункт **прерывать резервное копирование**.

   ![Снимок экрана: портал Azure элементы резервного копирования](./media/backup-azure-security-feature-cloud/backup-stopped.png)

2. В следующем окне вы получите возможность удалить или хранить данные резервной копии. Если выбрать вариант **удалить данные архивации** , а затем **отменить резервное копирование**, резервная копия виртуальной машины не будет окончательно удалена. Вместо этого данные резервного копирования будут храниться в течение 14 дней в состоянии обратимого удаления. Если выбран параметр **удалить данные резервной копии** , в настроенный идентификатор электронной почты отправляется оповещение об удалении по электронной почте, информирующее пользователя о том, что срок хранения данных резервной копии остается за 14 дней. Кроме того, в 12-й день отправляется оповещение по электронной почте о том, что для восстановлении удаленных данных осталось еще два дня. Удаление откладывается до 15-го дня, когда произойдет постоянное удаление и будет отправлено итоговое оповещение по электронной почте, информирующее об окончательном удалении данных.

   ![Снимок экрана портал Azure, окно завершения резервного копирования](./media/backup-azure-security-feature-cloud/delete-backup-data.png)

3. В течение 14 дней в хранилище служб восстановления обратимо Удаленная виртуальная машина появится рядом с красным значком "обратимое удаление".

   ![Снимок экрана портал Azure, виртуальная машина в состоянии обратимого удаления](./media/backup-azure-security-feature-cloud/vm-soft-delete.png)

   > [!NOTE]
   > Если в хранилище имеются обратимо удаленные элементы резервного копирования, хранилище нельзя будет удалить в это время. Попробуйте удалить хранилище после окончательного удаления архивных элементов, после чего в хранилище не останется элементов с обратимым удалением.

4. Чтобы восстановить обратимо удаленную виртуальную машину, необходимо сначала отменить ее удаление. Чтобы отменить удаление, выберите обратимо удаленную виртуальную машину, а затем выберите пункт **Удалить**.

   ![Снимок экрана портал Azure, отменить удаление виртуальной машины](./media/backup-azure-security-feature-cloud/choose-undelete.png)

   Появится окно с предупреждением о том, что при выборе отменить удаление все точки восстановления для виртуальной машины будут удалены и доступны для выполнения операции восстановления. Виртуальная машина будет храниться в состоянии "остановить защиту с сохранением данных" с приостановленными резервными копиями и хранением данных резервного копирования без учета политики резервного копирования.

   ![Снимок экрана портал Azure, подтверждение отмены удаления виртуальной машины](./media/backup-azure-security-feature-cloud/undelete-vm.png)

   На этом этапе можно также восстановить виртуальную машину, выбрав пункт **восстановить виртуальную машину** из выбранной точки восстановления.  

   ![Снимок экрана: параметр портал Azure, восстановление виртуальной машины](./media/backup-azure-security-feature-cloud/restore-vm.png)

   > [!NOTE]
   > Сборщик мусора будет работать и очищать точки восстановления с истекшим сроком только после того, как пользователь выполнит операцию **возобновления резервного копирования** .

5. После завершения процесса отмены удаления будет возвращено состояние "прерывать резервное копирование с помощью удержания данных", после чего можно выбрать **возобновить резервное копирование**. Операция **возобновления** резервного копирования возвращает резервную копию в активном состоянии, связанную с политикой резервного копирования, выбранной пользователем, определяющей расписания резервного копирования и хранения.

   ![Снимок экрана: параметр портал Azure, возобновить резервное копирование](./media/backup-azure-security-feature-cloud/resume-backup.png)

## <a name="soft-delete-for-vms-using-azure-powershell"></a>Обратимое удаление для виртуальных машин с помощью Azure PowerShell

> [!IMPORTANT]
> Версия AZ. RecoveryServices, необходимая для использования обратимого удаления с помощью Azure PowerShell, является минимальной 2.2.0. Используйте ```Install-Module -Name Az.RecoveryServices -Force``` для получения последней версии.

Как описано выше для портал Azure, последовательность шагов при использовании Azure PowerShell также одинакова.

### <a name="delete-the-backup-item-using-azure-powershell"></a>Удаление элемента резервного копирования с помощью Azure PowerShell

Удалите элемент резервного копирования с помощью командлета PowerShell [Disable-азрековерисервицесбаккуппротектион](/powershell/module/az.recoveryservices/disable-azrecoveryservicesbackupprotection) .

```powershell
Disable-AzRecoveryServicesBackupProtection -Item $myBkpItem -RemoveRecoveryPoints -VaultId $myVaultID -Force

WorkloadName     Operation            Status               StartTime                 EndTime                   JobID
------------     ---------            ------               ---------                 -------                   -----
AppVM1           DeleteBackupData     Completed            12/5/2019 12:44:15 PM     12/5/2019 12:44:50 PM     0488c3c2-accc-4a91-a1e0-fba09a67d2fb
```

Значение "Делетестате" элемента резервного копирования изменится с "Нотделетед" на "Тобеделетед". Данные резервной копии будут храниться в течение 14 дней. Если вы хотите отменить операцию удаления, необходимо выполнить отмену-удаление.

### <a name="undoing-the-deletion-operation-using-azure-powershell"></a>Отмена операции удаления с помощью Azure PowerShell

Сначала извлеките соответствующий элемент резервного копирования, который находится в состоянии обратимого удаления (то есть удаляется).

```powershell

Get-AzRecoveryServicesBackupItem -BackupManagementType AzureVM -WorkloadType AzureVM -VaultId $myVaultID | Where-Object {$_.DeleteState -eq "ToBeDeleted"}

Name                                     ContainerType        ContainerUniqueName                      WorkloadType         ProtectionStatus     HealthStatus         DeleteState
----                                     -------------        -------------------                      ------------         ----------------     ------------         -----------
VM;iaasvmcontainerv2;selfhostrg;AppVM1    AzureVM             iaasvmcontainerv2;selfhostrg;AppVM1       AzureVM              Healthy              Passed               ToBeDeleted

$myBkpItem = Get-AzRecoveryServicesBackupItem -BackupManagementType AzureVM -WorkloadType AzureVM -VaultId $myVaultID -Name AppVM1
```

Затем выполните операцию отмены удаления с помощью командлета PowerShell [Undo-азрековерисервицесбаккупитемделетион](/powershell/module/az.recoveryservices/undo-azrecoveryservicesbackupitemdeletion) .

```powershell
Undo-AzRecoveryServicesBackupItemDeletion -Item $myBKpItem -VaultId $myVaultID -Force

WorkloadName     Operation            Status               StartTime                 EndTime                   JobID
------------     ---------            ------               ---------                 -------                   -----
AppVM1           Undelete             Completed            12/5/2019 12:47:28 PM     12/5/2019 12:47:40 PM     65311982-3755-46b5-8e53-c82ea4f0d2a2
```

Значение "Делетестате" элемента резервного копирования будет возвращено к "Нотделетед". Но защита по-прежнему останавливается. [Возобновите резервное копирование](./backup-azure-vms-automation.md#change-policy-for-backup-items) , чтобы снова включить защиту.

## <a name="soft-delete-for-vms-using-rest-api"></a>Обратимое удаление для виртуальных машин с помощью REST API

- Удалите резервные копии с помощью REST API, как описано [здесь](backup-azure-arm-userestapi-backupazurevms.md#stop-protection-and-delete-data).
- Если вы хотите отменить эти операции удаления, см. действия, описанные [здесь](backup-azure-arm-userestapi-backupazurevms.md#undo-the-deletion).

## <a name="how-to-disable-soft-delete"></a>Как отключить обратимое удаление

Отключение этой функции не рекомендуется. Единственное обстоятельство, когда следует отключать обратимое удаление, — это планирование перемещения защищенных элементов в новое хранилище и не может ждать 14 дней, необходимых перед удалением и повторной защитой (например, в тестовой среде). Инструкции по отключению обратимого удаления см. в разделе [Включение и отключение обратимого удаления](backup-azure-security-feature-cloud.md#enabling-and-disabling-soft-delete).

## <a name="next-steps"></a>Дальнейшие действия

- Ознакомьтесь с [часто задаваемыми вопросами](backup-azure-security-feature-cloud.md#frequently-asked-questions) об обратимом удалении
- Ознакомьтесь со всеми [функциями безопасности в Azure Backup](security-overview.md)
