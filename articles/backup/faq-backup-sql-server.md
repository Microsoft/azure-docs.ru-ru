---
title: Часто задаваемые вопросы о резервном копировании баз данных SQL Server на виртуальных машинах Azure
description: Найдите ответы на часто задаваемые вопросы о резервном копировании SQL Server баз данных на виртуальных машинах Azure с Azure Backup.
ms.reviewer: vijayts
ms.topic: conceptual
ms.date: 04/23/2019
ms.openlocfilehash: ca785e217da4355a44ffbb26b813d55d942c5c14
ms.sourcegitcommit: 910a1a38711966cb171050db245fc3b22abc8c5f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "98787626"
---
# <a name="faq-about-sql-server-databases-that-are-running-on-an-azure-vm-backup"></a>Часто задаваемые вопросы о SQL Server базах данных, работающих в резервной копии виртуальной машины Azure

В этой статье содержатся ответы на часто задаваемые вопросы о резервном копировании SQL Server баз данных, работающих на виртуальных машинах Azure, и использовании службы [Azure Backup](backup-overview.md) .

## <a name="can-i-use-azure-backup-for-iaas-vm-as-well-as-sql-server-on-the-same-machine"></a>Можно ли использовать Azure Backup для виртуальной машины IaaS и SQL Server на том же компьютере?

Да, резервное копирование виртуальных машин и резервное копирование SQL можно выполнять на одной виртуальной машине. В этом случае мы внутренним образом активируем полную резервную копию только для копирования на виртуальной машине, чтобы не усекать журналы.

## <a name="does-the-solution-retry-or-auto-heal-the-backups"></a>Выполняет ли решение повторную попытку или автоматическое восстановление резервных копий?

В некоторых обстоятельствах Azure Backupная служба активирует резервные копии носителей. Автоматическое восстановление может происходить для любого из шести перечисленных ниже условий.

- Если журнал или разностная резервная копия не удается выполнить из-за ошибки проверки номера LSN, следующий журнал или разностная резервная копия преобразуются в полную резервную копию.
- Если полная резервная копия не была создана до создания журнала или разностной резервной копии, то этот журнал или разностная резервная копия преобразуется в полную резервную копию.
- Если последняя полная резервная копия на момент времени старше 15 дней, следующий журнал или разностная резервная копия преобразуются в полную резервную копию.
- Все задания резервного копирования, которые будут отменены из-за обновления расширения, повторно активируются после завершения обновления и запуска расширения.
- Если вы решили перезаписать базу данных во время восстановления, произойдет сбой следующей резервной копии журнала или разностного копирования, а затем будет активирована полная резервная копия.
- В случаях, когда требуется полная резервная копия для сброса цепочек журналов из-за изменения в модели восстановления базы данных, полная активация активируется автоматически в следующем расписании.

Автовосстановление в качестве возможности включено для всех пользователей по умолчанию. Однако если вы решили отказаться от него, выполните следующие действия.

- На экземпляре SQL Server в папке *C:\Program Files\azure Multi рабочей нагрузки баккуп\бин* Создайте или измените **ExtensionSettingsOverrides.jsв** файле.
- В **ExtensionSettingsOverrides.jsв** установите *{"енаблеаутохеалер": false}*.
- Сохраните изменения и закройте файл.
- На SQL Server экземпляр откройте **задачу Управление** , а затем перезапустите службу **азуревлбаккупкурдинаторсвк** .

## <a name="can-i-control-how-many-concurrent-backups-run-on-the-sql-server"></a>Можно ли проконтролировать, сколько одновременных операций резервного копирования выполняется на SQL Server?

Да. Вы можете регулировать частоту, с которой выполняется политика резервного копирования, чтобы свести к минимуму влияние на экземпляр SQL Server. Чтобы изменить этот параметр:

1. На экземпляре SQL Server в папке *C:\Program Files\azure Multi рабочей нагрузки баккуп\бин* создайте *ExtensionSettingsOverrides.jsв* файле.
2. В *ExtensionSettingsOverrides.jsв* файле измените значение параметра **дефаултбаккуптаскссрешолд** на меньшее (например, 5). <br>
  `{"DefaultBackupTasksThreshold": 5}`
<br>
Значение по умолчанию для Дефаултбаккуптаскссрешолд — **20**.

3. Сохраните изменения и закройте файл.
4. На экземпляре SQL Server откройте **диспетчер задач**. Перезагрузите службу **AzureWLBackupCoordinatorSvc**.<br/> <br/>
 Хотя этот метод помогает в том, что приложение резервного копирования использует большое количество ресурсов, SQL Server [Resource Governor](/sql/relational-databases/resource-governor/resource-governor) является более универсальным способом указания ограничений на объем ресурсов ЦП, физических операций ввода-вывода и памяти, которые могут использоваться входящими запросами приложения.

> [!NOTE]
> В UX вы по-прежнему можете запланировать столько резервных копий в любое заданное время. Однако они будут обрабатываться в скользящем окне, скажем, 5, в соответствии с приведенным выше примером.

## <a name="can-i-run-a-full-backup-from-a-secondary-replica"></a>Можно ли запустить полное резервное копирование из вторичной реплики?

В соответствии с ограничениями SQL можно запускать только полную резервную копию на вторичной реплике. Однако полное резервное копирование запрещено.

## <a name="can-i-protect-availability-groups-on-premises"></a>Можно ли защитить группы доступности локально?

Нет. Azure Backup защищает базы данных SQL Server, работающие в Azure. Если группа доступности (AG) распределена между Azure и локальными компьютерами, то для нее можно использовать защиту, только если первичная реплика выполняется в Azure. Кроме того, Azure Backup защищает только узлы, работающие в том же регионе Azure, что и хранилище служб восстановления.

## <a name="can-i-protect-availability-groups-across-regions"></a>Можно ли защитить группы доступности в разных регионах?

Хранилище служб восстановления Azure Backup может обнаруживать и защищать все узлы, наявляющиеся в том же регионе, что и хранилище. Если группа доступности SQL Server Always On охватывает несколько регионов Azure, настройте резервное копирование из региона, в котором находится основной узел. Azure Backup может обнаруживать и защищать все базы данных в группе доступности в соответствии с установленным параметром резервного копирования. Если настройка резервного копирования не соблюдается, резервное копирование завершается сбоем и появляется предупреждение о сбое.

## <a name="do-successful-backup-jobs-create-alerts"></a>Отправляются ли оповещения об успешно выполненных заданиях резервного копирования?

Нет. Для успешно выполненных заданий резервного копирования не создаются оповещения. Оповещения отправляются только в случае сбоя. Поведение оповещений портала подробно описано [здесь](backup-azure-monitoring-built-in-monitor.md). Однако если вы заинтересованы в наличии оповещений даже для успешного выполнения заданий, можно использовать [мониторинг с помощью Azure Monitor](backup-azure-monitoring-use-azuremonitor.md).

## <a name="can-i-see-scheduled-backup-jobs-in-the-backup-jobs-menu"></a>Можно ли просмотреть запланированные задания резервного копирования в меню "Задания резервного копирования"?

В меню **Задание резервного копирования** отображаются все запланированные и выполняемые по требованию операции, за исключением запланированных резервных копий журналов, так как они могут быть очень частыми. Для запланированных заданий журнала используйте [мониторинг с помощью Azure Monitor](backup-azure-monitoring-use-azuremonitor.md).

## <a name="are-future-databases-automatically-added-for-backup"></a>Добавляются ли автоматически будущие базы данных в резервное копирование?

Да, эту возможность можно реализовать с помощью [автоматической защиты](backup-sql-server-database-azure-vms.md#enable-auto-protection).  

## <a name="if-i-delete-a-database-from-an-autoprotected-instance-what-will-happen-to-the-backups"></a>Что произойдет с резервным копированием, если удалить базу данных из автоматически защищенного экземпляра?

Если база данных удаляется из автозащищаемого экземпляра, резервные копии базы данных по-прежнему будут пытаться. Это означает, что удаленная база данных начнет отображаться как неработоспособная в разделе **Элементы архивации** и будет по-прежнему обрабатываться как защищенная.

Правильный способ отключения защиты этой базы данных — **Отключить резервное копирование** с **удалением данных** в этой базе данных.  

## <a name="if-i-do-stop-backup-operation-of-an-autoprotected-database-what-will-be-its-behavior"></a>Что будет поведению при выполнении резервного копирования базы данных с автозащитой?

Если вы **останавливаете резервное копирование с сохранением данных**, дальнейшие резервные копии не будут выполняться, а существующие точки восстановления останутся без изменений. База данных по-прежнему будет рассматриваться как защищенная и должна отображаться в **архивных элементах**.

Если вы **останавливаете резервное копирование с удалением данных**, последующие резервные копии не будут выполняться, а существующие точки восстановления также будут удалены. База данных будет считаться незащищенной и будет отображаться в экземпляре в разделе Настройка резервного копирования. Однако в отличие от других защищенных баз данных, которые могут быть выбраны вручную или автоматически защищены, эта база данных отображается серым цветом и не может быть выбрана. Единственный способ повторно защитить эту базу данных — отключить автоматическую защиту для экземпляра. Теперь можно выбрать эту базу данных и настроить ее защиту или повторно включить автоматическую защиту для экземпляра.

## <a name="if-i-change-the-name-of-the-database-after-it-has-been-protected-what-will-be-the-behavior"></a>Что будет поведению при изменении имени базы данных после ее защиты?

Переименованная база данных рассматривается как новая база данных. Поэтому служба будет обрабатывать эту ситуацию так, как если бы база данных не была найдена и в ней не было ошибок резервного копирования.

Можно выбрать базу данных, которая будет переименована, и настроить для нее защиту. Если автоматическая защита в экземпляре включена, переименованная база данных будет автоматически обнаружена и защищена.

## <a name="why-cant-i-see-an-added-database-for-an-autoprotected-instance"></a>Почему я не вижу добавленной базы данных для автозащищенного экземпляра?

База данных, [добавляемая в автозащищаемый экземпляр](backup-sql-server-database-azure-vms.md#enable-auto-protection) , может не сразу отображаться в разделе защищенные элементы. Это обусловлено тем, что обнаружение обычно выполняется раз в 8 часов. Однако вы можете сразу обнаружить и защитить новые базы данных, если вручную запустить обнаружение, выбрав команду повторно **обнаружить баз данных**, как показано на следующем рисунке.

  ![Обнаружение вновь добавленной базы данных вручную](./media/backup-azure-sql-database/view-newly-added-database.png)

## <a name="can-i-protect-databases-on-virtual-machines-that-have-azure-disk-encryption-ade-enabled"></a>Можно ли защитить базы данных на виртуальных машинах с включенным шифрованием дисков Azure (ADE)?
Да, можно защитить базы данных на виртуальных машинах с включенным шифрованием дисков Azure (ADE).

## <a name="can-i-protect-databases-that-have-tde-transparent-data-encryption-turned-on-and-will-the-database-stay-encrypted-through-the-entire-backup-process"></a>Можно ли защитить базы данных с включенной TDE (прозрачное шифрование данных), и база данных останется зашифрованной по всему процессу резервного копирования?

Да, Azure Backup поддерживает резервное копирование баз данных SQL Server или сервера с включенным TDE. Служба архивации поддерживает [TDE](/sql/relational-databases/security/encryption/transparent-data-encryption) с ключами, управляемыми Azure, или с ключами, управляемыми клиентом (BYOK).  Резервное копирование не выполняет шифрование SQL в рамках процесса резервного копирования, поэтому база данных остается зашифрованной при резервном копировании.

## <a name="does-azure-backup-perform-a-checksum-operation-on-the-data-stream"></a>Azure Backup выполнить операцию вычисления контрольной суммы для потока данных?

Мы выполняем операцию вычисления контрольной суммы для потока данных. Однако это не следует путать с [контрольной суммой SQL](/sql/relational-databases/backup-restore/enable-or-disable-backup-checksums-during-backup-or-restore-sql-server).
Резервная копия рабочей нагрузки Azure вычислит контрольную сумму потока данных и сохранит ее явным образом во время операции резервного копирования. Затем этот поток контрольной суммы принимается в виде ссылки и перекрестно проверяется с помощью контрольной суммы потока данных во время операции восстановления, чтобы обеспечить согласованность данных.

## <a name="next-steps"></a>Дальнейшие действия

Узнайте, как [создать резервную копию базы данных SQL Server](backup-azure-sql-database.md) , которая работает на виртуальной машине Azure.