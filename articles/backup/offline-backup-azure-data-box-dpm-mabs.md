---
title: Автономная архивация с Azure Data Box для DPM и MABS
description: Вы можете использовать Azure Data Box для заполнения начальных резервных копий данных в автономном режиме из DPM и MABS.
ms.topic: conceptual
ms.date: 08/12/2020
ms.openlocfilehash: 1cfd9131099ad6a8ccd3d43e93f3d97641514f03
ms.sourcegitcommit: 772eb9c6684dd4864e0ba507945a83e48b8c16f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/19/2021
ms.locfileid: "96752555"
---
# <a name="offline-seeding-using-azure-data-box-for-dpm-and-mabs-preview"></a>Автономное заполнение с помощью Azure Data Box для DPM и MABS (Предварительная версия)

> [!NOTE]
> Эта функция применима к Data Protection Manager (DPM) 2019 UR2 и более поздних версий.<br><br>
> Сейчас эта функция доступна в предварительной версии для Microsoft Azure Backup Server (MABS). Если вы заинтересованы в использовании Azure Data Box для автономного заполнения с помощью MABS, обратитесь к нам по адресу [systemcenterfeedback@microsoft.com](mailto:systemcenterfeedback@microsoft.com) .

В этой статье объясняется, как можно использовать Azure Data Box для заполнения начальных резервных копий данных в автономном режиме из DPM и MABS в хранилище служб восстановления Azure.

Вы можете использовать [Azure Data Box](../databox/data-box-overview.md) для заполнения больших исходных резервных копий DPM и MABS в автономном режиме (без использования сети) в хранилище служб восстановления. Эта процедура помогает экономить время и ресурсы пропускной способности сети, которые в противном случае потреблялись бы при перемещении больших объемов данных резервных копий по сети с высокой задержкой. Эта функция в настоящее время находится на стадии предварительной версии.

Автономное резервное копирование с использованием Azure Data Box обеспечивает два весомых преимущества по сравнению с [автономным резервным копированием с использованием службы импорта и экспорта Azure](backup-azure-backup-server-import-export.md):

- Вам не нужно приобретать собственные диски и соединители, совместимые с Azure. в комплекте Azure Data Box поставляются диски, связанные с выбранным [номером SKU Data Box](https://azure.microsoft.com/services/databox/data/).

- Azure Backup (агент MARS) может напрямую записывать данные резервных копий на поддерживаемые номера SKU Azure Data Box. Такая возможность позволяет избежать подготовки расположения промежуточного хранения для исходных данных резервных копий. Кроме того, для форматирования и копирования этих данных на диски не требуются служебные программы.

## <a name="supported-platforms"></a>Поддерживаемые платформы

Поддерживаются следующие платформы:

- Windows Server 2019, 64-разрядная версия (Стандартный, Datacenter, Essentials)
- Windows Server 2016, 64-разрядная версия (Стандартный, Datacenter, Essentials)

## <a name="backup-data-size-and-supported-data-box-skus"></a>Размер данных резервной копии и поддерживаемые номера SKU Data Box

Поддерживаются следующие номера SKU Data Box:

| Размер данных резервной копии (после сжатия в режиме MARS) \* для каждого сервера | Поддерживаемый номер SKU Azure Data Box |
| --- | --- |
| \<= 7,2 ТБ | [Диск Azure Data Box](../databox/data-box-disk-overview.md) |
| > 7,2 ТБ и < = 80 ТБ\*\* | [Azure Data Box (100 ТБ)](../databox/data-box-overview.md) |

\*Стандартная скорость сжатия варьируется в диапазоне от 10 до 20 % <br>
\*\*Рекомендуется использовать [SystemCenterFeedback@microsoft.com](mailto:SystemCenterFeedback@microsoft.com), если предполагается обработать более 80 ТБ исходных данных резервных копий для одного источника данных.

> [!IMPORTANT]
> Начальные данные резервного копирования из одного источника данных должны содержаться в одном Azure Data Box или Azure Data Box диске и не могут совместно использоваться несколькими устройствами одного или разных номеров SKU. Однако Azure Data Box может содержать исходные резервные копии из нескольких источников данных.

## <a name="before-you-begin"></a>Перед началом

Агент MARS, выполняющийся на DPM/MABS, должен быть обновлен до [последней версии](https://aka.ms/azurebackup_agent) (2.0.9171.0 или более поздняя версия).

Убедитесь, что:

### <a name="azure-subscription-and-required-permissions"></a>Подписка Azure и необходимые разрешения

- Действующая подписка Azure.
- Пользователь, который будет выполнять политику автономного резервного копирования, должен быть владельцем подписки Azure.
- В одних и тех же подписках должны быть доступны задания Data Box и хранилище служб восстановления, в которые необходимо заполнить данные.
    > [!NOTE]
    > Рекомендуется, чтобы Целевая учетная запись хранения и хранилище служб восстановления нав одном регионе. Однако это не обязательно.

### <a name="order-and-receive-the-data-box-device"></a>Заказ и получение устройства Data Box

Перед активацией автономного резервного копирования убедитесь, что требуемые устройства Data Box находятся в состоянии *доставки* . Инструкции по выбору номера SKU для заказа в соответствии с вашими требованиями см. в разделе [Размер данных резервной копии и поддерживаемые номера SKU Data Box](#backup-data-size-and-supported-data-box-skus). Для заказа и получения устройств Data Box выполните действия, описанные в [этой статье](../databox/data-box-disk-deploy-ordered.md).

> [!IMPORTANT]
> Не выбирайте *блобстораже* для **типа учетной записи**. Для сервера DPM/MABS требуется учетная запись, которая поддерживает страничные BLOB-объекты, которые не поддерживаются при выборе *блобстораже* . Выберите  **хранилище версии 2 (общего назначения версии 2)** в качестве **типа учетной записи** при создании целевой учетной записи хранения для задания Azure Data Box.

![Настройка Azure Data Box](./media/offline-backup-azure-data-box-dpm-mabs/setup-azure-databox.png)

## <a name="setup-azure-data-box-devices"></a>Установка Azure Data Box устройств

Получив устройство Azure Data Box Azure Data Box, выполните действия, описанные в соответствующих разделах ниже, чтобы настроить и подготовить устройства Data Box для сервера DPM и MABS, чтобы определить и переместить исходные данные резервного копирования.

### <a name="setup-azure-data-box-disk"></a>Настройка диска Azure Data Box

Если вы заказали один или несколько дисков Azure Data Box (до 8 ТБ), выполните описанные [здесь](../databox/data-box-disk-deploy-set-up.md) действия по распаковке, подключению и разблокированию диска Data Box.

> [!NOTE]
> Возможно, у сервера DPM/MABS нет USB-порта. В этом случае можно подключить диск Azure Data Box к другому серверу или клиенту и настроить корневой каталог устройства как сетевую папку.

## <a name="setup-azure-data-box"></a>Настройка диска Azure Data Box

Если вы заказали Azure Data Box (до 100 ТБ), выполните описанные [здесь](../databox/data-box-deploy-set-up.md) действия по его настройке.

### <a name="mount-your-azure-data-box-as-local-system"></a>Подключение Azure Data Box в качестве локальной системы

Сервер DPM/MABS работает в контексте системы, поэтому для пути подключения, в котором подключена Azure Data Box, необходимо предоставить тот же уровень привилегий. Выполните следующие действия, чтобы подключить устройство Data Box в качестве локальной системы с помощью протокола NFS.

1. Включите функцию клиент для NFS на сервере DPM/MABS.
Указание альтернативного источника: *WIM:D:\Sources\Install.wim:4*
2. Скачайте **PsExec** с [https://download.sysinternals.com/files/PSTools.zip](https://download.sysinternals.com/files/PSTools.zip) сервера DPM или MABS.
3. Откройте командную строку с повышенными привилегиями и выполните следующую команду, указав каталог, который содержит *PSExec.exe*, в качестве текущего каталога.

   ```cmd
   psexec.exe  -s  -i  cmd.exe
   ```

4. Командное окно, открывающееся в результате выполнения приведенной выше команды, находится в контексте локальной системы. Используйте это окно командной строки, чтобы выполнить действия по подключению общей папки страничного BLOB-объекта Azure в качестве сетевого диска на сервере Windows Server.
5. Выполните [следующие действия,](../databox/data-box-deploy-copy-data-via-nfs.md#connect-to-data-box) чтобы ПОДКЛЮЧИТЬ сервер DPM/MABS к устройству Data Box с помощью NFS и выполнить следующую команду в командной строке локальной системы, чтобы подключить общую папку BLOB-объектов Azure:

    ```cmd
    mount -o nolock \\<DeviceIPAddres>\<StorageAccountName_PageBlob X:
    ```

6. После подключения проверьте наличие доступа к X: с сервера. Если вы можете, перейдите к следующему разделу этой статьи.

## <a name="transfer-initial-backup-data-to-azure-data-box-devices"></a>Перенос данных начального резервного копирования на устройства Azure Data Box

1. На сервере DPM/MABS выполните действия по [созданию новой группы защиты](/system-center/dpm/create-dpm-protection-groups). Если вы добавляете оперативную защиту в существующую группу защиты, щелкните правой кнопкой мыши существующую группу защиты и выберите команду **Добавить оперативную защиту** и начать с **шага 8**.
2. На странице **Выбор элементов группы** укажите компьютеры и источники, для которых требуется выполнить резервное копирование.
3. На странице **Выбор метода защиты данных** укажите способ обработки краткосрочного и долгосрочного резервного копирования. Обязательно установите флажок **Мне нужна оперативная защита.**

   ![Создание новой группы защиты](./media/offline-backup-azure-data-box-dpm-mabs/create-new-protection-group.png)

4. На странице **Выбрать краткосрочные цели** укажите способ резервного копирования для краткосрочного хранения на диске.
5. На странице **Проверка выделения места на диске** проверьте пространство на диске пула носителей, выделенное для этой группы защиты.
6. На странице **Выбор метода создания реплики** установите флажок **Автоматически по сети**.
7. На странице **Выбор параметров проверки согласованности** выберите способ автоматизации проверок согласованности.
8. На странице **Указание данных для оперативной защиты** выберите участника, для которого требуется включить оперативную защиту.

    ![Выбор оперативной защиты данных](./media/offline-backup-azure-data-box-dpm-mabs/specify-online-protection-data.png)

9. На странице **Укажите расписание архивации в сети** укажите, насколько часто должно выполняться добавочное резервное копирование в Azure.
10. На странице **Укажите политику хранения в сети** можно указать, каким образом точки восстановления, созданные на основе ежедневных, еженедельных, ежемесячных или ежегодных резервных копий, будут храниться в Azure.
11. На экране мастера **Выбор репликации в сети** выберите параметр **передать с помощью дисков, принадлежащих корпорации Майкрософт** , и нажмите кнопку **Далее**.

    ![Выбор начальной репликации в сети](./media/offline-backup-azure-data-box-dpm-mabs/choose-initial-online-replication.png)

    >[!NOTE]
    > Возможность выбора параметра **передать с помощью дисков, принадлежащих корпорации Майкрософт** , недоступна для MABS v3, так как эта функция доступна в предварительной версии. Обратитесь к нам по адресу [systemcenterfeedback@microsoft.com](mailto:systemcenterfeedback@microsoft.com) , если вы хотите использовать эту функцию для MABS v3.

12. Когда отобразится соответствующий запрос, войдите в Azure, используя учетные данные пользователя с правами владельца подписки Azure. После успешного входа появится следующий экран:

    ![После успешного входа](./media/offline-backup-azure-data-box-dpm-mabs/after-successful-login.png)

     После этого сервер DPM/MABS выберет задания Data Box в подписке, которая находится в состоянии *доставлено* .

     > [!NOTE]
     > Первый раз вход в систему занимает больше времени, чем обычно. Устанавливается модуль Azure PowerShell в фоновом режиме, а также регистрируется приложение Azure AD.
     >
     >  - Установлены следующие модули PowerShell:<br>
          — AzureRM.Profile     *5.8.3*;<br>
          — AzureRM.Resources   *6.7.3*;<br>
          — AzureRM.Storage     *5.2.0*;<br>
          — Azure.Storage       *4.6.1*.<br>
     >  - Приложение Azure AD регистрируется как *AzureOfflineBackup_\<object GUID of the user>* .

13. Выберите правильный порядок полей данных, для которого был распакован, подключен и разблокирован диск Data Box. Выберите **Далее**.

    ![Выбор Data Box](./media/offline-backup-azure-data-box-dpm-mabs/select-databox.png)

14. На экране **Обнаружение датабокс** введите путь к устройству Data Box, а затем выберите пункт **обнаружить устройство**.

    ![Ввод сетевого пути](./media/offline-backup-azure-data-box-dpm-mabs/enter-network-path.png)

    > [!IMPORTANT]
    > Укажите сетевой путь к корневому каталогу диска Azure Data Box. Этот каталог должен содержать каталог с именем *PageBlob*, как показано ниже:
    >
    > ![USB-накопитель](./media/offline-backup-azure-data-box-dpm-mabs/usb-drive.png)
    >
    > Например, если путь к диску — `\\mydomain\myserver\disk1\` и *disk1* содержит каталог с именем *PageBlob*, то путь, который должен быть указан в мастере сервера DPM/MABS, — это `\\mydomain\myserver\disk1\` .
    > Если [настраивается устройство Azure Data Box 100 ТБ](./offline-backup-azure-data-box.md#set-up-azure-data-box), укажите следующий сетевой путь к устройству `\\<DeviceIPAddress>\<StorageAccountName>_PageBlob`.

15. Выберите **Далее**. На странице **Сводка** проверьте параметры и нажмите кнопку **создать группу**.

    ![Обнаружение Data Box](./media/offline-backup-azure-data-box-dpm-mabs/detect-databox.png)

    На следующем экране отображается подтверждение успешного создания группы защиты.

    ![Группа защиты создана](./media/offline-backup-azure-data-box-dpm-mabs/protection-group-created.png)

16. Нажмите кнопку **Закрыть** на экране выше.

    В этом случае начальная репликация данных происходит на диск DPM/MABS. Когда она завершит защиту, на странице **Защита** в поле Состояние группы отобразится состояние защита **ОК** .

17. Чтобы запустить автономную резервную копию на устройстве Azure Data Box, щелкните правой кнопкой мыши **группу защиты** и выберите пункт **создать точку восстановления** . Затем выберите параметр **Оперативная защита**.

    ![Создать точку восстановления](./media/offline-backup-azure-data-box-dpm-mabs/create-recovery-point.png)

    ![Точка восстановления](./media/offline-backup-azure-data-box-dpm-mabs/recovery-point.png)

   Сервер DPM/MABS запустит резервное копирование данных, выбранных на устройство Azure Data Box. Это может занять от нескольких часов до нескольких дней в зависимости от размера данных и скорости подключения между сервером DPM/MABS и Диск Azure Data Box.

   Статус задания можно отслеживать в области **Мониторинг**. После завершения резервного копирования данных вы увидите экран, похожий на следующий:

   ![Консоль администрирования](./media/offline-backup-azure-data-box-dpm-mabs/administrator-console.png)

## <a name="post-backup-steps"></a>Действия, выполняемые после резервного копирования

Выполните следующие действия после успешного резервного копирования данных на диск Azure Data Box.

- Выполните действия, описанные в [этой статье](../databox/data-box-disk-deploy-picked-up.md), чтобы отправить диск Azure Data Box в Azure. Если использовалось устройство Azure Data Box 100 ТБ, выполните [следующие действия](../databox/data-box-deploy-picked-up.md) для отправки Azure Data Box в Azure.
- [Отслеживание задания Data Box](../databox/data-box-disk-deploy-upload-verify.md) на портале Azure. После *завершения* задания Azure Data Box сервер DPM/MABS автоматически переместит данные из учетной записи хранения в хранилище служб восстановления во время следующего запланированного резервного копирования. Если точка восстановления успешно создана, заданию резервного копирования будет присвоен статус *Завершено*.

  > [!NOTE]
  > Сервер DPM/MABS запускает резервное копирование в запланированное время во время создания группы защиты. Тем не менее эти задания будут помечены флагом *Ожидание завершения задания Azure Data Box* вплоть до момента завершения задания.

- После того как сервер DPM/MABS успешно создаст точку восстановления, соответствующую первоначальной резервной копии, вы можете удалить учетную запись хранения (или конкретное содержимое), связанную с заданием Azure Data Box.

## <a name="troubleshooting"></a>Устранение неполадок

Агент Microsoft Azure Backup (MAB) на сервере DPM создает приложение Azure AD на вашем арендаторе. Для этого приложения требуется сертификат для проверки подлинности, который создается и передается при настройке политики заполнения в автономном режиме.

Для создания и отправки сертификата в приложение Azure AD используется Azure PowerShell.

### <a name="issue"></a>Проблема

Во время настройки автономного резервного копирования из-за известного дефекта кода в командлете Azure PowerShell вы не можете добавить несколько сертификатов в одно приложение Azure AD, созданное агентом MAB. Это повлияет на то, что вы настроили политику автономного заполнения для того же или другого сервера.

### <a name="verify-if-the-issue-is-caused-by-this-specific-root-cause"></a>Убедитесь, что проблема возникла именно по этой причине

Чтобы убедиться в том, что ошибка возникла именно из-за [проблемы](#issue), описанной выше, выполните следующие действия.

#### <a name="step-1"></a>Шаг 1

Проверьте, отображается ли следующее сообщение об ошибке в консоли DPM/MABS во время настройки автономного резервного копирования:

![Агент служб восстановления Azure](./media/offline-backup-azure-data-box-dpm-mabs/azure-recovery-services-agent.png)

#### <a name="step-2"></a>Шаг 2

1. Откройте папку **Temp** из пути установки (путь к временной папке по умолчанию — *C:\Program Files\Microsoft Azure Recovery Services Agent\Temp*. Найдите файл *CBUICurr* и откройте его.
2. В файле *CBUICurr* прокрутите до последней строки и проверьте, вызвана ли проблема ошибкой "Не удалось создать учетные данные приложения Azure AD в учетной записи пользователя. Исключение: обновление существующих учетных данных с помощью KeyId \<some guid> не разрешено ".

### <a name="workaround"></a>Обходной путь

Чтобы устранить эту проблему, выполните следующие действия и повторите настройку политики.

1. Войдите на страницу входа Azure, которая отображается в пользовательском интерфейсе сервера DPM/MABS, используя другую учетную запись с правами администратора в подписке, в которой будет создано задание Data Box.
2. Если на другом сервере не настроено автономное заполнение и нет других серверов, зависимых от приложения `AzureOfflineBackup_<Azure User Id>`, удалите это приложение в разделе **портал Azure > Azure Active Directory > Регистрации приложений**.

   > [!NOTE]
   > Проверьте, `AzureOfflineBackup_<Azure User Id>` не настроено ли в приложении никакой другой режим автономного заполнения, а также в отсутствии других серверов, зависящих от этого приложения. Перейдите в раздел **параметры > ключи** в разделе открытые ключи. Не должны быть добавлены другие **открытые ключи** . Справочные сведения см. на следующем снимке экрана:
   >
   > ![Открытые ключи](./media/offline-backup-azure-data-box-dpm-mabs/public-keys.png)

#### <a name="step-3"></a>Шаг 3

На сервере DPM/MABS, для которого вы пытаетесь настроить автономную архивацию, выполните следующие действия.

1. Откройте вкладку **Управление приложением сертификата компьютера** > **Личный** и найдите сертификат с именем `CB_AzureADCertforOfflineSeeding_<ResourceId>`.
2. Выберите приведенный выше сертификат, щелкните правой кнопкой мыши **все задачи** и **экспортируйте** без закрытого ключа в формате CER.
3. Перейдите к приложению автономного резервного копирования Azure, о котором говорилось в **пункте 2**. В разделе **Параметры** > **Ключи** > **Отправка открытого ключа** отправьте сертификат, который экспортирован в предыдущем шаге.

   ![Отправка открытого ключа](./media/offline-backup-azure-data-box-dpm-mabs/upload-public-keys.png)

4. На сервере откройте реестр, введя в окне **выполнения** команду **regedit** .
5. Перейдите в раздел реестра *Computer\HKEY\_LOCAL\_MACHINE\SOFTWARE\Microsoft\Windows Azure Backup\Config\CloudBackupProvider*. Щелкните правой кнопкой мыши **CloudBackupProvider** и добавьте новое строковое значение с именем `AzureADAppCertThumbprint_<Azure User Id>`.

    >[!NOTE]
    > Чтобы получить идентификатор пользователя Azure, выполните одно из следующих действий.
    >
    >- В PowerShell, подключенном к Azure, выполните команду `Get-AzureRmADUser -UserPrincipalName "Account Holder's email as defined in the portal"`.
    > - Перейдите в раздел реестра `Computer\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Azure Backup\DbgSettings\OnlineBackup` с именем *CurrentUserId*.

6. Щелкните правой кнопкой мыши строку, добавленную в предыдущем шаге, и выберите **Изменить**. В поле значение укажите отпечаток сертификата, экспортированного в **точке 2** , и нажмите кнопку **ОК**.
7. Чтобы получить значение отпечатка, дважды щелкните сертификат, а затем выберите **Сведения** и прокрутите вниз, пока не появится поле "Отпечаток". Выберите **отпечаток** и скопируйте значение.

   ![Значение отпечатка](./media/offline-backup-azure-data-box-dpm-mabs/certificate.png)

## <a name="next-steps"></a>Дальнейшие действия

- [Автономное заполнение с использованием собственного диска (с помощью службы импорта и экспорта Azure)](backup-azure-backup-server-import-export.md)
